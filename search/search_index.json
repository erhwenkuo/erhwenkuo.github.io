{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Welcome to Tech Learning \u00b6 \u672c\u7db2\u7ad9\u4e3b\u8981\u662f\u500b\u4eba\u5728\u5b78\u7fd2\u4e00\u4e9b\u8cc7\u8a0a\u79d1\u6280\u7684\u77e5\u8b58\u8207\u5de5\u5177\u6642\u6240\u6536\u96c6\u7684\u76f8\u95dc\u6587\u7ae0\u8207\u7df4\u7fd2\u3002","title":"CICD \u8def\u7dda\u5716"},{"location":"#welcome-to-tech-learning","text":"\u672c\u7db2\u7ad9\u4e3b\u8981\u662f\u500b\u4eba\u5728\u5b78\u7fd2\u4e00\u4e9b\u8cc7\u8a0a\u79d1\u6280\u7684\u77e5\u8b58\u8207\u5de5\u5177\u6642\u6240\u6536\u96c6\u7684\u76f8\u95dc\u6587\u7ae0\u8207\u7df4\u7fd2\u3002","title":"Welcome to Tech Learning"},{"location":"ansible/an-introduction-to-configuration-management-with-ansible/","text":"","title":"An introduction to configuration management with ansible"},{"location":"ansible/ansible-cheatsheet/","text":"\u5982\u4f55\u4f7f\u7528 Ansible\uff1a\u53c3\u8003\u6307\u5357 \u00b6 Ansible \u662f\u4e00\u7a2e\u73fe\u4ee3\u5316\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff0c\u53ef\u5e6b\u52a9\u60a8\u5b8c\u6210\u8a2d\u7f6e\u548c\u7dad\u8b77\u9060\u7a0b\u670d\u52d9\u5668\u7684\u4efb\u52d9\u3002 \u9019\u500b cheatsheet \u98a8\u683c\u7684\u6307\u5357\u63d0\u4f9b\u4e86\u4f7f\u7528 Ansible \u6642\u5e38\u7528\u7684\u547d\u4ee4\u548c\u5be6\u8e10\u7684\u5feb\u901f\u53c3\u8003\u3002\u6709\u95dc Ansible \u7684\u6982\u8ff0\u4ee5\u53ca\u5982\u4f55\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u3002 \u5982\u4f55\u4f7f\u7528\u672c\u6307\u5357\uff1a \u672c\u6307\u5357\u63a1\u7528\u5099\u5fd8\u55ae\u683c\u5f0f\uff0c\u5e36\u6709\u7368\u7acb\u7684\u547d\u4ee4\u884c\u7247\u6bb5\u3002 \u8df3\u8f49\u5230\u8207\u60a8\u5617\u8a66\u5b8c\u6210\u7684\u4efb\u52d9\u76f8\u95dc\u7684\u4efb\u4f55\u90e8\u5206\u3002 \u7576\u60a8\u5728\u672c\u6307\u5357\u7684\u547d\u4ee4\u4e2d\u770b\u5230 \u7a81\u51fa\u986f\u793a\u7684\u6587\u672c \u6642\uff0c\u8acb\u8a18\u4f4f\uff0c\u6b64 \u6587\u672c \u662f\u5c0d\u61c9\u5230\u60a8\u81ea\u5df1\u7684\u6e05\u55ae\u4e2d\u7684\u4e3b\u6a5f\u3001\u7528\u6236\u540d\u548c IP \u5730\u5740\u3002 Ansible \u8a5e\u5f59\u8868 \u672c\u6307\u5357\u4e2d\u4e3b\u8981\u4f7f\u7528\u4ee5\u4e0b Ansible \u7279\u5b9a\u8853\u8a9e\uff1a Control Machine / Node : \u5b89\u88dd\u548c\u914d\u7f6e Ansible \u4ee5\u5728\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u57f7\u884c\u547d\u4ee4\u7684\u7cfb\u7d71\u3002 Node : \u7531 Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u3002 Inventory File : \u5305\u542b\u6709\u95dc Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u6587\u4ef6\uff0c\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \u3002 Playbook : \u5305\u542b\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4e00\u7cfb\u5217\u4efb\u52d9\u7684\u6587\u4ef6\u3002 Role : \u8207\u76ee\u6a19\u76f8\u95dc\u7684\u5287\u672c\u548c\u5176\u4ed6\u6587\u4ef6\u7684\u96c6\u5408\uff0c\u4f8b\u5982\u5b89\u88dd Web \u670d\u52d9\u5668\u3002 Play : \u5b8c\u6574\u7684 Ansible \u904b\u884c\u3002\u4e00\u500b\u5287\u672c\u53ef\u4ee5\u6709\u591a\u500b\u5287\u672c\u548c\u89d2\u8272\uff0c\u5305\u542b\u5728\u4e00\u500b\u4f5c\u70ba\u5165\u53e3\u9ede\u7684\u5287\u672c\u4e2d\u3002 \u8b93\u6211\u5011\u4f7f\u7528Ansible\u8207Vagrant\u4f86\u69cb\u5efa\u4e00\u500bVM\u4f86\u7df4\u7fd2\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6307\u4ee4\u3002 \u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-cheatsheet \u3002\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-cheatsheet $ cd ansible-cheatsheet \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" } \u6e2c\u8a66\u8207\u7bc0\u9ede\u7684\u9023\u63a5 \u00b6 \u8981\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u60a8\u7684\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u904b\u884c\u547d\u4ee4\u548c playbook\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a ansible all -m ping \u7d50\u679c: demo-vm | SUCCESS => { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python3\" }, \"changed\": false, \"ping\": \"pong\" } \u9664\u4e86\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c Python \u8173\u672c\u4e4b\u5916\uff0c ping \u6a21\u584a\u9084\u5c07\u6e2c\u8a66\u60a8\u662f\u5426\u5177\u6709\u9023\u63a5\u5230\u6e05\u55ae\u6587\u4ef6\u4e2d\u5b9a\u7fa9\u7684\u7bc0\u9ede\u7684\u6709\u6548\u6191\u64da\u3002 pong \u56de\u590d\u610f\u5473\u8457 Ansible \u5df2\u6e96\u5099\u597d\u5728\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c\u547d\u4ee4\u548c playbook\u3002 \u4ee5\u4e0d\u540c\u7528\u6236\u8eab\u4efd\u9023\u63a5 \u00b6 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible \u6703\u5617\u8a66\u4f7f\u7528\u5176\u5c0d\u61c9\u7684 SSH \u5bc6\u9470\u5c0d\u4ee5\u60a8\u7576\u524d\u7684\u7cfb\u7d71\u7528\u6236\u8eab\u4efd\u9023\u63a5\u5230\u7bc0\u9ede\u3002\u8981\u4ee5\u5176\u4ed6\u7528\u6236\u8eab\u4efd\u9023\u63a5\uff0c\u8acb\u5728\u547d\u4ee4\u5f8c\u9762\u9644\u52a0 -u \u6a19\u8a8c\u548c\u9810\u671f\u7528\u6236\u7684\u540d\u7a31\uff1a $ ansible all -m ping -u vagrant \u540c\u6a23\u7684flag\u4e5f\u9069\u7528\u65bc ansible-playbook\uff1a $ ansible-playbook myplaybook.yml -u vagrant \u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470 \u00b6 \u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u60a8\u53ef\u4ee5\u5728\u57f7\u884c\u6642\u4f7f\u7528 --private-key \u9078\u9805\u63d0\u4f9b\u5b83\uff1a $ ansible all -m ping --private-key = ~/.ssh/custom_id \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml --private-key = ~/.ssh/custom_id \u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49 \u00b6 \u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49\u4f86\u9023\u63a5\u5230\u7bc0\u9ede\uff0c\u5247\u9700\u8981\u5c07\u9078\u9805 --ask-pass \u9644\u52a0\u5230\u60a8\u7684 Ansible \u547d\u4ee4\u3002 \u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u60a8\u5617\u8a66\u9023\u63a5\u7684\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684\u7528\u6236\u5bc6\u78bc\uff1a $ ansible all -m ping --ask-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-pass \u63d0\u4f9b sudo \u5bc6\u78bc \u00b6 \u5982\u679c\u9060\u7a0b\u7528\u6236\u9700\u8981\u63d0\u4f9b\u5bc6\u78bc\u624d\u80fd\u904b\u884c sudo \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u5728 Ansible \u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 --ask-become-pass \u3002\u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9060\u7a0b\u7528\u6236 sudo \u5bc6\u78bc\uff1a $ ansible all -m ping --ask-become-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-become-pass \u4f7f\u7528\u81ea\u5b9a\u7fa9\u4e3b\u6a5f inventory \u6587\u4ef6 \u00b6 \u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \uff0c\u4f46\u60a8\u4e5f\u53ef\u4ee5\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u9078\u9805\u6307\u5411\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u3002 Ansible \u9084\u652f\u6301\u7528\u65bc\u69cb\u5efa\u52d5\u614b\u6e05\u55ae\u6587\u4ef6\u7684\u6e05\u55ae\u8173\u672c\uff0c\u4ee5\u4fbf\u5728\u60a8\u7684\u6e05\u55ae\u6ce2\u52d5\u6642\uff0c\u7d93\u5e38\u5275\u5efa\u548c\u92b7\u6bc0\u670d\u52d9\u5668\u3002\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u5c0d\u65bc\u8a2d\u7f6e\u53ef\u4ee5\u5305\u542b\u5728\u7248\u672c\u63a7\u5236\u7cfb\u7d71\uff08\u4f8b\u5982 Git\uff09\u4e2d\u7684\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u5f88\u6709\u7528\uff1a $ ansible all -m ping -i my_custom_inventory \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml -i my_custom_inventory \u904b\u884c\u81e8\u6642\u547d\u4ee4 (ad-hoc) \u00b6 \u8981\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u547d\u4ee4\uff0c\u8acb\u4f7f\u7528 -a \u9078\u9805\uff0c\u5f8c\u8ddf\u8981\u904b\u884c\u7684\u547d\u4ee4\uff0c\u7528\u5f15\u865f\u62ec\u8d77\u4f86\u3002 \u9019\u5c07\u5728\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u57f7\u884c uname -a \uff1a $ ansible all -a \"uname -a\" \u4e5f\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 -m \u904b\u884c Ansible \u6a21\u584a\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u5f9e\u60a8\u7684\u6e05\u55ae\u4e2d\u5c07\u8edf\u4ef6\u5305 vim \u5b89\u88dd\u5230 server1 \u4e0a\uff1a $ ansible server1 -m apt -a \"name=vim\" \u5728\u5c0d\u7bc0\u9ede\u9032\u884c\u66f4\u6539\u4e4b\u524d\uff0c\u60a8\u53ef\u4ee5\u9032\u884c\u8a66\u904b\u884c\u4ee5\u9810\u6e2c\u670d\u52d9\u5668\u5c07\u5982\u4f55\u53d7\u5230\u60a8\u7684\u547d\u4ee4\u7684\u5f71\u97ff\u3002\u9019\u53ef\u4ee5\u901a\u904e\u5305\u542b --check \u9078\u9805\u4f86\u5b8c\u6210\uff1a $ ansible server1 -m apt -a \"name=vim\" --check \u904b\u884c\u5287\u672c Playbook \u00b6 \u8981\u904b\u884c\u5287\u672c\u4e26\u57f7\u884c\u5176\u4e2d\u5b9a\u7fa9\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 ansible-playbook \u547d\u4ee4\uff1a $ ansible-playbook myplaybook.yml \u8981\u8986\u84cb playbook \u4e2d\u7684\u9ed8\u8a8d\u4e3b\u6a5f\u9078\u9805\u4e26\u5c07\u57f7\u884c\u9650\u5236\u70ba\u7279\u5b9a\u7d44\u6216\u4e3b\u6a5f\uff0c\u8acb\u5728\u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 -l \uff1a $ ansible-playbook -l server1 myplaybook.yml \u7372\u53d6\u6709\u95dc Play \u7684\u4fe1\u606f \u00b6 $ ansible-playbook myplaybook.yml --list-tasks \u540c\u6a23\uff0c\u53ef\u4ee5\u5217\u51fa\u6240\u6709\u53d7 Play \u5f71\u97ff\u7684\u4e3b\u6a5f\uff0c\u800c\u7121\u9700\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c\u4efb\u4f55\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --list-hosts \u60a8\u53ef\u4ee5\u4f7f\u7528\u6a19\u7c64\u4f86\u9650\u88fd Play \u7684\u57f7\u884c\u3002\u8981\u5217\u51fa\u64ad\u653e\u4e2d\u53ef\u7528\u7684\u6240\u6709\u6a19\u7c64\uff0c\u8acb\u4f7f\u7528\u9078\u9805 --list-tags \uff1a $ ansible-playbook myplaybook.yml --list-tags \u63a7\u5236\u5287\u672c Playbook \u57f7\u884c \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --start-at-task \u70ba\u60a8\u7684\u5287\u672c\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u5165\u53e3\u9ede\u3002 Ansible \u7136\u5f8c\u5c07\u8df3\u904e\u6307\u5b9a\u4efb\u52d9\u4e4b\u524d\u7684\u4efb\u4f55\u5167\u5bb9\uff0c\u5f9e\u8a72\u9ede\u958b\u59cb\u57f7\u884c\u5269\u9918\u7684\u64ad\u653e\u3002\u6b64\u9078\u9805\u9700\u8981\u4e00\u500b\u6709\u6548\u7684\u4efb\u52d9\u540d\u7a31\u4f5c\u70ba\u53c3\u6578\uff1a $ ansible-playbook myplaybook.yml --start-at-task = \"Set Up Nginx\" \u8981\u50c5\u57f7\u884c\u8207\u7279\u5b9a\u6a19\u7c64\u95dc\u806f\u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --tags\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u53ea\u60f3\u57f7\u884c\u6a19\u8a18\u70ba nginx \u6216 mysql \u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-playbook myplaybook.yml --tags = mysql,nginx \u5982\u679c\u8981\u8df3\u904e\u7279\u5b9a\u6a19\u7c64\u4e0b\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 --skip-tags\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u57f7\u884c myplaybook.yml\uff0c\u8df3\u904e\u6240\u6709\u6a19\u8a18\u70ba mysql \u7684\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --skip-tags = mysql \u4f7f\u7528 Ansible Vault \u5b58\u5132\u654f\u611f\u6578\u64da \u00b6 \u5982\u679c\u60a8\u7684 Ansible playbook \u8655\u7406\u5bc6\u78bc\u3001API \u5bc6\u9470\u548c\u6191\u64da\u7b49\u654f\u611f\u6578\u64da\uff0c\u5247\u4f7f\u7528\u52a0\u5bc6\u6a5f\u5236\u78ba\u4fdd\u9019\u4e9b\u6578\u64da\u7684\u5b89\u5168\u975e\u5e38\u91cd\u8981\u3002 Ansible \u63d0\u4f9b ansible-vault \u4f86\u52a0\u5bc6\u6587\u4ef6\u548c\u8b8a\u91cf\u3002 \u5118\u7ba1\u53ef\u4ee5\u52a0\u5bc6\u4efb\u4f55 Ansible \u6578\u64da\u6587\u4ef6\u4ee5\u53ca\u4e8c\u9032\u88fd\u6587\u4ef6\uff0c\u4f46\u66f4\u5e38\u898b\u7684\u662f\u4f7f\u7528 ansible-vault \u4f86\u52a0\u5bc6\u5305\u542b\u654f\u611f\u6578\u64da\u7684\u8b8a\u91cf\u6587\u4ef6\u3002\u4f7f\u7528\u6b64\u5de5\u5177\u52a0\u5bc6\u6587\u4ef6\u5f8c\uff0c\u60a8\u53ea\u80fd\u901a\u904e\u63d0\u4f9b\u9996\u6b21\u52a0\u5bc6\u6587\u4ef6\u6642\u5b9a\u7fa9\u7684\u76f8\u95dc\u5bc6\u78bc\u4f86\u57f7\u884c\u3001\u7de8\u8f2f\u6216\u67e5\u770b\u5176\u5167\u5bb9\u3002 \u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6 \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u4e00\u500b\u65b0\u7684\u52a0\u5bc6 Ansible \u6587\u4ef6\uff1a $ ansible-vault create credentials.yml \u8a72\u547d\u4ee4\u5c07\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u9996\u5148\uff0c\u5b83\u6703\u63d0\u793a\u60a8\u8f38\u5165\u65b0\u5bc6\u78bc\u3002\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6\u5167\u5bb9\u6642\uff0c\u60a8\u90fd\u9700\u8981\u63d0\u4f9b\u6b64\u5bc6\u78bc\uff0c\u7121\u8ad6\u662f\u7528\u65bc\u7de8\u8f2f\u3001\u67e5\u770b\u9084\u662f\u50c5\u4f7f\u7528\u9019\u4e9b\u503c\u904b\u884c playbook \u6216\u547d\u4ee4\u3002 \u63a5\u4e0b\u4f86\uff0c\u5b83\u5c07\u6253\u958b\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u4f7f\u7528\u6240\u9700\u5167\u5bb9\u586b\u5145\u6587\u4ef6\u3002 \u6700\u5f8c\uff0c\u7576\u4f60\u5b8c\u6210\u7de8\u8f2f\u5f8c\uff0cansible-vault \u6703\u5c07\u6587\u4ef6\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002 \u52a0\u5bc6\u73fe\u6709\u7684 Ansible File \u00b6 \u8981\u52a0\u5bc6\u73fe\u6709\u7684 Ansible \u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\uff1a $ ansible-vault encrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6 credentials.yml \u6642\u90fd\u9700\u8981\u8f38\u5165\u8a72\u5bc6\u78bc\u3002 \u67e5\u770b\u52a0\u5bc6\u6587\u4ef6\u7684\u5167\u5bb9 \u00b6 \u5982\u679c\u60a8\u60f3\u67e5\u770b\u4e4b\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\u4e26\u4e14\u4e0d\u9700\u8981\u66f4\u6539\u5176\u5167\u5bb9\uff0c\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-vault view credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6\u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002 \u7de8\u8f2f\u52a0\u5bc6\u6587\u4ef6 \u00b6 \u8981\u7de8\u8f2f\u4e4b\u524d\u4f7f\u7528 Ansible Vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u8acb\u904b\u884c\uff1a $ ansible-vault edit credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\u5c07\u6253\u958b\u6587\u4ef6\u7684\u672a\u52a0\u5bc6\u5167\u5bb9\uff0c\u5141\u8a31\u60a8\u9032\u884c\u66f4\u6539\u3002\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u7167\u5e38\u4fdd\u5b58\u548c\u95dc\u9589\u6587\u4ef6\uff0c\u66f4\u65b0\u7684\u5167\u5bb9\u5c07\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002 \u89e3\u5bc6\u52a0\u5bc6\u6587\u4ef6 \u00b6 \u5982\u679c\u60a8\u5e0c\u671b\u5c07\u4ee5\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u6c38\u4e45\u9084\u539f\u70ba\u5176\u672a\u52a0\u5bc6\u7248\u672c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\u57f7\u884c\u6b64\u64cd\u4f5c\uff1a $ ansible-vault decrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u6587\u4ef6\u5167\u5bb9\u5c07\u4f5c\u70ba\u672a\u52a0\u5bc6\u6578\u64da\u4fdd\u5b58\u5230\u78c1\u76e4\u3002 \u4f7f\u7528\u591a\u500b Vault \u5bc6\u78bc \u00b6 Ansible \u652f\u6301\u6309\u4e0d\u540c\u4fdd\u7ba1\u5eab ID \u5206\u7d44\u7684\u591a\u500b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5982\u679c\u60a8\u60f3\u70ba\u4e0d\u540c\u7684\u74b0\u5883\uff08\u4f8b\u5982\u958b\u767c\u3001\u6e2c\u8a66\u548c\u751f\u7522\u74b0\u5883\uff09\u4f7f\u7528\u5c08\u7528\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\uff0c\u9019\u5c07\u975e\u5e38\u6709\u7528\u3002 \u8981\u4f7f\u7528\u81ea\u5b9a\u7fa9\u4fdd\u7ba1\u5eab ID \u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6\uff0c\u8acb\u5305\u62ec --vault-id \u9078\u9805\u4ee5\u53ca\u6a19\u7c64\u548c ansible-vault \u53ef\u4ee5\u627e\u5230\u8a72\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u7684\u4f4d\u7f6e\u3002\u6a19\u7c64\u53ef\u4ee5\u662f\u4efb\u4f55\u6a19\u8b58\u7b26\uff0c\u4e26\u4e14\u4f4d\u7f6e\u53ef\u4ee5\u662f\u63d0\u793a\u7b26\uff0c\u9019\u610f\u5473\u8457\u8a72\u547d\u4ee4\u61c9\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6216\u5bc6\u78bc\u6587\u4ef6\u7684\u6709\u6548\u8def\u5f91\u3002 $ ansible-vault create --vault-id dev@prompt credentials_dev.yml \u9019\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dev \u7684\u65b0\u4fdd\u7ba1\u5eab ID\uff0c\u5b83\u4f7f\u7528\u63d0\u793a\u7b26\u4f5c\u70ba\u5bc6\u78bc\u6e90\u3002\u901a\u904e\u5c07\u6b64\u65b9\u6cd5\u8207\u7d44\u8b8a\u91cf\u6587\u4ef6\u76f8\u7d50\u5408\uff0c\u60a8\u5c07\u80fd\u5920\u70ba\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u64c1\u6709\u55ae\u7368\u7684 ansible \u4fdd\u96aa\u5eab\uff1a $ ansible-vault create --vault-id prod@prompt credentials_prod.yml \u6211\u5011\u4f7f\u7528 dev \u548c prod \u4f5c\u70ba\u6587\u4ef6\u5eab ID \u4f86\u6f14\u793a\u5982\u4f55\u70ba\u6bcf\u500b\u74b0\u5883\u5275\u5efa\u55ae\u7368\u7684\u6587\u4ef6\u5eab\uff0c\u4f46\u60a8\u53ef\u4ee5\u5275\u5efa\u4efb\u610f\u6578\u91cf\u7684\u6587\u4ef6\u5eab\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u4efb\u4f55\u6a19\u8b58\u7b26\u4f5c\u70ba\u6587\u4ef6\u5eab ID\u3002 \u73fe\u5728\u8981\u67e5\u770b\u3001\u7de8\u8f2f\u6216\u89e3\u5bc6\u9019\u4e9b\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u63d0\u4f9b\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\u4ee5\u53ca ansible-vault \u547d\u4ee4\uff1a $ ansible-vault edit credentials_dev.yml --vault-id dev@prompt \u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6 \u00b6 \u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u7b2c\u4e09\u65b9\u5de5\u5177\u901a\u904e Ansible \u81ea\u52d5\u914d\u7f6e\u670d\u52d9\u5668\u7684\u904e\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u4f86\u63d0\u4f9b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u800c\u4e0d\u88ab\u63d0\u793a\u8f38\u5165\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528\u5e36\u6709 ansible-vault \u7684\u5bc6\u78bc\u6587\u4ef6\u4f86\u505a\u5230\u9019\u4e00\u9ede\u3002 \u5bc6\u78bc\u6587\u4ef6\u53ef\u4ee5\u662f\u7d14\u6587\u672c\u6587\u4ef6\u6216\u53ef\u57f7\u884c\u8173\u672c\u3002\u5982\u679c\u6587\u4ef6\u662f\u53ef\u57f7\u884c\u8173\u672c\uff0c\u5247\u6b64\u8173\u672c\u751f\u6210\u7684\u8f38\u51fa\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5426\u5247\uff0c\u6587\u4ef6\u7684\u539f\u59cb\u5167\u5bb9\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002 \u8981\u5728 ansible-vault \u4e2d\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c\u4efb\u4f55 vault \u547d\u4ee4\u6642\u63d0\u4f9b\u5bc6\u78bc\u6587\u4ef6\u7684\u8def\u5f91\uff1a $ ansible-vault create --vault-id dev@path/to/passfile credentials_dev.yml \u53ea\u8981\u8f38\u5165\u7684\u5bc6\u78bc\u76f8\u540c\uff0cAnsible \u4e0d\u6703\u5340\u5206\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u7684\u5167\u5bb9\u6216\u5bc6\u78bc\u6587\u4ef6\u4f5c\u70ba\u5bc6\u78bc\u6e90\u7684\u5167\u5bb9\u3002\u5be6\u969b\u4e0a\uff0c\u9019\u610f\u5473\u8457\u53ef\u4ee5\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u6587\u4ef6\uff0c\u7136\u5f8c\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u5b58\u5132\u8207\u63d0\u793a\u65b9\u6cd5\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u53cd\u4e4b\u4ea6\u7136\uff1a\u60a8\u53ef\u4ee5\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u52a0\u5bc6\u5167\u5bb9\uff0c\u7136\u5f8c\u4f7f\u7528\u63d0\u793a\u65b9\u6cd5\uff0c\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u76f8\u540c\u7684\u5bc6\u78bc\u3002 \u70ba\u4e86\u63d0\u9ad8\u9748\u6d3b\u6027\u548c\u5b89\u5168\u6027\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Python \u8173\u672c\u5f9e\u5176\u4ed6\u4f86\u6e90\u7372\u53d6\u5bc6\u78bc\uff0c\u800c\u4e0d\u662f\u5c07\u60a8\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u5b58\u5132\u5728\u7d14\u6587\u672c\u6587\u4ef6\u4e2d\u3002\u5b98\u65b9 Ansible \u5b58\u5132\u5eab\u5305\u542b\u4e00\u4e9b Vault \u8173\u672c\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5728\u5275\u5efa\u9069\u5408\u9805\u76ee\u7279\u5b9a\u9700\u6c42\u7684\u81ea\u5b9a\u7fa9\u8173\u672c\u6642\u53c3\u8003\u9019\u4e9b\u793a\u4f8b\u3002 \u904b\u884c\u901a\u904e Ansible Vault \u52a0\u5bc6\u6578\u64da\u7684\u5287\u672c \u00b6 \u6bcf\u7576\u60a8\u904b\u884c\u4f7f\u7528\u5148\u524d\u901a\u904e ansible-vault \u52a0\u5bc6\u7684\u6578\u64da\u7684 playbook \u6642\uff0c\u60a8\u90fd\u9700\u8981\u5411 playbook \u547d\u4ee4\u63d0\u4f9b vault \u5bc6\u78bc\u3002 \u5982\u679c\u60a8\u5728\u52a0\u5bc6\u6b64 playbook \u4e2d\u4f7f\u7528\u7684\u6578\u64da\u6642\u4f7f\u7528\u4e86\u9ed8\u8a8d\u9078\u9805\u548c\u63d0\u793a\u5bc6\u78bc\u6e90\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --ask-vault-pass \u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff1a $ ansible-playbook myplaybook.yml --ask-vault-pass \u5982\u679c\u60a8\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u800c\u4e0d\u662f\u63d0\u793a\u8f38\u5165\u5bc6\u78bc\uff0c\u5247\u61c9\u4f7f\u7528\u9078\u9805 --vault-password-file \u4ee3\u66ff\uff1a $ ansible-playbook myplaybook.yml --vault-password-file my_vault_password.py \u5982\u679c\u60a8\u4f7f\u7528\u5728\u4fdd\u7ba1\u5eab ID \u4e0b\u52a0\u5bc6\u7684\u6578\u64da\uff0c\u5247\u9700\u8981\u63d0\u4f9b\u8207\u9996\u6b21\u52a0\u5bc6\u6578\u64da\u6642\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@prompt \u5982\u679c\u4f7f\u7528\u5e36\u6709\u60a8\u7684\u4fdd\u7ba1\u5eab ID \u7684\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u61c9\u8a72\u63d0\u4f9b\u6a19\u7c64\uff0c\u5f8c\u8ddf\u5bc6\u78bc\u6587\u4ef6\u7684\u5b8c\u6574\u8def\u5f91\u4f5c\u70ba\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py \u5982\u679c\u60a8\u7684\u904a\u6232\u4f7f\u7528\u591a\u500b\u4fdd\u96aa\u5eab\uff0c\u60a8\u61c9\u8a72\u70ba\u6bcf\u500b\u4fdd\u96aa\u5eab\u63d0\u4f9b\u4e00\u500b --vault-id \u53c3\u6578\uff0c\u6c92\u6709\u7279\u5b9a\u7684\u9806\u5e8f\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py --vault-id test@prompt --vault-id ci@prompt \u8abf\u8a66 \u00b6 \u5982\u679c\u60a8\u5728\u57f7\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u9047\u5230\u932f\u8aa4\uff0c\u6700\u597d\u589e\u52a0\u8f38\u51fa\u8a73\u7d30\u7a0b\u5ea6\u4ee5\u7372\u53d6\u6709\u95dc\u554f\u984c\u7684\u66f4\u591a\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u5305\u542b -v \u9078\u9805\u4f86\u505a\u5230\u9019\u4e00\u9ede\uff1a $ ansible-playbook myplaybook.yml -v \u5982\u679c\u60a8\u9700\u8981\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528 -vvv\uff0c\u9019\u5c07\u589e\u52a0\u8f38\u51fa\u7684\u8a73\u7d30\u7a0b\u5ea6\u3002\u5982\u679c\u60a8\u7121\u6cd5\u901a\u904e Ansible \u9023\u63a5\u5230\u9060\u7a0b\u7bc0\u9ede\uff0c\u8acb\u4f7f\u7528 -vvvv \u7372\u53d6\u9023\u63a5\u8abf\u8a66\u4fe1\u606f\uff1a $ ansible-playbook myplaybook.yml -vvvv \u7d50\u8ad6 \u00b6 \u672c\u6307\u5357\u6db5\u84cb\u4e86\u60a8\u5728\u914d\u7f6e\u670d\u52d9\u5668\u6642\u53ef\u80fd\u4f7f\u7528\u7684\u4e00\u4e9b\u6700\u5e38\u898b\u7684 Ansible \u547d\u4ee4\uff0c\u4f8b\u5982\u5982\u4f55\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u9060\u7a0b\u547d\u4ee4\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5404\u7a2e\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u904b\u884c playbook\u3002 \u60a8\u53ef\u80fd\u6703\u767c\u73fe\u5176\u4ed6\u547d\u4ee4\u8b8a\u9ad4\u548c\u6a19\u8a8c\u5c0d\u60a8\u7684 Ansible \u5de5\u4f5c\u6d41\u7a0b\u5f88\u6709\u7528\u3002\u8981\u7372\u5f97\u6240\u6709\u53ef\u7528\u9078\u9805\u7684\u6982\u89bd\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5e6b\u52a9\u547d\u4ee4\uff1a $ ansible --help \u5982\u679c\u60a8\u60f3\u66f4\u5168\u9762\u5730\u4e86\u89e3 Ansible \u53ca\u5176\u6240\u6709\u53ef\u7528\u547d\u4ee4\u548c\u529f\u80fd\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94\u3002 \u5982\u679c\u60a8\u60f3\u67e5\u770b Ansible \u7684\u53e6\u4e00\u500b\u5be6\u969b\u793a\u4f8b\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u6307\u5357\u3002","title":"Ansible \u4f7f\u7528\u6307\u5357"},{"location":"ansible/ansible-cheatsheet/#ansible","text":"Ansible \u662f\u4e00\u7a2e\u73fe\u4ee3\u5316\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff0c\u53ef\u5e6b\u52a9\u60a8\u5b8c\u6210\u8a2d\u7f6e\u548c\u7dad\u8b77\u9060\u7a0b\u670d\u52d9\u5668\u7684\u4efb\u52d9\u3002 \u9019\u500b cheatsheet \u98a8\u683c\u7684\u6307\u5357\u63d0\u4f9b\u4e86\u4f7f\u7528 Ansible \u6642\u5e38\u7528\u7684\u547d\u4ee4\u548c\u5be6\u8e10\u7684\u5feb\u901f\u53c3\u8003\u3002\u6709\u95dc Ansible \u7684\u6982\u8ff0\u4ee5\u53ca\u5982\u4f55\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u3002 \u5982\u4f55\u4f7f\u7528\u672c\u6307\u5357\uff1a \u672c\u6307\u5357\u63a1\u7528\u5099\u5fd8\u55ae\u683c\u5f0f\uff0c\u5e36\u6709\u7368\u7acb\u7684\u547d\u4ee4\u884c\u7247\u6bb5\u3002 \u8df3\u8f49\u5230\u8207\u60a8\u5617\u8a66\u5b8c\u6210\u7684\u4efb\u52d9\u76f8\u95dc\u7684\u4efb\u4f55\u90e8\u5206\u3002 \u7576\u60a8\u5728\u672c\u6307\u5357\u7684\u547d\u4ee4\u4e2d\u770b\u5230 \u7a81\u51fa\u986f\u793a\u7684\u6587\u672c \u6642\uff0c\u8acb\u8a18\u4f4f\uff0c\u6b64 \u6587\u672c \u662f\u5c0d\u61c9\u5230\u60a8\u81ea\u5df1\u7684\u6e05\u55ae\u4e2d\u7684\u4e3b\u6a5f\u3001\u7528\u6236\u540d\u548c IP \u5730\u5740\u3002 Ansible \u8a5e\u5f59\u8868 \u672c\u6307\u5357\u4e2d\u4e3b\u8981\u4f7f\u7528\u4ee5\u4e0b Ansible \u7279\u5b9a\u8853\u8a9e\uff1a Control Machine / Node : \u5b89\u88dd\u548c\u914d\u7f6e Ansible \u4ee5\u5728\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u57f7\u884c\u547d\u4ee4\u7684\u7cfb\u7d71\u3002 Node : \u7531 Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u3002 Inventory File : \u5305\u542b\u6709\u95dc Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u6587\u4ef6\uff0c\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \u3002 Playbook : \u5305\u542b\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4e00\u7cfb\u5217\u4efb\u52d9\u7684\u6587\u4ef6\u3002 Role : \u8207\u76ee\u6a19\u76f8\u95dc\u7684\u5287\u672c\u548c\u5176\u4ed6\u6587\u4ef6\u7684\u96c6\u5408\uff0c\u4f8b\u5982\u5b89\u88dd Web \u670d\u52d9\u5668\u3002 Play : \u5b8c\u6574\u7684 Ansible \u904b\u884c\u3002\u4e00\u500b\u5287\u672c\u53ef\u4ee5\u6709\u591a\u500b\u5287\u672c\u548c\u89d2\u8272\uff0c\u5305\u542b\u5728\u4e00\u500b\u4f5c\u70ba\u5165\u53e3\u9ede\u7684\u5287\u672c\u4e2d\u3002 \u8b93\u6211\u5011\u4f7f\u7528Ansible\u8207Vagrant\u4f86\u69cb\u5efa\u4e00\u500bVM\u4f86\u7df4\u7fd2\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6307\u4ee4\u3002 \u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-cheatsheet \u3002\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-cheatsheet $ cd ansible-cheatsheet \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" }","title":"\u5982\u4f55\u4f7f\u7528 Ansible\uff1a\u53c3\u8003\u6307\u5357"},{"location":"ansible/ansible-cheatsheet/#_1","text":"\u8981\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u60a8\u7684\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u904b\u884c\u547d\u4ee4\u548c playbook\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a ansible all -m ping \u7d50\u679c: demo-vm | SUCCESS => { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python3\" }, \"changed\": false, \"ping\": \"pong\" } \u9664\u4e86\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c Python \u8173\u672c\u4e4b\u5916\uff0c ping \u6a21\u584a\u9084\u5c07\u6e2c\u8a66\u60a8\u662f\u5426\u5177\u6709\u9023\u63a5\u5230\u6e05\u55ae\u6587\u4ef6\u4e2d\u5b9a\u7fa9\u7684\u7bc0\u9ede\u7684\u6709\u6548\u6191\u64da\u3002 pong \u56de\u590d\u610f\u5473\u8457 Ansible \u5df2\u6e96\u5099\u597d\u5728\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c\u547d\u4ee4\u548c playbook\u3002","title":"\u6e2c\u8a66\u8207\u7bc0\u9ede\u7684\u9023\u63a5"},{"location":"ansible/ansible-cheatsheet/#_2","text":"\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible \u6703\u5617\u8a66\u4f7f\u7528\u5176\u5c0d\u61c9\u7684 SSH \u5bc6\u9470\u5c0d\u4ee5\u60a8\u7576\u524d\u7684\u7cfb\u7d71\u7528\u6236\u8eab\u4efd\u9023\u63a5\u5230\u7bc0\u9ede\u3002\u8981\u4ee5\u5176\u4ed6\u7528\u6236\u8eab\u4efd\u9023\u63a5\uff0c\u8acb\u5728\u547d\u4ee4\u5f8c\u9762\u9644\u52a0 -u \u6a19\u8a8c\u548c\u9810\u671f\u7528\u6236\u7684\u540d\u7a31\uff1a $ ansible all -m ping -u vagrant \u540c\u6a23\u7684flag\u4e5f\u9069\u7528\u65bc ansible-playbook\uff1a $ ansible-playbook myplaybook.yml -u vagrant","title":"\u4ee5\u4e0d\u540c\u7528\u6236\u8eab\u4efd\u9023\u63a5"},{"location":"ansible/ansible-cheatsheet/#ssh","text":"\u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u60a8\u53ef\u4ee5\u5728\u57f7\u884c\u6642\u4f7f\u7528 --private-key \u9078\u9805\u63d0\u4f9b\u5b83\uff1a $ ansible all -m ping --private-key = ~/.ssh/custom_id \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml --private-key = ~/.ssh/custom_id","title":"\u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470"},{"location":"ansible/ansible-cheatsheet/#_3","text":"\u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49\u4f86\u9023\u63a5\u5230\u7bc0\u9ede\uff0c\u5247\u9700\u8981\u5c07\u9078\u9805 --ask-pass \u9644\u52a0\u5230\u60a8\u7684 Ansible \u547d\u4ee4\u3002 \u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u60a8\u5617\u8a66\u9023\u63a5\u7684\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684\u7528\u6236\u5bc6\u78bc\uff1a $ ansible all -m ping --ask-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-pass","title":"\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49"},{"location":"ansible/ansible-cheatsheet/#sudo","text":"\u5982\u679c\u9060\u7a0b\u7528\u6236\u9700\u8981\u63d0\u4f9b\u5bc6\u78bc\u624d\u80fd\u904b\u884c sudo \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u5728 Ansible \u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 --ask-become-pass \u3002\u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9060\u7a0b\u7528\u6236 sudo \u5bc6\u78bc\uff1a $ ansible all -m ping --ask-become-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-become-pass","title":"\u63d0\u4f9b sudo \u5bc6\u78bc"},{"location":"ansible/ansible-cheatsheet/#inventory","text":"\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \uff0c\u4f46\u60a8\u4e5f\u53ef\u4ee5\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u9078\u9805\u6307\u5411\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u3002 Ansible \u9084\u652f\u6301\u7528\u65bc\u69cb\u5efa\u52d5\u614b\u6e05\u55ae\u6587\u4ef6\u7684\u6e05\u55ae\u8173\u672c\uff0c\u4ee5\u4fbf\u5728\u60a8\u7684\u6e05\u55ae\u6ce2\u52d5\u6642\uff0c\u7d93\u5e38\u5275\u5efa\u548c\u92b7\u6bc0\u670d\u52d9\u5668\u3002\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u5c0d\u65bc\u8a2d\u7f6e\u53ef\u4ee5\u5305\u542b\u5728\u7248\u672c\u63a7\u5236\u7cfb\u7d71\uff08\u4f8b\u5982 Git\uff09\u4e2d\u7684\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u5f88\u6709\u7528\uff1a $ ansible all -m ping -i my_custom_inventory \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml -i my_custom_inventory","title":"\u4f7f\u7528\u81ea\u5b9a\u7fa9\u4e3b\u6a5f inventory \u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#ad-hoc","text":"\u8981\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u547d\u4ee4\uff0c\u8acb\u4f7f\u7528 -a \u9078\u9805\uff0c\u5f8c\u8ddf\u8981\u904b\u884c\u7684\u547d\u4ee4\uff0c\u7528\u5f15\u865f\u62ec\u8d77\u4f86\u3002 \u9019\u5c07\u5728\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u57f7\u884c uname -a \uff1a $ ansible all -a \"uname -a\" \u4e5f\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 -m \u904b\u884c Ansible \u6a21\u584a\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u5f9e\u60a8\u7684\u6e05\u55ae\u4e2d\u5c07\u8edf\u4ef6\u5305 vim \u5b89\u88dd\u5230 server1 \u4e0a\uff1a $ ansible server1 -m apt -a \"name=vim\" \u5728\u5c0d\u7bc0\u9ede\u9032\u884c\u66f4\u6539\u4e4b\u524d\uff0c\u60a8\u53ef\u4ee5\u9032\u884c\u8a66\u904b\u884c\u4ee5\u9810\u6e2c\u670d\u52d9\u5668\u5c07\u5982\u4f55\u53d7\u5230\u60a8\u7684\u547d\u4ee4\u7684\u5f71\u97ff\u3002\u9019\u53ef\u4ee5\u901a\u904e\u5305\u542b --check \u9078\u9805\u4f86\u5b8c\u6210\uff1a $ ansible server1 -m apt -a \"name=vim\" --check","title":"\u904b\u884c\u81e8\u6642\u547d\u4ee4 (ad-hoc)"},{"location":"ansible/ansible-cheatsheet/#playbook","text":"\u8981\u904b\u884c\u5287\u672c\u4e26\u57f7\u884c\u5176\u4e2d\u5b9a\u7fa9\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 ansible-playbook \u547d\u4ee4\uff1a $ ansible-playbook myplaybook.yml \u8981\u8986\u84cb playbook \u4e2d\u7684\u9ed8\u8a8d\u4e3b\u6a5f\u9078\u9805\u4e26\u5c07\u57f7\u884c\u9650\u5236\u70ba\u7279\u5b9a\u7d44\u6216\u4e3b\u6a5f\uff0c\u8acb\u5728\u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 -l \uff1a $ ansible-playbook -l server1 myplaybook.yml","title":"\u904b\u884c\u5287\u672c Playbook"},{"location":"ansible/ansible-cheatsheet/#play","text":"$ ansible-playbook myplaybook.yml --list-tasks \u540c\u6a23\uff0c\u53ef\u4ee5\u5217\u51fa\u6240\u6709\u53d7 Play \u5f71\u97ff\u7684\u4e3b\u6a5f\uff0c\u800c\u7121\u9700\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c\u4efb\u4f55\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --list-hosts \u60a8\u53ef\u4ee5\u4f7f\u7528\u6a19\u7c64\u4f86\u9650\u88fd Play \u7684\u57f7\u884c\u3002\u8981\u5217\u51fa\u64ad\u653e\u4e2d\u53ef\u7528\u7684\u6240\u6709\u6a19\u7c64\uff0c\u8acb\u4f7f\u7528\u9078\u9805 --list-tags \uff1a $ ansible-playbook myplaybook.yml --list-tags","title":"\u7372\u53d6\u6709\u95dc Play \u7684\u4fe1\u606f"},{"location":"ansible/ansible-cheatsheet/#playbook_1","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --start-at-task \u70ba\u60a8\u7684\u5287\u672c\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u5165\u53e3\u9ede\u3002 Ansible \u7136\u5f8c\u5c07\u8df3\u904e\u6307\u5b9a\u4efb\u52d9\u4e4b\u524d\u7684\u4efb\u4f55\u5167\u5bb9\uff0c\u5f9e\u8a72\u9ede\u958b\u59cb\u57f7\u884c\u5269\u9918\u7684\u64ad\u653e\u3002\u6b64\u9078\u9805\u9700\u8981\u4e00\u500b\u6709\u6548\u7684\u4efb\u52d9\u540d\u7a31\u4f5c\u70ba\u53c3\u6578\uff1a $ ansible-playbook myplaybook.yml --start-at-task = \"Set Up Nginx\" \u8981\u50c5\u57f7\u884c\u8207\u7279\u5b9a\u6a19\u7c64\u95dc\u806f\u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --tags\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u53ea\u60f3\u57f7\u884c\u6a19\u8a18\u70ba nginx \u6216 mysql \u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-playbook myplaybook.yml --tags = mysql,nginx \u5982\u679c\u8981\u8df3\u904e\u7279\u5b9a\u6a19\u7c64\u4e0b\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 --skip-tags\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u57f7\u884c myplaybook.yml\uff0c\u8df3\u904e\u6240\u6709\u6a19\u8a18\u70ba mysql \u7684\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --skip-tags = mysql","title":"\u63a7\u5236\u5287\u672c Playbook \u57f7\u884c"},{"location":"ansible/ansible-cheatsheet/#ansible-vault","text":"\u5982\u679c\u60a8\u7684 Ansible playbook \u8655\u7406\u5bc6\u78bc\u3001API \u5bc6\u9470\u548c\u6191\u64da\u7b49\u654f\u611f\u6578\u64da\uff0c\u5247\u4f7f\u7528\u52a0\u5bc6\u6a5f\u5236\u78ba\u4fdd\u9019\u4e9b\u6578\u64da\u7684\u5b89\u5168\u975e\u5e38\u91cd\u8981\u3002 Ansible \u63d0\u4f9b ansible-vault \u4f86\u52a0\u5bc6\u6587\u4ef6\u548c\u8b8a\u91cf\u3002 \u5118\u7ba1\u53ef\u4ee5\u52a0\u5bc6\u4efb\u4f55 Ansible \u6578\u64da\u6587\u4ef6\u4ee5\u53ca\u4e8c\u9032\u88fd\u6587\u4ef6\uff0c\u4f46\u66f4\u5e38\u898b\u7684\u662f\u4f7f\u7528 ansible-vault \u4f86\u52a0\u5bc6\u5305\u542b\u654f\u611f\u6578\u64da\u7684\u8b8a\u91cf\u6587\u4ef6\u3002\u4f7f\u7528\u6b64\u5de5\u5177\u52a0\u5bc6\u6587\u4ef6\u5f8c\uff0c\u60a8\u53ea\u80fd\u901a\u904e\u63d0\u4f9b\u9996\u6b21\u52a0\u5bc6\u6587\u4ef6\u6642\u5b9a\u7fa9\u7684\u76f8\u95dc\u5bc6\u78bc\u4f86\u57f7\u884c\u3001\u7de8\u8f2f\u6216\u67e5\u770b\u5176\u5167\u5bb9\u3002","title":"\u4f7f\u7528 Ansible Vault \u5b58\u5132\u654f\u611f\u6578\u64da"},{"location":"ansible/ansible-cheatsheet/#_4","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u4e00\u500b\u65b0\u7684\u52a0\u5bc6 Ansible \u6587\u4ef6\uff1a $ ansible-vault create credentials.yml \u8a72\u547d\u4ee4\u5c07\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u9996\u5148\uff0c\u5b83\u6703\u63d0\u793a\u60a8\u8f38\u5165\u65b0\u5bc6\u78bc\u3002\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6\u5167\u5bb9\u6642\uff0c\u60a8\u90fd\u9700\u8981\u63d0\u4f9b\u6b64\u5bc6\u78bc\uff0c\u7121\u8ad6\u662f\u7528\u65bc\u7de8\u8f2f\u3001\u67e5\u770b\u9084\u662f\u50c5\u4f7f\u7528\u9019\u4e9b\u503c\u904b\u884c playbook \u6216\u547d\u4ee4\u3002 \u63a5\u4e0b\u4f86\uff0c\u5b83\u5c07\u6253\u958b\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u4f7f\u7528\u6240\u9700\u5167\u5bb9\u586b\u5145\u6587\u4ef6\u3002 \u6700\u5f8c\uff0c\u7576\u4f60\u5b8c\u6210\u7de8\u8f2f\u5f8c\uff0cansible-vault \u6703\u5c07\u6587\u4ef6\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002","title":"\u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#ansible-file","text":"\u8981\u52a0\u5bc6\u73fe\u6709\u7684 Ansible \u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\uff1a $ ansible-vault encrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6 credentials.yml \u6642\u90fd\u9700\u8981\u8f38\u5165\u8a72\u5bc6\u78bc\u3002","title":"\u52a0\u5bc6\u73fe\u6709\u7684 Ansible File"},{"location":"ansible/ansible-cheatsheet/#_5","text":"\u5982\u679c\u60a8\u60f3\u67e5\u770b\u4e4b\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\u4e26\u4e14\u4e0d\u9700\u8981\u66f4\u6539\u5176\u5167\u5bb9\uff0c\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-vault view credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6\u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002","title":"\u67e5\u770b\u52a0\u5bc6\u6587\u4ef6\u7684\u5167\u5bb9"},{"location":"ansible/ansible-cheatsheet/#_6","text":"\u8981\u7de8\u8f2f\u4e4b\u524d\u4f7f\u7528 Ansible Vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u8acb\u904b\u884c\uff1a $ ansible-vault edit credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\u5c07\u6253\u958b\u6587\u4ef6\u7684\u672a\u52a0\u5bc6\u5167\u5bb9\uff0c\u5141\u8a31\u60a8\u9032\u884c\u66f4\u6539\u3002\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u7167\u5e38\u4fdd\u5b58\u548c\u95dc\u9589\u6587\u4ef6\uff0c\u66f4\u65b0\u7684\u5167\u5bb9\u5c07\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002","title":"\u7de8\u8f2f\u52a0\u5bc6\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#_7","text":"\u5982\u679c\u60a8\u5e0c\u671b\u5c07\u4ee5\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u6c38\u4e45\u9084\u539f\u70ba\u5176\u672a\u52a0\u5bc6\u7248\u672c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\u57f7\u884c\u6b64\u64cd\u4f5c\uff1a $ ansible-vault decrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u6587\u4ef6\u5167\u5bb9\u5c07\u4f5c\u70ba\u672a\u52a0\u5bc6\u6578\u64da\u4fdd\u5b58\u5230\u78c1\u76e4\u3002","title":"\u89e3\u5bc6\u52a0\u5bc6\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#vault","text":"Ansible \u652f\u6301\u6309\u4e0d\u540c\u4fdd\u7ba1\u5eab ID \u5206\u7d44\u7684\u591a\u500b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5982\u679c\u60a8\u60f3\u70ba\u4e0d\u540c\u7684\u74b0\u5883\uff08\u4f8b\u5982\u958b\u767c\u3001\u6e2c\u8a66\u548c\u751f\u7522\u74b0\u5883\uff09\u4f7f\u7528\u5c08\u7528\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\uff0c\u9019\u5c07\u975e\u5e38\u6709\u7528\u3002 \u8981\u4f7f\u7528\u81ea\u5b9a\u7fa9\u4fdd\u7ba1\u5eab ID \u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6\uff0c\u8acb\u5305\u62ec --vault-id \u9078\u9805\u4ee5\u53ca\u6a19\u7c64\u548c ansible-vault \u53ef\u4ee5\u627e\u5230\u8a72\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u7684\u4f4d\u7f6e\u3002\u6a19\u7c64\u53ef\u4ee5\u662f\u4efb\u4f55\u6a19\u8b58\u7b26\uff0c\u4e26\u4e14\u4f4d\u7f6e\u53ef\u4ee5\u662f\u63d0\u793a\u7b26\uff0c\u9019\u610f\u5473\u8457\u8a72\u547d\u4ee4\u61c9\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6216\u5bc6\u78bc\u6587\u4ef6\u7684\u6709\u6548\u8def\u5f91\u3002 $ ansible-vault create --vault-id dev@prompt credentials_dev.yml \u9019\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dev \u7684\u65b0\u4fdd\u7ba1\u5eab ID\uff0c\u5b83\u4f7f\u7528\u63d0\u793a\u7b26\u4f5c\u70ba\u5bc6\u78bc\u6e90\u3002\u901a\u904e\u5c07\u6b64\u65b9\u6cd5\u8207\u7d44\u8b8a\u91cf\u6587\u4ef6\u76f8\u7d50\u5408\uff0c\u60a8\u5c07\u80fd\u5920\u70ba\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u64c1\u6709\u55ae\u7368\u7684 ansible \u4fdd\u96aa\u5eab\uff1a $ ansible-vault create --vault-id prod@prompt credentials_prod.yml \u6211\u5011\u4f7f\u7528 dev \u548c prod \u4f5c\u70ba\u6587\u4ef6\u5eab ID \u4f86\u6f14\u793a\u5982\u4f55\u70ba\u6bcf\u500b\u74b0\u5883\u5275\u5efa\u55ae\u7368\u7684\u6587\u4ef6\u5eab\uff0c\u4f46\u60a8\u53ef\u4ee5\u5275\u5efa\u4efb\u610f\u6578\u91cf\u7684\u6587\u4ef6\u5eab\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u4efb\u4f55\u6a19\u8b58\u7b26\u4f5c\u70ba\u6587\u4ef6\u5eab ID\u3002 \u73fe\u5728\u8981\u67e5\u770b\u3001\u7de8\u8f2f\u6216\u89e3\u5bc6\u9019\u4e9b\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u63d0\u4f9b\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\u4ee5\u53ca ansible-vault \u547d\u4ee4\uff1a $ ansible-vault edit credentials_dev.yml --vault-id dev@prompt","title":"\u4f7f\u7528\u591a\u500b Vault \u5bc6\u78bc"},{"location":"ansible/ansible-cheatsheet/#_8","text":"\u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u7b2c\u4e09\u65b9\u5de5\u5177\u901a\u904e Ansible \u81ea\u52d5\u914d\u7f6e\u670d\u52d9\u5668\u7684\u904e\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u4f86\u63d0\u4f9b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u800c\u4e0d\u88ab\u63d0\u793a\u8f38\u5165\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528\u5e36\u6709 ansible-vault \u7684\u5bc6\u78bc\u6587\u4ef6\u4f86\u505a\u5230\u9019\u4e00\u9ede\u3002 \u5bc6\u78bc\u6587\u4ef6\u53ef\u4ee5\u662f\u7d14\u6587\u672c\u6587\u4ef6\u6216\u53ef\u57f7\u884c\u8173\u672c\u3002\u5982\u679c\u6587\u4ef6\u662f\u53ef\u57f7\u884c\u8173\u672c\uff0c\u5247\u6b64\u8173\u672c\u751f\u6210\u7684\u8f38\u51fa\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5426\u5247\uff0c\u6587\u4ef6\u7684\u539f\u59cb\u5167\u5bb9\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002 \u8981\u5728 ansible-vault \u4e2d\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c\u4efb\u4f55 vault \u547d\u4ee4\u6642\u63d0\u4f9b\u5bc6\u78bc\u6587\u4ef6\u7684\u8def\u5f91\uff1a $ ansible-vault create --vault-id dev@path/to/passfile credentials_dev.yml \u53ea\u8981\u8f38\u5165\u7684\u5bc6\u78bc\u76f8\u540c\uff0cAnsible \u4e0d\u6703\u5340\u5206\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u7684\u5167\u5bb9\u6216\u5bc6\u78bc\u6587\u4ef6\u4f5c\u70ba\u5bc6\u78bc\u6e90\u7684\u5167\u5bb9\u3002\u5be6\u969b\u4e0a\uff0c\u9019\u610f\u5473\u8457\u53ef\u4ee5\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u6587\u4ef6\uff0c\u7136\u5f8c\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u5b58\u5132\u8207\u63d0\u793a\u65b9\u6cd5\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u53cd\u4e4b\u4ea6\u7136\uff1a\u60a8\u53ef\u4ee5\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u52a0\u5bc6\u5167\u5bb9\uff0c\u7136\u5f8c\u4f7f\u7528\u63d0\u793a\u65b9\u6cd5\uff0c\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u76f8\u540c\u7684\u5bc6\u78bc\u3002 \u70ba\u4e86\u63d0\u9ad8\u9748\u6d3b\u6027\u548c\u5b89\u5168\u6027\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Python \u8173\u672c\u5f9e\u5176\u4ed6\u4f86\u6e90\u7372\u53d6\u5bc6\u78bc\uff0c\u800c\u4e0d\u662f\u5c07\u60a8\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u5b58\u5132\u5728\u7d14\u6587\u672c\u6587\u4ef6\u4e2d\u3002\u5b98\u65b9 Ansible \u5b58\u5132\u5eab\u5305\u542b\u4e00\u4e9b Vault \u8173\u672c\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5728\u5275\u5efa\u9069\u5408\u9805\u76ee\u7279\u5b9a\u9700\u6c42\u7684\u81ea\u5b9a\u7fa9\u8173\u672c\u6642\u53c3\u8003\u9019\u4e9b\u793a\u4f8b\u3002","title":"\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#ansible-vault_1","text":"\u6bcf\u7576\u60a8\u904b\u884c\u4f7f\u7528\u5148\u524d\u901a\u904e ansible-vault \u52a0\u5bc6\u7684\u6578\u64da\u7684 playbook \u6642\uff0c\u60a8\u90fd\u9700\u8981\u5411 playbook \u547d\u4ee4\u63d0\u4f9b vault \u5bc6\u78bc\u3002 \u5982\u679c\u60a8\u5728\u52a0\u5bc6\u6b64 playbook \u4e2d\u4f7f\u7528\u7684\u6578\u64da\u6642\u4f7f\u7528\u4e86\u9ed8\u8a8d\u9078\u9805\u548c\u63d0\u793a\u5bc6\u78bc\u6e90\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --ask-vault-pass \u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff1a $ ansible-playbook myplaybook.yml --ask-vault-pass \u5982\u679c\u60a8\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u800c\u4e0d\u662f\u63d0\u793a\u8f38\u5165\u5bc6\u78bc\uff0c\u5247\u61c9\u4f7f\u7528\u9078\u9805 --vault-password-file \u4ee3\u66ff\uff1a $ ansible-playbook myplaybook.yml --vault-password-file my_vault_password.py \u5982\u679c\u60a8\u4f7f\u7528\u5728\u4fdd\u7ba1\u5eab ID \u4e0b\u52a0\u5bc6\u7684\u6578\u64da\uff0c\u5247\u9700\u8981\u63d0\u4f9b\u8207\u9996\u6b21\u52a0\u5bc6\u6578\u64da\u6642\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@prompt \u5982\u679c\u4f7f\u7528\u5e36\u6709\u60a8\u7684\u4fdd\u7ba1\u5eab ID \u7684\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u61c9\u8a72\u63d0\u4f9b\u6a19\u7c64\uff0c\u5f8c\u8ddf\u5bc6\u78bc\u6587\u4ef6\u7684\u5b8c\u6574\u8def\u5f91\u4f5c\u70ba\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py \u5982\u679c\u60a8\u7684\u904a\u6232\u4f7f\u7528\u591a\u500b\u4fdd\u96aa\u5eab\uff0c\u60a8\u61c9\u8a72\u70ba\u6bcf\u500b\u4fdd\u96aa\u5eab\u63d0\u4f9b\u4e00\u500b --vault-id \u53c3\u6578\uff0c\u6c92\u6709\u7279\u5b9a\u7684\u9806\u5e8f\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py --vault-id test@prompt --vault-id ci@prompt","title":"\u904b\u884c\u901a\u904e Ansible Vault \u52a0\u5bc6\u6578\u64da\u7684\u5287\u672c"},{"location":"ansible/ansible-cheatsheet/#_9","text":"\u5982\u679c\u60a8\u5728\u57f7\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u9047\u5230\u932f\u8aa4\uff0c\u6700\u597d\u589e\u52a0\u8f38\u51fa\u8a73\u7d30\u7a0b\u5ea6\u4ee5\u7372\u53d6\u6709\u95dc\u554f\u984c\u7684\u66f4\u591a\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u5305\u542b -v \u9078\u9805\u4f86\u505a\u5230\u9019\u4e00\u9ede\uff1a $ ansible-playbook myplaybook.yml -v \u5982\u679c\u60a8\u9700\u8981\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528 -vvv\uff0c\u9019\u5c07\u589e\u52a0\u8f38\u51fa\u7684\u8a73\u7d30\u7a0b\u5ea6\u3002\u5982\u679c\u60a8\u7121\u6cd5\u901a\u904e Ansible \u9023\u63a5\u5230\u9060\u7a0b\u7bc0\u9ede\uff0c\u8acb\u4f7f\u7528 -vvvv \u7372\u53d6\u9023\u63a5\u8abf\u8a66\u4fe1\u606f\uff1a $ ansible-playbook myplaybook.yml -vvvv","title":"\u8abf\u8a66"},{"location":"ansible/ansible-cheatsheet/#_10","text":"\u672c\u6307\u5357\u6db5\u84cb\u4e86\u60a8\u5728\u914d\u7f6e\u670d\u52d9\u5668\u6642\u53ef\u80fd\u4f7f\u7528\u7684\u4e00\u4e9b\u6700\u5e38\u898b\u7684 Ansible \u547d\u4ee4\uff0c\u4f8b\u5982\u5982\u4f55\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u9060\u7a0b\u547d\u4ee4\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5404\u7a2e\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u904b\u884c playbook\u3002 \u60a8\u53ef\u80fd\u6703\u767c\u73fe\u5176\u4ed6\u547d\u4ee4\u8b8a\u9ad4\u548c\u6a19\u8a8c\u5c0d\u60a8\u7684 Ansible \u5de5\u4f5c\u6d41\u7a0b\u5f88\u6709\u7528\u3002\u8981\u7372\u5f97\u6240\u6709\u53ef\u7528\u9078\u9805\u7684\u6982\u89bd\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5e6b\u52a9\u547d\u4ee4\uff1a $ ansible --help \u5982\u679c\u60a8\u60f3\u66f4\u5168\u9762\u5730\u4e86\u89e3 Ansible \u53ca\u5176\u6240\u6709\u53ef\u7528\u547d\u4ee4\u548c\u529f\u80fd\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94\u3002 \u5982\u679c\u60a8\u60f3\u67e5\u770b Ansible \u7684\u53e6\u4e00\u500b\u5be6\u969b\u793a\u4f8b\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u6307\u5357\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/ansible-intro/","text":"\u4f7f\u7528 Ansible \u90e8\u7f72\u74b0\u5883 \u00b6 \u5728\u6211\u5011\u6210\u529f\u5229\u7528 Vagrant \u6a21\u64ec\u51fa\u6240\u9700\u7684\u74b0\u5883\u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528 Ansible \u9019\u5957\u81ea\u52d5\u5316\u5de5\u5177\u4f86\u9032\u884c\u90e8\u7f72\u4e86\u3002 Ansible \u4ecb\u7d39 \u00b6 Ansible \u662f\u4ec0\u9ebc\uff1f \u00b6 \u76f8\u4fe1\u5927\u5bb6\u61c9\u8a72\u90fd\u6709\u904e\u91cd\u704c\u96fb\u8166\u7684\u7d93\u9a57\u3002\u6bcf\u4e00\u6b21\u5728\u96fb\u8166\u91cd\u65b0\u5b89\u88dd\u5f8c\uff0c\u6211\u5011\u90fd\u9700\u8981\u82b1\u5927\u91cf\u7684\u6642\u9593\u628a\u5e73\u5e38\u5e38\u7528\u7684\u8edf\u9ad4\u4e00\u4e00\u91cd\u65b0\u88dd\u4e0a\uff0c\u6709\u4e9b\u8edf\u9ad4\u53ef\u80fd\u9084\u8981\u9032\u884c\u500b\u5225\u7684\u5fae\u8abf\uff0c\u800c\u9019\u6a23\u7e41\u7463\u7684\u6b65\u9a5f\u540c\u6a23\u4e5f\u6703\u767c\u751f\u5728\u8edf\u9ad4\u90e8\u7f72\u7684\u4f3a\u670d\u5668\u4e0a\u3002 \u70ba\u4e86\u904b\u884c\u958b\u767c\u51fa\u4f86\u7684\u8edf\u9ad4\uff0c\u958b\u767c\u4eba\u54e1\u5011\u5f80\u5f80\u9700\u8981\u8981\u82b1\u8cbb\u5927\u91cf\u7684\u6642\u9593\u5728\u4f3a\u670d\u5668\u4e0a\u5b89\u88dd\u6240\u6709\u6240\u9700\u7684\u5957\u4ef6 (packages) \u6216\u662f\u670d\u52d9\u4f9d\u8cf4 (dependency)\uff0c\u800c\u5728\u5b89\u88dd\u7684\u904e\u7a0b\u4e2d\u82e5\u6709\u758f\u5ffd\uff0c\u9084\u5f88\u6709\u53ef\u80fd\u9020\u6210\u90e8\u7f72\u7a0b\u5f0f\u767c\u751f\u7121\u9810\u671f\u7684\u932f\u8aa4\u3002\u56e0\u6b64\uff0c\u81ea\u52d5\u5316\u5c31\u662f\u56e0\u70ba\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u7a2e\u6982\u5ff5\u3002 \u82e5\u6211\u5011\u53ef\u4ee5\u5c07\u6bcf\u4e00\u6b21\u90e8\u7f72\u7684\u6b65\u9a5f\u5beb\u6210\u4e00\u500b\u81ea\u52d5\u5316\u7684\u6a19\u6e96\u4f5c\u696d\u7a0b\u5e8f (Standard Operating Procedures, SOP)\uff0c\u9664\u4e86\u53ef\u4ee5\u6709\u6548\u7e2e\u77ed\u6bcf\u6b21\u7684\u90e8\u7f72\u6642\u9593\u53ca\u964d\u4f4e\u51fa\u932f\u7387\u5916\uff0c\u5728\u672a\u4f86\u9700\u8981\u5347\u7d1a\u90e8\u7f72\u74b0\u5883\uff0c\u4e5f\u6703\u76f8\u5c0d\u5bb9\u6613\u8a31\u591a\u3002\u800c Ansible \u5c31\u662f\u76ee\u524d\u696d\u754c\u6700\u5e38\u4f7f\u7528\u7684\u81ea\u52d5\u5316\u5de5\u5177\u4e4b\u4e00\u3002 \u70ba\u4ec0\u9ebc\u8981\u9078\u64c7 Ansible\uff1f \u00b6 \u76ee\u524d\u696d\u754c\u4e2d\u4e3b\u6d41\u7684\u81ea\u52d5\u5316\u90e8\u7f72\u5de5\u5177\u9664\u4e86 Ansible \u4e4b\u5916\u9084\u6709 Chef\u3001Otter\u3001Puppet\u3001SaltStack \u7b49\u7b49\u3002\u6bcf\u4e00\u500b\u9663\u71df\u90fd\u6709\u5927\u91cf\u7684\u64c1\u8b77\u8005\u4ee5\u53ca\u5404\u81ea\u7684\u512a\u7f3a\u9ede\uff0c\u5176\u5be6\u5728\u9019\u500b\u554f\u984c\u4e0a\u4e26\u6c92\u6709\u8ab0\u7d55\u5c0d\u512a\u65bc\u8ab0\u7684\u7b54\u6848\u3002\u4e4b\u6240\u4ee5\u9078\u64c7 Ansible \u4f5c\u70ba\u81ea\u52d5\u5316\u7684\u5de5\u5177\uff0c\u4e3b\u8981\u539f\u56e0\u662f\u56e0\u70ba Ansible \u771f\u7684\u5bb9\u6613\u5b78\u7fd2\u8a31\u591a\u3002\u5728\u9078\u64c7\u5de5\u5177\u7684\u904e\u7a0b\u4e2d\uff0c\u6211\u76f8\u4fe1\u6700\u91cd\u8981\u7684\u8003\u91cf\u61c9\u8a72\u5728\u65bc\u6211\u5011\u80fd\u4e0d\u80fd\u5920\u5728\u6700\u77ed\u7684\u6642\u9593\u5167\u638c\u63e1\u9019\u500b\u5de5\u5177\u4e26\u6709\u6548\u5730\u89e3\u6c7a\u6211\u5011\u6240\u9047\u5230\u7684\u554f\u984c\u3002 \u5728\u9019\u6a23\u7684\u524d\u63d0\u4e0b\uff0cAnsible \u5c31\u6210\u70ba\u8a31\u591a\u958b\u767c\u5718\u968a\u7684\u9996\u9078\u4e86\u3002\u9664\u4e86\u5bb9\u6613\u5b78\u7fd2\u4e4b\u5916\uff0cAnsible \u672c\u8eab\u5728 GitHub \u4e0a\u4e5f\u662f\u4e00\u500b\u958b\u6e90\u7684\u5c08\u6848\u3002\u6709\u4e86\u5927\u91cf\u958b\u767c\u4eba\u54e1\u7684\u5e6b\u52a9\u53ca\u56de\u994b\uff0cAnsible \u9019\u5957\u8edf\u9ad4\u7684\u6210\u9577\u901f\u5ea6\u5176\u5be6\u662f\u771f\u7684\u76f8\u7576\u9a5a\u4eba\u7684\u3002 Ansible \u7684\u9700\u6c42 \u00b6 \u7531\u65bc Ansible \u662f\u4f7f\u7528 Python \u958b\u767c\u7684\u4e00\u5957\u514d\u8cbb\u8edf\u9ad4\uff0c\u8981\u900f\u904e Ansible \u5728\u9059\u63a7\u7bc0\u9ede (remote node) \u4e0a\u914d\u7f6e\u74b0\u5883\uff0c\u552f\u4e8c\u7684\u689d\u4ef6\u53ea\u6709\uff1a \u5b89\u88dd Python \u900f\u904e SSH \u9032\u884c\u9023\u7dda \u5728\u73fe\u5728\u5927\u90e8\u5206\u7684 Linux \u4e3b\u6a5f\u4e0a\uff0c\u57fa\u672c\u4e0a Python \u5df2\u7d93\u90fd\u662f\u57fa\u672c\u914d\u5099\u4e86\uff0c\u6240\u4ee5\u9019\u6a23\u7684\u8981\u6c42\u7b49\u65bc\u6c92\u6709\u8981\u6c42\u3002\u6211\u5011\u53ea\u9700\u8981\u5728\u5b89\u88dd\u597d Ansible \u7684\u4e3b\u6a5f (control machine) \u4e0a\u900f\u904e SSH \u8207\u9059\u63a7\u7bc0\u9ede\u6e9d\u901a\uff0c\u5c31\u53ef\u4ee5\u8f15\u9b06\u505a\u5230\u4e00\u9375\u90e8\u7f72\uff01 Ansible \u5b89\u88dd \u00b6 \u5728 Ansible \u88e1\uff0c\u6703\u628a\u6240\u6709\u6a5f\u5668\u7684\u89d2\u8272\u505a\u4ee5\u4e0b\u5169\u7a2e\u5340\u5206\uff1a \u63a7\u5236\u4e3b\u6a5f (Control Machine) \uff1a\u9867\u540d\u601d\u7fa9\uff0c\u9019\u985e\u4e3b\u6a5f\u53ef\u4ee5\u900f\u904e\u904b\u884c Ansible \u7684\u5287\u672c (playbook) \u5c0d\u7ba1\u7406\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u3002 \u7ba1\u7406\u7bc0\u9ede (Managed Node) \uff1a\u4e5f\u7a31\u70ba\u9059\u63a7\u7bc0\u9ede (Remote Node)\u3002\u76f8\u5c0d\u65bc\u63a7\u5236\u4e3b\u6a5f\uff0c\u9019\u985e\u7bc0\u9ede\u5c31\u662f\u6211\u5011\u900f\u904e Ansible \u9032\u884c\u90e8\u7f72\u7684\u5c0d\u8c61\u3002 \u5c0d\u65bc\u9019\u5169\u7a2e\u4e0d\u540c\u7684\u5c0d\u8c61\uff0c\u5728\u5b89\u88dd / \u4f7f\u7528 Ansible \u7684\u6642\u5019\u4e5f\u6709\u4e0d\u540c\u7684\u9700\u6c42\u3002 \u5b89\u88dd Ansible \u5728\u63a7\u5236\u4e3b\u6a5f \u00b6 \u7531\u65bc Ansible \u662f\u4e00\u5957\u958b\u6e90\u7684\u8edf\u9ad4\uff0c\u6240\u4ee5\u5728\u76ee\u524d\u5927\u90e8\u5206\u7684\u4e3b\u6d41\u4f5c\u696d\u7cfb\u7d71\u4e0a\u90fd\u5df2\u7d93\u53ef\u4ee5\u900f\u904e\u5c0d\u61c9\u7684\u5957\u4ef6\u7ba1\u7406 (package manager) \u9032\u884c\u5b89\u88dd\u4e86\u3002\u4ee5\u4e0b\u5217\u51fa\u5e7e\u500b\u6211\u4e3b\u8981\u6bd4\u8f03\u5e38\u7528\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u65b9\u6cd5\uff1a Ubuntu CentOS/RHEL bash $ sudo apt update $ sudo apt install software-properties-common $ sudo add-apt-repository --yes --update ppa:ansible/ansible $ sudo apt install ansible $ sudo yum install epel-release $ sudo yum install ansible \u5b89\u88dd\u597d\u4ee5\u5f8c\uff0c\u78ba\u8a8d Ansible \u5df2\u7d93\u5b89\u88dd\u5b8c\u6210\uff1a $ ansible --version ansible [ core 2 .12.6 ] config file = /etc/ansible/ansible.cfg configured module search path = [ '/home/dxlab/.ansible/plugins/modules' , '/usr/share/ansible/plugins/modules' ] ansible python module location = /usr/lib/python3/dist-packages/ansible ansible collection location = /home/dxlab/.ansible/collections:/usr/share/ansible/collections executable location = /usr/bin/ansible python version = 3 .9.7 ( default, Sep 10 2021 , 14 :59:43 ) [ GCC 11 .2.0 ] jinja version = 3 .1.1 libyaml = True \u5b89\u88dd Ansible \u5728\u7ba1\u7406\u7bc0\u9ede \u00b6 \u4e0d\u9700\u8981\uff01\u900f\u904e Ansible \u7ba1\u7406\u7684\u7ba1\u7406\u7bc0\u9ede\u5b8c\u5168\u4e0d\u9700\u8981\u5b89\u88dd Ansible\u3002\u5982\u4e0a\u500b\u7ae0\u7bc0\u6240\u8ff0\uff0c\u6211\u5011\u53ea\u9700\u8981\u78ba\u4fdd\u9019\u500b\u7ba1\u7406\u7bc0\u9ede\u53ef\u4ee5\u900f\u904e SSH \u8207\u63a7\u5236\u4e3b\u6a5f\u6e9d\u901a\uff0c\u4e26\u5df2\u5b89\u88dd Python 2.6 \u4ee5\u4e0a\u7684\u7248\u672c\u5c31\u53ef\u4ee5\u900f\u904e\u63a7\u5236\u4e3b\u6a5f\u7ba1\u7406\u4e86\u3002 \u5b89\u88dd Ansible-lint \u00b6 \u5728\u7de8\u5beb\u7a0b\u5f0f/\u8173\u672c\u7684\u6642\u5019\uff0c\u6211\u90fd\u6703\u7fd2\u6163\u53bb\u627e\u5c0d\u61c9\u8a9e\u8a00\u7684 linter \u4f86\u7fd2\u6163\u8a72\u8a9e\u8a00\u7684\u98a8\u683c\u3002\u96d6\u7136 Ansbile \u4e26\u4e0d\u662f\u4e00\u7a2e\u7a0b\u5f0f\u8a9e\u8a00\uff0c\u4f46\u5b83\u4e5f\u6709\u4e00\u500b\u5c0d\u61c9\u7684 linter - Ansible-lint\u3002\u6211\u6703\u5efa\u8b70\u5927\u5bb6\u53ef\u4ee5\u5b89\u88dd\u9019\u500b\u5c0f\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u5e6b\u52a9\u4f60\u78ba\u4fdd\u5beb\u51fa\u4f86\u7684\u8173\u672c\u54c1\u8cea\u662f\u6709\u4e00\u5b9a\u6c34\u6e96\u7684\u3002 sudo pip install ansible-lint \u6aa2\u67e5\uff1a ansible-lint 6.2.1 using ansible 2.12.6 \u64b0\u5beb\u7b2c\u4e00\u500b Playbook \u00b6 \u7576\u78ba\u8a8d Ansible \u5df2\u7d93\u6b63\u78ba\u5730\u5b89\u88dd\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4e4b\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u5c31\u53ef\u4ee5\u6e96\u5099\u900f\u904e Ansible \u5c0d\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u4e86\u3002\u7136\u800c\uff0c\u6211\u5011\u8981\u5982\u4f55\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u5c0d\u9059\u63a7\u7bc0\u9ede\u505a\u4e9b\u4ec0\u9ebc\u5462\uff1f\u5728 Ansible \u7684\u4e16\u754c\u88e1\uff0c\u6211\u5011\u662f\u900f\u904e\u7de8\u5beb \u5287\u672c (playbook) \u4f86\u544a\u8a34 Ansible \u63a5\u4e0b\u4f86\u9700\u8981\u505a\u7684\u4e8b\u9805\u3002 \u7531\u65bc Ansible \u7684\u5287\u672c\u662f\u7528 YAML (YAML Ain't Markup Language) \u9019\u7a2e\u8a9e\u8a00\u4f86\u64b0\u5beb\uff0c\u800c\u9019\u500b\u8a9e\u8a00\u6700\u5927\u7684\u7279\u8272\u5c31\u662f\u5177\u6709\u9ad8\u5ea6\u53ef\u8b80\u6027\uff0c\u56e0\u6b64\u7121\u8ad6\u6709\u6c92\u6709\u7a0b\u5f0f\u8a9e\u8a00\u7684\u57fa\u790e\uff0c\u7406\u8ad6\u4e0a\u4efb\u4f55\u4eba\u5728\u770b\u5230\u4e00\u4efd\u597d\u7684 Ansible playbook \u7684\u6642\u5019\u61c9\u8a72\u90fd\u662f\u975e\u5e38\u5bb9\u6613\u7406\u89e3\u53ca\u8457\u624b\u4fee\u6539\u7dad\u8b77\u7684\u3002 \u7b2c\u4e00\u500b playbook \u00b6 \u4ee5\u4e0b\u5148\u7528\u4e00\u500b\u975e\u5e38\u7c21\u55ae\u7684\u7bc4\u4f8b\u4f86\u4ecb\u7d39 playbook \u7684\u904b\u4f5c\u65b9\u5f0f\u3002\u6211\u5011\u5148\u5275\u5efa\u4e00\u500b playbook \u6a94\u6848\uff0c\u5c07\u5176\u547d\u540d\u70ba playbook.yml \u4e26\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u4e0b (e.g. vagrant_getting_started/playbook.yml)\u3002\u63a5\u8457\uff0c\u958b\u555f\u6a94\u6848\u4e26\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u76f8\u4fe1\u5927\u5bb6\u5c31\u7b97\u5f9e\u4f86\u6c92\u6709\u5beb\u904e Ansible \u7684 playbook\uff0c\u61c9\u8a72\u9084\u662f\u4e0d\u96e3\u731c\u51fa\u9019\u4efd playbook \u5728\u505a\u4e9b\u4ec0\u9ebc\u3002\u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u5728\u9019\u4efd playbook \u4e2d\u5b9a\u7fa9\u4e86\u4efb\u52d9\u6e05\u55ae tasks \u4ee5\u53ca\u90e8\u7f72\u5c0d\u8c61 hosts: sre001 \u3002 \u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u5728\u4e4b\u524d\u7684\u7ae0\u7bc0\u4e2d\u6211\u5011\u63d0\u5230\u4e86\u6700\u597d\u628a\u6bcf\u4e00\u500b\u865b\u64ec\u4e3b\u6a5f\u90fd\u505a\u547d\u540d\u3002\u4e3b\u6a5f\u547d\u540d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u900f\u904e\u4e3b\u6a5f\u7684\u540d\u7a31\u76f4\u63a5\u9032\u884c\u64cd\u4f5c\uff08\u6211\u5011\u6703\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u63d0\u5230\u82e5\u4e0d\u900f\u904e Vagrant \u8981\u5982\u4f55\u547d\u540d\u4e3b\u6a5f\uff09\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e name \u9019\u500b\u6a19\u7c64\u66ff\u4efb\u52d9\u6e05\u55ae\u4e2d\u7684\u6bcf\u500b task \u5206\u5225\u547d\u540d\u3002\u5728\u63a5\u4e0b\u4f86\u904b\u884c playbook \u7684\u904e\u7a0b\u4e2d\u82e5\u767c\u751f\u932f\u8aa4\uff0c\u6211\u5011\u4e5f\u6703\u6bd4\u8f03\u6e05\u695a\u662f\u5728\u54ea\u4e00\u500b\u74b0\u7bc0\u4e0a\u51fa\u4e86\u554f\u984c\u3002 \u5728\u9019\u500b playbook \u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u5169\u500b task\uff1a 1. test connection Info \u6211\u5011\u5728\u9019\u500b task \u4e2d\uff0c\u547c\u53eb\u4e86 Ansible \u7684\u5167\u5efa\u6e2c\u8a66\u6a21\u7d44 (module) - ping \u3002\u9019\u500b\u6a21\u7d44\u7684\u76ee\u7684\u975e\u5e38\u985e\u4f3c\u5728\u5b78\u7fd2\u6bcf\u500b\u8a9e\u8a00\u4e00\u958b\u59cb\u7df4\u7fd2\u7684 \"Hello World\" \u7a0b\u5f0f\u3002\u5176\u4e3b\u8981\u662f\u7528\u4f86\u6e2c\u8a66\u64cd\u63a7\u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u6b63\u78ba\u5730\u8207\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u6e9d\u901a\uff0c\u5982\u679c\u9023\u7dda\u6b63\u5e38\uff0c\u9059\u63a7\u7bc0\u9ede\u5c31\u6703\u56de\u50b3\u4e00\u500b \"pong\" \u7684\u8a0a\u606f\u7d66\u63a7\u5236\u4e3b\u6a5f\u3002\u63a5\u8457\uff0c\u6211\u5011\u900f\u904e\u53e6\u4e00\u500b Ansible \u5167\u5efa\u6a21\u7d44 - register \u628a\u9059\u63a7\u7bc0\u9ede\u56de\u50b3\u7684\u8a0a\u606f\u5b58\u6210\u8b8a\u6578 (variable) \u7684\u5f62\u5f0f\u3002 \u6ce8\u610f\uff1a\u6b64\u8655\u7684 ping \u4e26\u975e\u5efa\u7acb\u5728 ICMP \u5354\u5b9a\u4e0b\u7684 ping \u6307\u4ee4\uff0c\u53ea\u662f\u7d14 Ansible \u958b\u767c\u7684\u4e00\u500b\u7c21\u55ae\u6e2c\u8a66\u6a21\u7d44\u3002 \u6a21\u7d44: ansible.builtin.ping 2. print debug message Info \u5728\u4e0a\u4e00\u500b task \u4e2d\uff0c\u6211\u5011\u5df2\u7d93\u628a ping \u5f8c\u7684\u7d50\u679c\u5b58\u5728 message \u9019\u500b\u8b8a\u6578\u4e2d\u4e86\u3002\u6211\u5011\u53ef\u4ee5\u5229\u7528 debug \u9019\u500b\u6a21\u7d44\u628a\u5132\u5b58\u7684\u8a0a\u606f\u8f38\u51fa\u5230\u6211\u5011\u7684\u7d42\u7aef\u6a5f\u4e0a\u3002\u5728 Ansible \u4e2d\uff0c\u82e5\u8981\u8abf\u7528\u5132\u5b58\u8b8a\u6578\uff0c\u6211\u5011\u5fc5\u9808\u5728\u8b8a\u6578\u540d\u7a31\u5916\u52a0\u4e0a\u5169\u500b\u5927\u62ec\u5f27 - {{ }} \u4f86\u544a\u8a34 Ansible \u5927\u62ec\u5f27\u5167\u7684\u662f\u4e00\u500b\u8b8a\u6578 \uff08\u5982\u679c\u8b8a\u6578\u5728\u63cf\u8ff0\u53e5 (statement) \u7684\u958b\u982d\uff0c\u9084\u5fc5\u9808\u8981\u984d\u5916\u52a0\u4e0a\u4e00\u500b\u96d9\u5f15\u865f - \"\"\uff09\u3002 \u6a21\u7d44: ansible.builtin.debug \u6aa2\u67e5 playbook \u00b6 \u5229\u7528 Ansible-lint \u4f86\u6aa2\u67e5 playbook: $ ansible-lint playbook.yml \u5982\u679c\u6c92\u6709\u770b\u5230\u4efb\u4f55\u8f38\u51fa\u5c31\u8868\u793a\u4f60\u7684 playbook \u5b8c\u5168\u6c92\u6709\u554f\u984c\uff01\u4e0d\u904e\u70ba\u4e86\u5c55\u793a Ansible-lint \u7684\u63d0\u793a\u6548\u679c\uff0c\u6211\u5728 playbook \u7684\u7b2c\u4e94\u884c\u53e5\u5c3e\u52a0\u4e0a\u4e00\u500b\u7a7a\u767d\uff1a - name: test connection ~ \u63a5\u8457\uff0c\u91cd\u65b0\u8f38\u5165\u525b\u525b\u7684\u6307\u4ee4\uff1a $ ansible-lint playbook.yml WARNING Listing 1 violation ( s ) that are fatal yaml: trailing spaces ( yaml [ trailing-spaces ]) playbook.yml:5 You can skip specific rules or tags by adding them to your configuration file: # .config/ansible-lint.yml warn_list: # or 'skip_list' to silence them completely - yaml # Violations reported by yamllint. Finished with 1 failure ( s ) , 0 warning ( s ) on 1 files. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 Ansible-lint \u544a\u8a34\u6211\u5011\u5728 playbook.yml:5 \u7b2c\u4e94\u884c\u7684\u5730\u65b9\u6709\u500b\u5f8c\u7db4\u7a7a\u767d (trailing whitespace)\uff0c\u70ba\u4e86\u4fdd\u6301\u7a0b\u5f0f\u78bc\u7684\u7c21\u6f54\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u5176\u522a\u9664\u3002 \u5728\u5b9a\u7fa9\u597d\u4e86\u6211\u5011\u7684\u7b2c\u4e00\u500b playbook \u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u662f\u5982\u4f55\u904b\u884c\u6211\u5011\u5beb\u597d\u7684 playbook\u3002 \u904b\u884c playbook \u00b6 \u8981\u900f\u904e Ansible \u4f86\u904b\u884c playbook \u76f8\u7576\u5bb9\u6613\uff0c\u6211\u5011\u53ea\u8981\u4f7f\u7528 ansible-playbook \u7684\u6307\u4ee4\u5c31\u53ef\u4ee5\u8f15\u6613\u904b\u884c\u6211\u5011\u7de8\u5beb\u597d\u7684 playbook\uff1a $ ansible-playbook playbook.yml \u57f7\u884c\u5b8c\u7562\u5f8c\u6211\u5011\u61c9\u8a72\u53ef\u4ee5\u5728\u7d42\u7aef\u6a5f\u4e0a\u770b\u5230\u4ee5\u4e0b\u7684\u8f38\u51fa\uff1a [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all' [WARNING]: Could not match supplied host pattern, ignoring: sre001 PLAY [sre001] ***************************************************************************************************************************************************************** skipping: no hosts matched PLAY RECAP ******************************************************************************************************************************************************************** \u4ec0\u9ebc\u662f inventory? \u00b6 \u5728\u770b\u5230\u8f38\u51fa\u7d50\u679c\u5f8c\uff0c\u6211\u76f8\u4fe1\u5927\u90e8\u5206\u7684\u8b80\u8005\u53ef\u80fd\u6703\u7d0d\u60b6\u70ba\u4ec0\u9ebc\u8f38\u51fa\u7d50\u679c\u6c92\u6709\u4efb\u4f55\u57f7\u884c\u6210\u529f\u6216\u5931\u6557\u7684\u8cc7\u8a0a\u3002\u5f9e\u7d42\u7aef\u6a5f\u7684\u7d50\u679c\u6211\u5011\u53ef\u4ee5\u77e5\u9053 Ansible \u4ec0\u9ebc\u4efb\u52d9\u90fd\u6c92\u6709\u505a\uff0c\u9019\u6a23\u7684\u7d50\u679c\u4e5f\u4e0d\u662f\u6211\u5011\u6240\u9810\u671f\u7684\u3002\u5728\u89e3\u6c7a\u9019\u554f\u984c\u4e4b\u524d\uff0c\u8b93\u6211\u5011\u5148\u56de\u61b6\u4e00\u4e0b\u6211\u5011\u4e4b\u524d\u64b0\u5beb\u7684 playbook.yml \uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u5f9e\u9019\u4efd playbook \u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5f88\u6e05\u695a\u5730\u770b\u5230 Ansible \u61c9\u8a72\u8981\u5c0d sre001 \u9019\u53f0\u4e3b\u6a5f\u9032\u884c\u4efb\u52d9\u6e05\u55ae\u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002\u5728\u4e4b\u524d Vagrant \u4ecb\u7d39\u4e2d\uff0c\u6211\u5011\u7684\u78ba\u5c0d\u904b\u884c\u8d77\u4f86\u7684\u4e3b\u6a5f\u9032\u884c\u4e86\u547d\u540d\uff0c\u7136\u800c\uff0c\u6211\u5011\u537b\u5f9e\u4f86\u6c92\u6709\u544a\u8a34 Ansible \u904e\u54ea\u4e00\u53f0\u4e3b\u6a5f\u662f sre001 \u3002 \u56e0\u6b64\uff0c\u89e3\u6c7a\u9019\u500b\u554f\u984c\u6700\u76f4\u63a5\u7684\u65b9\u6cd5\u5c31\u662f\u5b9a\u7fa9\u4e00\u500b\u4e3b\u6a5f\u5217\u8868 inventory \u4e26\u8b93 Ansible \u53c3\u7167\uff0c\u9019\u6a23 Ansible \u624d\u6703\u77e5\u9053\u8a72\u5c0d\u8ab0\u505a\u4ec0\u9ebc\u4e8b\u3002 \u70ba\u4e86\u77e5\u9053 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u8a73\u7d30\u8cc7\u6599\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e vagrant ssh-config \u4f86\u5217\u51fa\u4e3b\u6a5f\u7684\u76f8\u95dc\u8cc7\u8a0a\uff1a $ vagrant ssh-config Host sre001 HostName 127 .0.0.1 User vagrant Port 2201 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL Tip \u6bcf\u4e00\u500b\u4eba\u7684\u56de\u61c9\u53ef\u80fd\u56e0\u500b\u4eba\u672c\u6a5f\u7684\u72c0\u6cc1\u6703\u6709\u6240\u4e0d\u540c\uff0c\u8acb\u7279\u5225\u6ce8\u610f Port \u8207 IdentifyFile \u7684\u8cc7\u8a0a\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728\u7576\u4e0b\u7684\u76ee\u9304\u4e0b\u65b0\u589e\u4e00\u500b\u6a94\u6848\u4e26\u547d\u540d\u70ba inventory . \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 Vagrantfile \u7136\u5f8c\u5728\u6a94\u6848\u5167\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a [sre001] 127.0.0.1 ansible_port=2201 ansible_user=vagrant ansible_ssh_common_args='-o StrictHostKeyChecking=no' \u6839\u64da vagrant ssh-config \u5217\u51fa\u4f86\u7684\u4e3b\u6a5f\u8cc7\u8a0a\uff0c\u6211\u5011\u5728 inventory \u4e2d\u4f9d\u5e8f\u5b9a\u7fa9\u4e86 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u9023\u7dda IP\u3001port \u5165\u53e3\u4ee5\u53ca\u767b\u5165\u4f7f\u7528\u8005\u7684\u8eab\u4efd\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u91cd\u65b0\u57f7\u884c\u904b\u884c\u6307\u4ee4\uff0c\u4e26\u5c07\u9019\u4efd\u4e3b\u6a5f\u6e05\u55ae\u6307\u5b9a\u7d66 Ansible \u53c3\u7167\uff1a $ ansible-playbook -i inventory playbook.yml \u73fe\u5728\uff0c\u8f38\u51fa\u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** fatal: [127.0.0.1]: UNREACHABLE! => {\"changed\": false, \"msg\": \"Failed to connect to the host via ssh: @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\n@ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @\\r\\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\\r\\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\\r\\nIt is also possible that a host key has just been changed.\\r\\nThe fingerprint for the ECDSA key sent by the remote host is\\nSHA256:7WcamAcB+cK5FXwfTxMiXBeovKpBFqpv4k4J6JzODYw.\\r\\nPlease contact your system administrator.\\r\\nAdd correct host key in /home/dxlab/.ssh/known_hosts to get rid of this message.\\r\\nOffending ECDSA key in /home/dxlab/.ssh/known_hosts:3\\r\\n remove with:\\r\\n ssh-keygen -f \\\"/home/dxlab/.ssh/known_hosts\\\" -R \\\"[127.0.0.1]:2201\\\"\\r\\nECDSA host key for [127.0.0.1]:2201 has changed and you have requested strict checking.\\r\\nHost key verification failed.\", \"unreachable\": true} PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=0 changed=0 unreachable=1 failed=0 skipped=0 rescued=0 ignored=0 \u73fe\u5728 Ansible \u77e5\u9053\u8ab0\u662f sre001 \u4e86\uff01\u4e0d\u904e\uff0c\u770b\u8d77\u4f86 Ansible \u4f3c\u4e4e\u4e26\u6c92\u6709\u8fa8\u6cd5\u5c07\u6211\u5011 playbook \u4e2d\u5b9a\u7fa9\u52d5\u4f5c\u6210\u529f\u5730\u90e8\u7f72\u5230 sre001 \u4e0a\u3002 \u8a2d\u5b9a PRIVATE_KEY_FILE \u00b6 \u5f9e\u4e0a\u9762\u7684\u932f\u8aa4\u8a0a\u606f (error message) \u4e2d\u6211\u5011\u53ef\u4ee5\u77e5\u9053\u90e8\u7f72\u5931\u6557\u7684\u539f\u56e0\u767c\u751f\u5728 SSH \u9023\u7dda\u5931\u6557\u3002\u9084\u8a18\u5f97\u6211\u5011\u8aaa\u904e\u4f7f\u7528 Ansible \u90e8\u7f72\u9059\u63a7\u7bc0\u9ede\u5fc5\u9808\u8981\u900f\u904e SSH \u9023\u7dda\u55ce\uff1f\u4e00\u822c\u4f86\u8aaa\uff0c\u6211\u5011\u5982\u679c\u8981\u900f\u904e SSH \u5b58\u53d6\u7db2\u7ad9\u6211\u5011\u6703\u9810\u8a2d\u5c07\u7522\u751f\u51fa\u4f86\u7684\u516c\u7528\u91d1\u9470 (public key) \u5b58\u653e\u5728 ~/.ssh/ \u7684\u8def\u5f91\u4e0b\uff0c\u7136\u5f8c\u518d\u624b\u52d5\u5c07\u9019\u7d44\u91d1\u9470\u52a0\u5230\u6211\u5011\u60f3\u8981\u6388\u6b0a\u7684\u670d\u52d9\u5217\u8868\u4e0a\u3002 \u4e0d\u904e\uff0c\u56e0\u70ba\u6211\u5011\u662f\u4f7f\u7528 Vagrant \u5efa\u7acb\u8d77\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u4f5c\u70ba\u7df4\u7fd2\uff0cVagrant \u5176\u5be6\u5df2\u7d93\u4e8b\u5148\u5e6b\u6211\u5011\u628a\u63a7\u5236\u4e3b\u6a5f\u8207\u9059\u63a7\u7bc0\u9ede\u505a\u597d SSH \u914d\u5c0d\u4e86\uff0c\u6240\u4ee5\u6211\u5011\u4e26\u4e0d\u9700\u8981\u624b\u52d5\u8a2d\u5b9a\u9019\u500b\u90e8\u5206\u3002\u5f9e\u4e0a\u9762\u7684 vagrant ssh-config \u8f38\u51fa\u7684\u7d50\u679c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u4e00\u500b\u7279\u6b8a\u7684\u53c3\u6578\uff1a IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key \u9019\u500b\u53c3\u6578\u544a\u8a34\u4e86\u6211\u5011\u9019\u53f0\u865b\u64ec\u4e3b\u6a5f private key \u7684\u5b58\u653e\u4f4d\u7f6e\uff0c\u6211\u5011\u53ea\u9700\u8981\u900f\u904e\u4ee5\u4e0b\u6307\u4ee4\uff0c\u5c07\u9019\u500b\u6a94\u6848\u7684\u8def\u5f91\u6307\u5b9a\u7d66 Ansible\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6210\u529f\u904b\u884c\u6211\u5011\u7684 playbook \u56c9\uff01 $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u904b\u884c\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [test connection] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [print debug message] **************************************************************************************************************************************************** ok: [127.0.0.1] => { \"msg\": { \"changed\": false, \"failed\": false, \"ping\": \"pong\" } } PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6210\u529f\u63a5\u6536\u5230\u5f9e sre001 \u56de\u50b3\u56de\u4f86\u7684 \"pong\" \u4e86\uff01 Ansible Role \u521d\u767b\u5834 \u00b6 \u73fe\u5728\u5927\u5bb6\u61c9\u8a72\u4e86\u89e3\u5982\u4f55\u64b0\u5beb Ansible playbook \uff0c\u4e26\u5c07\u6211\u5011\u7684\u5de5\u4f5c\u6e05\u55ae\u4ee5 task \u7684\u65b9\u5f0f\u5728 playbook \u4e2d\u8868\u5217\u4e0b\u4f86\u3002\u7136\u800c\uff0c\u5982\u679c Ansible \u53ea\u80fd\u505a\u5230\u9019\u6a23\u7684\u7a0b\u5ea6\uff0c\u5145\u5176\u91cf\u6211\u5011\u53ea\u80fd\u8aaa\u9019\u662f\u4e00\u500b\u6bd4\u8f03\u65b9\u4fbf\u95b1\u8b80\u7684 Shell script \u7f77\u4e86\u3002\u82e5\u662f\u4eca\u5929\u6211\u5011\u6e05\u55ae\u4e2d\u7684\u4efb\u52d9\u6709\u4e0a\u767e\u500b\uff0c\u9019\u6a23\u6211\u5011\u7684 playbook \u4e5f\u53ef\u80fd\u6703\u8b8a\u5f97\u975e\u5e38\u5197\u9577\uff0c\u5c31\u7b97\u8a9e\u6cd5\u518d\u5982\u4f55\u6613\u8b80\uff0c\u6574\u9ad4\u800c\u8a00 playbook \u9084\u662f\u6703\u8b8a\u5f97\u5341\u5206\u96e3\u4ee5\u7406\u89e3\u3002 \u53e6\u5916\uff0c\u5f88\u591a\u6642\u5019\u5176\u5be6\u6211\u5011\u6703\u5e0c\u671b\u6709\u90e8\u5206\u7684\u90e8\u7f72\u5167\u5bb9\u662f\u53ef\u4ee5\u88ab\u5176\u4ed6\u4e0d\u540c\u7684 playbook \u91cd\u65b0\u4f7f\u7528\u3002\u8209\u4f8b\u4f86\u8aaa\uff0c\u5f88\u591a\u670d\u52d9\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 pip \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u4f86\u9032\u884c\u5b89\u88dd\uff0c\u6211\u5011\u4e26\u4e0d\u6703\u5e0c\u671b\u5728\u6bcf\u4e00\u500b\u4e0d\u540c\u7684 playbook \u4e2d\u90fd\u8981\u91cd\u65b0\u5b9a\u7fa9\u4e00\u6b21 pip \u7684\u5b89\u88dd\u65b9\u6cd5\u3002 \u56e0\u6b64\uff0c\u70ba\u4e86\u89e3\u6c7a\u4e0a\u8ff0\u7684\u554f\u984c\uff0cAnsible \u63d0\u4f9b\u4e86\u6211\u5011\u5728\u64b0\u5beb\u81ea\u52d5\u5316\u8173\u672c\u6642\u4e00\u500b\u89d2\u8272 role \u7684\u6982\u5ff5\u3002\u6211\u5011\u53ef\u4ee5\u900f\u904e\u64b0\u5beb\u5c6c\u65bc\u81ea\u5df1\u7684 role \u4f86\u8b93\u6240\u6709 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u85c9\u6b64\u63d0\u5347\u900f\u904e Ansible \u81ea\u52d5\u5316\u7684\u9748\u6d3b\u5ea6\u3002 \u7b2c\u4e00\u500b role \u00b6 \u8003\u91cf\u5230\u7531\u65bc\u5b89\u88dd cURL \u7684\u9019\u500b\u5de5\u4f5c\u5f88\u53ef\u80fd\u6703\u5728\u672a\u4f86\u983b\u7e41\u5730\u88ab\u4e0d\u540c\u7684 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u56e0\u6b64\uff0c\u6211\u5011\u9078\u64c7\u628a\u5b89\u88dd cURL \u7684\u65b9\u6cd5\u5beb\u6210\u4e00\u500b\u53ef\u4ee5\u91cd\u8907\u88ab\u5229\u7528\u7684 role \uff0c\u800c\u975e playbook \u4e2d\u7684\u4e00\u500b task\u3002 \u8b93\u6211\u5011\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848 (\u65b0\u589e roles/curl/main.yml )\uff1a workspace \u251c\u2500\u2500 Vagrantfile \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 roles \u2514\u2500\u2500 curl \u2514\u2500\u2500 tasks \u2514\u2500\u2500 main.yml \u5728\u9019\u500b\u7d50\u69cb\u4e0b\uff0c curl \u5c31\u662f\u6211\u5011\u7684\u7b2c\u4e00\u500b role \u7684\u540d\u7a31\uff0c\u800c\u9019\u500b role \u7684\u5de5\u4f5c\u6d41\u7a0b\u5c31\u6703\u88ab\u6211\u5011\u5b9a\u7fa9\u5728\u4e0b\u9762\u7684 tasks/main.yml \u4e4b\u4e2d\u3002\u73fe\u5728\u6253\u958b curl/tasks/main.yml \u4e26\u5728\u5176\u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a curl/tasks/main.yml --- - name : install curl ansible.builtin.apt : name : curl \u6211\u5011\u5728\u9019\u500b role \u7684\u5167\u5bb9\u4e2d\u547c\u53eb\u4e86 Ansible \u5167\u5efa\u6a21\u7d44 apt \uff0c\u4e26\u5229\u7528\u5b83\u76f4\u63a5\u9032\u884c cURL \u7684\u5b89\u88dd\u3002\u63a5\u8457\uff0c\u6253\u958b\u6211\u5011\u7684 playbook.yml\uff0c\u4e26\u4fee\u6539\u70ba\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : ironman roles : - { role : curl , become : yes } \u6211\u5011\u522a\u9664\u4e86\u4e4b\u524d\u7528\u4f86\u6e2c\u8a66\u7684 ping \u5287\u78bc (play)\uff0c\u4e26\u5728\u9019\u500b playbook \u4e2d\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u57f7\u884c curl \u9019\u500b\u6211\u5011\u525b\u5b9a\u7fa9\u597d\u7684 role\u3002\u5176\u4e2d\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c become \u4ee3\u8868\u6211\u5011\u8981\u5347\u9ad8\u7576\u524d\u4f7f\u7528\u8005\u6b0a\u9650 \uff08\u7b49\u6548\u65bc Unix / Linux \u4e2d\u7684 sudo \u6307\u4ee4\uff09\u4f86\u904b\u884c\u7576\u524d\u5de5\u4f5c\u3002 \u6700\u5f8c\uff0c\u91cd\u65b0\u904b\u884c\u6211\u5011\u7684 playbook $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u5f97\u5230\u4ee5\u4e0b\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] **************************************************************************************************************************************************** ok: [127.0.0.1] PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u914d\u7f6e ansible.cfg \u00b6 \u6709\u4e9b\u6642\u5019\u6211\u5011\u60f3\u8981\u628a\u76f8\u95dc\u7684roles\u7f6e\u653e\u7684\u8def\u5f91\u505a\u4e0d\u540c\u7684\u898f\u5283\u6642\uff0cAnsible \u5c31\u6703\u627e\u4e0d\u5230\u5c0d\u61c9 role \u6a94\u6848\u7684\u4f4d\u7f6e\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5c31\u5fc5\u9808\u900f\u904e\u8a2d\u5b9a Ansible \u7684\u914d\u7f6e\u6a94\u6848 - ansible.cfg \u4f86\u8a2d\u7f6e role \u8def\u5f91 (path)\u3002 \u65b0\u589e\u4e00\u500b\u6a94\u6848 ansible.cfg \u4e26\u52a0\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a ansible.cfg [sre001] roles_path = ./roles \u82e5\u9ede\u9032\u5b98\u65b9\u914d\u7f6e\u6587\u4ef6\u7684\u8aaa\u660e\u9801\u9762\uff0c\u53ef\u4ee5\u767c\u73fe\u9664\u4e86 roles_path \u4e4b\u5916\u9084\u6709\u4e00\u5927\u5806\u53c3\u6578\u53ef\u4ee5\u4f9d\u64da\u4f7f\u7528\u8005\u7684\u9700\u6c42\u9032\u884c\u975e\u5e38\u6709\u5f48\u6027\u7684\u914d\u7f6e\u3002\u5176\u4e2d\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u9019\u500b\u793a\u7bc4\u88e1\u9762\u6211\u662f\u5c07 ansible.cfg \u9019\u500b\u914d\u7f6e\u6a94\u6848\u7f6e\u65bc\u6211\u5011\u5de5\u4f5c\u8cc7\u6599\u593e\u4e4b\u4e0b\uff0c\u76ee\u524d\u5177\u9ad4\u8cc7\u6599\u593e\u7d50\u69cb\u5982\u4e0b\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u2514\u2500\u2500 curl \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4f46\u5f9e\u5b98\u65b9\u6587\u4ef6\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u767c\u73fe\u9664\u4e86\u5c07\u914d\u7f6e\u6a94\u6848\u653e\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u5e95\u4e0b\u5916\uff0c\u9084\u6709\u5176\u4ed6\u5e7e\u7a2e\u4e0d\u540c\u7684\u914d\u7f6e\u65b9\u5f0f\uff1a \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf ANSIBLE_CONFIG \u7f6e\u65bc\u7576\u524d\u76ee\u9304\u4e0b\u7684 ansible.cfg \uff08\u9019\u6b21\u7bc4\u4f8b\u4e2d\u4f7f\u7528\u7684\u65b9\u6cd5\uff09 \u7f6e\u65bc\u6839\u76ee\u9304\u4e0b\u7684 .ansible.cfg \u7f6e\u65bc /etc/ansible/ \u4e0b\u7684 ansible.cfg \u82e5\u6211\u5011\u540c\u6642\u5206\u5225\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u5b58\u5728\u5728\u7cfb\u7d71\u4e2d\uff0cAnsible \u6703\u4f9d\u7167\u4e0a\u8ff0\u9806\u5e8f\u9010\u4e00\u67e5\u627e\u6587\u4ef6\uff0c\u82e5\u627e\u5230\u5176\u4e2d\u4e00\u500b\uff0c\u5c31\u6703\u4f9d\u5176\u8a2d\u5b9a\u9032\u884c\u914d\u7f6e\uff0c\u4e26\u4e0d\u518d\u7e7c\u7e8c\u67e5\u627e\u3002 \u5efa\u7acb Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2 \u00b6 \u5728\u5b8c\u6210\u7b2c\u4e00\u500b\u7c21\u55ae\u7684 role \u4e4b\u5f8c\uff0c\u8b93\u6211\u5011\u8a66\u8457\u5b89\u88dd\u4e00\u500bCI/CD\u7684\u5de5\u5177 Jenkins\u3002 \u81ea\u52d5\u5316 Jenkins \u5b89\u88dd \u00b6 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-jenkins-on-ubuntu-20-04 Jenkins \u5728 Ubuntu \u4e0a\u7684\u5b89\u88dd\u65b9\u5f0f\uff1a $ wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add - $ sudo sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list' $ sudo apt update $ sudo apt install jenkins \u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u6703\u5f9e Jenkins \u5b98\u65b9\u91cb\u51fa\u7684 Debian \u5957\u4ef6\u5eab\u4e2d\u5c07\u5bc6\u9470 (key) \u52a0\u5165\u672c\u5730\uff0c\u4e26\u65b0\u589e\u5c0d\u61c9\u7684\u5009\u5eab (repository) \u5165\u53e3\u3002\u6700\u5f8c\uff0c\u518d\u900f\u904e apt \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u9032\u884c Jenkins \u7684\u5b89\u88dd\u3002\u73fe\u5728\u8b93\u6211\u5011\u628a\u4e0a\u9762\u7684\u6307\u4ee4\u7ffb\u8b6f\u6210 Ansible \u7684\u8173\u672c\uff1a --- - name : add jenkins key ansible.builtin.apt_key : url : https://pkg.jenkins.io/debian-stable/jenkins.io.key state : present - name : add jenkins repository ansible.builtin.apt_repository : repo : deb http://pkg.jenkins.io/debian-stable binary/ state : present - name : install jenkins ansible.builtin.apt : name : jenkins update_cache : yes Tip \u5728\u9019\u6b21\u7684\u4efb\u52d9\u4e2d\u6211\u5011\u4f7f\u7528\u4e86\u4e09\u500bAnsible\u7684\u6a21\u7d44: ansible.builtin.apt_key \u6a21\u7d44 ansible.builtin.apt_repository \u6a21\u7d44 ansible.builtin.apt \u6a21\u7d44 \u5176\u4e2d apt_key \u53ca apt_repository \u90fd\u662f Ansible \u5df2\u7d93\u5167\u5efa\u7684\u5169\u500b\u6a21\u7d44\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5229\u7528\u5b83\u5011\u9032\u884c\u5bc6\u9470\u53ca\u5009\u5eab\u7684\u65b0\u589e\uff0c\u66f4\u591a\u7d30\u7bc0\u64cd\u4f5c\u53ef\u4ee5\u5728\u5b98\u65b9\u7684\u6587\u4ef6\u4e0a\u67e5\u770b\u3002\u800c\u5728 install jenkins \u9019\u500b task \u4e4b\u4e0b\u7684 update_cache \u5176\u5be6\u5c31\u662f\u7b49\u6548\u65bc\u6211\u5011\u5728\u4e00\u822c Ubuntu / Debian \u7cfb\u7d71\u4e0b\u4f7f\u7528 apt-get update \u7684\u6307\u4ee4\uff0c\u82e5\u5728\u64cd\u4f5c Ansible \u7684 apt \u9019\u500b\u6a21\u7d44\u6642\u4f7f\u7528\u4e86 update_cache: yes\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u6703\u5148\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 apt \u5957\u4ef6\u7ba1\u7406\u9032\u884c\u5347\u7d1a\u624d\u505a\u63a5\u4e0b\u4f86\u7684\u52d5\u4f5c\u3002 \u89e3\u91cb\u5b8c\u8981\u505a\u7684\u4e8b\u4ee5\u5f8c\uff0c\u9019\u6b21\u6211\u4e5f\u8981\u540c\u6642\u5c07\u6574\u500b\u5b89\u88dd Jenkins \u7684\u6d41\u7a0b\u5beb\u6210\u53e6\u5916\u4e00\u500b role\u3002\u4e00\u6a23\u7684\uff0c\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e jenkins \u9019\u500b role\uff0c\u4e26\u5728 roles/jenkins/tasks/main.yml \u4e2d\u8f38\u5165\u4ee5\u4e0a\u5167\u5bb9\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 jenkins \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u73fe\u5728\u6211\u5011\u6709\u5169\u500b roles \u4e86\u3002\u56de\u5230\u6211\u5011\u7684 playbook.yml \u4f5c\u4ee5\u4e0b\u7684\u8abf\u6574: playbook.yml --- - hosts : sre001 roles : - { role : curl , become : yes } - { role : jenkins , become : yes } \u91cd\u65b0\u57f7\u884c playbook: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml PLAY [sre001] ************************************************************************************************************* TASK [Gathering Facts] **************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] ************************************************************************************************ ok: [127.0.0.1] TASK [jenkins : add jenkins key] ****************************************************************************************** changed: [127.0.0.1] TASK [jenkins : add jenkins repository] *********************************************************************************** changed: [127.0.0.1] TASK [jenkins : install jenkins] ****************************************************************************************** fatal: [127.0.0.1]: FAILED! => {\"cache_update_time\": 1654304408, \"cache_updated\": true, \"changed\": false, \"msg\": \"'/usr/bin/apt-get -y -o \\\"Dpkg::Options::=--force-confdef\\\" -o \\\"Dpkg::Options::=--force-confold\\\" install 'jenkins'' failed: E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"rc\": 100, \"stderr\": \"E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"stderr_lines\": [\"E: Sub-process /usr/bin/dpkg returned an error code (1)\"], \"stdout\": \"Reading package lists...\\nBuilding dependency tree...\\nReading state information...\\nThe following additional packages will be installed:\\n net-tools\\nThe following NEW packages will be installed:\\n jenkins net-tools\\n0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\\nNeed to get 91.6 MB of archives.\\nAfter this operation, 95.9 MB of additional disk space will be used.\\nGet:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\\nGet:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\\nFetched 91.6 MB in 12s (7,593 kB/s)\\nSelecting previously unselected package net-tools.\\r\\n(Reading database ... \\r(Reading database ... 5%\\r(Reading database ... 10%\\r(Reading database ... 15%\\r(Reading database ... 20%\\r(Reading database ... 25%\\r(Reading database ... 30%\\r(Reading database ... 35%\\r(Reading database ... 40%\\r(Reading database ... 45%\\r(Reading database ... 50%\\r(Reading database ... 55%\\r(Reading database ... 60%\\r(Reading database ... 65%\\r(Reading database ... 70%\\r(Reading database ... 75%\\r(Reading database ... 80%\\r(Reading database ... 85%\\r(Reading database ... 90%\\r(Reading database ... 95%\\r(Reading database ... 100%\\r(Reading database ... 63489 files and directories currently installed.)\\r\\nPreparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\\r\\nUnpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSelecting previously unselected package jenkins.\\r\\nPreparing to unpack .../jenkins_2.332.3_all.deb ...\\r\\nUnpacking jenkins (2.332.3) ...\\r\\nSetting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSetting up jenkins (2.332.3) ...\\r\\nCreated symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\\r\\nJob for jenkins.service failed because the control process exited with error code.\\r\\nSee \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\\r\\ninvoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\\r\\n\u25cf jenkins.service - Jenkins Continuous Integration Server\\r\\n Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\\r\\n Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\\r\\n Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\\r\\n Main PID: 3569 (code=exited, status=1/FAILURE)\\r\\ndpkg: error processing package jenkins (--configure):\\r\\n installed jenkins package post-installation script subprocess returned error exit status 1\\r\\nProcessing triggers for man-db (2.9.1-1) ...\\r\\nProcessing triggers for systemd (245.4-4ubuntu3.17) ...\\r\\nErrors were encountered while processing:\\r\\n jenkins\\r\\n\", \"stdout_lines\": [\"Reading package lists...\", \"Building dependency tree...\", \"Reading state information...\", \"The following additional packages will be installed:\", \" net-tools\", \"The following NEW packages will be installed:\", \" jenkins net-tools\", \"0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\", \"Need to get 91.6 MB of archives.\", \"After this operation, 95.9 MB of additional disk space will be used.\", \"Get:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\", \"Get:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\", \"Fetched 91.6 MB in 12s (7,593 kB/s)\", \"Selecting previously unselected package net-tools.\", \"(Reading database ... \", \"(Reading database ... 5%\", \"(Reading database ... 10%\", \"(Reading database ... 15%\", \"(Reading database ... 20%\", \"(Reading database ... 25%\", \"(Reading database ... 30%\", \"(Reading database ... 35%\", \"(Reading database ... 40%\", \"(Reading database ... 45%\", \"(Reading database ... 50%\", \"(Reading database ... 55%\", \"(Reading database ... 60%\", \"(Reading database ... 65%\", \"(Reading database ... 70%\", \"(Reading database ... 75%\", \"(Reading database ... 80%\", \"(Reading database ... 85%\", \"(Reading database ... 90%\", \"(Reading database ... 95%\", \"(Reading database ... 100%\", \"(Reading database ... 63489 files and directories currently installed.)\", \"Preparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\", \"Unpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Selecting previously unselected package jenkins.\", \"Preparing to unpack .../jenkins_2.332.3_all.deb ...\", \"Unpacking jenkins (2.332.3) ...\", \"Setting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Setting up jenkins (2.332.3) ...\", \"Created symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\", \"Job for jenkins.service failed because the control process exited with error code.\", \"See \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\", \"invoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\", \"\u25cf jenkins.service - Jenkins Continuous Integration Server\", \" Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\", \" Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\", \" Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\", \" Main PID: 3569 (code=exited, status=1/FAILURE)\", \"dpkg: error processing package jenkins (--configure):\", \" installed jenkins package post-installation script subprocess returned error exit status 1\", \"Processing triggers for man-db (2.9.1-1) ...\", \"Processing triggers for systemd (245.4-4ubuntu3.17) ...\", \"Errors were encountered while processing:\", \" jenkins\"]} PLAY RECAP **************************************************************************************************************** 127.0.0.1 : ok=4 changed=2 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 \u57f7\u884c\u7684\u7d50\u679c\u5728 install jenkins \u51fa\u73fe\u5931\u6557\u3002\u53bb\u67e5\u8a62 Jenkins \u5b98\u7db2\u767c\u73fe Jenkins \u5fc5\u9700\u8981\u4f9d\u8cf4 Java \u624d\u80fd\u5920\u6b63\u78ba\u904b\u884c\u4e4b\u524d\uff0c\u4e5f\u5c31\u662f\u8aaa\u9664\u4e86\u5728 ansible \u4e2d\u8a2d\u5b9a\u5b89\u88dd Java \u4e4b\u5916, \u9084\u5fc5\u9700\u8b93 jenkins \u662f\u5728 java \u5b89\u88dd\u5b8c\u4e4b\u5f8c\u624d\u80fd\u63a5\u7e8c\u5b89\u88dd\u3002 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-on-ubuntu-20-04#installing-specific-versions-of-openjdk Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2 \u00b6 \u5728 Ansible \u7684\u4e16\u754c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e\u5b9a\u7fa9 role \u8207 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2 role dependencies \u4f86\u63d0\u5347\u6bcf\u4e00\u500b role \u7684\u53ef\u8b80\u6027\u8207\u76f8\u4e92\u7684\u4f9d\u8cf4\u3002\u5c31\u4ee5\u4e0a\u9762\u7684\u4f8b\u5b50\u800c\u8a00\uff0c\u6211\u5011\u5e0c\u671b\u6240\u6709\u90e8\u7f72 Jenkins \u7684\u4f3a\u670d\u5668\u90fd\u9810\u5148\u642d\u8f09\u597d Java\uff0c\u82e5\u7528 Ansible \u7684\u89d2\u5ea6\u601d\u8003\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u5e0c\u671b jenkins \u9019\u500b role \u4f9d\u8cf4\u65bc openjre \u9019\u500b role\u3002\u6211\u5011\u53ef\u4ee5\u5728\u6bcf\u4e00\u500b role \u7684\u8cc7\u6599\u593e\u4e2d\u900f\u904e meta \u9019\u500b\u5b50\u76ee\u9304\u5b9a\u7fa9\u9019\u6a23\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u5177\u9ad4\u6b65\u9a5f\u5982\u4e0b\uff1a \u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u5728 roles \u7684\u76ee\u9304\u4e0b\u5efa\u7acb openjre\\tasks \u7684\u5b50\u76ee\u9304\u4e26\u4e14\u5efa\u7acb\u4e00\u500b\u65b0\u6a94\u6848 main.yml : openjre\\tasks\\main.yml --- - name : install openjre ansible.builtin.apt : name : default-jre update_cache : yes \u4e0a\u8ff0\u7684 role \u6703\u7528\u4f86\u5b89\u88dd Java JRE runtime\u3002 jenkins/meta/main.yml --- dependencies : - { role : openjre , become : yes } \u5b9a\u7fa9 jenkins \u9019\u500b role \u4f9d\u8cf4\u4e8e openjre \u7684 role\u3002 \u56de\u5230 playbook.yml \u4e2d\u522a\u9664\u539f\u672c\u547c\u53eb curl role \u7684\u90e8\u5206\uff0c\u53ea\u7559\u4e0b jenkins\uff1a: playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=5 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6839\u64da role \u7684\u65b0\u7d50\u69cb\uff0c\u6211\u5011\u6bcf\u6b21\u53ea\u8981\u547c\u53eb jenkins \u9019\u500b role\uff0c\u5728\u5b89\u88dd Jenkins \u4e4b\u524d\uff0cAnsible \u5c31\u6703\u81ea\u52d5\u5148\u5e6b\u6211\u5011\u628a\u6240\u6709\u5b9a\u7fa9\u5728 meta \u4e2d\u7684\u670d\u52d9\u4f9d\u8cf4\u5b89\u88dd\u597d\u3002\u82e5\u672a\u4f86\u5728 jenkins \u9019\u500b role \u4e0a\u8981\u65b0\u589e\u6216\u79fb\u9664\u670d\u52d9\u4f9d\u8cf4\uff0c\u6211\u5011\u53ea\u9700\u8981\u56de\u5230 meta \u4e2d\u505a\u4fee\u6539\u5373\u53ef\u3002 \u900f\u904e\u5b9a\u7fa9 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u6211\u5011\u53ef\u4ee5\u5728 playbook \u4e2d\u53ea\u55ae\u7d14\u547c\u53eb\u9700\u8981\u7684 role\uff0c\u800c\u4e0d\u7528\u56de\u5230\u5e95\u5c64\u601d\u8003\u904b\u884c\u9019\u500b role \u4e4b\u524d\u6211\u5011\u9084\u9700\u8981\u5b89\u88dd\u4ec0\u9ebc\u984d\u5916\u7684\u670d\u52d9\u3002\u9019\u6a23\u7684\u8a2d\u8a08\u908f\u8f2f\u4e0d\u4f46\u53ef\u4ee5\u5c07\u6bcf\u4e00\u500b role \u90fd\u8996\u70ba\u5df2\u7d93\u5b8c\u5168\u53ef\u4ee5\u7528\u7684\u5de5\u5177\uff0c\u5728\u7dad\u8b77\u7684\u89d2\u5ea6\u4e0a\u4e5f\u4f7f\u5b89\u88dd\u7d50\u69cb\u66f4\u4f73\u6e05\u6670\u6613\u61c2\u3002 \u958b\u767c\u4eba\u54e1\u904e\u53bb\u5f80\u5f80\u56e0\u70ba\u7e41\u7463\u7684\u5b89\u88dd\u6d41\u7a0b\u96e3\u514d\u758f\u5ffd\u5176\u4e2d\u5e7e\u500b\u524d\u7f6e\u670d\u52d9\u5b89\u88dd\uff0c\u9032\u800c\u5c0e\u81f4\u5f8c\u9762\u90e8\u7f72\u6d41\u7a0b\u767c\u751f\u7684\u932f\u8aa4\uff0c\u900f\u904e\u9019\u6a23\u7684\u8a2d\u8a08\u6d41\u7a0b\uff0c\u5c07\u53ef\u4ee5\u5fb9\u5e95\u88ab\u89e3\u6c7a\u3002 Role \u8de8\u7cfb\u7d71\u7684\u9748\u6d3b\u5ea6 \u00b6 \u6211\u5011\u5c07\u65b0\u589e\u4e00\u500b role \u7528\u4f86\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u55ae\u4e00\u500b role \u540c\u6642\u652f\u63f4\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u7684\u4e3b\u6a5f\u3002 \u5b89\u88dd Git \u00b6 \u5beb\u53e6\u4e00\u500b\u7368\u7acb\u7684 role \u4f86\u5b89\u88dd Git\u3002\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e git \u9019\u500b role\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 git \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4e26\u5728 roles/git/tasks/main.yml \u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a roles/git/tasks/main.yml --- - name : install git ansible.builtin.yum : name : git-all when : ansible_distribution == 'CentOS' - name : install git ansible.builtin.apt : name : git when : ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian' \u9664\u4e86\u975e\u5e38\u985e\u4f3c\u65bc\u4e4b\u524d curl \u9019\u500b role \u7684\u5b89\u88dd\u6d41\u7a0b\uff0c\u9019\u6b21\u6211\u5011\u5728 role \u88e1\u9762\u52a0\u4e0a\u4e86\u7cfb\u7d71\u5224\u65b7\u689d\u4ef6\u3002\u7531\u65bc Ubuntu \u8ddf Debian \u9019\u5169\u7a2e\u4e3b\u8981\u7684 Linux \u4f5c\u696d\u7cfb\u7d71\u9810\u8a2d\u90fd\u662f\u642d\u8f09 apt \u505a\u70ba\u5957\u4ef6\u7ba1\u7406\uff0c\u6240\u4ee5\u7576\u6211\u5011\u4eca\u5929\u53ea\u8981\u904b\u884c\u9019\u500b role\uff0c\u4e26\u5224\u65b7\u9059\u63a7\u4e3b\u6a5f\u662f\u9019\u5169\u500b\u4f5c\u696d\u7cfb\u7d71\u4e4b\u4e00\u7684\u6642\u5019\uff0c\u6211\u5011\u5c31\u6703\u904b\u884c\u4e0a\u9762\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002 \u53e6\u5916\uff0c\u7531\u65bc git \u9019\u500b role \u7406\u8ad6\u4e0a\u5728\u672a\u4f86\u88ab\u91cd\u8907\u5229\u7528\u5230\u7684\u983b\u7387\u6703\u975e\u5e38\u9ad8\uff0c\u56e0\u6b64\u6211\u5728\u9019\u88e1\u540c\u6642\u4e5f\u65b0\u589e\u4e86\u5728 CentOS \u9019\u5957\u4f5c\u696d\u7cfb\u7d71\u4e0a\u4f7f\u7528 yum \u5b89\u88dd Git \u7684\u65b9\u6cd5\uff08\u5728 yum \u5957\u4ef6\u7ba1\u7406\u7cfb\u7d71\u4e2d\uff0cGit \u5957\u4ef6\u7684\u540d\u7a31\u8207 apt \u7cfb\u7d71\u4e26\u4e0d\u76f8\u540c\uff09\uff0c\u4ee5\u589e\u52a0\u9019\u500b role \u7684\u4f7f\u7528\u9748\u6d3b\u6027\u3002 \u63a5\u8457\u4fee\u6539 playbook.yml : playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } - { role : git , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] TASK [git : install git] *********************************************************************************** skipping: [127.0.0.1] TASK [git : install git] *********************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=6 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u6211\u5011\u53ef\u4ee5\u770b\u5230 Ansible \u6703\u6839\u64da\u5c0d\u61c9\u7684\u4f5c\u696d\u7cfb\u7d71\u5224\u65b7\u54ea\u4e9b tasks \u53ef\u4ee5\u88ab\u7565\u904e (skipping)\uff0c\u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u6211\u5011\u4e0d\u9700\u8981\u7279\u5225\u70ba\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u4fdd\u5b58\u591a\u4efd\u7248\u672c\u7684 role\uff0c\u53ea\u8981\u5c08\u6ce8\u5728\u540c\u4e00\u500b role \u4e2d\u958b\u767c\u7576\u524d\u4efb\u52d9\u5373\u53ef\u3002 \u53e6\u5916\uff0c\u82e5\u4ed4\u7d30\u95b1\u8b80\u5728\u7d42\u7aef\u6a5f\u4e0a\u986f\u793a\u7684 Ansible \u5b89\u88dd\u6d41\u7a0b\uff0c\u61c9\u8a72\u6703\u767c\u73fe\u5df2\u7d93\u88ab\u5b89\u88dd\u904e\u7684\u670d\u52d9\u4e26\u4e0d\u6703\u4e00\u76f4\u91cd\u8907\u88ab\u5b89\u88dd\u3002\u986f\u793a\u70ba changed \u8868\u793a\u9059\u63a7\u4e3b\u6a5f\u5728\u9019\u6b21\u904b\u884c playbook \u7684\u904e\u7a0b\u88e1\uff0cAnsible \u5728\u8a72\u9805 task \u4e2d\u5c0d\u7cfb\u7d71\u505a\u4e86\u6539\u8b8a\uff1bok \u5247\u8868\u793a\u8a72 task \u7684\u5b8c\u6210\u689d\u4ef6\u5df2\u6eff\u8db3\uff0c\u6240\u4ee5 Ansible \u4e26\u4e0d\u6703\u984d\u5916\u5c0d\u4e3b\u6a5f\u505a\u5176\u4ed6\u8b8a\u52d5\u3002 \u7279\u5225\u9700\u8981\u89e3\u91cb\u7684\u662f\uff0c\u82e5\u6211\u5011\u4f7f\u7528\u4e86 update_cache: yes \u9019\u9805\u5c6c\u6027\u4f86\u900f\u904e\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u5b89\u88dd\u670d\u52d9\u3002\u6211\u5011\u6bcf\u6b21\u5b89\u88dd\u670d\u52d9\u524d\u90fd\u6703\u8a66\u5716\u5c07\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u7684\u7248\u672c\u90fd\u66f4\u65b0\u5230\u7576\u524d\u6700\u65b0\u7248\u672c\uff0c\u7136\u5f8c\u624d\u9032\u884c\u5b89\u88dd\u6b65\u9a5f\uff0c\u56e0\u6b64\u6bcf\u6b21 task \u7684\u72c0\u614b\u90fd\u5c07\u6703\u986f\u793a\u70ba changed\u3002 Ansible Galaxy \u00b6 Ansible Galaxy \u662f\u4e00\u500b Ansible \u5b98\u65b9\u63d0\u4f9b\u7684 Ansible Role \u5171\u4eab\u5e73\u53f0\u3002\u6240\u6709 Ansible \u7684\u4f7f\u7528\u8005\u90fd\u53ef\u4ee5\u81ea\u7531\u4e0a\u50b3\u81ea\u5df1\u7684 role \u8207\u5168\u4e16\u754c\u7684\u958b\u767c\u4eba\u54e1\u5206\u4eab\u3002 \u5728\u63a5\u5230\u4efb\u52d9\u9700\u6c42\u524d\uff0c\u5efa\u8b70\u8b80\u8005\u53ef\u4ee5\u82b1\u500b\u5e7e\u5206\u9418\u5728\u4e0a\u9762\u7a0d\u5fae\u700f\u89bd\u4e00\u4e0b\uff0c\u770b\u770b\u662f\u5426\u6709\u9069\u5408\u81ea\u5df1\u4f7f\u7528\u7684\u73fe\u6210 role \u7684\u53ef\u4ee5\u7acb\u523b\u62ff\u4f86\u4f7f\u7528\u3002\u4e0d\u904e\uff0c\u70ba\u907f\u514d\u8b80\u8005\u6df7\u6dc6\uff0c\u9019\u6b21\u5c31\u4e0d\u7279\u5225\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 ansible-galaxy \u4f86\u8abf\u7528\u5176\u4ed6\u958b\u767c\u8005\u7684 role\uff0c\u6709\u8208\u8da3\u7684\u8b80\u8005\u53ef\u4ee5\u81ea\u884c\u53c3\u95b1\u5b98\u65b9\u4f7f\u7528\u6559\u5b78\u3002 \u8a2d\u5b9a Vagrant forward port \u00b6 \u7531\u65bc Jenkins \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 8080\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8a66\u8457\u628a\u9059\u63a7\u7bc0\u9ede\u7684 port 8080 \u5ee3\u64ad\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u3002\u4e0d\u904e\uff0c\u7531\u65bc port 8080 \u662f\u4e00\u500b\u975e\u5e38\u5bb9\u6613\u88ab\u5176\u4ed6\u670d\u52d9\u4f7f\u7528\u7684 port\uff0c\u70ba\u4e86\u907f\u514d\u885d\u7a81\uff0c\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u7684 port 9080\u3002 \u5728 Vagrantfile \u4e2d\uff0c\u76f4\u63a5\u5728 config.vm.define \"sre001\" \u8a72\u884c\u4e0b\u9762\u65b0\u589e\u4ee5\u4e0b\u8a2d\u5b9a\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"forwarded_port\" , guest : 8080 , host : 9080 end \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a $ vagrant reload \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a == > sre001: Attempting graceful shutdown of VM... == > sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > sre001: Clearing any previously set forwarded ports... == > sre001: Fixed port collision for 22 = > 2222 . Now on port 2201 . == > sre001: Clearing any previously set network interfaces... == > sre001: Preparing network interfaces based on configuration... sre001: Adapter 1 : nat == > sre001: Forwarding ports... sre001: 8080 ( guest ) = > 9080 ( host ) ( adapter 1 ) sre001: 22 ( guest ) = > 2201 ( host ) ( adapter 1 ) == > sre001: Running 'pre-boot' VM customizations... == > sre001: Booting VM... == > sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127 .0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key == > sre001: Machine booted and ready! == > sre001: Checking for guest additions in VM... == > sre001: Mounting shared folders... sre001: /vagrant = > /home/dxlab/opt/vagrant_getting_started == > sre001: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > sre001: flag to force provisioning. Provisioners marked to run always will still run. \u6211\u5011\u53ef\u4ee5\u5f9e\u4e0a\u9762\u8cc7\u8a0a\u4e2d\u770b\u5230 Vagrant \u5df2\u7d93\u5e6b\u6211\u5011\u628aVM\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u672c\u6a5f\u7684 port 9080 \u4e86\u3002\u73fe\u5728\u5617\u8a66\u900f\u904e\u700f\u89bd\u5668\u8a2a\u554f http://localhost:9080 \u5c31\u61c9\u8a72\u53ef\u4ee5\u9806\u5229\u9032\u5165 Jenkins \u7684\u521d\u59cb\u5316\u9801\u9762\u4e86\uff1a \u7d50\u8ad6 \u00b6 \u5f9e\u672c\u6b21\u7684\u5feb\u901f\u5165\u9580\u6559\u7a0b\u4e2d\u6211\u5011\u5feb\u901f\u5730\u4ecb\u8a54\u4e86 Ansible \u6700\u91cd\u8981\u7684\u57fa\u672c\u6982\u5ff5: ansible config inventory playbook tasks roles modules control node / manage node","title":"Ansible \u5feb\u901f\u5165\u9580"},{"location":"ansible/ansible-intro/#ansible","text":"\u5728\u6211\u5011\u6210\u529f\u5229\u7528 Vagrant \u6a21\u64ec\u51fa\u6240\u9700\u7684\u74b0\u5883\u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528 Ansible \u9019\u5957\u81ea\u52d5\u5316\u5de5\u5177\u4f86\u9032\u884c\u90e8\u7f72\u4e86\u3002","title":"\u4f7f\u7528 Ansible \u90e8\u7f72\u74b0\u5883"},{"location":"ansible/ansible-intro/#ansible_1","text":"","title":"Ansible \u4ecb\u7d39"},{"location":"ansible/ansible-intro/#ansible_2","text":"\u76f8\u4fe1\u5927\u5bb6\u61c9\u8a72\u90fd\u6709\u904e\u91cd\u704c\u96fb\u8166\u7684\u7d93\u9a57\u3002\u6bcf\u4e00\u6b21\u5728\u96fb\u8166\u91cd\u65b0\u5b89\u88dd\u5f8c\uff0c\u6211\u5011\u90fd\u9700\u8981\u82b1\u5927\u91cf\u7684\u6642\u9593\u628a\u5e73\u5e38\u5e38\u7528\u7684\u8edf\u9ad4\u4e00\u4e00\u91cd\u65b0\u88dd\u4e0a\uff0c\u6709\u4e9b\u8edf\u9ad4\u53ef\u80fd\u9084\u8981\u9032\u884c\u500b\u5225\u7684\u5fae\u8abf\uff0c\u800c\u9019\u6a23\u7e41\u7463\u7684\u6b65\u9a5f\u540c\u6a23\u4e5f\u6703\u767c\u751f\u5728\u8edf\u9ad4\u90e8\u7f72\u7684\u4f3a\u670d\u5668\u4e0a\u3002 \u70ba\u4e86\u904b\u884c\u958b\u767c\u51fa\u4f86\u7684\u8edf\u9ad4\uff0c\u958b\u767c\u4eba\u54e1\u5011\u5f80\u5f80\u9700\u8981\u8981\u82b1\u8cbb\u5927\u91cf\u7684\u6642\u9593\u5728\u4f3a\u670d\u5668\u4e0a\u5b89\u88dd\u6240\u6709\u6240\u9700\u7684\u5957\u4ef6 (packages) \u6216\u662f\u670d\u52d9\u4f9d\u8cf4 (dependency)\uff0c\u800c\u5728\u5b89\u88dd\u7684\u904e\u7a0b\u4e2d\u82e5\u6709\u758f\u5ffd\uff0c\u9084\u5f88\u6709\u53ef\u80fd\u9020\u6210\u90e8\u7f72\u7a0b\u5f0f\u767c\u751f\u7121\u9810\u671f\u7684\u932f\u8aa4\u3002\u56e0\u6b64\uff0c\u81ea\u52d5\u5316\u5c31\u662f\u56e0\u70ba\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u7a2e\u6982\u5ff5\u3002 \u82e5\u6211\u5011\u53ef\u4ee5\u5c07\u6bcf\u4e00\u6b21\u90e8\u7f72\u7684\u6b65\u9a5f\u5beb\u6210\u4e00\u500b\u81ea\u52d5\u5316\u7684\u6a19\u6e96\u4f5c\u696d\u7a0b\u5e8f (Standard Operating Procedures, SOP)\uff0c\u9664\u4e86\u53ef\u4ee5\u6709\u6548\u7e2e\u77ed\u6bcf\u6b21\u7684\u90e8\u7f72\u6642\u9593\u53ca\u964d\u4f4e\u51fa\u932f\u7387\u5916\uff0c\u5728\u672a\u4f86\u9700\u8981\u5347\u7d1a\u90e8\u7f72\u74b0\u5883\uff0c\u4e5f\u6703\u76f8\u5c0d\u5bb9\u6613\u8a31\u591a\u3002\u800c Ansible \u5c31\u662f\u76ee\u524d\u696d\u754c\u6700\u5e38\u4f7f\u7528\u7684\u81ea\u52d5\u5316\u5de5\u5177\u4e4b\u4e00\u3002","title":"Ansible \u662f\u4ec0\u9ebc\uff1f"},{"location":"ansible/ansible-intro/#ansible_3","text":"\u76ee\u524d\u696d\u754c\u4e2d\u4e3b\u6d41\u7684\u81ea\u52d5\u5316\u90e8\u7f72\u5de5\u5177\u9664\u4e86 Ansible \u4e4b\u5916\u9084\u6709 Chef\u3001Otter\u3001Puppet\u3001SaltStack \u7b49\u7b49\u3002\u6bcf\u4e00\u500b\u9663\u71df\u90fd\u6709\u5927\u91cf\u7684\u64c1\u8b77\u8005\u4ee5\u53ca\u5404\u81ea\u7684\u512a\u7f3a\u9ede\uff0c\u5176\u5be6\u5728\u9019\u500b\u554f\u984c\u4e0a\u4e26\u6c92\u6709\u8ab0\u7d55\u5c0d\u512a\u65bc\u8ab0\u7684\u7b54\u6848\u3002\u4e4b\u6240\u4ee5\u9078\u64c7 Ansible \u4f5c\u70ba\u81ea\u52d5\u5316\u7684\u5de5\u5177\uff0c\u4e3b\u8981\u539f\u56e0\u662f\u56e0\u70ba Ansible \u771f\u7684\u5bb9\u6613\u5b78\u7fd2\u8a31\u591a\u3002\u5728\u9078\u64c7\u5de5\u5177\u7684\u904e\u7a0b\u4e2d\uff0c\u6211\u76f8\u4fe1\u6700\u91cd\u8981\u7684\u8003\u91cf\u61c9\u8a72\u5728\u65bc\u6211\u5011\u80fd\u4e0d\u80fd\u5920\u5728\u6700\u77ed\u7684\u6642\u9593\u5167\u638c\u63e1\u9019\u500b\u5de5\u5177\u4e26\u6709\u6548\u5730\u89e3\u6c7a\u6211\u5011\u6240\u9047\u5230\u7684\u554f\u984c\u3002 \u5728\u9019\u6a23\u7684\u524d\u63d0\u4e0b\uff0cAnsible \u5c31\u6210\u70ba\u8a31\u591a\u958b\u767c\u5718\u968a\u7684\u9996\u9078\u4e86\u3002\u9664\u4e86\u5bb9\u6613\u5b78\u7fd2\u4e4b\u5916\uff0cAnsible \u672c\u8eab\u5728 GitHub \u4e0a\u4e5f\u662f\u4e00\u500b\u958b\u6e90\u7684\u5c08\u6848\u3002\u6709\u4e86\u5927\u91cf\u958b\u767c\u4eba\u54e1\u7684\u5e6b\u52a9\u53ca\u56de\u994b\uff0cAnsible \u9019\u5957\u8edf\u9ad4\u7684\u6210\u9577\u901f\u5ea6\u5176\u5be6\u662f\u771f\u7684\u76f8\u7576\u9a5a\u4eba\u7684\u3002","title":"\u70ba\u4ec0\u9ebc\u8981\u9078\u64c7 Ansible\uff1f"},{"location":"ansible/ansible-intro/#ansible_4","text":"\u7531\u65bc Ansible \u662f\u4f7f\u7528 Python \u958b\u767c\u7684\u4e00\u5957\u514d\u8cbb\u8edf\u9ad4\uff0c\u8981\u900f\u904e Ansible \u5728\u9059\u63a7\u7bc0\u9ede (remote node) \u4e0a\u914d\u7f6e\u74b0\u5883\uff0c\u552f\u4e8c\u7684\u689d\u4ef6\u53ea\u6709\uff1a \u5b89\u88dd Python \u900f\u904e SSH \u9032\u884c\u9023\u7dda \u5728\u73fe\u5728\u5927\u90e8\u5206\u7684 Linux \u4e3b\u6a5f\u4e0a\uff0c\u57fa\u672c\u4e0a Python \u5df2\u7d93\u90fd\u662f\u57fa\u672c\u914d\u5099\u4e86\uff0c\u6240\u4ee5\u9019\u6a23\u7684\u8981\u6c42\u7b49\u65bc\u6c92\u6709\u8981\u6c42\u3002\u6211\u5011\u53ea\u9700\u8981\u5728\u5b89\u88dd\u597d Ansible \u7684\u4e3b\u6a5f (control machine) \u4e0a\u900f\u904e SSH \u8207\u9059\u63a7\u7bc0\u9ede\u6e9d\u901a\uff0c\u5c31\u53ef\u4ee5\u8f15\u9b06\u505a\u5230\u4e00\u9375\u90e8\u7f72\uff01","title":"Ansible \u7684\u9700\u6c42"},{"location":"ansible/ansible-intro/#ansible_5","text":"\u5728 Ansible \u88e1\uff0c\u6703\u628a\u6240\u6709\u6a5f\u5668\u7684\u89d2\u8272\u505a\u4ee5\u4e0b\u5169\u7a2e\u5340\u5206\uff1a \u63a7\u5236\u4e3b\u6a5f (Control Machine) \uff1a\u9867\u540d\u601d\u7fa9\uff0c\u9019\u985e\u4e3b\u6a5f\u53ef\u4ee5\u900f\u904e\u904b\u884c Ansible \u7684\u5287\u672c (playbook) \u5c0d\u7ba1\u7406\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u3002 \u7ba1\u7406\u7bc0\u9ede (Managed Node) \uff1a\u4e5f\u7a31\u70ba\u9059\u63a7\u7bc0\u9ede (Remote Node)\u3002\u76f8\u5c0d\u65bc\u63a7\u5236\u4e3b\u6a5f\uff0c\u9019\u985e\u7bc0\u9ede\u5c31\u662f\u6211\u5011\u900f\u904e Ansible \u9032\u884c\u90e8\u7f72\u7684\u5c0d\u8c61\u3002 \u5c0d\u65bc\u9019\u5169\u7a2e\u4e0d\u540c\u7684\u5c0d\u8c61\uff0c\u5728\u5b89\u88dd / \u4f7f\u7528 Ansible \u7684\u6642\u5019\u4e5f\u6709\u4e0d\u540c\u7684\u9700\u6c42\u3002","title":"Ansible \u5b89\u88dd"},{"location":"ansible/ansible-intro/#ansible_6","text":"\u7531\u65bc Ansible \u662f\u4e00\u5957\u958b\u6e90\u7684\u8edf\u9ad4\uff0c\u6240\u4ee5\u5728\u76ee\u524d\u5927\u90e8\u5206\u7684\u4e3b\u6d41\u4f5c\u696d\u7cfb\u7d71\u4e0a\u90fd\u5df2\u7d93\u53ef\u4ee5\u900f\u904e\u5c0d\u61c9\u7684\u5957\u4ef6\u7ba1\u7406 (package manager) \u9032\u884c\u5b89\u88dd\u4e86\u3002\u4ee5\u4e0b\u5217\u51fa\u5e7e\u500b\u6211\u4e3b\u8981\u6bd4\u8f03\u5e38\u7528\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u65b9\u6cd5\uff1a Ubuntu CentOS/RHEL bash $ sudo apt update $ sudo apt install software-properties-common $ sudo add-apt-repository --yes --update ppa:ansible/ansible $ sudo apt install ansible $ sudo yum install epel-release $ sudo yum install ansible \u5b89\u88dd\u597d\u4ee5\u5f8c\uff0c\u78ba\u8a8d Ansible \u5df2\u7d93\u5b89\u88dd\u5b8c\u6210\uff1a $ ansible --version ansible [ core 2 .12.6 ] config file = /etc/ansible/ansible.cfg configured module search path = [ '/home/dxlab/.ansible/plugins/modules' , '/usr/share/ansible/plugins/modules' ] ansible python module location = /usr/lib/python3/dist-packages/ansible ansible collection location = /home/dxlab/.ansible/collections:/usr/share/ansible/collections executable location = /usr/bin/ansible python version = 3 .9.7 ( default, Sep 10 2021 , 14 :59:43 ) [ GCC 11 .2.0 ] jinja version = 3 .1.1 libyaml = True","title":"\u5b89\u88dd Ansible \u5728\u63a7\u5236\u4e3b\u6a5f"},{"location":"ansible/ansible-intro/#ansible_7","text":"\u4e0d\u9700\u8981\uff01\u900f\u904e Ansible \u7ba1\u7406\u7684\u7ba1\u7406\u7bc0\u9ede\u5b8c\u5168\u4e0d\u9700\u8981\u5b89\u88dd Ansible\u3002\u5982\u4e0a\u500b\u7ae0\u7bc0\u6240\u8ff0\uff0c\u6211\u5011\u53ea\u9700\u8981\u78ba\u4fdd\u9019\u500b\u7ba1\u7406\u7bc0\u9ede\u53ef\u4ee5\u900f\u904e SSH \u8207\u63a7\u5236\u4e3b\u6a5f\u6e9d\u901a\uff0c\u4e26\u5df2\u5b89\u88dd Python 2.6 \u4ee5\u4e0a\u7684\u7248\u672c\u5c31\u53ef\u4ee5\u900f\u904e\u63a7\u5236\u4e3b\u6a5f\u7ba1\u7406\u4e86\u3002","title":"\u5b89\u88dd Ansible \u5728\u7ba1\u7406\u7bc0\u9ede"},{"location":"ansible/ansible-intro/#ansible-lint","text":"\u5728\u7de8\u5beb\u7a0b\u5f0f/\u8173\u672c\u7684\u6642\u5019\uff0c\u6211\u90fd\u6703\u7fd2\u6163\u53bb\u627e\u5c0d\u61c9\u8a9e\u8a00\u7684 linter \u4f86\u7fd2\u6163\u8a72\u8a9e\u8a00\u7684\u98a8\u683c\u3002\u96d6\u7136 Ansbile \u4e26\u4e0d\u662f\u4e00\u7a2e\u7a0b\u5f0f\u8a9e\u8a00\uff0c\u4f46\u5b83\u4e5f\u6709\u4e00\u500b\u5c0d\u61c9\u7684 linter - Ansible-lint\u3002\u6211\u6703\u5efa\u8b70\u5927\u5bb6\u53ef\u4ee5\u5b89\u88dd\u9019\u500b\u5c0f\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u5e6b\u52a9\u4f60\u78ba\u4fdd\u5beb\u51fa\u4f86\u7684\u8173\u672c\u54c1\u8cea\u662f\u6709\u4e00\u5b9a\u6c34\u6e96\u7684\u3002 sudo pip install ansible-lint \u6aa2\u67e5\uff1a ansible-lint 6.2.1 using ansible 2.12.6","title":"\u5b89\u88dd Ansible-lint"},{"location":"ansible/ansible-intro/#playbook","text":"\u7576\u78ba\u8a8d Ansible \u5df2\u7d93\u6b63\u78ba\u5730\u5b89\u88dd\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4e4b\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u5c31\u53ef\u4ee5\u6e96\u5099\u900f\u904e Ansible \u5c0d\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u4e86\u3002\u7136\u800c\uff0c\u6211\u5011\u8981\u5982\u4f55\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u5c0d\u9059\u63a7\u7bc0\u9ede\u505a\u4e9b\u4ec0\u9ebc\u5462\uff1f\u5728 Ansible \u7684\u4e16\u754c\u88e1\uff0c\u6211\u5011\u662f\u900f\u904e\u7de8\u5beb \u5287\u672c (playbook) \u4f86\u544a\u8a34 Ansible \u63a5\u4e0b\u4f86\u9700\u8981\u505a\u7684\u4e8b\u9805\u3002 \u7531\u65bc Ansible \u7684\u5287\u672c\u662f\u7528 YAML (YAML Ain't Markup Language) \u9019\u7a2e\u8a9e\u8a00\u4f86\u64b0\u5beb\uff0c\u800c\u9019\u500b\u8a9e\u8a00\u6700\u5927\u7684\u7279\u8272\u5c31\u662f\u5177\u6709\u9ad8\u5ea6\u53ef\u8b80\u6027\uff0c\u56e0\u6b64\u7121\u8ad6\u6709\u6c92\u6709\u7a0b\u5f0f\u8a9e\u8a00\u7684\u57fa\u790e\uff0c\u7406\u8ad6\u4e0a\u4efb\u4f55\u4eba\u5728\u770b\u5230\u4e00\u4efd\u597d\u7684 Ansible playbook \u7684\u6642\u5019\u61c9\u8a72\u90fd\u662f\u975e\u5e38\u5bb9\u6613\u7406\u89e3\u53ca\u8457\u624b\u4fee\u6539\u7dad\u8b77\u7684\u3002","title":"\u64b0\u5beb\u7b2c\u4e00\u500b Playbook"},{"location":"ansible/ansible-intro/#playbook_1","text":"\u4ee5\u4e0b\u5148\u7528\u4e00\u500b\u975e\u5e38\u7c21\u55ae\u7684\u7bc4\u4f8b\u4f86\u4ecb\u7d39 playbook \u7684\u904b\u4f5c\u65b9\u5f0f\u3002\u6211\u5011\u5148\u5275\u5efa\u4e00\u500b playbook \u6a94\u6848\uff0c\u5c07\u5176\u547d\u540d\u70ba playbook.yml \u4e26\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u4e0b (e.g. vagrant_getting_started/playbook.yml)\u3002\u63a5\u8457\uff0c\u958b\u555f\u6a94\u6848\u4e26\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u76f8\u4fe1\u5927\u5bb6\u5c31\u7b97\u5f9e\u4f86\u6c92\u6709\u5beb\u904e Ansible \u7684 playbook\uff0c\u61c9\u8a72\u9084\u662f\u4e0d\u96e3\u731c\u51fa\u9019\u4efd playbook \u5728\u505a\u4e9b\u4ec0\u9ebc\u3002\u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u5728\u9019\u4efd playbook \u4e2d\u5b9a\u7fa9\u4e86\u4efb\u52d9\u6e05\u55ae tasks \u4ee5\u53ca\u90e8\u7f72\u5c0d\u8c61 hosts: sre001 \u3002 \u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u5728\u4e4b\u524d\u7684\u7ae0\u7bc0\u4e2d\u6211\u5011\u63d0\u5230\u4e86\u6700\u597d\u628a\u6bcf\u4e00\u500b\u865b\u64ec\u4e3b\u6a5f\u90fd\u505a\u547d\u540d\u3002\u4e3b\u6a5f\u547d\u540d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u900f\u904e\u4e3b\u6a5f\u7684\u540d\u7a31\u76f4\u63a5\u9032\u884c\u64cd\u4f5c\uff08\u6211\u5011\u6703\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u63d0\u5230\u82e5\u4e0d\u900f\u904e Vagrant \u8981\u5982\u4f55\u547d\u540d\u4e3b\u6a5f\uff09\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e name \u9019\u500b\u6a19\u7c64\u66ff\u4efb\u52d9\u6e05\u55ae\u4e2d\u7684\u6bcf\u500b task \u5206\u5225\u547d\u540d\u3002\u5728\u63a5\u4e0b\u4f86\u904b\u884c playbook \u7684\u904e\u7a0b\u4e2d\u82e5\u767c\u751f\u932f\u8aa4\uff0c\u6211\u5011\u4e5f\u6703\u6bd4\u8f03\u6e05\u695a\u662f\u5728\u54ea\u4e00\u500b\u74b0\u7bc0\u4e0a\u51fa\u4e86\u554f\u984c\u3002 \u5728\u9019\u500b playbook \u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u5169\u500b task\uff1a 1. test connection Info \u6211\u5011\u5728\u9019\u500b task \u4e2d\uff0c\u547c\u53eb\u4e86 Ansible \u7684\u5167\u5efa\u6e2c\u8a66\u6a21\u7d44 (module) - ping \u3002\u9019\u500b\u6a21\u7d44\u7684\u76ee\u7684\u975e\u5e38\u985e\u4f3c\u5728\u5b78\u7fd2\u6bcf\u500b\u8a9e\u8a00\u4e00\u958b\u59cb\u7df4\u7fd2\u7684 \"Hello World\" \u7a0b\u5f0f\u3002\u5176\u4e3b\u8981\u662f\u7528\u4f86\u6e2c\u8a66\u64cd\u63a7\u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u6b63\u78ba\u5730\u8207\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u6e9d\u901a\uff0c\u5982\u679c\u9023\u7dda\u6b63\u5e38\uff0c\u9059\u63a7\u7bc0\u9ede\u5c31\u6703\u56de\u50b3\u4e00\u500b \"pong\" \u7684\u8a0a\u606f\u7d66\u63a7\u5236\u4e3b\u6a5f\u3002\u63a5\u8457\uff0c\u6211\u5011\u900f\u904e\u53e6\u4e00\u500b Ansible \u5167\u5efa\u6a21\u7d44 - register \u628a\u9059\u63a7\u7bc0\u9ede\u56de\u50b3\u7684\u8a0a\u606f\u5b58\u6210\u8b8a\u6578 (variable) \u7684\u5f62\u5f0f\u3002 \u6ce8\u610f\uff1a\u6b64\u8655\u7684 ping \u4e26\u975e\u5efa\u7acb\u5728 ICMP \u5354\u5b9a\u4e0b\u7684 ping \u6307\u4ee4\uff0c\u53ea\u662f\u7d14 Ansible \u958b\u767c\u7684\u4e00\u500b\u7c21\u55ae\u6e2c\u8a66\u6a21\u7d44\u3002 \u6a21\u7d44: ansible.builtin.ping 2. print debug message Info \u5728\u4e0a\u4e00\u500b task \u4e2d\uff0c\u6211\u5011\u5df2\u7d93\u628a ping \u5f8c\u7684\u7d50\u679c\u5b58\u5728 message \u9019\u500b\u8b8a\u6578\u4e2d\u4e86\u3002\u6211\u5011\u53ef\u4ee5\u5229\u7528 debug \u9019\u500b\u6a21\u7d44\u628a\u5132\u5b58\u7684\u8a0a\u606f\u8f38\u51fa\u5230\u6211\u5011\u7684\u7d42\u7aef\u6a5f\u4e0a\u3002\u5728 Ansible \u4e2d\uff0c\u82e5\u8981\u8abf\u7528\u5132\u5b58\u8b8a\u6578\uff0c\u6211\u5011\u5fc5\u9808\u5728\u8b8a\u6578\u540d\u7a31\u5916\u52a0\u4e0a\u5169\u500b\u5927\u62ec\u5f27 - {{ }} \u4f86\u544a\u8a34 Ansible \u5927\u62ec\u5f27\u5167\u7684\u662f\u4e00\u500b\u8b8a\u6578 \uff08\u5982\u679c\u8b8a\u6578\u5728\u63cf\u8ff0\u53e5 (statement) \u7684\u958b\u982d\uff0c\u9084\u5fc5\u9808\u8981\u984d\u5916\u52a0\u4e0a\u4e00\u500b\u96d9\u5f15\u865f - \"\"\uff09\u3002 \u6a21\u7d44: ansible.builtin.debug","title":"\u7b2c\u4e00\u500b playbook"},{"location":"ansible/ansible-intro/#playbook_2","text":"\u5229\u7528 Ansible-lint \u4f86\u6aa2\u67e5 playbook: $ ansible-lint playbook.yml \u5982\u679c\u6c92\u6709\u770b\u5230\u4efb\u4f55\u8f38\u51fa\u5c31\u8868\u793a\u4f60\u7684 playbook \u5b8c\u5168\u6c92\u6709\u554f\u984c\uff01\u4e0d\u904e\u70ba\u4e86\u5c55\u793a Ansible-lint \u7684\u63d0\u793a\u6548\u679c\uff0c\u6211\u5728 playbook \u7684\u7b2c\u4e94\u884c\u53e5\u5c3e\u52a0\u4e0a\u4e00\u500b\u7a7a\u767d\uff1a - name: test connection ~ \u63a5\u8457\uff0c\u91cd\u65b0\u8f38\u5165\u525b\u525b\u7684\u6307\u4ee4\uff1a $ ansible-lint playbook.yml WARNING Listing 1 violation ( s ) that are fatal yaml: trailing spaces ( yaml [ trailing-spaces ]) playbook.yml:5 You can skip specific rules or tags by adding them to your configuration file: # .config/ansible-lint.yml warn_list: # or 'skip_list' to silence them completely - yaml # Violations reported by yamllint. Finished with 1 failure ( s ) , 0 warning ( s ) on 1 files. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 Ansible-lint \u544a\u8a34\u6211\u5011\u5728 playbook.yml:5 \u7b2c\u4e94\u884c\u7684\u5730\u65b9\u6709\u500b\u5f8c\u7db4\u7a7a\u767d (trailing whitespace)\uff0c\u70ba\u4e86\u4fdd\u6301\u7a0b\u5f0f\u78bc\u7684\u7c21\u6f54\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u5176\u522a\u9664\u3002 \u5728\u5b9a\u7fa9\u597d\u4e86\u6211\u5011\u7684\u7b2c\u4e00\u500b playbook \u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u662f\u5982\u4f55\u904b\u884c\u6211\u5011\u5beb\u597d\u7684 playbook\u3002","title":"\u6aa2\u67e5 playbook"},{"location":"ansible/ansible-intro/#playbook_3","text":"\u8981\u900f\u904e Ansible \u4f86\u904b\u884c playbook \u76f8\u7576\u5bb9\u6613\uff0c\u6211\u5011\u53ea\u8981\u4f7f\u7528 ansible-playbook \u7684\u6307\u4ee4\u5c31\u53ef\u4ee5\u8f15\u6613\u904b\u884c\u6211\u5011\u7de8\u5beb\u597d\u7684 playbook\uff1a $ ansible-playbook playbook.yml \u57f7\u884c\u5b8c\u7562\u5f8c\u6211\u5011\u61c9\u8a72\u53ef\u4ee5\u5728\u7d42\u7aef\u6a5f\u4e0a\u770b\u5230\u4ee5\u4e0b\u7684\u8f38\u51fa\uff1a [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all' [WARNING]: Could not match supplied host pattern, ignoring: sre001 PLAY [sre001] ***************************************************************************************************************************************************************** skipping: no hosts matched PLAY RECAP ********************************************************************************************************************************************************************","title":"\u904b\u884c playbook"},{"location":"ansible/ansible-intro/#inventory","text":"\u5728\u770b\u5230\u8f38\u51fa\u7d50\u679c\u5f8c\uff0c\u6211\u76f8\u4fe1\u5927\u90e8\u5206\u7684\u8b80\u8005\u53ef\u80fd\u6703\u7d0d\u60b6\u70ba\u4ec0\u9ebc\u8f38\u51fa\u7d50\u679c\u6c92\u6709\u4efb\u4f55\u57f7\u884c\u6210\u529f\u6216\u5931\u6557\u7684\u8cc7\u8a0a\u3002\u5f9e\u7d42\u7aef\u6a5f\u7684\u7d50\u679c\u6211\u5011\u53ef\u4ee5\u77e5\u9053 Ansible \u4ec0\u9ebc\u4efb\u52d9\u90fd\u6c92\u6709\u505a\uff0c\u9019\u6a23\u7684\u7d50\u679c\u4e5f\u4e0d\u662f\u6211\u5011\u6240\u9810\u671f\u7684\u3002\u5728\u89e3\u6c7a\u9019\u554f\u984c\u4e4b\u524d\uff0c\u8b93\u6211\u5011\u5148\u56de\u61b6\u4e00\u4e0b\u6211\u5011\u4e4b\u524d\u64b0\u5beb\u7684 playbook.yml \uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u5f9e\u9019\u4efd playbook \u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5f88\u6e05\u695a\u5730\u770b\u5230 Ansible \u61c9\u8a72\u8981\u5c0d sre001 \u9019\u53f0\u4e3b\u6a5f\u9032\u884c\u4efb\u52d9\u6e05\u55ae\u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002\u5728\u4e4b\u524d Vagrant \u4ecb\u7d39\u4e2d\uff0c\u6211\u5011\u7684\u78ba\u5c0d\u904b\u884c\u8d77\u4f86\u7684\u4e3b\u6a5f\u9032\u884c\u4e86\u547d\u540d\uff0c\u7136\u800c\uff0c\u6211\u5011\u537b\u5f9e\u4f86\u6c92\u6709\u544a\u8a34 Ansible \u904e\u54ea\u4e00\u53f0\u4e3b\u6a5f\u662f sre001 \u3002 \u56e0\u6b64\uff0c\u89e3\u6c7a\u9019\u500b\u554f\u984c\u6700\u76f4\u63a5\u7684\u65b9\u6cd5\u5c31\u662f\u5b9a\u7fa9\u4e00\u500b\u4e3b\u6a5f\u5217\u8868 inventory \u4e26\u8b93 Ansible \u53c3\u7167\uff0c\u9019\u6a23 Ansible \u624d\u6703\u77e5\u9053\u8a72\u5c0d\u8ab0\u505a\u4ec0\u9ebc\u4e8b\u3002 \u70ba\u4e86\u77e5\u9053 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u8a73\u7d30\u8cc7\u6599\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e vagrant ssh-config \u4f86\u5217\u51fa\u4e3b\u6a5f\u7684\u76f8\u95dc\u8cc7\u8a0a\uff1a $ vagrant ssh-config Host sre001 HostName 127 .0.0.1 User vagrant Port 2201 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL Tip \u6bcf\u4e00\u500b\u4eba\u7684\u56de\u61c9\u53ef\u80fd\u56e0\u500b\u4eba\u672c\u6a5f\u7684\u72c0\u6cc1\u6703\u6709\u6240\u4e0d\u540c\uff0c\u8acb\u7279\u5225\u6ce8\u610f Port \u8207 IdentifyFile \u7684\u8cc7\u8a0a\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728\u7576\u4e0b\u7684\u76ee\u9304\u4e0b\u65b0\u589e\u4e00\u500b\u6a94\u6848\u4e26\u547d\u540d\u70ba inventory . \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 Vagrantfile \u7136\u5f8c\u5728\u6a94\u6848\u5167\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a [sre001] 127.0.0.1 ansible_port=2201 ansible_user=vagrant ansible_ssh_common_args='-o StrictHostKeyChecking=no' \u6839\u64da vagrant ssh-config \u5217\u51fa\u4f86\u7684\u4e3b\u6a5f\u8cc7\u8a0a\uff0c\u6211\u5011\u5728 inventory \u4e2d\u4f9d\u5e8f\u5b9a\u7fa9\u4e86 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u9023\u7dda IP\u3001port \u5165\u53e3\u4ee5\u53ca\u767b\u5165\u4f7f\u7528\u8005\u7684\u8eab\u4efd\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u91cd\u65b0\u57f7\u884c\u904b\u884c\u6307\u4ee4\uff0c\u4e26\u5c07\u9019\u4efd\u4e3b\u6a5f\u6e05\u55ae\u6307\u5b9a\u7d66 Ansible \u53c3\u7167\uff1a $ ansible-playbook -i inventory playbook.yml \u73fe\u5728\uff0c\u8f38\u51fa\u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** fatal: [127.0.0.1]: UNREACHABLE! => {\"changed\": false, \"msg\": \"Failed to connect to the host via ssh: @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\n@ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @\\r\\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\\r\\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\\r\\nIt is also possible that a host key has just been changed.\\r\\nThe fingerprint for the ECDSA key sent by the remote host is\\nSHA256:7WcamAcB+cK5FXwfTxMiXBeovKpBFqpv4k4J6JzODYw.\\r\\nPlease contact your system administrator.\\r\\nAdd correct host key in /home/dxlab/.ssh/known_hosts to get rid of this message.\\r\\nOffending ECDSA key in /home/dxlab/.ssh/known_hosts:3\\r\\n remove with:\\r\\n ssh-keygen -f \\\"/home/dxlab/.ssh/known_hosts\\\" -R \\\"[127.0.0.1]:2201\\\"\\r\\nECDSA host key for [127.0.0.1]:2201 has changed and you have requested strict checking.\\r\\nHost key verification failed.\", \"unreachable\": true} PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=0 changed=0 unreachable=1 failed=0 skipped=0 rescued=0 ignored=0 \u73fe\u5728 Ansible \u77e5\u9053\u8ab0\u662f sre001 \u4e86\uff01\u4e0d\u904e\uff0c\u770b\u8d77\u4f86 Ansible \u4f3c\u4e4e\u4e26\u6c92\u6709\u8fa8\u6cd5\u5c07\u6211\u5011 playbook \u4e2d\u5b9a\u7fa9\u52d5\u4f5c\u6210\u529f\u5730\u90e8\u7f72\u5230 sre001 \u4e0a\u3002","title":"\u4ec0\u9ebc\u662f inventory?"},{"location":"ansible/ansible-intro/#private_key_file","text":"\u5f9e\u4e0a\u9762\u7684\u932f\u8aa4\u8a0a\u606f (error message) \u4e2d\u6211\u5011\u53ef\u4ee5\u77e5\u9053\u90e8\u7f72\u5931\u6557\u7684\u539f\u56e0\u767c\u751f\u5728 SSH \u9023\u7dda\u5931\u6557\u3002\u9084\u8a18\u5f97\u6211\u5011\u8aaa\u904e\u4f7f\u7528 Ansible \u90e8\u7f72\u9059\u63a7\u7bc0\u9ede\u5fc5\u9808\u8981\u900f\u904e SSH \u9023\u7dda\u55ce\uff1f\u4e00\u822c\u4f86\u8aaa\uff0c\u6211\u5011\u5982\u679c\u8981\u900f\u904e SSH \u5b58\u53d6\u7db2\u7ad9\u6211\u5011\u6703\u9810\u8a2d\u5c07\u7522\u751f\u51fa\u4f86\u7684\u516c\u7528\u91d1\u9470 (public key) \u5b58\u653e\u5728 ~/.ssh/ \u7684\u8def\u5f91\u4e0b\uff0c\u7136\u5f8c\u518d\u624b\u52d5\u5c07\u9019\u7d44\u91d1\u9470\u52a0\u5230\u6211\u5011\u60f3\u8981\u6388\u6b0a\u7684\u670d\u52d9\u5217\u8868\u4e0a\u3002 \u4e0d\u904e\uff0c\u56e0\u70ba\u6211\u5011\u662f\u4f7f\u7528 Vagrant \u5efa\u7acb\u8d77\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u4f5c\u70ba\u7df4\u7fd2\uff0cVagrant \u5176\u5be6\u5df2\u7d93\u4e8b\u5148\u5e6b\u6211\u5011\u628a\u63a7\u5236\u4e3b\u6a5f\u8207\u9059\u63a7\u7bc0\u9ede\u505a\u597d SSH \u914d\u5c0d\u4e86\uff0c\u6240\u4ee5\u6211\u5011\u4e26\u4e0d\u9700\u8981\u624b\u52d5\u8a2d\u5b9a\u9019\u500b\u90e8\u5206\u3002\u5f9e\u4e0a\u9762\u7684 vagrant ssh-config \u8f38\u51fa\u7684\u7d50\u679c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u4e00\u500b\u7279\u6b8a\u7684\u53c3\u6578\uff1a IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key \u9019\u500b\u53c3\u6578\u544a\u8a34\u4e86\u6211\u5011\u9019\u53f0\u865b\u64ec\u4e3b\u6a5f private key \u7684\u5b58\u653e\u4f4d\u7f6e\uff0c\u6211\u5011\u53ea\u9700\u8981\u900f\u904e\u4ee5\u4e0b\u6307\u4ee4\uff0c\u5c07\u9019\u500b\u6a94\u6848\u7684\u8def\u5f91\u6307\u5b9a\u7d66 Ansible\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6210\u529f\u904b\u884c\u6211\u5011\u7684 playbook \u56c9\uff01 $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u904b\u884c\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [test connection] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [print debug message] **************************************************************************************************************************************************** ok: [127.0.0.1] => { \"msg\": { \"changed\": false, \"failed\": false, \"ping\": \"pong\" } } PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6210\u529f\u63a5\u6536\u5230\u5f9e sre001 \u56de\u50b3\u56de\u4f86\u7684 \"pong\" \u4e86\uff01","title":"\u8a2d\u5b9a PRIVATE_KEY_FILE"},{"location":"ansible/ansible-intro/#ansible-role","text":"\u73fe\u5728\u5927\u5bb6\u61c9\u8a72\u4e86\u89e3\u5982\u4f55\u64b0\u5beb Ansible playbook \uff0c\u4e26\u5c07\u6211\u5011\u7684\u5de5\u4f5c\u6e05\u55ae\u4ee5 task \u7684\u65b9\u5f0f\u5728 playbook \u4e2d\u8868\u5217\u4e0b\u4f86\u3002\u7136\u800c\uff0c\u5982\u679c Ansible \u53ea\u80fd\u505a\u5230\u9019\u6a23\u7684\u7a0b\u5ea6\uff0c\u5145\u5176\u91cf\u6211\u5011\u53ea\u80fd\u8aaa\u9019\u662f\u4e00\u500b\u6bd4\u8f03\u65b9\u4fbf\u95b1\u8b80\u7684 Shell script \u7f77\u4e86\u3002\u82e5\u662f\u4eca\u5929\u6211\u5011\u6e05\u55ae\u4e2d\u7684\u4efb\u52d9\u6709\u4e0a\u767e\u500b\uff0c\u9019\u6a23\u6211\u5011\u7684 playbook \u4e5f\u53ef\u80fd\u6703\u8b8a\u5f97\u975e\u5e38\u5197\u9577\uff0c\u5c31\u7b97\u8a9e\u6cd5\u518d\u5982\u4f55\u6613\u8b80\uff0c\u6574\u9ad4\u800c\u8a00 playbook \u9084\u662f\u6703\u8b8a\u5f97\u5341\u5206\u96e3\u4ee5\u7406\u89e3\u3002 \u53e6\u5916\uff0c\u5f88\u591a\u6642\u5019\u5176\u5be6\u6211\u5011\u6703\u5e0c\u671b\u6709\u90e8\u5206\u7684\u90e8\u7f72\u5167\u5bb9\u662f\u53ef\u4ee5\u88ab\u5176\u4ed6\u4e0d\u540c\u7684 playbook \u91cd\u65b0\u4f7f\u7528\u3002\u8209\u4f8b\u4f86\u8aaa\uff0c\u5f88\u591a\u670d\u52d9\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 pip \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u4f86\u9032\u884c\u5b89\u88dd\uff0c\u6211\u5011\u4e26\u4e0d\u6703\u5e0c\u671b\u5728\u6bcf\u4e00\u500b\u4e0d\u540c\u7684 playbook \u4e2d\u90fd\u8981\u91cd\u65b0\u5b9a\u7fa9\u4e00\u6b21 pip \u7684\u5b89\u88dd\u65b9\u6cd5\u3002 \u56e0\u6b64\uff0c\u70ba\u4e86\u89e3\u6c7a\u4e0a\u8ff0\u7684\u554f\u984c\uff0cAnsible \u63d0\u4f9b\u4e86\u6211\u5011\u5728\u64b0\u5beb\u81ea\u52d5\u5316\u8173\u672c\u6642\u4e00\u500b\u89d2\u8272 role \u7684\u6982\u5ff5\u3002\u6211\u5011\u53ef\u4ee5\u900f\u904e\u64b0\u5beb\u5c6c\u65bc\u81ea\u5df1\u7684 role \u4f86\u8b93\u6240\u6709 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u85c9\u6b64\u63d0\u5347\u900f\u904e Ansible \u81ea\u52d5\u5316\u7684\u9748\u6d3b\u5ea6\u3002","title":"Ansible Role \u521d\u767b\u5834"},{"location":"ansible/ansible-intro/#role","text":"\u8003\u91cf\u5230\u7531\u65bc\u5b89\u88dd cURL \u7684\u9019\u500b\u5de5\u4f5c\u5f88\u53ef\u80fd\u6703\u5728\u672a\u4f86\u983b\u7e41\u5730\u88ab\u4e0d\u540c\u7684 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u56e0\u6b64\uff0c\u6211\u5011\u9078\u64c7\u628a\u5b89\u88dd cURL \u7684\u65b9\u6cd5\u5beb\u6210\u4e00\u500b\u53ef\u4ee5\u91cd\u8907\u88ab\u5229\u7528\u7684 role \uff0c\u800c\u975e playbook \u4e2d\u7684\u4e00\u500b task\u3002 \u8b93\u6211\u5011\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848 (\u65b0\u589e roles/curl/main.yml )\uff1a workspace \u251c\u2500\u2500 Vagrantfile \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 roles \u2514\u2500\u2500 curl \u2514\u2500\u2500 tasks \u2514\u2500\u2500 main.yml \u5728\u9019\u500b\u7d50\u69cb\u4e0b\uff0c curl \u5c31\u662f\u6211\u5011\u7684\u7b2c\u4e00\u500b role \u7684\u540d\u7a31\uff0c\u800c\u9019\u500b role \u7684\u5de5\u4f5c\u6d41\u7a0b\u5c31\u6703\u88ab\u6211\u5011\u5b9a\u7fa9\u5728\u4e0b\u9762\u7684 tasks/main.yml \u4e4b\u4e2d\u3002\u73fe\u5728\u6253\u958b curl/tasks/main.yml \u4e26\u5728\u5176\u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a curl/tasks/main.yml --- - name : install curl ansible.builtin.apt : name : curl \u6211\u5011\u5728\u9019\u500b role \u7684\u5167\u5bb9\u4e2d\u547c\u53eb\u4e86 Ansible \u5167\u5efa\u6a21\u7d44 apt \uff0c\u4e26\u5229\u7528\u5b83\u76f4\u63a5\u9032\u884c cURL \u7684\u5b89\u88dd\u3002\u63a5\u8457\uff0c\u6253\u958b\u6211\u5011\u7684 playbook.yml\uff0c\u4e26\u4fee\u6539\u70ba\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : ironman roles : - { role : curl , become : yes } \u6211\u5011\u522a\u9664\u4e86\u4e4b\u524d\u7528\u4f86\u6e2c\u8a66\u7684 ping \u5287\u78bc (play)\uff0c\u4e26\u5728\u9019\u500b playbook \u4e2d\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u57f7\u884c curl \u9019\u500b\u6211\u5011\u525b\u5b9a\u7fa9\u597d\u7684 role\u3002\u5176\u4e2d\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c become \u4ee3\u8868\u6211\u5011\u8981\u5347\u9ad8\u7576\u524d\u4f7f\u7528\u8005\u6b0a\u9650 \uff08\u7b49\u6548\u65bc Unix / Linux \u4e2d\u7684 sudo \u6307\u4ee4\uff09\u4f86\u904b\u884c\u7576\u524d\u5de5\u4f5c\u3002 \u6700\u5f8c\uff0c\u91cd\u65b0\u904b\u884c\u6211\u5011\u7684 playbook $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u5f97\u5230\u4ee5\u4e0b\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] **************************************************************************************************************************************************** ok: [127.0.0.1] PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"\u7b2c\u4e00\u500b role"},{"location":"ansible/ansible-intro/#ansiblecfg","text":"\u6709\u4e9b\u6642\u5019\u6211\u5011\u60f3\u8981\u628a\u76f8\u95dc\u7684roles\u7f6e\u653e\u7684\u8def\u5f91\u505a\u4e0d\u540c\u7684\u898f\u5283\u6642\uff0cAnsible \u5c31\u6703\u627e\u4e0d\u5230\u5c0d\u61c9 role \u6a94\u6848\u7684\u4f4d\u7f6e\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5c31\u5fc5\u9808\u900f\u904e\u8a2d\u5b9a Ansible \u7684\u914d\u7f6e\u6a94\u6848 - ansible.cfg \u4f86\u8a2d\u7f6e role \u8def\u5f91 (path)\u3002 \u65b0\u589e\u4e00\u500b\u6a94\u6848 ansible.cfg \u4e26\u52a0\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a ansible.cfg [sre001] roles_path = ./roles \u82e5\u9ede\u9032\u5b98\u65b9\u914d\u7f6e\u6587\u4ef6\u7684\u8aaa\u660e\u9801\u9762\uff0c\u53ef\u4ee5\u767c\u73fe\u9664\u4e86 roles_path \u4e4b\u5916\u9084\u6709\u4e00\u5927\u5806\u53c3\u6578\u53ef\u4ee5\u4f9d\u64da\u4f7f\u7528\u8005\u7684\u9700\u6c42\u9032\u884c\u975e\u5e38\u6709\u5f48\u6027\u7684\u914d\u7f6e\u3002\u5176\u4e2d\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u9019\u500b\u793a\u7bc4\u88e1\u9762\u6211\u662f\u5c07 ansible.cfg \u9019\u500b\u914d\u7f6e\u6a94\u6848\u7f6e\u65bc\u6211\u5011\u5de5\u4f5c\u8cc7\u6599\u593e\u4e4b\u4e0b\uff0c\u76ee\u524d\u5177\u9ad4\u8cc7\u6599\u593e\u7d50\u69cb\u5982\u4e0b\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u2514\u2500\u2500 curl \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4f46\u5f9e\u5b98\u65b9\u6587\u4ef6\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u767c\u73fe\u9664\u4e86\u5c07\u914d\u7f6e\u6a94\u6848\u653e\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u5e95\u4e0b\u5916\uff0c\u9084\u6709\u5176\u4ed6\u5e7e\u7a2e\u4e0d\u540c\u7684\u914d\u7f6e\u65b9\u5f0f\uff1a \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf ANSIBLE_CONFIG \u7f6e\u65bc\u7576\u524d\u76ee\u9304\u4e0b\u7684 ansible.cfg \uff08\u9019\u6b21\u7bc4\u4f8b\u4e2d\u4f7f\u7528\u7684\u65b9\u6cd5\uff09 \u7f6e\u65bc\u6839\u76ee\u9304\u4e0b\u7684 .ansible.cfg \u7f6e\u65bc /etc/ansible/ \u4e0b\u7684 ansible.cfg \u82e5\u6211\u5011\u540c\u6642\u5206\u5225\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u5b58\u5728\u5728\u7cfb\u7d71\u4e2d\uff0cAnsible \u6703\u4f9d\u7167\u4e0a\u8ff0\u9806\u5e8f\u9010\u4e00\u67e5\u627e\u6587\u4ef6\uff0c\u82e5\u627e\u5230\u5176\u4e2d\u4e00\u500b\uff0c\u5c31\u6703\u4f9d\u5176\u8a2d\u5b9a\u9032\u884c\u914d\u7f6e\uff0c\u4e26\u4e0d\u518d\u7e7c\u7e8c\u67e5\u627e\u3002","title":"\u914d\u7f6e ansible.cfg"},{"location":"ansible/ansible-intro/#ansible-role_1","text":"\u5728\u5b8c\u6210\u7b2c\u4e00\u500b\u7c21\u55ae\u7684 role \u4e4b\u5f8c\uff0c\u8b93\u6211\u5011\u8a66\u8457\u5b89\u88dd\u4e00\u500bCI/CD\u7684\u5de5\u5177 Jenkins\u3002","title":"\u5efa\u7acb Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2"},{"location":"ansible/ansible-intro/#jenkins","text":"\u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-jenkins-on-ubuntu-20-04 Jenkins \u5728 Ubuntu \u4e0a\u7684\u5b89\u88dd\u65b9\u5f0f\uff1a $ wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add - $ sudo sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list' $ sudo apt update $ sudo apt install jenkins \u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u6703\u5f9e Jenkins \u5b98\u65b9\u91cb\u51fa\u7684 Debian \u5957\u4ef6\u5eab\u4e2d\u5c07\u5bc6\u9470 (key) \u52a0\u5165\u672c\u5730\uff0c\u4e26\u65b0\u589e\u5c0d\u61c9\u7684\u5009\u5eab (repository) \u5165\u53e3\u3002\u6700\u5f8c\uff0c\u518d\u900f\u904e apt \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u9032\u884c Jenkins \u7684\u5b89\u88dd\u3002\u73fe\u5728\u8b93\u6211\u5011\u628a\u4e0a\u9762\u7684\u6307\u4ee4\u7ffb\u8b6f\u6210 Ansible \u7684\u8173\u672c\uff1a --- - name : add jenkins key ansible.builtin.apt_key : url : https://pkg.jenkins.io/debian-stable/jenkins.io.key state : present - name : add jenkins repository ansible.builtin.apt_repository : repo : deb http://pkg.jenkins.io/debian-stable binary/ state : present - name : install jenkins ansible.builtin.apt : name : jenkins update_cache : yes Tip \u5728\u9019\u6b21\u7684\u4efb\u52d9\u4e2d\u6211\u5011\u4f7f\u7528\u4e86\u4e09\u500bAnsible\u7684\u6a21\u7d44: ansible.builtin.apt_key \u6a21\u7d44 ansible.builtin.apt_repository \u6a21\u7d44 ansible.builtin.apt \u6a21\u7d44 \u5176\u4e2d apt_key \u53ca apt_repository \u90fd\u662f Ansible \u5df2\u7d93\u5167\u5efa\u7684\u5169\u500b\u6a21\u7d44\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5229\u7528\u5b83\u5011\u9032\u884c\u5bc6\u9470\u53ca\u5009\u5eab\u7684\u65b0\u589e\uff0c\u66f4\u591a\u7d30\u7bc0\u64cd\u4f5c\u53ef\u4ee5\u5728\u5b98\u65b9\u7684\u6587\u4ef6\u4e0a\u67e5\u770b\u3002\u800c\u5728 install jenkins \u9019\u500b task \u4e4b\u4e0b\u7684 update_cache \u5176\u5be6\u5c31\u662f\u7b49\u6548\u65bc\u6211\u5011\u5728\u4e00\u822c Ubuntu / Debian \u7cfb\u7d71\u4e0b\u4f7f\u7528 apt-get update \u7684\u6307\u4ee4\uff0c\u82e5\u5728\u64cd\u4f5c Ansible \u7684 apt \u9019\u500b\u6a21\u7d44\u6642\u4f7f\u7528\u4e86 update_cache: yes\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u6703\u5148\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 apt \u5957\u4ef6\u7ba1\u7406\u9032\u884c\u5347\u7d1a\u624d\u505a\u63a5\u4e0b\u4f86\u7684\u52d5\u4f5c\u3002 \u89e3\u91cb\u5b8c\u8981\u505a\u7684\u4e8b\u4ee5\u5f8c\uff0c\u9019\u6b21\u6211\u4e5f\u8981\u540c\u6642\u5c07\u6574\u500b\u5b89\u88dd Jenkins \u7684\u6d41\u7a0b\u5beb\u6210\u53e6\u5916\u4e00\u500b role\u3002\u4e00\u6a23\u7684\uff0c\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e jenkins \u9019\u500b role\uff0c\u4e26\u5728 roles/jenkins/tasks/main.yml \u4e2d\u8f38\u5165\u4ee5\u4e0a\u5167\u5bb9\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 jenkins \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u73fe\u5728\u6211\u5011\u6709\u5169\u500b roles \u4e86\u3002\u56de\u5230\u6211\u5011\u7684 playbook.yml \u4f5c\u4ee5\u4e0b\u7684\u8abf\u6574: playbook.yml --- - hosts : sre001 roles : - { role : curl , become : yes } - { role : jenkins , become : yes } \u91cd\u65b0\u57f7\u884c playbook: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml PLAY [sre001] ************************************************************************************************************* TASK [Gathering Facts] **************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] ************************************************************************************************ ok: [127.0.0.1] TASK [jenkins : add jenkins key] ****************************************************************************************** changed: [127.0.0.1] TASK [jenkins : add jenkins repository] *********************************************************************************** changed: [127.0.0.1] TASK [jenkins : install jenkins] ****************************************************************************************** fatal: [127.0.0.1]: FAILED! => {\"cache_update_time\": 1654304408, \"cache_updated\": true, \"changed\": false, \"msg\": \"'/usr/bin/apt-get -y -o \\\"Dpkg::Options::=--force-confdef\\\" -o \\\"Dpkg::Options::=--force-confold\\\" install 'jenkins'' failed: E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"rc\": 100, \"stderr\": \"E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"stderr_lines\": [\"E: Sub-process /usr/bin/dpkg returned an error code (1)\"], \"stdout\": \"Reading package lists...\\nBuilding dependency tree...\\nReading state information...\\nThe following additional packages will be installed:\\n net-tools\\nThe following NEW packages will be installed:\\n jenkins net-tools\\n0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\\nNeed to get 91.6 MB of archives.\\nAfter this operation, 95.9 MB of additional disk space will be used.\\nGet:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\\nGet:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\\nFetched 91.6 MB in 12s (7,593 kB/s)\\nSelecting previously unselected package net-tools.\\r\\n(Reading database ... \\r(Reading database ... 5%\\r(Reading database ... 10%\\r(Reading database ... 15%\\r(Reading database ... 20%\\r(Reading database ... 25%\\r(Reading database ... 30%\\r(Reading database ... 35%\\r(Reading database ... 40%\\r(Reading database ... 45%\\r(Reading database ... 50%\\r(Reading database ... 55%\\r(Reading database ... 60%\\r(Reading database ... 65%\\r(Reading database ... 70%\\r(Reading database ... 75%\\r(Reading database ... 80%\\r(Reading database ... 85%\\r(Reading database ... 90%\\r(Reading database ... 95%\\r(Reading database ... 100%\\r(Reading database ... 63489 files and directories currently installed.)\\r\\nPreparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\\r\\nUnpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSelecting previously unselected package jenkins.\\r\\nPreparing to unpack .../jenkins_2.332.3_all.deb ...\\r\\nUnpacking jenkins (2.332.3) ...\\r\\nSetting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSetting up jenkins (2.332.3) ...\\r\\nCreated symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\\r\\nJob for jenkins.service failed because the control process exited with error code.\\r\\nSee \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\\r\\ninvoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\\r\\n\u25cf jenkins.service - Jenkins Continuous Integration Server\\r\\n Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\\r\\n Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\\r\\n Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\\r\\n Main PID: 3569 (code=exited, status=1/FAILURE)\\r\\ndpkg: error processing package jenkins (--configure):\\r\\n installed jenkins package post-installation script subprocess returned error exit status 1\\r\\nProcessing triggers for man-db (2.9.1-1) ...\\r\\nProcessing triggers for systemd (245.4-4ubuntu3.17) ...\\r\\nErrors were encountered while processing:\\r\\n jenkins\\r\\n\", \"stdout_lines\": [\"Reading package lists...\", \"Building dependency tree...\", \"Reading state information...\", \"The following additional packages will be installed:\", \" net-tools\", \"The following NEW packages will be installed:\", \" jenkins net-tools\", \"0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\", \"Need to get 91.6 MB of archives.\", \"After this operation, 95.9 MB of additional disk space will be used.\", \"Get:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\", \"Get:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\", \"Fetched 91.6 MB in 12s (7,593 kB/s)\", \"Selecting previously unselected package net-tools.\", \"(Reading database ... \", \"(Reading database ... 5%\", \"(Reading database ... 10%\", \"(Reading database ... 15%\", \"(Reading database ... 20%\", \"(Reading database ... 25%\", \"(Reading database ... 30%\", \"(Reading database ... 35%\", \"(Reading database ... 40%\", \"(Reading database ... 45%\", \"(Reading database ... 50%\", \"(Reading database ... 55%\", \"(Reading database ... 60%\", \"(Reading database ... 65%\", \"(Reading database ... 70%\", \"(Reading database ... 75%\", \"(Reading database ... 80%\", \"(Reading database ... 85%\", \"(Reading database ... 90%\", \"(Reading database ... 95%\", \"(Reading database ... 100%\", \"(Reading database ... 63489 files and directories currently installed.)\", \"Preparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\", \"Unpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Selecting previously unselected package jenkins.\", \"Preparing to unpack .../jenkins_2.332.3_all.deb ...\", \"Unpacking jenkins (2.332.3) ...\", \"Setting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Setting up jenkins (2.332.3) ...\", \"Created symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\", \"Job for jenkins.service failed because the control process exited with error code.\", \"See \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\", \"invoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\", \"\u25cf jenkins.service - Jenkins Continuous Integration Server\", \" Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\", \" Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\", \" Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\", \" Main PID: 3569 (code=exited, status=1/FAILURE)\", \"dpkg: error processing package jenkins (--configure):\", \" installed jenkins package post-installation script subprocess returned error exit status 1\", \"Processing triggers for man-db (2.9.1-1) ...\", \"Processing triggers for systemd (245.4-4ubuntu3.17) ...\", \"Errors were encountered while processing:\", \" jenkins\"]} PLAY RECAP **************************************************************************************************************** 127.0.0.1 : ok=4 changed=2 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 \u57f7\u884c\u7684\u7d50\u679c\u5728 install jenkins \u51fa\u73fe\u5931\u6557\u3002\u53bb\u67e5\u8a62 Jenkins \u5b98\u7db2\u767c\u73fe Jenkins \u5fc5\u9700\u8981\u4f9d\u8cf4 Java \u624d\u80fd\u5920\u6b63\u78ba\u904b\u884c\u4e4b\u524d\uff0c\u4e5f\u5c31\u662f\u8aaa\u9664\u4e86\u5728 ansible \u4e2d\u8a2d\u5b9a\u5b89\u88dd Java \u4e4b\u5916, \u9084\u5fc5\u9700\u8b93 jenkins \u662f\u5728 java \u5b89\u88dd\u5b8c\u4e4b\u5f8c\u624d\u80fd\u63a5\u7e8c\u5b89\u88dd\u3002 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-on-ubuntu-20-04#installing-specific-versions-of-openjdk","title":"\u81ea\u52d5\u5316 Jenkins \u5b89\u88dd"},{"location":"ansible/ansible-intro/#ansible-role_2","text":"\u5728 Ansible \u7684\u4e16\u754c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e\u5b9a\u7fa9 role \u8207 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2 role dependencies \u4f86\u63d0\u5347\u6bcf\u4e00\u500b role \u7684\u53ef\u8b80\u6027\u8207\u76f8\u4e92\u7684\u4f9d\u8cf4\u3002\u5c31\u4ee5\u4e0a\u9762\u7684\u4f8b\u5b50\u800c\u8a00\uff0c\u6211\u5011\u5e0c\u671b\u6240\u6709\u90e8\u7f72 Jenkins \u7684\u4f3a\u670d\u5668\u90fd\u9810\u5148\u642d\u8f09\u597d Java\uff0c\u82e5\u7528 Ansible \u7684\u89d2\u5ea6\u601d\u8003\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u5e0c\u671b jenkins \u9019\u500b role \u4f9d\u8cf4\u65bc openjre \u9019\u500b role\u3002\u6211\u5011\u53ef\u4ee5\u5728\u6bcf\u4e00\u500b role \u7684\u8cc7\u6599\u593e\u4e2d\u900f\u904e meta \u9019\u500b\u5b50\u76ee\u9304\u5b9a\u7fa9\u9019\u6a23\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u5177\u9ad4\u6b65\u9a5f\u5982\u4e0b\uff1a \u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u5728 roles \u7684\u76ee\u9304\u4e0b\u5efa\u7acb openjre\\tasks \u7684\u5b50\u76ee\u9304\u4e26\u4e14\u5efa\u7acb\u4e00\u500b\u65b0\u6a94\u6848 main.yml : openjre\\tasks\\main.yml --- - name : install openjre ansible.builtin.apt : name : default-jre update_cache : yes \u4e0a\u8ff0\u7684 role \u6703\u7528\u4f86\u5b89\u88dd Java JRE runtime\u3002 jenkins/meta/main.yml --- dependencies : - { role : openjre , become : yes } \u5b9a\u7fa9 jenkins \u9019\u500b role \u4f9d\u8cf4\u4e8e openjre \u7684 role\u3002 \u56de\u5230 playbook.yml \u4e2d\u522a\u9664\u539f\u672c\u547c\u53eb curl role \u7684\u90e8\u5206\uff0c\u53ea\u7559\u4e0b jenkins\uff1a: playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=5 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6839\u64da role \u7684\u65b0\u7d50\u69cb\uff0c\u6211\u5011\u6bcf\u6b21\u53ea\u8981\u547c\u53eb jenkins \u9019\u500b role\uff0c\u5728\u5b89\u88dd Jenkins \u4e4b\u524d\uff0cAnsible \u5c31\u6703\u81ea\u52d5\u5148\u5e6b\u6211\u5011\u628a\u6240\u6709\u5b9a\u7fa9\u5728 meta \u4e2d\u7684\u670d\u52d9\u4f9d\u8cf4\u5b89\u88dd\u597d\u3002\u82e5\u672a\u4f86\u5728 jenkins \u9019\u500b role \u4e0a\u8981\u65b0\u589e\u6216\u79fb\u9664\u670d\u52d9\u4f9d\u8cf4\uff0c\u6211\u5011\u53ea\u9700\u8981\u56de\u5230 meta \u4e2d\u505a\u4fee\u6539\u5373\u53ef\u3002 \u900f\u904e\u5b9a\u7fa9 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u6211\u5011\u53ef\u4ee5\u5728 playbook \u4e2d\u53ea\u55ae\u7d14\u547c\u53eb\u9700\u8981\u7684 role\uff0c\u800c\u4e0d\u7528\u56de\u5230\u5e95\u5c64\u601d\u8003\u904b\u884c\u9019\u500b role \u4e4b\u524d\u6211\u5011\u9084\u9700\u8981\u5b89\u88dd\u4ec0\u9ebc\u984d\u5916\u7684\u670d\u52d9\u3002\u9019\u6a23\u7684\u8a2d\u8a08\u908f\u8f2f\u4e0d\u4f46\u53ef\u4ee5\u5c07\u6bcf\u4e00\u500b role \u90fd\u8996\u70ba\u5df2\u7d93\u5b8c\u5168\u53ef\u4ee5\u7528\u7684\u5de5\u5177\uff0c\u5728\u7dad\u8b77\u7684\u89d2\u5ea6\u4e0a\u4e5f\u4f7f\u5b89\u88dd\u7d50\u69cb\u66f4\u4f73\u6e05\u6670\u6613\u61c2\u3002 \u958b\u767c\u4eba\u54e1\u904e\u53bb\u5f80\u5f80\u56e0\u70ba\u7e41\u7463\u7684\u5b89\u88dd\u6d41\u7a0b\u96e3\u514d\u758f\u5ffd\u5176\u4e2d\u5e7e\u500b\u524d\u7f6e\u670d\u52d9\u5b89\u88dd\uff0c\u9032\u800c\u5c0e\u81f4\u5f8c\u9762\u90e8\u7f72\u6d41\u7a0b\u767c\u751f\u7684\u932f\u8aa4\uff0c\u900f\u904e\u9019\u6a23\u7684\u8a2d\u8a08\u6d41\u7a0b\uff0c\u5c07\u53ef\u4ee5\u5fb9\u5e95\u88ab\u89e3\u6c7a\u3002","title":"Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2"},{"location":"ansible/ansible-intro/#role_1","text":"\u6211\u5011\u5c07\u65b0\u589e\u4e00\u500b role \u7528\u4f86\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u55ae\u4e00\u500b role \u540c\u6642\u652f\u63f4\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u7684\u4e3b\u6a5f\u3002","title":"Role \u8de8\u7cfb\u7d71\u7684\u9748\u6d3b\u5ea6"},{"location":"ansible/ansible-intro/#git","text":"\u5beb\u53e6\u4e00\u500b\u7368\u7acb\u7684 role \u4f86\u5b89\u88dd Git\u3002\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e git \u9019\u500b role\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 git \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4e26\u5728 roles/git/tasks/main.yml \u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a roles/git/tasks/main.yml --- - name : install git ansible.builtin.yum : name : git-all when : ansible_distribution == 'CentOS' - name : install git ansible.builtin.apt : name : git when : ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian' \u9664\u4e86\u975e\u5e38\u985e\u4f3c\u65bc\u4e4b\u524d curl \u9019\u500b role \u7684\u5b89\u88dd\u6d41\u7a0b\uff0c\u9019\u6b21\u6211\u5011\u5728 role \u88e1\u9762\u52a0\u4e0a\u4e86\u7cfb\u7d71\u5224\u65b7\u689d\u4ef6\u3002\u7531\u65bc Ubuntu \u8ddf Debian \u9019\u5169\u7a2e\u4e3b\u8981\u7684 Linux \u4f5c\u696d\u7cfb\u7d71\u9810\u8a2d\u90fd\u662f\u642d\u8f09 apt \u505a\u70ba\u5957\u4ef6\u7ba1\u7406\uff0c\u6240\u4ee5\u7576\u6211\u5011\u4eca\u5929\u53ea\u8981\u904b\u884c\u9019\u500b role\uff0c\u4e26\u5224\u65b7\u9059\u63a7\u4e3b\u6a5f\u662f\u9019\u5169\u500b\u4f5c\u696d\u7cfb\u7d71\u4e4b\u4e00\u7684\u6642\u5019\uff0c\u6211\u5011\u5c31\u6703\u904b\u884c\u4e0a\u9762\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002 \u53e6\u5916\uff0c\u7531\u65bc git \u9019\u500b role \u7406\u8ad6\u4e0a\u5728\u672a\u4f86\u88ab\u91cd\u8907\u5229\u7528\u5230\u7684\u983b\u7387\u6703\u975e\u5e38\u9ad8\uff0c\u56e0\u6b64\u6211\u5728\u9019\u88e1\u540c\u6642\u4e5f\u65b0\u589e\u4e86\u5728 CentOS \u9019\u5957\u4f5c\u696d\u7cfb\u7d71\u4e0a\u4f7f\u7528 yum \u5b89\u88dd Git \u7684\u65b9\u6cd5\uff08\u5728 yum \u5957\u4ef6\u7ba1\u7406\u7cfb\u7d71\u4e2d\uff0cGit \u5957\u4ef6\u7684\u540d\u7a31\u8207 apt \u7cfb\u7d71\u4e26\u4e0d\u76f8\u540c\uff09\uff0c\u4ee5\u589e\u52a0\u9019\u500b role \u7684\u4f7f\u7528\u9748\u6d3b\u6027\u3002 \u63a5\u8457\u4fee\u6539 playbook.yml : playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } - { role : git , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] TASK [git : install git] *********************************************************************************** skipping: [127.0.0.1] TASK [git : install git] *********************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=6 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u6211\u5011\u53ef\u4ee5\u770b\u5230 Ansible \u6703\u6839\u64da\u5c0d\u61c9\u7684\u4f5c\u696d\u7cfb\u7d71\u5224\u65b7\u54ea\u4e9b tasks \u53ef\u4ee5\u88ab\u7565\u904e (skipping)\uff0c\u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u6211\u5011\u4e0d\u9700\u8981\u7279\u5225\u70ba\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u4fdd\u5b58\u591a\u4efd\u7248\u672c\u7684 role\uff0c\u53ea\u8981\u5c08\u6ce8\u5728\u540c\u4e00\u500b role \u4e2d\u958b\u767c\u7576\u524d\u4efb\u52d9\u5373\u53ef\u3002 \u53e6\u5916\uff0c\u82e5\u4ed4\u7d30\u95b1\u8b80\u5728\u7d42\u7aef\u6a5f\u4e0a\u986f\u793a\u7684 Ansible \u5b89\u88dd\u6d41\u7a0b\uff0c\u61c9\u8a72\u6703\u767c\u73fe\u5df2\u7d93\u88ab\u5b89\u88dd\u904e\u7684\u670d\u52d9\u4e26\u4e0d\u6703\u4e00\u76f4\u91cd\u8907\u88ab\u5b89\u88dd\u3002\u986f\u793a\u70ba changed \u8868\u793a\u9059\u63a7\u4e3b\u6a5f\u5728\u9019\u6b21\u904b\u884c playbook \u7684\u904e\u7a0b\u88e1\uff0cAnsible \u5728\u8a72\u9805 task \u4e2d\u5c0d\u7cfb\u7d71\u505a\u4e86\u6539\u8b8a\uff1bok \u5247\u8868\u793a\u8a72 task \u7684\u5b8c\u6210\u689d\u4ef6\u5df2\u6eff\u8db3\uff0c\u6240\u4ee5 Ansible \u4e26\u4e0d\u6703\u984d\u5916\u5c0d\u4e3b\u6a5f\u505a\u5176\u4ed6\u8b8a\u52d5\u3002 \u7279\u5225\u9700\u8981\u89e3\u91cb\u7684\u662f\uff0c\u82e5\u6211\u5011\u4f7f\u7528\u4e86 update_cache: yes \u9019\u9805\u5c6c\u6027\u4f86\u900f\u904e\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u5b89\u88dd\u670d\u52d9\u3002\u6211\u5011\u6bcf\u6b21\u5b89\u88dd\u670d\u52d9\u524d\u90fd\u6703\u8a66\u5716\u5c07\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u7684\u7248\u672c\u90fd\u66f4\u65b0\u5230\u7576\u524d\u6700\u65b0\u7248\u672c\uff0c\u7136\u5f8c\u624d\u9032\u884c\u5b89\u88dd\u6b65\u9a5f\uff0c\u56e0\u6b64\u6bcf\u6b21 task \u7684\u72c0\u614b\u90fd\u5c07\u6703\u986f\u793a\u70ba changed\u3002","title":"\u5b89\u88dd Git"},{"location":"ansible/ansible-intro/#ansible-galaxy","text":"Ansible Galaxy \u662f\u4e00\u500b Ansible \u5b98\u65b9\u63d0\u4f9b\u7684 Ansible Role \u5171\u4eab\u5e73\u53f0\u3002\u6240\u6709 Ansible \u7684\u4f7f\u7528\u8005\u90fd\u53ef\u4ee5\u81ea\u7531\u4e0a\u50b3\u81ea\u5df1\u7684 role \u8207\u5168\u4e16\u754c\u7684\u958b\u767c\u4eba\u54e1\u5206\u4eab\u3002 \u5728\u63a5\u5230\u4efb\u52d9\u9700\u6c42\u524d\uff0c\u5efa\u8b70\u8b80\u8005\u53ef\u4ee5\u82b1\u500b\u5e7e\u5206\u9418\u5728\u4e0a\u9762\u7a0d\u5fae\u700f\u89bd\u4e00\u4e0b\uff0c\u770b\u770b\u662f\u5426\u6709\u9069\u5408\u81ea\u5df1\u4f7f\u7528\u7684\u73fe\u6210 role \u7684\u53ef\u4ee5\u7acb\u523b\u62ff\u4f86\u4f7f\u7528\u3002\u4e0d\u904e\uff0c\u70ba\u907f\u514d\u8b80\u8005\u6df7\u6dc6\uff0c\u9019\u6b21\u5c31\u4e0d\u7279\u5225\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 ansible-galaxy \u4f86\u8abf\u7528\u5176\u4ed6\u958b\u767c\u8005\u7684 role\uff0c\u6709\u8208\u8da3\u7684\u8b80\u8005\u53ef\u4ee5\u81ea\u884c\u53c3\u95b1\u5b98\u65b9\u4f7f\u7528\u6559\u5b78\u3002","title":"Ansible Galaxy"},{"location":"ansible/ansible-intro/#vagrant-forward-port","text":"\u7531\u65bc Jenkins \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 8080\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8a66\u8457\u628a\u9059\u63a7\u7bc0\u9ede\u7684 port 8080 \u5ee3\u64ad\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u3002\u4e0d\u904e\uff0c\u7531\u65bc port 8080 \u662f\u4e00\u500b\u975e\u5e38\u5bb9\u6613\u88ab\u5176\u4ed6\u670d\u52d9\u4f7f\u7528\u7684 port\uff0c\u70ba\u4e86\u907f\u514d\u885d\u7a81\uff0c\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u7684 port 9080\u3002 \u5728 Vagrantfile \u4e2d\uff0c\u76f4\u63a5\u5728 config.vm.define \"sre001\" \u8a72\u884c\u4e0b\u9762\u65b0\u589e\u4ee5\u4e0b\u8a2d\u5b9a\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"forwarded_port\" , guest : 8080 , host : 9080 end \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a $ vagrant reload \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a == > sre001: Attempting graceful shutdown of VM... == > sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > sre001: Clearing any previously set forwarded ports... == > sre001: Fixed port collision for 22 = > 2222 . Now on port 2201 . == > sre001: Clearing any previously set network interfaces... == > sre001: Preparing network interfaces based on configuration... sre001: Adapter 1 : nat == > sre001: Forwarding ports... sre001: 8080 ( guest ) = > 9080 ( host ) ( adapter 1 ) sre001: 22 ( guest ) = > 2201 ( host ) ( adapter 1 ) == > sre001: Running 'pre-boot' VM customizations... == > sre001: Booting VM... == > sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127 .0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key == > sre001: Machine booted and ready! == > sre001: Checking for guest additions in VM... == > sre001: Mounting shared folders... sre001: /vagrant = > /home/dxlab/opt/vagrant_getting_started == > sre001: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > sre001: flag to force provisioning. Provisioners marked to run always will still run. \u6211\u5011\u53ef\u4ee5\u5f9e\u4e0a\u9762\u8cc7\u8a0a\u4e2d\u770b\u5230 Vagrant \u5df2\u7d93\u5e6b\u6211\u5011\u628aVM\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u672c\u6a5f\u7684 port 9080 \u4e86\u3002\u73fe\u5728\u5617\u8a66\u900f\u904e\u700f\u89bd\u5668\u8a2a\u554f http://localhost:9080 \u5c31\u61c9\u8a72\u53ef\u4ee5\u9806\u5229\u9032\u5165 Jenkins \u7684\u521d\u59cb\u5316\u9801\u9762\u4e86\uff1a","title":"\u8a2d\u5b9a Vagrant forward port"},{"location":"ansible/ansible-intro/#_1","text":"\u5f9e\u672c\u6b21\u7684\u5feb\u901f\u5165\u9580\u6559\u7a0b\u4e2d\u6211\u5011\u5feb\u901f\u5730\u4ecb\u8a54\u4e86 Ansible \u6700\u91cd\u8981\u7684\u57fa\u672c\u6982\u5ff5: ansible config inventory playbook tasks roles modules control node / manage node","title":"\u7d50\u8ad6"},{"location":"ansible/vagrant-intro/","text":"\u4f7f\u7528 Vagrant \u6a21\u64ec\u74b0\u5883 \u00b6 \u7531\u65bc\u5728 DevOps \u7684\u5be6\u52d9\u64cd\u4f5c\u4e0a\u6211\u5011\u5e38\u5e38\u6703\u540c\u6642\u64cd\u4f5c\u591a\u53f0\u6a5f\u5668\uff0c\u6240\u4ee5\u5728\u6b63\u5f0f\u9032\u5165\u63a5\u4e0b\u4f86\u7684\u8ab2\u7a0b\u524d\uff0c\u6211\u60f3\u8981\u5148\u82b1\u4e00\u9ede\u7bc7\u5e45\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Vagrant \u4f86\u6a21\u64ec\u6211\u5011\u7684\u5b78\u7fd2\u74b0\u5883\u3002 Vagrant \u662f\u4ec0\u9ebc\uff1f \u00b6 \u5728\u90e8\u7f72\u8edf\u9ad4\u670d\u52d9\u7684\u968e\u6bb5\uff0c\u958b\u767c\u4eba\u54e1\u5e38\u5e38\u6703\u5229\u7528\u865b\u64ec\u4e3b\u6a5f\u4f86\u6a21\u64ec\u53ca\u914d\u7f6e\u958b\u767c\u74b0\u5883\u3002Vagrant \u5c31\u662f\u57fa\u65bc\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u500b\u670d\u52d9\u3002\u8207\u50b3\u7d71\u4f7f\u7528 VirtualBox \u900f\u904e\u5716\u5f62\u4f7f\u7528\u8005\u4ecb\u9762 (Graphical User Interface, GUI) \u64cd\u4f5c\u865b\u64ec\u4e3b\u6a5f\u6709\u4e00\u9ede\u4e0d\u540c\u7684\u662f\uff0cVagrant \u4e3b\u8981\u662f\u4f7f\u7528\u547d\u4ee4\u5217\u4ecb\u9762 (command-line interface, CLI) \u4f86\u8207\u865b\u64ec\u4e3b\u6a5f\u505a\u6e9d\u901a\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u5c07\u6703\u904b\u7528\u5927\u91cf\u7684\u547d\u4ee4\u5217\u4f86\u9032\u884c\u64cd\u4f5c\u3002 Vagrant \u53ca\u76f8\u95dc\u8edf\u9ad4\u5b89\u88dd \u00b6 \u5b89\u88dd Vagrant \u00b6 Ubuntu/Debian CentOS/RHEL curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add - sudo apt-add-repository \"deb [arch=amd64] https://apt.releases.hashicorp.com $( lsb_release -cs ) main\" sudo apt-get update && sudo apt-get install vagrant sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo sudo yum -y install vagrant \u5176\u5b83\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u624b\u6cd5\u8acb\u53c3\u95b1: https://www.vagrantup.com/downloads \u9a57\u8b49\u5b89\u88dd \u00b6 \u5b89\u88dd Vagrant \u5f8c\uff0c\u901a\u904e\u6253\u958b\u65b0\u7684\u547d\u4ee4\u63d0\u793a\u7b26\u6216\u63a7\u5236\u53f0\u4f86\u9a57\u8b49\u5b89\u88dd\u662f\u5426\u6b63\u5e38\uff0c\u4e26\u6aa2\u67e5 vagrant \u662f\u5426\u53ef\u7528\u3002 $ vagrant Usage: vagrant [options] <command> [<args>] -v, --version Print the version and exit. -h, --help Print this help. # ... \u5b89\u88dd VirtualBox \u00b6 Vagrant \u652f\u6301\u4e0d\u540c\u7684\u865b\u64ec\u5316\u7522\u54c1\uff0c\u4f8b\u5982\uff1b VirtualBox\u3001VMware Fusion \u6216 Hyper-V\u3002\u5728\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528 VirtualBox \u4f86\u8b93\u5b78\u54e1\u7df4\u7fd2\u3002 \u8acb\u6839\u64da VirtualBox \u5b98\u7db2\u4e0a\u7684\u6307\u793a\u4f86\u9032\u884c\u5b89\u88dd: https://www.virtualbox.org/wiki/Downloads \u5275\u5efa\u4e00\u53f0\u865b\u64ec\u6a5f \u00b6 \u5275\u5efa\u4e00\u500b\u76ee\u9304 \u00b6 \u914d\u7f6e\u4efb\u4f55 Vagrant \u5c08\u6848\u7684\u7b2c\u4e00\u6b65\u662f\u5275\u5efa\u4e00\u500b Vagrantfile \u3002 Vagrantfile \u5141\u8a31\u4f60\uff1a \u6a19\u8a18 project \u7684\u6839\u76ee\u9304\u3002 Vagrant \u4e2d\u7684\u8a31\u591a\u914d\u7f6e\u9078\u9805\u90fd\u662f\u76f8\u5c0d\u65bc\u9019\u500b\u6839\u76ee\u9304\u7684\u3002 \u63cf\u8ff0\u904b\u884c\u5c08\u6848\u6240\u9700\u7684 VM \u548c\u8cc7\u6e90\u985e\u578b\uff0c\u4ee5\u53ca\u8981\u5b89\u88dd\u7684\u8edf\u4ef6\u4ee5\u53ca\u4f60\u5e0c\u671b\u5982\u4f55\u8a2a\u554f\u5b83\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_getting_started $ cd vagrant_getting_started \u521d\u59cb\u5316\u5c08\u6848 \u00b6 Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a hashcorp/bionic64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" end \u555f\u52d5\u865b\u64ec\u6a5f VM \u00b6 \u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220523.0.0' is up to date... ==> default: A newer version of the box 'ubuntu/focal64' for provider 'virtualbox' is ==> default: available! You currently have version '20220523.0.0'. The latest is version ==> default: '20220530.0.0'. Run `vagrant box update` to update. ==> default: Setting the name of the VM: vagrant_getting_started_default_1654224585969_14799 ==> default: Fixed port collision for 22 => 2222. Now on port 2201. ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat ==> default: Forwarding ports... default: 22 (guest) => 2201 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_getting_started SSH\u9032\u5165\u865b\u64ec\u6a5f \u00b6 Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Fri Jun 3 02:52:55 UTC 2022 System load: 0.12 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 20% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed \u6aa2\u67e5\u6a5f\u5668\u72c0\u614b \u00b6 \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u767c\u73fe\u96d6\u7136\u865b\u64ec\u6a5f\u5df2\u7d93\u6210\u529f\u904b\u884c\uff0c\u4f46\u4e3b\u6a5f\u540d\u7a31\u986f\u793a\u70ba default \u3002\u9019\u7a2e\u6a21\u7cca\u7684\u540d\u7a31\u5728\u7ba1\u7406\u4e3b\u6a5f\u6578\u91cf\u591a\u8d77\u4f86\u5f8c\u5e38\u5e38\u6703\u9020\u6210\u958b\u767c\u8005\u7684\u56f0\u64fe\u3002\u70ba\u4e86\u907f\u514d\u6df7\u6dc6\uff0c\u6211\u5011\u53ef\u4ee5\u5148\u7528 vagrant halt \u5c07\u76ee\u524d\u7684\u865b\u64ec\u6a5f\u66ab\u505c\u6216\u662f\u4f7f\u7528 vagrant destroy \u76f4\u63a5\u6467\u6bc0 (destroy)\u3002\u63a5\u4e0b\u4f86\uff0c\u5728 Vagrantfile \u4e2d\u52a0\u5165\u4e0b\u5217\u8a2d\u7f6e\u4f86\u66ff\u6211\u5011\u7684\u865b\u64ec\u6a5f\u547d\u540d\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" end \u91cd\u65b0\u555f\u52d5: $ vagrant up Bringing machine 'sre001' up with 'virtualbox' provider... ==> sre001: Importing base box 'ubuntu/focal64'... ==> sre001: Matching MAC address for NAT networking... ==> sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> sre001: Setting the name of the VM: vagrant_getting_started_sre001_1654228247885_34312 ==> sre001: Fixed port collision for 22 => 2222. Now on port 2201. ==> sre001: Clearing any previously set network interfaces... ==> sre001: Preparing network interfaces based on configuration... sre001: Adapter 1: nat ==> sre001: Forwarding ports... sre001: 22 (guest) => 2201 (host) (adapter 1) ==> sre001: Running 'pre-boot' VM customizations... ==> sre001: Booting VM... ==> sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127.0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key sre001: sre001: Vagrant insecure key detected. Vagrant will automatically replace sre001: this with a newly generated keypair for better security. sre001: sre001: Inserting generated public key within guest... sre001: Removing insecure key from the guest if it's present... sre001: Key inserted! Disconnecting and reconnecting using new SSH key... ==> sre001: Machine booted and ready! ==> sre001: Checking for guest additions in VM... ==> sre001: Mounting shared folders... sre001: /vagrant => /home/dxlab/opt/vagrant_getting_started \u518d\u6aa2\u67e5\u4e00\u6b21\u865b\u64ec\u6a5f\u904b\u884c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: sre001 running (virtualbox) \u6b63\u5982\u6211\u5011\u9810\u671f\u7684\uff0c\u865b\u64ec\u6a5f\u6709\u81ea\u5df1\u7684\u540d\u5b57\u5566\uff01 \u53d6\u5f97\u52d5\u614b IP (DHCP) \u00b6 \u5982\u679c\u60f3\u8981\u8b93 Vagrnt \u7684\u865b\u64ec\u6a5f\u6709\u53ef\u88ab\u5916\u90e8\u9023\u63a5\u7684\u7368\u7acb IP\uff0c\u5728 Vagrantfile \u589e\u52a0\u8a2d\u5b9a: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"private_network\" , type : \"dhcp\" end \u66ab\u505c\u6a5f\u5668 (Suspend) \u00b6 \u66ab\u505c\u865b\u64ec\u6a5f\u5c07\u505c\u6b62\u5b83\u4e26\u4fdd\u5b58\u5176\u7576\u524d\u904b\u884c\u72c0\u614b\u3002\u73fe\u5728\u8b93\u6211\u5011\u66ab\u505c\u6a5f\u5668\u3002 $ vagrant suspend ==> default: Saving VM state and suspending execution... \u7576\u4f60\u9700\u8981\u518d\u6b21\u958b\u59cb\u5de5\u4f5c\u6642\uff0c\u8acb\u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f\uff0c\u5b83\u7684\u72c0\u614b\u5c07\u5f9e\u4f60\u505c\u6b62\u7684\u5730\u65b9\u6062\u5fa9\u3002\u518d\u6b21\u555f\u52d5\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u66ab\u505c\u6a5f\u5668\u65e8\u5728\u5feb\u901f\u505c\u6b62\u548c\u958b\u59cb\u5de5\u4f5c\u3002\u7f3a\u9ede\u662f\u865b\u64ec\u6a5f\u5728\u639b\u8d77\u6642\u4ecd\u6703\u4f7f\u7528\u78c1\u76e4\u7a7a\u9593\uff0c\u4e26\u4e14\u9700\u8981\u984d\u5916\u7684\u78c1\u76e4\u7a7a\u9593\u4f86\u5b58\u5132\u865b\u64ec\u6a5f RAM \u7684\u72c0\u614b\u3002 \u505c\u6b62\u6a5f\u5668 (Halt) \u00b6 \u505c\u6b62\u865b\u64ec\u6a5f\u5c07\u6b63\u5e38\u7684\u6d41\u7a0b\u4f86\u95dc\u9589\u4f86\u8cd3\u64cd\u4f5c\u7cfb\u7d71\u4e26\u95dc\u9589\u4f86\u8cd3\u8a08\u7b97\u6a5f\u3002\u7acb\u5373\u505c\u6b62\u60a8\u7684\u6a5f\u5668\u3002 $ vagrant halt ==> default: Attempting graceful shutdown of VM... \u505c\u6b62\u60a8\u7684\u6a5f\u5668\u5c07\u4e7e\u6de8\u5730\u95dc\u9589\u5b83\uff0c\u4fdd\u7559\u78c1\u76e4\u7684\u5167\u5bb9\u4e26\u5141\u8a31\u4f60\u4e7e\u6de8\u5730\u518d\u6b21\u555f\u52d5\u5b83\u3002\u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u505c\u6b62\u7684\u5ba2\u6236\u6a5f\u5c07\u9700\u8981\u66f4\u591a\u6642\u9593\u624d\u80fd\u5f9e\u51b7\u555f\u52d5\u958b\u59cb\uff0c\u4e26\u4e14\u4ecd\u6703\u4f54\u7528\u78c1\u76e4\u7a7a\u9593\u3002 \u92b7\u9664\u6a5f\u5668 VM \u00b6 \u56de\u5230\u4e3b\u6a5f\u5f8c\uff0c\u505c\u6b62 Vagrant \u7ba1\u7406\u7684\u6a5f\u5668\u4e26\u522a\u9664\u5728\u6a5f\u5668\u5275\u5efa\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u6309\u201c\u662f\u201d\u78ba\u8a8d\u3002 $ vagrant destroy default: Are you sure you want to destroy the 'default' VM? [y/N] y ==> default: Forcing shutdown of VM... ==> default: Destroying VM and associated drives... \u79fb\u9664 VM box \u93e1\u50cf \u00b6 vagrant destroy \u547d\u4ee4\u4e0d\u6703\u522a\u9664\u4e0b\u8f09\u7684 VM box \u93e1\u50cf\u3002 \u5217\u51fa\u4f60\u7684 VM box \u4e0b\u8f09\u93e1\u50cf\u6587\u4ef6\u3002 $ vagrant box list ubuntu/focal64 (virtualbox, 20220523.0.0) \u4f7f\u7528 remove \u5b50\u547d\u4ee4\u522a\u9664 VM box \u93e1\u50cf\u6587\u4ef6\uff0c\u63d0\u4f9b VM box \u93e1\u50cf\u7684\u540d\u7a31\u3002 vagrant box remove ubuntu/focal64 Removing box 'ubuntu/focal64' (v20220523.0.0) with provider 'virtualbox'... \u7d50\u8ad6 \u00b6 \u4f60\u5df2\u7d93\u6210\u529f\u5730\u5275\u5efa\u4e86\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e26\u8207\u4e4b\u4e92\u52d5\uff01","title":"Vagrant \u5feb\u901f\u5165\u9580"},{"location":"ansible/vagrant-intro/#vagrant","text":"\u7531\u65bc\u5728 DevOps \u7684\u5be6\u52d9\u64cd\u4f5c\u4e0a\u6211\u5011\u5e38\u5e38\u6703\u540c\u6642\u64cd\u4f5c\u591a\u53f0\u6a5f\u5668\uff0c\u6240\u4ee5\u5728\u6b63\u5f0f\u9032\u5165\u63a5\u4e0b\u4f86\u7684\u8ab2\u7a0b\u524d\uff0c\u6211\u60f3\u8981\u5148\u82b1\u4e00\u9ede\u7bc7\u5e45\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Vagrant \u4f86\u6a21\u64ec\u6211\u5011\u7684\u5b78\u7fd2\u74b0\u5883\u3002","title":"\u4f7f\u7528 Vagrant \u6a21\u64ec\u74b0\u5883"},{"location":"ansible/vagrant-intro/#vagrant_1","text":"\u5728\u90e8\u7f72\u8edf\u9ad4\u670d\u52d9\u7684\u968e\u6bb5\uff0c\u958b\u767c\u4eba\u54e1\u5e38\u5e38\u6703\u5229\u7528\u865b\u64ec\u4e3b\u6a5f\u4f86\u6a21\u64ec\u53ca\u914d\u7f6e\u958b\u767c\u74b0\u5883\u3002Vagrant \u5c31\u662f\u57fa\u65bc\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u500b\u670d\u52d9\u3002\u8207\u50b3\u7d71\u4f7f\u7528 VirtualBox \u900f\u904e\u5716\u5f62\u4f7f\u7528\u8005\u4ecb\u9762 (Graphical User Interface, GUI) \u64cd\u4f5c\u865b\u64ec\u4e3b\u6a5f\u6709\u4e00\u9ede\u4e0d\u540c\u7684\u662f\uff0cVagrant \u4e3b\u8981\u662f\u4f7f\u7528\u547d\u4ee4\u5217\u4ecb\u9762 (command-line interface, CLI) \u4f86\u8207\u865b\u64ec\u4e3b\u6a5f\u505a\u6e9d\u901a\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u5c07\u6703\u904b\u7528\u5927\u91cf\u7684\u547d\u4ee4\u5217\u4f86\u9032\u884c\u64cd\u4f5c\u3002","title":"Vagrant \u662f\u4ec0\u9ebc\uff1f"},{"location":"ansible/vagrant-intro/#vagrant_2","text":"","title":"Vagrant \u53ca\u76f8\u95dc\u8edf\u9ad4\u5b89\u88dd"},{"location":"ansible/vagrant-intro/#vagrant_3","text":"Ubuntu/Debian CentOS/RHEL curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add - sudo apt-add-repository \"deb [arch=amd64] https://apt.releases.hashicorp.com $( lsb_release -cs ) main\" sudo apt-get update && sudo apt-get install vagrant sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo sudo yum -y install vagrant \u5176\u5b83\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u624b\u6cd5\u8acb\u53c3\u95b1: https://www.vagrantup.com/downloads","title":"\u5b89\u88dd Vagrant"},{"location":"ansible/vagrant-intro/#_1","text":"\u5b89\u88dd Vagrant \u5f8c\uff0c\u901a\u904e\u6253\u958b\u65b0\u7684\u547d\u4ee4\u63d0\u793a\u7b26\u6216\u63a7\u5236\u53f0\u4f86\u9a57\u8b49\u5b89\u88dd\u662f\u5426\u6b63\u5e38\uff0c\u4e26\u6aa2\u67e5 vagrant \u662f\u5426\u53ef\u7528\u3002 $ vagrant Usage: vagrant [options] <command> [<args>] -v, --version Print the version and exit. -h, --help Print this help. # ...","title":"\u9a57\u8b49\u5b89\u88dd"},{"location":"ansible/vagrant-intro/#virtualbox","text":"Vagrant \u652f\u6301\u4e0d\u540c\u7684\u865b\u64ec\u5316\u7522\u54c1\uff0c\u4f8b\u5982\uff1b VirtualBox\u3001VMware Fusion \u6216 Hyper-V\u3002\u5728\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528 VirtualBox \u4f86\u8b93\u5b78\u54e1\u7df4\u7fd2\u3002 \u8acb\u6839\u64da VirtualBox \u5b98\u7db2\u4e0a\u7684\u6307\u793a\u4f86\u9032\u884c\u5b89\u88dd: https://www.virtualbox.org/wiki/Downloads","title":"\u5b89\u88dd VirtualBox"},{"location":"ansible/vagrant-intro/#_2","text":"","title":"\u5275\u5efa\u4e00\u53f0\u865b\u64ec\u6a5f"},{"location":"ansible/vagrant-intro/#_3","text":"\u914d\u7f6e\u4efb\u4f55 Vagrant \u5c08\u6848\u7684\u7b2c\u4e00\u6b65\u662f\u5275\u5efa\u4e00\u500b Vagrantfile \u3002 Vagrantfile \u5141\u8a31\u4f60\uff1a \u6a19\u8a18 project \u7684\u6839\u76ee\u9304\u3002 Vagrant \u4e2d\u7684\u8a31\u591a\u914d\u7f6e\u9078\u9805\u90fd\u662f\u76f8\u5c0d\u65bc\u9019\u500b\u6839\u76ee\u9304\u7684\u3002 \u63cf\u8ff0\u904b\u884c\u5c08\u6848\u6240\u9700\u7684 VM \u548c\u8cc7\u6e90\u985e\u578b\uff0c\u4ee5\u53ca\u8981\u5b89\u88dd\u7684\u8edf\u4ef6\u4ee5\u53ca\u4f60\u5e0c\u671b\u5982\u4f55\u8a2a\u554f\u5b83\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_getting_started $ cd vagrant_getting_started","title":"\u5275\u5efa\u4e00\u500b\u76ee\u9304"},{"location":"ansible/vagrant-intro/#_4","text":"Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a hashcorp/bionic64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" end","title":"\u521d\u59cb\u5316\u5c08\u6848"},{"location":"ansible/vagrant-intro/#vm","text":"\u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220523.0.0' is up to date... ==> default: A newer version of the box 'ubuntu/focal64' for provider 'virtualbox' is ==> default: available! You currently have version '20220523.0.0'. The latest is version ==> default: '20220530.0.0'. Run `vagrant box update` to update. ==> default: Setting the name of the VM: vagrant_getting_started_default_1654224585969_14799 ==> default: Fixed port collision for 22 => 2222. Now on port 2201. ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat ==> default: Forwarding ports... default: 22 (guest) => 2201 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_getting_started","title":"\u555f\u52d5\u865b\u64ec\u6a5f VM"},{"location":"ansible/vagrant-intro/#ssh","text":"Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Fri Jun 3 02:52:55 UTC 2022 System load: 0.12 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 20% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed","title":"SSH\u9032\u5165\u865b\u64ec\u6a5f"},{"location":"ansible/vagrant-intro/#_5","text":"\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u767c\u73fe\u96d6\u7136\u865b\u64ec\u6a5f\u5df2\u7d93\u6210\u529f\u904b\u884c\uff0c\u4f46\u4e3b\u6a5f\u540d\u7a31\u986f\u793a\u70ba default \u3002\u9019\u7a2e\u6a21\u7cca\u7684\u540d\u7a31\u5728\u7ba1\u7406\u4e3b\u6a5f\u6578\u91cf\u591a\u8d77\u4f86\u5f8c\u5e38\u5e38\u6703\u9020\u6210\u958b\u767c\u8005\u7684\u56f0\u64fe\u3002\u70ba\u4e86\u907f\u514d\u6df7\u6dc6\uff0c\u6211\u5011\u53ef\u4ee5\u5148\u7528 vagrant halt \u5c07\u76ee\u524d\u7684\u865b\u64ec\u6a5f\u66ab\u505c\u6216\u662f\u4f7f\u7528 vagrant destroy \u76f4\u63a5\u6467\u6bc0 (destroy)\u3002\u63a5\u4e0b\u4f86\uff0c\u5728 Vagrantfile \u4e2d\u52a0\u5165\u4e0b\u5217\u8a2d\u7f6e\u4f86\u66ff\u6211\u5011\u7684\u865b\u64ec\u6a5f\u547d\u540d\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" end \u91cd\u65b0\u555f\u52d5: $ vagrant up Bringing machine 'sre001' up with 'virtualbox' provider... ==> sre001: Importing base box 'ubuntu/focal64'... ==> sre001: Matching MAC address for NAT networking... ==> sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> sre001: Setting the name of the VM: vagrant_getting_started_sre001_1654228247885_34312 ==> sre001: Fixed port collision for 22 => 2222. Now on port 2201. ==> sre001: Clearing any previously set network interfaces... ==> sre001: Preparing network interfaces based on configuration... sre001: Adapter 1: nat ==> sre001: Forwarding ports... sre001: 22 (guest) => 2201 (host) (adapter 1) ==> sre001: Running 'pre-boot' VM customizations... ==> sre001: Booting VM... ==> sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127.0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key sre001: sre001: Vagrant insecure key detected. Vagrant will automatically replace sre001: this with a newly generated keypair for better security. sre001: sre001: Inserting generated public key within guest... sre001: Removing insecure key from the guest if it's present... sre001: Key inserted! Disconnecting and reconnecting using new SSH key... ==> sre001: Machine booted and ready! ==> sre001: Checking for guest additions in VM... ==> sre001: Mounting shared folders... sre001: /vagrant => /home/dxlab/opt/vagrant_getting_started \u518d\u6aa2\u67e5\u4e00\u6b21\u865b\u64ec\u6a5f\u904b\u884c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: sre001 running (virtualbox) \u6b63\u5982\u6211\u5011\u9810\u671f\u7684\uff0c\u865b\u64ec\u6a5f\u6709\u81ea\u5df1\u7684\u540d\u5b57\u5566\uff01","title":"\u6aa2\u67e5\u6a5f\u5668\u72c0\u614b"},{"location":"ansible/vagrant-intro/#ip-dhcp","text":"\u5982\u679c\u60f3\u8981\u8b93 Vagrnt \u7684\u865b\u64ec\u6a5f\u6709\u53ef\u88ab\u5916\u90e8\u9023\u63a5\u7684\u7368\u7acb IP\uff0c\u5728 Vagrantfile \u589e\u52a0\u8a2d\u5b9a: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"private_network\" , type : \"dhcp\" end","title":"\u53d6\u5f97\u52d5\u614b IP (DHCP)"},{"location":"ansible/vagrant-intro/#suspend","text":"\u66ab\u505c\u865b\u64ec\u6a5f\u5c07\u505c\u6b62\u5b83\u4e26\u4fdd\u5b58\u5176\u7576\u524d\u904b\u884c\u72c0\u614b\u3002\u73fe\u5728\u8b93\u6211\u5011\u66ab\u505c\u6a5f\u5668\u3002 $ vagrant suspend ==> default: Saving VM state and suspending execution... \u7576\u4f60\u9700\u8981\u518d\u6b21\u958b\u59cb\u5de5\u4f5c\u6642\uff0c\u8acb\u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f\uff0c\u5b83\u7684\u72c0\u614b\u5c07\u5f9e\u4f60\u505c\u6b62\u7684\u5730\u65b9\u6062\u5fa9\u3002\u518d\u6b21\u555f\u52d5\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u66ab\u505c\u6a5f\u5668\u65e8\u5728\u5feb\u901f\u505c\u6b62\u548c\u958b\u59cb\u5de5\u4f5c\u3002\u7f3a\u9ede\u662f\u865b\u64ec\u6a5f\u5728\u639b\u8d77\u6642\u4ecd\u6703\u4f7f\u7528\u78c1\u76e4\u7a7a\u9593\uff0c\u4e26\u4e14\u9700\u8981\u984d\u5916\u7684\u78c1\u76e4\u7a7a\u9593\u4f86\u5b58\u5132\u865b\u64ec\u6a5f RAM \u7684\u72c0\u614b\u3002","title":"\u66ab\u505c\u6a5f\u5668 (Suspend)"},{"location":"ansible/vagrant-intro/#halt","text":"\u505c\u6b62\u865b\u64ec\u6a5f\u5c07\u6b63\u5e38\u7684\u6d41\u7a0b\u4f86\u95dc\u9589\u4f86\u8cd3\u64cd\u4f5c\u7cfb\u7d71\u4e26\u95dc\u9589\u4f86\u8cd3\u8a08\u7b97\u6a5f\u3002\u7acb\u5373\u505c\u6b62\u60a8\u7684\u6a5f\u5668\u3002 $ vagrant halt ==> default: Attempting graceful shutdown of VM... \u505c\u6b62\u60a8\u7684\u6a5f\u5668\u5c07\u4e7e\u6de8\u5730\u95dc\u9589\u5b83\uff0c\u4fdd\u7559\u78c1\u76e4\u7684\u5167\u5bb9\u4e26\u5141\u8a31\u4f60\u4e7e\u6de8\u5730\u518d\u6b21\u555f\u52d5\u5b83\u3002\u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u505c\u6b62\u7684\u5ba2\u6236\u6a5f\u5c07\u9700\u8981\u66f4\u591a\u6642\u9593\u624d\u80fd\u5f9e\u51b7\u555f\u52d5\u958b\u59cb\uff0c\u4e26\u4e14\u4ecd\u6703\u4f54\u7528\u78c1\u76e4\u7a7a\u9593\u3002","title":"\u505c\u6b62\u6a5f\u5668 (Halt)"},{"location":"ansible/vagrant-intro/#vm_1","text":"\u56de\u5230\u4e3b\u6a5f\u5f8c\uff0c\u505c\u6b62 Vagrant \u7ba1\u7406\u7684\u6a5f\u5668\u4e26\u522a\u9664\u5728\u6a5f\u5668\u5275\u5efa\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u6309\u201c\u662f\u201d\u78ba\u8a8d\u3002 $ vagrant destroy default: Are you sure you want to destroy the 'default' VM? [y/N] y ==> default: Forcing shutdown of VM... ==> default: Destroying VM and associated drives...","title":"\u92b7\u9664\u6a5f\u5668 VM"},{"location":"ansible/vagrant-intro/#vm-box","text":"vagrant destroy \u547d\u4ee4\u4e0d\u6703\u522a\u9664\u4e0b\u8f09\u7684 VM box \u93e1\u50cf\u3002 \u5217\u51fa\u4f60\u7684 VM box \u4e0b\u8f09\u93e1\u50cf\u6587\u4ef6\u3002 $ vagrant box list ubuntu/focal64 (virtualbox, 20220523.0.0) \u4f7f\u7528 remove \u5b50\u547d\u4ee4\u522a\u9664 VM box \u93e1\u50cf\u6587\u4ef6\uff0c\u63d0\u4f9b VM box \u93e1\u50cf\u7684\u540d\u7a31\u3002 vagrant box remove ubuntu/focal64 Removing box 'ubuntu/focal64' (v20220523.0.0) with provider 'virtualbox'...","title":"\u79fb\u9664 VM box \u93e1\u50cf"},{"location":"ansible/vagrant-intro/#_6","text":"\u4f60\u5df2\u7d93\u6210\u529f\u5730\u5275\u5efa\u4e86\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e26\u8207\u4e4b\u4e92\u52d5\uff01","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial/ansible-install-docker/","text":"\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u00b6 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-20-04 \u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u7684\u4e00\u6b21\u6027\u6027\u8cea\uff0c\u670d\u52d9\u5668\u81ea\u52d5\u5316\u73fe\u5728\u5728\u7cfb\u7d71\u7ba1\u7406\u4e2d\u767c\u63ee\u8457\u91cd\u8981\u4f5c\u7528\u3002 Ansible \u7b49\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u901a\u5e38\u7528\u65bc\u901a\u904e\u70ba\u65b0\u670d\u52d9\u5668\u5efa\u7acb\u6a19\u6e96\u7a0b\u5e8f\u4f86\u7c21\u5316\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u904e\u7a0b\uff0c\u540c\u6642\u6e1b\u5c11\u8207\u624b\u52d5\u8a2d\u7f6e\u76f8\u95dc\u7684\u4eba\u70ba\u932f\u8aa4\u3002 Ansible \u63d0\u4f9b\u4e86\u4e00\u500b\u7c21\u55ae\u7684\u67b6\u69cb\uff0c\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\u3002\u5b83\u9084\u63d0\u4f9b\u4e86\u4e00\u7d44\u5f37\u5927\u7684\u529f\u80fd\u548c\u5167\u7f6e\u6a21\u584a\uff0c\u6709\u52a9\u65bc\u7de8\u5beb\u81ea\u52d5\u5316\u8173\u672c\u3002 \u672c\u6559\u7a0b\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u57f7\u884c\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u7684\u6307\u5357\u4e2d\u5305\u542b\u7684\u6b65\u9a5f\u3002 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u7ba1\u7406\u5bb9\u5668\u7684\u904e\u7a0b\uff0c\u9019\u4e9b\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u7684\u884c\u70ba\u65b9\u5f0f\u8207\u865b\u64ec\u6a5f\u76f8\u4f3c\uff0c\u4f46\u66f4\u4fbf\u651c\u3001\u5c0d\u8cc7\u6e90\u66f4\u53cb\u597d\uff0c\u4e26\u4e14\u5c0d\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u7684\u4f9d\u8cf4\u7a0b\u5ea6\u66f4\u9ad8\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u70ba\u4e86\u57f7\u884c\u672c\u6307\u5357\u4e2d\u7684\u5287\u672c\u63d0\u4f9b\u7684\u81ea\u52d5\u8a2d\u7f6e\uff0c\u4f60\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede \uff1a\u4e00\u53f0\u5b89\u88dd\u4e86 Ansible \u4e26\u914d\u7f6e\u70ba\u4f7f\u7528 SSH \u5bc6\u9470\u9023\u63a5\u5230 Ansible \u4e3b\u6a5f\u7684 Ubuntu 20.04 \u6a5f\u5668\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u6709\u4e00\u500b\u5177\u6709 sudo \u6b0a\u9650\u7684\u666e\u901a\u7528\u6236\u4e26\u555f\u7528\u4e86\u9632\u706b\u7246\uff0c\u5982\u6211\u5011\u7684 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u4e2d\u6240\u8ff0\u3002\u8981\u8a2d\u7f6e Ansible\uff0c\u8acb\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u9032\u884c\u64cd\u4f5c\u3002 \u4e00\u53f0\u6216\u591a\u53f0 Ansible \u4e3b\u6a5f \uff1a\u4e00\u53f0\u6216\u591a\u53f0\u9060\u7a0b Ubuntu 20.04 \u670d\u52d9\u5668\u4e4b\u524d\u5df2\u6309\u7167 \u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u81ea\u52d5\u5316\u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u6307\u5357 \u9032\u884c\u8a2d\u7f6e\u3002 \u9019\u500b Playbook \u6709\u4ec0\u9ebc\u4f5c\u7528\uff1f \u00b6 \u9019\u500b Ansible playbook \u63d0\u4f9b\u4e86\u4e00\u7a2e\u66ff\u4ee3\u65b9\u6cd5\u4f86\u624b\u52d5\u904b\u884c\u6211\u5011\u7684\u6307\u5357\u4e2d\u6982\u8ff0\u7684\u904e\u7a0b\uff0c\u8a72\u6307\u5357\u662f \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u3002\u8a2d\u7f6e\u4f60\u7684\u5287\u672c\u4e00\u6b21\uff0c\u7136\u5f8c\u5728\u6bcf\u6b21\u5b89\u88dd\u5f8c\u4f7f\u7528\u5b83\u3002 \u904b\u884c\u6b64 playbook \u5c07\u5728\u4f60\u7684 Ansible \u4e3b\u6a5f\u4e0a\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5b89\u88dd aptitude \uff0cAnsible \u9996\u9078\u5b83\u4f5c\u70ba apt \u5305\u7ba1\u7406\u5668\u7684\u66ff\u4ee3\u54c1\u3002 \u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u3002 \u5b89\u88dd Docker GPG APT \u5bc6\u9470\u3002 \u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 apt \u6e90\u9ede\u3002 \u5b89\u88dd Docker\u3002 \u901a\u904e pip \u5b89\u88dd Python Docker \u6a21\u584a\u3002 \u5f9e Docker Hub \u62c9\u53d6 default_container_image \u6307\u5b9a\u7684\u9ed8\u8a8d\u93e1\u50cf\u3002 \u5275\u5efa\u7531 container_count \u8b8a\u91cf\u5b9a\u7fa9\u7684\u5bb9\u5668\u6578\u91cf\uff0c\u6bcf\u500b\u5bb9\u5668\u4f7f\u7528 default_container_image \u5b9a\u7fa9\u7684\u93e1\u50cf\uff0c\u4e26\u5728\u6bcf\u500b\u65b0\u5bb9\u5668\u4e2d\u57f7\u884c default_container_command \u4e2d\u5b9a\u7fa9\u7684\u547d\u4ee4\u3002 \u4e00\u65e6 playbook \u5b8c\u6210\u904b\u884c\uff0c\u4f60\u5c07\u6839\u64da\u4f60\u5728\u914d\u7f6e\u8b8a\u91cf\u4e2d\u5b9a\u7fa9\u7684\u9078\u9805\u5275\u5efa\u8a31\u591a\u5bb9\u5668\u3002 \u9996\u5148\uff0c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u670d\u52d9\u5668\u4e0a\u767b\u9304\u555f\u7528 sudo \u7684\u7528\u6236\u3002 1. \u6e96\u5099\u4f60\u7684 Playbook \u00b6 playbook.yml \u6587\u4ef6\u662f\u5b9a\u7fa9\u6240\u6709 task \u7684\u5730\u65b9\u3002 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u4f46\u9996\u5148\uff0c\u4f7f\u7528\u4f60\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u5275\u5efa\u4f60\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u5c07\u6253\u958b\u4e00\u500b\u7a7a\u7684 YAML \u6587\u4ef6\u3002\u5728\u958b\u59cb\u5411\u4f60\u7684 playbook \u6dfb\u52a0\u4efb\u52d9\u4e4b\u524d\uff0c\u8acb\u5148\u6dfb\u52a0\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1 \u5e7e\u4e4e\u4f60\u9047\u5230\u7684\u6bcf\u4e00\u500b playbook \u90fd\u6703\u4ee5\u985e\u4f3c\u7684\u8072\u660e\u958b\u982d\u3002 hosts \u8072\u660e Ansible \u63a7\u5236\u7bc0\u9ede\u5c07\u4f7f\u7528\u6b64 playbook \u5b9a\u4f4d\u54ea\u4e9b\u670d\u52d9\u5668\u3002 become \u72c0\u614b\u662f\u5426\u6240\u6709\u547d\u4ee4\u90fd\u5c07\u4f7f\u7528\u5347\u7d1a\u7684 root \u6b0a\u9650\u5b8c\u6210\u3002 vars \u5141\u8a31\u4f60\u5c07\u6578\u64da\u5b58\u5132\u5728\u8b8a\u91cf\u4e2d\u3002\u5982\u679c\u4f60\u6c7a\u5b9a\u5c07\u4f86\u66f4\u6539\u9019\u4e9b\uff0c\u4f60\u53ea\u9700\u5728\u6587\u4ef6\u4e2d\u7de8\u8f2f\u9019\u4e9b\u55ae\u884c\u3002\u4ee5\u4e0b\u662f\u6bcf\u500b\u8b8a\u91cf\u7684\u7c21\u8981\u8aaa\u660e\uff1a container_count \uff1a\u8981\u5275\u5efa\u7684\u5bb9\u5668\u6578\u3002 default_container_name \uff1a\u9ed8\u8a8d\u5bb9\u5668\u540d\u7a31\u3002 default_container_image \uff1a\u5275\u5efa\u5bb9\u5668\u6642\u4f7f\u7528\u7684\u9ed8\u8a8d Docker \u6620\u50cf\u3002 default_container_command \uff1a\u5728\u65b0\u5bb9\u5668\u4e0a\u904b\u884c\u7684\u9ed8\u8a8d\u547d\u4ee4\u3002 2. \u5c07\u5b89\u88dd\u5957\u4ef6\u7684\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook \u00b6 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c Ansible \u5728 playbook \u4e2d\u6309\u7167\u5f9e\u4e0a\u5230\u4e0b\u7684\u9806\u5e8f\u540c\u6b65\u57f7\u884c\u4efb\u52d9 \u3002\u9019\u610f\u5473\u8457\u4efb\u52d9\u9806\u5e8f\u5f88\u91cd\u8981\uff0c\u4f60\u53ef\u4ee5\u653e\u5fc3\u5730\u5047\u8a2d\u4e00\u500b\u4efb\u52d9\u5c07\u5728\u4e0b\u4e00\u500b\u4efb\u52d9\u958b\u59cb\u4e4b\u524d\u5b8c\u6210\u57f7\u884c\u3002 \u6b64 playbook \u4e2d\u7684\u6240\u6709\u4efb\u52d9\u90fd\u53ef\u4ee5\u7368\u7acb\u5b58\u5728\uff0c\u4e26\u53ef\u5728\u4f60\u7684\u5176\u4ed6\u5287\u672c\u4e2d\u91cd\u8907\u4f7f\u7528\u3002 \u6dfb\u52a0\u5b89\u88dd aptitude \uff08\u8207 Linux \u5305\u7ba1\u7406\u5668\u4ea4\u4e92\u7684\u5de5\u5177\uff09\u548c\u5b89\u88dd\u6240\u9700\u7cfb\u7d71\u5305\u7684\u7b2c\u4e00\u500b\u4efb\u52d9\u3002 Ansible \u5c07\u78ba\u4fdd\u9019\u4e9b\u8edf\u4ef6\u5305\u59cb\u7d42\u5b89\u88dd\u5728\u4f60\u7684\u670d\u52d9\u5668\u4e0a\uff1a playbook.yml tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true \u5728\u9019\u88e1\uff0c\u4f60\u4f7f\u7528 apt Ansible \u5167\u7f6e\u6a21\u584a\u4f86\u6307\u5c0e Ansible \u5b89\u88dd\u4f60\u7684\u5957\u4ef6\u3002 Ansible \u4e2d\u7684\u6a21\u584a\u662f\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u5982\u679c aptitude \u4e0d\u53ef\u7528\uff0cAnsible \u6703\u5b89\u5168\u5730\u4f7f\u7528 apt \u4f86\u5b89\u88dd\u8edf\u4ef6\u5305\uff0c\u4f46 Ansible \u6b77\u4f86\u504f\u611b aptitude\u3002 \u4f60\u53ef\u4ee5\u6839\u64da\u81ea\u5df1\u7684\u559c\u597d\u6dfb\u52a0\u6216\u522a\u9664\u8edf\u4ef6\u5957\u4ef6\u3002\u9019\u5c07\u78ba\u4fdd\u6240\u6709\u8edf\u4ef6\u5957\u4ef6\u4e0d\u50c5\u5b58\u5728\uff0c\u800c\u4e14\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u4e26\u4e14\u5728\u8abf\u7528 apt \u66f4\u65b0\u5f8c\u5b8c\u6210\u3002 3. \u5c07 Docker \u5b89\u88dd\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook \u00b6 \u4f60\u7684\u4efb\u52d9\u5c07\u5f9e\u5b98\u65b9\u5b58\u5132\u5eab\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\u3002\u6dfb\u52a0 Docker GPG \u5bc6\u9470\u4ee5\u9a57\u8b49\u4e0b\u8f09\uff0c\u6dfb\u52a0\u5b98\u65b9\u5b58\u5132\u5eab\u4f5c\u70ba\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u4e26\u5c07\u5b89\u88dd Docker\u3002\u6b64\u5916\uff0c\u9084\u5c07\u5b89\u88dd Python \u7684 Docker \u6a21\u584a\uff1a playbook.yml - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker \u4f60\u6703\u770b\u5230 apt_key \u548c apt_repository \u5167\u7f6e Ansible \u6a21\u584a\u9996\u5148\u6307\u5411\u6b63\u78ba\u7684 URL\uff0c\u7136\u5f8c\u8ca0\u8cac\u78ba\u4fdd\u5b83\u5011\u5b58\u5728\u3002\u9019\u5141\u8a31\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\uff0c\u4ee5\u53ca\u4f7f\u7528 pip \u5b89\u88dd Python \u6a21\u584a\u3002 4. \u5c07 Docker \u6620\u50cf\u548c\u5bb9\u5668\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook \u00b6 Docker \u5bb9\u5668\u7684\u5be6\u969b\u5275\u5efa\u5f9e\u62c9\u53d6\u6240\u9700\u7684 Docker \u6620\u50cf\u958b\u59cb\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e9b\u93e1\u50cf\u4f86\u81ea\u5b98\u65b9\u7684 Docker Hub\u3002\u4f7f\u7528\u6b64\u6620\u50cf\uff0c\u5c07\u6839\u64da\u5287\u672c\u9802\u90e8\u8072\u660e\u7684\u8b8a\u91cf\u6240\u898f\u5b9a\u7684\u898f\u7bc4\u5275\u5efa\u5bb9\u5668\uff1a playbook.yml - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} docker_image \u7528\u65bc\u63d0\u53d6\u8981\u7528\u4f5c\u5bb9\u5668\u57fa\u790e\u7684 Docker \u6620\u50cf\u3002 docker_container \u5141\u8a31\u4f60\u6307\u5b9a\u4f60\u5275\u5efa\u7684\u5bb9\u5668\u7684\u7d30\u7bc0\uff0c\u4ee5\u53ca\u4f60\u60f3\u8981\u50b3\u905e\u5b83\u5011\u7684\u547d\u4ee4\u3002 with_sequence \u662f Ansible \u5275\u5efa\u5faa\u74b0\u7684\u65b9\u5f0f\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5c07\u6839\u64da\u4f60\u6307\u5b9a\u7684\u8a08\u6578\u5faa\u74b0\u5275\u5efa\u5bb9\u5668\u3002\u9019\u662f\u4e00\u500b\u57fa\u672c\u7684\u8a08\u6578\u5faa\u74b0\uff0c\u6240\u4ee5\u9019\u88e1\u7684 item \u8b8a\u91cf\u63d0\u4f9b\u4e86\u4e00\u500b\u4ee3\u8868\u7576\u524d\u5faa\u74b0\u8fed\u4ee3\u7684\u6578\u5b57\u3002\u9019\u500b\u6578\u5b57\u5728\u9019\u88e1\u7528\u4f86\u547d\u540d\u4f60\u7684\u5bb9\u5668\u3002 5. \u56de\u9867\u4f60\u7684\u5b8c\u6574 Playbook \u00b6 \u4f60\u7684 playbook \u61c9\u5927\u81f4\u5982\u4e0b\u6240\u793a\uff0c\u6839\u64da\u4f60\u7684\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u7565\u6709\u4e0d\u540c\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1d tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} \u96a8\u610f\u4fee\u6539\u6b64\u624b\u518a\u4ee5\u6700\u9069\u5408\u4f60\u81ea\u5df1\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u7684\u500b\u4eba\u9700\u6c42\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 docker_image \u6a21\u584a\u5c07\u6620\u50cf\u63a8\u9001\u5230 Docker Hub \u6216\u4f7f\u7528 docker_container \u6a21\u584a\u4f86\u8a2d\u7f6e\u5bb9\u5668\u7db2\u7d61\u3002 \u4e00\u65e6\u4f60\u5c0d\u4f60\u7684\u5287\u672c\u611f\u5230\u6eff\u610f\uff0c\u4f60\u53ef\u4ee5\u9000\u51fa\u4f60\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4fdd\u5b58\u3002 6. \u904b\u884c\u4f60\u7684 Playbook \u00b6 \u4f60\u73fe\u5728\u5df2\u6e96\u5099\u597d\u5728\u4e00\u53f0\u6216\u591a\u53f0\u670d\u52d9\u5668\u4e0a\u904b\u884c\u6b64 playbook\u3002\u5927\u591a\u6578\u5287\u672c\u9ed8\u8a8d\u914d\u7f6e\u70ba\u5728\u4f60\u5eab\u5b58\u4e2d\u7684\u6bcf\u53f0\u670d\u52d9\u5668\u4e0a\u57f7\u884c\uff0c\u4f46\u9019\u6b21\u4f60\u5c07\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\u3002 \u8981\u50c5\u5728 server1 \u4e0a\u57f7\u884c playbook\uff0c\u4ee5 sammy \u8eab\u4efd\u9023\u63a5\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible-playbook playbook.yml -l server1 -u sammy -l \u6a19\u8a8c\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\uff0c-u \u6a19\u8a8c\u6307\u5b9a\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u767b\u9304\u7684\u7528\u6236\u3002\u4f60\u6703\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a Output . . . changed: [server1] TASK [Create default containers] ***************************************************************************************************************** changed: [server1] => (item=1) changed: [server1] => (item=2) changed: [server1] => (item=3) changed: [server1] => (item=4) PLAY RECAP *************************************************************************************************************************************** server1 : ok=9 changed=8 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u9019\u8868\u660e\u4f60\u7684\u670d\u52d9\u5668\u8a2d\u7f6e\u5df2\u5b8c\u6210\uff01\u4f60\u7684\u8f38\u51fa\u4e0d\u5fc5\u5b8c\u5168\u76f8\u540c\uff0c\u4f46\u96f6\u6545\u969c\u5f88\u91cd\u8981\u3002 \u7576 playbook \u904b\u884c\u5b8c\u6210\u5f8c\uff0c\u901a\u904e SSH \u767b\u9304\u5230 Ansible \u63d0\u4f9b\u7684\u670d\u52d9\u5668\uff0c\u6aa2\u67e5\u5bb9\u5668\u662f\u5426\u5275\u5efa\u6210\u529f\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u767b\u9304\u9060\u7a0b\u670d\u52d9\u5668\uff1a ssh sammy@your_remote_server_ip vagrant ssh \u4e26\u5217\u51fa\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684 Docker \u5bb9\u5668\uff1a $ sudo docker ps -a \u4f60\u61c9\u8a72\u6703\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff1a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 9885b07bb59b ubuntu \"sleep 1d\" 3 minutes ago Created docker4 06d42806b828 ubuntu \"sleep 1d\" 3 minutes ago Created docker3 83a27e8fe4db ubuntu \"sleep 1d\" 3 minutes ago Created docker2 c6e52400d0c9 ubuntu \"sleep 1d\" 3 minutes ago Created docker1 \u9019\u610f\u5473\u8457 playbook \u4e2d\u5b9a\u7fa9\u7684\u5bb9\u5668\u5df2\u6210\u529f\u5275\u5efa\u3002\u7531\u65bc\u9019\u662f playbook \u4e2d\u7684\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\uff0c\u56e0\u6b64\u5b83\u9084\u78ba\u8a8d playbook \u5df2\u5728\u6b64\u670d\u52d9\u5668\u4e0a\u5b8c\u5168\u57f7\u884c\u3002 \u7d50\u8ad6 \u00b6 \u81ea\u52d5\u5316\u4f60\u7684\u57fa\u790e\u8a2d\u65bd\u8a2d\u7f6e\u4e0d\u50c5\u53ef\u4ee5\u7bc0\u7701\u4f60\u7684\u6642\u9593\uff0c\u800c\u4e14\u9084\u6709\u52a9\u65bc\u78ba\u4fdd\u4f60\u7684\u670d\u52d9\u5668\u9075\u5faa\u53ef\u6839\u64da\u4f60\u7684\u9700\u6c42\u9032\u884c\u5b9a\u5236\u7684\u6a19\u6e96\u914d\u7f6e\u3002\u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u7684\u5206\u4f48\u5f0f\u7279\u6027\u4ee5\u53ca\u4e0d\u540c\u66ab\u5b58\u74b0\u5883\u4e4b\u9593\u5c0d\u4e00\u81f4\u6027\u7684\u9700\u6c42\uff0c\u9019\u6a23\u7684\u81ea\u52d5\u5316\u5df2\u6210\u70ba\u8a31\u591a\u5718\u968a\u958b\u767c\u904e\u7a0b\u4e2d\u7684\u6838\u5fc3\u7d44\u4ef6\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u4f60\u6f14\u793a\u77ad\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u5316\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u904e\u7a0b\u3002\u56e0\u70ba\u6bcf\u500b\u4eba\u5728\u4f7f\u7528\u5bb9\u5668\u6642\u901a\u5e38\u6709\u4e0d\u540c\u7684\u9700\u6c42\uff0c\u6211\u5011\u9f13\u52f5\u4f60\u67e5\u770b\u5b98\u65b9 Ansible \u6587\u6a94\u4ee5\u7372\u53d6\u66f4\u591a\u4fe1\u606f\u548c docker_container Ansible \u6a21\u584a\u7684\u7528\u4f8b\u3002","title":"\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker"},{"location":"ansible/tutorial/ansible-install-docker/#ansible-ubuntu-2004-docker","text":"\u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-20-04 \u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u7684\u4e00\u6b21\u6027\u6027\u8cea\uff0c\u670d\u52d9\u5668\u81ea\u52d5\u5316\u73fe\u5728\u5728\u7cfb\u7d71\u7ba1\u7406\u4e2d\u767c\u63ee\u8457\u91cd\u8981\u4f5c\u7528\u3002 Ansible \u7b49\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u901a\u5e38\u7528\u65bc\u901a\u904e\u70ba\u65b0\u670d\u52d9\u5668\u5efa\u7acb\u6a19\u6e96\u7a0b\u5e8f\u4f86\u7c21\u5316\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u904e\u7a0b\uff0c\u540c\u6642\u6e1b\u5c11\u8207\u624b\u52d5\u8a2d\u7f6e\u76f8\u95dc\u7684\u4eba\u70ba\u932f\u8aa4\u3002 Ansible \u63d0\u4f9b\u4e86\u4e00\u500b\u7c21\u55ae\u7684\u67b6\u69cb\uff0c\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\u3002\u5b83\u9084\u63d0\u4f9b\u4e86\u4e00\u7d44\u5f37\u5927\u7684\u529f\u80fd\u548c\u5167\u7f6e\u6a21\u584a\uff0c\u6709\u52a9\u65bc\u7de8\u5beb\u81ea\u52d5\u5316\u8173\u672c\u3002 \u672c\u6559\u7a0b\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u57f7\u884c\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u7684\u6307\u5357\u4e2d\u5305\u542b\u7684\u6b65\u9a5f\u3002 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u7ba1\u7406\u5bb9\u5668\u7684\u904e\u7a0b\uff0c\u9019\u4e9b\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u7684\u884c\u70ba\u65b9\u5f0f\u8207\u865b\u64ec\u6a5f\u76f8\u4f3c\uff0c\u4f46\u66f4\u4fbf\u651c\u3001\u5c0d\u8cc7\u6e90\u66f4\u53cb\u597d\uff0c\u4e26\u4e14\u5c0d\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u7684\u4f9d\u8cf4\u7a0b\u5ea6\u66f4\u9ad8\u3002","title":"\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker"},{"location":"ansible/tutorial/ansible-install-docker/#_1","text":"\u70ba\u4e86\u57f7\u884c\u672c\u6307\u5357\u4e2d\u7684\u5287\u672c\u63d0\u4f9b\u7684\u81ea\u52d5\u8a2d\u7f6e\uff0c\u4f60\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede \uff1a\u4e00\u53f0\u5b89\u88dd\u4e86 Ansible \u4e26\u914d\u7f6e\u70ba\u4f7f\u7528 SSH \u5bc6\u9470\u9023\u63a5\u5230 Ansible \u4e3b\u6a5f\u7684 Ubuntu 20.04 \u6a5f\u5668\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u6709\u4e00\u500b\u5177\u6709 sudo \u6b0a\u9650\u7684\u666e\u901a\u7528\u6236\u4e26\u555f\u7528\u4e86\u9632\u706b\u7246\uff0c\u5982\u6211\u5011\u7684 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u4e2d\u6240\u8ff0\u3002\u8981\u8a2d\u7f6e Ansible\uff0c\u8acb\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u9032\u884c\u64cd\u4f5c\u3002 \u4e00\u53f0\u6216\u591a\u53f0 Ansible \u4e3b\u6a5f \uff1a\u4e00\u53f0\u6216\u591a\u53f0\u9060\u7a0b Ubuntu 20.04 \u670d\u52d9\u5668\u4e4b\u524d\u5df2\u6309\u7167 \u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u81ea\u52d5\u5316\u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u6307\u5357 \u9032\u884c\u8a2d\u7f6e\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial/ansible-install-docker/#playbook","text":"\u9019\u500b Ansible playbook \u63d0\u4f9b\u4e86\u4e00\u7a2e\u66ff\u4ee3\u65b9\u6cd5\u4f86\u624b\u52d5\u904b\u884c\u6211\u5011\u7684\u6307\u5357\u4e2d\u6982\u8ff0\u7684\u904e\u7a0b\uff0c\u8a72\u6307\u5357\u662f \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u3002\u8a2d\u7f6e\u4f60\u7684\u5287\u672c\u4e00\u6b21\uff0c\u7136\u5f8c\u5728\u6bcf\u6b21\u5b89\u88dd\u5f8c\u4f7f\u7528\u5b83\u3002 \u904b\u884c\u6b64 playbook \u5c07\u5728\u4f60\u7684 Ansible \u4e3b\u6a5f\u4e0a\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5b89\u88dd aptitude \uff0cAnsible \u9996\u9078\u5b83\u4f5c\u70ba apt \u5305\u7ba1\u7406\u5668\u7684\u66ff\u4ee3\u54c1\u3002 \u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u3002 \u5b89\u88dd Docker GPG APT \u5bc6\u9470\u3002 \u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 apt \u6e90\u9ede\u3002 \u5b89\u88dd Docker\u3002 \u901a\u904e pip \u5b89\u88dd Python Docker \u6a21\u584a\u3002 \u5f9e Docker Hub \u62c9\u53d6 default_container_image \u6307\u5b9a\u7684\u9ed8\u8a8d\u93e1\u50cf\u3002 \u5275\u5efa\u7531 container_count \u8b8a\u91cf\u5b9a\u7fa9\u7684\u5bb9\u5668\u6578\u91cf\uff0c\u6bcf\u500b\u5bb9\u5668\u4f7f\u7528 default_container_image \u5b9a\u7fa9\u7684\u93e1\u50cf\uff0c\u4e26\u5728\u6bcf\u500b\u65b0\u5bb9\u5668\u4e2d\u57f7\u884c default_container_command \u4e2d\u5b9a\u7fa9\u7684\u547d\u4ee4\u3002 \u4e00\u65e6 playbook \u5b8c\u6210\u904b\u884c\uff0c\u4f60\u5c07\u6839\u64da\u4f60\u5728\u914d\u7f6e\u8b8a\u91cf\u4e2d\u5b9a\u7fa9\u7684\u9078\u9805\u5275\u5efa\u8a31\u591a\u5bb9\u5668\u3002 \u9996\u5148\uff0c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u670d\u52d9\u5668\u4e0a\u767b\u9304\u555f\u7528 sudo \u7684\u7528\u6236\u3002","title":"\u9019\u500b Playbook \u6709\u4ec0\u9ebc\u4f5c\u7528\uff1f"},{"location":"ansible/tutorial/ansible-install-docker/#1-playbook","text":"playbook.yml \u6587\u4ef6\u662f\u5b9a\u7fa9\u6240\u6709 task \u7684\u5730\u65b9\u3002 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u4f46\u9996\u5148\uff0c\u4f7f\u7528\u4f60\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u5275\u5efa\u4f60\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u5c07\u6253\u958b\u4e00\u500b\u7a7a\u7684 YAML \u6587\u4ef6\u3002\u5728\u958b\u59cb\u5411\u4f60\u7684 playbook \u6dfb\u52a0\u4efb\u52d9\u4e4b\u524d\uff0c\u8acb\u5148\u6dfb\u52a0\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1 \u5e7e\u4e4e\u4f60\u9047\u5230\u7684\u6bcf\u4e00\u500b playbook \u90fd\u6703\u4ee5\u985e\u4f3c\u7684\u8072\u660e\u958b\u982d\u3002 hosts \u8072\u660e Ansible \u63a7\u5236\u7bc0\u9ede\u5c07\u4f7f\u7528\u6b64 playbook \u5b9a\u4f4d\u54ea\u4e9b\u670d\u52d9\u5668\u3002 become \u72c0\u614b\u662f\u5426\u6240\u6709\u547d\u4ee4\u90fd\u5c07\u4f7f\u7528\u5347\u7d1a\u7684 root \u6b0a\u9650\u5b8c\u6210\u3002 vars \u5141\u8a31\u4f60\u5c07\u6578\u64da\u5b58\u5132\u5728\u8b8a\u91cf\u4e2d\u3002\u5982\u679c\u4f60\u6c7a\u5b9a\u5c07\u4f86\u66f4\u6539\u9019\u4e9b\uff0c\u4f60\u53ea\u9700\u5728\u6587\u4ef6\u4e2d\u7de8\u8f2f\u9019\u4e9b\u55ae\u884c\u3002\u4ee5\u4e0b\u662f\u6bcf\u500b\u8b8a\u91cf\u7684\u7c21\u8981\u8aaa\u660e\uff1a container_count \uff1a\u8981\u5275\u5efa\u7684\u5bb9\u5668\u6578\u3002 default_container_name \uff1a\u9ed8\u8a8d\u5bb9\u5668\u540d\u7a31\u3002 default_container_image \uff1a\u5275\u5efa\u5bb9\u5668\u6642\u4f7f\u7528\u7684\u9ed8\u8a8d Docker \u6620\u50cf\u3002 default_container_command \uff1a\u5728\u65b0\u5bb9\u5668\u4e0a\u904b\u884c\u7684\u9ed8\u8a8d\u547d\u4ee4\u3002","title":"1. \u6e96\u5099\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#2-playbook","text":"\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c Ansible \u5728 playbook \u4e2d\u6309\u7167\u5f9e\u4e0a\u5230\u4e0b\u7684\u9806\u5e8f\u540c\u6b65\u57f7\u884c\u4efb\u52d9 \u3002\u9019\u610f\u5473\u8457\u4efb\u52d9\u9806\u5e8f\u5f88\u91cd\u8981\uff0c\u4f60\u53ef\u4ee5\u653e\u5fc3\u5730\u5047\u8a2d\u4e00\u500b\u4efb\u52d9\u5c07\u5728\u4e0b\u4e00\u500b\u4efb\u52d9\u958b\u59cb\u4e4b\u524d\u5b8c\u6210\u57f7\u884c\u3002 \u6b64 playbook \u4e2d\u7684\u6240\u6709\u4efb\u52d9\u90fd\u53ef\u4ee5\u7368\u7acb\u5b58\u5728\uff0c\u4e26\u53ef\u5728\u4f60\u7684\u5176\u4ed6\u5287\u672c\u4e2d\u91cd\u8907\u4f7f\u7528\u3002 \u6dfb\u52a0\u5b89\u88dd aptitude \uff08\u8207 Linux \u5305\u7ba1\u7406\u5668\u4ea4\u4e92\u7684\u5de5\u5177\uff09\u548c\u5b89\u88dd\u6240\u9700\u7cfb\u7d71\u5305\u7684\u7b2c\u4e00\u500b\u4efb\u52d9\u3002 Ansible \u5c07\u78ba\u4fdd\u9019\u4e9b\u8edf\u4ef6\u5305\u59cb\u7d42\u5b89\u88dd\u5728\u4f60\u7684\u670d\u52d9\u5668\u4e0a\uff1a playbook.yml tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true \u5728\u9019\u88e1\uff0c\u4f60\u4f7f\u7528 apt Ansible \u5167\u7f6e\u6a21\u584a\u4f86\u6307\u5c0e Ansible \u5b89\u88dd\u4f60\u7684\u5957\u4ef6\u3002 Ansible \u4e2d\u7684\u6a21\u584a\u662f\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u5982\u679c aptitude \u4e0d\u53ef\u7528\uff0cAnsible \u6703\u5b89\u5168\u5730\u4f7f\u7528 apt \u4f86\u5b89\u88dd\u8edf\u4ef6\u5305\uff0c\u4f46 Ansible \u6b77\u4f86\u504f\u611b aptitude\u3002 \u4f60\u53ef\u4ee5\u6839\u64da\u81ea\u5df1\u7684\u559c\u597d\u6dfb\u52a0\u6216\u522a\u9664\u8edf\u4ef6\u5957\u4ef6\u3002\u9019\u5c07\u78ba\u4fdd\u6240\u6709\u8edf\u4ef6\u5957\u4ef6\u4e0d\u50c5\u5b58\u5728\uff0c\u800c\u4e14\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u4e26\u4e14\u5728\u8abf\u7528 apt \u66f4\u65b0\u5f8c\u5b8c\u6210\u3002","title":"2. \u5c07\u5b89\u88dd\u5957\u4ef6\u7684\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#3-docker-playbook","text":"\u4f60\u7684\u4efb\u52d9\u5c07\u5f9e\u5b98\u65b9\u5b58\u5132\u5eab\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\u3002\u6dfb\u52a0 Docker GPG \u5bc6\u9470\u4ee5\u9a57\u8b49\u4e0b\u8f09\uff0c\u6dfb\u52a0\u5b98\u65b9\u5b58\u5132\u5eab\u4f5c\u70ba\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u4e26\u5c07\u5b89\u88dd Docker\u3002\u6b64\u5916\uff0c\u9084\u5c07\u5b89\u88dd Python \u7684 Docker \u6a21\u584a\uff1a playbook.yml - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker \u4f60\u6703\u770b\u5230 apt_key \u548c apt_repository \u5167\u7f6e Ansible \u6a21\u584a\u9996\u5148\u6307\u5411\u6b63\u78ba\u7684 URL\uff0c\u7136\u5f8c\u8ca0\u8cac\u78ba\u4fdd\u5b83\u5011\u5b58\u5728\u3002\u9019\u5141\u8a31\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\uff0c\u4ee5\u53ca\u4f7f\u7528 pip \u5b89\u88dd Python \u6a21\u584a\u3002","title":"3. \u5c07 Docker \u5b89\u88dd\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#4-docker-playbook","text":"Docker \u5bb9\u5668\u7684\u5be6\u969b\u5275\u5efa\u5f9e\u62c9\u53d6\u6240\u9700\u7684 Docker \u6620\u50cf\u958b\u59cb\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e9b\u93e1\u50cf\u4f86\u81ea\u5b98\u65b9\u7684 Docker Hub\u3002\u4f7f\u7528\u6b64\u6620\u50cf\uff0c\u5c07\u6839\u64da\u5287\u672c\u9802\u90e8\u8072\u660e\u7684\u8b8a\u91cf\u6240\u898f\u5b9a\u7684\u898f\u7bc4\u5275\u5efa\u5bb9\u5668\uff1a playbook.yml - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} docker_image \u7528\u65bc\u63d0\u53d6\u8981\u7528\u4f5c\u5bb9\u5668\u57fa\u790e\u7684 Docker \u6620\u50cf\u3002 docker_container \u5141\u8a31\u4f60\u6307\u5b9a\u4f60\u5275\u5efa\u7684\u5bb9\u5668\u7684\u7d30\u7bc0\uff0c\u4ee5\u53ca\u4f60\u60f3\u8981\u50b3\u905e\u5b83\u5011\u7684\u547d\u4ee4\u3002 with_sequence \u662f Ansible \u5275\u5efa\u5faa\u74b0\u7684\u65b9\u5f0f\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5c07\u6839\u64da\u4f60\u6307\u5b9a\u7684\u8a08\u6578\u5faa\u74b0\u5275\u5efa\u5bb9\u5668\u3002\u9019\u662f\u4e00\u500b\u57fa\u672c\u7684\u8a08\u6578\u5faa\u74b0\uff0c\u6240\u4ee5\u9019\u88e1\u7684 item \u8b8a\u91cf\u63d0\u4f9b\u4e86\u4e00\u500b\u4ee3\u8868\u7576\u524d\u5faa\u74b0\u8fed\u4ee3\u7684\u6578\u5b57\u3002\u9019\u500b\u6578\u5b57\u5728\u9019\u88e1\u7528\u4f86\u547d\u540d\u4f60\u7684\u5bb9\u5668\u3002","title":"4. \u5c07 Docker \u6620\u50cf\u548c\u5bb9\u5668\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#5-playbook","text":"\u4f60\u7684 playbook \u61c9\u5927\u81f4\u5982\u4e0b\u6240\u793a\uff0c\u6839\u64da\u4f60\u7684\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u7565\u6709\u4e0d\u540c\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1d tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} \u96a8\u610f\u4fee\u6539\u6b64\u624b\u518a\u4ee5\u6700\u9069\u5408\u4f60\u81ea\u5df1\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u7684\u500b\u4eba\u9700\u6c42\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 docker_image \u6a21\u584a\u5c07\u6620\u50cf\u63a8\u9001\u5230 Docker Hub \u6216\u4f7f\u7528 docker_container \u6a21\u584a\u4f86\u8a2d\u7f6e\u5bb9\u5668\u7db2\u7d61\u3002 \u4e00\u65e6\u4f60\u5c0d\u4f60\u7684\u5287\u672c\u611f\u5230\u6eff\u610f\uff0c\u4f60\u53ef\u4ee5\u9000\u51fa\u4f60\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4fdd\u5b58\u3002","title":"5. \u56de\u9867\u4f60\u7684\u5b8c\u6574 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#6-playbook","text":"\u4f60\u73fe\u5728\u5df2\u6e96\u5099\u597d\u5728\u4e00\u53f0\u6216\u591a\u53f0\u670d\u52d9\u5668\u4e0a\u904b\u884c\u6b64 playbook\u3002\u5927\u591a\u6578\u5287\u672c\u9ed8\u8a8d\u914d\u7f6e\u70ba\u5728\u4f60\u5eab\u5b58\u4e2d\u7684\u6bcf\u53f0\u670d\u52d9\u5668\u4e0a\u57f7\u884c\uff0c\u4f46\u9019\u6b21\u4f60\u5c07\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\u3002 \u8981\u50c5\u5728 server1 \u4e0a\u57f7\u884c playbook\uff0c\u4ee5 sammy \u8eab\u4efd\u9023\u63a5\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible-playbook playbook.yml -l server1 -u sammy -l \u6a19\u8a8c\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\uff0c-u \u6a19\u8a8c\u6307\u5b9a\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u767b\u9304\u7684\u7528\u6236\u3002\u4f60\u6703\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a Output . . . changed: [server1] TASK [Create default containers] ***************************************************************************************************************** changed: [server1] => (item=1) changed: [server1] => (item=2) changed: [server1] => (item=3) changed: [server1] => (item=4) PLAY RECAP *************************************************************************************************************************************** server1 : ok=9 changed=8 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u9019\u8868\u660e\u4f60\u7684\u670d\u52d9\u5668\u8a2d\u7f6e\u5df2\u5b8c\u6210\uff01\u4f60\u7684\u8f38\u51fa\u4e0d\u5fc5\u5b8c\u5168\u76f8\u540c\uff0c\u4f46\u96f6\u6545\u969c\u5f88\u91cd\u8981\u3002 \u7576 playbook \u904b\u884c\u5b8c\u6210\u5f8c\uff0c\u901a\u904e SSH \u767b\u9304\u5230 Ansible \u63d0\u4f9b\u7684\u670d\u52d9\u5668\uff0c\u6aa2\u67e5\u5bb9\u5668\u662f\u5426\u5275\u5efa\u6210\u529f\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u767b\u9304\u9060\u7a0b\u670d\u52d9\u5668\uff1a ssh sammy@your_remote_server_ip vagrant ssh \u4e26\u5217\u51fa\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684 Docker \u5bb9\u5668\uff1a $ sudo docker ps -a \u4f60\u61c9\u8a72\u6703\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff1a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 9885b07bb59b ubuntu \"sleep 1d\" 3 minutes ago Created docker4 06d42806b828 ubuntu \"sleep 1d\" 3 minutes ago Created docker3 83a27e8fe4db ubuntu \"sleep 1d\" 3 minutes ago Created docker2 c6e52400d0c9 ubuntu \"sleep 1d\" 3 minutes ago Created docker1 \u9019\u610f\u5473\u8457 playbook \u4e2d\u5b9a\u7fa9\u7684\u5bb9\u5668\u5df2\u6210\u529f\u5275\u5efa\u3002\u7531\u65bc\u9019\u662f playbook \u4e2d\u7684\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\uff0c\u56e0\u6b64\u5b83\u9084\u78ba\u8a8d playbook \u5df2\u5728\u6b64\u670d\u52d9\u5668\u4e0a\u5b8c\u5168\u57f7\u884c\u3002","title":"6. \u904b\u884c\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#_2","text":"\u81ea\u52d5\u5316\u4f60\u7684\u57fa\u790e\u8a2d\u65bd\u8a2d\u7f6e\u4e0d\u50c5\u53ef\u4ee5\u7bc0\u7701\u4f60\u7684\u6642\u9593\uff0c\u800c\u4e14\u9084\u6709\u52a9\u65bc\u78ba\u4fdd\u4f60\u7684\u670d\u52d9\u5668\u9075\u5faa\u53ef\u6839\u64da\u4f60\u7684\u9700\u6c42\u9032\u884c\u5b9a\u5236\u7684\u6a19\u6e96\u914d\u7f6e\u3002\u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u7684\u5206\u4f48\u5f0f\u7279\u6027\u4ee5\u53ca\u4e0d\u540c\u66ab\u5b58\u74b0\u5883\u4e4b\u9593\u5c0d\u4e00\u81f4\u6027\u7684\u9700\u6c42\uff0c\u9019\u6a23\u7684\u81ea\u52d5\u5316\u5df2\u6210\u70ba\u8a31\u591a\u5718\u968a\u958b\u767c\u904e\u7a0b\u4e2d\u7684\u6838\u5fc3\u7d44\u4ef6\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u4f60\u6f14\u793a\u77ad\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u5316\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u904e\u7a0b\u3002\u56e0\u70ba\u6bcf\u500b\u4eba\u5728\u4f7f\u7528\u5bb9\u5668\u6642\u901a\u5e38\u6709\u4e0d\u540c\u7684\u9700\u6c42\uff0c\u6211\u5011\u9f13\u52f5\u4f60\u67e5\u770b\u5b98\u65b9 Ansible \u6587\u6a94\u4ee5\u7372\u53d6\u66f4\u591a\u4fe1\u606f\u548c docker_container Ansible \u6a21\u584a\u7684\u7528\u4f8b\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/","text":"\u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u00b6 \u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-22-04 \u914d\u7f6e\u7ba1\u7406\u7cfb\u7d71\u65e8\u5728\u70ba\u7ba1\u7406\u54e1\u548c\u904b\u71df\u5718\u968a\u7c21\u5316\u63a7\u5236\u5927\u91cf\u670d\u52d9\u5668\u7684\u904e\u7a0b\u3002\u5b83\u5011\u5141\u8a31\u60a8\u5f9e\u4e00\u500b\u4e2d\u592e\u4f4d\u7f6e\u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u63a7\u5236\u8a31\u591a\u4e0d\u540c\u7684\u7cfb\u7d71\u3002 \u96d6\u7136\u6709\u8a31\u591a\u6d41\u884c\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u53ef\u7528\u65bc Linux \u7cfb\u7d71\uff0c\u4f8b\u5982 Chef \u548c Puppet\uff0c\u4f46\u9019\u4e9b\u5de5\u5177\u901a\u5e38\u6bd4\u8a31\u591a\u4eba\u60f3\u8981\u6216\u9700\u8981\u7684\u8907\u96dc\u3002 Ansible \u662f\u9019\u4e9b\u9078\u9805\u7684\u7d55\u4f73\u66ff\u4ee3\u54c1\uff0c\u56e0\u70ba\u5b83\u63d0\u4f9b\u7684\u67b6\u69cb\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\uff0c\u4f7f\u7528 SSH \u4f86\u57f7\u884c\u81ea\u52d5\u5316\u4efb\u52d9\u4e26\u4f7f\u7528 YAML \u6587\u4ef6\u4f86\u5b9a\u7fa9\u914d\u7f6e\u7d30\u7bc0\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u8a0e\u8ad6\u5982\u4f55\u5728 Ubuntu 22.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd Ansible\uff0c\u4e26\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u8a72\u8edf\u4ef6\u7684\u4e00\u4e9b\u57fa\u790e\u77e5\u8b58\u3002\u6709\u95dc Ansible \u4f5c\u70ba\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u7684\u66f4\u9ad8\u7d1a\u6982\u8ff0\uff0c\u8acb\u53c3\u95b1 An Introduction to Configuration Management with Ansible \u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u8981\u9075\u5faa\u672c\u6559\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede\uff1aAnsible \u63a7\u5236\u7bc0\u9ede\u662f\u6211\u5011\u5c07\u7528\u4f86\u901a\u904e SSH \u9023\u63a5\u548c\u63a7\u5236 Ansible \u4e3b\u6a5f\u7684\u6a5f\u5668\u3002\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u53ef\u4ee5\u662f\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216\u5c08\u7528\u65bc\u904b\u884c Ansible \u7684\u670d\u52d9\u5668\uff0c\u4f46\u672c\u6307\u5357\u5047\u5b9a\u60a8\u7684\u63a7\u5236\u7bc0\u9ede\u662f Ubuntu 22.04 \u7cfb\u7d71\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u5177\u6709\uff1a \u5177\u6709 sudo \u6b0a\u9650\u7684\u975e root \u7528\u6236 \u3002\u8981\u9032\u884c\u6b64\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u7684 Ubuntu 22.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u7684\u7b2c 2 \u6b65\u548c\u7b2c 3 \u6b65\u9032\u884c\u64cd\u4f5c\u3002\u4f46\u662f\uff0c\u8acb\u6ce8\u610f\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u9060\u7a0b\u670d\u52d9\u5668\u4f5c\u70ba Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u5247\u61c9\u9075\u5faa\u672c\u6307\u5357\u7684\u6bcf\u500b\u6b65\u9a5f\u3002\u9019\u6a23\u505a\u5c07\u4f7f\u7528 ufw \u5728\u670d\u52d9\u5668\u4e0a\u914d\u7f6e\u9632\u706b\u7246\u4e26\u555f\u7528\u5c0d\u975e root \u7528\u6236\u914d\u7f6e\u6587\u4ef6\u7684\u5916\u90e8\u8a2a\u554f\uff0c\u9019\u5169\u8005\u90fd\u5c07\u6709\u52a9\u65bc\u4fdd\u6301\u9060\u7a0b\u670d\u52d9\u5668\u7684\u5b89\u5168\u3002 \u8207\u6b64\u7528\u6236\u95dc\u806f\u7684 SSH \u5bc6\u9470\u5c0d \u3002\u8981\u9032\u884c\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u8a2d\u7f6e SSH \u5bc6\u9470\u7684\u6307\u5357 \u7684\u7b2c 1 \u6b65\u9032\u884c\u64cd\u4f5c\u3002 Step 1 \u2014 Installing Ansible \u00b6 \u8981\u958b\u59cb\u4f7f\u7528 Ansible \u4f5c\u70ba\u7ba1\u7406\u670d\u52d9\u5668\u57fa\u790e\u67b6\u69cb\u7684\u4e00\u7a2e\u65b9\u5f0f\uff0c\u60a8\u9700\u8981\u5728\u5c07\u7528\u4f5c Ansible \u63a7\u5236\u7bc0\u9ede\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd Ansible \u8edf\u4ef6\u3002\u6211\u5011\u5c07\u70ba\u6b64\u4f7f\u7528\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5237\u65b0\u7cfb\u7d71\u7684\u5305\u7d22\u5f15\uff1a $ sudo apt update \u5728\u6b64\u66f4\u65b0\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5b89\u88dd Ansible \u8edf\u4ef6\uff1a $ sudo apt install ansible \u63d0\u793a\u78ba\u8a8d\u5b89\u88dd\u6642\u6309 Y \u3002\u5982\u679c\u7cfb\u7d71\u63d0\u793a\u60a8\u91cd\u65b0\u555f\u52d5\u4efb\u4f55\u670d\u52d9\uff0c\u8acb\u6309 ENTER \u63a5\u53d7\u9ed8\u8a8d\u8a2d\u7f6e\u4e26\u7e7c\u7e8c\u3002 \u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u73fe\u5728\u64c1\u6709\u7ba1\u7406\u4e3b\u6a5f\u6240\u9700\u200b\u200b\u7684\u6240\u6709\u8edf\u4ef6\u3002\u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\uff0c\u4ee5\u4fbf Ansible \u53ef\u4ee5\u8207\u60a8\u7684\u8a17\u7ba1\u7bc0\u9ede\u901a\u4fe1\u3002 Step 2 \u2014 Setting Up the Inventory File \u00b6 Inventory \u6e05\u55ae\u6587\u4ef6\u5305\u542b\u6709\u95dc\u60a8\u5c07\u4f7f\u7528 Ansible \u7ba1\u7406\u7684\u4e3b\u6a5f\u7684\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u5728 inventory \u6e05\u55ae\u6587\u4ef6\u4e2d\u5305\u542b\u5f9e\u4e00\u53f0\u5230\u6578\u767e\u53f0\u670d\u52d9\u5668\u7684\u4efb\u610f\u4f4d\u7f6e\uff0c\u4e26\u4e14\u53ef\u4ee5\u5c07\u4e3b\u6a5f\u7d44\u7e54\u6210\u7fa4\u7d44\u548c\u5b50\u7fa4\u7d44\u3002Inventory \u6e05\u55ae\u6587\u4ef6\u9084\u7d93\u5e38\u7528\u65bc\u8a2d\u7f6e\u50c5\u5c0d\u7279\u5b9a\u4e3b\u6a5f\u6216\u7d44\u6709\u6548\u7684\u8b8a\u91cf\uff0c\u4ee5\u4fbf\u5728\u5287\u672c\u548c\u6a21\u677f\u4e2d\u4f7f\u7528\u3002\u4e00\u4e9b\u8b8a\u91cf\u4e5f\u6703\u5f71\u97ff playbook \u7684\u904b\u884c\u65b9\u5f0f\uff0c\u4f8b\u5982\u6211\u5011\u7a0d\u5f8c\u6703\u770b\u5230\u7684 ansible_python_interpreter \u8b8a\u91cf\u3002 \u8981\u7de8\u8f2f\u9ed8\u8a8d Ansible \u7684 inventory \u6e05\u55ae\u7684\u5167\u5bb9\uff0c\u9996\u5148\u4f7f\u7528 mkdir \u547d\u4ee4\u5275\u5efa /etc/ansible \u76ee\u9304\u3002\u7136\u5f8c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u6587\u672c\u7de8\u8f2f\u5668\u6253\u958b /etc/ansible/hosts \u6587\u4ef6\uff1a $ sudo mkdir /etc/ansible $ sudo nano /etc/ansible/hosts Tip \u5118\u7ba1 Ansible \u901a\u5e38\u6703\u5728 etc/ansible/hosts \u4e2d\u5275\u5efa\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\uff0c\u4f46\u60a8\u53ef\u4ee5\u5728\u4efb\u4f55\u66f4\u9069\u5408\u60a8\u9700\u6c42\u7684\u4f4d\u7f6e\u81ea\u7531\u5275\u5efa\u6e05\u55ae\u6587\u4ef6\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u53c3\u6578\u63d0\u4f9b\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u7684\u8def\u5f91\u3002\u4f7f\u7528\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u6587\u4ef6\u662f\u4e00\u7a2e\u5f88\u597d\u7684\u505a\u6cd5\uff0c\u53ef\u4ee5\u6700\u5927\u7a0b\u5ea6\u5730\u964d\u4f4e\u5728\u932f\u8aa4\u7684\u670d\u52d9\u5668\u7d44\u4e0a\u904b\u884c\u5287\u672c\u7684\u98a8\u96aa\u3002 Ansible \u5b89\u88dd\u63d0\u4f9b\u7684\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u5305\u542b\u8a31\u591a\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5c07\u5b83\u5011\u7528\u4f5c\u8a2d\u7f6e\u6e05\u55ae\u7684\u53c3\u8003\u3002\u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba [servers] \u7684\u7d44\uff0c\u5176\u4e2d\u5305\u542b\u4e09\u500b\u4e0d\u540c\u7684\u670d\u52d9\u5668\uff0c\u6bcf\u500b\u670d\u52d9\u5668\u7531\u4e00\u500b\u81ea\u5b9a\u7fa9\u5225\u540d\u6a19\u8b58\uff1a server1 \u3001 server2 \u548c server3 \u3002\u8acb\u52d9\u5fc5\u5c07\u7a81\u51fa\u4e0b\u5217\u986f\u793a\u7684 IP \u66ff\u63db\u70ba\u4f60\u8981\u63a7\u5236\u7684 Ansible \u4e3b\u6a5f\u7684 IP \u5730\u5740\u3002 /etc/ansible/hosts [servers] server1 ansible_host=203.0.113.111 server2 ansible_host=203.0.113.112 server3 ansible_host=203.0.113.113 [all:vars] ansible_python_interpreter=/usr/bin/python3 all:vars \u5b50\u7fa4\u7d44\u8a2d\u7f6e ansible_python_interpreter \u4e3b\u6a5f\u53c3\u6578\uff0c\u8a72\u53c3\u6578\u5c07\u5c0d\u8a72\u6e05\u55ae\u4e2d\u5305\u542b\u7684\u6240\u6709\u4e3b\u6a5f\u6709\u6548\u3002\u6b64\u53c3\u6578\u78ba\u4fdd\u9060\u7a0b\u670d\u52d9\u5668\u4f7f\u7528 /usr/bin/python3 Python 3 \u53ef\u57f7\u884c\u6587\u4ef6\uff0c\u800c\u4e0d\u662f /usr/bin/python (Python 2.7)\uff0c\u9019\u5728\u6700\u8fd1\u7684 Ubuntu \u7248\u672c\u4e2d\u4e0d\u5b58\u5728\u3002 \u5b8c\u6210\u5f8c\uff0c\u6309 CTRL+X \u7136\u5f8c\u6309 Y \u548c ENTER \u78ba\u8a8d\u66f4\u6539\uff0c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002 \u6bcf\u7576\u60a8\u60f3\u6aa2\u67e5\u5eab\u5b58\u6642\uff0c\u90fd\u53ef\u4ee5\u904b\u884c\uff1a $ ansible-inventory --list -y \u60a8\u5c07\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff0c\u4f46\u5305\u542b\u60a8\u81ea\u5df1\u7684\u670d\u52d9\u5668\u57fa\u790e\u8a2d\u65bd\uff0c\u5982\u6e05\u55ae\u6587\u4ef6\u4e2d\u6240\u5b9a\u7fa9\uff1a all : children : servers : hosts : server1 : ansible_host : 203.0.113.111 ansible_python_interpreter : /usr/bin/python3 server2 : ansible_host : 203.0.113.112 ansible_python_interpreter : /usr/bin/python3 server3 : ansible_host : 203.0.113.113 ansible_python_interpreter : /usr/bin/python3 ungrouped : {} \u73fe\u5728\u60a8\u5df2\u7d93\u914d\u7f6e\u4e86\u6e05\u55ae\u6587\u4ef6\uff0c\u60a8\u64c1\u6709\u6e2c\u8a66\u8207 Ansible \u4e3b\u6a5f\u7684\u9023\u63a5\u6240\u9700\u7684\u4e00\u5207\u3002 Step 3 \u2014 Testing Connection \u00b6 \u5728\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\u4ee5\u5305\u542b\u60a8\u7684\u670d\u52d9\u5668\u4e4b\u5f8c\uff0c\u662f\u6642\u5019\u6aa2\u67e5 Ansible \u662f\u5426\u80fd\u5920\u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\u4e26\u901a\u904e SSH \u904b\u884c\u547d\u4ee4\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ubuntu root \u5e33\u6236\uff0c\u56e0\u70ba\u9019\u901a\u5e38\u662f\u65b0\u5275\u5efa\u7684\u670d\u52d9\u5668\u4e0a\u9ed8\u8a8d\u53ef\u7528\u7684\u552f\u4e00\u5e33\u6236\u3002\u5982\u679c\u60a8\u7684 Ansible \u4e3b\u6a5f\u5df2\u7d93\u5275\u5efa\u4e86\u4e00\u500b\u666e\u901a\u7684 sudo \u7528\u6236\uff0c\u6211\u5011\u9f13\u52f5\u60a8\u6539\u7528\u8a72\u5e33\u6236\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 -u \u53c3\u6578\u4f86\u6307\u5b9a\u9060\u7a0b\u7cfb\u7d71\u7528\u6236\u3002\u5982\u679c\u672a\u63d0\u4f9b\uff0cAnsible \u5c07\u5617\u8a66\u4ee5\u60a8\u7576\u524d\u7cfb\u7d71\u7528\u6236\u7684\u8eab\u4efd\u9023\u63a5\u5230\u63a7\u5236\u7bc0\u9ede\u3002 \u5f9e\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216 Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u904b\u884c\uff1a $ ansible all -m ping -u root \u6b64\u547d\u4ee4\u5c07\u4f7f\u7528 Ansible \u7684\u5167\u7f6e ping \u6a21\u584a\u5728\u9ed8\u8a8d\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u904b\u884c\u9023\u63a5\u6e2c\u8a66\uff0c\u4ee5 root \u8eab\u4efd\u9023\u63a5\u3002 ping \u6a21\u584a\u5c07\u6e2c\u8a66\uff1a \u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u8a2a\u554f\uff1b \u5982\u679c\u60a8\u64c1\u6709\u6709\u6548\u7684 SSH \u6191\u64da\uff1b \u5982\u679c\u4e3b\u6a5f\u80fd\u5920\u4f7f\u7528 Python \u904b\u884c Ansible \u6a21\u584a\u3002 \u4f60\u61c9\u8a72\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a server1 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server2 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server3 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } \u5982\u679c\u9019\u662f\u60a8\u7b2c\u4e00\u6b21\u901a\u904e SSH \u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\uff0c\u7cfb\u7d71\u6703\u8981\u6c42\u60a8\u78ba\u8a8d\u901a\u904e Ansible \u9023\u63a5\u7684\u4e3b\u6a5f\u7684\u771f\u5be6\u6027\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u9375\u5165 yes \uff0c\u7136\u5f8c\u6309 ENTER \u78ba\u8a8d\u3002 \u4e00\u65e6\u60a8\u5f9e\u4e3b\u6a5f\u6536\u5230 \u201c pong \u201d \u56de\u8986\uff0c\u9019\u610f\u5473\u8457\u60a8\u5df2\u6e96\u5099\u597d\u5728\u8a72\u670d\u52d9\u5668\u4e0a\u904b\u884c Ansible \u547d\u4ee4\u548c playbook\u3002 Info \u5982\u679c\u60a8\u7121\u6cd5\u5f9e\u670d\u52d9\u5668\u7372\u5f97\u6210\u529f\u7684\u97ff\u61c9\uff0c\u8acb\u67e5\u770b\u6211\u5011\u7684 Ansible \u5099\u5fd8\u55ae\u6307\u5357 \uff0c\u4e86\u89e3\u6709\u95dc\u5982\u4f55\u4f7f\u7528\u4e0d\u540c\u9023\u63a5\u9078\u9805\u904b\u884c Ansible \u547d\u4ee4\u7684\u66f4\u591a\u4fe1\u606f\u3002 Step 4 \u2014 Running Ad-Hoc Commands (Optional) \u00b6 \u5728\u78ba\u8a8d\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u80fd\u5920\u8207\u60a8\u7684\u4e3b\u6a5f\u901a\u4fe1\u5f8c\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u5728\u60a8\u7684\u670d\u52d9\u5668\u4e0a\u904b\u884c\u81e8\u6642\u547d\u4ee4\u548c playbook\u3002 \u60a8\u901a\u5e38\u901a\u904e SSH \u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4efb\u4f55\u547d\u4ee4\u90fd\u53ef\u4ee5\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u670d\u52d9\u5668\u4e0a\u4f7f\u7528 Ansible \u904b\u884c\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u6240\u6709\u670d\u52d9\u5668\u4e0a\u7684\u78c1\u76e4\u4f7f\u7528\u60c5\u6cc1\uff1a $ ansible all -a \"df -h\" -u root \u7d50\u679c: server1 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 3.9G 0 3.9G 0% /dev tmpfs 798M 624K 798M 1% /run /dev/vda1 155G 2.3G 153G 2% / tmpfs 3.9G 0 3.9G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 3.9G 0 3.9G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 798M 0 798M 0% /run/user/0 server2 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 2.0G 0 2.0G 0% /dev tmpfs 395M 608K 394M 1% /run /dev/vda1 78G 2.2G 76G 3% / tmpfs 2.0G 0 2.0G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 2.0G 0 2.0G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 395M 0 395M 0% /run/user/0 ... \u7a81\u51fa\u986f\u793a\u7684\u547d\u4ee4 df -h \u53ef\u4ee5\u66ff\u63db\u70ba\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u3002 \u60a8\u9084\u53ef\u4ee5\u901a\u904e ad-hoc \u547d\u4ee4\u57f7\u884c Ansible \u5176\u5b83\u6a21\u584a\uff0c\u985e\u4f3c\u65bc\u6211\u5011\u4e4b\u524d\u4f7f\u7528 ping \u6a21\u584a\u6e2c\u8a66\u9023\u63a5\u6240\u505a\u7684\u64cd\u4f5c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u662f\u6211\u5011\u5982\u4f55\u4f7f\u7528 apt \u6a21\u584a\u5728\u5eab\u5b58\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 vim \uff1a $ ansible all -m apt -a \"name=vim state=latest\" -u root \u5728\u904b\u884c Ansible \u547d\u4ee4\u6642\uff0c\u60a8\u9084\u53ef\u4ee5\u91dd\u5c0d\u55ae\u500b\u4e3b\u6a5f\u4ee5\u53ca\u7d44\u7fa4\u548c\u5b50\u7fa4\u7d44\u3002\u4f8b\u5982\uff0c\u9019\u662f\u60a8\u6aa2\u67e5\u670d\u52d9\u5668\u7d44\u4e2d\u6bcf\u500b\u4e3b\u6a5f\u7684\u6b63\u5e38\u904b\u884c\u6642\u9593\u7684\u65b9\u5f0f\uff1a $ ansible servers -a \"uptime\" -u root \u6211\u5011\u53ef\u4ee5\u901a\u904e\u7528\u5192\u865f\u5206\u9694\u4f86\u6307\u5b9a\u591a\u500b\u4e3b\u6a5f\uff1a $ ansible server1:server2 -m ping -u root \u6709\u95dc\u5982\u4f55\u4f7f\u7528 Ansible \u7684\u66f4\u591a\u4fe1\u606f\uff0c\u5305\u62ec\u5982\u4f55\u57f7\u884c playbook \u4ee5\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u6211\u5011\u7684 Ansible \u53c3\u8003\u6307\u5357 \u3002 \u7d50\u8ad6 \u00b6 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u60a8\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible \u4e26\u8a2d\u7f6e\u4e86\u4e00\u500b\u6e05\u55ae\u6587\u4ef6\u4ee5\u5f9e Ansible \u63a7\u5236\u7bc0\u9ede\u57f7\u884c\u81e8\u6642\u547d\u4ee4\u3002 \u4e00\u65e6\u60a8\u78ba\u8a8d\u60a8\u80fd\u5920\u5f9e\u4e2d\u592e Ansible \u63a7\u5236\u5668\u6a5f\u5668\u9023\u63a5\u548c\u63a7\u5236\u60a8\u7684\u57fa\u790e\u67b6\u69cb\uff0c\u60a8\u5c31\u53ef\u4ee5\u5728\u9019\u4e9b\u4e3b\u6a5f\u4e0a\u57f7\u884c\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u6216\u5287\u672c\u3002","title":"\u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#ubuntu-2204-ansible","text":"\u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-22-04 \u914d\u7f6e\u7ba1\u7406\u7cfb\u7d71\u65e8\u5728\u70ba\u7ba1\u7406\u54e1\u548c\u904b\u71df\u5718\u968a\u7c21\u5316\u63a7\u5236\u5927\u91cf\u670d\u52d9\u5668\u7684\u904e\u7a0b\u3002\u5b83\u5011\u5141\u8a31\u60a8\u5f9e\u4e00\u500b\u4e2d\u592e\u4f4d\u7f6e\u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u63a7\u5236\u8a31\u591a\u4e0d\u540c\u7684\u7cfb\u7d71\u3002 \u96d6\u7136\u6709\u8a31\u591a\u6d41\u884c\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u53ef\u7528\u65bc Linux \u7cfb\u7d71\uff0c\u4f8b\u5982 Chef \u548c Puppet\uff0c\u4f46\u9019\u4e9b\u5de5\u5177\u901a\u5e38\u6bd4\u8a31\u591a\u4eba\u60f3\u8981\u6216\u9700\u8981\u7684\u8907\u96dc\u3002 Ansible \u662f\u9019\u4e9b\u9078\u9805\u7684\u7d55\u4f73\u66ff\u4ee3\u54c1\uff0c\u56e0\u70ba\u5b83\u63d0\u4f9b\u7684\u67b6\u69cb\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\uff0c\u4f7f\u7528 SSH \u4f86\u57f7\u884c\u81ea\u52d5\u5316\u4efb\u52d9\u4e26\u4f7f\u7528 YAML \u6587\u4ef6\u4f86\u5b9a\u7fa9\u914d\u7f6e\u7d30\u7bc0\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u8a0e\u8ad6\u5982\u4f55\u5728 Ubuntu 22.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd Ansible\uff0c\u4e26\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u8a72\u8edf\u4ef6\u7684\u4e00\u4e9b\u57fa\u790e\u77e5\u8b58\u3002\u6709\u95dc Ansible \u4f5c\u70ba\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u7684\u66f4\u9ad8\u7d1a\u6982\u8ff0\uff0c\u8acb\u53c3\u95b1 An Introduction to Configuration Management with Ansible \u3002","title":"\u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#_1","text":"\u8981\u9075\u5faa\u672c\u6559\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede\uff1aAnsible \u63a7\u5236\u7bc0\u9ede\u662f\u6211\u5011\u5c07\u7528\u4f86\u901a\u904e SSH \u9023\u63a5\u548c\u63a7\u5236 Ansible \u4e3b\u6a5f\u7684\u6a5f\u5668\u3002\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u53ef\u4ee5\u662f\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216\u5c08\u7528\u65bc\u904b\u884c Ansible \u7684\u670d\u52d9\u5668\uff0c\u4f46\u672c\u6307\u5357\u5047\u5b9a\u60a8\u7684\u63a7\u5236\u7bc0\u9ede\u662f Ubuntu 22.04 \u7cfb\u7d71\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u5177\u6709\uff1a \u5177\u6709 sudo \u6b0a\u9650\u7684\u975e root \u7528\u6236 \u3002\u8981\u9032\u884c\u6b64\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u7684 Ubuntu 22.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u7684\u7b2c 2 \u6b65\u548c\u7b2c 3 \u6b65\u9032\u884c\u64cd\u4f5c\u3002\u4f46\u662f\uff0c\u8acb\u6ce8\u610f\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u9060\u7a0b\u670d\u52d9\u5668\u4f5c\u70ba Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u5247\u61c9\u9075\u5faa\u672c\u6307\u5357\u7684\u6bcf\u500b\u6b65\u9a5f\u3002\u9019\u6a23\u505a\u5c07\u4f7f\u7528 ufw \u5728\u670d\u52d9\u5668\u4e0a\u914d\u7f6e\u9632\u706b\u7246\u4e26\u555f\u7528\u5c0d\u975e root \u7528\u6236\u914d\u7f6e\u6587\u4ef6\u7684\u5916\u90e8\u8a2a\u554f\uff0c\u9019\u5169\u8005\u90fd\u5c07\u6709\u52a9\u65bc\u4fdd\u6301\u9060\u7a0b\u670d\u52d9\u5668\u7684\u5b89\u5168\u3002 \u8207\u6b64\u7528\u6236\u95dc\u806f\u7684 SSH \u5bc6\u9470\u5c0d \u3002\u8981\u9032\u884c\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u8a2d\u7f6e SSH \u5bc6\u9470\u7684\u6307\u5357 \u7684\u7b2c 1 \u6b65\u9032\u884c\u64cd\u4f5c\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-1-installing-ansible","text":"\u8981\u958b\u59cb\u4f7f\u7528 Ansible \u4f5c\u70ba\u7ba1\u7406\u670d\u52d9\u5668\u57fa\u790e\u67b6\u69cb\u7684\u4e00\u7a2e\u65b9\u5f0f\uff0c\u60a8\u9700\u8981\u5728\u5c07\u7528\u4f5c Ansible \u63a7\u5236\u7bc0\u9ede\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd Ansible \u8edf\u4ef6\u3002\u6211\u5011\u5c07\u70ba\u6b64\u4f7f\u7528\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5237\u65b0\u7cfb\u7d71\u7684\u5305\u7d22\u5f15\uff1a $ sudo apt update \u5728\u6b64\u66f4\u65b0\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5b89\u88dd Ansible \u8edf\u4ef6\uff1a $ sudo apt install ansible \u63d0\u793a\u78ba\u8a8d\u5b89\u88dd\u6642\u6309 Y \u3002\u5982\u679c\u7cfb\u7d71\u63d0\u793a\u60a8\u91cd\u65b0\u555f\u52d5\u4efb\u4f55\u670d\u52d9\uff0c\u8acb\u6309 ENTER \u63a5\u53d7\u9ed8\u8a8d\u8a2d\u7f6e\u4e26\u7e7c\u7e8c\u3002 \u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u73fe\u5728\u64c1\u6709\u7ba1\u7406\u4e3b\u6a5f\u6240\u9700\u200b\u200b\u7684\u6240\u6709\u8edf\u4ef6\u3002\u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\uff0c\u4ee5\u4fbf Ansible \u53ef\u4ee5\u8207\u60a8\u7684\u8a17\u7ba1\u7bc0\u9ede\u901a\u4fe1\u3002","title":"Step 1 \u2014 Installing Ansible"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-2-setting-up-the-inventory-file","text":"Inventory \u6e05\u55ae\u6587\u4ef6\u5305\u542b\u6709\u95dc\u60a8\u5c07\u4f7f\u7528 Ansible \u7ba1\u7406\u7684\u4e3b\u6a5f\u7684\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u5728 inventory \u6e05\u55ae\u6587\u4ef6\u4e2d\u5305\u542b\u5f9e\u4e00\u53f0\u5230\u6578\u767e\u53f0\u670d\u52d9\u5668\u7684\u4efb\u610f\u4f4d\u7f6e\uff0c\u4e26\u4e14\u53ef\u4ee5\u5c07\u4e3b\u6a5f\u7d44\u7e54\u6210\u7fa4\u7d44\u548c\u5b50\u7fa4\u7d44\u3002Inventory \u6e05\u55ae\u6587\u4ef6\u9084\u7d93\u5e38\u7528\u65bc\u8a2d\u7f6e\u50c5\u5c0d\u7279\u5b9a\u4e3b\u6a5f\u6216\u7d44\u6709\u6548\u7684\u8b8a\u91cf\uff0c\u4ee5\u4fbf\u5728\u5287\u672c\u548c\u6a21\u677f\u4e2d\u4f7f\u7528\u3002\u4e00\u4e9b\u8b8a\u91cf\u4e5f\u6703\u5f71\u97ff playbook \u7684\u904b\u884c\u65b9\u5f0f\uff0c\u4f8b\u5982\u6211\u5011\u7a0d\u5f8c\u6703\u770b\u5230\u7684 ansible_python_interpreter \u8b8a\u91cf\u3002 \u8981\u7de8\u8f2f\u9ed8\u8a8d Ansible \u7684 inventory \u6e05\u55ae\u7684\u5167\u5bb9\uff0c\u9996\u5148\u4f7f\u7528 mkdir \u547d\u4ee4\u5275\u5efa /etc/ansible \u76ee\u9304\u3002\u7136\u5f8c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u6587\u672c\u7de8\u8f2f\u5668\u6253\u958b /etc/ansible/hosts \u6587\u4ef6\uff1a $ sudo mkdir /etc/ansible $ sudo nano /etc/ansible/hosts Tip \u5118\u7ba1 Ansible \u901a\u5e38\u6703\u5728 etc/ansible/hosts \u4e2d\u5275\u5efa\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\uff0c\u4f46\u60a8\u53ef\u4ee5\u5728\u4efb\u4f55\u66f4\u9069\u5408\u60a8\u9700\u6c42\u7684\u4f4d\u7f6e\u81ea\u7531\u5275\u5efa\u6e05\u55ae\u6587\u4ef6\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u53c3\u6578\u63d0\u4f9b\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u7684\u8def\u5f91\u3002\u4f7f\u7528\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u6587\u4ef6\u662f\u4e00\u7a2e\u5f88\u597d\u7684\u505a\u6cd5\uff0c\u53ef\u4ee5\u6700\u5927\u7a0b\u5ea6\u5730\u964d\u4f4e\u5728\u932f\u8aa4\u7684\u670d\u52d9\u5668\u7d44\u4e0a\u904b\u884c\u5287\u672c\u7684\u98a8\u96aa\u3002 Ansible \u5b89\u88dd\u63d0\u4f9b\u7684\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u5305\u542b\u8a31\u591a\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5c07\u5b83\u5011\u7528\u4f5c\u8a2d\u7f6e\u6e05\u55ae\u7684\u53c3\u8003\u3002\u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba [servers] \u7684\u7d44\uff0c\u5176\u4e2d\u5305\u542b\u4e09\u500b\u4e0d\u540c\u7684\u670d\u52d9\u5668\uff0c\u6bcf\u500b\u670d\u52d9\u5668\u7531\u4e00\u500b\u81ea\u5b9a\u7fa9\u5225\u540d\u6a19\u8b58\uff1a server1 \u3001 server2 \u548c server3 \u3002\u8acb\u52d9\u5fc5\u5c07\u7a81\u51fa\u4e0b\u5217\u986f\u793a\u7684 IP \u66ff\u63db\u70ba\u4f60\u8981\u63a7\u5236\u7684 Ansible \u4e3b\u6a5f\u7684 IP \u5730\u5740\u3002 /etc/ansible/hosts [servers] server1 ansible_host=203.0.113.111 server2 ansible_host=203.0.113.112 server3 ansible_host=203.0.113.113 [all:vars] ansible_python_interpreter=/usr/bin/python3 all:vars \u5b50\u7fa4\u7d44\u8a2d\u7f6e ansible_python_interpreter \u4e3b\u6a5f\u53c3\u6578\uff0c\u8a72\u53c3\u6578\u5c07\u5c0d\u8a72\u6e05\u55ae\u4e2d\u5305\u542b\u7684\u6240\u6709\u4e3b\u6a5f\u6709\u6548\u3002\u6b64\u53c3\u6578\u78ba\u4fdd\u9060\u7a0b\u670d\u52d9\u5668\u4f7f\u7528 /usr/bin/python3 Python 3 \u53ef\u57f7\u884c\u6587\u4ef6\uff0c\u800c\u4e0d\u662f /usr/bin/python (Python 2.7)\uff0c\u9019\u5728\u6700\u8fd1\u7684 Ubuntu \u7248\u672c\u4e2d\u4e0d\u5b58\u5728\u3002 \u5b8c\u6210\u5f8c\uff0c\u6309 CTRL+X \u7136\u5f8c\u6309 Y \u548c ENTER \u78ba\u8a8d\u66f4\u6539\uff0c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002 \u6bcf\u7576\u60a8\u60f3\u6aa2\u67e5\u5eab\u5b58\u6642\uff0c\u90fd\u53ef\u4ee5\u904b\u884c\uff1a $ ansible-inventory --list -y \u60a8\u5c07\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff0c\u4f46\u5305\u542b\u60a8\u81ea\u5df1\u7684\u670d\u52d9\u5668\u57fa\u790e\u8a2d\u65bd\uff0c\u5982\u6e05\u55ae\u6587\u4ef6\u4e2d\u6240\u5b9a\u7fa9\uff1a all : children : servers : hosts : server1 : ansible_host : 203.0.113.111 ansible_python_interpreter : /usr/bin/python3 server2 : ansible_host : 203.0.113.112 ansible_python_interpreter : /usr/bin/python3 server3 : ansible_host : 203.0.113.113 ansible_python_interpreter : /usr/bin/python3 ungrouped : {} \u73fe\u5728\u60a8\u5df2\u7d93\u914d\u7f6e\u4e86\u6e05\u55ae\u6587\u4ef6\uff0c\u60a8\u64c1\u6709\u6e2c\u8a66\u8207 Ansible \u4e3b\u6a5f\u7684\u9023\u63a5\u6240\u9700\u7684\u4e00\u5207\u3002","title":"Step 2 \u2014 Setting Up the Inventory File"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-3-testing-connection","text":"\u5728\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\u4ee5\u5305\u542b\u60a8\u7684\u670d\u52d9\u5668\u4e4b\u5f8c\uff0c\u662f\u6642\u5019\u6aa2\u67e5 Ansible \u662f\u5426\u80fd\u5920\u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\u4e26\u901a\u904e SSH \u904b\u884c\u547d\u4ee4\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ubuntu root \u5e33\u6236\uff0c\u56e0\u70ba\u9019\u901a\u5e38\u662f\u65b0\u5275\u5efa\u7684\u670d\u52d9\u5668\u4e0a\u9ed8\u8a8d\u53ef\u7528\u7684\u552f\u4e00\u5e33\u6236\u3002\u5982\u679c\u60a8\u7684 Ansible \u4e3b\u6a5f\u5df2\u7d93\u5275\u5efa\u4e86\u4e00\u500b\u666e\u901a\u7684 sudo \u7528\u6236\uff0c\u6211\u5011\u9f13\u52f5\u60a8\u6539\u7528\u8a72\u5e33\u6236\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 -u \u53c3\u6578\u4f86\u6307\u5b9a\u9060\u7a0b\u7cfb\u7d71\u7528\u6236\u3002\u5982\u679c\u672a\u63d0\u4f9b\uff0cAnsible \u5c07\u5617\u8a66\u4ee5\u60a8\u7576\u524d\u7cfb\u7d71\u7528\u6236\u7684\u8eab\u4efd\u9023\u63a5\u5230\u63a7\u5236\u7bc0\u9ede\u3002 \u5f9e\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216 Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u904b\u884c\uff1a $ ansible all -m ping -u root \u6b64\u547d\u4ee4\u5c07\u4f7f\u7528 Ansible \u7684\u5167\u7f6e ping \u6a21\u584a\u5728\u9ed8\u8a8d\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u904b\u884c\u9023\u63a5\u6e2c\u8a66\uff0c\u4ee5 root \u8eab\u4efd\u9023\u63a5\u3002 ping \u6a21\u584a\u5c07\u6e2c\u8a66\uff1a \u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u8a2a\u554f\uff1b \u5982\u679c\u60a8\u64c1\u6709\u6709\u6548\u7684 SSH \u6191\u64da\uff1b \u5982\u679c\u4e3b\u6a5f\u80fd\u5920\u4f7f\u7528 Python \u904b\u884c Ansible \u6a21\u584a\u3002 \u4f60\u61c9\u8a72\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a server1 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server2 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server3 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } \u5982\u679c\u9019\u662f\u60a8\u7b2c\u4e00\u6b21\u901a\u904e SSH \u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\uff0c\u7cfb\u7d71\u6703\u8981\u6c42\u60a8\u78ba\u8a8d\u901a\u904e Ansible \u9023\u63a5\u7684\u4e3b\u6a5f\u7684\u771f\u5be6\u6027\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u9375\u5165 yes \uff0c\u7136\u5f8c\u6309 ENTER \u78ba\u8a8d\u3002 \u4e00\u65e6\u60a8\u5f9e\u4e3b\u6a5f\u6536\u5230 \u201c pong \u201d \u56de\u8986\uff0c\u9019\u610f\u5473\u8457\u60a8\u5df2\u6e96\u5099\u597d\u5728\u8a72\u670d\u52d9\u5668\u4e0a\u904b\u884c Ansible \u547d\u4ee4\u548c playbook\u3002 Info \u5982\u679c\u60a8\u7121\u6cd5\u5f9e\u670d\u52d9\u5668\u7372\u5f97\u6210\u529f\u7684\u97ff\u61c9\uff0c\u8acb\u67e5\u770b\u6211\u5011\u7684 Ansible \u5099\u5fd8\u55ae\u6307\u5357 \uff0c\u4e86\u89e3\u6709\u95dc\u5982\u4f55\u4f7f\u7528\u4e0d\u540c\u9023\u63a5\u9078\u9805\u904b\u884c Ansible \u547d\u4ee4\u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"Step 3 \u2014 Testing Connection"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-4-running-ad-hoc-commands-optional","text":"\u5728\u78ba\u8a8d\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u80fd\u5920\u8207\u60a8\u7684\u4e3b\u6a5f\u901a\u4fe1\u5f8c\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u5728\u60a8\u7684\u670d\u52d9\u5668\u4e0a\u904b\u884c\u81e8\u6642\u547d\u4ee4\u548c playbook\u3002 \u60a8\u901a\u5e38\u901a\u904e SSH \u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4efb\u4f55\u547d\u4ee4\u90fd\u53ef\u4ee5\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u670d\u52d9\u5668\u4e0a\u4f7f\u7528 Ansible \u904b\u884c\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u6240\u6709\u670d\u52d9\u5668\u4e0a\u7684\u78c1\u76e4\u4f7f\u7528\u60c5\u6cc1\uff1a $ ansible all -a \"df -h\" -u root \u7d50\u679c: server1 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 3.9G 0 3.9G 0% /dev tmpfs 798M 624K 798M 1% /run /dev/vda1 155G 2.3G 153G 2% / tmpfs 3.9G 0 3.9G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 3.9G 0 3.9G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 798M 0 798M 0% /run/user/0 server2 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 2.0G 0 2.0G 0% /dev tmpfs 395M 608K 394M 1% /run /dev/vda1 78G 2.2G 76G 3% / tmpfs 2.0G 0 2.0G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 2.0G 0 2.0G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 395M 0 395M 0% /run/user/0 ... \u7a81\u51fa\u986f\u793a\u7684\u547d\u4ee4 df -h \u53ef\u4ee5\u66ff\u63db\u70ba\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u3002 \u60a8\u9084\u53ef\u4ee5\u901a\u904e ad-hoc \u547d\u4ee4\u57f7\u884c Ansible \u5176\u5b83\u6a21\u584a\uff0c\u985e\u4f3c\u65bc\u6211\u5011\u4e4b\u524d\u4f7f\u7528 ping \u6a21\u584a\u6e2c\u8a66\u9023\u63a5\u6240\u505a\u7684\u64cd\u4f5c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u662f\u6211\u5011\u5982\u4f55\u4f7f\u7528 apt \u6a21\u584a\u5728\u5eab\u5b58\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 vim \uff1a $ ansible all -m apt -a \"name=vim state=latest\" -u root \u5728\u904b\u884c Ansible \u547d\u4ee4\u6642\uff0c\u60a8\u9084\u53ef\u4ee5\u91dd\u5c0d\u55ae\u500b\u4e3b\u6a5f\u4ee5\u53ca\u7d44\u7fa4\u548c\u5b50\u7fa4\u7d44\u3002\u4f8b\u5982\uff0c\u9019\u662f\u60a8\u6aa2\u67e5\u670d\u52d9\u5668\u7d44\u4e2d\u6bcf\u500b\u4e3b\u6a5f\u7684\u6b63\u5e38\u904b\u884c\u6642\u9593\u7684\u65b9\u5f0f\uff1a $ ansible servers -a \"uptime\" -u root \u6211\u5011\u53ef\u4ee5\u901a\u904e\u7528\u5192\u865f\u5206\u9694\u4f86\u6307\u5b9a\u591a\u500b\u4e3b\u6a5f\uff1a $ ansible server1:server2 -m ping -u root \u6709\u95dc\u5982\u4f55\u4f7f\u7528 Ansible \u7684\u66f4\u591a\u4fe1\u606f\uff0c\u5305\u62ec\u5982\u4f55\u57f7\u884c playbook \u4ee5\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u6211\u5011\u7684 Ansible \u53c3\u8003\u6307\u5357 \u3002","title":"Step 4 \u2014 Running Ad-Hoc Commands (Optional)"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#_2","text":"\u5728\u672c\u6307\u5357\u4e2d\uff0c\u60a8\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible \u4e26\u8a2d\u7f6e\u4e86\u4e00\u500b\u6e05\u55ae\u6587\u4ef6\u4ee5\u5f9e Ansible \u63a7\u5236\u7bc0\u9ede\u57f7\u884c\u81e8\u6642\u547d\u4ee4\u3002 \u4e00\u65e6\u60a8\u78ba\u8a8d\u60a8\u80fd\u5920\u5f9e\u4e2d\u592e Ansible \u63a7\u5236\u5668\u6a5f\u5668\u9023\u63a5\u548c\u63a7\u5236\u60a8\u7684\u57fa\u790e\u67b6\u69cb\uff0c\u60a8\u5c31\u53ef\u4ee5\u5728\u9019\u4e9b\u4e3b\u6a5f\u4e0a\u57f7\u884c\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u6216\u5287\u672c\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial/ubuntu-insall-docker/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Docker \u00b6 \u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u5728\u5bb9\u5668\u4e2d\u7ba1\u7406\u61c9\u7528\u7a0b\u5e8f\u9032\u7a0b\u7684\u904e\u7a0b\u3002\u5bb9\u5668\u8b93\u4f60\u53ef\u4ee5\u5728\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u4e2d\u904b\u884c\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5b83\u5011\u985e\u4f3c\u65bc\u865b\u64ec\u6a5f\uff0c\u4f46\u5bb9\u5668\u66f4\u4fbf\u651c\u3001\u66f4\u8cc7\u6e90\u53cb\u597d\uff0c\u4e26\u4e14\u66f4\u4f9d\u8cf4\u65bc\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u4f60\u5c07\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u793e\u5340\u7248 (CE)\u3002\u4f60\u5c07\u5b89\u88dd Docker \u672c\u8eab\uff0c\u4f7f\u7528\u5bb9\u5668\u548c\u6620\u50cf\u6a94\uff0c\u4e26\u5c07\u6620\u50cf\u6a94\u63a8\u9001\u5230 Docker \u5b58\u5132\u5eab\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u8981\u5b78\u7fd2\u672c\u6559\u7a0b\uff0c\u4f60\u5c07\u9700\u8981\u6e96\u5099\u4ee5\u4e0b\u74b0\u5883\uff1a \u6309\u7167 Ubuntu 20.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357\u8a2d\u7f6e\u4e00\u53f0 Ubuntu 20.04 \u670d\u52d9\u5668\uff0c\u5305\u62ec sudo \u975e root \u7528\u6236\u548c\u9632\u706b\u7246\u3002(\u5728\u672c\u6559\u7a0b\u4e2d\u6211\u5011\u4f7f\u7528Vagrant\u8207VirtualBox\u4f86\u555f\u52d5\u4e00\u53f0VM) Docker Hub \u4e0a\u7684\u5e33\u6236\uff0c\u5982\u679c\u4f60\u5e0c\u671b\u5275\u5efa\u81ea\u5df1\u7684\u5716\u50cf\u4e26\u5c07\u5b83\u5011\u63a8\u9001\u5230 Docker Hub\uff0c\u5982\u6b65\u9a5f 7 \u548c 8 \u6240\u793a\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ubuntu_install_docker $ cd ubuntu_install_docker $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u7d50\u679c: Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue Jun 7 21:29:14 UTC 2022 System load: 0.06 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update \u5b89\u88dd Docker \u00b6 Ubuntu \u5b98\u65b9\u5b58\u5132\u5eab\u4e2d\u63d0\u4f9b\u7684 Docker \u5b89\u88dd\u5305\u53ef\u80fd\u4e0d\u662f\u6700\u65b0\u7248\u672c\u3002\u70ba\u78ba\u4fdd\u6211\u5011\u7372\u5f97\u6700\u65b0\u7248\u672c\uff0c\u6211\u5011\u5c07\u5f9e\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u5b89\u88dd Docker\u3002\u70ba\u6b64\uff0c\u6211\u5011\u5c07\u6dfb\u52a0\u4e00\u500b\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u5f9e Docker \u6dfb\u52a0 GPG \u5bc6\u9470\u4ee5\u78ba\u4fdd\u4e0b\u8f09\u6709\u6548\uff0c\u7136\u5f8c\u5b89\u88dd\u5957\u4ef6\u3002 \u9996\u5148\uff0c\u66f4\u65b0\u73fe\u6709\u7684\u8edf\u4ef6\u5957\u4ef6\u5217\u8868\uff1a $ sudo apt update \u63a5\u4e0b\u4f86\uff0c\u5b89\u88dd\u4e00\u4e9b\u5fc5\u5099\u5957\u4ef6\uff0c\u8b93 apt \u53ef\u901a\u904e HTTPS \u4f86\u4e0b\u8f09\u5957\u4ef6\uff1a $ sudo apt install apt-transport-https ca-certificates curl software-properties-common \u7136\u5f8c\u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u7684 GPG \u5bc6\u9470\u6dfb\u52a0\u5230\u4f60\u7684\u7cfb\u7d71\uff1a $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - \u5c07 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 APT \u5957\u4ef6\u6e90\u5217\u8868\uff1a $ sudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable\" \u9019\u4e5f\u5c07\u4f7f\u7528\u65b0\u6dfb\u52a0\u7684 repo \u4e2d\u7684 Docker \u5957\u4ef6\u66f4\u65b0\u6211\u5011\u7684\u5957\u4ef6\u6578\u64da\u5eab\u3002 \u78ba\u4fdd\u4f60\u8981\u5f9e Docker \u5b58\u5132\u5eab\u800c\u4e0d\u662f\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u9032\u884c\u5b89\u88dd\uff1a $ apt-cache policy docker-ce \u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u5118\u7ba1 Docker \u7684\u7248\u672c\u865f\u53ef\u80fd\u4e0d\u540c\uff1a docker-ce: Installed: (none) Candidate: 5:20.10.17~3-0~ubuntu-focal Version table: 5:20.10.17~3-0~ubuntu-focal 500 500 https://download.docker.com/linux/ubuntu focal/stable amd64 Packages ... ... \u8acb\u6ce8\u610f\uff0c\u6b64\u6642\u6211\u5011\u9084\u672a\u5b89\u88dd docker-ce\uff0c\u4f46\u5b89\u88dd\u7684\u5019\u9078\u8005\u4f86\u81ea Ubuntu 20.04 \u7684 Docker \u5b58\u5132\u5eab\u3002 \u6700\u5f8c\uff0c\u5b89\u88dd Docker\uff1a $ sudo apt install docker-ce Docker \u73fe\u5728\u61c9\u8a72\u5df2\u5b89\u88dd\uff0c\u5b88\u8b77\u7a0b\u5e8f\u5df2\u555f\u52d5\uff0c\u4e26\u4e14\u8a72\u9032\u7a0b\u5df2\u555f\u7528\u4ee5\u5728\u865b\u64ec\u6a5f\u555f\u52d5\u6642\u555f\u52d5\u3002\u6aa2\u67e5\u5b83\u662f\u5426\u6b63\u5728\u904b\u884c\uff1a $ sudo systemctl status docker \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff0c\u8868\u660e\u8a72\u670d\u52d9\u8655\u65bc\u6d3b\u52d5\u72c0\u614b\u4e14\u6b63\u5728\u904b\u884c\uff1a Processing triggers for systemd (245.4-4ubuntu3.17) ... vagrant@ubuntu-focal:~$ sudo systemctl status docker \u25cf docker.service - Docker Application Container Engine Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2022-06-07 21:53:53 UTC; 1min 39s ago TriggeredBy: \u25cf docker.socket Docs: https://docs.docker.com Main PID: 5211 (dockerd) Tasks: 8 Memory: 30.6M CGroup: /system.slice/docker.service \u2514\u25005211 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Docker"},{"location":"ansible/tutorial/ubuntu-insall-docker/#ubuntu-2004-docker","text":"\u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u5728\u5bb9\u5668\u4e2d\u7ba1\u7406\u61c9\u7528\u7a0b\u5e8f\u9032\u7a0b\u7684\u904e\u7a0b\u3002\u5bb9\u5668\u8b93\u4f60\u53ef\u4ee5\u5728\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u4e2d\u904b\u884c\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5b83\u5011\u985e\u4f3c\u65bc\u865b\u64ec\u6a5f\uff0c\u4f46\u5bb9\u5668\u66f4\u4fbf\u651c\u3001\u66f4\u8cc7\u6e90\u53cb\u597d\uff0c\u4e26\u4e14\u66f4\u4f9d\u8cf4\u65bc\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u4f60\u5c07\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u793e\u5340\u7248 (CE)\u3002\u4f60\u5c07\u5b89\u88dd Docker \u672c\u8eab\uff0c\u4f7f\u7528\u5bb9\u5668\u548c\u6620\u50cf\u6a94\uff0c\u4e26\u5c07\u6620\u50cf\u6a94\u63a8\u9001\u5230 Docker \u5b58\u5132\u5eab\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Docker"},{"location":"ansible/tutorial/ubuntu-insall-docker/#_1","text":"\u8981\u5b78\u7fd2\u672c\u6559\u7a0b\uff0c\u4f60\u5c07\u9700\u8981\u6e96\u5099\u4ee5\u4e0b\u74b0\u5883\uff1a \u6309\u7167 Ubuntu 20.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357\u8a2d\u7f6e\u4e00\u53f0 Ubuntu 20.04 \u670d\u52d9\u5668\uff0c\u5305\u62ec sudo \u975e root \u7528\u6236\u548c\u9632\u706b\u7246\u3002(\u5728\u672c\u6559\u7a0b\u4e2d\u6211\u5011\u4f7f\u7528Vagrant\u8207VirtualBox\u4f86\u555f\u52d5\u4e00\u53f0VM) Docker Hub \u4e0a\u7684\u5e33\u6236\uff0c\u5982\u679c\u4f60\u5e0c\u671b\u5275\u5efa\u81ea\u5df1\u7684\u5716\u50cf\u4e26\u5c07\u5b83\u5011\u63a8\u9001\u5230 Docker Hub\uff0c\u5982\u6b65\u9a5f 7 \u548c 8 \u6240\u793a\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ubuntu_install_docker $ cd ubuntu_install_docker $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u7d50\u679c: Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue Jun 7 21:29:14 UTC 2022 System load: 0.06 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial/ubuntu-insall-docker/#docker","text":"Ubuntu \u5b98\u65b9\u5b58\u5132\u5eab\u4e2d\u63d0\u4f9b\u7684 Docker \u5b89\u88dd\u5305\u53ef\u80fd\u4e0d\u662f\u6700\u65b0\u7248\u672c\u3002\u70ba\u78ba\u4fdd\u6211\u5011\u7372\u5f97\u6700\u65b0\u7248\u672c\uff0c\u6211\u5011\u5c07\u5f9e\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u5b89\u88dd Docker\u3002\u70ba\u6b64\uff0c\u6211\u5011\u5c07\u6dfb\u52a0\u4e00\u500b\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u5f9e Docker \u6dfb\u52a0 GPG \u5bc6\u9470\u4ee5\u78ba\u4fdd\u4e0b\u8f09\u6709\u6548\uff0c\u7136\u5f8c\u5b89\u88dd\u5957\u4ef6\u3002 \u9996\u5148\uff0c\u66f4\u65b0\u73fe\u6709\u7684\u8edf\u4ef6\u5957\u4ef6\u5217\u8868\uff1a $ sudo apt update \u63a5\u4e0b\u4f86\uff0c\u5b89\u88dd\u4e00\u4e9b\u5fc5\u5099\u5957\u4ef6\uff0c\u8b93 apt \u53ef\u901a\u904e HTTPS \u4f86\u4e0b\u8f09\u5957\u4ef6\uff1a $ sudo apt install apt-transport-https ca-certificates curl software-properties-common \u7136\u5f8c\u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u7684 GPG \u5bc6\u9470\u6dfb\u52a0\u5230\u4f60\u7684\u7cfb\u7d71\uff1a $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - \u5c07 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 APT \u5957\u4ef6\u6e90\u5217\u8868\uff1a $ sudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable\" \u9019\u4e5f\u5c07\u4f7f\u7528\u65b0\u6dfb\u52a0\u7684 repo \u4e2d\u7684 Docker \u5957\u4ef6\u66f4\u65b0\u6211\u5011\u7684\u5957\u4ef6\u6578\u64da\u5eab\u3002 \u78ba\u4fdd\u4f60\u8981\u5f9e Docker \u5b58\u5132\u5eab\u800c\u4e0d\u662f\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u9032\u884c\u5b89\u88dd\uff1a $ apt-cache policy docker-ce \u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u5118\u7ba1 Docker \u7684\u7248\u672c\u865f\u53ef\u80fd\u4e0d\u540c\uff1a docker-ce: Installed: (none) Candidate: 5:20.10.17~3-0~ubuntu-focal Version table: 5:20.10.17~3-0~ubuntu-focal 500 500 https://download.docker.com/linux/ubuntu focal/stable amd64 Packages ... ... \u8acb\u6ce8\u610f\uff0c\u6b64\u6642\u6211\u5011\u9084\u672a\u5b89\u88dd docker-ce\uff0c\u4f46\u5b89\u88dd\u7684\u5019\u9078\u8005\u4f86\u81ea Ubuntu 20.04 \u7684 Docker \u5b58\u5132\u5eab\u3002 \u6700\u5f8c\uff0c\u5b89\u88dd Docker\uff1a $ sudo apt install docker-ce Docker \u73fe\u5728\u61c9\u8a72\u5df2\u5b89\u88dd\uff0c\u5b88\u8b77\u7a0b\u5e8f\u5df2\u555f\u52d5\uff0c\u4e26\u4e14\u8a72\u9032\u7a0b\u5df2\u555f\u7528\u4ee5\u5728\u865b\u64ec\u6a5f\u555f\u52d5\u6642\u555f\u52d5\u3002\u6aa2\u67e5\u5b83\u662f\u5426\u6b63\u5728\u904b\u884c\uff1a $ sudo systemctl status docker \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff0c\u8868\u660e\u8a72\u670d\u52d9\u8655\u65bc\u6d3b\u52d5\u72c0\u614b\u4e14\u6b63\u5728\u904b\u884c\uff1a Processing triggers for systemd (245.4-4ubuntu3.17) ... vagrant@ubuntu-focal:~$ sudo systemctl status docker \u25cf docker.service - Docker Application Container Engine Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2022-06-07 21:53:53 UTC; 1min 39s ago TriggeredBy: \u25cf docker.socket Docs: https://docs.docker.com Main PID: 5211 (dockerd) Tasks: 8 Memory: 30.6M CGroup: /system.slice/docker.service \u2514\u25005211 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock","title":"\u5b89\u88dd Docker"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/","text":"Ansible AWX \u57fa\u672c\u4f7f\u7528\u548c\u914d\u7f6e \u00b6 AWX \u662f\u4e00\u500b\u958b\u6e90 Web \u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u70ba Ansible \u63d0\u4f9b\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\u3002\u5b83\u662f Ansible Tower \u7684\u958b\u6e90\u7248\u672c\u3002 AWX \u5141\u8a31\u60a8\u4f7f\u7528 Web \u754c\u9762\u7ba1\u7406 Ansible \u5287\u672c\u3001\u6e05\u55ae\u548c\u5b89\u6392\u4f5c\u696d\u904b\u884c\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u5411\u60a8\u5c55\u793a Ansible AWX \u7684\u57fa\u672c\u7528\u6cd5\u3002\u56e0\u6b64\uff0c\u60a8\u9700\u8981\u4e00\u53f0\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible AWX \u7684\u670d\u52d9\u5668\u3002\u6211\u5011\u4ecb\u7d39\u4e86\u4e00\u4e9b\u60a8\u5fc5\u9808\u4e86\u89e3\u7684 Ansible AWX \u57fa\u672c\u914d\u7f6e\uff0c\u4f8b\u5982\u8a2d\u7f6e\u6191\u64da\u3001\u5eab\u5b58\u3001\u8a2d\u7f6e\u548c\u904b\u884c\u4f5c\u696d\u6a21\u677f\u7b49\u3002 1. Ansible AWX \u74b0\u5883\u8a2d\u7f6e\u548c\u914d\u7f6e \u00b6 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ansible AWX \u5100\u8868\u677f\u90e8\u7f72\u548c\u904b\u884c Ansible playbook \u4ee5\u9032\u884c\u57fa\u672c LEMP \u5b89\u88dd\u3002 \u9996\u5148\u8acb\u6839\u64da \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX \u7684\u6559\u7a0b\u4f86\u5b89\u88dd\u8207\u555f\u52d5 Ansible AWX\u3002 $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA 2. \u5275\u5efa\u4e00\u53f0Ansible\u7ba1\u7406\u7d50\u9ede\u7684\u865b\u64ec\u4e3b\u6a5f \u00b6 \u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u4f7f\u7528 Vagrant \u4f86\u914d\u7f6e\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u3002 \u5275\u5efa\u4e00\u500b\u76ee\u9304 \u00b6 \u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_ansible_awx $ cd vagrant_ansible_awx \u521d\u59cb\u5316\u5c08\u6848 \u00b6 Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a ubuntu/focal64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"private_network\" , type : \"dhcp\" end \u555f\u52d5\u865b\u64ec\u6a5f VM \u00b6 \u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220610.0.0' is up to date... ==> default: Setting the name of the VM: vagrant_ansible_awx_default_1655334451195_65866 ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat default: Adapter 2: hostonly ==> default: Forwarding ports... default: 22 (guest) => 2222 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Configuring and enabling network interfaces... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_ansible_awx SSH\u9032\u5165\u865b\u64ec\u6a5f \u00b6 Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-117-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jun 15 23:09:53 UTC 2022 System load: 0.18 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% IPv4 address for enp0s8: 192.168.56.5 Info \u5f9e\u767b\u5165\u7684console\u8a0a\u606f\u4e2d\u53ef\u5f97\u77e5\u9019\u500b\u865b\u64ec\u6a5f\u5f9e DHCP \u670d\u52d9\u4e2d\u53d6\u5f97\u7684 IP \u4f4d\u5740 \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed \u6aa2\u67e5\u6a5f\u5668\u72c0\u614b \u00b6 \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`. 3. \u5728 AWX \u4e2d\u8a2d\u5b9a Credentials \u00b6 \u9996\u5148\uff0c\u6211\u5011\u9700\u8981\u5728 Ansible AWX \u914d\u7f6e\u7ba1\u7406\u7bc0\u9ede\u7684\u6191\u8b49\u3002\u5b83\u7528\u65bc\u5c0d\u8a17\u7ba1\u7684\u670d\u52d9\u5668\u555f\u52d5\u548c\u904b\u884c\u4f5c\u696d\u3001\u8207\u5eab\u5b58\u6e90\u540c\u6b65\u548c\u5c0e\u5165\u9805\u76ee\u6642\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible AWX \u652f\u6301\u591a\u7a2e\u6191\u8b49\uff0c\u5305\u62ec\u901a\u904e SSH \u8eab\u4efd\u9a57\u8b49\u7684 VM \u6a5f\u5668\u3001Amazon Web Services\u3001Google Compute Engine\u3001OpenStack\u3001Vault \u5bc6\u78bc\u3001\u6e90\u4ee3\u78bc\u63a7\u5236\u7b49\u3002 \u8981\u8a2d\u7f6e\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 Credentials \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca Add \u6309\u9215\u3002 \u73fe\u5728\u9375\u5165\u6191\u8b49 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u5c07 \u201cCredential Type\u201d \u6307\u5b9a\u70ba \u201cMachine\u201d\u3002 \u7c21\u55ae\u5730\u8aaa\uff0c\u201cMachine\u201d\u6191\u8b49\u5c07\u5141\u8a31\u60a8\u4f7f\u7528 SSH \u8eab\u4efd\u9a57\u8b49\u4f86\u7ba1\u7406\u670d\u52d9\u5668\u3002\u5b83\u652f\u6301\u5bc6\u78bc\u548c\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002\u56e0\u6b64\uff0c\u8f38\u5165\u7528\u6236\u540d vagrant \u4e26\u7c98\u8cbc\u8a72\u7528\u6236\u7684\u79c1\u9470\u3002 \u7136\u5f8c\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u6700\u5f8c\u6aa2\u67e5\u6211\u5011\u662f\u5426\u5df2\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible AWX \u6191\u8b49\u985e\u578b\u201c\u6a5f\u5668\u201d\u3002 4. \u5728 AWX \u4e2d\u8a2d\u5b9a Inventory \u00b6 Inventory \u662f\u7531 Ansible AWX \u7ba1\u7406\u7684\u4e3b\u6a5f\u670d\u52d9\u5668\u6e05\u55ae\u8207\u7fa4\u7d44\u8cc7\u8a0a\u3002Inventory \u5141\u8a31\u60a8\u5275\u5efa\u4e00\u500b\u5305\u542b\u591a\u500b\u4e3b\u6a5f\u670d\u52d9\u5668\u7684\u7fa4\u7d44\u3002\u4e26\u4e14\u53ef\u4ee5\u66f4\u8f15\u9b06\u5730\u7ba1\u7406\u5177\u6709\u4e0d\u540c\u74b0\u5883\u7684\u4e0d\u540c\u670d\u52d9\u5668\u3002 \u70ba\u4e86\u7ba1\u7406\u548c\u63d0\u4f9b\u670d\u52d9\u5668\uff0c\u6211\u5011\u5fc5\u9808\u5275\u5efa\u4e00\u500b\u65b0\u7684 Inventory \u7fa4\u7d44\uff0c\u7136\u5f8c\u5c07\u670d\u52d9\u5668\u4e3b\u6a5f\u6dfb\u52a0\u5230\u8a72\u7fa4\u7d44\u4e2d\u3002 \u8981\u6dfb\u52a0\u65b0\u5eab\u5b58\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 \u201cInventory\u201d \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u4e26\u9078\u64c7\u201c\u5eab\u5b58\u201d\u3002 \u8f38\u5165 Inventory \u7684 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u55ae\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u73fe\u5728\u55ae\u64ca \u201cHosts\u201d \u9078\u9805\u5361\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u6dfb\u52a0\u65b0\u4e3b\u6a5f\u3002 \u9375\u5165\u201cName\u201d\u3001\u201cDescription\u201d \u548c \u201cVariables\u201d \u4ee5\u53ca\u76ee\u6a19\u6a5f\u5668 IP \u5730\u5740 \u201cansible_host: 192.168.56.5\u201d \u7684\u9644\u52a0\u914d\u7f6e\u3002 \u73fe\u5728\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u9700\u8981\u901a\u904e\u4f7f\u7528 ping \u547d\u4ee4\u6aa2\u67e5\u4e3b\u6a5f\u4f86\u78ba\u4fdd\u4e3b\u6a5f\u914d\u7f6e\u3002 \u8fd4\u56de\u201c\u4e3b\u6a5f\u201d\u9078\u9805\u5361\uff0c\u52fe\u9078\u4e3b\u6a5f\u7684\u540d\u7a31\u670d\u52d9\u5668\uff0c\u7136\u5f8c\u55ae\u64ca\u201c\u904b\u884c\u547d\u4ee4\u201d\u6309\u9215\u3002 \u73fe\u5728\u9078\u64c7\u540d\u70ba\u201c ping \u201d\u7684\u201c\u6a21\u584a\u201d\uff0c\u7136\u5f8c\u55ae\u64ca\u201cNext\u201d\u6309\u9215\u3002","title":"Ansible AWX \u57fa\u672c\u4f7f\u7528\u548c\u914d\u7f6e"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#ansible-awx","text":"AWX \u662f\u4e00\u500b\u958b\u6e90 Web \u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u70ba Ansible \u63d0\u4f9b\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\u3002\u5b83\u662f Ansible Tower \u7684\u958b\u6e90\u7248\u672c\u3002 AWX \u5141\u8a31\u60a8\u4f7f\u7528 Web \u754c\u9762\u7ba1\u7406 Ansible \u5287\u672c\u3001\u6e05\u55ae\u548c\u5b89\u6392\u4f5c\u696d\u904b\u884c\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u5411\u60a8\u5c55\u793a Ansible AWX \u7684\u57fa\u672c\u7528\u6cd5\u3002\u56e0\u6b64\uff0c\u60a8\u9700\u8981\u4e00\u53f0\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible AWX \u7684\u670d\u52d9\u5668\u3002\u6211\u5011\u4ecb\u7d39\u4e86\u4e00\u4e9b\u60a8\u5fc5\u9808\u4e86\u89e3\u7684 Ansible AWX \u57fa\u672c\u914d\u7f6e\uff0c\u4f8b\u5982\u8a2d\u7f6e\u6191\u64da\u3001\u5eab\u5b58\u3001\u8a2d\u7f6e\u548c\u904b\u884c\u4f5c\u696d\u6a21\u677f\u7b49\u3002","title":"Ansible AWX \u57fa\u672c\u4f7f\u7528\u548c\u914d\u7f6e"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#1-ansible-awx","text":"\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ansible AWX \u5100\u8868\u677f\u90e8\u7f72\u548c\u904b\u884c Ansible playbook \u4ee5\u9032\u884c\u57fa\u672c LEMP \u5b89\u88dd\u3002 \u9996\u5148\u8acb\u6839\u64da \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX \u7684\u6559\u7a0b\u4f86\u5b89\u88dd\u8207\u555f\u52d5 Ansible AWX\u3002 $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA","title":"1. Ansible AWX \u74b0\u5883\u8a2d\u7f6e\u548c\u914d\u7f6e"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#2-ansible","text":"\u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u4f7f\u7528 Vagrant \u4f86\u914d\u7f6e\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u3002","title":"2. \u5275\u5efa\u4e00\u53f0Ansible\u7ba1\u7406\u7d50\u9ede\u7684\u865b\u64ec\u4e3b\u6a5f"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#_1","text":"\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_ansible_awx $ cd vagrant_ansible_awx","title":"\u5275\u5efa\u4e00\u500b\u76ee\u9304"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#_2","text":"Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a ubuntu/focal64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"private_network\" , type : \"dhcp\" end","title":"\u521d\u59cb\u5316\u5c08\u6848"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#vm","text":"\u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220610.0.0' is up to date... ==> default: Setting the name of the VM: vagrant_ansible_awx_default_1655334451195_65866 ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat default: Adapter 2: hostonly ==> default: Forwarding ports... default: 22 (guest) => 2222 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Configuring and enabling network interfaces... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_ansible_awx","title":"\u555f\u52d5\u865b\u64ec\u6a5f VM"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#ssh","text":"Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-117-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jun 15 23:09:53 UTC 2022 System load: 0.18 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% IPv4 address for enp0s8: 192.168.56.5 Info \u5f9e\u767b\u5165\u7684console\u8a0a\u606f\u4e2d\u53ef\u5f97\u77e5\u9019\u500b\u865b\u64ec\u6a5f\u5f9e DHCP \u670d\u52d9\u4e2d\u53d6\u5f97\u7684 IP \u4f4d\u5740 \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed","title":"SSH\u9032\u5165\u865b\u64ec\u6a5f"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#_3","text":"\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`.","title":"\u6aa2\u67e5\u6a5f\u5668\u72c0\u614b"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#3-awx-credentials","text":"\u9996\u5148\uff0c\u6211\u5011\u9700\u8981\u5728 Ansible AWX \u914d\u7f6e\u7ba1\u7406\u7bc0\u9ede\u7684\u6191\u8b49\u3002\u5b83\u7528\u65bc\u5c0d\u8a17\u7ba1\u7684\u670d\u52d9\u5668\u555f\u52d5\u548c\u904b\u884c\u4f5c\u696d\u3001\u8207\u5eab\u5b58\u6e90\u540c\u6b65\u548c\u5c0e\u5165\u9805\u76ee\u6642\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible AWX \u652f\u6301\u591a\u7a2e\u6191\u8b49\uff0c\u5305\u62ec\u901a\u904e SSH \u8eab\u4efd\u9a57\u8b49\u7684 VM \u6a5f\u5668\u3001Amazon Web Services\u3001Google Compute Engine\u3001OpenStack\u3001Vault \u5bc6\u78bc\u3001\u6e90\u4ee3\u78bc\u63a7\u5236\u7b49\u3002 \u8981\u8a2d\u7f6e\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 Credentials \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca Add \u6309\u9215\u3002 \u73fe\u5728\u9375\u5165\u6191\u8b49 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u5c07 \u201cCredential Type\u201d \u6307\u5b9a\u70ba \u201cMachine\u201d\u3002 \u7c21\u55ae\u5730\u8aaa\uff0c\u201cMachine\u201d\u6191\u8b49\u5c07\u5141\u8a31\u60a8\u4f7f\u7528 SSH \u8eab\u4efd\u9a57\u8b49\u4f86\u7ba1\u7406\u670d\u52d9\u5668\u3002\u5b83\u652f\u6301\u5bc6\u78bc\u548c\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002\u56e0\u6b64\uff0c\u8f38\u5165\u7528\u6236\u540d vagrant \u4e26\u7c98\u8cbc\u8a72\u7528\u6236\u7684\u79c1\u9470\u3002 \u7136\u5f8c\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u6700\u5f8c\u6aa2\u67e5\u6211\u5011\u662f\u5426\u5df2\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible AWX \u6191\u8b49\u985e\u578b\u201c\u6a5f\u5668\u201d\u3002","title":"3. \u5728 AWX \u4e2d\u8a2d\u5b9a Credentials"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#4-awx-inventory","text":"Inventory \u662f\u7531 Ansible AWX \u7ba1\u7406\u7684\u4e3b\u6a5f\u670d\u52d9\u5668\u6e05\u55ae\u8207\u7fa4\u7d44\u8cc7\u8a0a\u3002Inventory \u5141\u8a31\u60a8\u5275\u5efa\u4e00\u500b\u5305\u542b\u591a\u500b\u4e3b\u6a5f\u670d\u52d9\u5668\u7684\u7fa4\u7d44\u3002\u4e26\u4e14\u53ef\u4ee5\u66f4\u8f15\u9b06\u5730\u7ba1\u7406\u5177\u6709\u4e0d\u540c\u74b0\u5883\u7684\u4e0d\u540c\u670d\u52d9\u5668\u3002 \u70ba\u4e86\u7ba1\u7406\u548c\u63d0\u4f9b\u670d\u52d9\u5668\uff0c\u6211\u5011\u5fc5\u9808\u5275\u5efa\u4e00\u500b\u65b0\u7684 Inventory \u7fa4\u7d44\uff0c\u7136\u5f8c\u5c07\u670d\u52d9\u5668\u4e3b\u6a5f\u6dfb\u52a0\u5230\u8a72\u7fa4\u7d44\u4e2d\u3002 \u8981\u6dfb\u52a0\u65b0\u5eab\u5b58\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 \u201cInventory\u201d \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u4e26\u9078\u64c7\u201c\u5eab\u5b58\u201d\u3002 \u8f38\u5165 Inventory \u7684 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u55ae\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u73fe\u5728\u55ae\u64ca \u201cHosts\u201d \u9078\u9805\u5361\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u6dfb\u52a0\u65b0\u4e3b\u6a5f\u3002 \u9375\u5165\u201cName\u201d\u3001\u201cDescription\u201d \u548c \u201cVariables\u201d \u4ee5\u53ca\u76ee\u6a19\u6a5f\u5668 IP \u5730\u5740 \u201cansible_host: 192.168.56.5\u201d \u7684\u9644\u52a0\u914d\u7f6e\u3002 \u73fe\u5728\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u9700\u8981\u901a\u904e\u4f7f\u7528 ping \u547d\u4ee4\u6aa2\u67e5\u4e3b\u6a5f\u4f86\u78ba\u4fdd\u4e3b\u6a5f\u914d\u7f6e\u3002 \u8fd4\u56de\u201c\u4e3b\u6a5f\u201d\u9078\u9805\u5361\uff0c\u52fe\u9078\u4e3b\u6a5f\u7684\u540d\u7a31\u670d\u52d9\u5668\uff0c\u7136\u5f8c\u55ae\u64ca\u201c\u904b\u884c\u547d\u4ee4\u201d\u6309\u9215\u3002 \u73fe\u5728\u9078\u64c7\u540d\u70ba\u201c ping \u201d\u7684\u201c\u6a21\u584a\u201d\uff0c\u7136\u5f8c\u55ae\u64ca\u201cNext\u201d\u6309\u9215\u3002","title":"4. \u5728 AWX \u4e2d\u8a2d\u5b9a Inventory"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX \u00b6 \u6b61\u8fce\u95b1\u8b80\u4eca\u5929\u7684\u6307\u5357\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u4f7f\u7528 Minikube \u5b89\u88dd Ansible AWX\u3002 Ansible AWX \u662f\u4e00\u500b\u958b\u6e90\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u500b\u57fa\u65bc Web \u7684\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\uff0c\u7528\u65bc\u8f15\u9b06\u3001\u5354\u4f5c\u5730\u7ba1\u7406 Ansible Playbooks \u548c Inventories\u3002 AWX \u5141\u8a31\u60a8\u5f9e Web \u754c\u9762\u96c6\u4e2d\u7ba1\u7406 Ansible \u5287\u672c\u3001\u5eab\u5b58\u3001\u6a5f\u5bc6\u548c\u8a08\u5283\u4f5c\u696d\u3002\u5728 Ubuntu 20.04 Linux \u7cfb\u7d71\u4e0a\u5b89\u88dd AWX \u5f88\u5bb9\u6613\u3002\u4f7f\u7528\u4e0b\u9762\u5171\u4eab\u7684\u6b65\u9a5f\u5728 Ubuntu 20.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible AWX\u3002 \u5f9e AWX 18.0 \u7248\u958b\u59cb\uff0c\u63a8\u85a6\u7684\u5b89\u88dd\u65b9\u6cd5\u662f\u901a\u904e AWX Operator \u3002\u7531\u65bc operator \u5b89\u88dd\u65b9\u5f0f\u9700\u8981 Kubernetes \u96c6\u7fa4\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Minikube \u5728 Ubuntu Linux \u4e0a\u57f7\u884c\u55ae\u7bc0\u9ede Kubernetes \u5b89\u88dd\u3002 \u8a2d\u7f6e\u6700\u4f4e\u8981\u6c42 \u00b6 Ubuntu 20.04 LTS \u670d\u52d9\u5668 \u81f3\u5c11 8GB \u7684\u200b\u200b RAM 4vcpus 10GB \u53ef\u7528\u78c1\u76e4\u5b58\u5132\u7a7a\u9593 \u4f7f\u7528 sudo \u9032\u884c ssh \u7684 root \u6216\u7528\u6236 1. \u66f4\u65b0 Ubuntu \u7cfb\u7d71 \u00b6 \u66f4\u65b0\u548c\u5347\u7d1a\u60a8\u7684\u7cfb\u7d71 sudo apt update sudo apt -y upgrade && sudo systemctl reboot 2. \u5b89\u88dd\u55ae\u7bc0\u9ede Minikube \u00b6 \u53c3\u8003 \u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube \u4f86\u555f\u52d5\u55ae\u7bc0\u9ede\u7684 Kubernetes\u3002 $ minikube start --cpus = 4 --memory = 6g --addons = ingress \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \u2757 Your cgroup does not allow setting memory. \u25aa More information: https://docs.docker.com/engine/install/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 4 , Memory = 6144MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass, ingress \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u90e8\u7f72 Minikube \u5f8c\uff0c\u6aa2\u67e5\u7bc0\u9ede\u548c kube-apiserver \u901a\u4fe1\u662f\u5426\u6309\u9810\u671f\u5de5\u4f5c\u3002 $ kubectl get nodes NAME STATUS ROLES AGE VERSION minikube Ready control-plane,master 115s v1.23.3 kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE ingress-nginx ingress-nginx-admission-create-8c749 0 /1 Completed 0 2m40s ingress-nginx ingress-nginx-admission-patch-vszkd 0 /1 Completed 1 2m40s ingress-nginx ingress-nginx-controller-cc8496874-zjw2b 1 /1 Running 0 2m40s kube-system coredns-64897985d-2n22v 1 /1 Running 0 2m40s kube-system etcd-minikube 1 /1 Running 0 2m51s kube-system kube-apiserver-minikube 1 /1 Running 0 2m55s kube-system kube-controller-manager-minikube 1 /1 Running 0 2m54s kube-system kube-proxy-vkr58 1 /1 Running 0 2m40s kube-system kube-scheduler-minikube 1 /1 Running 0 2m52s kube-system storage-provisioner 1 /1 Running 0 2m50s 3. \u57fa\u672c\u5b89\u88dd \u00b6 \u64c1\u6709\u4e00\u500b\u6b63\u5728\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Kustomize \u5c07 AWX Operator \u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa4\u4e2d\u3002\u4ee5\u4e0b\u8173\u672c\u6aa2\u6e2c\u60a8\u7684\u64cd\u4f5c\u7cfb\u7d71\u4e26\u5c07\u9069\u7576\u7684 kustomize \u4e8c\u9032\u88fd\u6587\u4ef6\u4e0b\u8f09\u5230\u60a8\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u3002 $ curl -s \"https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh\" | bash $ sudo mv kustomize /usr/local/bin/ \u9996\u5148\u5f9e AWX Operator \u7684 Github \u4e0a\u67e5\u627e\u6700\u65b0\u91cb\u51fa\u7684\u7248\u672c: https://github.com/ansible/awx-operator/releases \u8209\u4f8b\u4f86\u8aaa\u5728\u73fe\u5728\u7576\u4e0b2022/06/15\u67e5\u627e\u6642\u770b\u5230\u6700\u65b0\u7684\u7248\u672c\u662f 0.22.0 \u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba kustomization.yaml \u7684\u6587\u4ef6\uff0c\u5176\u5167\u5bb9\u5982\u4e0b(\u8acb\u4f7f\u7528\u67e5\u627e\u5230\u7684\u7248\u672c\u4f86\u66ff\u4ee3 <tag> \u7684\u6a19\u7c64)\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : # Find the latest tag here: https://github.com/ansible/awx-operator/releases - github.com/ansible/awx-operator/config/default?ref=<tag> # Set the image tags to match the git version from above images : - name : quay.io/ansible/awx-operator newTag : <tag> # Specify a custom namespace in which to install AWX namespace : awx Info \u63d0\u793a\uff1a\u5982\u679c\u60a8\u9700\u8981\u66f4\u6539AWX Operator\u7684\u4efb\u4f55\u9ed8\u8a8d\u8a2d\u7f6e\uff08\u4f8b\u5982 resources.limits\uff09\uff0c\u60a8\u53ef\u4ee5\u5728 kustomization.yaml \u6587\u4ef6\u7684\u5e95\u90e8\u6dfb\u52a0\u88dc\u4e01\u3002 \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd\u6e05\u55ae\uff1a $ kustomize build . | kubectl apply -f - namespace/awx created customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com created serviceaccount/awx-operator-controller-manager created role.rbac.authorization.k8s.io/awx-operator-awx-manager-role created role.rbac.authorization.k8s.io/awx-operator-leader-election-role created clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader created clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role created rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding created rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding created configmap/awx-operator-awx-manager-config created service/awx-operator-controller-manager-metrics-service created deployment.apps/awx-operator-controller-manager created \u7a0d\u7b49\u4e00\u4e0b\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 awx-operator \u904b\u884c\u5728 Kubernetes \u88e1\uff1a $ kubectl get pods -n awx NAME READY STATUS RESTARTS AGE awx-operator-controller-manager-c6554d8f-v9vbn 2 /2 Running 0 2m10s \u70ba\u4e86\u8b93\u6211\u5011\u4e0d\u5fc5\u4e00\u76f4\u91cd\u8907\u9375\u5165 -n awx \uff0c\u8b93\u6211\u5011\u70ba kubectl \u8a2d\u7f6e\u7576\u524d\u9810\u8a2d\u7684\u547d\u540d\u7a7a\u9593\uff1a $ kubectl config set-context --current --namespace = awx Context \"minikube\" modified. \u63a5\u4e0b\u4f86\uff0c\u4f7f\u7528\u4ee5\u4e0b\u5efa\u8b70\u7684\u5167\u5bb9\u5728\u540c\u4e00\u6587\u4ef6\u593e\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba awx-demo.yaml \u7684\u6587\u4ef6\u3002\u5176\u4e2d metadata.name \u8a2d\u5b9a\u7684\u5c07\u662f\u751f\u6210\u7684 AWX \u90e8\u7f72\u7684\u540d\u7a31\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u5c07\u591a\u500b AWX \u5be6\u4f8b\u90e8\u7f72\u5230\u540c\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff0c\u8acb\u52d9\u5fc5\u4f7f\u7528\u552f\u4e00\u540d\u7a31\u3002 awx-demo.yaml --- apiVersion : awx.ansible.com/v1beta1 kind : AWX metadata : name : awx-demo spec : service_type : nodeport \u78ba\u4fdd\u5c07\u6b64\u65b0\u6587\u4ef6\u6dfb\u52a0\u5230 kustomization.yaml \u6587\u4ef6\u4e2d\u7684 \u201cresources\u201d \u5217\u8868\u4e2d\uff1a ... resources : - github.com/ansible/awx-operator/config/default?ref=<tag> # Add this extra line: - awx-demo.yaml ... \u6700\u5f8c\uff0c\u518d\u6b21\u904b\u884c kustomize \u5728\u96c6\u7fa4\u4e2d\u5275\u5efa AWX \u5be6\u4f8b\uff1a $ kustomize build . | kubectl apply -f - \u7d50\u679c: namespace/awx unchanged customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com unchanged serviceaccount/awx-operator-controller-manager unchanged role.rbac.authorization.k8s.io/awx-operator-awx-manager-role configured role.rbac.authorization.k8s.io/awx-operator-leader-election-role unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding unchanged clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding unchanged configmap/awx-operator-awx-manager-config unchanged service/awx-operator-controller-manager-metrics-service unchanged deployment.apps/awx-operator-controller-manager unchanged awx.awx.ansible.com/awx-demo created \u5e7e\u5206\u9418\u5f8c\uff0c\u5728 Kubernetes \u4e2d\u5c07\u770b\u5230\u65b0\u90e8\u7f72\u7684 AWX \u5be6\u4f8b\u3002\u60a8\u53ef\u4ee5\u67e5\u770b operator pod \u65e5\u8a8c\u4ee5\u4e86\u89e3\u5b89\u88dd\u904e\u7a0b\u7684\u4f4d\u7f6e\uff1a $ kubectl logs -f deployments/awx-operator-controller-manager -c awx-manager \u5e7e\u79d2\u9418\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 AWX Operator \u958b\u59cb\u5275\u5efa\u65b0\u8cc7\u6e90\uff1a $ kubectl get pods -l \"app.kubernetes.io/managed-by=awx-operator\" NAME READY STATUS RESTARTS AGE awx-demo-fb89f8dd-rz42r 4 /4 Running 0 3m7s awx-demo-postgres-0 1 /1 Running 0 4m3s $ kubectl get svc -l \"app.kubernetes.io/managed-by=awx-operator\" NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE awx-demo-postgres ClusterIP None <none> 5432 /TCP 4m42s awx-demo-service NodePort 10 .99.232.78 <none> 80 :30080/TCP 3m48s \u90e8\u7f72\u5f8c\uff0c\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u8a2a\u554f AWX \u5be6\u4f8b\uff1a $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#ubuntu-2004-ansible-awx","text":"\u6b61\u8fce\u95b1\u8b80\u4eca\u5929\u7684\u6307\u5357\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u4f7f\u7528 Minikube \u5b89\u88dd Ansible AWX\u3002 Ansible AWX \u662f\u4e00\u500b\u958b\u6e90\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u500b\u57fa\u65bc Web \u7684\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\uff0c\u7528\u65bc\u8f15\u9b06\u3001\u5354\u4f5c\u5730\u7ba1\u7406 Ansible Playbooks \u548c Inventories\u3002 AWX \u5141\u8a31\u60a8\u5f9e Web \u754c\u9762\u96c6\u4e2d\u7ba1\u7406 Ansible \u5287\u672c\u3001\u5eab\u5b58\u3001\u6a5f\u5bc6\u548c\u8a08\u5283\u4f5c\u696d\u3002\u5728 Ubuntu 20.04 Linux \u7cfb\u7d71\u4e0a\u5b89\u88dd AWX \u5f88\u5bb9\u6613\u3002\u4f7f\u7528\u4e0b\u9762\u5171\u4eab\u7684\u6b65\u9a5f\u5728 Ubuntu 20.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible AWX\u3002 \u5f9e AWX 18.0 \u7248\u958b\u59cb\uff0c\u63a8\u85a6\u7684\u5b89\u88dd\u65b9\u6cd5\u662f\u901a\u904e AWX Operator \u3002\u7531\u65bc operator \u5b89\u88dd\u65b9\u5f0f\u9700\u8981 Kubernetes \u96c6\u7fa4\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Minikube \u5728 Ubuntu Linux \u4e0a\u57f7\u884c\u55ae\u7bc0\u9ede Kubernetes \u5b89\u88dd\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#_1","text":"Ubuntu 20.04 LTS \u670d\u52d9\u5668 \u81f3\u5c11 8GB \u7684\u200b\u200b RAM 4vcpus 10GB \u53ef\u7528\u78c1\u76e4\u5b58\u5132\u7a7a\u9593 \u4f7f\u7528 sudo \u9032\u884c ssh \u7684 root \u6216\u7528\u6236","title":"\u8a2d\u7f6e\u6700\u4f4e\u8981\u6c42"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#1-ubuntu","text":"\u66f4\u65b0\u548c\u5347\u7d1a\u60a8\u7684\u7cfb\u7d71 sudo apt update sudo apt -y upgrade && sudo systemctl reboot","title":"1. \u66f4\u65b0 Ubuntu \u7cfb\u7d71"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#2-minikube","text":"\u53c3\u8003 \u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube \u4f86\u555f\u52d5\u55ae\u7bc0\u9ede\u7684 Kubernetes\u3002 $ minikube start --cpus = 4 --memory = 6g --addons = ingress \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \u2757 Your cgroup does not allow setting memory. \u25aa More information: https://docs.docker.com/engine/install/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 4 , Memory = 6144MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass, ingress \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u90e8\u7f72 Minikube \u5f8c\uff0c\u6aa2\u67e5\u7bc0\u9ede\u548c kube-apiserver \u901a\u4fe1\u662f\u5426\u6309\u9810\u671f\u5de5\u4f5c\u3002 $ kubectl get nodes NAME STATUS ROLES AGE VERSION minikube Ready control-plane,master 115s v1.23.3 kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE ingress-nginx ingress-nginx-admission-create-8c749 0 /1 Completed 0 2m40s ingress-nginx ingress-nginx-admission-patch-vszkd 0 /1 Completed 1 2m40s ingress-nginx ingress-nginx-controller-cc8496874-zjw2b 1 /1 Running 0 2m40s kube-system coredns-64897985d-2n22v 1 /1 Running 0 2m40s kube-system etcd-minikube 1 /1 Running 0 2m51s kube-system kube-apiserver-minikube 1 /1 Running 0 2m55s kube-system kube-controller-manager-minikube 1 /1 Running 0 2m54s kube-system kube-proxy-vkr58 1 /1 Running 0 2m40s kube-system kube-scheduler-minikube 1 /1 Running 0 2m52s kube-system storage-provisioner 1 /1 Running 0 2m50s","title":"2. \u5b89\u88dd\u55ae\u7bc0\u9ede Minikube"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#3","text":"\u64c1\u6709\u4e00\u500b\u6b63\u5728\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Kustomize \u5c07 AWX Operator \u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa4\u4e2d\u3002\u4ee5\u4e0b\u8173\u672c\u6aa2\u6e2c\u60a8\u7684\u64cd\u4f5c\u7cfb\u7d71\u4e26\u5c07\u9069\u7576\u7684 kustomize \u4e8c\u9032\u88fd\u6587\u4ef6\u4e0b\u8f09\u5230\u60a8\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u3002 $ curl -s \"https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh\" | bash $ sudo mv kustomize /usr/local/bin/ \u9996\u5148\u5f9e AWX Operator \u7684 Github \u4e0a\u67e5\u627e\u6700\u65b0\u91cb\u51fa\u7684\u7248\u672c: https://github.com/ansible/awx-operator/releases \u8209\u4f8b\u4f86\u8aaa\u5728\u73fe\u5728\u7576\u4e0b2022/06/15\u67e5\u627e\u6642\u770b\u5230\u6700\u65b0\u7684\u7248\u672c\u662f 0.22.0 \u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba kustomization.yaml \u7684\u6587\u4ef6\uff0c\u5176\u5167\u5bb9\u5982\u4e0b(\u8acb\u4f7f\u7528\u67e5\u627e\u5230\u7684\u7248\u672c\u4f86\u66ff\u4ee3 <tag> \u7684\u6a19\u7c64)\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : # Find the latest tag here: https://github.com/ansible/awx-operator/releases - github.com/ansible/awx-operator/config/default?ref=<tag> # Set the image tags to match the git version from above images : - name : quay.io/ansible/awx-operator newTag : <tag> # Specify a custom namespace in which to install AWX namespace : awx Info \u63d0\u793a\uff1a\u5982\u679c\u60a8\u9700\u8981\u66f4\u6539AWX Operator\u7684\u4efb\u4f55\u9ed8\u8a8d\u8a2d\u7f6e\uff08\u4f8b\u5982 resources.limits\uff09\uff0c\u60a8\u53ef\u4ee5\u5728 kustomization.yaml \u6587\u4ef6\u7684\u5e95\u90e8\u6dfb\u52a0\u88dc\u4e01\u3002 \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd\u6e05\u55ae\uff1a $ kustomize build . | kubectl apply -f - namespace/awx created customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com created serviceaccount/awx-operator-controller-manager created role.rbac.authorization.k8s.io/awx-operator-awx-manager-role created role.rbac.authorization.k8s.io/awx-operator-leader-election-role created clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader created clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role created rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding created rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding created configmap/awx-operator-awx-manager-config created service/awx-operator-controller-manager-metrics-service created deployment.apps/awx-operator-controller-manager created \u7a0d\u7b49\u4e00\u4e0b\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 awx-operator \u904b\u884c\u5728 Kubernetes \u88e1\uff1a $ kubectl get pods -n awx NAME READY STATUS RESTARTS AGE awx-operator-controller-manager-c6554d8f-v9vbn 2 /2 Running 0 2m10s \u70ba\u4e86\u8b93\u6211\u5011\u4e0d\u5fc5\u4e00\u76f4\u91cd\u8907\u9375\u5165 -n awx \uff0c\u8b93\u6211\u5011\u70ba kubectl \u8a2d\u7f6e\u7576\u524d\u9810\u8a2d\u7684\u547d\u540d\u7a7a\u9593\uff1a $ kubectl config set-context --current --namespace = awx Context \"minikube\" modified. \u63a5\u4e0b\u4f86\uff0c\u4f7f\u7528\u4ee5\u4e0b\u5efa\u8b70\u7684\u5167\u5bb9\u5728\u540c\u4e00\u6587\u4ef6\u593e\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba awx-demo.yaml \u7684\u6587\u4ef6\u3002\u5176\u4e2d metadata.name \u8a2d\u5b9a\u7684\u5c07\u662f\u751f\u6210\u7684 AWX \u90e8\u7f72\u7684\u540d\u7a31\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u5c07\u591a\u500b AWX \u5be6\u4f8b\u90e8\u7f72\u5230\u540c\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff0c\u8acb\u52d9\u5fc5\u4f7f\u7528\u552f\u4e00\u540d\u7a31\u3002 awx-demo.yaml --- apiVersion : awx.ansible.com/v1beta1 kind : AWX metadata : name : awx-demo spec : service_type : nodeport \u78ba\u4fdd\u5c07\u6b64\u65b0\u6587\u4ef6\u6dfb\u52a0\u5230 kustomization.yaml \u6587\u4ef6\u4e2d\u7684 \u201cresources\u201d \u5217\u8868\u4e2d\uff1a ... resources : - github.com/ansible/awx-operator/config/default?ref=<tag> # Add this extra line: - awx-demo.yaml ... \u6700\u5f8c\uff0c\u518d\u6b21\u904b\u884c kustomize \u5728\u96c6\u7fa4\u4e2d\u5275\u5efa AWX \u5be6\u4f8b\uff1a $ kustomize build . | kubectl apply -f - \u7d50\u679c: namespace/awx unchanged customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com unchanged serviceaccount/awx-operator-controller-manager unchanged role.rbac.authorization.k8s.io/awx-operator-awx-manager-role configured role.rbac.authorization.k8s.io/awx-operator-leader-election-role unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding unchanged clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding unchanged configmap/awx-operator-awx-manager-config unchanged service/awx-operator-controller-manager-metrics-service unchanged deployment.apps/awx-operator-controller-manager unchanged awx.awx.ansible.com/awx-demo created \u5e7e\u5206\u9418\u5f8c\uff0c\u5728 Kubernetes \u4e2d\u5c07\u770b\u5230\u65b0\u90e8\u7f72\u7684 AWX \u5be6\u4f8b\u3002\u60a8\u53ef\u4ee5\u67e5\u770b operator pod \u65e5\u8a8c\u4ee5\u4e86\u89e3\u5b89\u88dd\u904e\u7a0b\u7684\u4f4d\u7f6e\uff1a $ kubectl logs -f deployments/awx-operator-controller-manager -c awx-manager \u5e7e\u79d2\u9418\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 AWX Operator \u958b\u59cb\u5275\u5efa\u65b0\u8cc7\u6e90\uff1a $ kubectl get pods -l \"app.kubernetes.io/managed-by=awx-operator\" NAME READY STATUS RESTARTS AGE awx-demo-fb89f8dd-rz42r 4 /4 Running 0 3m7s awx-demo-postgres-0 1 /1 Running 0 4m3s $ kubectl get svc -l \"app.kubernetes.io/managed-by=awx-operator\" NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE awx-demo-postgres ClusterIP None <none> 5432 /TCP 4m42s awx-demo-service NodePort 10 .99.232.78 <none> 80 :30080/TCP 3m48s \u90e8\u7f72\u5f8c\uff0c\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u8a2a\u554f AWX \u5be6\u4f8b\uff1a $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA","title":"3. \u57fa\u672c\u5b89\u88dd"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u00b6 Ansible playbook \u4f7f\u7528 YAML \u683c\u5f0f\u4f86\u5b9a\u7fa9\u4e00\u500b\u6216\u591a\u500b\u5287\u672c\u3002\u5287\u672c\u662f\u4e00\u7d44\u6709\u5e8f\u7684\u4efb\u52d9\uff0c\u9019\u4e9b\u4efb\u52d9\u4ee5\u81ea\u52d5\u5316\u6d41\u7a0b\u7684\u65b9\u5f0f\u6392\u5217\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\u3002 \u5728 playbook \u6587\u4ef6\u4e2d\uff0cplays \u88ab\u5b9a\u7fa9\u70ba YAML \u5217\u8868\u3002\u5178\u578b\u7684 playbook \u662f\u5f9e\u78ba\u5b9a\u54ea\u4e9b\u4e3b\u6a5f\u662f\u8a72\u7279\u5b9a\u8a2d\u7f6e\u7684\u76ee\u6a19\u958b\u59cb\u3002\u9019\u662f\u901a\u904e hosts \u6307\u4ee4\u5b8c\u6210\u7684\u3002 \u5c07 hosts \u6307\u4ee4\u8a2d\u7f6e\u70ba all \u662f\u4e00\u7a2e\u5e38\u898b\u7684\u9078\u64c7\uff0c\u56e0\u70ba\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u5e36\u6709 -l \u53c3\u6578\u7684 ansible-playbook \u547d\u4ee4\u4f86\u5728\u57f7\u884c\u6642\u6307\u5b9a\u81ea\u52d5\u8a2d\u5b9a\u7684\u76ee\u6a19\u3002\u9019\u5141\u8a31\u4f60\u5728\u4e0d\u540c\u7684\u670d\u52d9\u5668\u6216\u7d44\u4e0a\u904b\u884c\u76f8\u540c\u7684 playbook\uff0c\u800c\u7121\u9700\u6bcf\u6b21\u90fd\u66f4\u6539 playbook \u6587\u4ef6\u3002 \u524d\u7f6e\u6e96\u5099 \u00b6 \u9996\u5148\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u53ef\u4ee5\u5728\u5176\u4e2d\u4fdd\u5b58\u7df4\u7fd2\u624b\u518a\u3002\u9996\u5148\uff0c\u78ba\u4fdd\u4f60\u4f4d\u65bc Ubuntu \u7528\u6236\u7684\u4e3b\u76ee\u9304\u4e2d\u3002\u5f9e\u90a3\u88e1\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba ansible-practice \u7684\u76ee\u9304\uff0c\u7136\u5f8c\u4f7f\u7528 cd \u547d\u4ee4\u5c0e\u822a\u5230\u8a72\u76ee\u9304\uff1a $ mkdir ansible-practice $ cd ansible-practice \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-practice/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" } Ansible Playbook \u5287\u672c \u00b6 \u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u65b0\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook-01.yml \u4ee5\u4e0b\u5287\u672c\u5b9a\u7fa9\u4e86\u91dd\u5c0d\u7d66\u5b9a\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u4e3b\u6a5f\u7684\u5287\u672c\u3002\u5b83\u5305\u542b\u4e00\u500b\u6253\u5370\u8abf\u8a66\u6d88\u606f\u7684\u4efb\u52d9\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u4f60\u7684 playbook-01.yml \u6587\u4ef6\u4e2d\uff1a playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f nano\uff0c\u4f60\u53ef\u4ee5\u901a\u904e\u9375\u5165 CTRL+X\u3001Y \u548c ENTER \u4f86\u78ba\u8a8d\u3002 \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u4f46\u8acb\u52d9\u5fc5\u66f4\u6539\u9019\u4e9b\u8a73\u7d30\u4fe1\u606f\u4ee5\u8207\u4f60\u81ea\u5df1\u7684\u5eab\u5b58\u6587\u4ef6\u548c\u7ba1\u7406\u7528\u6236\u4fdd\u6301\u4e00\u81f4\uff1a $ ansible-playbook -i inventory playbook-01.yml \u7d50\u679c: PLAY [all] *************************************************************************** TASK [Gathering Facts] *************************************************************** ok: [demo-vm] TASK [Print message] ***************************************************************** ok: [demo-vm] => { \"msg\": \"Hello Ansible World\" } PLAY RECAP *************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u7d50\u8ad6 \u00b6 \u4f60\u53ef\u80fd\u5df2\u7d93\u6ce8\u610f\u5230\uff0c\u5373\u4f7f\u4f60\u5728 playbook \u4e2d\u53ea\u5b9a\u7fa9\u4e86\u4e00\u500b\u4efb\u52d9\uff0cplay \u8f38\u51fa\u4e2d\u4e5f\u5217\u51fa\u4e86\u5169\u500b\u4efb\u52d9\u3002\u5728\u6bcf\u6b21\u64ad\u653e\u958b\u59cb\u6642\uff0cAnsible \u9ed8\u8a8d\u57f7\u884c\u4e00\u500b\u984d\u5916\u7684\u4efb\u52d9\uff0c\u8a72\u4efb\u52d9\u6536\u96c6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u7684\u4fe1\u606f\uff08\u7a31\u70ba facts \uff09\u3002\u56e0\u70ba\u53ef\u4ee5\u5728\u5287\u672c\u4e0a\u4f7f\u7528 fact \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u7684\u884c\u70ba\uff0c\u6240\u4ee5\u4e8b\u5be6\u6536\u96c6\u4efb\u52d9\u5fc5\u9808\u5728\u57f7\u884c\u4efb\u4f55\u5176\u4ed6\u4efb\u52d9\u4e4b\u524d\u767c\u751f\u3002 \u6211\u5011\u5c07\u5728\u672c\u7cfb\u5217\u7684\u5f8c\u9762\u90e8\u5206\u4e86\u89e3\u6709\u95dc Ansible fact \u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"\u5982\u4f55\u5275\u5efa\u8207\u904b\u884c"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#ubuntu-2004-ansible","text":"Ansible playbook \u4f7f\u7528 YAML \u683c\u5f0f\u4f86\u5b9a\u7fa9\u4e00\u500b\u6216\u591a\u500b\u5287\u672c\u3002\u5287\u672c\u662f\u4e00\u7d44\u6709\u5e8f\u7684\u4efb\u52d9\uff0c\u9019\u4e9b\u4efb\u52d9\u4ee5\u81ea\u52d5\u5316\u6d41\u7a0b\u7684\u65b9\u5f0f\u6392\u5217\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\u3002 \u5728 playbook \u6587\u4ef6\u4e2d\uff0cplays \u88ab\u5b9a\u7fa9\u70ba YAML \u5217\u8868\u3002\u5178\u578b\u7684 playbook \u662f\u5f9e\u78ba\u5b9a\u54ea\u4e9b\u4e3b\u6a5f\u662f\u8a72\u7279\u5b9a\u8a2d\u7f6e\u7684\u76ee\u6a19\u958b\u59cb\u3002\u9019\u662f\u901a\u904e hosts \u6307\u4ee4\u5b8c\u6210\u7684\u3002 \u5c07 hosts \u6307\u4ee4\u8a2d\u7f6e\u70ba all \u662f\u4e00\u7a2e\u5e38\u898b\u7684\u9078\u64c7\uff0c\u56e0\u70ba\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u5e36\u6709 -l \u53c3\u6578\u7684 ansible-playbook \u547d\u4ee4\u4f86\u5728\u57f7\u884c\u6642\u6307\u5b9a\u81ea\u52d5\u8a2d\u5b9a\u7684\u76ee\u6a19\u3002\u9019\u5141\u8a31\u4f60\u5728\u4e0d\u540c\u7684\u670d\u52d9\u5668\u6216\u7d44\u4e0a\u904b\u884c\u76f8\u540c\u7684 playbook\uff0c\u800c\u7121\u9700\u6bcf\u6b21\u90fd\u66f4\u6539 playbook \u6587\u4ef6\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#_1","text":"\u9996\u5148\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u53ef\u4ee5\u5728\u5176\u4e2d\u4fdd\u5b58\u7df4\u7fd2\u624b\u518a\u3002\u9996\u5148\uff0c\u78ba\u4fdd\u4f60\u4f4d\u65bc Ubuntu \u7528\u6236\u7684\u4e3b\u76ee\u9304\u4e2d\u3002\u5f9e\u90a3\u88e1\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba ansible-practice \u7684\u76ee\u9304\uff0c\u7136\u5f8c\u4f7f\u7528 cd \u547d\u4ee4\u5c0e\u822a\u5230\u8a72\u76ee\u9304\uff1a $ mkdir ansible-practice $ cd ansible-practice \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-practice/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" }","title":"\u524d\u7f6e\u6e96\u5099"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#ansible-playbook","text":"\u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u65b0\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook-01.yml \u4ee5\u4e0b\u5287\u672c\u5b9a\u7fa9\u4e86\u91dd\u5c0d\u7d66\u5b9a\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u4e3b\u6a5f\u7684\u5287\u672c\u3002\u5b83\u5305\u542b\u4e00\u500b\u6253\u5370\u8abf\u8a66\u6d88\u606f\u7684\u4efb\u52d9\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u4f60\u7684 playbook-01.yml \u6587\u4ef6\u4e2d\uff1a playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f nano\uff0c\u4f60\u53ef\u4ee5\u901a\u904e\u9375\u5165 CTRL+X\u3001Y \u548c ENTER \u4f86\u78ba\u8a8d\u3002 \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u4f46\u8acb\u52d9\u5fc5\u66f4\u6539\u9019\u4e9b\u8a73\u7d30\u4fe1\u606f\u4ee5\u8207\u4f60\u81ea\u5df1\u7684\u5eab\u5b58\u6587\u4ef6\u548c\u7ba1\u7406\u7528\u6236\u4fdd\u6301\u4e00\u81f4\uff1a $ ansible-playbook -i inventory playbook-01.yml \u7d50\u679c: PLAY [all] *************************************************************************** TASK [Gathering Facts] *************************************************************** ok: [demo-vm] TASK [Print message] ***************************************************************** ok: [demo-vm] => { \"msg\": \"Hello Ansible World\" } PLAY RECAP *************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"Ansible Playbook \u5287\u672c"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#_2","text":"\u4f60\u53ef\u80fd\u5df2\u7d93\u6ce8\u610f\u5230\uff0c\u5373\u4f7f\u4f60\u5728 playbook \u4e2d\u53ea\u5b9a\u7fa9\u4e86\u4e00\u500b\u4efb\u52d9\uff0cplay \u8f38\u51fa\u4e2d\u4e5f\u5217\u51fa\u4e86\u5169\u500b\u4efb\u52d9\u3002\u5728\u6bcf\u6b21\u64ad\u653e\u958b\u59cb\u6642\uff0cAnsible \u9ed8\u8a8d\u57f7\u884c\u4e00\u500b\u984d\u5916\u7684\u4efb\u52d9\uff0c\u8a72\u4efb\u52d9\u6536\u96c6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u7684\u4fe1\u606f\uff08\u7a31\u70ba facts \uff09\u3002\u56e0\u70ba\u53ef\u4ee5\u5728\u5287\u672c\u4e0a\u4f7f\u7528 fact \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u7684\u884c\u70ba\uff0c\u6240\u4ee5\u4e8b\u5be6\u6536\u96c6\u4efb\u52d9\u5fc5\u9808\u5728\u57f7\u884c\u4efb\u4f55\u5176\u4ed6\u4efb\u52d9\u4e4b\u524d\u767c\u751f\u3002 \u6211\u5011\u5c07\u5728\u672c\u7cfb\u5217\u7684\u5f8c\u9762\u90e8\u5206\u4e86\u89e3\u6709\u95dc Ansible fact \u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial_playbook/how-to-access-system-information-facts-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u8a2a\u554f\u7cfb\u7d71\u4fe1\u606f\uff08Facts\uff09 \u00b6 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5728\u57f7\u884c playbook \u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u96c6\u4e4b\u524d\uff0cAnsible \u5c07\u82b1\u4e00\u4e9b\u6642\u9593\u4f86\u6536\u96c6\u6709\u95dc\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u7684\u4fe1\u606f\u3002\u9019\u4e9b\u4fe1\u606f\uff08\u7a31\u70baFacts\uff09\u5305\u542b\u8af8\u5982\u7db2\u7d61\u63a5\u53e3\u548c\u5730\u5740\u3001\u9060\u7a0b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u64cd\u4f5c\u7cfb\u7d71\u548c\u53ef\u7528\u5167\u5b58\u7b49\u8a73\u7d30\u4fe1\u606f\u3002 Ansible \u4ee5 JSON \u683c\u5f0f\u5b58\u5132 \u4e8b\u5be6 \uff0c\u9805\u76ee\u6309\u7bc0\u9ede\u5206\u7d44\u3002\u8981\u6aa2\u67e5\u60a8\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u6709\u54ea\u4e9b\u985e\u578b\u7684\u4fe1\u606f\u53ef\u7528\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ad hoc \u547d\u4ee4\u904b\u884c setup \u6a21\u584a\uff1a $ ansible all -i inventory -m setup \u7d50\u679c: { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ], \"ansible_all_ipv6_addresses\" : [ \"fe80::45:8eff:fe95:1bba\" ], \"ansible_apparmor\" : { \"status\" : \"enabled\" }, \"ansible_architecture\" : \"x86_64\" , \"ansible_bios_date\" : \"12/01/2006\" , \"ansible_bios_vendor\" : \"innotek GmbH\" , \"ansible_bios_version\" : \"VirtualBox\" , \"ansible_board_asset_tag\" : \"NA\" , \"ansible_board_name\" : \"VirtualBox\" , \"ansible_board_serial\" : \"NA\" , \"ansible_board_vendor\" : \"Oracle Corporation\" , \"ansible_board_version\" : \"1.2\" , \"ansible_chassis_asset_tag\" : \"NA\" , \"ansible_chassis_serial\" : \"NA\" , \"ansible_chassis_vendor\" : \"Oracle Corporation\" , \"ansible_chassis_version\" : \"NA\" , \"ansible_cmdline\" : { \"BOOT_IMAGE\" : \"/boot/vmlinuz-5.4.0-113-generic\" , \"console\" : \"ttyS0\" , \"ro\" : true , \"root\" : \"UUID=e42c9539-b31f-497a-98f5-47111033eed3\" }, \"ansible_date_time\" : { \"date\" : \"2022-06-08\" , \"day\" : \"08\" , \"epoch\" : \"1654679603\" , \"epoch_int\" : \"1654679603\" , \"hour\" : \"09\" , \"iso8601\" : \"2022-06-08T09:13:23Z\" , \"iso8601_basic\" : \"20220608T091323507293\" , \"iso8601_basic_short\" : \"20220608T091323\" , \"iso8601_micro\" : \"2022-06-08T09:13:23.507293Z\" , \"minute\" : \"13\" , \"month\" : \"06\" , \"second\" : \"23\" , \"time\" : \"09:13:23\" , \"tz\" : \"UTC\" , \"tz_dst\" : \"UTC\" , \"tz_offset\" : \"+0000\" , \"weekday\" : \"Wednesday\" , \"weekday_number\" : \"3\" , \"weeknumber\" : \"23\" , \"year\" : \"2022\" }, \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" }, \"ansible_default_ipv6\" : {} }, ... ... } \u6b64\u547d\u4ee4\u5c07\u8f38\u51fa\u5305\u542b\u6709\u95dc\u60a8\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u5ee3\u6cdb JSON\u3002\u8981\u7372\u53d6\u8a72\u6578\u64da\u7684\u5b50\u96c6\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 filter \u53c3\u6578\u4e26\u63d0\u4f9b\u6a21\u5f0f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u60f3\u7372\u53d6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u4e2d\u6240\u6709 IPv4 \u5730\u5740\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible all -i inventory -m setup -a \"filter=*ipv4*\" \u7d50\u679c: demo-vm | SUCCESS = > { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ] , \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" } , \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false } \u4e00\u65e6\u4f60\u627e\u5230\u4e86\u5c0d\u4f60\u7684\u81ea\u52d5\u5316\u6709\u7528\u7684 fact \uff0c\u4f60\u5c31\u53ef\u4ee5\u76f8\u61c9\u5730\u66f4\u65b0\u4f60\u7684\u5287\u672c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b playbook \u5c07\u6253\u5370\u51fa\u9ed8\u8a8d\u7db2\u7d61\u63a5\u53e3\u7684 IPv4 \u5730\u5740\u3002\u5f9e\u524d\u9762\u7684\u547d\u4ee4\u8f38\u51fa\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u901a\u904e Ansible \u63d0\u4f9b\u7684 JSON \u4e2d\u7684 ansible_default_ipv4.address \u53ef\u4ee5\u5f97\u5230\u9019\u500b\u503c\u3002 \u5728 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-03.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-03.yml --- - hosts : all tasks : - name : print facts debug : msg : \"IPv4 address: {{ ansible_default_ipv4.address }}\" \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-03.yml \u7576\u60a8\u904b\u884c playbook \u6642\uff0c\u60a8\u5c07\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u60a8\u7684\u9060\u7a0b\u670d\u52d9\u5668\u7684 IPv4 \u5730\u5740\uff0c\u5982\u9810\u671f\u7684\u90a3\u6a23\uff1a PLAY [all] ******************************************************************************************************************* TASK [Gathering Facts] ******************************************************************************************************* ok: [demo-vm] TASK [print facts] *********************************************************************************************************** ok: [demo-vm] => { \"msg\": \"IPv4 address: 10.0.2.15\" } PLAY RECAP ******************************************************************************************************************* demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 Facts \u5c01\u88dd\u4e86\u91cd\u8981\u7684\u5143\u6578\u64da\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u9019\u4e9b\u5143\u6578\u64da\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u60a8\u7684\u5287\u672c\u3002\u8981\u8a73\u7d30\u4e86\u89e3\u60a8\u53ef\u4ee5\u901a\u904e\u4e8b\u5be6 facts \u7372\u5f97\u7684\u6240\u6709\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u8a2a\u554f\u7cfb\u7d71\u4fe1\u606f"},{"location":"ansible/tutorial_playbook/how-to-access-system-information-facts-in-ansible-playbooks/#ansible-playbooks-facts","text":"\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5728\u57f7\u884c playbook \u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u96c6\u4e4b\u524d\uff0cAnsible \u5c07\u82b1\u4e00\u4e9b\u6642\u9593\u4f86\u6536\u96c6\u6709\u95dc\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u7684\u4fe1\u606f\u3002\u9019\u4e9b\u4fe1\u606f\uff08\u7a31\u70baFacts\uff09\u5305\u542b\u8af8\u5982\u7db2\u7d61\u63a5\u53e3\u548c\u5730\u5740\u3001\u9060\u7a0b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u64cd\u4f5c\u7cfb\u7d71\u548c\u53ef\u7528\u5167\u5b58\u7b49\u8a73\u7d30\u4fe1\u606f\u3002 Ansible \u4ee5 JSON \u683c\u5f0f\u5b58\u5132 \u4e8b\u5be6 \uff0c\u9805\u76ee\u6309\u7bc0\u9ede\u5206\u7d44\u3002\u8981\u6aa2\u67e5\u60a8\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u6709\u54ea\u4e9b\u985e\u578b\u7684\u4fe1\u606f\u53ef\u7528\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ad hoc \u547d\u4ee4\u904b\u884c setup \u6a21\u584a\uff1a $ ansible all -i inventory -m setup \u7d50\u679c: { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ], \"ansible_all_ipv6_addresses\" : [ \"fe80::45:8eff:fe95:1bba\" ], \"ansible_apparmor\" : { \"status\" : \"enabled\" }, \"ansible_architecture\" : \"x86_64\" , \"ansible_bios_date\" : \"12/01/2006\" , \"ansible_bios_vendor\" : \"innotek GmbH\" , \"ansible_bios_version\" : \"VirtualBox\" , \"ansible_board_asset_tag\" : \"NA\" , \"ansible_board_name\" : \"VirtualBox\" , \"ansible_board_serial\" : \"NA\" , \"ansible_board_vendor\" : \"Oracle Corporation\" , \"ansible_board_version\" : \"1.2\" , \"ansible_chassis_asset_tag\" : \"NA\" , \"ansible_chassis_serial\" : \"NA\" , \"ansible_chassis_vendor\" : \"Oracle Corporation\" , \"ansible_chassis_version\" : \"NA\" , \"ansible_cmdline\" : { \"BOOT_IMAGE\" : \"/boot/vmlinuz-5.4.0-113-generic\" , \"console\" : \"ttyS0\" , \"ro\" : true , \"root\" : \"UUID=e42c9539-b31f-497a-98f5-47111033eed3\" }, \"ansible_date_time\" : { \"date\" : \"2022-06-08\" , \"day\" : \"08\" , \"epoch\" : \"1654679603\" , \"epoch_int\" : \"1654679603\" , \"hour\" : \"09\" , \"iso8601\" : \"2022-06-08T09:13:23Z\" , \"iso8601_basic\" : \"20220608T091323507293\" , \"iso8601_basic_short\" : \"20220608T091323\" , \"iso8601_micro\" : \"2022-06-08T09:13:23.507293Z\" , \"minute\" : \"13\" , \"month\" : \"06\" , \"second\" : \"23\" , \"time\" : \"09:13:23\" , \"tz\" : \"UTC\" , \"tz_dst\" : \"UTC\" , \"tz_offset\" : \"+0000\" , \"weekday\" : \"Wednesday\" , \"weekday_number\" : \"3\" , \"weeknumber\" : \"23\" , \"year\" : \"2022\" }, \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" }, \"ansible_default_ipv6\" : {} }, ... ... } \u6b64\u547d\u4ee4\u5c07\u8f38\u51fa\u5305\u542b\u6709\u95dc\u60a8\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u5ee3\u6cdb JSON\u3002\u8981\u7372\u53d6\u8a72\u6578\u64da\u7684\u5b50\u96c6\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 filter \u53c3\u6578\u4e26\u63d0\u4f9b\u6a21\u5f0f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u60f3\u7372\u53d6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u4e2d\u6240\u6709 IPv4 \u5730\u5740\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible all -i inventory -m setup -a \"filter=*ipv4*\" \u7d50\u679c: demo-vm | SUCCESS = > { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ] , \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" } , \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false } \u4e00\u65e6\u4f60\u627e\u5230\u4e86\u5c0d\u4f60\u7684\u81ea\u52d5\u5316\u6709\u7528\u7684 fact \uff0c\u4f60\u5c31\u53ef\u4ee5\u76f8\u61c9\u5730\u66f4\u65b0\u4f60\u7684\u5287\u672c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b playbook \u5c07\u6253\u5370\u51fa\u9ed8\u8a8d\u7db2\u7d61\u63a5\u53e3\u7684 IPv4 \u5730\u5740\u3002\u5f9e\u524d\u9762\u7684\u547d\u4ee4\u8f38\u51fa\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u901a\u904e Ansible \u63d0\u4f9b\u7684 JSON \u4e2d\u7684 ansible_default_ipv4.address \u53ef\u4ee5\u5f97\u5230\u9019\u500b\u503c\u3002 \u5728 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-03.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-03.yml --- - hosts : all tasks : - name : print facts debug : msg : \"IPv4 address: {{ ansible_default_ipv4.address }}\" \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-03.yml \u7576\u60a8\u904b\u884c playbook \u6642\uff0c\u60a8\u5c07\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u60a8\u7684\u9060\u7a0b\u670d\u52d9\u5668\u7684 IPv4 \u5730\u5740\uff0c\u5982\u9810\u671f\u7684\u90a3\u6a23\uff1a PLAY [all] ******************************************************************************************************************* TASK [Gathering Facts] ******************************************************************************************************* ok: [demo-vm] TASK [print facts] *********************************************************************************************************** ok: [demo-vm] => { \"msg\": \"IPv4 address: 10.0.2.15\" } PLAY RECAP ******************************************************************************************************************* demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 Facts \u5c01\u88dd\u4e86\u91cd\u8981\u7684\u5143\u6578\u64da\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u9019\u4e9b\u5143\u6578\u64da\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u60a8\u7684\u5287\u672c\u3002\u8981\u8a73\u7d30\u4e86\u89e3\u60a8\u53ef\u4ee5\u901a\u904e\u4e8b\u5be6 facts \u7372\u5f97\u7684\u6240\u6709\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u8a2a\u554f\u7cfb\u7d71\u4fe1\u606f\uff08Facts\uff09"},{"location":"ansible/tutorial_playbook/how-to-create-and-use-templates-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f \u00b6 \u6a21\u677f\u5141\u8a31\u60a8\u4f7f\u7528\u57fa\u65bc Jinja2 \u6a21\u677f\u7cfb\u7d71 \u7684\u9810\u5b9a\u7fa9\u6a21\u578b\u5728\u7bc0\u9ede\u4e0a\u5275\u5efa\u65b0\u6587\u4ef6\u3002 Ansible \u6a21\u677f\u901a\u5e38\u4fdd\u5b58\u70ba .tpl \u6587\u4ef6\uff0c\u4e26\u652f\u6301\u4f7f\u7528\u8b8a\u91cf\u3001\u5faa\u74b0\u548c\u689d\u4ef6\u8868\u9054\u5f0f\u3002 \u6a21\u677f\u901a\u5e38\u7528\u65bc\u57fa\u65bc\u8b8a\u91cf\u503c\u914d\u7f6e\u670d\u52d9\uff0c\u9019\u4e9b\u8b8a\u91cf\u503c\u53ef\u4ee5\u5728\u5287\u672c\u672c\u8eab\u3001\u5305\u542b\u7684\u8b8a\u91cf\u6587\u4ef6\u4e2d\u6216\u901a\u904e facts \u7372\u5f97\u3002\u9019\u4f7f\u60a8\u80fd\u5920\u5275\u5efa\u66f4\u901a\u7528\u7684\u8a2d\u7f6e\uff0c\u4ee5\u6839\u64da\u52d5\u614b\u4fe1\u606f\u8abf\u6574\u884c\u70ba\u3002 \u8981\u901a\u904e\u5be6\u969b\u793a\u4f8b\u5617\u8a66\u6b64\u529f\u80fd\uff0c\u8acb\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u4ee5\u5728\u60a8\u7684 ansible-practice \u76ee\u9304\u4e2d\u4fdd\u5b58\u975e\u5287\u672c\u6587\u4ef6\uff1a $ mkdir ~/ansible-practice/files \u63a5\u4e0b\u4f86\uff0c\u70ba HTML \u767b\u9304\u9801\u9762\u5275\u5efa\u4e00\u500b\u65b0\u6a21\u677f\u6587\u4ef6\u3002\u7a0d\u5f8c\uff0c\u6211\u5011\u5c07\u8a2d\u7f6e\u4e00\u500b\u5287\u672c\uff0c\u5b83\u5c07\u914d\u7f6e\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4ee5\u4f7f\u7528 Nginx \u63d0\u4f9b\u767b\u9304\u9801\u9762\uff1a $ nano ~/ansible-practice/files/landing-page.html.j2 \u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a landing-page.html.j2 <!doctype html> < html lang = \"en\" > < head > < meta charset = \"utf-8\" > < title > {{ page_title }} </ title > < meta name = \"description\" content = \"Created with Ansible\" > </ head > < body > < h1 > {{ page_title }} </ h1 > < p > {{ page_description }} </ p > </ body > </ html > \u9019\u500b\u6a21\u677f\u4f7f\u7528\u4e86\u5169\u500b\u8b8a\u91cf\uff0c\u7576\u6a21\u677f\u61c9\u7528\u5230 playbook \u4e2d\u6642\u5fc5\u9808\u63d0\u4f9b\uff1a page_title \u548c page_description \u3002 \u4ee5\u4e0b playbook \u8a2d\u7f6e\u6240\u9700\u7684\u8b8a\u91cf\uff0c\u5b89\u88dd Nginx\uff0c\u7136\u5f8c\u61c9\u7528\u6307\u5b9a\u7684\u6a21\u677f\u4f86\u66ff\u63db\u4f4d\u65bc /var/www/html/index.nginx-debian.html \u7684\u73fe\u6709\u9ed8\u8a8d Nginx \u767b\u9304\u9801\u9762\u3002\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 ufw \u6a21\u584a\u555f\u7528\u9632\u706b\u7246\u5728\u7aef\u53e3 80 \u4e0a\u958b\u653e tcp \u8a2a\u554f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-11.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-11.yml --- - hosts : all become : yes vars : page_title : My Landing Page page_description : This is my landing page description. tasks : - name : Install Nginx apt : name : nginx state : latest - name : Apply Page Template template : src : files/landing-page.html.j2 dest : /var/www/html/index.nginx-debian.html - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp \u7531\u65bc Nginx \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 80 \u3002\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07VM\u4e0a\u7684 port 80 \u6620\u5c04\u5230\u672c\u6a5f\u4e0a\u7684 port 9080 \u3002 \u4fee\u6539 Vagrantfile: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"forwarded_port\" , guest : 80 , host : 9080 end \u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668: $ vagrant reload == > default: Attempting graceful shutdown of VM... == > default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > default: Clearing any previously set forwarded ports... == > default: Clearing any previously set network interfaces... == > default: Preparing network interfaces based on configuration... default: Adapter 1 : nat == > default: Forwarding ports... default: 80 ( guest ) = > 9080 ( host ) ( adapter 1 ) default: 22 ( guest ) = > 2222 ( host ) ( adapter 1 ) == > default: Running 'pre-boot' VM customizations... == > default: Booting VM... == > default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127 .0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key == > default: Machine booted and ready! == > default: Checking for guest additions in VM... == > default: Mounting shared folders... default: /vagrant = > /home/dxlab/opt/ws_ansible/ansible-cheatsheet == > default: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > default: flag to force provisioning. Provisioners marked to run always will still run. \u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-11.yml -u vagrant -K \u64ad\u653e\u7d50\u675f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5f9e\u700f\u89bd\u5668\u8a2a\u554f Web \u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\u3002\u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u9801\u9762\uff1a \u9019\u610f\u5473\u8457\u60a8\u7684\u5287\u672c\u6309\u9810\u671f\u5de5\u4f5c\uff0c\u4e26\u4e14\u9ed8\u8a8d\u7684 Nginx \u9801\u9762\u5df2\u88ab\u60a8\u5275\u5efa\u7684\u6a21\u677f\u66ff\u63db\u3002","title":"\u5982\u4f55\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f"},{"location":"ansible/tutorial_playbook/how-to-create-and-use-templates-in-ansible-playbooks/#ansible-playbook","text":"\u6a21\u677f\u5141\u8a31\u60a8\u4f7f\u7528\u57fa\u65bc Jinja2 \u6a21\u677f\u7cfb\u7d71 \u7684\u9810\u5b9a\u7fa9\u6a21\u578b\u5728\u7bc0\u9ede\u4e0a\u5275\u5efa\u65b0\u6587\u4ef6\u3002 Ansible \u6a21\u677f\u901a\u5e38\u4fdd\u5b58\u70ba .tpl \u6587\u4ef6\uff0c\u4e26\u652f\u6301\u4f7f\u7528\u8b8a\u91cf\u3001\u5faa\u74b0\u548c\u689d\u4ef6\u8868\u9054\u5f0f\u3002 \u6a21\u677f\u901a\u5e38\u7528\u65bc\u57fa\u65bc\u8b8a\u91cf\u503c\u914d\u7f6e\u670d\u52d9\uff0c\u9019\u4e9b\u8b8a\u91cf\u503c\u53ef\u4ee5\u5728\u5287\u672c\u672c\u8eab\u3001\u5305\u542b\u7684\u8b8a\u91cf\u6587\u4ef6\u4e2d\u6216\u901a\u904e facts \u7372\u5f97\u3002\u9019\u4f7f\u60a8\u80fd\u5920\u5275\u5efa\u66f4\u901a\u7528\u7684\u8a2d\u7f6e\uff0c\u4ee5\u6839\u64da\u52d5\u614b\u4fe1\u606f\u8abf\u6574\u884c\u70ba\u3002 \u8981\u901a\u904e\u5be6\u969b\u793a\u4f8b\u5617\u8a66\u6b64\u529f\u80fd\uff0c\u8acb\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u4ee5\u5728\u60a8\u7684 ansible-practice \u76ee\u9304\u4e2d\u4fdd\u5b58\u975e\u5287\u672c\u6587\u4ef6\uff1a $ mkdir ~/ansible-practice/files \u63a5\u4e0b\u4f86\uff0c\u70ba HTML \u767b\u9304\u9801\u9762\u5275\u5efa\u4e00\u500b\u65b0\u6a21\u677f\u6587\u4ef6\u3002\u7a0d\u5f8c\uff0c\u6211\u5011\u5c07\u8a2d\u7f6e\u4e00\u500b\u5287\u672c\uff0c\u5b83\u5c07\u914d\u7f6e\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4ee5\u4f7f\u7528 Nginx \u63d0\u4f9b\u767b\u9304\u9801\u9762\uff1a $ nano ~/ansible-practice/files/landing-page.html.j2 \u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a landing-page.html.j2 <!doctype html> < html lang = \"en\" > < head > < meta charset = \"utf-8\" > < title > {{ page_title }} </ title > < meta name = \"description\" content = \"Created with Ansible\" > </ head > < body > < h1 > {{ page_title }} </ h1 > < p > {{ page_description }} </ p > </ body > </ html > \u9019\u500b\u6a21\u677f\u4f7f\u7528\u4e86\u5169\u500b\u8b8a\u91cf\uff0c\u7576\u6a21\u677f\u61c9\u7528\u5230 playbook \u4e2d\u6642\u5fc5\u9808\u63d0\u4f9b\uff1a page_title \u548c page_description \u3002 \u4ee5\u4e0b playbook \u8a2d\u7f6e\u6240\u9700\u7684\u8b8a\u91cf\uff0c\u5b89\u88dd Nginx\uff0c\u7136\u5f8c\u61c9\u7528\u6307\u5b9a\u7684\u6a21\u677f\u4f86\u66ff\u63db\u4f4d\u65bc /var/www/html/index.nginx-debian.html \u7684\u73fe\u6709\u9ed8\u8a8d Nginx \u767b\u9304\u9801\u9762\u3002\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 ufw \u6a21\u584a\u555f\u7528\u9632\u706b\u7246\u5728\u7aef\u53e3 80 \u4e0a\u958b\u653e tcp \u8a2a\u554f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-11.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-11.yml --- - hosts : all become : yes vars : page_title : My Landing Page page_description : This is my landing page description. tasks : - name : Install Nginx apt : name : nginx state : latest - name : Apply Page Template template : src : files/landing-page.html.j2 dest : /var/www/html/index.nginx-debian.html - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp \u7531\u65bc Nginx \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 80 \u3002\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07VM\u4e0a\u7684 port 80 \u6620\u5c04\u5230\u672c\u6a5f\u4e0a\u7684 port 9080 \u3002 \u4fee\u6539 Vagrantfile: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"forwarded_port\" , guest : 80 , host : 9080 end \u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668: $ vagrant reload == > default: Attempting graceful shutdown of VM... == > default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > default: Clearing any previously set forwarded ports... == > default: Clearing any previously set network interfaces... == > default: Preparing network interfaces based on configuration... default: Adapter 1 : nat == > default: Forwarding ports... default: 80 ( guest ) = > 9080 ( host ) ( adapter 1 ) default: 22 ( guest ) = > 2222 ( host ) ( adapter 1 ) == > default: Running 'pre-boot' VM customizations... == > default: Booting VM... == > default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127 .0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key == > default: Machine booted and ready! == > default: Checking for guest additions in VM... == > default: Mounting shared folders... default: /vagrant = > /home/dxlab/opt/ws_ansible/ansible-cheatsheet == > default: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > default: flag to force provisioning. Provisioners marked to run always will still run. \u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-11.yml -u vagrant -K \u64ad\u653e\u7d50\u675f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5f9e\u700f\u89bd\u5668\u8a2a\u554f Web \u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\u3002\u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u9801\u9762\uff1a \u9019\u610f\u5473\u8457\u60a8\u7684\u5287\u672c\u6309\u9810\u671f\u5de5\u4f5c\uff0c\u4e26\u4e14\u9ed8\u8a8d\u7684 Nginx \u9801\u9762\u5df2\u88ab\u60a8\u5275\u5efa\u7684\u6a21\u677f\u66ff\u63db\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f"},{"location":"ansible/tutorial_playbook/how-to-define-and-use-handlers-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u548c\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f \u00b6 \u7c21\u800c\u8a00\u4e4b\uff0c\u8655\u7406\u7a0b\u5e8f handler \u662f\u7279\u6b8a\u4efb\u52d9\uff0c\u53ea\u6709\u5728\u901a\u904e notify \u6307\u4ee4\u89f8\u767c\u6642\u624d\u6703\u57f7\u884c\u3002\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u6642\u57f7\u884c\uff0c\u4e00\u65e6\u6240\u6709\u4efb\u52d9\u5b8c\u6210\u3002 \u5728 Ansible \u4e2d\uff0c\u8655\u7406\u7a0b\u5e8f\u901a\u5e38\u7528\u65bc \u555f\u52d5 \u3001 \u91cd\u65b0\u52a0\u8f09 \u3001 \u91cd\u65b0\u555f\u52d5 \u548c \u505c\u6b62\u670d\u52d9 \u3002\u5982\u679c\u60a8\u7684\u5287\u672c\u6d89\u53ca\u66f4\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5247\u5f88\u6709\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u4ee5\u4f7f\u66f4\u6539\u751f\u6548\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u70ba\u8a72\u670d\u52d9\u5b9a\u7fa9\u4e00\u500b\u8655\u7406\u7a0b\u5e8f\uff0c\u4e26\u5c07 notify \u6307\u4ee4\u5305\u542b\u5728\u4efb\u4f55\u9700\u8981\u8a72\u670d\u52d9\u8655\u7406\u7a0b\u5e8f\u7684\u4efb\u52d9\u4e2d\u3002 \u5728\u672c\u7cfb\u5217\u7684 \u5982\u4f55\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f \u4e2d\uff0c\u60a8\u5df2\u7d93\u4e86\u89e3\u77ad\u5982\u4f55\u4f7f\u7528\u6a21\u677f\u5c07\u9ed8\u8a8d Nginx \u9801\u9762\u66ff\u63db\u70ba\u81ea\u5b9a\u7fa9 HTML \u767b\u9304\u9801\u9762\u3002\u5be6\u969b\u4e0a\uff0c\u5728\u8a2d\u7f6e Nginx Web \u670d\u52d9\u5668\u6642\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u5728\u7ad9\u9ede\u53ef\u7528\u76ee\u9304\u4e2d\u5305\u542b\u65b0\u7684\u670d\u52d9\u5668\u584a\u6587\u4ef6\u3001\u5275\u5efa\u7b26\u865f\u93c8\u63a5\u6216\u66f4\u6539\u9700\u8981\u91cd\u65b0\u52a0\u8f09\u6216\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u5668\u7684\u8a2d\u7f6e\u3002 \u8003\u616e\u5230\u9019\u7a2e\u60c5\u6cc1\uff0c\u91cd\u555f Nginx \u670d\u52d9\u7684\u8655\u7406\u7a0b\u5e8f\u5982\u4e0b\u6240\u793a\uff1a ... handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u89f8\u767c\u6b64\u8655\u7406\u7a0b\u5e8f\uff0c\u60a8\u9700\u8981\u5728\u4efb\u4f55\u9700\u8981\u5728 Nginx \u670d\u52d9\u5668\u4e0a\u91cd\u65b0\u555f\u52d5\u7684\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b notify \u6307\u4ee4\u3002 \u4ee5\u4e0b playbook \u4f7f\u7528\u5167\u7f6e\u7684 Ansible \u7684 replace \u6a21\u584a\u4f86\u66ff\u63db Nginx \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u9ed8\u8a8d\u6587\u6a94\u6839\u76ee\u9304 ( document root )\u3002\u8a72\u6a21\u584a\u6839\u64da regexp \u5b9a\u7fa9\u7684\u6b63\u5247\u8868\u9054\u5f0f\u5728\u6587\u4ef6\u4e2d\u67e5\u627e\u6a21\u5f0f\uff0c\u7136\u5f8c\u5c07\u627e\u5230\u7684\u4efb\u4f55\u5339\u914d\u9805\u66ff\u63db\u70ba replace \u5b9a\u7fa9\u7684\u5167\u5bb9\u3002\u7136\u5f8c\uff0c\u8a72\u4efb\u52d9\u5411 Restart Nginx \u8655\u7406\u7a0b\u5e8f\u767c\u9001\u901a\u77e5\u4ee5\u76e1\u5feb\u91cd\u65b0\u555f\u52d5\u3002\u9019\u610f\u5473\u8457\uff0c\u89f8\u767c\u91cd\u555f\u7684\u6b21\u6578\u7121\u95dc\u7dca\u8981\uff0c\u5b83\u53ea\u6703\u5728\u6240\u6709\u4efb\u52d9\u5df2\u7d93\u5b8c\u6210\u57f7\u884c\u4e26\u4e14\u8655\u7406\u7a0b\u5e8f\u958b\u59cb\u904b\u884c\u6642\u624d\u6703\u767c\u751f\u3002\u6b64\u5916\uff0c\u7576\u6c92\u6709\u627e\u5230\u5339\u914d\u9805\u6642\uff0c\u4e0d\u6703\u5c0d\u7cfb\u7d71\u9032\u884c\u4efb\u4f55\u66f4\u6539\uff0c\u56e0\u6b64\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-12.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-12.yml --- - hosts : all become : yes vars : page_title : My Second Landing Page page_description : This is my second landing page description. doc_root : /var/www/mypage tasks : - name : Install Nginx apt : name : nginx state : latest - name : Make sure new doc root exists file : path : \"{{ doc_root }}\" state : directory mode : '0755' - name : Apply Page Template template : src : files/landing-page.html.j2 dest : \"{{ doc_root }}/index.html\" - name : Replace document root on default Nginx configuration replace : path : /etc/nginx/sites-available/default regexp : '(\\s+)root /var/www/html;(\\s+.*)?$' replace : \\g<1>root {{ doc_root }};\\g<2> notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u4f7f\u7528\u8655\u7406\u7a0b\u5e8f handler \u6642\u8981\u8a18\u4f4f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u5b83\u5011\u50c5\u5728\u5b9a\u7fa9 notify \u89f8\u767c\u5668\u7684\u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u66f4\u6539\u6642\u624d\u88ab\u89f8\u767c\u3002\u8003\u616e\u5230\u9019\u500b playbook\uff0c\u5b83\u7b2c\u4e00\u6b21\u904b\u884c replace \u4efb\u52d9\u6642\u6703\u66f4\u6539 Nginx \u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u6b64\u5c07\u904b\u884c\u91cd\u555f\u3002\u7136\u800c\uff0c\u5728\u96a8\u5f8c\u7684\u57f7\u884c\u4e2d\uff0c\u7531\u65bc\u8981\u66ff\u63db\u7684\u5b57\u7b26\u4e32\u4e0d\u518d\u5b58\u5728\u65bc\u6587\u4ef6\u4e2d\uff0c\u56e0\u6b64\u8a72\u4efb\u52d9\u4e0d\u6703\u5c0e\u81f4\u4efb\u4f55\u66f4\u6539\uff0c\u4e5f\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u57f7\u884c\u3002 \u5982\u679c\u60a8\u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-12.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Install Nginx] ******************************************************************************************************************************************************* ok: [demo-vm] TASK [Make sure new doc root exists] *************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Page Template] ************************************************************************************************************************************************* changed: [demo-vm] TASK [Replace document root on default Nginx configuration] **************************************************************************************************************** changed: [demo-vm] TASK [Allow all access to tcp port 80] ************************************************************************************************************************************* ok: [demo-vm] RUNNING HANDLER [Restart Nginx] ******************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=7 changed=4 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u60a8\u67e5\u770b\u8f38\u51fa\uff0c\u60a8\u6703\u770b\u5230\u201cRestart Nginx\u201d\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u4e4b\u524d\u6b63\u5728\u57f7\u884c\u3002\u5982\u679c\u60a8\u73fe\u5728\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684 IP \u5730\u5740\uff0c\u60a8\u5c07\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a \u5728\u672c\u7cfb\u5217\u7684\u4e0b\u4e00\u90e8\u5206\u548c\u6700\u5f8c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u9023\u63a5\u6240\u6709\u7684\u9ede\uff0c\u4e26\u7de8\u5beb\u4e00\u500b\u81ea\u52d5\u8a2d\u7f6e\u9060\u7a0b Nginx \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u7684\u5287\u672c\u3002","title":"\u5982\u4f55\u5b9a\u7fa9\u548c\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f"},{"location":"ansible/tutorial_playbook/how-to-define-and-use-handlers-in-ansible-playbooks/#ansible-playbook","text":"\u7c21\u800c\u8a00\u4e4b\uff0c\u8655\u7406\u7a0b\u5e8f handler \u662f\u7279\u6b8a\u4efb\u52d9\uff0c\u53ea\u6709\u5728\u901a\u904e notify \u6307\u4ee4\u89f8\u767c\u6642\u624d\u6703\u57f7\u884c\u3002\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u6642\u57f7\u884c\uff0c\u4e00\u65e6\u6240\u6709\u4efb\u52d9\u5b8c\u6210\u3002 \u5728 Ansible \u4e2d\uff0c\u8655\u7406\u7a0b\u5e8f\u901a\u5e38\u7528\u65bc \u555f\u52d5 \u3001 \u91cd\u65b0\u52a0\u8f09 \u3001 \u91cd\u65b0\u555f\u52d5 \u548c \u505c\u6b62\u670d\u52d9 \u3002\u5982\u679c\u60a8\u7684\u5287\u672c\u6d89\u53ca\u66f4\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5247\u5f88\u6709\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u4ee5\u4f7f\u66f4\u6539\u751f\u6548\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u70ba\u8a72\u670d\u52d9\u5b9a\u7fa9\u4e00\u500b\u8655\u7406\u7a0b\u5e8f\uff0c\u4e26\u5c07 notify \u6307\u4ee4\u5305\u542b\u5728\u4efb\u4f55\u9700\u8981\u8a72\u670d\u52d9\u8655\u7406\u7a0b\u5e8f\u7684\u4efb\u52d9\u4e2d\u3002 \u5728\u672c\u7cfb\u5217\u7684 \u5982\u4f55\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f \u4e2d\uff0c\u60a8\u5df2\u7d93\u4e86\u89e3\u77ad\u5982\u4f55\u4f7f\u7528\u6a21\u677f\u5c07\u9ed8\u8a8d Nginx \u9801\u9762\u66ff\u63db\u70ba\u81ea\u5b9a\u7fa9 HTML \u767b\u9304\u9801\u9762\u3002\u5be6\u969b\u4e0a\uff0c\u5728\u8a2d\u7f6e Nginx Web \u670d\u52d9\u5668\u6642\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u5728\u7ad9\u9ede\u53ef\u7528\u76ee\u9304\u4e2d\u5305\u542b\u65b0\u7684\u670d\u52d9\u5668\u584a\u6587\u4ef6\u3001\u5275\u5efa\u7b26\u865f\u93c8\u63a5\u6216\u66f4\u6539\u9700\u8981\u91cd\u65b0\u52a0\u8f09\u6216\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u5668\u7684\u8a2d\u7f6e\u3002 \u8003\u616e\u5230\u9019\u7a2e\u60c5\u6cc1\uff0c\u91cd\u555f Nginx \u670d\u52d9\u7684\u8655\u7406\u7a0b\u5e8f\u5982\u4e0b\u6240\u793a\uff1a ... handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u89f8\u767c\u6b64\u8655\u7406\u7a0b\u5e8f\uff0c\u60a8\u9700\u8981\u5728\u4efb\u4f55\u9700\u8981\u5728 Nginx \u670d\u52d9\u5668\u4e0a\u91cd\u65b0\u555f\u52d5\u7684\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b notify \u6307\u4ee4\u3002 \u4ee5\u4e0b playbook \u4f7f\u7528\u5167\u7f6e\u7684 Ansible \u7684 replace \u6a21\u584a\u4f86\u66ff\u63db Nginx \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u9ed8\u8a8d\u6587\u6a94\u6839\u76ee\u9304 ( document root )\u3002\u8a72\u6a21\u584a\u6839\u64da regexp \u5b9a\u7fa9\u7684\u6b63\u5247\u8868\u9054\u5f0f\u5728\u6587\u4ef6\u4e2d\u67e5\u627e\u6a21\u5f0f\uff0c\u7136\u5f8c\u5c07\u627e\u5230\u7684\u4efb\u4f55\u5339\u914d\u9805\u66ff\u63db\u70ba replace \u5b9a\u7fa9\u7684\u5167\u5bb9\u3002\u7136\u5f8c\uff0c\u8a72\u4efb\u52d9\u5411 Restart Nginx \u8655\u7406\u7a0b\u5e8f\u767c\u9001\u901a\u77e5\u4ee5\u76e1\u5feb\u91cd\u65b0\u555f\u52d5\u3002\u9019\u610f\u5473\u8457\uff0c\u89f8\u767c\u91cd\u555f\u7684\u6b21\u6578\u7121\u95dc\u7dca\u8981\uff0c\u5b83\u53ea\u6703\u5728\u6240\u6709\u4efb\u52d9\u5df2\u7d93\u5b8c\u6210\u57f7\u884c\u4e26\u4e14\u8655\u7406\u7a0b\u5e8f\u958b\u59cb\u904b\u884c\u6642\u624d\u6703\u767c\u751f\u3002\u6b64\u5916\uff0c\u7576\u6c92\u6709\u627e\u5230\u5339\u914d\u9805\u6642\uff0c\u4e0d\u6703\u5c0d\u7cfb\u7d71\u9032\u884c\u4efb\u4f55\u66f4\u6539\uff0c\u56e0\u6b64\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-12.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-12.yml --- - hosts : all become : yes vars : page_title : My Second Landing Page page_description : This is my second landing page description. doc_root : /var/www/mypage tasks : - name : Install Nginx apt : name : nginx state : latest - name : Make sure new doc root exists file : path : \"{{ doc_root }}\" state : directory mode : '0755' - name : Apply Page Template template : src : files/landing-page.html.j2 dest : \"{{ doc_root }}/index.html\" - name : Replace document root on default Nginx configuration replace : path : /etc/nginx/sites-available/default regexp : '(\\s+)root /var/www/html;(\\s+.*)?$' replace : \\g<1>root {{ doc_root }};\\g<2> notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u4f7f\u7528\u8655\u7406\u7a0b\u5e8f handler \u6642\u8981\u8a18\u4f4f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u5b83\u5011\u50c5\u5728\u5b9a\u7fa9 notify \u89f8\u767c\u5668\u7684\u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u66f4\u6539\u6642\u624d\u88ab\u89f8\u767c\u3002\u8003\u616e\u5230\u9019\u500b playbook\uff0c\u5b83\u7b2c\u4e00\u6b21\u904b\u884c replace \u4efb\u52d9\u6642\u6703\u66f4\u6539 Nginx \u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u6b64\u5c07\u904b\u884c\u91cd\u555f\u3002\u7136\u800c\uff0c\u5728\u96a8\u5f8c\u7684\u57f7\u884c\u4e2d\uff0c\u7531\u65bc\u8981\u66ff\u63db\u7684\u5b57\u7b26\u4e32\u4e0d\u518d\u5b58\u5728\u65bc\u6587\u4ef6\u4e2d\uff0c\u56e0\u6b64\u8a72\u4efb\u52d9\u4e0d\u6703\u5c0e\u81f4\u4efb\u4f55\u66f4\u6539\uff0c\u4e5f\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u57f7\u884c\u3002 \u5982\u679c\u60a8\u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-12.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Install Nginx] ******************************************************************************************************************************************************* ok: [demo-vm] TASK [Make sure new doc root exists] *************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Page Template] ************************************************************************************************************************************************* changed: [demo-vm] TASK [Replace document root on default Nginx configuration] **************************************************************************************************************** changed: [demo-vm] TASK [Allow all access to tcp port 80] ************************************************************************************************************************************* ok: [demo-vm] RUNNING HANDLER [Restart Nginx] ******************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=7 changed=4 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u60a8\u67e5\u770b\u8f38\u51fa\uff0c\u60a8\u6703\u770b\u5230\u201cRestart Nginx\u201d\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u4e4b\u524d\u6b63\u5728\u57f7\u884c\u3002\u5982\u679c\u60a8\u73fe\u5728\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684 IP \u5730\u5740\uff0c\u60a8\u5c07\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a \u5728\u672c\u7cfb\u5217\u7684\u4e0b\u4e00\u90e8\u5206\u548c\u6700\u5f8c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u9023\u63a5\u6240\u6709\u7684\u9ede\uff0c\u4e26\u7de8\u5beb\u4e00\u500b\u81ea\u52d5\u8a2d\u7f6e\u9060\u7a0b Nginx \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u7684\u5287\u672c\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u548c\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f"},{"location":"ansible/tutorial_playbook/how-to-define-tasks-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u4efb\u52d9 \u00b6 \u4efb\u52d9 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u5287\u672c Playbook \u901a\u5e38\u5305\u542b\u4e00\u7cfb\u5217\u670d\u52d9\u65bc\u67d0\u500b\u76ee\u6a19\u7684\u4efb\u52d9\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u9060\u7a0b\u74b0\u5883\u3002 Ansible \u6309\u7167\u5b83\u5011\u5728\u5287\u672c\u4e2d\u5b9a\u7fa9\u7684\u9806\u5e8f\u57f7\u884c\u4efb\u52d9\u3002\u5728\u81ea\u52d5\u5316\u8af8\u5982\u8a2d\u7f6e LEMP \u670d\u52d9\u5668\u4e4b\u985e\u7684\u904e\u7a0b\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u8a55\u4f30\u54ea\u4e9b\u624b\u52d5\u6b65\u9a5f\u662f\u5fc5\u8981\u7684\uff0c\u4ee5\u53ca\u5b83\u5011\u5fc5\u9808\u5b8c\u6210\u7684\u9806\u5e8f\u624d\u80fd\u5b8c\u6210\u6240\u6709\u5de5\u4f5c\u3002\u7136\u5f8c\uff0c\u4f60\u5c07\u80fd\u5920\u78ba\u5b9a\u9700\u8981\u54ea\u4e9b\u4efb\u52d9\u4ee5\u53ca\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e9b\u6a21\u584a\u4ee5\u66f4\u5c11\u7684\u6b65\u9a5f\u5be6\u73fe\u76ee\u6a19\u3002 \u6a21\u584a\u63d0\u4f9b\u4e86\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u9019\u4e9b\u4e5f\u7d93\u5e38\u7528\u65bc\u8de8\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7d71\u62bd\u8c61\u547d\u4ee4\u3002 \u7576\u4f60\u5728\u672c\u6307\u5357\u7684\u524d\u4e00\u90e8\u5206\u5275\u5efa\u4f60\u7684\u7b2c\u4e00\u500b playbook \u6642\uff0c\u4f60\u5b9a\u7fa9\u4e86\u4e00\u500b\u4f7f\u7528\u8abf\u8a66\u8f38\u51fa\u6d88\u606f\u7684\u4efb\u52d9\u3002\u8b93\u6211\u5011\u518d\u770b\u770b\u90a3\u500b playbook\u3002 playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u6bcf\u4e00\u500b task \u4efb\u52d9\u88ab\u5b9a\u7fa9\u5728\u7d1a\u5225\u4e4b\u4e0b\u3002 name \u5c6c\u6027\u5b9a\u7fa9\u4e86\u5728\u8a72\u4efb\u52d9\u5373\u5c07\u57f7\u884c\u6642\u5c07\u88ab\u6253\u5370\u51fa\u4f86\u7684\u8f38\u51fa\u3002 \u793a\u4f8b\u4efb\u52d9\u8abf\u7528 debug \u6a21\u584a\uff0c\u5b83\u5141\u8a31\u60a8\u5728playbook\u7684\u57f7\u884c\u4e2d\u986f\u793a\u6d88\u606f\u3002\u4f8b\u5982\uff0c\u9019\u4e9b\u6d88\u606f\u53ef\u7528\u65bc\u986f\u793a\u8abf\u8a66\u4fe1\u606f\uff0c\u4f8b\u5982\u8b8a\u91cf\u7684\u5167\u5bb9\u6216\u547d\u4ee4\u8fd4\u56de\u7684\u8f38\u51fa\u6d88\u606f\u3002 \u6bcf\u500b\u6a21\u584a\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u7d44\u9078\u9805\u548c\u5c6c\u6027\u3002 debug \u6a21\u584a\u9700\u8981\u4e00\u500b\u540d\u70ba msg \u7684\u5c6c\u6027\uff0c\u5176\u4e2d\u5305\u542b\u8981\u6253\u5370\u7684\u6d88\u606f\u3002\u7279\u5225\u6ce8\u610f\u7e2e\u9032\uff082 \u500b\u7a7a\u683c\uff09\uff0c\u56e0\u70ba msg \u5fc5\u9808\u662f debug \u4e2d\u7684\u5c6c\u6027\u3002","title":"\u5982\u4f55\u5b9a\u7fa9\u4efb\u52d9"},{"location":"ansible/tutorial_playbook/how-to-define-tasks-in-ansible-playbooks/#ansible-playbook","text":"\u4efb\u52d9 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u5287\u672c Playbook \u901a\u5e38\u5305\u542b\u4e00\u7cfb\u5217\u670d\u52d9\u65bc\u67d0\u500b\u76ee\u6a19\u7684\u4efb\u52d9\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u9060\u7a0b\u74b0\u5883\u3002 Ansible \u6309\u7167\u5b83\u5011\u5728\u5287\u672c\u4e2d\u5b9a\u7fa9\u7684\u9806\u5e8f\u57f7\u884c\u4efb\u52d9\u3002\u5728\u81ea\u52d5\u5316\u8af8\u5982\u8a2d\u7f6e LEMP \u670d\u52d9\u5668\u4e4b\u985e\u7684\u904e\u7a0b\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u8a55\u4f30\u54ea\u4e9b\u624b\u52d5\u6b65\u9a5f\u662f\u5fc5\u8981\u7684\uff0c\u4ee5\u53ca\u5b83\u5011\u5fc5\u9808\u5b8c\u6210\u7684\u9806\u5e8f\u624d\u80fd\u5b8c\u6210\u6240\u6709\u5de5\u4f5c\u3002\u7136\u5f8c\uff0c\u4f60\u5c07\u80fd\u5920\u78ba\u5b9a\u9700\u8981\u54ea\u4e9b\u4efb\u52d9\u4ee5\u53ca\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e9b\u6a21\u584a\u4ee5\u66f4\u5c11\u7684\u6b65\u9a5f\u5be6\u73fe\u76ee\u6a19\u3002 \u6a21\u584a\u63d0\u4f9b\u4e86\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u9019\u4e9b\u4e5f\u7d93\u5e38\u7528\u65bc\u8de8\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7d71\u62bd\u8c61\u547d\u4ee4\u3002 \u7576\u4f60\u5728\u672c\u6307\u5357\u7684\u524d\u4e00\u90e8\u5206\u5275\u5efa\u4f60\u7684\u7b2c\u4e00\u500b playbook \u6642\uff0c\u4f60\u5b9a\u7fa9\u4e86\u4e00\u500b\u4f7f\u7528\u8abf\u8a66\u8f38\u51fa\u6d88\u606f\u7684\u4efb\u52d9\u3002\u8b93\u6211\u5011\u518d\u770b\u770b\u90a3\u500b playbook\u3002 playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u6bcf\u4e00\u500b task \u4efb\u52d9\u88ab\u5b9a\u7fa9\u5728\u7d1a\u5225\u4e4b\u4e0b\u3002 name \u5c6c\u6027\u5b9a\u7fa9\u4e86\u5728\u8a72\u4efb\u52d9\u5373\u5c07\u57f7\u884c\u6642\u5c07\u88ab\u6253\u5370\u51fa\u4f86\u7684\u8f38\u51fa\u3002 \u793a\u4f8b\u4efb\u52d9\u8abf\u7528 debug \u6a21\u584a\uff0c\u5b83\u5141\u8a31\u60a8\u5728playbook\u7684\u57f7\u884c\u4e2d\u986f\u793a\u6d88\u606f\u3002\u4f8b\u5982\uff0c\u9019\u4e9b\u6d88\u606f\u53ef\u7528\u65bc\u986f\u793a\u8abf\u8a66\u4fe1\u606f\uff0c\u4f8b\u5982\u8b8a\u91cf\u7684\u5167\u5bb9\u6216\u547d\u4ee4\u8fd4\u56de\u7684\u8f38\u51fa\u6d88\u606f\u3002 \u6bcf\u500b\u6a21\u584a\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u7d44\u9078\u9805\u548c\u5c6c\u6027\u3002 debug \u6a21\u584a\u9700\u8981\u4e00\u500b\u540d\u70ba msg \u7684\u5c6c\u6027\uff0c\u5176\u4e2d\u5305\u542b\u8981\u6253\u5370\u7684\u6d88\u606f\u3002\u7279\u5225\u6ce8\u610f\u7e2e\u9032\uff082 \u500b\u7a7a\u683c\uff09\uff0c\u56e0\u70ba msg \u5fc5\u9808\u662f debug \u4e2d\u7684\u5c6c\u6027\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u4efb\u52d9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 (Nginx) \u4e0a\u4f7f\u7528 Ansible \u90e8\u7f72\u975c\u614b HTML \u7db2\u7ad9 \u00b6 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx \u5982\u679c\u4f60\u6b63\u5728\u95b1\u8b80\u672c\u7cfb\u5217\u7684\u6240\u6709\u90e8\u5206\uff0c\u90a3\u9ebc\u6b64\u6642\u4f60\u61c9\u8a72\u719f\u6089\u5b89\u88dd\u7cfb\u7d71\u5305\u3001\u61c9\u7528\u6a21\u677f\u548c\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f\u3002\u5728\u672c\u7cfb\u5217\u7684\u9019\u4e00\u90e8\u5206\u4e2d\uff0c\u4f60\u5c07\u4f7f\u7528\u5230\u76ee\u524d\u70ba\u6b62\u6240\u898b\u7684\u5167\u5bb9\u4f86\u5275\u5efa\u4e00\u500b playbook\uff0c\u8a72 playbook \u53ef\u4ee5\u81ea\u52d5\u8a2d\u7f6e Nginx \u670d\u52d9\u5668\u4ee5\u5728 Ubuntu 20.04 \u4e0a\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-nginx-demo\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-nginx-demo $ cd ansible-nginx-demo \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" } \u53d6\u5f97\u6f14\u793a\u7528\u7684\u975c\u614b\u7db2\u7ad9 \u00b6 \u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u975c\u614b HTML \u7db2\u7ad9\uff0c\u9019\u662f \u5982\u4f55\u5728 HTML \u4e2d\u7de8\u78bc\u7cfb\u5217 \u7684\u6559\u5b78\u4e2d\u6240\u69cb\u5efa\u7684\u7db2\u7ad9\u3002\u9996\u5148\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f09\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a $ curl -L https://github.com/do-community/html_demo_site/archive/refs/heads/main.zip -o html_demo.zip % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0 100 385k 0 385k 0 0 316k 0 --:--:-- 0 :00:01 --:--:-- 316k \u4f60\u9700\u8981\u89e3\u58d3\u7e2e\u624d\u80fd\u89e3\u58d3\u7e2e\u6b64\u4e0b\u8f09\u7684\u5167\u5bb9\u3002\u70ba\u78ba\u4fdd\u4f60\u5df2\u5b89\u88dd\u6b64\u5de5\u5177\uff0c\u8acb\u904b\u884c\uff1a $ sudo apt install unzip \u7136\u5f8c\uff0c\u89e3\u58d3\u7e2e\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a unzip html_demo.zip \u9019\u5c07\u5728\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u4e0a\u5275\u5efa\u4e00\u500b\u540d\u70ba html_demo_site-main \u7684\u65b0\u76ee\u9304\u3002\u73fe\u5728\u5de5\u4f5c\u76ee\u9304\u7684\u7d50\u69cb\u5982\u4e0b\uff1a $ tree . . \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 html_demo_site-main \u2502 \u251c\u2500\u2500 about.html \u2502 \u251c\u2500\u2500 images \u2502 \u2502 \u251c\u2500\u2500 background.jpg \u2502 \u2502 \u251c\u2500\u2500 large-profile.jpg \u2502 \u2502 \u2514\u2500\u2500 small-profile.jpeg \u2502 \u251c\u2500\u2500 index.html \u2502 \u251c\u2500\u2500 LICENSE \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 html_demo.zip \u251c\u2500\u2500 inventory \u2514\u2500\u2500 Vagrantfile \u70ba Nginx \u7684\u914d\u7f6e\u5275\u5efa\u6a21\u677f \u00b6 \u73fe\u5728\u6211\u5011\u5c07\u8a2d\u7f6e\u914d\u7f6e\u9060\u7a0b Web \u670d\u52d9\u5668\u6240\u9700\u7684 Nginx \u8a2d\u5b9a\u6a21\u677f\u3002\u5728\u5de5\u4f5c\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\u593e\u4f86\u4fdd\u5b58\u5176\u5b83\u975e playbook \u7684\u6587\u4ef6\uff1a $ mkdir files \u7136\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba nginx.conf.j2 \u7684\u65b0\u6587\u4ef6\uff1a $ nano files/nginx.conf.j2 \u6b64\u6a21\u677f\u6587\u4ef6\u5305\u542b\u975c\u614b HTML \u7db2\u7ad9\u7684 Nginx \u670d\u52d9\u5668\u584a\u914d\u7f6e\u3002\u5b83\u4f7f\u7528\u4e09\u500b\u8b8a\u91cf\uff1a document_root \u3001 app_root \u548c server_name \u3002\u6211\u5011\u7a0d\u5f8c\u6703\u5728\u5275\u5efa playbook \u6642\u5b9a\u7fa9\u9019\u4e9b\u8b8a\u91cf\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u8907\u88fd\u5230\u4f60\u7684\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a nginx.conf.j2 server { listen 80; root {{ document_root }}/{{ app_root }}; index index.html index.htm; server_name {{ server_name }}; location / { default_type \"text/html\"; try_files $uri.html $uri $uri/ =404; } } \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002 \u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible playbook \u00b6 \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible \u5287\u672c\u4e26\u8a2d\u7f6e\u6211\u5011\u5728\u672c\u6559\u7a0b\u4e0a\u4e00\u90e8\u5206\u4e2d\u4f7f\u7528\u7684\u8b8a\u91cf\u3002\u6253\u958b\u4e00\u500b\u540d\u70ba playbook.yml \u7684\u65b0\u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u500b playbook \u5c07 hosts \u5b9a\u7fa9\u8a2d\u7f6e\u70ba all \u548c\u4e00\u500b become \u6307\u4ee4\u958b\u59cb\uff0c\u8a72\u6307\u4ee4\u544a\u8a34 Ansible \u9ed8\u8a8d\u4ee5 root \u7528\u6236\u8eab\u4efd\u904b\u884c\u6240\u6709\u4efb\u52d9\uff08\u8207\u4f7f\u7528 sudo \u624b\u52d5\u904b\u884c\u547d\u4ee4\u76f8\u540c\uff09\u3002 \u5728\u672c\u5287\u672c\u7684 var \u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e09\u500b\u8b8a\u91cf\uff1a server_name \u3001 document_root \u548c app_root \u3002\u9019\u4e9b\u8b8a\u91cf\u5728 Nginx \u914d\u7f6e\u6a21\u677f\u4e2d\u7528\u65bc\u8a2d\u7f6e\u6b64 Web \u670d\u52d9\u5668\u5c07\u97ff\u61c9\u7684\u57df\u540d\u6216 IP \u5730\u5740\uff0c\u4ee5\u53ca\u7db2\u7ad9\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u7684\u5b8c\u6574\u8def\u5f91\u3002\u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ansible_default_ipv4.address \u4e8b\u5be6\u8b8a\u91cf\uff0c\u56e0\u70ba\u5b83\u5305\u542b\u9060\u7a0b\u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c\u5b83\u5728 DNS \u670d\u52d9\u4e2d\u6b63\u78ba\u914d\u7f6e\u4e86\u4e00\u500b\u57df\u540d\u4ee5\u6307\u5411\u9019\u500b\u670d\u52d9\u5668\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www/html app_root : html_demo_site-main tasks : \u4f60\u53ef\u4ee5\u66ab\u6642\u4fdd\u6301\u6b64\u6587\u4ef6\u6253\u958b\u3002\u63a5\u4e0b\u4f86\u7684\u90e8\u5206\u5c07\u5f15\u5c0e\u4f60\u5b8c\u6210\u6240\u6709\u9700\u8981\u5305\u542b\u5728\u672c\u6559\u7a0b\u4e2d\u4ee5\u4f7f\u5176\u5b8c\u5168\u6b63\u5e38\u904b\u884c\u7684\u4efb\u52d9\u3002 \u5b89\u88dd\u6240\u9700\u7684\u8edf\u4ef6\u5305 \u00b6 \u4ee5\u4e0b\u4efb\u52d9\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd nginx \u5305\uff1a ansible-nginx-demo/playbook.yml - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes \u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u7bc0\u9ede \u00b6 \u4e0b\u4e00\u500b\u4efb\u52d9\u5c07\u4f7f\u7528ansible copy \u5167\u7f6e\u6a21\u584a\u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u6587\u6a94\u6839\u76ee\u9304\u3002\u6211\u5011\u5c07\u4f7f\u7528 document_root \u8b8a\u91cf\u5728\u670d\u52d9\u5668\u4e0a\u8a2d\u7f6e\u61c9\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u6587\u4ef6\u593e\u7684\u76ee\u6a19\u3002 ansible-nginx-demo/playbook.yml - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve \u61c9\u7528\u548c\u555f\u7528\u81ea\u5b9a\u7fa9 Nginx \u914d\u7f6e \u00b6 \u6211\u5011\u73fe\u5728\u5c07\u61c9\u7528 Nginx \u6a21\u677f\uff0c\u8a72\u6a21\u677f\u5c07\u914d\u7f6e Web \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u4f60\u7684\u975c\u614b HTML \u6587\u4ef6\u3002\u5728 /etc/nginx/sites-available \u8a2d\u7f6e\u914d\u7f6e\u6587\u4ef6\u5f8c\uff0c\u6211\u5011\u5c07\u5728 /etc/nginx-sites-enabled \u4e2d\u5275\u5efa\u6307\u5411\u8a72\u6587\u4ef6\u7684\u7b26\u865f\u93c8\u63a5\uff0c\u4e26\u901a\u77e5 Nginx \u670d\u52d9\u4ee5\u9032\u884c\u5f8c\u7e8c\u91cd\u555f\u3002\u6574\u500b\u904e\u7a0b\u5c07\u9700\u8981\u5169\u500b\u55ae\u7368\u7684\u4efb\u52d9\uff1a ansible-nginx-demo/playbook.yml - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx \u5728 UFW \u4e0a\u5141\u8a31\u7aef\u53e3 80 \u00b6 ufw \u7684\u5168\u540d\u662f Uncomplicated Firewall\uff0c\u610f\u601d\u662f\u4e0d\u8907\u96dc\u7684\u9632\u706b\u7246\u3002\u5b83\u7684\u6307\u4ee4\u4e0d\u4f46\u597d\u8a18\uff0c\u5beb\u597d\u7684\u898f\u5247\u4e5f\u6dfa\u986f\u6613\u61c2\uff0c\u4e0d\u6703\u50cf iptables \u7684\u88f9\u8173\u5e03\u53c8\u81ed\u53c8\u9577\u3002 ansible-nginx-demo/playbook.yml - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp \u70ba Nginx \u670d\u52d9\u5275\u5efa Handler \u00b6 \u8981\u5b8c\u6210\u9019\u500b\u5287\u672c\uff0c\u5269\u4e0b\u8981\u505a\u7684\u5c31\u662f\u8a2d\u7f6e Restart Nginx \u8655\u7406\u7a0b\u5e8f\uff1a ansible-nginx-demo/playbook.yml handlers : - name : Restart Nginx service : name : nginx state : restarted \u904b\u884c\u5b8c\u6210\u7684\u5287\u672c \u00b6 \u5728 playbook \u6587\u4ef6\u4e2d\u5305\u542b\u6240\u6709\u5fc5\u9700\u7684\u4efb\u52d9\u5f8c\uff0c\u5b83\u5c07\u5982\u4e0b\u6240\u793a\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www app_root : html_demo_site-main tasks : - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u56e0\u70ba playbook \u9700\u8981 sudo \u624d\u80fd\u904b\u884c\uff0c\u6240\u4ee5\u6211\u5011\u9084\u5305\u62ec -K \u53c3\u6578\uff0c\u4ee5\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u9060\u7a0b\u7528\u6236\u7684 sudo \u5bc6\u78bc\uff1a $ ansible-playbook playbook.yml \u7d50\u679c: $ ansible-playbook playbook.yml PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and install Nginx] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Copy website files to the server's document root] ************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Nginx template] ****************************************************************************************************************************************************************** changed: [demo-vm] TASK [Enable new site] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Allow all access to tcp port 80] ******************************************************************************************************************************************************* changed: [demo-vm] RUNNING HANDLER [Restart Nginx] ************************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=7 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u7531\u65bc\u6211\u5011\u4f7f\u7528\u4e86Vagrant\u8207VirtualBox\u4f86\u555f\u52d5VM\uff0c\u9700\u8981\u5728 Vagrantfile \u88e1\u8a2d\u5b9a port-forward \u7684\u53c3\u6578: Vagrantfile Vagrant.configure(\"2\") do |config| config.vm.box = \"ubuntu/focal64\" config.vm.network \"forwarded_port\", guest: 80, host: 8080 end \u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f: $ vagrant reload \u5b8c\u6210\u5f8c\uff0c\u5982\u679c\u4f60\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684\u4e3b\u6a5f\u540d\u6216 IP \u5730\u5740(\u6211\u5011\u628a\u7db2\u7ad9\u6620\u5c04\u5230\u672c\u6a5f\u7684port: 8080): http://localhost:8080 \u4f60\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a \u7d50\u8ad6 \u00b6 \u606d\u559c\uff0c\u4f60\u5df2\u4f7f\u7528 Ansible \u6210\u529f\u5730\u5c07\u975c\u614b HTML \u7db2\u7ad9\u90e8\u7f72\u5230\u9060\u7a0b Nginx \u670d\u52d9\u5668\u3002 \u5982\u679c\u4f60\u5c0d\u6f14\u793a\u7db2\u7ad9\u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u9032\u884c\u4e86\u66f4\u6539\uff0c\u4f60\u53ef\u4ee5\u518d\u6b21\u904b\u884c playbook\uff0c\u8907\u88fd\u4efb\u52d9\u5c07\u78ba\u4fdd\u4efb\u4f55\u6587\u4ef6\u66f4\u6539\u90fd\u53cd\u6620\u5728\u9060\u7a0b\u4e3b\u6a5f\u4e2d\u3002\u56e0\u70ba Ansible \u5177\u6709\u51aa\u7b49\u884c\u70ba\uff0c\u6240\u4ee5\u591a\u6b21\u904b\u884c playbook \u4e0d\u6703\u89f8\u767c\u5df2\u7d93\u5c0d\u7cfb\u7d71\u9032\u884c\u7684\u66f4\u6539\u3002","title":"\u5982\u4f55\u4f7f\u7528Nginx\u90e8\u7f72\u975c\u614bHTML\u7db2\u7ad9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#ubuntu-2004-nginx-ansible-html","text":"\u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx \u5982\u679c\u4f60\u6b63\u5728\u95b1\u8b80\u672c\u7cfb\u5217\u7684\u6240\u6709\u90e8\u5206\uff0c\u90a3\u9ebc\u6b64\u6642\u4f60\u61c9\u8a72\u719f\u6089\u5b89\u88dd\u7cfb\u7d71\u5305\u3001\u61c9\u7528\u6a21\u677f\u548c\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f\u3002\u5728\u672c\u7cfb\u5217\u7684\u9019\u4e00\u90e8\u5206\u4e2d\uff0c\u4f60\u5c07\u4f7f\u7528\u5230\u76ee\u524d\u70ba\u6b62\u6240\u898b\u7684\u5167\u5bb9\u4f86\u5275\u5efa\u4e00\u500b playbook\uff0c\u8a72 playbook \u53ef\u4ee5\u81ea\u52d5\u8a2d\u7f6e Nginx \u670d\u52d9\u5668\u4ee5\u5728 Ubuntu 20.04 \u4e0a\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 (Nginx) \u4e0a\u4f7f\u7528 Ansible \u90e8\u7f72\u975c\u614b HTML \u7db2\u7ad9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_1","text":"\u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-nginx-demo\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-nginx-demo $ cd ansible-nginx-demo \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" }","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_2","text":"\u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u975c\u614b HTML \u7db2\u7ad9\uff0c\u9019\u662f \u5982\u4f55\u5728 HTML \u4e2d\u7de8\u78bc\u7cfb\u5217 \u7684\u6559\u5b78\u4e2d\u6240\u69cb\u5efa\u7684\u7db2\u7ad9\u3002\u9996\u5148\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f09\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a $ curl -L https://github.com/do-community/html_demo_site/archive/refs/heads/main.zip -o html_demo.zip % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0 100 385k 0 385k 0 0 316k 0 --:--:-- 0 :00:01 --:--:-- 316k \u4f60\u9700\u8981\u89e3\u58d3\u7e2e\u624d\u80fd\u89e3\u58d3\u7e2e\u6b64\u4e0b\u8f09\u7684\u5167\u5bb9\u3002\u70ba\u78ba\u4fdd\u4f60\u5df2\u5b89\u88dd\u6b64\u5de5\u5177\uff0c\u8acb\u904b\u884c\uff1a $ sudo apt install unzip \u7136\u5f8c\uff0c\u89e3\u58d3\u7e2e\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a unzip html_demo.zip \u9019\u5c07\u5728\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u4e0a\u5275\u5efa\u4e00\u500b\u540d\u70ba html_demo_site-main \u7684\u65b0\u76ee\u9304\u3002\u73fe\u5728\u5de5\u4f5c\u76ee\u9304\u7684\u7d50\u69cb\u5982\u4e0b\uff1a $ tree . . \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 html_demo_site-main \u2502 \u251c\u2500\u2500 about.html \u2502 \u251c\u2500\u2500 images \u2502 \u2502 \u251c\u2500\u2500 background.jpg \u2502 \u2502 \u251c\u2500\u2500 large-profile.jpg \u2502 \u2502 \u2514\u2500\u2500 small-profile.jpeg \u2502 \u251c\u2500\u2500 index.html \u2502 \u251c\u2500\u2500 LICENSE \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 html_demo.zip \u251c\u2500\u2500 inventory \u2514\u2500\u2500 Vagrantfile","title":"\u53d6\u5f97\u6f14\u793a\u7528\u7684\u975c\u614b\u7db2\u7ad9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#nginx","text":"\u73fe\u5728\u6211\u5011\u5c07\u8a2d\u7f6e\u914d\u7f6e\u9060\u7a0b Web \u670d\u52d9\u5668\u6240\u9700\u7684 Nginx \u8a2d\u5b9a\u6a21\u677f\u3002\u5728\u5de5\u4f5c\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\u593e\u4f86\u4fdd\u5b58\u5176\u5b83\u975e playbook \u7684\u6587\u4ef6\uff1a $ mkdir files \u7136\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba nginx.conf.j2 \u7684\u65b0\u6587\u4ef6\uff1a $ nano files/nginx.conf.j2 \u6b64\u6a21\u677f\u6587\u4ef6\u5305\u542b\u975c\u614b HTML \u7db2\u7ad9\u7684 Nginx \u670d\u52d9\u5668\u584a\u914d\u7f6e\u3002\u5b83\u4f7f\u7528\u4e09\u500b\u8b8a\u91cf\uff1a document_root \u3001 app_root \u548c server_name \u3002\u6211\u5011\u7a0d\u5f8c\u6703\u5728\u5275\u5efa playbook \u6642\u5b9a\u7fa9\u9019\u4e9b\u8b8a\u91cf\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u8907\u88fd\u5230\u4f60\u7684\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a nginx.conf.j2 server { listen 80; root {{ document_root }}/{{ app_root }}; index index.html index.htm; server_name {{ server_name }}; location / { default_type \"text/html\"; try_files $uri.html $uri $uri/ =404; } } \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002","title":"\u70ba Nginx \u7684\u914d\u7f6e\u5275\u5efa\u6a21\u677f"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#ansible-playbook","text":"\u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible \u5287\u672c\u4e26\u8a2d\u7f6e\u6211\u5011\u5728\u672c\u6559\u7a0b\u4e0a\u4e00\u90e8\u5206\u4e2d\u4f7f\u7528\u7684\u8b8a\u91cf\u3002\u6253\u958b\u4e00\u500b\u540d\u70ba playbook.yml \u7684\u65b0\u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u500b playbook \u5c07 hosts \u5b9a\u7fa9\u8a2d\u7f6e\u70ba all \u548c\u4e00\u500b become \u6307\u4ee4\u958b\u59cb\uff0c\u8a72\u6307\u4ee4\u544a\u8a34 Ansible \u9ed8\u8a8d\u4ee5 root \u7528\u6236\u8eab\u4efd\u904b\u884c\u6240\u6709\u4efb\u52d9\uff08\u8207\u4f7f\u7528 sudo \u624b\u52d5\u904b\u884c\u547d\u4ee4\u76f8\u540c\uff09\u3002 \u5728\u672c\u5287\u672c\u7684 var \u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e09\u500b\u8b8a\u91cf\uff1a server_name \u3001 document_root \u548c app_root \u3002\u9019\u4e9b\u8b8a\u91cf\u5728 Nginx \u914d\u7f6e\u6a21\u677f\u4e2d\u7528\u65bc\u8a2d\u7f6e\u6b64 Web \u670d\u52d9\u5668\u5c07\u97ff\u61c9\u7684\u57df\u540d\u6216 IP \u5730\u5740\uff0c\u4ee5\u53ca\u7db2\u7ad9\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u7684\u5b8c\u6574\u8def\u5f91\u3002\u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ansible_default_ipv4.address \u4e8b\u5be6\u8b8a\u91cf\uff0c\u56e0\u70ba\u5b83\u5305\u542b\u9060\u7a0b\u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c\u5b83\u5728 DNS \u670d\u52d9\u4e2d\u6b63\u78ba\u914d\u7f6e\u4e86\u4e00\u500b\u57df\u540d\u4ee5\u6307\u5411\u9019\u500b\u670d\u52d9\u5668\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www/html app_root : html_demo_site-main tasks : \u4f60\u53ef\u4ee5\u66ab\u6642\u4fdd\u6301\u6b64\u6587\u4ef6\u6253\u958b\u3002\u63a5\u4e0b\u4f86\u7684\u90e8\u5206\u5c07\u5f15\u5c0e\u4f60\u5b8c\u6210\u6240\u6709\u9700\u8981\u5305\u542b\u5728\u672c\u6559\u7a0b\u4e2d\u4ee5\u4f7f\u5176\u5b8c\u5168\u6b63\u5e38\u904b\u884c\u7684\u4efb\u52d9\u3002","title":"\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible playbook"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_3","text":"\u4ee5\u4e0b\u4efb\u52d9\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd nginx \u5305\uff1a ansible-nginx-demo/playbook.yml - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes","title":"\u5b89\u88dd\u6240\u9700\u7684\u8edf\u4ef6\u5305"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_4","text":"\u4e0b\u4e00\u500b\u4efb\u52d9\u5c07\u4f7f\u7528ansible copy \u5167\u7f6e\u6a21\u584a\u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u6587\u6a94\u6839\u76ee\u9304\u3002\u6211\u5011\u5c07\u4f7f\u7528 document_root \u8b8a\u91cf\u5728\u670d\u52d9\u5668\u4e0a\u8a2d\u7f6e\u61c9\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u6587\u4ef6\u593e\u7684\u76ee\u6a19\u3002 ansible-nginx-demo/playbook.yml - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve","title":"\u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u7bc0\u9ede"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#nginx_1","text":"\u6211\u5011\u73fe\u5728\u5c07\u61c9\u7528 Nginx \u6a21\u677f\uff0c\u8a72\u6a21\u677f\u5c07\u914d\u7f6e Web \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u4f60\u7684\u975c\u614b HTML \u6587\u4ef6\u3002\u5728 /etc/nginx/sites-available \u8a2d\u7f6e\u914d\u7f6e\u6587\u4ef6\u5f8c\uff0c\u6211\u5011\u5c07\u5728 /etc/nginx-sites-enabled \u4e2d\u5275\u5efa\u6307\u5411\u8a72\u6587\u4ef6\u7684\u7b26\u865f\u93c8\u63a5\uff0c\u4e26\u901a\u77e5 Nginx \u670d\u52d9\u4ee5\u9032\u884c\u5f8c\u7e8c\u91cd\u555f\u3002\u6574\u500b\u904e\u7a0b\u5c07\u9700\u8981\u5169\u500b\u55ae\u7368\u7684\u4efb\u52d9\uff1a ansible-nginx-demo/playbook.yml - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx","title":"\u61c9\u7528\u548c\u555f\u7528\u81ea\u5b9a\u7fa9 Nginx \u914d\u7f6e"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#ufw-80","text":"ufw \u7684\u5168\u540d\u662f Uncomplicated Firewall\uff0c\u610f\u601d\u662f\u4e0d\u8907\u96dc\u7684\u9632\u706b\u7246\u3002\u5b83\u7684\u6307\u4ee4\u4e0d\u4f46\u597d\u8a18\uff0c\u5beb\u597d\u7684\u898f\u5247\u4e5f\u6dfa\u986f\u6613\u61c2\uff0c\u4e0d\u6703\u50cf iptables \u7684\u88f9\u8173\u5e03\u53c8\u81ed\u53c8\u9577\u3002 ansible-nginx-demo/playbook.yml - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp","title":"\u5728 UFW \u4e0a\u5141\u8a31\u7aef\u53e3 80"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#nginx-handler","text":"\u8981\u5b8c\u6210\u9019\u500b\u5287\u672c\uff0c\u5269\u4e0b\u8981\u505a\u7684\u5c31\u662f\u8a2d\u7f6e Restart Nginx \u8655\u7406\u7a0b\u5e8f\uff1a ansible-nginx-demo/playbook.yml handlers : - name : Restart Nginx service : name : nginx state : restarted","title":"\u70ba Nginx \u670d\u52d9\u5275\u5efa Handler"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_5","text":"\u5728 playbook \u6587\u4ef6\u4e2d\u5305\u542b\u6240\u6709\u5fc5\u9700\u7684\u4efb\u52d9\u5f8c\uff0c\u5b83\u5c07\u5982\u4e0b\u6240\u793a\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www app_root : html_demo_site-main tasks : - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u56e0\u70ba playbook \u9700\u8981 sudo \u624d\u80fd\u904b\u884c\uff0c\u6240\u4ee5\u6211\u5011\u9084\u5305\u62ec -K \u53c3\u6578\uff0c\u4ee5\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u9060\u7a0b\u7528\u6236\u7684 sudo \u5bc6\u78bc\uff1a $ ansible-playbook playbook.yml \u7d50\u679c: $ ansible-playbook playbook.yml PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and install Nginx] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Copy website files to the server's document root] ************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Nginx template] ****************************************************************************************************************************************************************** changed: [demo-vm] TASK [Enable new site] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Allow all access to tcp port 80] ******************************************************************************************************************************************************* changed: [demo-vm] RUNNING HANDLER [Restart Nginx] ************************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=7 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u7531\u65bc\u6211\u5011\u4f7f\u7528\u4e86Vagrant\u8207VirtualBox\u4f86\u555f\u52d5VM\uff0c\u9700\u8981\u5728 Vagrantfile \u88e1\u8a2d\u5b9a port-forward \u7684\u53c3\u6578: Vagrantfile Vagrant.configure(\"2\") do |config| config.vm.box = \"ubuntu/focal64\" config.vm.network \"forwarded_port\", guest: 80, host: 8080 end \u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f: $ vagrant reload \u5b8c\u6210\u5f8c\uff0c\u5982\u679c\u4f60\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684\u4e3b\u6a5f\u540d\u6216 IP \u5730\u5740(\u6211\u5011\u628a\u7db2\u7ad9\u6620\u5c04\u5230\u672c\u6a5f\u7684port: 8080): http://localhost:8080 \u4f60\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a","title":"\u904b\u884c\u5b8c\u6210\u7684\u5287\u672c"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_6","text":"\u606d\u559c\uff0c\u4f60\u5df2\u4f7f\u7528 Ansible \u6210\u529f\u5730\u5c07\u975c\u614b HTML \u7db2\u7ad9\u90e8\u7f72\u5230\u9060\u7a0b Nginx \u670d\u52d9\u5668\u3002 \u5982\u679c\u4f60\u5c0d\u6f14\u793a\u7db2\u7ad9\u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u9032\u884c\u4e86\u66f4\u6539\uff0c\u4f60\u53ef\u4ee5\u518d\u6b21\u904b\u884c playbook\uff0c\u8907\u88fd\u4efb\u52d9\u5c07\u78ba\u4fdd\u4efb\u4f55\u6587\u4ef6\u66f4\u6539\u90fd\u53cd\u6620\u5728\u9060\u7a0b\u4e3b\u6a5f\u4e2d\u3002\u56e0\u70ba Ansible \u5177\u6709\u51aa\u7b49\u884c\u70ba\uff0c\u6240\u4ee5\u591a\u6b21\u904b\u884c playbook \u4e0d\u6703\u89f8\u767c\u5df2\u7d93\u5c0d\u7cfb\u7d71\u9032\u884c\u7684\u66f4\u6539\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial_playbook/how-to-install-and-manage-system-packages-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u5b89\u88dd\u548c\u7ba1\u7406\u7cfb\u7d71\u5305 \u00b6 \u81ea\u52d5\u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u662f Ansible playbook \u4e2d\u7684\u4e00\u9805\u5e38\u898b\u64cd\u4f5c\u4efb\u52d9\uff0c\u56e0\u70ba\u5178\u578b\u7684\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\u9700\u8981\u4f86\u81ea\u4e0d\u540c\u4f86\u6e90\u7684\u8edf\u4ef6\u3002 apt \u6a21\u584a\u7ba1\u7406\u57fa\u65bc Debian \u7684 Linux \u64cd\u4f5c\u7cfb\u7d71\uff08\u4f8b\u5982 Ubuntu\uff09\u4e0a\u7684\u7cfb\u7d71\u5305\uff0c\u9019\u662f\u6211\u5011\u5728\u672c\u6307\u5357\u4e2d\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u4f7f\u7528\u7684\u767c\u884c\u7248\u3002\u4ee5\u4e0b\u5287\u672c\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u78ba\u4fdd\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd\u4e86 Vim \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-09.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-09.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim is installed apt : name : vim update_cache : yes \u8acb\u6ce8\u610f\uff0c\u6211\u5011\u5728 playbook \u7684\u958b\u982d\u5305\u542b\u4e86 become \u6307\u4ee4\u3002\u9019\u662f\u5fc5\u9700\u7684\uff0c\u56e0\u70ba\u5b89\u88dd\u8edf\u4ef6\u5305\u9700\u8981\u7ba1\u7406\u7cfb\u7d71\u6b0a\u9650\u3002 \u522a\u9664\u5305\u7684\u65b9\u5f0f\u8207\u6b64\u985e\u4f3c\uff0c\u552f\u4e00\u7684\u8b8a\u5316\u662f\u60a8\u5fc5\u9808\u5c07\u5305\u72c0\u614b\u5b9a\u7fa9\u70ba\u4e0d\u5b58\u5728\u3002 state \u6307\u4ee4\u7684\u9ed8\u8a8d\u503c\u662f present \uff0c\u9019\u5c07\u78ba\u4fdd\u8edf\u4ef6\u5305\u5b89\u88dd\u5728\u7cfb\u7d71\u4e0a\uff0c\u7121\u8ad6\u7248\u672c\u5982\u4f55\u3002\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5c07\u5b89\u88dd\u8a72\u8edf\u4ef6\u5305\u3002\u70ba\u78ba\u4fdd\u60a8\u64c1\u6709\u6700\u65b0\u7248\u672c\u7684\u8edf\u4ef6\u5305\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 latest \u4ee3\u66ff\u3002\u5982\u679c\u8a72\u8edf\u4ef6\u5305\u4e0d\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u9019\u5c07\u5c0e\u81f4 apt \u66f4\u65b0\u8acb\u6c42\u7684\u8edf\u4ef6\u5305\u3002 \u8acb\u8a18\u4f4f\u5728\u904b\u884c\u6b64 playbook \u6642\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-09.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim is installed] ********************************************************************************************************************* ok: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5b89\u88dd\u591a\u500b\u5305\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 loop \u4e26\u63d0\u4f9b\u4e00\u500b\u9663\u5217\uff0c\u5176\u4e2d\u5305\u542b\u60a8\u8981\u5b89\u88dd\u7684\u5305\u7684\u540d\u7a31\u3002\u4ee5\u4e0b playbook \u5c07\u78ba\u4fdd\u5b89\u88dd\u5305 vim\u3001unzip \u548c curl \u4e26\u8655\u65bc\u6700\u65b0\u7248\u672c\u3002 \u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-10.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-10.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim, Curl and Unzip are installed apt : name : \"{{ item }}\" update_cache : yes loop : - vim - curl - unzip \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\uff0c\u4e26\u4e14\u4e0d\u8981\u5fd8\u8a18\u5305\u542b -K \u9078\u9805\uff0c\u56e0\u70ba\u6b64 playbook \u9700\u8981\u7ba1\u7406\u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-09.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim, Curl and Unzip are installed] **************************************************************************************************** ok: [demo-vm] => (item=vim) ok: [demo-vm] => (item=curl) changed: [demo-vm] => (item=unzip) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u95dc\u65bc\u5982\u4f55\u7ba1\u7406\u7cfb\u7d71\u5305\u7684\u66f4\u591a\u7d30\u7bc0\uff0c\u5305\u62ec\u5982\u4f55\u522a\u9664\u5305\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u9ad8\u7d1aapt\u9078\u9805\uff0c\u53ef\u4ee5\u53c3\u8003 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5b89\u88dd\u548c\u7ba1\u7406\u7cfb\u7d71\u5305"},{"location":"ansible/tutorial_playbook/how-to-install-and-manage-system-packages-in-ansible-playbooks/#ansible-playbooks","text":"\u81ea\u52d5\u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u662f Ansible playbook \u4e2d\u7684\u4e00\u9805\u5e38\u898b\u64cd\u4f5c\u4efb\u52d9\uff0c\u56e0\u70ba\u5178\u578b\u7684\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\u9700\u8981\u4f86\u81ea\u4e0d\u540c\u4f86\u6e90\u7684\u8edf\u4ef6\u3002 apt \u6a21\u584a\u7ba1\u7406\u57fa\u65bc Debian \u7684 Linux \u64cd\u4f5c\u7cfb\u7d71\uff08\u4f8b\u5982 Ubuntu\uff09\u4e0a\u7684\u7cfb\u7d71\u5305\uff0c\u9019\u662f\u6211\u5011\u5728\u672c\u6307\u5357\u4e2d\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u4f7f\u7528\u7684\u767c\u884c\u7248\u3002\u4ee5\u4e0b\u5287\u672c\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u78ba\u4fdd\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd\u4e86 Vim \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-09.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-09.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim is installed apt : name : vim update_cache : yes \u8acb\u6ce8\u610f\uff0c\u6211\u5011\u5728 playbook \u7684\u958b\u982d\u5305\u542b\u4e86 become \u6307\u4ee4\u3002\u9019\u662f\u5fc5\u9700\u7684\uff0c\u56e0\u70ba\u5b89\u88dd\u8edf\u4ef6\u5305\u9700\u8981\u7ba1\u7406\u7cfb\u7d71\u6b0a\u9650\u3002 \u522a\u9664\u5305\u7684\u65b9\u5f0f\u8207\u6b64\u985e\u4f3c\uff0c\u552f\u4e00\u7684\u8b8a\u5316\u662f\u60a8\u5fc5\u9808\u5c07\u5305\u72c0\u614b\u5b9a\u7fa9\u70ba\u4e0d\u5b58\u5728\u3002 state \u6307\u4ee4\u7684\u9ed8\u8a8d\u503c\u662f present \uff0c\u9019\u5c07\u78ba\u4fdd\u8edf\u4ef6\u5305\u5b89\u88dd\u5728\u7cfb\u7d71\u4e0a\uff0c\u7121\u8ad6\u7248\u672c\u5982\u4f55\u3002\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5c07\u5b89\u88dd\u8a72\u8edf\u4ef6\u5305\u3002\u70ba\u78ba\u4fdd\u60a8\u64c1\u6709\u6700\u65b0\u7248\u672c\u7684\u8edf\u4ef6\u5305\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 latest \u4ee3\u66ff\u3002\u5982\u679c\u8a72\u8edf\u4ef6\u5305\u4e0d\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u9019\u5c07\u5c0e\u81f4 apt \u66f4\u65b0\u8acb\u6c42\u7684\u8edf\u4ef6\u5305\u3002 \u8acb\u8a18\u4f4f\u5728\u904b\u884c\u6b64 playbook \u6642\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-09.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim is installed] ********************************************************************************************************************* ok: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5b89\u88dd\u591a\u500b\u5305\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 loop \u4e26\u63d0\u4f9b\u4e00\u500b\u9663\u5217\uff0c\u5176\u4e2d\u5305\u542b\u60a8\u8981\u5b89\u88dd\u7684\u5305\u7684\u540d\u7a31\u3002\u4ee5\u4e0b playbook \u5c07\u78ba\u4fdd\u5b89\u88dd\u5305 vim\u3001unzip \u548c curl \u4e26\u8655\u65bc\u6700\u65b0\u7248\u672c\u3002 \u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-10.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-10.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim, Curl and Unzip are installed apt : name : \"{{ item }}\" update_cache : yes loop : - vim - curl - unzip \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\uff0c\u4e26\u4e14\u4e0d\u8981\u5fd8\u8a18\u5305\u542b -K \u9078\u9805\uff0c\u56e0\u70ba\u6b64 playbook \u9700\u8981\u7ba1\u7406\u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-09.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim, Curl and Unzip are installed] **************************************************************************************************** ok: [demo-vm] => (item=vim) ok: [demo-vm] => (item=curl) changed: [demo-vm] => (item=unzip) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u95dc\u65bc\u5982\u4f55\u7ba1\u7406\u7cfb\u7d71\u5305\u7684\u66f4\u591a\u7d30\u7bc0\uff0c\u5305\u62ec\u5982\u4f55\u522a\u9664\u5305\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u9ad8\u7d1aapt\u9078\u9805\uff0c\u53ef\u4ee5\u53c3\u8003 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u5b89\u88dd\u548c\u7ba1\u7406\u7cfb\u7d71\u5305"},{"location":"ansible/tutorial_playbook/how-to-use-conditionals-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 ansible-playbooks \u4e2d\u4f7f\u7528\u689d\u4ef6 \u00b6 \u5728 Ansible\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u5728\u57f7\u884c\u4efb\u52d9\u4e4b\u524d\u8981\u6eff\u8db3\u7684\u689d\u4ef6\u3002\u5982\u679c\u689d\u4ef6\u4e0d\u6eff\u8db3\uff0c\u5247\u8df3\u904e\u8a72\u4efb\u52d9\u3002\u9019\u662f\u901a\u904e when \u95dc\u9375\u5b57\u5b8c\u6210\u7684\uff0c\u5b83\u63a5\u53d7\u901a\u5e38\u57fa\u65bc \u8b8a\u91cf \u6216 \u4e8b\u5be6 \u7684\u8868\u9054\u5f0f\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u5169\u500b\u8b8a\u91cf\uff1a create_user_file \u548c user \u3002\u7576 create_user_file \u88ab\u8a55\u4f30\u70ba true \u6642\uff0c\u5c07\u5728 user \u8b8a\u91cf\u5b9a\u7fa9\u7684\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff1a \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-04.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : yes - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u8981\u5f9e\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u672c\u7cfb\u5217\u4e2d\u7684\u5176\u4ed6 playbook \u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-04.yml \u7576\u6eff\u8db3\u689d\u4ef6\u6642 (create_user_file\uff1dtrue)\uff0c\u60a8\u5c07\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u66f4\u6539\u7684\u72c0\u614b\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u5c07 create_user_file \u7684\u503c\u66f4\u6539\u70ba no \uff0c\u5247\u689d\u4ef6\u5c07\u88ab\u8a55\u4f30\u70ba false \u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u6703\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u8df3\u904e\u72c0\u614b\uff0c\u8868\u793a\u4efb\u52d9\u672a\u57f7\u884c\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : no - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u518d\u57f7\u884c\u4e00\u6b21 playbook: $ ansible-playbook -i inventory playbook-04.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=1 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5728 Ansible playbook \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u689d\u4ef6\u8a9e\u53e5\u7684\u4e00\u500b\u5e38\u898b\u7528\u9014\u662f\u5c07\u5b83\u5011\u8207 register \u7d50\u5408\uff0c\u9019\u662f\u4e00\u500b\u5275\u5efa\u65b0\u8b8a\u91cf\u4e26\u5c07\u5176\u5206\u914d\u7d66\u5f9e\u547d\u4ee4\u7372\u5f97\u7684\u8f38\u51fa\u7684\u95dc\u9375\u5b57\u3002\u9019\u6a23\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u5916\u90e8\u547d\u4ee4\u4f86\u8a55\u4f30\u4efb\u52d9\u7684\u57f7\u884c\u3002 \u9700\u8981\u6ce8\u610f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u60a8\u7528\u65bc\u8a55\u4f30\u689d\u4ef6\u7684\u547d\u4ee4\u5931\u6557\uff0cAnsible \u5c07\u4e2d\u65b7\u64ad\u653e\u3002\u51fa\u65bc\u9019\u500b\u539f\u56e0\uff0c\u60a8\u9700\u8981\u5728\u6240\u8ff0\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b\u8a2d\u7f6e\u70ba yes \u7684 ignore_errors \u6307\u4ee4\uff0c\u9019\u5c07\u4f7f Ansible \u7e7c\u7e8c\u57f7\u884c\u4e0b\u4e00\u500b\u4efb\u52d9\u4e26\u7e7c\u7e8c\u64ad\u653e\u3002 \u4ee5\u4e0b\u793a\u4f8b\u53ea\u6703\u5728\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff0c\u4ee5\u9632\u8a72\u6587\u4ef6\u5c1a\u4e0d\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ls \u547d\u4ee4\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u4f46\u662f\uff0c\u5982\u679c\u6587\u4ef6\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 debug \u6a21\u584a\u986f\u793a\u4e00\u689d\u6d88\u606f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-05.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-05.yml --- - hosts : all vars : - user : vagrant tasks : - name : Check if file already exists command : ls /home/{{ user }}/myfile register : file_exists ignore_errors : yes - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : file_exists is failed - name : show message if file exists debug : msg : The user file already exists. when : file_exists is succeeded \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7b2c\u4e00\u6b21\u904b\u884c\u6b64 playbook \u6642\uff0c\u547d\u4ee4 Check if file already exists \u5c07\u5931\u6557\uff0c\u56e0\u70ba\u8a72\u6587\u4ef6\u4e0d\u5b58\u5728\u65bc\u8a72\u8def\u5f91\u4e2d\u3002\u7136\u5f8c\u5c07\u57f7\u884c create file for user \u5275\u5efa\u6587\u4ef6\u7684\u4efb\u52d9\uff0c\u800c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9 show message if file exists \u5c07\u88ab\u8df3\u904e\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** fatal: [demo-vm]: FAILED! => {\"changed\": true, \"cmd\": [\"ls\", \"/home/vagrant/myfile\"], \"delta\": \"0:00:00.002623\", \"end\": \"2022-06-08 23:00:34.377372\", \"msg\": \"non-zero return code\", \"rc\": 2, \"start\": \"2022-06-08 23:00:34.374749\", \"stderr\": \"ls: cannot access '/home/vagrant/myfile': No such file or directory\", \"stderr_lines\": [\"ls: cannot access '/home/vagrant/myfile': No such file or directory\"], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=1 rescued=0 ignored=1 \u5f9e\u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 create file for user \u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u8b8a\u5316\uff0c\u9019\u610f\u5473\u8457\u6587\u4ef6\u5df2\u5275\u5efa\u3002\u73fe\u5728\uff0c\u518d\u6b21\u904b\u884c playbook\uff0c\u4f60\u6703\u5f97\u5230\u4e0d\u540c\u7684\u7d50\u679c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** changed: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"The user file already exists.\" } PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=1 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5982\u679c\u60a8\u60f3\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u689d\u4ef6\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u4f7f\u7528\u689d\u4ef6"},{"location":"ansible/tutorial_playbook/how-to-use-conditionals-in-ansible-playbooks/#ansible-playbooks","text":"\u5728 Ansible\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u5728\u57f7\u884c\u4efb\u52d9\u4e4b\u524d\u8981\u6eff\u8db3\u7684\u689d\u4ef6\u3002\u5982\u679c\u689d\u4ef6\u4e0d\u6eff\u8db3\uff0c\u5247\u8df3\u904e\u8a72\u4efb\u52d9\u3002\u9019\u662f\u901a\u904e when \u95dc\u9375\u5b57\u5b8c\u6210\u7684\uff0c\u5b83\u63a5\u53d7\u901a\u5e38\u57fa\u65bc \u8b8a\u91cf \u6216 \u4e8b\u5be6 \u7684\u8868\u9054\u5f0f\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u5169\u500b\u8b8a\u91cf\uff1a create_user_file \u548c user \u3002\u7576 create_user_file \u88ab\u8a55\u4f30\u70ba true \u6642\uff0c\u5c07\u5728 user \u8b8a\u91cf\u5b9a\u7fa9\u7684\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff1a \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-04.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : yes - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u8981\u5f9e\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u672c\u7cfb\u5217\u4e2d\u7684\u5176\u4ed6 playbook \u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-04.yml \u7576\u6eff\u8db3\u689d\u4ef6\u6642 (create_user_file\uff1dtrue)\uff0c\u60a8\u5c07\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u66f4\u6539\u7684\u72c0\u614b\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u5c07 create_user_file \u7684\u503c\u66f4\u6539\u70ba no \uff0c\u5247\u689d\u4ef6\u5c07\u88ab\u8a55\u4f30\u70ba false \u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u6703\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u8df3\u904e\u72c0\u614b\uff0c\u8868\u793a\u4efb\u52d9\u672a\u57f7\u884c\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : no - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u518d\u57f7\u884c\u4e00\u6b21 playbook: $ ansible-playbook -i inventory playbook-04.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=1 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5728 Ansible playbook \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u689d\u4ef6\u8a9e\u53e5\u7684\u4e00\u500b\u5e38\u898b\u7528\u9014\u662f\u5c07\u5b83\u5011\u8207 register \u7d50\u5408\uff0c\u9019\u662f\u4e00\u500b\u5275\u5efa\u65b0\u8b8a\u91cf\u4e26\u5c07\u5176\u5206\u914d\u7d66\u5f9e\u547d\u4ee4\u7372\u5f97\u7684\u8f38\u51fa\u7684\u95dc\u9375\u5b57\u3002\u9019\u6a23\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u5916\u90e8\u547d\u4ee4\u4f86\u8a55\u4f30\u4efb\u52d9\u7684\u57f7\u884c\u3002 \u9700\u8981\u6ce8\u610f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u60a8\u7528\u65bc\u8a55\u4f30\u689d\u4ef6\u7684\u547d\u4ee4\u5931\u6557\uff0cAnsible \u5c07\u4e2d\u65b7\u64ad\u653e\u3002\u51fa\u65bc\u9019\u500b\u539f\u56e0\uff0c\u60a8\u9700\u8981\u5728\u6240\u8ff0\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b\u8a2d\u7f6e\u70ba yes \u7684 ignore_errors \u6307\u4ee4\uff0c\u9019\u5c07\u4f7f Ansible \u7e7c\u7e8c\u57f7\u884c\u4e0b\u4e00\u500b\u4efb\u52d9\u4e26\u7e7c\u7e8c\u64ad\u653e\u3002 \u4ee5\u4e0b\u793a\u4f8b\u53ea\u6703\u5728\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff0c\u4ee5\u9632\u8a72\u6587\u4ef6\u5c1a\u4e0d\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ls \u547d\u4ee4\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u4f46\u662f\uff0c\u5982\u679c\u6587\u4ef6\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 debug \u6a21\u584a\u986f\u793a\u4e00\u689d\u6d88\u606f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-05.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-05.yml --- - hosts : all vars : - user : vagrant tasks : - name : Check if file already exists command : ls /home/{{ user }}/myfile register : file_exists ignore_errors : yes - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : file_exists is failed - name : show message if file exists debug : msg : The user file already exists. when : file_exists is succeeded \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7b2c\u4e00\u6b21\u904b\u884c\u6b64 playbook \u6642\uff0c\u547d\u4ee4 Check if file already exists \u5c07\u5931\u6557\uff0c\u56e0\u70ba\u8a72\u6587\u4ef6\u4e0d\u5b58\u5728\u65bc\u8a72\u8def\u5f91\u4e2d\u3002\u7136\u5f8c\u5c07\u57f7\u884c create file for user \u5275\u5efa\u6587\u4ef6\u7684\u4efb\u52d9\uff0c\u800c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9 show message if file exists \u5c07\u88ab\u8df3\u904e\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** fatal: [demo-vm]: FAILED! => {\"changed\": true, \"cmd\": [\"ls\", \"/home/vagrant/myfile\"], \"delta\": \"0:00:00.002623\", \"end\": \"2022-06-08 23:00:34.377372\", \"msg\": \"non-zero return code\", \"rc\": 2, \"start\": \"2022-06-08 23:00:34.374749\", \"stderr\": \"ls: cannot access '/home/vagrant/myfile': No such file or directory\", \"stderr_lines\": [\"ls: cannot access '/home/vagrant/myfile': No such file or directory\"], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=1 rescued=0 ignored=1 \u5f9e\u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 create file for user \u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u8b8a\u5316\uff0c\u9019\u610f\u5473\u8457\u6587\u4ef6\u5df2\u5275\u5efa\u3002\u73fe\u5728\uff0c\u518d\u6b21\u904b\u884c playbook\uff0c\u4f60\u6703\u5f97\u5230\u4e0d\u540c\u7684\u7d50\u679c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** changed: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"The user file already exists.\" } PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=1 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5982\u679c\u60a8\u60f3\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u689d\u4ef6\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 ansible-playbooks \u4e2d\u4f7f\u7528\u689d\u4ef6"},{"location":"ansible/tutorial_playbook/how-to-use-loops-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u5faa\u74b0 \u00b6 \u5728\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u6642\uff0c\u6709\u6642\u60a8\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u503c\u91cd\u8907\u57f7\u884c\u76f8\u540c\u7684\u4efb\u52d9\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u6539\u591a\u500b\u6587\u4ef6\u7684\u6b0a\u9650\uff0c\u6216\u5275\u5efa\u591a\u500b\u7528\u6236\u3002\u70ba\u907f\u514d\u5728 playbook \u6587\u4ef6\u4e2d\u591a\u6b21\u91cd\u8907\u8a72\u4efb\u52d9\uff0c\u6700\u597d\u4f7f\u7528 loop \u3002 \u5728\u7de8\u7a0b\u4e2d\uff0c loop \u5141\u8a31\u60a8\u91cd\u8907\u6307\u4ee4\uff0c\u901a\u5e38\u76f4\u5230\u6eff\u8db3\u67d0\u500b\u689d\u4ef6\u3002 Ansible \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u5faa\u74b0\u65b9\u6cd5\uff0c\u5176\u4e2d loop \u95dc\u9375\u5b57\u662f\u9577\u671f\u517c\u5bb9\u6027\u6700\u63a8\u85a6\u7684\u9078\u9805\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5728 /tmp \u76ee\u9304\u4e0b\u8981\u5275\u5efa\u4e09\u500b\u4e0d\u540c\u7684\u6587\u4ef6\u3002\u5b83\u5728\u4f7f\u7528\u4e09\u500b\u4e0d\u540c\u503c\u5be6\u73fe\u5faa\u74b0\u7684\u4efb\u52d9\u4e2d\u4f7f\u7528\u6587\u4ef6\u6a21\u584a\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-06.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-06.yml --- - hosts : all tasks : - name : creates users files file : path : /tmp/ansible-{{ item }} state : touch loop : - sammy - erika - brian \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-06.yml \u4f60\u6703\u5f97\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u986f\u793a\u5faa\u74b0\u4e2d\u4f7f\u7528\u7684\u6bcf\u500b\u55ae\u7368\u7684\u9805\u76ee\u503c\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [creates user files] ************************************************************************************************************************************************** changed: [demo-vm] => (item=sammy) changed: [demo-vm] => (item=erika) changed: [demo-vm] => (item=brain) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6709\u95dc\u5728\u7de8\u5beb Ansible playbook \u6642\u5982\u4f55\u4f7f\u7528\u5faa\u74b0\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u4f7f\u7528\u5faa\u74b0"},{"location":"ansible/tutorial_playbook/how-to-use-loops-in-ansible-playbooks/#ansible-playbook","text":"\u5728\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u6642\uff0c\u6709\u6642\u60a8\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u503c\u91cd\u8907\u57f7\u884c\u76f8\u540c\u7684\u4efb\u52d9\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u6539\u591a\u500b\u6587\u4ef6\u7684\u6b0a\u9650\uff0c\u6216\u5275\u5efa\u591a\u500b\u7528\u6236\u3002\u70ba\u907f\u514d\u5728 playbook \u6587\u4ef6\u4e2d\u591a\u6b21\u91cd\u8907\u8a72\u4efb\u52d9\uff0c\u6700\u597d\u4f7f\u7528 loop \u3002 \u5728\u7de8\u7a0b\u4e2d\uff0c loop \u5141\u8a31\u60a8\u91cd\u8907\u6307\u4ee4\uff0c\u901a\u5e38\u76f4\u5230\u6eff\u8db3\u67d0\u500b\u689d\u4ef6\u3002 Ansible \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u5faa\u74b0\u65b9\u6cd5\uff0c\u5176\u4e2d loop \u95dc\u9375\u5b57\u662f\u9577\u671f\u517c\u5bb9\u6027\u6700\u63a8\u85a6\u7684\u9078\u9805\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5728 /tmp \u76ee\u9304\u4e0b\u8981\u5275\u5efa\u4e09\u500b\u4e0d\u540c\u7684\u6587\u4ef6\u3002\u5b83\u5728\u4f7f\u7528\u4e09\u500b\u4e0d\u540c\u503c\u5be6\u73fe\u5faa\u74b0\u7684\u4efb\u52d9\u4e2d\u4f7f\u7528\u6587\u4ef6\u6a21\u584a\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-06.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-06.yml --- - hosts : all tasks : - name : creates users files file : path : /tmp/ansible-{{ item }} state : touch loop : - sammy - erika - brian \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-06.yml \u4f60\u6703\u5f97\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u986f\u793a\u5faa\u74b0\u4e2d\u4f7f\u7528\u7684\u6bcf\u500b\u55ae\u7368\u7684\u9805\u76ee\u503c\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [creates user files] ************************************************************************************************************************************************** changed: [demo-vm] => (item=sammy) changed: [demo-vm] => (item=erika) changed: [demo-vm] => (item=brain) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6709\u95dc\u5728\u7de8\u5beb Ansible playbook \u6642\u5982\u4f55\u4f7f\u7528\u5faa\u74b0\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u5faa\u74b0"},{"location":"ansible/tutorial_playbook/how-to-use-variables-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u8b8a\u91cf \u00b6 Ansible \u652f\u6301\u4f7f\u7528 \u8b8a\u91cf \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u548c\u5287\u672c\u7684\u57f7\u884c\u3002\u9019\u6a23\uff0c\u5c31\u53ef\u4ee5\u5c07\u540c\u4e00\u5287\u672c\u7528\u65bc\u4e0d\u540c\u7684\u76ee\u6a19\u548c\u74b0\u5883\u3002 \u8b8a\u91cf \u53ef\u4ee5\u4f86\u81ea\u4e0d\u540c\u7684\u4f86\u6e90\uff0c\u4f8b\u5982\u5287\u672c\u6587\u4ef6\u672c\u8eab\u6216\u5287\u672c\u4e2d\u5c0e\u5165\u7684\u5916\u90e8\u8b8a\u91cf\u6587\u4ef6\u3002\u7576\u4f7f\u7528\u5b9a\u7fa9\u540c\u540d\u8b8a\u91cf\u7684\u591a\u500b\u8b8a\u91cf\u6e90\u6642\uff0c\u5c07\u61c9\u7528\u7279\u6b8a\u512a\u5148\u7d1a\u898f\u5247\u3002 \u70ba\u4e86\u4e86\u89e3\u8b8a\u91cf\u5728\u5be6\u8e10\u4e2d\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6e2c\u8a66 playbook\uff0c\u5b83\u5c07\u6253\u5370\u5169\u500b\u8b8a\u91cf\u7684\u503c\uff0c username \u548c home_dir \u3002\u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-02.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-02.yml --- - hosts: all vars: - username: vagrant - home: /home/vagrant tasks: - name: print variables debug: msg: \"Username: {{ username }}, Home dir: {{ home }}\" playbook \u7684 vars \u90e8\u5206\u5b9a\u7fa9\u4e86\u5c07\u5728\u8a72 play \u7bc4\u570d\u5167\u8981\u6ce8\u5165\u7684\u8b8a\u91cf\u5217\u8868\u3002\u6240\u6709\u4efb\u52d9\u4ee5\u53ca\u53ef\u80fd\u5305\u542b\u5728 playbook \u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u6216\u6a21\u677f\u90fd\u53ef\u4ee5\u8a2a\u554f\u9019\u4e9b\u8b8a\u91cf\u3002 \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a ansible-playbook -i inventory playbook-02.yml \u7d50\u679c: PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [print variables] *********************************************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"Username: vagrant, Home dir: /home/vagrant\" } PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6253\u5370\u8b8a\u91cf\u4efb\u52d9\u5c07\u4f7f\u7528\u8abf\u8a66\u6a21\u584a\u6253\u5370\u6211\u5011\u5728\u5287\u672c\u7684 vars \u5340\u584a\u4e2d\u5b9a\u7fa9\u7684\u5169\u500b\u8b8a\u91cf\u7684\u503c\u3002","title":"\u5982\u4f55\u4f7f\u7528\u8b8a\u91cf"},{"location":"ansible/tutorial_playbook/how-to-use-variables-in-ansible-playbooks/#ansible-playbook","text":"Ansible \u652f\u6301\u4f7f\u7528 \u8b8a\u91cf \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u548c\u5287\u672c\u7684\u57f7\u884c\u3002\u9019\u6a23\uff0c\u5c31\u53ef\u4ee5\u5c07\u540c\u4e00\u5287\u672c\u7528\u65bc\u4e0d\u540c\u7684\u76ee\u6a19\u548c\u74b0\u5883\u3002 \u8b8a\u91cf \u53ef\u4ee5\u4f86\u81ea\u4e0d\u540c\u7684\u4f86\u6e90\uff0c\u4f8b\u5982\u5287\u672c\u6587\u4ef6\u672c\u8eab\u6216\u5287\u672c\u4e2d\u5c0e\u5165\u7684\u5916\u90e8\u8b8a\u91cf\u6587\u4ef6\u3002\u7576\u4f7f\u7528\u5b9a\u7fa9\u540c\u540d\u8b8a\u91cf\u7684\u591a\u500b\u8b8a\u91cf\u6e90\u6642\uff0c\u5c07\u61c9\u7528\u7279\u6b8a\u512a\u5148\u7d1a\u898f\u5247\u3002 \u70ba\u4e86\u4e86\u89e3\u8b8a\u91cf\u5728\u5be6\u8e10\u4e2d\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6e2c\u8a66 playbook\uff0c\u5b83\u5c07\u6253\u5370\u5169\u500b\u8b8a\u91cf\u7684\u503c\uff0c username \u548c home_dir \u3002\u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-02.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-02.yml --- - hosts: all vars: - username: vagrant - home: /home/vagrant tasks: - name: print variables debug: msg: \"Username: {{ username }}, Home dir: {{ home }}\" playbook \u7684 vars \u90e8\u5206\u5b9a\u7fa9\u4e86\u5c07\u5728\u8a72 play \u7bc4\u570d\u5167\u8981\u6ce8\u5165\u7684\u8b8a\u91cf\u5217\u8868\u3002\u6240\u6709\u4efb\u52d9\u4ee5\u53ca\u53ef\u80fd\u5305\u542b\u5728 playbook \u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u6216\u6a21\u677f\u90fd\u53ef\u4ee5\u8a2a\u554f\u9019\u4e9b\u8b8a\u91cf\u3002 \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a ansible-playbook -i inventory playbook-02.yml \u7d50\u679c: PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [print variables] *********************************************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"Username: vagrant, Home dir: /home/vagrant\" } PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6253\u5370\u8b8a\u91cf\u4efb\u52d9\u5c07\u4f7f\u7528\u8abf\u8a66\u6a21\u584a\u6253\u5370\u6211\u5011\u5728\u5287\u672c\u7684 vars \u5340\u584a\u4e2d\u5b9a\u7fa9\u7684\u5169\u500b\u8b8a\u91cf\u7684\u503c\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u8b8a\u91cf"},{"location":"ansible/tutorial_playbook/understanding-privilege-escalation-in-ansible-playbooks/","text":"\u4e86\u89e3 Ansible Playbook \u4e2d\u7684\u6b0a\u9650\u63d0\u5347 \u00b6 \u5c31\u50cf\u60a8\u5728\u7d42\u7aef\u4e0a\u57f7\u884c\u7684\u5e38\u898f\u547d\u4ee4\u4e00\u6a23\uff0c\u67d0\u4e9b\u4efb\u52d9\u9700\u8981\u7279\u6b8a\u6b0a\u9650\u624d\u80fd\u8b93 Ansible \u5728\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4e0a\u6210\u529f\u57f7\u884c\u5b83\u5011\u3002 \u4e86\u89e3\u6b0a\u9650\u63d0\u6607\u5728 Ansible \u4e2d\u7684\u5de5\u4f5c\u539f\u7406\u975e\u5e38\u91cd\u8981\uff0c\u9019\u6a23\u60a8\u5c31\u53ef\u4ee5\u4f7f\u7528\u9069\u7576\u7684\u6b0a\u9650\u57f7\u884c\u4efb\u52d9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4efb\u52d9\u5c07\u4ee5\u9023\u63a5\u7528\u6236\u8eab\u4efd\u904b\u884c - \u9019\u53ef\u80fd\u662f root \u6216\u4efb\u4f55\u5177\u6709 SSH \u8a2a\u554f\u6e05\u55ae\u6587\u4ef6\u4e2d\u9060\u7a0b\u7bc0\u9ede\u7684\u5e38\u898f\u7528\u6236\u3002 \u8981\u904b\u884c\u5177\u6709\u64f4\u5c55\u6b0a\u9650\u7684\u547d\u4ee4\uff0c\u4f8b\u5982\u9700\u8981 sudo \u7684\u547d\u4ee4\uff0c\u60a8\u9700\u8981\u5728 playbook \u4e2d\u5305\u542b\u8a2d\u5b9a become \u6307\u4ee4\u3002\u9019\u53ef\u4ee5\u4f5c\u70ba\u5c0d\u8a72 playbook \u4e2d\u6240\u6709\u4efb\u52d9\u6709\u6548\u7684\u5168\u5c40\u8a2d\u7f6e\u4f86\u5b8c\u6210\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba\u6bcf\u500b\u4efb\u52d9\u61c9\u7528\u7684\u55ae\u7368\u6307\u4ee4\u4f86\u5b8c\u6210\u3002\u6839\u64da\u60a8\u7684 sudo \u7528\u6236\u5728\u9060\u7a0b\u7bc0\u9ede\u4e2d\u7684\u8a2d\u7f6e\u65b9\u5f0f\uff0c\u60a8\u53ef\u80fd\u9084\u9700\u8981\u63d0\u4f9b\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002\u4ee5\u4e0b\u793a\u4f8b\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u9019\u662f\u4e00\u9805\u9700\u8981 root \u6b0a\u9650\u7684\u4efb\u52d9\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-07.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-07.yml --- - hosts : all become : yes tasks : - name : Update apt cache apt : update_cache : yes \u8981\u904b\u884c\u9019\u500b playbook\uff0c\u60a8\u9700\u8981\u5728 ansible-playbook \u547d\u4ee4\u4e2d\u5305\u542b -K \u9078\u9805\u3002\u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u6307\u5b9a\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002 $ ansible-playbook -i inventory playbook-07.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u60a8\u9084\u53ef\u4ee5\u5728\u57f7\u884c\u4efb\u52d9\u6216\u64ad\u653e\u6642\u66f4\u6539\u8981\u5207\u63db\u5230\u7684\u7528\u6236\u3002\u70ba\u6b64\uff0c\u8acb\u5c07 become_user \u6307\u4ee4\u8a2d\u7f6e\u70ba\u60a8\u8981\u5207\u63db\u5230\u7684\u9060\u7a0b\u7528\u6236\u7684\u540d\u7a31\u3002\u7576\u60a8\u5728 playbook \u4e2d\u6709\u591a\u500b\u4f9d\u8cf4 sudo \u7684\u4efb\u52d9\u6642\uff0c\u9019\u5f88\u6709\u7528\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u4efb\u52d9\u61c9\u8a72\u4f5c\u70ba\u60a8\u7684\u666e\u901a\u7528\u6236\u904b\u884c\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u672c\u6b21\u64ad\u653e\u4e2d\u7684\u6240\u6709\u4efb\u52d9\u9ed8\u8a8d\u4f7f\u7528 sudo \u57f7\u884c\u3002\u9019\u662f\u5728\u64ad\u653e\u7d1a\u5225\u8a2d\u7f6e\u7684\uff0c\u5c31\u5728\u4e3b\u6a5f\u5b9a\u7fa9\u4e4b\u5f8c\u3002\u7b2c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 root \u6b0a\u9650\u5728 /tmp \u4e0a\u5275\u5efa\u4e00\u500b\u6587\u4ef6\uff0c\u56e0\u70ba\u9019\u662f\u9ed8\u8a8d\u7684 become_user \u503c\u3002\u7136\u800c\uff0c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u5b9a\u7fa9\u4e86\u5b83\u81ea\u5df1\u7684 become_user \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-08.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-08.yml --- - hosts : all become : yes vars : user : \"{{ ansible_env.USER }}\" tasks : - name : Create root file file : path : /tmp/my_file_root state : touch - name : Create user file become_user : \"{{ user }}\" file : path : /tmp/my_file_{{ user }} state : touch ansible_env.USER \u7684\u4e8b\u5be6(fact)\u5305\u542b\u9023\u63a5\u7528\u6236\u7684\u7528\u6236\u540d\uff0c\u53ef\u4ee5\u5728\u4f7f\u7528 -u \u9078\u9805\u904b\u884c ansible-playbook \u547d\u4ee4\u6642\u5728\u57f7\u884c\u6642\u5b9a\u7fa9\u3002\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u4ee5 vagrant \u7684\u8eab\u4efd\u9032\u884c\u9023\u63a5\uff1a $ ansible-playbook -i inventory playbook-08.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Create root file] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Create user file] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u8b93\u6211\u5011\u767b\u5165\u5230\u9019\u53f0VM\u53bb\u9a57\u8b49: $ vagrant ssh $ ls -la /tmp/my_file* -rw-r--r-- 1 root root 0 Jun 9 23 :37 /tmp/my_file_root \u6709\u95dc Ansible \u4e2d\u6b0a\u9650\u63d0\u5347\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u4e86\u89e3\u6b0a\u9650\u63d0\u5347"},{"location":"ansible/tutorial_playbook/understanding-privilege-escalation-in-ansible-playbooks/#ansible-playbook","text":"\u5c31\u50cf\u60a8\u5728\u7d42\u7aef\u4e0a\u57f7\u884c\u7684\u5e38\u898f\u547d\u4ee4\u4e00\u6a23\uff0c\u67d0\u4e9b\u4efb\u52d9\u9700\u8981\u7279\u6b8a\u6b0a\u9650\u624d\u80fd\u8b93 Ansible \u5728\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4e0a\u6210\u529f\u57f7\u884c\u5b83\u5011\u3002 \u4e86\u89e3\u6b0a\u9650\u63d0\u6607\u5728 Ansible \u4e2d\u7684\u5de5\u4f5c\u539f\u7406\u975e\u5e38\u91cd\u8981\uff0c\u9019\u6a23\u60a8\u5c31\u53ef\u4ee5\u4f7f\u7528\u9069\u7576\u7684\u6b0a\u9650\u57f7\u884c\u4efb\u52d9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4efb\u52d9\u5c07\u4ee5\u9023\u63a5\u7528\u6236\u8eab\u4efd\u904b\u884c - \u9019\u53ef\u80fd\u662f root \u6216\u4efb\u4f55\u5177\u6709 SSH \u8a2a\u554f\u6e05\u55ae\u6587\u4ef6\u4e2d\u9060\u7a0b\u7bc0\u9ede\u7684\u5e38\u898f\u7528\u6236\u3002 \u8981\u904b\u884c\u5177\u6709\u64f4\u5c55\u6b0a\u9650\u7684\u547d\u4ee4\uff0c\u4f8b\u5982\u9700\u8981 sudo \u7684\u547d\u4ee4\uff0c\u60a8\u9700\u8981\u5728 playbook \u4e2d\u5305\u542b\u8a2d\u5b9a become \u6307\u4ee4\u3002\u9019\u53ef\u4ee5\u4f5c\u70ba\u5c0d\u8a72 playbook \u4e2d\u6240\u6709\u4efb\u52d9\u6709\u6548\u7684\u5168\u5c40\u8a2d\u7f6e\u4f86\u5b8c\u6210\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba\u6bcf\u500b\u4efb\u52d9\u61c9\u7528\u7684\u55ae\u7368\u6307\u4ee4\u4f86\u5b8c\u6210\u3002\u6839\u64da\u60a8\u7684 sudo \u7528\u6236\u5728\u9060\u7a0b\u7bc0\u9ede\u4e2d\u7684\u8a2d\u7f6e\u65b9\u5f0f\uff0c\u60a8\u53ef\u80fd\u9084\u9700\u8981\u63d0\u4f9b\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002\u4ee5\u4e0b\u793a\u4f8b\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u9019\u662f\u4e00\u9805\u9700\u8981 root \u6b0a\u9650\u7684\u4efb\u52d9\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-07.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-07.yml --- - hosts : all become : yes tasks : - name : Update apt cache apt : update_cache : yes \u8981\u904b\u884c\u9019\u500b playbook\uff0c\u60a8\u9700\u8981\u5728 ansible-playbook \u547d\u4ee4\u4e2d\u5305\u542b -K \u9078\u9805\u3002\u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u6307\u5b9a\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002 $ ansible-playbook -i inventory playbook-07.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u60a8\u9084\u53ef\u4ee5\u5728\u57f7\u884c\u4efb\u52d9\u6216\u64ad\u653e\u6642\u66f4\u6539\u8981\u5207\u63db\u5230\u7684\u7528\u6236\u3002\u70ba\u6b64\uff0c\u8acb\u5c07 become_user \u6307\u4ee4\u8a2d\u7f6e\u70ba\u60a8\u8981\u5207\u63db\u5230\u7684\u9060\u7a0b\u7528\u6236\u7684\u540d\u7a31\u3002\u7576\u60a8\u5728 playbook \u4e2d\u6709\u591a\u500b\u4f9d\u8cf4 sudo \u7684\u4efb\u52d9\u6642\uff0c\u9019\u5f88\u6709\u7528\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u4efb\u52d9\u61c9\u8a72\u4f5c\u70ba\u60a8\u7684\u666e\u901a\u7528\u6236\u904b\u884c\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u672c\u6b21\u64ad\u653e\u4e2d\u7684\u6240\u6709\u4efb\u52d9\u9ed8\u8a8d\u4f7f\u7528 sudo \u57f7\u884c\u3002\u9019\u662f\u5728\u64ad\u653e\u7d1a\u5225\u8a2d\u7f6e\u7684\uff0c\u5c31\u5728\u4e3b\u6a5f\u5b9a\u7fa9\u4e4b\u5f8c\u3002\u7b2c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 root \u6b0a\u9650\u5728 /tmp \u4e0a\u5275\u5efa\u4e00\u500b\u6587\u4ef6\uff0c\u56e0\u70ba\u9019\u662f\u9ed8\u8a8d\u7684 become_user \u503c\u3002\u7136\u800c\uff0c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u5b9a\u7fa9\u4e86\u5b83\u81ea\u5df1\u7684 become_user \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-08.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-08.yml --- - hosts : all become : yes vars : user : \"{{ ansible_env.USER }}\" tasks : - name : Create root file file : path : /tmp/my_file_root state : touch - name : Create user file become_user : \"{{ user }}\" file : path : /tmp/my_file_{{ user }} state : touch ansible_env.USER \u7684\u4e8b\u5be6(fact)\u5305\u542b\u9023\u63a5\u7528\u6236\u7684\u7528\u6236\u540d\uff0c\u53ef\u4ee5\u5728\u4f7f\u7528 -u \u9078\u9805\u904b\u884c ansible-playbook \u547d\u4ee4\u6642\u5728\u57f7\u884c\u6642\u5b9a\u7fa9\u3002\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u4ee5 vagrant \u7684\u8eab\u4efd\u9032\u884c\u9023\u63a5\uff1a $ ansible-playbook -i inventory playbook-08.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Create root file] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Create user file] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u8b93\u6211\u5011\u767b\u5165\u5230\u9019\u53f0VM\u53bb\u9a57\u8b49: $ vagrant ssh $ ls -la /tmp/my_file* -rw-r--r-- 1 root root 0 Jun 9 23 :37 /tmp/my_file_root \u6709\u95dc Ansible \u4e2d\u6b0a\u9650\u63d0\u5347\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u4e86\u89e3 Ansible Playbook \u4e2d\u7684\u6b0a\u9650\u63d0\u5347"},{"location":"cicd/gitops/","text":"\u6dfa\u8ac7 GitOps \u7684\u6982\u5ff5 \u00b6 \u539f\u6587: https://www.hwchiu.com/gitops.html \u672c\u7bc7\u6587\u7ae0\u4e3b\u8981\u8ddf\u5927\u5bb6\u4ecb\u7d39\u9019\u5e7e\u5e74\u4f34\u96a8\u8005 Kubernetes \u51fa\u73fe\u7684\u4e00\u500b\u540d\u8a5e GitOps , \u5167\u5bb9\u4e3b\u8981\u6703\u5305\u542b: GitOps \u6982\u5ff5\u4ecb\u7d39 ArgoCD\u958b\u6e90\u5c08\u6848\u4ecb\u7d39 GitOps \u4ecb\u7d39 \u00b6 GitOps \u9019\u500b\u8a5e\u5c31\u6211\u4e86\u89e3\uff0c\u6700\u65e9\u662f\u7531 Weave Net \u6240\u63d0\u51fa\u7684\u6982\u5ff5\uff0c\u8981\u77ad\u89e3 GitOps \u7684\u512a\u52a3\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u9084\u662f\u900f\u904e\u6bd4\u8f03\u7684\u65b9\u5f0f\u4f86\u7406\u89e3 GitOps \u8207\u539f\u5148\u7fd2\u6163\u7684 CI/CD \u90e8\u7f72\u65b9\u5f0f\u7684\u5dee\u7570\u3002 Info \u8a3b: \u9019\u908a\u63a2\u8a0e\u7684\u6240\u6709\u67b6\u69cb\u90fd\u4ee5 Kubernetes \u70ba\u4e3b \u5e38\u898b\u7684 CD \u6d41\u7a0b \u00b6 \u4e0b\u5716\u662f\u4e00\u500b\u5e38\u898b\u7684 CD \u6d41\u6c34\u7dda\u6d41\u7a0b: \u9019\u500b\u7bc4\u4f8b\u4e2d\uff0c\u6211\u5011\u6709\u4e00\u4e9b\u57fa\u672c\u5143\u4ef6: Git Repo - \u9019\u500b Git Repository \u4e2d\u81f3\u5c11\u6703\u653e\u7f6e\u95dc\u65bc Kubernetes \u8cc7\u6e90\u7684\u63cf\u8ff0\u6a94\u6848(Manifests), \u53ef\u4ee5\u662f\u539f\u751f\u7684 Yaml\uff0c Helm Charts \u6216\u662f Kustomize \u7684\u6a94\u6848\u3002 CI/CD Pipeline - \u8b6c\u5982 Jenkins/Gilab CI/GitHub Action/CirecleCI \u7b49\u5e38\u898b\u7cfb\u7d71\uff0c\u9019\u500b Pipeline \u88e1\u9762\u6703\u6709\u4e00\u4e9b\u5de5\u4f5c\uff0c\u8b6c\u5982\u6e2c\u8a66\uff0c\u5efa\u7f6e Contianer Image, \u66f4\u65b0 Container Image\uff0c\u4ee5\u53ca\u8ddf Kubernetes \u6e9d\u901a Operator/Devloper - \u5be6\u969b\u4e0a\u64cd\u4f5c\u7684\u4eba\u54e1\uff0c\u8b6c\u5982\u5c08\u6848\u958b\u767c\u4eba\u54e1\u6216\u662f\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u3002 \u5c0d\u65bc\u958b\u767c\u4eba\u54e1\u4f86\u8aaa\uff0c\u53ef\u80fd\u6703\u900f\u904e 1) PullRequest/MergeRequest \u7684\u7522\u751f\uff0c 2) PR/MR \u88ab\u5408\u4f75\u6216\u662f\u6709\u7279\u5b9a\u7684 Tag \u88ab\u7522\u751f \u7b49\u8af8\u591a\u689d\u4ef6\u89f8\u767c CI/CD Pipeline \u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba\u3002 \u5c0d\u65bc\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u4f86\u8aaa\u53ef\u5df2\u900f\u904e 1)\u76f4\u63a5\u8981\u6c42 CI/CD Pipeline \u904b\u884c\u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba 2) \u76f4\u63a5\u5c0d\u76ee\u6a19 Kubernetes Cluster \u9032\u884c\u64cd\u63a7\u3002 \u5f9e\u4e0a\u8ff0\u7684\u7bc4\u4f8b\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u6c92\u6709\u56b4\u53b2\u7684\u53bb\u9650\u5236 \u76f4\u63a5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0 \u9019\u500b\u884c\u70ba\uff0c\u5c31\u6709\u5169\u500b\u4e0d\u540c\u7684\u89f8\u767c\u9ede\u53ef\u4ee5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0\uff0c\u9019\u7a2e\u60c5\u6cc1\u53ef\u80fd\u6703\u9020\u6210\u7684\u554f\u984c\u662f: \u6c92\u6709\u8fa6\u6cd5\u63a7\u7ba1 Kubernetes \u6b63\u5728\u904b\u884c\u7684\u8cc7\u6e90\u72c0\u614b (Living Status) \u8207 Kubernetes \u88ab\u671f\u671b\u7684\u8cc7\u6e90\u72c0\u614b (Desired Yaml) \u4e00\u81f4 \u7279\u5225\u662f\u7576\u6709\u4eba\u54e1\u6703\u76f4\u63a5\u900f\u904e kubectl edit, kubectl patch, \u4f7f\u7528\u67d0\u7a2eUI\u7b49\u65b9\u5f0f\u76f4\u63a5\u4fee\u6539\u904b\u884c\u72c0\u614b\u537b\u53c8\u6c92\u6709\u8981\u66f4\u65b0\u63cf\u8ff0\u8cc7\u6e90 (Yaml) \u6642\u66f4\u5bb9\u6613\u767c\u751f\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u9019\u500b\u90e8\u7f72\u7d50\u69cb\u9084\u6709\u4e00\u500b\u5bb9\u6613\u5f15\u4eba\u8a6c\u75c5\u7684\u554f\u984c\u5c31\u662f KUBECONFIG \u7684\u6563\u4f48\uff0c\u70ba\u4e86\u8b93\u5916\u90e8\u74b0\u5883(CI/CD Pipeline, \u7279\u5b9a\u4eba\u54e1 laptop) \u80fd\u5920\u5c0d Kubernetes \u9032\u884c\u64cd\u4f5c\uff0c\u5fc5\u9808\u8981\u5c07\u9023\u63a5 Kubernetes Cluster \u6240\u9700\u8981\u7684 KUBECONFIG (Token/Credentail/API Address:Port) \u7b49\u8cc7\u8a0a\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u9019\u7121\u7591\u9020\u6210\u4e86\u4e00\u4e9b\u5b89\u5168\u6027\u7684\u96b1\u6182\u3002 \u75db\u9ede \u00b6 \u7c21\u55ae\u6574\u7406\u4ee5\u4e0b\u4e0a\u8ff0\u90e8\u7f72\u6d41\u7a0b\u53ef\u80fd\u7684\u7f3a\u5931: Kubernetes Cluster \u7684\u9023\u7dda\u8cc7\u8a0a\u5fc5\u9808\u8981\u66b4\u9732\u5728\u5916\uff0c\u4e00\u65e6\u88ab\u5916\u754c\u62ff\u5230\u5247\u6574\u500b Cluster \u90fd\u6709\u88ab\u7834\u58de\u7684\u53ef\u80fd \u96e3\u4ee5\u78ba\u4fdd Kubernetes \u5167\u904b\u884c\u7684\u72c0\u614b\u8207\u63cf\u8ff0\u7684\u8cc7\u6e90\u6a94\u6848 (Yaml/Helm Chart) \u4e00\u81f4\uff0c\u56e0\u70ba\u6709\u592a\u591a\u5730\u65b9\u53ef\u4ee5\u9032\u884c\u64cd\u4f5c \u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u770b\u4e00\u4e0b\u5c0d\u65bc GitOps \u4f86\u8aaa\uff0c\u8981\u5982\u4f55\u89e3\u6c7a\u4e0a\u9762\u5169\u500b\u6f5b\u5728\u554f\u984c\uff0c\u4e26\u4e14\u662f\u900f\u904e\u4f55\u7a2e\u65b9\u5f0f\u4f86\u8655\u7406\u3002 GitOps \u00b6 GitOps \u7684\u6982\u5ff5\u5982\u4e0b\u5716\u5448\u73fe: \u8207\u524d\u8ff0\u7684\u90e8\u7f72\u65b9\u5f0f\u6700\u5927\u7684\u5dee\u8ddd\u5c31\u662f: CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo \uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002 \u6240\u4ee5\u9019\u908a\u91dd\u5c0d GitOps \u4e0b\u500b\u4e00\u500b\u7e3d\u7d50\uff1a KUBECONFIG \u4e0d\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u4e0d\u5e0c\u671b\u4efb\u4f55\u4eba/\u74b0\u5883\u6709\u8fa6\u6cd5\u76f4\u63a5\u5f9e\u5916\u90e8\u53bb\u64cd\u4f5c Kubernetes \u5c07\u6240\u6709\u63cf\u8ff0 Kubernetes \u8cc7\u6e90\u72c0\u614b\u7684\u6a94\u6848\uff08Yaml/Helm Chart)\u7528 Git \u4fdd\u5b58 Kubernetes \u5167\u6703\u5b89\u88dd\u76f8\u5c0d\u61c9\u7684 controller \u4f86\u76e3\u63a7 Git Repo \u7684\u66f4\u65b0\u4e26\u4e14\u5c07\u4e00\u5207\u7684\u66f4\u65b0\u90fd\u66f4\u65b0\u5230 kubernetes cluster \u5167 (\u53ef\u80fd\u7684\u512a\u52e2)\uff0c\u900f\u904e GitOps \u9019\u7a2e\u67b6\u69cb\uff0cKubernetes Cluster \u672c\u8eab\u4e0d\u9700\u8981\u5c07 API Server \u7684\u5b58\u53d6\u65b9\u5f0f\u7d66\u66b4\u9732\u51fa\u53bb\uff0c\u53ef\u4ee5\u900f\u904e Firewall \u7684\u65b9\u5f0f\u628a\u5e38\u898b\u7684 6443 \u9023\u63a5\u57e0\u7d66\u95dc\u9589\uff0c\u5c0d\u65bc\u5b89\u5168\u6027\u4f86\u8aaa\u4e5f\u662f\u6e1b\u5c11\u4e86\u4e00\u4e9b\u6f5b\u5728\u7684\u554f\u984c\u3002 ArgoCD \u958b\u6e90\u5c08\u6848\u4ecb\u7d39 \u00b6 \u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u63a2\u8a0e\u4e00\u500b\u5be6\u73fe GitOps \u7684\u958b\u6e90\u5c08\u6848 ArgoCD\uff0c\u9019\u908a\u4e0d\u6703\u6709\u592a\u4ed4\u7d30\u7684 Demo \u8207\u64cd\u4f5c\uff0c\u4e3b\u8981\u662f\u91dd\u5c0d\u67b6\u69cb\u4f86\u9032\u884c\u4ecb\u7d39\u3002 ArgoCD \u7684\u67b6\u69cb\u5f15\u7528\u5176\u5b98\u7db2: \u9019\u500b\u67b6\u69cb\u5716\u5206\u6210\u5e7e\u500b\u90e8\u5206\u4f86\u770b\u3002 ArgoCD \u65bc Kubernetes Cluster \u5167\u5b89\u88dd\u7684\u670d\u52d9\uff0c\u9019\u4e9b\u670d\u52d9\u5305\u542b\u4e86 Argo API Server : \u63d0\u4f9b\u4ecb\u9762\u7d66\u5916\u754c\u64cd\u63a7 ArgoCD \u670d\u52d9\uff0c\u672c\u8eab\u63d0\u4f9b\u4e86 CLI, GUI \u4ee5\u53ca gRPC/REST \u7b49\u4ecb\u9762\uff0c\u6700\u7c21\u55ae\u7684 Demo \u53ef\u4ee5\u4f7f\u7528 GUI \u4f86\u64cd\u4f5c\u3002 Repository Service : \u672c\u8eab\u4f5c\u70ba\u4e00\u500b\u9060\u65b9 Git Repo \u7684\u672c\u5730\u5feb\u53d6\uff0c\u4e3b\u8981\u662f\u5132\u5b58\u8a72 Git Repo \u5167\u7684\u8cc7\u6e90\u9810\u671f\u6a94\u6848 (Yaml/Helm Chart) Application Controller : \u8ca0\u8cac\u8ddf Kubernetes \u6e9d\u901a\uff0c\u6703\u6bd4\u8f03 Kubernetes Cluster \u5167\u7684\u904b\u884c\u72c0\u614b (living status) \u4ee5\u53ca Git Repository \u5167\u6240\u63cf\u8ff0\u7684\u8cc7\u6e90\u9810\u671f\u72c0\u614b (Yaml/Helm Chart), \u4e26\u4e14\u66f4\u65b0 Kubernetes Cluster \u4e00\u65e6\u767c\u73fe Git Repository \u5167\u6709\u66f4\u52d5 \u4e0a\u65b9\u7684 Git Repo, \u8a72 Git Repo \u672c\u8eab\u6709\u5169\u7a2e\u65b9\u5f0f\u8207 ArgoCD \u4e92\u52d5 Webhook \u4e3b\u52d5\u544a\u77e5 ArgoCD ArgoCD \u672c\u8eab\u5b9a\u671f\u53bb\u89c0\u5bdf Git Repo \u7684\u72c0\u614b\uff0c\u4e26\u4e14\u4e00\u65e6\u6709\u66f4\u65b0\u5c31\u6703\u8b93 Controller \u4f86\u66f4\u65b0\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f \u5de6\u65b9\u7684\u958b\u767c\u4eba\u54e1/\u7dad\u8b77\u4eba\u54e1\uff0c\u9019\u4e9b\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI/gRPC/REST \u7b49\u65b9\u5f0f\u4f86\u64cd\u4f5c ArgoCD \u7684\u670d\u52d9\u3002 \u958b\u767c\u4eba\u54e1\u53ef\u4ee5\u900f\u904e\u5c0d Git Repo \u7684\u4fee\u6539\u8207\u5408\u4f75\u4f86\u89f8\u767c ArgoCD \u90e8\u7f72\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI \u7b49\u65b9\u5f0f\u4f86\u89c0\u5bdf\u8207\u8a2d\u5b9a\u7576\u524d\u61c9\u7528\u7a0b\u5f0f\u7684\u72c0\u614b \u5de6\u4e0b\u65b9\u7684\u662f Hook \u9ede\uff0c ArgoCD \u672c\u8eab\u91dd\u5c0d Git Repo \u66f4\u65b0\u524d\u5f8c\u6709\u63d0\u4f9b\u76f8\u95dc\u7684 Hook\uff0c\u53ef\u4ee5\u5728\u9019\u908a\u5c07\u76f8\u95dc\u7684\u8a0a\u606f\u8207\u5176\u4ed6\u7cfb\u7d71\u929c\u63a5\uff0c\u8b6c\u5982 Slack, Webhook \u7b49\uff0c\u8b93\u4f60\u7684\u7cfb\u7d71\u80fd\u5920\u6709\u8fa6\u6cd5\u63a5\u6536\u5230\u7576\u524d\u90e8\u7f72\u7684\u72c0\u6cc1 \u53f3\u4e0b\u65b9\u5247\u662f\u76ee\u6a19\u7684 Kubernetes Cluster \u5c0d\u65bc ArgoCD \u4f86\u8aaa\uff0c\u672c\u8eab\u8981\u5148\u900f\u904e\u4e00\u5957 Kubernetes \u4f86\u67b6\u8a2d\u670d\u52d9\uff0c\u63a5\u8005\u8a72 ArgoCD \u53ef\u4ee5\u91dd\u5c0d\u4e0d\u540c\u7684 Kuberentes Cluster \u9032\u884c\u8a2d\u5b9a\u8207\u5b58\u53d6\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u5982\u679c\u4f60\u74b0\u5883\u5167\u6709\u591a\u5957 Kubernetes Cluster, \u53ef\u4ee5\u53ea\u7528\u4e00\u5957 ArgoCD \u4f86\u7ba1\u7406\u9019\u4e9b Kubernetes Cluster\uff0c\u5c07\u95dc\u6ce8\u7684 Git Repo \u7d66\u90e8\u7f72\u5230\u4e0d\u540c Kubernetes Cluster \u5167\u7684\u4e0d\u540c namespace \u4e0b\u3002 \u4f7f\u7528\u7bc4\u4f8b \u00b6 \u5b98\u7db2\u7684 \u4f7f\u7528\u7bc4\u4f8b , \u6709\u8208\u8da3\u7684\u53ef\u4ee5\u53c3\u8003\u9023\u7d50\u4f86\u8a2d\u5b9a\u73a9\u770b\u770b\uff0c\u57fa\u672c\u4e0a\u5168\u90e8\u90fd\u662f\u57fa\u65bc GUI \u4f86\u9032\u884c\u64cd\u4f5c \u4ee5\u4e0b\u5716\u7247\u90fd\u4f86\u81ea\u5b98\u7db2\u7bc4\u4f8b: \u4e0a\u5716\u7bc4\u4f8b\u5c31\u662f\u5efa\u7acb\u4e00\u500b Application , \u5176\u8ffd\u8e64\u7684 Git Repo \u662f https://github.com/argoproj/argocd-example-apps \uff0c\u4e26\u4e14\u8ffd\u8e64\u7684\u662f\u76ee\u6a19 Repo \u7684 HEAD(latest) branch \u4e0b\u7684 guestbook \u8cc7\u6599\u593e\u5167\u7684\u8cc7\u6e90\u63cf\u8ff0\u6a94\u6848\u3002 \u6b64\u5916\u7576\u6709\u4efb\u4f55\u66f4\u65b0\u7684\u6642\u5019\uff0c\u6703\u5c07\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f\u90e8\u7f72\u5230 https://kubernetes.default.svc \u8a72 API server \u6240\u5c0d\u61c9\u7684 Kubernetes Cluster \u5167\uff0c\u4e26\u4e14\u653e\u5230 default namespace\u3002 ArgoCD \u672c\u8eab\u4e5f\u6703\u900f\u904e GUI \u7684\u65b9\u5f0f\u4f86\u8996\u89ba\u5316\u5448\u73fe\u90e8\u7f72\u7684\u8cc7\u6e90\uff0c\u5305\u542b\u5176\u72c0\u614b\uff0c\u540d\u7a31\u4ee5\u53ca\u5f7c\u6b64\u7684\u95dc\u4fc2\u3002 \u7e3d\u7d50 \u00b6 GitOps \u95dc\u6ce8\u7684\u662f\u5982\u4f55\u81ea\u52d5\u5316\u90e8\u7f72(CD)\uff0c\u8ddf CI, Pipeline \u95dc\u4fc2\u4e0d\u5927 GitOps \u8981\u6c42\u7684\u662f\u4ee5 Git Repo \u70ba\u4f86\u6e90\uff0c\u5982\u679c\u8981\u5c0d\u61c9\u7528\u7a0b\u5f0f\u9032\u7248\u6216\u662f\u9000\u7248\uff0c\u90fd\u76f4\u63a5\u5c0d Git \u4fee\u6b63\u5373\u53ef\uff0c\u5f8c\u7e8c\u8b93\u76f8\u95dc\u7684 Controller \u4f86\u5e6b\u5fd9\u540c\u6b65\u8cc7\u6e90\u72c0\u614b \u91dd\u5c0d\u4e0d\u80fd\u5920\u88ab\u5916\u754c\u5b58\u53d6\u7684 Kubernetes Cluster\u4f86\u8aaa\uff0c GitOps \u7684\u6982\u5ff5\u53ef\u4ee5\u89e3\u6c7a\u81ea\u52d5\u90e8\u7f72\u7684\u56f0\u5883\uff0c\u540c\u6642\u4e5f\u80fd\u5920\u6e1b\u5c11\u5916\u6d29 KUBECONFIG \u9019\u500b\u6a94\u6848\u7684\u6f5b\u5728\u6027","title":"GitOps \u7684\u6982\u5ff5"},{"location":"cicd/gitops/#gitops","text":"\u539f\u6587: https://www.hwchiu.com/gitops.html \u672c\u7bc7\u6587\u7ae0\u4e3b\u8981\u8ddf\u5927\u5bb6\u4ecb\u7d39\u9019\u5e7e\u5e74\u4f34\u96a8\u8005 Kubernetes \u51fa\u73fe\u7684\u4e00\u500b\u540d\u8a5e GitOps , \u5167\u5bb9\u4e3b\u8981\u6703\u5305\u542b: GitOps \u6982\u5ff5\u4ecb\u7d39 ArgoCD\u958b\u6e90\u5c08\u6848\u4ecb\u7d39","title":"\u6dfa\u8ac7 GitOps \u7684\u6982\u5ff5"},{"location":"cicd/gitops/#gitops_1","text":"GitOps \u9019\u500b\u8a5e\u5c31\u6211\u4e86\u89e3\uff0c\u6700\u65e9\u662f\u7531 Weave Net \u6240\u63d0\u51fa\u7684\u6982\u5ff5\uff0c\u8981\u77ad\u89e3 GitOps \u7684\u512a\u52a3\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u9084\u662f\u900f\u904e\u6bd4\u8f03\u7684\u65b9\u5f0f\u4f86\u7406\u89e3 GitOps \u8207\u539f\u5148\u7fd2\u6163\u7684 CI/CD \u90e8\u7f72\u65b9\u5f0f\u7684\u5dee\u7570\u3002 Info \u8a3b: \u9019\u908a\u63a2\u8a0e\u7684\u6240\u6709\u67b6\u69cb\u90fd\u4ee5 Kubernetes \u70ba\u4e3b","title":"GitOps \u4ecb\u7d39"},{"location":"cicd/gitops/#cd","text":"\u4e0b\u5716\u662f\u4e00\u500b\u5e38\u898b\u7684 CD \u6d41\u6c34\u7dda\u6d41\u7a0b: \u9019\u500b\u7bc4\u4f8b\u4e2d\uff0c\u6211\u5011\u6709\u4e00\u4e9b\u57fa\u672c\u5143\u4ef6: Git Repo - \u9019\u500b Git Repository \u4e2d\u81f3\u5c11\u6703\u653e\u7f6e\u95dc\u65bc Kubernetes \u8cc7\u6e90\u7684\u63cf\u8ff0\u6a94\u6848(Manifests), \u53ef\u4ee5\u662f\u539f\u751f\u7684 Yaml\uff0c Helm Charts \u6216\u662f Kustomize \u7684\u6a94\u6848\u3002 CI/CD Pipeline - \u8b6c\u5982 Jenkins/Gilab CI/GitHub Action/CirecleCI \u7b49\u5e38\u898b\u7cfb\u7d71\uff0c\u9019\u500b Pipeline \u88e1\u9762\u6703\u6709\u4e00\u4e9b\u5de5\u4f5c\uff0c\u8b6c\u5982\u6e2c\u8a66\uff0c\u5efa\u7f6e Contianer Image, \u66f4\u65b0 Container Image\uff0c\u4ee5\u53ca\u8ddf Kubernetes \u6e9d\u901a Operator/Devloper - \u5be6\u969b\u4e0a\u64cd\u4f5c\u7684\u4eba\u54e1\uff0c\u8b6c\u5982\u5c08\u6848\u958b\u767c\u4eba\u54e1\u6216\u662f\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u3002 \u5c0d\u65bc\u958b\u767c\u4eba\u54e1\u4f86\u8aaa\uff0c\u53ef\u80fd\u6703\u900f\u904e 1) PullRequest/MergeRequest \u7684\u7522\u751f\uff0c 2) PR/MR \u88ab\u5408\u4f75\u6216\u662f\u6709\u7279\u5b9a\u7684 Tag \u88ab\u7522\u751f \u7b49\u8af8\u591a\u689d\u4ef6\u89f8\u767c CI/CD Pipeline \u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba\u3002 \u5c0d\u65bc\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u4f86\u8aaa\u53ef\u5df2\u900f\u904e 1)\u76f4\u63a5\u8981\u6c42 CI/CD Pipeline \u904b\u884c\u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba 2) \u76f4\u63a5\u5c0d\u76ee\u6a19 Kubernetes Cluster \u9032\u884c\u64cd\u63a7\u3002 \u5f9e\u4e0a\u8ff0\u7684\u7bc4\u4f8b\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u6c92\u6709\u56b4\u53b2\u7684\u53bb\u9650\u5236 \u76f4\u63a5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0 \u9019\u500b\u884c\u70ba\uff0c\u5c31\u6709\u5169\u500b\u4e0d\u540c\u7684\u89f8\u767c\u9ede\u53ef\u4ee5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0\uff0c\u9019\u7a2e\u60c5\u6cc1\u53ef\u80fd\u6703\u9020\u6210\u7684\u554f\u984c\u662f: \u6c92\u6709\u8fa6\u6cd5\u63a7\u7ba1 Kubernetes \u6b63\u5728\u904b\u884c\u7684\u8cc7\u6e90\u72c0\u614b (Living Status) \u8207 Kubernetes \u88ab\u671f\u671b\u7684\u8cc7\u6e90\u72c0\u614b (Desired Yaml) \u4e00\u81f4 \u7279\u5225\u662f\u7576\u6709\u4eba\u54e1\u6703\u76f4\u63a5\u900f\u904e kubectl edit, kubectl patch, \u4f7f\u7528\u67d0\u7a2eUI\u7b49\u65b9\u5f0f\u76f4\u63a5\u4fee\u6539\u904b\u884c\u72c0\u614b\u537b\u53c8\u6c92\u6709\u8981\u66f4\u65b0\u63cf\u8ff0\u8cc7\u6e90 (Yaml) \u6642\u66f4\u5bb9\u6613\u767c\u751f\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u9019\u500b\u90e8\u7f72\u7d50\u69cb\u9084\u6709\u4e00\u500b\u5bb9\u6613\u5f15\u4eba\u8a6c\u75c5\u7684\u554f\u984c\u5c31\u662f KUBECONFIG \u7684\u6563\u4f48\uff0c\u70ba\u4e86\u8b93\u5916\u90e8\u74b0\u5883(CI/CD Pipeline, \u7279\u5b9a\u4eba\u54e1 laptop) \u80fd\u5920\u5c0d Kubernetes \u9032\u884c\u64cd\u4f5c\uff0c\u5fc5\u9808\u8981\u5c07\u9023\u63a5 Kubernetes Cluster \u6240\u9700\u8981\u7684 KUBECONFIG (Token/Credentail/API Address:Port) \u7b49\u8cc7\u8a0a\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u9019\u7121\u7591\u9020\u6210\u4e86\u4e00\u4e9b\u5b89\u5168\u6027\u7684\u96b1\u6182\u3002","title":"\u5e38\u898b\u7684 CD \u6d41\u7a0b"},{"location":"cicd/gitops/#_1","text":"\u7c21\u55ae\u6574\u7406\u4ee5\u4e0b\u4e0a\u8ff0\u90e8\u7f72\u6d41\u7a0b\u53ef\u80fd\u7684\u7f3a\u5931: Kubernetes Cluster \u7684\u9023\u7dda\u8cc7\u8a0a\u5fc5\u9808\u8981\u66b4\u9732\u5728\u5916\uff0c\u4e00\u65e6\u88ab\u5916\u754c\u62ff\u5230\u5247\u6574\u500b Cluster \u90fd\u6709\u88ab\u7834\u58de\u7684\u53ef\u80fd \u96e3\u4ee5\u78ba\u4fdd Kubernetes \u5167\u904b\u884c\u7684\u72c0\u614b\u8207\u63cf\u8ff0\u7684\u8cc7\u6e90\u6a94\u6848 (Yaml/Helm Chart) \u4e00\u81f4\uff0c\u56e0\u70ba\u6709\u592a\u591a\u5730\u65b9\u53ef\u4ee5\u9032\u884c\u64cd\u4f5c \u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u770b\u4e00\u4e0b\u5c0d\u65bc GitOps \u4f86\u8aaa\uff0c\u8981\u5982\u4f55\u89e3\u6c7a\u4e0a\u9762\u5169\u500b\u6f5b\u5728\u554f\u984c\uff0c\u4e26\u4e14\u662f\u900f\u904e\u4f55\u7a2e\u65b9\u5f0f\u4f86\u8655\u7406\u3002","title":"\u75db\u9ede"},{"location":"cicd/gitops/#gitops_2","text":"GitOps \u7684\u6982\u5ff5\u5982\u4e0b\u5716\u5448\u73fe: \u8207\u524d\u8ff0\u7684\u90e8\u7f72\u65b9\u5f0f\u6700\u5927\u7684\u5dee\u8ddd\u5c31\u662f: CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo \uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002 \u6240\u4ee5\u9019\u908a\u91dd\u5c0d GitOps \u4e0b\u500b\u4e00\u500b\u7e3d\u7d50\uff1a KUBECONFIG \u4e0d\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u4e0d\u5e0c\u671b\u4efb\u4f55\u4eba/\u74b0\u5883\u6709\u8fa6\u6cd5\u76f4\u63a5\u5f9e\u5916\u90e8\u53bb\u64cd\u4f5c Kubernetes \u5c07\u6240\u6709\u63cf\u8ff0 Kubernetes \u8cc7\u6e90\u72c0\u614b\u7684\u6a94\u6848\uff08Yaml/Helm Chart)\u7528 Git \u4fdd\u5b58 Kubernetes \u5167\u6703\u5b89\u88dd\u76f8\u5c0d\u61c9\u7684 controller \u4f86\u76e3\u63a7 Git Repo \u7684\u66f4\u65b0\u4e26\u4e14\u5c07\u4e00\u5207\u7684\u66f4\u65b0\u90fd\u66f4\u65b0\u5230 kubernetes cluster \u5167 (\u53ef\u80fd\u7684\u512a\u52e2)\uff0c\u900f\u904e GitOps \u9019\u7a2e\u67b6\u69cb\uff0cKubernetes Cluster \u672c\u8eab\u4e0d\u9700\u8981\u5c07 API Server \u7684\u5b58\u53d6\u65b9\u5f0f\u7d66\u66b4\u9732\u51fa\u53bb\uff0c\u53ef\u4ee5\u900f\u904e Firewall \u7684\u65b9\u5f0f\u628a\u5e38\u898b\u7684 6443 \u9023\u63a5\u57e0\u7d66\u95dc\u9589\uff0c\u5c0d\u65bc\u5b89\u5168\u6027\u4f86\u8aaa\u4e5f\u662f\u6e1b\u5c11\u4e86\u4e00\u4e9b\u6f5b\u5728\u7684\u554f\u984c\u3002","title":"GitOps"},{"location":"cicd/gitops/#argocd","text":"\u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u63a2\u8a0e\u4e00\u500b\u5be6\u73fe GitOps \u7684\u958b\u6e90\u5c08\u6848 ArgoCD\uff0c\u9019\u908a\u4e0d\u6703\u6709\u592a\u4ed4\u7d30\u7684 Demo \u8207\u64cd\u4f5c\uff0c\u4e3b\u8981\u662f\u91dd\u5c0d\u67b6\u69cb\u4f86\u9032\u884c\u4ecb\u7d39\u3002 ArgoCD \u7684\u67b6\u69cb\u5f15\u7528\u5176\u5b98\u7db2: \u9019\u500b\u67b6\u69cb\u5716\u5206\u6210\u5e7e\u500b\u90e8\u5206\u4f86\u770b\u3002 ArgoCD \u65bc Kubernetes Cluster \u5167\u5b89\u88dd\u7684\u670d\u52d9\uff0c\u9019\u4e9b\u670d\u52d9\u5305\u542b\u4e86 Argo API Server : \u63d0\u4f9b\u4ecb\u9762\u7d66\u5916\u754c\u64cd\u63a7 ArgoCD \u670d\u52d9\uff0c\u672c\u8eab\u63d0\u4f9b\u4e86 CLI, GUI \u4ee5\u53ca gRPC/REST \u7b49\u4ecb\u9762\uff0c\u6700\u7c21\u55ae\u7684 Demo \u53ef\u4ee5\u4f7f\u7528 GUI \u4f86\u64cd\u4f5c\u3002 Repository Service : \u672c\u8eab\u4f5c\u70ba\u4e00\u500b\u9060\u65b9 Git Repo \u7684\u672c\u5730\u5feb\u53d6\uff0c\u4e3b\u8981\u662f\u5132\u5b58\u8a72 Git Repo \u5167\u7684\u8cc7\u6e90\u9810\u671f\u6a94\u6848 (Yaml/Helm Chart) Application Controller : \u8ca0\u8cac\u8ddf Kubernetes \u6e9d\u901a\uff0c\u6703\u6bd4\u8f03 Kubernetes Cluster \u5167\u7684\u904b\u884c\u72c0\u614b (living status) \u4ee5\u53ca Git Repository \u5167\u6240\u63cf\u8ff0\u7684\u8cc7\u6e90\u9810\u671f\u72c0\u614b (Yaml/Helm Chart), \u4e26\u4e14\u66f4\u65b0 Kubernetes Cluster \u4e00\u65e6\u767c\u73fe Git Repository \u5167\u6709\u66f4\u52d5 \u4e0a\u65b9\u7684 Git Repo, \u8a72 Git Repo \u672c\u8eab\u6709\u5169\u7a2e\u65b9\u5f0f\u8207 ArgoCD \u4e92\u52d5 Webhook \u4e3b\u52d5\u544a\u77e5 ArgoCD ArgoCD \u672c\u8eab\u5b9a\u671f\u53bb\u89c0\u5bdf Git Repo \u7684\u72c0\u614b\uff0c\u4e26\u4e14\u4e00\u65e6\u6709\u66f4\u65b0\u5c31\u6703\u8b93 Controller \u4f86\u66f4\u65b0\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f \u5de6\u65b9\u7684\u958b\u767c\u4eba\u54e1/\u7dad\u8b77\u4eba\u54e1\uff0c\u9019\u4e9b\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI/gRPC/REST \u7b49\u65b9\u5f0f\u4f86\u64cd\u4f5c ArgoCD \u7684\u670d\u52d9\u3002 \u958b\u767c\u4eba\u54e1\u53ef\u4ee5\u900f\u904e\u5c0d Git Repo \u7684\u4fee\u6539\u8207\u5408\u4f75\u4f86\u89f8\u767c ArgoCD \u90e8\u7f72\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI \u7b49\u65b9\u5f0f\u4f86\u89c0\u5bdf\u8207\u8a2d\u5b9a\u7576\u524d\u61c9\u7528\u7a0b\u5f0f\u7684\u72c0\u614b \u5de6\u4e0b\u65b9\u7684\u662f Hook \u9ede\uff0c ArgoCD \u672c\u8eab\u91dd\u5c0d Git Repo \u66f4\u65b0\u524d\u5f8c\u6709\u63d0\u4f9b\u76f8\u95dc\u7684 Hook\uff0c\u53ef\u4ee5\u5728\u9019\u908a\u5c07\u76f8\u95dc\u7684\u8a0a\u606f\u8207\u5176\u4ed6\u7cfb\u7d71\u929c\u63a5\uff0c\u8b6c\u5982 Slack, Webhook \u7b49\uff0c\u8b93\u4f60\u7684\u7cfb\u7d71\u80fd\u5920\u6709\u8fa6\u6cd5\u63a5\u6536\u5230\u7576\u524d\u90e8\u7f72\u7684\u72c0\u6cc1 \u53f3\u4e0b\u65b9\u5247\u662f\u76ee\u6a19\u7684 Kubernetes Cluster \u5c0d\u65bc ArgoCD \u4f86\u8aaa\uff0c\u672c\u8eab\u8981\u5148\u900f\u904e\u4e00\u5957 Kubernetes \u4f86\u67b6\u8a2d\u670d\u52d9\uff0c\u63a5\u8005\u8a72 ArgoCD \u53ef\u4ee5\u91dd\u5c0d\u4e0d\u540c\u7684 Kuberentes Cluster \u9032\u884c\u8a2d\u5b9a\u8207\u5b58\u53d6\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u5982\u679c\u4f60\u74b0\u5883\u5167\u6709\u591a\u5957 Kubernetes Cluster, \u53ef\u4ee5\u53ea\u7528\u4e00\u5957 ArgoCD \u4f86\u7ba1\u7406\u9019\u4e9b Kubernetes Cluster\uff0c\u5c07\u95dc\u6ce8\u7684 Git Repo \u7d66\u90e8\u7f72\u5230\u4e0d\u540c Kubernetes Cluster \u5167\u7684\u4e0d\u540c namespace \u4e0b\u3002","title":"ArgoCD \u958b\u6e90\u5c08\u6848\u4ecb\u7d39"},{"location":"cicd/gitops/#_2","text":"\u5b98\u7db2\u7684 \u4f7f\u7528\u7bc4\u4f8b , \u6709\u8208\u8da3\u7684\u53ef\u4ee5\u53c3\u8003\u9023\u7d50\u4f86\u8a2d\u5b9a\u73a9\u770b\u770b\uff0c\u57fa\u672c\u4e0a\u5168\u90e8\u90fd\u662f\u57fa\u65bc GUI \u4f86\u9032\u884c\u64cd\u4f5c \u4ee5\u4e0b\u5716\u7247\u90fd\u4f86\u81ea\u5b98\u7db2\u7bc4\u4f8b: \u4e0a\u5716\u7bc4\u4f8b\u5c31\u662f\u5efa\u7acb\u4e00\u500b Application , \u5176\u8ffd\u8e64\u7684 Git Repo \u662f https://github.com/argoproj/argocd-example-apps \uff0c\u4e26\u4e14\u8ffd\u8e64\u7684\u662f\u76ee\u6a19 Repo \u7684 HEAD(latest) branch \u4e0b\u7684 guestbook \u8cc7\u6599\u593e\u5167\u7684\u8cc7\u6e90\u63cf\u8ff0\u6a94\u6848\u3002 \u6b64\u5916\u7576\u6709\u4efb\u4f55\u66f4\u65b0\u7684\u6642\u5019\uff0c\u6703\u5c07\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f\u90e8\u7f72\u5230 https://kubernetes.default.svc \u8a72 API server \u6240\u5c0d\u61c9\u7684 Kubernetes Cluster \u5167\uff0c\u4e26\u4e14\u653e\u5230 default namespace\u3002 ArgoCD \u672c\u8eab\u4e5f\u6703\u900f\u904e GUI \u7684\u65b9\u5f0f\u4f86\u8996\u89ba\u5316\u5448\u73fe\u90e8\u7f72\u7684\u8cc7\u6e90\uff0c\u5305\u542b\u5176\u72c0\u614b\uff0c\u540d\u7a31\u4ee5\u53ca\u5f7c\u6b64\u7684\u95dc\u4fc2\u3002","title":"\u4f7f\u7528\u7bc4\u4f8b"},{"location":"cicd/gitops/#_3","text":"GitOps \u95dc\u6ce8\u7684\u662f\u5982\u4f55\u81ea\u52d5\u5316\u90e8\u7f72(CD)\uff0c\u8ddf CI, Pipeline \u95dc\u4fc2\u4e0d\u5927 GitOps \u8981\u6c42\u7684\u662f\u4ee5 Git Repo \u70ba\u4f86\u6e90\uff0c\u5982\u679c\u8981\u5c0d\u61c9\u7528\u7a0b\u5f0f\u9032\u7248\u6216\u662f\u9000\u7248\uff0c\u90fd\u76f4\u63a5\u5c0d Git \u4fee\u6b63\u5373\u53ef\uff0c\u5f8c\u7e8c\u8b93\u76f8\u95dc\u7684 Controller \u4f86\u5e6b\u5fd9\u540c\u6b65\u8cc7\u6e90\u72c0\u614b \u91dd\u5c0d\u4e0d\u80fd\u5920\u88ab\u5916\u754c\u5b58\u53d6\u7684 Kubernetes Cluster\u4f86\u8aaa\uff0c GitOps \u7684\u6982\u5ff5\u53ef\u4ee5\u89e3\u6c7a\u81ea\u52d5\u90e8\u7f72\u7684\u56f0\u5883\uff0c\u540c\u6642\u4e5f\u80fd\u5920\u6e1b\u5c11\u5916\u6d29 KUBECONFIG \u9019\u500b\u6a94\u6848\u7684\u6f5b\u5728\u6027","title":"\u7e3d\u7d50"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/","text":"\u7528 HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API \u00b6 \u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-call-simple-http-client/ \u4f7f\u7528 CLI\uff08\u5982 curl\uff09\u6216 GUI\uff08\u5982 postman\uff09HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API \u6709\u5f88\u591a\u4f7f\u7528\u60c5\u5883\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u6bd4 kubectl \u63d0\u4f9b\u7684\u66f4\u7d30\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u6216\u8005\u53ea\u662f\u60f3\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u8a2a\u554f API \u4e4b\u524d\u63a2\u7d22\u5b83\u3002 \u672c\u6587\u4e0d\u50c5\u50c5\u662f\u4e00\u500b\u65b9\u4fbf\u7684\u547d\u4ee4\u5217\u8868\uff0c\u800c\u662f\u4e00\u500b\u6df1\u601d\u719f\u616e\u7684\u6f14\u7df4\uff0c\u63ed\u793a\u4e86\u4e00\u4e9b\u60a8\u5728\u5f9e\u547d\u4ee4\u884c\u8abf\u7528 Kubernetes API \u6642\u53ef\u80fd\u6703\u5076\u7136\u767c\u73fe\u7684\u6709\u8da3\u554f\u984c\u3002\u5b83\u6db5\u84cb\u4ee5\u4e0b\u4e3b\u984c\uff1a \u5982\u4f55\u7372\u53d6 Kubernetes API \u670d\u52d9\u5668\u5730\u5740 \u5982\u4f55\u5411\u5ba2\u6236\u7aef\u9a57\u8b49 API \u670d\u52d9\u5668 \u5982\u4f55\u4f7f\u7528\u8b49\u66f8 (certificate) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u4f7f\u7528\u4ee4\u724c (token) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u5f9e Pod \u5167\u90e8\u8abf\u7528 Kubernetes API \u5982\u4f55\u4f7f\u7528 curl \u5c0d Kubernetes \u5c0d\u8c61\u57f7\u884c\u57fa\u672c\u7684 CRUD \u64cd\u4f5c \u5982\u4f55\u4f7f\u7528 kubectl \u7684 raw \u6a21\u5f0f\u76f4\u63a5\u8a2a\u554f Kubernetes API \u5982\u4f55\u67e5\u770b\u54ea\u4e9b API \u8acb\u6c42 kubectl \u547d\u4ee4\uff08\u5982 apply \u767c\u9001\uff09 Setting up Kubernetes playground \u00b6 \u5982\u679c\u4f60\u6c92\u6709 Kubernetes \u96c6\u7fa4\u53ef\u4ee5\u73a9\uff0c\u9019\u88e1\u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 arkade \u5feb\u901f\u5275\u5efa\u672c\u5730\u904a\u6a02\u5834\u7684\u65b9\u6cd5\uff1a $ curl -sLS https://get.arkade.dev | sudo sh $ arkade get minikube kubectl $ minikube start --profile cluster1 How to get Kubernetes API host and port \u00b6 \u8981\u8abf\u7528\u4efb\u4f55 API\uff0c\u60a8\u9996\u5148\u9700\u8981\u77e5\u9053\u5176\u670d\u52d9\u5668\u5730\u5740\u3002\u5c0d\u65bc Kubernetes\uff0c\u6bcf\u500b\u96c6\u7fa4\u90fd\u6709\u4e00\u500b API \u670d\u52d9\u5668\u3002\u56e0\u6b64\uff0c\u67e5\u627e API \u4e3b\u6a5f\u548c\u7aef\u53e3\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u67e5\u770b kubectl cluster-info \u8f38\u51fa\u3002\u4f8b\u5982\uff0c\u5728\u6211\u7684 Vagrant \u76d2\u5b50\u4e0a\uff0c\u5b83\u6703\u7522\u751f\u4ee5\u4e0b\u8a0a\u606f\uff1a $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy ... cluster-info \u547d\u4ee4\u986f\u793a\u5728 \u7576\u524d\u4e0a\u4e0b\u6587 \u4e2d\u9078\u64c7\u7684\u96c6\u7fa4\u7684 API \u5730\u5740\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u6709\u591a\u500b\u96c6\u7fa4\u600e\u9ebc\u8fa6\uff1f $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority: /home/dxlab/.minikube/ca.crt extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: cluster_info server: https://192.168.49.2:8443 name: minikube contexts: - context: cluster: minikube extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: context_info namespace: default user: minikube name: minikube current-context: minikube kind: Config preferences: {} users: - name: minikube user: client-certificate: /home/dxlab/.minikube/profiles/minikube/client.crt client-key: /home/dxlab/.minikube/profiles/minikube/client.key Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c kubectl \u5728 $HOME/.kube \u76ee\u9304\u4e2d\u67e5\u627e\u540d\u70ba config \u7684\u6587\u4ef6\u3002\u90a3\u9ebc\uff0c\u70ba\u4ec0\u9ebc\u4e0d\u76f4\u63a5\u5f9e\u9019\u500b\u6587\u4ef6\u4e2d\u7372\u53d6 API \u5730\u5740\u5462\uff1f \u539f\u56e0\u662f\u6f5b\u5728\u7684\u914d\u7f6e\u5408\u4f75\u3002\u901a\u904e\u5c07 KUBECONFIG env var \u8a2d\u7f6e\u70ba\u4ee5\u5192\u865f\u5206\u9694\u7684\u4f4d\u7f6e\u5217\u8868\uff0c\u53ef\u4ee5\u6307\u5b9a\u591a\u500b kubeconfig \u6587\u4ef6\u3002\u5728\u8a2a\u554f\u96c6\u7fa4\u4e4b\u524d\uff0c kubectl \u6703\u5617\u8a66\u5c07\u6240\u6709 kubeconfig \u6587\u4ef6\u7684\u5167\u5bb9\u5408\u4f75\u5230\u4e00\u500b\u914d\u7f6e\u4e2d\u3002 \u56e0\u6b64\uff0c\u5f9e\u4e0a\u9762\u7684\u5217\u8868\u4e2d\u9078\u64c7\u6b63\u78ba\u7684\u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u5617\u8a66\u5411\u5176 API \u670d\u52d9\u5668\u767c\u9001\u8acb\u6c42\uff1a $ KUBE_API = $( kubectl config view -o jsonpath = '{.clusters[0].cluster.server}' ) How to call Kubernetes API using curl \u00b6 \u5be6\u969b\u4e0a\uff0c\u4efb\u4f55 HTTP \u5ba2\u6236\u7aef\uff08curl\u3001httpie\u3001wget \u751a\u81f3 postman\uff09\u90fd\u53ef\u4ee5\uff0c\u4f46\u6211\u5c07\u5728\u672c\u7bc0\u4e2d\u4f7f\u7528 curl \u3002 Authenticating API server to client \u00b6 \u8b93\u6211\u5011\u5f9e\u67e5\u8a62 API \u7684 /version \u7aef\u9ede\u958b\u59cb\uff1a $ curl $KUBE_API /version curl: ( 60 ) SSL certificate problem: unable to get local issuer certificate More details here: https://curl.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. \u5f88\u986f\u7136\u2026\u2026\u6211\u5011\u9023\u63a5\u5931\u6557\u4e86\uff01 \ud83d\ude48 \u7576\u6211\u7b2c\u4e00\u6b21\u5076\u7136\u767c\u73fe\u985e\u4f3c\u7684\u932f\u8aa4\u6642\uff0c\u6211\u771f\u7684\u5f88\u56f0\u60d1\u3002\u4f46\u4ed4\u7d30\u60f3\u60f3\uff0c\u4e0a\u8ff0\u932f\u8aa4\u5be6\u969b\u4e0a\u662f\u6709\u9053\u7406\u7684\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cKubernetes \u901a\u904e HTTPS \u516c\u958b\u5176 API\uff0c\u7279\u5225\u662f\u70ba\u4e86\u5411\u5ba2\u6236\u7aef\u4fdd\u8b49 API \u670d\u52d9\u5668\u7684\u5f37\u8eab\u4efd\u3002\u4f46\u662f\uff0cminikube \u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\u4f86\u8a2d\u5b9a\u672c\u5730\u96c6\u7fa4\u3002\u56e0\u6b64\uff0cKubernetes API \u670d\u52d9\u5668\u7684 TLS \u8b49\u66f8\u539f\u4f86\u662f\u7531\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u7c3d\u7f72\u7684(self-signed)\uff0c\u8a72\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u5c0d curl \u662f\u672a\u77e5\u7684 \u3002curl \u7121\u6cd5\u4fe1\u4efb\u5b83\uff0c\u56e0\u6b64\u8acb\u6c42\u5931\u6557\u3002 Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0ccurl \u4fe1\u4efb\u5e95\u5c64\u64cd\u4f5c\u7cfb\u7d71\u6240\u4fe1\u4efb\u7684\u540c\u4e00\u7d44 CA\u3002\u4f8b\u5982\uff0c\u5728 Ubuntu \u6216 Debian \u4e0a\uff0c\u53ef\u4ee5\u5728 /etc/ssl/certs/ca-certificates.crt \u4e2d\u627e\u5230\u53d7\u4fe1\u4efb\u7684 CA \u5217\u8868\u3002\u986f\u7136\uff0cminikube \u4e0d\u6703\u5c07\u5176\u8b49\u66f8\u6dfb\u52a0\u5230\u6b64\u6587\u4ef6\u4e2d\u3002 \u5e78\u904b\u7684\u662f\uff0cminikube \u5c07 CA \u8b49\u66f8\u4fdd\u5b58\u5230 ~/.minikube/ca.crt \uff1a $ cat ~/.minikube/ca.crt | openssl x509 -text \u7d50\u679c: Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 1 ( 0x1 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 12 06 :14:14 2022 GMT Not After : Jun 10 06 :14:14 2032 GMT Subject: CN = minikubeCA Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :c2:ee:45:b9:c6:63:1f:15:d5:e7:22:5a:92:48: 86 :23:db:0c:a2:0c:e5:e9:b4:9b:29:75:04:c0:e2: 2b:f2:8e:2a:8a:47:06:6e:81:d0:13:90:0a:08:71: 99 :23:01:57:47:9b:1d:00:8f:95:50:20:97:13:6c: 32 :42:b5:04:c8:3a:0b:5d:30:9c:55:bd:28:53:1b: 87 :de:04:a7:04:18:e9:16:38:47:38:aa:a7:08:35: 1c:62:c3:e5:2d:89:ae:0b:e3:3b:9d:be:a2:b8:3b: e6:81:ac:75:12:fe:f7:9b:a1:1b:a8:46:f7:9d:b8: ce:41:2b:95:de:98:1b:52:a6:59:b9:54:ce:60:d6: f3:2b:a5:b8:43:e1:ca:87:5c:8c:61:f8:59:4b:47: 1c:73:20:ad:3d:8e:fa:0e:a2:c5:b7:2d:8b:9a:85: 3f:6c:39:46:16:e8:4f:a9:91:e2:86:02:f3:2d:66: 7d:6c:74:66:23:7a:34:24:85:d9:f6:20:b0:39:7d: 68 :86:d0:67:f1:90:df:ab:bd:52:85:5c:bb:99:a0: ab:b9:a5:bd:1e:08:69:8e:7e:e2:e0:d5:f2:a5:40: 76 :e7:03:de:aa:e3:f9:16:11:c9:ed:a3:8f:9a:c3: 48 :44:20:5e:4c:8d:13:fa:a0:f7:68:86:f5:8f:5f: 97 :3f Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment, Certificate Sign X509v3 Extended Key Usage: TLS Web Client Authentication, TLS Web Server Authentication X509v3 Basic Constraints: critical CA:TRUE X509v3 Subject Key Identifier: 70 :53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption 56 :3c:de:59:09:ce:7b:bf:92:b0:fd:44:ca:e7:83:48:a2:f8: a7:3d:01:b2:62:50:62:cb:c0:7c:33:5d:25:a2:f4:46:af:88: b0:02:db:84:e6:4c:cb:a3:74:46:ed:ef:96:48:15:f9:cb:d7: 07 :42:0e:b0:3f:bf:bd:2b:e6:02:66:9c:a6:b4:5c:de:f9:0a: 5b:68:cc:7a:0f:ea:1a:b5:4e:ff:ff:95:f7:b9:c4:a1:1f:e5: 76 :62:f4:c7:82:2d:9d:a6:79:99:95:f2:f7:77:58:11:87:0a: 76 :88:e3:32:fe:4a:18:99:fd:a2:b8:50:29:fb:4a:f5:74:4c: b2:0c:b5:42:75:93:6c:b9:80:db:10:8b:3e:49:c2:f2:15:84: e4:0f:fd:9b:21:05:ed:0e:66:85:04:58:ff:d8:c3:e9:e4:44: c4:30:28:fa:7f:b8:79:3c:8e:c3:28:64:cd:6c:ea:db:57:a2: e9:b3:26:2a:d2:18:4e:f5:b9:1d:23:48:cf:be:f7:85:6c:7e: dd:c8:85:78:ae:92:a7:1e:2c:0e:2a:c6:5f:3a:9c:84:8f:2d: cd:20:ac:30:a6:79:f3:4d:08:8e:e3:93:32:81:01:dc:c5:7b: 0d:a8:d8:e3:13:0b:d6:68:1f:3e:69:10:16:4a:9e:77:4a:61: 8f:94:e5:3c -----BEGIN CERTIFICATE----- MIIDBjCCAe6gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYxMjA2MTQxNFoXDTMyMDYxMDA2MTQxNFowFTETMBEGA1UE AxMKbWluaWt1YmVDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMLu RbnGYx8V1eciWpJIhiPbDKIM5em0myl1BMDiK/KOKopHBm6B0BOQCghxmSMBV0eb HQCPlVAglxNsMkK1BMg6C10wnFW9KFMbh94EpwQY6RY4Rziqpwg1HGLD5S2Jrgvj O52+org75oGsdRL+95uhG6hG9524zkErld6YG1KmWblUzmDW8yuluEPhyodcjGH4 WUtHHHMgrT2O+g6ixbcti5qFP2w5RhboT6mR4oYC8y1mfWx0ZiN6NCSF2fYgsDl9 aIbQZ/GQ36u9UoVcu5mgq7mlvR4IaY5+4uDV8qVAducD3qrj+RYRye2jj5rDSEQg XkyNE/qg92iG9Y9flz8CAwEAAaNhMF8wDgYDVR0PAQH/BAQDAgKkMB0GA1UdJQQW MBQGCCsGAQUFBwMCBggrBgEFBQcDATAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQW BBRwU4aOAa7jT1ePsDDDMbBeMdt/ljANBgkqhkiG9w0BAQsFAAOCAQEAVjzeWQnO e7+SsP1EyueDSKL4pz0BsmJQYsvAfDNdJaL0Rq+IsALbhOZMy6N0Ru3vlkgV+cvX B0IOsD+/vSvmAmacprRc3vkKW2jMeg/qGrVO//+V97nEoR/ldmL0x4ItnaZ5mZXy 93dYEYcKdojjMv5KGJn9orhQKftK9XRMsgy1QnWTbLmA2xCLPknC8hWE5A/9myEF 7Q5mhQRY/9jD6eRExDAo+n+4eTyOwyhkzWzq21ei6bMmKtIYTvW5HSNIz773hWx+ 3ciFeK6Spx4sDirGXzqchI8tzSCsMKZ5800IjuOTMoEB3MV7DajY4xML1mgfPmkQ Fkqed0phj5TlPA == -----END CERTIFICATE----- \u56e0\u6b64\uff0c\u8981\u4fee\u5fa9 GET /version \u8acb\u6c42\u7684\u554f\u984c\uff0c\u6211\u53ea\u9700\u8981\u901a\u904e\u624b\u52d5\u5c07\u5176\u6307\u5411 minikubeCA \u8b49\u66f8\u4f86\u4f7f curl \u4fe1\u4efb API \u670d\u52d9\u5668\u8b49\u66f8\u7684\u9812\u767c\u8005\uff1a $ curl --cacert ~/.minikube/ca.crt $KUBE_API /version { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } Info \u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5728\u3000 curl \u547d\u4ee4\u4e2d\u4f7f\u7528 --insecure \u6a19\u8a8c\u6216\u5176\u77ed\u5225\u540d -k \u3002\u5728\u5b89\u5168\u7684\u74b0\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b61 insecure mode\uff0c\u5b83\u6bd4\u8a66\u5716\u627e\u5230\u9812\u767c\u8005\u8b49\u66f8\u66f4\u7c21\u55ae\u3002 Authenticating using Certificates \u00b6 \u597d\u7684\uff0c\u8b93\u6211\u5011\u5617\u8a66\u4e00\u4e9b\u66f4\u8907\u96dc\u7684\u6771\u897f\u3002\u5217\u51fa\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u90e8\u7f72\u600e\u9ebc\u6a23\uff1f $ curl --cacert ~/.minikube/ca.crt $KUBE_API /apis/apps/v1/deployments { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:anonymous\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" at the cluster scope\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u8207\u660e\u986f\u4e0d\u53d7\u4fdd\u8b77\u7684 /version \u7aef\u9ede\u4e0d\u540c\uff0cKubernetes \u901a\u5e38\u6703\u9650\u5236\u5c0d\u5176 API \u7aef\u9ede\u7684\u8a2a\u554f\u3002 \u5f9e\u932f\u8aa4\u6d88\u606f\u4e2d\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u51fa\uff0c\u8a72\u8acb\u6c42\u88ab\u9a57\u8b49\u70ba\u7528\u6236 system:anonymous \uff0c\u986f\u7136\uff0c\u8a72\u7528\u6236\u672a\u6388\u6b0a\u53ef\u547c\u53eb\u5217\u51fa\u90e8\u7f72\u8cc7\u6e90\u7684 API \u6b0a\u9650\u3002 \u9019\u500b\u5931\u6557\u7684\u8acb\u6c42\u5c0e\u56e0\u65bc\u6211\u5011\u4e26\u672a\u6aa2\u9644\u4efb\u4f55\u8eab\u4efd\u9a57\u8b49\u8cc7\u8a0a\uff08\u5118\u7ba1\u5982\u6b64\uff0c\u5b83\u5df2\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\uff0c\u4f46\u4f5c\u70ba\u533f\u540d\u7528\u6236\uff09\uff0c\u6240\u4ee5\u6211\u9700\u8981\u63d0\u4f9b\u4e00\u4e9b\u984d\u5916\u7684\u4fe1\u606f\u4f86\u7372\u5f97\u6240\u9700\u7684\u8a2a\u554f\u7d1a\u5225\u3002 Kubernetes \u652f\u6301\u591a\u7a2e \u8eab\u4efd\u9a57\u8b49\u6a5f\u5236 \uff0c\u6211\u5c07\u5f9e\u4f7f\u7528\u5ba2\u6236\u7aef\u8b49\u66f8(client certificate)\u5c0d\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u958b\u59cb\u3002 \u4f46\u662f\u7b49\u4e00\u4e0b\uff01\u4ec0\u9ebc\u662f\u5ba2\u6236\u8b49\u66f8(client certificate)\uff1f \u7576 minikube \u8a2d\u5b9a\u96c6\u7fa4\u6642\uff0c\u5b83\u9084\u5275\u5efa\u4e86\u4e00\u500b \u7528\u6236 \u3002\u8a72 \u7528\u6236 \u7372\u5f97\u4e86\u7531\u540c\u4e00\u500b minikubeCA \u9812\u767c\u6a5f\u69cb\u7c3d\u7f72\u7684\u8b49\u66f8\u3002\u7531\u65bc Kubernetes API \u670d\u52d9\u5668\u4fe1\u4efb\u6b64 CA\uff0c\u56e0\u6b64\u5728\u8acb\u6c42\u4e2d\u63d0\u4f9b\u6b64\u8b49\u66f8\u5c07\u4f7f\u5176\u4f5c\u70ba\u6240\u8ff0\u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 Info Kubernetes \u6c92\u6709\u4ee3\u8868 \u7528\u6236 \u7684\u5c0d\u8c61\u3002\u5373\u4e0d\u80fd\u901a\u904e API \u8abf\u7528\u5c07\u7528\u6236\u6dfb\u52a0\u5230\u96c6\u7fa4\u4e2d\u3002\u4f46\u662f\uff0c\u4efb\u4f55\u63d0\u4f9b\u7531\u96c6\u7fa4\u7684\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7c3d\u540d\u7684\u6709\u6548\u8b49\u66f8\u7684\u7528\u6236\u90fd\u88ab\u8996\u70ba\u5df2\u901a\u904e\u8eab\u4efd\u9a57\u8b49\u3002 Kubernetes \u5f9e\u8b49\u66f8\u4e3b\u984c\u4e2d\u7684\u901a\u7528\u540d\u7a31\u5b57\u6bb5\u4e2d\u7372\u53d6\u7528\u6236\u540d\uff08\u4f8b\u5982\uff0cCN = minikube-user\uff09\u3002\u7136\u5f8c\uff0cKubernetes RBAC \u5b50\u7cfb\u7d71\u5224\u65b7\u7528\u6236\u662f\u5426\u6709\u6b0a\u5c0d\u8cc7\u6e90\u57f7\u884c\u7279\u5b9a\u64cd\u4f5c\u3002 \u7528\u6236\u8b49\u66f8\u901a\u5e38\u53ef\u4ee5\u5728\u6211\u5011\u5df2\u7d93\u719f\u6089\u7684 kubectl \u914d\u7f6e\u8996\u5716\u8f38\u51fa\u4e2d\u627e\u5230\uff1a $ kubectl config view -o jsonpath = '{.users[0]}' | jq { \"name\" : \"minikube\" , \"user\" : { \"client-certificate\" : \"/home/dxlab/.minikube/profiles/minikube/client.crt\" , \"client-key\" : \"/home/dxlab/.minikube/profiles/minikube/client.key\" } } \u8b93\u6211\u5011\u5feb\u901f\u6aa2\u67e5\u8b49\u66f8\u5167\u5bb9\u4ee5\u78ba\u4fdd\u5b83\u662f\u7531\u540c\u4e00\u500b CA \u7c3d\u540d\u7684\uff1a $ cat ~/.minikube/profiles/cluster1/client.crt | openssl x509 -text Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 2 ( 0x2 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 26 21 :54:59 2022 GMT Not After : Jun 26 21 :54:59 2025 GMT Subject: O = system:masters, CN = minikube-user Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :a6:eb:74:10:82:be:42:94:2b:db:72:a6:17:7d: a5:9e:b4:d1:1b:34:c5:a4:71:ff:03:68:1b:1e:cb: 77 :57:bb:6f:fd:0e:d7:b5:62:8f:c8:66:22:36:7d: 01 :d3:f3:4b:3d:84:6a:03:0b:6f:e4:8e:3d:50:24: a4:ad:e0:89:1a:3f:05:af:d8:67:63:9d:44:92:73: 93 :ef:65:08:7e:05:76:45:69:6e:e7:b8:50:81:b6: 8b:82:a7:85:9b:9d:84:2d:db:d5:f5:73:a9:eb:08: a5:0b:f2:61:b8:66:a5:f9:84:09:68:8d:9f:56:8e: 1f:a7:71:f6:4f:67:31:03:8d:a2:17:2a:42:f4:de: 96 :11:2e:22:da:fa:f6:26:f2:de:7b:99:bb:66:b3: d0:3e:4a:f6:c3:7e:6d:0f:d5:ef:44:54:fd:7f:c1: c9:65:f7:7f:d4:50:73:2b:2a:ce:84:19:b0:a7:8a: 66 :cb:ed:f8:60:3a:4a:ac:36:e6:5a:8f:21:eb:4f: f8:fd:db:d3:55:d8:41:a9:34:00:20:9f:eb:9c:58: fd:32:0c:d5:a8:3d:13:82:5c:ef:5c:e6:a5:ac:a8: fb:71:ec:1a:d1:db:ad:f9:2c:40:3b:ee:59:0f:70: 36 :b1:8a:ab:95:1e:e6:0b:1e:01:c4:ab:a7:5c:c6: 10 :43 Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment X509v3 Extended Key Usage: TLS Web Server Authentication, TLS Web Client Authentication X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:70:53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption a3:4e:82:61:63:b9:bc:5c:3f:ba:4d:00:ae:b4:f0:a7:a3:9f: 39 :5b:2b:82:0c:4f:d8:a6:ef:07:45:de:b1:0f:85:70:50:8c: b3:9f:1f:a6:31:34:20:ee:59:89:3b:c5:03:5f:f0:8a:1c:b5: c4:44:c6:45:c4:f4:51:1c:28:4b:b0:0b:52:41:55:4a:04:06: 38 :0d:ab:65:e7:7a:6f:0b:eb:3c:7e:92:7f:f8:30:b8:73:dd: 62 :1c:19:f4:66:ff:88:57:f8:10:23:1b:c1:42:04:41:a1:94: 13 :d3:51:bb:8f:52:bf:f3:ff:50:66:cf:9e:e0:d4:1e:0b:44: 7f:e3:8e:2a:b9:07:62:a3:98:e1:50:c6:82:71:de:da:c8:83: 4a:6d:8f:78:f7:aa:53:5c:ed:68:db:b5:09:b2:1b:94:80:50: 71 :12:cb:92:c2:a3:5f:f1:9d:12:4f:b0:0a:08:39:25:d9:19: b3:ca:15:51:d6:01:b6:7d:58:81:cc:b5:85:47:b0:ff:d4:b3: 63 :ce:2e:b9:12:eb:c6:0e:c3:5f:88:62:7c:39:5f:2d:c5:d1: 56 :a6:68:7b:c1:29:5c:69:dc:ee:cf:af:92:6b:ad:3c:e8:bd: 6c:b9:1e:9d:35:3a:93:c1:4a:f2:64:d2:1b:bb:79:48:bc:89: 51 :81:0d:da -----BEGIN CERTIFICATE----- MIIDITCCAgmgAwIBAgIBAjANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYyNjIxNTQ1OVoXDTI1MDYyNjIxNTQ1OVowMTEXMBUGA1UE ChMOc3lzdGVtOm1hc3RlcnMxFjAUBgNVBAMTDW1pbmlrdWJlLXVzZXIwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCm63QQgr5ClCvbcqYXfaWetNEbNMWk cf8DaBsey3dXu2/9Dte1Yo/IZiI2fQHT80s9hGoDC2/kjj1QJKSt4IkaPwWv2Gdj nUSSc5PvZQh+BXZFaW7nuFCBtouCp4WbnYQt29X1c6nrCKUL8mG4ZqX5hAlojZ9W jh+ncfZPZzEDjaIXKkL03pYRLiLa+vYm8t57mbtms9A+SvbDfm0P1e9EVP1/wcll 93 /UUHMrKs6EGbCnimbL7fhgOkqsNuZajyHrT/j929NV2EGpNAAgn+ucWP0yDNWo PROCXO9c5qWsqPtx7BrR2635LEA77lkPcDaxiquVHuYLHgHEq6dcxhBDAgMBAAGj YDBeMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUH AwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBRwU4aOAa7jT1ePsDDDMbBeMdt/ ljANBgkqhkiG9w0BAQsFAAOCAQEAo06CYWO5vFw/uk0ArrTwp6OfOVsrggxP2Kbv B0XesQ+FcFCMs58fpjE0IO5ZiTvFA1/wihy1xETGRcT0URwoS7ALUkFVSgQGOA2r Zed6bwvrPH6Sf/gwuHPdYhwZ9Gb/iFf4ECMbwUIEQaGUE9NRu49Sv/P/UGbPnuDU HgtEf+OOKrkHYqOY4VDGgnHe2siDSm2PePeqU1ztaNu1CbIblIBQcRLLksKjX/Gd Ek+wCgg5JdkZs8oVUdYBtn1Ygcy1hUew/9SzY84uuRLrxg7DX4hifDlfLcXRVqZo e8EpXGnc7s+vkmutPOi9bLkenTU6k8FK8mTSG7t5SLyJUYEN2g == -----END CERTIFICATE----- \u4e0b\u9762\u662f\u5982\u4f55\u4f7f\u7528 curl \u5411 Kubernetes API \u670d\u52d9\u5668\u767c\u9001\u7531\u8a72\u8b49\u66f8\u8a8d\u8b49\u7684\u8acb\u6c42\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"654514\" } , \"items\" : [ ... ] - \"iss\" ( Issuer ) Claim - The \"iss\" ( issuer ) claim identifies the principal that issued the JWT. - \"sub\" ( Subject ) Claim -The \"sub\" ( subject ) claim identifies the principal that is the subject of the JWT. } Authenticating using Service Account Tokens \u00b6 \u53e6\u4e00\u7a2e\u9a57\u8b49 API \u8acb\u6c42\u7684\u65b9\u6cd5\u662f\u4f7f\u7528 \u670d\u52d9\u5e33\u6236 \u7684 JWT \u4ee4\u724c\u3002\u8207\u7528\u6236\u975e\u5e38\u76f8\u4f3c\uff0c\u4e0d\u540c\u7684 \u670d\u52d9\u5e33\u6236 \u5177\u6709\u4e0d\u540c\u7d1a\u5225\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u8b93\u6211\u5011\u770b\u770b\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u9ed8\u8a8d\u670d\u52d9\u5e33\u6236\u53ef\u4ee5\u5be6\u73fe\u4ec0\u9ebc\uff1a $ JWT_TOKEN_DEFAULT_DEFAULT = $( kubectl get secrets \\ $( kubectl get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_DEFAULT_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tNng1ZHEiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRiZjA0ZDczLWZlOTctNDMzMi04NDM2LWVjNDdlMDZkYzE2MSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.pkJ-AZufRuGcMGXwtL7jQu0BOa6DGgylzTjGcKQcOESjXeTsZfw8pnwHMOJsiV760QMLY33GtpzLy0om5l4gfU1O-CJZXKTaYCHzjyEb6ZVLK0xLeLwsW--LI_Weo0X9KiAjNBqDSUmj8NYHn2-c-wygN6IYWqbT8MmXL-YC8dejeqUlLzAQUw8hZasdWN6KLnmNxhI0-cntp0C8O2I5SPumOxq7IEX8s2Erir2cU2xGI-LPaMm8ccAk5wrKS9rqk23G24vXFgi9u1SwtujC_hZrki_rm8yrMUWvOa5SPZqAag_dkjLXR5YSxF_nJO69XGJ1fId3hr2ruHBTivbfEQ \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-6x5dq\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"dbf04d73-fe97-4332-8436-ec47e06dc161\" , \"sub\" : \"system:serviceaccount:default:default\" } \u5f9e\u4e00\u500b\u7c21\u55ae\u7684\u4efb\u52d9\u958b\u59cb - \u5728 apps/v1 \u4e2d\u5217\u51fa\u5df2\u77e5\u7684 API \u8cc7\u6e90\u985e\u578b\uff1a $ curl $KUBE_API /apis/apps/v1/ \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"APIResourceList\" , \"apiVersion\" : \"v1\" , \"groupVersion\" : \"apps/v1\" , \"resources\" : [ ... ] } \u63a5\u8457\u8b93\u6211\u5011\u5617\u8a66\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa\u5be6\u969b\u7684\u90e8\u7f72\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u986f\u7136\uff0c\u7528\u6236 system:serviceaccount:default:default \u751a\u81f3\u4e0d\u8db3\u4ee5\u5728\u5176\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa Kubernetes \u5c0d\u8c61\u3002 \u8b93\u6211\u5011\u5617\u8a66\u4e00\u500b\u5f37\u5927\u7684 kube-system \u670d\u52d9\u5e33\u6236\uff1a $ JWT_TOKEN_KUBESYSTEM_DEFAULT = $( kubectl -n kube-system get secrets \\ $( kubectl -n kube-system get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_KUBESYSTEM_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZWZhdWx0LXRva2VuLW16bWo3Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRlZmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhN2E4YTc1Mi1jNjQ5LTRkOGYtOTQzMi03MDgxYjE4YzBiNTIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06ZGVmYXVsdCJ9.talXOCcsaH5VaZEOJo-VilVZUhM6YWrChmKScXHcTwDfVBmX6XlrelomnYMUtwahnF1aGe_vJpLzk-SJhvdLvFSAvw0pIWxsabes7ITfCdOfAMliPhiCIOC4XwawKWmbVJYcvhHppNA41qzNAbtav_e9qB6z84fmAQHQJLITMmMfe-ZC38I3sWh5ezoo-1uiV3iY6SHxd4WGXmuRBqkvWxJM7JiC2TmUU9Z6K4gfrRtfBrB2-A3Ti6v7Jcqwxakqq092X7VpstmJTHgh6KExm-0laIUSOKwUFlFvs4-MYKwmbYdz4IYDxJejZjcfC8XkTM6nQPaXdaTA6olKBzKHKg \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"kube-system\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-mzmj7\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"a7a8a752-c649-4d8f-9432-7081b18c0b52\" , \"sub\" : \"system:serviceaccount:kube-system:default\" } \u5f37\u5927\u7684\u5e33\u6236\u503c\u5f97\u4e00\u9805\u5177\u6709\u6311\u6230\u6027\u7684\u4efb\u52d9 - \u5217\u51fa\u96c6\u7fa4\u7d1a\u8cc7\u6e90\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_KUBESYSTEM_DEFAULT \" { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"656580\" } , \"items\" : [ ... ] } \u662f\u7684\uff0c\u7b26\u5408\u6211\u5011\u7684\u671f\u5f85\u5730\u5b8c\u6210\u5de5\u4f5c\ud83d\udc4c Call Kubernetes API inside a Pod \u00b6 \u8207\u4efb\u4f55\u5176\u4ed6 Kubernetes \u670d\u52d9\u975e\u5e38\u76f8\u4f3c\uff0cKubernetes API \u670d\u52d9\u5730\u5740\u53ef\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u63d0\u4f9b\u7d66 Pod\uff1a $ kubectl run -it --image curlimages/curl --restart = Never mypod -- sh $ env | grep KUBERNETES KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 Pod \u901a\u5e38\u9084\u6703\u5728 /var/run/secrets/kubernetes.io/serviceaccount/ \u4e0a\u5b89\u88dd Kubernetes CA \u8b49\u66f8\u548c \u670d\u52d9\u5e33\u6236 credentials\u3002\u56e0\u6b64\uff0c\u61c9\u7528\u4ee5\u4e0a\u90e8\u5206\u7684\u77e5\u8b58\uff0c\u5f9e Pod \u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u7684 curl \u547d\u4ee4\u53ef\u4ee5\u5982\u4e0b\u6240\u793a\uff1a $ curl https:// ${ KUBERNETES_SERVICE_HOST } : ${ KUBERNETES_SERVICE_PORT } /apis/apps/v1 \\ --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \\ --header \"Authorization: Bearer $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \" Creat, Read, Watch, Update, Patch, and Delete objects \u00b6 Kubernetes API \u652f\u6301\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u4ee5\u4e0b \u64cd\u4f5c \uff1a GET /<resourcePlural> - Retrieve a list of type . POST /<resourcePlural> - Create a new resource from the JSON object provided by the client. GET /<resourcePlural>/<name> - Retrieves a single resource with the given name. DELETE /<resourcePlural>/<name> - Delete the single resource with the given name. DELETE /<resourcePlural> - Deletes a list of type . PUT /<resourcePlural>/<name> - Update or create the resource with the given name with the JSON object provided by client. PATCH /<resourcePlural>/<name> - Selectively modify the specified fields of the resource. GET /<resourcePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. API \u662f RESTful \u7684\u578b\u5f0f\uff0c\u56e0\u6b64\u4e0a\u8ff0 HTTP \u65b9\u6cd5\u5728\u8cc7\u6e90\u64cd\u4f5c\u4e0a\u7684\u6620\u5c04\u61c9\u8a72\u770b\u8d77\u4f86\u5f88\u719f\u6089\u3002 Info \u5373\u4f7f\u6587\u6a94\u50c5\u63d0\u53ca JSON \u5c0d\u8c61\uff0c\u5982\u679c Content-Type \u6a19\u982d\u8a2d\u7f6e\u70ba application/yaml \uff0c\u5247\u652f\u6301\u63d0\u4ea4 YAML \u6709\u6548\u8ca0\u8f09\u3002 CREATE \u4ee5\u4e0b\u662f\u4f7f\u7528 curl \u548c YAML \u6e05\u55ae\u5275\u5efa\u65b0\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X POST \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"365d\"] ' READ \u4ee5\u4e0b\u662f\u5982\u4f55\u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4ee5\u53ca\u5982\u4f55\u901a\u904e\u540d\u7a31\u548c\u547d\u540d\u7a7a\u9593\u7372\u53d6\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4e00\u7a2e\u66f4\u9ad8\u7d1a\u7684\u6aa2\u7d22 Kubernetes \u8cc7\u6e90\u7684\u65b9\u6cd5\u662f\u6301\u7e8c\u89c0\u5bdf\u5b83\u5011\u7684\u8b8a\u5316\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments?watch = true \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key Info \u8acb\u6ce8\u610f\uff0c\u53ea\u80fd\u76e3\u8996\u4e00\u7d44\u8cc7\u6e90\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u63d0\u4f9b\u6a19\u7c64\u6216\u5b57\u6bb5\u9078\u64c7\u5668\u5c07\u7d50\u679c\u96c6\u7e2e\u5c0f\u5230\u55ae\u500b\u8cc7\u6e90\u3002 UPDATE \u4ee5\u4e0b\u662f\u66f4\u65b0\u73fe\u6709\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PUT \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"730d\"] # <-- Making it sleep twice longer ' \u4ee5\u4e0b\u662f\u5982\u4f55\u4fee\u88dc\u73fe\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PATCH \\ -H 'Content-Type: application/merge-patch+json' \\ -d '{ \"spec\": { \"template\": { \"spec\": { \"containers\": [ { \"name\": \"sleep\", \"image\": \"curlimages/curl\", \"command\": [\"/bin/sleep\", \"1d\"] } ] } } } }' Info \u8acb\u6ce8\u610f UPDATE \u548c PATCH \u662f\u76f8\u7576\u68d8\u624b\u7684\u64cd\u4f5c\u3002\u7b2c\u4e00\u500b\u53d7\u5230\u5404\u7a2e\u7248\u672c\u885d\u7a81\u7684\u5f71\u97ff\uff0c\u7b2c\u4e8c\u500b\u7684\u884c\u70ba\u56e0\u4f7f\u7528\u7684\u88dc\u4e01\u7b56\u7565\u800c\u7570\u3002 DELETE \u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f - \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u5c0d\u8c61\u96c6\u5408\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u55ae\u500b\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE How to call Kubernetes API using kubectl \u00b6 \u4e0a\u9762\u4f7f\u7528\u8b49\u66f8\u548c\u4ee4\u724c\u4f86\u547c\u53eb Kubernetes API \u5f88\u6709\u8da3\u3002\u81f3\u5c11\u7d93\u6b77\u4e00\u6b21\u662f\u4e00\u500b\u5f88\u597d\u7684\u7df4\u7fd2\uff0c\u53ef\u4ee5\u978f\u56fa\u5c0d\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u79fb\u52d5\u90e8\u4ef6\u7684\u7406\u89e3\u3002\u4f46\u662f\uff0c\u7576\u4f60\u6709\u4e00\u500b\u53ef\u4ee5\u4f7f\u7528\u7684 kubectl \u6642\uff0c\u6bcf\u5929\u90fd\u9019\u6a23\u505a\u53ef\u80fd\u6703\u6709\u9ede\u77ef\u6789\u904e\u6b63\u3002 Calling Kubernetes API using kubectl proxy \u00b6 \u4f7f\u7528\u6b63\u78ba\u914d\u7f6e\u7684 kubectl \u5de5\u5177\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl proxy \u547d\u4ee4\u5927\u5927\u7c21\u5316 API \u8a2a\u554f\u3002 kubectl proxy \u547d\u4ee4\u5728\u60a8\u7684 localhost \u548c Kubernetes API \u670d\u52d9\u5668 \u4e4b\u9593\u5275\u5efa\u4e00\u500b\u4ee3\u7406\u670d\u52d9\u5668\uff08\u6216\u61c9\u7528\u7a0b\u5e8f\u7d1a\u7db2\u95dc\uff09\u3002\u4f46\u5b83\u5fc5\u9808\u4e0d\u6b62\u65bc\u6b64\u3002\u4e0d\u7136\u600e\u9ebc\u6703\u9019\u9ebc\u65b9\u4fbf\uff1f \u4ee3\u7406 kubectl \u5f9e\u8abf\u7528\u8005\u90a3\u88e1\u5378\u8f09\u4e86\u76f8\u4e92\u7684\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u8cac\u4efb\u3002\u7531\u65bc\u8abf\u7528\u8005\u548c\u4ee3\u7406\u4e4b\u9593\u7684\u901a\u4fe1\u767c\u751f\u5728\u672c\u5730\u4e3b\u6a5f\u4e0a\uff0c\u56e0\u6b64\u5b83\u88ab\u8a8d\u70ba\u662f\u5b89\u5168\u7684\u3002\u4e26\u4e14\u4ee3\u7406\u672c\u8eab\u4f7f\u7528 kubeconfig \u6587\u4ef6\u4e2d\u9078\u64c7\u7684\u7576\u524d\u4e0a\u4e0b\u6587\u4e2d\u7684\u4fe1\u606f\u4f86\u8655\u7406\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u3002 $ kubectl config current-context minikube $ kubectl proxy --port = 8080 & \u555f\u52d5\u4ee3\u7406\u670d\u52d9\u5668\u5f8c\uff0c\u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u5c31\u8b8a\u5f97\u7c21\u55ae\u591a\u4e86\uff1a $ curl localhost:8080/apis/apps/v1/deployments { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"660883\" } , \"items\" : [ ... ] } Calling Kubernetes API using kubectl raw mode \u00b6 \u6211\u6700\u8fd1\u5b78\u5230\u7684\u53e6\u4e00\u500b\u5f88\u9177\u7684\u6280\u5de7\u662f\u4e00\u4e9b kubectl \u547d\u4ee4\u652f\u6301\u7684\u539f\u59cb\u6a21\u5f0f\uff1a # Sends HTTP GET request $ kubectl get --raw /api/v1/namespaces/default/pods # Sends HTTP POST request $ kubectl create --raw /api/v1/namespaces/default/pods -f file.yaml # Sends HTTP PUT request $ kubectl replace --raw /api/v1/namespaces/default/pods/mypod -f file.json # Sends HTTP DELETE request $ kubectl delete --raw /api/v1/namespaces/default/pods kubectl \u662f\u4e00\u500b\u975e\u5e38\u5148\u9032\u7684\u5de5\u5177\uff0c\u5373\u4f7f\u662f\u50cf kubectl \u9019\u6a23\u7684\u7c21\u55ae\u547d\u4ee4\u4e5f\u6709\u5927\u91cf\u4ee3\u78bc\u3002\u4f46\u662f\uff0c\u7576\u4f7f\u7528 --raw \u6a19\u8a8c\u6642\uff0c\u5be6\u73fe\u6b78\u7d50\u70ba\u5c07\u552f\u4e00\u7684\u53c3\u6578\u8f49\u63db\u70ba API \u7aef\u9ede URL \u4e26\u8abf\u7528\u539f\u59cb REST API \u5ba2\u6236\u7aef\u3002 Wrapping up \u00b6 \u7b2c\u4e00\u6b21\u8a2a\u554f Kubernetes API \u7684\u9700\u6c42\u53ef\u80fd\u5f88\u53ef\u6015 - \u6709\u5f88\u591a\u65b0\u6982\u5ff5\uff0c\u5982\u8cc7\u6e90\u3001API \u7d44\u3001\u7a2e\u985e\u3001\u5c0d\u8c61\u3001\u96c6\u7fa4\u3001\u4e0a\u4e0b\u6587\u3001\u8b49\u66f8\uff0c\u54e6\uff0c\u5929\u54ea\uff01\u4f46\u662f\u4e00\u65e6\u4f60\u5728\u69cb\u5efa\u584a\u4e0a\u5206\u89e3\u5b83\u4e26\u901a\u904e\u57f7\u884c\u4e00\u4e9b\u7463\u788e\u7684\u4efb\u52d9\uff08\u6bd4\u5982\u627e\u51fa API \u670d\u52d9\u5668\u5730\u5740\u6216\u4f7f\u7528 curl \u8abf\u7528\u4e00\u5806\u7aef\u9ede\uff09\u7372\u5f97\u4e00\u4e9b\u5be6\u8e10\u7d93\u9a57\uff0c\u4f60\u5f88\u5feb\u5c31\u6703\u610f\u8b58\u5230\u9019\u500b\u60f3\u6cd5\u52d5\u7269\u5712\u4e26\u4e0d\u662f\u771f\u7684\u4e00\u4e9b\u65b0\u7684\u6771\u897f\u2014\u2014\u5b83\u53ea\u662f\u591a\u5e74\u4f86\u70ba\u6211\u5011\u670d\u52d9\u7684\u773e\u6240\u5468\u77e5\u7684\u6a5f\u5236\u7684\u7d44\u5408 \u2014 REST \u67b6\u69cb\u98a8\u683c\u3001TLS \u8b49\u66f8\u3001JWT \u4ee4\u724c\u3001\u5c0d\u8c61\u65b9\u6848\u7b49\u3002 \u6240\u4ee5\uff0c\u4e0d\u8981\u5bb3\u6015\u4e26\u904b\u884c\u4e00\u4e9b\u67e5\u8a62\uff01 Info \u8feb\u4e0d\u53ca\u5f85\u60f3\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8abf\u7528 API\uff1f\u5728 GitHub \u4e0a\u67e5\u770b\u6211\u6536\u96c6\u7684 Kubernetes \u5ba2\u6236\u7aef\u793a\u4f8b \ud83d\ude09 Resources \u00b6 Kubernetes Documentation - Access Clusters Using the Kubernetes API Kubernetes Documentation - Configure Access to Multiple Clusters Kubernetes Documentation - Authenticating Kubernetes Documentation - Controlling Access to the Kubernetes API Kubernetes Documentation - Configure Service Accounts for Pods Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"\u7528 HTTP \u5ba2\u6236\u7aef\u8abf\u7528 K8S API"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#http-kubernetes-api","text":"\u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-call-simple-http-client/ \u4f7f\u7528 CLI\uff08\u5982 curl\uff09\u6216 GUI\uff08\u5982 postman\uff09HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API \u6709\u5f88\u591a\u4f7f\u7528\u60c5\u5883\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u6bd4 kubectl \u63d0\u4f9b\u7684\u66f4\u7d30\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u6216\u8005\u53ea\u662f\u60f3\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u8a2a\u554f API \u4e4b\u524d\u63a2\u7d22\u5b83\u3002 \u672c\u6587\u4e0d\u50c5\u50c5\u662f\u4e00\u500b\u65b9\u4fbf\u7684\u547d\u4ee4\u5217\u8868\uff0c\u800c\u662f\u4e00\u500b\u6df1\u601d\u719f\u616e\u7684\u6f14\u7df4\uff0c\u63ed\u793a\u4e86\u4e00\u4e9b\u60a8\u5728\u5f9e\u547d\u4ee4\u884c\u8abf\u7528 Kubernetes API \u6642\u53ef\u80fd\u6703\u5076\u7136\u767c\u73fe\u7684\u6709\u8da3\u554f\u984c\u3002\u5b83\u6db5\u84cb\u4ee5\u4e0b\u4e3b\u984c\uff1a \u5982\u4f55\u7372\u53d6 Kubernetes API \u670d\u52d9\u5668\u5730\u5740 \u5982\u4f55\u5411\u5ba2\u6236\u7aef\u9a57\u8b49 API \u670d\u52d9\u5668 \u5982\u4f55\u4f7f\u7528\u8b49\u66f8 (certificate) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u4f7f\u7528\u4ee4\u724c (token) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u5f9e Pod \u5167\u90e8\u8abf\u7528 Kubernetes API \u5982\u4f55\u4f7f\u7528 curl \u5c0d Kubernetes \u5c0d\u8c61\u57f7\u884c\u57fa\u672c\u7684 CRUD \u64cd\u4f5c \u5982\u4f55\u4f7f\u7528 kubectl \u7684 raw \u6a21\u5f0f\u76f4\u63a5\u8a2a\u554f Kubernetes API \u5982\u4f55\u67e5\u770b\u54ea\u4e9b API \u8acb\u6c42 kubectl \u547d\u4ee4\uff08\u5982 apply \u767c\u9001\uff09","title":"\u7528 HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#setting-up-kubernetes-playground","text":"\u5982\u679c\u4f60\u6c92\u6709 Kubernetes \u96c6\u7fa4\u53ef\u4ee5\u73a9\uff0c\u9019\u88e1\u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 arkade \u5feb\u901f\u5275\u5efa\u672c\u5730\u904a\u6a02\u5834\u7684\u65b9\u6cd5\uff1a $ curl -sLS https://get.arkade.dev | sudo sh $ arkade get minikube kubectl $ minikube start --profile cluster1","title":"Setting up Kubernetes playground"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#how-to-get-kubernetes-api-host-and-port","text":"\u8981\u8abf\u7528\u4efb\u4f55 API\uff0c\u60a8\u9996\u5148\u9700\u8981\u77e5\u9053\u5176\u670d\u52d9\u5668\u5730\u5740\u3002\u5c0d\u65bc Kubernetes\uff0c\u6bcf\u500b\u96c6\u7fa4\u90fd\u6709\u4e00\u500b API \u670d\u52d9\u5668\u3002\u56e0\u6b64\uff0c\u67e5\u627e API \u4e3b\u6a5f\u548c\u7aef\u53e3\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u67e5\u770b kubectl cluster-info \u8f38\u51fa\u3002\u4f8b\u5982\uff0c\u5728\u6211\u7684 Vagrant \u76d2\u5b50\u4e0a\uff0c\u5b83\u6703\u7522\u751f\u4ee5\u4e0b\u8a0a\u606f\uff1a $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy ... cluster-info \u547d\u4ee4\u986f\u793a\u5728 \u7576\u524d\u4e0a\u4e0b\u6587 \u4e2d\u9078\u64c7\u7684\u96c6\u7fa4\u7684 API \u5730\u5740\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u6709\u591a\u500b\u96c6\u7fa4\u600e\u9ebc\u8fa6\uff1f $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority: /home/dxlab/.minikube/ca.crt extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: cluster_info server: https://192.168.49.2:8443 name: minikube contexts: - context: cluster: minikube extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: context_info namespace: default user: minikube name: minikube current-context: minikube kind: Config preferences: {} users: - name: minikube user: client-certificate: /home/dxlab/.minikube/profiles/minikube/client.crt client-key: /home/dxlab/.minikube/profiles/minikube/client.key Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c kubectl \u5728 $HOME/.kube \u76ee\u9304\u4e2d\u67e5\u627e\u540d\u70ba config \u7684\u6587\u4ef6\u3002\u90a3\u9ebc\uff0c\u70ba\u4ec0\u9ebc\u4e0d\u76f4\u63a5\u5f9e\u9019\u500b\u6587\u4ef6\u4e2d\u7372\u53d6 API \u5730\u5740\u5462\uff1f \u539f\u56e0\u662f\u6f5b\u5728\u7684\u914d\u7f6e\u5408\u4f75\u3002\u901a\u904e\u5c07 KUBECONFIG env var \u8a2d\u7f6e\u70ba\u4ee5\u5192\u865f\u5206\u9694\u7684\u4f4d\u7f6e\u5217\u8868\uff0c\u53ef\u4ee5\u6307\u5b9a\u591a\u500b kubeconfig \u6587\u4ef6\u3002\u5728\u8a2a\u554f\u96c6\u7fa4\u4e4b\u524d\uff0c kubectl \u6703\u5617\u8a66\u5c07\u6240\u6709 kubeconfig \u6587\u4ef6\u7684\u5167\u5bb9\u5408\u4f75\u5230\u4e00\u500b\u914d\u7f6e\u4e2d\u3002 \u56e0\u6b64\uff0c\u5f9e\u4e0a\u9762\u7684\u5217\u8868\u4e2d\u9078\u64c7\u6b63\u78ba\u7684\u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u5617\u8a66\u5411\u5176 API \u670d\u52d9\u5668\u767c\u9001\u8acb\u6c42\uff1a $ KUBE_API = $( kubectl config view -o jsonpath = '{.clusters[0].cluster.server}' )","title":"How to get Kubernetes API host and port"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#how-to-call-kubernetes-api-using-curl","text":"\u5be6\u969b\u4e0a\uff0c\u4efb\u4f55 HTTP \u5ba2\u6236\u7aef\uff08curl\u3001httpie\u3001wget \u751a\u81f3 postman\uff09\u90fd\u53ef\u4ee5\uff0c\u4f46\u6211\u5c07\u5728\u672c\u7bc0\u4e2d\u4f7f\u7528 curl \u3002","title":"How to call Kubernetes API using curl"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#authenticating-api-server-to-client","text":"\u8b93\u6211\u5011\u5f9e\u67e5\u8a62 API \u7684 /version \u7aef\u9ede\u958b\u59cb\uff1a $ curl $KUBE_API /version curl: ( 60 ) SSL certificate problem: unable to get local issuer certificate More details here: https://curl.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. \u5f88\u986f\u7136\u2026\u2026\u6211\u5011\u9023\u63a5\u5931\u6557\u4e86\uff01 \ud83d\ude48 \u7576\u6211\u7b2c\u4e00\u6b21\u5076\u7136\u767c\u73fe\u985e\u4f3c\u7684\u932f\u8aa4\u6642\uff0c\u6211\u771f\u7684\u5f88\u56f0\u60d1\u3002\u4f46\u4ed4\u7d30\u60f3\u60f3\uff0c\u4e0a\u8ff0\u932f\u8aa4\u5be6\u969b\u4e0a\u662f\u6709\u9053\u7406\u7684\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cKubernetes \u901a\u904e HTTPS \u516c\u958b\u5176 API\uff0c\u7279\u5225\u662f\u70ba\u4e86\u5411\u5ba2\u6236\u7aef\u4fdd\u8b49 API \u670d\u52d9\u5668\u7684\u5f37\u8eab\u4efd\u3002\u4f46\u662f\uff0cminikube \u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\u4f86\u8a2d\u5b9a\u672c\u5730\u96c6\u7fa4\u3002\u56e0\u6b64\uff0cKubernetes API \u670d\u52d9\u5668\u7684 TLS \u8b49\u66f8\u539f\u4f86\u662f\u7531\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u7c3d\u7f72\u7684(self-signed)\uff0c\u8a72\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u5c0d curl \u662f\u672a\u77e5\u7684 \u3002curl \u7121\u6cd5\u4fe1\u4efb\u5b83\uff0c\u56e0\u6b64\u8acb\u6c42\u5931\u6557\u3002 Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0ccurl \u4fe1\u4efb\u5e95\u5c64\u64cd\u4f5c\u7cfb\u7d71\u6240\u4fe1\u4efb\u7684\u540c\u4e00\u7d44 CA\u3002\u4f8b\u5982\uff0c\u5728 Ubuntu \u6216 Debian \u4e0a\uff0c\u53ef\u4ee5\u5728 /etc/ssl/certs/ca-certificates.crt \u4e2d\u627e\u5230\u53d7\u4fe1\u4efb\u7684 CA \u5217\u8868\u3002\u986f\u7136\uff0cminikube \u4e0d\u6703\u5c07\u5176\u8b49\u66f8\u6dfb\u52a0\u5230\u6b64\u6587\u4ef6\u4e2d\u3002 \u5e78\u904b\u7684\u662f\uff0cminikube \u5c07 CA \u8b49\u66f8\u4fdd\u5b58\u5230 ~/.minikube/ca.crt \uff1a $ cat ~/.minikube/ca.crt | openssl x509 -text \u7d50\u679c: Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 1 ( 0x1 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 12 06 :14:14 2022 GMT Not After : Jun 10 06 :14:14 2032 GMT Subject: CN = minikubeCA Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :c2:ee:45:b9:c6:63:1f:15:d5:e7:22:5a:92:48: 86 :23:db:0c:a2:0c:e5:e9:b4:9b:29:75:04:c0:e2: 2b:f2:8e:2a:8a:47:06:6e:81:d0:13:90:0a:08:71: 99 :23:01:57:47:9b:1d:00:8f:95:50:20:97:13:6c: 32 :42:b5:04:c8:3a:0b:5d:30:9c:55:bd:28:53:1b: 87 :de:04:a7:04:18:e9:16:38:47:38:aa:a7:08:35: 1c:62:c3:e5:2d:89:ae:0b:e3:3b:9d:be:a2:b8:3b: e6:81:ac:75:12:fe:f7:9b:a1:1b:a8:46:f7:9d:b8: ce:41:2b:95:de:98:1b:52:a6:59:b9:54:ce:60:d6: f3:2b:a5:b8:43:e1:ca:87:5c:8c:61:f8:59:4b:47: 1c:73:20:ad:3d:8e:fa:0e:a2:c5:b7:2d:8b:9a:85: 3f:6c:39:46:16:e8:4f:a9:91:e2:86:02:f3:2d:66: 7d:6c:74:66:23:7a:34:24:85:d9:f6:20:b0:39:7d: 68 :86:d0:67:f1:90:df:ab:bd:52:85:5c:bb:99:a0: ab:b9:a5:bd:1e:08:69:8e:7e:e2:e0:d5:f2:a5:40: 76 :e7:03:de:aa:e3:f9:16:11:c9:ed:a3:8f:9a:c3: 48 :44:20:5e:4c:8d:13:fa:a0:f7:68:86:f5:8f:5f: 97 :3f Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment, Certificate Sign X509v3 Extended Key Usage: TLS Web Client Authentication, TLS Web Server Authentication X509v3 Basic Constraints: critical CA:TRUE X509v3 Subject Key Identifier: 70 :53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption 56 :3c:de:59:09:ce:7b:bf:92:b0:fd:44:ca:e7:83:48:a2:f8: a7:3d:01:b2:62:50:62:cb:c0:7c:33:5d:25:a2:f4:46:af:88: b0:02:db:84:e6:4c:cb:a3:74:46:ed:ef:96:48:15:f9:cb:d7: 07 :42:0e:b0:3f:bf:bd:2b:e6:02:66:9c:a6:b4:5c:de:f9:0a: 5b:68:cc:7a:0f:ea:1a:b5:4e:ff:ff:95:f7:b9:c4:a1:1f:e5: 76 :62:f4:c7:82:2d:9d:a6:79:99:95:f2:f7:77:58:11:87:0a: 76 :88:e3:32:fe:4a:18:99:fd:a2:b8:50:29:fb:4a:f5:74:4c: b2:0c:b5:42:75:93:6c:b9:80:db:10:8b:3e:49:c2:f2:15:84: e4:0f:fd:9b:21:05:ed:0e:66:85:04:58:ff:d8:c3:e9:e4:44: c4:30:28:fa:7f:b8:79:3c:8e:c3:28:64:cd:6c:ea:db:57:a2: e9:b3:26:2a:d2:18:4e:f5:b9:1d:23:48:cf:be:f7:85:6c:7e: dd:c8:85:78:ae:92:a7:1e:2c:0e:2a:c6:5f:3a:9c:84:8f:2d: cd:20:ac:30:a6:79:f3:4d:08:8e:e3:93:32:81:01:dc:c5:7b: 0d:a8:d8:e3:13:0b:d6:68:1f:3e:69:10:16:4a:9e:77:4a:61: 8f:94:e5:3c -----BEGIN CERTIFICATE----- MIIDBjCCAe6gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYxMjA2MTQxNFoXDTMyMDYxMDA2MTQxNFowFTETMBEGA1UE AxMKbWluaWt1YmVDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMLu RbnGYx8V1eciWpJIhiPbDKIM5em0myl1BMDiK/KOKopHBm6B0BOQCghxmSMBV0eb HQCPlVAglxNsMkK1BMg6C10wnFW9KFMbh94EpwQY6RY4Rziqpwg1HGLD5S2Jrgvj O52+org75oGsdRL+95uhG6hG9524zkErld6YG1KmWblUzmDW8yuluEPhyodcjGH4 WUtHHHMgrT2O+g6ixbcti5qFP2w5RhboT6mR4oYC8y1mfWx0ZiN6NCSF2fYgsDl9 aIbQZ/GQ36u9UoVcu5mgq7mlvR4IaY5+4uDV8qVAducD3qrj+RYRye2jj5rDSEQg XkyNE/qg92iG9Y9flz8CAwEAAaNhMF8wDgYDVR0PAQH/BAQDAgKkMB0GA1UdJQQW MBQGCCsGAQUFBwMCBggrBgEFBQcDATAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQW BBRwU4aOAa7jT1ePsDDDMbBeMdt/ljANBgkqhkiG9w0BAQsFAAOCAQEAVjzeWQnO e7+SsP1EyueDSKL4pz0BsmJQYsvAfDNdJaL0Rq+IsALbhOZMy6N0Ru3vlkgV+cvX B0IOsD+/vSvmAmacprRc3vkKW2jMeg/qGrVO//+V97nEoR/ldmL0x4ItnaZ5mZXy 93dYEYcKdojjMv5KGJn9orhQKftK9XRMsgy1QnWTbLmA2xCLPknC8hWE5A/9myEF 7Q5mhQRY/9jD6eRExDAo+n+4eTyOwyhkzWzq21ei6bMmKtIYTvW5HSNIz773hWx+ 3ciFeK6Spx4sDirGXzqchI8tzSCsMKZ5800IjuOTMoEB3MV7DajY4xML1mgfPmkQ Fkqed0phj5TlPA == -----END CERTIFICATE----- \u56e0\u6b64\uff0c\u8981\u4fee\u5fa9 GET /version \u8acb\u6c42\u7684\u554f\u984c\uff0c\u6211\u53ea\u9700\u8981\u901a\u904e\u624b\u52d5\u5c07\u5176\u6307\u5411 minikubeCA \u8b49\u66f8\u4f86\u4f7f curl \u4fe1\u4efb API \u670d\u52d9\u5668\u8b49\u66f8\u7684\u9812\u767c\u8005\uff1a $ curl --cacert ~/.minikube/ca.crt $KUBE_API /version { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } Info \u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5728\u3000 curl \u547d\u4ee4\u4e2d\u4f7f\u7528 --insecure \u6a19\u8a8c\u6216\u5176\u77ed\u5225\u540d -k \u3002\u5728\u5b89\u5168\u7684\u74b0\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b61 insecure mode\uff0c\u5b83\u6bd4\u8a66\u5716\u627e\u5230\u9812\u767c\u8005\u8b49\u66f8\u66f4\u7c21\u55ae\u3002","title":"Authenticating API server to client"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#authenticating-using-certificates","text":"\u597d\u7684\uff0c\u8b93\u6211\u5011\u5617\u8a66\u4e00\u4e9b\u66f4\u8907\u96dc\u7684\u6771\u897f\u3002\u5217\u51fa\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u90e8\u7f72\u600e\u9ebc\u6a23\uff1f $ curl --cacert ~/.minikube/ca.crt $KUBE_API /apis/apps/v1/deployments { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:anonymous\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" at the cluster scope\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u8207\u660e\u986f\u4e0d\u53d7\u4fdd\u8b77\u7684 /version \u7aef\u9ede\u4e0d\u540c\uff0cKubernetes \u901a\u5e38\u6703\u9650\u5236\u5c0d\u5176 API \u7aef\u9ede\u7684\u8a2a\u554f\u3002 \u5f9e\u932f\u8aa4\u6d88\u606f\u4e2d\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u51fa\uff0c\u8a72\u8acb\u6c42\u88ab\u9a57\u8b49\u70ba\u7528\u6236 system:anonymous \uff0c\u986f\u7136\uff0c\u8a72\u7528\u6236\u672a\u6388\u6b0a\u53ef\u547c\u53eb\u5217\u51fa\u90e8\u7f72\u8cc7\u6e90\u7684 API \u6b0a\u9650\u3002 \u9019\u500b\u5931\u6557\u7684\u8acb\u6c42\u5c0e\u56e0\u65bc\u6211\u5011\u4e26\u672a\u6aa2\u9644\u4efb\u4f55\u8eab\u4efd\u9a57\u8b49\u8cc7\u8a0a\uff08\u5118\u7ba1\u5982\u6b64\uff0c\u5b83\u5df2\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\uff0c\u4f46\u4f5c\u70ba\u533f\u540d\u7528\u6236\uff09\uff0c\u6240\u4ee5\u6211\u9700\u8981\u63d0\u4f9b\u4e00\u4e9b\u984d\u5916\u7684\u4fe1\u606f\u4f86\u7372\u5f97\u6240\u9700\u7684\u8a2a\u554f\u7d1a\u5225\u3002 Kubernetes \u652f\u6301\u591a\u7a2e \u8eab\u4efd\u9a57\u8b49\u6a5f\u5236 \uff0c\u6211\u5c07\u5f9e\u4f7f\u7528\u5ba2\u6236\u7aef\u8b49\u66f8(client certificate)\u5c0d\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u958b\u59cb\u3002 \u4f46\u662f\u7b49\u4e00\u4e0b\uff01\u4ec0\u9ebc\u662f\u5ba2\u6236\u8b49\u66f8(client certificate)\uff1f \u7576 minikube \u8a2d\u5b9a\u96c6\u7fa4\u6642\uff0c\u5b83\u9084\u5275\u5efa\u4e86\u4e00\u500b \u7528\u6236 \u3002\u8a72 \u7528\u6236 \u7372\u5f97\u4e86\u7531\u540c\u4e00\u500b minikubeCA \u9812\u767c\u6a5f\u69cb\u7c3d\u7f72\u7684\u8b49\u66f8\u3002\u7531\u65bc Kubernetes API \u670d\u52d9\u5668\u4fe1\u4efb\u6b64 CA\uff0c\u56e0\u6b64\u5728\u8acb\u6c42\u4e2d\u63d0\u4f9b\u6b64\u8b49\u66f8\u5c07\u4f7f\u5176\u4f5c\u70ba\u6240\u8ff0\u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 Info Kubernetes \u6c92\u6709\u4ee3\u8868 \u7528\u6236 \u7684\u5c0d\u8c61\u3002\u5373\u4e0d\u80fd\u901a\u904e API \u8abf\u7528\u5c07\u7528\u6236\u6dfb\u52a0\u5230\u96c6\u7fa4\u4e2d\u3002\u4f46\u662f\uff0c\u4efb\u4f55\u63d0\u4f9b\u7531\u96c6\u7fa4\u7684\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7c3d\u540d\u7684\u6709\u6548\u8b49\u66f8\u7684\u7528\u6236\u90fd\u88ab\u8996\u70ba\u5df2\u901a\u904e\u8eab\u4efd\u9a57\u8b49\u3002 Kubernetes \u5f9e\u8b49\u66f8\u4e3b\u984c\u4e2d\u7684\u901a\u7528\u540d\u7a31\u5b57\u6bb5\u4e2d\u7372\u53d6\u7528\u6236\u540d\uff08\u4f8b\u5982\uff0cCN = minikube-user\uff09\u3002\u7136\u5f8c\uff0cKubernetes RBAC \u5b50\u7cfb\u7d71\u5224\u65b7\u7528\u6236\u662f\u5426\u6709\u6b0a\u5c0d\u8cc7\u6e90\u57f7\u884c\u7279\u5b9a\u64cd\u4f5c\u3002 \u7528\u6236\u8b49\u66f8\u901a\u5e38\u53ef\u4ee5\u5728\u6211\u5011\u5df2\u7d93\u719f\u6089\u7684 kubectl \u914d\u7f6e\u8996\u5716\u8f38\u51fa\u4e2d\u627e\u5230\uff1a $ kubectl config view -o jsonpath = '{.users[0]}' | jq { \"name\" : \"minikube\" , \"user\" : { \"client-certificate\" : \"/home/dxlab/.minikube/profiles/minikube/client.crt\" , \"client-key\" : \"/home/dxlab/.minikube/profiles/minikube/client.key\" } } \u8b93\u6211\u5011\u5feb\u901f\u6aa2\u67e5\u8b49\u66f8\u5167\u5bb9\u4ee5\u78ba\u4fdd\u5b83\u662f\u7531\u540c\u4e00\u500b CA \u7c3d\u540d\u7684\uff1a $ cat ~/.minikube/profiles/cluster1/client.crt | openssl x509 -text Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 2 ( 0x2 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 26 21 :54:59 2022 GMT Not After : Jun 26 21 :54:59 2025 GMT Subject: O = system:masters, CN = minikube-user Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :a6:eb:74:10:82:be:42:94:2b:db:72:a6:17:7d: a5:9e:b4:d1:1b:34:c5:a4:71:ff:03:68:1b:1e:cb: 77 :57:bb:6f:fd:0e:d7:b5:62:8f:c8:66:22:36:7d: 01 :d3:f3:4b:3d:84:6a:03:0b:6f:e4:8e:3d:50:24: a4:ad:e0:89:1a:3f:05:af:d8:67:63:9d:44:92:73: 93 :ef:65:08:7e:05:76:45:69:6e:e7:b8:50:81:b6: 8b:82:a7:85:9b:9d:84:2d:db:d5:f5:73:a9:eb:08: a5:0b:f2:61:b8:66:a5:f9:84:09:68:8d:9f:56:8e: 1f:a7:71:f6:4f:67:31:03:8d:a2:17:2a:42:f4:de: 96 :11:2e:22:da:fa:f6:26:f2:de:7b:99:bb:66:b3: d0:3e:4a:f6:c3:7e:6d:0f:d5:ef:44:54:fd:7f:c1: c9:65:f7:7f:d4:50:73:2b:2a:ce:84:19:b0:a7:8a: 66 :cb:ed:f8:60:3a:4a:ac:36:e6:5a:8f:21:eb:4f: f8:fd:db:d3:55:d8:41:a9:34:00:20:9f:eb:9c:58: fd:32:0c:d5:a8:3d:13:82:5c:ef:5c:e6:a5:ac:a8: fb:71:ec:1a:d1:db:ad:f9:2c:40:3b:ee:59:0f:70: 36 :b1:8a:ab:95:1e:e6:0b:1e:01:c4:ab:a7:5c:c6: 10 :43 Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment X509v3 Extended Key Usage: TLS Web Server Authentication, TLS Web Client Authentication X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:70:53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption a3:4e:82:61:63:b9:bc:5c:3f:ba:4d:00:ae:b4:f0:a7:a3:9f: 39 :5b:2b:82:0c:4f:d8:a6:ef:07:45:de:b1:0f:85:70:50:8c: b3:9f:1f:a6:31:34:20:ee:59:89:3b:c5:03:5f:f0:8a:1c:b5: c4:44:c6:45:c4:f4:51:1c:28:4b:b0:0b:52:41:55:4a:04:06: 38 :0d:ab:65:e7:7a:6f:0b:eb:3c:7e:92:7f:f8:30:b8:73:dd: 62 :1c:19:f4:66:ff:88:57:f8:10:23:1b:c1:42:04:41:a1:94: 13 :d3:51:bb:8f:52:bf:f3:ff:50:66:cf:9e:e0:d4:1e:0b:44: 7f:e3:8e:2a:b9:07:62:a3:98:e1:50:c6:82:71:de:da:c8:83: 4a:6d:8f:78:f7:aa:53:5c:ed:68:db:b5:09:b2:1b:94:80:50: 71 :12:cb:92:c2:a3:5f:f1:9d:12:4f:b0:0a:08:39:25:d9:19: b3:ca:15:51:d6:01:b6:7d:58:81:cc:b5:85:47:b0:ff:d4:b3: 63 :ce:2e:b9:12:eb:c6:0e:c3:5f:88:62:7c:39:5f:2d:c5:d1: 56 :a6:68:7b:c1:29:5c:69:dc:ee:cf:af:92:6b:ad:3c:e8:bd: 6c:b9:1e:9d:35:3a:93:c1:4a:f2:64:d2:1b:bb:79:48:bc:89: 51 :81:0d:da -----BEGIN CERTIFICATE----- MIIDITCCAgmgAwIBAgIBAjANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYyNjIxNTQ1OVoXDTI1MDYyNjIxNTQ1OVowMTEXMBUGA1UE ChMOc3lzdGVtOm1hc3RlcnMxFjAUBgNVBAMTDW1pbmlrdWJlLXVzZXIwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCm63QQgr5ClCvbcqYXfaWetNEbNMWk cf8DaBsey3dXu2/9Dte1Yo/IZiI2fQHT80s9hGoDC2/kjj1QJKSt4IkaPwWv2Gdj nUSSc5PvZQh+BXZFaW7nuFCBtouCp4WbnYQt29X1c6nrCKUL8mG4ZqX5hAlojZ9W jh+ncfZPZzEDjaIXKkL03pYRLiLa+vYm8t57mbtms9A+SvbDfm0P1e9EVP1/wcll 93 /UUHMrKs6EGbCnimbL7fhgOkqsNuZajyHrT/j929NV2EGpNAAgn+ucWP0yDNWo PROCXO9c5qWsqPtx7BrR2635LEA77lkPcDaxiquVHuYLHgHEq6dcxhBDAgMBAAGj YDBeMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUH AwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBRwU4aOAa7jT1ePsDDDMbBeMdt/ ljANBgkqhkiG9w0BAQsFAAOCAQEAo06CYWO5vFw/uk0ArrTwp6OfOVsrggxP2Kbv B0XesQ+FcFCMs58fpjE0IO5ZiTvFA1/wihy1xETGRcT0URwoS7ALUkFVSgQGOA2r Zed6bwvrPH6Sf/gwuHPdYhwZ9Gb/iFf4ECMbwUIEQaGUE9NRu49Sv/P/UGbPnuDU HgtEf+OOKrkHYqOY4VDGgnHe2siDSm2PePeqU1ztaNu1CbIblIBQcRLLksKjX/Gd Ek+wCgg5JdkZs8oVUdYBtn1Ygcy1hUew/9SzY84uuRLrxg7DX4hifDlfLcXRVqZo e8EpXGnc7s+vkmutPOi9bLkenTU6k8FK8mTSG7t5SLyJUYEN2g == -----END CERTIFICATE----- \u4e0b\u9762\u662f\u5982\u4f55\u4f7f\u7528 curl \u5411 Kubernetes API \u670d\u52d9\u5668\u767c\u9001\u7531\u8a72\u8b49\u66f8\u8a8d\u8b49\u7684\u8acb\u6c42\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"654514\" } , \"items\" : [ ... ] - \"iss\" ( Issuer ) Claim - The \"iss\" ( issuer ) claim identifies the principal that issued the JWT. - \"sub\" ( Subject ) Claim -The \"sub\" ( subject ) claim identifies the principal that is the subject of the JWT. }","title":"Authenticating using Certificates"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#authenticating-using-service-account-tokens","text":"\u53e6\u4e00\u7a2e\u9a57\u8b49 API \u8acb\u6c42\u7684\u65b9\u6cd5\u662f\u4f7f\u7528 \u670d\u52d9\u5e33\u6236 \u7684 JWT \u4ee4\u724c\u3002\u8207\u7528\u6236\u975e\u5e38\u76f8\u4f3c\uff0c\u4e0d\u540c\u7684 \u670d\u52d9\u5e33\u6236 \u5177\u6709\u4e0d\u540c\u7d1a\u5225\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u8b93\u6211\u5011\u770b\u770b\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u9ed8\u8a8d\u670d\u52d9\u5e33\u6236\u53ef\u4ee5\u5be6\u73fe\u4ec0\u9ebc\uff1a $ JWT_TOKEN_DEFAULT_DEFAULT = $( kubectl get secrets \\ $( kubectl get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_DEFAULT_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tNng1ZHEiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRiZjA0ZDczLWZlOTctNDMzMi04NDM2LWVjNDdlMDZkYzE2MSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.pkJ-AZufRuGcMGXwtL7jQu0BOa6DGgylzTjGcKQcOESjXeTsZfw8pnwHMOJsiV760QMLY33GtpzLy0om5l4gfU1O-CJZXKTaYCHzjyEb6ZVLK0xLeLwsW--LI_Weo0X9KiAjNBqDSUmj8NYHn2-c-wygN6IYWqbT8MmXL-YC8dejeqUlLzAQUw8hZasdWN6KLnmNxhI0-cntp0C8O2I5SPumOxq7IEX8s2Erir2cU2xGI-LPaMm8ccAk5wrKS9rqk23G24vXFgi9u1SwtujC_hZrki_rm8yrMUWvOa5SPZqAag_dkjLXR5YSxF_nJO69XGJ1fId3hr2ruHBTivbfEQ \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-6x5dq\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"dbf04d73-fe97-4332-8436-ec47e06dc161\" , \"sub\" : \"system:serviceaccount:default:default\" } \u5f9e\u4e00\u500b\u7c21\u55ae\u7684\u4efb\u52d9\u958b\u59cb - \u5728 apps/v1 \u4e2d\u5217\u51fa\u5df2\u77e5\u7684 API \u8cc7\u6e90\u985e\u578b\uff1a $ curl $KUBE_API /apis/apps/v1/ \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"APIResourceList\" , \"apiVersion\" : \"v1\" , \"groupVersion\" : \"apps/v1\" , \"resources\" : [ ... ] } \u63a5\u8457\u8b93\u6211\u5011\u5617\u8a66\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa\u5be6\u969b\u7684\u90e8\u7f72\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u986f\u7136\uff0c\u7528\u6236 system:serviceaccount:default:default \u751a\u81f3\u4e0d\u8db3\u4ee5\u5728\u5176\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa Kubernetes \u5c0d\u8c61\u3002 \u8b93\u6211\u5011\u5617\u8a66\u4e00\u500b\u5f37\u5927\u7684 kube-system \u670d\u52d9\u5e33\u6236\uff1a $ JWT_TOKEN_KUBESYSTEM_DEFAULT = $( kubectl -n kube-system get secrets \\ $( kubectl -n kube-system get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_KUBESYSTEM_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZWZhdWx0LXRva2VuLW16bWo3Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRlZmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhN2E4YTc1Mi1jNjQ5LTRkOGYtOTQzMi03MDgxYjE4YzBiNTIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06ZGVmYXVsdCJ9.talXOCcsaH5VaZEOJo-VilVZUhM6YWrChmKScXHcTwDfVBmX6XlrelomnYMUtwahnF1aGe_vJpLzk-SJhvdLvFSAvw0pIWxsabes7ITfCdOfAMliPhiCIOC4XwawKWmbVJYcvhHppNA41qzNAbtav_e9qB6z84fmAQHQJLITMmMfe-ZC38I3sWh5ezoo-1uiV3iY6SHxd4WGXmuRBqkvWxJM7JiC2TmUU9Z6K4gfrRtfBrB2-A3Ti6v7Jcqwxakqq092X7VpstmJTHgh6KExm-0laIUSOKwUFlFvs4-MYKwmbYdz4IYDxJejZjcfC8XkTM6nQPaXdaTA6olKBzKHKg \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"kube-system\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-mzmj7\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"a7a8a752-c649-4d8f-9432-7081b18c0b52\" , \"sub\" : \"system:serviceaccount:kube-system:default\" } \u5f37\u5927\u7684\u5e33\u6236\u503c\u5f97\u4e00\u9805\u5177\u6709\u6311\u6230\u6027\u7684\u4efb\u52d9 - \u5217\u51fa\u96c6\u7fa4\u7d1a\u8cc7\u6e90\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_KUBESYSTEM_DEFAULT \" { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"656580\" } , \"items\" : [ ... ] } \u662f\u7684\uff0c\u7b26\u5408\u6211\u5011\u7684\u671f\u5f85\u5730\u5b8c\u6210\u5de5\u4f5c\ud83d\udc4c","title":"Authenticating using Service Account Tokens"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#call-kubernetes-api-inside-a-pod","text":"\u8207\u4efb\u4f55\u5176\u4ed6 Kubernetes \u670d\u52d9\u975e\u5e38\u76f8\u4f3c\uff0cKubernetes API \u670d\u52d9\u5730\u5740\u53ef\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u63d0\u4f9b\u7d66 Pod\uff1a $ kubectl run -it --image curlimages/curl --restart = Never mypod -- sh $ env | grep KUBERNETES KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 Pod \u901a\u5e38\u9084\u6703\u5728 /var/run/secrets/kubernetes.io/serviceaccount/ \u4e0a\u5b89\u88dd Kubernetes CA \u8b49\u66f8\u548c \u670d\u52d9\u5e33\u6236 credentials\u3002\u56e0\u6b64\uff0c\u61c9\u7528\u4ee5\u4e0a\u90e8\u5206\u7684\u77e5\u8b58\uff0c\u5f9e Pod \u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u7684 curl \u547d\u4ee4\u53ef\u4ee5\u5982\u4e0b\u6240\u793a\uff1a $ curl https:// ${ KUBERNETES_SERVICE_HOST } : ${ KUBERNETES_SERVICE_PORT } /apis/apps/v1 \\ --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \\ --header \"Authorization: Bearer $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \"","title":"Call Kubernetes API inside a Pod"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#creat-read-watch-update-patch-and-delete-objects","text":"Kubernetes API \u652f\u6301\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u4ee5\u4e0b \u64cd\u4f5c \uff1a GET /<resourcePlural> - Retrieve a list of type . POST /<resourcePlural> - Create a new resource from the JSON object provided by the client. GET /<resourcePlural>/<name> - Retrieves a single resource with the given name. DELETE /<resourcePlural>/<name> - Delete the single resource with the given name. DELETE /<resourcePlural> - Deletes a list of type . PUT /<resourcePlural>/<name> - Update or create the resource with the given name with the JSON object provided by client. PATCH /<resourcePlural>/<name> - Selectively modify the specified fields of the resource. GET /<resourcePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. API \u662f RESTful \u7684\u578b\u5f0f\uff0c\u56e0\u6b64\u4e0a\u8ff0 HTTP \u65b9\u6cd5\u5728\u8cc7\u6e90\u64cd\u4f5c\u4e0a\u7684\u6620\u5c04\u61c9\u8a72\u770b\u8d77\u4f86\u5f88\u719f\u6089\u3002 Info \u5373\u4f7f\u6587\u6a94\u50c5\u63d0\u53ca JSON \u5c0d\u8c61\uff0c\u5982\u679c Content-Type \u6a19\u982d\u8a2d\u7f6e\u70ba application/yaml \uff0c\u5247\u652f\u6301\u63d0\u4ea4 YAML \u6709\u6548\u8ca0\u8f09\u3002 CREATE \u4ee5\u4e0b\u662f\u4f7f\u7528 curl \u548c YAML \u6e05\u55ae\u5275\u5efa\u65b0\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X POST \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"365d\"] ' READ \u4ee5\u4e0b\u662f\u5982\u4f55\u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4ee5\u53ca\u5982\u4f55\u901a\u904e\u540d\u7a31\u548c\u547d\u540d\u7a7a\u9593\u7372\u53d6\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4e00\u7a2e\u66f4\u9ad8\u7d1a\u7684\u6aa2\u7d22 Kubernetes \u8cc7\u6e90\u7684\u65b9\u6cd5\u662f\u6301\u7e8c\u89c0\u5bdf\u5b83\u5011\u7684\u8b8a\u5316\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments?watch = true \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key Info \u8acb\u6ce8\u610f\uff0c\u53ea\u80fd\u76e3\u8996\u4e00\u7d44\u8cc7\u6e90\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u63d0\u4f9b\u6a19\u7c64\u6216\u5b57\u6bb5\u9078\u64c7\u5668\u5c07\u7d50\u679c\u96c6\u7e2e\u5c0f\u5230\u55ae\u500b\u8cc7\u6e90\u3002 UPDATE \u4ee5\u4e0b\u662f\u66f4\u65b0\u73fe\u6709\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PUT \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"730d\"] # <-- Making it sleep twice longer ' \u4ee5\u4e0b\u662f\u5982\u4f55\u4fee\u88dc\u73fe\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PATCH \\ -H 'Content-Type: application/merge-patch+json' \\ -d '{ \"spec\": { \"template\": { \"spec\": { \"containers\": [ { \"name\": \"sleep\", \"image\": \"curlimages/curl\", \"command\": [\"/bin/sleep\", \"1d\"] } ] } } } }' Info \u8acb\u6ce8\u610f UPDATE \u548c PATCH \u662f\u76f8\u7576\u68d8\u624b\u7684\u64cd\u4f5c\u3002\u7b2c\u4e00\u500b\u53d7\u5230\u5404\u7a2e\u7248\u672c\u885d\u7a81\u7684\u5f71\u97ff\uff0c\u7b2c\u4e8c\u500b\u7684\u884c\u70ba\u56e0\u4f7f\u7528\u7684\u88dc\u4e01\u7b56\u7565\u800c\u7570\u3002 DELETE \u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f - \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u5c0d\u8c61\u96c6\u5408\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u55ae\u500b\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE","title":"Creat, Read, Watch, Update, Patch, and Delete objects"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#how-to-call-kubernetes-api-using-kubectl","text":"\u4e0a\u9762\u4f7f\u7528\u8b49\u66f8\u548c\u4ee4\u724c\u4f86\u547c\u53eb Kubernetes API \u5f88\u6709\u8da3\u3002\u81f3\u5c11\u7d93\u6b77\u4e00\u6b21\u662f\u4e00\u500b\u5f88\u597d\u7684\u7df4\u7fd2\uff0c\u53ef\u4ee5\u978f\u56fa\u5c0d\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u79fb\u52d5\u90e8\u4ef6\u7684\u7406\u89e3\u3002\u4f46\u662f\uff0c\u7576\u4f60\u6709\u4e00\u500b\u53ef\u4ee5\u4f7f\u7528\u7684 kubectl \u6642\uff0c\u6bcf\u5929\u90fd\u9019\u6a23\u505a\u53ef\u80fd\u6703\u6709\u9ede\u77ef\u6789\u904e\u6b63\u3002","title":"How to call Kubernetes API using kubectl"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#calling-kubernetes-api-using-kubectl-proxy","text":"\u4f7f\u7528\u6b63\u78ba\u914d\u7f6e\u7684 kubectl \u5de5\u5177\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl proxy \u547d\u4ee4\u5927\u5927\u7c21\u5316 API \u8a2a\u554f\u3002 kubectl proxy \u547d\u4ee4\u5728\u60a8\u7684 localhost \u548c Kubernetes API \u670d\u52d9\u5668 \u4e4b\u9593\u5275\u5efa\u4e00\u500b\u4ee3\u7406\u670d\u52d9\u5668\uff08\u6216\u61c9\u7528\u7a0b\u5e8f\u7d1a\u7db2\u95dc\uff09\u3002\u4f46\u5b83\u5fc5\u9808\u4e0d\u6b62\u65bc\u6b64\u3002\u4e0d\u7136\u600e\u9ebc\u6703\u9019\u9ebc\u65b9\u4fbf\uff1f \u4ee3\u7406 kubectl \u5f9e\u8abf\u7528\u8005\u90a3\u88e1\u5378\u8f09\u4e86\u76f8\u4e92\u7684\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u8cac\u4efb\u3002\u7531\u65bc\u8abf\u7528\u8005\u548c\u4ee3\u7406\u4e4b\u9593\u7684\u901a\u4fe1\u767c\u751f\u5728\u672c\u5730\u4e3b\u6a5f\u4e0a\uff0c\u56e0\u6b64\u5b83\u88ab\u8a8d\u70ba\u662f\u5b89\u5168\u7684\u3002\u4e26\u4e14\u4ee3\u7406\u672c\u8eab\u4f7f\u7528 kubeconfig \u6587\u4ef6\u4e2d\u9078\u64c7\u7684\u7576\u524d\u4e0a\u4e0b\u6587\u4e2d\u7684\u4fe1\u606f\u4f86\u8655\u7406\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u3002 $ kubectl config current-context minikube $ kubectl proxy --port = 8080 & \u555f\u52d5\u4ee3\u7406\u670d\u52d9\u5668\u5f8c\uff0c\u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u5c31\u8b8a\u5f97\u7c21\u55ae\u591a\u4e86\uff1a $ curl localhost:8080/apis/apps/v1/deployments { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"660883\" } , \"items\" : [ ... ] }","title":"Calling Kubernetes API using kubectl proxy"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#calling-kubernetes-api-using-kubectl-raw-mode","text":"\u6211\u6700\u8fd1\u5b78\u5230\u7684\u53e6\u4e00\u500b\u5f88\u9177\u7684\u6280\u5de7\u662f\u4e00\u4e9b kubectl \u547d\u4ee4\u652f\u6301\u7684\u539f\u59cb\u6a21\u5f0f\uff1a # Sends HTTP GET request $ kubectl get --raw /api/v1/namespaces/default/pods # Sends HTTP POST request $ kubectl create --raw /api/v1/namespaces/default/pods -f file.yaml # Sends HTTP PUT request $ kubectl replace --raw /api/v1/namespaces/default/pods/mypod -f file.json # Sends HTTP DELETE request $ kubectl delete --raw /api/v1/namespaces/default/pods kubectl \u662f\u4e00\u500b\u975e\u5e38\u5148\u9032\u7684\u5de5\u5177\uff0c\u5373\u4f7f\u662f\u50cf kubectl \u9019\u6a23\u7684\u7c21\u55ae\u547d\u4ee4\u4e5f\u6709\u5927\u91cf\u4ee3\u78bc\u3002\u4f46\u662f\uff0c\u7576\u4f7f\u7528 --raw \u6a19\u8a8c\u6642\uff0c\u5be6\u73fe\u6b78\u7d50\u70ba\u5c07\u552f\u4e00\u7684\u53c3\u6578\u8f49\u63db\u70ba API \u7aef\u9ede URL \u4e26\u8abf\u7528\u539f\u59cb REST API \u5ba2\u6236\u7aef\u3002","title":"Calling Kubernetes API using kubectl raw mode"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#wrapping-up","text":"\u7b2c\u4e00\u6b21\u8a2a\u554f Kubernetes API \u7684\u9700\u6c42\u53ef\u80fd\u5f88\u53ef\u6015 - \u6709\u5f88\u591a\u65b0\u6982\u5ff5\uff0c\u5982\u8cc7\u6e90\u3001API \u7d44\u3001\u7a2e\u985e\u3001\u5c0d\u8c61\u3001\u96c6\u7fa4\u3001\u4e0a\u4e0b\u6587\u3001\u8b49\u66f8\uff0c\u54e6\uff0c\u5929\u54ea\uff01\u4f46\u662f\u4e00\u65e6\u4f60\u5728\u69cb\u5efa\u584a\u4e0a\u5206\u89e3\u5b83\u4e26\u901a\u904e\u57f7\u884c\u4e00\u4e9b\u7463\u788e\u7684\u4efb\u52d9\uff08\u6bd4\u5982\u627e\u51fa API \u670d\u52d9\u5668\u5730\u5740\u6216\u4f7f\u7528 curl \u8abf\u7528\u4e00\u5806\u7aef\u9ede\uff09\u7372\u5f97\u4e00\u4e9b\u5be6\u8e10\u7d93\u9a57\uff0c\u4f60\u5f88\u5feb\u5c31\u6703\u610f\u8b58\u5230\u9019\u500b\u60f3\u6cd5\u52d5\u7269\u5712\u4e26\u4e0d\u662f\u771f\u7684\u4e00\u4e9b\u65b0\u7684\u6771\u897f\u2014\u2014\u5b83\u53ea\u662f\u591a\u5e74\u4f86\u70ba\u6211\u5011\u670d\u52d9\u7684\u773e\u6240\u5468\u77e5\u7684\u6a5f\u5236\u7684\u7d44\u5408 \u2014 REST \u67b6\u69cb\u98a8\u683c\u3001TLS \u8b49\u66f8\u3001JWT \u4ee4\u724c\u3001\u5c0d\u8c61\u65b9\u6848\u7b49\u3002 \u6240\u4ee5\uff0c\u4e0d\u8981\u5bb3\u6015\u4e26\u904b\u884c\u4e00\u4e9b\u67e5\u8a62\uff01 Info \u8feb\u4e0d\u53ca\u5f85\u60f3\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8abf\u7528 API\uff1f\u5728 GitHub \u4e0a\u67e5\u770b\u6211\u6536\u96c6\u7684 Kubernetes \u5ba2\u6236\u7aef\u793a\u4f8b \ud83d\ude09","title":"Wrapping up"},{"location":"kubernetes/api/kubernetes-api-call-simple-http-client/#resources","text":"Kubernetes Documentation - Access Clusters Using the Kubernetes API Kubernetes Documentation - Configure Access to Multiple Clusters Kubernetes Documentation - Authenticating Kubernetes Documentation - Controlling Access to the Kubernetes API Kubernetes Documentation - Configure Service Accounts for Pods Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"Resources"},{"location":"kubernetes/api/kubernetes-api-structure-and-terminology/","text":"Kubernetes API \u57fa\u790e \u00b6 \u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-structure-and-terminology/ \u9019\u662f\u95dc\u65bc\u5982\u4f55\u5f9e\u4ee3\u78bc\u4e2d\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\u7ae0\u4e2d\u7684\u7b2c\u4e00\u7bc7\u3002 Kubernetes API \u6bd4\u4e00\u5806 HTTP \u7aef\u9ede\u7d44\u5408\u5728\u4e00\u8d77\u8981\u5148\u9032\u4e00\u9ede\u3002\u56e0\u6b64\uff0c\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8a2a\u554f\u5b83\u4e4b\u524d\uff0c\u4e86\u89e3 Kubernetes API \u7d50\u69cb\u4e26\u719f\u6089\u8853\u8a9e\u81f3\u95dc\u91cd\u8981\u3002\u5426\u5247\uff0c\u5617\u8a66\u5c07\u975e\u5e38\u75db\u82e6\u2014\u2014\u5b98\u65b9\u7684 Go \u5ba2\u6236\u7aef\u5e36\u6709\u592a\u591a\u7684\u82b1\u91cc\u80e1\u54e8\uff0c\u8a66\u5716\u5c07\u4f60\u7684\u982d\u8166\u570d\u7e5e\u5728\u5ba2\u6236\u7aef\u548c API \u6982\u5ff5\u4e0a\uff0c\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u8b93\u4f60\u4e0d\u77e5\u6240\u63aa\u3002 Kubernetes API \u975e\u5e38\u9f90\u5927\u2014\u2014\u5b83\u6709\u6578\u767e\u500b\u7aef\u9ede\u3002\u5e78\u904b\u7684\u662f\uff0c\u5b83\u975e\u5e38\u4e00\u81f4\uff0c\u56e0\u6b64\u53ea\u9700\u4e86\u89e3\u6709\u9650\u6578\u91cf\u7684\u60f3\u6cd5\uff0c\u7136\u5f8c\u5c07\u9019\u4e9b\u77e5\u8b58\u5916\u63a8\u5230 API \u7684\u5176\u9918\u90e8\u5206\u3002\u5728\u9019\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5c07\u5617\u8a66\u89f8\u53ca\u6211\u767c\u73fe\u7684\u6700\u57fa\u672c\u7684\u6982\u5ff5\u3002\u6211\u50be\u5411\u65bc\u7c21\u55ae\u548c\u6613\u6d88\u5316\uff0c\u800c\u4e0d\u662f\u5b78\u8853\u4e0a\u7684\u6b63\u78ba\u6027\u548c\u6750\u6599\u7684\u5b8c\u6574\u6027\u3002\u548c\u5f80\u5e38\u4e00\u6a23\uff0c\u6211\u53ea\u662f\u5206\u4eab\u6211\u5c0d\u4e8b\u7269\u7684\u7406\u89e3\u548c\u601d\u8003\u9019\u500b\u8a71\u984c\u7684\u65b9\u5f0f\u2014\u2014\u6240\u4ee5\uff0c\u5b83\u4e0d\u662f API \u624b\u518a\uff0c\u800c\u662f\u500b\u4eba\u5b78\u7fd2\u7d93\u9a57\u7684\u8a18\u9304\u3002 Resources and Verbs \u00b6 \u7531\u65bc\u5b83\u662f\u4e00\u500b RESTful \u9818\u57df\uff0c\u6211\u5011\u5c07\u6839\u64da resource \uff08\u9b06\u6563\u5730\uff0c\u67d0\u7a2e\u7d50\u69cb\u7684\u5c0d\u8c61\uff09\u548c verb \uff08\u5c0d\u9019\u4e9b\u5c0d\u8c61\u7684\u64cd\u4f5c\uff09\u9032\u884c\u64cd\u4f5c\u3002 \u5728\u8a0e\u8ad6 resources \u6642\uff0c\u5c07 a resource as a certain kind of objects \u8207 a resource as a particular instance of some kind \u5340\u5206\u958b\u4f86\u662f\u5f88\u91cd\u8981\u7684\u3002\u56e0\u6b64\uff0cKubernetes API \u7aef\u9ede\u88ab\u6b63\u5f0f\u547d\u540d\u70ba\u8cc7\u6e90\u985e\u578b (resource types)\uff0c\u4ee5\u907f\u514d\u8207\u8cc7\u6e90\u5be6\u4f8b (resource instances) \u7522\u751f\u6b67\u7fa9\u3002\u7136\u800c\uff0c\u5c0d\u4e00\u822c\u61c9\u7528\u7a0b\u5f0f\u7684\u958b\u767c\u8005\u4f86\uff0c\u7aef\u9ede(endpoint)\u901a\u5e38\u88ab\u7a31\u70ba\u8cc7\u6e90(resource)\uff0c\u56e0\u6b64\u9019\u500b\u8a5e\u7684\u5be6\u969b\u542b\u7fa9\u5f97\u5f9e\u4e0a\u4e0b\u6587\u4e2d\u4f86\u5f97\u51fa\u3002 \u51fa\u65bc\u53ef\u64f4\u5c55\u6027\u7684\u539f\u56e0\uff0c resource types \u3000\u88ab\u7d44\u7e54\u6210 API groups \uff0c\u4e26\u4e14\u9019\u4e9b\u3000API\u3000\u7fa4\u7d44\u5f7c\u6b64\u7368\u7acb\u5730\u9032\u884c\u7248\u672c\u63a7\u5236\uff1a $ kubectl api-resources NAME SHORTNAMES APIVERSION NAMESPACED KIND bindings v1 true Binding componentstatuses cs v1 false ComponentStatus configmaps cm v1 true ConfigMap endpoints ep v1 true Endpoints events ev v1 true Event limitranges limits v1 true LimitRange namespaces ns v1 false Namespace nodes no v1 false Node persistentvolumeclaims pvc v1 true PersistentVolumeClaim persistentvolumes pv v1 false PersistentVolume pods po v1 true Pod podtemplates v1 true PodTemplate replicationcontrollers rc v1 true ReplicationController resourcequotas quota v1 true ResourceQuota secrets v1 true Secret serviceaccounts sa v1 true ServiceAccount services svc v1 true Service mutatingwebhookconfigurations admissionregistration.k8s.io/v1 false MutatingWebhookConfiguration validatingwebhookconfigurations admissionregistration.k8s.io/v1 false ValidatingWebhookConfiguration customresourcedefinitions crd,crds apiextensions.k8s.io/v1 false CustomResourceDefinition apiservices apiregistration.k8s.io/v1 false APIService controllerrevisions apps/v1 true ControllerRevision daemonsets ds apps/v1 true DaemonSet deployments deploy apps/v1 true Deployment replicasets rs apps/v1 true ReplicaSet statefulsets sts apps/v1 true StatefulSet tokenreviews authentication.k8s.io/v1 false TokenReview localsubjectaccessreviews authorization.k8s.io/v1 true LocalSubjectAccessReview selfsubjectaccessreviews authorization.k8s.io/v1 false SelfSubjectAccessReview selfsubjectrulesreviews authorization.k8s.io/v1 false SelfSubjectRulesReview subjectaccessreviews authorization.k8s.io/v1 false SubjectAccessReview horizontalpodautoscalers hpa autoscaling/v2 true HorizontalPodAutoscaler cronjobs cj batch/v1 true CronJob jobs batch/v1 true Job certificatesigningrequests csr certificates.k8s.io/v1 false CertificateSigningRequest leases coordination.k8s.io/v1 true Lease endpointslices discovery.k8s.io/v1 true EndpointSlice events ev events.k8s.io/v1 true Event flowschemas flowcontrol.apiserver.k8s.io/v1beta2 false FlowSchema prioritylevelconfigurations flowcontrol.apiserver.k8s.io/v1beta2 false PriorityLevelConfiguration ingressclasses networking.k8s.io/v1 false IngressClass ingresses ing networking.k8s.io/v1 true Ingress networkpolicies netpol networking.k8s.io/v1 true NetworkPolicy runtimeclasses node.k8s.io/v1 false RuntimeClass poddisruptionbudgets pdb policy/v1 true PodDisruptionBudget podsecuritypolicies psp policy/v1beta1 false PodSecurityPolicy clusterrolebindings rbac.authorization.k8s.io/v1 false ClusterRoleBinding clusterroles rbac.authorization.k8s.io/v1 false ClusterRole rolebindings rbac.authorization.k8s.io/v1 true RoleBinding roles rbac.authorization.k8s.io/v1 true Role priorityclasses pc scheduling.k8s.io/v1 false PriorityClass csidrivers storage.k8s.io/v1 false CSIDriver csinodes storage.k8s.io/v1 false CSINode csistoragecapacities storage.k8s.io/v1beta1 true CSIStorageCapacity storageclasses sc storage.k8s.io/v1 false StorageClass volumeattachments storage.k8s.io/v1 false VolumeAttachment \u5982\u679c\u4f60\u597d\u5947 kubectl api-resources \u547d\u4ee4\u662f\u5982\u4f55\u69cb\u5efa\u9019\u6a23\u4e00\u500b\u652f\u6301\u7684\u8cc7\u6e90\u5217\u8868\u7684\uff0c\u9019\u88e1\u6709\u4e00\u500b\u5f88\u597d\u7684\u6280\u5de7\uff0c\u5b83\u986f\u793a\u4e86\u4efb\u4f55 kubectl \u547d\u4ee4\u9032\u884c\u4e86\u54ea\u4e9b API \u8abf\u7528\uff1a $ kubectl api-resources -v 6 # -v 6 means \"extra verbose logging\" ... I0108 ... GET https://192.168.58.2:8443/api?timeout = 32s 200 OK in 10 milliseconds I0108 ... GET https://192.168.58.2:8443/apis?timeout = 32s 200 OK in 1 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apiregistration.k8s.io/v1?timeout = 32s 200 OK in 7 milliseconds I0108 ... GET https://192.168.58.2:8443/api/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/authentication.k8s.io/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/events.k8s.io/v1?timeout = 32s 200 OK in 15 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apps/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/autoscaling/v2beta1?timeout = 32s 200 OK in 16 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/policy/v1beta1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/scheduling.k8s.io/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1beta1?timeout = 32s 200 OK in 43 milliseconds ... \u5176\u5be6\u3000ubernetes\u3000\u7684\u3000API\u3000\u90fd\u5177\u5099\u4e86\u76f8\u7576\u8c50\u5bcc\u7684 meta data \u4f86\u9673\u8ff0\u9019\u500b\u3000Kubernetes API \u57fa\u672c\u8cc7\u6599\u3002\u986f\u7136\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u8b80\u53d6\uff08\u6216\u5275\u5efa\uff09\u5176\u4ed6\u8cc7\u6e90\u4f86\u5217\u51fa\u73fe\u6709\u7684\uff08\u751a\u81f3\u8a3b\u518a\u65b0\u7684\u8cc7\u6e90\u985e\u578b\uff09\uff01\u4f8b\u5982\uff0c\u4e0a\u9762\u7684\u5217\u8868\u662f\u901a\u904e\u8abf\u7528\u7279\u6b8a\u7684 /api \u548c /apis/<group-name> \u8cc7\u6e90\u7372\u5f97\u7684\u3002 Info /api \u7aef\u9ede\u5df2\u7d93\u662f\u6700\u521d\u3000Kubernetes\u3000\u5b9a\u7fa9\u8207\u4f7f\u7528\u7684\uff0c\u50c5\u7528\u65bc\u6838\u5fc3\u8cc7\u6e90\uff08pod\u3001secrets\u3001configmaps \u7b49\uff09\u3002\u4e00\u500b\u66f4\u73fe\u4ee3\u548c\u901a\u7528\u7684 /apis/<group-name> \u7aef\u9ede\u7528\u65bc\u5176\u9918\u8cc7\u6e90\uff0c\u5305\u62ec\u7528\u6236\u5b9a\u7fa9\u7684\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 curl \u7b49\u6a19\u6e96 HTTP \u5ba2\u6236\u7aef\u8f15\u9b06\u8abf\u7528\u4e0a\u8ff0\u8cc7\u6e90\uff08\u5373 API \u7aef\u9ede\uff09\u4e26\u6aa2\u67e5\u8fd4\u56de\u7684\u8cc7\u6e90\uff08\u5373 JSON \u5c0d\u8c61\uff09\uff1a # Make Kubernetes API available on localhost:8080 # to bypass the auth step in subsequent queries: $ kubectl proxy --port = 8080 & # List all known API paths $ curl http://localhost:8080/ # List known versions of the `core` group $ curl http://localhost:8080/api # List known resources of the `core/v1` group $ curl http://localhost:8080/api/v1 # Get a particular Pod resource $ curl http://localhost:8080/api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg # List known groups (all but `core`) $ curl http://localhost:8080/apis # List known versions of the `apps` group $ curl http://localhost:8080/apis/apps # List known resources of the `apps/v1` group $ curl http://localhost:8080/apis/apps/v1 # Get a particular Deployment resource $ curl http://localhost:8080/apis/apps/v1/namespaces/default/deployments/sleep Info \u6709\u4e00\u7a2e\u66f4\u7c21\u55ae\u7684\u65b9\u6cd5\u4f86\u6aa2\u67e5 Kubernetes API\uff1a kubectl get --raw /SOME/API/PATH \u3002\u7136\u800c\uff0c\u4e0a\u9762\u7684\u7df4\u7fd2\u662f\u70ba\u4e86\u8868\u660e Kubernetes API \u4e26\u4e0d\u795e\u5947\u3002\u64c1\u6709\u4e00\u500b\u901a\u7528\u578b\u7684 HTTP \u5ba2\u6236\u7aef\u6216\u5de5\u5177\u5c31\u8db3\u4ee5\u958b\u59cb\u4f7f\u7528\u5b83\u4e86\u3002 \u8aaa\u5230\u3000 verbs (\u5373\u5c0d\u8cc7\u6e90\u7684\u64cd\u4f5c)\uff0c\u6240\u6709\u6a19\u6e96\u7684 CRUD \u64cd\u4f5c\u53ca\u5176\u50b3\u7d71\u6620\u5c04\u5230 HTTP \u65b9\u6cd5\u90fd\u5728\u90a3\u88e1\u3002\u6b64\u5916\uff0c\u9084\u652f\u6301\u8cc7\u6e90\u7684 patching \uff08\u9078\u64c7\u6027\u5b57\u6bb5\u4fee\u6539\uff09\u548c watching \uff08\u6d41\u5f0f\u96c6\u5408\u7684\u8b80\u53d6\uff09\u3002\u5728\u3000Kubernetes \u5b98\u65b9\u958b\u767c\u6307\u5357\u4e2d\u5b9a\u7fa9\u4e86\u8a73\u7d30\u7684\u8aaa\u660e: sig-architecture/api-conventions.md \uff1a ## Verbs on Resources API resources should use the traditional REST pattern: GET /<resourceNamePlural> - Retrieve a list of type <resourceName>, e.g. GET /pods returns a list of Pods. POST /<resourceNamePlural> - Create a new resource from the JSON object provided by the client. GET /<resourceNamePlural>/<name> - Retrieves a single resource with the given name, e.g. GET /pods/first returns a Pod named 'first'. Should be constant time, and the resource should be bounded in size. DELETE /<resourceNamePlural>/<name> - Delete the single resource with the given name. DeleteOptions may specify gracePeriodSeconds, the optional duration in seconds before the object should be deleted. Individual kinds may declare fields which provide a default grace period, and different kinds may have differing kind-wide default grace periods. A user provided grace period overrides a default grace period, including the zero grace period (\"now\"). DELETE /<resourceNamePlural> - Deletes a list of type <resourceName>, e.g. DELETE /pods a list of Pods. PUT /<resourceNamePlural>/<name> - Update or create the resource with the given name with the JSON object provided by the client. PATCH /<resourceNamePlural>/<name> - Selectively modify the specified fields of the resource. See more information below. GET /<resourceNamePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. ## PATCH operations The API supports three different PATCH operations, determined by their corresponding Content-Type header: JSON Patch, Content-Type: application/json-patch+json As defined in RFC6902, a JSON Patch is a sequence of operations that are executed on the resource, e.g. {\"op\": \"add\", \"path\": \"/a/b/c\", \"value\": [ \"foo\", \"bar\" ]}. For more details on how to use JSON Patch, see the RFC. Merge Patch, Content-Type: application/merge-patch+json As defined in RFC7386, a Merge Patch is essentially a partial representation of the resource. The submitted JSON is \"merged\" with the current resource to create a new one, then the new one is saved. For more details on how to use Merge Patch, see the RFC. Strategic Merge Patch, Content-Type: application/strategic-merge-patch+json Strategic Merge Patch is a custom implementation of Merge Patch. For a detailed explanation of how it works and why it needed to be introduced, see here. Kinds aka Object Schemas \u00b6 kind (\u985e\u578b) \u9019\u500b\u8a5e\u6703\u6642\u4e0d\u6642\u5730\u51fa\u73fe\u5728\u9019\u91cc\u548c\u90a3\u88e1\u3002\u4f8b\u5982\uff0c\u5728 kubectl api-resources \u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 persistentvolumes \u8cc7\u6e90\u5177\u6709\u76f8\u61c9\u7684 PersistentVolume \u985e\u578b\u3002 \u5f88\u9577\u4e00\u6bb5\u6642\u9593\u4ee5\u4f86\uff0c\u6211\u8207 Kubernetes \u7684\u4ea4\u4e92\u50c5\u9650\u65bc\u4f7f\u7528 kubectl apply \u76f2\u76ee\u5730\u70ba\u5176\u63d0\u4f9b\u6e05\u55ae\u3002\u9019\u8b93\u6211\u89ba\u5f97 kind \u7e3d\u662f\u5305\u542b\u4e00\u500b\u8cc7\u6e90\u7684 CamelCase \u540d\u7a31\uff0c\u6bd4\u5982 Pod \u3001 Service \u3001 Deployment \u7b49\u3002 $ cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: my-deployment spec: replicas: 1 selector: ... EOF \u4f46\u5be6\u969b\u4e0a\uff0c\u5c31\u7b97\u4e0d\u662f\u8cc7\u6e90\u7684 Kubernetes \u6578\u64da\u7d50\u69cb\u4e5f\u53ef\u4ee5\u6709 Kind \u7684\u5ba3\u544a\uff1a apiVersion : audit.k8s.io/v1 kind : Policy rules : - level : Metadata \u751a\u81f3 Kubernetes \u5c0d\u8c61\uff08\u5373\u6301\u4e45\u5be6\u9ad4\uff09\u7684\u8cc7\u6e90\u4e5f\u6709 Kind \uff1a $ kubectl get --raw /api | jq { \"kind\" : \"APIVersions\" , \"versions\" : [ \"v1\" ] , \"serverAddressByClientCIDRs\" : [ { \"clientCIDR\" : \"0.0.0.0/0\" , \"serverAddress\" : \"192.168.49.2:8443\" } ] } \u90a3\u9ebc\uff0c\u4ec0\u9ebc\u662f kind \uff1f Info \"All resource types have a concrete representation which is called a kind\" - Kubernetes API reference. \u55ef\uff0c\u9019\u500b\u89e3\u91cb\u4e0d\u662f\u7279\u5225\u6709\u7528! \ud83e\udd14 \u4e8b\u5be6\u8b49\u660e\uff0c\u5728 Kubernetes \u4e2d\uff0c\u4e00\u7a2e Kind \u662f object schema \u3002\u5c31\u50cf\u60a8\u901a\u5e38\u4f7f\u7528 JSON schema \u90a3\u6a23\u3002\u63db\u53e5\u8a71\u8aaa\uff0c Kind \u662f\u6307\u7279\u5b9a\u7684\u6578\u64da\u7d50\u69cb\uff0c\u5373 attributes \u548c properties \u7684\u67d0\u7a2e\u7d44\u5408\u3002 \u6839\u64da sig-architecture/api-conventions.md \uff0c Kind \u5206\u70ba\u4e09\u985e\uff1a Objects (Pod, Service, etc) - persistent entities in the system. Lists - (PodList, APIResourceList, etc) - collections of resources of one or more kinds. Simple - specific actions on objects (status, scale, etc.) or non-persistent auxiliary entities (ListOptions, Policy, etc). Kubernetes \u4e2d\u4f7f\u7528\u7684\u5927\u591a\u6578\u7269\u4ef6(object)\uff0c\u5305\u62ec API \u8fd4\u56de\u7684\u6240\u6709 JSON \u7269\u4ef6\uff0c\u90fd\u6709 kind \u5b57\u6bb5\u3002\u5b83\u5141\u8a31\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u5728\u901a\u904e\u7db2\u7d61\u767c\u9001\u5b83\u5011\u6216\u5c07\u5b83\u5011\u5b58\u5132\u5728\u78c1\u76e4\u4e0a\u4e4b\u524d\u6b63\u78ba\u5730\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u9019\u4e9b\u7269\u4ef6\u3002 Kubernetes Objects \u00b6 \u5c31\u50cf resource \u4e00\u6a23\uff0cKubernetes \u7528\u8a9e\u4e2d\u7684 object \u4e00\u8a5e\u662f\u4e5f\u662f\u641e\u7684\u5927\u5bb6\u6688\u982d\u8f49\u5411\u7684\u3002\u5f9e\u5ee3\u7fa9\u4e0a\u8b1b\uff0c Objects \u53ef\u4ee5\u6307\u4efb\u4f55\u6578\u64da\u7d50\u69cb\u2014\u2014\u8cc7\u6e90\u985e\u578b\u7684\u5be6\u4f8b\uff08\u5982 APIGroup\uff09\u3001\u914d\u7f6e\uff08\u5982\u5be9\u8a08\u7b56\u7565\uff09\u6216\u6301\u4e45\u5be6\u9ad4\uff08\u5982 Pod\uff09\u3002\u4f46\u662f\uff0c\u5728\u672c\u7bc0\u4e2d\uff0c\u6211\u5c07\u5728\u72f9\u7fa9\u7684\u3001\u660e\u78ba\u5b9a\u7fa9\u7684\u610f\u7fa9\u4e0a\u8a0e\u8ad6 object \u3002\u6240\u4ee5\uff0c\u6211\u5c07\u4f7f\u7528\u5927\u5beb\u7684\u8a5e Object \u4f86\u4ee3\u66ff\u3002 \u5927\u591a\u6578 Kubernetes API \u8cc7\u6e90\u4ee3\u8868 Object \u3002\u8207\u50c5\u8981\u6c42 kind \u5b57\u6bb5\u7684\u5176\u4ed6\u5f62\u5f0f\u7684\u8cc7\u6e90\u4e0d\u540c\uff0cObjects \u5fc5\u9808\u5b9a\u7fa9\u66f4\u591a\u5b57\u6bb5\uff1a kind - a string that identifies the schema this object should have apiVersion - a string that identifies the version of the schema the object should have metadata.namespace - a string with the namespace (defaults to \"default\") metadata.name - a string that uniquely identifies this object within the current namespace metadata.uid - a unique in time and space value used to distinguish between objects with the same name that have been deleted and recreated. \u6b64\u5916\uff0c metadata \u4e5f\u53ef\u80fd\u5305\u62ec\u6a19\u7c64\u548c\u8a3b\u91cb\u5b57\u6bb5\uff0c\u4ee5\u53ca\u4e00\u4e9b\u7248\u672c\u63a7\u5236\u548c\u6642\u9593\u6233\u4fe1\u606f\u3002 \u793a\u4f8b - Pod \u5c0d\u8c61\uff08\u622a\u65b7\u8f38\u51fa\uff09\uff1a $ kubectl get --raw /api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"Pod\" , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"sleep-7c7db887d8-dkkcg\" , \"uid\" : \"32bf410a-0009-484e-adac-21179ec28f0f\" , \"labels\" : { \"app\" : \"sleep\" , \"pod-template-hash\" : \"7c7db887d8\" } , \"creationTimestamp\" : \"2022-01-08T18:10:04Z\" , \"resourceVersion\" : \"465766\" } , \"spec\" : { ... } , \"status\" : { ... } } \u5982\u4e0a\u4f8b\u6240\u793a\uff0cKubernetes \u5c0d\u8c61\u901a\u5e38\u5177\u6709 spec \uff08\u671f\u671b\u72c0\u614b\uff09\u548c status \uff08\u5be6\u969b\u72c0\u614b\uff09\u5b57\u6bb5\u3002\u4f46\u60c5\u6cc1\u4e26\u975e\u7e3d\u662f\u5982\u6b64\u3002\u5c07\u4e0a\u9762\u7684\u8f38\u51fa\u8207\u4e0b\u9762\u7684 ConfigMap \u5c0d\u8c61\u9032\u884c\u6bd4\u8f03\uff1a $ kubectl get --raw /api/v1/namespaces/default/configmaps/informer-dynamic-simple-wzgmx | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"ConfigMap\" , \"data\" : { \"foo\" : \"bar\" } , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"informer-dynamic-simple-wzgmx\" , \"uid\" : \"74471398-0244-4686-b490-7007f6246a63\" , \"creationTimestamp\" : \"2022-01-06T21:45:04Z\" , \"generateName\" : \"informer-dynamic-simple-\" , \"resourceVersion\" : \"418185\" } } \u5f9e\u4ee3\u78bc\u4e2d\u8655\u7406 Kubernetes API \u6d89\u53ca\u5230\u5927\u91cf\u7684 Object \u64cd\u4f5c\uff0c\u56e0\u6b64\u5fc5\u9808\u5c0d\u5e38\u898b\u7684\u5c0d\u8c61\u7d50\u69cb\u6709\u7d2e\u5be6\u7684\u7406\u89e3\u3002 kubectl explain \u547d\u4ee4\u53ef\u4ee5\u5e6b\u52a9\u60a8\u3002\u5b83\u6700\u9177\u7684\u90e8\u5206\u662f\u5b83\u4e0d\u50c5\u53ef\u4ee5\u5728\u8cc7\u6e90\u4e0a\u8abf\u7528\uff0c\u9084\u53ef\u4ee5\u5728\u5d4c\u5957\u5b57\u6bb5\u4e0a\u8abf\u7528\uff1a $ kubectl explain deployment.spec.template KIND: Deployment VERSION: apps/v1 RESOURCE: template <Object> DESCRIPTION: Template describes the pods that will be created. PodTemplateSpec describes the data a pod should have when created from a template FIELDS: metadata <Object> Standard object ' s metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata spec <Object> Specification of the desired behavior of the pod. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status Summarizing \u00b6 Kubernetes \u7528\u8a9e\u4e2d\u7684 resource \u53ef\u4ee5\u6307\u8cc7\u6e90\u985e\u578b\u548c\u8cc7\u6e90\u5be6\u4f8b\u3002\u8cc7\u6e90\u985e\u578b\u88ab\u7d44\u7e54\u6210 API groups\uff0c\u4e26\u4e14 API groups\u662f\u7248\u672c\u5316\u7684\u3002\u6bcf\u500b\u8cc7\u6e90\u8868\u793a\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u7279\u5b9a\u6a21\u5f0f\u3002\u96d6\u7136\u6bcf\u500b\u8cc7\u6e90\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u5177\u9ad4\u7d50\u69cb\uff0c\u4f46\u4e26\u975e\u6bcf\u500b\u8cc7\u6e90\u90fd\u4ee3\u8868\u4e00\u500b Kubernetes \u5c0d\u8c61\u3002\u5c0d\u50cf\u662f\u8868\u793a\u610f\u5716\u8a18\u9304\u7684\u6301\u4e45\u5be6\u9ad4\u3002\u4e0d\u540c\u7a2e\u985e\u7684\u5c0d\u8c61\u5177\u6709\u4e0d\u540c\u7684\u7d50\u69cb\uff0c\u4f46\u6240\u6709\u5c0d\u50cf\u90fd\u5e36\u6709\u5171\u540c\u7684\u5143\u6578\u64da\u5c6c\u6027\uff0c\u4f8b\u5982\u547d\u540d\u7a7a\u9593\u3001\u540d\u7a31\u3001uid \u6216 creationTimestamp\u3002 What's next? \u00b6 \u5c0d Kubernetes API \u7684\u7406\u8ad6\u90e8\u5206\u6709\u66f4\u597d\u7684\u4e86\u89e3\u55ce\uff1f \u592a\u597d\u4e86\uff01\u3000\u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u7528\u4e00\u500b\u7c21\u55ae\u7684 HTTP \u5ba2\u6236\u7aef\u8abf\u7528\u5b83(\u4e8b\u5be6\u8b49\u660e\u9019\u4e0d\u662f\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\uff0c\u6709\u5f88\u591a\u5751\u8981\u8df3)\u3002 \u7576\u7406\u8ad6\u548c\u5be6\u8e10\u76f8\u63d0\u4e26\u8ad6\u6642\uff0c\u6211\u5efa\u8b70\u770b\u4e00\u4e0b k8s.io/api \u548c k8s.io/apimachinery \u6a21\u584a - \u9019\u662f \u5b98\u65b9 Go \u5ba2\u6236\u7aef \u7684\u5169\u500b\u4e3b\u8981\u4f9d\u8cf4\u9805\u3002 k8s.io/api \u70ba Kubernetes \u5c0d\u8c61\u5b9a\u7fa9\u7684 Go \u7d50\u69cb\uff0c\u800c k8s.io/apimachinery \u5e36\u4f86\u4e86\u8f03\u4f4e\u7d1a\u5225\u7684\u69cb\u5efa\u584a\u548c\u5e38\u898b\u7684 API \u529f\u80fd\uff0c\u5982\u5e8f\u5217\u5316\u3001\u985e\u578b\u8f49\u63db\u6216\u932f\u8aa4\u8655\u7406\u3002 \u9019\u662f\u6211\u5c0d\u9019\u5169\u500b\u6a21\u584a\u7684\u5716\u89e3\u6982\u8ff0 \u3002 Talk is cheap, show me the code? \u5927\u5bb6\u53ef\u770b\u6211\u5728 GitHub \u4e0a\u6536\u96c6\u7684 Kubernetes client-go \u793a\u4f8b\ud83d\ude09 Resources Kubernetes Documentation - API Overview Kubernetes Documentation - API Concepts Kubernetes Documentation- Understanding Kubernetes Objects SIG Architecture - API Conventions Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"K8S API \u57fa\u790e"},{"location":"kubernetes/api/kubernetes-api-structure-and-terminology/#kubernetes-api","text":"\u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-structure-and-terminology/ \u9019\u662f\u95dc\u65bc\u5982\u4f55\u5f9e\u4ee3\u78bc\u4e2d\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\u7ae0\u4e2d\u7684\u7b2c\u4e00\u7bc7\u3002 Kubernetes API \u6bd4\u4e00\u5806 HTTP \u7aef\u9ede\u7d44\u5408\u5728\u4e00\u8d77\u8981\u5148\u9032\u4e00\u9ede\u3002\u56e0\u6b64\uff0c\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8a2a\u554f\u5b83\u4e4b\u524d\uff0c\u4e86\u89e3 Kubernetes API \u7d50\u69cb\u4e26\u719f\u6089\u8853\u8a9e\u81f3\u95dc\u91cd\u8981\u3002\u5426\u5247\uff0c\u5617\u8a66\u5c07\u975e\u5e38\u75db\u82e6\u2014\u2014\u5b98\u65b9\u7684 Go \u5ba2\u6236\u7aef\u5e36\u6709\u592a\u591a\u7684\u82b1\u91cc\u80e1\u54e8\uff0c\u8a66\u5716\u5c07\u4f60\u7684\u982d\u8166\u570d\u7e5e\u5728\u5ba2\u6236\u7aef\u548c API \u6982\u5ff5\u4e0a\uff0c\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u8b93\u4f60\u4e0d\u77e5\u6240\u63aa\u3002 Kubernetes API \u975e\u5e38\u9f90\u5927\u2014\u2014\u5b83\u6709\u6578\u767e\u500b\u7aef\u9ede\u3002\u5e78\u904b\u7684\u662f\uff0c\u5b83\u975e\u5e38\u4e00\u81f4\uff0c\u56e0\u6b64\u53ea\u9700\u4e86\u89e3\u6709\u9650\u6578\u91cf\u7684\u60f3\u6cd5\uff0c\u7136\u5f8c\u5c07\u9019\u4e9b\u77e5\u8b58\u5916\u63a8\u5230 API \u7684\u5176\u9918\u90e8\u5206\u3002\u5728\u9019\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5c07\u5617\u8a66\u89f8\u53ca\u6211\u767c\u73fe\u7684\u6700\u57fa\u672c\u7684\u6982\u5ff5\u3002\u6211\u50be\u5411\u65bc\u7c21\u55ae\u548c\u6613\u6d88\u5316\uff0c\u800c\u4e0d\u662f\u5b78\u8853\u4e0a\u7684\u6b63\u78ba\u6027\u548c\u6750\u6599\u7684\u5b8c\u6574\u6027\u3002\u548c\u5f80\u5e38\u4e00\u6a23\uff0c\u6211\u53ea\u662f\u5206\u4eab\u6211\u5c0d\u4e8b\u7269\u7684\u7406\u89e3\u548c\u601d\u8003\u9019\u500b\u8a71\u984c\u7684\u65b9\u5f0f\u2014\u2014\u6240\u4ee5\uff0c\u5b83\u4e0d\u662f API \u624b\u518a\uff0c\u800c\u662f\u500b\u4eba\u5b78\u7fd2\u7d93\u9a57\u7684\u8a18\u9304\u3002","title":"Kubernetes API \u57fa\u790e"},{"location":"kubernetes/api/kubernetes-api-structure-and-terminology/#resources-and-verbs","text":"\u7531\u65bc\u5b83\u662f\u4e00\u500b RESTful \u9818\u57df\uff0c\u6211\u5011\u5c07\u6839\u64da resource \uff08\u9b06\u6563\u5730\uff0c\u67d0\u7a2e\u7d50\u69cb\u7684\u5c0d\u8c61\uff09\u548c verb \uff08\u5c0d\u9019\u4e9b\u5c0d\u8c61\u7684\u64cd\u4f5c\uff09\u9032\u884c\u64cd\u4f5c\u3002 \u5728\u8a0e\u8ad6 resources \u6642\uff0c\u5c07 a resource as a certain kind of objects \u8207 a resource as a particular instance of some kind \u5340\u5206\u958b\u4f86\u662f\u5f88\u91cd\u8981\u7684\u3002\u56e0\u6b64\uff0cKubernetes API \u7aef\u9ede\u88ab\u6b63\u5f0f\u547d\u540d\u70ba\u8cc7\u6e90\u985e\u578b (resource types)\uff0c\u4ee5\u907f\u514d\u8207\u8cc7\u6e90\u5be6\u4f8b (resource instances) \u7522\u751f\u6b67\u7fa9\u3002\u7136\u800c\uff0c\u5c0d\u4e00\u822c\u61c9\u7528\u7a0b\u5f0f\u7684\u958b\u767c\u8005\u4f86\uff0c\u7aef\u9ede(endpoint)\u901a\u5e38\u88ab\u7a31\u70ba\u8cc7\u6e90(resource)\uff0c\u56e0\u6b64\u9019\u500b\u8a5e\u7684\u5be6\u969b\u542b\u7fa9\u5f97\u5f9e\u4e0a\u4e0b\u6587\u4e2d\u4f86\u5f97\u51fa\u3002 \u51fa\u65bc\u53ef\u64f4\u5c55\u6027\u7684\u539f\u56e0\uff0c resource types \u3000\u88ab\u7d44\u7e54\u6210 API groups \uff0c\u4e26\u4e14\u9019\u4e9b\u3000API\u3000\u7fa4\u7d44\u5f7c\u6b64\u7368\u7acb\u5730\u9032\u884c\u7248\u672c\u63a7\u5236\uff1a $ kubectl api-resources NAME SHORTNAMES APIVERSION NAMESPACED KIND bindings v1 true Binding componentstatuses cs v1 false ComponentStatus configmaps cm v1 true ConfigMap endpoints ep v1 true Endpoints events ev v1 true Event limitranges limits v1 true LimitRange namespaces ns v1 false Namespace nodes no v1 false Node persistentvolumeclaims pvc v1 true PersistentVolumeClaim persistentvolumes pv v1 false PersistentVolume pods po v1 true Pod podtemplates v1 true PodTemplate replicationcontrollers rc v1 true ReplicationController resourcequotas quota v1 true ResourceQuota secrets v1 true Secret serviceaccounts sa v1 true ServiceAccount services svc v1 true Service mutatingwebhookconfigurations admissionregistration.k8s.io/v1 false MutatingWebhookConfiguration validatingwebhookconfigurations admissionregistration.k8s.io/v1 false ValidatingWebhookConfiguration customresourcedefinitions crd,crds apiextensions.k8s.io/v1 false CustomResourceDefinition apiservices apiregistration.k8s.io/v1 false APIService controllerrevisions apps/v1 true ControllerRevision daemonsets ds apps/v1 true DaemonSet deployments deploy apps/v1 true Deployment replicasets rs apps/v1 true ReplicaSet statefulsets sts apps/v1 true StatefulSet tokenreviews authentication.k8s.io/v1 false TokenReview localsubjectaccessreviews authorization.k8s.io/v1 true LocalSubjectAccessReview selfsubjectaccessreviews authorization.k8s.io/v1 false SelfSubjectAccessReview selfsubjectrulesreviews authorization.k8s.io/v1 false SelfSubjectRulesReview subjectaccessreviews authorization.k8s.io/v1 false SubjectAccessReview horizontalpodautoscalers hpa autoscaling/v2 true HorizontalPodAutoscaler cronjobs cj batch/v1 true CronJob jobs batch/v1 true Job certificatesigningrequests csr certificates.k8s.io/v1 false CertificateSigningRequest leases coordination.k8s.io/v1 true Lease endpointslices discovery.k8s.io/v1 true EndpointSlice events ev events.k8s.io/v1 true Event flowschemas flowcontrol.apiserver.k8s.io/v1beta2 false FlowSchema prioritylevelconfigurations flowcontrol.apiserver.k8s.io/v1beta2 false PriorityLevelConfiguration ingressclasses networking.k8s.io/v1 false IngressClass ingresses ing networking.k8s.io/v1 true Ingress networkpolicies netpol networking.k8s.io/v1 true NetworkPolicy runtimeclasses node.k8s.io/v1 false RuntimeClass poddisruptionbudgets pdb policy/v1 true PodDisruptionBudget podsecuritypolicies psp policy/v1beta1 false PodSecurityPolicy clusterrolebindings rbac.authorization.k8s.io/v1 false ClusterRoleBinding clusterroles rbac.authorization.k8s.io/v1 false ClusterRole rolebindings rbac.authorization.k8s.io/v1 true RoleBinding roles rbac.authorization.k8s.io/v1 true Role priorityclasses pc scheduling.k8s.io/v1 false PriorityClass csidrivers storage.k8s.io/v1 false CSIDriver csinodes storage.k8s.io/v1 false CSINode csistoragecapacities storage.k8s.io/v1beta1 true CSIStorageCapacity storageclasses sc storage.k8s.io/v1 false StorageClass volumeattachments storage.k8s.io/v1 false VolumeAttachment \u5982\u679c\u4f60\u597d\u5947 kubectl api-resources \u547d\u4ee4\u662f\u5982\u4f55\u69cb\u5efa\u9019\u6a23\u4e00\u500b\u652f\u6301\u7684\u8cc7\u6e90\u5217\u8868\u7684\uff0c\u9019\u88e1\u6709\u4e00\u500b\u5f88\u597d\u7684\u6280\u5de7\uff0c\u5b83\u986f\u793a\u4e86\u4efb\u4f55 kubectl \u547d\u4ee4\u9032\u884c\u4e86\u54ea\u4e9b API \u8abf\u7528\uff1a $ kubectl api-resources -v 6 # -v 6 means \"extra verbose logging\" ... I0108 ... GET https://192.168.58.2:8443/api?timeout = 32s 200 OK in 10 milliseconds I0108 ... GET https://192.168.58.2:8443/apis?timeout = 32s 200 OK in 1 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apiregistration.k8s.io/v1?timeout = 32s 200 OK in 7 milliseconds I0108 ... GET https://192.168.58.2:8443/api/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/authentication.k8s.io/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/events.k8s.io/v1?timeout = 32s 200 OK in 15 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apps/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/autoscaling/v2beta1?timeout = 32s 200 OK in 16 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/policy/v1beta1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/scheduling.k8s.io/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1beta1?timeout = 32s 200 OK in 43 milliseconds ... \u5176\u5be6\u3000ubernetes\u3000\u7684\u3000API\u3000\u90fd\u5177\u5099\u4e86\u76f8\u7576\u8c50\u5bcc\u7684 meta data \u4f86\u9673\u8ff0\u9019\u500b\u3000Kubernetes API \u57fa\u672c\u8cc7\u6599\u3002\u986f\u7136\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u8b80\u53d6\uff08\u6216\u5275\u5efa\uff09\u5176\u4ed6\u8cc7\u6e90\u4f86\u5217\u51fa\u73fe\u6709\u7684\uff08\u751a\u81f3\u8a3b\u518a\u65b0\u7684\u8cc7\u6e90\u985e\u578b\uff09\uff01\u4f8b\u5982\uff0c\u4e0a\u9762\u7684\u5217\u8868\u662f\u901a\u904e\u8abf\u7528\u7279\u6b8a\u7684 /api \u548c /apis/<group-name> \u8cc7\u6e90\u7372\u5f97\u7684\u3002 Info /api \u7aef\u9ede\u5df2\u7d93\u662f\u6700\u521d\u3000Kubernetes\u3000\u5b9a\u7fa9\u8207\u4f7f\u7528\u7684\uff0c\u50c5\u7528\u65bc\u6838\u5fc3\u8cc7\u6e90\uff08pod\u3001secrets\u3001configmaps \u7b49\uff09\u3002\u4e00\u500b\u66f4\u73fe\u4ee3\u548c\u901a\u7528\u7684 /apis/<group-name> \u7aef\u9ede\u7528\u65bc\u5176\u9918\u8cc7\u6e90\uff0c\u5305\u62ec\u7528\u6236\u5b9a\u7fa9\u7684\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 curl \u7b49\u6a19\u6e96 HTTP \u5ba2\u6236\u7aef\u8f15\u9b06\u8abf\u7528\u4e0a\u8ff0\u8cc7\u6e90\uff08\u5373 API \u7aef\u9ede\uff09\u4e26\u6aa2\u67e5\u8fd4\u56de\u7684\u8cc7\u6e90\uff08\u5373 JSON \u5c0d\u8c61\uff09\uff1a # Make Kubernetes API available on localhost:8080 # to bypass the auth step in subsequent queries: $ kubectl proxy --port = 8080 & # List all known API paths $ curl http://localhost:8080/ # List known versions of the `core` group $ curl http://localhost:8080/api # List known resources of the `core/v1` group $ curl http://localhost:8080/api/v1 # Get a particular Pod resource $ curl http://localhost:8080/api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg # List known groups (all but `core`) $ curl http://localhost:8080/apis # List known versions of the `apps` group $ curl http://localhost:8080/apis/apps # List known resources of the `apps/v1` group $ curl http://localhost:8080/apis/apps/v1 # Get a particular Deployment resource $ curl http://localhost:8080/apis/apps/v1/namespaces/default/deployments/sleep Info \u6709\u4e00\u7a2e\u66f4\u7c21\u55ae\u7684\u65b9\u6cd5\u4f86\u6aa2\u67e5 Kubernetes API\uff1a kubectl get --raw /SOME/API/PATH \u3002\u7136\u800c\uff0c\u4e0a\u9762\u7684\u7df4\u7fd2\u662f\u70ba\u4e86\u8868\u660e Kubernetes API \u4e26\u4e0d\u795e\u5947\u3002\u64c1\u6709\u4e00\u500b\u901a\u7528\u578b\u7684 HTTP \u5ba2\u6236\u7aef\u6216\u5de5\u5177\u5c31\u8db3\u4ee5\u958b\u59cb\u4f7f\u7528\u5b83\u4e86\u3002 \u8aaa\u5230\u3000 verbs (\u5373\u5c0d\u8cc7\u6e90\u7684\u64cd\u4f5c)\uff0c\u6240\u6709\u6a19\u6e96\u7684 CRUD \u64cd\u4f5c\u53ca\u5176\u50b3\u7d71\u6620\u5c04\u5230 HTTP \u65b9\u6cd5\u90fd\u5728\u90a3\u88e1\u3002\u6b64\u5916\uff0c\u9084\u652f\u6301\u8cc7\u6e90\u7684 patching \uff08\u9078\u64c7\u6027\u5b57\u6bb5\u4fee\u6539\uff09\u548c watching \uff08\u6d41\u5f0f\u96c6\u5408\u7684\u8b80\u53d6\uff09\u3002\u5728\u3000Kubernetes \u5b98\u65b9\u958b\u767c\u6307\u5357\u4e2d\u5b9a\u7fa9\u4e86\u8a73\u7d30\u7684\u8aaa\u660e: sig-architecture/api-conventions.md \uff1a ## Verbs on Resources API resources should use the traditional REST pattern: GET /<resourceNamePlural> - Retrieve a list of type <resourceName>, e.g. GET /pods returns a list of Pods. POST /<resourceNamePlural> - Create a new resource from the JSON object provided by the client. GET /<resourceNamePlural>/<name> - Retrieves a single resource with the given name, e.g. GET /pods/first returns a Pod named 'first'. Should be constant time, and the resource should be bounded in size. DELETE /<resourceNamePlural>/<name> - Delete the single resource with the given name. DeleteOptions may specify gracePeriodSeconds, the optional duration in seconds before the object should be deleted. Individual kinds may declare fields which provide a default grace period, and different kinds may have differing kind-wide default grace periods. A user provided grace period overrides a default grace period, including the zero grace period (\"now\"). DELETE /<resourceNamePlural> - Deletes a list of type <resourceName>, e.g. DELETE /pods a list of Pods. PUT /<resourceNamePlural>/<name> - Update or create the resource with the given name with the JSON object provided by the client. PATCH /<resourceNamePlural>/<name> - Selectively modify the specified fields of the resource. See more information below. GET /<resourceNamePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. ## PATCH operations The API supports three different PATCH operations, determined by their corresponding Content-Type header: JSON Patch, Content-Type: application/json-patch+json As defined in RFC6902, a JSON Patch is a sequence of operations that are executed on the resource, e.g. {\"op\": \"add\", \"path\": \"/a/b/c\", \"value\": [ \"foo\", \"bar\" ]}. For more details on how to use JSON Patch, see the RFC. Merge Patch, Content-Type: application/merge-patch+json As defined in RFC7386, a Merge Patch is essentially a partial representation of the resource. The submitted JSON is \"merged\" with the current resource to create a new one, then the new one is saved. For more details on how to use Merge Patch, see the RFC. Strategic Merge Patch, Content-Type: application/strategic-merge-patch+json Strategic Merge Patch is a custom implementation of Merge Patch. For a detailed explanation of how it works and why it needed to be introduced, see here.","title":"Resources and Verbs"},{"location":"kubernetes/api/kubernetes-api-structure-and-terminology/#kinds-aka-object-schemas","text":"kind (\u985e\u578b) \u9019\u500b\u8a5e\u6703\u6642\u4e0d\u6642\u5730\u51fa\u73fe\u5728\u9019\u91cc\u548c\u90a3\u88e1\u3002\u4f8b\u5982\uff0c\u5728 kubectl api-resources \u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 persistentvolumes \u8cc7\u6e90\u5177\u6709\u76f8\u61c9\u7684 PersistentVolume \u985e\u578b\u3002 \u5f88\u9577\u4e00\u6bb5\u6642\u9593\u4ee5\u4f86\uff0c\u6211\u8207 Kubernetes \u7684\u4ea4\u4e92\u50c5\u9650\u65bc\u4f7f\u7528 kubectl apply \u76f2\u76ee\u5730\u70ba\u5176\u63d0\u4f9b\u6e05\u55ae\u3002\u9019\u8b93\u6211\u89ba\u5f97 kind \u7e3d\u662f\u5305\u542b\u4e00\u500b\u8cc7\u6e90\u7684 CamelCase \u540d\u7a31\uff0c\u6bd4\u5982 Pod \u3001 Service \u3001 Deployment \u7b49\u3002 $ cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: my-deployment spec: replicas: 1 selector: ... EOF \u4f46\u5be6\u969b\u4e0a\uff0c\u5c31\u7b97\u4e0d\u662f\u8cc7\u6e90\u7684 Kubernetes \u6578\u64da\u7d50\u69cb\u4e5f\u53ef\u4ee5\u6709 Kind \u7684\u5ba3\u544a\uff1a apiVersion : audit.k8s.io/v1 kind : Policy rules : - level : Metadata \u751a\u81f3 Kubernetes \u5c0d\u8c61\uff08\u5373\u6301\u4e45\u5be6\u9ad4\uff09\u7684\u8cc7\u6e90\u4e5f\u6709 Kind \uff1a $ kubectl get --raw /api | jq { \"kind\" : \"APIVersions\" , \"versions\" : [ \"v1\" ] , \"serverAddressByClientCIDRs\" : [ { \"clientCIDR\" : \"0.0.0.0/0\" , \"serverAddress\" : \"192.168.49.2:8443\" } ] } \u90a3\u9ebc\uff0c\u4ec0\u9ebc\u662f kind \uff1f Info \"All resource types have a concrete representation which is called a kind\" - Kubernetes API reference. \u55ef\uff0c\u9019\u500b\u89e3\u91cb\u4e0d\u662f\u7279\u5225\u6709\u7528! \ud83e\udd14 \u4e8b\u5be6\u8b49\u660e\uff0c\u5728 Kubernetes \u4e2d\uff0c\u4e00\u7a2e Kind \u662f object schema \u3002\u5c31\u50cf\u60a8\u901a\u5e38\u4f7f\u7528 JSON schema \u90a3\u6a23\u3002\u63db\u53e5\u8a71\u8aaa\uff0c Kind \u662f\u6307\u7279\u5b9a\u7684\u6578\u64da\u7d50\u69cb\uff0c\u5373 attributes \u548c properties \u7684\u67d0\u7a2e\u7d44\u5408\u3002 \u6839\u64da sig-architecture/api-conventions.md \uff0c Kind \u5206\u70ba\u4e09\u985e\uff1a Objects (Pod, Service, etc) - persistent entities in the system. Lists - (PodList, APIResourceList, etc) - collections of resources of one or more kinds. Simple - specific actions on objects (status, scale, etc.) or non-persistent auxiliary entities (ListOptions, Policy, etc). Kubernetes \u4e2d\u4f7f\u7528\u7684\u5927\u591a\u6578\u7269\u4ef6(object)\uff0c\u5305\u62ec API \u8fd4\u56de\u7684\u6240\u6709 JSON \u7269\u4ef6\uff0c\u90fd\u6709 kind \u5b57\u6bb5\u3002\u5b83\u5141\u8a31\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u5728\u901a\u904e\u7db2\u7d61\u767c\u9001\u5b83\u5011\u6216\u5c07\u5b83\u5011\u5b58\u5132\u5728\u78c1\u76e4\u4e0a\u4e4b\u524d\u6b63\u78ba\u5730\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u9019\u4e9b\u7269\u4ef6\u3002","title":"Kinds aka Object Schemas"},{"location":"kubernetes/api/kubernetes-api-structure-and-terminology/#kubernetes-objects","text":"\u5c31\u50cf resource \u4e00\u6a23\uff0cKubernetes \u7528\u8a9e\u4e2d\u7684 object \u4e00\u8a5e\u662f\u4e5f\u662f\u641e\u7684\u5927\u5bb6\u6688\u982d\u8f49\u5411\u7684\u3002\u5f9e\u5ee3\u7fa9\u4e0a\u8b1b\uff0c Objects \u53ef\u4ee5\u6307\u4efb\u4f55\u6578\u64da\u7d50\u69cb\u2014\u2014\u8cc7\u6e90\u985e\u578b\u7684\u5be6\u4f8b\uff08\u5982 APIGroup\uff09\u3001\u914d\u7f6e\uff08\u5982\u5be9\u8a08\u7b56\u7565\uff09\u6216\u6301\u4e45\u5be6\u9ad4\uff08\u5982 Pod\uff09\u3002\u4f46\u662f\uff0c\u5728\u672c\u7bc0\u4e2d\uff0c\u6211\u5c07\u5728\u72f9\u7fa9\u7684\u3001\u660e\u78ba\u5b9a\u7fa9\u7684\u610f\u7fa9\u4e0a\u8a0e\u8ad6 object \u3002\u6240\u4ee5\uff0c\u6211\u5c07\u4f7f\u7528\u5927\u5beb\u7684\u8a5e Object \u4f86\u4ee3\u66ff\u3002 \u5927\u591a\u6578 Kubernetes API \u8cc7\u6e90\u4ee3\u8868 Object \u3002\u8207\u50c5\u8981\u6c42 kind \u5b57\u6bb5\u7684\u5176\u4ed6\u5f62\u5f0f\u7684\u8cc7\u6e90\u4e0d\u540c\uff0cObjects \u5fc5\u9808\u5b9a\u7fa9\u66f4\u591a\u5b57\u6bb5\uff1a kind - a string that identifies the schema this object should have apiVersion - a string that identifies the version of the schema the object should have metadata.namespace - a string with the namespace (defaults to \"default\") metadata.name - a string that uniquely identifies this object within the current namespace metadata.uid - a unique in time and space value used to distinguish between objects with the same name that have been deleted and recreated. \u6b64\u5916\uff0c metadata \u4e5f\u53ef\u80fd\u5305\u62ec\u6a19\u7c64\u548c\u8a3b\u91cb\u5b57\u6bb5\uff0c\u4ee5\u53ca\u4e00\u4e9b\u7248\u672c\u63a7\u5236\u548c\u6642\u9593\u6233\u4fe1\u606f\u3002 \u793a\u4f8b - Pod \u5c0d\u8c61\uff08\u622a\u65b7\u8f38\u51fa\uff09\uff1a $ kubectl get --raw /api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"Pod\" , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"sleep-7c7db887d8-dkkcg\" , \"uid\" : \"32bf410a-0009-484e-adac-21179ec28f0f\" , \"labels\" : { \"app\" : \"sleep\" , \"pod-template-hash\" : \"7c7db887d8\" } , \"creationTimestamp\" : \"2022-01-08T18:10:04Z\" , \"resourceVersion\" : \"465766\" } , \"spec\" : { ... } , \"status\" : { ... } } \u5982\u4e0a\u4f8b\u6240\u793a\uff0cKubernetes \u5c0d\u8c61\u901a\u5e38\u5177\u6709 spec \uff08\u671f\u671b\u72c0\u614b\uff09\u548c status \uff08\u5be6\u969b\u72c0\u614b\uff09\u5b57\u6bb5\u3002\u4f46\u60c5\u6cc1\u4e26\u975e\u7e3d\u662f\u5982\u6b64\u3002\u5c07\u4e0a\u9762\u7684\u8f38\u51fa\u8207\u4e0b\u9762\u7684 ConfigMap \u5c0d\u8c61\u9032\u884c\u6bd4\u8f03\uff1a $ kubectl get --raw /api/v1/namespaces/default/configmaps/informer-dynamic-simple-wzgmx | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"ConfigMap\" , \"data\" : { \"foo\" : \"bar\" } , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"informer-dynamic-simple-wzgmx\" , \"uid\" : \"74471398-0244-4686-b490-7007f6246a63\" , \"creationTimestamp\" : \"2022-01-06T21:45:04Z\" , \"generateName\" : \"informer-dynamic-simple-\" , \"resourceVersion\" : \"418185\" } } \u5f9e\u4ee3\u78bc\u4e2d\u8655\u7406 Kubernetes API \u6d89\u53ca\u5230\u5927\u91cf\u7684 Object \u64cd\u4f5c\uff0c\u56e0\u6b64\u5fc5\u9808\u5c0d\u5e38\u898b\u7684\u5c0d\u8c61\u7d50\u69cb\u6709\u7d2e\u5be6\u7684\u7406\u89e3\u3002 kubectl explain \u547d\u4ee4\u53ef\u4ee5\u5e6b\u52a9\u60a8\u3002\u5b83\u6700\u9177\u7684\u90e8\u5206\u662f\u5b83\u4e0d\u50c5\u53ef\u4ee5\u5728\u8cc7\u6e90\u4e0a\u8abf\u7528\uff0c\u9084\u53ef\u4ee5\u5728\u5d4c\u5957\u5b57\u6bb5\u4e0a\u8abf\u7528\uff1a $ kubectl explain deployment.spec.template KIND: Deployment VERSION: apps/v1 RESOURCE: template <Object> DESCRIPTION: Template describes the pods that will be created. PodTemplateSpec describes the data a pod should have when created from a template FIELDS: metadata <Object> Standard object ' s metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata spec <Object> Specification of the desired behavior of the pod. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status","title":"Kubernetes Objects"},{"location":"kubernetes/api/kubernetes-api-structure-and-terminology/#summarizing","text":"Kubernetes \u7528\u8a9e\u4e2d\u7684 resource \u53ef\u4ee5\u6307\u8cc7\u6e90\u985e\u578b\u548c\u8cc7\u6e90\u5be6\u4f8b\u3002\u8cc7\u6e90\u985e\u578b\u88ab\u7d44\u7e54\u6210 API groups\uff0c\u4e26\u4e14 API groups\u662f\u7248\u672c\u5316\u7684\u3002\u6bcf\u500b\u8cc7\u6e90\u8868\u793a\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u7279\u5b9a\u6a21\u5f0f\u3002\u96d6\u7136\u6bcf\u500b\u8cc7\u6e90\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u5177\u9ad4\u7d50\u69cb\uff0c\u4f46\u4e26\u975e\u6bcf\u500b\u8cc7\u6e90\u90fd\u4ee3\u8868\u4e00\u500b Kubernetes \u5c0d\u8c61\u3002\u5c0d\u50cf\u662f\u8868\u793a\u610f\u5716\u8a18\u9304\u7684\u6301\u4e45\u5be6\u9ad4\u3002\u4e0d\u540c\u7a2e\u985e\u7684\u5c0d\u8c61\u5177\u6709\u4e0d\u540c\u7684\u7d50\u69cb\uff0c\u4f46\u6240\u6709\u5c0d\u50cf\u90fd\u5e36\u6709\u5171\u540c\u7684\u5143\u6578\u64da\u5c6c\u6027\uff0c\u4f8b\u5982\u547d\u540d\u7a7a\u9593\u3001\u540d\u7a31\u3001uid \u6216 creationTimestamp\u3002","title":"Summarizing"},{"location":"kubernetes/api/kubernetes-api-structure-and-terminology/#whats-next","text":"\u5c0d Kubernetes API \u7684\u7406\u8ad6\u90e8\u5206\u6709\u66f4\u597d\u7684\u4e86\u89e3\u55ce\uff1f \u592a\u597d\u4e86\uff01\u3000\u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u7528\u4e00\u500b\u7c21\u55ae\u7684 HTTP \u5ba2\u6236\u7aef\u8abf\u7528\u5b83(\u4e8b\u5be6\u8b49\u660e\u9019\u4e0d\u662f\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\uff0c\u6709\u5f88\u591a\u5751\u8981\u8df3)\u3002 \u7576\u7406\u8ad6\u548c\u5be6\u8e10\u76f8\u63d0\u4e26\u8ad6\u6642\uff0c\u6211\u5efa\u8b70\u770b\u4e00\u4e0b k8s.io/api \u548c k8s.io/apimachinery \u6a21\u584a - \u9019\u662f \u5b98\u65b9 Go \u5ba2\u6236\u7aef \u7684\u5169\u500b\u4e3b\u8981\u4f9d\u8cf4\u9805\u3002 k8s.io/api \u70ba Kubernetes \u5c0d\u8c61\u5b9a\u7fa9\u7684 Go \u7d50\u69cb\uff0c\u800c k8s.io/apimachinery \u5e36\u4f86\u4e86\u8f03\u4f4e\u7d1a\u5225\u7684\u69cb\u5efa\u584a\u548c\u5e38\u898b\u7684 API \u529f\u80fd\uff0c\u5982\u5e8f\u5217\u5316\u3001\u985e\u578b\u8f49\u63db\u6216\u932f\u8aa4\u8655\u7406\u3002 \u9019\u662f\u6211\u5c0d\u9019\u5169\u500b\u6a21\u584a\u7684\u5716\u89e3\u6982\u8ff0 \u3002 Talk is cheap, show me the code? \u5927\u5bb6\u53ef\u770b\u6211\u5728 GitHub \u4e0a\u6536\u96c6\u7684 Kubernetes client-go \u793a\u4f8b\ud83d\ude09 Resources Kubernetes Documentation - API Overview Kubernetes Documentation - API Concepts Kubernetes Documentation- Understanding Kubernetes Objects SIG Architecture - API Conventions Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"What's next?"},{"location":"kubernetes/api/working-with-k8s-api/","text":"Working with Kubernetes API \u00b6 \u539f\u6587: https://iximiuz.com/en/series/working-with-kubernetes-api/ Kubernetes \u5df2\u7d93\u6210\u70ba\u6211\u5011\u8a31\u591a\u4eba\u65b0\u4e00\u4ee3\u57fa\u790e\u8a2d\u65bd\u7684\u901a\u7528\u8a9e\u3002\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\uff0c\u9019\u662f\u7531\u65bc Kubernetes \u63d0\u4f9b\u4e86\u53ef\u79fb\u690d\u7684 API \u4f86\u7ba1\u7406\u670d\u52d9\u5668\u8cc7\u6e90\u3002\u5c31\u50cf POSIX \u5b9a\u7fa9\u4e86\u6d88\u8017\u55ae\u53f0\u8a08\u7b97\u6a5f\u8cc7\u6e90\u7684\u6a19\u6e96\u65b9\u5f0f\u4e00\u6a23\uff0cKubernetes API \u4ee5\u8207\u63d0\u4f9b\u8005\u7121\u95dc\u7684\u65b9\u5f0f\u555f\u7528\u4e86\u6578\u64da\u4e2d\u5fc3\u8cc7\u6e90\u7684\u6d88\u8017\u3002 \u9019\u662f\u95dc\u65bc\u5f9e\u547d\u4ee4\u884c\u548c\u4ee3\u78bc\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\uff1a \u672c\u7cfb\u5217\u9996\u5148\u6982\u8ff0\u6700\u57fa\u672c\u7684 API \u6982\u5ff5\u3002 \u89e3\u91cb\u4e86Resource\u3001Kind\u200b\u200b\u548cObject\u7b49\u95dc\u9375\u7684\u57fa\u790e\u77e5\u8b58\u3002 \u8aaa\u660e API \u7d50\u69cb\u548c\u8853\u8a9e\u3002 \u6709\u5927\u91cf\u95dc\u65bc\u5982\u4f55\u8a2a\u554f\u548c\u64f4\u5c55 API \u7684\u5be6\u969b\u793a\u4f8b\u3002 \u9019\u7cfb\u5217\u9084\u53ef\u4ee5\u5e6b\u52a9\u8b80\u8005\u4e86\u89e3\u7576\u4ee3 Kubernetes API \u5ba2\u6236\u7aef\uff08Go \u548c Rust\uff09\uff0c\u5f9e\u57fa\u672c\u7684 REST \u529f\u80fd\u958b\u59cb\uff0c\u5230 Informers \u548c Work Queues \u7b49\u9ad8\u7d1a\u62bd\u8c61\uff0c\u56e0\u6b64\u5b83\u5c0d\u7de8\u5beb\u5404\u7a2e Kubernetes \u81ea\u52d5\u5316\u7684\u4eba\u5f88\u6709\u7528\u5305\u62ec\u81ea\u5b9a\u7fa9 custom operator \u548c controller\u3002 Kubernetes API Basics - Resources, Kinds, and Objects How To Call Kubernetes API using Simple HTTP Client How To Call Kubernetes API using Go - Types and Common Machinery How To Extend Kubernetes API - Kubernetes vs. Django How To Develop Kubernetes CLIs Like a Pro","title":"\u4f7f\u7528 K8S API"},{"location":"kubernetes/api/working-with-k8s-api/#working-with-kubernetes-api","text":"\u539f\u6587: https://iximiuz.com/en/series/working-with-kubernetes-api/ Kubernetes \u5df2\u7d93\u6210\u70ba\u6211\u5011\u8a31\u591a\u4eba\u65b0\u4e00\u4ee3\u57fa\u790e\u8a2d\u65bd\u7684\u901a\u7528\u8a9e\u3002\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\uff0c\u9019\u662f\u7531\u65bc Kubernetes \u63d0\u4f9b\u4e86\u53ef\u79fb\u690d\u7684 API \u4f86\u7ba1\u7406\u670d\u52d9\u5668\u8cc7\u6e90\u3002\u5c31\u50cf POSIX \u5b9a\u7fa9\u4e86\u6d88\u8017\u55ae\u53f0\u8a08\u7b97\u6a5f\u8cc7\u6e90\u7684\u6a19\u6e96\u65b9\u5f0f\u4e00\u6a23\uff0cKubernetes API \u4ee5\u8207\u63d0\u4f9b\u8005\u7121\u95dc\u7684\u65b9\u5f0f\u555f\u7528\u4e86\u6578\u64da\u4e2d\u5fc3\u8cc7\u6e90\u7684\u6d88\u8017\u3002 \u9019\u662f\u95dc\u65bc\u5f9e\u547d\u4ee4\u884c\u548c\u4ee3\u78bc\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\uff1a \u672c\u7cfb\u5217\u9996\u5148\u6982\u8ff0\u6700\u57fa\u672c\u7684 API \u6982\u5ff5\u3002 \u89e3\u91cb\u4e86Resource\u3001Kind\u200b\u200b\u548cObject\u7b49\u95dc\u9375\u7684\u57fa\u790e\u77e5\u8b58\u3002 \u8aaa\u660e API \u7d50\u69cb\u548c\u8853\u8a9e\u3002 \u6709\u5927\u91cf\u95dc\u65bc\u5982\u4f55\u8a2a\u554f\u548c\u64f4\u5c55 API \u7684\u5be6\u969b\u793a\u4f8b\u3002 \u9019\u7cfb\u5217\u9084\u53ef\u4ee5\u5e6b\u52a9\u8b80\u8005\u4e86\u89e3\u7576\u4ee3 Kubernetes API \u5ba2\u6236\u7aef\uff08Go \u548c Rust\uff09\uff0c\u5f9e\u57fa\u672c\u7684 REST \u529f\u80fd\u958b\u59cb\uff0c\u5230 Informers \u548c Work Queues \u7b49\u9ad8\u7d1a\u62bd\u8c61\uff0c\u56e0\u6b64\u5b83\u5c0d\u7de8\u5beb\u5404\u7a2e Kubernetes \u81ea\u52d5\u5316\u7684\u4eba\u5f88\u6709\u7528\u5305\u62ec\u81ea\u5b9a\u7fa9 custom operator \u548c controller\u3002 Kubernetes API Basics - Resources, Kinds, and Objects How To Call Kubernetes API using Simple HTTP Client How To Call Kubernetes API using Go - Types and Common Machinery How To Extend Kubernetes API - Kubernetes vs. Django How To Develop Kubernetes CLIs Like a Pro","title":"Working with Kubernetes API"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/","text":"\u4f7f\u7528 GitOps \u548c Argo CD Vault \u63d2\u4ef6\u9032\u884c Secret \u7ba1\u7406 \u00b6 \u539f\u6587: https://colinwilson.uk/2022/03/27/secret-management-with-gitops-and-argo-cd-vault-plugin/ GitOps \u5f88\u68d2\uff01\u4ec0\u9ebc\u662f GitOps\uff1f Info GitOps \u662f\u4e00\u7a2e\u9032\u884c Kubernetes \u96c6\u7fa4\u7ba1\u7406\u548c\u61c9\u7528\u4ea4\u4ed8\u7684\u65b9\u6cd5\u3002 GitOps \u901a\u904e\u4f7f\u7528 Git \u4f5c\u70ba\u8072\u660e\u6027\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u7684\u55ae\u4e00\u4e8b\u5be6\u4f86\u6e90\u4f86\u5de5\u4f5c\u3002 \u66f4\u7c21\u55ae\u5730\u8aaa\uff0cGitOps \u5141\u8a31\u60a8\u901a\u904e Git \u4ee5\u4ee3\u78bc\u7684\u5f62\u5f0f\u8a2d\u7f6e\u548c\u7ba1\u7406\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u3002 \u4f46\u662f\u5bc6\u78bc\u3001api \u4ee4\u724c\u3001\u6578\u64da\u5eab\u6191\u8b49\u548c\u5176\u4ed6\u79d8\u5bc6\u5462\uff1f\u9019\u4e9b\u4e5f\u53ef\u4ee5\u5b58\u5132\u5728 Git \u4e2d\u55ce\uff1f\u4e0d\uff01\uff01\uff01\u5728 Git \u4e2d\u5b58\u5132\u79d8\u5bc6\u662f\u4e00\u500b\u975e\u5e38\u7cdf\u7cd5\u7684\u4e3b\u610f\u3002\u9019\u5c31\u5f15\u51fa\u4e86\u4e00\u500b\u5e38\u898b\u7684\u554f\u984c\uff0c\u201c\u4f60\u5982\u4f55\u4f7f\u7528 GitOps \u8655\u7406\u79d8\u5bc6\uff1f\u201d\u3002 \u4f5c\u6cd5\u6709\u597d\u5e7e\u7a2e\u3002\u4e00\u7a2e\u5e38\u898b\u7684\u65b9\u6cd5\u662f\u5c0d\u6a5f\u5bc6\u672c\u8eab\u4f7f\u7528\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08\u4f8b\u5982 HashiCorp Vault\uff09\uff0c\u4e26\u4f7f\u7528\u53e6\u4e00\u500b\u5de5\u5177\uff08\u6216\u591a\u500b\u5de5\u5177\uff09\u5f9e\u7ba1\u7406\u5de5\u5177\u4e2d\u63d0\u53d6\u9019\u4e9b\u6a5f\u5bc6\u4e26\u5c07\u5b83\u5011\u201c\u6ce8\u5165\u201d\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002 \u672c\u6559\u7a0b\u6db5\u84cb\u4e86\u4f7f\u7528 Argo CD Vault Plugin \u7ba1\u7406\u6a5f\u5bc6\u7684\u7279\u5b9a\u5834\u666f\u3002 Argo CD Vault Plugin\uff08\u9867\u540d\u601d\u7fa9\uff09\u662f\u4e00\u500b Argo CD \u914d\u7f6e\u7ba1\u7406\u63d2\u4ef6\uff0c\u8207\u8a31\u591a\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08HashiCorp Vault\u3001IBM Cloud Secrets Manager\u3001AWS Secrets Manager \u7b49\uff09\u517c\u5bb9\u3002\u672c\u6559\u7a0b\u4ecb\u7d39\u4e86\u5b83\u8207 HashiCorp Vault \u7684\u96c6\u6210\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u60a8\u5c07\u9700\u8981\u4ee5\u4e0b\u5167\u5bb9\uff1a HashiCorp Vault \u5b89\u88dd Terraform\u3001Kubernetes\u3001Git/GitHub \u548c Traefik \u7684\u521d\u5b78\u8005\u5230\u4e2d\u7d1a\u77e5\u8b58 Terraform \u2265 v0.15 Argo CD Vault \u63d2\u4ef6\u7684\u5de5\u4f5c\u539f\u7406 \u00b6 Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u5c07\u4f54\u4f4d\u7b26 placeholder \u5b58\u5132\u5728 git \u4e2d\uff0c\u800c\u4e0d\u662f\u5be6\u969b\u7684 Kubernetes secret \u3002 \u6240\u4ee5\u4e00\u500b\u5178\u578b\u7684 yaml/manifest secret \u7bc4\u4f8b\u5982\u4e0b: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : bXlfZmlyc3Rfc2VjcmV0 Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u6211\u5011\u5c07 TOKEN \u7684\u503c\u66ff\u63db\u70ba\u4f54\u4f4d\u7b26 placeholder \u7136\u5f8c\u518d\u5b58\u5132\u5728 git \u4e2d\uff0c\u4f8b\u5982: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : <myToken> \u4e0b\u5716\u8aaa\u660e\u4e86 Argo CD Vault \u63d2\u4ef6\u5c07\u6a5f\u5bc6\u6ce8\u5165 Kubernetes \u96c6\u7fa4\u7684\u904e\u7a0b\u4e2d\u7684\u6b65\u9a5f\uff1a Argo CD \u5f9e Git Repo \u62c9\u53d6 Secret manifest \u6a21\u677f Vault \u63d2\u4ef6\u7531\u6a21\u677f\u4e2d\u5b58\u5728\u7684\u4f54\u4f4d\u7b26\u89f8\u767c \u8a72\u63d2\u4ef6\u901a\u904e Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e26\u62c9\u53d6 secret\uff08\u6839\u64da avp.kubernetes.io/path \u8a3b\u89e3\u8a2d\u7f6e\u7684\u8def\u5f91\u5b9a\u4f4d\uff09 \u6aa2\u7d22\u5230\u7684\u79d8\u5bc6\u88ab\u6ce8\u5165\u5230\u6a21\u677f\u4e2d\uff0c\u66ff\u63db\u4f54\u4f4d\u7b26 Argo CD \u7136\u5f8c\u5c07\u66f4\u65b0\u7684\u6e05\u55ae\u61c9\u7528\u5230 Kubernetes Tip Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc secret\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc deployment\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc\u79d8\u5bc6\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc\u90e8\u7f72\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002 ArgoCD \u5b89\u88dd \u00b6 \u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s \u66dd\u9732 ArgoCD \u670d\u52d9 \u00b6 \u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684\u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' \u4f7f\u7528 ArgoCD Web UI \u00b6 \u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002 \u5b89\u88dd ArgoCD-Vault-Plugin \u00b6","title":"\u4f7f\u7528 Argo CD Vault \u63d2\u4ef6\u9032\u884c Secret \u7ba1\u7406"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#gitops-argo-cd-vault-secret","text":"\u539f\u6587: https://colinwilson.uk/2022/03/27/secret-management-with-gitops-and-argo-cd-vault-plugin/ GitOps \u5f88\u68d2\uff01\u4ec0\u9ebc\u662f GitOps\uff1f Info GitOps \u662f\u4e00\u7a2e\u9032\u884c Kubernetes \u96c6\u7fa4\u7ba1\u7406\u548c\u61c9\u7528\u4ea4\u4ed8\u7684\u65b9\u6cd5\u3002 GitOps \u901a\u904e\u4f7f\u7528 Git \u4f5c\u70ba\u8072\u660e\u6027\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u7684\u55ae\u4e00\u4e8b\u5be6\u4f86\u6e90\u4f86\u5de5\u4f5c\u3002 \u66f4\u7c21\u55ae\u5730\u8aaa\uff0cGitOps \u5141\u8a31\u60a8\u901a\u904e Git \u4ee5\u4ee3\u78bc\u7684\u5f62\u5f0f\u8a2d\u7f6e\u548c\u7ba1\u7406\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u3002 \u4f46\u662f\u5bc6\u78bc\u3001api \u4ee4\u724c\u3001\u6578\u64da\u5eab\u6191\u8b49\u548c\u5176\u4ed6\u79d8\u5bc6\u5462\uff1f\u9019\u4e9b\u4e5f\u53ef\u4ee5\u5b58\u5132\u5728 Git \u4e2d\u55ce\uff1f\u4e0d\uff01\uff01\uff01\u5728 Git \u4e2d\u5b58\u5132\u79d8\u5bc6\u662f\u4e00\u500b\u975e\u5e38\u7cdf\u7cd5\u7684\u4e3b\u610f\u3002\u9019\u5c31\u5f15\u51fa\u4e86\u4e00\u500b\u5e38\u898b\u7684\u554f\u984c\uff0c\u201c\u4f60\u5982\u4f55\u4f7f\u7528 GitOps \u8655\u7406\u79d8\u5bc6\uff1f\u201d\u3002 \u4f5c\u6cd5\u6709\u597d\u5e7e\u7a2e\u3002\u4e00\u7a2e\u5e38\u898b\u7684\u65b9\u6cd5\u662f\u5c0d\u6a5f\u5bc6\u672c\u8eab\u4f7f\u7528\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08\u4f8b\u5982 HashiCorp Vault\uff09\uff0c\u4e26\u4f7f\u7528\u53e6\u4e00\u500b\u5de5\u5177\uff08\u6216\u591a\u500b\u5de5\u5177\uff09\u5f9e\u7ba1\u7406\u5de5\u5177\u4e2d\u63d0\u53d6\u9019\u4e9b\u6a5f\u5bc6\u4e26\u5c07\u5b83\u5011\u201c\u6ce8\u5165\u201d\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002 \u672c\u6559\u7a0b\u6db5\u84cb\u4e86\u4f7f\u7528 Argo CD Vault Plugin \u7ba1\u7406\u6a5f\u5bc6\u7684\u7279\u5b9a\u5834\u666f\u3002 Argo CD Vault Plugin\uff08\u9867\u540d\u601d\u7fa9\uff09\u662f\u4e00\u500b Argo CD \u914d\u7f6e\u7ba1\u7406\u63d2\u4ef6\uff0c\u8207\u8a31\u591a\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08HashiCorp Vault\u3001IBM Cloud Secrets Manager\u3001AWS Secrets Manager \u7b49\uff09\u517c\u5bb9\u3002\u672c\u6559\u7a0b\u4ecb\u7d39\u4e86\u5b83\u8207 HashiCorp Vault \u7684\u96c6\u6210\u3002","title":"\u4f7f\u7528 GitOps \u548c Argo CD Vault \u63d2\u4ef6\u9032\u884c Secret \u7ba1\u7406"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#_1","text":"\u5c0d\u65bc\u672c\u6307\u5357\uff0c\u60a8\u5c07\u9700\u8981\u4ee5\u4e0b\u5167\u5bb9\uff1a HashiCorp Vault \u5b89\u88dd Terraform\u3001Kubernetes\u3001Git/GitHub \u548c Traefik \u7684\u521d\u5b78\u8005\u5230\u4e2d\u7d1a\u77e5\u8b58 Terraform \u2265 v0.15","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#argo-cd-vault","text":"Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u5c07\u4f54\u4f4d\u7b26 placeholder \u5b58\u5132\u5728 git \u4e2d\uff0c\u800c\u4e0d\u662f\u5be6\u969b\u7684 Kubernetes secret \u3002 \u6240\u4ee5\u4e00\u500b\u5178\u578b\u7684 yaml/manifest secret \u7bc4\u4f8b\u5982\u4e0b: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : bXlfZmlyc3Rfc2VjcmV0 Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u6211\u5011\u5c07 TOKEN \u7684\u503c\u66ff\u63db\u70ba\u4f54\u4f4d\u7b26 placeholder \u7136\u5f8c\u518d\u5b58\u5132\u5728 git \u4e2d\uff0c\u4f8b\u5982: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : <myToken> \u4e0b\u5716\u8aaa\u660e\u4e86 Argo CD Vault \u63d2\u4ef6\u5c07\u6a5f\u5bc6\u6ce8\u5165 Kubernetes \u96c6\u7fa4\u7684\u904e\u7a0b\u4e2d\u7684\u6b65\u9a5f\uff1a Argo CD \u5f9e Git Repo \u62c9\u53d6 Secret manifest \u6a21\u677f Vault \u63d2\u4ef6\u7531\u6a21\u677f\u4e2d\u5b58\u5728\u7684\u4f54\u4f4d\u7b26\u89f8\u767c \u8a72\u63d2\u4ef6\u901a\u904e Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e26\u62c9\u53d6 secret\uff08\u6839\u64da avp.kubernetes.io/path \u8a3b\u89e3\u8a2d\u7f6e\u7684\u8def\u5f91\u5b9a\u4f4d\uff09 \u6aa2\u7d22\u5230\u7684\u79d8\u5bc6\u88ab\u6ce8\u5165\u5230\u6a21\u677f\u4e2d\uff0c\u66ff\u63db\u4f54\u4f4d\u7b26 Argo CD \u7136\u5f8c\u5c07\u66f4\u65b0\u7684\u6e05\u55ae\u61c9\u7528\u5230 Kubernetes Tip Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc secret\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc deployment\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002","title":"Argo CD Vault \u63d2\u4ef6\u7684\u5de5\u4f5c\u539f\u7406"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#kubernetes","text":"\u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc\u79d8\u5bc6\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc\u90e8\u7f72\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd","text":"\u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s","title":"ArgoCD \u5b89\u88dd"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd_1","text":"\u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684\u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0'","title":"\u66dd\u9732 ArgoCD \u670d\u52d9"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd-web-ui","text":"\u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002","title":"\u4f7f\u7528 ArgoCD Web UI"},{"location":"kubernetes/argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd-vault-plugin","text":"","title":"\u5b89\u88dd ArgoCD-Vault-Plugin"},{"location":"kubernetes/argocd/tutorial/","text":"\u6b61\u8fce\u4f86\u5230 ArgoCD \u6559\u7a0b \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/index.html ArgoCD \u00b6 Argo CD \u662f\u7528\u65bc Kubernetes \u7684\u5ba3\u544a\u5f0f GitOps \u6301\u7e8c\u4ea4\u4ed8\u5de5\u5177\u3002 \u5b83\u9075\u5faa GitOps \u6a21\u5f0f\uff0c\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u5b9a\u7fa9\u6240\u9700\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u7684\u4e8b\u5be6\u4f86\u6e90\u3002 \u5b83\u5728\u6307\u5b9a\u7684\u76ee\u6a19\u74b0\u5883\u4e2d\u81ea\u52d5\u90e8\u7f72\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u3002\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u53ef\u4ee5\u8ddf\u8e2a\u5206\u652f\u3001\u6a19\u7c64\u7684\u66f4\u65b0\uff0c\u6216\u5728 Git \u63d0\u4ea4\u6642\u56fa\u5b9a\u5230\u7279\u5b9a\u7248\u672c\u7684\u6e05\u55ae\u3002 GitOps \u00b6 GitOps \u662f\u4e00\u7d44\u5229\u7528 Git \u5de5\u4f5c\u6d41\u4f86\u7ba1\u7406\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u7684\u5be6\u8e10\u3002\u901a\u904e\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u4e8b\u5be6\u4f86\u6e90\uff0c\u5b83\u5141\u8a31 DevOps \u5718\u968a\u5c07\u96c6\u7fa4\u914d\u7f6e\u7684\u6574\u500b\u72c0\u614b\u5b58\u5132\u5728 Git \u4e2d\uff0c\u4ee5\u4fbf\u66f4\u6539\u8ddf\u8e2a\u662f\u53ef\u898b\u548c\u53ef\u5be9\u8a08\u7684\u3002 GitOps \u901a\u904e\u5c07\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u5b9a\u7fa9\u70ba\u201c\u4ee3\u78bc\u201d\u4f86\u7c21\u5316\u8de8\u591a\u500b\u96c6\u7fa4\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u66f4\u6539\u7684\u50b3\u64ad\u3002 \u78ba\u4fdd\u96c6\u7fa4\u5177\u6709\u76f8\u4f3c\u7684\u914d\u7f6e\u3001\u76e3\u63a7\u6216\u5b58\u5132\u72c0\u614b\u3002 \u5f9e\u5df2\u77e5\u72c0\u614b\u6062\u5fa9\u6216\u91cd\u65b0\u5275\u5efa\u96c6\u7fa4\u3002 \u5275\u5efa\u5177\u6709\u5df2\u77e5\u72c0\u614b\u7684\u96c6\u7fa4\u3002 \u5c07\u914d\u7f6e\u66f4\u6539\u61c9\u7528\u6216\u9084\u539f\u5230\u591a\u500b\u96c6\u7fa4\u3002 \u5c07\u6a21\u677f\u5316\u914d\u7f6e\u8207\u4e0d\u540c\u7684\u74b0\u5883\u76f8\u95dc\u806f\u3002","title":"ArgoCD \u6559\u7a0b\u7c21\u4ecb"},{"location":"kubernetes/argocd/tutorial/#argocd","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/index.html","title":"\u6b61\u8fce\u4f86\u5230 ArgoCD \u6559\u7a0b"},{"location":"kubernetes/argocd/tutorial/#argocd_1","text":"Argo CD \u662f\u7528\u65bc Kubernetes \u7684\u5ba3\u544a\u5f0f GitOps \u6301\u7e8c\u4ea4\u4ed8\u5de5\u5177\u3002 \u5b83\u9075\u5faa GitOps \u6a21\u5f0f\uff0c\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u5b9a\u7fa9\u6240\u9700\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u7684\u4e8b\u5be6\u4f86\u6e90\u3002 \u5b83\u5728\u6307\u5b9a\u7684\u76ee\u6a19\u74b0\u5883\u4e2d\u81ea\u52d5\u90e8\u7f72\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u3002\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u53ef\u4ee5\u8ddf\u8e2a\u5206\u652f\u3001\u6a19\u7c64\u7684\u66f4\u65b0\uff0c\u6216\u5728 Git \u63d0\u4ea4\u6642\u56fa\u5b9a\u5230\u7279\u5b9a\u7248\u672c\u7684\u6e05\u55ae\u3002","title":"ArgoCD"},{"location":"kubernetes/argocd/tutorial/#gitops","text":"GitOps \u662f\u4e00\u7d44\u5229\u7528 Git \u5de5\u4f5c\u6d41\u4f86\u7ba1\u7406\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u7684\u5be6\u8e10\u3002\u901a\u904e\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u4e8b\u5be6\u4f86\u6e90\uff0c\u5b83\u5141\u8a31 DevOps \u5718\u968a\u5c07\u96c6\u7fa4\u914d\u7f6e\u7684\u6574\u500b\u72c0\u614b\u5b58\u5132\u5728 Git \u4e2d\uff0c\u4ee5\u4fbf\u66f4\u6539\u8ddf\u8e2a\u662f\u53ef\u898b\u548c\u53ef\u5be9\u8a08\u7684\u3002 GitOps \u901a\u904e\u5c07\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u5b9a\u7fa9\u70ba\u201c\u4ee3\u78bc\u201d\u4f86\u7c21\u5316\u8de8\u591a\u500b\u96c6\u7fa4\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u66f4\u6539\u7684\u50b3\u64ad\u3002 \u78ba\u4fdd\u96c6\u7fa4\u5177\u6709\u76f8\u4f3c\u7684\u914d\u7f6e\u3001\u76e3\u63a7\u6216\u5b58\u5132\u72c0\u614b\u3002 \u5f9e\u5df2\u77e5\u72c0\u614b\u6062\u5fa9\u6216\u91cd\u65b0\u5275\u5efa\u96c6\u7fa4\u3002 \u5275\u5efa\u5177\u6709\u5df2\u77e5\u72c0\u614b\u7684\u96c6\u7fa4\u3002 \u5c07\u914d\u7f6e\u66f4\u6539\u61c9\u7528\u6216\u9084\u539f\u5230\u591a\u500b\u96c6\u7fa4\u3002 \u5c07\u6a21\u677f\u5316\u914d\u7f6e\u8207\u4e0d\u540c\u7684\u74b0\u5883\u76f8\u95dc\u806f\u3002","title":"GitOps"},{"location":"kubernetes/argocd/tutorial/01-setup/","text":"\u8a2d\u5b9a \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/01-setup.html \u76f8\u95dc\u9700\u8981\u7684 CLI \u5de5\u5177 \u00b6 \u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u9700\u8981\u4ee5\u4e0b CLI \u5de5\u5177\u3002\u5728\u958b\u59cb\u5b78\u7fd2\u4efb\u4f55\u6559\u7a0b\u7ae0\u7bc0\u4e4b\u524d\uff0c\u8acb\u5148\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\u5011\u3002 Tool Linux Git Download Docker Download K3D v5.4.4 Download kubectl v1.20.2 Download argocd v2.0.0 Download kustomize v4.1.2 Download \u4ee5\u4e0b CLI \u5de5\u5177\u5c0d\u65bc\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u662f\u53ef\u9078\u7684\u3002\u5118\u7ba1\u5728\u6559\u7a0b\u4e2d\u4f7f\u7528\u4e86\u5b83\u5011\uff0c\u4f46\u60a8\u53ef\u4ee5\u6beb\u7121\u554f\u984c\u5730\u4f7f\u7528\u5176\u4ed6\u7684\u3002 \u53d6\u5f97\u6559\u7a0b\u8cc7\u6e90 \u00b6 \u5728\u958b\u59cb\u8a2d\u7f6e\u74b0\u5883\u4e4b\u524d\uff0c\u8b93\u6211\u5011 clone \u6559\u7a0b\u6e90\u78bc\u4e26\u5c07 TUTORIAL_HOME \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6559\u7a0b\u7684\u6839\u76ee\u9304\uff1a $ git clone https://github.com/redhat-scholars/argocd-tutorial.git gitops $ export TUTORIAL_HOME = \" $( pwd ) /gitops\" $ cd $TUTORIAL_HOME \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc\u79d8\u5bc6\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc\u90e8\u7f72\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002 ArgoCD \u5b89\u88dd \u00b6 \u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml \u7d50\u679c: customresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created customresourcedefinition.apiextensions.k8s.io/applicationsets.argoproj.io created customresourcedefinition.apiextensions.k8s.io/appprojects.argoproj.io created serviceaccount/argocd-application-controller created serviceaccount/argocd-applicationset-controller created serviceaccount/argocd-dex-server created serviceaccount/argocd-notifications-controller created serviceaccount/argocd-redis created serviceaccount/argocd-repo-server created serviceaccount/argocd-server created role.rbac.authorization.k8s.io/argocd-application-controller created role.rbac.authorization.k8s.io/argocd-applicationset-controller created role.rbac.authorization.k8s.io/argocd-dex-server created role.rbac.authorization.k8s.io/argocd-notifications-controller created role.rbac.authorization.k8s.io/argocd-server created clusterrole.rbac.authorization.k8s.io/argocd-application-controller created clusterrole.rbac.authorization.k8s.io/argocd-server created rolebinding.rbac.authorization.k8s.io/argocd-application-controller created rolebinding.rbac.authorization.k8s.io/argocd-applicationset-controller created rolebinding.rbac.authorization.k8s.io/argocd-dex-server created rolebinding.rbac.authorization.k8s.io/argocd-notifications-controller created rolebinding.rbac.authorization.k8s.io/argocd-redis created rolebinding.rbac.authorization.k8s.io/argocd-server created clusterrolebinding.rbac.authorization.k8s.io/argocd-application-controller created clusterrolebinding.rbac.authorization.k8s.io/argocd-server created configmap/argocd-cm created configmap/argocd-cmd-params-cm created configmap/argocd-gpg-keys-cm created configmap/argocd-notifications-cm created configmap/argocd-rbac-cm created configmap/argocd-ssh-known-hosts-cm created configmap/argocd-tls-certs-cm created secret/argocd-notifications-secret created secret/argocd-secret created service/argocd-applicationset-controller created service/argocd-dex-server created service/argocd-metrics created service/argocd-notifications-controller-metrics created service/argocd-redis created service/argocd-repo-server created service/argocd-server created service/argocd-server-metrics created deployment.apps/argocd-applicationset-controller created deployment.apps/argocd-dex-server created deployment.apps/argocd-notifications-controller created deployment.apps/argocd-redis created deployment.apps/argocd-repo-server created deployment.apps/argocd-server created statefulset.apps/argocd-application-controller created networkpolicy.networking.k8s.io/argocd-application-controller-network-policy created networkpolicy.networking.k8s.io/argocd-dex-server-network-policy created networkpolicy.networking.k8s.io/argocd-redis-network-policy created networkpolicy.networking.k8s.io/argocd-repo-server-network-policy created networkpolicy.networking.k8s.io/argocd-server-network-policy created Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s","title":"ArgoCD \u5b89\u88dd\u8a2d\u5b9a"},{"location":"kubernetes/argocd/tutorial/01-setup/#_1","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/01-setup.html","title":"\u8a2d\u5b9a"},{"location":"kubernetes/argocd/tutorial/01-setup/#cli","text":"\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u9700\u8981\u4ee5\u4e0b CLI \u5de5\u5177\u3002\u5728\u958b\u59cb\u5b78\u7fd2\u4efb\u4f55\u6559\u7a0b\u7ae0\u7bc0\u4e4b\u524d\uff0c\u8acb\u5148\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\u5011\u3002 Tool Linux Git Download Docker Download K3D v5.4.4 Download kubectl v1.20.2 Download argocd v2.0.0 Download kustomize v4.1.2 Download \u4ee5\u4e0b CLI \u5de5\u5177\u5c0d\u65bc\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u662f\u53ef\u9078\u7684\u3002\u5118\u7ba1\u5728\u6559\u7a0b\u4e2d\u4f7f\u7528\u4e86\u5b83\u5011\uff0c\u4f46\u60a8\u53ef\u4ee5\u6beb\u7121\u554f\u984c\u5730\u4f7f\u7528\u5176\u4ed6\u7684\u3002","title":"\u76f8\u95dc\u9700\u8981\u7684 CLI \u5de5\u5177"},{"location":"kubernetes/argocd/tutorial/01-setup/#_2","text":"\u5728\u958b\u59cb\u8a2d\u7f6e\u74b0\u5883\u4e4b\u524d\uff0c\u8b93\u6211\u5011 clone \u6559\u7a0b\u6e90\u78bc\u4e26\u5c07 TUTORIAL_HOME \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6559\u7a0b\u7684\u6839\u76ee\u9304\uff1a $ git clone https://github.com/redhat-scholars/argocd-tutorial.git gitops $ export TUTORIAL_HOME = \" $( pwd ) /gitops\" $ cd $TUTORIAL_HOME","title":"\u53d6\u5f97\u6559\u7a0b\u8cc7\u6e90"},{"location":"kubernetes/argocd/tutorial/01-setup/#kubernetes","text":"\u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc\u79d8\u5bc6\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc\u90e8\u7f72\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/argocd/tutorial/01-setup/#argocd","text":"\u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml \u7d50\u679c: customresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created customresourcedefinition.apiextensions.k8s.io/applicationsets.argoproj.io created customresourcedefinition.apiextensions.k8s.io/appprojects.argoproj.io created serviceaccount/argocd-application-controller created serviceaccount/argocd-applicationset-controller created serviceaccount/argocd-dex-server created serviceaccount/argocd-notifications-controller created serviceaccount/argocd-redis created serviceaccount/argocd-repo-server created serviceaccount/argocd-server created role.rbac.authorization.k8s.io/argocd-application-controller created role.rbac.authorization.k8s.io/argocd-applicationset-controller created role.rbac.authorization.k8s.io/argocd-dex-server created role.rbac.authorization.k8s.io/argocd-notifications-controller created role.rbac.authorization.k8s.io/argocd-server created clusterrole.rbac.authorization.k8s.io/argocd-application-controller created clusterrole.rbac.authorization.k8s.io/argocd-server created rolebinding.rbac.authorization.k8s.io/argocd-application-controller created rolebinding.rbac.authorization.k8s.io/argocd-applicationset-controller created rolebinding.rbac.authorization.k8s.io/argocd-dex-server created rolebinding.rbac.authorization.k8s.io/argocd-notifications-controller created rolebinding.rbac.authorization.k8s.io/argocd-redis created rolebinding.rbac.authorization.k8s.io/argocd-server created clusterrolebinding.rbac.authorization.k8s.io/argocd-application-controller created clusterrolebinding.rbac.authorization.k8s.io/argocd-server created configmap/argocd-cm created configmap/argocd-cmd-params-cm created configmap/argocd-gpg-keys-cm created configmap/argocd-notifications-cm created configmap/argocd-rbac-cm created configmap/argocd-ssh-known-hosts-cm created configmap/argocd-tls-certs-cm created secret/argocd-notifications-secret created secret/argocd-secret created service/argocd-applicationset-controller created service/argocd-dex-server created service/argocd-metrics created service/argocd-notifications-controller-metrics created service/argocd-redis created service/argocd-repo-server created service/argocd-server created service/argocd-server-metrics created deployment.apps/argocd-applicationset-controller created deployment.apps/argocd-dex-server created deployment.apps/argocd-notifications-controller created deployment.apps/argocd-redis created deployment.apps/argocd-repo-server created deployment.apps/argocd-server created statefulset.apps/argocd-application-controller created networkpolicy.networking.k8s.io/argocd-application-controller-network-policy created networkpolicy.networking.k8s.io/argocd-dex-server-network-policy created networkpolicy.networking.k8s.io/argocd-redis-network-policy created networkpolicy.networking.k8s.io/argocd-repo-server-network-policy created networkpolicy.networking.k8s.io/argocd-server-network-policy created Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s","title":"ArgoCD \u5b89\u88dd"},{"location":"kubernetes/argocd/tutorial/02-getting_started/","text":"ArgoCD \u5165\u9580 \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/02-getting_started.html \u78ba\u8a8d Argo CD \u5df2\u555f\u52d5\u4e26\u904b\u884c\u5f8c\uff0c\u8b93\u6211\u5011\u63a2\u7d22\u5982\u4f55\u8a2a\u554f\u548c\u7ba1\u7406 Argo CD\u3002 \u66dd\u9732 ArgoCD \u670d\u52d9 \u00b6 \u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684\u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' Tip Kubernetes \u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u4e00\u500b\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u904e Kubernetes \u5ba2\u6236\u7aef\u4e3b\u6a5f\u7aef\u53e3\u8f49\u767c\u5728 Kubernetes \u5167\u90e8\u7db2\u7d61\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u5b83\u7d81\u5b9a\u5230 127.0.0.1 \u4e26\u4e14\u5b83\u4e0d\u6703\u63a5\u53d7\u4f86\u81ea\u5916\u90e8\u4e3b\u6a5f\u7684\u8acb\u6c42\u3002 \u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u8a9e\u6cd5\u5982\u4e0b\u3002 kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] \u6211\u5728\u4e0b\u9762\u7d66\u51fa\u4e00\u500b\u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u4f8b\u5b50\u3002\u4e0b\u9762\u7684\u547d\u4ee4\u6703\u5c07\u5728\u7aef\u53e3 443 \u4e2d\u904b\u884c\u7684\u670d\u52d9\u7aef\u53e3\u8f49\u767c\u5230 kubectl \u5ba2\u6236\u7aef\u4e3b\u6a5f\u4e2d\u7684\u7aef\u53e3 8443\u3002 $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 \u7576\u6211\u5617\u8a66\u4f7f\u7528\u5ba2\u6236\u7aef\u8a08\u7b97\u6a5f\u7684 IP \u5730\u5740\u548c\u7aef\u53e3\u5f9e\u53e6\u4e00\u53f0\u8a08\u7b97\u6a5f\u6253\u958b\u6b64 URL \u6642\uff0c\u5b83\u4e0d\u8d77\u4f5c\u7528\u3002\u539f\u56e0\u662f\u56e0\u70ba8080\u7aef\u53e3\u7d81\u5b9a\u4e86 127.0.0.1 \u3002 \u70ba\u4e86\u8b93\u5b83\u5de5\u4f5c\uff0c\u6211\u5011\u5fc5\u9808\u8b93\u9019\u500b\u7aef\u53e3\u76e3\u807d 0.0.0.0\u3002 \u9019\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u6dfb\u52a0\u9644\u52a0\u53c3\u6578\u4f86\u8f15\u9b06\u5be6\u73fe\u3002\u8a9e\u6cd5\u5982\u4e0b\u3002 $ kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0' \u6709\u95dc Kubernetes Port Forwarding \u7684\u8a73\u7d30\u8aaa\u660e\u53c3\u95b1: Use Port Forwarding to Access Applications in a Cluster \u9023\u63a5\u5230 ArgoCD \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528 CLI \u6216 Web \u63a7\u5236\u53f0\u9023\u63a5\u5230 ArgoCD\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cArgoCD \u6703\u751f\u6210\u4e00\u500b\u7ba1\u7406\u54e1\u7528\u6236\uff0c\u4ee5\u53ca\u5728\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc\u3002 \u4f7f\u7528 CLI \u9023\u63a5 \u00b6 \u5b89\u88dd argocd CLI \u7684\u5de5\u5177: $ curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 $ wget https://github.com/argoproj/argo-cd/releases/download/v2.4.3/argocd-linux-amd64 $ chmod +x /usr/local/bin/argocd \u4f7f\u7528 argocd CLI \u767b\u9304 ArgoCD \u5be6\u4f8b \u00b6 \u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528 ArgoCD cli \u767b\u9304\u5230 ArgoCD\uff1a $ argocd login --insecure --grpc-web $argoURL --username admin --password $argoPass 'admin:login' logged in successfully Context '0.0.0.0:8443' updated \u8207 Web \u63a7\u5236\u53f0\u9023\u63a5 \u00b6 \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002 \u90e8\u7f72\u7bc4\u4f8b\u61c9\u7528\u7a0b\u5e8f \u00b6 \u5c0d\u65bc\u672c\u6559\u7a0b\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Redhat \u5728 Github \u516c\u958b\u7684 GitOps \u7bc4\u4f8b\u5b58\u5132\u5eab\u3002\u6211\u5011\u5c07\u4f7f\u7528\u9019\u500b repo \u4f86\u90e8\u7f72\u6211\u5011\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u4e26\u5305\u542b\u6e05\u55ae\u4f86\u90e8\u7f72\u6211\u5011\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u3002 Redhat Developer Demo: https://github.com/redhat-developer-demos/openshift-gitops-examples \u61c9\u7528\u7a0b\u5e8f Manifest \u66f4\u65b0\u8207\u4fdd\u5b58\u5728 Git Repo \u00b6 \u61c9\u7528\u7a0b\u5e8f\u8981\u8a2d\u5b9a\u5728 Kubernetes \u88e1\u7684 manifet \u6e05\u55ae\u5305\u62ec\uff1a Namespace: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ns.yaml bgd-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : bgd spec : {} status : {} Deployment: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-deployment.yaml bgd-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : labels : app : bgd name : bgd namespace : bgd spec : replicas : 1 selector : matchLabels : app : bgd strategy : {} template : metadata : labels : app : bgd spec : containers : - image : quay.io/redhatworkshops/bgd:latest name : bgd env : - name : COLOR value : \"blue\" resources : {} --- Service: NodePort \u985e\u578b\u7684\u670d\u52d9\uff1a \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-svc.yaml bgd-svc.yaml --- apiVersion : v1 kind : Service metadata : labels : app : bgd name : bgd namespace : bgd spec : type : NodePort ports : - port : 8080 protocol : TCP targetPort : 8080 selector : app : bgd --- Ingress: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ingress.yaml bgd-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : bgd spec : rules : - host : bgd.devnation http : paths : - path : / pathType : Prefix backend : service : name : bgd port : number : 8080 \u8a2d\u5b9a \u61c9\u7528\u7a0b\u5e8f Argo \u7684 Application \u7269\u4ef6 \u00b6 ArgoCD \u5b9a\u7fa9\u4e86\u4e00\u500b Kubernetes \u5ba2\u88fd\u7684API (CRD) \u7269\u4ef6 Application \u3002\u4f60\u5fc5\u9808\u9019\u6a23\u5b9a\u7fa9 Application \u5f8c ArgoCD \u624d\u77e5\u9053\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u61c9\u7528\u9019\u4e9b\u6e05\u55ae\u3002 \u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u5728 ArgoCD \u4e2d\u5b9a\u7fa9\u548c\u61c9\u7528\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002\u8b93\u6211\u5011\u6aa2\u67e5\u7528\u65bc\u90e8\u7f72\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u7684 bgd-app.yaml \u4e26\u5c07\u5176\u5206\u89e3\u4e00\u4e0b\uff1a bgd-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgd-app namespace : argocd spec : destination : namespace : bgd server : https://kubernetes.default.svc # 1 project : default # 2 source : # 3 path : apps/bgd/overlays/bgd repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : # 4 automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u76ee\u6a19\u670d\u52d9\u5668\u662f\u6211\u5011\u5b89\u88dd ArgoCD \u7684\u670d\u52d9\u5668\u3002 \u5728 ArgoCD \u7684\u9ed8\u8a8d\u9805\u76ee (.spec.project) \u4e2d\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u3002 YAML \u6240\u5728\u7684\u6e05\u55ae\u5b58\u5132\u5eab\u548c\u8981\u67e5\u627e\u7684\u8def\u5f91\u3002 syncPolicy \u8a2d\u7f6e\u70ba false\u3002\u8acb\u6ce8\u610f\uff0c\u60a8\u53ef\u4ee5\u8b93 Argo CD \u81ea\u52d5\u540c\u6b65 repo\u3002 Application CR (CustomResource) \u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u61c9\u7528\uff1a $ kubectl apply -f documentation/modules/ROOT/examples/minikube/bgd-app/bgd-app.yaml application.argoproj.io/bgd-app created \u6211\u5011\u53ef\u5728 ArgoCD UI \u4e2d\u89c0\u5bdf\u5230 bgd-app \u7684\u5275\u5efa\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u5c07\u5e36\u60a8\u9032\u5165\u6982\u89bd\u9801\u9762\u3002\u60a8\u53ef\u80fd\u6703\u770b\u5230\u5b83\u4ecd\u5728\u9032\u884c\u4e2d\u6216\u5b8c\u5168\u540c\u6b65\u3002 Tip \u60a8\u53ef\u80fd\u9700\u8981\u9ede\u64ca\u6b64\u9801\u9762\u4e0a\u7684\u986f\u793a\u96b1\u85cf\u8cc7\u6e90\u624d\u80fd\u67e5\u770b\u5168\u90e8\u5167\u5bb9 \u6b64\u6642\u61c9\u7528\u7a0b\u5e8f\u61c9\u8a72\u5df2\u555f\u52d5\u4e26\u6b63\u5728\u904b\u884c\u3002 \u60a8\u53ef\u4ee5\u770b\u5230\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\uff1a $ kubectl get all -n bgd \u8f38\u51fa\u61c9\u5982\u4e0b\u6240\u793a\uff1a NAME READY STATUS RESTARTS AGE pod/bgd-788cb756f7-kz448 1 /1 Running 0 10m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/bgd ClusterIP 172 .30.111.118 <none> 8080 /TCP 10m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/bgd 1 /1 1 1 10m \u9996\u5148\u7b49\u5f85\u90e8\u7f72\u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd deployment \"bgd\" successfully rolled out \u7136\u5f8c\u8a2a\u554f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u5c07\u8dd1 K3D \u7684\u4e3b\u6a5f IP \u548c Ingress \u88e1\u5b9a\u7fa9\u7684\u4e3b\u6a5f\u540d bgd.devnation \u6dfb\u52a0\u5230\u4f60\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 /etc/hosts 127.0.0.1 localhost 127.0.1.1 dxlab-ThinkPad-T580 0.0.0.0 bgd.devnation bgdk.devnation # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters Info \u7531\u65bc\u6211\u5011\u8981\u4f7f\u7528 Ingress \u4f86\u63a5\u5165\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u88e1\u7684 application\u3002\u5728 Kubernetes \u4e2d\u4e3b\u8981\u6709\u5169\u7a2e\u6a21\u5f0f: \u6a21\u5f0f1. \u4f7f\u7528\u8def\u5f91\u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u6a21\u5f0f2. \u4f7f\u7528 Domain Name (Hostname) \u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u672c\u7bc4\u4f8b\u4f7f\u7528\u7684\u662f \u6a21\u5f0f2 \u3002 \u6211\u5011\u7684 Kubernetes \u662f\u4f7f\u7528\u4e0b\u5217\u7684\u547d\u4ee4\u6240\u5275\u5efa\u7684: $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" \u4ee3\u8868\u8457\u6211\u5011\u628a K3D \u88e1\u7684 Ingress Control \u6620\u5c04\u5230\u672c\u6a5f\u7684 8081 \u7aef\u53e3\u3002 \u56e0\u6b64\u4f60\u53ef\u4f7f\u7528\u700f\u89bd\u5668 http://bgd.devnation:8081 \u4f86\u9023\u63a5\u5230\u525b\u525b\u4f48\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 \u8b93\u6211\u5011\u4ecb\u7d39\u4e00\u500b\u8b8a\u5316\uff01\u4fee\u88dc\u5be6\u6642\u6e05\u55ae\u4ee5\u5c07\u6846\u7684\u984f\u8272\u5f9e\u85cd\u8272\u66f4\u6539\u70ba\u7da0\u8272\uff1a $ kubectl -n bgd patch deploy/bgd --type = 'json' -p = '[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/env/0/value\", \"value\":\"green\"}]' \u7b49\u5f85 rollout \u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd \u5982\u679c\u60a8\u5237\u65b0\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6b63\u5728\u904b\u884c\u7684\u9078\u9805\u5361\uff0c\u60a8\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4e00\u500b\u7da0\u8272\u65b9\u584a\u3002 \u67e5\u770b\u60a8\u7684 Argo CD Web UI\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 Argo \u5c07\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6aa2\u6e2c\u70ba \u201c Out of Sync \u201d\u3002 \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002 \u60a8\u53ef\u4ee5\u901a\u904e Argo CD \u518d\u6b21\u540c\u6b65\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u9996\u5148\u9ede\u64ca SYNC \u7136\u5f8c\u9ede\u64ca\u3000 SYNCHRONIZE \u76f8\u53cd\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\uff1a $ argocd app sync bgd-app \u540c\u6b65\u904e\u7a0b\u5b8c\u6210\u5f8c\uff0cArgo CD UI \u61c9\u8a72\u5c07\u61c9\u7528\u7a0b\u5e8f\u6a19\u8a18\u70ba\u540c\u6b65\u3002 \u5982\u679c\u60a8\u5728\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u9078\u9805\u5361\u4e0a\u91cd\u65b0\u52a0\u8f09\u9801\u9762\u3002\u5b83\u61c9\u8a72\u56de\u5230\u85cd\u8272\u65b9\u584a\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u8a2d\u7f6e Application \u7684 manifest \u4f86\u8a2d\u7f6e Argo CD \u4ee5\u81ea\u52d5\u7cfe\u6b63\u6f02\u79fb\u3002 \u4f8b\u5b50\uff1a spec: syncPolicy: automated: prune: true selfHeal: true \u6216\u8005\uff0c\u5728\u6211\u5011\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e8b\u5f8c\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ kubectl patch application/bgd-app -n argocd --type = merge -p = '{\"spec\":{\"syncPolicy\":{\"automated\":{\"prune\":true,\"selfHeal\":true}}}}' \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002 GitOps \u6982\u5ff5\u56de\u9867 \u00b6 CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo\uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002","title":"ArgoCD \u5165\u9580"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#argocd","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/02-getting_started.html \u78ba\u8a8d Argo CD \u5df2\u555f\u52d5\u4e26\u904b\u884c\u5f8c\uff0c\u8b93\u6211\u5011\u63a2\u7d22\u5982\u4f55\u8a2a\u554f\u548c\u7ba1\u7406 Argo CD\u3002","title":"ArgoCD \u5165\u9580"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#argocd_1","text":"\u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684\u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' Tip Kubernetes \u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u4e00\u500b\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u904e Kubernetes \u5ba2\u6236\u7aef\u4e3b\u6a5f\u7aef\u53e3\u8f49\u767c\u5728 Kubernetes \u5167\u90e8\u7db2\u7d61\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u5b83\u7d81\u5b9a\u5230 127.0.0.1 \u4e26\u4e14\u5b83\u4e0d\u6703\u63a5\u53d7\u4f86\u81ea\u5916\u90e8\u4e3b\u6a5f\u7684\u8acb\u6c42\u3002 \u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u8a9e\u6cd5\u5982\u4e0b\u3002 kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] \u6211\u5728\u4e0b\u9762\u7d66\u51fa\u4e00\u500b\u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u4f8b\u5b50\u3002\u4e0b\u9762\u7684\u547d\u4ee4\u6703\u5c07\u5728\u7aef\u53e3 443 \u4e2d\u904b\u884c\u7684\u670d\u52d9\u7aef\u53e3\u8f49\u767c\u5230 kubectl \u5ba2\u6236\u7aef\u4e3b\u6a5f\u4e2d\u7684\u7aef\u53e3 8443\u3002 $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 \u7576\u6211\u5617\u8a66\u4f7f\u7528\u5ba2\u6236\u7aef\u8a08\u7b97\u6a5f\u7684 IP \u5730\u5740\u548c\u7aef\u53e3\u5f9e\u53e6\u4e00\u53f0\u8a08\u7b97\u6a5f\u6253\u958b\u6b64 URL \u6642\uff0c\u5b83\u4e0d\u8d77\u4f5c\u7528\u3002\u539f\u56e0\u662f\u56e0\u70ba8080\u7aef\u53e3\u7d81\u5b9a\u4e86 127.0.0.1 \u3002 \u70ba\u4e86\u8b93\u5b83\u5de5\u4f5c\uff0c\u6211\u5011\u5fc5\u9808\u8b93\u9019\u500b\u7aef\u53e3\u76e3\u807d 0.0.0.0\u3002 \u9019\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u6dfb\u52a0\u9644\u52a0\u53c3\u6578\u4f86\u8f15\u9b06\u5be6\u73fe\u3002\u8a9e\u6cd5\u5982\u4e0b\u3002 $ kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0' \u6709\u95dc Kubernetes Port Forwarding \u7684\u8a73\u7d30\u8aaa\u660e\u53c3\u95b1: Use Port Forwarding to Access Applications in a Cluster","title":"\u66dd\u9732 ArgoCD \u670d\u52d9"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#argocd_2","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528 CLI \u6216 Web \u63a7\u5236\u53f0\u9023\u63a5\u5230 ArgoCD\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cArgoCD \u6703\u751f\u6210\u4e00\u500b\u7ba1\u7406\u54e1\u7528\u6236\uff0c\u4ee5\u53ca\u5728\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc\u3002","title":"\u9023\u63a5\u5230 ArgoCD"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#cli","text":"\u5b89\u88dd argocd CLI \u7684\u5de5\u5177: $ curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 $ wget https://github.com/argoproj/argo-cd/releases/download/v2.4.3/argocd-linux-amd64 $ chmod +x /usr/local/bin/argocd","title":"\u4f7f\u7528 CLI \u9023\u63a5"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#argocd-cli-argocd","text":"\u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528 ArgoCD cli \u767b\u9304\u5230 ArgoCD\uff1a $ argocd login --insecure --grpc-web $argoURL --username admin --password $argoPass 'admin:login' logged in successfully Context '0.0.0.0:8443' updated","title":"\u4f7f\u7528 argocd CLI \u767b\u9304 ArgoCD \u5be6\u4f8b"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#web","text":"\u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002","title":"\u8207 Web \u63a7\u5236\u53f0\u9023\u63a5"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#_1","text":"\u5c0d\u65bc\u672c\u6559\u7a0b\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Redhat \u5728 Github \u516c\u958b\u7684 GitOps \u7bc4\u4f8b\u5b58\u5132\u5eab\u3002\u6211\u5011\u5c07\u4f7f\u7528\u9019\u500b repo \u4f86\u90e8\u7f72\u6211\u5011\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u4e26\u5305\u542b\u6e05\u55ae\u4f86\u90e8\u7f72\u6211\u5011\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u3002 Redhat Developer Demo: https://github.com/redhat-developer-demos/openshift-gitops-examples","title":"\u90e8\u7f72\u7bc4\u4f8b\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#manifest-git-repo","text":"\u61c9\u7528\u7a0b\u5e8f\u8981\u8a2d\u5b9a\u5728 Kubernetes \u88e1\u7684 manifet \u6e05\u55ae\u5305\u62ec\uff1a Namespace: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ns.yaml bgd-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : bgd spec : {} status : {} Deployment: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-deployment.yaml bgd-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : labels : app : bgd name : bgd namespace : bgd spec : replicas : 1 selector : matchLabels : app : bgd strategy : {} template : metadata : labels : app : bgd spec : containers : - image : quay.io/redhatworkshops/bgd:latest name : bgd env : - name : COLOR value : \"blue\" resources : {} --- Service: NodePort \u985e\u578b\u7684\u670d\u52d9\uff1a \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-svc.yaml bgd-svc.yaml --- apiVersion : v1 kind : Service metadata : labels : app : bgd name : bgd namespace : bgd spec : type : NodePort ports : - port : 8080 protocol : TCP targetPort : 8080 selector : app : bgd --- Ingress: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ingress.yaml bgd-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : bgd spec : rules : - host : bgd.devnation http : paths : - path : / pathType : Prefix backend : service : name : bgd port : number : 8080","title":"\u61c9\u7528\u7a0b\u5e8f Manifest \u66f4\u65b0\u8207\u4fdd\u5b58\u5728 Git Repo"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#argo-application","text":"ArgoCD \u5b9a\u7fa9\u4e86\u4e00\u500b Kubernetes \u5ba2\u88fd\u7684API (CRD) \u7269\u4ef6 Application \u3002\u4f60\u5fc5\u9808\u9019\u6a23\u5b9a\u7fa9 Application \u5f8c ArgoCD \u624d\u77e5\u9053\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u61c9\u7528\u9019\u4e9b\u6e05\u55ae\u3002 \u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u5728 ArgoCD \u4e2d\u5b9a\u7fa9\u548c\u61c9\u7528\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002\u8b93\u6211\u5011\u6aa2\u67e5\u7528\u65bc\u90e8\u7f72\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u7684 bgd-app.yaml \u4e26\u5c07\u5176\u5206\u89e3\u4e00\u4e0b\uff1a bgd-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgd-app namespace : argocd spec : destination : namespace : bgd server : https://kubernetes.default.svc # 1 project : default # 2 source : # 3 path : apps/bgd/overlays/bgd repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : # 4 automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u76ee\u6a19\u670d\u52d9\u5668\u662f\u6211\u5011\u5b89\u88dd ArgoCD \u7684\u670d\u52d9\u5668\u3002 \u5728 ArgoCD \u7684\u9ed8\u8a8d\u9805\u76ee (.spec.project) \u4e2d\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u3002 YAML \u6240\u5728\u7684\u6e05\u55ae\u5b58\u5132\u5eab\u548c\u8981\u67e5\u627e\u7684\u8def\u5f91\u3002 syncPolicy \u8a2d\u7f6e\u70ba false\u3002\u8acb\u6ce8\u610f\uff0c\u60a8\u53ef\u4ee5\u8b93 Argo CD \u81ea\u52d5\u540c\u6b65 repo\u3002 Application CR (CustomResource) \u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u61c9\u7528\uff1a $ kubectl apply -f documentation/modules/ROOT/examples/minikube/bgd-app/bgd-app.yaml application.argoproj.io/bgd-app created \u6211\u5011\u53ef\u5728 ArgoCD UI \u4e2d\u89c0\u5bdf\u5230 bgd-app \u7684\u5275\u5efa\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u5c07\u5e36\u60a8\u9032\u5165\u6982\u89bd\u9801\u9762\u3002\u60a8\u53ef\u80fd\u6703\u770b\u5230\u5b83\u4ecd\u5728\u9032\u884c\u4e2d\u6216\u5b8c\u5168\u540c\u6b65\u3002 Tip \u60a8\u53ef\u80fd\u9700\u8981\u9ede\u64ca\u6b64\u9801\u9762\u4e0a\u7684\u986f\u793a\u96b1\u85cf\u8cc7\u6e90\u624d\u80fd\u67e5\u770b\u5168\u90e8\u5167\u5bb9 \u6b64\u6642\u61c9\u7528\u7a0b\u5e8f\u61c9\u8a72\u5df2\u555f\u52d5\u4e26\u6b63\u5728\u904b\u884c\u3002 \u60a8\u53ef\u4ee5\u770b\u5230\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\uff1a $ kubectl get all -n bgd \u8f38\u51fa\u61c9\u5982\u4e0b\u6240\u793a\uff1a NAME READY STATUS RESTARTS AGE pod/bgd-788cb756f7-kz448 1 /1 Running 0 10m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/bgd ClusterIP 172 .30.111.118 <none> 8080 /TCP 10m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/bgd 1 /1 1 1 10m \u9996\u5148\u7b49\u5f85\u90e8\u7f72\u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd deployment \"bgd\" successfully rolled out \u7136\u5f8c\u8a2a\u554f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u5c07\u8dd1 K3D \u7684\u4e3b\u6a5f IP \u548c Ingress \u88e1\u5b9a\u7fa9\u7684\u4e3b\u6a5f\u540d bgd.devnation \u6dfb\u52a0\u5230\u4f60\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 /etc/hosts 127.0.0.1 localhost 127.0.1.1 dxlab-ThinkPad-T580 0.0.0.0 bgd.devnation bgdk.devnation # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters Info \u7531\u65bc\u6211\u5011\u8981\u4f7f\u7528 Ingress \u4f86\u63a5\u5165\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u88e1\u7684 application\u3002\u5728 Kubernetes \u4e2d\u4e3b\u8981\u6709\u5169\u7a2e\u6a21\u5f0f: \u6a21\u5f0f1. \u4f7f\u7528\u8def\u5f91\u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u6a21\u5f0f2. \u4f7f\u7528 Domain Name (Hostname) \u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u672c\u7bc4\u4f8b\u4f7f\u7528\u7684\u662f \u6a21\u5f0f2 \u3002 \u6211\u5011\u7684 Kubernetes \u662f\u4f7f\u7528\u4e0b\u5217\u7684\u547d\u4ee4\u6240\u5275\u5efa\u7684: $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" \u4ee3\u8868\u8457\u6211\u5011\u628a K3D \u88e1\u7684 Ingress Control \u6620\u5c04\u5230\u672c\u6a5f\u7684 8081 \u7aef\u53e3\u3002 \u56e0\u6b64\u4f60\u53ef\u4f7f\u7528\u700f\u89bd\u5668 http://bgd.devnation:8081 \u4f86\u9023\u63a5\u5230\u525b\u525b\u4f48\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 \u8b93\u6211\u5011\u4ecb\u7d39\u4e00\u500b\u8b8a\u5316\uff01\u4fee\u88dc\u5be6\u6642\u6e05\u55ae\u4ee5\u5c07\u6846\u7684\u984f\u8272\u5f9e\u85cd\u8272\u66f4\u6539\u70ba\u7da0\u8272\uff1a $ kubectl -n bgd patch deploy/bgd --type = 'json' -p = '[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/env/0/value\", \"value\":\"green\"}]' \u7b49\u5f85 rollout \u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd \u5982\u679c\u60a8\u5237\u65b0\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6b63\u5728\u904b\u884c\u7684\u9078\u9805\u5361\uff0c\u60a8\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4e00\u500b\u7da0\u8272\u65b9\u584a\u3002 \u67e5\u770b\u60a8\u7684 Argo CD Web UI\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 Argo \u5c07\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6aa2\u6e2c\u70ba \u201c Out of Sync \u201d\u3002 \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002 \u60a8\u53ef\u4ee5\u901a\u904e Argo CD \u518d\u6b21\u540c\u6b65\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u9996\u5148\u9ede\u64ca SYNC \u7136\u5f8c\u9ede\u64ca\u3000 SYNCHRONIZE \u76f8\u53cd\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\uff1a $ argocd app sync bgd-app \u540c\u6b65\u904e\u7a0b\u5b8c\u6210\u5f8c\uff0cArgo CD UI \u61c9\u8a72\u5c07\u61c9\u7528\u7a0b\u5e8f\u6a19\u8a18\u70ba\u540c\u6b65\u3002 \u5982\u679c\u60a8\u5728\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u9078\u9805\u5361\u4e0a\u91cd\u65b0\u52a0\u8f09\u9801\u9762\u3002\u5b83\u61c9\u8a72\u56de\u5230\u85cd\u8272\u65b9\u584a\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u8a2d\u7f6e Application \u7684 manifest \u4f86\u8a2d\u7f6e Argo CD \u4ee5\u81ea\u52d5\u7cfe\u6b63\u6f02\u79fb\u3002 \u4f8b\u5b50\uff1a spec: syncPolicy: automated: prune: true selfHeal: true \u6216\u8005\uff0c\u5728\u6211\u5011\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e8b\u5f8c\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ kubectl patch application/bgd-app -n argocd --type = merge -p = '{\"spec\":{\"syncPolicy\":{\"automated\":{\"prune\":true,\"selfHeal\":true}}}}' \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002","title":"\u8a2d\u5b9a \u61c9\u7528\u7a0b\u5e8f Argo \u7684 Application \u7269\u4ef6"},{"location":"kubernetes/argocd/tutorial/02-getting_started/#gitops","text":"CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo\uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002","title":"GitOps \u6982\u5ff5\u56de\u9867"},{"location":"kubernetes/argocd/tutorial/03-kustomize/","text":"Kustomize \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/03-kustomize.html Kustomize \u904d\u6b77 Kubernetes \u6e05\u55ae\u4f86\u6dfb\u52a0\u3001\u522a\u9664\u6216\u66f4\u65b0\u914d\u7f6e\u9078\u9805\uff0c\u800c\u7121\u9700 fork \u3002\u5b83\u65e2\u53ef\u4ee5\u4f5c\u70ba\u7368\u7acb\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba kubectl \u7684\u539f\u751f\u64f4\u5c55\u4f7f\u7528\u3002 kustomize \u7684\u539f\u5247\u662f\uff1a \u914d\u7f6e\u5b9a\u5236\u7684\u7d14\u8072\u660e\u5f0f\u65b9\u6cd5 \u7ba1\u7406\u4efb\u610f\u6578\u91cf\u7684\u660e\u78ba\u5b9a\u5236\u7684 Kubernetes \u914d\u7f6e kustomize \u4f7f\u7528\u7684\u6bcf\u500b\u5de5\u4ef6\u90fd\u662f\u7d14 YAML\uff0c\u53ef\u4ee5\u9019\u6a23\u9032\u884c\u9a57\u8b49\u548c\u8655\u7406 \u4f5c\u70ba\u201c\u7121\u6a21\u677f\u201d\u7684\u6a21\u677f\u7cfb\u7d71\uff1b\u5b83\u9f13\u52f5\u4f7f\u7528 YAML \u800c\u4e0d folk \u5b83\u3002 \u63a2\u7d22 Kustomize \u00b6 \u63a2\u7d22 Kustomize CLI \u00b6 kustomize CLI \u61c9\u8a72\u5df2\u4f5c\u70balab\u8a2d\u7f6e\u7684\u4e00\u90e8\u5206\u5b89\u88dd\u3002\u9a57\u8b49\u5b83\u662f\u5426\u5df2\u5b89\u88dd\u3002 $ kustomize version --short \u9019\u61c9\u8a72\u986f\u793a\u7248\u672c\uff0c\u5b83\u61c9\u8a72\u770b\u8d77\u4f86\u50cf\u9019\u6a23\u3002 {Version:kustomize/v4.5.5 GitCommit:daa3e5e2c2d3a4b8c94021a7384bfb06734bcd26 BuildDate:2022-05-20T20:25:40Z GoOs:linux GoArch:amd64} Kustomize \u7684\u6838\u5fc3\u662f\u57fa\u65bc YAML \u69cb\u5efa\u672c\u6a5f Kubernetes \u6e05\u55ae\uff0c\u540c\u6642\u4fdd\u7559\u539f\u59cb YAML\u3002\u5b83\u4ee5\u201c\u7121\u6a21\u677f\u201d\u6a21\u677f\u683c\u5f0f\u5be6\u73fe\u4e86\u9019\u4e00\u9ede\u3002\u9019\u662f\u901a\u904e\u63d0\u4f9b\u4e00\u500b kustomization.yaml \u6587\u4ef6\u4f86\u5b8c\u6210\u7684\u3002 \u6211\u5011\u5c07\u5c08\u6ce8\u65bc\u5169\u500b\u5b50\u547d\u4ee4\uff0c build \u547d\u4ee4\u548c edit \u547d\u4ee4\u3002 build \u547d\u4ee4\u7372\u53d6 YAML \u6e90\uff08\u901a\u904e\u8def\u5f91\u6216 URL\uff09\u4e26\u5275\u5efa\u4e00\u500b\u65b0\u7684 YAML\uff0c\u8a72 YAML \u53ef\u4ee5\u901a\u904e\u7ba1\u9053\u50b3\u8f38\u5230 kubectl create \u3002\u6211\u5011\u5c07\u4f7f\u7528 documentation/modules/ROOT/examples/kustomize-build \u76ee\u9304\u4e2d\u7684\u793a\u4f8b\u3002 $ cd documentation/modules/ROOT/examples/kustomize-build \u5728\u9019\u88e1\u4f60\u61c9\u8a72\u770b\u5230\u5169\u500b\u6587\u4ef6\uff0c\u4e00\u500b kustomization.yaml \u6587\u4ef6\u548c\u4e00\u500b welcome.yaml \u6587\u4ef6\uff0c\u6211\u5011\u4f86\u770b\u770b\u5b83\u5011\u3002 welcome.yaml apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:latest name : welcome-php resources : {} \u9019\u500b\u6587\u4ef6\u6c92\u6709\u4ec0\u9ebc\u7279\u5225\u4e4b\u8655\u3002\u53ea\u662f\u4e00\u500b\u6a19\u6e96\u7684 Kubernetes \u6e05\u55ae\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u5011\u60f3\u5728\u6b64\u6e05\u55ae\u4e2d\u6dfb\u52a0\u6a19\u7c64\u800c\u4e0d\u5c0d\u5176\u9032\u884c\u7de8\u8f2f\u600e\u9ebc\u8fa6\uff1f\u9019\u5c31\u662f kustomization.yaml \u6587\u4ef6\u7684\u7528\u6b66\u4e4b\u5730\u3002 kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u6b63\u5982\u60a8\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u7684\u90a3\u6a23\uff0c\u6c92\u6709\u592a\u591a\u3002\u6b64\u793a\u4f8b\u7684\u5169\u500b\u90e8\u5206\u662f resources \u548c patchesJson6902 \u90e8\u5206\u3002 resources \u662f\u5b58\u5132\u5176\u4ed6\u6e05\u55ae\u7684\u55ae\u500b\u6587\u4ef6\u3001\u76ee\u9304\u548c/\u6216 URL \u7684\u6578\u7d44\u3002\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u53ea\u662f\u52a0\u8f09\u4e00\u500b\u6587\u4ef6\u3002 patchesJson6902 \u662f kustomize \u652f\u6301\u7684\u4fee\u88dc RFC\u3002\u5982\u60a8\u6240\u898b\uff0c\u5728 patchJson6902 \u6587\u4ef6\u4e2d\uff0c\u6211\u6b63\u5728\u5411\u6b64\u6e05\u55ae\u6dfb\u52a0\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u4ee5\u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e2d\u95b1\u8b80\u6709\u95dc\u53ef\u7528\u65bc \u4fee\u88dc \u7684\u9078\u9805 \u901a\u904e build \u69cb\u5efa\u6b64\u6e05\u55ae\uff1a $ kustomize build \u60a8\u53ef\u4ee5\u770b\u5230\u65b0\u6a19\u7c64\u5df2\u6dfb\u52a0\u5230\u6e05\u55ae\u4e2d\uff01 apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php testkey : testvalue name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:ffcd15 name : welcome-php resources : {} \u60a8\u53ef\u4ee5\u4f7f\u7528 kustomize \u7de8\u8f2f\u547d\u4ee4\u800c\u4e0d\u662f\u7de8\u5beb YAML\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5c07\u6b64 Deployment \u4f7f\u7528\u7684\u6620\u50cf\u6a19\u7c64\u5f9e latest \u66f4\u6539\u70ba ffcd15 \uff1a $ kustomize edit set image quay.io/redhatworkshops/welcome-php:ffcd15 \u9019\u5c07\u4f7f\u7528\u5716\u50cf\u90e8\u5206\u66f4\u65b0 kustomization.yaml \u6587\u4ef6\u3002 $ cat kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u73fe\u5728\u7576\u4f60\u904b\u884c\u6642\uff1a $ kustomize build . \u60a8\u4e0d\u50c5\u61c9\u8a72\u770b\u5230\u65b0\u6a19\u7c64\uff0c\u9084\u61c9\u8a72\u770b\u5230\u65b0\u7684 ffcd15 \u93e1\u50cf\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u80fd\u5fc5\u9808\u95dc\u9589 kustomization.yaml \u9078\u9805\u5361\u4e26\u91cd\u65b0\u6253\u958b\u5b83\u624d\u80fd\u67e5\u770b\u66f4\u6539\u3002 \u60a8\u53ef\u4ee5\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u73fe\u6709\u7684 YAML \u4e26\u91dd\u5c0d\u60a8\u7684\u7279\u5b9a\u74b0\u5883\u5c0d\u5176\u9032\u884c\u4fee\u6539\uff0c\u800c\u7121\u9700\u8907\u88fd\u6216\u7de8\u8f2f\u539f\u59cb\u6587\u4ef6\u3002 Kustomize \u53ef\u7528\u65bc\u7de8\u5beb\u65b0\u7684 YAML \u6587\u4ef6\u6216\u88ab\u5c0e\u5165 kubectl \u547d\u4ee4\u3002\u4f8b\u5b50\uff1a $ kustomize build . | kubectl apply -f - \u4f7f\u7528 Kubectl \u63a2\u7d22 Kustomize \u00b6 \u5f9e Kubernetes 1.14 \u958b\u59cb\uff0c kubectl \u547d\u4ee4\u5167\u7f6e\u4e86\u5c0d Kustomize \u7684\u652f\u6301\u3002 \u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize --help \u9019\u5c07\u904b\u884c kustomize \u69cb\u5efa\u547d\u4ee4\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize \u5118\u7ba1\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u5c07\u5176\u901a\u904e\u7ba1\u9053\u50b3\u905e\u5230\u61c9\u7528\u547d\u4ee4\u4e2d\uff0c\u4f46\u60a8\u4e0d\u5fc5\u9019\u6a23\u505a\u3002 kubectl apply \u547d\u4ee4\u5177\u6709 -k \u9078\u9805\uff0c\u8a72\u9078\u9805\u5c07\u5728\u61c9\u7528\u6e05\u55ae\u4e4b\u524d\u904b\u884c\u69cb\u5efa\u3002 \u8981\u5c0d\u6b64\u9032\u884c\u6e2c\u8a66\uff0c\u9996\u5148\u5275\u5efa\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff1a $ kubectl create namespace kustomize-test \u63a5\u4e0b\u4f86\u78ba\u4fdd\u60a8\u5728\u547d\u540d\u7a7a\u9593\u4e2d\uff1a $ kubectl config set-context --current --namespace = kustomize-test \u6700\u5f8c\u904b\u884c\u547d\u4ee4\u4f86\u69cb\u5efa\u548c\u61c9\u7528\u6e05\u55ae\uff1a $ kubectl apply -k ./ Info \u6ce8\u610f \u60a8\u4e0d\u50c5\u53ef\u4ee5\u50b3\u905e\u76ee\u9304\uff0c\u9084\u53ef\u4ee5\u50b3\u905e URL\u3002\u552f\u4e00\u7684\u8981\u6c42\u662f\u8def\u5f91\u4e2d\u6709\u4e00\u500b kustomization.yaml \u6587\u4ef6\u3002 \u9019\u61c9\u8a72\u6703\u5275\u5efa\u90e8\u7f72\uff0c\u4e26\u4e14\u60a8\u61c9\u8a72\u6703\u770b\u5230\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u904b\u884c\u7684 pod\uff1a $ kubectl get pods -n kustomize-test \u60a8\u53ef\u4ee5\u770b\u5230\u90e8\u7f72\u662f\u4f7f\u7528\u9644\u52a0\u6a19\u7c64\u5275\u5efa\u7684\uff1a $ kubectl get deployment welcome-php -o jsonpath = '{.metadata.labels}' | jq -r \u6b64\u5916\uff0c\u93e1\u50cf\u5df2\u6839\u64da\u6240\u505a\u7684\u81ea\u5b9a\u7fa9\u9032\u884c\u4e86\u66f4\u65b0\uff1a $ kubectl get deploy welcome-php -o jsonpath = '{.spec.template.spec.containers[].image}{\"\\n\"}' \u5982\u60a8\u6240\u898b\uff0ckustomize \u662f\u4e00\u500b\u5f37\u5927\u7684\u5de5\u5177\u3002 \u60a8\u73fe\u5728\u53ef\u4ee5\u5b89\u5168\u5730\u522a\u9664\u6b64\u547d\u540d\u7a7a\u9593\uff1a $ kubectl delete namespace kustomize-test \u90e8\u7f72 Kustomized \u61c9\u7528\u7a0b\u5e8f \u00b6 \u5728\u4e0a\u4e00\u7ae0\u4e2d\uff0c\u60a8\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4e86\u89e3\u4e86\u9019\u4e00\u9ede\uff1b\u6574\u500b\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\uff08\u5305\u62ec\u57fa\u790e\u8a2d\u65bd\uff09\u90fd\u53cd\u6620\u5728 git repo \u4e2d\u3002\u6311\u6230\u5728\u65bc\u5982\u4f55\u5728\u4e0d\u5fa9\u5236 YAML \u7684\u60c5\u6cc1\u4e0b\u505a\u5230\u9019\u4e00\u9ede\u3002 \u73fe\u5728\u60a8\u5df2\u7d93\u63a2\u7d22\u4e86 kustomize\uff0c\u8b93\u6211\u5011\u770b\u770b\u5b83\u5982\u4f55\u878d\u5165 Argo CD \u4ee5\u53ca\u5982\u4f55\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4f7f\u7528\u5b83\u3002 \u5728\u7e7c\u7e8c\u4e4b\u524d\uff0c\u56de\u5230\u4e3b\u76ee\u9304\uff1a cd ~ Argo CD Web \u63a7\u5236\u53f0 \u00b6 \u8a2a\u554f Argo CD Web \u63a7\u5236\u53f0\u3002 \u4e00\u65e6\u60a8\u63a5\u53d7\u4e86\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 Argo CD \u767b\u9304\u5c4f\u5e55\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u767b\u9304 Username: admin Password: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d VoNuPLkxJdwMOLCI Kustomized \u61c9\u7528\u7a0b\u5e8f \u00b6 Argo CD \u539f\u751f\u652f\u6301 Kustomize\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u907f\u514d\u70ba\u6bcf\u500b\u90e8\u7f72\u91cd\u8907 YAML\u3002\u5982\u679c\u60a8\u6709\u4e0d\u540c\u7684\u74b0\u5883\u6216\u8981\u90e8\u7f72\u7684\u96c6\u7fa4\uff0c\u9019\u7279\u5225\u597d\u7528\u3002 \u770b\u4e00\u4e0b Application \u5b9a\u7fa9\uff1a bgdk-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgdk-app namespace : argocd spec : destination : namespace : bgdk server : https://kubernetes.default.svc project : default source : path : apps/bgd/overlays/bgdk repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u6b64\u61c9\u7528\u7a0b\u5e8f\u6307\u5411\u76f8\u540c\u7684 \u5b58\u5132\u5eab \u4f46\u4e0d\u540c\u7684 \u76ee\u9304 \u3002 \u770b\u4e00\u4e0b kustomization.yaml \u6587\u4ef6\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization namespace : bgdk resources : - ../../base - bgdk-ns.yaml patchesJson6902 : - target : version : v1 group : apps kind : Deployment name : bgd namespace : bgdk patch : |- - op: replace path: /spec/template/spec/containers/0/env/0/value value: yellow - target : version : v1 group : networking.k8s.io kind : Ingress name : bgd namespace : bgdk patch : |- - op: replace path: /spec/rules/0/host value: bgdk.devnation \u9019\u500b kustomization.yaml \u7372\u53d6\u57fa\u790e\u61c9\u7528\u7a0b\u5e8f\u4e26\u4fee\u88dc\u6e05\u55ae\uff0c\u4ee5\u4fbf\u6211\u5011\u5f97\u5230\u9ec3\u8272\u65b9\u584a\u800c\u4e0d\u662f\u85cd\u8272\u65b9\u584a\u3002\u5b83\u9084\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230 bgdk \u547d\u540d\u7a7a\u9593\uff08\u7531\u6587\u4ef6\u7684\u547d\u540d\u7a7a\u9593\uff1a\u90e8\u5206\u9336\u793a\uff09\u4e26\u5c07\u9019\u500b\u65b0\u547d\u540d\u7a7a\u9593\u7684 Ingress \u4e3b\u6a5f\u540d\u66f4\u65b0\u70ba bgdk.devnation \u3002 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d bgdk.devnation \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 \u4f8b\u5b50\uff1a /etc/hosts 192.168.39.242 bgd.devnation bgdk.devnation \u9019\u61c9\u8a72\u6703\u5728 Argo CD UI \u4e0a\u5411\u60a8\u986f\u793a\u5169\u500b\u61c9\u7528\u7a0b\u5e8f\u3002 \u6253\u958b\u61c9\u7528\u7a0b\u5e8f\u7684 Ingress \u6216 Route\u3002 \u5982\u60a8\u6240\u898b\uff0c\u4f7f\u7528\u60a8\u7684\u81ea\u5b9a\u7fa9\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\uff01\u56de\u9867\u6211\u5011\u525b\u525b\u6240\u505a\u7684\u3002 \u90e8\u7f72\u4e86\u4e00\u500b\u540d\u70ba bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5e36\u6709\u4e00\u500b\u85cd\u8272\u65b9\u584a\u3002 \u90e8\u7f72\u4e86\u53e6\u4e00\u500b\u57fa\u65bc bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u7a31\u70ba bgdk \u61c9\u7528\u7a0b\u5e8f bgdk \u90e8\u7f72\u5728\u5b83\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\uff0c\u4e26\u5177\u6709\u90e8\u7f72\u81ea\u5b9a\u7fa9\u3002 \u5168\u90e8\u7121\u9700\u8907\u5236 YAML\uff01","title":"Kustomize"},{"location":"kubernetes/argocd/tutorial/03-kustomize/#kustomize","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/03-kustomize.html Kustomize \u904d\u6b77 Kubernetes \u6e05\u55ae\u4f86\u6dfb\u52a0\u3001\u522a\u9664\u6216\u66f4\u65b0\u914d\u7f6e\u9078\u9805\uff0c\u800c\u7121\u9700 fork \u3002\u5b83\u65e2\u53ef\u4ee5\u4f5c\u70ba\u7368\u7acb\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba kubectl \u7684\u539f\u751f\u64f4\u5c55\u4f7f\u7528\u3002 kustomize \u7684\u539f\u5247\u662f\uff1a \u914d\u7f6e\u5b9a\u5236\u7684\u7d14\u8072\u660e\u5f0f\u65b9\u6cd5 \u7ba1\u7406\u4efb\u610f\u6578\u91cf\u7684\u660e\u78ba\u5b9a\u5236\u7684 Kubernetes \u914d\u7f6e kustomize \u4f7f\u7528\u7684\u6bcf\u500b\u5de5\u4ef6\u90fd\u662f\u7d14 YAML\uff0c\u53ef\u4ee5\u9019\u6a23\u9032\u884c\u9a57\u8b49\u548c\u8655\u7406 \u4f5c\u70ba\u201c\u7121\u6a21\u677f\u201d\u7684\u6a21\u677f\u7cfb\u7d71\uff1b\u5b83\u9f13\u52f5\u4f7f\u7528 YAML \u800c\u4e0d folk \u5b83\u3002","title":"Kustomize"},{"location":"kubernetes/argocd/tutorial/03-kustomize/#kustomize_1","text":"","title":"\u63a2\u7d22 Kustomize"},{"location":"kubernetes/argocd/tutorial/03-kustomize/#kustomize-cli","text":"kustomize CLI \u61c9\u8a72\u5df2\u4f5c\u70balab\u8a2d\u7f6e\u7684\u4e00\u90e8\u5206\u5b89\u88dd\u3002\u9a57\u8b49\u5b83\u662f\u5426\u5df2\u5b89\u88dd\u3002 $ kustomize version --short \u9019\u61c9\u8a72\u986f\u793a\u7248\u672c\uff0c\u5b83\u61c9\u8a72\u770b\u8d77\u4f86\u50cf\u9019\u6a23\u3002 {Version:kustomize/v4.5.5 GitCommit:daa3e5e2c2d3a4b8c94021a7384bfb06734bcd26 BuildDate:2022-05-20T20:25:40Z GoOs:linux GoArch:amd64} Kustomize \u7684\u6838\u5fc3\u662f\u57fa\u65bc YAML \u69cb\u5efa\u672c\u6a5f Kubernetes \u6e05\u55ae\uff0c\u540c\u6642\u4fdd\u7559\u539f\u59cb YAML\u3002\u5b83\u4ee5\u201c\u7121\u6a21\u677f\u201d\u6a21\u677f\u683c\u5f0f\u5be6\u73fe\u4e86\u9019\u4e00\u9ede\u3002\u9019\u662f\u901a\u904e\u63d0\u4f9b\u4e00\u500b kustomization.yaml \u6587\u4ef6\u4f86\u5b8c\u6210\u7684\u3002 \u6211\u5011\u5c07\u5c08\u6ce8\u65bc\u5169\u500b\u5b50\u547d\u4ee4\uff0c build \u547d\u4ee4\u548c edit \u547d\u4ee4\u3002 build \u547d\u4ee4\u7372\u53d6 YAML \u6e90\uff08\u901a\u904e\u8def\u5f91\u6216 URL\uff09\u4e26\u5275\u5efa\u4e00\u500b\u65b0\u7684 YAML\uff0c\u8a72 YAML \u53ef\u4ee5\u901a\u904e\u7ba1\u9053\u50b3\u8f38\u5230 kubectl create \u3002\u6211\u5011\u5c07\u4f7f\u7528 documentation/modules/ROOT/examples/kustomize-build \u76ee\u9304\u4e2d\u7684\u793a\u4f8b\u3002 $ cd documentation/modules/ROOT/examples/kustomize-build \u5728\u9019\u88e1\u4f60\u61c9\u8a72\u770b\u5230\u5169\u500b\u6587\u4ef6\uff0c\u4e00\u500b kustomization.yaml \u6587\u4ef6\u548c\u4e00\u500b welcome.yaml \u6587\u4ef6\uff0c\u6211\u5011\u4f86\u770b\u770b\u5b83\u5011\u3002 welcome.yaml apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:latest name : welcome-php resources : {} \u9019\u500b\u6587\u4ef6\u6c92\u6709\u4ec0\u9ebc\u7279\u5225\u4e4b\u8655\u3002\u53ea\u662f\u4e00\u500b\u6a19\u6e96\u7684 Kubernetes \u6e05\u55ae\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u5011\u60f3\u5728\u6b64\u6e05\u55ae\u4e2d\u6dfb\u52a0\u6a19\u7c64\u800c\u4e0d\u5c0d\u5176\u9032\u884c\u7de8\u8f2f\u600e\u9ebc\u8fa6\uff1f\u9019\u5c31\u662f kustomization.yaml \u6587\u4ef6\u7684\u7528\u6b66\u4e4b\u5730\u3002 kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u6b63\u5982\u60a8\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u7684\u90a3\u6a23\uff0c\u6c92\u6709\u592a\u591a\u3002\u6b64\u793a\u4f8b\u7684\u5169\u500b\u90e8\u5206\u662f resources \u548c patchesJson6902 \u90e8\u5206\u3002 resources \u662f\u5b58\u5132\u5176\u4ed6\u6e05\u55ae\u7684\u55ae\u500b\u6587\u4ef6\u3001\u76ee\u9304\u548c/\u6216 URL \u7684\u6578\u7d44\u3002\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u53ea\u662f\u52a0\u8f09\u4e00\u500b\u6587\u4ef6\u3002 patchesJson6902 \u662f kustomize \u652f\u6301\u7684\u4fee\u88dc RFC\u3002\u5982\u60a8\u6240\u898b\uff0c\u5728 patchJson6902 \u6587\u4ef6\u4e2d\uff0c\u6211\u6b63\u5728\u5411\u6b64\u6e05\u55ae\u6dfb\u52a0\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u4ee5\u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e2d\u95b1\u8b80\u6709\u95dc\u53ef\u7528\u65bc \u4fee\u88dc \u7684\u9078\u9805 \u901a\u904e build \u69cb\u5efa\u6b64\u6e05\u55ae\uff1a $ kustomize build \u60a8\u53ef\u4ee5\u770b\u5230\u65b0\u6a19\u7c64\u5df2\u6dfb\u52a0\u5230\u6e05\u55ae\u4e2d\uff01 apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php testkey : testvalue name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:ffcd15 name : welcome-php resources : {} \u60a8\u53ef\u4ee5\u4f7f\u7528 kustomize \u7de8\u8f2f\u547d\u4ee4\u800c\u4e0d\u662f\u7de8\u5beb YAML\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5c07\u6b64 Deployment \u4f7f\u7528\u7684\u6620\u50cf\u6a19\u7c64\u5f9e latest \u66f4\u6539\u70ba ffcd15 \uff1a $ kustomize edit set image quay.io/redhatworkshops/welcome-php:ffcd15 \u9019\u5c07\u4f7f\u7528\u5716\u50cf\u90e8\u5206\u66f4\u65b0 kustomization.yaml \u6587\u4ef6\u3002 $ cat kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u73fe\u5728\u7576\u4f60\u904b\u884c\u6642\uff1a $ kustomize build . \u60a8\u4e0d\u50c5\u61c9\u8a72\u770b\u5230\u65b0\u6a19\u7c64\uff0c\u9084\u61c9\u8a72\u770b\u5230\u65b0\u7684 ffcd15 \u93e1\u50cf\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u80fd\u5fc5\u9808\u95dc\u9589 kustomization.yaml \u9078\u9805\u5361\u4e26\u91cd\u65b0\u6253\u958b\u5b83\u624d\u80fd\u67e5\u770b\u66f4\u6539\u3002 \u60a8\u53ef\u4ee5\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u73fe\u6709\u7684 YAML \u4e26\u91dd\u5c0d\u60a8\u7684\u7279\u5b9a\u74b0\u5883\u5c0d\u5176\u9032\u884c\u4fee\u6539\uff0c\u800c\u7121\u9700\u8907\u88fd\u6216\u7de8\u8f2f\u539f\u59cb\u6587\u4ef6\u3002 Kustomize \u53ef\u7528\u65bc\u7de8\u5beb\u65b0\u7684 YAML \u6587\u4ef6\u6216\u88ab\u5c0e\u5165 kubectl \u547d\u4ee4\u3002\u4f8b\u5b50\uff1a $ kustomize build . | kubectl apply -f -","title":"\u63a2\u7d22 Kustomize CLI"},{"location":"kubernetes/argocd/tutorial/03-kustomize/#kubectl-kustomize","text":"\u5f9e Kubernetes 1.14 \u958b\u59cb\uff0c kubectl \u547d\u4ee4\u5167\u7f6e\u4e86\u5c0d Kustomize \u7684\u652f\u6301\u3002 \u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize --help \u9019\u5c07\u904b\u884c kustomize \u69cb\u5efa\u547d\u4ee4\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize \u5118\u7ba1\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u5c07\u5176\u901a\u904e\u7ba1\u9053\u50b3\u905e\u5230\u61c9\u7528\u547d\u4ee4\u4e2d\uff0c\u4f46\u60a8\u4e0d\u5fc5\u9019\u6a23\u505a\u3002 kubectl apply \u547d\u4ee4\u5177\u6709 -k \u9078\u9805\uff0c\u8a72\u9078\u9805\u5c07\u5728\u61c9\u7528\u6e05\u55ae\u4e4b\u524d\u904b\u884c\u69cb\u5efa\u3002 \u8981\u5c0d\u6b64\u9032\u884c\u6e2c\u8a66\uff0c\u9996\u5148\u5275\u5efa\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff1a $ kubectl create namespace kustomize-test \u63a5\u4e0b\u4f86\u78ba\u4fdd\u60a8\u5728\u547d\u540d\u7a7a\u9593\u4e2d\uff1a $ kubectl config set-context --current --namespace = kustomize-test \u6700\u5f8c\u904b\u884c\u547d\u4ee4\u4f86\u69cb\u5efa\u548c\u61c9\u7528\u6e05\u55ae\uff1a $ kubectl apply -k ./ Info \u6ce8\u610f \u60a8\u4e0d\u50c5\u53ef\u4ee5\u50b3\u905e\u76ee\u9304\uff0c\u9084\u53ef\u4ee5\u50b3\u905e URL\u3002\u552f\u4e00\u7684\u8981\u6c42\u662f\u8def\u5f91\u4e2d\u6709\u4e00\u500b kustomization.yaml \u6587\u4ef6\u3002 \u9019\u61c9\u8a72\u6703\u5275\u5efa\u90e8\u7f72\uff0c\u4e26\u4e14\u60a8\u61c9\u8a72\u6703\u770b\u5230\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u904b\u884c\u7684 pod\uff1a $ kubectl get pods -n kustomize-test \u60a8\u53ef\u4ee5\u770b\u5230\u90e8\u7f72\u662f\u4f7f\u7528\u9644\u52a0\u6a19\u7c64\u5275\u5efa\u7684\uff1a $ kubectl get deployment welcome-php -o jsonpath = '{.metadata.labels}' | jq -r \u6b64\u5916\uff0c\u93e1\u50cf\u5df2\u6839\u64da\u6240\u505a\u7684\u81ea\u5b9a\u7fa9\u9032\u884c\u4e86\u66f4\u65b0\uff1a $ kubectl get deploy welcome-php -o jsonpath = '{.spec.template.spec.containers[].image}{\"\\n\"}' \u5982\u60a8\u6240\u898b\uff0ckustomize \u662f\u4e00\u500b\u5f37\u5927\u7684\u5de5\u5177\u3002 \u60a8\u73fe\u5728\u53ef\u4ee5\u5b89\u5168\u5730\u522a\u9664\u6b64\u547d\u540d\u7a7a\u9593\uff1a $ kubectl delete namespace kustomize-test","title":"\u4f7f\u7528 Kubectl \u63a2\u7d22 Kustomize"},{"location":"kubernetes/argocd/tutorial/03-kustomize/#kustomized","text":"\u5728\u4e0a\u4e00\u7ae0\u4e2d\uff0c\u60a8\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4e86\u89e3\u4e86\u9019\u4e00\u9ede\uff1b\u6574\u500b\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\uff08\u5305\u62ec\u57fa\u790e\u8a2d\u65bd\uff09\u90fd\u53cd\u6620\u5728 git repo \u4e2d\u3002\u6311\u6230\u5728\u65bc\u5982\u4f55\u5728\u4e0d\u5fa9\u5236 YAML \u7684\u60c5\u6cc1\u4e0b\u505a\u5230\u9019\u4e00\u9ede\u3002 \u73fe\u5728\u60a8\u5df2\u7d93\u63a2\u7d22\u4e86 kustomize\uff0c\u8b93\u6211\u5011\u770b\u770b\u5b83\u5982\u4f55\u878d\u5165 Argo CD \u4ee5\u53ca\u5982\u4f55\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4f7f\u7528\u5b83\u3002 \u5728\u7e7c\u7e8c\u4e4b\u524d\uff0c\u56de\u5230\u4e3b\u76ee\u9304\uff1a cd ~","title":"\u90e8\u7f72 Kustomized \u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/argocd/tutorial/03-kustomize/#argo-cd-web","text":"\u8a2a\u554f Argo CD Web \u63a7\u5236\u53f0\u3002 \u4e00\u65e6\u60a8\u63a5\u53d7\u4e86\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 Argo CD \u767b\u9304\u5c4f\u5e55\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u767b\u9304 Username: admin Password: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d VoNuPLkxJdwMOLCI","title":"Argo CD Web \u63a7\u5236\u53f0"},{"location":"kubernetes/argocd/tutorial/03-kustomize/#kustomized_1","text":"Argo CD \u539f\u751f\u652f\u6301 Kustomize\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u907f\u514d\u70ba\u6bcf\u500b\u90e8\u7f72\u91cd\u8907 YAML\u3002\u5982\u679c\u60a8\u6709\u4e0d\u540c\u7684\u74b0\u5883\u6216\u8981\u90e8\u7f72\u7684\u96c6\u7fa4\uff0c\u9019\u7279\u5225\u597d\u7528\u3002 \u770b\u4e00\u4e0b Application \u5b9a\u7fa9\uff1a bgdk-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgdk-app namespace : argocd spec : destination : namespace : bgdk server : https://kubernetes.default.svc project : default source : path : apps/bgd/overlays/bgdk repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u6b64\u61c9\u7528\u7a0b\u5e8f\u6307\u5411\u76f8\u540c\u7684 \u5b58\u5132\u5eab \u4f46\u4e0d\u540c\u7684 \u76ee\u9304 \u3002 \u770b\u4e00\u4e0b kustomization.yaml \u6587\u4ef6\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization namespace : bgdk resources : - ../../base - bgdk-ns.yaml patchesJson6902 : - target : version : v1 group : apps kind : Deployment name : bgd namespace : bgdk patch : |- - op: replace path: /spec/template/spec/containers/0/env/0/value value: yellow - target : version : v1 group : networking.k8s.io kind : Ingress name : bgd namespace : bgdk patch : |- - op: replace path: /spec/rules/0/host value: bgdk.devnation \u9019\u500b kustomization.yaml \u7372\u53d6\u57fa\u790e\u61c9\u7528\u7a0b\u5e8f\u4e26\u4fee\u88dc\u6e05\u55ae\uff0c\u4ee5\u4fbf\u6211\u5011\u5f97\u5230\u9ec3\u8272\u65b9\u584a\u800c\u4e0d\u662f\u85cd\u8272\u65b9\u584a\u3002\u5b83\u9084\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230 bgdk \u547d\u540d\u7a7a\u9593\uff08\u7531\u6587\u4ef6\u7684\u547d\u540d\u7a7a\u9593\uff1a\u90e8\u5206\u9336\u793a\uff09\u4e26\u5c07\u9019\u500b\u65b0\u547d\u540d\u7a7a\u9593\u7684 Ingress \u4e3b\u6a5f\u540d\u66f4\u65b0\u70ba bgdk.devnation \u3002 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d bgdk.devnation \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 \u4f8b\u5b50\uff1a /etc/hosts 192.168.39.242 bgd.devnation bgdk.devnation \u9019\u61c9\u8a72\u6703\u5728 Argo CD UI \u4e0a\u5411\u60a8\u986f\u793a\u5169\u500b\u61c9\u7528\u7a0b\u5e8f\u3002 \u6253\u958b\u61c9\u7528\u7a0b\u5e8f\u7684 Ingress \u6216 Route\u3002 \u5982\u60a8\u6240\u898b\uff0c\u4f7f\u7528\u60a8\u7684\u81ea\u5b9a\u7fa9\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\uff01\u56de\u9867\u6211\u5011\u525b\u525b\u6240\u505a\u7684\u3002 \u90e8\u7f72\u4e86\u4e00\u500b\u540d\u70ba bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5e36\u6709\u4e00\u500b\u85cd\u8272\u65b9\u584a\u3002 \u90e8\u7f72\u4e86\u53e6\u4e00\u500b\u57fa\u65bc bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u7a31\u70ba bgdk \u61c9\u7528\u7a0b\u5e8f bgdk \u90e8\u7f72\u5728\u5b83\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\uff0c\u4e26\u5177\u6709\u90e8\u7f72\u81ea\u5b9a\u7fa9\u3002 \u5168\u90e8\u7121\u9700\u8907\u5236 YAML\uff01","title":"Kustomized \u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/argocd/tutorial/04-syncwaves-hooks/","text":"SyncWaves \u8207 Hooks \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/04-syncwaves-hooks.html Argo CD \u4e2d\u4f7f\u7528 Syncwave \u4f86\u78ba\u5b9a\u6e05\u55ae\u5982\u4f55\u61c9\u7528\u65bc\u96c6\u7fa4\u3002 \u53e6\u4e00\u65b9\u9762\uff0c resource hooks \u5728\u4e0d\u540c\u968e\u6bb5\u5206\u89e3\u4e86\u9019\u4e9b\u6e05\u55ae\u7684\u4ea4\u4ed8\u3002 \u4f7f\u7528 syncwaves \u548c resource hooks \u7684\u7d44\u5408\uff0c\u60a8\u53ef\u4ee5\u63a7\u5236\u61c9\u7528\u7a0b\u5e8f\u7684 roll out \u65b9\u5f0f\u3002 \u672c\u793a\u4f8b\u5c07\u5f15\u5c0e\u60a8\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u4f7f\u7528 Syncwaves \u63a7\u5236\u90e8\u7f72\u9806\u5e8f \u63a2\u7d22 Resource Hooks \u7d44\u5408\u4f7f\u7528 Syncwaves \u548c Resource Hooks \u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u5e36\u6709\u6578\u64da\u5eab\u7684 TODO \u61c9\u7528\u7a0b\u5e8f\uff0c\u9664\u4e86\u90e8\u7f72\u6587\u4ef6\u4e4b\u5916\uff0c\u9084\u4f7f\u7528\u4e86 Syncwaves \u548c Resource Hooks : \u4f7f\u7528 Syncwaves \u00b6 Syncwave \u662f\u4e00\u7a2e\u547d\u4ee4 Argo CD \u5982\u4f55\u61c9\u7528\u5b58\u5132\u5728 git \u4e2d\u7684\u6e05\u55ae\u7684\u65b9\u6cd5\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6240\u6709\u6e05\u55ae\u90fd\u5177\u6709\u96f6\u6ce2\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/sync-wave \u8a3b\u91cb\u4f86\u8a2d\u7f6e\u9019\u4e9b\u3002 \u4f8b\u5b50\uff1a metadata : annotations : argocd.argoproj.io/sync-wave : \"2\" wave \u7684\u6578\u503c\u4e5f\u53ef\u4ee5\u662f \u8ca0 \u7684\u3002 metadata : annotations : argocd.argoproj.io/sync-wave : \"-5\" \u7576 Argo CD \u958b\u59cb\u540c\u6b65\u64cd\u4f5c\u6642\uff0c\u6e05\u55ae\u6309\u4ee5\u4e0b\u9806\u5e8f\u653e\u7f6e\uff1a \u4ed6\u5011\u6240\u8655\u7684\u968e\u6bb5\uff08\u6211\u5011\u5c07\u5728\u4e0b\u4e00\u7bc0\u4e2d\u4ecb\u7d39\u968e\u6bb5\uff09 \u8cc7\u6e90\u88ab\u8a3b\u91cb\u7684\u6ce2\u6b21\uff08\u5f9e\u6700\u4f4e\u503c\u5230\u6700\u9ad8\u503c\uff09 \u6309\u7a2e\u985e\uff08\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\uff0c\u7136\u5f8c\u662f\u670d\u52d9\uff0c\u7136\u5f8c\u662f\u90e8\u7f72\u7b49......\uff09 \u6309\u540d\u7a31\uff08\u5347\u5e8f\uff09 \u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e0a\u95b1\u8b80\u6709\u95dc Syncwaves \u7684\u66f4\u591a\u4fe1\u606f\u3002 \u63a2\u7d22 Manifests \u00b6 \u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u4ee5\u4e0b\u6e05\u55ae\uff1a Namespace \u7684 syncwave \u70ba -1 \uff1a todo-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : todo annotations : argocd.argoproj.io/sync-wave : \"-1\" PostgreSQL \u7684 syncwave \u8a2d\u70ba 0 : postgresql-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : name : postgresql namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : matchLabels : app : postgresql template : metadata : labels : app : postgresql spec : containers : - name : postgresql image : postgres:12 imagePullPolicy : Always ports : - name : tcp containerPort : 5432 env : - name : POSTGRES_PASSWORD value : admin - name : POSTGRES_USER value : admin - name : POSTGRES_DB value : todo PostgreSQL Service \u7684 syncwave \u8a2d\u70ba 0 : postgresql-service.yaml --- apiVersion : v1 kind : Service metadata : name : postgres namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : app : postgresql ports : - name : pgsql port : 5432 targetPort : 5432 Database table creation \u7684 syncwave \u8a2d\u70ba 1 : postgres-create-table.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-table namespace : todo annotations : argocd.argoproj.io/sync-wave : \"1\" spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : postgresql-client image : postgres:12 imagePullPolicy : Always env : - name : PGPASSWORD value : admin command : [ \"psql\" ] args : [ \"--host=postgresql\" , \"--username=admin\" , \"--no-password\" , \"--dbname=todo\" , \"--command=create table Todo (id bigint not null,completed boolean not null,ordering integer,title varchar(255),url varchar(255),primary key (id));create sequence hibernate_sequence start with 1 increment by 1;\" , ] restartPolicy : Never backoffLimit : 1 TODO application deployment \u7684 syncwave \u8a2d\u70ba 2 : todo-deployment.yaml --- apiVersion : \"v1\" kind : \"ServiceAccount\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo\u540c\u6b65\u6ce2 argocd.argoproj.io/sync-wave : \"2\" --- apiVersion : \"apps/v1\" kind : \"Deployment\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo annotations : argocd.argoproj.io/sync-wave : \"2\" spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" template : metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" spec : containers : - env : - name : \"KUBERNETES_NAMESPACE\" valueFrom : fieldRef : fieldPath : \"metadata.namespace\" image : \"quay.io/rhdevelopers/todo-gitops:1.0.0\" imagePullPolicy : \"Always\" name : \"todo-gitops\" ports : - containerPort : 8080 name : \"http\" protocol : \"TCP\" serviceAccount : \"todo-gitops\" TODO \u7db2\u8def\u914d\u7f6e\uff1a TODO Service \u7684 syncwave \u8a2d\u70ba 2 : todo-service.yaml --- apiVersion : \"v1\" kind : \"Service\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" annotations : argocd.argoproj.io/sync-wave : \"2\" namespace : todo spec : ports : - name : \"http\" port : 8080 targetPort : 8080 selector : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" type : \"NodePort\" TODO Ingress \u7684 syncwave \u8a2d\u70ba 3 : todo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : todo namespace : todo annotations : argocd.argoproj.io/sync-wave : \"3\" spec : rules : - host : todo.devnation http : paths : - path : / pathType : Prefix backend:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 service : name : todo-gitops port:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d `todo.devnation` \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 `/etc/hosts`\u3002 ``` title=\"/etc/hosts\" 192.168.39.242 bgd.devnation bgdk.devnation todo.devnation Argo CD \u5c07\u9996\u5148\u61c9\u7528\u547d\u540d\u7a7a\u9593\uff08\u56e0\u70ba\u5b83\u662f\u6700\u5c0f\u503c\uff09\uff0c\u4e26\u78ba\u4fdd\u5b83\u5728\u7e7c\u7e8c\u4e4b\u524d\u8fd4\u56de\u201c\u5065\u5eb7\u201d\u72c0\u614b\u3002 \u63a5\u4e0b\u4f86\uff0c\u5c07\u61c9\u7528 PostgreSQL \u90e8\u7f72\u3002\u4e4b\u5f8c\uff0c\u5831\u544a\u5065\u5eb7\u5c07\u7e7c\u7e8c\u4f7f\u7528\u5176\u9918\u8cc7\u6e90\u3002 Info Argo CD \u5728\u4e4b\u524d\u7684\u5831\u544a\u201c\u5065\u5eb7\u201d\u4e4b\u524d\u4e0d\u6703\u61c9\u7528\u4e0b\u4e00\u500b\u6e05\u55ae\u3002 \u63a2\u7d22 Resource Hooks \u00b6 \u73fe\u5728\u60a8\u5df2\u7d93\u719f\u6089\u4e86 syncwave \uff0c\u6211\u5011\u53ef\u4ee5\u958b\u59cb\u63a2\u7d22\u4f7f\u7528 resource hooks \u5206\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u3002 \u4f7f\u7528 hook \u53ef\u4ee5\u9032\u4e00\u6b65\u91cd\u65b0\u5b9a\u7fa9\u63a7\u5236\u540c\u6b65\u64cd\u4f5c\u3002 PreSync - \u5728\u540c\u6b65\u64cd\u4f5c\u4e4b\u524d\u904b\u884c\u3002\u9019\u53ef\u80fd\u985e\u4f3c\u65bc\u67b6\u69cb\u66f4\u6539\u4e4b\u524d\u7684\u6578\u64da\u5eab\u5099\u4efd\u3002 Sync - \u5728 PreSync \u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u5c07\u8207\u60a8\u7684\u6b63\u5e38\u6e05\u55ae\u4e00\u8d77\u904b\u884c\u3002 PostSync - \u5728\u540c\u6b65\u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u53ef\u4ee5\u662f\u8af8\u5982 Slack \u6d88\u606f\u6216\u96fb\u5b50\u90f5\u4ef6\u901a\u77e5\u4e4b\u985e\u7684\u6771\u897f\u3002 SyncFail - \u5982\u679c\u540c\u6b65\u64cd\u4f5c\u5931\u6557\u5247\u904b\u884c\u3002\u9019\u4e5f\u7528\u65bc\u767c\u9001\u901a\u77e5\u6216\u57f7\u884c\u5176\u4ed6\u898f\u907f\u64cd\u4f5c\u3002 \u8981\u555f\u7528\u540c\u6b65\uff0c\u8acb\u4f7f\u7528 argocd.argoproj.io/hook \u4f7f\u7528\u60a8\u8981\u7528\u65bc\u8a72\u8cc7\u6e90\u7684\u540c\u6b65\u985e\u578b\u4f86\u8a3b\u91cb\u7279\u5b9a\u5c0d\u8c61\u6e05\u55ae\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u60f3\u4f7f\u7528 PreSync \u9264\u5b50\uff1a metadata : annotations : argocd.argoproj.io/hook : PreSync \u60a8\u9084\u53ef\u4ee5\u5728\u6210\u529f/\u4e0d\u6210\u529f\u904b\u884c\u5f8c\u522a\u9664\u639b\u9264\u3002 HookSucceeded - \u8cc7\u6e90\u5728\u6210\u529f\u5f8c\u5c07\u88ab\u522a\u9664\u3002 HookFailed - \u5982\u679c\u8cc7\u6e90\u5931\u6557\uff0c\u8cc7\u6e90\u5c07\u88ab\u522a\u9664\u3002 BeforeHookCreation - \u5728\u5275\u5efa\u65b0\u8cc7\u6e90\u4e4b\u524d\u5c07\u522a\u9664\u8cc7\u6e90\uff08\u89f8\u767c\u65b0\u540c\u6b65\u6642\uff09\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/hook-delete-policy \u8a3b\u91cb\u4f86\u61c9\u7528\u9019\u4e9b\u3002\u4f8b\u5982 metadata : annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded Tips \u7531\u65bc\u540c\u6b65\u53ef\u80fd\u5728\u4efb\u4f55\u968e\u6bb5\u5931\u6557\uff0c\u60a8\u53ef\u80fd\u6703\u9047\u5230\u61c9\u7528\u7a0b\u5e8f\u6c38\u9060\u4e0d\u6703\u5831\u544a\u5065\u5eb7\u7684\u60c5\u6cc1\uff01 \u96d6\u7136\u9264\u5b50\u53ef\u4ee5\u662f\u4efb\u4f55\u8cc7\u6e90\uff0c\u4f46\u5b83\u5011\u901a\u5e38\u662f Pod \u548c/\u6216 Job\u3002 \u8981\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u8cc7\u6e90\u639b\u9264\u7684\u4fe1\u606f\uff0c\u8acb\u67e5\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002 \u63a2\u7d22\u6e05\u55ae \u00b6 \u770b\u770b\u9019\u500b PostSync \u6e05\u55ae\uff0c\u5b83\u767c\u9001\u4e00\u500b HTTP \u8acb\u6c42\u4f86\u63d2\u5165\u4e00\u500b\u65b0\u7684 TODO \u9805\uff1a todo-insert-data.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-insert annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : httpie image : alpine/httpie:2.4.0 imagePullPolicy : Always command : [ \"http\" ] args : [ \"POST\" , \"todo-gitops:8080/api\" , \"title=Finish ArgoCD tutorial\" , \"--ignore-stdin\" ] restartPolicy : Never backoffLimit : 1 Info \u9019\u610f\u5473\u8457\u8a72\u4f5c\u696d\u5c07\u5728\u540c\u6b65\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u4e4b\u5f8c\u5728 PostSync \u968e\u6bb5\u904b\u884c\u3002 \u57f7\u884c\u9806\u5e8f\u5982\u4e0b\u5716\u6240\u793a\uff1a \u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f \u00b6 \u60a8\u53ef\u4ee5\u901a\u904e\u8a2a\u554f repo \u67e5\u770b\u6240\u6709\u90e8\u7f72\u6587\u4ef6\u3002 \u770b\u770b\u9019\u500b\u6e05\u55ae\u6587\u4ef6\uff1a todo-application.yaml \uff1a todo-application.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : todo-app namespace : argocd spec : destination : namespace : todo server : https://kubernetes.default.svc project : default source : path : apps/todo repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u5b83\u5c07\u986f\u793a\u9019\u5c07\u5728 todo \u547d\u540d\u7a7a\u9593\u4e2d\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u6b64\u61c9\u7528\u7a0b\u5e8f\uff1a kubectl apply -f documentation/modules/ROOT/examples/minikube/todo-yaml/todo-application.yaml application.argoproj.io/todo-app created \u5728 Argo CD WebUI \u4e0a\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u53e6\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u51fa\u73fe\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u61c9\u5c07\u60a8\u5e36\u5230\u6a39\u8996\u5716\u3002 \u89c0\u5bdf\u540c\u6b65\u904e\u7a0b\u3002\u60a8\u5c07\u770b\u5230\u61c9\u7528\u8cc7\u6e90\u7684\u9806\u5e8f\uff0c\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\u5275\u5efa\uff0c\u6700\u5f8c\u662f\u5275\u5efa Route \u4ee5\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\u3002 \u4e00\u65e6\u61c9\u7528\u7a0b\u5e8f\u5b8c\u5168\u540c\u6b65\u3002\u67e5\u770b\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u548c\u4f5c\u696d\uff1a $ kubectl get pods -n todo \u60a8\u61c9\u8a72\u770b\u5230 Job \u5df2\u5b8c\u6210\uff0c\u4f46\u4ecd\u7136\u5b58\u5728\u3002 NAME READY STATUS RESTARTS AGE postgresql-599467fd86-cgj9v 1 /1 Running 0 32s todo-gitops-679d88f6f4-v4djp 1 /1 Running 0 19s todo-table-xhddk 0 /1 Completed 0 27s \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 todo-insert \u4f5c\u696d\u672a\u986f\u793a\uff0c\u56e0\u70ba\u5b83\u88ab\u914d\u7f6e\u70ba\u5982\u679c\u6210\u529f\u5247\u88ab\u522a\u9664\uff1a argocd.argoproj.io/hook-delete-policy : HookSucceeded","title":"SyncWaves \u8207 Hooks"},{"location":"kubernetes/argocd/tutorial/04-syncwaves-hooks/#syncwaves-hooks","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/04-syncwaves-hooks.html Argo CD \u4e2d\u4f7f\u7528 Syncwave \u4f86\u78ba\u5b9a\u6e05\u55ae\u5982\u4f55\u61c9\u7528\u65bc\u96c6\u7fa4\u3002 \u53e6\u4e00\u65b9\u9762\uff0c resource hooks \u5728\u4e0d\u540c\u968e\u6bb5\u5206\u89e3\u4e86\u9019\u4e9b\u6e05\u55ae\u7684\u4ea4\u4ed8\u3002 \u4f7f\u7528 syncwaves \u548c resource hooks \u7684\u7d44\u5408\uff0c\u60a8\u53ef\u4ee5\u63a7\u5236\u61c9\u7528\u7a0b\u5e8f\u7684 roll out \u65b9\u5f0f\u3002 \u672c\u793a\u4f8b\u5c07\u5f15\u5c0e\u60a8\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u4f7f\u7528 Syncwaves \u63a7\u5236\u90e8\u7f72\u9806\u5e8f \u63a2\u7d22 Resource Hooks \u7d44\u5408\u4f7f\u7528 Syncwaves \u548c Resource Hooks \u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u5e36\u6709\u6578\u64da\u5eab\u7684 TODO \u61c9\u7528\u7a0b\u5e8f\uff0c\u9664\u4e86\u90e8\u7f72\u6587\u4ef6\u4e4b\u5916\uff0c\u9084\u4f7f\u7528\u4e86 Syncwaves \u548c Resource Hooks :","title":"SyncWaves \u8207 Hooks"},{"location":"kubernetes/argocd/tutorial/04-syncwaves-hooks/#syncwaves","text":"Syncwave \u662f\u4e00\u7a2e\u547d\u4ee4 Argo CD \u5982\u4f55\u61c9\u7528\u5b58\u5132\u5728 git \u4e2d\u7684\u6e05\u55ae\u7684\u65b9\u6cd5\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6240\u6709\u6e05\u55ae\u90fd\u5177\u6709\u96f6\u6ce2\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/sync-wave \u8a3b\u91cb\u4f86\u8a2d\u7f6e\u9019\u4e9b\u3002 \u4f8b\u5b50\uff1a metadata : annotations : argocd.argoproj.io/sync-wave : \"2\" wave \u7684\u6578\u503c\u4e5f\u53ef\u4ee5\u662f \u8ca0 \u7684\u3002 metadata : annotations : argocd.argoproj.io/sync-wave : \"-5\" \u7576 Argo CD \u958b\u59cb\u540c\u6b65\u64cd\u4f5c\u6642\uff0c\u6e05\u55ae\u6309\u4ee5\u4e0b\u9806\u5e8f\u653e\u7f6e\uff1a \u4ed6\u5011\u6240\u8655\u7684\u968e\u6bb5\uff08\u6211\u5011\u5c07\u5728\u4e0b\u4e00\u7bc0\u4e2d\u4ecb\u7d39\u968e\u6bb5\uff09 \u8cc7\u6e90\u88ab\u8a3b\u91cb\u7684\u6ce2\u6b21\uff08\u5f9e\u6700\u4f4e\u503c\u5230\u6700\u9ad8\u503c\uff09 \u6309\u7a2e\u985e\uff08\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\uff0c\u7136\u5f8c\u662f\u670d\u52d9\uff0c\u7136\u5f8c\u662f\u90e8\u7f72\u7b49......\uff09 \u6309\u540d\u7a31\uff08\u5347\u5e8f\uff09 \u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e0a\u95b1\u8b80\u6709\u95dc Syncwaves \u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"\u4f7f\u7528 Syncwaves"},{"location":"kubernetes/argocd/tutorial/04-syncwaves-hooks/#manifests","text":"\u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u4ee5\u4e0b\u6e05\u55ae\uff1a Namespace \u7684 syncwave \u70ba -1 \uff1a todo-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : todo annotations : argocd.argoproj.io/sync-wave : \"-1\" PostgreSQL \u7684 syncwave \u8a2d\u70ba 0 : postgresql-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : name : postgresql namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : matchLabels : app : postgresql template : metadata : labels : app : postgresql spec : containers : - name : postgresql image : postgres:12 imagePullPolicy : Always ports : - name : tcp containerPort : 5432 env : - name : POSTGRES_PASSWORD value : admin - name : POSTGRES_USER value : admin - name : POSTGRES_DB value : todo PostgreSQL Service \u7684 syncwave \u8a2d\u70ba 0 : postgresql-service.yaml --- apiVersion : v1 kind : Service metadata : name : postgres namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : app : postgresql ports : - name : pgsql port : 5432 targetPort : 5432 Database table creation \u7684 syncwave \u8a2d\u70ba 1 : postgres-create-table.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-table namespace : todo annotations : argocd.argoproj.io/sync-wave : \"1\" spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : postgresql-client image : postgres:12 imagePullPolicy : Always env : - name : PGPASSWORD value : admin command : [ \"psql\" ] args : [ \"--host=postgresql\" , \"--username=admin\" , \"--no-password\" , \"--dbname=todo\" , \"--command=create table Todo (id bigint not null,completed boolean not null,ordering integer,title varchar(255),url varchar(255),primary key (id));create sequence hibernate_sequence start with 1 increment by 1;\" , ] restartPolicy : Never backoffLimit : 1 TODO application deployment \u7684 syncwave \u8a2d\u70ba 2 : todo-deployment.yaml --- apiVersion : \"v1\" kind : \"ServiceAccount\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo\u540c\u6b65\u6ce2 argocd.argoproj.io/sync-wave : \"2\" --- apiVersion : \"apps/v1\" kind : \"Deployment\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo annotations : argocd.argoproj.io/sync-wave : \"2\" spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" template : metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" spec : containers : - env : - name : \"KUBERNETES_NAMESPACE\" valueFrom : fieldRef : fieldPath : \"metadata.namespace\" image : \"quay.io/rhdevelopers/todo-gitops:1.0.0\" imagePullPolicy : \"Always\" name : \"todo-gitops\" ports : - containerPort : 8080 name : \"http\" protocol : \"TCP\" serviceAccount : \"todo-gitops\" TODO \u7db2\u8def\u914d\u7f6e\uff1a TODO Service \u7684 syncwave \u8a2d\u70ba 2 : todo-service.yaml --- apiVersion : \"v1\" kind : \"Service\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" annotations : argocd.argoproj.io/sync-wave : \"2\" namespace : todo spec : ports : - name : \"http\" port : 8080 targetPort : 8080 selector : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" type : \"NodePort\" TODO Ingress \u7684 syncwave \u8a2d\u70ba 3 : todo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : todo namespace : todo annotations : argocd.argoproj.io/sync-wave : \"3\" spec : rules : - host : todo.devnation http : paths : - path : / pathType : Prefix backend:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 service : name : todo-gitops port:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d `todo.devnation` \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 `/etc/hosts`\u3002 ``` title=\"/etc/hosts\" 192.168.39.242 bgd.devnation bgdk.devnation todo.devnation Argo CD \u5c07\u9996\u5148\u61c9\u7528\u547d\u540d\u7a7a\u9593\uff08\u56e0\u70ba\u5b83\u662f\u6700\u5c0f\u503c\uff09\uff0c\u4e26\u78ba\u4fdd\u5b83\u5728\u7e7c\u7e8c\u4e4b\u524d\u8fd4\u56de\u201c\u5065\u5eb7\u201d\u72c0\u614b\u3002 \u63a5\u4e0b\u4f86\uff0c\u5c07\u61c9\u7528 PostgreSQL \u90e8\u7f72\u3002\u4e4b\u5f8c\uff0c\u5831\u544a\u5065\u5eb7\u5c07\u7e7c\u7e8c\u4f7f\u7528\u5176\u9918\u8cc7\u6e90\u3002 Info Argo CD \u5728\u4e4b\u524d\u7684\u5831\u544a\u201c\u5065\u5eb7\u201d\u4e4b\u524d\u4e0d\u6703\u61c9\u7528\u4e0b\u4e00\u500b\u6e05\u55ae\u3002","title":"\u63a2\u7d22 Manifests"},{"location":"kubernetes/argocd/tutorial/04-syncwaves-hooks/#resource-hooks","text":"\u73fe\u5728\u60a8\u5df2\u7d93\u719f\u6089\u4e86 syncwave \uff0c\u6211\u5011\u53ef\u4ee5\u958b\u59cb\u63a2\u7d22\u4f7f\u7528 resource hooks \u5206\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u3002 \u4f7f\u7528 hook \u53ef\u4ee5\u9032\u4e00\u6b65\u91cd\u65b0\u5b9a\u7fa9\u63a7\u5236\u540c\u6b65\u64cd\u4f5c\u3002 PreSync - \u5728\u540c\u6b65\u64cd\u4f5c\u4e4b\u524d\u904b\u884c\u3002\u9019\u53ef\u80fd\u985e\u4f3c\u65bc\u67b6\u69cb\u66f4\u6539\u4e4b\u524d\u7684\u6578\u64da\u5eab\u5099\u4efd\u3002 Sync - \u5728 PreSync \u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u5c07\u8207\u60a8\u7684\u6b63\u5e38\u6e05\u55ae\u4e00\u8d77\u904b\u884c\u3002 PostSync - \u5728\u540c\u6b65\u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u53ef\u4ee5\u662f\u8af8\u5982 Slack \u6d88\u606f\u6216\u96fb\u5b50\u90f5\u4ef6\u901a\u77e5\u4e4b\u985e\u7684\u6771\u897f\u3002 SyncFail - \u5982\u679c\u540c\u6b65\u64cd\u4f5c\u5931\u6557\u5247\u904b\u884c\u3002\u9019\u4e5f\u7528\u65bc\u767c\u9001\u901a\u77e5\u6216\u57f7\u884c\u5176\u4ed6\u898f\u907f\u64cd\u4f5c\u3002 \u8981\u555f\u7528\u540c\u6b65\uff0c\u8acb\u4f7f\u7528 argocd.argoproj.io/hook \u4f7f\u7528\u60a8\u8981\u7528\u65bc\u8a72\u8cc7\u6e90\u7684\u540c\u6b65\u985e\u578b\u4f86\u8a3b\u91cb\u7279\u5b9a\u5c0d\u8c61\u6e05\u55ae\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u60f3\u4f7f\u7528 PreSync \u9264\u5b50\uff1a metadata : annotations : argocd.argoproj.io/hook : PreSync \u60a8\u9084\u53ef\u4ee5\u5728\u6210\u529f/\u4e0d\u6210\u529f\u904b\u884c\u5f8c\u522a\u9664\u639b\u9264\u3002 HookSucceeded - \u8cc7\u6e90\u5728\u6210\u529f\u5f8c\u5c07\u88ab\u522a\u9664\u3002 HookFailed - \u5982\u679c\u8cc7\u6e90\u5931\u6557\uff0c\u8cc7\u6e90\u5c07\u88ab\u522a\u9664\u3002 BeforeHookCreation - \u5728\u5275\u5efa\u65b0\u8cc7\u6e90\u4e4b\u524d\u5c07\u522a\u9664\u8cc7\u6e90\uff08\u89f8\u767c\u65b0\u540c\u6b65\u6642\uff09\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/hook-delete-policy \u8a3b\u91cb\u4f86\u61c9\u7528\u9019\u4e9b\u3002\u4f8b\u5982 metadata : annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded Tips \u7531\u65bc\u540c\u6b65\u53ef\u80fd\u5728\u4efb\u4f55\u968e\u6bb5\u5931\u6557\uff0c\u60a8\u53ef\u80fd\u6703\u9047\u5230\u61c9\u7528\u7a0b\u5e8f\u6c38\u9060\u4e0d\u6703\u5831\u544a\u5065\u5eb7\u7684\u60c5\u6cc1\uff01 \u96d6\u7136\u9264\u5b50\u53ef\u4ee5\u662f\u4efb\u4f55\u8cc7\u6e90\uff0c\u4f46\u5b83\u5011\u901a\u5e38\u662f Pod \u548c/\u6216 Job\u3002 \u8981\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u8cc7\u6e90\u639b\u9264\u7684\u4fe1\u606f\uff0c\u8acb\u67e5\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u63a2\u7d22 Resource Hooks"},{"location":"kubernetes/argocd/tutorial/04-syncwaves-hooks/#_1","text":"\u770b\u770b\u9019\u500b PostSync \u6e05\u55ae\uff0c\u5b83\u767c\u9001\u4e00\u500b HTTP \u8acb\u6c42\u4f86\u63d2\u5165\u4e00\u500b\u65b0\u7684 TODO \u9805\uff1a todo-insert-data.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-insert annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : httpie image : alpine/httpie:2.4.0 imagePullPolicy : Always command : [ \"http\" ] args : [ \"POST\" , \"todo-gitops:8080/api\" , \"title=Finish ArgoCD tutorial\" , \"--ignore-stdin\" ] restartPolicy : Never backoffLimit : 1 Info \u9019\u610f\u5473\u8457\u8a72\u4f5c\u696d\u5c07\u5728\u540c\u6b65\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u4e4b\u5f8c\u5728 PostSync \u968e\u6bb5\u904b\u884c\u3002 \u57f7\u884c\u9806\u5e8f\u5982\u4e0b\u5716\u6240\u793a\uff1a","title":"\u63a2\u7d22\u6e05\u55ae"},{"location":"kubernetes/argocd/tutorial/04-syncwaves-hooks/#_2","text":"\u60a8\u53ef\u4ee5\u901a\u904e\u8a2a\u554f repo \u67e5\u770b\u6240\u6709\u90e8\u7f72\u6587\u4ef6\u3002 \u770b\u770b\u9019\u500b\u6e05\u55ae\u6587\u4ef6\uff1a todo-application.yaml \uff1a todo-application.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : todo-app namespace : argocd spec : destination : namespace : todo server : https://kubernetes.default.svc project : default source : path : apps/todo repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u5b83\u5c07\u986f\u793a\u9019\u5c07\u5728 todo \u547d\u540d\u7a7a\u9593\u4e2d\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u6b64\u61c9\u7528\u7a0b\u5e8f\uff1a kubectl apply -f documentation/modules/ROOT/examples/minikube/todo-yaml/todo-application.yaml application.argoproj.io/todo-app created \u5728 Argo CD WebUI \u4e0a\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u53e6\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u51fa\u73fe\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u61c9\u5c07\u60a8\u5e36\u5230\u6a39\u8996\u5716\u3002 \u89c0\u5bdf\u540c\u6b65\u904e\u7a0b\u3002\u60a8\u5c07\u770b\u5230\u61c9\u7528\u8cc7\u6e90\u7684\u9806\u5e8f\uff0c\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\u5275\u5efa\uff0c\u6700\u5f8c\u662f\u5275\u5efa Route \u4ee5\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\u3002 \u4e00\u65e6\u61c9\u7528\u7a0b\u5e8f\u5b8c\u5168\u540c\u6b65\u3002\u67e5\u770b\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u548c\u4f5c\u696d\uff1a $ kubectl get pods -n todo \u60a8\u61c9\u8a72\u770b\u5230 Job \u5df2\u5b8c\u6210\uff0c\u4f46\u4ecd\u7136\u5b58\u5728\u3002 NAME READY STATUS RESTARTS AGE postgresql-599467fd86-cgj9v 1 /1 Running 0 32s todo-gitops-679d88f6f4-v4djp 1 /1 Running 0 19s todo-table-xhddk 0 /1 Completed 0 27s \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 todo-insert \u4f5c\u696d\u672a\u986f\u793a\uff0c\u56e0\u70ba\u5b83\u88ab\u914d\u7f6e\u70ba\u5982\u679c\u6210\u529f\u5247\u88ab\u522a\u9664\uff1a argocd.argoproj.io/hook-delete-policy : HookSucceeded","title":"\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/authentication/k82-api-call-inside-the-cluster/","text":"The Kubernetes API call inside the cluster \u00b6 \u539f\u6587: https://medium.com/@pczarkowski/the-kubernetes-api-call-is-coming-from-inside-the-cluster-f1a115bd2066 \u6709\u6642\u5f9e Pod \u5167\u90e8\u8a2a\u554f Kubernetes API \u5f88\u6709\u7528\u3002 Kubernetes \u8a66\u5716\u901a\u904e\u70ba\u6bcf\u500b pod \u639b\u8f09\u4e00\u500b serviceaccount secret \u4f86\u7c21\u5316\u6b64\u64cd\u4f5c\u3002 \u70ba\u4e86\u63a2\u7d22\u9019\u4e00\u9ede\uff0c\u6211\u4f7f\u7528 minikube \u5275\u5efa\u4e86\u4e00\u500b Kubernetes \u96c6\u7fa4\u4e26\u555f\u52d5\u4e86\u4e00\u500b\u4ea4\u4e92\u5f0f alpine Linux pod\uff1a $ minikube start $ kubectl run -i --tty alpine --image = alpine --restart = Never -- sh / # \u60a8\u6703\u5728\u8def\u5f91\u4e2d\u627e\u5230\u5e7e\u500b\u6587\u4ef6 /var/run/secrets/kubernetes.io/serviceaccount \u53ef\u7528\u65bc\u5c0d Kubernetes API \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff08\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3001ca \u8b49\u66f8\u548c\u547d\u540d\u7a7a\u9593\uff09\uff1a $ ls /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token $ cat /var/run/secrets/kubernetes.io/serviceaccount/token eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZ... ... l25cDJo2xgnz02W-FVznBJ46A/ \u7136\u800c\uff0c\u9019\u4e9b\u6587\u4ef6\u90fd\u6c92\u6709\u63d0\u4f9b Kubernetes API \u7684 URL\uff0c\u5e78\u597d\u9019\u53ef\u4ee5\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u7372\u5f97\uff1a $ env | grep KUBE KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 \u7d50\u5408\u4f7f\u7528\u9019\u4e9b\uff0c\u60a8\u5c07\u80fd\u5920\u9a57\u8b49\u548c\u8a2a\u554f Kubernetes API\u3002\u4e0d\u5e78\u7684\u662f\uff0calpine \u9644\u5e36\u7684 wget \u7121\u6cd5\u8a2a\u554f TLS \u7aef\u9ede\uff0c\u56e0\u6b64\u60a8\u9700\u8981\u5148\u5b89\u88dd curl \u6216\u985e\u4f3c\u7684\u6771\u897f\u624d\u80fd\u8a2a\u554f\u5b83\uff1a $ apk update fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz v3.16.0-242-ge8a8292729 [ https://dl-cdn.alpinelinux.org/alpine/v3.16/main ] v3.16.0-240-g6e6a2bc8ec [ https://dl-cdn.alpinelinux.org/alpine/v3.16/community ] OK: 17029 distinct packages available $ apk add curl ( 1 /5 ) Installing ca-certificates ( 20211220 -r0 ) ( 2 /5 ) Installing brotli-libs ( 1 .0.9-r6 ) ( 3 /5 ) Installing nghttp2-libs ( 1 .47.0-r0 ) ( 4 /5 ) Installing libcurl ( 7 .83.1-r2 ) ( 5 /5 ) Installing curl ( 7 .83.1-r2 ) Executing busybox-1.35.0-r13.trigger Executing ca-certificates-20211220-r0.trigger OK: 8 MiB in 19 packages \u5c07 curl \u5b89\u88dd\u5230\u6211\u5011\u7684 alpine \u5bb9\u5668\u4e2d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u57f7\u884c\u4e00\u4e9b\u975e\u5e38\u57fa\u672c\u7684 API \u64cd\u4f5c\u4f86\u67e5\u627e\u4fe1\u606f\u3002 $ K8S = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) $ CACERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt $ NAMESPACE = $( cat /var/run/secrets/kubernetes.io/serviceaccount/namespace ) $ curl -H \"Authorization: Bearer $TOKEN \" --cacert $CACERT $K8S /healthz kubectl get rolebinding,clusterrolebinding --all-namespaces -o jsonpath='{range .items[?(@.subjects[0].name==\"default\")]}[{.roleRef.kind},{.roleRef.name}]{end}'","title":"The Kubernetes API call inside the cluster"},{"location":"kubernetes/authentication/k82-api-call-inside-the-cluster/#the-kubernetes-api-call-inside-the-cluster","text":"\u539f\u6587: https://medium.com/@pczarkowski/the-kubernetes-api-call-is-coming-from-inside-the-cluster-f1a115bd2066 \u6709\u6642\u5f9e Pod \u5167\u90e8\u8a2a\u554f Kubernetes API \u5f88\u6709\u7528\u3002 Kubernetes \u8a66\u5716\u901a\u904e\u70ba\u6bcf\u500b pod \u639b\u8f09\u4e00\u500b serviceaccount secret \u4f86\u7c21\u5316\u6b64\u64cd\u4f5c\u3002 \u70ba\u4e86\u63a2\u7d22\u9019\u4e00\u9ede\uff0c\u6211\u4f7f\u7528 minikube \u5275\u5efa\u4e86\u4e00\u500b Kubernetes \u96c6\u7fa4\u4e26\u555f\u52d5\u4e86\u4e00\u500b\u4ea4\u4e92\u5f0f alpine Linux pod\uff1a $ minikube start $ kubectl run -i --tty alpine --image = alpine --restart = Never -- sh / # \u60a8\u6703\u5728\u8def\u5f91\u4e2d\u627e\u5230\u5e7e\u500b\u6587\u4ef6 /var/run/secrets/kubernetes.io/serviceaccount \u53ef\u7528\u65bc\u5c0d Kubernetes API \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff08\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3001ca \u8b49\u66f8\u548c\u547d\u540d\u7a7a\u9593\uff09\uff1a $ ls /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token $ cat /var/run/secrets/kubernetes.io/serviceaccount/token eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZ... ... l25cDJo2xgnz02W-FVznBJ46A/ \u7136\u800c\uff0c\u9019\u4e9b\u6587\u4ef6\u90fd\u6c92\u6709\u63d0\u4f9b Kubernetes API \u7684 URL\uff0c\u5e78\u597d\u9019\u53ef\u4ee5\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u7372\u5f97\uff1a $ env | grep KUBE KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 \u7d50\u5408\u4f7f\u7528\u9019\u4e9b\uff0c\u60a8\u5c07\u80fd\u5920\u9a57\u8b49\u548c\u8a2a\u554f Kubernetes API\u3002\u4e0d\u5e78\u7684\u662f\uff0calpine \u9644\u5e36\u7684 wget \u7121\u6cd5\u8a2a\u554f TLS \u7aef\u9ede\uff0c\u56e0\u6b64\u60a8\u9700\u8981\u5148\u5b89\u88dd curl \u6216\u985e\u4f3c\u7684\u6771\u897f\u624d\u80fd\u8a2a\u554f\u5b83\uff1a $ apk update fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz v3.16.0-242-ge8a8292729 [ https://dl-cdn.alpinelinux.org/alpine/v3.16/main ] v3.16.0-240-g6e6a2bc8ec [ https://dl-cdn.alpinelinux.org/alpine/v3.16/community ] OK: 17029 distinct packages available $ apk add curl ( 1 /5 ) Installing ca-certificates ( 20211220 -r0 ) ( 2 /5 ) Installing brotli-libs ( 1 .0.9-r6 ) ( 3 /5 ) Installing nghttp2-libs ( 1 .47.0-r0 ) ( 4 /5 ) Installing libcurl ( 7 .83.1-r2 ) ( 5 /5 ) Installing curl ( 7 .83.1-r2 ) Executing busybox-1.35.0-r13.trigger Executing ca-certificates-20211220-r0.trigger OK: 8 MiB in 19 packages \u5c07 curl \u5b89\u88dd\u5230\u6211\u5011\u7684 alpine \u5bb9\u5668\u4e2d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u57f7\u884c\u4e00\u4e9b\u975e\u5e38\u57fa\u672c\u7684 API \u64cd\u4f5c\u4f86\u67e5\u627e\u4fe1\u606f\u3002 $ K8S = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) $ CACERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt $ NAMESPACE = $( cat /var/run/secrets/kubernetes.io/serviceaccount/namespace ) $ curl -H \"Authorization: Bearer $TOKEN \" --cacert $CACERT $K8S /healthz kubectl get rolebinding,clusterrolebinding --all-namespaces -o jsonpath='{range .items[?(@.subjects[0].name==\"default\")]}[{.roleRef.kind},{.roleRef.name}]{end}'","title":"The Kubernetes API call inside the cluster"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/","text":"\u5728 kubernetes \u4e2d\u4f7f\u7528 rbac \u8a2d\u7f6e\u670d\u52d9\u5e33\u6236\u6b0a\u9650 \u00b6 \u539f\u6587: https://blog.dudaji.com/kubernetes/2019/05/01/k8s-authorization-of-sa-with-rbac.html \u60f3\u50cf\u4e00\u4e0b\uff0c\u60a8\u7684\u7d44\u7e54\u6b63\u5728\u904b\u884c\u7531\u591a\u500b\u5de5\u7a0b\u5718\u968a\u4f7f\u7528\u7684\u55ae\u500b Kubernetes \u96c6\u7fa4\u3002\u9019\u4e9b\u5718\u968a\u4e2d\u7684\u6bcf\u4e00\u500b\u90fd\u7368\u7acb\u90e8\u7f72\u4e86\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5e8f\u4f86\u958b\u767c\u548c\u6e2c\u8a66\u5b83\u3002\u60a8\u5e0c\u671b\u6bcf\u500b\u5718\u968a\u53ea\u8655\u7406\u4ed6\u5011\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u5957\u4ef6\u5be6\u4f8b\u2014\u2014\u6bcf\u500b\u5718\u968a\u53ea\u60f3\u770b\u5230\u4ed6\u5011\u5275\u5efa\u7684\u5c0d\u8c61\uff0c\u800c\u4e0d\u662f\u5176\u4ed6\u5718\u968a\u5275\u5efa\u7684\u5c0d\u8c61\u3002\u5728\u55ae\u4e00\u500b Kubernetes \u7684\u96c6\u7fa4\u88e1\u53ef\u4f7f\u7528\u547d\u540d\u7a7a\u9593( namespace )\u4f86\u5be6\u73fe\u3002 \u4f7f\u7528\u591a\u500b namespace \u5141\u8a31\u60a8\u5c07\u5177\u6709\u5927\u91cf\u7d44\u4ef6\u7684\u8907\u96dc\u7cfb\u7d71\u5283\u5206\u70ba\u7531\u4e0d\u540c\u5718\u968a\u7ba1\u7406\u7684\u5340\u57df\u3002\u5b83\u5011\u9084\u53ef\u7528\u65bc\u5728 mult-tenant environment \u7684\u60c5\u5883\u4e2d\u4f86\u9032\u884c\u5718\u968a\u7684\u9694\u96e2\u3002 \u5927\u591a\u6578 Kubernetes API \u7269\u4ef6\u985e\u578b\u90fd\u6709\u547d\u540d\u7a7a\u9593\uff0c\u4f46\u4e5f\u6709\u5c11\u6578\u6c92\u6709\u3002 Pod \u3001 ConfigMaps \u3001 Secrets \u3001 PersistentVolumeClaims \u548c Events \u90fd\u662f\u547d\u540d\u7a7a\u9593\u3002 Nodes , PersistentVolumes , StorageClasses , \u548c Namespaces \u672c\u8eab\u5247\u4e0d\u662f\u3002 \u8981\u67e5\u770b \u8cc7\u6e90 \u662f \u547d\u540d\u7a7a\u9593\u9084 \u662f \u96c6\u7fa4\u7bc4\u570d \uff0c\u8acb\u5728\u904b\u884c kubectl api-resources \u6642\u6aa2\u67e5 NAMESPACED \u5217\u3002 $ kubectl api-resources \u5834\u666f \u00b6 admin \uff1a\u64c1\u6709\u6240\u6709\u6b0a\u9650 department-leader \uff1a\u5c0d\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u64c1\u6709\u6b0a\u9650 team-a-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650\uff0c\u800c\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650 team-b-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650\uff0c\u5c0d\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650 \u5982\u4f55\u4f7f\u7528 Kubernetes \u9032\u884c\u8eab\u4efd\u9a57\u8b49 \u00b6 Kubernetes\u4e2d\u6709\u591a\u7a2e\u8a8d\u8b49\u65b9\u5f0f\uff0c\u5982token\u3001proxy\u3001webhook\u3001ID/PW\u3001OAuth2\u7b49\u3002\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\u53ef\u5728\u6b64\u8655\u7372\u5f97\u3002\u9664\u4e86\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u8eab\u4efd\u9a57\u8b49\u4e4b\u5916\uff0cKubernetes \u5efa\u8b70\u4f7f\u7528\u4e00\u7a2e\u6216\u591a\u7a2e\u7528\u6236\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u901a\u904e\u670d\u52d9\u5e33\u6236\uff08 Service account \uff09\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f86\u6e2c\u8a66 kubernetes api \u8abf\u7528\u3002 \u5275\u5efa\u547d\u540d\u7a7a\u9593 \u00b6 ns-team-a-create.yaml # ns-team-a-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-a ns-team-b-create.yaml # ns-team-b-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-b \u5275\u5efa namespace: $ kubectl create -f ns-team-a-create.yaml $ kubectl create -f ns-team-b-create.yaml \u6aa2\u67e5 namespace: $ kubectl get ns NAME STATUS AGE default Active 6m14s kube-node-lease Active 6m16s kube-public Active 6m16s kube-system Active 6m16s team-a Active 8s team-b Active 4s \u5275\u5efa\u670d\u52d9\u5e33\u6236 \u00b6 sa-team-a-create.yaml # sa-team-a-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-a namespace : team-a sa-team-b-create.yaml # sa-team-b-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-b namespace : team-b \u5275\u5efa service account: $ kubectl create -f sa-team-a-create.yaml $ kubectl create -f sa-team-b-create.yaml \u6aa2\u67e5\u5728\u4e0d\u540c namespace \u88e1\u7684 service account: $ kubectl get sa -n team-a NAME SECRETS AGE default 1 5m47s sa-team-a 1 22s $ kubectl get sa -n team-b NAME SECRETS AGE default 1 5m46s sa-team-b 1 17s \u89d2\u8272\u548c\u89d2\u8272\u7d81\u5b9a \u00b6 \u89d2\u8272\u5b9a\u7fa9\u4e86\u6709\u95dc\u6b0a\u9650\u7684\u4e8b\u60c5\u3002\u5b83\u5b9a\u7fa9\u4e86\u53ef\u4ee5\u8a2a\u554f\u7684\u4f4d\u7f6e\u4ee5\u53ca\u53ef\u4ee5\u5c0d\u54ea\u4e9b\u8cc7\u6e90\u9032\u884c\u54ea\u4e9b\u64cd\u4f5c\u3002 RoleBinding \u662f\u9023\u63a5 Role \u548c User \u7684\u6a4b\u6a11\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u7528\u6236\u88ab\u6388\u4e88\u6b0a\u9650\uff0c\u4f46\u662f\u95dc\u65bc\u6b0a\u9650\u7684\u4fe1\u606f\u662f\u7531**\u89d2\u8272**\u6c7a\u5b9a\u7684\u3002 \u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u89d2\u8272\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u9810\u5b9a\u7fa9\u7684\u89d2\u8272\u4f86\u7d66\u4e88\u6b0a\u9650\u3002 ClusterRole \u4e2d\u9810\u5b9a\u7fa9\u7684\u6b0a\u9650\u662f cluster-admin \u3001 admin \u3001 edit \u548c view \uff0c\u6839\u64da\u7d81\u5b9a\u7684\u985e\u578b\uff08 Rolebinding \u3001 ClusterRolebinding \uff09\u4f86\u78ba\u5b9a\u6b0a\u9650\u8a2a\u554f\u7bc4\u570d\u662f\u547d\u540d\u7a7a\u9593\u9084\u662f\u6574\u500b\u96c6\u7fa4\u3002 \u4f86\u6e90\uff1ahttps ://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles \u8b93\u6211\u5011\u4f86\u5275\u5efa\u4e00\u500b\u5ba2\u5236\u7684\u89d2\u8272: custom-role-binding.yaml kind : Role apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-role namespace : team-a rules : - apiGroups : [ \"\" ] # \"\" indicates the core API group resources : [ \"pods\" ] verbs : [ \"get\" , \"watch\" , \"list\" ] --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-rolebinding namespace : team-a subjects : - kind : ServiceAccount name : sa-team-a namespace : team-a roleRef : kind : Role name : custom-role apiGroup : rbac.authorization.k8s.io \u69cb\u5efa\u89d2\u8272\u8207\u6b0a\u9650\u4e26\u4e14\u9032\u884c\u7d81\u5b9a: $ kubectl create -f custom-role-binding.yaml role.rbac.authorization.k8s.io/custom-role created rolebinding.rbac.authorization.k8s.io/custom-rolebinding created \u4f7f\u7528\u5167\u5efa\u7684\u89d2\u8272\uff1a default-role-binding.yaml # default-role-binding.yaml kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : default-rolebinding namespace : team-b subjects : - kind : ServiceAccount name : sa-team-b namespace : team-b roleRef : kind : ClusterRole name : view apiGroup : rbac.authorization.k8s.io \u5c07\u6e05\u55ae\u61c9\u7528\u65bc Kubernetes $ kubectl create -f default-role-binding.yaml rolebinding.rbac.authorization.k8s.io/default-rolebinding created \u5275\u5efa\u4e00\u500b Pod \u00b6 pod-team-a-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-a namespace : team-a spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 pod-team-b-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-b namespace : team-b spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 \u5206\u5225\u5728\u5169\u500b namespace \u5404\u5275\u5efa\u4e00\u500b pod: $ kubectl create -f pod-team-a-create.yaml pod/pod-team-a created $ kubectl create -f pod-team-b-create.yaml pod/pod-team-b created API \u6e2c\u8a66 \u00b6 api\u670d\u52d9\u5668ip\u6aa2\u67e5 $ kubectl config view | grep server | cut -f 2 - -d \":\" | tr -d \" \" # display list of your api server https://192.168.49.2:8443 \u4e5f\u53ef\u7528: $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 ... \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578: APISERVER = <your-k8s-api-server> APISERVER = https://192.168.49.2:8443 \u6aa2\u67e5 sa-team-a \u7684\u4ee4\u724c: NAMESPACE = team-a SA = sa-team-a TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u6aa2\u67e5 sa-team-b \u7684\u4ee4\u724c: NAMESPACE = team-b SA = sa-team-b TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u5982\u679c system account \u60f3\u8981\u53bb\u8a2a\u554f\u6c92\u6709\u6b0a\u9650\u7684\u7684 namespace , \u8209\u4f8b: sa-team-b \u8a2a\u554f team-a \u3002 $ SA = sa-team-b $ NAMESPACE = team-b $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:team-b:sa-team-b\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"team-a\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 } department-leader \u548c admin \u00b6 \u5275\u5efa department-leader \u00b6 department-leader \u6709\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u7684\u6b0a\u9650\uff0c\u800c\u5c0d\u65bc admin \uff0c\u5247\u64c1\u6709\u6240\u6709\u5340\u57df\u7684\u6b0a\u9650\u3002 sa-leader.yaml # sa-leader.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-leader --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-a namespace : team-b subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-b namespace : team-a subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f sa-leader.yaml serviceaccount/sa-leader created rolebinding.rbac.authorization.k8s.io/department-leader-team-a created rolebinding.rbac.authorization.k8s.io/department-leader-team-b created $ SA = sa-leader $ NAMESPACE = default $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure $ NAMESPACE = team-b $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u5275\u5efa admin \u00b6 sa-admin-create.yaml # sa-admin-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-admin --- kind : ClusterRoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : admin-all-cluster subjects : - kind : ServiceAccount name : sa-admin namespace : default roleRef : kind : ClusterRole name : cluster-admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f a-admin-create.yaml serviceaccount/sa-admin created clusterrolebinding.rbac.authorization.k8s.io/admin-all-cluster created","title":"\u4f7f\u7528 RBAC \u8a2d\u7f6e\u670d\u52d9\u5e33\u6236\u6b0a\u9650"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#kubernetes-rbac","text":"\u539f\u6587: https://blog.dudaji.com/kubernetes/2019/05/01/k8s-authorization-of-sa-with-rbac.html \u60f3\u50cf\u4e00\u4e0b\uff0c\u60a8\u7684\u7d44\u7e54\u6b63\u5728\u904b\u884c\u7531\u591a\u500b\u5de5\u7a0b\u5718\u968a\u4f7f\u7528\u7684\u55ae\u500b Kubernetes \u96c6\u7fa4\u3002\u9019\u4e9b\u5718\u968a\u4e2d\u7684\u6bcf\u4e00\u500b\u90fd\u7368\u7acb\u90e8\u7f72\u4e86\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5e8f\u4f86\u958b\u767c\u548c\u6e2c\u8a66\u5b83\u3002\u60a8\u5e0c\u671b\u6bcf\u500b\u5718\u968a\u53ea\u8655\u7406\u4ed6\u5011\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u5957\u4ef6\u5be6\u4f8b\u2014\u2014\u6bcf\u500b\u5718\u968a\u53ea\u60f3\u770b\u5230\u4ed6\u5011\u5275\u5efa\u7684\u5c0d\u8c61\uff0c\u800c\u4e0d\u662f\u5176\u4ed6\u5718\u968a\u5275\u5efa\u7684\u5c0d\u8c61\u3002\u5728\u55ae\u4e00\u500b Kubernetes \u7684\u96c6\u7fa4\u88e1\u53ef\u4f7f\u7528\u547d\u540d\u7a7a\u9593( namespace )\u4f86\u5be6\u73fe\u3002 \u4f7f\u7528\u591a\u500b namespace \u5141\u8a31\u60a8\u5c07\u5177\u6709\u5927\u91cf\u7d44\u4ef6\u7684\u8907\u96dc\u7cfb\u7d71\u5283\u5206\u70ba\u7531\u4e0d\u540c\u5718\u968a\u7ba1\u7406\u7684\u5340\u57df\u3002\u5b83\u5011\u9084\u53ef\u7528\u65bc\u5728 mult-tenant environment \u7684\u60c5\u5883\u4e2d\u4f86\u9032\u884c\u5718\u968a\u7684\u9694\u96e2\u3002 \u5927\u591a\u6578 Kubernetes API \u7269\u4ef6\u985e\u578b\u90fd\u6709\u547d\u540d\u7a7a\u9593\uff0c\u4f46\u4e5f\u6709\u5c11\u6578\u6c92\u6709\u3002 Pod \u3001 ConfigMaps \u3001 Secrets \u3001 PersistentVolumeClaims \u548c Events \u90fd\u662f\u547d\u540d\u7a7a\u9593\u3002 Nodes , PersistentVolumes , StorageClasses , \u548c Namespaces \u672c\u8eab\u5247\u4e0d\u662f\u3002 \u8981\u67e5\u770b \u8cc7\u6e90 \u662f \u547d\u540d\u7a7a\u9593\u9084 \u662f \u96c6\u7fa4\u7bc4\u570d \uff0c\u8acb\u5728\u904b\u884c kubectl api-resources \u6642\u6aa2\u67e5 NAMESPACED \u5217\u3002 $ kubectl api-resources","title":"\u5728 kubernetes \u4e2d\u4f7f\u7528 rbac \u8a2d\u7f6e\u670d\u52d9\u5e33\u6236\u6b0a\u9650"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#_1","text":"admin \uff1a\u64c1\u6709\u6240\u6709\u6b0a\u9650 department-leader \uff1a\u5c0d\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u64c1\u6709\u6b0a\u9650 team-a-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650\uff0c\u800c\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650 team-b-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650\uff0c\u5c0d\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650","title":"\u5834\u666f"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#kubernetes","text":"Kubernetes\u4e2d\u6709\u591a\u7a2e\u8a8d\u8b49\u65b9\u5f0f\uff0c\u5982token\u3001proxy\u3001webhook\u3001ID/PW\u3001OAuth2\u7b49\u3002\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\u53ef\u5728\u6b64\u8655\u7372\u5f97\u3002\u9664\u4e86\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u8eab\u4efd\u9a57\u8b49\u4e4b\u5916\uff0cKubernetes \u5efa\u8b70\u4f7f\u7528\u4e00\u7a2e\u6216\u591a\u7a2e\u7528\u6236\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u901a\u904e\u670d\u52d9\u5e33\u6236\uff08 Service account \uff09\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f86\u6e2c\u8a66 kubernetes api \u8abf\u7528\u3002","title":"\u5982\u4f55\u4f7f\u7528 Kubernetes \u9032\u884c\u8eab\u4efd\u9a57\u8b49"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#_2","text":"ns-team-a-create.yaml # ns-team-a-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-a ns-team-b-create.yaml # ns-team-b-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-b \u5275\u5efa namespace: $ kubectl create -f ns-team-a-create.yaml $ kubectl create -f ns-team-b-create.yaml \u6aa2\u67e5 namespace: $ kubectl get ns NAME STATUS AGE default Active 6m14s kube-node-lease Active 6m16s kube-public Active 6m16s kube-system Active 6m16s team-a Active 8s team-b Active 4s","title":"\u5275\u5efa\u547d\u540d\u7a7a\u9593"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#_3","text":"sa-team-a-create.yaml # sa-team-a-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-a namespace : team-a sa-team-b-create.yaml # sa-team-b-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-b namespace : team-b \u5275\u5efa service account: $ kubectl create -f sa-team-a-create.yaml $ kubectl create -f sa-team-b-create.yaml \u6aa2\u67e5\u5728\u4e0d\u540c namespace \u88e1\u7684 service account: $ kubectl get sa -n team-a NAME SECRETS AGE default 1 5m47s sa-team-a 1 22s $ kubectl get sa -n team-b NAME SECRETS AGE default 1 5m46s sa-team-b 1 17s","title":"\u5275\u5efa\u670d\u52d9\u5e33\u6236"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#_4","text":"\u89d2\u8272\u5b9a\u7fa9\u4e86\u6709\u95dc\u6b0a\u9650\u7684\u4e8b\u60c5\u3002\u5b83\u5b9a\u7fa9\u4e86\u53ef\u4ee5\u8a2a\u554f\u7684\u4f4d\u7f6e\u4ee5\u53ca\u53ef\u4ee5\u5c0d\u54ea\u4e9b\u8cc7\u6e90\u9032\u884c\u54ea\u4e9b\u64cd\u4f5c\u3002 RoleBinding \u662f\u9023\u63a5 Role \u548c User \u7684\u6a4b\u6a11\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u7528\u6236\u88ab\u6388\u4e88\u6b0a\u9650\uff0c\u4f46\u662f\u95dc\u65bc\u6b0a\u9650\u7684\u4fe1\u606f\u662f\u7531**\u89d2\u8272**\u6c7a\u5b9a\u7684\u3002 \u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u89d2\u8272\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u9810\u5b9a\u7fa9\u7684\u89d2\u8272\u4f86\u7d66\u4e88\u6b0a\u9650\u3002 ClusterRole \u4e2d\u9810\u5b9a\u7fa9\u7684\u6b0a\u9650\u662f cluster-admin \u3001 admin \u3001 edit \u548c view \uff0c\u6839\u64da\u7d81\u5b9a\u7684\u985e\u578b\uff08 Rolebinding \u3001 ClusterRolebinding \uff09\u4f86\u78ba\u5b9a\u6b0a\u9650\u8a2a\u554f\u7bc4\u570d\u662f\u547d\u540d\u7a7a\u9593\u9084\u662f\u6574\u500b\u96c6\u7fa4\u3002 \u4f86\u6e90\uff1ahttps ://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles \u8b93\u6211\u5011\u4f86\u5275\u5efa\u4e00\u500b\u5ba2\u5236\u7684\u89d2\u8272: custom-role-binding.yaml kind : Role apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-role namespace : team-a rules : - apiGroups : [ \"\" ] # \"\" indicates the core API group resources : [ \"pods\" ] verbs : [ \"get\" , \"watch\" , \"list\" ] --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-rolebinding namespace : team-a subjects : - kind : ServiceAccount name : sa-team-a namespace : team-a roleRef : kind : Role name : custom-role apiGroup : rbac.authorization.k8s.io \u69cb\u5efa\u89d2\u8272\u8207\u6b0a\u9650\u4e26\u4e14\u9032\u884c\u7d81\u5b9a: $ kubectl create -f custom-role-binding.yaml role.rbac.authorization.k8s.io/custom-role created rolebinding.rbac.authorization.k8s.io/custom-rolebinding created \u4f7f\u7528\u5167\u5efa\u7684\u89d2\u8272\uff1a default-role-binding.yaml # default-role-binding.yaml kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : default-rolebinding namespace : team-b subjects : - kind : ServiceAccount name : sa-team-b namespace : team-b roleRef : kind : ClusterRole name : view apiGroup : rbac.authorization.k8s.io \u5c07\u6e05\u55ae\u61c9\u7528\u65bc Kubernetes $ kubectl create -f default-role-binding.yaml rolebinding.rbac.authorization.k8s.io/default-rolebinding created","title":"\u89d2\u8272\u548c\u89d2\u8272\u7d81\u5b9a"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#pod","text":"pod-team-a-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-a namespace : team-a spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 pod-team-b-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-b namespace : team-b spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 \u5206\u5225\u5728\u5169\u500b namespace \u5404\u5275\u5efa\u4e00\u500b pod: $ kubectl create -f pod-team-a-create.yaml pod/pod-team-a created $ kubectl create -f pod-team-b-create.yaml pod/pod-team-b created","title":"\u5275\u5efa\u4e00\u500b Pod"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#api","text":"api\u670d\u52d9\u5668ip\u6aa2\u67e5 $ kubectl config view | grep server | cut -f 2 - -d \":\" | tr -d \" \" # display list of your api server https://192.168.49.2:8443 \u4e5f\u53ef\u7528: $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 ... \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578: APISERVER = <your-k8s-api-server> APISERVER = https://192.168.49.2:8443 \u6aa2\u67e5 sa-team-a \u7684\u4ee4\u724c: NAMESPACE = team-a SA = sa-team-a TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u6aa2\u67e5 sa-team-b \u7684\u4ee4\u724c: NAMESPACE = team-b SA = sa-team-b TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u5982\u679c system account \u60f3\u8981\u53bb\u8a2a\u554f\u6c92\u6709\u6b0a\u9650\u7684\u7684 namespace , \u8209\u4f8b: sa-team-b \u8a2a\u554f team-a \u3002 $ SA = sa-team-b $ NAMESPACE = team-b $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:team-b:sa-team-b\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"team-a\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 }","title":"API \u6e2c\u8a66"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#department-leader-admin","text":"","title":"department-leader \u548c admin"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#department-leader","text":"department-leader \u6709\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u7684\u6b0a\u9650\uff0c\u800c\u5c0d\u65bc admin \uff0c\u5247\u64c1\u6709\u6240\u6709\u5340\u57df\u7684\u6b0a\u9650\u3002 sa-leader.yaml # sa-leader.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-leader --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-a namespace : team-b subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-b namespace : team-a subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f sa-leader.yaml serviceaccount/sa-leader created rolebinding.rbac.authorization.k8s.io/department-leader-team-a created rolebinding.rbac.authorization.k8s.io/department-leader-team-b created $ SA = sa-leader $ NAMESPACE = default $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure $ NAMESPACE = team-b $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure","title":"\u5275\u5efa department-leader"},{"location":"kubernetes/authentication/k8s-authorization-of-sa-with-rbac/#admin","text":"sa-admin-create.yaml # sa-admin-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-admin --- kind : ClusterRoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : admin-all-cluster subjects : - kind : ServiceAccount name : sa-admin namespace : default roleRef : kind : ClusterRole name : cluster-admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f a-admin-create.yaml serviceaccount/sa-admin created clusterrolebinding.rbac.authorization.k8s.io/admin-all-cluster created","title":"\u5275\u5efa admin"},{"location":"kubernetes/authentication/k8s-sa-jwt-rbac/","text":"ServiceAccounts\u3001JWT-tokens\u3001\u8eab\u4efd\u9a57\u8b49\u548c RBAC \u6388\u6b0a \u00b6 \u539f\u6587: https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/ \u5c0d\u65bc\u8a8d\u8b49\u548c\u6388\u6b0a\uff0cKubernetes \u6709 User Accounts \u548c Service Accounts \u7b49\u6982\u5ff5\u3002 User Accounts \u7528\u65bc\u5f9e\u5916\u90e8\u8a2a\u554f\u96c6\u7fa4\u7684\u5e38\u7528\u7528\u6236\u914d\u7f6e\u6587\u4ef6\uff0c\u800c Service Accounts \u7528\u65bc\u5f9e\u96c6\u7fa4\u5167\u90e8\u6388\u4e88\u8a2a\u554f\u6b0a\u9650\u3002 ServiceAccounts \u65e8\u5728\u70ba Kubernetes Pod \u63d0\u4f9b\u4e00\u500b\u8eab\u4efd\uff0c\u4ee5\u4f9b\u5176\u5bb9\u5668\u5728\u5411 Kubernetes API \u670d\u52d9\u5668\u57f7\u884c API \u8acb\u6c42\u6642\u5c0d\u5176\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u3002 \u9810\u8a2d\u7684 ServiceAccount \u00b6 \u6bcf\u500b Kubernetes \u547d\u540d\u7a7a\u9593\u90fd\u6709\u81ea\u5df1\u7684\u9ed8\u8a8d ServiceAccount (SA)\uff0c\u5b83\u662f\u5728\u5275\u5efa\u547d\u540d\u7a7a\u9593\u6642\u5275\u5efa\u7684\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u547d\u540d\u7a7a\u9593\uff1a @ kubectl --namespace default get serviceaccount NAME SECRETS AGE default 1 44h \u5c0d\u65bc\u6bcf\u500b ServiceAccount\uff0c\u90fd\u6703\u751f\u6210\u4e00\u500b token \u4e26\u5c07\u5176\u5b58\u5132\u70ba Kubernetes Secret\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u7684\u9019\u500b ServiceAccount\uff1a $ kubectl --namespace default get serviceaccount default -o yaml apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-07-14T04:56:34Z\" name: default namespace: default resourceVersion: \"476\" uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 secrets: - name: default-token-tvflf \u5728\u672c\u7bc4\u4f8b\u4e2d SA \u7684\u4ee4\u724c\u5132\u653e\u5728 default-token-tvflf \u7684 Secret \u4e2d\uff1a Warning \u5728 Kubernetes 1.24+ \u4e4b\u5f8c\u7684\u7248\u672c\uff0cK8s \u4e0d\u6703\u518d\u70ba ServiceAccounts \u81ea\u52d5\u751f\u6210 Secret\u3002\u898b BIG change in K8s 1.24 about ServiceAccounts and their Secrets \u9810\u8a2d\u7684 token \u00b6 \u73fe\u5728\uff0c\u6aa2\u67e5 Secret \u7684\u5167\u5bb9\uff1a $ kubectl get secret default-token-tvflf -o yaml apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyTlRjM056UTFOell3SGhjTk1qSXdOekUwTURRMU5qRTJXaGNOTXpJd056RXhNRFExTmpFMgpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyTlRjM056UTFOell3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSUkFMTldkL2ZwVGxwWGY1c1BndjVDaTZGUm5hcFBwYWZSb2V2ZTJ3dGYKdjFQYVRueGNERUVUM0FKbDVUdDd4RG9DRlRtMVRyWXRTN2MyTmFLOFd3bk5vMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVWh4OUhPeGJWQ0dRU2NZMC9ZaGxjCnlyQ25YcmN3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQU5DQVRNOElScHNHaWs4R1FuWThGL1BEMFcrQXB6NW8KYzNqRnNXblZSc1B3QWlCdi9UWFQwSGtoZVpCZHJING0rZlUzeDNpU0UvVThqcGFGVEJ1ZUJqWUU0dz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K namespace: ZGVmYXVsdA == token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn kind: Secret metadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 creationTimestamp: \"2022-07-14T04:56:34Z\" name: default-token-tvflf namespace: default resourceVersion: \"474\" uid: 5cf55c44-2c6a-46a9-90ba-137cea5f27b9 type: kubernetes.io/service-account-token type - \u6a19\u793a\u4e86\u9019\u500b Secret \u7684\u985e\u578b\u662f kubernetes.io/service-account-token \u3002 data - \u4fdd\u5b58\u4e86 ca.ert \u8207 token \u7684\u8cc7\u8a0a (base64 encoded) ca.crt \u7531 K8S \u96c6\u7fa4\u7684\u4e3b\u5bc6\u9470\u7c3d\u540d\uff0c\u56e0\u6b64\u96c6\u7fa4\u626e\u6f14\u8457\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7684\u89d2\u8272\uff0c\u4e26\u5141\u8a31 pod \u6216\u61c9\u7528\u7a0b\u5e8f\u9a57\u8b49 API-server\u3002 \u73fe\u5728\uff0c\u8b93\u6211\u5011\u53bb\u7814\u7a76 token \u7684\u90e8\u5206\u3002 JWT token \u5167\u5bb9 \u00b6 \u70ba\u4e86\u66f4\u5bb9\u6613\u5f9e termainal \u5de5\u4f5c - \u5c07 data.token \u503c\u4fdd\u5b58\u5230\u8b8a\u91cf\u4e2d\uff1a $ token = \"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn\" \u4f7f\u7528 base64 \u7372\u53d6\u5176\u5167\u5bb9\uff1a $ echo $token | base64 -d eyJhbGciOiJSUzI1NiIsImtpZCI6Inl3NVZwakRjMEZYU29GQUN2ZERfUmlncERlSlRQclA5OVVpbGxYR090b28ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tdHZmbGYiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNiODFmYjJhLWExNDgtNGEyYS1iNzlmLTg5YzEwMWNlN2MxMiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.ggbx38gAGQR6VsUI2dbGHXqyW2-Pb6V63IEBmQtkh2g-i_qNcx40yF9UY23cltm9recFpMuDE1eRT9LsapVnDtOpgOym2Z8jK9F5vKR6k_F25RojtSuQb8o_oktD2eMIpzcv96n_XCz7LpWVRtP2m0QbVLM7HdhShNdt_q1wWxHj-PbBH9nmyxazgFxa8nHKs7vcRgLPj9TJDM7BH7SEZ9yY8n5KVpnkwv3RPElvSZGKZr-1WCQq444ebqVVqQiLN0clu57a6Oy7kNNtjGlzIXOoJMXZZCIYdDAmAnJCVkxKE_hGLL0OgofG1wYQuLZ9mqTAjW9DCPx71N_U6aKLEg JWT \u7684 token \u5305\u542b\u4e86\u4e09\u90e8\u4efd\u7684\u8cc7\u8a0a: \u6a19\u982d header - \u63cf\u8ff0\u4ee4\u724c\u7684\u7c3d\u540d\u65b9\u5f0f \u6709\u6548\u8ca0\u8f09 payload - \u4ee4\u724c\u7684\u5be6\u969b\u6578\u64da\uff0c\u4f8b\u5982\u5230\u671f\u65e5\u671f\u3001\u9812\u767c\u8005\u7b49\uff0c\u8acb\u53c3\u95b1 RFC-7519 \u7c3d\u540d signature - \u7528\u65bc\u9a57\u8b49\u4ee4\u724c\u6c92\u6709\u88ab\u4fee\u6539\uff0c\u4e26\u53ef\u7528\u65bc\u9a57\u8b49\u767c\u4ef6\u4eba \u8981\u6aa2\u67e5\u4ee4\u724c\u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 jwtutility \u6216\u5728 jwt.io \u7db2\u7ad9\u3002 \u6709\u6548\u8ca0\u8f09 payload \u90e8\u5206\u6709\u4ee5\u4e0b\u8cc7\u8a0a\uff1a { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-tvflf\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"cb81fb2a-a148-4a2a-b79f-89c101ce7c12\" , \"sub\" : \"system:serviceaccount:default:default\" } iss - \u4ee4\u724c\u7684\u7c3d\u767c\u8005 issuer kubernetes.io/serviceaccount/namespace - \u6a19\u793a\u4e86\u4ee4\u724c\u6b78\u5c6c\u65bc\u90a3\u500b\u547d\u540d\u7a7a\u9593 kubernetes.io/serviceaccount/secret.name - \u6a19\u793a\u4ee4\u724c\u4ee3\u8868\u8005\u90a3\u4e00\u500b\u670d\u52d9\u5e33\u6236 kubernetes.io/serviceaccount/service-account.uid - \u670d\u52d9\u5e33\u6236\u7684\u5167\u90e8 id sub - \u6a19\u793a\u4e86\u4e00\u500b unique \u7684\u5b8c\u6574\u670d\u52d9\u5e33\u6236\u7684\u540d\u7a31 ServiceAccount \u548c RBAC \u00b6 \u5c0d\u65bc\u6c92\u6709\u6307\u5b9a ServiceAccount \u7684\u6bcf\u500b Pod\uff0cKubernetes \u90fd\u6703\u81ea\u52d5\u6307\u6d3e\u4f7f\u7528 default \u9019\u500b ServiceAccount \u4e26\u639b\u8f09\u4e86\u5b83\u7684 JWT \u4ee4\u724c\u3002 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5728 pod \u5167\u90e8\u6aa2\u67e5 /var/run/secrets/kubernetes.io/serviceaccount \u76ee\u9304\u5167\u5bb9\uff1a [ root@ca-test-pod:/ ] $ ls -1 /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token \u5728 pod \u5167\u90e8\u6aa2\u67e5\u74b0\u5883\u8b8a\u6578\uff1a [ root@ca-test-pod:/ ] $ env | grep KUBERNETES KUBERNETES_PORT = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 \u5617\u8a66\u5728\u6c92\u6709\u8eab\u4efd\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\u5411 API-server \u57f7\u884c\u8acb\u6c42 - \u4f7f\u7528\u7279\u6b8a\u7684 Service kubernetes \uff0c\u5c07 -k \u6216 --insecure \u6dfb\u52a0\u5230 curl \u4ee5\u8df3\u904e\u670d\u52d9\u5668\u7684\u8b49\u66f8\u9a57\u8b49 [ root@ca-test-pod:/ ] $ curl -k https://kubernetes { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"Unauthorized\" , \"reason\" : \"Unauthorized\" , \"code\" : 401 } \u6211\u5011\u5f97\u5230 401 Unauthorized\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5728\u547c\u53eb\u8a2d\u5b9a\u4e0a\u6dfb\u52a0\u5169\u500b\u8b8a\u91cf ca.crt \u548c token \uff1a [ root@ca-test-pod:/ ] $ CERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt [ root@ca-test-pod:/ ] $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \u518d\u6b21\u904b\u884c curl, \u8b93\u6211\u5011\u5617\u8a66\u7372\u53d6\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u5217\u8868\uff0c\u9019\u6b21\u4e0d\u4f7f\u7528 --insecure \u4e26\u4f7f\u7528 Authorization \u6a19\u982d\u9032\u884c\u6388\u6b0a\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 } \u9019\u6b21\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u7684\u7528\u6236 system:serviceaccount:default:default \u6c92\u6709\u6b0a\u9650\u4f86\u547c\u53eb\u672c\u6b64\u7684API\u3002 ServiceAccount \u8207 RoleBindig \u00b6 \u70ba\u4e86\u7d66\u6211\u5011\u7684 SericeAccount \u6b0a\u9650\uff0c\u6211\u5011\u9700\u8981\u50cf\u666e\u901a\u7528\u6236\u4e00\u6a23\u5275\u5efa RoleBinding \u6216 ClusterRoleBinding \u3002 \u5275\u5efa\u5230\u9ed8\u8a8d ClusterRole \u8996\u5716\u7684 RoleBinding \u6620\u5c04\uff0c\u8acb\u53c3\u95b1 User-facing roles \uff1a $ kubectl create rolebinding ca-test-view --clusterrole = view --serviceaccount = default:default rolebinding.rbac.authorization.k8s.io/ca-test-view created \u4e26\u518d\u6b21\u904b\u884c curl\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" \u7d50\u679c: { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { }, \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" }, \"code\" : 403 }[ roo t @ca - test - pod : / ] $ curl -- cacer t $CERT - H \"Authorization: Bearer $TOKEN\" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"PodList\" , \"apiVersion\" : \"v1\" , \"metadata\" : { \"resourceVersion\" : \"14260\" }, \"items\" : [ { \"metadata\" : { \"name\" : \"ca-test-pod\" , \"namespace\" : \"default\" , \"uid\" : \"db7b286c-a31d-4697-bed6-7e75cb7865e9\" , \"resourceVersion\" : \"13958\" , \"creationTimestamp\" : \"2022-07-16T01:50:29Z\" , \"labels\" : { \"run\" : \"ca-test-pod\" }, \"managedFields\" : [ { \"manager\" : \"kubectl-run\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:29Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:metadata\" :{ \"f:labels\" :{ \".\" :{}, \"f:run\" :{}}}, \"f:spec\" :{ \"f:containers\" :{ \"k:{\\\"name\\\":\\\"ca-test-pod\\\"}\" :{ \".\" :{}, \"f:image\" :{}, \"f:imagePullPolicy\" :{}, \"f:name\" :{}, \"f:resources\" :{}, \"f:stdin\" :{}, \"f:stdinOnce\" :{}, \"f:terminationMessagePath\" :{}, \"f:terminationMessagePolicy\" :{}, \"f:tty\" :{}}}, \"f:dnsPolicy\" :{}, \"f:enableServiceLinks\" :{}, \"f:restartPolicy\" :{}, \"f:schedulerName\" :{}, \"f:securityContext\" :{}, \"f:terminationGracePeriodSeconds\" :{}}} }, { \"manager\" : \"k3s\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:38Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:status\" :{ \"f:conditions\" :{ \"k:{\\\"type\\\":\\\"ContainersReady\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Initialized\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Ready\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}}, \"f:containerStatuses\" :{}, \"f:hostIP\" :{}, \"f:phase\" :{}, \"f:podIP\" :{}, \"f:podIPs\" :{ \".\" :{}, \"k:{\\\"ip\\\":\\\"10.42.0.11\\\"}\" :{ \".\" :{}, \"f:ip\" :{}}}, \"f:startTime\" :{}}}, \"subresource\" : \"status\" } ] }, \"spec\" : { \"volumes\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"projected\" : { \"sources\" : [ { \"serviceAccountToken\" : { \"expirationSeconds\" : 3607 , \"path\" : \"token\" } }, { \"configMap\" : { \"name\" : \"kube-root-ca.crt\" , \"items\" : [ { \"key\" : \"ca.crt\" , \"path\" : \"ca.crt\" } ] } }, { \"downwardAPI\" : { \"items\" : [ { \"path\" : \"namespace\" , \"fieldRef\" : { \"apiVersion\" : \"v1\" , \"fieldPath\" : \"metadata.namespace\" } } ] } } ], \"defaultMode\" : 420 } } ], \"containers\" : [ { \"name\" : \"ca-test-pod\" , \"image\" : \"radial/busyboxplus:curl\" , \"resources\" : { }, \"volumeMounts\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"readOnly\" : true , \"mountPath\" : \"/var/run/secrets/kubernetes.io/serviceaccount\" } ], \"terminationMessagePath\" : \"/dev/termination-log\" , \"terminationMessagePolicy\" : \"File\" , \"imagePullPolicy\" : \"IfNotPresent\" , \"stdin\" : true , \"stdinOnce\" : true , \"tty\" : true } ], \"restartPolicy\" : \"Always\" , \"terminationGracePeriodSeconds\" : 30 , \"dnsPolicy\" : \"ClusterFirst\" , \"serviceAccountName\" : \"default\" , \"serviceAccount\" : \"default\" , \"nodeName\" : \"k3d-k3s-default-server-0\" , \"securityContext\" : { }, \"schedulerName\" : \"default-scheduler\" , \"tolerations\" : [ { \"key\" : \"node.kubernetes.io/not-ready\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 }, { \"key\" : \"node.kubernetes.io/unreachable\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 } ], \"priority\" : 0 , \"enableServiceLinks\" : true , \"preemptionPolicy\" : \"PreemptLowerPriority\" }, \"status\" : { \"phase\" : \"Running\" , \"conditions\" : [ { \"type\" : \"Initialized\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" }, { \"type\" : \"Ready\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"ContainersReady\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"PodScheduled\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" } ], \"hostIP\" : \"172.24.0.2\" , \"podIP\" : \"10.42.0.11\" , \"podIPs\" : [ { \"ip\" : \"10.42.0.11\" } ], \"startTime\" : \"2022-07-16T01:50:29Z\" , \"containerStatuses\" : [ { \"name\" : \"ca-test-pod\" , \"state\" : { \"running\" : { \"startedAt\" : \"2022-07-16T01:50:37Z\" } }, \"lastState\" : { }, \"ready\" : true , \"restartCount\" : 0 , \"image\" : \"docker.io/radial/busyboxplus:curl\" , \"imageID\" : \"sha256:4776f1f7d1f625c8c5173a969fdc9ae6b62655a2746aba989784bb2b7edbfe9b\" , \"containerID\" : \"containerd://c3e6ffab06622a2506ed6cf18ec8acd61fbb2a45721a2d65617b5bbce2a91159\" , \"started\" : true } ], \"qosClass\" : \"BestEffort\" } } ] }","title":"ServiceAccounts\u3001JWT-tokens\u3001\u8eab\u4efd\u9a57\u8b49\u548c RBAC \u6388\u6b0a"},{"location":"kubernetes/authentication/k8s-sa-jwt-rbac/#serviceaccountsjwt-tokens-rbac","text":"\u539f\u6587: https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/ \u5c0d\u65bc\u8a8d\u8b49\u548c\u6388\u6b0a\uff0cKubernetes \u6709 User Accounts \u548c Service Accounts \u7b49\u6982\u5ff5\u3002 User Accounts \u7528\u65bc\u5f9e\u5916\u90e8\u8a2a\u554f\u96c6\u7fa4\u7684\u5e38\u7528\u7528\u6236\u914d\u7f6e\u6587\u4ef6\uff0c\u800c Service Accounts \u7528\u65bc\u5f9e\u96c6\u7fa4\u5167\u90e8\u6388\u4e88\u8a2a\u554f\u6b0a\u9650\u3002 ServiceAccounts \u65e8\u5728\u70ba Kubernetes Pod \u63d0\u4f9b\u4e00\u500b\u8eab\u4efd\uff0c\u4ee5\u4f9b\u5176\u5bb9\u5668\u5728\u5411 Kubernetes API \u670d\u52d9\u5668\u57f7\u884c API \u8acb\u6c42\u6642\u5c0d\u5176\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u3002","title":"ServiceAccounts\u3001JWT-tokens\u3001\u8eab\u4efd\u9a57\u8b49\u548c RBAC \u6388\u6b0a"},{"location":"kubernetes/authentication/k8s-sa-jwt-rbac/#serviceaccount","text":"\u6bcf\u500b Kubernetes \u547d\u540d\u7a7a\u9593\u90fd\u6709\u81ea\u5df1\u7684\u9ed8\u8a8d ServiceAccount (SA)\uff0c\u5b83\u662f\u5728\u5275\u5efa\u547d\u540d\u7a7a\u9593\u6642\u5275\u5efa\u7684\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u547d\u540d\u7a7a\u9593\uff1a @ kubectl --namespace default get serviceaccount NAME SECRETS AGE default 1 44h \u5c0d\u65bc\u6bcf\u500b ServiceAccount\uff0c\u90fd\u6703\u751f\u6210\u4e00\u500b token \u4e26\u5c07\u5176\u5b58\u5132\u70ba Kubernetes Secret\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u7684\u9019\u500b ServiceAccount\uff1a $ kubectl --namespace default get serviceaccount default -o yaml apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-07-14T04:56:34Z\" name: default namespace: default resourceVersion: \"476\" uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 secrets: - name: default-token-tvflf \u5728\u672c\u7bc4\u4f8b\u4e2d SA \u7684\u4ee4\u724c\u5132\u653e\u5728 default-token-tvflf \u7684 Secret \u4e2d\uff1a Warning \u5728 Kubernetes 1.24+ \u4e4b\u5f8c\u7684\u7248\u672c\uff0cK8s \u4e0d\u6703\u518d\u70ba ServiceAccounts \u81ea\u52d5\u751f\u6210 Secret\u3002\u898b BIG change in K8s 1.24 about ServiceAccounts and their Secrets","title":"\u9810\u8a2d\u7684 ServiceAccount"},{"location":"kubernetes/authentication/k8s-sa-jwt-rbac/#token","text":"\u73fe\u5728\uff0c\u6aa2\u67e5 Secret \u7684\u5167\u5bb9\uff1a $ kubectl get secret default-token-tvflf -o yaml apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyTlRjM056UTFOell3SGhjTk1qSXdOekUwTURRMU5qRTJXaGNOTXpJd056RXhNRFExTmpFMgpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyTlRjM056UTFOell3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSUkFMTldkL2ZwVGxwWGY1c1BndjVDaTZGUm5hcFBwYWZSb2V2ZTJ3dGYKdjFQYVRueGNERUVUM0FKbDVUdDd4RG9DRlRtMVRyWXRTN2MyTmFLOFd3bk5vMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVWh4OUhPeGJWQ0dRU2NZMC9ZaGxjCnlyQ25YcmN3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQU5DQVRNOElScHNHaWs4R1FuWThGL1BEMFcrQXB6NW8KYzNqRnNXblZSc1B3QWlCdi9UWFQwSGtoZVpCZHJING0rZlUzeDNpU0UvVThqcGFGVEJ1ZUJqWUU0dz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K namespace: ZGVmYXVsdA == token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn kind: Secret metadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 creationTimestamp: \"2022-07-14T04:56:34Z\" name: default-token-tvflf namespace: default resourceVersion: \"474\" uid: 5cf55c44-2c6a-46a9-90ba-137cea5f27b9 type: kubernetes.io/service-account-token type - \u6a19\u793a\u4e86\u9019\u500b Secret \u7684\u985e\u578b\u662f kubernetes.io/service-account-token \u3002 data - \u4fdd\u5b58\u4e86 ca.ert \u8207 token \u7684\u8cc7\u8a0a (base64 encoded) ca.crt \u7531 K8S \u96c6\u7fa4\u7684\u4e3b\u5bc6\u9470\u7c3d\u540d\uff0c\u56e0\u6b64\u96c6\u7fa4\u626e\u6f14\u8457\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7684\u89d2\u8272\uff0c\u4e26\u5141\u8a31 pod \u6216\u61c9\u7528\u7a0b\u5e8f\u9a57\u8b49 API-server\u3002 \u73fe\u5728\uff0c\u8b93\u6211\u5011\u53bb\u7814\u7a76 token \u7684\u90e8\u5206\u3002","title":"\u9810\u8a2d\u7684 token"},{"location":"kubernetes/authentication/k8s-sa-jwt-rbac/#jwt-token","text":"\u70ba\u4e86\u66f4\u5bb9\u6613\u5f9e termainal \u5de5\u4f5c - \u5c07 data.token \u503c\u4fdd\u5b58\u5230\u8b8a\u91cf\u4e2d\uff1a $ token = \"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn\" \u4f7f\u7528 base64 \u7372\u53d6\u5176\u5167\u5bb9\uff1a $ echo $token | base64 -d eyJhbGciOiJSUzI1NiIsImtpZCI6Inl3NVZwakRjMEZYU29GQUN2ZERfUmlncERlSlRQclA5OVVpbGxYR090b28ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tdHZmbGYiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNiODFmYjJhLWExNDgtNGEyYS1iNzlmLTg5YzEwMWNlN2MxMiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.ggbx38gAGQR6VsUI2dbGHXqyW2-Pb6V63IEBmQtkh2g-i_qNcx40yF9UY23cltm9recFpMuDE1eRT9LsapVnDtOpgOym2Z8jK9F5vKR6k_F25RojtSuQb8o_oktD2eMIpzcv96n_XCz7LpWVRtP2m0QbVLM7HdhShNdt_q1wWxHj-PbBH9nmyxazgFxa8nHKs7vcRgLPj9TJDM7BH7SEZ9yY8n5KVpnkwv3RPElvSZGKZr-1WCQq444ebqVVqQiLN0clu57a6Oy7kNNtjGlzIXOoJMXZZCIYdDAmAnJCVkxKE_hGLL0OgofG1wYQuLZ9mqTAjW9DCPx71N_U6aKLEg JWT \u7684 token \u5305\u542b\u4e86\u4e09\u90e8\u4efd\u7684\u8cc7\u8a0a: \u6a19\u982d header - \u63cf\u8ff0\u4ee4\u724c\u7684\u7c3d\u540d\u65b9\u5f0f \u6709\u6548\u8ca0\u8f09 payload - \u4ee4\u724c\u7684\u5be6\u969b\u6578\u64da\uff0c\u4f8b\u5982\u5230\u671f\u65e5\u671f\u3001\u9812\u767c\u8005\u7b49\uff0c\u8acb\u53c3\u95b1 RFC-7519 \u7c3d\u540d signature - \u7528\u65bc\u9a57\u8b49\u4ee4\u724c\u6c92\u6709\u88ab\u4fee\u6539\uff0c\u4e26\u53ef\u7528\u65bc\u9a57\u8b49\u767c\u4ef6\u4eba \u8981\u6aa2\u67e5\u4ee4\u724c\u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 jwtutility \u6216\u5728 jwt.io \u7db2\u7ad9\u3002 \u6709\u6548\u8ca0\u8f09 payload \u90e8\u5206\u6709\u4ee5\u4e0b\u8cc7\u8a0a\uff1a { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-tvflf\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"cb81fb2a-a148-4a2a-b79f-89c101ce7c12\" , \"sub\" : \"system:serviceaccount:default:default\" } iss - \u4ee4\u724c\u7684\u7c3d\u767c\u8005 issuer kubernetes.io/serviceaccount/namespace - \u6a19\u793a\u4e86\u4ee4\u724c\u6b78\u5c6c\u65bc\u90a3\u500b\u547d\u540d\u7a7a\u9593 kubernetes.io/serviceaccount/secret.name - \u6a19\u793a\u4ee4\u724c\u4ee3\u8868\u8005\u90a3\u4e00\u500b\u670d\u52d9\u5e33\u6236 kubernetes.io/serviceaccount/service-account.uid - \u670d\u52d9\u5e33\u6236\u7684\u5167\u90e8 id sub - \u6a19\u793a\u4e86\u4e00\u500b unique \u7684\u5b8c\u6574\u670d\u52d9\u5e33\u6236\u7684\u540d\u7a31","title":"JWT token \u5167\u5bb9"},{"location":"kubernetes/authentication/k8s-sa-jwt-rbac/#serviceaccount-rbac","text":"\u5c0d\u65bc\u6c92\u6709\u6307\u5b9a ServiceAccount \u7684\u6bcf\u500b Pod\uff0cKubernetes \u90fd\u6703\u81ea\u52d5\u6307\u6d3e\u4f7f\u7528 default \u9019\u500b ServiceAccount \u4e26\u639b\u8f09\u4e86\u5b83\u7684 JWT \u4ee4\u724c\u3002 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5728 pod \u5167\u90e8\u6aa2\u67e5 /var/run/secrets/kubernetes.io/serviceaccount \u76ee\u9304\u5167\u5bb9\uff1a [ root@ca-test-pod:/ ] $ ls -1 /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token \u5728 pod \u5167\u90e8\u6aa2\u67e5\u74b0\u5883\u8b8a\u6578\uff1a [ root@ca-test-pod:/ ] $ env | grep KUBERNETES KUBERNETES_PORT = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 \u5617\u8a66\u5728\u6c92\u6709\u8eab\u4efd\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\u5411 API-server \u57f7\u884c\u8acb\u6c42 - \u4f7f\u7528\u7279\u6b8a\u7684 Service kubernetes \uff0c\u5c07 -k \u6216 --insecure \u6dfb\u52a0\u5230 curl \u4ee5\u8df3\u904e\u670d\u52d9\u5668\u7684\u8b49\u66f8\u9a57\u8b49 [ root@ca-test-pod:/ ] $ curl -k https://kubernetes { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"Unauthorized\" , \"reason\" : \"Unauthorized\" , \"code\" : 401 } \u6211\u5011\u5f97\u5230 401 Unauthorized\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5728\u547c\u53eb\u8a2d\u5b9a\u4e0a\u6dfb\u52a0\u5169\u500b\u8b8a\u91cf ca.crt \u548c token \uff1a [ root@ca-test-pod:/ ] $ CERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt [ root@ca-test-pod:/ ] $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \u518d\u6b21\u904b\u884c curl, \u8b93\u6211\u5011\u5617\u8a66\u7372\u53d6\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u5217\u8868\uff0c\u9019\u6b21\u4e0d\u4f7f\u7528 --insecure \u4e26\u4f7f\u7528 Authorization \u6a19\u982d\u9032\u884c\u6388\u6b0a\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 } \u9019\u6b21\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u7684\u7528\u6236 system:serviceaccount:default:default \u6c92\u6709\u6b0a\u9650\u4f86\u547c\u53eb\u672c\u6b64\u7684API\u3002","title":"ServiceAccount \u548c RBAC"},{"location":"kubernetes/authentication/k8s-sa-jwt-rbac/#serviceaccount-rolebindig","text":"\u70ba\u4e86\u7d66\u6211\u5011\u7684 SericeAccount \u6b0a\u9650\uff0c\u6211\u5011\u9700\u8981\u50cf\u666e\u901a\u7528\u6236\u4e00\u6a23\u5275\u5efa RoleBinding \u6216 ClusterRoleBinding \u3002 \u5275\u5efa\u5230\u9ed8\u8a8d ClusterRole \u8996\u5716\u7684 RoleBinding \u6620\u5c04\uff0c\u8acb\u53c3\u95b1 User-facing roles \uff1a $ kubectl create rolebinding ca-test-view --clusterrole = view --serviceaccount = default:default rolebinding.rbac.authorization.k8s.io/ca-test-view created \u4e26\u518d\u6b21\u904b\u884c curl\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" \u7d50\u679c: { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { }, \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" }, \"code\" : 403 }[ roo t @ca - test - pod : / ] $ curl -- cacer t $CERT - H \"Authorization: Bearer $TOKEN\" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"PodList\" , \"apiVersion\" : \"v1\" , \"metadata\" : { \"resourceVersion\" : \"14260\" }, \"items\" : [ { \"metadata\" : { \"name\" : \"ca-test-pod\" , \"namespace\" : \"default\" , \"uid\" : \"db7b286c-a31d-4697-bed6-7e75cb7865e9\" , \"resourceVersion\" : \"13958\" , \"creationTimestamp\" : \"2022-07-16T01:50:29Z\" , \"labels\" : { \"run\" : \"ca-test-pod\" }, \"managedFields\" : [ { \"manager\" : \"kubectl-run\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:29Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:metadata\" :{ \"f:labels\" :{ \".\" :{}, \"f:run\" :{}}}, \"f:spec\" :{ \"f:containers\" :{ \"k:{\\\"name\\\":\\\"ca-test-pod\\\"}\" :{ \".\" :{}, \"f:image\" :{}, \"f:imagePullPolicy\" :{}, \"f:name\" :{}, \"f:resources\" :{}, \"f:stdin\" :{}, \"f:stdinOnce\" :{}, \"f:terminationMessagePath\" :{}, \"f:terminationMessagePolicy\" :{}, \"f:tty\" :{}}}, \"f:dnsPolicy\" :{}, \"f:enableServiceLinks\" :{}, \"f:restartPolicy\" :{}, \"f:schedulerName\" :{}, \"f:securityContext\" :{}, \"f:terminationGracePeriodSeconds\" :{}}} }, { \"manager\" : \"k3s\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:38Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:status\" :{ \"f:conditions\" :{ \"k:{\\\"type\\\":\\\"ContainersReady\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Initialized\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Ready\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}}, \"f:containerStatuses\" :{}, \"f:hostIP\" :{}, \"f:phase\" :{}, \"f:podIP\" :{}, \"f:podIPs\" :{ \".\" :{}, \"k:{\\\"ip\\\":\\\"10.42.0.11\\\"}\" :{ \".\" :{}, \"f:ip\" :{}}}, \"f:startTime\" :{}}}, \"subresource\" : \"status\" } ] }, \"spec\" : { \"volumes\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"projected\" : { \"sources\" : [ { \"serviceAccountToken\" : { \"expirationSeconds\" : 3607 , \"path\" : \"token\" } }, { \"configMap\" : { \"name\" : \"kube-root-ca.crt\" , \"items\" : [ { \"key\" : \"ca.crt\" , \"path\" : \"ca.crt\" } ] } }, { \"downwardAPI\" : { \"items\" : [ { \"path\" : \"namespace\" , \"fieldRef\" : { \"apiVersion\" : \"v1\" , \"fieldPath\" : \"metadata.namespace\" } } ] } } ], \"defaultMode\" : 420 } } ], \"containers\" : [ { \"name\" : \"ca-test-pod\" , \"image\" : \"radial/busyboxplus:curl\" , \"resources\" : { }, \"volumeMounts\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"readOnly\" : true , \"mountPath\" : \"/var/run/secrets/kubernetes.io/serviceaccount\" } ], \"terminationMessagePath\" : \"/dev/termination-log\" , \"terminationMessagePolicy\" : \"File\" , \"imagePullPolicy\" : \"IfNotPresent\" , \"stdin\" : true , \"stdinOnce\" : true , \"tty\" : true } ], \"restartPolicy\" : \"Always\" , \"terminationGracePeriodSeconds\" : 30 , \"dnsPolicy\" : \"ClusterFirst\" , \"serviceAccountName\" : \"default\" , \"serviceAccount\" : \"default\" , \"nodeName\" : \"k3d-k3s-default-server-0\" , \"securityContext\" : { }, \"schedulerName\" : \"default-scheduler\" , \"tolerations\" : [ { \"key\" : \"node.kubernetes.io/not-ready\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 }, { \"key\" : \"node.kubernetes.io/unreachable\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 } ], \"priority\" : 0 , \"enableServiceLinks\" : true , \"preemptionPolicy\" : \"PreemptLowerPriority\" }, \"status\" : { \"phase\" : \"Running\" , \"conditions\" : [ { \"type\" : \"Initialized\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" }, { \"type\" : \"Ready\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"ContainersReady\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"PodScheduled\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" } ], \"hostIP\" : \"172.24.0.2\" , \"podIP\" : \"10.42.0.11\" , \"podIPs\" : [ { \"ip\" : \"10.42.0.11\" } ], \"startTime\" : \"2022-07-16T01:50:29Z\" , \"containerStatuses\" : [ { \"name\" : \"ca-test-pod\" , \"state\" : { \"running\" : { \"startedAt\" : \"2022-07-16T01:50:37Z\" } }, \"lastState\" : { }, \"ready\" : true , \"restartCount\" : 0 , \"image\" : \"docker.io/radial/busyboxplus:curl\" , \"imageID\" : \"sha256:4776f1f7d1f625c8c5173a969fdc9ae6b62655a2746aba989784bb2b7edbfe9b\" , \"containerID\" : \"containerd://c3e6ffab06622a2506ed6cf18ec8acd61fbb2a45721a2d65617b5bbce2a91159\" , \"started\" : true } ], \"qosClass\" : \"BestEffort\" } } ] }","title":"ServiceAccount \u8207 RoleBindig"},{"location":"kubernetes/authentication/rbac-intro/","text":"Kubernetes RBAC (Role Base Access Control) \u00b6 k8s \u5728 1.8 \u7248\u4e4b\u5f8c\uff0c\u5f15\u7528\u4e86 Role-Base Access Control (RBAC\uff0c\u57fa\u65bc\u89d2\u8272\u7684\u8a2a\u554f\u63a7\u5236) \u505a\u70ba\u6388\u6b0a (Authorization) \u7684\u57fa\u790e\uff0c\u4e5f\u5c31\u662f\u4e00\u7a2e\u7ba1\u5236\u8a2a\u554f k8s API \u7684\u6a5f\u5236\u3002\u7ba1\u7406\u8005\u53ef\u4ee5\u900f\u904e rbac.authorization.k8s.io \u9019\u500b API \u7fa4\u7d44\u4f86\u9032\u884c\u52d5\u614b\u7684\u7ba1\u7406\u914d\u7f6e\u3002 \u900f\u904e\u9069\u7576\u7684\u89d2\u8272\u914d\u7f6e\u8207\u6388\u6b0a\u5206\u914d\uff0c\u7ba1\u7406\u8005\u53ef\u4ee5\u6c7a\u5b9a\u4f7f\u7528\u8005\u80fd\u5920\u4f7f\u7528\u54ea\u4e9b\u529f\u80fd\u3002\u4f8b\u5982\u5141\u8a31\u67d0\u500b\u89d2\u8272\u80fd\u65b0\u589e Pod \u6216\u53ea\u80fd\u5920\u5bdf\u770b\u4f46\u662f\u4e0d\u80fd\u65b0\u589e\u7b49\u7b49\u3002 \u53e6\u5916\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c\u5728 RBAC \u4e0b\u7684 \u89d2\u8272 \u6703\u88ab\u8ce6\u4e88\u4e0d\u540c\u7684\u7684\u6b0a\u9650 (permission)\uff0c\u800c\u9019\u4e9b\u6b0a\u9650\u662f\u63a1\u53d6\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\uff0c\u610f\u601d\u662f\u53ea\u6703\u6709\u89d2\u8272\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u800c\u4e0d\u6703\u6709\u89d2\u8272\u4e0d\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u3002 \u56e0\u6b64\uff0c\u4f5c\u70ba\u4e00\u500b\u512a\u79c0\u7684\u7ba1\u7406\u8005\uff0c\u4f60\u61c9\u8a72\u9069\u5ea6\u7684\u914d\u7f6e\u89d2\u8272\u4e26\u6c7a\u5b9a\u4e0d\u540c\u89d2\u8272\u53ef\u4ee5\u5141\u8a31\u64cd\u4f5c\u4ec0\u9ebc\u9805\u76ee\u3002 Role vs ClusterRole \u00b6 Role \u662f\u7528\u4f86\u5b9a\u7fa9\u5728\u67d0\u500b \u547d\u540d\u7a7a\u9593 \u5e95\u4e0b\u7684 \u89d2\u8272 \uff0c\u800c ClusterRole \u5247\u662f\u5c6c\u65bc \u53e2\u96c6\u901a\u7528\u7684\u89d2\u8272 \u3002\u53e6\u5916 ClusterRole \u9664\u4e86\u53ef\u4ee5\u914d\u7f6e Role \u7684\u6b0a\u9650\u5167\u5bb9\u5916\uff0c\u7531\u65bc\u662f Cluster \u7bc4\u570d\u7684\u89d2\u8272\uff0c\u56e0\u6b64\u9084\u80fd\u5920\u914d\u7f6e: \u53e2\u96c6\u7bc4\u570d\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 Nodes \u975e\u8cc7\u6e90\u985e\u578b\u7684 endpoints\uff0c\u4f8b\u5982 /healthz \u8de8\u547d\u540d\u7a7a\u9593\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 kubectl get pods --all-namespace \u770b\u500b\u4f8b\u5b50\uff1a role.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : Role metadata : namespace : default <=== \u5b9a\u7fa9\u5728 default \u547d\u540d\u7a7a\u9593\u4e2d name : configmap-editor <=== Role \u7684\u540d\u7a31 rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"configmap\" ] verbs : [ \"get\" , \"list\" , \"watch\" , \"create\" , \"update\" , \"patch\" , \"delete\" ] role.yaml \u6307\u5b9a\u4e86\u4e00\u500b default \u547d\u540d\u7a7a\u9593\u5167\u7684 Role \u7269\u4ef6\uff0c\u4e26\u5141\u8a31\u9019\u500b Role \u80fd\u5920\u5c0d ConfigMap \u9032\u884c\u64cd\u4f5c\u3002\u9019\u908a\u53ef\u4ee5\u77e5\u9053\u5728\u5b9a\u7fa9 Role \u7684\u6642\u5019\u5fc5\u9808: \u6307\u5b9a apiGroup \uff1a\u56e0\u70ba ConfigMap \u662f\u5c6c\u65bc apiVersion:v1 \u5e95\u4e0b\u7684\u7269\u4ef6\uff0c\"\" \u4ee3\u8868\u7684\u610f\u601d\u5c31\u662f apiVersion:v1 \u6307\u5b9a\u8981\u64cd\u4f5c\u7684\u8cc7\u6e90 resource \uff1a\u9019\u908a\u7684\u7bc4\u4f8b\u662f ConfigMap \u6388\u6b0a\u52d5\u4f5c verbs \uff1a\u8a18\u5f97\u662f\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\u8a72\u89d2\u8272\u80fd\u5728\u6307\u5b9a\u8cc7\u6e90\u505a\u4ec0\u9ebc\u64cd\u4f5c\uff0c\u4e0a\u9762\u4f8b\u5b50\u5305\u542b get , list , watch , create , update , patch \u548c delete \u3002 \u5982\u679c\u662f ClusterRole \uff1a clusterrole.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRole metadata : name : secret-reader rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"secrets\" ] verbs : [ \"get\" , \"list\" , \"watch\" ] <=== \u5141\u8a31\u8b80\u53d6 Secret \u4e0a\u9762\u7684\u7bc4\u4f8b\uff0c\u6211\u5011\u5efa\u7acb\u4e86\u4e00\u500b\u53ef\u4ee5\u8b80\u53d6 Secret \u7684 ClusterRole \u3002\u5176\u5be6\u8ddf Role \u5f88\u985e\u4f3c\uff0c\u5dee\u5225\u5728\u65bc ClusterRole \u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u7a7a\u9593\u3002 RoleBinding vs ClusterRoleBinding \u00b6 \u6709\u4e86 Role \u6216 ClusterRole \u4e4b\u5f8c\uff0c\u8868\u793a\u67d0\u500b\u547d\u540d\u7a7a\u9593\u5167\u6216\u662f\u53e2\u96c6\u5167\u6709\u88ab\u8ce6\u4e88\u6b0a\u9650\u7684\u89d2\u8272\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u9700\u8981\u900f\u904e RoleBinding \u6216 ClusterRoleBinding \u7684\u65b9\u5f0f\u4f86\u7d81\u5b9a\u3002 \u5982\u679c\u53ea\u6709\u5ba3\u544a Role \u6216 ClusterRole \u4f46\u672a\u7d81\u5b9a\uff0c\u5247\u6beb\u7121\u7528\u8655 \u7d81\u5b9a\u7684\u5c0d\u8c61\u53ef\u4ee5\u662f User , Group , \u6216\u8005\u662f Service Account \uff0c\u4f8b\u5982: User: subjects : - kind : User <=== \u6307\u5b9a\u5c0d\u8c61\u70ba User name : \"james@example.com\" <=== User \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Group: subjects : - kind : Group <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Group name : \"frontend-admins\" <=== Group \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Service Account\uff1a subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Service Account name : default <=== Service Account \u540d\u7a31 namespace : kube-system <=== \u547d\u540d\u7a7a\u9593 \u9019\u908a\u7279\u5225\u8aaa\u660e\u4e00\u4e0b Service Account \u3002\u5982\u679c\u5728 k8s \u90e8\u7f72\u50cf Jenkins \u9019\u985e\u7684 CI/CD \u5de5\u5177\u6642\uff0c\u4e00\u822c\u90fd\u6703\u5efa\u7acb\u81ea\u5df1\u7684 \u547d\u540d\u7a7a\u9593 \u3002\u800c\u7576\u7522\u751f\u4e00\u500b\u65b0\u7684 \u547d\u540d\u7a7a\u9593 \u6642\uff0c\u9810\u8a2d\u5c31\u6703\u6709\u4e00\u500b default \u7684 Service Account \u3002\u4f8b\u5982\uff1a $ kubectl create namespace jenkins namespace \"jenkins\" created $ kubectl get serviceaccount --namespace = jenkins NAME SECRETS AGE default 1 4m < === \u6703\u6709\u4e00\u500b\u9810\u8a2d\u7684 Service Account \u800c Jenkins \u6703\u53c3\u8003\u9019\u500b default \u4f86\u53d6\u5f97\u64cd\u4f5c k8s \u7684\u6b0a\u9650\uff0c\u4f46\u662f\u5728\u9810\u8a2d\u7684\u60c5\u6cc1\u4e0b\uff0c default \u4e0d\u6703\u64c1\u6709\u4efb\u4f55\u7684\u6b0a\u9650\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8981\u8a2d\u5b9a default \u7684\u6b0a\u9650\uff0c\u5373\u642d\u914d\u4e0a\u9762\u7684 RoleBinding \u6216 ClusterRoleBinding \u624d\u80fd\u5920\u63a7\u5236\u9019\u500b default \u80fd\u5920\u64cd\u4f5c\u7684\u6b0a\u9650\u3002 \u5e95\u4e0b\u662f\u4e00\u500b\u7d81\u5b9a\u4e0a\u9762 jenkins \u547d\u540d\u7a7a\u9593\u7684 Service Account \u4f8b\u5b50 clusterrolebinding.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : secret-reader subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u70ba jenkins \u5e95\u4e0b\u7684 default name : default namespace : jenkins roleRef : kind : ClusterRole <=== \u7d81\u5b9a ClusterRole name : secret-reader apiGroup : rbac.authorization.k8s.io \u53e6\u5916\uff0c\u4f60\u4e5f\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u4f86\u7d81\u5b9a\uff0c\u4f8b\u5982\u5982\u679c\u60f3\u8981\u5141\u8a31\u4e0a\u9762\u7684 default \u9019\u500b Service Account \u80fd\u5920\u64c1\u6709\u6574\u500b\u53e2\u96c6\u7684\u7ba1\u7406\u6b0a\u9650\uff0c\u6211\u5011\u53ef\u4ee5\u5efa\u7acb\u4e00\u500b ClusterRoleBinding \uff1a $ kubectl create clusterrolebinding jenkins-admin \\ --clusterrole = admin \\ --serviceaccount = jenkins:default clusterrolebinding jenkins-admin \uff1a\u5efa\u7acb\u4e00\u500b ClusterRoleBinding --clusterrole=admin \uff1a\u6307\u5b9a\u6b0a\u9650\u70ba admin --serviceaccount=jenkins:default \uff1a\u7d81\u5b9a jenkins \u7684\u4e0b\u7684 default","title":"Kubernetes RBAC \u4ecb\u8a54"},{"location":"kubernetes/authentication/rbac-intro/#kubernetes-rbac-role-base-access-control","text":"k8s \u5728 1.8 \u7248\u4e4b\u5f8c\uff0c\u5f15\u7528\u4e86 Role-Base Access Control (RBAC\uff0c\u57fa\u65bc\u89d2\u8272\u7684\u8a2a\u554f\u63a7\u5236) \u505a\u70ba\u6388\u6b0a (Authorization) \u7684\u57fa\u790e\uff0c\u4e5f\u5c31\u662f\u4e00\u7a2e\u7ba1\u5236\u8a2a\u554f k8s API \u7684\u6a5f\u5236\u3002\u7ba1\u7406\u8005\u53ef\u4ee5\u900f\u904e rbac.authorization.k8s.io \u9019\u500b API \u7fa4\u7d44\u4f86\u9032\u884c\u52d5\u614b\u7684\u7ba1\u7406\u914d\u7f6e\u3002 \u900f\u904e\u9069\u7576\u7684\u89d2\u8272\u914d\u7f6e\u8207\u6388\u6b0a\u5206\u914d\uff0c\u7ba1\u7406\u8005\u53ef\u4ee5\u6c7a\u5b9a\u4f7f\u7528\u8005\u80fd\u5920\u4f7f\u7528\u54ea\u4e9b\u529f\u80fd\u3002\u4f8b\u5982\u5141\u8a31\u67d0\u500b\u89d2\u8272\u80fd\u65b0\u589e Pod \u6216\u53ea\u80fd\u5920\u5bdf\u770b\u4f46\u662f\u4e0d\u80fd\u65b0\u589e\u7b49\u7b49\u3002 \u53e6\u5916\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c\u5728 RBAC \u4e0b\u7684 \u89d2\u8272 \u6703\u88ab\u8ce6\u4e88\u4e0d\u540c\u7684\u7684\u6b0a\u9650 (permission)\uff0c\u800c\u9019\u4e9b\u6b0a\u9650\u662f\u63a1\u53d6\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\uff0c\u610f\u601d\u662f\u53ea\u6703\u6709\u89d2\u8272\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u800c\u4e0d\u6703\u6709\u89d2\u8272\u4e0d\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u3002 \u56e0\u6b64\uff0c\u4f5c\u70ba\u4e00\u500b\u512a\u79c0\u7684\u7ba1\u7406\u8005\uff0c\u4f60\u61c9\u8a72\u9069\u5ea6\u7684\u914d\u7f6e\u89d2\u8272\u4e26\u6c7a\u5b9a\u4e0d\u540c\u89d2\u8272\u53ef\u4ee5\u5141\u8a31\u64cd\u4f5c\u4ec0\u9ebc\u9805\u76ee\u3002","title":"Kubernetes RBAC (Role Base Access Control)"},{"location":"kubernetes/authentication/rbac-intro/#role-vs-clusterrole","text":"Role \u662f\u7528\u4f86\u5b9a\u7fa9\u5728\u67d0\u500b \u547d\u540d\u7a7a\u9593 \u5e95\u4e0b\u7684 \u89d2\u8272 \uff0c\u800c ClusterRole \u5247\u662f\u5c6c\u65bc \u53e2\u96c6\u901a\u7528\u7684\u89d2\u8272 \u3002\u53e6\u5916 ClusterRole \u9664\u4e86\u53ef\u4ee5\u914d\u7f6e Role \u7684\u6b0a\u9650\u5167\u5bb9\u5916\uff0c\u7531\u65bc\u662f Cluster \u7bc4\u570d\u7684\u89d2\u8272\uff0c\u56e0\u6b64\u9084\u80fd\u5920\u914d\u7f6e: \u53e2\u96c6\u7bc4\u570d\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 Nodes \u975e\u8cc7\u6e90\u985e\u578b\u7684 endpoints\uff0c\u4f8b\u5982 /healthz \u8de8\u547d\u540d\u7a7a\u9593\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 kubectl get pods --all-namespace \u770b\u500b\u4f8b\u5b50\uff1a role.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : Role metadata : namespace : default <=== \u5b9a\u7fa9\u5728 default \u547d\u540d\u7a7a\u9593\u4e2d name : configmap-editor <=== Role \u7684\u540d\u7a31 rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"configmap\" ] verbs : [ \"get\" , \"list\" , \"watch\" , \"create\" , \"update\" , \"patch\" , \"delete\" ] role.yaml \u6307\u5b9a\u4e86\u4e00\u500b default \u547d\u540d\u7a7a\u9593\u5167\u7684 Role \u7269\u4ef6\uff0c\u4e26\u5141\u8a31\u9019\u500b Role \u80fd\u5920\u5c0d ConfigMap \u9032\u884c\u64cd\u4f5c\u3002\u9019\u908a\u53ef\u4ee5\u77e5\u9053\u5728\u5b9a\u7fa9 Role \u7684\u6642\u5019\u5fc5\u9808: \u6307\u5b9a apiGroup \uff1a\u56e0\u70ba ConfigMap \u662f\u5c6c\u65bc apiVersion:v1 \u5e95\u4e0b\u7684\u7269\u4ef6\uff0c\"\" \u4ee3\u8868\u7684\u610f\u601d\u5c31\u662f apiVersion:v1 \u6307\u5b9a\u8981\u64cd\u4f5c\u7684\u8cc7\u6e90 resource \uff1a\u9019\u908a\u7684\u7bc4\u4f8b\u662f ConfigMap \u6388\u6b0a\u52d5\u4f5c verbs \uff1a\u8a18\u5f97\u662f\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\u8a72\u89d2\u8272\u80fd\u5728\u6307\u5b9a\u8cc7\u6e90\u505a\u4ec0\u9ebc\u64cd\u4f5c\uff0c\u4e0a\u9762\u4f8b\u5b50\u5305\u542b get , list , watch , create , update , patch \u548c delete \u3002 \u5982\u679c\u662f ClusterRole \uff1a clusterrole.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRole metadata : name : secret-reader rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"secrets\" ] verbs : [ \"get\" , \"list\" , \"watch\" ] <=== \u5141\u8a31\u8b80\u53d6 Secret \u4e0a\u9762\u7684\u7bc4\u4f8b\uff0c\u6211\u5011\u5efa\u7acb\u4e86\u4e00\u500b\u53ef\u4ee5\u8b80\u53d6 Secret \u7684 ClusterRole \u3002\u5176\u5be6\u8ddf Role \u5f88\u985e\u4f3c\uff0c\u5dee\u5225\u5728\u65bc ClusterRole \u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u7a7a\u9593\u3002","title":"Role vs ClusterRole"},{"location":"kubernetes/authentication/rbac-intro/#rolebinding-vs-clusterrolebinding","text":"\u6709\u4e86 Role \u6216 ClusterRole \u4e4b\u5f8c\uff0c\u8868\u793a\u67d0\u500b\u547d\u540d\u7a7a\u9593\u5167\u6216\u662f\u53e2\u96c6\u5167\u6709\u88ab\u8ce6\u4e88\u6b0a\u9650\u7684\u89d2\u8272\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u9700\u8981\u900f\u904e RoleBinding \u6216 ClusterRoleBinding \u7684\u65b9\u5f0f\u4f86\u7d81\u5b9a\u3002 \u5982\u679c\u53ea\u6709\u5ba3\u544a Role \u6216 ClusterRole \u4f46\u672a\u7d81\u5b9a\uff0c\u5247\u6beb\u7121\u7528\u8655 \u7d81\u5b9a\u7684\u5c0d\u8c61\u53ef\u4ee5\u662f User , Group , \u6216\u8005\u662f Service Account \uff0c\u4f8b\u5982: User: subjects : - kind : User <=== \u6307\u5b9a\u5c0d\u8c61\u70ba User name : \"james@example.com\" <=== User \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Group: subjects : - kind : Group <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Group name : \"frontend-admins\" <=== Group \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Service Account\uff1a subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Service Account name : default <=== Service Account \u540d\u7a31 namespace : kube-system <=== \u547d\u540d\u7a7a\u9593 \u9019\u908a\u7279\u5225\u8aaa\u660e\u4e00\u4e0b Service Account \u3002\u5982\u679c\u5728 k8s \u90e8\u7f72\u50cf Jenkins \u9019\u985e\u7684 CI/CD \u5de5\u5177\u6642\uff0c\u4e00\u822c\u90fd\u6703\u5efa\u7acb\u81ea\u5df1\u7684 \u547d\u540d\u7a7a\u9593 \u3002\u800c\u7576\u7522\u751f\u4e00\u500b\u65b0\u7684 \u547d\u540d\u7a7a\u9593 \u6642\uff0c\u9810\u8a2d\u5c31\u6703\u6709\u4e00\u500b default \u7684 Service Account \u3002\u4f8b\u5982\uff1a $ kubectl create namespace jenkins namespace \"jenkins\" created $ kubectl get serviceaccount --namespace = jenkins NAME SECRETS AGE default 1 4m < === \u6703\u6709\u4e00\u500b\u9810\u8a2d\u7684 Service Account \u800c Jenkins \u6703\u53c3\u8003\u9019\u500b default \u4f86\u53d6\u5f97\u64cd\u4f5c k8s \u7684\u6b0a\u9650\uff0c\u4f46\u662f\u5728\u9810\u8a2d\u7684\u60c5\u6cc1\u4e0b\uff0c default \u4e0d\u6703\u64c1\u6709\u4efb\u4f55\u7684\u6b0a\u9650\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8981\u8a2d\u5b9a default \u7684\u6b0a\u9650\uff0c\u5373\u642d\u914d\u4e0a\u9762\u7684 RoleBinding \u6216 ClusterRoleBinding \u624d\u80fd\u5920\u63a7\u5236\u9019\u500b default \u80fd\u5920\u64cd\u4f5c\u7684\u6b0a\u9650\u3002 \u5e95\u4e0b\u662f\u4e00\u500b\u7d81\u5b9a\u4e0a\u9762 jenkins \u547d\u540d\u7a7a\u9593\u7684 Service Account \u4f8b\u5b50 clusterrolebinding.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : secret-reader subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u70ba jenkins \u5e95\u4e0b\u7684 default name : default namespace : jenkins roleRef : kind : ClusterRole <=== \u7d81\u5b9a ClusterRole name : secret-reader apiGroup : rbac.authorization.k8s.io \u53e6\u5916\uff0c\u4f60\u4e5f\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u4f86\u7d81\u5b9a\uff0c\u4f8b\u5982\u5982\u679c\u60f3\u8981\u5141\u8a31\u4e0a\u9762\u7684 default \u9019\u500b Service Account \u80fd\u5920\u64c1\u6709\u6574\u500b\u53e2\u96c6\u7684\u7ba1\u7406\u6b0a\u9650\uff0c\u6211\u5011\u53ef\u4ee5\u5efa\u7acb\u4e00\u500b ClusterRoleBinding \uff1a $ kubectl create clusterrolebinding jenkins-admin \\ --clusterrole = admin \\ --serviceaccount = jenkins:default clusterrolebinding jenkins-admin \uff1a\u5efa\u7acb\u4e00\u500b ClusterRoleBinding --clusterrole=admin \uff1a\u6307\u5b9a\u6b0a\u9650\u70ba admin --serviceaccount=jenkins:default \uff1a\u7d81\u5b9a jenkins \u7684\u4e0b\u7684 default","title":"RoleBinding vs ClusterRoleBinding"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/","text":"\u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u539f\u6587: https://kartaca.com/en/k3s-kubernetes-cluster-setup-with-k3d/ \u5728\u672c\u6587\u4e2d\uff0c\u5c07\u8a0e\u8ad6\u5982\u4f55\u4f7f\u7528 Rancher \u7684\u5de5\u5177 K3D \u5728\u57fa\u65bc Linux \u7684\u64cd\u4f5c\u7cfb\u7d71\u4e2d\u5275\u5efa Kubernetes \u96c6\u7fa4\u3002 K3S (\u8f15\u91cf\u7d1a Kubernetes) \u00b6 K3S \u662f Rancher \u65bc 2019 \u5e74\u958b\u6e90\u767c\u5e03\u7684\u8f15\u91cf\u7d1a Kubernetes \u767c\u884c\u7248\u3002 K3S \u88ab\u8a2d\u8a08\u70ba 100MB \u4ee5\u4e0b\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u3002\u6b64\u5916\uff0c\u5b83\u662f\u4e00\u500b\u64c1\u6709 CNCF\uff08Cloud Native Computing Foundation\uff09\u8b49\u66f8\u7684 Kubernetes \u5de5\u5177\u3002\u7531\u65bc K3S \u7684\u8f15\u91cf\u7d1a\uff0c\u6211\u5011\u751a\u81f3\u53ef\u4ee5\u5728\u914d\u7f6e\u4f4e\u7684\u7cfb\u7d71\u4e2d\u5b89\u88dd Kubernetes \u96c6\u7fa4\u3002 K3S\u7684\u6700\u4f4e\u7cfb\u7d71\u8981\u6c42\u5982\u4e0b\uff1a Linux 3.10 512MB RAM (server) 75MB RAM (node) 200MB range K3D \u00b6 K3D \u662f\u4e00\u500b\u70ba\u6211\u5011\u63d0\u4f9b\u5feb\u901f\u642d\u5efa Kubernetes \u96c6\u7fa4\u7684\u5de5\u5177\u3002\u5275\u5efa K3D \u7684\u96c6\u7fa4\u662f\u8f15\u91cf\u7d1a\u7684\uff0c\u56e0\u70ba\u5b83\u5011\u57fa\u65bc\u6211\u4e0a\u9762\u63d0\u5230\u7684 K3S\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u4f7f\u7528 K3D\uff0c\u6211\u5011\u53ef\u4ee5\u5feb\u901f\u642d\u5efa\u4e00\u500b K3S \u96c6\u7fa4\uff0c\u7528\u6700\u5c11\u7684\u5de5\u4f5c\u91cf\u548c\u6700\u5c11\u7684\u8cc7\u6e90\u4f7f\u7528\u3002\u6b64\u5916\uff0c\u7531\u65bc K3D \u662f\u8de8\u5e73\u53f0\u7684\uff0c\u5b83\u53ef\u4ee5\u5728 Windows\u3001Mac OS \u548c Linux \u8a2d\u5099\u4e0a\u904b\u884c\uff0c\u4e26\u652f\u6301\u5275\u5efa\u591a\u500b\u96c6\u7fa4\u3002 \u5b89\u88dd \u00b6 Requirements\uff1a Docker Kubectl K3D Docker \u8a2d\u5b9a\u5b89\u88dd \u00b6 \u8981\u5feb\u901f\u5b89\u88dd Docker\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Rancher \u6e96\u5099\u7684\u8173\u672c\u548c\u6211\u5728\u4e0b\u9762\u7d66\u51fa\u7684\u547d\u4ee4\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167\u9069\u5408\u4f60\u5c07\u8981\u5b89\u88dd\u7684\u74b0\u5883\u7684\u5b89\u88dd\u6b65\u9a5f\u5f9e\u9019\u500b\u5730\u5740\u5b89\u88dd\u3002 [ Rancher Script ] $ curl https://releases.rancher.com/install-docker/19.03.sh | sh Kubectl \u8a2d\u5b9a\u5b89\u88dd \u00b6 \u60a8\u9700\u8981\u8a2d\u7f6e Kubectl \u4ee5\u8207 Kubernetes API \u901a\u4fe1\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u8f15\u9b06\u5b8c\u6210\u6b64\u64cd\u4f5c\u3002 $ curl -LO \"https://storage.googleapis.com/kubernetes-release/release/ $( curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ) /bin/linux/amd64/kubectl\" $ chmod +x ./kubectl $ sudo mv ./kubectl /usr/local/bin/kubectl \u5728\u5b89\u88dd\u5b8c\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9032\u884c Kubectl \u7248\u672c\u6aa2\u67e5\u3002 $ kubectl version --client K3D \u8a2d\u5b9a\u5b89\u88dd \u00b6 K3D \u8a2d\u7f6e\u975e\u5e38\u7c21\u55ae\uff0c\u60a8\u552f\u4e00\u9700\u8981\u505a\u7684\u5c31\u662f\u5728\u7d42\u7aef\u8f38\u5165\u4ee5\u4e0b\u547d\u4ee4\u3002\u5982\u679c\u60a8\u9858\u610f\uff0c\u53ef\u4ee5\u6839\u64da\u60a8\u7684\u74b0\u5883\u5f9e\u6b64\u5730\u5740\u9032\u884c\u8a2d\u7f6e\u6b65\u9a5f\u3002 $ wget -q -O - https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash \u60a8\u53ef\u4ee5\u901a\u904e\u7248\u672c\u6aa2\u67e5\u4f86\u9a57\u8b49\u60a8\u7684\u8a2d\u7f6e\uff0c\u70ba\u6b64\u60a8\u9700\u8981\u5728\u7d42\u7aef\u4e2d\u8f38\u5165\u4ee5\u4e0b\u6307\u4ee4\u3002 $ k3d --version K3D \u6307\u4ee4 \u00b6 K3D \u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u7684\u6307\u4ee4\u4f86\u5e6b\u52a9\u6211\u5011\u63a7\u5236 Kubernetes \u96c6\u7fa4\u7684\u76f8\u95dc\u8a2d\u5b9a\u8207\u64cd\u4f5c\u3002 $ k3d Usage: k3d [ flags ] k3d [ command ] Available Commands: cluster Manage cluster ( s ) completion Generate completion scripts for [ bash, zsh, fish, powershell | psh ] config Work with config file ( s ) help Help about any command image Handle container images. kubeconfig Manage kubeconfig ( s ) node Manage node ( s ) registry Manage registry/registries version Show k3d and default k3s version Flags: -h, --help help for k3d --timestamps Enable Log timestamps --trace Enable super verbose output ( trace logging ) --verbose Enable verbose output ( debug logging ) --version Show k3d and default k3s version Use \"k3d [command] --help\" for more information about a command. \u4f7f\u7528 k3d cluster \u547d\u4ee4: create \u5275\u5efa\u4e00\u500b\u65b0\u96c6\u7fa4 delete \u522a\u9664\u96c6\u7fa4\u3002 edit [EXPERIMENTAL] \u7de8\u8f2f\u96c6\u7fa4\u3002 list \u5217\u51fa\u96c6\u7fa4 start \u555f\u52d5\u73fe\u6709\u7684 k3d \u96c6\u7fa4 stop \u505c\u6b62\u73fe\u6709\u7684 k3d \u96c6\u7fa4 \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u73fe\u5728\u6211\u5011\u53ef\u4ee5\u7e7c\u7e8c\u9032\u884c\u96c6\u7fa4\u8a2d\u7f6e\u3002\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u540d\u7a31\u5275\u5efa\u96c6\u7fa4\u3002 $ k3d cluster create [ NAME ] \u7531\u65bc\u5b83\u5728\u7b2c\u4e00\u6b21\u5b89\u88dd\u6642\u6703\u4e0b\u8f09\u5927\u7d04 150\u2013200MB \u7684 docker \u6620\u50cf\uff0c\u56e0\u6b64\u5b89\u88dd\u6642\u9593\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7684\u4e92\u806f\u7db2\u901f\u5ea6\uff0c\u4f46\u9664\u975e\u60a8\u522a\u9664\u9019\u4e9b\u6620\u50cf\uff0c\u5426\u5247\u60a8\u7684\u4e0b\u4e00\u6b21\u96c6\u7fa4\u5b89\u88dd\u5c07\u82b1\u8cbb\u66f4\u5c11\u7684\u6642\u9593\u3002 INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .27.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u4f7f\u7528 k3d cluster list \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u5df2\u5275\u5efa\u7684\u96c6\u7fa4\u53ca\u5176\u72c0\u614b\u3002 $ k3d cluster list NAME SERVERS AGENTS LOADBALANCER k3s-default 1 /1 0 /0 true \u5982\u679c\u60a8\u6309\u7167\u9019\u4e9b\u6b65\u9a5f\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd K3D \u4e26\u5728\u6b64\u74b0\u5883\u4e2d\u5275\u5efa\u96c6\u7fa4\uff0c\u5247\u5728\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u6642\u7121\u6cd5\u8a2a\u554f\u6b64\u61c9\u7528\u7a0b\u5e8f\u3002\u56e0\u70ba\u6211\u5011\u4e0d\u5141\u8a31\u4efb\u4f55\u7aef\u53e3\uff0c\u6240\u4ee5\u53ea\u80fd\u5f9e\u96c6\u7fa4\u5167\u90e8\u8a2a\u554f\u5b83\u3002 \u5728\u4e0b\u4e00\u6b65\u4e2d\uff0c\u6211\u5c07\u8a0e\u8ad6\u5982\u4f55\u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 # Deletes all clusters $ k3d cluster delete -a # Deletes specified cluster $ k3d cluster delete [ name ] \u670d\u52d9\u66b4\u9732 \u00b6 \u5728\u4f7f\u7528 K3D \u6642\uff0c\u6211\u5011\u9700\u8981\u9810\u5148\u6253\u958b\u4e00\u500b\u7aef\u53e3\uff0c\u4f46\u5b83\u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u5f88\u591a\u65b9\u6cd5\u3002\u6211\u5011\u53ef\u4ee5\u4f5c\u70ba node-port \u6216\u901a\u904e Load Balancer \u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 K3D \u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e \u00b6 K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer Info the port-mapping construct 8081:80 @loadbalancer means: \u201cmap port 8081 from the host to port 80 on the container which matches the nodefilter loadbalancer\u201c \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u5275\u5efa\u7684\u90e8\u7f72\u3002 $ kubectl create service clusterip nginx --tcp = 80 :80 \u6aa2\u67e5\u7d50\u679c: $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 88s nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 15s \u6210\u529f\u5275\u5efa\u670d\u52d9\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u8a2d\u7f6e\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u73fe\u5728\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u540d\u70ba demo-ingress.yaml \u7684\u6587\u4ef6\u4e26\u7de8\u8f2f\u5176\u5167\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u8a73\u7d30\u7684 ingress \u8a2d\u5b9a\u898f\u5247\u898b: Kubernetes - Ingress demo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"false\" spec : rules : - http : paths : - path : / pathType : Prefix backend : service : name : nginx port : number : 80 \u5728 Kubernetes \u4e0a\u90e8\u7f72 ingress: $ kubectl create -f demo-ingress.yaml \u9019\u6a23\uff0c\u6211\u5011\u5c31\u5b8c\u6210\u4e86\u525b\u525b\u5275\u5efa\u7684\u6f14\u793a nginx \u61c9\u7528\u7684\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u4f7f\u7528 kubectl get pod,svc,ing \u547d\u4ee4\u5275\u5efa\u7684 Kubernetes \u5c0d\u8c61\u3002 $ kubectl get pod,svc,ing NAME READY STATUS RESTARTS AGE pod/nginx-7848d4b86f-xdbfx 1 /1 Running 0 111s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 2m37s service/nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 84s NAME CLASS HOSTS ADDRESS PORTS AGE ingress.networking.k8s.io/nginx <none> * 172 .31.0.2 80 21s \u5982\u679c\u60a8\u6709\u4e0a\u8ff0\u8f38\u51fa\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u5982\u679c\u60a8\u5728\u81ea\u5df1\u7684\u8a08\u7b97\u6a5f\u4e0a\u4f7f\u7528 localhost \u5b8c\u6210\u4e86\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8a2a\u554f nginx \u9801\u9762\uff0c\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b8c\u6210\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u9a57\u8b49\u5b89\u88dd\u3002 $ curl localhost:8081/ K3D NodePort \u8a2d\u7f6e \u00b6 K3D \u9700\u8981\u986f\u793a\u5730\u544a\u8a34\u5b83\u6253\u958b\u67d0\u500b\u7aef\u53e3\u7bc4\u570d\u3002\u8b93\u6211\u7e7c\u7e8c\u4e0b\u9762\u7684\u4f8b\u5b50\u3002 $ k3d cluster create --agents 1 -p 30000-30010:30000-30010@agent:0 -p 8081:80@loadbalancer \u6211\u5011\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e86\u4e00\u500b\u65b0\u53c3\u6578\u3002 Docker \u7528\u6236\u7d93\u5e38\u4f7f\u7528\u201c-p\u201d\uff08\u767c\u5e03\uff09\u53c3\u6578\u3002\u6709\u4e86\u9019\u500b\u53c3\u6578\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6253\u958b\u4e3b\u6a5f\u5bb9\u5668\u7aef\u53e3\u4e86\u3002\u6211\u5011\u5728\u4e0a\u9762\u505a\u4e86\u9019\u500b\uff0c\u5728\u4e3b\u6a5f\u7aef\u548c\u5bb9\u5668\u7aef\u90fd\u6253\u958b\u4e86 30000-30010 \u7aef\u53e3\u7bc4\u570d\u3002(Kubernetes default node port range: 30000\u201332767) Info \u6ce8\u610f\uff1a\u6211\u4e0d\u5efa\u8b70\u914d\u7f6e\u7cfb\u7d71\u6253\u958b 30000-32767 \u7bc4\u570d\uff0c\u56e0\u70ba\u6253\u958b\u7aef\u53e3\u6642 RAM \u4f7f\u7528\u91cf\u6703\u986f\u8457\u589e\u52a0\u3002 \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u4f7f\u7528 nodeport \u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u90e8\u7f72\u7684 nginx \u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba demo-nodeport.yaml \u7684\u6587\u4ef6\u4e26\u6dfb\u52a0\u4ee5\u4e0b\u884c\u4e26\u4fdd\u5b58\u5b83\u3002 demo-nodeport.yaml apiVersion : v1 kind : Service metadata : labels : app : nginx name : nginx spec : ports : - name : 80-80 nodePort : 30008 port : 80 protocol : TCP targetPort : 80 selector : app : nginx type : NodePort \u5728 Kubernetes \u4e0a\u90e8\u7f72 service: $ kubectl create -f demo-nodeport.yaml \u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8207 nodeport \u6240\u6620\u5c04\u7684\u7aef\u53e3\u4f86\u8a2a\u554f nginx \u9801\u9762\u3002 $ curl localhost:30008/","title":"\u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d-kubernetes","text":"\u539f\u6587: https://kartaca.com/en/k3s-kubernetes-cluster-setup-with-k3d/ \u5728\u672c\u6587\u4e2d\uff0c\u5c07\u8a0e\u8ad6\u5982\u4f55\u4f7f\u7528 Rancher \u7684\u5de5\u5177 K3D \u5728\u57fa\u65bc Linux \u7684\u64cd\u4f5c\u7cfb\u7d71\u4e2d\u5275\u5efa Kubernetes \u96c6\u7fa4\u3002","title":"\u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3s-kubernetes","text":"K3S \u662f Rancher \u65bc 2019 \u5e74\u958b\u6e90\u767c\u5e03\u7684\u8f15\u91cf\u7d1a Kubernetes \u767c\u884c\u7248\u3002 K3S \u88ab\u8a2d\u8a08\u70ba 100MB \u4ee5\u4e0b\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u3002\u6b64\u5916\uff0c\u5b83\u662f\u4e00\u500b\u64c1\u6709 CNCF\uff08Cloud Native Computing Foundation\uff09\u8b49\u66f8\u7684 Kubernetes \u5de5\u5177\u3002\u7531\u65bc K3S \u7684\u8f15\u91cf\u7d1a\uff0c\u6211\u5011\u751a\u81f3\u53ef\u4ee5\u5728\u914d\u7f6e\u4f4e\u7684\u7cfb\u7d71\u4e2d\u5b89\u88dd Kubernetes \u96c6\u7fa4\u3002 K3S\u7684\u6700\u4f4e\u7cfb\u7d71\u8981\u6c42\u5982\u4e0b\uff1a Linux 3.10 512MB RAM (server) 75MB RAM (node) 200MB range","title":"K3S (\u8f15\u91cf\u7d1a Kubernetes)"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d","text":"K3D \u662f\u4e00\u500b\u70ba\u6211\u5011\u63d0\u4f9b\u5feb\u901f\u642d\u5efa Kubernetes \u96c6\u7fa4\u7684\u5de5\u5177\u3002\u5275\u5efa K3D \u7684\u96c6\u7fa4\u662f\u8f15\u91cf\u7d1a\u7684\uff0c\u56e0\u70ba\u5b83\u5011\u57fa\u65bc\u6211\u4e0a\u9762\u63d0\u5230\u7684 K3S\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u4f7f\u7528 K3D\uff0c\u6211\u5011\u53ef\u4ee5\u5feb\u901f\u642d\u5efa\u4e00\u500b K3S \u96c6\u7fa4\uff0c\u7528\u6700\u5c11\u7684\u5de5\u4f5c\u91cf\u548c\u6700\u5c11\u7684\u8cc7\u6e90\u4f7f\u7528\u3002\u6b64\u5916\uff0c\u7531\u65bc K3D \u662f\u8de8\u5e73\u53f0\u7684\uff0c\u5b83\u53ef\u4ee5\u5728 Windows\u3001Mac OS \u548c Linux \u8a2d\u5099\u4e0a\u904b\u884c\uff0c\u4e26\u652f\u6301\u5275\u5efa\u591a\u500b\u96c6\u7fa4\u3002","title":"K3D"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#_1","text":"Requirements\uff1a Docker Kubectl K3D","title":"\u5b89\u88dd"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#docker","text":"\u8981\u5feb\u901f\u5b89\u88dd Docker\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Rancher \u6e96\u5099\u7684\u8173\u672c\u548c\u6211\u5728\u4e0b\u9762\u7d66\u51fa\u7684\u547d\u4ee4\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167\u9069\u5408\u4f60\u5c07\u8981\u5b89\u88dd\u7684\u74b0\u5883\u7684\u5b89\u88dd\u6b65\u9a5f\u5f9e\u9019\u500b\u5730\u5740\u5b89\u88dd\u3002 [ Rancher Script ] $ curl https://releases.rancher.com/install-docker/19.03.sh | sh","title":"Docker \u8a2d\u5b9a\u5b89\u88dd"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#kubectl","text":"\u60a8\u9700\u8981\u8a2d\u7f6e Kubectl \u4ee5\u8207 Kubernetes API \u901a\u4fe1\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u8f15\u9b06\u5b8c\u6210\u6b64\u64cd\u4f5c\u3002 $ curl -LO \"https://storage.googleapis.com/kubernetes-release/release/ $( curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ) /bin/linux/amd64/kubectl\" $ chmod +x ./kubectl $ sudo mv ./kubectl /usr/local/bin/kubectl \u5728\u5b89\u88dd\u5b8c\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9032\u884c Kubectl \u7248\u672c\u6aa2\u67e5\u3002 $ kubectl version --client","title":"Kubectl \u8a2d\u5b9a\u5b89\u88dd"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d_1","text":"K3D \u8a2d\u7f6e\u975e\u5e38\u7c21\u55ae\uff0c\u60a8\u552f\u4e00\u9700\u8981\u505a\u7684\u5c31\u662f\u5728\u7d42\u7aef\u8f38\u5165\u4ee5\u4e0b\u547d\u4ee4\u3002\u5982\u679c\u60a8\u9858\u610f\uff0c\u53ef\u4ee5\u6839\u64da\u60a8\u7684\u74b0\u5883\u5f9e\u6b64\u5730\u5740\u9032\u884c\u8a2d\u7f6e\u6b65\u9a5f\u3002 $ wget -q -O - https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash \u60a8\u53ef\u4ee5\u901a\u904e\u7248\u672c\u6aa2\u67e5\u4f86\u9a57\u8b49\u60a8\u7684\u8a2d\u7f6e\uff0c\u70ba\u6b64\u60a8\u9700\u8981\u5728\u7d42\u7aef\u4e2d\u8f38\u5165\u4ee5\u4e0b\u6307\u4ee4\u3002 $ k3d --version","title":"K3D \u8a2d\u5b9a\u5b89\u88dd"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d_2","text":"K3D \u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u7684\u6307\u4ee4\u4f86\u5e6b\u52a9\u6211\u5011\u63a7\u5236 Kubernetes \u96c6\u7fa4\u7684\u76f8\u95dc\u8a2d\u5b9a\u8207\u64cd\u4f5c\u3002 $ k3d Usage: k3d [ flags ] k3d [ command ] Available Commands: cluster Manage cluster ( s ) completion Generate completion scripts for [ bash, zsh, fish, powershell | psh ] config Work with config file ( s ) help Help about any command image Handle container images. kubeconfig Manage kubeconfig ( s ) node Manage node ( s ) registry Manage registry/registries version Show k3d and default k3s version Flags: -h, --help help for k3d --timestamps Enable Log timestamps --trace Enable super verbose output ( trace logging ) --verbose Enable verbose output ( debug logging ) --version Show k3d and default k3s version Use \"k3d [command] --help\" for more information about a command. \u4f7f\u7528 k3d cluster \u547d\u4ee4: create \u5275\u5efa\u4e00\u500b\u65b0\u96c6\u7fa4 delete \u522a\u9664\u96c6\u7fa4\u3002 edit [EXPERIMENTAL] \u7de8\u8f2f\u96c6\u7fa4\u3002 list \u5217\u51fa\u96c6\u7fa4 start \u555f\u52d5\u73fe\u6709\u7684 k3d \u96c6\u7fa4 stop \u505c\u6b62\u73fe\u6709\u7684 k3d \u96c6\u7fa4","title":"K3D \u6307\u4ee4"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#kubernetes","text":"\u73fe\u5728\u6211\u5011\u53ef\u4ee5\u7e7c\u7e8c\u9032\u884c\u96c6\u7fa4\u8a2d\u7f6e\u3002\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u540d\u7a31\u5275\u5efa\u96c6\u7fa4\u3002 $ k3d cluster create [ NAME ] \u7531\u65bc\u5b83\u5728\u7b2c\u4e00\u6b21\u5b89\u88dd\u6642\u6703\u4e0b\u8f09\u5927\u7d04 150\u2013200MB \u7684 docker \u6620\u50cf\uff0c\u56e0\u6b64\u5b89\u88dd\u6642\u9593\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7684\u4e92\u806f\u7db2\u901f\u5ea6\uff0c\u4f46\u9664\u975e\u60a8\u522a\u9664\u9019\u4e9b\u6620\u50cf\uff0c\u5426\u5247\u60a8\u7684\u4e0b\u4e00\u6b21\u96c6\u7fa4\u5b89\u88dd\u5c07\u82b1\u8cbb\u66f4\u5c11\u7684\u6642\u9593\u3002 INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .27.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u4f7f\u7528 k3d cluster list \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u5df2\u5275\u5efa\u7684\u96c6\u7fa4\u53ca\u5176\u72c0\u614b\u3002 $ k3d cluster list NAME SERVERS AGENTS LOADBALANCER k3s-default 1 /1 0 /0 true \u5982\u679c\u60a8\u6309\u7167\u9019\u4e9b\u6b65\u9a5f\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd K3D \u4e26\u5728\u6b64\u74b0\u5883\u4e2d\u5275\u5efa\u96c6\u7fa4\uff0c\u5247\u5728\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u6642\u7121\u6cd5\u8a2a\u554f\u6b64\u61c9\u7528\u7a0b\u5e8f\u3002\u56e0\u70ba\u6211\u5011\u4e0d\u5141\u8a31\u4efb\u4f55\u7aef\u53e3\uff0c\u6240\u4ee5\u53ea\u80fd\u5f9e\u96c6\u7fa4\u5167\u90e8\u8a2a\u554f\u5b83\u3002 \u5728\u4e0b\u4e00\u6b65\u4e2d\uff0c\u6211\u5c07\u8a0e\u8ad6\u5982\u4f55\u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 # Deletes all clusters $ k3d cluster delete -a # Deletes specified cluster $ k3d cluster delete [ name ]","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#_2","text":"\u5728\u4f7f\u7528 K3D \u6642\uff0c\u6211\u5011\u9700\u8981\u9810\u5148\u6253\u958b\u4e00\u500b\u7aef\u53e3\uff0c\u4f46\u5b83\u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u5f88\u591a\u65b9\u6cd5\u3002\u6211\u5011\u53ef\u4ee5\u4f5c\u70ba node-port \u6216\u901a\u904e Load Balancer \u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002","title":"\u670d\u52d9\u66b4\u9732"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d_3","text":"K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer Info the port-mapping construct 8081:80 @loadbalancer means: \u201cmap port 8081 from the host to port 80 on the container which matches the nodefilter loadbalancer\u201c \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u5275\u5efa\u7684\u90e8\u7f72\u3002 $ kubectl create service clusterip nginx --tcp = 80 :80 \u6aa2\u67e5\u7d50\u679c: $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 88s nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 15s \u6210\u529f\u5275\u5efa\u670d\u52d9\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u8a2d\u7f6e\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u73fe\u5728\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u540d\u70ba demo-ingress.yaml \u7684\u6587\u4ef6\u4e26\u7de8\u8f2f\u5176\u5167\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u8a73\u7d30\u7684 ingress \u8a2d\u5b9a\u898f\u5247\u898b: Kubernetes - Ingress demo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"false\" spec : rules : - http : paths : - path : / pathType : Prefix backend : service : name : nginx port : number : 80 \u5728 Kubernetes \u4e0a\u90e8\u7f72 ingress: $ kubectl create -f demo-ingress.yaml \u9019\u6a23\uff0c\u6211\u5011\u5c31\u5b8c\u6210\u4e86\u525b\u525b\u5275\u5efa\u7684\u6f14\u793a nginx \u61c9\u7528\u7684\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u4f7f\u7528 kubectl get pod,svc,ing \u547d\u4ee4\u5275\u5efa\u7684 Kubernetes \u5c0d\u8c61\u3002 $ kubectl get pod,svc,ing NAME READY STATUS RESTARTS AGE pod/nginx-7848d4b86f-xdbfx 1 /1 Running 0 111s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 2m37s service/nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 84s NAME CLASS HOSTS ADDRESS PORTS AGE ingress.networking.k8s.io/nginx <none> * 172 .31.0.2 80 21s \u5982\u679c\u60a8\u6709\u4e0a\u8ff0\u8f38\u51fa\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u5982\u679c\u60a8\u5728\u81ea\u5df1\u7684\u8a08\u7b97\u6a5f\u4e0a\u4f7f\u7528 localhost \u5b8c\u6210\u4e86\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8a2a\u554f nginx \u9801\u9762\uff0c\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b8c\u6210\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u9a57\u8b49\u5b89\u88dd\u3002 $ curl localhost:8081/","title":"K3D \u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e"},{"location":"kubernetes/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d-nodeport","text":"K3D \u9700\u8981\u986f\u793a\u5730\u544a\u8a34\u5b83\u6253\u958b\u67d0\u500b\u7aef\u53e3\u7bc4\u570d\u3002\u8b93\u6211\u7e7c\u7e8c\u4e0b\u9762\u7684\u4f8b\u5b50\u3002 $ k3d cluster create --agents 1 -p 30000-30010:30000-30010@agent:0 -p 8081:80@loadbalancer \u6211\u5011\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e86\u4e00\u500b\u65b0\u53c3\u6578\u3002 Docker \u7528\u6236\u7d93\u5e38\u4f7f\u7528\u201c-p\u201d\uff08\u767c\u5e03\uff09\u53c3\u6578\u3002\u6709\u4e86\u9019\u500b\u53c3\u6578\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6253\u958b\u4e3b\u6a5f\u5bb9\u5668\u7aef\u53e3\u4e86\u3002\u6211\u5011\u5728\u4e0a\u9762\u505a\u4e86\u9019\u500b\uff0c\u5728\u4e3b\u6a5f\u7aef\u548c\u5bb9\u5668\u7aef\u90fd\u6253\u958b\u4e86 30000-30010 \u7aef\u53e3\u7bc4\u570d\u3002(Kubernetes default node port range: 30000\u201332767) Info \u6ce8\u610f\uff1a\u6211\u4e0d\u5efa\u8b70\u914d\u7f6e\u7cfb\u7d71\u6253\u958b 30000-32767 \u7bc4\u570d\uff0c\u56e0\u70ba\u6253\u958b\u7aef\u53e3\u6642 RAM \u4f7f\u7528\u91cf\u6703\u986f\u8457\u589e\u52a0\u3002 \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u4f7f\u7528 nodeport \u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u90e8\u7f72\u7684 nginx \u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba demo-nodeport.yaml \u7684\u6587\u4ef6\u4e26\u6dfb\u52a0\u4ee5\u4e0b\u884c\u4e26\u4fdd\u5b58\u5b83\u3002 demo-nodeport.yaml apiVersion : v1 kind : Service metadata : labels : app : nginx name : nginx spec : ports : - name : 80-80 nodePort : 30008 port : 80 protocol : TCP targetPort : 80 selector : app : nginx type : NodePort \u5728 Kubernetes \u4e0a\u90e8\u7f72 service: $ kubectl create -f demo-nodeport.yaml \u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8207 nodeport \u6240\u6620\u5c04\u7684\u7aef\u53e3\u4f86\u8a2a\u554f nginx \u9801\u9762\u3002 $ curl localhost:30008/","title":"K3D NodePort \u8a2d\u7f6e"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube \u00b6 \u539f\u6587: https://www.linuxbuzz.com/how-to-install-minikube-on-ubuntu/ Minikube \u662f\u55ae\u7bc0\u9ede Kubernetes (k8s) \u96c6\u7fa4\uff0c\u53ef\u4ee5\u5b89\u88dd\u5728\u865b\u64ec\u6a5f\u4e2d\u3002\u5b83\u4e00\u822c\u7528\u65bc\u6e2c\u8a66\u548c\u958b\u767c\u74b0\u5883\u3002\u4efb\u4f55\u525b\u63a5\u89f8 Kubernetes \u4e26\u60f3\u5b78\u7fd2\u5b83\u7684\u4eba\u90fd\u5efa\u8b70\u4f7f\u7528 minikube\u3002\u56e0\u70ba\u5b83\u53ef\u4ee5\u975e\u5e38\u5bb9\u6613\u5730\u90e8\u7f72\u5728\u5e7e\u4e4e\u6240\u6709\u7684 Linux \u767c\u884c\u7248\u4e0a\uff0c\u6bd4\u5982 Ubuntu\u3001RHEL\u3001CentOS \u548c Debian\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u5728 Ubuntu 22.04 (Jammy Jellyfish) \u548c Ubuntu 20.04 (Focal Fossa) LTS \u4e0a\u5b89\u88dd Minikube\u3002 ubuntu \u7248\u672c\u4e0a\u7684\u6b65\u9a5f\u662f\u76f8\u540c\u7684\u3002 \u6700\u4f4e\u7cfb\u7d71\u8981\u6c42 \u00b6 2GB RAM \u6216\u66f4\u591a 2\u500bCPU\u6838\u5fc3\u6216\u66f4\u591a 20 GB \u786c\u76e4\u6216\u66f4\u591a \u5177\u6709 Sudo \u6b0a\u9650\u7684\u7528\u6236 Docker \u6216 VirtualBox \u6216 KVM \u7a69\u5b9a\u7684\u4e92\u806f\u7db2\u9023\u63a5 (internet connection) \u8b93\u6211\u5011\u6df1\u5165\u4e86\u89e3 Minikube \u7684\u5b89\u88dd\u6b65\u9a5f\u3002 1. \u5b89\u88dd Minikube \u5305\u4f9d\u8cf4\u9805 \u00b6 \u767b\u9304\u5230\u60a8\u7684 Ubuntu 22.04 / Ubuntu 20.04 \u7cfb\u7d71\u4e26\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u5b89\u88dd minikube \u5305\u4f9d\u8cf4\u9805\u3002 $ sudo apt update $ sudo apt install curl wget apt-transport-https -y Info \u6ce8\u610f\uff1a\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u4f7f\u7528 docker \u4f5c\u70ba Minikube \u7684\u57fa\u790e\uff0c\u4e26\u5047\u8a2d\u60a8\u7684\u7cfb\u7d71\u4e0a\u5df2\u7d93\u5b89\u88dd\u4e86\u5b83\u3002\u5982\u679c\u672a\u5b89\u88dd\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b\u5167\u5bb9\uff1a How to Install Docker on Ubuntu 22.04 / Ubuntu 20.04 LTS 2. \u4f7f\u7528 wget \u4e0b\u8f09 Minikube \u4e8c\u9032\u88fd\u6587\u4ef6 \u00b6 \u5728 wget \u547d\u4ee4\u4e0b\u904b\u884c\u4ee5\u4e0b\u8f09 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\uff0c $ wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \u4f7f\u7528 cp \u547d\u4ee4\u5c07\u4e0b\u8f09\u7684 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\u8907\u88fd\u5230 /usr/local/bin \u4e26\u4e0d\u8981\u5fd8\u8a18\u70ba\u5176\u8a2d\u7f6e\u53ef\u57f7\u884c\u6b0a\u9650\u3002 $ sudo cp minikube-linux-amd64 /usr/local/bin/minikube $ sudo chmod +x /usr/local/bin/minikube \u904b\u884c\u67e5\u770bminikube\u7248\u672c\uff0c $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7 3. \u4e0b\u8f09 kubectl \u00b6 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c CLI\uff0c\u7528\u65bc\u8207 Kubernetes \u96c6\u7fa4\u4ea4\u4e92\u3002\u4f7f\u7528 kubectl \u6211\u5011\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e0d\u540c\u7684\u8cc7\u6e90\u3002 \u8981\u4e0b\u8f09\u4e26\u5b89\u88dd kubectl \uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b wget \u547d\u4ee4\uff0c $ curl -LO https://storage.googleapis.com/kubernetes-release/release/ ` curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ` /bin/linux/amd64/kubectl \u5c07 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u79fb\u52d5\u5230 /usr/local/bin \u4e26\u5c0d\u5176\u8a2d\u7f6e\u57f7\u884c\u6b0a\u9650\u3002 $ chmod +x kubectl $ sudo mv kubectl /usr/local/bin/ \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9a57\u8b49 kubectl \u7248\u672c\uff0c $ kubectl version 4. \u4f7f\u7528 Docker \u9a45\u52d5\u7a0b\u5e8f\u555f\u52d5 Minikube \u00b6 \u7531\u65bc\u6211\u5011\u4f7f\u7528 docker \u4f5c\u70ba minikube \u7684\u57fa\u790e\uff0c\u6240\u4ee5\u904b\u884c\u4ee5\u4e0b minikube \u547d\u4ee4\u4f86\u555f\u52d5\u5b83\u3002 $ minikube start --driver = docker \u7d50\u679c: \ud83d\ude04 minikube v1.25.2 on Ubuntu 21.10 \u2728 Using the docker driver based on user configuration \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udcbe Downloading Kubernetes v1.23.3 preload ... > preloaded-images-k8s-v17-v1...: 505.68 MiB / 505.68 MiB 100.00% 11.91 Mi > gcr.io/k8s-minikube/kicbase: 379.06 MiB / 379.06 MiB 100.00% 8.14 MiB p/ \ud83d\udd25 Creating docker container (CPUs=2, Memory=3900MB) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20.10.12 ... \u25aa kubelet.housekeeping-interval=5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u592a\u597d\u4e86\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d minikube \u5df2\u6210\u529f\u555f\u52d5\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u60f3\u5728\u555f\u52d5 minikube \u6642\u50b3\u905e\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u53c3\u6578\uff0c\u8acb\u4f7f\u7528\u4e0b\u9762\u7684\u7bc4\u4f8b: $ minikube start --addons = ingress --cpus = 4 --cni = flannel --install-addons = true --kubernetes-version = stable --memory = 6g 5. \u9a57\u8b49 Minikube \u548c Kubernetes \u96c6\u7fa4\u72c0\u614b \u00b6 \u8981\u9a57\u8b49 minikube \u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured 6. \u5728 Minikube \u4e0a\u555f\u7528\u63d2\u4ef6 \u00b6 \u7576\u6211\u5011\u5b89\u88dd minikube \u6642\uff0c\u53ea\u555f\u7528\u4e86\u5e7e\u500b\u63d2\u4ef6\u3002\u8981\u67e5\u770b\u6240\u6709\u63d2\u4ef6\u53ca\u5176\u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube addons list | ----------------------------- | ---------- | -------------- | -------------------------------- | | ADDON NAME | PROFILE | STATUS | MAINTAINER | | ----------------------------- | ---------- | -------------- | -------------------------------- | | ambassador | minikube | disabled | third-party ( ambassador ) | | auto-pause | minikube | disabled | google | | csi-hostpath-driver | minikube | disabled | kubernetes | | dashboard | minikube | disabled | kubernetes | | default-storageclass | minikube | enabled \u2705 | kubernetes | | efk | minikube | disabled | third-party ( elastic ) | | freshpod | minikube | disabled | google | | gcp-auth | minikube | disabled | google | | gvisor | minikube | disabled | google | | helm-tiller | minikube | disabled | third-party ( helm ) | | ingress | minikube | disabled | unknown ( third-party ) | | ingress-dns | minikube | disabled | google | | istio | minikube | disabled | third-party ( istio ) | | istio-provisioner | minikube | disabled | third-party ( istio ) | | kong | minikube | disabled | third-party ( Kong HQ ) | | kubevirt | minikube | disabled | third-party ( kubevirt ) | | logviewer | minikube | disabled | unknown ( third-party ) | | metallb | minikube | disabled | third-party ( metallb ) | | metrics-server | minikube | disabled | kubernetes | | nvidia-driver-installer | minikube | disabled | google | | nvidia-gpu-device-plugin | minikube | disabled | third-party ( nvidia ) | | olm | minikube | disabled | third-party ( operator | | | | | framework ) | | pod-security-policy | minikube | disabled | unknown ( third-party ) | | portainer | minikube | disabled | portainer.io | | registry | minikube | disabled | google | | registry-aliases | minikube | disabled | unknown ( third-party ) | | registry-creds | minikube | disabled | third-party ( upmc enterprises ) | | storage-provisioner | minikube | enabled \u2705 | google | | storage-provisioner-gluster | minikube | disabled | unknown ( third-party ) | | volumesnapshots | minikube | disabled | kubernetes | | ----------------------------- | ---------- | -------------- | -------------------------------- | \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable ingress \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f The 'ingress' addon is enabled \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable dashboard \u25aa Using image kubernetesui/metrics-scraper:v1.0.7 \u25aa Using image kubernetesui/dashboard:v2.3.1 \ud83d\udca1 Some dashboard features require the metrics-server addon. To enable all features please run: minikube addons enable metrics-server \ud83c\udf1f The 'dashboard' addon is enabled 7. \u6e2c\u8a66 Kubernetes \u96c6\u7fa4 \u00b6 \u8981\u6e2c\u8a66 Kubernetes \u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u90e8\u7f72\u57fa\u65bc nginx \u7684\u90e8\u7f72\uff0c $ kubectl create deployment myapp --image = nginx --replicas = 2 $ kubectl get deployment myapp NAME READY UP-TO-DATE AVAILABLE AGE myapp 2 /2 2 2 30s \u901a\u904e\u516c\u958b\u90e8\u7f72\u5275\u5efa\u670d\u52d9 $ kubectl expose deployment myapp --type = NodePort --port = 80 service/myapp exposed \u901a\u904e\u904b\u884c\u7372\u53d6\u670d\u52d9 url $ minikube service myapp --url http://192.168.49.2:31258 \u73fe\u5728\u5617\u8a66\u4f7f\u7528 URL \u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff0c $ curl http://192.168.49.2:31258 \u5b8c\u7f8e\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d\u6211\u5011\u53ef\u4ee5\u8a2a\u554f nginx \u7db2\u9801\u3002 8. \u8a2a\u554f Kubernetes \u5100\u8868\u677f \u00b6 \u8981\u8a2a\u554f Kubernetes \u5100\u8868\u677f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4 $ minikube dashboard --url \ud83e\udd14 Verifying dashboard health ... \ud83d\ude80 Launching proxy ... \ud83e\udd14 Verifying proxy health ... http://127.0.0.1:44153/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ \u55ae\u64ca\u8f38\u51fa\u4e2d\u986f\u793a\u7684 url\uff0c\u5b83\u5c07\u6253\u958b Kubernetes \u5100\u8868\u677f\uff0c 9. \u7ba1\u7406 Minikube \u96c6\u7fa4 \u00b6 \u8981\u505c\u6b62 minikube\uff0c\u8acb\u904b\u884c $ minikube stop \u8981\u555f\u52d5 minikube\uff0c\u8acb\u904b\u884c $ minikube start \u522a\u9664minikube\u96c6\u7fa4\uff0c\u5148\u505c\u6b62\u518d\u522a\u9664 $ minikube delete","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Minikube"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#ubuntu-2004-lts-minikube","text":"\u539f\u6587: https://www.linuxbuzz.com/how-to-install-minikube-on-ubuntu/ Minikube \u662f\u55ae\u7bc0\u9ede Kubernetes (k8s) \u96c6\u7fa4\uff0c\u53ef\u4ee5\u5b89\u88dd\u5728\u865b\u64ec\u6a5f\u4e2d\u3002\u5b83\u4e00\u822c\u7528\u65bc\u6e2c\u8a66\u548c\u958b\u767c\u74b0\u5883\u3002\u4efb\u4f55\u525b\u63a5\u89f8 Kubernetes \u4e26\u60f3\u5b78\u7fd2\u5b83\u7684\u4eba\u90fd\u5efa\u8b70\u4f7f\u7528 minikube\u3002\u56e0\u70ba\u5b83\u53ef\u4ee5\u975e\u5e38\u5bb9\u6613\u5730\u90e8\u7f72\u5728\u5e7e\u4e4e\u6240\u6709\u7684 Linux \u767c\u884c\u7248\u4e0a\uff0c\u6bd4\u5982 Ubuntu\u3001RHEL\u3001CentOS \u548c Debian\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u5728 Ubuntu 22.04 (Jammy Jellyfish) \u548c Ubuntu 20.04 (Focal Fossa) LTS \u4e0a\u5b89\u88dd Minikube\u3002 ubuntu \u7248\u672c\u4e0a\u7684\u6b65\u9a5f\u662f\u76f8\u540c\u7684\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#_1","text":"2GB RAM \u6216\u66f4\u591a 2\u500bCPU\u6838\u5fc3\u6216\u66f4\u591a 20 GB \u786c\u76e4\u6216\u66f4\u591a \u5177\u6709 Sudo \u6b0a\u9650\u7684\u7528\u6236 Docker \u6216 VirtualBox \u6216 KVM \u7a69\u5b9a\u7684\u4e92\u806f\u7db2\u9023\u63a5 (internet connection) \u8b93\u6211\u5011\u6df1\u5165\u4e86\u89e3 Minikube \u7684\u5b89\u88dd\u6b65\u9a5f\u3002","title":"\u6700\u4f4e\u7cfb\u7d71\u8981\u6c42"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#1-minikube","text":"\u767b\u9304\u5230\u60a8\u7684 Ubuntu 22.04 / Ubuntu 20.04 \u7cfb\u7d71\u4e26\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u5b89\u88dd minikube \u5305\u4f9d\u8cf4\u9805\u3002 $ sudo apt update $ sudo apt install curl wget apt-transport-https -y Info \u6ce8\u610f\uff1a\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u4f7f\u7528 docker \u4f5c\u70ba Minikube \u7684\u57fa\u790e\uff0c\u4e26\u5047\u8a2d\u60a8\u7684\u7cfb\u7d71\u4e0a\u5df2\u7d93\u5b89\u88dd\u4e86\u5b83\u3002\u5982\u679c\u672a\u5b89\u88dd\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b\u5167\u5bb9\uff1a How to Install Docker on Ubuntu 22.04 / Ubuntu 20.04 LTS","title":"1. \u5b89\u88dd Minikube \u5305\u4f9d\u8cf4\u9805"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#2-wget-minikube","text":"\u5728 wget \u547d\u4ee4\u4e0b\u904b\u884c\u4ee5\u4e0b\u8f09 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\uff0c $ wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \u4f7f\u7528 cp \u547d\u4ee4\u5c07\u4e0b\u8f09\u7684 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\u8907\u88fd\u5230 /usr/local/bin \u4e26\u4e0d\u8981\u5fd8\u8a18\u70ba\u5176\u8a2d\u7f6e\u53ef\u57f7\u884c\u6b0a\u9650\u3002 $ sudo cp minikube-linux-amd64 /usr/local/bin/minikube $ sudo chmod +x /usr/local/bin/minikube \u904b\u884c\u67e5\u770bminikube\u7248\u672c\uff0c $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7","title":"2. \u4f7f\u7528 wget \u4e0b\u8f09 Minikube \u4e8c\u9032\u88fd\u6587\u4ef6"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#3-kubectl","text":"kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c CLI\uff0c\u7528\u65bc\u8207 Kubernetes \u96c6\u7fa4\u4ea4\u4e92\u3002\u4f7f\u7528 kubectl \u6211\u5011\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e0d\u540c\u7684\u8cc7\u6e90\u3002 \u8981\u4e0b\u8f09\u4e26\u5b89\u88dd kubectl \uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b wget \u547d\u4ee4\uff0c $ curl -LO https://storage.googleapis.com/kubernetes-release/release/ ` curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ` /bin/linux/amd64/kubectl \u5c07 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u79fb\u52d5\u5230 /usr/local/bin \u4e26\u5c0d\u5176\u8a2d\u7f6e\u57f7\u884c\u6b0a\u9650\u3002 $ chmod +x kubectl $ sudo mv kubectl /usr/local/bin/ \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9a57\u8b49 kubectl \u7248\u672c\uff0c $ kubectl version","title":"3. \u4e0b\u8f09 kubectl"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#4-docker-minikube","text":"\u7531\u65bc\u6211\u5011\u4f7f\u7528 docker \u4f5c\u70ba minikube \u7684\u57fa\u790e\uff0c\u6240\u4ee5\u904b\u884c\u4ee5\u4e0b minikube \u547d\u4ee4\u4f86\u555f\u52d5\u5b83\u3002 $ minikube start --driver = docker \u7d50\u679c: \ud83d\ude04 minikube v1.25.2 on Ubuntu 21.10 \u2728 Using the docker driver based on user configuration \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udcbe Downloading Kubernetes v1.23.3 preload ... > preloaded-images-k8s-v17-v1...: 505.68 MiB / 505.68 MiB 100.00% 11.91 Mi > gcr.io/k8s-minikube/kicbase: 379.06 MiB / 379.06 MiB 100.00% 8.14 MiB p/ \ud83d\udd25 Creating docker container (CPUs=2, Memory=3900MB) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20.10.12 ... \u25aa kubelet.housekeeping-interval=5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u592a\u597d\u4e86\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d minikube \u5df2\u6210\u529f\u555f\u52d5\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u60f3\u5728\u555f\u52d5 minikube \u6642\u50b3\u905e\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u53c3\u6578\uff0c\u8acb\u4f7f\u7528\u4e0b\u9762\u7684\u7bc4\u4f8b: $ minikube start --addons = ingress --cpus = 4 --cni = flannel --install-addons = true --kubernetes-version = stable --memory = 6g","title":"4. \u4f7f\u7528 Docker \u9a45\u52d5\u7a0b\u5e8f\u555f\u52d5 Minikube"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#5-minikube-kubernetes","text":"\u8981\u9a57\u8b49 minikube \u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured","title":"5. \u9a57\u8b49 Minikube \u548c Kubernetes \u96c6\u7fa4\u72c0\u614b"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#6-minikube","text":"\u7576\u6211\u5011\u5b89\u88dd minikube \u6642\uff0c\u53ea\u555f\u7528\u4e86\u5e7e\u500b\u63d2\u4ef6\u3002\u8981\u67e5\u770b\u6240\u6709\u63d2\u4ef6\u53ca\u5176\u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube addons list | ----------------------------- | ---------- | -------------- | -------------------------------- | | ADDON NAME | PROFILE | STATUS | MAINTAINER | | ----------------------------- | ---------- | -------------- | -------------------------------- | | ambassador | minikube | disabled | third-party ( ambassador ) | | auto-pause | minikube | disabled | google | | csi-hostpath-driver | minikube | disabled | kubernetes | | dashboard | minikube | disabled | kubernetes | | default-storageclass | minikube | enabled \u2705 | kubernetes | | efk | minikube | disabled | third-party ( elastic ) | | freshpod | minikube | disabled | google | | gcp-auth | minikube | disabled | google | | gvisor | minikube | disabled | google | | helm-tiller | minikube | disabled | third-party ( helm ) | | ingress | minikube | disabled | unknown ( third-party ) | | ingress-dns | minikube | disabled | google | | istio | minikube | disabled | third-party ( istio ) | | istio-provisioner | minikube | disabled | third-party ( istio ) | | kong | minikube | disabled | third-party ( Kong HQ ) | | kubevirt | minikube | disabled | third-party ( kubevirt ) | | logviewer | minikube | disabled | unknown ( third-party ) | | metallb | minikube | disabled | third-party ( metallb ) | | metrics-server | minikube | disabled | kubernetes | | nvidia-driver-installer | minikube | disabled | google | | nvidia-gpu-device-plugin | minikube | disabled | third-party ( nvidia ) | | olm | minikube | disabled | third-party ( operator | | | | | framework ) | | pod-security-policy | minikube | disabled | unknown ( third-party ) | | portainer | minikube | disabled | portainer.io | | registry | minikube | disabled | google | | registry-aliases | minikube | disabled | unknown ( third-party ) | | registry-creds | minikube | disabled | third-party ( upmc enterprises ) | | storage-provisioner | minikube | enabled \u2705 | google | | storage-provisioner-gluster | minikube | disabled | unknown ( third-party ) | | volumesnapshots | minikube | disabled | kubernetes | | ----------------------------- | ---------- | -------------- | -------------------------------- | \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable ingress \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f The 'ingress' addon is enabled \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable dashboard \u25aa Using image kubernetesui/metrics-scraper:v1.0.7 \u25aa Using image kubernetesui/dashboard:v2.3.1 \ud83d\udca1 Some dashboard features require the metrics-server addon. To enable all features please run: minikube addons enable metrics-server \ud83c\udf1f The 'dashboard' addon is enabled","title":"6. \u5728 Minikube \u4e0a\u555f\u7528\u63d2\u4ef6"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#7-kubernetes","text":"\u8981\u6e2c\u8a66 Kubernetes \u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u90e8\u7f72\u57fa\u65bc nginx \u7684\u90e8\u7f72\uff0c $ kubectl create deployment myapp --image = nginx --replicas = 2 $ kubectl get deployment myapp NAME READY UP-TO-DATE AVAILABLE AGE myapp 2 /2 2 2 30s \u901a\u904e\u516c\u958b\u90e8\u7f72\u5275\u5efa\u670d\u52d9 $ kubectl expose deployment myapp --type = NodePort --port = 80 service/myapp exposed \u901a\u904e\u904b\u884c\u7372\u53d6\u670d\u52d9 url $ minikube service myapp --url http://192.168.49.2:31258 \u73fe\u5728\u5617\u8a66\u4f7f\u7528 URL \u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff0c $ curl http://192.168.49.2:31258 \u5b8c\u7f8e\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d\u6211\u5011\u53ef\u4ee5\u8a2a\u554f nginx \u7db2\u9801\u3002","title":"7. \u6e2c\u8a66 Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#8-kubernetes","text":"\u8981\u8a2a\u554f Kubernetes \u5100\u8868\u677f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4 $ minikube dashboard --url \ud83e\udd14 Verifying dashboard health ... \ud83d\ude80 Launching proxy ... \ud83e\udd14 Verifying proxy health ... http://127.0.0.1:44153/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ \u55ae\u64ca\u8f38\u51fa\u4e2d\u986f\u793a\u7684 url\uff0c\u5b83\u5c07\u6253\u958b Kubernetes \u5100\u8868\u677f\uff0c","title":"8. \u8a2a\u554f Kubernetes \u5100\u8868\u677f"},{"location":"kubernetes/minikube/how-to-install-minikube-on-ubuntu/#9-minikube","text":"\u8981\u505c\u6b62 minikube\uff0c\u8acb\u904b\u884c $ minikube stop \u8981\u555f\u52d5 minikube\uff0c\u8acb\u904b\u884c $ minikube start \u522a\u9664minikube\u96c6\u7fa4\uff0c\u5148\u505c\u6b62\u518d\u522a\u9664 $ minikube delete","title":"9. \u7ba1\u7406 Minikube \u96c6\u7fa4"},{"location":"kubernetes/minikube/onfigure-pod-service-account/","text":"\u914d\u7f6e Pod \u7684 Service Account \u00b6 \u539f\u6587: https://jimmysong.io/kubernetes-handbook/guide/configure-pod-service-account.html Service account \u70ba Pod \u4e2d\u7684\u9032\u7a0b\u63d0\u4f9b\u8eab\u4efd\u4fe1\u606f\u3002 \u672c\u6587\u662f\u95dc\u65bc Service Account \u7684\u7528\u6236\u6307\u5357 \uff0c\u7ba1\u7406\u6307\u5357\u53e6\u898b Service Account \u7684\u96c6\u7fa4\u7ba1\u7406\u6307\u5357 \u3002 \u6ce8\u610f\uff1a\u672c\u6587\u6a94\u63cf\u8ff0\u7684\u95dc\u65bc Service Account \u7684\u884c\u70ba\u53ea\u6709\u7576\u60a8\u6309\u7167 Kubernetes \u9805\u76ee\u5efa\u8b70\u7684\u65b9\u5f0f\u642d\u5efa\u8d77\u96c6\u7fa4\u7684\u60c5\u6cc1\u4e0b\u624d\u6709\u6548\u3002\u60a8\u7684\u96c6\u7fa4\u7ba1\u7406\u54e1\u53ef\u80fd\u5728\u60a8\u7684\u96c6\u7fa4\u4e2d\u6709\u81ea\u5b9a\u7fa9\u914d\u7f6e\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u8a72\u6587\u6a94\u53ef\u80fd\u4e26\u4e0d\u9069\u7528\u3002 \u7576\u60a8\uff08\u771f\u4eba\u7528\u6236\uff09\u8a2a\u554f\u96c6\u7fa4\uff08\u4f8b\u5982\u4f7f\u7528kubectl\u547d\u4ee4\uff09\u6642\uff0capiserver \u6703\u5c07\u60a8\u8a8d\u8b49\u70ba\u4e00\u500b\u7279\u5b9a\u7684 User Account\uff08\u76ee\u524d\u901a\u5e38\u662fadmin\uff0c\u9664\u975e\u60a8\u7684\u7cfb\u7d71\u7ba1\u7406\u54e1\u81ea\u5b9a\u7fa9\u4e86\u96c6\u7fa4\u914d\u7f6e\uff09\u3002 Pod \u5bb9\u5668\u4e2d\u7684\u9032\u7a0b\u4e5f\u53ef\u4ee5\u8207 apiserver \u806f\u7e6b\u3002\u7576\u5b83\u5011\u5728\u806f\u7e6b apiserver \u7684\u6642\u5019\uff0c\u5b83\u5011\u6703\u88ab\u8a8d\u8b49\u70ba\u4e00\u500b\u7279\u5b9a\u7684 Service Account\uff08\u4f8b\u5982default\uff09\u3002 \u4f7f\u7528\u9ed8\u8a8d\u7684 Service Account \u8a2a\u554f API server \u00b6 \u7576\u60a8\u5275\u5efa pod \u7684\u6642\u5019\uff0c\u5982\u679c\u60a8\u6c92\u6709\u6307\u5b9a\u4e00\u500b service account\uff0c\u7cfb\u7d71\u6703\u81ea\u52d5\u5f97\u5728\u8207\u8a72pod \u76f8\u540c\u7684 namespace \u4e0b\u70ba\u5176\u6307\u6d3e\u4e00\u500bdefault service account\u3002\u5982\u679c\u60a8\u7372\u53d6\u525b\u5275\u5efa\u7684 pod \u7684\u539f\u59cb json \u6216 yaml \u4fe1\u606f\uff08\u4f8b\u5982\u4f7f\u7528 kubectl get pods/podename -o yaml \u547d\u4ee4\uff09\uff0c\u60a8\u5c07\u770b\u5230 spec.serviceAccountName \u5b57\u6bb5\u5df2\u7d93\u88ab\u8a2d\u7f6e\u70ba automatically \u3002 \u4f7f\u7528 Service Account \u4f5c\u70ba\u7528\u6236\u6b0a\u9650\u7ba1\u7406\u914d\u7f6e kubeconfig \u00b6 \u5275\u5efa\u670d\u52d9\u8cec\u865f \u00b6 $ kubectl create serviceaccount sample-sc \u9019\u6642\u5019\u6211\u5011\u5c07\u5f97\u5230\u4e00\u500b\u5728 default namespace \u7684 serviceaccount \u8cec\u865f\uff1b \u6211\u5011\u904b\u884c kubectl get serviceaccount sample-sc -o yaml \u5c07\u5f97\u5230\u5982\u4e0b\u7d50\u679c: apiVersion : v1 kind : ServiceAccount metadata : creationTimestamp : \"2022-06-25T04:15:41Z\" name : sample-sc namespace : default resourceVersion : \"10098\" uid : cc45957d-3b67-4382-ac0b-c49ebfbcb3f6 secrets : - name : sample-sc-token-wmdvw \u56e0\u70ba\u6211\u5011\u5728\u4f7f\u7528 serviceaccount \u8cec\u865f\u914d\u7f6e kubeconfig \u7684\u6642\u5019\u9700\u8981\u4f7f\u7528\u5230 sample-sc \u7684 token\uff0c \u8a72 token \u4fdd\u5b58\u5728\u8a72 serviceaccount \u4fdd\u5b58\u7684 secret \u4e2d\uff1b \u6211\u5011\u904b\u884c kubectl get secret sample-sc-token-wmdvw -o yaml \u5c07\u6703\u5f97\u5230\u5982\u4e0b\u7d50\u679c: apiVersion : v1 data : ca.crt : LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJeU1EWXhNakEyTVRReE5Gb1hEVE15TURZeE1EQTJNVFF4TkZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUx1ClJibkdZeDhWMWVjaVdwSkloaVBiREtJTTVlbTBteWwxQk1EaUsvS09Lb3BIQm02QjBCT1FDZ2h4bVNNQlYwZWIKSFFDUGxWQWdseE5zTWtLMUJNZzZDMTB3bkZXOUtGTWJoOTRFcHdRWTZSWTRSemlxcHdnMUhHTEQ1UzJKcmd2agpPNTIrb3JnNzVvR3NkUkwrOTV1aEc2aEc5NTI0emtFcmxkNllHMUttV2JsVXptRFc4eXVsdUVQaHlvZGNqR0g0CldVdEhISE1nclQyTytnNml4YmN0aTVxRlAydzVSaGJvVDZtUjRvWUM4eTFtZld4MFppTjZOQ1NGMmZZZ3NEbDkKYUliUVovR1EzNnU5VW9WY3U1bWdxN21sdlI0SWFZNSs0dURWOHFWQWR1Y0QzcXJqK1JZUnllMmpqNXJEU0VRZwpYa3lORS9xZzkyaUc5WTlmbHo4Q0F3RUFBYU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVcKQkJSd1U0YU9BYTdqVDFlUHNERERNYkJlTWR0L2xqQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFWanplV1FuTwplNytTc1AxRXl1ZURTS0w0cHowQnNtSlFZc3ZBZkROZEphTDBScStJc0FMYmhPWk15Nk4wUnUzdmxrZ1YrY3ZYCkIwSU9zRCsvdlN2bUFtYWNwclJjM3ZrS1cyak1lZy9xR3JWTy8vK1Y5N25Fb1IvbGRtTDB4NEl0bmFaNW1aWHkKOTNkWUVZY0tkb2pqTXY1S0dKbjlvcmhRS2Z0SzlYUk1zZ3kxUW5XVGJMbUEyeENMUGtuQzhoV0U1QS85bXlFRgo3UTVtaFFSWS85akQ2ZVJFeERBbytuKzRlVHlPd3loa3pXenEyMWVpNmJNbUt0SVlUdlc1SFNOSXo3NzNoV3grCjNjaUZlSzZTcHg0c0RpckdYenFjaEk4dHpTQ3NNS1o1ODAwSWp1T1RNb0VCM01WN0Rhalk0eE1MMW1nZlBta1EKRmtxZWQwcGhqNVRsUEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== namespace : ZGVmYXVsdA== token : ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUk9hbkJKYmpGd2JVbElRbHByU1VKb2VrdExTV2xoZFRBMk9IWkhXbTFWVlVsNWF6SnRRMGgyWjBFaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbk5oYlhCc1pTMXpZeTEwYjJ0bGJpMTNiV1IyZHlJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKellXMXdiR1V0YzJNaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sY25acFkyVXRZV05qYjNWdWRDNTFhV1FpT2lKall6UTFPVFUzWkMwellqWTNMVFF6T0RJdFlXTXdZaTFqTkRsbFltWmlZMkl6WmpZaUxDSnpkV0lpT2lKemVYTjBaVzA2YzJWeWRtbGpaV0ZqWTI5MWJuUTZaR1ZtWVhWc2REcHpZVzF3YkdVdGMyTWlmUS5DNVdxM2w0NjFWRTdPbkdoUW9TaU5XQm5yQ0hwVFV1VnZueHlBZ2JXTDNmYU9tSmwxTDhXWGtBSUlGbGtYR1UyLUx1VlpfYjJjX1BMUUNFbm9NZ016TFBSWGFncXFzZ1FtLXZSdnFNVlgtUUlwZjc3eEZJeV9mN3k0MWVYaXhuWVZ1UWZZZk42TUpHVFJoYnhMZ25COUstY3A1dnNtUkRWUUtqZ3BoU3ZybTFmRllTNW1NUzY0cjJSYnFQMWhxc1h3c2pvbW9FS2daSlRGamt5UWdVaFhxb1ZqT250d3NGaU53NVBaYUEwZGdocEY3RWNvMF9VSVZOQTVCa0dkYkI0ak9mbDU2TUNVUk1oMU1iVVdhaHFkMnJ4Q1E2bXk0c0ZOcE8tOEstQmtkMEpOWF9yNDBoSjF4MHFPUlBmSXpvVk1Oc0Exdl90cTQ1c3pwN3BjRGxjbWc= kind : Secret metadata : annotations : kubernetes.io/service-account.name : sample-sc kubernetes.io/service-account.uid : cc45957d-3b67-4382-ac0b-c49ebfbcb3f6 creationTimestamp : \"2022-06-25T04:15:41Z\" name : sample-sc-token-wmdvw namespace : default resourceVersion : \"10097\" uid : b31a06c6-e26e-411d-a3ff-614589691bc4 type : kubernetes.io/service-account-token \u5176\u4e2d {data.token} \u5c31\u6703\u662f\u6211\u5011\u7684\u7528\u6236 token \u7684 base64 \u7de8\u78bc\uff0c\u4e4b\u5f8c\u6211\u5011\u914d\u7f6e kubeconfig \u7684\u6642\u5019\u5c07\u6703\u7528\u5230\u5b83\uff1b \u5275\u5efa\u89d2\u8272 \u00b6 \u6bd4\u5982\u6211\u5011\u60f3\u5275\u5efa\u4e00\u500b\u53ea\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4 deployments \uff0c services \uff0c pods \u76f8\u95dc\u7684\u89d2\u8272\uff0c\u61c9\u8a72\u4f7f\u7528\u5982\u4e0b\u914d\u7f6e: apiVersion : rbac.authorization.k8s.io/v1 ## \u8fd9\u91cc\u4e5f\u53ef\u4ee5\u4f7f\u7528 Role kind : ClusterRole metadata : name : mofang-viewer-role labels : from : mofang rules : - apiGroups : - \"\" resources : - pods - pods/status - pods/log - services - services/status - endpoints - endpoints/status - deployments verbs : - get - list - watch \u5275\u5efa\u89d2\u8272\u7d81\u5b9a \u00b6 apiVersion : rbac.authorization.k8s.io/v1 ## \u8fd9\u91cc\u4e5f\u53ef\u4ee5\u4f7f\u7528 RoleBinding kind : ClusterRoleBinding metadata : name : sample-role-binding labels : from : mofang roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : mofang-viewer-role subjects : - kind : ServiceAccount name : sample-sc namespace : default \u4f7f\u7528\u591a\u500bService Account \u00b6 \u6bcf\u500b namespace \u4e2d\u90fd\u6709\u4e00\u500b\u9ed8\u8a8d\u7684\u53eb\u505a default \u7684 service account \u8cc7\u6e90\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5217\u51fa namespace \u4e0b\u7684\u6240\u6709 serviceAccount \u8cc7\u6e90\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 3h19m \u60a8\u53ef\u4ee5\u50cf\u9019\u6a23\u5275\u5efa\u4e00\u500b ServiceAccount \u5c0d\u8c61\uff1a $ cat > /tmp/serviceaccount.yaml <<EOF apiVersion: v1 kind: ServiceAccount metadata: name: build-robot EOF $ kubectl create -f /tmp/serviceaccount.yaml serviceaccount \"build-robot\" created \u5982\u679c\u60a8\u770b\u5230\u5982\u4e0b\u7684 service account \u5c0d\u8c61\u7684\u5b8c\u6574\u8f38\u51fa\u4fe1\u606f\uff1a $ kubectl get serviceaccounts/build-robot -o yaml apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-06-25T04:26:12Z\" name: build-robot namespace: default resourceVersion: \"10625\" uid: e9d34d79-c412-410c-baa5-f985096e105e secrets: - name: build-robot-token-4mmqj \u7136\u5f8c\u60a8\u5c07\u770b\u5230\u6709\u4e00\u500b token \u5df2\u7d93\u88ab\u81ea\u52d5\u5275\u5efa\uff0c\u4e26\u88ab service account \u5f15\u7528\u3002 $ kubectl get secret build-robot-token-4mmqj -o yaml \u7d50\u679c: apiVersion : v1 kind : ServiceAccount metadata : creationTimestamp : \"2022-06-25T04:26:12Z\" name : build-robot namespace : default resourceVersion : \"10625\" uid : e9d34d79-c412-410c-baa5-f985096e105e secrets : - name : build-robot-token-4mmqj $ kubectl get secret build-robot-token-4mmqj NAME TYPE DATA AGE build-robot-token-4mmqj kubernetes.io/service-account-token 3 3h58m $ kubectl get secret build-robot-token-4mmqj -o yaml apiVersion : v1 data : ca.crt : LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJeU1EWXhNakEyTVRReE5Gb1hEVE15TURZeE1EQTJNVFF4TkZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUx1ClJibkdZeDhWMWVjaVdwSkloaVBiREtJTTVlbTBteWwxQk1EaUsvS09Lb3BIQm02QjBCT1FDZ2h4bVNNQlYwZWIKSFFDUGxWQWdseE5zTWtLMUJNZzZDMTB3bkZXOUtGTWJoOTRFcHdRWTZSWTRSemlxcHdnMUhHTEQ1UzJKcmd2agpPNTIrb3JnNzVvR3NkUkwrOTV1aEc2aEc5NTI0emtFcmxkNllHMUttV2JsVXptRFc4eXVsdUVQaHlvZGNqR0g0CldVdEhISE1nclQyTytnNml4YmN0aTVxRlAydzVSaGJvVDZtUjRvWUM4eTFtZld4MFppTjZOQ1NGMmZZZ3NEbDkKYUliUVovR1EzNnU5VW9WY3U1bWdxN21sdlI0SWFZNSs0dURWOHFWQWR1Y0QzcXJqK1JZUnllMmpqNXJEU0VRZwpYa3lORS9xZzkyaUc5WTlmbHo4Q0F3RUFBYU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVcKQkJSd1U0YU9BYTdqVDFlUHNERERNYkJlTWR0L2xqQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFWanplV1FuTwplNytTc1AxRXl1ZURTS0w0cHowQnNtSlFZc3ZBZkROZEphTDBScStJc0FMYmhPWk15Nk4wUnUzdmxrZ1YrY3ZYCkIwSU9zRCsvdlN2bUFtYWNwclJjM3ZrS1cyak1lZy9xR3JWTy8vK1Y5N25Fb1IvbGRtTDB4NEl0bmFaNW1aWHkKOTNkWUVZY0tkb2pqTXY1S0dKbjlvcmhRS2Z0SzlYUk1zZ3kxUW5XVGJMbUEyeENMUGtuQzhoV0U1QS85bXlFRgo3UTVtaFFSWS85akQ2ZVJFeERBbytuKzRlVHlPd3loa3pXenEyMWVpNmJNbUt0SVlUdlc1SFNOSXo3NzNoV3grCjNjaUZlSzZTcHg0c0RpckdYenFjaEk4dHpTQ3NNS1o1ODAwSWp1T1RNb0VCM01WN0Rhalk0eE1MMW1nZlBta1EKRmtxZWQwcGhqNVRsUEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== namespace : ZGVmYXVsdA== token : ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUk9hbkJKYmpGd2JVbElRbHByU1VKb2VrdExTV2xoZFRBMk9IWkhXbTFWVlVsNWF6SnRRMGgyWjBFaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbUoxYVd4a0xYSnZZbTkwTFhSdmEyVnVMVFJ0YlhGcUlpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVibUZ0WlNJNkltSjFhV3hrTFhKdlltOTBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpYSjJhV05sTFdGalkyOTFiblF1ZFdsa0lqb2laVGxrTXpSa056a3RZelF4TWkwME1UQmpMV0poWVRVdFpqazROVEE1Tm1VeE1EVmxJaXdpYzNWaUlqb2ljM2x6ZEdWdE9uTmxjblpwWTJWaFkyTnZkVzUwT21SbFptRjFiSFE2WW5WcGJHUXRjbTlpYjNRaWZRLjVMTWhjR0hfMk1tTVhHSHpIQkhiZmhqN21rT0RtRV81UjE2SWE2ZHhzeVNvRURNZW5lSVc0R212MWxFTDlwTjlyZE9HR1lwRWNqR2dxZmc0Q0hESFlCYVhxLVdwMy05dmMwci1JQjEyY0xBWVhoMllXN2JwY0F5eVJOdUhSZzN3V1ZPWm9nQ0JoZmRISS1uaWNHYnF3Y3lFSzVvNllUOWNRajJDcFAxeFVYN1R0U2dTbWc0TDNscXBoaGhYYVo1RFVtT2FldlE2REhGZEVBYXpsOGN6WURRb01yTi1GekpUVEgwZzBJOWJ2YnAtZDFUa29hWnNXaG15RUROVV9jeTRVaEdrYl9BNGJLckVKQ2xkMG8yM1BJVVpPWFBBdEQ3MFRZN2VQcVpycllaRWRWUmN5WWRzb2pPSVlobUZXWEVTRWg5dG5KTFdOZ3ZoaXFwd2U5dEVFQQ== kind : Secret metadata : annotations : kubernetes.io/service-account.name : build-robot kubernetes.io/service-account.uid : e9d34d79-c412-410c-baa5-f985096e105e creationTimestamp : \"2022-06-25T04:26:12Z\" name : build-robot-token-4mmqj namespace : default resourceVersion : \"10624\" uid : f22e7413-eda5-4b0f-bbbd-bb353588ff01 type : kubernetes.io/service-account-token \u8a2d\u7f6e\u975e\u9ed8\u8a8d\u7684 service account\uff0c\u53ea\u9700\u8981\u5728 pod \u7684 spec.serviceAccountName \u5b57\u6bb5\u4e2d\u5c07 name \u8a2d\u7f6e\u70ba\u60a8\u60f3\u8981\u7528\u7684 service account \u540d\u5b57\u5373\u53ef\u3002 \u5728 pod \u5275\u5efa\u4e4b\u521d service account \u5c31\u5fc5\u9808\u5df2\u7d93\u5b58\u5728\uff0c\u5426\u5247\u5275\u5efa\u5c07\u88ab\u62d2\u7d55\u3002 \u60a8\u4e0d\u80fd\u66f4\u65b0\u5df2\u5275\u5efa\u7684 pod \u7684 service account\u3002 \u60a8\u53ef\u4ee5\u6e05\u7406 service account\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ kubectl delete serviceaccount/build-robot \u624b\u52d5\u5275\u5efa service account \u7684 API token \u00b6 \u5047\u8a2d\u6211\u5011\u5df2\u7d93\u6709\u4e86\u4e00\u500b\u5982\u4e0a\u6587\u63d0\u5230\u7684\u540d\u70ba \u201dbuild-robot\u201c \u7684 service account\uff0c\u6211\u5011\u624b\u52d5\u5275\u5efa\u4e00\u500b\u65b0\u7684 secret\u3002 $ cat > /tmp/build-robot-secret.yaml <<EOF apiVersion: v1 kind: Secret metadata: name: build-robot-secret annotations: kubernetes.io/service-account.name: build-robot type: kubernetes.io/service-account-token EOF $ kubectl create -f /tmp/build-robot-secret.yaml secret \"build-robot-secret\" created \u73fe\u5728\u60a8\u53ef\u4ee5\u78ba\u8a8d\u4e0b\u65b0\u5275\u5efa\u7684 secret \u53d6\u4ee3\u4e86 \"build-robot\" \u9019\u500b service account \u539f\u4f86\u7684 API token\u3002 \u6240\u6709\u5df2\u4e0d\u5b58\u5728\u7684 service account \u7684 token \u5c07\u88ab token controller \u6e05\u7406\u6389\u3002 $ kubectl describe secrets/build-robot-secret Name: build-robot-secret Namespace: default Labels: <none> Annotations: kubernetes.io/service-account.name: build-robot kubernetes.io/service-account.uid: e9d34d79-c412-410c-baa5-f985096e105e Type: kubernetes.io/service-account-token Data ==== ca.crt: 1111 bytes namespace: 7 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6ImROanBJbjFwbUlIQlprSUJoektLSWlhdTA2OHZHWm1VVUl5azJtQ0h2Z0EifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImJ1aWxkLXJvYm90LXNlY3JldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJidWlsZC1yb2JvdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImU5ZDM0ZDc5LWM0MTItNDEwYy1iYWE1LWY5ODUwOTZlMTA1ZSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmJ1aWxkLXJvYm90In0.WhfmWnNQaTUxALMz5vGJmeL-xCMKqxIjWAWnc4OH6ACiRdwwG_TgiphT4_1XlmuUDKSd2hS-yYdLSnWADrNyLBj-5GFcClI4CN8i6VDPoM2FRRlDPWJ0Yr56Alj1-tK_mbIlJck5GyAGrN32Ju2jDxlb0U_GSh5qf85-BijIC_c3AyFxO1W4jbkHNbXpvsUsu71xesAJamlygQwOwxXyL-UYducwFEHebwk4_o4gSd3_m5YwUKEFSfNlrUiCm-Fy91rOCRshDPRbwwUTaW3jCBZIMK-GjgSRTvTJE1dZb5dlieqhPevSBXxw85z8gIsfJ99zuHN2no9avdIImqyxBA","title":"\u914d\u7f6e Pod \u7684 Service Account"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#pod-service-account","text":"\u539f\u6587: https://jimmysong.io/kubernetes-handbook/guide/configure-pod-service-account.html Service account \u70ba Pod \u4e2d\u7684\u9032\u7a0b\u63d0\u4f9b\u8eab\u4efd\u4fe1\u606f\u3002 \u672c\u6587\u662f\u95dc\u65bc Service Account \u7684\u7528\u6236\u6307\u5357 \uff0c\u7ba1\u7406\u6307\u5357\u53e6\u898b Service Account \u7684\u96c6\u7fa4\u7ba1\u7406\u6307\u5357 \u3002 \u6ce8\u610f\uff1a\u672c\u6587\u6a94\u63cf\u8ff0\u7684\u95dc\u65bc Service Account \u7684\u884c\u70ba\u53ea\u6709\u7576\u60a8\u6309\u7167 Kubernetes \u9805\u76ee\u5efa\u8b70\u7684\u65b9\u5f0f\u642d\u5efa\u8d77\u96c6\u7fa4\u7684\u60c5\u6cc1\u4e0b\u624d\u6709\u6548\u3002\u60a8\u7684\u96c6\u7fa4\u7ba1\u7406\u54e1\u53ef\u80fd\u5728\u60a8\u7684\u96c6\u7fa4\u4e2d\u6709\u81ea\u5b9a\u7fa9\u914d\u7f6e\uff0c\u9019\u7a2e\u60c5\u6cc1\u4e0b\u8a72\u6587\u6a94\u53ef\u80fd\u4e26\u4e0d\u9069\u7528\u3002 \u7576\u60a8\uff08\u771f\u4eba\u7528\u6236\uff09\u8a2a\u554f\u96c6\u7fa4\uff08\u4f8b\u5982\u4f7f\u7528kubectl\u547d\u4ee4\uff09\u6642\uff0capiserver \u6703\u5c07\u60a8\u8a8d\u8b49\u70ba\u4e00\u500b\u7279\u5b9a\u7684 User Account\uff08\u76ee\u524d\u901a\u5e38\u662fadmin\uff0c\u9664\u975e\u60a8\u7684\u7cfb\u7d71\u7ba1\u7406\u54e1\u81ea\u5b9a\u7fa9\u4e86\u96c6\u7fa4\u914d\u7f6e\uff09\u3002 Pod \u5bb9\u5668\u4e2d\u7684\u9032\u7a0b\u4e5f\u53ef\u4ee5\u8207 apiserver \u806f\u7e6b\u3002\u7576\u5b83\u5011\u5728\u806f\u7e6b apiserver \u7684\u6642\u5019\uff0c\u5b83\u5011\u6703\u88ab\u8a8d\u8b49\u70ba\u4e00\u500b\u7279\u5b9a\u7684 Service Account\uff08\u4f8b\u5982default\uff09\u3002","title":"\u914d\u7f6e Pod \u7684 Service Account"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#service-account-api-server","text":"\u7576\u60a8\u5275\u5efa pod \u7684\u6642\u5019\uff0c\u5982\u679c\u60a8\u6c92\u6709\u6307\u5b9a\u4e00\u500b service account\uff0c\u7cfb\u7d71\u6703\u81ea\u52d5\u5f97\u5728\u8207\u8a72pod \u76f8\u540c\u7684 namespace \u4e0b\u70ba\u5176\u6307\u6d3e\u4e00\u500bdefault service account\u3002\u5982\u679c\u60a8\u7372\u53d6\u525b\u5275\u5efa\u7684 pod \u7684\u539f\u59cb json \u6216 yaml \u4fe1\u606f\uff08\u4f8b\u5982\u4f7f\u7528 kubectl get pods/podename -o yaml \u547d\u4ee4\uff09\uff0c\u60a8\u5c07\u770b\u5230 spec.serviceAccountName \u5b57\u6bb5\u5df2\u7d93\u88ab\u8a2d\u7f6e\u70ba automatically \u3002","title":"\u4f7f\u7528\u9ed8\u8a8d\u7684 Service Account \u8a2a\u554f API server"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#service-account-kubeconfig","text":"","title":"\u4f7f\u7528 Service Account \u4f5c\u70ba\u7528\u6236\u6b0a\u9650\u7ba1\u7406\u914d\u7f6e kubeconfig"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#_1","text":"$ kubectl create serviceaccount sample-sc \u9019\u6642\u5019\u6211\u5011\u5c07\u5f97\u5230\u4e00\u500b\u5728 default namespace \u7684 serviceaccount \u8cec\u865f\uff1b \u6211\u5011\u904b\u884c kubectl get serviceaccount sample-sc -o yaml \u5c07\u5f97\u5230\u5982\u4e0b\u7d50\u679c: apiVersion : v1 kind : ServiceAccount metadata : creationTimestamp : \"2022-06-25T04:15:41Z\" name : sample-sc namespace : default resourceVersion : \"10098\" uid : cc45957d-3b67-4382-ac0b-c49ebfbcb3f6 secrets : - name : sample-sc-token-wmdvw \u56e0\u70ba\u6211\u5011\u5728\u4f7f\u7528 serviceaccount \u8cec\u865f\u914d\u7f6e kubeconfig \u7684\u6642\u5019\u9700\u8981\u4f7f\u7528\u5230 sample-sc \u7684 token\uff0c \u8a72 token \u4fdd\u5b58\u5728\u8a72 serviceaccount \u4fdd\u5b58\u7684 secret \u4e2d\uff1b \u6211\u5011\u904b\u884c kubectl get secret sample-sc-token-wmdvw -o yaml \u5c07\u6703\u5f97\u5230\u5982\u4e0b\u7d50\u679c: apiVersion : v1 data : ca.crt : LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJeU1EWXhNakEyTVRReE5Gb1hEVE15TURZeE1EQTJNVFF4TkZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUx1ClJibkdZeDhWMWVjaVdwSkloaVBiREtJTTVlbTBteWwxQk1EaUsvS09Lb3BIQm02QjBCT1FDZ2h4bVNNQlYwZWIKSFFDUGxWQWdseE5zTWtLMUJNZzZDMTB3bkZXOUtGTWJoOTRFcHdRWTZSWTRSemlxcHdnMUhHTEQ1UzJKcmd2agpPNTIrb3JnNzVvR3NkUkwrOTV1aEc2aEc5NTI0emtFcmxkNllHMUttV2JsVXptRFc4eXVsdUVQaHlvZGNqR0g0CldVdEhISE1nclQyTytnNml4YmN0aTVxRlAydzVSaGJvVDZtUjRvWUM4eTFtZld4MFppTjZOQ1NGMmZZZ3NEbDkKYUliUVovR1EzNnU5VW9WY3U1bWdxN21sdlI0SWFZNSs0dURWOHFWQWR1Y0QzcXJqK1JZUnllMmpqNXJEU0VRZwpYa3lORS9xZzkyaUc5WTlmbHo4Q0F3RUFBYU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVcKQkJSd1U0YU9BYTdqVDFlUHNERERNYkJlTWR0L2xqQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFWanplV1FuTwplNytTc1AxRXl1ZURTS0w0cHowQnNtSlFZc3ZBZkROZEphTDBScStJc0FMYmhPWk15Nk4wUnUzdmxrZ1YrY3ZYCkIwSU9zRCsvdlN2bUFtYWNwclJjM3ZrS1cyak1lZy9xR3JWTy8vK1Y5N25Fb1IvbGRtTDB4NEl0bmFaNW1aWHkKOTNkWUVZY0tkb2pqTXY1S0dKbjlvcmhRS2Z0SzlYUk1zZ3kxUW5XVGJMbUEyeENMUGtuQzhoV0U1QS85bXlFRgo3UTVtaFFSWS85akQ2ZVJFeERBbytuKzRlVHlPd3loa3pXenEyMWVpNmJNbUt0SVlUdlc1SFNOSXo3NzNoV3grCjNjaUZlSzZTcHg0c0RpckdYenFjaEk4dHpTQ3NNS1o1ODAwSWp1T1RNb0VCM01WN0Rhalk0eE1MMW1nZlBta1EKRmtxZWQwcGhqNVRsUEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== namespace : ZGVmYXVsdA== token : ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUk9hbkJKYmpGd2JVbElRbHByU1VKb2VrdExTV2xoZFRBMk9IWkhXbTFWVlVsNWF6SnRRMGgyWjBFaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbk5oYlhCc1pTMXpZeTEwYjJ0bGJpMTNiV1IyZHlJc0ltdDFZbVZ5Ym1WMFpYTXVhVzh2YzJWeWRtbGpaV0ZqWTI5MWJuUXZjMlZ5ZG1salpTMWhZMk52ZFc1MExtNWhiV1VpT2lKellXMXdiR1V0YzJNaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sY25acFkyVXRZV05qYjNWdWRDNTFhV1FpT2lKall6UTFPVFUzWkMwellqWTNMVFF6T0RJdFlXTXdZaTFqTkRsbFltWmlZMkl6WmpZaUxDSnpkV0lpT2lKemVYTjBaVzA2YzJWeWRtbGpaV0ZqWTI5MWJuUTZaR1ZtWVhWc2REcHpZVzF3YkdVdGMyTWlmUS5DNVdxM2w0NjFWRTdPbkdoUW9TaU5XQm5yQ0hwVFV1VnZueHlBZ2JXTDNmYU9tSmwxTDhXWGtBSUlGbGtYR1UyLUx1VlpfYjJjX1BMUUNFbm9NZ016TFBSWGFncXFzZ1FtLXZSdnFNVlgtUUlwZjc3eEZJeV9mN3k0MWVYaXhuWVZ1UWZZZk42TUpHVFJoYnhMZ25COUstY3A1dnNtUkRWUUtqZ3BoU3ZybTFmRllTNW1NUzY0cjJSYnFQMWhxc1h3c2pvbW9FS2daSlRGamt5UWdVaFhxb1ZqT250d3NGaU53NVBaYUEwZGdocEY3RWNvMF9VSVZOQTVCa0dkYkI0ak9mbDU2TUNVUk1oMU1iVVdhaHFkMnJ4Q1E2bXk0c0ZOcE8tOEstQmtkMEpOWF9yNDBoSjF4MHFPUlBmSXpvVk1Oc0Exdl90cTQ1c3pwN3BjRGxjbWc= kind : Secret metadata : annotations : kubernetes.io/service-account.name : sample-sc kubernetes.io/service-account.uid : cc45957d-3b67-4382-ac0b-c49ebfbcb3f6 creationTimestamp : \"2022-06-25T04:15:41Z\" name : sample-sc-token-wmdvw namespace : default resourceVersion : \"10097\" uid : b31a06c6-e26e-411d-a3ff-614589691bc4 type : kubernetes.io/service-account-token \u5176\u4e2d {data.token} \u5c31\u6703\u662f\u6211\u5011\u7684\u7528\u6236 token \u7684 base64 \u7de8\u78bc\uff0c\u4e4b\u5f8c\u6211\u5011\u914d\u7f6e kubeconfig \u7684\u6642\u5019\u5c07\u6703\u7528\u5230\u5b83\uff1b","title":"\u5275\u5efa\u670d\u52d9\u8cec\u865f"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#_2","text":"\u6bd4\u5982\u6211\u5011\u60f3\u5275\u5efa\u4e00\u500b\u53ea\u53ef\u4ee5\u67e5\u770b\u96c6\u7fa4 deployments \uff0c services \uff0c pods \u76f8\u95dc\u7684\u89d2\u8272\uff0c\u61c9\u8a72\u4f7f\u7528\u5982\u4e0b\u914d\u7f6e: apiVersion : rbac.authorization.k8s.io/v1 ## \u8fd9\u91cc\u4e5f\u53ef\u4ee5\u4f7f\u7528 Role kind : ClusterRole metadata : name : mofang-viewer-role labels : from : mofang rules : - apiGroups : - \"\" resources : - pods - pods/status - pods/log - services - services/status - endpoints - endpoints/status - deployments verbs : - get - list - watch","title":"\u5275\u5efa\u89d2\u8272"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#_3","text":"apiVersion : rbac.authorization.k8s.io/v1 ## \u8fd9\u91cc\u4e5f\u53ef\u4ee5\u4f7f\u7528 RoleBinding kind : ClusterRoleBinding metadata : name : sample-role-binding labels : from : mofang roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : mofang-viewer-role subjects : - kind : ServiceAccount name : sample-sc namespace : default","title":"\u5275\u5efa\u89d2\u8272\u7d81\u5b9a"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#service-account","text":"\u6bcf\u500b namespace \u4e2d\u90fd\u6709\u4e00\u500b\u9ed8\u8a8d\u7684\u53eb\u505a default \u7684 service account \u8cc7\u6e90\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5217\u51fa namespace \u4e0b\u7684\u6240\u6709 serviceAccount \u8cc7\u6e90\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 3h19m \u60a8\u53ef\u4ee5\u50cf\u9019\u6a23\u5275\u5efa\u4e00\u500b ServiceAccount \u5c0d\u8c61\uff1a $ cat > /tmp/serviceaccount.yaml <<EOF apiVersion: v1 kind: ServiceAccount metadata: name: build-robot EOF $ kubectl create -f /tmp/serviceaccount.yaml serviceaccount \"build-robot\" created \u5982\u679c\u60a8\u770b\u5230\u5982\u4e0b\u7684 service account \u5c0d\u8c61\u7684\u5b8c\u6574\u8f38\u51fa\u4fe1\u606f\uff1a $ kubectl get serviceaccounts/build-robot -o yaml apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-06-25T04:26:12Z\" name: build-robot namespace: default resourceVersion: \"10625\" uid: e9d34d79-c412-410c-baa5-f985096e105e secrets: - name: build-robot-token-4mmqj \u7136\u5f8c\u60a8\u5c07\u770b\u5230\u6709\u4e00\u500b token \u5df2\u7d93\u88ab\u81ea\u52d5\u5275\u5efa\uff0c\u4e26\u88ab service account \u5f15\u7528\u3002 $ kubectl get secret build-robot-token-4mmqj -o yaml \u7d50\u679c: apiVersion : v1 kind : ServiceAccount metadata : creationTimestamp : \"2022-06-25T04:26:12Z\" name : build-robot namespace : default resourceVersion : \"10625\" uid : e9d34d79-c412-410c-baa5-f985096e105e secrets : - name : build-robot-token-4mmqj $ kubectl get secret build-robot-token-4mmqj NAME TYPE DATA AGE build-robot-token-4mmqj kubernetes.io/service-account-token 3 3h58m $ kubectl get secret build-robot-token-4mmqj -o yaml apiVersion : v1 data : ca.crt : LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJeU1EWXhNakEyTVRReE5Gb1hEVE15TURZeE1EQTJNVFF4TkZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTUx1ClJibkdZeDhWMWVjaVdwSkloaVBiREtJTTVlbTBteWwxQk1EaUsvS09Lb3BIQm02QjBCT1FDZ2h4bVNNQlYwZWIKSFFDUGxWQWdseE5zTWtLMUJNZzZDMTB3bkZXOUtGTWJoOTRFcHdRWTZSWTRSemlxcHdnMUhHTEQ1UzJKcmd2agpPNTIrb3JnNzVvR3NkUkwrOTV1aEc2aEc5NTI0emtFcmxkNllHMUttV2JsVXptRFc4eXVsdUVQaHlvZGNqR0g0CldVdEhISE1nclQyTytnNml4YmN0aTVxRlAydzVSaGJvVDZtUjRvWUM4eTFtZld4MFppTjZOQ1NGMmZZZ3NEbDkKYUliUVovR1EzNnU5VW9WY3U1bWdxN21sdlI0SWFZNSs0dURWOHFWQWR1Y0QzcXJqK1JZUnllMmpqNXJEU0VRZwpYa3lORS9xZzkyaUc5WTlmbHo4Q0F3RUFBYU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVcKQkJSd1U0YU9BYTdqVDFlUHNERERNYkJlTWR0L2xqQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFWanplV1FuTwplNytTc1AxRXl1ZURTS0w0cHowQnNtSlFZc3ZBZkROZEphTDBScStJc0FMYmhPWk15Nk4wUnUzdmxrZ1YrY3ZYCkIwSU9zRCsvdlN2bUFtYWNwclJjM3ZrS1cyak1lZy9xR3JWTy8vK1Y5N25Fb1IvbGRtTDB4NEl0bmFaNW1aWHkKOTNkWUVZY0tkb2pqTXY1S0dKbjlvcmhRS2Z0SzlYUk1zZ3kxUW5XVGJMbUEyeENMUGtuQzhoV0U1QS85bXlFRgo3UTVtaFFSWS85akQ2ZVJFeERBbytuKzRlVHlPd3loa3pXenEyMWVpNmJNbUt0SVlUdlc1SFNOSXo3NzNoV3grCjNjaUZlSzZTcHg0c0RpckdYenFjaEk4dHpTQ3NNS1o1ODAwSWp1T1RNb0VCM01WN0Rhalk0eE1MMW1nZlBta1EKRmtxZWQwcGhqNVRsUEE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== namespace : ZGVmYXVsdA== token : ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltUk9hbkJKYmpGd2JVbElRbHByU1VKb2VrdExTV2xoZFRBMk9IWkhXbTFWVlVsNWF6SnRRMGgyWjBFaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbUoxYVd4a0xYSnZZbTkwTFhSdmEyVnVMVFJ0YlhGcUlpd2lhM1ZpWlhKdVpYUmxjeTVwYnk5elpYSjJhV05sWVdOamIzVnVkQzl6WlhKMmFXTmxMV0ZqWTI5MWJuUXVibUZ0WlNJNkltSjFhV3hrTFhKdlltOTBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpYSjJhV05sTFdGalkyOTFiblF1ZFdsa0lqb2laVGxrTXpSa056a3RZelF4TWkwME1UQmpMV0poWVRVdFpqazROVEE1Tm1VeE1EVmxJaXdpYzNWaUlqb2ljM2x6ZEdWdE9uTmxjblpwWTJWaFkyTnZkVzUwT21SbFptRjFiSFE2WW5WcGJHUXRjbTlpYjNRaWZRLjVMTWhjR0hfMk1tTVhHSHpIQkhiZmhqN21rT0RtRV81UjE2SWE2ZHhzeVNvRURNZW5lSVc0R212MWxFTDlwTjlyZE9HR1lwRWNqR2dxZmc0Q0hESFlCYVhxLVdwMy05dmMwci1JQjEyY0xBWVhoMllXN2JwY0F5eVJOdUhSZzN3V1ZPWm9nQ0JoZmRISS1uaWNHYnF3Y3lFSzVvNllUOWNRajJDcFAxeFVYN1R0U2dTbWc0TDNscXBoaGhYYVo1RFVtT2FldlE2REhGZEVBYXpsOGN6WURRb01yTi1GekpUVEgwZzBJOWJ2YnAtZDFUa29hWnNXaG15RUROVV9jeTRVaEdrYl9BNGJLckVKQ2xkMG8yM1BJVVpPWFBBdEQ3MFRZN2VQcVpycllaRWRWUmN5WWRzb2pPSVlobUZXWEVTRWg5dG5KTFdOZ3ZoaXFwd2U5dEVFQQ== kind : Secret metadata : annotations : kubernetes.io/service-account.name : build-robot kubernetes.io/service-account.uid : e9d34d79-c412-410c-baa5-f985096e105e creationTimestamp : \"2022-06-25T04:26:12Z\" name : build-robot-token-4mmqj namespace : default resourceVersion : \"10624\" uid : f22e7413-eda5-4b0f-bbbd-bb353588ff01 type : kubernetes.io/service-account-token \u8a2d\u7f6e\u975e\u9ed8\u8a8d\u7684 service account\uff0c\u53ea\u9700\u8981\u5728 pod \u7684 spec.serviceAccountName \u5b57\u6bb5\u4e2d\u5c07 name \u8a2d\u7f6e\u70ba\u60a8\u60f3\u8981\u7528\u7684 service account \u540d\u5b57\u5373\u53ef\u3002 \u5728 pod \u5275\u5efa\u4e4b\u521d service account \u5c31\u5fc5\u9808\u5df2\u7d93\u5b58\u5728\uff0c\u5426\u5247\u5275\u5efa\u5c07\u88ab\u62d2\u7d55\u3002 \u60a8\u4e0d\u80fd\u66f4\u65b0\u5df2\u5275\u5efa\u7684 pod \u7684 service account\u3002 \u60a8\u53ef\u4ee5\u6e05\u7406 service account\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ kubectl delete serviceaccount/build-robot","title":"\u4f7f\u7528\u591a\u500bService Account"},{"location":"kubernetes/minikube/onfigure-pod-service-account/#service-account-api-token","text":"\u5047\u8a2d\u6211\u5011\u5df2\u7d93\u6709\u4e86\u4e00\u500b\u5982\u4e0a\u6587\u63d0\u5230\u7684\u540d\u70ba \u201dbuild-robot\u201c \u7684 service account\uff0c\u6211\u5011\u624b\u52d5\u5275\u5efa\u4e00\u500b\u65b0\u7684 secret\u3002 $ cat > /tmp/build-robot-secret.yaml <<EOF apiVersion: v1 kind: Secret metadata: name: build-robot-secret annotations: kubernetes.io/service-account.name: build-robot type: kubernetes.io/service-account-token EOF $ kubectl create -f /tmp/build-robot-secret.yaml secret \"build-robot-secret\" created \u73fe\u5728\u60a8\u53ef\u4ee5\u78ba\u8a8d\u4e0b\u65b0\u5275\u5efa\u7684 secret \u53d6\u4ee3\u4e86 \"build-robot\" \u9019\u500b service account \u539f\u4f86\u7684 API token\u3002 \u6240\u6709\u5df2\u4e0d\u5b58\u5728\u7684 service account \u7684 token \u5c07\u88ab token controller \u6e05\u7406\u6389\u3002 $ kubectl describe secrets/build-robot-secret Name: build-robot-secret Namespace: default Labels: <none> Annotations: kubernetes.io/service-account.name: build-robot kubernetes.io/service-account.uid: e9d34d79-c412-410c-baa5-f985096e105e Type: kubernetes.io/service-account-token Data ==== ca.crt: 1111 bytes namespace: 7 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6ImROanBJbjFwbUlIQlprSUJoektLSWlhdTA2OHZHWm1VVUl5azJtQ0h2Z0EifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImJ1aWxkLXJvYm90LXNlY3JldCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJidWlsZC1yb2JvdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImU5ZDM0ZDc5LWM0MTItNDEwYy1iYWE1LWY5ODUwOTZlMTA1ZSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmJ1aWxkLXJvYm90In0.WhfmWnNQaTUxALMz5vGJmeL-xCMKqxIjWAWnc4OH6ACiRdwwG_TgiphT4_1XlmuUDKSd2hS-yYdLSnWADrNyLBj-5GFcClI4CN8i6VDPoM2FRRlDPWJ0Yr56Alj1-tK_mbIlJck5GyAGrN32Ju2jDxlb0U_GSh5qf85-BijIC_c3AyFxO1W4jbkHNbXpvsUsu71xesAJamlygQwOwxXyL-UYducwFEHebwk4_o4gSd3_m5YwUKEFSfNlrUiCm-Fy91rOCRshDPRbwwUTaW3jCBZIMK-GjgSRTvTJE1dZb5dlieqhPevSBXxw85z8gIsfJ99zuHN2no9avdIImqyxBA","title":"\u624b\u52d5\u5275\u5efa service account \u7684 API token"},{"location":"vault/docs/auth/kubernetes/","text":"Kubernetes Auth Method \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth/kubernetes kubernetes auth \u65b9\u6cd5\u53ef\u7528\u65bc\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service account)\u4ee4\u724c\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u9019\u7a2e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u53ef\u4ee5\u8f15\u9b06\u5730\u5c07 Vault \u4ee4\u724c\u5f15\u5165 Kubernetes Pod\u3002 \u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u901a\u904e JWT \u8eab\u4efd\u9a57\u8b49\u767b\u9304 \u3002\u8acb\u53c3\u95b1 \u5982\u4f55\u4f7f\u7528\u77ed\u671f Kubernetes \u4ee4\u724c \u90e8\u5206\uff0c\u4e86\u89e3\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528 JWT \u8eab\u4efd\u9a57\u8b49\u7684\u539f\u56e0\u4ee5\u53ca\u5b83\u8207 Kubernetes \u8eab\u4efd\u9a57\u8b49\u7684\u6bd4\u8f03\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u8981\u5347\u7d1a\u5230 Kubernetes v1.21+\uff0c\u8acb\u78ba\u4fdd\u914d\u7f6e\u9078\u9805 disable_iss_validation \u8a2d\u7f6e\u70ba true \u3002\u5047\u8a2d\u9ed8\u8a8d\u639b\u8f09\u8def\u5f91\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 vault read -field disable_iss_validation auth/kubernetes/config \u6aa2\u67e5\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684 Kubernetes 1.21 \u3002 Authentication \u00b6 Via the CLI \u00b6 \u9ed8\u8a8d\u8def\u5f91\u662f /kubernetes \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u5728 CLI \u4e2d\u6307\u5b9a -path=/my-path \u3002 $ vault write auth/kubernetes/login role = demo jwt = ... Via the API \u00b6 \u9ed8\u8a8d\u7aef\u9ede\u662f auth/kubernetes/login \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u4f7f\u7528\u8a72\u503c\u800c\u4e0d\u662f kubernetes\u3002 $ curl \\ --request POST \\ --data '{\"jwt\": \"<your service account jwt>\", \"role\": \"demo\"}' \\ http://127.0.0.1:8200/v1/auth/kubernetes/login \u97ff\u61c9\u5c07\u5728 auth.client_token \u5305\u542b\u4e00\u500b\u4ee4\u724c\uff1a { \"auth\" : { \"client_token\" : \"38fe9691-e623-7238-f618-c94d4e7bc674\" , \"accessor\" : \"78e87a38-84ed-2692-538f-ca8b9f400ab3\" , \"policies\" : [ \"default\" ], \"metadata\" : { \"role\" : \"demo\" , \"service_account_name\" : \"vault-auth\" , \"service_account_namespace\" : \"default\" , \"service_account_secret_name\" : \"vault-auth-token-pd21c\" , \"service_account_uid\" : \"aa9aa8ff-98d0-11e7-9bb7-0800276d99bf\" }, \"lease_duration\" : 2764800 , \"renewable\" : true } } Configuration \u00b6 \u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u5728 Vault\u3000\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531 Vault \u7ba1\u7406\u54e1\u6216\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff1a $ vault auth enable kubernetes \u4f7f\u7528 /config \u7aef\u9ede\u914d\u7f6e Vault \u4ee5\u8207 Kubernetes \u901a\u4fe1\u3002\u4f7f\u7528 kubectl cluster-info \u9a57\u8b49 Kubernetes \u4e3b\u6a5f\u5730\u5740\u548c TCP \u7aef\u53e3\u3002\u6709\u95dc\u53ef\u7528\u914d\u7f6e\u9078\u9805\u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \"<your reviewer service account JWT>\" \\ kubernetes_host = https://192.168.99.100:<your TCP port or blank for 443 > \\ kubernetes_ca_cert = @ca.crt \u5275\u5efa name role\uff1a $ vault write auth/kubernetes/role/demo \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = default \\ ttl = 1h \u6b64\u89d2\u8272\u6388\u6b0a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-auth \u670d\u52d9\u5e33\u6236\uff0c\u4e26\u70ba\u5176\u63d0\u4f9b\u9ed8\u8a8d\u7b56\u7565\u3002 \u6709\u95dc\u914d\u7f6e\u9078\u9805\u7684\u5b8c\u6574\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002 Kubernetes 1.21 \u00b6 \u5f9e\u7248\u672c 1.21 \u958b\u59cb\uff0cKubernetes BoundServiceAccountTokenVolume \u529f\u80fd\u9ed8\u8a8d\u70ba\u555f\u7528\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u6703\u4ee5\u5169\u7a2e\u5c0d Kubernetes \u8eab\u4efd\u9a57\u8b49\u5f88\u91cd\u8981\u7684\u65b9\u5f0f\u66f4\u6539\u639b\u8f09\u5230\u5bb9\u5668\u4e2d\u7684 JWT \u4ee4\u724c\uff1a \u5b83\u6709\u4e00\u500b\u904e\u671f\u6642\u9593\uff0c\u4e26\u4e14\u7d81\u5b9a\u5230 pod \u548c\u670d\u52d9\u5e33\u6236\u7684\u751f\u547d\u9031\u671f\u3002 JWT \u7684 iss \u8072\u660e\u7684\u503c\u53d6\u6c7a\u65bc\u96c6\u7fa4\u7684\u914d\u7f6e\u3002 \u914d\u7f6e token_reviewer_jwt \u9078\u9805\u6642\uff0c\u5c0d\u4ee4\u724c\u751f\u547d\u9031\u671f\u7684\u66f4\u6539\u5f88\u91cd\u8981\u3002\u5982\u679c\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0cKubernetes \u5c07\u5728 pod \u6216\u670d\u52d9\u5e33\u6236\u88ab\u522a\u9664\u6216\u904e\u671f\u6642\u9593\u904e\u5f8c\u7acb\u5373\u64a4\u92b7\u5b83\uff0c\u4e26\u4e14 Vault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API \u3002 \u70ba\u4e86\u97ff\u61c9 iss \u7684\u66f4\u6539\uff0cKubernetes auth \u5df2\u5728 Vault 1.9.0 \u4e2d\u66f4\u65b0\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u4e0d\u9a57\u8b49\u9812\u767c\u8005\u3002 Kubernetes API \u5728\u5be9\u67e5\u4ee4\u724c\u6642\u57f7\u884c\u76f8\u540c\u7684\u9a57\u8b49\uff0c\u56e0\u6b64\u5728 Vault \u7aef\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\u662f\u91cd\u8907\u7684\u5de5\u4f5c\u3002 \u5728\u4e0d\u7981\u7528 Vault \u7684\u9812\u767c\u8005\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\uff0c\u55ae\u500b Kubernetes \u8eab\u4efd\u9a57\u8b49\u914d\u7f6e\u7121\u6cd5\u540c\u6642\u7528\u65bc Kubernetes 1.20 \u548c 1.21 \u7684\u9ed8\u8a8d\u639b\u8f09 pod \u4ee4\u724c\u3002\u8acb\u6ce8\u610f\uff0c\u5728 Vault 1.9 \u4e4b\u524d\u5275\u5efa\u7684\u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u5c07\u4fdd\u6301\u820a\u7684\u9ed8\u8a8d\u503c\uff0c\u60a8\u9700\u8981\u5728\u5c07 Kubernetes \u5347\u7d1a\u5230 1.21 \u4e4b\u524d\u986f\u5f0f\u8a2d\u7f6e disable_iss_validation=true \u3002\u5982\u679c\u60a8\u5e0c\u671b\u5728 Vault \u4e2d\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684\u767c\u73fe\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u4ee5\u7372\u53d6\u6307\u5c0e\u3002 \u5982\u4f55\u514b\u670d short-lived Kubernetes tokens \u5e36\u4f86\u7684\u554f\u984c \u00b6 \u7576\u9ed8\u8a8d\u639b\u8f09\u7684 pod \u4ee4\u724c\u662f\u77ed\u66ab\u7684\u6642\uff0c\u6709\u5e7e\u7a2e\u4e0d\u540c\u7684\u65b9\u6cd5\u53ef\u4ee5\u70ba Kubernetes pod \u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\uff0c\u6bcf\u7a2e\u65b9\u6cd5\u90fd\u6709\u81ea\u5df1\u7684\u6b0a\u8861\u3002\u6b64\u8868\u7e3d\u7d50\u4e86\u9078\u9805\uff0c\u4e0b\u9762\u5c07\u66f4\u8a73\u7d30\u5730\u89e3\u91cb\u6bcf\u500b\u9078\u9805\u3002 Option All tokens are short-lived Can revoke tokens early Other considerations Use local token as reviewer JWT Yes Yes Requires Vault (1.9.3+) to be deployed on the Kubernetes cluster Use client JWT as reviewer JWT Yes Yes Operational overhead Use long-lived token as reviewer JWT No Yes Use JWT auth instead Yes No Use local service account token as the reviewer JWT \u00b6 \u5728 Kubernetes pod \u4e2d\u904b\u884c Vault \u6642\uff0c\u63a8\u85a6\u7684\u9078\u9805\u662f\u4f7f\u7528 pod \u7684\u672c\u5730\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 Vault \u5c07\u5b9a\u671f\u91cd\u65b0\u8b80\u53d6\u6587\u4ef6\u4ee5\u652f\u6301\u77ed\u671f\u4ee4\u724c\u3002\u8981\u4f7f\u7528\u672c\u5730\u4ee4\u724c\u548c CA \u8b49\u66f8\uff0c\u8acb\u5728\u914d\u7f6e auth \u65b9\u6cd5\u6642\u7701\u7565 token_reviewer_jwt \u548c kubernetes_ca_cert \u3002 Vault \u5c07\u5617\u8a66\u5206\u5225\u5f9e\u9ed8\u8a8d\u639b\u8f09\u6587\u4ef6\u593e /var/run/secrets/kubernetes.io/serviceaccount/ \u4e2d\u7684 token \u548c ca.crt \u52a0\u8f09\u5b83\u5011\u3002 $ vault write auth/kubernetes/config \\ kubernetes_host = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT Warning \u6ce8\u610f\uff1a\u9700\u8981 Vault 1.9.3+\u3002\u5728\u65e9\u671f\u7248\u672c\u4e2d\uff0c\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u548c CA \u8b49\u66f8\u88ab\u8b80\u53d6\u4e00\u6b21\u4e26\u5b58\u5132\u5728 Vault \u5b58\u5132\u4e2d\u3002\u7576\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u904e\u671f\u6216\u88ab\u64a4\u92b7\u6642\uff0cVault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API\uff0c\u4e26\u4e14\u5ba2\u6236\u7aef\u8eab\u4efd\u9a57\u8b49\u5c07\u5931\u6557\u3002 Use the Vault client's JWT as the reviewer JWT \u00b6 \u914d\u7f6e Kubernetes auth \u6642\uff0c\u53ef\u4ee5\u7701\u7565 token_reviewer_jwt \uff0cVault \u5728\u8207 Kubernetes TokenReview API \u901a\u4fe1\u6642\u6703\u4f7f\u7528 Vault \u5ba2\u6236\u7aef\u7684 JWT \u4f5c\u70ba\u81ea\u5df1\u7684 auth token\u3002\u5982\u679c Vault \u5728 Kubernetes \u4e2d\u904b\u884c\uff0c\u60a8\u9084\u9700\u8981\u8a2d\u7f6e disable_local_ca_jwt=true \u3002 \u9019\u610f\u5473\u8457 Vault \u4e0d\u5b58\u5132\u4efb\u4f55 JWT \u4e26\u5141\u8a31\u60a8\u5728\u4efb\u4f55\u5730\u65b9\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4f46\u6703\u589e\u52a0\u4e00\u4e9b\u64cd\u4f5c\u958b\u92b7\u4f86\u7dad\u8b77\u60a8\u5e0c\u671b\u80fd\u5920\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u670d\u52d9\u5e33\u6236\u96c6\u4e0a\u7684\u96c6\u7fa4\u89d2\u8272\u7d81\u5b9a\u3002 Vault \u7684\u6bcf\u500b\u5ba2\u6236\u7aef\u90fd\u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl create clusterrolebinding vault-client-auth-delegator \\ --clusterrole = system:auth-delegator \\ --group = group1 \\ --serviceaccount = default:svcaccount1 \\ ... Continue using long-lived tokens \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u8655\u7684\u8aaa\u660e\u5275\u5efa\u4e00\u500b\u9577\u671f\u5b58\u5728\u7684\u6a5f\u5bc6\u4e26\u5c07\u5176\u7528\u4f5c token_reviewer_jwt \u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c vault \u670d\u52d9\u5e33\u6236 \u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl apply -f - <<EOF apiVersion: v1 kind: Secret metadata: name: vault-k8s-auth-secret annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u4f7f\u7528\u5b83\u53ef\u4ee5\u7dad\u8b77\u4ee5\u524d\u7684\u5de5\u4f5c\u6d41\u7a0b\uff0c\u4f46\u4e0d\u6703\u5f9e\u77ed\u671f\u4ee4\u724c\u7684\u6539\u9032\u5b89\u5168\u72c0\u614b\u4e2d\u53d7\u76ca\u3002 Use JWT auth \u00b6 Kubernetes auth \u5c08\u9580\u7528\u65bc\u4f7f\u7528 Kubernetes \u7684 TokenReview API \u3002\u4f46\u662f\uff0cKubernetes \u751f\u6210\u7684 JWT \u4ee4\u724c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u9a57\u8b49\u3002 JWT auth \u65b9\u6cd5\u6587\u6a94\u5305\u542b\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u8a2d\u7f6e JWT auth \u7684\u8aaa\u660e\u3002 \u6b64\u89e3\u6c7a\u65b9\u6848\u5141\u8a31\u60a8\u70ba\u6240\u6709\u5ba2\u6236\u7aef\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4e26\u4e14\u7121\u9700\u5be9\u67e5\u8005 JWT\u3002\u4f46\u662f\uff0c\u5ba2\u6236\u7aef\u4ee4\u724c\u5728\u5176 TTL \u5230\u671f\u4e4b\u524d\u4e0d\u80fd\u88ab\u64a4\u92b7\uff0c\u56e0\u6b64\u5efa\u8b70\u5728\u8a18\u4f4f\u8a72\u9650\u5236\u7684\u60c5\u6cc1\u4e0b\u4fdd\u6301 TTL \u8f03\u77ed\u3002 \u767c\u73fe Service account issuer \u00b6 Info \u6ce8\u610f\uff1a\u5f9e Vault 1.9.0 \u958b\u59cb\uff0c disable_iss_validation \u548c issuer \u5df2\u88ab\u68c4\u7528\uff0c\u4e26\u4e14 disable_iss_validation \u7684\u9ed8\u8a8d\u503c\u5df2\u66f4\u6539\u70ba true \u4ee5\u7528\u65bc\u65b0\u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u3002\u4ee5\u4e0b\u90e8\u5206\u50c5\u9069\u7528\u65bc\u60a8\u5df2\u8a2d\u7f6e disable_iss_validation=false \u6216\u5728 1.9 \u4e4b\u524d\u4f7f\u7528\u9ed8\u8a8d\u503c\u5275\u5efa\u639b\u8f09\uff0c\u4f46 disable_iss_validation=true \u662f\u6240\u6709 Vault \u7248\u672c\u7684\u65b0\u63a8\u85a6\u503c\u3002 Kubernetes 1.21+ \u96c6\u7fa4\u53ef\u80fd\u9700\u8981\u5c07\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u8a2d\u7f6e\u70ba\u8207 kube-apiserver \u7684 --service-account-issuer \u6a19\u8a8c\u76f8\u540c\u7684\u503c\u3002\u9019\u662f\u56e0\u70ba\u9019\u4e9b\u96c6\u7fa4\u7684\u670d\u52d9\u5e33\u6236 JWT \u53ef\u80fd\u5177\u6709\u7279\u5b9a\u65bc\u96c6\u7fa4\u672c\u8eab\u7684\u9812\u767c\u8005\uff0c\u800c\u4e0d\u662f\u820a\u9ed8\u8a8d\u7684 kubernetes/serviceaccount\u3002\u5982\u679c\u60a8\u7121\u6cd5\u76f4\u63a5\u6aa2\u67e5\u6b64\u503c\uff0c\u5247\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e26\u67e5\u627e iss \u5b57\u6bb5\u4ee5\u627e\u5230\u6240\u9700\u7684\u503c\uff1a echo '{\"apiVersion\": \"authentication.k8s.io/v1\", \"kind\": \"TokenRequest\"}' \\ | kubectl create -f- --raw /api/v1/namespaces/default/serviceaccounts/default/token \\ | jq -r '.status.token' \\ | cut -d . -f2 \\ | base64 -D \u5927\u591a\u6578\u96c6\u7fa4\u9084\u5c07\u5728 .well-known/openid-configuration \u7aef\u9ede\u4e0a\u63d0\u4f9b\u8a72\u4fe1\u606f\uff1a $ kubectl get --raw /.well-known/openid-configuration | jq -r .issuer \u7136\u5f8c\u5728\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u6642\u4f7f\u7528\u6b64\u503c\uff0c\u4f8b\u5982\uff1a $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT \" \\ issuer = \"\\\"test-aks-cluster-dns-d6cbb78e.hcp.uksouth.azmk8s.io\\\"\" { \"issuer\" : \"https://kubernetes.default.svc.cluster.local\" , \"jwks_uri\" : \"https://192.168.49.2:8443/openid/v1/jwks\" , \"response_types_supported\" : [ \"id_token\" ], \"subject_types_supported\" : [ \"public\" ], \"id_token_signing_alg_values_supported\" : [ \"RS256\" ] } \u914d\u7f6e Kubernetes \u00b6 \u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u8a2a\u554f Kubernetes TokenReview API \u4ee5\u9a57\u8b49\u63d0\u4f9b\u7684 JWT \u662f\u5426\u4ecd\u7136\u6709\u6548\u3002 Kubernetes \u61c9\u8a72\u4f7f\u7528 --service-account-lookup \u904b\u884c\u3002\u9019\u5728 Kubernetes 1.7 \u4e2d\u9ed8\u8a8d\u70ba true\u3002\u5426\u5247 Kubernetes \u4e2d\u5df2\u522a\u9664\u7684\u4ee4\u724c\u5c07\u7121\u6cd5\u6b63\u78ba\u64a4\u92b7\uff0c\u4e26\u4e14\u80fd\u5920\u901a\u904e\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4e2d\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u9700\u8981\u6709\u6b0a\u8a2a\u554f TokenReview API \u3002\u5982\u679c Kubernetes \u914d\u7f6e\u70ba\u4f7f\u7528 RBAC \u89d2\u8272\uff0c\u5247\u61c9\u6388\u4e88\u670d\u52d9\u5e33\u6236\u8a2a\u554f\u6b64 API \u7684\u6b0a\u9650\u3002\u4ee5\u4e0b\u793a\u4f8b ClusterRoleBinding \u53ef\u7528\u65bc\u6388\u4e88\u9019\u4e9b\u6b0a\u9650\uff1a apiVersion : rbac.authorization.k8s.io/v1beta1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default API \u00b6 Kubernetes Auth \u63d2\u4ef6\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002 \u4ee3\u78bc\u793a\u4f8b \u00b6 \u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684 Kubernetes auth \u65b9\u6cd5\u3002 package main import ( \"fmt\" \"os\" vault \"github.com/hashicorp/vault/api\" auth \"github.com/hashicorp/vault/api-docs/auth/kubernetes\" ) // Fetches a key-value secret (kv-v2) after authenticating to Vault with a Kubernetes service account. // For a more in-depth setup explanation, please see the relevant readme in the hashicorp/vault-examples repo. func getSecretWithKubernetesAuth () ( string , error ) { // If set, the VAULT_ADDR environment variable will be the address that // your pod uses to communicate with Vault. config := vault . DefaultConfig () // modify for more granular configuration client , err := vault . NewClient ( config ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Vault client: %w\" , err ) } // The service-account token will be read from the path where the token's // Kubernetes Secret is mounted. By default, Kubernetes will mount it to // /var/run/secrets/kubernetes.io/serviceaccount/token, but an administrator // may have configured it to be mounted elsewhere. // In that case, we'll use the option WithServiceAccountTokenPath to look // for the token there. k8sAuth , err := auth . NewKubernetesAuth ( \"dev-role-k8s\" , auth . WithServiceAccountTokenPath ( \"path/to/service-account-token\" ), ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Kubernetes auth method: %w\" , err ) } authInfo , err := client . Auth (). Login ( context . TODO (), k8sAuth ) if err != nil { return \"\" , fmt . Errorf ( \"unable to log in with Kubernetes auth: %w\" , err ) } if authInfo == nil { return \"\" , fmt . Errorf ( \"no auth info was returned after login\" ) } // get secret from Vault, from the default mount path for KV v2 in dev mode, \"secret\" secret , err := client . KVv2 ( \"secret\" ). Get ( context . Background (), \"creds\" ) if err != nil { return \"\" , fmt . Errorf ( \"unable to read secret: %w\" , err ) } // data map can contain more than one key-value pair, // in this case we're just grabbing one of them value , ok := secret . Data [ \"password\" ].( string ) if ! ok { return \"\" , fmt . Errorf ( \"value type assertion failed: %T %#v\" , secret . Data [ \"password\" ], secret . Data [ \"password\" ]) } return value , nil }","title":"Kubernetes"},{"location":"vault/docs/auth/kubernetes/#kubernetes-auth-method","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth/kubernetes kubernetes auth \u65b9\u6cd5\u53ef\u7528\u65bc\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service account)\u4ee4\u724c\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u9019\u7a2e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u53ef\u4ee5\u8f15\u9b06\u5730\u5c07 Vault \u4ee4\u724c\u5f15\u5165 Kubernetes Pod\u3002 \u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u901a\u904e JWT \u8eab\u4efd\u9a57\u8b49\u767b\u9304 \u3002\u8acb\u53c3\u95b1 \u5982\u4f55\u4f7f\u7528\u77ed\u671f Kubernetes \u4ee4\u724c \u90e8\u5206\uff0c\u4e86\u89e3\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528 JWT \u8eab\u4efd\u9a57\u8b49\u7684\u539f\u56e0\u4ee5\u53ca\u5b83\u8207 Kubernetes \u8eab\u4efd\u9a57\u8b49\u7684\u6bd4\u8f03\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u8981\u5347\u7d1a\u5230 Kubernetes v1.21+\uff0c\u8acb\u78ba\u4fdd\u914d\u7f6e\u9078\u9805 disable_iss_validation \u8a2d\u7f6e\u70ba true \u3002\u5047\u8a2d\u9ed8\u8a8d\u639b\u8f09\u8def\u5f91\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 vault read -field disable_iss_validation auth/kubernetes/config \u6aa2\u67e5\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684 Kubernetes 1.21 \u3002","title":"Kubernetes Auth Method"},{"location":"vault/docs/auth/kubernetes/#authentication","text":"","title":"Authentication"},{"location":"vault/docs/auth/kubernetes/#via-the-cli","text":"\u9ed8\u8a8d\u8def\u5f91\u662f /kubernetes \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u5728 CLI \u4e2d\u6307\u5b9a -path=/my-path \u3002 $ vault write auth/kubernetes/login role = demo jwt = ...","title":"Via the CLI"},{"location":"vault/docs/auth/kubernetes/#via-the-api","text":"\u9ed8\u8a8d\u7aef\u9ede\u662f auth/kubernetes/login \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u4f7f\u7528\u8a72\u503c\u800c\u4e0d\u662f kubernetes\u3002 $ curl \\ --request POST \\ --data '{\"jwt\": \"<your service account jwt>\", \"role\": \"demo\"}' \\ http://127.0.0.1:8200/v1/auth/kubernetes/login \u97ff\u61c9\u5c07\u5728 auth.client_token \u5305\u542b\u4e00\u500b\u4ee4\u724c\uff1a { \"auth\" : { \"client_token\" : \"38fe9691-e623-7238-f618-c94d4e7bc674\" , \"accessor\" : \"78e87a38-84ed-2692-538f-ca8b9f400ab3\" , \"policies\" : [ \"default\" ], \"metadata\" : { \"role\" : \"demo\" , \"service_account_name\" : \"vault-auth\" , \"service_account_namespace\" : \"default\" , \"service_account_secret_name\" : \"vault-auth-token-pd21c\" , \"service_account_uid\" : \"aa9aa8ff-98d0-11e7-9bb7-0800276d99bf\" }, \"lease_duration\" : 2764800 , \"renewable\" : true } }","title":"Via the API"},{"location":"vault/docs/auth/kubernetes/#configuration","text":"\u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u5728 Vault\u3000\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531 Vault \u7ba1\u7406\u54e1\u6216\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff1a $ vault auth enable kubernetes \u4f7f\u7528 /config \u7aef\u9ede\u914d\u7f6e Vault \u4ee5\u8207 Kubernetes \u901a\u4fe1\u3002\u4f7f\u7528 kubectl cluster-info \u9a57\u8b49 Kubernetes \u4e3b\u6a5f\u5730\u5740\u548c TCP \u7aef\u53e3\u3002\u6709\u95dc\u53ef\u7528\u914d\u7f6e\u9078\u9805\u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \"<your reviewer service account JWT>\" \\ kubernetes_host = https://192.168.99.100:<your TCP port or blank for 443 > \\ kubernetes_ca_cert = @ca.crt \u5275\u5efa name role\uff1a $ vault write auth/kubernetes/role/demo \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = default \\ ttl = 1h \u6b64\u89d2\u8272\u6388\u6b0a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-auth \u670d\u52d9\u5e33\u6236\uff0c\u4e26\u70ba\u5176\u63d0\u4f9b\u9ed8\u8a8d\u7b56\u7565\u3002 \u6709\u95dc\u914d\u7f6e\u9078\u9805\u7684\u5b8c\u6574\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002","title":"Configuration"},{"location":"vault/docs/auth/kubernetes/#kubernetes-121","text":"\u5f9e\u7248\u672c 1.21 \u958b\u59cb\uff0cKubernetes BoundServiceAccountTokenVolume \u529f\u80fd\u9ed8\u8a8d\u70ba\u555f\u7528\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u6703\u4ee5\u5169\u7a2e\u5c0d Kubernetes \u8eab\u4efd\u9a57\u8b49\u5f88\u91cd\u8981\u7684\u65b9\u5f0f\u66f4\u6539\u639b\u8f09\u5230\u5bb9\u5668\u4e2d\u7684 JWT \u4ee4\u724c\uff1a \u5b83\u6709\u4e00\u500b\u904e\u671f\u6642\u9593\uff0c\u4e26\u4e14\u7d81\u5b9a\u5230 pod \u548c\u670d\u52d9\u5e33\u6236\u7684\u751f\u547d\u9031\u671f\u3002 JWT \u7684 iss \u8072\u660e\u7684\u503c\u53d6\u6c7a\u65bc\u96c6\u7fa4\u7684\u914d\u7f6e\u3002 \u914d\u7f6e token_reviewer_jwt \u9078\u9805\u6642\uff0c\u5c0d\u4ee4\u724c\u751f\u547d\u9031\u671f\u7684\u66f4\u6539\u5f88\u91cd\u8981\u3002\u5982\u679c\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0cKubernetes \u5c07\u5728 pod \u6216\u670d\u52d9\u5e33\u6236\u88ab\u522a\u9664\u6216\u904e\u671f\u6642\u9593\u904e\u5f8c\u7acb\u5373\u64a4\u92b7\u5b83\uff0c\u4e26\u4e14 Vault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API \u3002 \u70ba\u4e86\u97ff\u61c9 iss \u7684\u66f4\u6539\uff0cKubernetes auth \u5df2\u5728 Vault 1.9.0 \u4e2d\u66f4\u65b0\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u4e0d\u9a57\u8b49\u9812\u767c\u8005\u3002 Kubernetes API \u5728\u5be9\u67e5\u4ee4\u724c\u6642\u57f7\u884c\u76f8\u540c\u7684\u9a57\u8b49\uff0c\u56e0\u6b64\u5728 Vault \u7aef\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\u662f\u91cd\u8907\u7684\u5de5\u4f5c\u3002 \u5728\u4e0d\u7981\u7528 Vault \u7684\u9812\u767c\u8005\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\uff0c\u55ae\u500b Kubernetes \u8eab\u4efd\u9a57\u8b49\u914d\u7f6e\u7121\u6cd5\u540c\u6642\u7528\u65bc Kubernetes 1.20 \u548c 1.21 \u7684\u9ed8\u8a8d\u639b\u8f09 pod \u4ee4\u724c\u3002\u8acb\u6ce8\u610f\uff0c\u5728 Vault 1.9 \u4e4b\u524d\u5275\u5efa\u7684\u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u5c07\u4fdd\u6301\u820a\u7684\u9ed8\u8a8d\u503c\uff0c\u60a8\u9700\u8981\u5728\u5c07 Kubernetes \u5347\u7d1a\u5230 1.21 \u4e4b\u524d\u986f\u5f0f\u8a2d\u7f6e disable_iss_validation=true \u3002\u5982\u679c\u60a8\u5e0c\u671b\u5728 Vault \u4e2d\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684\u767c\u73fe\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u4ee5\u7372\u53d6\u6307\u5c0e\u3002","title":"Kubernetes 1.21"},{"location":"vault/docs/auth/kubernetes/#short-lived-kubernetes-tokens","text":"\u7576\u9ed8\u8a8d\u639b\u8f09\u7684 pod \u4ee4\u724c\u662f\u77ed\u66ab\u7684\u6642\uff0c\u6709\u5e7e\u7a2e\u4e0d\u540c\u7684\u65b9\u6cd5\u53ef\u4ee5\u70ba Kubernetes pod \u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\uff0c\u6bcf\u7a2e\u65b9\u6cd5\u90fd\u6709\u81ea\u5df1\u7684\u6b0a\u8861\u3002\u6b64\u8868\u7e3d\u7d50\u4e86\u9078\u9805\uff0c\u4e0b\u9762\u5c07\u66f4\u8a73\u7d30\u5730\u89e3\u91cb\u6bcf\u500b\u9078\u9805\u3002 Option All tokens are short-lived Can revoke tokens early Other considerations Use local token as reviewer JWT Yes Yes Requires Vault (1.9.3+) to be deployed on the Kubernetes cluster Use client JWT as reviewer JWT Yes Yes Operational overhead Use long-lived token as reviewer JWT No Yes Use JWT auth instead Yes No","title":"\u5982\u4f55\u514b\u670d short-lived Kubernetes tokens \u5e36\u4f86\u7684\u554f\u984c"},{"location":"vault/docs/auth/kubernetes/#use-local-service-account-token-as-the-reviewer-jwt","text":"\u5728 Kubernetes pod \u4e2d\u904b\u884c Vault \u6642\uff0c\u63a8\u85a6\u7684\u9078\u9805\u662f\u4f7f\u7528 pod \u7684\u672c\u5730\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 Vault \u5c07\u5b9a\u671f\u91cd\u65b0\u8b80\u53d6\u6587\u4ef6\u4ee5\u652f\u6301\u77ed\u671f\u4ee4\u724c\u3002\u8981\u4f7f\u7528\u672c\u5730\u4ee4\u724c\u548c CA \u8b49\u66f8\uff0c\u8acb\u5728\u914d\u7f6e auth \u65b9\u6cd5\u6642\u7701\u7565 token_reviewer_jwt \u548c kubernetes_ca_cert \u3002 Vault \u5c07\u5617\u8a66\u5206\u5225\u5f9e\u9ed8\u8a8d\u639b\u8f09\u6587\u4ef6\u593e /var/run/secrets/kubernetes.io/serviceaccount/ \u4e2d\u7684 token \u548c ca.crt \u52a0\u8f09\u5b83\u5011\u3002 $ vault write auth/kubernetes/config \\ kubernetes_host = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT Warning \u6ce8\u610f\uff1a\u9700\u8981 Vault 1.9.3+\u3002\u5728\u65e9\u671f\u7248\u672c\u4e2d\uff0c\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u548c CA \u8b49\u66f8\u88ab\u8b80\u53d6\u4e00\u6b21\u4e26\u5b58\u5132\u5728 Vault \u5b58\u5132\u4e2d\u3002\u7576\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u904e\u671f\u6216\u88ab\u64a4\u92b7\u6642\uff0cVault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API\uff0c\u4e26\u4e14\u5ba2\u6236\u7aef\u8eab\u4efd\u9a57\u8b49\u5c07\u5931\u6557\u3002","title":"Use local service account token as the reviewer JWT"},{"location":"vault/docs/auth/kubernetes/#use-the-vault-clients-jwt-as-the-reviewer-jwt","text":"\u914d\u7f6e Kubernetes auth \u6642\uff0c\u53ef\u4ee5\u7701\u7565 token_reviewer_jwt \uff0cVault \u5728\u8207 Kubernetes TokenReview API \u901a\u4fe1\u6642\u6703\u4f7f\u7528 Vault \u5ba2\u6236\u7aef\u7684 JWT \u4f5c\u70ba\u81ea\u5df1\u7684 auth token\u3002\u5982\u679c Vault \u5728 Kubernetes \u4e2d\u904b\u884c\uff0c\u60a8\u9084\u9700\u8981\u8a2d\u7f6e disable_local_ca_jwt=true \u3002 \u9019\u610f\u5473\u8457 Vault \u4e0d\u5b58\u5132\u4efb\u4f55 JWT \u4e26\u5141\u8a31\u60a8\u5728\u4efb\u4f55\u5730\u65b9\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4f46\u6703\u589e\u52a0\u4e00\u4e9b\u64cd\u4f5c\u958b\u92b7\u4f86\u7dad\u8b77\u60a8\u5e0c\u671b\u80fd\u5920\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u670d\u52d9\u5e33\u6236\u96c6\u4e0a\u7684\u96c6\u7fa4\u89d2\u8272\u7d81\u5b9a\u3002 Vault \u7684\u6bcf\u500b\u5ba2\u6236\u7aef\u90fd\u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl create clusterrolebinding vault-client-auth-delegator \\ --clusterrole = system:auth-delegator \\ --group = group1 \\ --serviceaccount = default:svcaccount1 \\ ...","title":"Use the Vault client's JWT as the reviewer JWT"},{"location":"vault/docs/auth/kubernetes/#continue-using-long-lived-tokens","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u8655\u7684\u8aaa\u660e\u5275\u5efa\u4e00\u500b\u9577\u671f\u5b58\u5728\u7684\u6a5f\u5bc6\u4e26\u5c07\u5176\u7528\u4f5c token_reviewer_jwt \u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c vault \u670d\u52d9\u5e33\u6236 \u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl apply -f - <<EOF apiVersion: v1 kind: Secret metadata: name: vault-k8s-auth-secret annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u4f7f\u7528\u5b83\u53ef\u4ee5\u7dad\u8b77\u4ee5\u524d\u7684\u5de5\u4f5c\u6d41\u7a0b\uff0c\u4f46\u4e0d\u6703\u5f9e\u77ed\u671f\u4ee4\u724c\u7684\u6539\u9032\u5b89\u5168\u72c0\u614b\u4e2d\u53d7\u76ca\u3002","title":"Continue using long-lived tokens"},{"location":"vault/docs/auth/kubernetes/#use-jwt-auth","text":"Kubernetes auth \u5c08\u9580\u7528\u65bc\u4f7f\u7528 Kubernetes \u7684 TokenReview API \u3002\u4f46\u662f\uff0cKubernetes \u751f\u6210\u7684 JWT \u4ee4\u724c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u9a57\u8b49\u3002 JWT auth \u65b9\u6cd5\u6587\u6a94\u5305\u542b\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u8a2d\u7f6e JWT auth \u7684\u8aaa\u660e\u3002 \u6b64\u89e3\u6c7a\u65b9\u6848\u5141\u8a31\u60a8\u70ba\u6240\u6709\u5ba2\u6236\u7aef\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4e26\u4e14\u7121\u9700\u5be9\u67e5\u8005 JWT\u3002\u4f46\u662f\uff0c\u5ba2\u6236\u7aef\u4ee4\u724c\u5728\u5176 TTL \u5230\u671f\u4e4b\u524d\u4e0d\u80fd\u88ab\u64a4\u92b7\uff0c\u56e0\u6b64\u5efa\u8b70\u5728\u8a18\u4f4f\u8a72\u9650\u5236\u7684\u60c5\u6cc1\u4e0b\u4fdd\u6301 TTL \u8f03\u77ed\u3002","title":"Use JWT auth"},{"location":"vault/docs/auth/kubernetes/#service-account-issuer","text":"Info \u6ce8\u610f\uff1a\u5f9e Vault 1.9.0 \u958b\u59cb\uff0c disable_iss_validation \u548c issuer \u5df2\u88ab\u68c4\u7528\uff0c\u4e26\u4e14 disable_iss_validation \u7684\u9ed8\u8a8d\u503c\u5df2\u66f4\u6539\u70ba true \u4ee5\u7528\u65bc\u65b0\u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u3002\u4ee5\u4e0b\u90e8\u5206\u50c5\u9069\u7528\u65bc\u60a8\u5df2\u8a2d\u7f6e disable_iss_validation=false \u6216\u5728 1.9 \u4e4b\u524d\u4f7f\u7528\u9ed8\u8a8d\u503c\u5275\u5efa\u639b\u8f09\uff0c\u4f46 disable_iss_validation=true \u662f\u6240\u6709 Vault \u7248\u672c\u7684\u65b0\u63a8\u85a6\u503c\u3002 Kubernetes 1.21+ \u96c6\u7fa4\u53ef\u80fd\u9700\u8981\u5c07\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u8a2d\u7f6e\u70ba\u8207 kube-apiserver \u7684 --service-account-issuer \u6a19\u8a8c\u76f8\u540c\u7684\u503c\u3002\u9019\u662f\u56e0\u70ba\u9019\u4e9b\u96c6\u7fa4\u7684\u670d\u52d9\u5e33\u6236 JWT \u53ef\u80fd\u5177\u6709\u7279\u5b9a\u65bc\u96c6\u7fa4\u672c\u8eab\u7684\u9812\u767c\u8005\uff0c\u800c\u4e0d\u662f\u820a\u9ed8\u8a8d\u7684 kubernetes/serviceaccount\u3002\u5982\u679c\u60a8\u7121\u6cd5\u76f4\u63a5\u6aa2\u67e5\u6b64\u503c\uff0c\u5247\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e26\u67e5\u627e iss \u5b57\u6bb5\u4ee5\u627e\u5230\u6240\u9700\u7684\u503c\uff1a echo '{\"apiVersion\": \"authentication.k8s.io/v1\", \"kind\": \"TokenRequest\"}' \\ | kubectl create -f- --raw /api/v1/namespaces/default/serviceaccounts/default/token \\ | jq -r '.status.token' \\ | cut -d . -f2 \\ | base64 -D \u5927\u591a\u6578\u96c6\u7fa4\u9084\u5c07\u5728 .well-known/openid-configuration \u7aef\u9ede\u4e0a\u63d0\u4f9b\u8a72\u4fe1\u606f\uff1a $ kubectl get --raw /.well-known/openid-configuration | jq -r .issuer \u7136\u5f8c\u5728\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u6642\u4f7f\u7528\u6b64\u503c\uff0c\u4f8b\u5982\uff1a $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT \" \\ issuer = \"\\\"test-aks-cluster-dns-d6cbb78e.hcp.uksouth.azmk8s.io\\\"\" { \"issuer\" : \"https://kubernetes.default.svc.cluster.local\" , \"jwks_uri\" : \"https://192.168.49.2:8443/openid/v1/jwks\" , \"response_types_supported\" : [ \"id_token\" ], \"subject_types_supported\" : [ \"public\" ], \"id_token_signing_alg_values_supported\" : [ \"RS256\" ] }","title":"\u767c\u73fe Service account issuer"},{"location":"vault/docs/auth/kubernetes/#kubernetes","text":"\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u8a2a\u554f Kubernetes TokenReview API \u4ee5\u9a57\u8b49\u63d0\u4f9b\u7684 JWT \u662f\u5426\u4ecd\u7136\u6709\u6548\u3002 Kubernetes \u61c9\u8a72\u4f7f\u7528 --service-account-lookup \u904b\u884c\u3002\u9019\u5728 Kubernetes 1.7 \u4e2d\u9ed8\u8a8d\u70ba true\u3002\u5426\u5247 Kubernetes \u4e2d\u5df2\u522a\u9664\u7684\u4ee4\u724c\u5c07\u7121\u6cd5\u6b63\u78ba\u64a4\u92b7\uff0c\u4e26\u4e14\u80fd\u5920\u901a\u904e\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4e2d\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u9700\u8981\u6709\u6b0a\u8a2a\u554f TokenReview API \u3002\u5982\u679c Kubernetes \u914d\u7f6e\u70ba\u4f7f\u7528 RBAC \u89d2\u8272\uff0c\u5247\u61c9\u6388\u4e88\u670d\u52d9\u5e33\u6236\u8a2a\u554f\u6b64 API \u7684\u6b0a\u9650\u3002\u4ee5\u4e0b\u793a\u4f8b ClusterRoleBinding \u53ef\u7528\u65bc\u6388\u4e88\u9019\u4e9b\u6b0a\u9650\uff1a apiVersion : rbac.authorization.k8s.io/v1beta1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default","title":"\u914d\u7f6e Kubernetes"},{"location":"vault/docs/auth/kubernetes/#api","text":"Kubernetes Auth \u63d2\u4ef6\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002","title":"API"},{"location":"vault/docs/auth/kubernetes/#_1","text":"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684 Kubernetes auth \u65b9\u6cd5\u3002 package main import ( \"fmt\" \"os\" vault \"github.com/hashicorp/vault/api\" auth \"github.com/hashicorp/vault/api-docs/auth/kubernetes\" ) // Fetches a key-value secret (kv-v2) after authenticating to Vault with a Kubernetes service account. // For a more in-depth setup explanation, please see the relevant readme in the hashicorp/vault-examples repo. func getSecretWithKubernetesAuth () ( string , error ) { // If set, the VAULT_ADDR environment variable will be the address that // your pod uses to communicate with Vault. config := vault . DefaultConfig () // modify for more granular configuration client , err := vault . NewClient ( config ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Vault client: %w\" , err ) } // The service-account token will be read from the path where the token's // Kubernetes Secret is mounted. By default, Kubernetes will mount it to // /var/run/secrets/kubernetes.io/serviceaccount/token, but an administrator // may have configured it to be mounted elsewhere. // In that case, we'll use the option WithServiceAccountTokenPath to look // for the token there. k8sAuth , err := auth . NewKubernetesAuth ( \"dev-role-k8s\" , auth . WithServiceAccountTokenPath ( \"path/to/service-account-token\" ), ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Kubernetes auth method: %w\" , err ) } authInfo , err := client . Auth (). Login ( context . TODO (), k8sAuth ) if err != nil { return \"\" , fmt . Errorf ( \"unable to log in with Kubernetes auth: %w\" , err ) } if authInfo == nil { return \"\" , fmt . Errorf ( \"no auth info was returned after login\" ) } // get secret from Vault, from the default mount path for KV v2 in dev mode, \"secret\" secret , err := client . KVv2 ( \"secret\" ). Get ( context . Background (), \"creds\" ) if err != nil { return \"\" , fmt . Errorf ( \"unable to read secret: %w\" , err ) } // data map can contain more than one key-value pair, // in this case we're just grabbing one of them value , ok := secret . Data [ \"password\" ].( string ) if ! ok { return \"\" , fmt . Errorf ( \"value type assertion failed: %T %#v\" , secret . Data [ \"password\" ], secret . Data [ \"password\" ]) } return value , nil }","title":"\u4ee3\u78bc\u793a\u4f8b"},{"location":"vault/docs/auth/overview/","text":"Auth Methods \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u662f Vault \u4e2d\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7d44\u4ef6\uff0c\u8ca0\u8cac\u70ba\u7528\u6236\u5206\u914d\u8eab\u4efd\u548c\u4e00\u7d44\u7b56\u7565\u3002\u5728\u6240\u6709\u60c5\u6cc1\u4e0b\uff0cVault \u90fd\u6703\u5728\u8acb\u6c42\u8655\u7406\u904e\u7a0b\u4e2d\u5f37\u5236\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0cVault \u6703\u5c07\u8eab\u4efd\u9a57\u8b49\u7ba1\u7406\u548c\u6c7a\u7b56\u59d4\u8a17\u7d66\u76f8\u95dc\u914d\u7f6e\u7684\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982\uff0cAmazon Web Services\u3001GitHub\u3001Google Cloud Platform\u3001Kubernetes\u3001Microsoft Azure\u3001Okta ...\uff09\u3002 \u64c1\u6709\u591a\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f7f\u60a8\u80fd\u5920\u4f7f\u7528\u5c0d\u60a8\u7684 Vault \u548c\u60a8\u7684\u7d44\u7e54\u7684\u7528\u4f8b\u6700\u6709\u610f\u7fa9\u7684\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 \u4f8b\u5982\uff0c\u5728\u7a0b\u5f0f\u958b\u767c\u8005\u7684\u96fb\u8166\u4e0a\uff0c GitHub auth \u65b9\u6cd5\u6700\u5bb9\u6613\u4f7f\u7528\u3002\u4f46\u662f\u5c0d\u65bc\u670d\u52d9\u5668\uff0c AppRole \u65b9\u6cd5\u662f\u63a8\u85a6\u7684\u9078\u64c7\u3002 \u8981\u4e86\u89e3\u6709\u95dc\u8eab\u4efd\u9a57\u8b49\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u8eab\u4efd\u9a57\u8b49\u6982\u5ff5 \u9801\u9762\u3002 Enabling/Disabling Auth Methods \u00b6 \u53ef\u4ee5\u4f7f\u7528 CLI \u6216 API \u555f\u7528/\u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable userpass \u555f\u7528\u5f8c\uff0cauth \u65b9\u6cd5\u985e\u4f3c\u65bc secrets engines\uff1a\u5b83\u5011\u88ab\u639b\u8f09\u5728 Vault mount table \u4e2d\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u6a19\u6e96\u8b80/\u5beb API \u8a2a\u554f\u548c\u914d\u7f6e\u3002\u6240\u6709 auth \u65b9\u6cd5\u90fd\u5b89\u88dd\u5728 auth/ \u524d\u7db4\u4e0b\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cauth \u65b9\u6cd5\u639b\u8f09\u5230 auth/<type> \u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u555f\u7528\u201cgithub\u201d\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u5728 auth/github \u8207\u5b83\u9032\u884c\u4ea4\u4e92\u3002\u4f46\u662f\uff0c\u6b64\u8def\u5f91\u662f\u53ef\u81ea\u5b9a\u7fa9\u7684\uff0c\u5141\u8a31\u5177\u6709\u9ad8\u7d1a\u7528\u4f8b\u7684\u7528\u6236\u591a\u6b21\u639b\u8f09\u55ae\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable -path = my-login userpass \u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\uff0c\u901a\u904e\u8a72\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u6240\u6709\u7528\u6236\u90fd\u5c07\u81ea\u52d5\u8a3b\u92b7\u3002 External Auth Method Considerations \u00b6 \u7576\u4f7f\u7528\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982 GitHub\uff09\u6642\uff0cVault \u5c07\u5728\u8eab\u4efd\u9a57\u8b49\u6642\u8abf\u7528\u5916\u90e8\u670d\u52d9\u4ee5\u53ca\u4efb\u4f55\u5f8c\u7e8c\u4ee4\u724c\u66f4\u65b0\u3002\u9019\u610f\u5473\u8457\u5df2\u767c\u884c\u7684\u4ee4\u724c\u5728\u5176\u6574\u500b\u6709\u6548\u671f\u5167\u90fd\u6709\u6548\uff0c\u4e26\u4e14\u5728\u66f4\u65b0\u6216\u7528\u6236\u91cd\u65b0\u8eab\u4efd\u9a57\u8b49\u767c\u751f\u4e4b\u524d\u4e0d\u6703\u5931\u6548\u3002\u904b\u71df\u5546\u61c9\u78ba\u4fdd\u5728\u4f7f\u7528\u9019\u4e9b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\u8a2d\u7f6e\u9069\u7576\u7684 \u4ee4\u724c TTL \u3002","title":"Overview"},{"location":"vault/docs/auth/overview/#auth-methods","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u662f Vault \u4e2d\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7d44\u4ef6\uff0c\u8ca0\u8cac\u70ba\u7528\u6236\u5206\u914d\u8eab\u4efd\u548c\u4e00\u7d44\u7b56\u7565\u3002\u5728\u6240\u6709\u60c5\u6cc1\u4e0b\uff0cVault \u90fd\u6703\u5728\u8acb\u6c42\u8655\u7406\u904e\u7a0b\u4e2d\u5f37\u5236\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0cVault \u6703\u5c07\u8eab\u4efd\u9a57\u8b49\u7ba1\u7406\u548c\u6c7a\u7b56\u59d4\u8a17\u7d66\u76f8\u95dc\u914d\u7f6e\u7684\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982\uff0cAmazon Web Services\u3001GitHub\u3001Google Cloud Platform\u3001Kubernetes\u3001Microsoft Azure\u3001Okta ...\uff09\u3002 \u64c1\u6709\u591a\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f7f\u60a8\u80fd\u5920\u4f7f\u7528\u5c0d\u60a8\u7684 Vault \u548c\u60a8\u7684\u7d44\u7e54\u7684\u7528\u4f8b\u6700\u6709\u610f\u7fa9\u7684\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 \u4f8b\u5982\uff0c\u5728\u7a0b\u5f0f\u958b\u767c\u8005\u7684\u96fb\u8166\u4e0a\uff0c GitHub auth \u65b9\u6cd5\u6700\u5bb9\u6613\u4f7f\u7528\u3002\u4f46\u662f\u5c0d\u65bc\u670d\u52d9\u5668\uff0c AppRole \u65b9\u6cd5\u662f\u63a8\u85a6\u7684\u9078\u64c7\u3002 \u8981\u4e86\u89e3\u6709\u95dc\u8eab\u4efd\u9a57\u8b49\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u8eab\u4efd\u9a57\u8b49\u6982\u5ff5 \u9801\u9762\u3002","title":"Auth Methods"},{"location":"vault/docs/auth/overview/#enablingdisabling-auth-methods","text":"\u53ef\u4ee5\u4f7f\u7528 CLI \u6216 API \u555f\u7528/\u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable userpass \u555f\u7528\u5f8c\uff0cauth \u65b9\u6cd5\u985e\u4f3c\u65bc secrets engines\uff1a\u5b83\u5011\u88ab\u639b\u8f09\u5728 Vault mount table \u4e2d\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u6a19\u6e96\u8b80/\u5beb API \u8a2a\u554f\u548c\u914d\u7f6e\u3002\u6240\u6709 auth \u65b9\u6cd5\u90fd\u5b89\u88dd\u5728 auth/ \u524d\u7db4\u4e0b\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cauth \u65b9\u6cd5\u639b\u8f09\u5230 auth/<type> \u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u555f\u7528\u201cgithub\u201d\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u5728 auth/github \u8207\u5b83\u9032\u884c\u4ea4\u4e92\u3002\u4f46\u662f\uff0c\u6b64\u8def\u5f91\u662f\u53ef\u81ea\u5b9a\u7fa9\u7684\uff0c\u5141\u8a31\u5177\u6709\u9ad8\u7d1a\u7528\u4f8b\u7684\u7528\u6236\u591a\u6b21\u639b\u8f09\u55ae\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable -path = my-login userpass \u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\uff0c\u901a\u904e\u8a72\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u6240\u6709\u7528\u6236\u90fd\u5c07\u81ea\u52d5\u8a3b\u92b7\u3002","title":"Enabling/Disabling Auth Methods"},{"location":"vault/docs/auth/overview/#external-auth-method-considerations","text":"\u7576\u4f7f\u7528\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982 GitHub\uff09\u6642\uff0cVault \u5c07\u5728\u8eab\u4efd\u9a57\u8b49\u6642\u8abf\u7528\u5916\u90e8\u670d\u52d9\u4ee5\u53ca\u4efb\u4f55\u5f8c\u7e8c\u4ee4\u724c\u66f4\u65b0\u3002\u9019\u610f\u5473\u8457\u5df2\u767c\u884c\u7684\u4ee4\u724c\u5728\u5176\u6574\u500b\u6709\u6548\u671f\u5167\u90fd\u6709\u6548\uff0c\u4e26\u4e14\u5728\u66f4\u65b0\u6216\u7528\u6236\u91cd\u65b0\u8eab\u4efd\u9a57\u8b49\u767c\u751f\u4e4b\u524d\u4e0d\u6703\u5931\u6548\u3002\u904b\u71df\u5546\u61c9\u78ba\u4fdd\u5728\u4f7f\u7528\u9019\u4e9b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\u8a2d\u7f6e\u9069\u7576\u7684 \u4ee4\u724c TTL \u3002","title":"External Auth Method Considerations"},{"location":"vault/docs/auth/userpass/","text":"Userpass Auth Method \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth/userpass userpass auth \u65b9\u6cd5\u5141\u8a31\u7528\u6236\u4f7f\u7528 username \u548c password \u7d44\u5408\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u7528\u6236\u540d/\u5bc6\u78bc\u7d44\u5408\u76f4\u63a5\u914d\u7f6e\u70ba\u4f7f\u7528 users/ \u8def\u5f91\u7684 auth \u65b9\u6cd5\u3002\u6b64\u65b9\u6cd5\u7121\u6cd5\u5f9e\u5916\u90e8\u6e90\u8b80\u53d6\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002 \u8a72\u65b9\u6cd5\u5c07\u6240\u6709\u63d0\u4ea4\u7684\u7528\u6236\u540d\u5c0f\u5beb\uff0c\u4f8b\u5982 Mary \u548c mary \u662f\u540c\u4e00\u500b\u4f7f\u7528\u8005\u3002 Authentication \u00b6 Via the CLI \u00b6 $ vault login -method = userpass \\ username = mitchellh \\ password = foo Via the API \u00b6 $ curl \\ --request POST \\ --data '{\"password\": \"foo\"}' \\ http://127.0.0.1:8200/v1/auth/userpass/login/mitchellh \u97ff\u61c9\u5c07\u5305\u542b auth.client_token \u4e2d\u7684\u4ee4\u724c\uff1a { \"lease_id\" : \"\" , \"renewable\" : false , \"lease_duration\" : 0 , \"data\" : null , \"auth\" : { \"client_token\" : \"c4f280f6-fdb2-18eb-89d3-589e2e834cdb\" , \"policies\" : [ \"admins\" ], \"metadata\" : { \"username\" : \"mitchellh\" }, \"lease_duration\" : 0 , \"renewable\" : false } } Configuration \u00b6 \u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531Vault \u7ba1\u7406\u54e1\u6216\u67d0\u7a2e\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 userpass auth \u65b9\u6cd5\uff1a $ vault auth enable userpass \u4f7f\u7528\u5141\u8a31\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u5c0d\u5176\u9032\u884c\u914d\u7f6e\uff1a $ vault write auth/userpass/users/mitchellh \\ password = foo \\ policies = admins \u9019\u5c07\u5275\u5efa\u4e00\u500b\u5bc6\u78bc\u70ba foo \u7684\u65b0\u7528\u6236 mitchellh \uff0c\u8a72\u7528\u6236\u5c07\u8207 admins \u7b56\u7565\u76f8\u95dc\u806f\u3002\u9019\u662f\u552f\u4e00\u9700\u8981\u7684\u914d\u7f6e\u3002 API \u00b6 Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 API \u3002","title":"Username & Password"},{"location":"vault/docs/auth/userpass/#userpass-auth-method","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth/userpass userpass auth \u65b9\u6cd5\u5141\u8a31\u7528\u6236\u4f7f\u7528 username \u548c password \u7d44\u5408\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u7528\u6236\u540d/\u5bc6\u78bc\u7d44\u5408\u76f4\u63a5\u914d\u7f6e\u70ba\u4f7f\u7528 users/ \u8def\u5f91\u7684 auth \u65b9\u6cd5\u3002\u6b64\u65b9\u6cd5\u7121\u6cd5\u5f9e\u5916\u90e8\u6e90\u8b80\u53d6\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002 \u8a72\u65b9\u6cd5\u5c07\u6240\u6709\u63d0\u4ea4\u7684\u7528\u6236\u540d\u5c0f\u5beb\uff0c\u4f8b\u5982 Mary \u548c mary \u662f\u540c\u4e00\u500b\u4f7f\u7528\u8005\u3002","title":"Userpass Auth Method"},{"location":"vault/docs/auth/userpass/#authentication","text":"","title":"Authentication"},{"location":"vault/docs/auth/userpass/#via-the-cli","text":"$ vault login -method = userpass \\ username = mitchellh \\ password = foo","title":"Via the CLI"},{"location":"vault/docs/auth/userpass/#via-the-api","text":"$ curl \\ --request POST \\ --data '{\"password\": \"foo\"}' \\ http://127.0.0.1:8200/v1/auth/userpass/login/mitchellh \u97ff\u61c9\u5c07\u5305\u542b auth.client_token \u4e2d\u7684\u4ee4\u724c\uff1a { \"lease_id\" : \"\" , \"renewable\" : false , \"lease_duration\" : 0 , \"data\" : null , \"auth\" : { \"client_token\" : \"c4f280f6-fdb2-18eb-89d3-589e2e834cdb\" , \"policies\" : [ \"admins\" ], \"metadata\" : { \"username\" : \"mitchellh\" }, \"lease_duration\" : 0 , \"renewable\" : false } }","title":"Via the API"},{"location":"vault/docs/auth/userpass/#configuration","text":"\u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531Vault \u7ba1\u7406\u54e1\u6216\u67d0\u7a2e\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 userpass auth \u65b9\u6cd5\uff1a $ vault auth enable userpass \u4f7f\u7528\u5141\u8a31\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u5c0d\u5176\u9032\u884c\u914d\u7f6e\uff1a $ vault write auth/userpass/users/mitchellh \\ password = foo \\ policies = admins \u9019\u5c07\u5275\u5efa\u4e00\u500b\u5bc6\u78bc\u70ba foo \u7684\u65b0\u7528\u6236 mitchellh \uff0c\u8a72\u7528\u6236\u5c07\u8207 admins \u7b56\u7565\u76f8\u95dc\u806f\u3002\u9019\u662f\u552f\u4e00\u9700\u8981\u7684\u914d\u7f6e\u3002","title":"Configuration"},{"location":"vault/docs/auth/userpass/#api","text":"Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 API \u3002","title":"API"},{"location":"vault/docs/platform/","text":"Kubernetes \u00b6 \u672c\u7ae0\u7bc0\u4ecb\u7d39\u5728 Kubernetes\u4e0a\u904b\u884c Vault\uff0c\u4e26\u89e3\u91cb\u67b6\u69cb\u3001\u914d\u7f6e\u3001\u5b89\u88dd\u548c\u5b89\u5168\u6ce8\u610f\u4e8b\u9805\u3002 Hashicorp \u5efa\u8b70\u4f7f\u7528\u5b98\u65b9 HashiCorp Vault Helm chart \u5c07 Vault \u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 Helm chart \u5141\u8a31\u7528\u6236\u4ee5\u5404\u7a2e\u914d\u7f6e\u90e8\u7f72 Vault\uff1a Dev \uff1a\u7528\u65bc\u6e2c\u8a66 Vault \u7684\u55ae\u500b\u5167\u5b58 Vault \u670d\u52d9\u5668 Standalone (default) \uff1a\u55ae\u500b Vault \u670d\u52d9\u5668\u4f7f\u7528\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u6301\u4e45\u4fdd\u5b58\u5230\u5377 High-Availability (HA) \uff1a\u4f7f\u7528 HA \u5b58\u5132\u5f8c\u7aef\uff08\u5982 Consul\uff09\u7684 Vault \u670d\u52d9\u5668\u96c6\u7fa4\uff08\u9ed8\u8a8d\uff09 External \uff1a\u4f9d\u8cf4\u65bc\u5916\u90e8 Vault \u670d\u52d9\u5668\u7684 Vault Agent Injector \u670d\u52d9\u5668 \u7528\u4f8b \u00b6 \u904b\u884c Vault Service \uff1aVault \u670d\u52d9\u5668\u96c6\u7fa4\u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\u3002\u9019\u53ef\u4ee5\u7531\u904b\u884c\u5728 Kubernetes \u5167\u90e8\u4ee5\u53ca Kubernetes \u5916\u90e8\u7684\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\uff0c\u53ea\u8981\u5b83\u5011\u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8207\u670d\u52d9\u5668\u901a\u4fe1\u3002 \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528\u8a31\u591a\u4e0d\u540c\u7684\u79d8\u5bc6\u5f15\u64ce\u548c\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5f9e Vault \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6\u3002 \u904b\u884c\u9ad8\u53ef\u7528 Vault \u670d\u52d9 \uff1a\u901a\u904e\u4f7f\u7528 pod \u95dc\u806f\u6027\u3001\u9ad8\u53ef\u7528\u5f8c\u7aef\u5b58\u5132\uff08\u5982 Consul\uff09\u548c\u81ea\u52d5\u89e3\u5c01\uff0cVault \u53ef\u4ee5\u6210\u70ba Kubernetes \u4e2d\u7684\u9ad8\u53ef\u7528\u670d\u52d9\u3002 \u52a0\u5bc6\u5373\u670d\u52d9 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u5229\u7528 Transit \u79d8\u5bc6\u5f15\u64ce\u4f5c\u70ba\u201c\u52a0\u5bc6\u5373\u670d\u52d9\u201d\u3002\u9019\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u5728\u5b58\u5132\u975c\u614b\u6578\u64da\u4e4b\u524d\u5c07\u52a0\u5bc6\u9700\u6c42\u5378\u8f09\u5230 Vault\u3002 Vault \u7684\u5be9\u8a08\u65e5\u8a8c \uff1a\u64cd\u4f5c\u54e1\u53ef\u4ee5\u9078\u64c7\u5c07\u6301\u4e45\u5377\u9644\u52a0\u5230 Vault \u96c6\u7fa4\uff0c\u8a72\u96c6\u7fa4\u53ef\u7528\u65bc\u5b58\u5132\u5be9\u8a08\u65e5\u8a8c\u3002 \u548c\u66f4\u591a\uff01 Vault \u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\uff0c\u56e0\u6b64\u9664\u4e86 Vault \u672c\u8eab\u63d0\u4f9b\u7684\u539f\u751f\u96c6\u6210\u4e4b\u5916\uff0c\u70ba Kubernetes \u69cb\u5efa\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u5177\u90fd\u53ef\u4ee5\u9078\u64c7\u5229\u7528 Vault\u3002 Vault \u6574\u5408 Kubernetes \u5165\u9580 \u00b6 \u6709\u5e7e\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u74b0\u5883\u4e2d\u5617\u8a66\u4f7f\u7528 Kubernetes \u7684 Vault\u3002 \u6307\u5357 \u00b6 \u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u5305\u62ec\u4f7f\u7528 Minikube \u548c\u5b98\u65b9 Helm chart\u5728\u672c\u5730\u5b89\u88dd Vault\u3002 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u63d0\u4f9b\u4e86\u4e00\u500b\u901a\u904e Kubernetes \u670d\u52d9\u548c\u7aef\u9ede\u4f7f Vault \u53ef\u8a2a\u554f\u7684\u793a\u4f8b\u3002 Kubernetes \u4e0a\u7684 Vault \u90e8\u7f72\u6307\u5357 \u6db5\u84cb\u4e86\u5b89\u88dd\u548c\u914d\u7f6e\u55ae\u500b HashiCorp Vault \u96c6\u7fa4\u6240\u9700\u7684\u6b65\u9a5f\uff0c\u5982 Kubernetes \u4e0a\u7684 Vault \u53c3\u8003\u67b6\u69cb \u4e2d\u5b9a\u7fa9\u7684\u90a3\u6a23\u3002","title":"Overview"},{"location":"vault/docs/platform/#kubernetes","text":"\u672c\u7ae0\u7bc0\u4ecb\u7d39\u5728 Kubernetes\u4e0a\u904b\u884c Vault\uff0c\u4e26\u89e3\u91cb\u67b6\u69cb\u3001\u914d\u7f6e\u3001\u5b89\u88dd\u548c\u5b89\u5168\u6ce8\u610f\u4e8b\u9805\u3002 Hashicorp \u5efa\u8b70\u4f7f\u7528\u5b98\u65b9 HashiCorp Vault Helm chart \u5c07 Vault \u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 Helm chart \u5141\u8a31\u7528\u6236\u4ee5\u5404\u7a2e\u914d\u7f6e\u90e8\u7f72 Vault\uff1a Dev \uff1a\u7528\u65bc\u6e2c\u8a66 Vault \u7684\u55ae\u500b\u5167\u5b58 Vault \u670d\u52d9\u5668 Standalone (default) \uff1a\u55ae\u500b Vault \u670d\u52d9\u5668\u4f7f\u7528\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u6301\u4e45\u4fdd\u5b58\u5230\u5377 High-Availability (HA) \uff1a\u4f7f\u7528 HA \u5b58\u5132\u5f8c\u7aef\uff08\u5982 Consul\uff09\u7684 Vault \u670d\u52d9\u5668\u96c6\u7fa4\uff08\u9ed8\u8a8d\uff09 External \uff1a\u4f9d\u8cf4\u65bc\u5916\u90e8 Vault \u670d\u52d9\u5668\u7684 Vault Agent Injector \u670d\u52d9\u5668","title":"Kubernetes"},{"location":"vault/docs/platform/#_1","text":"\u904b\u884c Vault Service \uff1aVault \u670d\u52d9\u5668\u96c6\u7fa4\u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\u3002\u9019\u53ef\u4ee5\u7531\u904b\u884c\u5728 Kubernetes \u5167\u90e8\u4ee5\u53ca Kubernetes \u5916\u90e8\u7684\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\uff0c\u53ea\u8981\u5b83\u5011\u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8207\u670d\u52d9\u5668\u901a\u4fe1\u3002 \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528\u8a31\u591a\u4e0d\u540c\u7684\u79d8\u5bc6\u5f15\u64ce\u548c\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5f9e Vault \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6\u3002 \u904b\u884c\u9ad8\u53ef\u7528 Vault \u670d\u52d9 \uff1a\u901a\u904e\u4f7f\u7528 pod \u95dc\u806f\u6027\u3001\u9ad8\u53ef\u7528\u5f8c\u7aef\u5b58\u5132\uff08\u5982 Consul\uff09\u548c\u81ea\u52d5\u89e3\u5c01\uff0cVault \u53ef\u4ee5\u6210\u70ba Kubernetes \u4e2d\u7684\u9ad8\u53ef\u7528\u670d\u52d9\u3002 \u52a0\u5bc6\u5373\u670d\u52d9 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u5229\u7528 Transit \u79d8\u5bc6\u5f15\u64ce\u4f5c\u70ba\u201c\u52a0\u5bc6\u5373\u670d\u52d9\u201d\u3002\u9019\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u5728\u5b58\u5132\u975c\u614b\u6578\u64da\u4e4b\u524d\u5c07\u52a0\u5bc6\u9700\u6c42\u5378\u8f09\u5230 Vault\u3002 Vault \u7684\u5be9\u8a08\u65e5\u8a8c \uff1a\u64cd\u4f5c\u54e1\u53ef\u4ee5\u9078\u64c7\u5c07\u6301\u4e45\u5377\u9644\u52a0\u5230 Vault \u96c6\u7fa4\uff0c\u8a72\u96c6\u7fa4\u53ef\u7528\u65bc\u5b58\u5132\u5be9\u8a08\u65e5\u8a8c\u3002 \u548c\u66f4\u591a\uff01 Vault \u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\uff0c\u56e0\u6b64\u9664\u4e86 Vault \u672c\u8eab\u63d0\u4f9b\u7684\u539f\u751f\u96c6\u6210\u4e4b\u5916\uff0c\u70ba Kubernetes \u69cb\u5efa\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u5177\u90fd\u53ef\u4ee5\u9078\u64c7\u5229\u7528 Vault\u3002","title":"\u7528\u4f8b"},{"location":"vault/docs/platform/#vault-kubernetes","text":"\u6709\u5e7e\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u74b0\u5883\u4e2d\u5617\u8a66\u4f7f\u7528 Kubernetes \u7684 Vault\u3002","title":"Vault \u6574\u5408 Kubernetes \u5165\u9580"},{"location":"vault/docs/platform/#_2","text":"\u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u5305\u62ec\u4f7f\u7528 Minikube \u548c\u5b98\u65b9 Helm chart\u5728\u672c\u5730\u5b89\u88dd Vault\u3002 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u63d0\u4f9b\u4e86\u4e00\u500b\u901a\u904e Kubernetes \u670d\u52d9\u548c\u7aef\u9ede\u4f7f Vault \u53ef\u8a2a\u554f\u7684\u793a\u4f8b\u3002 Kubernetes \u4e0a\u7684 Vault \u90e8\u7f72\u6307\u5357 \u6db5\u84cb\u4e86\u5b89\u88dd\u548c\u914d\u7f6e\u55ae\u500b HashiCorp Vault \u96c6\u7fa4\u6240\u9700\u7684\u6b65\u9a5f\uff0c\u5982 Kubernetes \u4e0a\u7684 Vault \u53c3\u8003\u67b6\u69cb \u4e2d\u5b9a\u7fa9\u7684\u90a3\u6a23\u3002","title":"\u6307\u5357"},{"location":"vault/docs/platform/injector-csi/","text":"Agent Injector \u5c0d\u6bd4 Vault CSI Provider \u00b6 \u672c\u6587\u6a94\u63a2\u8a0e\u4e86\u5c07 HashiCorp Vault \u8207 Kubernetes \u96c6\u6210\u7684\u5169\u7a2e\u4e0d\u540c\u65b9\u6cd5\u3002\u63d0\u4f9b\u7684\u4fe1\u606f\u9069\u7528\u65bc\u4e86\u89e3\u6a5f\u5bc6\u7ba1\u7406\u6982\u5ff5\u4e26\u719f\u6089 HashiCorp Vault \u548c Kubernetes \u7684 DevOps \u5f9e\u696d\u8005\u3002\u672c\u6587\u6a94\u9084\u63d0\u4f9b\u5be6\u7528\u6307\u5357\uff0c\u5e6b\u52a9\u60a8\u4e86\u89e3\u548c\u9078\u64c7\u6700\u9069\u5408\u60a8\u7684\u7528\u4f8b\u7684\u65b9\u6cd5\u3002 \u672c\u6587\u6a94\u4e2d\u5305\u542b\u7684\u4fe1\u606f\u8a73\u7d30\u8aaa\u660e\u4e86 Agent Injector \uff08\u5728\u672c\u6587\u6a94\u4e2d\u4e5f\u7a31\u70ba Vault Sidecar \u6216 Sidecar \uff09\u8207\u7528\u65bc\u96c6\u6210 Vault \u548c Kubernetes \u7684 Vault Container Storage Interface (CSI) \u63d0\u4f9b\u7a0b\u5e8f\u4e4b\u9593\u7684\u5c0d\u6bd4\u3002 Vault Sidecar Agent Injector \u00b6 Vault Sidecar Agent Injector \u5229\u7528 Sidecar \u6a21\u5f0f \u4f86\u66f4\u6539 pod \u898f\u7bc4\u4ee5\u5305\u542b\u4e00\u500b Vault Agent \u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u5c07 Vault \u6a5f\u5bc6\u5448\u73fe\u5230\u5171\u4eab\u5167\u5b58\u5377\u3002\u901a\u904e\u5c07\u79d8\u5bc6\u5448\u73fe\u7d66\u5171\u4eab\u5377\uff0cPod \u4e2d\u7684\u5bb9\u5668\u53ef\u4ee5\u4f7f\u7528 Vault \u79d8\u5bc6\u800c\u7121\u9700 Vault \u611f\u77e5\u3002\u6ce8\u5165\u5668\u662f\u4e00\u500b Kubernetes mutating webhook \u63a7\u5236\u5668\u3002\u5982\u679c\u8acb\u6c42\u4e2d\u5b58\u5728\u8a3b\u91cb\uff0c\u63a7\u5236\u5668\u6703\u6514\u622a pod \u4e8b\u4ef6\u4e26\u5c07\u8b8a\u66f4\u61c9\u7528\u65bc pod\u3002\u6b64\u529f\u80fd\u7531 Vault-k8s \u9805\u76ee\u63d0\u4f9b\uff0c\u53ef\u4ee5\u4f7f\u7528 Vault Helm \u5716\u8868\u81ea\u52d5\u5b89\u88dd\u548c\u914d\u7f6e\u3002","title":"Agent Injector \u5c0d\u6bd4 Vault CSI Provider"},{"location":"vault/docs/platform/injector-csi/#agent-injector-vault-csi-provider","text":"\u672c\u6587\u6a94\u63a2\u8a0e\u4e86\u5c07 HashiCorp Vault \u8207 Kubernetes \u96c6\u6210\u7684\u5169\u7a2e\u4e0d\u540c\u65b9\u6cd5\u3002\u63d0\u4f9b\u7684\u4fe1\u606f\u9069\u7528\u65bc\u4e86\u89e3\u6a5f\u5bc6\u7ba1\u7406\u6982\u5ff5\u4e26\u719f\u6089 HashiCorp Vault \u548c Kubernetes \u7684 DevOps \u5f9e\u696d\u8005\u3002\u672c\u6587\u6a94\u9084\u63d0\u4f9b\u5be6\u7528\u6307\u5357\uff0c\u5e6b\u52a9\u60a8\u4e86\u89e3\u548c\u9078\u64c7\u6700\u9069\u5408\u60a8\u7684\u7528\u4f8b\u7684\u65b9\u6cd5\u3002 \u672c\u6587\u6a94\u4e2d\u5305\u542b\u7684\u4fe1\u606f\u8a73\u7d30\u8aaa\u660e\u4e86 Agent Injector \uff08\u5728\u672c\u6587\u6a94\u4e2d\u4e5f\u7a31\u70ba Vault Sidecar \u6216 Sidecar \uff09\u8207\u7528\u65bc\u96c6\u6210 Vault \u548c Kubernetes \u7684 Vault Container Storage Interface (CSI) \u63d0\u4f9b\u7a0b\u5e8f\u4e4b\u9593\u7684\u5c0d\u6bd4\u3002","title":"Agent Injector \u5c0d\u6bd4 Vault CSI Provider"},{"location":"vault/docs/platform/injector-csi/#vault-sidecar-agent-injector","text":"Vault Sidecar Agent Injector \u5229\u7528 Sidecar \u6a21\u5f0f \u4f86\u66f4\u6539 pod \u898f\u7bc4\u4ee5\u5305\u542b\u4e00\u500b Vault Agent \u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u5c07 Vault \u6a5f\u5bc6\u5448\u73fe\u5230\u5171\u4eab\u5167\u5b58\u5377\u3002\u901a\u904e\u5c07\u79d8\u5bc6\u5448\u73fe\u7d66\u5171\u4eab\u5377\uff0cPod \u4e2d\u7684\u5bb9\u5668\u53ef\u4ee5\u4f7f\u7528 Vault \u79d8\u5bc6\u800c\u7121\u9700 Vault \u611f\u77e5\u3002\u6ce8\u5165\u5668\u662f\u4e00\u500b Kubernetes mutating webhook \u63a7\u5236\u5668\u3002\u5982\u679c\u8acb\u6c42\u4e2d\u5b58\u5728\u8a3b\u91cb\uff0c\u63a7\u5236\u5668\u6703\u6514\u622a pod \u4e8b\u4ef6\u4e26\u5c07\u8b8a\u66f4\u61c9\u7528\u65bc pod\u3002\u6b64\u529f\u80fd\u7531 Vault-k8s \u9805\u76ee\u63d0\u4f9b\uff0c\u53ef\u4ee5\u4f7f\u7528 Vault Helm \u5716\u8868\u81ea\u52d5\u5b89\u88dd\u548c\u914d\u7f6e\u3002","title":"Vault Sidecar Agent Injector"},{"location":"vault/docs/platform/helm/","text":"Helm Chart \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/platform/k8s/helm Vault Helm chart \u662f\u5728 Kubernetes \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Vault \u7684\u63a8\u85a6\u65b9\u5f0f\u3002\u9664\u4e86\u904b\u884c Vault \u672c\u8eab\u4e4b\u5916\uff0cHelm chart \u662f\u5b89\u88dd\u548c\u914d\u7f6e Vault \u4ee5\u8207\u5176\u4ed6\u670d\u52d9\u96c6\u6210\u7684\u4e3b\u8981\u65b9\u6cd5\uff0c\u4f8b\u5982 Consul for High Availability (HA) \u90e8\u7f72\u3002 \u6b64\u9801\u9762\u5047\u5b9a\u60a8\u5177\u6709 Helm \u7684\u4e00\u822c\u77e5\u8b58\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u3002\u4f7f\u7528 Helm \u5b89\u88dd Vault \u9700\u8981\u4f7f\u7528 Kubernetes \u96c6\u7fa4\u6b63\u78ba\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002 \u4f7f\u7528 Helm Chart \u00b6 \u5fc5\u9808\u5728\u60a8\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002\u8acb\u53c3\u95b1 Helm \u6587\u6a94 \u6216\u901a\u904e Helm \u5b89\u88dd\u5230 Minikube \u7684 Vault \u6559\u7a0b \u3002 \u8981\u4f7f\u7528 Helm chart\uff0c\u8acb\u6dfb\u52a0 Hashicorp helm \u5b58\u5132\u5eab\u4e26\u6aa2\u67e5\u60a8\u662f\u5426\u6709\u6b0a\u8a2a\u554f\u8a72 chart\uff1a $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories $ helm search repo hashicorp/vault NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart Warning \u91cd\u8981\u63d0\u793a\uff1aHelm chart \u6703\u6301\u7e8c\u88ab Hashicorpt \u958b\u767c\u66f4\u7248\u4e2d\u3002\u8acb\u59cb\u7d42\u5728\u5b89\u88dd\u6216\u5347\u7d1a\u4e4b\u524d\u4f7f\u7528 --dry-run \u904b\u884c Helm \u4ee5\u9a57\u8b49\u66f4\u6539\u3002 Helm chart \u7528\u6cd5\u793a\u4f8b\uff1a \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u5176\u4e2d pod \u4ee5\u540d\u7a31 vault \u70ba\u524d\u7db4\u3002 $ helm install vault hashicorp/vault \u5b89\u88dd\u7279\u5b9a\u7248\u672c\u7684 chart\u3002 # List the available releases $ helm search repo hashicorp/vault -l NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .20.0 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .19.0 1 .9.2 Official HashiCorp Vault Chart hashicorp/vault 0 .18.0 1 .9.0 Official HashiCorp Vault Chart hashicorp/vault 0 .17.1 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .17.0 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .16.1 1 .8.3 Official HashiCorp Vault Chart hashicorp/vault 0 .16.0 1 .8.2 Official HashiCorp Vault Chart hashicorp/vault 0 .15.0 1 .8.1 Official HashiCorp Vault Chart hashicorp/vault 0 .14.0 1 .8.0 Official HashiCorp Vault Chart hashicorp/vault 0 .13.0 1 .7.3 Official HashiCorp Vault Chart hashicorp/vault 0 .12.0 1 .7.2 Official HashiCorp Vault Chart hashicorp/vault 0 .11.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .10.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .9.1 1 .6.2 Official HashiCorp Vault Chart hashicorp/vault 0 .9.0 1 .6.1 Official HashiCorp Vault Chart hashicorp/vault 0 .8.0 1 .5.4 Official HashiCorp Vault Chart hashicorp/vault 0 .7.0 1 .5.2 Official HashiCorp Vault Chart hashicorp/vault 0 .6.0 1 .4.2 Official HashiCorp Vault Chart hashicorp/vault 0 .5.0 Install and configure Vault on Kubernetes. hashicorp/vault 0 .4.0 Install and configure Vault on Kubernetes. # Install version 0.20.1 $ helm install vault hashicorp/vault --version 0 .20.1 Info \u5b89\u5168\u8b66\u544a\uff1a\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cchart \u4ee5 standalong mode \u904b\u884c\u3002\u6b64\u6a21\u5f0f\u4f7f\u7528\u5e36\u6709\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u7684\u55ae\u500b Vault \u670d\u52d9\u5668\u3002\u9019\u662f\u4e00\u7a2e\u7c21\u6613\u5730\u5b89\u88dd\uff0c\u4e0d\u9069\u5408\u751f\u7522\u74b0\u5883\u7684\u8a2d\u7f6e\u3002\u5f37\u70c8\u5efa\u8b70\u4f7f\u7528\u9069\u7576\u4fdd\u8b77\u7684 Kubernetes \u96c6\u7fa4\uff0c\u4e86\u89e3\u53ef\u7528\u7684 \u914d\u7f6e\u9078\u9805 \uff0c\u4e26\u95b1\u8b80 \u751f\u7522\u90e8\u7f72\u6e05\u55ae \u3002 helm install \u547d\u4ee4\u63a5\u53d7\u53c3\u6578\u4ee5\u8986\u84cb\u4e8b\u5148\u5728 Helm \u4e2d\u5b9a\u7fa9\u7684\u9ed8\u8a8d\u914d\u7f6e\u503c\u3002 \u8986\u84cb server.dev.enabled \u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \u5728 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u8981\u8986\u84cb\u7684\u914d\u7f6e\u503c\uff1a override-values.yml server : ha : enabled : true replicas : 5 \u4f7f\u7528 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u4f86\u8986\u84cb\u9ed8\u8a8d\u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --values override-values.yml Dev mode \u00b6 Helm chart \u53ef\u4ee5\u904b\u884c\u4e00\u500b\u7528\u4f86\u8b93\u958b\u767c/\u9a57\u8b49\u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528 memory \u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 Info Dev mode\uff1a\u9019\u662f\u5b78\u7fd2\u548c\u6f14\u793a\u74b0\u5883\u7684\u7406\u60f3\u9078\u64c7\uff0c\u4f46\u4e0d\u63a8\u85a6\u7528\u65bc\u751f\u7522\u74b0\u5883\u3002 \u4f7f\u7528\u5728 Dev mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" Standalone mode \u00b6 Helm chart \u9ed8\u8a8d\u4ee5 Standalone mode \u5b89\u88dd Vault\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528\u6a94\u6848\u6587\u4ef6\u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 \u5728 Standalone mode \u4e0b\u5b89\u88dd Vault\u3002HA $ helm install vault hashicorp/vault HA mode \u00b6 Helm chart \u53ef\u4ee5\u5b89\u88dd\u4e00\u500b\u9ad8\u53ef\u7528\u6027 (HA) mode/ \u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e09\u500b\u5177\u6709\u4f7f\u7528 Consul \u5b58\u5132\u5f8c\u7aef\u7684 Vault \u670d\u52d9\u5668\u3002\u5efa\u8b70\u901a\u904e Consul Helm chart \u5b89\u88dd Consul\u3002 \u5728 HA mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.ha.enabled=true\" \u8acb\u53c3\u95b1 \u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u6559\u7a0b \uff0c\u4e86\u89e3\u5982\u4f55\u5728 HA \u6a21\u5f0f\u4e0b\u8a2d\u7f6e Consul \u548c Vault\u3002 External mode \u00b6 Helm chart\u53ef\u4ee5\u5728 External mode \u4e0b\u904b\u884c\u3002\u9019\u4e0d\u6703\u5b89\u88dd Vault \u670d\u52d9\u5668\uff0c\u800c\u662f\u4f9d\u8cf4\u65bc\u4e00\u500b\u5916\u90e8 Vault \u670d\u52d9\u5668\u3002 \u5728 External mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" \u8acb\u53c3\u95b1 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u6559\u7a0b\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528\u5916\u90e8 Vault\u3002 \u555f\u52d5 Vault UI \u00b6 Vault UI \u5df2\u555f\u7528\uff0c\u4f46\u51fa\u65bc\u5b89\u5168\u539f\u56e0\u672a\u4f5c\u70ba\u670d\u52d9\u516c\u958b\u3002 Vault UI \u4e5f\u53ef\u4ee5\u901a\u904e\u7aef\u53e3\u8f49\u767c\u6216\u901a\u904e ui \u914d\u7f6e\u503c \u516c\u958b\u3002 \u4f7f\u7528 port-forwarding \u516c\u958b Vault UI\uff1a $ kubectl port-forward vault-0 8200 :8200 Initialize \u8207 Unseal Vault \u00b6 \u5728\u4ee5 standalone \u6216 ha \u6a21\u5f0f\u5b89\u88dd Vault Helm chart\u5f8c\uff0c\u9700\u8981 \u521d\u59cb\u5316 \u5176\u4e2d\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u521d\u59cb\u5316\u6703\u751f\u6210 unseal \u6240\u6709 Vault \u670d\u52d9\u5668\u6240\u9700\u7684\u6191\u64da\u3002 CLI initialize \u8207 unseal \u00b6 \u67e5\u770b\u7576\u524d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 Vault pod\uff1a $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 0 /1 Running 0 1m49s vault-1 0 /1 Running 0 1m49s vault-2 0 /1 Running 0 1m49s \u4f7f\u7528\u9ed8\u8a8d\u7684\u5bc6\u9470\u5171\u4eab\u6578\u91cf\u548c\u9ed8\u8a8d\u7684\u5bc6\u9470\u95be\u503c\u521d\u59cb\u5316\u4e00\u500b Vault \u670d\u52d9\u5668\uff1a $ kubectl exec -ti vault-0 -- vault operator init Unseal Key 1 : MBFSDepD9E6whREc6Dj+k3pMaKJ6cCnCUWcySJQymObb Unseal Key 2 : zQj4v22k9ixegS+94HJwmIaWLBL3nZHe1i+b/wHz25fr Unseal Key 3 : 7dbPPeeGGW3SmeBFFo04peCKkXFuuyKc8b2DuntA4VU5 Unseal Key 4 : tLt+ME7Z7hYUATfWnuQdfCEgnKA2L173dptAwfmenCdf Unseal Key 5 : vYt9bxLr0+OzJ8m7c7cNMFj7nvdLljj0xWRbpLezFAI9 Initial Root Token: s.zJNwZlRrqISjyBHFMiEca6GF ##... Info \u8a18\u5f97\u5148\u628a\u9019\u4e9b\u89e3\u5c01\u7684\u5bc6\u9470\u8207 Root Token\u4fdd\u5b58\u8d77\u4f86 \u8f38\u51fa\u986f\u793a\u5bc6\u9470\u5171\u4eab\u548c\u751f\u6210\u7684\u521d\u59cb\u6839\u5bc6\u9470\u3002 \u4f7f\u7528\u5bc6\u9470\u5171\u4eab\u89e3\u5c01 Vault \u670d\u52d9\u5668\uff0c\u76f4\u5230\u6eff\u8db3\u5bc6\u9470\u95be\u503c\uff1a ## Unseal the first vault server until it reaches the key threshold $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 1 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 2 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 3 \u5c0d\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u91cd\u8907\u89e3\u5c01\u904e\u7a0b\u3002\u7576\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u90fd\u6253\u958b\u6642\uff0c\u5b83\u5011\u6703\u5831\u544a READY 1/1\u3002 $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 1m49s vault-1 1 /1 Running 0 1m49s vault-2 1 /1 Running 0 1m49s \u63a2\u91dd Probes \u00b6 \u63a2\u91dd Probes \u5c0d\u65bc\u5728 Kubernetes \u4e2d\u6aa2\u6e2c\u6545\u969c\u3001\u91cd\u65b0\u8abf\u5ea6\u548c\u4f7f\u7528 pod \u81f3\u95dc\u91cd\u8981\u3002 helm chart \u63d0\u4f9b\u53ef\u914d\u7f6e\u7684\u5c31\u7dd2\u548c\u6d3b\u8e8d\u5ea6\u63a2\u91dd\uff0c\u53ef\u4ee5\u91dd\u5c0d\u5404\u7a2e\u7528\u4f8b\u9032\u884c\u5b9a\u5236\u3002 \u53ef\u4ee5\u81ea\u5b9a\u7fa9 Vault \u7684 /sys/health \u7aef\u9ede\u4ee5\u66f4\u6539\u904b\u884c\u72c0\u6cc1\u6aa2\u67e5\u7684\u884c\u70ba\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u63a2\u91dd\u66f4\u6539 Vault \u5c31\u7dd2\u63a2\u6e2c\u4ee5\u986f\u793a Vault pod \u5df2\u6e96\u5099\u5c31\u7dd2\uff0c\u5373\u4f7f\u5b83\u5011\u4ecd\u672a\u521d\u59cb\u5316\u548c\u5bc6\u5c01\u72c0\u614b\uff1a server : readinessProbe : enabled : true path : '/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204' \u4f7f\u7528\u9019\u500b\u5b9a\u5236\u7684\u63a2\u91dd\uff0c\u4e00\u65e6 pod \u6e96\u5099\u597d\u9032\u884c\u5176\u4ed6\u8a2d\u7f6e\uff0cpostStart \u8173\u672c\u5c31\u53ef\u4ee5\u81ea\u52d5\u904b\u884c\u3002 \u4fdd\u8b77\u654f\u611f\u7684 Vault \u914d\u7f6e\u8cc7\u8a0a \u00b6 Vault Helm \u6703\u5728\u5b89\u88dd Vault \u7684\u904e\u7a0b\u4e2d\u751f\u6210\u4e00\u4f6a Vault \u914d\u7f6e\u6587\u4ef6\uff0c\u4e26\u5c07\u8a72\u6587\u4ef6\u5b58\u5132\u5728 Kubernetes configmap \u4e2d\u3002\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u80fd\u5305\u542b\u4e86\u4e00\u4e9b\u654f\u611f\u6578\u64da\u914d\u7f6e\u8cc7\u8a0a\uff0c\u4e26\u4e14\u4e00\u65e6\u5728 Kubernetes \u4e2d\u5275\u5efa\u4e4b\u5f8c\u5c31\u4e0d\u6703\u88ab\u975c\u614b\u52a0\u5bc6\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u5411 Vault Helm \u6dfb\u52a0\u984d\u5916\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4ee5\u4fdd\u8b77\u654f\u611f\u914d\u7f6e\u4e0d\u4f7f\u7528 Kubernetes \u6a5f\u5bc6\u4ee5\u975c\u614b\u660e\u6587\u5f62\u5f0f\u51fa\u73fe\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u555f\u52d5\u671f\u9593 Vault \u52a0\u8f09\u7684\u654f\u611f\u8a2d\u7f6e\u5275\u5efa\u90e8\u5206 Vault \u914d\u7f6e\uff1a config.hcl storage \"mysql\" { username = \"user1234\" password = \"secret123!\" database = \"vault\" } \u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u5305\u542b\u6b64\u90e8\u5206\u914d\u7f6e\u7684 Kubernetes secret\uff1a $ kubectl create secret generic vault-storage-config \\ --from-file = config.hcl \u6700\u5f8c\uff0c\u5c07\u6b64 secret \u639b\u8f09\u70ba\u4e00\u500b\u984d\u5916\u7684 volume\uff0c\u4e26\u5728 Vault \u555f\u52d5\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e00\u500b\u984d\u5916\u7684 -config \u6a19\u8a8c\uff1a $ helm install vault hashicorp/vault \\ --set = 'server.volumes[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumes[0].secret.defaultMode=420' \\ --set = 'server.volumes[0].secret.secretName=vault-storage-config' \\ --set = 'server.volumeMounts[0].mountPath=/vault/userconfig/vault-storage-config' \\ --set = 'server.volumeMounts[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumeMounts[0].readOnly=true' \\ --set = 'server.extraArgs=-config=/vault/userconfig/vault-storage-config/config.hcl'","title":"Overview"},{"location":"vault/docs/platform/helm/#helm-chart","text":"\u539f\u6587: https://www.vaultproject.io/docs/platform/k8s/helm Vault Helm chart \u662f\u5728 Kubernetes \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Vault \u7684\u63a8\u85a6\u65b9\u5f0f\u3002\u9664\u4e86\u904b\u884c Vault \u672c\u8eab\u4e4b\u5916\uff0cHelm chart \u662f\u5b89\u88dd\u548c\u914d\u7f6e Vault \u4ee5\u8207\u5176\u4ed6\u670d\u52d9\u96c6\u6210\u7684\u4e3b\u8981\u65b9\u6cd5\uff0c\u4f8b\u5982 Consul for High Availability (HA) \u90e8\u7f72\u3002 \u6b64\u9801\u9762\u5047\u5b9a\u60a8\u5177\u6709 Helm \u7684\u4e00\u822c\u77e5\u8b58\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u3002\u4f7f\u7528 Helm \u5b89\u88dd Vault \u9700\u8981\u4f7f\u7528 Kubernetes \u96c6\u7fa4\u6b63\u78ba\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002","title":"Helm Chart"},{"location":"vault/docs/platform/helm/#helm-chart_1","text":"\u5fc5\u9808\u5728\u60a8\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002\u8acb\u53c3\u95b1 Helm \u6587\u6a94 \u6216\u901a\u904e Helm \u5b89\u88dd\u5230 Minikube \u7684 Vault \u6559\u7a0b \u3002 \u8981\u4f7f\u7528 Helm chart\uff0c\u8acb\u6dfb\u52a0 Hashicorp helm \u5b58\u5132\u5eab\u4e26\u6aa2\u67e5\u60a8\u662f\u5426\u6709\u6b0a\u8a2a\u554f\u8a72 chart\uff1a $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories $ helm search repo hashicorp/vault NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart Warning \u91cd\u8981\u63d0\u793a\uff1aHelm chart \u6703\u6301\u7e8c\u88ab Hashicorpt \u958b\u767c\u66f4\u7248\u4e2d\u3002\u8acb\u59cb\u7d42\u5728\u5b89\u88dd\u6216\u5347\u7d1a\u4e4b\u524d\u4f7f\u7528 --dry-run \u904b\u884c Helm \u4ee5\u9a57\u8b49\u66f4\u6539\u3002 Helm chart \u7528\u6cd5\u793a\u4f8b\uff1a \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u5176\u4e2d pod \u4ee5\u540d\u7a31 vault \u70ba\u524d\u7db4\u3002 $ helm install vault hashicorp/vault \u5b89\u88dd\u7279\u5b9a\u7248\u672c\u7684 chart\u3002 # List the available releases $ helm search repo hashicorp/vault -l NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .20.0 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .19.0 1 .9.2 Official HashiCorp Vault Chart hashicorp/vault 0 .18.0 1 .9.0 Official HashiCorp Vault Chart hashicorp/vault 0 .17.1 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .17.0 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .16.1 1 .8.3 Official HashiCorp Vault Chart hashicorp/vault 0 .16.0 1 .8.2 Official HashiCorp Vault Chart hashicorp/vault 0 .15.0 1 .8.1 Official HashiCorp Vault Chart hashicorp/vault 0 .14.0 1 .8.0 Official HashiCorp Vault Chart hashicorp/vault 0 .13.0 1 .7.3 Official HashiCorp Vault Chart hashicorp/vault 0 .12.0 1 .7.2 Official HashiCorp Vault Chart hashicorp/vault 0 .11.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .10.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .9.1 1 .6.2 Official HashiCorp Vault Chart hashicorp/vault 0 .9.0 1 .6.1 Official HashiCorp Vault Chart hashicorp/vault 0 .8.0 1 .5.4 Official HashiCorp Vault Chart hashicorp/vault 0 .7.0 1 .5.2 Official HashiCorp Vault Chart hashicorp/vault 0 .6.0 1 .4.2 Official HashiCorp Vault Chart hashicorp/vault 0 .5.0 Install and configure Vault on Kubernetes. hashicorp/vault 0 .4.0 Install and configure Vault on Kubernetes. # Install version 0.20.1 $ helm install vault hashicorp/vault --version 0 .20.1 Info \u5b89\u5168\u8b66\u544a\uff1a\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cchart \u4ee5 standalong mode \u904b\u884c\u3002\u6b64\u6a21\u5f0f\u4f7f\u7528\u5e36\u6709\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u7684\u55ae\u500b Vault \u670d\u52d9\u5668\u3002\u9019\u662f\u4e00\u7a2e\u7c21\u6613\u5730\u5b89\u88dd\uff0c\u4e0d\u9069\u5408\u751f\u7522\u74b0\u5883\u7684\u8a2d\u7f6e\u3002\u5f37\u70c8\u5efa\u8b70\u4f7f\u7528\u9069\u7576\u4fdd\u8b77\u7684 Kubernetes \u96c6\u7fa4\uff0c\u4e86\u89e3\u53ef\u7528\u7684 \u914d\u7f6e\u9078\u9805 \uff0c\u4e26\u95b1\u8b80 \u751f\u7522\u90e8\u7f72\u6e05\u55ae \u3002 helm install \u547d\u4ee4\u63a5\u53d7\u53c3\u6578\u4ee5\u8986\u84cb\u4e8b\u5148\u5728 Helm \u4e2d\u5b9a\u7fa9\u7684\u9ed8\u8a8d\u914d\u7f6e\u503c\u3002 \u8986\u84cb server.dev.enabled \u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \u5728 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u8981\u8986\u84cb\u7684\u914d\u7f6e\u503c\uff1a override-values.yml server : ha : enabled : true replicas : 5 \u4f7f\u7528 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u4f86\u8986\u84cb\u9ed8\u8a8d\u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --values override-values.yml","title":"\u4f7f\u7528 Helm Chart"},{"location":"vault/docs/platform/helm/#dev-mode","text":"Helm chart \u53ef\u4ee5\u904b\u884c\u4e00\u500b\u7528\u4f86\u8b93\u958b\u767c/\u9a57\u8b49\u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528 memory \u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 Info Dev mode\uff1a\u9019\u662f\u5b78\u7fd2\u548c\u6f14\u793a\u74b0\u5883\u7684\u7406\u60f3\u9078\u64c7\uff0c\u4f46\u4e0d\u63a8\u85a6\u7528\u65bc\u751f\u7522\u74b0\u5883\u3002 \u4f7f\u7528\u5728 Dev mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\"","title":"Dev mode"},{"location":"vault/docs/platform/helm/#standalone-mode","text":"Helm chart \u9ed8\u8a8d\u4ee5 Standalone mode \u5b89\u88dd Vault\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528\u6a94\u6848\u6587\u4ef6\u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 \u5728 Standalone mode \u4e0b\u5b89\u88dd Vault\u3002HA $ helm install vault hashicorp/vault","title":"Standalone mode"},{"location":"vault/docs/platform/helm/#ha-mode","text":"Helm chart \u53ef\u4ee5\u5b89\u88dd\u4e00\u500b\u9ad8\u53ef\u7528\u6027 (HA) mode/ \u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e09\u500b\u5177\u6709\u4f7f\u7528 Consul \u5b58\u5132\u5f8c\u7aef\u7684 Vault \u670d\u52d9\u5668\u3002\u5efa\u8b70\u901a\u904e Consul Helm chart \u5b89\u88dd Consul\u3002 \u5728 HA mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.ha.enabled=true\" \u8acb\u53c3\u95b1 \u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u6559\u7a0b \uff0c\u4e86\u89e3\u5982\u4f55\u5728 HA \u6a21\u5f0f\u4e0b\u8a2d\u7f6e Consul \u548c Vault\u3002","title":"HA mode"},{"location":"vault/docs/platform/helm/#external-mode","text":"Helm chart\u53ef\u4ee5\u5728 External mode \u4e0b\u904b\u884c\u3002\u9019\u4e0d\u6703\u5b89\u88dd Vault \u670d\u52d9\u5668\uff0c\u800c\u662f\u4f9d\u8cf4\u65bc\u4e00\u500b\u5916\u90e8 Vault \u670d\u52d9\u5668\u3002 \u5728 External mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" \u8acb\u53c3\u95b1 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u6559\u7a0b\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528\u5916\u90e8 Vault\u3002","title":"External mode"},{"location":"vault/docs/platform/helm/#vault-ui","text":"Vault UI \u5df2\u555f\u7528\uff0c\u4f46\u51fa\u65bc\u5b89\u5168\u539f\u56e0\u672a\u4f5c\u70ba\u670d\u52d9\u516c\u958b\u3002 Vault UI \u4e5f\u53ef\u4ee5\u901a\u904e\u7aef\u53e3\u8f49\u767c\u6216\u901a\u904e ui \u914d\u7f6e\u503c \u516c\u958b\u3002 \u4f7f\u7528 port-forwarding \u516c\u958b Vault UI\uff1a $ kubectl port-forward vault-0 8200 :8200","title":"\u555f\u52d5 Vault UI"},{"location":"vault/docs/platform/helm/#initialize-unseal-vault","text":"\u5728\u4ee5 standalone \u6216 ha \u6a21\u5f0f\u5b89\u88dd Vault Helm chart\u5f8c\uff0c\u9700\u8981 \u521d\u59cb\u5316 \u5176\u4e2d\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u521d\u59cb\u5316\u6703\u751f\u6210 unseal \u6240\u6709 Vault \u670d\u52d9\u5668\u6240\u9700\u7684\u6191\u64da\u3002","title":"Initialize \u8207 Unseal Vault"},{"location":"vault/docs/platform/helm/#cli-initialize-unseal","text":"\u67e5\u770b\u7576\u524d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 Vault pod\uff1a $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 0 /1 Running 0 1m49s vault-1 0 /1 Running 0 1m49s vault-2 0 /1 Running 0 1m49s \u4f7f\u7528\u9ed8\u8a8d\u7684\u5bc6\u9470\u5171\u4eab\u6578\u91cf\u548c\u9ed8\u8a8d\u7684\u5bc6\u9470\u95be\u503c\u521d\u59cb\u5316\u4e00\u500b Vault \u670d\u52d9\u5668\uff1a $ kubectl exec -ti vault-0 -- vault operator init Unseal Key 1 : MBFSDepD9E6whREc6Dj+k3pMaKJ6cCnCUWcySJQymObb Unseal Key 2 : zQj4v22k9ixegS+94HJwmIaWLBL3nZHe1i+b/wHz25fr Unseal Key 3 : 7dbPPeeGGW3SmeBFFo04peCKkXFuuyKc8b2DuntA4VU5 Unseal Key 4 : tLt+ME7Z7hYUATfWnuQdfCEgnKA2L173dptAwfmenCdf Unseal Key 5 : vYt9bxLr0+OzJ8m7c7cNMFj7nvdLljj0xWRbpLezFAI9 Initial Root Token: s.zJNwZlRrqISjyBHFMiEca6GF ##... Info \u8a18\u5f97\u5148\u628a\u9019\u4e9b\u89e3\u5c01\u7684\u5bc6\u9470\u8207 Root Token\u4fdd\u5b58\u8d77\u4f86 \u8f38\u51fa\u986f\u793a\u5bc6\u9470\u5171\u4eab\u548c\u751f\u6210\u7684\u521d\u59cb\u6839\u5bc6\u9470\u3002 \u4f7f\u7528\u5bc6\u9470\u5171\u4eab\u89e3\u5c01 Vault \u670d\u52d9\u5668\uff0c\u76f4\u5230\u6eff\u8db3\u5bc6\u9470\u95be\u503c\uff1a ## Unseal the first vault server until it reaches the key threshold $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 1 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 2 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 3 \u5c0d\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u91cd\u8907\u89e3\u5c01\u904e\u7a0b\u3002\u7576\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u90fd\u6253\u958b\u6642\uff0c\u5b83\u5011\u6703\u5831\u544a READY 1/1\u3002 $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 1m49s vault-1 1 /1 Running 0 1m49s vault-2 1 /1 Running 0 1m49s","title":"CLI initialize \u8207 unseal"},{"location":"vault/docs/platform/helm/#probes","text":"\u63a2\u91dd Probes \u5c0d\u65bc\u5728 Kubernetes \u4e2d\u6aa2\u6e2c\u6545\u969c\u3001\u91cd\u65b0\u8abf\u5ea6\u548c\u4f7f\u7528 pod \u81f3\u95dc\u91cd\u8981\u3002 helm chart \u63d0\u4f9b\u53ef\u914d\u7f6e\u7684\u5c31\u7dd2\u548c\u6d3b\u8e8d\u5ea6\u63a2\u91dd\uff0c\u53ef\u4ee5\u91dd\u5c0d\u5404\u7a2e\u7528\u4f8b\u9032\u884c\u5b9a\u5236\u3002 \u53ef\u4ee5\u81ea\u5b9a\u7fa9 Vault \u7684 /sys/health \u7aef\u9ede\u4ee5\u66f4\u6539\u904b\u884c\u72c0\u6cc1\u6aa2\u67e5\u7684\u884c\u70ba\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u63a2\u91dd\u66f4\u6539 Vault \u5c31\u7dd2\u63a2\u6e2c\u4ee5\u986f\u793a Vault pod \u5df2\u6e96\u5099\u5c31\u7dd2\uff0c\u5373\u4f7f\u5b83\u5011\u4ecd\u672a\u521d\u59cb\u5316\u548c\u5bc6\u5c01\u72c0\u614b\uff1a server : readinessProbe : enabled : true path : '/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204' \u4f7f\u7528\u9019\u500b\u5b9a\u5236\u7684\u63a2\u91dd\uff0c\u4e00\u65e6 pod \u6e96\u5099\u597d\u9032\u884c\u5176\u4ed6\u8a2d\u7f6e\uff0cpostStart \u8173\u672c\u5c31\u53ef\u4ee5\u81ea\u52d5\u904b\u884c\u3002","title":"\u63a2\u91dd Probes"},{"location":"vault/docs/platform/helm/#vault","text":"Vault Helm \u6703\u5728\u5b89\u88dd Vault \u7684\u904e\u7a0b\u4e2d\u751f\u6210\u4e00\u4f6a Vault \u914d\u7f6e\u6587\u4ef6\uff0c\u4e26\u5c07\u8a72\u6587\u4ef6\u5b58\u5132\u5728 Kubernetes configmap \u4e2d\u3002\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u80fd\u5305\u542b\u4e86\u4e00\u4e9b\u654f\u611f\u6578\u64da\u914d\u7f6e\u8cc7\u8a0a\uff0c\u4e26\u4e14\u4e00\u65e6\u5728 Kubernetes \u4e2d\u5275\u5efa\u4e4b\u5f8c\u5c31\u4e0d\u6703\u88ab\u975c\u614b\u52a0\u5bc6\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u5411 Vault Helm \u6dfb\u52a0\u984d\u5916\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4ee5\u4fdd\u8b77\u654f\u611f\u914d\u7f6e\u4e0d\u4f7f\u7528 Kubernetes \u6a5f\u5bc6\u4ee5\u975c\u614b\u660e\u6587\u5f62\u5f0f\u51fa\u73fe\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u555f\u52d5\u671f\u9593 Vault \u52a0\u8f09\u7684\u654f\u611f\u8a2d\u7f6e\u5275\u5efa\u90e8\u5206 Vault \u914d\u7f6e\uff1a config.hcl storage \"mysql\" { username = \"user1234\" password = \"secret123!\" database = \"vault\" } \u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u5305\u542b\u6b64\u90e8\u5206\u914d\u7f6e\u7684 Kubernetes secret\uff1a $ kubectl create secret generic vault-storage-config \\ --from-file = config.hcl \u6700\u5f8c\uff0c\u5c07\u6b64 secret \u639b\u8f09\u70ba\u4e00\u500b\u984d\u5916\u7684 volume\uff0c\u4e26\u5728 Vault \u555f\u52d5\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e00\u500b\u984d\u5916\u7684 -config \u6a19\u8a8c\uff1a $ helm install vault hashicorp/vault \\ --set = 'server.volumes[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumes[0].secret.defaultMode=420' \\ --set = 'server.volumes[0].secret.secretName=vault-storage-config' \\ --set = 'server.volumeMounts[0].mountPath=/vault/userconfig/vault-storage-config' \\ --set = 'server.volumeMounts[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumeMounts[0].readOnly=true' \\ --set = 'server.extraArgs=-config=/vault/userconfig/vault-storage-config/config.hcl'","title":"\u4fdd\u8b77\u654f\u611f\u7684 Vault \u914d\u7f6e\u8cc7\u8a0a"},{"location":"vault/kubernetes/agent-kubernetes/","text":"Vault Agent with Kubernetes \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/agent-kubernetes?in=vault/auth-methods \u5e7e\u4e4e\u6240\u6709\u5c0d Vault \u7684\u8acb\u6c42\u90fd\u5fc5\u9808\u9644\u6709\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3002\u9019\u5305\u62ec\u6240\u6709 API \u8acb\u6c42\uff0c\u4ee5\u53ca\u901a\u904e Vault CLI \u7684\u8acb\u6c42\u3002\u5982\u679c\u60a8\u53ef\u4ee5\u5b89\u5168\u5730\u5f9e\u767c\u8d77\u8005\u90a3\u88e1\u7372\u5f97\u7b2c\u4e00\u500b\u79d8\u5bc6\u5230\u6d88\u8cbb\u8005\uff0c\u90a3\u9ebc\u5728\u8a72\u767c\u8d77\u8005\u548c\u6d88\u8cbb\u8005\u4e4b\u9593\u50b3\u8f38\u7684\u6240\u6709\u5f8c\u7e8c\u79d8\u5bc6\u90fd\u53ef\u4ee5\u901a\u904e\u6210\u529f\u5206\u767c\u548c\u8a72\u7b2c\u4e00\u500b\u79d8\u5bc6\u7684\u7528\u6236\u5efa\u7acb\u7684\u4fe1\u4efb\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 Challenge \u00b6 \u5728 Kubernetes \u74b0\u5883\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u4e5f\u4e0d\u4f8b\u5916\u3002\u5e78\u904b\u7684\u662f\uff0cVault \u63d0\u4f9b\u4e86 Kubernetes auth \u65b9\u6cd5 \u4f86\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service Account)\u4ee4\u724c\u5c0d\u5ba2\u6236\u7aef\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u4f46\u662f\uff0c\u5ba2\u6236\u7aef(\u6bcf\u4e00\u500b\u5728K8S\u88e1\u982d\u7684Pod)\u4ecd\u7136\u9700\u8981\u8ca0\u8cac\u7ba1\u7406 Vault \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f(TTL)\u3002\u56e0\u6b64\uff0c\u4e0b\u4e00\u500b\u6311\u6230\u8b8a\u6210\u77ad\u5982\u4f55\u4ee5\u6a19\u6e96\u65b9\u5f0f\u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\uff0c\u800c\u7121\u9700\u7de8\u5beb\u81ea\u5b9a\u7fa9\u908f\u8f2f\u3002 Solution \u00b6 Vault Agent \u63d0\u4f9b\u4e86\u8a31\u591a\u4e0d\u540c\u7684\u5e6b\u52a9\u529f\u80fd\uff0c\u5c08\u9580\u89e3\u6c7a\u4ee5\u4e0b\u6311\u6230\uff1a \u81ea\u52d5\u8a8d\u8b49 \u4ee4\u724c\u7684\u5b89\u5168\u4ea4\u4ed8/\u5b58\u5132 \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u7ba1\u7406\uff08\u66f4\u65b0\u548c\u91cd\u65b0\u8a8d\u8b49\uff09 Info \u672c\u6559\u7a0b\u91cd\u9ede\u4ecb\u7d39\u4f7f\u7528 kubernetes auth \u65b9\u6cd5\u7684 Vault Agent Auto-Auth \u7684\u6f14\u793a\u3002 Vault Helm \u5f15\u5165\u4e86 Agent Sidecar Injector\u3002\u6709\u95dc Sidecar \u4f7f\u7528\u7684\u5206\u6b65\u6559\u7a0b\uff0c\u8acb\u53c3\u95b1\u901a\u904e Vault Helm Sidecar \u5c07 Secrets \u6ce8\u5165 Kubernetes Pod\u3002 Prerequisites \u00b6 \u8981\u57f7\u884c\u672c\u6559\u7a0b\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\uff0c\u60a8\u9700\u8981\uff1a \u4e00\u500b\u5b89\u88dd\u597d\u4e86\u7684 Minikube \u53ef\u5f9e Kubernetes \u74b0\u5883\u8a2a\u554f\u5230\u7684 Vault \u74b0\u5883\u3002\u8acb\u53c3\u95b1\u5165\u9580\u6559\u7a0b\u4ee5\u5b89\u88dd Vault\u3002\u78ba\u4fdd\u60a8\u7684 Vault \u670d\u52d9\u5668\u5df2\u521d\u59cb\u5316\u4e26\u89e3\u5c01 Info \u6ce8\u610f\uff1a\u51fa\u65bc\u6f14\u793a\u7684\u76ee\u7684\uff0c\u672c\u6559\u7a0b\u5c07 Minikube \u4f5c\u70ba Kubernetes \u74b0\u5883\u904b\u884c\u3002\u5982\u679c\u4f60\u5e0c\u671b\u6539\u70ba\u91dd\u5c0d Azure Kubernetes \u670d\u52d9 (AKS) \u7fa4\u96c6\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u6309\u7167 Azure Kubernetes \u670d\u52d9\u7fa4\u96c6\u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\u5275\u5efa AKS \u7fa4\u96c6\u3002\u5982\u679c\u8981\u91dd\u5c0d Google Kubernetes Engine (GKE) \u96c6\u7fa4\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u53c3\u95b1 Google Kubernetes Engine \u96c6\u7fa4\u90e8\u5206\u4e2d\u63cf\u8ff0\u7684\u6b65\u9a5f\u3002 \u901a\u904e\u5f9e clone GitHub hashcorp/learn-vault-agent \u5b58\u5132\u5eab\u4f86\u6aa2\u7d22\u9644\u52a0\u914d\u7f6e\u3002 $ git clone https://github.com/hashicorp/learn-vault-agent.git \u6b64Git\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6559\u7a0b\u7684\u652f\u6301\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u7279\u5b9a\u5167\u5bb9\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 learn-vault-agent/identity/vault-agent-k8s-demo \u76ee\u9304\u3002 $ cd learn-vault-agent/vault-agent-k8s-demo Info \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u5b83\u7684\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002 Start a Vault server \u00b6 \u8981\u5b8c\u6210\u672c\u6559\u7a0b\uff0c\u8acb\u555f\u52d5\u4e00\u500b Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u8a72\u670d\u52d9\u5668\u5728 0.0.0.0:8200 \u4ee5 root \u4f5c\u70ba\u6839\u4ee4\u724c ID \u5075\u807d\u672c\u5730\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u9023\u63a5\u5230\u3002 \u70ba Vault CLI \u5c0e\u51fa\u74b0\u5883\u8b8a\u91cf\u4ee5\u5b9a\u4f4d\u5230 Vault \u670d\u52d9\u5668\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200 Create a service account \u00b6 1. Start Kubernetes \u00b6 \u555f\u52d5\u5728 Minikube \u4e2d\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u3002 $ minikube start --driver = docker \u7b49\u5f85\u5e7e\u5206\u9418\u8b93 minikube \u74b0\u5883\u5b8c\u5168\u53ef\u7528\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured 2. Define Kubernetes Serviceaccount \u00b6 \u5728 Kubernetes \u4e2d\uff0c service account \u70ba\u5728 Pod \u4e2d\u904b\u884c\u7684\u9032\u7a0b\u63d0\u4f9b\u8eab\u4efd\uff0c\u4ee5\u4fbf\u9032\u7a0b\u53ef\u4ee5\u806f\u7e6b Kubernetes API \u670d\u52d9\u5668\u3002\u5728\u60a8\u9996\u9078\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\u6253\u958b\u63d0\u4f9b\u7684 vault-auth-service-account.yaml \u6587\u4ef6\uff0c\u4e26\u6aa2\u67e5\u5176\u5167\u5bb9\u4ee5\u4e86\u89e3\u672c\u6559\u7a0b\u8981\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u5b9a\u7fa9\u3002 vault-auth-service-account.yaml apiVersion : v1 kind : ServiceAccount metadata : name : vault-auth namespace : default --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default 3. Create Service account \u00b6 \u5275\u5efa Vault-auth \u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename vault-auth-service-account.yaml 4. Kubernetes 1.24+ only \u00b6 \u670d\u52d9\u5e33\u6236\u751f\u6210\u4e86\u4e00\u500b\u5728 Kubernetes 1.23 \u4e2d\u81ea\u52d5\u914d\u7f6e\u6240\u9700\u7684\u5bc6\u9470\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0c\u60a8\u9700\u8981\u986f\u5f0f\u5275\u5efa\u5bc6\u9470\u3002 vault-auth-secret.yaml apiVersion : v1 kind : Secret metadata : name : vault-auth-secret annotations : kubernetes.io/service-account.name : vault-auth type : kubernetes.io/service-account-token \u5275\u5efa\u4e00\u500b Vault-auth-secret \u5bc6\u9470\u3002 $ kubectl apply --filename vault-auth-secret.yaml Configure Kubernetes auth method \u00b6 1. Create a read-only policy \u00b6 \u5728 Vault \u4e2d\u5275\u5efa\u4e00\u500b\u552f\u8b80\u7684\u7b56\u7565 myapp-kv-ro \u3002 $ vault policy write myapp-kv-ro - <<EOF path \"secret/data/myapp/*\" { capabilities = [\"read\", \"list\"] } EOF 2. Put test data \u00b6 \u5728 secret/myapp \u8def\u5f91\u5275\u5efa\u4e00\u4e9b\u6e2c\u8a66\u6578\u64da\u3002 $ vault kv put secret/myapp/config \\ username = 'appuser' \\ password = 'suP3rsec(et!' \\ ttl = '30s' \u7d50\u679c: ====== Secret Path ====== secret/data/myapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -06-25T10:48:43.580414126Z custom_metadata <nil> deletion_time n/a destroyed false version 1 3. Set up environment variables \u00b6 \u5c07\u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6b63\u5728\u904b\u884c\u7684 Minikube \u74b0\u5883\u3002\u5c07 SA_SECRET_NAME \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba vault-auth \u670d\u52d9\u5e33\u6236 \u5bc6\u78bc\u3002 $ export SA_SECRET_NAME = $( kubectl get secrets --output = json \\ | jq -r '.items[].metadata | select(.name|startswith(\"vault-auth-\")).name' ) \u5c07 SA_JWT_TOKEN \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8a2a\u554f TokenReview API \u7684\u670d\u52d9\u5e33\u6236 JWT $ export SA_JWT_TOKEN = $( kubectl get secret $SA_SECRET_NAME \\ --output 'go-template={{ .data.token }}' | base64 --decode ) \u5c07 SA_CA_CRT \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8207 Kubernetes API \u5c0d\u8a71\u7684 PEM \u7de8\u78bc CA \u8b49\u66f8\u3002 $ export SA_CA_CRT = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) \u5c07 K8S_HOST \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba minikube IP \u5730\u5740\u3002 $ export K8S_HOST = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.server}' ) 4. Configure the Kubernetes auth method \u00b6 \u73fe\u5728\uff0c\u555f\u7528\u4e26\u914d\u7f6e Kubernetes auth \u65b9\u6cd5\u3002\u5728\u9ed8\u8a8d\u8def\u5f91\uff08 auth/kubernetes \uff09\u555f\u7528 Kubernetes auth \u65b9\u6cd5\u3002 $ vault auth enable kubernetes \u544a\u8a34 Vault \u5982\u4f55\u8207 Kubernetes (Minikube) \u96c6\u7fa4\u901a\u4fe1\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $SA_JWT_TOKEN \" \\ kubernetes_host = \" $K8S_HOST \" \\ kubernetes_ca_cert = \" $SA_CA_CRT \" \\ issuer = \"https://kubernetes.default.svc.cluster.local\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config Tips \u60a8\u53ef\u4ee5\u4f7f\u7528 \u6b64\u65b9\u6cd5 \u9a57\u8b49 Kubernetes \u96c6\u7fa4\u7684\u9812\u767c\u8005\u540d\u7a31\u3002 5. Create role \u00b6 \u5275\u5efa\u4e00\u500b\u540d\u70ba example \u7684\u89d2\u8272\uff0c\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u6620\u5c04\u5230 Vault \u7b56\u7565\u548c\u9ed8\u8a8d\u4ee4\u724c TTL\u3002 $ vault write auth/kubernetes/role/example \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = myapp-kv-ro \\ ttl = 24h \u7d50\u679c: Success! Data written to: auth/kubernetes/role/example Determine the Vault address \u00b6 \u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e\u5411 Kubernetes \u96c6\u7fa4\u7684\u7db2\u95dc\u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u7531 Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5c0b\u5740\u3002 1. \u555f\u52d5 minikube SSH \u00b6 $ minikube ssh ## ... minikube ssh login 2. \u5728\u6b64 SSH \u6703\u8a71\u4e2d\uff0c\u6aa2\u7d22 Minikube \u4e3b\u6a5f \u00b6 $ dig host.minikube.internal ; <<>> DiG 9 .16.1-Ubuntu <<>> host.minikube.internal ;; global options: +cmd ;; Got answer: ;; ->>HEADER <<- opco de: QUERY, status: NXDOMAIN, id: 13469 ;; flags: qr rd ra ; QUERY: 1 , ANSWER: 0 , AUTHORITY: 1 , ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0 , flags: ; udp: 65494 ;; QUESTION SECTION: ; host.minikube.internal. IN A ;; AUTHORITY SECTION: . 86375 IN SOA a.root-servers.net. nstld.verisign-grs.com. 2022062500 1800 900 604800 86400 ;; Query time: 43 msec ;; SERVER: 192 .168.49.1#53 ( 192 .168.49.1 ) ;; WHEN: Sat Jun 25 13 :02:27 UTC 2022 ;; MSG SIZE rcvd: 126 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u4f86\u6355\u7372 Minikube \u7db2\u95dc\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = $( minikube ssh \"dig +short host.docker.internal\" | tr -d '\\r' ) $ EXTERNAL_VAULT_ADDR = 192 .168.50.191 Optional: Verify the Kubernetes auth method configuration \u00b6 1. \u5b9a\u7fa9\u4e00\u500b\u5e36\u6709\u5bb9\u5668\u7684 Pod $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: vault-auth containers: - name: devwebapp image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" EOF Pod \u540d\u70ba devwebapp \u4e26\u4f7f\u7528 vault-auth \u670d\u52d9\u5e33\u6236\u904b\u884c\u3002 2. \u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml --namespace default pod/devwebapp created 3. \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 54s \u7b49\u5230 devwebapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 4. \u5728 devwebapp pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell $ kubectl exec --stdin = true --tty = true devwebapp -- /bin/sh # \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a # \u3002 Info \u6ce8\u610f\uff1a\u672c\u7bc0\u4e2d\u7684\u63d0\u793a\u986f\u793a\u70ba $\uff0c\u4f46\u9019\u4e9b\u547d\u4ee4\u65e8\u5728\u5728 devwebapp \u5bb9\u5668\u4e0a\u7684\u6b64\u4ea4\u4e92\u5f0f shell \u4e2d\u57f7\u884c\u3002 5. \u5c07 KUBE_TOKEN \u8a2d\u7f6e\u70ba\u670d\u52d9\u5e33\u6236\u4ee4\u724c $ KUBE_TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) 6. \u901a\u904e\u5e36\u6709 KUBE_TOKEN \u7684\u793a\u4f8b\u89d2\u8272\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49 curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ $VAULT_ADDR /v1/auth/kubernetes/login curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ http://192.168.50.191:8200/v1/auth/kubernetes/login","title":"Vault Agent \u8207 Kubernetes"},{"location":"vault/kubernetes/agent-kubernetes/#vault-agent-with-kubernetes","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/agent-kubernetes?in=vault/auth-methods \u5e7e\u4e4e\u6240\u6709\u5c0d Vault \u7684\u8acb\u6c42\u90fd\u5fc5\u9808\u9644\u6709\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3002\u9019\u5305\u62ec\u6240\u6709 API \u8acb\u6c42\uff0c\u4ee5\u53ca\u901a\u904e Vault CLI \u7684\u8acb\u6c42\u3002\u5982\u679c\u60a8\u53ef\u4ee5\u5b89\u5168\u5730\u5f9e\u767c\u8d77\u8005\u90a3\u88e1\u7372\u5f97\u7b2c\u4e00\u500b\u79d8\u5bc6\u5230\u6d88\u8cbb\u8005\uff0c\u90a3\u9ebc\u5728\u8a72\u767c\u8d77\u8005\u548c\u6d88\u8cbb\u8005\u4e4b\u9593\u50b3\u8f38\u7684\u6240\u6709\u5f8c\u7e8c\u79d8\u5bc6\u90fd\u53ef\u4ee5\u901a\u904e\u6210\u529f\u5206\u767c\u548c\u8a72\u7b2c\u4e00\u500b\u79d8\u5bc6\u7684\u7528\u6236\u5efa\u7acb\u7684\u4fe1\u4efb\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002","title":"Vault Agent with Kubernetes"},{"location":"vault/kubernetes/agent-kubernetes/#challenge","text":"\u5728 Kubernetes \u74b0\u5883\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u4e5f\u4e0d\u4f8b\u5916\u3002\u5e78\u904b\u7684\u662f\uff0cVault \u63d0\u4f9b\u4e86 Kubernetes auth \u65b9\u6cd5 \u4f86\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service Account)\u4ee4\u724c\u5c0d\u5ba2\u6236\u7aef\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u4f46\u662f\uff0c\u5ba2\u6236\u7aef(\u6bcf\u4e00\u500b\u5728K8S\u88e1\u982d\u7684Pod)\u4ecd\u7136\u9700\u8981\u8ca0\u8cac\u7ba1\u7406 Vault \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f(TTL)\u3002\u56e0\u6b64\uff0c\u4e0b\u4e00\u500b\u6311\u6230\u8b8a\u6210\u77ad\u5982\u4f55\u4ee5\u6a19\u6e96\u65b9\u5f0f\u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\uff0c\u800c\u7121\u9700\u7de8\u5beb\u81ea\u5b9a\u7fa9\u908f\u8f2f\u3002","title":"Challenge"},{"location":"vault/kubernetes/agent-kubernetes/#solution","text":"Vault Agent \u63d0\u4f9b\u4e86\u8a31\u591a\u4e0d\u540c\u7684\u5e6b\u52a9\u529f\u80fd\uff0c\u5c08\u9580\u89e3\u6c7a\u4ee5\u4e0b\u6311\u6230\uff1a \u81ea\u52d5\u8a8d\u8b49 \u4ee4\u724c\u7684\u5b89\u5168\u4ea4\u4ed8/\u5b58\u5132 \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u7ba1\u7406\uff08\u66f4\u65b0\u548c\u91cd\u65b0\u8a8d\u8b49\uff09 Info \u672c\u6559\u7a0b\u91cd\u9ede\u4ecb\u7d39\u4f7f\u7528 kubernetes auth \u65b9\u6cd5\u7684 Vault Agent Auto-Auth \u7684\u6f14\u793a\u3002 Vault Helm \u5f15\u5165\u4e86 Agent Sidecar Injector\u3002\u6709\u95dc Sidecar \u4f7f\u7528\u7684\u5206\u6b65\u6559\u7a0b\uff0c\u8acb\u53c3\u95b1\u901a\u904e Vault Helm Sidecar \u5c07 Secrets \u6ce8\u5165 Kubernetes Pod\u3002","title":"Solution"},{"location":"vault/kubernetes/agent-kubernetes/#prerequisites","text":"\u8981\u57f7\u884c\u672c\u6559\u7a0b\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\uff0c\u60a8\u9700\u8981\uff1a \u4e00\u500b\u5b89\u88dd\u597d\u4e86\u7684 Minikube \u53ef\u5f9e Kubernetes \u74b0\u5883\u8a2a\u554f\u5230\u7684 Vault \u74b0\u5883\u3002\u8acb\u53c3\u95b1\u5165\u9580\u6559\u7a0b\u4ee5\u5b89\u88dd Vault\u3002\u78ba\u4fdd\u60a8\u7684 Vault \u670d\u52d9\u5668\u5df2\u521d\u59cb\u5316\u4e26\u89e3\u5c01 Info \u6ce8\u610f\uff1a\u51fa\u65bc\u6f14\u793a\u7684\u76ee\u7684\uff0c\u672c\u6559\u7a0b\u5c07 Minikube \u4f5c\u70ba Kubernetes \u74b0\u5883\u904b\u884c\u3002\u5982\u679c\u4f60\u5e0c\u671b\u6539\u70ba\u91dd\u5c0d Azure Kubernetes \u670d\u52d9 (AKS) \u7fa4\u96c6\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u6309\u7167 Azure Kubernetes \u670d\u52d9\u7fa4\u96c6\u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\u5275\u5efa AKS \u7fa4\u96c6\u3002\u5982\u679c\u8981\u91dd\u5c0d Google Kubernetes Engine (GKE) \u96c6\u7fa4\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u53c3\u95b1 Google Kubernetes Engine \u96c6\u7fa4\u90e8\u5206\u4e2d\u63cf\u8ff0\u7684\u6b65\u9a5f\u3002 \u901a\u904e\u5f9e clone GitHub hashcorp/learn-vault-agent \u5b58\u5132\u5eab\u4f86\u6aa2\u7d22\u9644\u52a0\u914d\u7f6e\u3002 $ git clone https://github.com/hashicorp/learn-vault-agent.git \u6b64Git\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6559\u7a0b\u7684\u652f\u6301\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u7279\u5b9a\u5167\u5bb9\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 learn-vault-agent/identity/vault-agent-k8s-demo \u76ee\u9304\u3002 $ cd learn-vault-agent/vault-agent-k8s-demo Info \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u5b83\u7684\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002","title":"Prerequisites"},{"location":"vault/kubernetes/agent-kubernetes/#start-a-vault-server","text":"\u8981\u5b8c\u6210\u672c\u6559\u7a0b\uff0c\u8acb\u555f\u52d5\u4e00\u500b Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u8a72\u670d\u52d9\u5668\u5728 0.0.0.0:8200 \u4ee5 root \u4f5c\u70ba\u6839\u4ee4\u724c ID \u5075\u807d\u672c\u5730\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u9023\u63a5\u5230\u3002 \u70ba Vault CLI \u5c0e\u51fa\u74b0\u5883\u8b8a\u91cf\u4ee5\u5b9a\u4f4d\u5230 Vault \u670d\u52d9\u5668\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200","title":"Start a Vault server"},{"location":"vault/kubernetes/agent-kubernetes/#create-a-service-account","text":"","title":"Create a service account"},{"location":"vault/kubernetes/agent-kubernetes/#1-start-kubernetes","text":"\u555f\u52d5\u5728 Minikube \u4e2d\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u3002 $ minikube start --driver = docker \u7b49\u5f85\u5e7e\u5206\u9418\u8b93 minikube \u74b0\u5883\u5b8c\u5168\u53ef\u7528\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured","title":"1. Start Kubernetes"},{"location":"vault/kubernetes/agent-kubernetes/#2-define-kubernetes-serviceaccount","text":"\u5728 Kubernetes \u4e2d\uff0c service account \u70ba\u5728 Pod \u4e2d\u904b\u884c\u7684\u9032\u7a0b\u63d0\u4f9b\u8eab\u4efd\uff0c\u4ee5\u4fbf\u9032\u7a0b\u53ef\u4ee5\u806f\u7e6b Kubernetes API \u670d\u52d9\u5668\u3002\u5728\u60a8\u9996\u9078\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\u6253\u958b\u63d0\u4f9b\u7684 vault-auth-service-account.yaml \u6587\u4ef6\uff0c\u4e26\u6aa2\u67e5\u5176\u5167\u5bb9\u4ee5\u4e86\u89e3\u672c\u6559\u7a0b\u8981\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u5b9a\u7fa9\u3002 vault-auth-service-account.yaml apiVersion : v1 kind : ServiceAccount metadata : name : vault-auth namespace : default --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default","title":"2. Define Kubernetes Serviceaccount"},{"location":"vault/kubernetes/agent-kubernetes/#3-create-service-account","text":"\u5275\u5efa Vault-auth \u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename vault-auth-service-account.yaml","title":"3. Create Service account"},{"location":"vault/kubernetes/agent-kubernetes/#4-kubernetes-124-only","text":"\u670d\u52d9\u5e33\u6236\u751f\u6210\u4e86\u4e00\u500b\u5728 Kubernetes 1.23 \u4e2d\u81ea\u52d5\u914d\u7f6e\u6240\u9700\u7684\u5bc6\u9470\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0c\u60a8\u9700\u8981\u986f\u5f0f\u5275\u5efa\u5bc6\u9470\u3002 vault-auth-secret.yaml apiVersion : v1 kind : Secret metadata : name : vault-auth-secret annotations : kubernetes.io/service-account.name : vault-auth type : kubernetes.io/service-account-token \u5275\u5efa\u4e00\u500b Vault-auth-secret \u5bc6\u9470\u3002 $ kubectl apply --filename vault-auth-secret.yaml","title":"4. Kubernetes 1.24+ only"},{"location":"vault/kubernetes/agent-kubernetes/#configure-kubernetes-auth-method","text":"","title":"Configure Kubernetes auth method"},{"location":"vault/kubernetes/agent-kubernetes/#1-create-a-read-only-policy","text":"\u5728 Vault \u4e2d\u5275\u5efa\u4e00\u500b\u552f\u8b80\u7684\u7b56\u7565 myapp-kv-ro \u3002 $ vault policy write myapp-kv-ro - <<EOF path \"secret/data/myapp/*\" { capabilities = [\"read\", \"list\"] } EOF","title":"1. Create a read-only policy"},{"location":"vault/kubernetes/agent-kubernetes/#2-put-test-data","text":"\u5728 secret/myapp \u8def\u5f91\u5275\u5efa\u4e00\u4e9b\u6e2c\u8a66\u6578\u64da\u3002 $ vault kv put secret/myapp/config \\ username = 'appuser' \\ password = 'suP3rsec(et!' \\ ttl = '30s' \u7d50\u679c: ====== Secret Path ====== secret/data/myapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -06-25T10:48:43.580414126Z custom_metadata <nil> deletion_time n/a destroyed false version 1","title":"2. Put test data"},{"location":"vault/kubernetes/agent-kubernetes/#3-set-up-environment-variables","text":"\u5c07\u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6b63\u5728\u904b\u884c\u7684 Minikube \u74b0\u5883\u3002\u5c07 SA_SECRET_NAME \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba vault-auth \u670d\u52d9\u5e33\u6236 \u5bc6\u78bc\u3002 $ export SA_SECRET_NAME = $( kubectl get secrets --output = json \\ | jq -r '.items[].metadata | select(.name|startswith(\"vault-auth-\")).name' ) \u5c07 SA_JWT_TOKEN \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8a2a\u554f TokenReview API \u7684\u670d\u52d9\u5e33\u6236 JWT $ export SA_JWT_TOKEN = $( kubectl get secret $SA_SECRET_NAME \\ --output 'go-template={{ .data.token }}' | base64 --decode ) \u5c07 SA_CA_CRT \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8207 Kubernetes API \u5c0d\u8a71\u7684 PEM \u7de8\u78bc CA \u8b49\u66f8\u3002 $ export SA_CA_CRT = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) \u5c07 K8S_HOST \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba minikube IP \u5730\u5740\u3002 $ export K8S_HOST = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.server}' )","title":"3. Set up environment variables"},{"location":"vault/kubernetes/agent-kubernetes/#4-configure-the-kubernetes-auth-method","text":"\u73fe\u5728\uff0c\u555f\u7528\u4e26\u914d\u7f6e Kubernetes auth \u65b9\u6cd5\u3002\u5728\u9ed8\u8a8d\u8def\u5f91\uff08 auth/kubernetes \uff09\u555f\u7528 Kubernetes auth \u65b9\u6cd5\u3002 $ vault auth enable kubernetes \u544a\u8a34 Vault \u5982\u4f55\u8207 Kubernetes (Minikube) \u96c6\u7fa4\u901a\u4fe1\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $SA_JWT_TOKEN \" \\ kubernetes_host = \" $K8S_HOST \" \\ kubernetes_ca_cert = \" $SA_CA_CRT \" \\ issuer = \"https://kubernetes.default.svc.cluster.local\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config Tips \u60a8\u53ef\u4ee5\u4f7f\u7528 \u6b64\u65b9\u6cd5 \u9a57\u8b49 Kubernetes \u96c6\u7fa4\u7684\u9812\u767c\u8005\u540d\u7a31\u3002","title":"4. Configure the Kubernetes auth method"},{"location":"vault/kubernetes/agent-kubernetes/#5-create-role","text":"\u5275\u5efa\u4e00\u500b\u540d\u70ba example \u7684\u89d2\u8272\uff0c\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u6620\u5c04\u5230 Vault \u7b56\u7565\u548c\u9ed8\u8a8d\u4ee4\u724c TTL\u3002 $ vault write auth/kubernetes/role/example \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = myapp-kv-ro \\ ttl = 24h \u7d50\u679c: Success! Data written to: auth/kubernetes/role/example","title":"5. Create role"},{"location":"vault/kubernetes/agent-kubernetes/#determine-the-vault-address","text":"\u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e\u5411 Kubernetes \u96c6\u7fa4\u7684\u7db2\u95dc\u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u7531 Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5c0b\u5740\u3002","title":"Determine the Vault address"},{"location":"vault/kubernetes/agent-kubernetes/#1-minikube-ssh","text":"$ minikube ssh ## ... minikube ssh login","title":"1. \u555f\u52d5 minikube SSH"},{"location":"vault/kubernetes/agent-kubernetes/#2-ssh-minikube","text":"$ dig host.minikube.internal ; <<>> DiG 9 .16.1-Ubuntu <<>> host.minikube.internal ;; global options: +cmd ;; Got answer: ;; ->>HEADER <<- opco de: QUERY, status: NXDOMAIN, id: 13469 ;; flags: qr rd ra ; QUERY: 1 , ANSWER: 0 , AUTHORITY: 1 , ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0 , flags: ; udp: 65494 ;; QUESTION SECTION: ; host.minikube.internal. IN A ;; AUTHORITY SECTION: . 86375 IN SOA a.root-servers.net. nstld.verisign-grs.com. 2022062500 1800 900 604800 86400 ;; Query time: 43 msec ;; SERVER: 192 .168.49.1#53 ( 192 .168.49.1 ) ;; WHEN: Sat Jun 25 13 :02:27 UTC 2022 ;; MSG SIZE rcvd: 126 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u4f86\u6355\u7372 Minikube \u7db2\u95dc\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = $( minikube ssh \"dig +short host.docker.internal\" | tr -d '\\r' ) $ EXTERNAL_VAULT_ADDR = 192 .168.50.191","title":"2. \u5728\u6b64 SSH \u6703\u8a71\u4e2d\uff0c\u6aa2\u7d22 Minikube \u4e3b\u6a5f"},{"location":"vault/kubernetes/agent-kubernetes/#optional-verify-the-kubernetes-auth-method-configuration","text":"1. \u5b9a\u7fa9\u4e00\u500b\u5e36\u6709\u5bb9\u5668\u7684 Pod $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: vault-auth containers: - name: devwebapp image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" EOF Pod \u540d\u70ba devwebapp \u4e26\u4f7f\u7528 vault-auth \u670d\u52d9\u5e33\u6236\u904b\u884c\u3002 2. \u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml --namespace default pod/devwebapp created 3. \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 54s \u7b49\u5230 devwebapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 4. \u5728 devwebapp pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell $ kubectl exec --stdin = true --tty = true devwebapp -- /bin/sh # \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a # \u3002 Info \u6ce8\u610f\uff1a\u672c\u7bc0\u4e2d\u7684\u63d0\u793a\u986f\u793a\u70ba $\uff0c\u4f46\u9019\u4e9b\u547d\u4ee4\u65e8\u5728\u5728 devwebapp \u5bb9\u5668\u4e0a\u7684\u6b64\u4ea4\u4e92\u5f0f shell \u4e2d\u57f7\u884c\u3002 5. \u5c07 KUBE_TOKEN \u8a2d\u7f6e\u70ba\u670d\u52d9\u5e33\u6236\u4ee4\u724c $ KUBE_TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) 6. \u901a\u904e\u5e36\u6709 KUBE_TOKEN \u7684\u793a\u4f8b\u89d2\u8272\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49 curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ $VAULT_ADDR /v1/auth/kubernetes/login curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ http://192.168.50.191:8200/v1/auth/kubernetes/login","title":"Optional: Verify the Kubernetes auth method configuration"},{"location":"vault/kubernetes/kubernetes-external-vault/","text":"Kubernetes \u8207\u5916\u90e8 Vault \u6574\u5408 \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-external-vault Vault \u53ef\u4ee5\u7ba1\u7406 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u7684\u6a5f\u5bc6\u3002\u901a\u5e38\u9019\u500b Vault \u670d\u52d9\u662f\u88ab\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e4b\u5916\u3002 Info \u5728 Kubernetes \u4e2d\u904b\u884c Vault\uff1a\u5728 Vault Installation to Minikube via Helm \u548c Injecting Secrets into Kubernetes Pods via Vault Helm Sidecar \u6559\u7a0b\u4e2d\u63a2\u8a0e\u4e86\u5728 K8S \u96c6\u7fa4\u4e2d\u904b\u884c Vault \u670d\u52d9\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5728\u672c\u5730\u904b\u884c Vault\uff0c\u4f7f\u7528 K3D \u555f\u52d5 Kubernetes \u96c6\u7fa4\uff0c\u90e8\u7f72\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u8a72\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u76f4\u63a5\u5f9e Vault \u6aa2\u7d22\u6a5f\u5bc6\uff0c\u4e26\u901a\u904e Vault Agent Injector \u9032\u884c\u6a5f\u5bc6\u6ce8\u5165\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001K3D \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 K3D version. $ k3d version k3d version v5.4.1 k3s version v1.22.7-k3s1 ( default ) Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" } \u9019\u4e9b\u662f\u63a8\u85a6\u7684\u8edf\u4ef6\u7248\u672c\uff0c\u986f\u793a\u7684\u8f38\u51fa\u53ef\u80fd\u6703\u56e0\u60a8\u7684\u74b0\u5883\u548c\u60a8\u4f7f\u7528\u7684\u8edf\u4ef6\u7248\u672c\u800c\u7570\u3002 \u63a5\u4e0b\u4f86\uff0c\u901a\u904e\u5f9e GitHub \u4f86 clone hashcorp/vault-guides \u5b58\u5132\u5eab\uff0c\u88e1\u982d\u5305\u542b\u672c\u6559\u7a0b\u7528\u4f86\u9a57\u8b49\u7684\u7bc4\u4f8b Web \u61c9\u7528\u7a0b\u5e8f\u548c\u5176\u4ed6\u914d\u7f6e\u6a94\u6848\u3002 $ git clone https://github.com/hashicorp/vault-guides.git \u6b64\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6307\u5357\u7684\u76f8\u95dc\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6587\u4ef6\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 vault-guides/operations/provision-vault/kubernetes/minikube/external-vault \u76ee\u9304\u3002 $ cd vault-guides/operations/provision-vault/kubernetes/minikube/external-vault Important \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u9918\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002 \u555f\u52d5 Vault \u00b6 \u53ea\u8981 Vault \u670d\u52d9\u5668\u662f\u7db2\u5740\u662f\u53ef\u88ab Kubernetes \u9023\u63a5\u5230\u7684\uff0c\u90a3\u9ebc\u904b\u884c\u5728 Kubernetes \u96c6\u7fa4\u5916\u90e8\u7684 Vault \u5c31\u53ef\u4ee5\u88ab\u5b83\u7684\u4efb\u4f55\u88ab\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684 pod \u6240\u9023\u63a5\u3002 1. \u555f\u52d5 Vault \u670d\u52d9 \u6253\u958b\u4e00\u500b\u65b0\u7d42\u7aef\uff0c\u555f\u52d5\u4e00\u500b\u4ee5 root \u4f5c\u70ba root \u4ee4\u724c\u7684 Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u5b83\u5728 0.0.0.0:8200 \u8655\u5075\u807d\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u5c0b\u5740\uff0c\u56e0\u70ba\u5b83\u7d81\u5b9a\u5230\u5171\u4eab\u7db2\u7d61. 2. \u8a2d\u5b9a VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u70ba Vault CLI \u8a2d\u5b9a\u74b0\u5883\u8b8a\u91cf\u4f86\u66b4\u9732\u51fa Vault \u670d\u52d9\u5668\u7db2\u8def\u5730\u5740\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200 \u60a8\u90e8\u7f72\u7684 Web \u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u53d6\u5f97\u5132\u5b58\u5728 Vault \u88e1\u9762\u7684 username \u548c password \uff0c\u9019\u4e9b\u7528\u6236\u540d\u548c\u5bc6\u78bc\u7684\u6a5f\u654f\u8cc7\u8a0a\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cVault \u958b\u767c\u670d\u52d9\u5668\u4ee5\u5728\u4ee5 secret \u70ba\u524d\u7db4\u7684\u8def\u5f91\u4e0a\u555f\u7528\u9375\u503c\u6a5f\u5bc6\u5f15\u64ce\u555f\u52d5\u3002 3. \u4fbf\u7528 root \u4ee4\u724c\u767b\u5165 Vault \u5728\u555f\u52d5 Vault \u6642\u6211\u5011\u8a2d\u5b9a\u7684 root \u4ee4\u724c\u662f root $ vault login root Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \"vault login\" again. Future Vault requests will automatically use this token. Key Value --- ----- token root token_accessor OJU8So8T5wuCassRAJpNrfN4 token_duration \u221e token_renewable false token_policies [ \"root\" ] identity_policies [] policies [ \"root\" ] 4. \u5728 secret/devwebapp/config \u8a2d\u5b9a credential \u4f7f\u7528\u7528\u6236\u540d username \u548c\u5bc6\u78bc password \u5728\u88ab\u5275\u5efa\u5728\u8def\u5f91 secret/devwebapp/config \u4e0a\u3002 $ vault kv put secret/devwebapp/config username = 'giraffe' password = 'salsa' ======== Secret Path ======== secret/data/devwebapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-11T22:35:03.103203218Z custom_metadata <nil> deletion_time n/a destroyed false version 1 5. \u9a57\u8b49 Secret \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002 $ vault kv get -format = json secret/devwebapp/config | jq \".data.data\" { \"password\" : \"salsa\" , \"username\" : \"giraffe\" } \u5e36\u6709\u5bc6\u9470\u7684 Vault \u670d\u52d9\u5668\u5df2\u6e96\u5099\u597d\uff0c\u63a5\u8457\u8b93\u6211\u5011\u914d\u7f6e\u4f86\u8b93 Kubernetes \u96c6\u7fa4\u548c\u90e8\u7f72\u5728\u5176\u4e2d\u7684 pod \u53ef\u9023\u63a5\u5230\u9019\u500b\u5916\u90e8\u7684 Vault \u670d\u52d9\u3002 \u555f\u52d5 Kubernetes \u00b6 k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u7d50\u679c: Kubernetes control plane is running at https://0.0.0.0:46339 CoreDNS is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy Metrics-server is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy Info \u5982\u679c\u6c92\u6709\u7279\u5225\u5b9a\u7fa9 K3D \u6703\u5728\u5275\u5efa Kubernetes \u96c6\u7fa4\u6642\u81ea\u52d5\u627e\u4e00\u500b\u53ef\u7528\u7684 port \u6210 Kubernetes API server \u4f7f\u7528\u7684 port\u3002 \u6c7a\u5b9a Vault address \u00b6 \u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5411 Kubernetes \u96c6\u7fa4\u7684 \u7db2\u95dc \u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u5c0b\u5740\u3002 1. \u53d6\u5f97\u672c\u6a5f\u7684\u7db2\u7d61\u4f4d\u5740 $ ifconfig wlp4s0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 192 .168.50.191 netmask 255 .255.255.0 broadcast 192 .168.50.255 inet6 fe80::3433:7b7c:e266:7a35 prefixlen 64 scopeid 0x20<link> ether 88 :b1:11:e5:6e:33 txqueuelen 1000 ( Ethernet ) RX packets 473363 bytes 659034753 ( 659 .0 MB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 96234 bytes 19111520 ( 19 .1 MB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \u5728\u7bc4\u4f8b\u7684\u6a5f\u5668\u4e0a\u7684\u7db2\u8def\u4f4d\u5740\u662f 192.168.50.191 (\u9019\u500b ip address \u5728\u4e0d\u540c\u7684\u6a5f\u5668\u4e0a\u90fd\u6703\u662f\u4e0d\u540c\u7684) !! 2. \u9a57\u8b49\u8207 Vault \u7684\u7db2\u7d61\u9023\u63a5 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5617\u8a66\u4f7f\u7528\u524d\u4e00\u6b65\u9a5f\u6240\u53d6\u7684\u7684 ip address \u4f86\u547c\u53eb external Vault \u7684 API\uff1a [ root@ca-test-pod:/ ] $ curl -s http://192.168.50.191:8200/v1/sys/seal-status { \"type\" : \"shamir\" , \"initialized\" :true, \"sealed\" :false, \"t\" :1, \"n\" :1, \"progress\" :0, \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" :false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" :false, \"storage_type\" : \"inmem\" } \u8f38\u51fa\u986f\u793a Vault \u5df2\u521d\u59cb\u5316\u4e14\u672a\u5bc6\u5c01\u3002\u9019\u78ba\u8a8d\u4e86\u96c6\u7fa4\u4e2d\u7684 pod \u80fd\u5920\u8a2a\u554f\u5230 external Vault\u3002 3. \u9000\u51fa pod \u6703\u8a71 [ root@ca-test-pod:/ ] $ exit 4. \u8a2d\u5b9a EXTERNAL_VAULT_ADDR \u74b0\u5883 \u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u5ba3\u544a Vault \u7684\u7db2\u7d61\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = 192 .168.50.191 5. \u9a57\u8b49\u8b8a\u91cf \u9a57\u8b49\u8b8a\u91cf\u3002 $ echo $EXTERNAL_VAULT_ADDR \u4f7f\u7528 hard-coded \u7684 Vault \u5730\u5740\u4f48\u7f72\u61c9\u7528\u7a0b\u5e8f \u00b6 Kubernetes \u96c6\u7fa4\u4e2d\u7684 pods \u627e\u5c0b \u5916\u90e8 Vault \u670d\u52d9\u4f4d\u5740\u7684\u6700\u76f4\u63a5\u65b9\u6cd5\u662f\u76f4\u63a5\u5728\u61c9\u7528\u7a0b\u5f0f\u7684\u7a0b\u5f0f\u78bc\u4e2d\u5b9a\u7fa9 (hard-coded) Valut \u7684\u7db2\u7d61\u4f4d\u5740\u6216\u628a Vault \u7684\u7db2\u7d61\u4f4d\u5740\u7528 \u74b0\u5883\u8b8a\u91cf \u9032\u884c\u63d0\u4f9b\u3002\u6211\u5011\u5df2\u7d93\u5275\u5efa\u4e26\u767c\u5e03\u4e86\u4e00\u500b\u5141\u8a31\u8a2d\u5b9a Vault \u5730\u5740\u7684 Web \u61c9\u7528\u7a0b\u5f0f\u3002 exampleapp config.ru lib/service.rb Dockerfile # This file is a configuration file for a Rackup application. # Load the service file found in the lib directory. require './lib/service' # This Sinatra web application was built in the Classic way. Which # is great for simple web application. Sinatra automatically provides # a class you can provide to Rackup's `run` method to start the # application. # # Read about the 'Modular vs. Classic Style' in the Sinatra README. # @see http://www.sinatrarb.com/intro.html run ExampleApp require \"sinatra\" require \"faraday\" require \"json\" require \"logger\" $stdout . sync = true class ExampleApp < Sinatra :: Base set :port , ENV [ 'SERVICE_PORT' ] || \"8080\" set :vault_token , ENV [ \"VAULT_TOKEN\" ] || \"root\" configure :development do logger = Logger . new ( STDOUT ) logger . level = Logger :: DEBUG set :raise_errors , true set :logger , logger set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://host.docker.internal:8200\" end configure :production do logger = Logger . new ( STDOUT ) logger . level = Logger :: INFO set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://vault:8200\" end # GET \"/\" get \"/\" do logger . info \"Received Request.\" # Set up an undefined state and set the vault server and secrets path secrets = { \"username\" => \"undefined\" , \"password\" => \"undefined\" } secrets_path = \"secret/data/devwebapp/config\" # Ask for the secret at the path vault_response = Faraday . get \" #{ settings . vault_url } /v1/ #{ secrets_path } \" do | req | req . headers [ 'Content-Type' ] = 'application/json' req . headers [ 'X-Vault-Token' ] = settings . vault_token end if vault_response . status != 200 raise Exception . new \"The secret request failed: #{ vault_response . body } \" end # Parse the JSON content = JSON . parse ( vault_response . body ) rescue {} # Traverse the response to find the secrets in the response if content . key? ( 'data' ) and content [ 'data' ]. key? ( 'data' ) secrets = content [ 'data' ][ 'data' ] end # Return secret secrets . to_s end end FROM ruby:2.6.2 RUN apt-get update && \\ apt-get install -y net-tools # Install gems ENV APP_HOME /app ENV HOME /root RUN mkdir $APP_HOME WORKDIR $APP_HOME COPY Gemfile* $APP_HOME / RUN bundle install # Upload source COPY config.ru $APP_HOME RUN mkdir $APP_HOME /lib COPY lib/* $APP_HOME /lib # Start server ENV PORT 8080 EXPOSE 8080 CMD [ \"rackup\" , \"--port\" , \"8080\" , \"--env\" , \"production\" ] 1. \u5275\u5efa internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236 $ kubectl create sa internal-app serviceaccount/internal-app created 2. \u8a2d\u7f6e EXTERNAL_VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u4f7f\u7528\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba EXTERNAL_VAULT_ADDR \u7684 Web \u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u4e00\u500b\u540d\u70ba devwebapp \u7684 pod\u3002 $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: internal-app containers: - name: app image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" - name: VAULT_TOKEN value: root EOF 3. \u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml pod/devwebapp created \u67e5\u770b pod/devwebapp \u7684\u898f\u683c: $ kubectl get pod/devwebapp -o yaml \u7d50\u679c: apiVersion : v1 kind : Pod metadata : annotations : ... ... app : devwebapp name : devwebapp namespace : default resourceVersion : \"1045\" uid : c41d0da7-e2d7-41ad-b3e5-b31a7a0c387a spec : containers : - env : - name : VAULT_ADDR value : http://192.168.50.191:8200 - name : VAULT_TOKEN value : root image : burtlo/devwebapp-ruby:k8s imagePullPolicy : IfNotPresent name : app resources : {} terminationMessagePath : /dev/termination-log terminationMessagePolicy : File volumeMounts : - mountPath : /var/run/secrets/kubernetes.io/serviceaccount name : kube-api-access-nhtdj readOnly : true dnsPolicy : ClusterFirst enableServiceLinks : true nodeName : minikube preemptionPolicy : PreemptLowerPriority priority : 0 restartPolicy : Always schedulerName : default-scheduler securityContext : {} serviceAccount : internal-app serviceAccountName : internal-app terminationGracePeriodSeconds : 30 tolerations : - effect : NoExecute key : node.kubernetes.io/not-ready operator : Exists tolerationSeconds : 300 - effect : NoExecute key : node.kubernetes.io/unreachable operator : Exists tolerationSeconds : 300 volumes : - name : kube-api-access-nhtdj projected : defaultMode : 420 sources : - serviceAccountToken : expirationSeconds : 3607 path : token - configMap : items : - key : ca.crt path : ca.crt name : kube-root-ca.crt - downwardAPI : items : - fieldRef : apiVersion : v1 fieldPath : metadata.namespace path : namespace 4. \u7372\u53d6 default \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 2m11s \u7b49\u5230 devwebapp pod \u5831\u544a\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 5. \u5f9e devwebapp pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u7684\u5167\u5bb9 $ kubectl exec devwebapp -- curl -s localhost:8080 ; echo \u7d50\u679c\u986f\u793a Secret \u662f\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u3002 {\"password\"=>\"salsa\", \"username\"=>\"giraffe\"} Web \u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u6839\u4ee4\u724c\u5411\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4e26\u8fd4\u56de\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u5bc6\u9470\u3002\u5982\u679c Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u4e0d\u8b8a\uff0c\u9019\u7a2e\u786c\u7de8\u78bc\u65b9\u6cd5\u662f\u4e00\u7a2e\u6709\u6548\u7684\u89e3\u6c7a\u65b9\u6848\u3002 \u5728 K8S \u90e8\u7f72 service \u548c endpoint \u4f86\u6620\u5c04\u81f3 external Vault \u00b6 \u5916\u90e8 Vault \u53ef\u80fd\u6c92\u6709 K8S \u96c6\u7fa4\u7684 Service \u53ef\u4ee5\u8b93\u76f8\u95dc\u7684 Pod \u4f86\u4f9d\u8cf4\u3002\u7576 Vault \u7684\u7db2\u8def\u5730\u5740\u66f4\u6539\u6642\uff0c\u6bcf\u500b Pod \u4e5f\u9700\u8981\u66f4\u6539\u624d\u80fd\u7e7c\u7e8c\u904b\u884c\u3002\u7ba1\u7406\u6b64\u7db2\u8def\u5730\u5740\u7684\u53e6\u4e00\u7a2e\u65b9\u6cd5\u662f\u5728Kubernetes \u4e2d\u901a\u904e\u5b9a\u7fa9 service \u548c endpoint \u7269\u4ef6\u4f86\u6307\u5411 Vault\u3002 Service \u7269\u4ef6\u662f\u5c0d Kubernetes \u5916\u90e8\u670d\u52d9\u7684\u62bd\u8c61\u8868\u793a\u3002\u7576\u5728 pod \u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u8acb\u6c42 service \u6642\uff0c\u8a72\u8acb\u6c42\u5c07\u88ab\u8def\u7531\u5230\u5171\u4eab service \u7684 endpoint \u3002 1. \u5b9a\u7fa9 service \u8207 endpoint \u7684\u7269\u4ef6 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba external-vault \u7684\u670d\u52d9\u548c\u4e00\u500b\u914d\u7f6e\u70ba\u5c0b\u5740 EXTERNAL_VAULT_ADDR \u7684\u76f8\u61c9\u7aef\u9ede\u3002 \u76f8\u95dc\u7684\u8aaa\u660e\u898b Kubernetes Service Overview \u3002 $ cat > external-vault.yaml <<EOF --- apiVersion: v1 kind: Service metadata: name: external-vault namespace: default spec: ports: - protocol: TCP port: 8200 --- apiVersion: v1 kind: Endpoints metadata: name: external-vault subsets: - addresses: - ip: $EXTERNAL_VAULT_ADDR ports: - port: 8200 EOF 2. \u5275\u5efa external-vault \u670d\u52d9 $ kubectl apply --filename external-vault.yaml service/external-vault created endpoints/external-vault created 3.\u9a57\u8b49 external-vault \u670d\u52d9\u662f\u5426\u53ef\u5f9e devwebapp pod \u4e2d\u5c0b\u5740 $ kubectl exec devwebapp -- curl -s http://external-vault:8200/v1/sys/seal-status | jq \u7d50\u679c\u986f\u793a Vault \u670d\u52d9\u5668\u7684\u72c0\u614b\u3002 { \"type\" : \"shamir\" , \"initialized\" : true, \"sealed\" : false, \"t\" : 1 , \"n\" : 1 , \"progress\" : 0 , \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" : false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" : false, \"storage_type\" : \"inmem\" } 4. \u5275\u5efa\u4e00\u500b\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba external-vault \u670d\u52d9\u7684 pod pod-devwebapp-through-service.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-through-service labels : app : devwebapp-through-service spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root devwebapp-through-service pod \u901a\u904eService name\u800c\u4e0d\u662f\u786c\u7de8\u78bc\u7684\u7db2\u7d61\u5730\u5740\u4f86\u5c0b\u5740 Vault\u3002 $ kubectl apply --filename = pod-devwebapp-through-service.yaml pod/devwebapp-through-service created 5. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 153m devwebapp-through-service 1 /1 Running 0 87s \u7b49\u5230 devwebapp-through-service pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 6. \u5f9e devwebapp-through-service pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u63d0\u4f9b\u7684\u5167\u5bb9 $ kubectl exec devwebapp-through-service -- curl -s localhost:8080 ; echo { \"password\" = > \"salsa\" , \"username\" = > \"giraffe\" } Web \u61c9\u7528\u7a0b\u5e8f\u5c0d\u5176\u901a\u904e external-Vault \u670d\u52d9\u627e\u5230\u7684\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u8acb\u6c42\u3002 \u5b89\u88dd\u914d\u7f6e\u70ba\u5c0b\u5740\u5916\u90e8 Vault \u7684 Vault Helm chart \u00b6 Vault Helm chart \u53ea\u80fd\u90e8\u7f72\u914d\u7f6e\u70ba\u4ee5\u5916\u90e8 Vault \u70ba\u76ee\u6a19\u7684 Vault Agent Injector \u670d\u52d9\u3002\u6ce8\u5165\u5668\u670d\u52d9\u901a\u904e\u5728\u5c07 Vault Agent \u5bb9\u5668\u81ea\u52d5\u5beb\u5165 pod \u6642\u6dfb\u52a0\u5b83\u5011\u4f86\u652f\u6301\u61c9\u7528\u7a0b\u5e8f\u7684\u8eab\u4efd\u9a57\u8b49\u548c\u79d8\u5bc6\u6aa2\u7d22\uff0c\u5b83\u5305\u542b\u7279\u5b9a\u7684\u8a3b\u91cb\u3002 \u5728\u672c\u7bc0\u4e2d\uff0c\u60a8\u5c07\u5b89\u88dd Vault Helm chart \u4e26\u555f\u52d5 Vault agent injector \u670d\u52d9\u3001\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u3001\u5275\u5efa\u89d2\u8272\u4ee5\u8a2a\u554f\u6a5f\u5bc6\u4ee5\u53ca\u4fee\u88dc\u90e8\u7f72\u3002 \u5b89\u88dd Vault Helm chart \u00b6 Vault Helm chart \u555f\u52d5 Vault Agent Injector \u670d\u52d9\u3002 1. \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" already exists with the same configuration, skipping 2. \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"hashicorp\" chart repository ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository Update Complete. \u2388Happy Helming!\u2388 3. \u5b89\u88dd\u5728\u5916\u90e8\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" NAME: vault LAST DEPLOYED: Wed Jul 13 16 :37:28 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault \u70ba injector.externalVaultAddr \u5206\u914d Deploy \u670d\u52d9\u548c\u7aef\u9ede\u4e2d\u5b9a\u7fa9\u7684 Kubernetes \u670d\u52d9\u7684\u5730\u5740\uff0c\u4ee5\u89e3\u6c7a\u5916\u90e8 Vault \u6b65\u9a5f\u3002 Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 4. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 31h devwebapp-through-service 1 /1 Running 0 29h vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 14m \u7b49\u5230 vault-agent-injector pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 Helm chart \u6703\u5275\u5efa\u4e00\u500b vault \u7684 service account\u3002Service account \u7684 JWT \u4ee4\u724c\u662f\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6240\u5fc5\u9700\u7684\u8a2d\u5b9a\u9805\u3002 5. \u63cf\u8ff0 Vault \u670d\u52d9\u5e33\u6236 $ kubectl describe serviceaccount vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: vault-token-kgdww Tokens: vault-token-kgdww Events: <none> 6. \u50c5\u9650 Kubernetes 1.24+ Mountable secrets \u7684\u540d\u7a31\u986f\u793a\u5728 Kubernetes 1.23 \u4e2d\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0cJWT \u4ee4\u724c\u4e0d\u6703\u81ea\u52d5\u5275\u5efa\uff0c\u60a8\u5fc5\u9808\u986f\u5f0f\u5275\u5efa\u5b83\u3002 cat > vault-secret.yaml <<EOF apiVersion: v1 kind: Secret metadata: name: vault-token-g955r annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u5275\u5efa\u4e00\u500b Secret \u3002 $ kubectl apply -f vault-secret.yaml secret/vault-token-g955r created $ kubectl describe sa vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: <none> Tokens: vault-token-kgdww Events: <none> 7. \u5275\u5efa\u4e00\u500b\u540d\u70ba VAULT_HELM_SECRET_NAME \u7684\u8b8a\u91cf\u4f86\u5b58\u5132\u5bc6\u9470\u540d\u7a31 $ VAULT_HELM_SECRET_NAME = $( kubectl get secrets --output = json | jq -r '.items[].metadata | select(.name|startswith(\"vault-token-\")).name' ) \u6b64\u547d\u4ee4\u904e\u6ffe\u4ee5 vault-token- \u958b\u982d\u7684\u79d8\u5bc6\u4e26\u8fd4\u56de\u4ee4\u724c\u7684\u540d\u7a31\u3002 8. \u63cf\u8ff0 Vault \u4ee4\u724c\u79d8\u5bc6 $ kubectl describe secret $VAULT_HELM_SECRET_NAME \u793a\u4f8b\u8f38\u51fa\uff1a $ kubectl describe secret $VAULT_HELM_SECRET_NAME Name: vault-token-kgdww Namespace: default Labels: <none> Annotations: kubernetes.io/service-account.name: vault kubernetes.io/service-account.uid: ab246d63-abae-4244-a173-5eb926e78913 Type: kubernetes.io/service-account-token Data ==== namespace: 7 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6Im1qb3FKczdnM1dFZnpDekd1N2tEU1B5YmhXZTFOVFpScjRxVm9oTUppQU0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InZhdWx0LXRva2VuLWc5NTVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYWIyNDZkNjMtYWJhZS00MjQ0LWExNzMtNWViOTI2ZTc4OTEzIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6dmF1bHQifQ.dVWwFxGLa-lxCqK2L0hllUI6KWAetnzAVMkjF3I7ybGxDq7JJcLyAil8Aym1rRK3gQBkwh1th0yHVrSfezBo0eEUgfPvzY4Qttqc1um3FN8dmPUdjnV4Gewr6hHEYijYtJJW7PWJYS7SmE3tnLuaaoyPFpXJBM-RyTW-aws9O5cZIVD18AI2G23MLhyt1D8nqZr39yyNPsPiwKPa-Ba0QYzMZUOh0AmcLEIP7yGnMM8OLKVeN7XMz7yKbCV1f85Nz0BgH-aPF1rYHr7gCZ5I0jRVPqqpmAl8Gje1OggWxekCnWhZZTmQtMXCR3L2e4q08P2LYTeiSxIiBFeyqjPZVg ca.crt: 1111 bytes \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49 \u00b6 Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 1. \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u6b64\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u914d\u7f6e\u7684 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002\u8981\u6b63\u78ba\u914d\u7f6e\u5b83\uff0c\u9700\u8981\u6355\u7372\u670d\u52d9\u5e33\u6236\u7684 JSON Web \u4ee4\u724c (JWT)\u3001Kubernetes CA \u8b49\u66f8\u548c Kubernetes \u4e3b\u6a5f URL\u3002 2. \u5f9e\u5bc6\u9470\u4e2d\u7372\u53d6 JSON Web \u4ee4\u724c (JWT) $ TOKEN_REVIEW_JWT = $( kubectl get secret $VAULT_HELM_SECRET_NAME --output = 'go-template={{ .data.token }}' | base64 --decode ) 3. \u6aa2\u7d22 Kubernetes CA \u8b49\u66f8 $ KUBE_CA_CERT = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) 4. \u6aa2\u7d22 Kubernetes \u4e3b\u6a5f URL $ KUBE_HOST = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.server}' ) 5. \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3001Kubernetes \u4e3b\u6a5f\u7684\u4f4d\u7f6e\u3001\u5176\u8b49\u66f8\u53ca\u5176\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u540d\u7a31 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $TOKEN_REVIEW_JWT \" \\ kubernetes_host = \" $KUBE_HOST \" \\ kubernetes_ca_cert = \" $KUBE_CA_CERT \" Success! Data written to: auth/kubernetes/config \u8981\u8b93 Vault \u5ba2\u6236\u7aef\u8b80\u53d6 Start Vault \u90e8\u5206\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 secret/data/devwebapp/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002 6. \u5b9a\u7fa9 devwebapp \u7684\u7b56\u7565\uff0c\u8a72\u7b56\u7565\u5728\u8def\u5f91 secret/data/devwebapp/config \u8655\u555f\u7528\u5c0d\u5bc6\u9470\u7684\u8b80\u53d6\u529f\u80fd $ vault policy write devwebapp - <<EOF path \"secret/data/devwebapp/config\" { capabilities = [\"read\"] } EOF Success! Uploaded policy: devwebapp 7. \u5728 Vault \u88e1\u5275\u5efa\u4e00\u500b\u540d\u70ba devweb-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49 role $ vault write auth/kubernetes/role/devweb-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = devwebapp \\ ttl = 24h Success! Data written to: auth/kubernetes/role/devweb-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001\u5167\u90e8\u61c9\u7528\u7a0b\u5e8f\u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 devwebapp \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002 \u5c07 Secret \u6ce8\u5165\u9032 pod \u00b6 Vault Agent Injector \u50c5\u5728 Pod \u6216\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u5c0d\u5176\u9032\u884c\u4fee\u6539\u3002 1.\u4f7f\u7528\u60a8\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4f7f\u7528\u8a3b\u91cb pod-devwebapp-with-annotations.yaml \u6aa2\u67e5 pod pod-devwebapp-with-annotations.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-with-annotations labels : app : devwebapp-with-annotations annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'devweb-app' vault.hashicorp.com/agent-inject-secret-credentials.txt : 'secret/data/devwebapp/config' spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector \u670d\u52d9 role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49 role agent-inject-secret-FILEPATH \u4f5c\u70ba\u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c credentials.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 2. \u5275\u5efa devwebapp-with-annotations pod $ kubectl apply --filename pod-devwebapp-with-annotations.yaml pod/devwebapp-with-annotations created 3. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 33h devwebapp-through-service 1 /1 Running 0 30h devwebapp-with-annotations 0 /2 Init:0/1 0 38s vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 104m \u7b49\u5230 devwebapp-with-annotations pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 Vault Agent Injector \u670d\u52d9\u5728 pod \u4e2d\u5275\u5efa\u4e86\u4e00\u500b\u9644\u52a0\u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u81ea\u52d5\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u8def\u5f91 /vault/secrets/credentials.txt \u8655\u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u3002 4. \u5728 devwebapp-with-annotations pod \u4e0a\u986f\u793a\u5beb\u5165\u6587\u4ef6 /vault/secrets/secret-credentials.txt \u7684\u6a5f\u5bc6 $ kubectl exec -it devwebapp-with-annotations -c app -- cat /vault/secrets/credentials.txt \u7d50\u679c\u986f\u793a\u5bb9\u5668\u4e0a\u5b58\u5728\u7684\u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u3002 data: map [ password:salsa username:giraffe ] metadata: map [ created_time:2022-06-06T18:26:14.070155Z custom_metadata:<nil> deletion_time: destroyed:false version:1 ] Tip \u683c\u5f0f\u5316\u6578\u64da\uff1a\u53ef\u4ee5\u61c9\u7528 \u6a21\u677f \u4f86\u683c\u5f0f\u5316\u9019\u4e9b\u6578\u64da\u4ee5\u6eff\u8db3\u61c9\u7528\u7a0b\u5e8f\u7684\u9700\u8981\u3002 \u9019\u500b pod \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u76f4\u63a5\u6aa2\u7d22\u79d8\u5bc6\uff0c\u4f46\u73fe\u5728\u6ce8\u5165\u5668\u670d\u52d9\u5df2\u90e8\u7f72\u4e26\u4e14\u80fd\u5920\u6aa2\u7d22\u61c9\u7528\u7a0b\u5e8f\u7684\u79d8\u5bc6\uff0c\u672a\u4f86\u7684\u66f4\u65b0\u53ef\u4ee5\u522a\u9664\u8a72\u61c9\u7528\u7a0b\u5e8f\u908f\u8f2f\u3002","title":"Kubernetes \u8207\u5916\u90e8 Vault \u6574\u5408"},{"location":"vault/kubernetes/kubernetes-external-vault/#kubernetes-vault","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-external-vault Vault \u53ef\u4ee5\u7ba1\u7406 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u7684\u6a5f\u5bc6\u3002\u901a\u5e38\u9019\u500b Vault \u670d\u52d9\u662f\u88ab\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e4b\u5916\u3002 Info \u5728 Kubernetes \u4e2d\u904b\u884c Vault\uff1a\u5728 Vault Installation to Minikube via Helm \u548c Injecting Secrets into Kubernetes Pods via Vault Helm Sidecar \u6559\u7a0b\u4e2d\u63a2\u8a0e\u4e86\u5728 K8S \u96c6\u7fa4\u4e2d\u904b\u884c Vault \u670d\u52d9\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5728\u672c\u5730\u904b\u884c Vault\uff0c\u4f7f\u7528 K3D \u555f\u52d5 Kubernetes \u96c6\u7fa4\uff0c\u90e8\u7f72\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u8a72\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u76f4\u63a5\u5f9e Vault \u6aa2\u7d22\u6a5f\u5bc6\uff0c\u4e26\u901a\u904e Vault Agent Injector \u9032\u884c\u6a5f\u5bc6\u6ce8\u5165\u3002","title":"Kubernetes \u8207\u5916\u90e8 Vault \u6574\u5408"},{"location":"vault/kubernetes/kubernetes-external-vault/#_1","text":"\u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001K3D \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 K3D version. $ k3d version k3d version v5.4.1 k3s version v1.22.7-k3s1 ( default ) Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" } \u9019\u4e9b\u662f\u63a8\u85a6\u7684\u8edf\u4ef6\u7248\u672c\uff0c\u986f\u793a\u7684\u8f38\u51fa\u53ef\u80fd\u6703\u56e0\u60a8\u7684\u74b0\u5883\u548c\u60a8\u4f7f\u7528\u7684\u8edf\u4ef6\u7248\u672c\u800c\u7570\u3002 \u63a5\u4e0b\u4f86\uff0c\u901a\u904e\u5f9e GitHub \u4f86 clone hashcorp/vault-guides \u5b58\u5132\u5eab\uff0c\u88e1\u982d\u5305\u542b\u672c\u6559\u7a0b\u7528\u4f86\u9a57\u8b49\u7684\u7bc4\u4f8b Web \u61c9\u7528\u7a0b\u5e8f\u548c\u5176\u4ed6\u914d\u7f6e\u6a94\u6848\u3002 $ git clone https://github.com/hashicorp/vault-guides.git \u6b64\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6307\u5357\u7684\u76f8\u95dc\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6587\u4ef6\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 vault-guides/operations/provision-vault/kubernetes/minikube/external-vault \u76ee\u9304\u3002 $ cd vault-guides/operations/provision-vault/kubernetes/minikube/external-vault Important \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u9918\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault","text":"\u53ea\u8981 Vault \u670d\u52d9\u5668\u662f\u7db2\u5740\u662f\u53ef\u88ab Kubernetes \u9023\u63a5\u5230\u7684\uff0c\u90a3\u9ebc\u904b\u884c\u5728 Kubernetes \u96c6\u7fa4\u5916\u90e8\u7684 Vault \u5c31\u53ef\u4ee5\u88ab\u5b83\u7684\u4efb\u4f55\u88ab\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684 pod \u6240\u9023\u63a5\u3002 1. \u555f\u52d5 Vault \u670d\u52d9 \u6253\u958b\u4e00\u500b\u65b0\u7d42\u7aef\uff0c\u555f\u52d5\u4e00\u500b\u4ee5 root \u4f5c\u70ba root \u4ee4\u724c\u7684 Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u5b83\u5728 0.0.0.0:8200 \u8655\u5075\u807d\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u5c0b\u5740\uff0c\u56e0\u70ba\u5b83\u7d81\u5b9a\u5230\u5171\u4eab\u7db2\u7d61. 2. \u8a2d\u5b9a VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u70ba Vault CLI \u8a2d\u5b9a\u74b0\u5883\u8b8a\u91cf\u4f86\u66b4\u9732\u51fa Vault \u670d\u52d9\u5668\u7db2\u8def\u5730\u5740\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200 \u60a8\u90e8\u7f72\u7684 Web \u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u53d6\u5f97\u5132\u5b58\u5728 Vault \u88e1\u9762\u7684 username \u548c password \uff0c\u9019\u4e9b\u7528\u6236\u540d\u548c\u5bc6\u78bc\u7684\u6a5f\u654f\u8cc7\u8a0a\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cVault \u958b\u767c\u670d\u52d9\u5668\u4ee5\u5728\u4ee5 secret \u70ba\u524d\u7db4\u7684\u8def\u5f91\u4e0a\u555f\u7528\u9375\u503c\u6a5f\u5bc6\u5f15\u64ce\u555f\u52d5\u3002 3. \u4fbf\u7528 root \u4ee4\u724c\u767b\u5165 Vault \u5728\u555f\u52d5 Vault \u6642\u6211\u5011\u8a2d\u5b9a\u7684 root \u4ee4\u724c\u662f root $ vault login root Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \"vault login\" again. Future Vault requests will automatically use this token. Key Value --- ----- token root token_accessor OJU8So8T5wuCassRAJpNrfN4 token_duration \u221e token_renewable false token_policies [ \"root\" ] identity_policies [] policies [ \"root\" ] 4. \u5728 secret/devwebapp/config \u8a2d\u5b9a credential \u4f7f\u7528\u7528\u6236\u540d username \u548c\u5bc6\u78bc password \u5728\u88ab\u5275\u5efa\u5728\u8def\u5f91 secret/devwebapp/config \u4e0a\u3002 $ vault kv put secret/devwebapp/config username = 'giraffe' password = 'salsa' ======== Secret Path ======== secret/data/devwebapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-11T22:35:03.103203218Z custom_metadata <nil> deletion_time n/a destroyed false version 1 5. \u9a57\u8b49 Secret \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002 $ vault kv get -format = json secret/devwebapp/config | jq \".data.data\" { \"password\" : \"salsa\" , \"username\" : \"giraffe\" } \u5e36\u6709\u5bc6\u9470\u7684 Vault \u670d\u52d9\u5668\u5df2\u6e96\u5099\u597d\uff0c\u63a5\u8457\u8b93\u6211\u5011\u914d\u7f6e\u4f86\u8b93 Kubernetes \u96c6\u7fa4\u548c\u90e8\u7f72\u5728\u5176\u4e2d\u7684 pod \u53ef\u9023\u63a5\u5230\u9019\u500b\u5916\u90e8\u7684 Vault \u670d\u52d9\u3002","title":"\u555f\u52d5 Vault"},{"location":"vault/kubernetes/kubernetes-external-vault/#kubernetes","text":"k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u7d50\u679c: Kubernetes control plane is running at https://0.0.0.0:46339 CoreDNS is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy Metrics-server is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy Info \u5982\u679c\u6c92\u6709\u7279\u5225\u5b9a\u7fa9 K3D \u6703\u5728\u5275\u5efa Kubernetes \u96c6\u7fa4\u6642\u81ea\u52d5\u627e\u4e00\u500b\u53ef\u7528\u7684 port \u6210 Kubernetes API server \u4f7f\u7528\u7684 port\u3002","title":"\u555f\u52d5 Kubernetes"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault-address","text":"\u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5411 Kubernetes \u96c6\u7fa4\u7684 \u7db2\u95dc \u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u5c0b\u5740\u3002 1. \u53d6\u5f97\u672c\u6a5f\u7684\u7db2\u7d61\u4f4d\u5740 $ ifconfig wlp4s0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 192 .168.50.191 netmask 255 .255.255.0 broadcast 192 .168.50.255 inet6 fe80::3433:7b7c:e266:7a35 prefixlen 64 scopeid 0x20<link> ether 88 :b1:11:e5:6e:33 txqueuelen 1000 ( Ethernet ) RX packets 473363 bytes 659034753 ( 659 .0 MB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 96234 bytes 19111520 ( 19 .1 MB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \u5728\u7bc4\u4f8b\u7684\u6a5f\u5668\u4e0a\u7684\u7db2\u8def\u4f4d\u5740\u662f 192.168.50.191 (\u9019\u500b ip address \u5728\u4e0d\u540c\u7684\u6a5f\u5668\u4e0a\u90fd\u6703\u662f\u4e0d\u540c\u7684) !! 2. \u9a57\u8b49\u8207 Vault \u7684\u7db2\u7d61\u9023\u63a5 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5617\u8a66\u4f7f\u7528\u524d\u4e00\u6b65\u9a5f\u6240\u53d6\u7684\u7684 ip address \u4f86\u547c\u53eb external Vault \u7684 API\uff1a [ root@ca-test-pod:/ ] $ curl -s http://192.168.50.191:8200/v1/sys/seal-status { \"type\" : \"shamir\" , \"initialized\" :true, \"sealed\" :false, \"t\" :1, \"n\" :1, \"progress\" :0, \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" :false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" :false, \"storage_type\" : \"inmem\" } \u8f38\u51fa\u986f\u793a Vault \u5df2\u521d\u59cb\u5316\u4e14\u672a\u5bc6\u5c01\u3002\u9019\u78ba\u8a8d\u4e86\u96c6\u7fa4\u4e2d\u7684 pod \u80fd\u5920\u8a2a\u554f\u5230 external Vault\u3002 3. \u9000\u51fa pod \u6703\u8a71 [ root@ca-test-pod:/ ] $ exit 4. \u8a2d\u5b9a EXTERNAL_VAULT_ADDR \u74b0\u5883 \u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u5ba3\u544a Vault \u7684\u7db2\u7d61\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = 192 .168.50.191 5. \u9a57\u8b49\u8b8a\u91cf \u9a57\u8b49\u8b8a\u91cf\u3002 $ echo $EXTERNAL_VAULT_ADDR","title":"\u6c7a\u5b9a Vault address"},{"location":"vault/kubernetes/kubernetes-external-vault/#hard-coded-vault","text":"Kubernetes \u96c6\u7fa4\u4e2d\u7684 pods \u627e\u5c0b \u5916\u90e8 Vault \u670d\u52d9\u4f4d\u5740\u7684\u6700\u76f4\u63a5\u65b9\u6cd5\u662f\u76f4\u63a5\u5728\u61c9\u7528\u7a0b\u5f0f\u7684\u7a0b\u5f0f\u78bc\u4e2d\u5b9a\u7fa9 (hard-coded) Valut \u7684\u7db2\u7d61\u4f4d\u5740\u6216\u628a Vault \u7684\u7db2\u7d61\u4f4d\u5740\u7528 \u74b0\u5883\u8b8a\u91cf \u9032\u884c\u63d0\u4f9b\u3002\u6211\u5011\u5df2\u7d93\u5275\u5efa\u4e26\u767c\u5e03\u4e86\u4e00\u500b\u5141\u8a31\u8a2d\u5b9a Vault \u5730\u5740\u7684 Web \u61c9\u7528\u7a0b\u5f0f\u3002 exampleapp config.ru lib/service.rb Dockerfile # This file is a configuration file for a Rackup application. # Load the service file found in the lib directory. require './lib/service' # This Sinatra web application was built in the Classic way. Which # is great for simple web application. Sinatra automatically provides # a class you can provide to Rackup's `run` method to start the # application. # # Read about the 'Modular vs. Classic Style' in the Sinatra README. # @see http://www.sinatrarb.com/intro.html run ExampleApp require \"sinatra\" require \"faraday\" require \"json\" require \"logger\" $stdout . sync = true class ExampleApp < Sinatra :: Base set :port , ENV [ 'SERVICE_PORT' ] || \"8080\" set :vault_token , ENV [ \"VAULT_TOKEN\" ] || \"root\" configure :development do logger = Logger . new ( STDOUT ) logger . level = Logger :: DEBUG set :raise_errors , true set :logger , logger set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://host.docker.internal:8200\" end configure :production do logger = Logger . new ( STDOUT ) logger . level = Logger :: INFO set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://vault:8200\" end # GET \"/\" get \"/\" do logger . info \"Received Request.\" # Set up an undefined state and set the vault server and secrets path secrets = { \"username\" => \"undefined\" , \"password\" => \"undefined\" } secrets_path = \"secret/data/devwebapp/config\" # Ask for the secret at the path vault_response = Faraday . get \" #{ settings . vault_url } /v1/ #{ secrets_path } \" do | req | req . headers [ 'Content-Type' ] = 'application/json' req . headers [ 'X-Vault-Token' ] = settings . vault_token end if vault_response . status != 200 raise Exception . new \"The secret request failed: #{ vault_response . body } \" end # Parse the JSON content = JSON . parse ( vault_response . body ) rescue {} # Traverse the response to find the secrets in the response if content . key? ( 'data' ) and content [ 'data' ]. key? ( 'data' ) secrets = content [ 'data' ][ 'data' ] end # Return secret secrets . to_s end end FROM ruby:2.6.2 RUN apt-get update && \\ apt-get install -y net-tools # Install gems ENV APP_HOME /app ENV HOME /root RUN mkdir $APP_HOME WORKDIR $APP_HOME COPY Gemfile* $APP_HOME / RUN bundle install # Upload source COPY config.ru $APP_HOME RUN mkdir $APP_HOME /lib COPY lib/* $APP_HOME /lib # Start server ENV PORT 8080 EXPOSE 8080 CMD [ \"rackup\" , \"--port\" , \"8080\" , \"--env\" , \"production\" ] 1. \u5275\u5efa internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236 $ kubectl create sa internal-app serviceaccount/internal-app created 2. \u8a2d\u7f6e EXTERNAL_VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u4f7f\u7528\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba EXTERNAL_VAULT_ADDR \u7684 Web \u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u4e00\u500b\u540d\u70ba devwebapp \u7684 pod\u3002 $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: internal-app containers: - name: app image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" - name: VAULT_TOKEN value: root EOF 3. \u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml pod/devwebapp created \u67e5\u770b pod/devwebapp \u7684\u898f\u683c: $ kubectl get pod/devwebapp -o yaml \u7d50\u679c: apiVersion : v1 kind : Pod metadata : annotations : ... ... app : devwebapp name : devwebapp namespace : default resourceVersion : \"1045\" uid : c41d0da7-e2d7-41ad-b3e5-b31a7a0c387a spec : containers : - env : - name : VAULT_ADDR value : http://192.168.50.191:8200 - name : VAULT_TOKEN value : root image : burtlo/devwebapp-ruby:k8s imagePullPolicy : IfNotPresent name : app resources : {} terminationMessagePath : /dev/termination-log terminationMessagePolicy : File volumeMounts : - mountPath : /var/run/secrets/kubernetes.io/serviceaccount name : kube-api-access-nhtdj readOnly : true dnsPolicy : ClusterFirst enableServiceLinks : true nodeName : minikube preemptionPolicy : PreemptLowerPriority priority : 0 restartPolicy : Always schedulerName : default-scheduler securityContext : {} serviceAccount : internal-app serviceAccountName : internal-app terminationGracePeriodSeconds : 30 tolerations : - effect : NoExecute key : node.kubernetes.io/not-ready operator : Exists tolerationSeconds : 300 - effect : NoExecute key : node.kubernetes.io/unreachable operator : Exists tolerationSeconds : 300 volumes : - name : kube-api-access-nhtdj projected : defaultMode : 420 sources : - serviceAccountToken : expirationSeconds : 3607 path : token - configMap : items : - key : ca.crt path : ca.crt name : kube-root-ca.crt - downwardAPI : items : - fieldRef : apiVersion : v1 fieldPath : metadata.namespace path : namespace 4. \u7372\u53d6 default \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 2m11s \u7b49\u5230 devwebapp pod \u5831\u544a\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 5. \u5f9e devwebapp pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u7684\u5167\u5bb9 $ kubectl exec devwebapp -- curl -s localhost:8080 ; echo \u7d50\u679c\u986f\u793a Secret \u662f\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u3002 {\"password\"=>\"salsa\", \"username\"=>\"giraffe\"} Web \u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u6839\u4ee4\u724c\u5411\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4e26\u8fd4\u56de\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u5bc6\u9470\u3002\u5982\u679c Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u4e0d\u8b8a\uff0c\u9019\u7a2e\u786c\u7de8\u78bc\u65b9\u6cd5\u662f\u4e00\u7a2e\u6709\u6548\u7684\u89e3\u6c7a\u65b9\u6848\u3002","title":"\u4f7f\u7528 hard-coded \u7684 Vault \u5730\u5740\u4f48\u7f72\u61c9\u7528\u7a0b\u5e8f"},{"location":"vault/kubernetes/kubernetes-external-vault/#k8s-service-endpoint-external-vault","text":"\u5916\u90e8 Vault \u53ef\u80fd\u6c92\u6709 K8S \u96c6\u7fa4\u7684 Service \u53ef\u4ee5\u8b93\u76f8\u95dc\u7684 Pod \u4f86\u4f9d\u8cf4\u3002\u7576 Vault \u7684\u7db2\u8def\u5730\u5740\u66f4\u6539\u6642\uff0c\u6bcf\u500b Pod \u4e5f\u9700\u8981\u66f4\u6539\u624d\u80fd\u7e7c\u7e8c\u904b\u884c\u3002\u7ba1\u7406\u6b64\u7db2\u8def\u5730\u5740\u7684\u53e6\u4e00\u7a2e\u65b9\u6cd5\u662f\u5728Kubernetes \u4e2d\u901a\u904e\u5b9a\u7fa9 service \u548c endpoint \u7269\u4ef6\u4f86\u6307\u5411 Vault\u3002 Service \u7269\u4ef6\u662f\u5c0d Kubernetes \u5916\u90e8\u670d\u52d9\u7684\u62bd\u8c61\u8868\u793a\u3002\u7576\u5728 pod \u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u8acb\u6c42 service \u6642\uff0c\u8a72\u8acb\u6c42\u5c07\u88ab\u8def\u7531\u5230\u5171\u4eab service \u7684 endpoint \u3002 1. \u5b9a\u7fa9 service \u8207 endpoint \u7684\u7269\u4ef6 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba external-vault \u7684\u670d\u52d9\u548c\u4e00\u500b\u914d\u7f6e\u70ba\u5c0b\u5740 EXTERNAL_VAULT_ADDR \u7684\u76f8\u61c9\u7aef\u9ede\u3002 \u76f8\u95dc\u7684\u8aaa\u660e\u898b Kubernetes Service Overview \u3002 $ cat > external-vault.yaml <<EOF --- apiVersion: v1 kind: Service metadata: name: external-vault namespace: default spec: ports: - protocol: TCP port: 8200 --- apiVersion: v1 kind: Endpoints metadata: name: external-vault subsets: - addresses: - ip: $EXTERNAL_VAULT_ADDR ports: - port: 8200 EOF 2. \u5275\u5efa external-vault \u670d\u52d9 $ kubectl apply --filename external-vault.yaml service/external-vault created endpoints/external-vault created 3.\u9a57\u8b49 external-vault \u670d\u52d9\u662f\u5426\u53ef\u5f9e devwebapp pod \u4e2d\u5c0b\u5740 $ kubectl exec devwebapp -- curl -s http://external-vault:8200/v1/sys/seal-status | jq \u7d50\u679c\u986f\u793a Vault \u670d\u52d9\u5668\u7684\u72c0\u614b\u3002 { \"type\" : \"shamir\" , \"initialized\" : true, \"sealed\" : false, \"t\" : 1 , \"n\" : 1 , \"progress\" : 0 , \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" : false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" : false, \"storage_type\" : \"inmem\" } 4. \u5275\u5efa\u4e00\u500b\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba external-vault \u670d\u52d9\u7684 pod pod-devwebapp-through-service.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-through-service labels : app : devwebapp-through-service spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root devwebapp-through-service pod \u901a\u904eService name\u800c\u4e0d\u662f\u786c\u7de8\u78bc\u7684\u7db2\u7d61\u5730\u5740\u4f86\u5c0b\u5740 Vault\u3002 $ kubectl apply --filename = pod-devwebapp-through-service.yaml pod/devwebapp-through-service created 5. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 153m devwebapp-through-service 1 /1 Running 0 87s \u7b49\u5230 devwebapp-through-service pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 6. \u5f9e devwebapp-through-service pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u63d0\u4f9b\u7684\u5167\u5bb9 $ kubectl exec devwebapp-through-service -- curl -s localhost:8080 ; echo { \"password\" = > \"salsa\" , \"username\" = > \"giraffe\" } Web \u61c9\u7528\u7a0b\u5e8f\u5c0d\u5176\u901a\u904e external-Vault \u670d\u52d9\u627e\u5230\u7684\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u8acb\u6c42\u3002","title":"\u5728 K8S \u90e8\u7f72 service \u548c endpoint \u4f86\u6620\u5c04\u81f3 external Vault"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault-vault-helm-chart","text":"Vault Helm chart \u53ea\u80fd\u90e8\u7f72\u914d\u7f6e\u70ba\u4ee5\u5916\u90e8 Vault \u70ba\u76ee\u6a19\u7684 Vault Agent Injector \u670d\u52d9\u3002\u6ce8\u5165\u5668\u670d\u52d9\u901a\u904e\u5728\u5c07 Vault Agent \u5bb9\u5668\u81ea\u52d5\u5beb\u5165 pod \u6642\u6dfb\u52a0\u5b83\u5011\u4f86\u652f\u6301\u61c9\u7528\u7a0b\u5e8f\u7684\u8eab\u4efd\u9a57\u8b49\u548c\u79d8\u5bc6\u6aa2\u7d22\uff0c\u5b83\u5305\u542b\u7279\u5b9a\u7684\u8a3b\u91cb\u3002 \u5728\u672c\u7bc0\u4e2d\uff0c\u60a8\u5c07\u5b89\u88dd Vault Helm chart \u4e26\u555f\u52d5 Vault agent injector \u670d\u52d9\u3001\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u3001\u5275\u5efa\u89d2\u8272\u4ee5\u8a2a\u554f\u6a5f\u5bc6\u4ee5\u53ca\u4fee\u88dc\u90e8\u7f72\u3002","title":"\u5b89\u88dd\u914d\u7f6e\u70ba\u5c0b\u5740\u5916\u90e8 Vault \u7684 Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault-helm-chart","text":"Vault Helm chart \u555f\u52d5 Vault Agent Injector \u670d\u52d9\u3002 1. \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" already exists with the same configuration, skipping 2. \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"hashicorp\" chart repository ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository Update Complete. \u2388Happy Helming!\u2388 3. \u5b89\u88dd\u5728\u5916\u90e8\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" NAME: vault LAST DEPLOYED: Wed Jul 13 16 :37:28 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault \u70ba injector.externalVaultAddr \u5206\u914d Deploy \u670d\u52d9\u548c\u7aef\u9ede\u4e2d\u5b9a\u7fa9\u7684 Kubernetes \u670d\u52d9\u7684\u5730\u5740\uff0c\u4ee5\u89e3\u6c7a\u5916\u90e8 Vault \u6b65\u9a5f\u3002 Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 4. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 31h devwebapp-through-service 1 /1 Running 0 29h vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 14m \u7b49\u5230 vault-agent-injector pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 Helm chart \u6703\u5275\u5efa\u4e00\u500b vault \u7684 service account\u3002Service account \u7684 JWT \u4ee4\u724c\u662f\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6240\u5fc5\u9700\u7684\u8a2d\u5b9a\u9805\u3002 5. \u63cf\u8ff0 Vault \u670d\u52d9\u5e33\u6236 $ kubectl describe serviceaccount vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: vault-token-kgdww Tokens: vault-token-kgdww Events: <none> 6. \u50c5\u9650 Kubernetes 1.24+ Mountable secrets \u7684\u540d\u7a31\u986f\u793a\u5728 Kubernetes 1.23 \u4e2d\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0cJWT \u4ee4\u724c\u4e0d\u6703\u81ea\u52d5\u5275\u5efa\uff0c\u60a8\u5fc5\u9808\u986f\u5f0f\u5275\u5efa\u5b83\u3002 cat > vault-secret.yaml <<EOF apiVersion: v1 kind: Secret metadata: name: vault-token-g955r annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u5275\u5efa\u4e00\u500b Secret \u3002 $ kubectl apply -f vault-secret.yaml secret/vault-token-g955r created $ kubectl describe sa vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: <none> Tokens: vault-token-kgdww Events: <none> 7. \u5275\u5efa\u4e00\u500b\u540d\u70ba VAULT_HELM_SECRET_NAME \u7684\u8b8a\u91cf\u4f86\u5b58\u5132\u5bc6\u9470\u540d\u7a31 $ VAULT_HELM_SECRET_NAME = $( kubectl get secrets --output = json | jq -r '.items[].metadata | select(.name|startswith(\"vault-token-\")).name' ) \u6b64\u547d\u4ee4\u904e\u6ffe\u4ee5 vault-token- \u958b\u982d\u7684\u79d8\u5bc6\u4e26\u8fd4\u56de\u4ee4\u724c\u7684\u540d\u7a31\u3002 8. \u63cf\u8ff0 Vault \u4ee4\u724c\u79d8\u5bc6 $ kubectl describe secret $VAULT_HELM_SECRET_NAME \u793a\u4f8b\u8f38\u51fa\uff1a $ kubectl describe secret $VAULT_HELM_SECRET_NAME Name: vault-token-kgdww Namespace: default Labels: <none> Annotations: kubernetes.io/service-account.name: vault kubernetes.io/service-account.uid: ab246d63-abae-4244-a173-5eb926e78913 Type: kubernetes.io/service-account-token Data ==== namespace: 7 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6Im1qb3FKczdnM1dFZnpDekd1N2tEU1B5YmhXZTFOVFpScjRxVm9oTUppQU0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InZhdWx0LXRva2VuLWc5NTVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYWIyNDZkNjMtYWJhZS00MjQ0LWExNzMtNWViOTI2ZTc4OTEzIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6dmF1bHQifQ.dVWwFxGLa-lxCqK2L0hllUI6KWAetnzAVMkjF3I7ybGxDq7JJcLyAil8Aym1rRK3gQBkwh1th0yHVrSfezBo0eEUgfPvzY4Qttqc1um3FN8dmPUdjnV4Gewr6hHEYijYtJJW7PWJYS7SmE3tnLuaaoyPFpXJBM-RyTW-aws9O5cZIVD18AI2G23MLhyt1D8nqZr39yyNPsPiwKPa-Ba0QYzMZUOh0AmcLEIP7yGnMM8OLKVeN7XMz7yKbCV1f85Nz0BgH-aPF1rYHr7gCZ5I0jRVPqqpmAl8Gje1OggWxekCnWhZZTmQtMXCR3L2e4q08P2LYTeiSxIiBFeyqjPZVg ca.crt: 1111 bytes","title":"\u5b89\u88dd Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-external-vault/#kubernetes_1","text":"Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 1. \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u6b64\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u914d\u7f6e\u7684 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002\u8981\u6b63\u78ba\u914d\u7f6e\u5b83\uff0c\u9700\u8981\u6355\u7372\u670d\u52d9\u5e33\u6236\u7684 JSON Web \u4ee4\u724c (JWT)\u3001Kubernetes CA \u8b49\u66f8\u548c Kubernetes \u4e3b\u6a5f URL\u3002 2. \u5f9e\u5bc6\u9470\u4e2d\u7372\u53d6 JSON Web \u4ee4\u724c (JWT) $ TOKEN_REVIEW_JWT = $( kubectl get secret $VAULT_HELM_SECRET_NAME --output = 'go-template={{ .data.token }}' | base64 --decode ) 3. \u6aa2\u7d22 Kubernetes CA \u8b49\u66f8 $ KUBE_CA_CERT = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) 4. \u6aa2\u7d22 Kubernetes \u4e3b\u6a5f URL $ KUBE_HOST = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.server}' ) 5. \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3001Kubernetes \u4e3b\u6a5f\u7684\u4f4d\u7f6e\u3001\u5176\u8b49\u66f8\u53ca\u5176\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u540d\u7a31 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $TOKEN_REVIEW_JWT \" \\ kubernetes_host = \" $KUBE_HOST \" \\ kubernetes_ca_cert = \" $KUBE_CA_CERT \" Success! Data written to: auth/kubernetes/config \u8981\u8b93 Vault \u5ba2\u6236\u7aef\u8b80\u53d6 Start Vault \u90e8\u5206\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 secret/data/devwebapp/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002 6. \u5b9a\u7fa9 devwebapp \u7684\u7b56\u7565\uff0c\u8a72\u7b56\u7565\u5728\u8def\u5f91 secret/data/devwebapp/config \u8655\u555f\u7528\u5c0d\u5bc6\u9470\u7684\u8b80\u53d6\u529f\u80fd $ vault policy write devwebapp - <<EOF path \"secret/data/devwebapp/config\" { capabilities = [\"read\"] } EOF Success! Uploaded policy: devwebapp 7. \u5728 Vault \u88e1\u5275\u5efa\u4e00\u500b\u540d\u70ba devweb-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49 role $ vault write auth/kubernetes/role/devweb-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = devwebapp \\ ttl = 24h Success! Data written to: auth/kubernetes/role/devweb-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001\u5167\u90e8\u61c9\u7528\u7a0b\u5e8f\u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 devwebapp \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002","title":"\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49"},{"location":"vault/kubernetes/kubernetes-external-vault/#secret-pod","text":"Vault Agent Injector \u50c5\u5728 Pod \u6216\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u5c0d\u5176\u9032\u884c\u4fee\u6539\u3002 1.\u4f7f\u7528\u60a8\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4f7f\u7528\u8a3b\u91cb pod-devwebapp-with-annotations.yaml \u6aa2\u67e5 pod pod-devwebapp-with-annotations.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-with-annotations labels : app : devwebapp-with-annotations annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'devweb-app' vault.hashicorp.com/agent-inject-secret-credentials.txt : 'secret/data/devwebapp/config' spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector \u670d\u52d9 role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49 role agent-inject-secret-FILEPATH \u4f5c\u70ba\u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c credentials.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 2. \u5275\u5efa devwebapp-with-annotations pod $ kubectl apply --filename pod-devwebapp-with-annotations.yaml pod/devwebapp-with-annotations created 3. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 33h devwebapp-through-service 1 /1 Running 0 30h devwebapp-with-annotations 0 /2 Init:0/1 0 38s vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 104m \u7b49\u5230 devwebapp-with-annotations pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 Vault Agent Injector \u670d\u52d9\u5728 pod \u4e2d\u5275\u5efa\u4e86\u4e00\u500b\u9644\u52a0\u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u81ea\u52d5\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u8def\u5f91 /vault/secrets/credentials.txt \u8655\u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u3002 4. \u5728 devwebapp-with-annotations pod \u4e0a\u986f\u793a\u5beb\u5165\u6587\u4ef6 /vault/secrets/secret-credentials.txt \u7684\u6a5f\u5bc6 $ kubectl exec -it devwebapp-with-annotations -c app -- cat /vault/secrets/credentials.txt \u7d50\u679c\u986f\u793a\u5bb9\u5668\u4e0a\u5b58\u5728\u7684\u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u3002 data: map [ password:salsa username:giraffe ] metadata: map [ created_time:2022-06-06T18:26:14.070155Z custom_metadata:<nil> deletion_time: destroyed:false version:1 ] Tip \u683c\u5f0f\u5316\u6578\u64da\uff1a\u53ef\u4ee5\u61c9\u7528 \u6a21\u677f \u4f86\u683c\u5f0f\u5316\u9019\u4e9b\u6578\u64da\u4ee5\u6eff\u8db3\u61c9\u7528\u7a0b\u5e8f\u7684\u9700\u8981\u3002 \u9019\u500b pod \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u76f4\u63a5\u6aa2\u7d22\u79d8\u5bc6\uff0c\u4f46\u73fe\u5728\u6ce8\u5165\u5668\u670d\u52d9\u5df2\u90e8\u7f72\u4e26\u4e14\u80fd\u5920\u6aa2\u7d22\u61c9\u7528\u7a0b\u5e8f\u7684\u79d8\u5bc6\uff0c\u672a\u4f86\u7684\u66f4\u65b0\u53ef\u4ee5\u522a\u9664\u8a72\u61c9\u7528\u7a0b\u5e8f\u908f\u8f2f\u3002","title":"\u5c07 Secret \u6ce8\u5165\u9032 pod"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/","text":"\u901a\u904e\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u639b\u8f09 Vault Secret \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-secret-store-driver \u4f9d\u8cf4 Vault \u7ba1\u7406\u5176\u6a5f\u5bc6\u7684 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8acb\u6c42\u76f4\u63a5\u6aa2\u7d22\u5b83\u5011\uff0c\u6216\u8005\u901a\u904e Vault Injector \u670d\u52d9\u901a\u904e\u8a3b\u91cb\u6216\u9644\u52a0\u70ba\u81e8\u6642\u5377\u5728\u5df2\u5b89\u88dd\u7684\u6587\u4ef6\u7cfb\u7d71\u4e0a\u7dad\u8b77\u5b83\u5011\u3002\u9019\u7a2e\u4f7f\u7528\u81e8\u6642\u5377\u5b58\u5132\u6a5f\u5bc6\u7684\u65b9\u6cd5\u662f Kubernetes \u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u9a45\u52d5\u7a0b\u5e8f\u7684 Secrets Store \u64f4\u5c55\u7684\u4e00\u500b\u529f\u80fd\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Helm chart \u8a2d\u7f6e Vault \u53ca\u5176\u4f9d\u8cf4\u9805\u3002\u7136\u5f8c\u555f\u7528\u4e26\u914d\u7f6e secrets store CSI driver \u4ee5\u5275\u5efa\u4e00\u500b\u5305\u542b\u60a8\u5c07\u639b\u8f09\u5230\u61c9\u7528\u7a0b\u5e8f pod \u7684\u79d8\u5bc6\u7684 volume\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 Minikube version. $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7 Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" } \u555f\u52d5 Kubernetes \u00b6 Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u7528\u65bc\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002\u9019\u4e9b\u96c6\u7fa4\u5728\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u904b\u884c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \ud83c\udf89 minikube 1 .26.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.26.0 \ud83d\udca1 To disable this notice, run: 'minikube config set WantUpdateNotification false' \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 2 , Memory = 3900MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u986f\u793a Kubernetes \u96c6\u7fa4\u7684\u7248\u672c\u3002 $ kubectl version --output = json { \"clientVersion\" : { \"major\" : \"1\" , \"minor\" : \"24\" , \"gitVersion\" : \"v1.24.1\" , \"gitCommit\" : \"3ddd0f45aa91e2f30c70734b175631bec5b5825a\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-05-24T12:26:19Z\" , \"goVersion\" : \"go1.18.2\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } , \"kustomizeVersion\" : \"v4.5.4\" , \"serverVersion\" : { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } } \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Runningk3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684\u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 kubelet: Running apiserver: Running kubeconfig: Configured k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u4e3b\u6a5f\u3001kubelet\u3001apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002 \u5b89\u88dd Vault Helm chart \u00b6 Vault \u7ba1\u7406\u5beb\u5165\u9019\u4e9b\u53ef\u639b\u8f09\u5377\u7684\u6a5f\u5bc6\u3002\u8981\u63d0\u4f9b\u9019\u4e9b\u6a5f\u5bc6\uff0c\u9700\u8981\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u5c0d\u65bc\u6b64\u6f14\u793a\uff0cVault \u53ef\u4ee5\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\uff0c\u4ee5\u81ea\u52d5\u8655\u7406 KV \u6a5f\u5bc6\u5f15\u64ce\u7684\u521d\u59cb\u5316\u3001\u89e3\u5c01\u548c\u8a2d\u7f6e\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository ...Successfully got an update from the \"hashicorp\" chart repository Update Complete. \u2388Happy Helming!\u2388 \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u4e26\u7981\u7528\u6ce8\u5165\u5668\u670d\u52d9\u4e26\u555f\u7528 CSI\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \\ --set \"injector.enabled=false\" \\ --set \"csi.enabled=true\" \u793a\u4f8b\u8f38\u51fa\uff1a NAME: vault LAST DEPLOYED: Sun Jul 10 22 :23:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault Vault \u670d\u52d9\u5668\u5728\u55ae\u500b pod server.dev.enabled=true \u4e0a\u4ee5\u958b\u767c\u6a21\u5f0f\u904b\u884c\u3002 Vault Agent Injector pod \u88ab\u7981\u7528 injector.enabled=false \u4e26\u4e14 Vault CSI Provider pod csi.enabled=true \u88ab\u555f\u7528\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 16m vault-csi-provider-8kxjg 1 /1 Running 0 16m \u7b49\u5230 vault-0 pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 Vault \u4e2d\u8a2d\u7f6e Secret \u00b6 \u5728 Create a pod with secretmounted \u90e8\u5206\u4e2d\u639b\u8f09\u5230 pod \u7684\u6372\u9700\u8981\u5b58\u5132\u5728\u8def\u5f91 secret/data/db-pass \u4e2d\u7684 secret\u3002\u7576 Vault \u5728\u958b\u767c\u4e2d\u904b\u884c\u6642\uff0c\u5728\u8def\u5f91 /secret \u4e2d\u555f\u7528\u4e86 KV \u79d8\u5bc6\u5f15\u64ce\u3002 \u9996\u5148\uff0c\u5728 vault-0 pod \u4e0a\u555f\u52d5\u4e00\u500b\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 / $ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u4f7f\u7528\u5bc6\u78bc\u5728\u8def\u5f91 secret/db-pass \u8655\u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put secret/db-pass password = \"db-secret-password\" === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u5728\u8def\u5f91 secret/db-pass \u4e0a\u662f\u5426\u53ef\u8b80\u3002 / $ vault kv get secret/db-pass === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password \u914d\u7f6e Kubernetes authentication \u00b6 Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication \u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u8a2a\u554f\u5bc6\u9470\u548c\u5275\u5efa\u5377\u7684 Kubernetes \u8cc7\u6e90\u901a\u904e\u6b64\u65b9\u6cd5\u901a\u904e\u89d2\u8272\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ \u4f7f\u7528 Kubernetes API \u5730\u5740\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5b83\u5c07\u81ea\u52d5\u4f7f\u7528 Vault pod \u81ea\u5df1\u7684\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config \u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684\u7b56\u7565\u3002\u9019\u5c07\u7528\u65bc\u6388\u4e88 webapp-sa \u670d\u52d9\u5e33\u6236\u8b80\u53d6\u4e4b\u524d\u5275\u5efa\u7684 kv \u5bc6\u9470\u7684\u6b0a\u9650\u3002 / $ vault policy write internal-app - <<EOF path \"secret/data/db-pass\" { capabilities = [\"read\"] } EOF kv-v2 \u7684\u6578\u64da\u8981\u6c42\u5728\u5176\u639b\u8f09\u8def\u5f91\uff08\u672c\u4f8b\u4e2d\u70ba secret/ \uff09\u4e4b\u5f8c\u5305\u542b\u984d\u5916\u7684\u6578\u64da\u8def\u5f91\u5143\u7d20\u3002 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba database \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\uff0c\u8a72\u89d2\u8272\u5c07\u6b64\u7b56\u7565\u8207\u540d\u70ba webapp-sa \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u7d81\u5b9a\u3002 / $ vault write auth/kubernetes/role/database \\ bound_service_account_names = webapp-sa \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 20m \u7d50\u679c: Success! Data written to: auth/kubernetes/role/database \u8a72\u89d2\u8272\u5c07\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u4e2d\u7684 Kubernetes \u670d\u52d9\u5e33\u6236 webapp-sa \u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 20 \u5206\u9418\u3002\u9019\u500b Kubernetes \u670d\u52d9\u5e33\u6236\u540d\u7a31 webapp-sa \u5c07\u5728\u4e0b\u9762\u5275\u5efa\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit \u5b89\u88dd secrets store CSI driver \u00b6 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f secrets-store.csi.k8s.io \u5141\u8a31 Kubernetes \u5c07\u5b58\u5132\u5728\u4f01\u696d\u7d1a\u5916\u90e8\u6a5f\u5bc6\u5b58\u5132\u4e2d\u7684\u591a\u500b\u6a5f\u5bc6\u3001\u5bc6\u9470\u548c\u8b49\u66f8\u4f5c\u70ba\u5377\u639b\u8f09\u5230\u5176 pod \u4e2d\u3002\u9644\u52a0\u5377\u5f8c\uff0c\u5176\u4e2d\u7684\u6578\u64da\u5c07\u88ab\u639b\u8f09\u5230\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u6dfb\u52a0 Secrets Store CSI \u9a45\u52d5 Helm \u5b58\u5132\u5eab\u3002 $ helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts \"secrets-store-csi-driver\" has been added to your repositories \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Kubernetes Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u3002 $ helm install csi secrets-store-csi-driver/secrets-store-csi-driver \\ --set syncSecret.enabled = true \u7d50\u679c: NAME: csi LAST DEPLOYED: Sun Jul 10 23 :57:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: The Secrets Store CSI Driver is getting deployed to your cluster. To verify that Secrets Store CSI Driver has started, run: kubectl --namespace = default get pods -l \"app=secrets-store-csi-driver\" Now you can follow these steps https://secrets-store-csi-driver.sigs.k8s.io/getting-started/usage.html to create a SecretProviderClass resource, and a deployment using the SecretProviderClass. \u9a57\u8b49 Vault CSI provider \u555f\u52d5\u72c0\u614b \u00b6 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u652f\u6301\u901a\u904e\u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u64f4\u5c55\u3002\u63d0\u4f9b\u8005\u4f5c\u70ba Kubernetes DaemonSet \u8207 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f DaemonSet \u4e00\u8d77\u555f\u52d5\u3002 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u901a\u904e Vault Helm chart \u5b89\u88dd\u5728 Vault \u65c1\u908a\u3002 \u6b64 DaemonSet \u555f\u52d5\u5176\u81ea\u5df1\u7684\u63d0\u4f9b\u7a0b\u5e8f pod \u4e26\u904b\u884c\u4e00\u500b gRPC \u670d\u52d9\u5668\uff0cSecrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9023\u63a5\u5230\u8a72\u670d\u52d9\u5668\u4ee5\u767c\u51fa\u5377\u639b\u8f09\u8acb\u6c42\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\uff0c\u4ee5\u6aa2\u67e5 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 4m58s vault-0 1 /1 Running 0 99m vault-csi-provider-8kxjg 1 /1 Running 0 99m \u7b49\u5230 vault-csi-provider pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5b9a\u7fa9 SecretProviderClass resource \u00b6 Kubernetes Secrets Store CSI Driver Helm \u5716\u8868\u70ba SecretProviderClass \u8cc7\u6e90\u5275\u5efa\u5b9a\u7fa9\u3002\u6b64\u8cc7\u6e90\u63cf\u8ff0\u4e86\u63d0\u4f9b\u7d66 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u7684\u53c3\u6578\u3002\u8981\u914d\u7f6e\u5b83\uff0c\u9700\u8981 Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u3001Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u7684\u540d\u7a31\u548c\u6a5f\u5bc6\u3002 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u5275\u5efa vault-database \u7684 SecretProviderClass\u3002 $ kubectl apply --filename spc-vault-database.yaml secretproviderclass.secrets-store.csi.x-k8s.io/vault-database created vault-database \u7684 SecretProviderClass \u63cf\u8ff0\u4e86\u4e00\u500b Secret \u7269\u4ef6\uff1a objectName \u662f secret \u7684 symbolic name \u8207\u8981\u69cb\u5efa\u7684\u6a94\u6848\u540d\u7a31\u3002 secretPath \u662f secret \u5b9a\u7fa9\u5728 Vault \u88e1\u7684\u8def\u5f91\u3002 secretKey \u662f secret \u88e1\u7684\u9375\u540d(key name)\u3002 \u9a57\u8b49\u5df2\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5b9a\u7fa9\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ kubectl describe SecretProviderClass vault-database Name: vault-database Namespace: default Labels: <none> Annotations: kubectl.kubernetes.io/last-applied-configuration: { \"apiVersion\" : \"secrets-store.csi.x-k8s.io/v1\" , \"kind\" : \"SecretProviderClass\" , \"metadata\" : { \"annotations\" : {} , \"name\" : \"vault-database\" , \"namespace... API Version: secrets-store.csi.x-k8s.io/v1 Kind: SecretProviderClass ## ... \u5275\u5efa\u4e00\u500b\u639b\u8f09 secret \u7684 pod \u00b6 \u5c07 secret \u5b58\u5132\u5728 Vault \u4e2d\uff0c\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u4e26\u5275\u5efa\u89d2\u8272\uff0c\u5b89\u88dd provider-vault \u64f4\u5c55\u4e26\u5b9a\u7fa9 SecretProviderClass \uff0c\u6700\u5f8c\u662f\u6642\u5019\u5275\u5efa\u4e00\u500b\u639b\u8f09\u6240\u9700\u6a5f\u5bc6\u7684 pod\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba webapp-sa \u7684\u670d\u52d9\u5e33\u6236\u3002 $ kubectl create serviceaccount webapp-sa \u5b9a\u7fa9\u639b\u8f09\u79d8\u5bc6\u5377\u7684 webapp pod\u3002 $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF webapp pod \u5b9a\u7fa9\u4e86\u4e00\u500b\u552f\u8b80\u5377(volume)\u4e26\u5c07\u5176\u639b\u8f09\u5230 /mnt/secrets-store \u3002\u5728 vault-database SecretProviderClass \u4e2d\u5b9a\u7fa9\u7684\u7269\u4ef6\u5c07\u88ab\u5beb\u5165\u81f3\u8a72\u8def\u5f91\u4e2d\u7684\u6587\u4ef6\u3002 \u5275\u5efa webapp pod \u3002 $ kubectl apply --filename webapp-pod.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 6h23m vault-0 1 /1 Running 0 7h57m vault-csi-provider-8kxjg 1 /1 Running 0 7h57m webapp \u7b49\u5230 webapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 webapp pod \u4e0a\u7684 /mnt/secrets-store/db-password \u4e2d\u986f\u793a\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u7684\u5bc6\u78bc\u6a5f\u5bc6\u3002 $ kubectl exec webapp -- cat /mnt/secrets-store/db-password db-secret-password \u986f\u793a\u7684\u503c\u8207\u79d8\u5bc6 secret/db-pass \u7684\u5bc6\u78bc\u503c\u5339\u914d\u3002 \u540c\u6b65\u5230 Kubernetes Secret \u00b6 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9084\u652f\u6301\u540c\u6b65\u5230 Kubernetes \u7684 Secret \u7269\u4ef6\u3002 Kubernetes Secret \u586b\u5145\u4e86 CSI \u5377\u4e2d\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u5b83\u5011\u7684\u751f\u547d\u9031\u671f\u8207\u5275\u5efa\u5b83\u5011\u7684 pod \u7684\u751f\u547d\u9031\u671f\u5bc6\u5207\u76f8\u95dc\u3002 \u8981\u70ba\u60a8\u7684 webapp pod \u6dfb\u52a0 secret \u540c\u6b65\uff0c\u8acb\u66f4\u65b0 SecretProviderClass \u4ee5\u6dfb\u52a0\u4e00\u500b secretObjects \u689d\u76ee\uff1a $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault secretObjects: - data: - key: password objectName: db-password secretName: dbpass type: Opaque parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u61c9\u7528\u66f4\u6539\uff1a $ kubectl apply --filename spc-vault-database.yaml \u7576 pod \u5f15\u7528\u6b64 SecretProviderClass \u6642\uff0cCSI \u9a45\u52d5\u7a0b\u5e8f\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dbpass \u7684 Kubernetes secret\uff0c\u5176\u4e2d password \u5b57\u6bb5\u8a2d\u7f6e\u70ba\u53c3\u6578\u4e2d db-password \u5c0d\u8c61\u7684\u5167\u5bb9\u3002 Pod \u6703\u5728\u555f\u52d5\u524d\u7b49\u5f85 Secret \u88ab\u5275\u5efa\uff0c\u7576 Pod \u505c\u6b62\u6642\uff0cSecret \u6703\u88ab\u522a\u9664 \u3002 \u63a5\u4e0b\u4f86\uff0c\u66f4\u65b0 pod \u4ee5\u5f15\u7528\u65b0\u7684 secret\uff1a $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp env: - name: DB_PASSWORD valueFrom: secretKeyRef: name: dbpass key: password volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF \u8acb\u6ce8\u610f\uff0c\u73fe\u5728\u6709\u4e00\u500b env \u689d\u76ee\uff0c\u5f15\u7528\u4e86\u4e00\u500b\u79d8\u5bc6\u3002\u522a\u9664\u4e26\u91cd\u65b0\u90e8\u7f72 pod\uff1a $ kubectl delete pod webapp && kubectl apply --filename webapp-pod.yaml \u90e8\u7f72\u66f4\u65b0\u7684\u914d\u7f6e\u4e26\u7b49\u5f85 webapp pod \u518d\u6b21\u51fa\u73fe\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-w2xxv 3 /3 Running 0 4m28s vault-0 1 /1 Running 0 5m57s vault-csi-provider-qxz8d 1 /1 Running 0 5m57s webapp 1 /1 Running 0 36s \u60a8\u73fe\u5728\u53ef\u4ee5\u9a57\u8b49 Kubernetes \u5bc6\u9470\u662f\u5426\u5df2\u5275\u5efa\uff1a $ kubectl get secret dbpass NAME TYPE DATA AGE dbpass Opaque 1 100s \u60a8\u9084\u53ef\u4ee5\u9a57\u8b49\u8a72\u79d8\u5bc6\u5728 pod \u7684\u74b0\u5883\u4e2d\u662f\u5426\u53ef\u7528\uff1a $ kubectl exec webapp -- env | grep DB_PASSWORD DB_PASSWORD = db-secret-password","title":"\u901a\u904e\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u639b\u8f09 Vault Secret"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#csi-vault-secret","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-secret-store-driver \u4f9d\u8cf4 Vault \u7ba1\u7406\u5176\u6a5f\u5bc6\u7684 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8acb\u6c42\u76f4\u63a5\u6aa2\u7d22\u5b83\u5011\uff0c\u6216\u8005\u901a\u904e Vault Injector \u670d\u52d9\u901a\u904e\u8a3b\u91cb\u6216\u9644\u52a0\u70ba\u81e8\u6642\u5377\u5728\u5df2\u5b89\u88dd\u7684\u6587\u4ef6\u7cfb\u7d71\u4e0a\u7dad\u8b77\u5b83\u5011\u3002\u9019\u7a2e\u4f7f\u7528\u81e8\u6642\u5377\u5b58\u5132\u6a5f\u5bc6\u7684\u65b9\u6cd5\u662f Kubernetes \u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u9a45\u52d5\u7a0b\u5e8f\u7684 Secrets Store \u64f4\u5c55\u7684\u4e00\u500b\u529f\u80fd\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Helm chart \u8a2d\u7f6e Vault \u53ca\u5176\u4f9d\u8cf4\u9805\u3002\u7136\u5f8c\u555f\u7528\u4e26\u914d\u7f6e secrets store CSI driver \u4ee5\u5275\u5efa\u4e00\u500b\u5305\u542b\u60a8\u5c07\u639b\u8f09\u5230\u61c9\u7528\u7a0b\u5e8f pod \u7684\u79d8\u5bc6\u7684 volume\u3002","title":"\u901a\u904e\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u639b\u8f09 Vault Secret"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#_1","text":"\u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 Minikube version. $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7 Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" }","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#kubernetes","text":"Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u7528\u65bc\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002\u9019\u4e9b\u96c6\u7fa4\u5728\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u904b\u884c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \ud83c\udf89 minikube 1 .26.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.26.0 \ud83d\udca1 To disable this notice, run: 'minikube config set WantUpdateNotification false' \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 2 , Memory = 3900MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u986f\u793a Kubernetes \u96c6\u7fa4\u7684\u7248\u672c\u3002 $ kubectl version --output = json { \"clientVersion\" : { \"major\" : \"1\" , \"minor\" : \"24\" , \"gitVersion\" : \"v1.24.1\" , \"gitCommit\" : \"3ddd0f45aa91e2f30c70734b175631bec5b5825a\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-05-24T12:26:19Z\" , \"goVersion\" : \"go1.18.2\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } , \"kustomizeVersion\" : \"v4.5.4\" , \"serverVersion\" : { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } } \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Runningk3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684\u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 kubelet: Running apiserver: Running kubeconfig: Configured k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u4e3b\u6a5f\u3001kubelet\u3001apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002","title":"\u555f\u52d5 Kubernetes"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#vault-helm-chart","text":"Vault \u7ba1\u7406\u5beb\u5165\u9019\u4e9b\u53ef\u639b\u8f09\u5377\u7684\u6a5f\u5bc6\u3002\u8981\u63d0\u4f9b\u9019\u4e9b\u6a5f\u5bc6\uff0c\u9700\u8981\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u5c0d\u65bc\u6b64\u6f14\u793a\uff0cVault \u53ef\u4ee5\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\uff0c\u4ee5\u81ea\u52d5\u8655\u7406 KV \u6a5f\u5bc6\u5f15\u64ce\u7684\u521d\u59cb\u5316\u3001\u89e3\u5c01\u548c\u8a2d\u7f6e\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository ...Successfully got an update from the \"hashicorp\" chart repository Update Complete. \u2388Happy Helming!\u2388 \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u4e26\u7981\u7528\u6ce8\u5165\u5668\u670d\u52d9\u4e26\u555f\u7528 CSI\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \\ --set \"injector.enabled=false\" \\ --set \"csi.enabled=true\" \u793a\u4f8b\u8f38\u51fa\uff1a NAME: vault LAST DEPLOYED: Sun Jul 10 22 :23:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault Vault \u670d\u52d9\u5668\u5728\u55ae\u500b pod server.dev.enabled=true \u4e0a\u4ee5\u958b\u767c\u6a21\u5f0f\u904b\u884c\u3002 Vault Agent Injector pod \u88ab\u7981\u7528 injector.enabled=false \u4e26\u4e14 Vault CSI Provider pod csi.enabled=true \u88ab\u555f\u7528\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 16m vault-csi-provider-8kxjg 1 /1 Running 0 16m \u7b49\u5230 vault-0 pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002","title":"\u5b89\u88dd Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#vault-secret","text":"\u5728 Create a pod with secretmounted \u90e8\u5206\u4e2d\u639b\u8f09\u5230 pod \u7684\u6372\u9700\u8981\u5b58\u5132\u5728\u8def\u5f91 secret/data/db-pass \u4e2d\u7684 secret\u3002\u7576 Vault \u5728\u958b\u767c\u4e2d\u904b\u884c\u6642\uff0c\u5728\u8def\u5f91 /secret \u4e2d\u555f\u7528\u4e86 KV \u79d8\u5bc6\u5f15\u64ce\u3002 \u9996\u5148\uff0c\u5728 vault-0 pod \u4e0a\u555f\u52d5\u4e00\u500b\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 / $ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u4f7f\u7528\u5bc6\u78bc\u5728\u8def\u5f91 secret/db-pass \u8655\u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put secret/db-pass password = \"db-secret-password\" === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u5728\u8def\u5f91 secret/db-pass \u4e0a\u662f\u5426\u53ef\u8b80\u3002 / $ vault kv get secret/db-pass === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password","title":"\u5728 Vault \u4e2d\u8a2d\u7f6e Secret"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#kubernetes-authentication","text":"Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication \u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u8a2a\u554f\u5bc6\u9470\u548c\u5275\u5efa\u5377\u7684 Kubernetes \u8cc7\u6e90\u901a\u904e\u6b64\u65b9\u6cd5\u901a\u904e\u89d2\u8272\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ \u4f7f\u7528 Kubernetes API \u5730\u5740\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5b83\u5c07\u81ea\u52d5\u4f7f\u7528 Vault pod \u81ea\u5df1\u7684\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config \u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684\u7b56\u7565\u3002\u9019\u5c07\u7528\u65bc\u6388\u4e88 webapp-sa \u670d\u52d9\u5e33\u6236\u8b80\u53d6\u4e4b\u524d\u5275\u5efa\u7684 kv \u5bc6\u9470\u7684\u6b0a\u9650\u3002 / $ vault policy write internal-app - <<EOF path \"secret/data/db-pass\" { capabilities = [\"read\"] } EOF kv-v2 \u7684\u6578\u64da\u8981\u6c42\u5728\u5176\u639b\u8f09\u8def\u5f91\uff08\u672c\u4f8b\u4e2d\u70ba secret/ \uff09\u4e4b\u5f8c\u5305\u542b\u984d\u5916\u7684\u6578\u64da\u8def\u5f91\u5143\u7d20\u3002 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba database \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\uff0c\u8a72\u89d2\u8272\u5c07\u6b64\u7b56\u7565\u8207\u540d\u70ba webapp-sa \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u7d81\u5b9a\u3002 / $ vault write auth/kubernetes/role/database \\ bound_service_account_names = webapp-sa \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 20m \u7d50\u679c: Success! Data written to: auth/kubernetes/role/database \u8a72\u89d2\u8272\u5c07\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u4e2d\u7684 Kubernetes \u670d\u52d9\u5e33\u6236 webapp-sa \u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 20 \u5206\u9418\u3002\u9019\u500b Kubernetes \u670d\u52d9\u5e33\u6236\u540d\u7a31 webapp-sa \u5c07\u5728\u4e0b\u9762\u5275\u5efa\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit","title":"\u914d\u7f6e Kubernetes authentication"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#secrets-store-csi-driver","text":"Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f secrets-store.csi.k8s.io \u5141\u8a31 Kubernetes \u5c07\u5b58\u5132\u5728\u4f01\u696d\u7d1a\u5916\u90e8\u6a5f\u5bc6\u5b58\u5132\u4e2d\u7684\u591a\u500b\u6a5f\u5bc6\u3001\u5bc6\u9470\u548c\u8b49\u66f8\u4f5c\u70ba\u5377\u639b\u8f09\u5230\u5176 pod \u4e2d\u3002\u9644\u52a0\u5377\u5f8c\uff0c\u5176\u4e2d\u7684\u6578\u64da\u5c07\u88ab\u639b\u8f09\u5230\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u6dfb\u52a0 Secrets Store CSI \u9a45\u52d5 Helm \u5b58\u5132\u5eab\u3002 $ helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts \"secrets-store-csi-driver\" has been added to your repositories \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Kubernetes Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u3002 $ helm install csi secrets-store-csi-driver/secrets-store-csi-driver \\ --set syncSecret.enabled = true \u7d50\u679c: NAME: csi LAST DEPLOYED: Sun Jul 10 23 :57:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: The Secrets Store CSI Driver is getting deployed to your cluster. To verify that Secrets Store CSI Driver has started, run: kubectl --namespace = default get pods -l \"app=secrets-store-csi-driver\" Now you can follow these steps https://secrets-store-csi-driver.sigs.k8s.io/getting-started/usage.html to create a SecretProviderClass resource, and a deployment using the SecretProviderClass.","title":"\u5b89\u88dd secrets store CSI driver"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#vault-csi-provider","text":"Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u652f\u6301\u901a\u904e\u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u64f4\u5c55\u3002\u63d0\u4f9b\u8005\u4f5c\u70ba Kubernetes DaemonSet \u8207 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f DaemonSet \u4e00\u8d77\u555f\u52d5\u3002 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u901a\u904e Vault Helm chart \u5b89\u88dd\u5728 Vault \u65c1\u908a\u3002 \u6b64 DaemonSet \u555f\u52d5\u5176\u81ea\u5df1\u7684\u63d0\u4f9b\u7a0b\u5e8f pod \u4e26\u904b\u884c\u4e00\u500b gRPC \u670d\u52d9\u5668\uff0cSecrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9023\u63a5\u5230\u8a72\u670d\u52d9\u5668\u4ee5\u767c\u51fa\u5377\u639b\u8f09\u8acb\u6c42\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\uff0c\u4ee5\u6aa2\u67e5 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 4m58s vault-0 1 /1 Running 0 99m vault-csi-provider-8kxjg 1 /1 Running 0 99m \u7b49\u5230 vault-csi-provider pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002","title":"\u9a57\u8b49 Vault CSI provider \u555f\u52d5\u72c0\u614b"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#secretproviderclass-resource","text":"Kubernetes Secrets Store CSI Driver Helm \u5716\u8868\u70ba SecretProviderClass \u8cc7\u6e90\u5275\u5efa\u5b9a\u7fa9\u3002\u6b64\u8cc7\u6e90\u63cf\u8ff0\u4e86\u63d0\u4f9b\u7d66 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u7684\u53c3\u6578\u3002\u8981\u914d\u7f6e\u5b83\uff0c\u9700\u8981 Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u3001Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u7684\u540d\u7a31\u548c\u6a5f\u5bc6\u3002 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u5275\u5efa vault-database \u7684 SecretProviderClass\u3002 $ kubectl apply --filename spc-vault-database.yaml secretproviderclass.secrets-store.csi.x-k8s.io/vault-database created vault-database \u7684 SecretProviderClass \u63cf\u8ff0\u4e86\u4e00\u500b Secret \u7269\u4ef6\uff1a objectName \u662f secret \u7684 symbolic name \u8207\u8981\u69cb\u5efa\u7684\u6a94\u6848\u540d\u7a31\u3002 secretPath \u662f secret \u5b9a\u7fa9\u5728 Vault \u88e1\u7684\u8def\u5f91\u3002 secretKey \u662f secret \u88e1\u7684\u9375\u540d(key name)\u3002 \u9a57\u8b49\u5df2\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5b9a\u7fa9\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ kubectl describe SecretProviderClass vault-database Name: vault-database Namespace: default Labels: <none> Annotations: kubectl.kubernetes.io/last-applied-configuration: { \"apiVersion\" : \"secrets-store.csi.x-k8s.io/v1\" , \"kind\" : \"SecretProviderClass\" , \"metadata\" : { \"annotations\" : {} , \"name\" : \"vault-database\" , \"namespace... API Version: secrets-store.csi.x-k8s.io/v1 Kind: SecretProviderClass ## ...","title":"\u5b9a\u7fa9 SecretProviderClass resource"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#secret-pod","text":"\u5c07 secret \u5b58\u5132\u5728 Vault \u4e2d\uff0c\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u4e26\u5275\u5efa\u89d2\u8272\uff0c\u5b89\u88dd provider-vault \u64f4\u5c55\u4e26\u5b9a\u7fa9 SecretProviderClass \uff0c\u6700\u5f8c\u662f\u6642\u5019\u5275\u5efa\u4e00\u500b\u639b\u8f09\u6240\u9700\u6a5f\u5bc6\u7684 pod\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba webapp-sa \u7684\u670d\u52d9\u5e33\u6236\u3002 $ kubectl create serviceaccount webapp-sa \u5b9a\u7fa9\u639b\u8f09\u79d8\u5bc6\u5377\u7684 webapp pod\u3002 $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF webapp pod \u5b9a\u7fa9\u4e86\u4e00\u500b\u552f\u8b80\u5377(volume)\u4e26\u5c07\u5176\u639b\u8f09\u5230 /mnt/secrets-store \u3002\u5728 vault-database SecretProviderClass \u4e2d\u5b9a\u7fa9\u7684\u7269\u4ef6\u5c07\u88ab\u5beb\u5165\u81f3\u8a72\u8def\u5f91\u4e2d\u7684\u6587\u4ef6\u3002 \u5275\u5efa webapp pod \u3002 $ kubectl apply --filename webapp-pod.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 6h23m vault-0 1 /1 Running 0 7h57m vault-csi-provider-8kxjg 1 /1 Running 0 7h57m webapp \u7b49\u5230 webapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 webapp pod \u4e0a\u7684 /mnt/secrets-store/db-password \u4e2d\u986f\u793a\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u7684\u5bc6\u78bc\u6a5f\u5bc6\u3002 $ kubectl exec webapp -- cat /mnt/secrets-store/db-password db-secret-password \u986f\u793a\u7684\u503c\u8207\u79d8\u5bc6 secret/db-pass \u7684\u5bc6\u78bc\u503c\u5339\u914d\u3002","title":"\u5275\u5efa\u4e00\u500b\u639b\u8f09 secret \u7684 pod"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#kubernetes-secret","text":"Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9084\u652f\u6301\u540c\u6b65\u5230 Kubernetes \u7684 Secret \u7269\u4ef6\u3002 Kubernetes Secret \u586b\u5145\u4e86 CSI \u5377\u4e2d\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u5b83\u5011\u7684\u751f\u547d\u9031\u671f\u8207\u5275\u5efa\u5b83\u5011\u7684 pod \u7684\u751f\u547d\u9031\u671f\u5bc6\u5207\u76f8\u95dc\u3002 \u8981\u70ba\u60a8\u7684 webapp pod \u6dfb\u52a0 secret \u540c\u6b65\uff0c\u8acb\u66f4\u65b0 SecretProviderClass \u4ee5\u6dfb\u52a0\u4e00\u500b secretObjects \u689d\u76ee\uff1a $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault secretObjects: - data: - key: password objectName: db-password secretName: dbpass type: Opaque parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u61c9\u7528\u66f4\u6539\uff1a $ kubectl apply --filename spc-vault-database.yaml \u7576 pod \u5f15\u7528\u6b64 SecretProviderClass \u6642\uff0cCSI \u9a45\u52d5\u7a0b\u5e8f\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dbpass \u7684 Kubernetes secret\uff0c\u5176\u4e2d password \u5b57\u6bb5\u8a2d\u7f6e\u70ba\u53c3\u6578\u4e2d db-password \u5c0d\u8c61\u7684\u5167\u5bb9\u3002 Pod \u6703\u5728\u555f\u52d5\u524d\u7b49\u5f85 Secret \u88ab\u5275\u5efa\uff0c\u7576 Pod \u505c\u6b62\u6642\uff0cSecret \u6703\u88ab\u522a\u9664 \u3002 \u63a5\u4e0b\u4f86\uff0c\u66f4\u65b0 pod \u4ee5\u5f15\u7528\u65b0\u7684 secret\uff1a $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp env: - name: DB_PASSWORD valueFrom: secretKeyRef: name: dbpass key: password volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF \u8acb\u6ce8\u610f\uff0c\u73fe\u5728\u6709\u4e00\u500b env \u689d\u76ee\uff0c\u5f15\u7528\u4e86\u4e00\u500b\u79d8\u5bc6\u3002\u522a\u9664\u4e26\u91cd\u65b0\u90e8\u7f72 pod\uff1a $ kubectl delete pod webapp && kubectl apply --filename webapp-pod.yaml \u90e8\u7f72\u66f4\u65b0\u7684\u914d\u7f6e\u4e26\u7b49\u5f85 webapp pod \u518d\u6b21\u51fa\u73fe\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-w2xxv 3 /3 Running 0 4m28s vault-0 1 /1 Running 0 5m57s vault-csi-provider-qxz8d 1 /1 Running 0 5m57s webapp 1 /1 Running 0 36s \u60a8\u73fe\u5728\u53ef\u4ee5\u9a57\u8b49 Kubernetes \u5bc6\u9470\u662f\u5426\u5df2\u5275\u5efa\uff1a $ kubectl get secret dbpass NAME TYPE DATA AGE dbpass Opaque 1 100s \u60a8\u9084\u53ef\u4ee5\u9a57\u8b49\u8a72\u79d8\u5bc6\u5728 pod \u7684\u74b0\u5883\u4e2d\u662f\u5426\u53ef\u7528\uff1a $ kubectl exec webapp -- env | grep DB_PASSWORD DB_PASSWORD = db-secret-password","title":"\u540c\u6b65\u5230 Kubernetes Secret"},{"location":"vault/kubernetes/kubernetes-sidecar/","text":"\u901a\u904e Vault Agent \u5bb9\u5668\u5c07 Secret \u6ce8\u5165 Kubernetes Pod \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-sidecar \u90e8\u7f72\u4f7f\u7528 Vault \u4f86\u4fdd\u5b58\u8207\u61c9\u7528\u5e33\u5bc6\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\uff1a \u9a57\u8b49\u4e26\u7372\u53d6\u5ba2\u6236\u7aef\u4ee4\u724c\u3002 \u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u3002 \u5f9e Vault \u4e2d\u6aa2\u7d22\u79d8\u5bc6\u3002 \u7ba1\u7406\u4efb\u4f55\u52d5\u614b\u6a5f\u5bc6\u7684\u79df\u7d04\u3002 Vault Agent \u8ca0\u8cac\u9019\u4e9b\u4efb\u52d9\u4e26\u4f7f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u611f\u53d7\u4e0d\u5230 Vault \u7684\u5b58\u5728\u3002\u9019\u6a23\u7684\u6574\u5408\u5f15\u5165\u4e86\u4e00\u9805\u65b0\u8981\u6c42\uff0c\u4e5f\u5c31\u662f\u5c07 Vault Agent \u8207\u61c9\u7528\u7a0b\u5e8f\u4e00\u8d77\u5b89\u88dd\u548c\u914d\u7f6e\u70ba sidecar \u3002 Vault Helm chart \u4f7f\u60a8\u80fd\u5920\u904b\u884c Vault \u548c Vault Agent Injector \u670d\u52d9\u3002\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u5229\u7528 Kubernetes mutating admission webhook \u4f86\u6514\u622a\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684 pod\uff0c\u4e26\u8a3b\u5165 Vault Agent \u5bb9\u5668\u4f86\u7ba1\u7406\u9019\u4e9b\u6a5f\u5bc6\u3002\u9019\u662f\u5f88\u6709\u5e6b\u52a9\uff0c\u56e0\u70ba\uff1a \u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u4e0d\u77e5\u9053 Vault\uff0c\u56e0\u70ba\u6a5f\u5bc6\u5b58\u5132\u5728\u5176\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u73fe\u6709\u90e8\u7f72\u7121\u9700\u66f4\u6539\uff1b\u56e0\u70ba\u53ef\u4ee5\u4fee\u88dc\u8a3b\u91cb\u3002 \u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u5e33\u6236\u548c\u547d\u540d\u7a7a\u9593\u5f37\u5236\u8a2a\u554f\u6a5f\u5bc6 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Vault Helm chart \u8a2d\u7f6e Vault \u548c\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u3002\u7136\u5f8c\uff0c\u60a8\u5c07\u90e8\u7f72\u5e7e\u500b\u61c9\u7528\u7a0b\u5e8f\u4f86\u6f14\u793a\u9019\u500b\u65b0\u7684\u6ce8\u5165\u5668\u670d\u52d9\u5982\u4f55\u6aa2\u7d22\u548c\u5beb\u5165\u9019\u4e9b\u79d8\u5bc6\u4ee5\u4f9b\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI \u3001 Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 \u555f\u52d5 Kubernetes \u00b6 Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u53ef\u5728\u7cfb\u7d71\u4e0a\u7684\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.19.0 on Darwin 11 .2.3 \u2728 Using the docker driver based on existing profile \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\udd04 Restarting existing docker container for \"minikube\" ... \ud83d\udc33 Preparing Kubernetes v1.20.2 on Docker 20 .10.5 ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u521d\u59cb\u5316\u904e\u7a0b\u9700\u8981\u5e7e\u5206\u9418\uff0c\u56e0\u70ba\u5b83\u6703\u6aa2\u7d22\u4efb\u4f55\u5fc5\u8981\u7684\u4f9d\u8cf4\u9805\u4e26\u57f7\u884c\u5404\u7a2e\u5bb9\u5668\u6620\u50cf\u3002 \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured \u4e3b\u6a5f\u3001kubelet \u548c apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002 Minikube \u5728\u57fa\u65bc Web \u7684\u5100\u8868\u677f\u4e2d\u63d0\u4f9b\u72c0\u614b\u7684\u53ef\u8996\u5316\u8868\u793a\u3002\u8a72\u754c\u9762\u5728\u53ef\u8996\u5316\u754c\u9762\u4e2d\u986f\u793a\u96c6\u7fa4\u6d3b\u52d5\uff0c\u6709\u52a9\u65bc\u6df1\u5165\u7814\u7a76\u5f71\u97ff\u5b83\u7684\u554f\u984c\u3002 \u5728\u53e6\u4e00\u500b\u7d42\u7aef\u4e2d\uff0c\u555f\u52d5 minikube \u5100\u8868\u677f\u3002 $ minikube dashboard \u64cd\u4f5c\u7cfb\u7d71\u7684\u9ed8\u8a8d\u700f\u89bd\u5668\u6253\u958b\u4e26\u986f\u793a\u5100\u8868\u677f\u3002 k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u5b89\u88dd Vault Helm chart \u00b6 \u5728 Kubernetes \u4e0a\u904b\u884c Vault \u7684\u63a8\u85a6\u65b9\u6cd5\u662f\u901a\u904e Helm chart \u3002 Helm \u662f\u4e00\u500b\u5305\u7ba1\u7406\u5668\uff0c\u5b83\u5b89\u88dd\u548c\u914d\u7f6e\u6240\u6709\u5fc5\u8981\u7684\u7d44\u4ef6\u4ee5\u5728\u5e7e\u7a2e\u4e0d\u540c\u7684\u6a21\u5f0f\u4e0b\u904b\u884c Vault\u3002 Helm chart \u5305\u62ec\u555f\u7528\u689d\u4ef6\u548c\u53c3\u6578\u5316\u57f7\u884c\u7684\u6a21\u677f\u3002\u9019\u4e9b\u53c3\u6578\u53ef\u4ee5\u901a\u904e\u547d\u4ee4\u884c\u53c3\u6578\u8a2d\u7f6e\u6216\u5728 YAML \u4e2d\u5b9a\u7fa9\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668\u3002 $ helm install vault hashicorp/vault --set \"server.dev.enabled=true\" Vault pod \u548c Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 80s vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 80s vault-0 pod \u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c Vault \u670d\u52d9\u5668\u3002 vault-agent-injector pod \u6839\u64da\u90e8\u7f72\u4e2d\u5b58\u5728\u6216\u4fee\u88dc\u7684\u8a3b\u91cb\u57f7\u884c\u6ce8\u5165\u3002 Info \u958b\u767c\u6a21\u5f0f\uff1a\u5728\u958b\u767c\u4e2d\u904b\u884c Vault \u670d\u52d9\u5668\u6703\u81ea\u52d5\u521d\u59cb\u5316\u548c\u89e3\u5c01\u3002\u9019\u5728\u5b78\u7fd2\u74b0\u5883\u4e2d\u662f\u7406\u60f3\u7684\uff0c\u4f46\u4e0d\u5efa\u8b70\u5728\u751f\u7522\u74b0\u5883\u4e2d\u4f7f\u7528\u3002 \u7b49\u5230 vault-0 pod \u548c vault-agent-injector pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 Vault \u4e2d\u8a2d\u5b9a Secret \u00b6 \u60a8\u5728\u5c07\u6a5f\u5bc6\u6ce8\u5165 pod \u90e8\u5206\u4e2d\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u671f\u671b Vault \u5b58\u5132\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff0c\u8a72\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5b58\u5132\u5728\u8def\u5f91 internal/database/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 /$ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u5728 internal \u8def\u5f91\u555f\u7528 kv-v2 \u6a5f\u5bc6\u5b58\u5132\u3002 / $ vault secrets enable -path = internal kv-v2 Success! Enabled the kv-v2 secrets engine at: internal/ \u4f7f\u7528\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5728\u8def\u5f91 internal/database/config \u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put internal/database/config username = \"db-readonly-username\" password = \"db-secret-password\" ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5728\u8def\u5f91 internal/database/config \u4e2d\u5b9a\u7fa9\u3002 / $ vault kv get internal/database/config ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password username db-readonly-username \u79d8\u5bc6\u5df2\u6e96\u5099\u597d\u7528\u65bc\u61c9\u7528\u7a0b\u5e8f\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit \u914d\u7f6e Kubernetes auth \u00b6 Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication method\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes **\u670d\u52d9\u5e33\u6236\u4ee4\u724c**\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u6b64\u4ee4\u724c\u5728\u5275\u5efa\u6642\u63d0\u4f9b\u7d66\u6bcf\u500b pod\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u5728 Vault \u4e2d\u555f\u52d5 Kubernetes authentication method\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u4ee4\u724c\u5be9\u67e5 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002 \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528 Kubernetes API \u7684\u4f4d\u7f6e\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" Success! Data written to: auth/kubernetes/config \u5b9a\u7fa9\u4e86\u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u4e26\u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5c0d\u65bc\u5ba2\u6236\u7aef\u8b80\u53d6\u5b9a\u7fa9\u5728 internal/database/config \u4e2d\u7684\u79d8\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 internal/data/database/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002\u9019\u662f Vault Policy \u7684\u4e00\u500b\u4f8b\u5b50\u3002Policy \u5b9a\u7fa9\u4e86\u4e00\u7d44\u80fd\u529b\u3002 \u5beb\u51fa\u540d\u70ba internal-app \u7684 Policy\uff0c\u8a72 Policy \u555f\u7528\u5c0d\u8def\u5f91 internal/data/database/config \u4e2d\u6a5f\u5bc6\u7684\u8b80\u53d6\u529f\u80fd\u3002 / $ vault policy write internal-app - <<EOF path \"internal/data/database/config\" { capabilities = [\"read\"] } EOF \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/internal-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/internal-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001internal-app \u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit \u5b9a\u7fa9\u4e00\u500b Kubernetes service account \u00b6 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5e33\u6236\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 98m vault 1 39m vault-agent-injector 1 39m \u8b93\u6211\u5011\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u9a57\u8b49\u670d\u52d9\u5e33\u6236\u662f\u5426\u5df2\u5275\u5efa\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 101m internal-app 1 69s vault 1 42m vault-agent-injector 1 42m \u6b64\u8655\u7684\u670d\u52d9\u5e33\u6236\u540d\u7a31\u8207\u5275\u5efa internal-app \u89d2\u8272\u6642\u5206\u914d\u7d66 bound_service_account_names \u5b57\u6bb5\u7684\u540d\u7a31\u4e00\u81f4\u3002 \u555f\u52d5\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f \u00b6 \u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5c07\u5176\u767c\u4f48\u5230 DockerHub\uff0c\u4e26\u5275\u5efa\u4e86\u4e00\u500b\u555f\u52d5\u8a72\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u90e8\u7f72\u3002 \u986f\u793a orgchart \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u3002 $ cat deployment-orgchart.yaml jwissig\u6e90\u78bc: https://github.com/jweissig/app/blob/master/main.go deployment-orgchart.yaml apiVersion : apps/v1 kind : Deployment metadata : name : orgchart labels : app : orgchart spec : selector : matchLabels : app : orgchart replicas : 1 template : metadata : annotations : labels : app : orgchart spec : serviceAccountName : internal-app containers : - name : orgchart image : jweissig/app:0.0.1 \u6b64\u90e8\u7f72\u7684\u540d\u7a31\u662f orgchart\u3002 spec.template.spec.serviceAccountName \u5b9a\u7fa9\u4e86\u670d\u52d9\u5e33\u6236 internal-app \u4f86\u904b\u884c\u9019\u500b\u5bb9\u5668\u3002 \u61c9\u7528\u5728 deployment-orgchart.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 $ kubectl apply --filename deployment-orgchart.yaml deployment.apps/orgchart created \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-97b5b656d-4658m 1 /1 Running 0 57s vault-0 1 /1 Running 0 53m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 53m orgchart pod \u5728\u6b64\u8655\u986f\u793a\u70ba\u4ee5 orgchart \u70ba\u524d\u7db4\u7684 pod\u3002 Vault-Agent \u6ce8\u5165\u5668\u67e5\u627e\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684\u90e8\u7f72\u3002\u7576\u524d\u90e8\u7f72\u4e2d\u4e0d\u5b58\u5728\u9019\u4e9b\u8a3b\u91cb\u3002\u9019\u610f\u5473\u8457 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u4e0a\u4e0d\u5b58\u5728\u4efb\u4f55\u9700\u8981\u5f9e Vault \u4e2d\u53d6\u5f97\u7684\u6a5f\u5bc6\u3002 \u9a57\u8b49 Vault-Agent \u6c92\u6709\u5c07\u6a5f\u5bc6\u5beb\u5165 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u3002 $ kubectl exec \\ $(kubectl get pod -l app=orgchart -o jsonpath=\"{.items[0].metadata.name}\") \\ --container orgchart -- ls /vault/secrets \u8f38\u51fa\u986f\u793a\u6c92\u627e\u5230\u540d\u70ba /vault/secrets \u7684\u6b64\u985e\u6587\u4ef6\u6216\u76ee\u9304\uff1a ls: /vault/secrets: No such file or directory command terminated with exit code 1 \u5728 pod \u88e1\u982d\u6ce8\u5165 secret \u00b6 \u90e8\u7f72\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 internal-app Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c pod\u3002 Vault Agent Injector \u53ea\u6709\u5728\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u6703\u4fee\u6539\u5b83\u3002\u73fe\u6709\u90e8\u7f72\u53ef\u80fd\u6703\u5c0d\u5176\u5b9a\u7fa9\u9032\u884c\u4fee\u88dc\u4ee5\u5305\u542b\u5fc5\u8981\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-inject-secrets.yaml \u3002 patch-inject-secrets.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector service role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272 agent-inject-secret-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c database-config.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 \u4fee\u88dc\u5728 patch-inject-secrets.yaml \u4e2d\u5b9a\u7fa9\u7684 orgchart \u90e8\u7f72\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets.yaml ) \" deployment.apps/orgchart patched \u4e00\u500b\u65b0\u7684 orgchart pod \u5728\u73fe\u6709 pod \u65c1\u908a\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-6f88c9f9f4-c2pdb 2 /2 Running 0 42s vault-0 1 /1 Running 0 66m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 66m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u9019\u500b\u65b0\u7684 pod \u73fe\u5728\u555f\u52d5\u4e86\u5169\u500b\u5bb9\u5668\u3002\u540d\u70ba orgchart \u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u548c\u540d\u70ba vault-agent \u7684 Vault Agent \u5bb9\u5668\u3002 \u5728\u65b0\u7684 orgchart pod \u4e2d\u986f\u793a Vault-agent \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: creating file sink 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T00:31:28.781Z [ INFO ] template.server: starting template server 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: authenticating 2022 -07-10T00:31:28.781Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.781Z [ INFO ] sink.server: starting sink server 2022 -07-10T00:31:28.784Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: authentication successful, sending token to sinks 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: starting renewal process 2022 -07-10T00:31:28.801Z [ INFO ] sink.file: token written: path = /home/vault/.vault-token 2022 -07-10T00:31:28.801Z [ INFO ] template.server: template server received new token 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) stopping 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) starting 2022 -07-10T00:31:28.803Z [ INFO ] auth.handler: renewed auth token Vault Agent \u7ba1\u7406\u4ee4\u724c\u751f\u547d\u9031\u671f\u548c\u79d8\u5bc6\u6aa2\u7d22\u3002\u6a5f\u5bc6\u5728\u8def\u5f91 /vault/secrets/database-config.txt \u7684 orgchart \u5bb9\u5668\u4e2d\u5448\u73fe\u3002 \u6700\u5f8c\uff0c\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container orgchart -- cat /vault/secrets/database-config.txt \u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u5b58\u5728\u65bc\u5bb9\u5668\u4e2d\uff1a data: map[password:db-secret-password username:db-readonly-user] metadata: map[created_time:2019-12-20T18:17:50.930264759Z deletion_time: destroyed:false version:2] \u5c07\u6a21\u677f\u61c9\u7528\u65bc\u6ce8\u5165\u7684\u6a5f\u5bc6 \u00b6 \u6ce8\u5165\u7684\u79d8\u5bc6\u7684\u7d50\u69cb\u53ef\u80fd\u9700\u8981\u4ee5\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u7684\u65b9\u5f0f\u9032\u884c\u7d50\u69cb\u5316\u3002\u5728\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u4e4b\u524d\uff0c\u6a21\u677f\u53ef\u4ee5\u69cb\u9020\u6578\u64da\u3002\u8981\u61c9\u7528\u6b64\u6a21\u677f\uff0c\u9700\u8981\u61c9\u7528\u4e00\u7d44\u65b0\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u5305\u542b\u6a21\u677f\u5b9a\u7fa9\u7684\u8a3b\u91cb\u6587\u4ef6\u3002 patch-inject-secrets-as-template.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u6b64\u88dc\u4e01\u5305\u542b\u5169\u500b\u65b0\u8a3b\u91cb\uff1a agent-inject-status \u8a2d\u7f6e\u70ba\u66f4\u65b0\u901a\u77e5\u6ce8\u5165\u5668\u91cd\u65b0\u8a3b\u5165\u9019\u4e9b\u503c\u3002 agent-inject-template-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\u3002\u8a72\u503c\u5b9a\u7fa9\u8981\u61c9\u7528\u65bc\u6a5f\u5bc6\u6578\u64da\u7684 Vault Agent \u6a21\u677f\u3002 \u8a72\u6a21\u677f\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u683c\u5f0f\u5316\u70ba PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u3002 \u61c9\u7528\u66f4\u65b0\u7684\u8a3b\u91cb\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets-as-template.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 16s vault-0 1 /1 Running 0 126m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 126m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 orgchart pod \u4e2d\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ -c orgchart -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard \u5e36\u6709\u8a3b\u91cb\u7684 Pod \u00b6 \u8a3b\u91cb\u53ef\u4ee5\u5c07\u9019\u4e9b\u79d8\u5bc6\u4fee\u88dc\u5230\u4efb\u4f55\u90e8\u7f72\u4e2d\u3002 Pod \u8981\u6c42\u5c07\u8a3b\u91cb\u5305\u542b\u5728\u5176\u521d\u59cb\u5b9a\u7fa9\u4e2d\u3002 \u986f\u793a payroll \u61c9\u7528\u7a0b\u5e8f\u7684 pod \u5b9a\u7fa9\u3002 pod-payroll.yaml apiVersion : v1 kind : Pod metadata : name : payroll labels : app : payroll annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} spec : serviceAccountName : internal-app containers : - name : payroll image : jweissig/app:0.0.1 \u61c9\u7528 pod-payroll.yaml \u4e2d\u5b9a\u7fa9\u7684 pod\u3002 $ kubectl apply --filename pod-payroll.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 4h18m payroll 2 /2 Running 0 3m vault-0 1 /1 Running 0 5h34m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 5h34m \u7b49\u5230 payroll pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 payroll pod \u4e2d\u986f\u793a\u5beb\u5165 payroll \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ payroll \\ --container payroll -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard Secret \u7d81\u5b9a\u5230 Service account \u00b6 \u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u986f\u793a website \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 deployment-website.yaml apiVersion : apps/v1 kind : Deployment metadata : name : website labels : app : website spec : selector : matchLabels : app : website replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : website spec : # This service account does not have permission to request the secrets. serviceAccountName : website containers : - name : website image : jweissig/app:0.0.1 --- apiVersion : v1 kind : ServiceAccount metadata : name : website \u61c9\u7528 deployment-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename deployment-website.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 29m payroll 2 /2 Running 0 12s vault-0 1 /1 Running 0 155m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 155m website-7fc8b69645-527rf 0 /2 Init:0/1 0 76s web-site \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728Kubernetes\u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init \u521d\u59cb\u5316\u904e\u7a0b\u5931\u6557\uff0c\u56e0\u70ba\u670d\u52d9\u5e33\u6236\u540d\u7a31\u672a\u7d93\u6388\u6b0a\uff1a ... [INFO] auth.handler: authenticating [ERROR] auth.handler: error authenticating: error=\"Error making API request. URL: PUT http://vault.default.svc:8200/v1/auth/kubernetes/login Code: 500. Errors: * service account name not authorized\" backoff=1.562132589 \u670d\u52d9\u5e33\u6236 website \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-website.yaml \u3002 patch-website.yaml spec : template : spec : serviceAccountName : internal-app \u8a72\u88dc\u4e01\u4fee\u6539\u4e86\u90e8\u7f72\u5b9a\u7fa9\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236 internal-app \u3002\u6b64 Kubernetes \u670d\u52d9\u5e33\u6236\u7531 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u6388\u6b0a\u3002 \u4fee\u88dc patch-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u7db2\u7ad9\u90e8\u7f72\u3002 $ kubectl patch deployment website --patch \" $( cat patch-website.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 8h payroll 2 /2 Running 0 4h9m vault-0 1 /1 Running 0 9h vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 9h website-54cf7dcdfd-fv9vh 2 /2 Running 0 23s website-5899c7c66b-drhv7 0 /2 Terminating 0 34m \u7b49\u5230\u7db2\u7ad9 pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 website pod \u4e2d\u986f\u793a\u5beb\u5165\u7db2\u7ad9\u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container website -- cat /vault/secrets/database-config.txt Secret \u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard Info Vault Kubernetes \u89d2\u8272\uff1a\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684 Vault Kubernetes \u89d2\u8272\uff0c\u8a72\u89d2\u8272\u555f\u7528\u539f\u59cb\u670d\u52d9\u5e33\u6236\u8a2a\u554f\uff0c\u4e26\u4fee\u88dc\u90e8\u7f72\u3002 Secret \u7d81\u5b9a\u5230 Namespace \u00b6 \u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u5275\u5efa offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl create namespace offsite namespace/offsite created \u5c07\u7576\u524d\u4e0a\u4e0b\u6587\u8a2d\u7f6e\u70ba offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl config set-context --current --namespace offsite Context \"minikube\" modified. \u5728 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u986f\u793a issue \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72 manifest\u3002 deployment-issues.yaml apiVersion : apps/v1 kind : Deployment metadata : name : issues labels : app : issues spec : selector : matchLabels : app : issues replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : issues spec : serviceAccountName : internal-app containers : - name : issues image : jweissig/app:0.0.1 \u61c9\u7528 deployment-issues.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u3002 $ kubectl apply --filename deployment-issues.yaml deployment.apps/issues created \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-cd8958bc6-7hrc5 0 /2 Init:0/1 0 111s deployment-issues.yaml \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728 Kubernetes \u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: creating file sink 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T11:51:47.277Z [ INFO ] template.server: starting template server 2022 -07-10T11:51:47.277Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T11:51:47.277Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T11:51:47.278Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:51:47.277Z [ INFO ] sink.server: starting sink server 2022 -07-10T11:51:47.278Z [ INFO ] ( runner ) creating watcher 2022 -07-10T11:52:47.279Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1s 2022 -07-10T11:52:48.280Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:53:48.281Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1 .93s 2022 -07-10T11:53:50.218Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:54:50.219Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 3 .36s 2022 -07-10T11:54:53.586Z [ INFO ] auth.handler: authenticating \u547d\u540d\u7a7a\u9593 offsite \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec --namespace default -it vault-0 -- /bin/sh / $ \u5275\u5efa\u4e00\u500b\u540d\u70ba offsite-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/offsite-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = offsite \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/offsite-app \u9000\u51fa vault-0 pod\u3002 $ exit \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-issues.yaml \u3002 patch-issues.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'offsite-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u8a72\u88dc\u4e01\u57f7\u884c\u66f4\u65b0\u4ee5\u5c07 vault.hashicorp.com/role \u8a2d\u7f6e\u70ba Vault Kubernetes \u89d2\u8272 offsite-app \u3002 \u4fee\u88dc patch-issues.yaml \u4e2d\u5b9a\u7fa9\u7684 issues \u90e8\u7f72\u3002 $ kubectl patch deployment issues --patch \" $( cat patch-issues.yaml ) \" deployment.apps/issues patched \u65b0\u554f\u984c pod \u8207\u73fe\u6709 pod \u4e00\u8d77\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-d8596bb9-jkzzr 2 /2 Running 0 66s \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684\u554f\u984c pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728\u554f\u984c pod \u4e2d\u986f\u793a\u5beb\u5165\u554f\u984c\u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container issues -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard","title":"\u901a\u904e Vault Agent \u5bb9\u5668\u5c07 Secret \u6ce8\u5165 Kubernetes Pod"},{"location":"vault/kubernetes/kubernetes-sidecar/#vault-agent-secret-kubernetes-pod","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-sidecar \u90e8\u7f72\u4f7f\u7528 Vault \u4f86\u4fdd\u5b58\u8207\u61c9\u7528\u5e33\u5bc6\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\uff1a \u9a57\u8b49\u4e26\u7372\u53d6\u5ba2\u6236\u7aef\u4ee4\u724c\u3002 \u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u3002 \u5f9e Vault \u4e2d\u6aa2\u7d22\u79d8\u5bc6\u3002 \u7ba1\u7406\u4efb\u4f55\u52d5\u614b\u6a5f\u5bc6\u7684\u79df\u7d04\u3002 Vault Agent \u8ca0\u8cac\u9019\u4e9b\u4efb\u52d9\u4e26\u4f7f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u611f\u53d7\u4e0d\u5230 Vault \u7684\u5b58\u5728\u3002\u9019\u6a23\u7684\u6574\u5408\u5f15\u5165\u4e86\u4e00\u9805\u65b0\u8981\u6c42\uff0c\u4e5f\u5c31\u662f\u5c07 Vault Agent \u8207\u61c9\u7528\u7a0b\u5e8f\u4e00\u8d77\u5b89\u88dd\u548c\u914d\u7f6e\u70ba sidecar \u3002 Vault Helm chart \u4f7f\u60a8\u80fd\u5920\u904b\u884c Vault \u548c Vault Agent Injector \u670d\u52d9\u3002\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u5229\u7528 Kubernetes mutating admission webhook \u4f86\u6514\u622a\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684 pod\uff0c\u4e26\u8a3b\u5165 Vault Agent \u5bb9\u5668\u4f86\u7ba1\u7406\u9019\u4e9b\u6a5f\u5bc6\u3002\u9019\u662f\u5f88\u6709\u5e6b\u52a9\uff0c\u56e0\u70ba\uff1a \u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u4e0d\u77e5\u9053 Vault\uff0c\u56e0\u70ba\u6a5f\u5bc6\u5b58\u5132\u5728\u5176\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u73fe\u6709\u90e8\u7f72\u7121\u9700\u66f4\u6539\uff1b\u56e0\u70ba\u53ef\u4ee5\u4fee\u88dc\u8a3b\u91cb\u3002 \u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u5e33\u6236\u548c\u547d\u540d\u7a7a\u9593\u5f37\u5236\u8a2a\u554f\u6a5f\u5bc6 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Vault Helm chart \u8a2d\u7f6e Vault \u548c\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u3002\u7136\u5f8c\uff0c\u60a8\u5c07\u90e8\u7f72\u5e7e\u500b\u61c9\u7528\u7a0b\u5e8f\u4f86\u6f14\u793a\u9019\u500b\u65b0\u7684\u6ce8\u5165\u5668\u670d\u52d9\u5982\u4f55\u6aa2\u7d22\u548c\u5beb\u5165\u9019\u4e9b\u79d8\u5bc6\u4ee5\u4f9b\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u3002","title":"\u901a\u904e Vault Agent \u5bb9\u5668\u5c07 Secret \u6ce8\u5165 Kubernetes Pod"},{"location":"vault/kubernetes/kubernetes-sidecar/#_1","text":"\u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI \u3001 Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"vault/kubernetes/kubernetes-sidecar/#kubernetes","text":"Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u53ef\u5728\u7cfb\u7d71\u4e0a\u7684\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.19.0 on Darwin 11 .2.3 \u2728 Using the docker driver based on existing profile \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\udd04 Restarting existing docker container for \"minikube\" ... \ud83d\udc33 Preparing Kubernetes v1.20.2 on Docker 20 .10.5 ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u521d\u59cb\u5316\u904e\u7a0b\u9700\u8981\u5e7e\u5206\u9418\uff0c\u56e0\u70ba\u5b83\u6703\u6aa2\u7d22\u4efb\u4f55\u5fc5\u8981\u7684\u4f9d\u8cf4\u9805\u4e26\u57f7\u884c\u5404\u7a2e\u5bb9\u5668\u6620\u50cf\u3002 \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured \u4e3b\u6a5f\u3001kubelet \u548c apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002 Minikube \u5728\u57fa\u65bc Web \u7684\u5100\u8868\u677f\u4e2d\u63d0\u4f9b\u72c0\u614b\u7684\u53ef\u8996\u5316\u8868\u793a\u3002\u8a72\u754c\u9762\u5728\u53ef\u8996\u5316\u754c\u9762\u4e2d\u986f\u793a\u96c6\u7fa4\u6d3b\u52d5\uff0c\u6709\u52a9\u65bc\u6df1\u5165\u7814\u7a76\u5f71\u97ff\u5b83\u7684\u554f\u984c\u3002 \u5728\u53e6\u4e00\u500b\u7d42\u7aef\u4e2d\uff0c\u555f\u52d5 minikube \u5100\u8868\u677f\u3002 $ minikube dashboard \u64cd\u4f5c\u7cfb\u7d71\u7684\u9ed8\u8a8d\u700f\u89bd\u5668\u6253\u958b\u4e26\u986f\u793a\u5100\u8868\u677f\u3002 k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info","title":"\u555f\u52d5 Kubernetes"},{"location":"vault/kubernetes/kubernetes-sidecar/#vault-helm-chart","text":"\u5728 Kubernetes \u4e0a\u904b\u884c Vault \u7684\u63a8\u85a6\u65b9\u6cd5\u662f\u901a\u904e Helm chart \u3002 Helm \u662f\u4e00\u500b\u5305\u7ba1\u7406\u5668\uff0c\u5b83\u5b89\u88dd\u548c\u914d\u7f6e\u6240\u6709\u5fc5\u8981\u7684\u7d44\u4ef6\u4ee5\u5728\u5e7e\u7a2e\u4e0d\u540c\u7684\u6a21\u5f0f\u4e0b\u904b\u884c Vault\u3002 Helm chart \u5305\u62ec\u555f\u7528\u689d\u4ef6\u548c\u53c3\u6578\u5316\u57f7\u884c\u7684\u6a21\u677f\u3002\u9019\u4e9b\u53c3\u6578\u53ef\u4ee5\u901a\u904e\u547d\u4ee4\u884c\u53c3\u6578\u8a2d\u7f6e\u6216\u5728 YAML \u4e2d\u5b9a\u7fa9\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668\u3002 $ helm install vault hashicorp/vault --set \"server.dev.enabled=true\" Vault pod \u548c Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 80s vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 80s vault-0 pod \u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c Vault \u670d\u52d9\u5668\u3002 vault-agent-injector pod \u6839\u64da\u90e8\u7f72\u4e2d\u5b58\u5728\u6216\u4fee\u88dc\u7684\u8a3b\u91cb\u57f7\u884c\u6ce8\u5165\u3002 Info \u958b\u767c\u6a21\u5f0f\uff1a\u5728\u958b\u767c\u4e2d\u904b\u884c Vault \u670d\u52d9\u5668\u6703\u81ea\u52d5\u521d\u59cb\u5316\u548c\u89e3\u5c01\u3002\u9019\u5728\u5b78\u7fd2\u74b0\u5883\u4e2d\u662f\u7406\u60f3\u7684\uff0c\u4f46\u4e0d\u5efa\u8b70\u5728\u751f\u7522\u74b0\u5883\u4e2d\u4f7f\u7528\u3002 \u7b49\u5230 vault-0 pod \u548c vault-agent-injector pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002","title":"\u5b89\u88dd Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-sidecar/#vault-secret","text":"\u60a8\u5728\u5c07\u6a5f\u5bc6\u6ce8\u5165 pod \u90e8\u5206\u4e2d\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u671f\u671b Vault \u5b58\u5132\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff0c\u8a72\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5b58\u5132\u5728\u8def\u5f91 internal/database/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 /$ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u5728 internal \u8def\u5f91\u555f\u7528 kv-v2 \u6a5f\u5bc6\u5b58\u5132\u3002 / $ vault secrets enable -path = internal kv-v2 Success! Enabled the kv-v2 secrets engine at: internal/ \u4f7f\u7528\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5728\u8def\u5f91 internal/database/config \u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put internal/database/config username = \"db-readonly-username\" password = \"db-secret-password\" ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5728\u8def\u5f91 internal/database/config \u4e2d\u5b9a\u7fa9\u3002 / $ vault kv get internal/database/config ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password username db-readonly-username \u79d8\u5bc6\u5df2\u6e96\u5099\u597d\u7528\u65bc\u61c9\u7528\u7a0b\u5e8f\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit","title":"\u5728 Vault \u4e2d\u8a2d\u5b9a Secret"},{"location":"vault/kubernetes/kubernetes-sidecar/#kubernetes-auth","text":"Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication method\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes **\u670d\u52d9\u5e33\u6236\u4ee4\u724c**\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u6b64\u4ee4\u724c\u5728\u5275\u5efa\u6642\u63d0\u4f9b\u7d66\u6bcf\u500b pod\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u5728 Vault \u4e2d\u555f\u52d5 Kubernetes authentication method\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u4ee4\u724c\u5be9\u67e5 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002 \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528 Kubernetes API \u7684\u4f4d\u7f6e\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" Success! Data written to: auth/kubernetes/config \u5b9a\u7fa9\u4e86\u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u4e26\u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5c0d\u65bc\u5ba2\u6236\u7aef\u8b80\u53d6\u5b9a\u7fa9\u5728 internal/database/config \u4e2d\u7684\u79d8\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 internal/data/database/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002\u9019\u662f Vault Policy \u7684\u4e00\u500b\u4f8b\u5b50\u3002Policy \u5b9a\u7fa9\u4e86\u4e00\u7d44\u80fd\u529b\u3002 \u5beb\u51fa\u540d\u70ba internal-app \u7684 Policy\uff0c\u8a72 Policy \u555f\u7528\u5c0d\u8def\u5f91 internal/data/database/config \u4e2d\u6a5f\u5bc6\u7684\u8b80\u53d6\u529f\u80fd\u3002 / $ vault policy write internal-app - <<EOF path \"internal/data/database/config\" { capabilities = [\"read\"] } EOF \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/internal-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/internal-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001internal-app \u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit","title":"\u914d\u7f6e Kubernetes auth"},{"location":"vault/kubernetes/kubernetes-sidecar/#kubernetes-service-account","text":"Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5e33\u6236\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 98m vault 1 39m vault-agent-injector 1 39m \u8b93\u6211\u5011\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u9a57\u8b49\u670d\u52d9\u5e33\u6236\u662f\u5426\u5df2\u5275\u5efa\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 101m internal-app 1 69s vault 1 42m vault-agent-injector 1 42m \u6b64\u8655\u7684\u670d\u52d9\u5e33\u6236\u540d\u7a31\u8207\u5275\u5efa internal-app \u89d2\u8272\u6642\u5206\u914d\u7d66 bound_service_account_names \u5b57\u6bb5\u7684\u540d\u7a31\u4e00\u81f4\u3002","title":"\u5b9a\u7fa9\u4e00\u500b Kubernetes service account"},{"location":"vault/kubernetes/kubernetes-sidecar/#_2","text":"\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5c07\u5176\u767c\u4f48\u5230 DockerHub\uff0c\u4e26\u5275\u5efa\u4e86\u4e00\u500b\u555f\u52d5\u8a72\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u90e8\u7f72\u3002 \u986f\u793a orgchart \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u3002 $ cat deployment-orgchart.yaml jwissig\u6e90\u78bc: https://github.com/jweissig/app/blob/master/main.go deployment-orgchart.yaml apiVersion : apps/v1 kind : Deployment metadata : name : orgchart labels : app : orgchart spec : selector : matchLabels : app : orgchart replicas : 1 template : metadata : annotations : labels : app : orgchart spec : serviceAccountName : internal-app containers : - name : orgchart image : jweissig/app:0.0.1 \u6b64\u90e8\u7f72\u7684\u540d\u7a31\u662f orgchart\u3002 spec.template.spec.serviceAccountName \u5b9a\u7fa9\u4e86\u670d\u52d9\u5e33\u6236 internal-app \u4f86\u904b\u884c\u9019\u500b\u5bb9\u5668\u3002 \u61c9\u7528\u5728 deployment-orgchart.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 $ kubectl apply --filename deployment-orgchart.yaml deployment.apps/orgchart created \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-97b5b656d-4658m 1 /1 Running 0 57s vault-0 1 /1 Running 0 53m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 53m orgchart pod \u5728\u6b64\u8655\u986f\u793a\u70ba\u4ee5 orgchart \u70ba\u524d\u7db4\u7684 pod\u3002 Vault-Agent \u6ce8\u5165\u5668\u67e5\u627e\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684\u90e8\u7f72\u3002\u7576\u524d\u90e8\u7f72\u4e2d\u4e0d\u5b58\u5728\u9019\u4e9b\u8a3b\u91cb\u3002\u9019\u610f\u5473\u8457 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u4e0a\u4e0d\u5b58\u5728\u4efb\u4f55\u9700\u8981\u5f9e Vault \u4e2d\u53d6\u5f97\u7684\u6a5f\u5bc6\u3002 \u9a57\u8b49 Vault-Agent \u6c92\u6709\u5c07\u6a5f\u5bc6\u5beb\u5165 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u3002 $ kubectl exec \\ $(kubectl get pod -l app=orgchart -o jsonpath=\"{.items[0].metadata.name}\") \\ --container orgchart -- ls /vault/secrets \u8f38\u51fa\u986f\u793a\u6c92\u627e\u5230\u540d\u70ba /vault/secrets \u7684\u6b64\u985e\u6587\u4ef6\u6216\u76ee\u9304\uff1a ls: /vault/secrets: No such file or directory command terminated with exit code 1","title":"\u555f\u52d5\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f"},{"location":"vault/kubernetes/kubernetes-sidecar/#pod-secret","text":"\u90e8\u7f72\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 internal-app Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c pod\u3002 Vault Agent Injector \u53ea\u6709\u5728\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u6703\u4fee\u6539\u5b83\u3002\u73fe\u6709\u90e8\u7f72\u53ef\u80fd\u6703\u5c0d\u5176\u5b9a\u7fa9\u9032\u884c\u4fee\u88dc\u4ee5\u5305\u542b\u5fc5\u8981\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-inject-secrets.yaml \u3002 patch-inject-secrets.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector service role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272 agent-inject-secret-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c database-config.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 \u4fee\u88dc\u5728 patch-inject-secrets.yaml \u4e2d\u5b9a\u7fa9\u7684 orgchart \u90e8\u7f72\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets.yaml ) \" deployment.apps/orgchart patched \u4e00\u500b\u65b0\u7684 orgchart pod \u5728\u73fe\u6709 pod \u65c1\u908a\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-6f88c9f9f4-c2pdb 2 /2 Running 0 42s vault-0 1 /1 Running 0 66m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 66m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u9019\u500b\u65b0\u7684 pod \u73fe\u5728\u555f\u52d5\u4e86\u5169\u500b\u5bb9\u5668\u3002\u540d\u70ba orgchart \u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u548c\u540d\u70ba vault-agent \u7684 Vault Agent \u5bb9\u5668\u3002 \u5728\u65b0\u7684 orgchart pod \u4e2d\u986f\u793a Vault-agent \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: creating file sink 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T00:31:28.781Z [ INFO ] template.server: starting template server 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: authenticating 2022 -07-10T00:31:28.781Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.781Z [ INFO ] sink.server: starting sink server 2022 -07-10T00:31:28.784Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: authentication successful, sending token to sinks 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: starting renewal process 2022 -07-10T00:31:28.801Z [ INFO ] sink.file: token written: path = /home/vault/.vault-token 2022 -07-10T00:31:28.801Z [ INFO ] template.server: template server received new token 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) stopping 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) starting 2022 -07-10T00:31:28.803Z [ INFO ] auth.handler: renewed auth token Vault Agent \u7ba1\u7406\u4ee4\u724c\u751f\u547d\u9031\u671f\u548c\u79d8\u5bc6\u6aa2\u7d22\u3002\u6a5f\u5bc6\u5728\u8def\u5f91 /vault/secrets/database-config.txt \u7684 orgchart \u5bb9\u5668\u4e2d\u5448\u73fe\u3002 \u6700\u5f8c\uff0c\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container orgchart -- cat /vault/secrets/database-config.txt \u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u5b58\u5728\u65bc\u5bb9\u5668\u4e2d\uff1a data: map[password:db-secret-password username:db-readonly-user] metadata: map[created_time:2019-12-20T18:17:50.930264759Z deletion_time: destroyed:false version:2]","title":"\u5728 pod \u88e1\u982d\u6ce8\u5165 secret"},{"location":"vault/kubernetes/kubernetes-sidecar/#_3","text":"\u6ce8\u5165\u7684\u79d8\u5bc6\u7684\u7d50\u69cb\u53ef\u80fd\u9700\u8981\u4ee5\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u7684\u65b9\u5f0f\u9032\u884c\u7d50\u69cb\u5316\u3002\u5728\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u4e4b\u524d\uff0c\u6a21\u677f\u53ef\u4ee5\u69cb\u9020\u6578\u64da\u3002\u8981\u61c9\u7528\u6b64\u6a21\u677f\uff0c\u9700\u8981\u61c9\u7528\u4e00\u7d44\u65b0\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u5305\u542b\u6a21\u677f\u5b9a\u7fa9\u7684\u8a3b\u91cb\u6587\u4ef6\u3002 patch-inject-secrets-as-template.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u6b64\u88dc\u4e01\u5305\u542b\u5169\u500b\u65b0\u8a3b\u91cb\uff1a agent-inject-status \u8a2d\u7f6e\u70ba\u66f4\u65b0\u901a\u77e5\u6ce8\u5165\u5668\u91cd\u65b0\u8a3b\u5165\u9019\u4e9b\u503c\u3002 agent-inject-template-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\u3002\u8a72\u503c\u5b9a\u7fa9\u8981\u61c9\u7528\u65bc\u6a5f\u5bc6\u6578\u64da\u7684 Vault Agent \u6a21\u677f\u3002 \u8a72\u6a21\u677f\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u683c\u5f0f\u5316\u70ba PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u3002 \u61c9\u7528\u66f4\u65b0\u7684\u8a3b\u91cb\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets-as-template.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 16s vault-0 1 /1 Running 0 126m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 126m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 orgchart pod \u4e2d\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ -c orgchart -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard","title":"\u5c07\u6a21\u677f\u61c9\u7528\u65bc\u6ce8\u5165\u7684\u6a5f\u5bc6"},{"location":"vault/kubernetes/kubernetes-sidecar/#pod","text":"\u8a3b\u91cb\u53ef\u4ee5\u5c07\u9019\u4e9b\u79d8\u5bc6\u4fee\u88dc\u5230\u4efb\u4f55\u90e8\u7f72\u4e2d\u3002 Pod \u8981\u6c42\u5c07\u8a3b\u91cb\u5305\u542b\u5728\u5176\u521d\u59cb\u5b9a\u7fa9\u4e2d\u3002 \u986f\u793a payroll \u61c9\u7528\u7a0b\u5e8f\u7684 pod \u5b9a\u7fa9\u3002 pod-payroll.yaml apiVersion : v1 kind : Pod metadata : name : payroll labels : app : payroll annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} spec : serviceAccountName : internal-app containers : - name : payroll image : jweissig/app:0.0.1 \u61c9\u7528 pod-payroll.yaml \u4e2d\u5b9a\u7fa9\u7684 pod\u3002 $ kubectl apply --filename pod-payroll.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 4h18m payroll 2 /2 Running 0 3m vault-0 1 /1 Running 0 5h34m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 5h34m \u7b49\u5230 payroll pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 payroll pod \u4e2d\u986f\u793a\u5beb\u5165 payroll \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ payroll \\ --container payroll -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard","title":"\u5e36\u6709\u8a3b\u91cb\u7684 Pod"},{"location":"vault/kubernetes/kubernetes-sidecar/#secret-service-account","text":"\u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u986f\u793a website \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 deployment-website.yaml apiVersion : apps/v1 kind : Deployment metadata : name : website labels : app : website spec : selector : matchLabels : app : website replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : website spec : # This service account does not have permission to request the secrets. serviceAccountName : website containers : - name : website image : jweissig/app:0.0.1 --- apiVersion : v1 kind : ServiceAccount metadata : name : website \u61c9\u7528 deployment-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename deployment-website.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 29m payroll 2 /2 Running 0 12s vault-0 1 /1 Running 0 155m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 155m website-7fc8b69645-527rf 0 /2 Init:0/1 0 76s web-site \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728Kubernetes\u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init \u521d\u59cb\u5316\u904e\u7a0b\u5931\u6557\uff0c\u56e0\u70ba\u670d\u52d9\u5e33\u6236\u540d\u7a31\u672a\u7d93\u6388\u6b0a\uff1a ... [INFO] auth.handler: authenticating [ERROR] auth.handler: error authenticating: error=\"Error making API request. URL: PUT http://vault.default.svc:8200/v1/auth/kubernetes/login Code: 500. Errors: * service account name not authorized\" backoff=1.562132589 \u670d\u52d9\u5e33\u6236 website \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-website.yaml \u3002 patch-website.yaml spec : template : spec : serviceAccountName : internal-app \u8a72\u88dc\u4e01\u4fee\u6539\u4e86\u90e8\u7f72\u5b9a\u7fa9\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236 internal-app \u3002\u6b64 Kubernetes \u670d\u52d9\u5e33\u6236\u7531 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u6388\u6b0a\u3002 \u4fee\u88dc patch-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u7db2\u7ad9\u90e8\u7f72\u3002 $ kubectl patch deployment website --patch \" $( cat patch-website.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 8h payroll 2 /2 Running 0 4h9m vault-0 1 /1 Running 0 9h vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 9h website-54cf7dcdfd-fv9vh 2 /2 Running 0 23s website-5899c7c66b-drhv7 0 /2 Terminating 0 34m \u7b49\u5230\u7db2\u7ad9 pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 website pod \u4e2d\u986f\u793a\u5beb\u5165\u7db2\u7ad9\u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container website -- cat /vault/secrets/database-config.txt Secret \u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard Info Vault Kubernetes \u89d2\u8272\uff1a\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684 Vault Kubernetes \u89d2\u8272\uff0c\u8a72\u89d2\u8272\u555f\u7528\u539f\u59cb\u670d\u52d9\u5e33\u6236\u8a2a\u554f\uff0c\u4e26\u4fee\u88dc\u90e8\u7f72\u3002","title":"Secret \u7d81\u5b9a\u5230 Service account"},{"location":"vault/kubernetes/kubernetes-sidecar/#secret-namespace","text":"\u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u5275\u5efa offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl create namespace offsite namespace/offsite created \u5c07\u7576\u524d\u4e0a\u4e0b\u6587\u8a2d\u7f6e\u70ba offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl config set-context --current --namespace offsite Context \"minikube\" modified. \u5728 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u986f\u793a issue \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72 manifest\u3002 deployment-issues.yaml apiVersion : apps/v1 kind : Deployment metadata : name : issues labels : app : issues spec : selector : matchLabels : app : issues replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : issues spec : serviceAccountName : internal-app containers : - name : issues image : jweissig/app:0.0.1 \u61c9\u7528 deployment-issues.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u3002 $ kubectl apply --filename deployment-issues.yaml deployment.apps/issues created \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-cd8958bc6-7hrc5 0 /2 Init:0/1 0 111s deployment-issues.yaml \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728 Kubernetes \u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: creating file sink 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T11:51:47.277Z [ INFO ] template.server: starting template server 2022 -07-10T11:51:47.277Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T11:51:47.277Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T11:51:47.278Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:51:47.277Z [ INFO ] sink.server: starting sink server 2022 -07-10T11:51:47.278Z [ INFO ] ( runner ) creating watcher 2022 -07-10T11:52:47.279Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1s 2022 -07-10T11:52:48.280Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:53:48.281Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1 .93s 2022 -07-10T11:53:50.218Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:54:50.219Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 3 .36s 2022 -07-10T11:54:53.586Z [ INFO ] auth.handler: authenticating \u547d\u540d\u7a7a\u9593 offsite \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec --namespace default -it vault-0 -- /bin/sh / $ \u5275\u5efa\u4e00\u500b\u540d\u70ba offsite-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/offsite-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = offsite \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/offsite-app \u9000\u51fa vault-0 pod\u3002 $ exit \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-issues.yaml \u3002 patch-issues.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'offsite-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u8a72\u88dc\u4e01\u57f7\u884c\u66f4\u65b0\u4ee5\u5c07 vault.hashicorp.com/role \u8a2d\u7f6e\u70ba Vault Kubernetes \u89d2\u8272 offsite-app \u3002 \u4fee\u88dc patch-issues.yaml \u4e2d\u5b9a\u7fa9\u7684 issues \u90e8\u7f72\u3002 $ kubectl patch deployment issues --patch \" $( cat patch-issues.yaml ) \" deployment.apps/issues patched \u65b0\u554f\u984c pod \u8207\u73fe\u6709 pod \u4e00\u8d77\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-d8596bb9-jkzzr 2 /2 Running 0 66s \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684\u554f\u984c pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728\u554f\u984c pod \u4e2d\u986f\u793a\u5beb\u5165\u554f\u984c\u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container issues -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard","title":"Secret \u7d81\u5b9a\u5230 Namespace"},{"location":"vault/tutorials/auth/identity-entity-group/","text":"Identity: Entities and Groups \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth/userpass","title":"Identity: Entities and Groups"},{"location":"vault/tutorials/auth/identity-entity-group/#identity-entities-and-groups","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth/userpass","title":"Identity: Entities and Groups"}]}