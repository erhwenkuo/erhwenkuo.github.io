{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Welcome to Tech Learning \u00b6 \u672c\u7db2\u7ad9\u4e3b\u8981\u662f\u500b\u4eba\u5728\u5b78\u7fd2\u4e00\u4e9b\u8cc7\u8a0a\u79d1\u6280\u7684\u77e5\u8b58\u8207\u5de5\u5177\u6642\u6240\u6536\u96c6\u7684\u76f8\u95dc\u6587\u7ae0\u8207\u7df4\u7fd2\u3002","title":"CICD \u8def\u7dda\u5716"},{"location":"#welcome-to-tech-learning","text":"\u672c\u7db2\u7ad9\u4e3b\u8981\u662f\u500b\u4eba\u5728\u5b78\u7fd2\u4e00\u4e9b\u8cc7\u8a0a\u79d1\u6280\u7684\u77e5\u8b58\u8207\u5de5\u5177\u6642\u6240\u6536\u96c6\u7684\u76f8\u95dc\u6587\u7ae0\u8207\u7df4\u7fd2\u3002","title":"Welcome to Tech Learning"},{"location":"ansible/ansible-cheatsheet/","text":"\u5982\u4f55\u4f7f\u7528 Ansible\uff1a\u53c3\u8003\u6307\u5357 \u00b6 Ansible \u662f\u4e00\u7a2e\u73fe\u4ee3\u5316\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff0c\u53ef\u5e6b\u52a9\u60a8\u5b8c\u6210\u8a2d\u7f6e\u548c\u7dad\u8b77\u9060\u7a0b\u670d\u52d9\u5668\u7684\u4efb\u52d9\u3002 \u9019\u500b cheatsheet \u98a8\u683c\u7684\u6307\u5357\u63d0\u4f9b\u4e86\u4f7f\u7528 Ansible \u6642\u5e38\u7528\u7684\u547d\u4ee4\u548c\u5be6\u8e10\u7684\u5feb\u901f\u53c3\u8003\u3002\u6709\u95dc Ansible \u7684\u6982\u8ff0\u4ee5\u53ca\u5982\u4f55\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u3002 \u5982\u4f55\u4f7f\u7528\u672c\u6307\u5357\uff1a \u672c\u6307\u5357\u63a1\u7528\u5099\u5fd8\u55ae\u683c\u5f0f\uff0c\u5e36\u6709\u7368\u7acb\u7684\u547d\u4ee4\u884c\u7247\u6bb5\u3002 \u8df3\u8f49\u5230\u8207\u60a8\u5617\u8a66\u5b8c\u6210\u7684\u4efb\u52d9\u76f8\u95dc\u7684\u4efb\u4f55\u90e8\u5206\u3002 \u7576\u60a8\u5728\u672c\u6307\u5357\u7684\u547d\u4ee4\u4e2d\u770b\u5230 \u7a81\u51fa\u986f\u793a\u7684\u6587\u672c \u6642\uff0c\u8acb\u8a18\u4f4f\uff0c\u6b64 \u6587\u672c \u662f\u5c0d\u61c9\u5230\u60a8\u81ea\u5df1\u7684\u6e05\u55ae\u4e2d\u7684\u4e3b\u6a5f\u3001\u7528\u6236\u540d\u548c IP \u5730\u5740\u3002 Ansible \u8a5e\u5f59\u8868 \u672c\u6307\u5357\u4e2d\u4e3b\u8981\u4f7f\u7528\u4ee5\u4e0b Ansible \u7279\u5b9a\u8853\u8a9e\uff1a Control Machine / Node : \u5b89\u88dd\u548c\u914d\u7f6e Ansible \u4ee5\u5728\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u57f7\u884c\u547d\u4ee4\u7684\u7cfb\u7d71\u3002 Node : \u7531 Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u3002 Inventory File : \u5305\u542b\u6709\u95dc Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u6587\u4ef6\uff0c\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \u3002 Playbook : \u5305\u542b\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4e00\u7cfb\u5217\u4efb\u52d9\u7684\u6587\u4ef6\u3002 Role : \u8207\u76ee\u6a19\u76f8\u95dc\u7684\u5287\u672c\u548c\u5176\u4ed6\u6587\u4ef6\u7684\u96c6\u5408\uff0c\u4f8b\u5982\u5b89\u88dd Web \u670d\u52d9\u5668\u3002 Play : \u5b8c\u6574\u7684 Ansible \u904b\u884c\u3002\u4e00\u500b\u5287\u672c\u53ef\u4ee5\u6709\u591a\u500b\u5287\u672c\u548c\u89d2\u8272\uff0c\u5305\u542b\u5728\u4e00\u500b\u4f5c\u70ba\u5165\u53e3\u9ede\u7684\u5287\u672c\u4e2d\u3002 \u8b93\u6211\u5011\u4f7f\u7528Ansible\u8207Vagrant\u4f86\u69cb\u5efa\u4e00\u500bVM\u4f86\u7df4\u7fd2\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6307\u4ee4\u3002 \u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-cheatsheet \u3002\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-cheatsheet $ cd ansible-cheatsheet \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" } \u6e2c\u8a66\u8207\u7bc0\u9ede\u7684\u9023\u63a5 \u00b6 \u8981\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u60a8\u7684\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u904b\u884c\u547d\u4ee4\u548c playbook\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a ansible all -m ping \u7d50\u679c: demo-vm | SUCCESS => { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python3\" }, \"changed\": false, \"ping\": \"pong\" } \u9664\u4e86\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c Python \u8173\u672c\u4e4b\u5916\uff0c ping \u6a21\u584a\u9084\u5c07\u6e2c\u8a66\u60a8\u662f\u5426\u5177\u6709\u9023\u63a5\u5230\u6e05\u55ae\u6587\u4ef6\u4e2d\u5b9a\u7fa9\u7684\u7bc0\u9ede\u7684\u6709\u6548\u6191\u64da\u3002 pong \u56de\u590d\u610f\u5473\u8457 Ansible \u5df2\u6e96\u5099\u597d\u5728\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c\u547d\u4ee4\u548c playbook\u3002 \u4ee5\u4e0d\u540c\u7528\u6236\u8eab\u4efd\u9023\u63a5 \u00b6 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible \u6703\u5617\u8a66\u4f7f\u7528\u5176\u5c0d\u61c9\u7684 SSH \u5bc6\u9470\u5c0d\u4ee5\u60a8\u7576\u524d\u7684\u7cfb\u7d71\u7528\u6236\u8eab\u4efd\u9023\u63a5\u5230\u7bc0\u9ede\u3002\u8981\u4ee5\u5176\u4ed6\u7528\u6236\u8eab\u4efd\u9023\u63a5\uff0c\u8acb\u5728\u547d\u4ee4\u5f8c\u9762\u9644\u52a0 -u \u6a19\u8a8c\u548c\u9810\u671f\u7528\u6236\u7684\u540d\u7a31\uff1a $ ansible all -m ping -u vagrant \u540c\u6a23\u7684flag\u4e5f\u9069\u7528\u65bc ansible-playbook\uff1a $ ansible-playbook myplaybook.yml -u vagrant \u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470 \u00b6 \u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u60a8\u53ef\u4ee5\u5728\u57f7\u884c\u6642\u4f7f\u7528 --private-key \u9078\u9805\u63d0\u4f9b\u5b83\uff1a $ ansible all -m ping --private-key = ~/.ssh/custom_id \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml --private-key = ~/.ssh/custom_id \u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49 \u00b6 \u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49\u4f86\u9023\u63a5\u5230\u7bc0\u9ede\uff0c\u5247\u9700\u8981\u5c07\u9078\u9805 --ask-pass \u9644\u52a0\u5230\u60a8\u7684 Ansible \u547d\u4ee4\u3002 \u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u60a8\u5617\u8a66\u9023\u63a5\u7684\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684\u7528\u6236\u5bc6\u78bc\uff1a $ ansible all -m ping --ask-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-pass \u63d0\u4f9b sudo \u5bc6\u78bc \u00b6 \u5982\u679c\u9060\u7a0b\u7528\u6236\u9700\u8981\u63d0\u4f9b\u5bc6\u78bc\u624d\u80fd\u904b\u884c sudo \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u5728 Ansible \u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 --ask-become-pass \u3002\u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9060\u7a0b\u7528\u6236 sudo \u5bc6\u78bc\uff1a $ ansible all -m ping --ask-become-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-become-pass \u4f7f\u7528\u81ea\u5b9a\u7fa9\u4e3b\u6a5f inventory \u6587\u4ef6 \u00b6 \u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \uff0c\u4f46\u60a8\u4e5f\u53ef\u4ee5\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u9078\u9805\u6307\u5411\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u3002 Ansible \u9084\u652f\u6301\u7528\u65bc\u69cb\u5efa\u52d5\u614b\u6e05\u55ae\u6587\u4ef6\u7684\u6e05\u55ae\u8173\u672c\uff0c\u4ee5\u4fbf\u5728\u60a8\u7684\u6e05\u55ae\u6ce2\u52d5\u6642\uff0c\u7d93\u5e38\u5275\u5efa\u548c\u92b7\u6bc0\u670d\u52d9\u5668\u3002\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u5c0d\u65bc\u8a2d\u7f6e\u53ef\u4ee5\u5305\u542b\u5728\u7248\u672c\u63a7\u5236\u7cfb\u7d71\uff08\u4f8b\u5982 Git\uff09\u4e2d\u7684\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u5f88\u6709\u7528\uff1a $ ansible all -m ping -i my_custom_inventory \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml -i my_custom_inventory \u904b\u884c\u81e8\u6642\u547d\u4ee4 (ad-hoc) \u00b6 \u8981\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u547d\u4ee4\uff0c\u8acb\u4f7f\u7528 -a \u9078\u9805\uff0c\u5f8c\u8ddf\u8981\u904b\u884c\u7684\u547d\u4ee4\uff0c\u7528\u5f15\u865f\u62ec\u8d77\u4f86\u3002 \u9019\u5c07\u5728\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u57f7\u884c uname -a \uff1a $ ansible all -a \"uname -a\" \u4e5f\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 -m \u904b\u884c Ansible \u6a21\u584a\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u5f9e\u60a8\u7684\u6e05\u55ae\u4e2d\u5c07\u8edf\u4ef6\u5305 vim \u5b89\u88dd\u5230 server1 \u4e0a\uff1a $ ansible server1 -m apt -a \"name=vim\" \u5728\u5c0d\u7bc0\u9ede\u9032\u884c\u66f4\u6539\u4e4b\u524d\uff0c\u60a8\u53ef\u4ee5\u9032\u884c\u8a66\u904b\u884c\u4ee5\u9810\u6e2c\u670d\u52d9\u5668\u5c07\u5982\u4f55\u53d7\u5230\u60a8\u7684\u547d\u4ee4\u7684\u5f71\u97ff\u3002\u9019\u53ef\u4ee5\u901a\u904e\u5305\u542b --check \u9078\u9805\u4f86\u5b8c\u6210\uff1a $ ansible server1 -m apt -a \"name=vim\" --check \u904b\u884c\u5287\u672c Playbook \u00b6 \u8981\u904b\u884c\u5287\u672c\u4e26\u57f7\u884c\u5176\u4e2d\u5b9a\u7fa9\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 ansible-playbook \u547d\u4ee4\uff1a $ ansible-playbook myplaybook.yml \u8981\u8986\u84cb playbook \u4e2d\u7684\u9ed8\u8a8d\u4e3b\u6a5f\u9078\u9805\u4e26\u5c07\u57f7\u884c\u9650\u5236\u70ba\u7279\u5b9a\u7d44\u6216\u4e3b\u6a5f\uff0c\u8acb\u5728\u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 -l \uff1a $ ansible-playbook -l server1 myplaybook.yml \u7372\u53d6\u6709\u95dc Play \u7684\u4fe1\u606f \u00b6 $ ansible-playbook myplaybook.yml --list-tasks \u540c\u6a23\uff0c\u53ef\u4ee5\u5217\u51fa\u6240\u6709\u53d7 Play \u5f71\u97ff\u7684\u4e3b\u6a5f\uff0c\u800c\u7121\u9700\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c\u4efb\u4f55\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --list-hosts \u60a8\u53ef\u4ee5\u4f7f\u7528\u6a19\u7c64\u4f86\u9650\u88fd Play \u7684\u57f7\u884c\u3002\u8981\u5217\u51fa\u64ad\u653e\u4e2d\u53ef\u7528\u7684\u6240\u6709\u6a19\u7c64\uff0c\u8acb\u4f7f\u7528\u9078\u9805 --list-tags \uff1a $ ansible-playbook myplaybook.yml --list-tags \u63a7\u5236\u5287\u672c Playbook \u57f7\u884c \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --start-at-task \u70ba\u60a8\u7684\u5287\u672c\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u5165\u53e3\u9ede\u3002 Ansible \u7136\u5f8c\u5c07\u8df3\u904e\u6307\u5b9a\u4efb\u52d9\u4e4b\u524d\u7684\u4efb\u4f55\u5167\u5bb9\uff0c\u5f9e\u8a72\u9ede\u958b\u59cb\u57f7\u884c\u5269\u9918\u7684\u64ad\u653e\u3002\u6b64\u9078\u9805\u9700\u8981\u4e00\u500b\u6709\u6548\u7684\u4efb\u52d9\u540d\u7a31\u4f5c\u70ba\u53c3\u6578\uff1a $ ansible-playbook myplaybook.yml --start-at-task = \"Set Up Nginx\" \u8981\u50c5\u57f7\u884c\u8207\u7279\u5b9a\u6a19\u7c64\u95dc\u806f\u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --tags\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u53ea\u60f3\u57f7\u884c\u6a19\u8a18\u70ba nginx \u6216 mysql \u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-playbook myplaybook.yml --tags = mysql,nginx \u5982\u679c\u8981\u8df3\u904e\u7279\u5b9a\u6a19\u7c64\u4e0b\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 --skip-tags\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u57f7\u884c myplaybook.yml\uff0c\u8df3\u904e\u6240\u6709\u6a19\u8a18\u70ba mysql \u7684\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --skip-tags = mysql \u4f7f\u7528 Ansible Vault \u5b58\u5132\u654f\u611f\u6578\u64da \u00b6 \u5982\u679c\u60a8\u7684 Ansible playbook \u8655\u7406\u5bc6\u78bc\u3001API \u5bc6\u9470\u548c\u6191\u64da\u7b49\u654f\u611f\u6578\u64da\uff0c\u5247\u4f7f\u7528\u52a0\u5bc6\u6a5f\u5236\u78ba\u4fdd\u9019\u4e9b\u6578\u64da\u7684\u5b89\u5168\u975e\u5e38\u91cd\u8981\u3002 Ansible \u63d0\u4f9b ansible-vault \u4f86\u52a0\u5bc6\u6587\u4ef6\u548c\u8b8a\u91cf\u3002 \u5118\u7ba1\u53ef\u4ee5\u52a0\u5bc6\u4efb\u4f55 Ansible \u6578\u64da\u6587\u4ef6\u4ee5\u53ca\u4e8c\u9032\u88fd\u6587\u4ef6\uff0c\u4f46\u66f4\u5e38\u898b\u7684\u662f\u4f7f\u7528 ansible-vault \u4f86\u52a0\u5bc6\u5305\u542b\u654f\u611f\u6578\u64da\u7684\u8b8a\u91cf\u6587\u4ef6\u3002\u4f7f\u7528\u6b64\u5de5\u5177\u52a0\u5bc6\u6587\u4ef6\u5f8c\uff0c\u60a8\u53ea\u80fd\u901a\u904e\u63d0\u4f9b\u9996\u6b21\u52a0\u5bc6\u6587\u4ef6\u6642\u5b9a\u7fa9\u7684\u76f8\u95dc\u5bc6\u78bc\u4f86\u57f7\u884c\u3001\u7de8\u8f2f\u6216\u67e5\u770b\u5176\u5167\u5bb9\u3002 \u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6 \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u4e00\u500b\u65b0\u7684\u52a0\u5bc6 Ansible \u6587\u4ef6\uff1a $ ansible-vault create credentials.yml \u8a72\u547d\u4ee4\u5c07\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u9996\u5148\uff0c\u5b83\u6703\u63d0\u793a\u60a8\u8f38\u5165\u65b0\u5bc6\u78bc\u3002\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6\u5167\u5bb9\u6642\uff0c\u60a8\u90fd\u9700\u8981\u63d0\u4f9b\u6b64\u5bc6\u78bc\uff0c\u7121\u8ad6\u662f\u7528\u65bc\u7de8\u8f2f\u3001\u67e5\u770b\u9084\u662f\u50c5\u4f7f\u7528\u9019\u4e9b\u503c\u904b\u884c playbook \u6216\u547d\u4ee4\u3002 \u63a5\u4e0b\u4f86\uff0c\u5b83\u5c07\u6253\u958b\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u4f7f\u7528\u6240\u9700\u5167\u5bb9\u586b\u5145\u6587\u4ef6\u3002 \u6700\u5f8c\uff0c\u7576\u4f60\u5b8c\u6210\u7de8\u8f2f\u5f8c\uff0cansible-vault \u6703\u5c07\u6587\u4ef6\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002 \u52a0\u5bc6\u73fe\u6709\u7684 Ansible File \u00b6 \u8981\u52a0\u5bc6\u73fe\u6709\u7684 Ansible \u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\uff1a $ ansible-vault encrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6 credentials.yml \u6642\u90fd\u9700\u8981\u8f38\u5165\u8a72\u5bc6\u78bc\u3002 \u67e5\u770b\u52a0\u5bc6\u6587\u4ef6\u7684\u5167\u5bb9 \u00b6 \u5982\u679c\u60a8\u60f3\u67e5\u770b\u4e4b\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\u4e26\u4e14\u4e0d\u9700\u8981\u66f4\u6539\u5176\u5167\u5bb9\uff0c\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-vault view credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6\u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002 \u7de8\u8f2f\u52a0\u5bc6\u6587\u4ef6 \u00b6 \u8981\u7de8\u8f2f\u4e4b\u524d\u4f7f\u7528 Ansible Vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u8acb\u904b\u884c\uff1a $ ansible-vault edit credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\u5c07\u6253\u958b\u6587\u4ef6\u7684\u672a\u52a0\u5bc6\u5167\u5bb9\uff0c\u5141\u8a31\u60a8\u9032\u884c\u66f4\u6539\u3002\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u7167\u5e38\u4fdd\u5b58\u548c\u95dc\u9589\u6587\u4ef6\uff0c\u66f4\u65b0\u7684\u5167\u5bb9\u5c07\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002 \u89e3\u5bc6\u52a0\u5bc6\u6587\u4ef6 \u00b6 \u5982\u679c\u60a8\u5e0c\u671b\u5c07\u4ee5\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u6c38\u4e45\u9084\u539f\u70ba\u5176\u672a\u52a0\u5bc6\u7248\u672c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\u57f7\u884c\u6b64\u64cd\u4f5c\uff1a $ ansible-vault decrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u6587\u4ef6\u5167\u5bb9\u5c07\u4f5c\u70ba\u672a\u52a0\u5bc6\u6578\u64da\u4fdd\u5b58\u5230\u78c1\u76e4\u3002 \u4f7f\u7528\u591a\u500b Vault \u5bc6\u78bc \u00b6 Ansible \u652f\u6301\u6309\u4e0d\u540c\u4fdd\u7ba1\u5eab ID \u5206\u7d44\u7684\u591a\u500b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5982\u679c\u60a8\u60f3\u70ba\u4e0d\u540c\u7684\u74b0\u5883\uff08\u4f8b\u5982\u958b\u767c\u3001\u6e2c\u8a66\u548c\u751f\u7522\u74b0\u5883\uff09\u4f7f\u7528\u5c08\u7528\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\uff0c\u9019\u5c07\u975e\u5e38\u6709\u7528\u3002 \u8981\u4f7f\u7528\u81ea\u5b9a\u7fa9\u4fdd\u7ba1\u5eab ID \u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6\uff0c\u8acb\u5305\u62ec --vault-id \u9078\u9805\u4ee5\u53ca\u6a19\u7c64\u548c ansible-vault \u53ef\u4ee5\u627e\u5230\u8a72\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u7684\u4f4d\u7f6e\u3002\u6a19\u7c64\u53ef\u4ee5\u662f\u4efb\u4f55\u6a19\u8b58\u7b26\uff0c\u4e26\u4e14\u4f4d\u7f6e\u53ef\u4ee5\u662f\u63d0\u793a\u7b26\uff0c\u9019\u610f\u5473\u8457\u8a72\u547d\u4ee4\u61c9\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6216\u5bc6\u78bc\u6587\u4ef6\u7684\u6709\u6548\u8def\u5f91\u3002 $ ansible-vault create --vault-id dev@prompt credentials_dev.yml \u9019\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dev \u7684\u65b0\u4fdd\u7ba1\u5eab ID\uff0c\u5b83\u4f7f\u7528\u63d0\u793a\u7b26\u4f5c\u70ba\u5bc6\u78bc\u6e90\u3002\u901a\u904e\u5c07\u6b64\u65b9\u6cd5\u8207\u7d44\u8b8a\u91cf\u6587\u4ef6\u76f8\u7d50\u5408\uff0c\u60a8\u5c07\u80fd\u5920\u70ba\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u64c1\u6709\u55ae\u7368\u7684 ansible \u4fdd\u96aa\u5eab\uff1a $ ansible-vault create --vault-id prod@prompt credentials_prod.yml \u6211\u5011\u4f7f\u7528 dev \u548c prod \u4f5c\u70ba\u6587\u4ef6\u5eab ID \u4f86\u6f14\u793a\u5982\u4f55\u70ba\u6bcf\u500b\u74b0\u5883\u5275\u5efa\u55ae\u7368\u7684\u6587\u4ef6\u5eab\uff0c\u4f46\u60a8\u53ef\u4ee5\u5275\u5efa\u4efb\u610f\u6578\u91cf\u7684\u6587\u4ef6\u5eab\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u4efb\u4f55\u6a19\u8b58\u7b26\u4f5c\u70ba\u6587\u4ef6\u5eab ID\u3002 \u73fe\u5728\u8981\u67e5\u770b\u3001\u7de8\u8f2f\u6216\u89e3\u5bc6\u9019\u4e9b\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u63d0\u4f9b\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\u4ee5\u53ca ansible-vault \u547d\u4ee4\uff1a $ ansible-vault edit credentials_dev.yml --vault-id dev@prompt \u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6 \u00b6 \u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u7b2c\u4e09\u65b9\u5de5\u5177\u901a\u904e Ansible \u81ea\u52d5\u914d\u7f6e\u670d\u52d9\u5668\u7684\u904e\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u4f86\u63d0\u4f9b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u800c\u4e0d\u88ab\u63d0\u793a\u8f38\u5165\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528\u5e36\u6709 ansible-vault \u7684\u5bc6\u78bc\u6587\u4ef6\u4f86\u505a\u5230\u9019\u4e00\u9ede\u3002 \u5bc6\u78bc\u6587\u4ef6\u53ef\u4ee5\u662f\u7d14\u6587\u672c\u6587\u4ef6\u6216\u53ef\u57f7\u884c\u8173\u672c\u3002\u5982\u679c\u6587\u4ef6\u662f\u53ef\u57f7\u884c\u8173\u672c\uff0c\u5247\u6b64\u8173\u672c\u751f\u6210\u7684\u8f38\u51fa\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5426\u5247\uff0c\u6587\u4ef6\u7684\u539f\u59cb\u5167\u5bb9\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002 \u8981\u5728 ansible-vault \u4e2d\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c\u4efb\u4f55 vault \u547d\u4ee4\u6642\u63d0\u4f9b\u5bc6\u78bc\u6587\u4ef6\u7684\u8def\u5f91\uff1a $ ansible-vault create --vault-id dev@path/to/passfile credentials_dev.yml \u53ea\u8981\u8f38\u5165\u7684\u5bc6\u78bc\u76f8\u540c\uff0cAnsible \u4e0d\u6703\u5340\u5206\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u7684\u5167\u5bb9\u6216\u5bc6\u78bc\u6587\u4ef6\u4f5c\u70ba\u5bc6\u78bc\u6e90\u7684\u5167\u5bb9\u3002\u5be6\u969b\u4e0a\uff0c\u9019\u610f\u5473\u8457\u53ef\u4ee5\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u6587\u4ef6\uff0c\u7136\u5f8c\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u5b58\u5132\u8207\u63d0\u793a\u65b9\u6cd5\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u53cd\u4e4b\u4ea6\u7136\uff1a\u60a8\u53ef\u4ee5\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u52a0\u5bc6\u5167\u5bb9\uff0c\u7136\u5f8c\u4f7f\u7528\u63d0\u793a\u65b9\u6cd5\uff0c\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u76f8\u540c\u7684\u5bc6\u78bc\u3002 \u70ba\u4e86\u63d0\u9ad8\u9748\u6d3b\u6027\u548c\u5b89\u5168\u6027\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Python \u8173\u672c\u5f9e\u5176\u4ed6\u4f86\u6e90\u7372\u53d6\u5bc6\u78bc\uff0c\u800c\u4e0d\u662f\u5c07\u60a8\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u5b58\u5132\u5728\u7d14\u6587\u672c\u6587\u4ef6\u4e2d\u3002\u5b98\u65b9 Ansible \u5b58\u5132\u5eab\u5305\u542b\u4e00\u4e9b Vault \u8173\u672c\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5728\u5275\u5efa\u9069\u5408\u9805\u76ee\u7279\u5b9a\u9700\u6c42\u7684\u81ea\u5b9a\u7fa9\u8173\u672c\u6642\u53c3\u8003\u9019\u4e9b\u793a\u4f8b\u3002 \u904b\u884c\u901a\u904e Ansible Vault \u52a0\u5bc6\u6578\u64da\u7684\u5287\u672c \u00b6 \u6bcf\u7576\u60a8\u904b\u884c\u4f7f\u7528\u5148\u524d\u901a\u904e ansible-vault \u52a0\u5bc6\u7684\u6578\u64da\u7684 playbook \u6642\uff0c\u60a8\u90fd\u9700\u8981\u5411 playbook \u547d\u4ee4\u63d0\u4f9b vault \u5bc6\u78bc\u3002 \u5982\u679c\u60a8\u5728\u52a0\u5bc6\u6b64 playbook \u4e2d\u4f7f\u7528\u7684\u6578\u64da\u6642\u4f7f\u7528\u4e86\u9ed8\u8a8d\u9078\u9805\u548c\u63d0\u793a\u5bc6\u78bc\u6e90\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --ask-vault-pass \u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff1a $ ansible-playbook myplaybook.yml --ask-vault-pass \u5982\u679c\u60a8\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u800c\u4e0d\u662f\u63d0\u793a\u8f38\u5165\u5bc6\u78bc\uff0c\u5247\u61c9\u4f7f\u7528\u9078\u9805 --vault-password-file \u4ee3\u66ff\uff1a $ ansible-playbook myplaybook.yml --vault-password-file my_vault_password.py \u5982\u679c\u60a8\u4f7f\u7528\u5728\u4fdd\u7ba1\u5eab ID \u4e0b\u52a0\u5bc6\u7684\u6578\u64da\uff0c\u5247\u9700\u8981\u63d0\u4f9b\u8207\u9996\u6b21\u52a0\u5bc6\u6578\u64da\u6642\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@prompt \u5982\u679c\u4f7f\u7528\u5e36\u6709\u60a8\u7684\u4fdd\u7ba1\u5eab ID \u7684\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u61c9\u8a72\u63d0\u4f9b\u6a19\u7c64\uff0c\u5f8c\u8ddf\u5bc6\u78bc\u6587\u4ef6\u7684\u5b8c\u6574\u8def\u5f91\u4f5c\u70ba\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py \u5982\u679c\u60a8\u7684\u904a\u6232\u4f7f\u7528\u591a\u500b\u4fdd\u96aa\u5eab\uff0c\u60a8\u61c9\u8a72\u70ba\u6bcf\u500b\u4fdd\u96aa\u5eab\u63d0\u4f9b\u4e00\u500b --vault-id \u53c3\u6578\uff0c\u6c92\u6709\u7279\u5b9a\u7684\u9806\u5e8f\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py --vault-id test@prompt --vault-id ci@prompt \u8abf\u8a66 \u00b6 \u5982\u679c\u60a8\u5728\u57f7\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u9047\u5230\u932f\u8aa4\uff0c\u6700\u597d\u589e\u52a0\u8f38\u51fa\u8a73\u7d30\u7a0b\u5ea6\u4ee5\u7372\u53d6\u6709\u95dc\u554f\u984c\u7684\u66f4\u591a\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u5305\u542b -v \u9078\u9805\u4f86\u505a\u5230\u9019\u4e00\u9ede\uff1a $ ansible-playbook myplaybook.yml -v \u5982\u679c\u60a8\u9700\u8981\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528 -vvv\uff0c\u9019\u5c07\u589e\u52a0\u8f38\u51fa\u7684\u8a73\u7d30\u7a0b\u5ea6\u3002\u5982\u679c\u60a8\u7121\u6cd5\u901a\u904e Ansible \u9023\u63a5\u5230\u9060\u7a0b\u7bc0\u9ede\uff0c\u8acb\u4f7f\u7528 -vvvv \u7372\u53d6\u9023\u63a5\u8abf\u8a66\u4fe1\u606f\uff1a $ ansible-playbook myplaybook.yml -vvvv \u7d50\u8ad6 \u00b6 \u672c\u6307\u5357\u6db5\u84cb\u4e86\u60a8\u5728\u914d\u7f6e\u670d\u52d9\u5668\u6642\u53ef\u80fd\u4f7f\u7528\u7684\u4e00\u4e9b\u6700\u5e38\u898b\u7684 Ansible \u547d\u4ee4\uff0c\u4f8b\u5982\u5982\u4f55\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u9060\u7a0b\u547d\u4ee4\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5404\u7a2e\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u904b\u884c playbook\u3002 \u60a8\u53ef\u80fd\u6703\u767c\u73fe\u5176\u4ed6\u547d\u4ee4\u8b8a\u9ad4\u548c\u6a19\u8a8c\u5c0d\u60a8\u7684 Ansible \u5de5\u4f5c\u6d41\u7a0b\u5f88\u6709\u7528\u3002\u8981\u7372\u5f97\u6240\u6709\u53ef\u7528\u9078\u9805\u7684\u6982\u89bd\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5e6b\u52a9\u547d\u4ee4\uff1a $ ansible --help \u5982\u679c\u60a8\u60f3\u66f4\u5168\u9762\u5730\u4e86\u89e3 Ansible \u53ca\u5176\u6240\u6709\u53ef\u7528\u547d\u4ee4\u548c\u529f\u80fd\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94\u3002 \u5982\u679c\u60a8\u60f3\u67e5\u770b Ansible \u7684\u53e6\u4e00\u500b\u5be6\u969b\u793a\u4f8b\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u6307\u5357\u3002","title":"Ansible \u4f7f\u7528\u6307\u5357"},{"location":"ansible/ansible-cheatsheet/#ansible","text":"Ansible \u662f\u4e00\u7a2e\u73fe\u4ee3\u5316\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\uff0c\u53ef\u5e6b\u52a9\u60a8\u5b8c\u6210\u8a2d\u7f6e\u548c\u7dad\u8b77\u9060\u7a0b\u670d\u52d9\u5668\u7684\u4efb\u52d9\u3002 \u9019\u500b cheatsheet \u98a8\u683c\u7684\u6307\u5357\u63d0\u4f9b\u4e86\u4f7f\u7528 Ansible \u6642\u5e38\u7528\u7684\u547d\u4ee4\u548c\u5be6\u8e10\u7684\u5feb\u901f\u53c3\u8003\u3002\u6709\u95dc Ansible \u7684\u6982\u8ff0\u4ee5\u53ca\u5982\u4f55\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u3002 \u5982\u4f55\u4f7f\u7528\u672c\u6307\u5357\uff1a \u672c\u6307\u5357\u63a1\u7528\u5099\u5fd8\u55ae\u683c\u5f0f\uff0c\u5e36\u6709\u7368\u7acb\u7684\u547d\u4ee4\u884c\u7247\u6bb5\u3002 \u8df3\u8f49\u5230\u8207\u60a8\u5617\u8a66\u5b8c\u6210\u7684\u4efb\u52d9\u76f8\u95dc\u7684\u4efb\u4f55\u90e8\u5206\u3002 \u7576\u60a8\u5728\u672c\u6307\u5357\u7684\u547d\u4ee4\u4e2d\u770b\u5230 \u7a81\u51fa\u986f\u793a\u7684\u6587\u672c \u6642\uff0c\u8acb\u8a18\u4f4f\uff0c\u6b64 \u6587\u672c \u662f\u5c0d\u61c9\u5230\u60a8\u81ea\u5df1\u7684\u6e05\u55ae\u4e2d\u7684\u4e3b\u6a5f\u3001\u7528\u6236\u540d\u548c IP \u5730\u5740\u3002 Ansible \u8a5e\u5f59\u8868 \u672c\u6307\u5357\u4e2d\u4e3b\u8981\u4f7f\u7528\u4ee5\u4e0b Ansible \u7279\u5b9a\u8853\u8a9e\uff1a Control Machine / Node : \u5b89\u88dd\u548c\u914d\u7f6e Ansible \u4ee5\u5728\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u57f7\u884c\u547d\u4ee4\u7684\u7cfb\u7d71\u3002 Node : \u7531 Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u3002 Inventory File : \u5305\u542b\u6709\u95dc Ansible \u63a7\u5236\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u6587\u4ef6\uff0c\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \u3002 Playbook : \u5305\u542b\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4e00\u7cfb\u5217\u4efb\u52d9\u7684\u6587\u4ef6\u3002 Role : \u8207\u76ee\u6a19\u76f8\u95dc\u7684\u5287\u672c\u548c\u5176\u4ed6\u6587\u4ef6\u7684\u96c6\u5408\uff0c\u4f8b\u5982\u5b89\u88dd Web \u670d\u52d9\u5668\u3002 Play : \u5b8c\u6574\u7684 Ansible \u904b\u884c\u3002\u4e00\u500b\u5287\u672c\u53ef\u4ee5\u6709\u591a\u500b\u5287\u672c\u548c\u89d2\u8272\uff0c\u5305\u542b\u5728\u4e00\u500b\u4f5c\u70ba\u5165\u53e3\u9ede\u7684\u5287\u672c\u4e2d\u3002 \u8b93\u6211\u5011\u4f7f\u7528Ansible\u8207Vagrant\u4f86\u69cb\u5efa\u4e00\u500bVM\u4f86\u7df4\u7fd2\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6307\u4ee4\u3002 \u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-cheatsheet \u3002\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-cheatsheet $ cd ansible-cheatsheet \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" }","title":"\u5982\u4f55\u4f7f\u7528 Ansible\uff1a\u53c3\u8003\u6307\u5357"},{"location":"ansible/ansible-cheatsheet/#_1","text":"\u8981\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u60a8\u7684\u7bc0\u9ede\u4e0a\u9023\u63a5\u548c\u904b\u884c\u547d\u4ee4\u548c playbook\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a ansible all -m ping \u7d50\u679c: demo-vm | SUCCESS => { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python3\" }, \"changed\": false, \"ping\": \"pong\" } \u9664\u4e86\u6e2c\u8a66 Ansible \u662f\u5426\u80fd\u5920\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c Python \u8173\u672c\u4e4b\u5916\uff0c ping \u6a21\u584a\u9084\u5c07\u6e2c\u8a66\u60a8\u662f\u5426\u5177\u6709\u9023\u63a5\u5230\u6e05\u55ae\u6587\u4ef6\u4e2d\u5b9a\u7fa9\u7684\u7bc0\u9ede\u7684\u6709\u6548\u6191\u64da\u3002 pong \u56de\u590d\u610f\u5473\u8457 Ansible \u5df2\u6e96\u5099\u597d\u5728\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c\u547d\u4ee4\u548c playbook\u3002","title":"\u6e2c\u8a66\u8207\u7bc0\u9ede\u7684\u9023\u63a5"},{"location":"ansible/ansible-cheatsheet/#_2","text":"\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible \u6703\u5617\u8a66\u4f7f\u7528\u5176\u5c0d\u61c9\u7684 SSH \u5bc6\u9470\u5c0d\u4ee5\u60a8\u7576\u524d\u7684\u7cfb\u7d71\u7528\u6236\u8eab\u4efd\u9023\u63a5\u5230\u7bc0\u9ede\u3002\u8981\u4ee5\u5176\u4ed6\u7528\u6236\u8eab\u4efd\u9023\u63a5\uff0c\u8acb\u5728\u547d\u4ee4\u5f8c\u9762\u9644\u52a0 -u \u6a19\u8a8c\u548c\u9810\u671f\u7528\u6236\u7684\u540d\u7a31\uff1a $ ansible all -m ping -u vagrant \u540c\u6a23\u7684flag\u4e5f\u9069\u7528\u65bc ansible-playbook\uff1a $ ansible-playbook myplaybook.yml -u vagrant","title":"\u4ee5\u4e0d\u540c\u7528\u6236\u8eab\u4efd\u9023\u63a5"},{"location":"ansible/ansible-cheatsheet/#ssh","text":"\u5982\u679c\u60a8\u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u60a8\u53ef\u4ee5\u5728\u57f7\u884c\u6642\u4f7f\u7528 --private-key \u9078\u9805\u63d0\u4f9b\u5b83\uff1a $ ansible all -m ping --private-key = ~/.ssh/custom_id \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml --private-key = ~/.ssh/custom_id","title":"\u4f7f\u7528\u81ea\u5b9a\u7fa9 SSH \u5bc6\u9470"},{"location":"ansible/ansible-cheatsheet/#_3","text":"\u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49\u4f86\u9023\u63a5\u5230\u7bc0\u9ede\uff0c\u5247\u9700\u8981\u5c07\u9078\u9805 --ask-pass \u9644\u52a0\u5230\u60a8\u7684 Ansible \u547d\u4ee4\u3002 \u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u60a8\u5617\u8a66\u9023\u63a5\u7684\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684\u7528\u6236\u5bc6\u78bc\uff1a $ ansible all -m ping --ask-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-pass","title":"\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684\u8eab\u4efd\u9a57\u8b49"},{"location":"ansible/ansible-cheatsheet/#sudo","text":"\u5982\u679c\u9060\u7a0b\u7528\u6236\u9700\u8981\u63d0\u4f9b\u5bc6\u78bc\u624d\u80fd\u904b\u884c sudo \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u5728 Ansible \u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 --ask-become-pass \u3002\u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9060\u7a0b\u7528\u6236 sudo \u5bc6\u78bc\uff1a $ ansible all -m ping --ask-become-pass \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a $ ansible-playbook myplaybook.yml --ask-become-pass","title":"\u63d0\u4f9b sudo \u5bc6\u78bc"},{"location":"ansible/ansible-cheatsheet/#inventory","text":"\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u901a\u5e38\u4f4d\u65bc /etc/ansible/hosts \uff0c\u4f46\u60a8\u4e5f\u53ef\u4ee5\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u9078\u9805\u6307\u5411\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u3002 Ansible \u9084\u652f\u6301\u7528\u65bc\u69cb\u5efa\u52d5\u614b\u6e05\u55ae\u6587\u4ef6\u7684\u6e05\u55ae\u8173\u672c\uff0c\u4ee5\u4fbf\u5728\u60a8\u7684\u6e05\u55ae\u6ce2\u52d5\u6642\uff0c\u7d93\u5e38\u5275\u5efa\u548c\u92b7\u6bc0\u670d\u52d9\u5668\u3002\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u5c0d\u65bc\u8a2d\u7f6e\u53ef\u4ee5\u5305\u542b\u5728\u7248\u672c\u63a7\u5236\u7cfb\u7d71\uff08\u4f8b\u5982 Git\uff09\u4e2d\u7684\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u5f88\u6709\u7528\uff1a $ ansible all -m ping -i my_custom_inventory \u6b64\u9078\u9805\u5c0d ansible-playbook \u4e5f\u6709\u6548\uff1a ansible-playbook myplaybook.yml -i my_custom_inventory","title":"\u4f7f\u7528\u81ea\u5b9a\u7fa9\u4e3b\u6a5f inventory \u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#ad-hoc","text":"\u8981\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u547d\u4ee4\uff0c\u8acb\u4f7f\u7528 -a \u9078\u9805\uff0c\u5f8c\u8ddf\u8981\u904b\u884c\u7684\u547d\u4ee4\uff0c\u7528\u5f15\u865f\u62ec\u8d77\u4f86\u3002 \u9019\u5c07\u5728\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u57f7\u884c uname -a \uff1a $ ansible all -a \"uname -a\" \u4e5f\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 -m \u904b\u884c Ansible \u6a21\u584a\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u5f9e\u60a8\u7684\u6e05\u55ae\u4e2d\u5c07\u8edf\u4ef6\u5305 vim \u5b89\u88dd\u5230 server1 \u4e0a\uff1a $ ansible server1 -m apt -a \"name=vim\" \u5728\u5c0d\u7bc0\u9ede\u9032\u884c\u66f4\u6539\u4e4b\u524d\uff0c\u60a8\u53ef\u4ee5\u9032\u884c\u8a66\u904b\u884c\u4ee5\u9810\u6e2c\u670d\u52d9\u5668\u5c07\u5982\u4f55\u53d7\u5230\u60a8\u7684\u547d\u4ee4\u7684\u5f71\u97ff\u3002\u9019\u53ef\u4ee5\u901a\u904e\u5305\u542b --check \u9078\u9805\u4f86\u5b8c\u6210\uff1a $ ansible server1 -m apt -a \"name=vim\" --check","title":"\u904b\u884c\u81e8\u6642\u547d\u4ee4 (ad-hoc)"},{"location":"ansible/ansible-cheatsheet/#playbook","text":"\u8981\u904b\u884c\u5287\u672c\u4e26\u57f7\u884c\u5176\u4e2d\u5b9a\u7fa9\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 ansible-playbook \u547d\u4ee4\uff1a $ ansible-playbook myplaybook.yml \u8981\u8986\u84cb playbook \u4e2d\u7684\u9ed8\u8a8d\u4e3b\u6a5f\u9078\u9805\u4e26\u5c07\u57f7\u884c\u9650\u5236\u70ba\u7279\u5b9a\u7d44\u6216\u4e3b\u6a5f\uff0c\u8acb\u5728\u547d\u4ee4\u4e2d\u5305\u542b\u9078\u9805 -l \uff1a $ ansible-playbook -l server1 myplaybook.yml","title":"\u904b\u884c\u5287\u672c Playbook"},{"location":"ansible/ansible-cheatsheet/#play","text":"$ ansible-playbook myplaybook.yml --list-tasks \u540c\u6a23\uff0c\u53ef\u4ee5\u5217\u51fa\u6240\u6709\u53d7 Play \u5f71\u97ff\u7684\u4e3b\u6a5f\uff0c\u800c\u7121\u9700\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u904b\u884c\u4efb\u4f55\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --list-hosts \u60a8\u53ef\u4ee5\u4f7f\u7528\u6a19\u7c64\u4f86\u9650\u88fd Play \u7684\u57f7\u884c\u3002\u8981\u5217\u51fa\u64ad\u653e\u4e2d\u53ef\u7528\u7684\u6240\u6709\u6a19\u7c64\uff0c\u8acb\u4f7f\u7528\u9078\u9805 --list-tags \uff1a $ ansible-playbook myplaybook.yml --list-tags","title":"\u7372\u53d6\u6709\u95dc Play \u7684\u4fe1\u606f"},{"location":"ansible/ansible-cheatsheet/#playbook_1","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --start-at-task \u70ba\u60a8\u7684\u5287\u672c\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u5165\u53e3\u9ede\u3002 Ansible \u7136\u5f8c\u5c07\u8df3\u904e\u6307\u5b9a\u4efb\u52d9\u4e4b\u524d\u7684\u4efb\u4f55\u5167\u5bb9\uff0c\u5f9e\u8a72\u9ede\u958b\u59cb\u57f7\u884c\u5269\u9918\u7684\u64ad\u653e\u3002\u6b64\u9078\u9805\u9700\u8981\u4e00\u500b\u6709\u6548\u7684\u4efb\u52d9\u540d\u7a31\u4f5c\u70ba\u53c3\u6578\uff1a $ ansible-playbook myplaybook.yml --start-at-task = \"Set Up Nginx\" \u8981\u50c5\u57f7\u884c\u8207\u7279\u5b9a\u6a19\u7c64\u95dc\u806f\u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --tags\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u53ea\u60f3\u57f7\u884c\u6a19\u8a18\u70ba nginx \u6216 mysql \u7684\u4efb\u52d9\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-playbook myplaybook.yml --tags = mysql,nginx \u5982\u679c\u8981\u8df3\u904e\u7279\u5b9a\u6a19\u7c64\u4e0b\u7684\u6240\u6709\u4efb\u52d9\uff0c\u8acb\u4f7f\u7528 --skip-tags\u3002\u4ee5\u4e0b\u547d\u4ee4\u5c07\u57f7\u884c myplaybook.yml\uff0c\u8df3\u904e\u6240\u6709\u6a19\u8a18\u70ba mysql \u7684\u4efb\u52d9\uff1a $ ansible-playbook myplaybook.yml --skip-tags = mysql","title":"\u63a7\u5236\u5287\u672c Playbook \u57f7\u884c"},{"location":"ansible/ansible-cheatsheet/#ansible-vault","text":"\u5982\u679c\u60a8\u7684 Ansible playbook \u8655\u7406\u5bc6\u78bc\u3001API \u5bc6\u9470\u548c\u6191\u64da\u7b49\u654f\u611f\u6578\u64da\uff0c\u5247\u4f7f\u7528\u52a0\u5bc6\u6a5f\u5236\u78ba\u4fdd\u9019\u4e9b\u6578\u64da\u7684\u5b89\u5168\u975e\u5e38\u91cd\u8981\u3002 Ansible \u63d0\u4f9b ansible-vault \u4f86\u52a0\u5bc6\u6587\u4ef6\u548c\u8b8a\u91cf\u3002 \u5118\u7ba1\u53ef\u4ee5\u52a0\u5bc6\u4efb\u4f55 Ansible \u6578\u64da\u6587\u4ef6\u4ee5\u53ca\u4e8c\u9032\u88fd\u6587\u4ef6\uff0c\u4f46\u66f4\u5e38\u898b\u7684\u662f\u4f7f\u7528 ansible-vault \u4f86\u52a0\u5bc6\u5305\u542b\u654f\u611f\u6578\u64da\u7684\u8b8a\u91cf\u6587\u4ef6\u3002\u4f7f\u7528\u6b64\u5de5\u5177\u52a0\u5bc6\u6587\u4ef6\u5f8c\uff0c\u60a8\u53ea\u80fd\u901a\u904e\u63d0\u4f9b\u9996\u6b21\u52a0\u5bc6\u6587\u4ef6\u6642\u5b9a\u7fa9\u7684\u76f8\u95dc\u5bc6\u78bc\u4f86\u57f7\u884c\u3001\u7de8\u8f2f\u6216\u67e5\u770b\u5176\u5167\u5bb9\u3002","title":"\u4f7f\u7528 Ansible Vault \u5b58\u5132\u654f\u611f\u6578\u64da"},{"location":"ansible/ansible-cheatsheet/#_4","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u4e00\u500b\u65b0\u7684\u52a0\u5bc6 Ansible \u6587\u4ef6\uff1a $ ansible-vault create credentials.yml \u8a72\u547d\u4ee4\u5c07\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u9996\u5148\uff0c\u5b83\u6703\u63d0\u793a\u60a8\u8f38\u5165\u65b0\u5bc6\u78bc\u3002\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6\u5167\u5bb9\u6642\uff0c\u60a8\u90fd\u9700\u8981\u63d0\u4f9b\u6b64\u5bc6\u78bc\uff0c\u7121\u8ad6\u662f\u7528\u65bc\u7de8\u8f2f\u3001\u67e5\u770b\u9084\u662f\u50c5\u4f7f\u7528\u9019\u4e9b\u503c\u904b\u884c playbook \u6216\u547d\u4ee4\u3002 \u63a5\u4e0b\u4f86\uff0c\u5b83\u5c07\u6253\u958b\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u4f7f\u7528\u6240\u9700\u5167\u5bb9\u586b\u5145\u6587\u4ef6\u3002 \u6700\u5f8c\uff0c\u7576\u4f60\u5b8c\u6210\u7de8\u8f2f\u5f8c\uff0cansible-vault \u6703\u5c07\u6587\u4ef6\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002","title":"\u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#ansible-file","text":"\u8981\u52a0\u5bc6\u73fe\u6709\u7684 Ansible \u6587\u4ef6\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\uff1a $ ansible-vault encrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6bcf\u7576\u60a8\u8a2a\u554f\u6587\u4ef6 credentials.yml \u6642\u90fd\u9700\u8981\u8f38\u5165\u8a72\u5bc6\u78bc\u3002","title":"\u52a0\u5bc6\u73fe\u6709\u7684 Ansible File"},{"location":"ansible/ansible-cheatsheet/#_5","text":"\u5982\u679c\u60a8\u60f3\u67e5\u770b\u4e4b\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\u4e26\u4e14\u4e0d\u9700\u8981\u66f4\u6539\u5176\u5167\u5bb9\uff0c\u53ef\u4ee5\u4f7f\u7528\uff1a $ ansible-vault view credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6\u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002","title":"\u67e5\u770b\u52a0\u5bc6\u6587\u4ef6\u7684\u5167\u5bb9"},{"location":"ansible/ansible-cheatsheet/#_6","text":"\u8981\u7de8\u8f2f\u4e4b\u524d\u4f7f\u7528 Ansible Vault \u52a0\u5bc6\u7684\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u8acb\u904b\u884c\uff1a $ ansible-vault edit credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u9078\u64c7\u7684\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u60a8\u7684\u9ed8\u8a8d\u547d\u4ee4\u884c\u7de8\u8f2f\u5668\u5c07\u6253\u958b\u6587\u4ef6\u7684\u672a\u52a0\u5bc6\u5167\u5bb9\uff0c\u5141\u8a31\u60a8\u9032\u884c\u66f4\u6539\u3002\u5b8c\u6210\u5f8c\uff0c\u60a8\u53ef\u4ee5\u7167\u5e38\u4fdd\u5b58\u548c\u95dc\u9589\u6587\u4ef6\uff0c\u66f4\u65b0\u7684\u5167\u5bb9\u5c07\u4fdd\u5b58\u70ba\u52a0\u5bc6\u6578\u64da\u3002","title":"\u7de8\u8f2f\u52a0\u5bc6\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#_7","text":"\u5982\u679c\u60a8\u5e0c\u671b\u5c07\u4ee5\u524d\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u7684\u6587\u4ef6\u6c38\u4e45\u9084\u539f\u70ba\u5176\u672a\u52a0\u5bc6\u7248\u672c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u8a9e\u6cd5\u57f7\u884c\u6b64\u64cd\u4f5c\uff1a $ ansible-vault decrypt credentials.yml \u9019\u5c07\u63d0\u793a\u60a8\u63d0\u4f9b\u9996\u6b21\u4f7f\u7528 ansible-vault \u52a0\u5bc6\u6587\u4ef6 credentials.yml \u6642\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u5bc6\u78bc\u9a57\u8b49\u5f8c\uff0c\u6587\u4ef6\u5167\u5bb9\u5c07\u4f5c\u70ba\u672a\u52a0\u5bc6\u6578\u64da\u4fdd\u5b58\u5230\u78c1\u76e4\u3002","title":"\u89e3\u5bc6\u52a0\u5bc6\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#vault","text":"Ansible \u652f\u6301\u6309\u4e0d\u540c\u4fdd\u7ba1\u5eab ID \u5206\u7d44\u7684\u591a\u500b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5982\u679c\u60a8\u60f3\u70ba\u4e0d\u540c\u7684\u74b0\u5883\uff08\u4f8b\u5982\u958b\u767c\u3001\u6e2c\u8a66\u548c\u751f\u7522\u74b0\u5883\uff09\u4f7f\u7528\u5c08\u7528\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\uff0c\u9019\u5c07\u975e\u5e38\u6709\u7528\u3002 \u8981\u4f7f\u7528\u81ea\u5b9a\u7fa9\u4fdd\u7ba1\u5eab ID \u5275\u5efa\u65b0\u7684\u52a0\u5bc6\u6587\u4ef6\uff0c\u8acb\u5305\u62ec --vault-id \u9078\u9805\u4ee5\u53ca\u6a19\u7c64\u548c ansible-vault \u53ef\u4ee5\u627e\u5230\u8a72\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u7684\u4f4d\u7f6e\u3002\u6a19\u7c64\u53ef\u4ee5\u662f\u4efb\u4f55\u6a19\u8b58\u7b26\uff0c\u4e26\u4e14\u4f4d\u7f6e\u53ef\u4ee5\u662f\u63d0\u793a\u7b26\uff0c\u9019\u610f\u5473\u8457\u8a72\u547d\u4ee4\u61c9\u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff0c\u6216\u5bc6\u78bc\u6587\u4ef6\u7684\u6709\u6548\u8def\u5f91\u3002 $ ansible-vault create --vault-id dev@prompt credentials_dev.yml \u9019\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dev \u7684\u65b0\u4fdd\u7ba1\u5eab ID\uff0c\u5b83\u4f7f\u7528\u63d0\u793a\u7b26\u4f5c\u70ba\u5bc6\u78bc\u6e90\u3002\u901a\u904e\u5c07\u6b64\u65b9\u6cd5\u8207\u7d44\u8b8a\u91cf\u6587\u4ef6\u76f8\u7d50\u5408\uff0c\u60a8\u5c07\u80fd\u5920\u70ba\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u64c1\u6709\u55ae\u7368\u7684 ansible \u4fdd\u96aa\u5eab\uff1a $ ansible-vault create --vault-id prod@prompt credentials_prod.yml \u6211\u5011\u4f7f\u7528 dev \u548c prod \u4f5c\u70ba\u6587\u4ef6\u5eab ID \u4f86\u6f14\u793a\u5982\u4f55\u70ba\u6bcf\u500b\u74b0\u5883\u5275\u5efa\u55ae\u7368\u7684\u6587\u4ef6\u5eab\uff0c\u4f46\u60a8\u53ef\u4ee5\u5275\u5efa\u4efb\u610f\u6578\u91cf\u7684\u6587\u4ef6\u5eab\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u4efb\u4f55\u6a19\u8b58\u7b26\u4f5c\u70ba\u6587\u4ef6\u5eab ID\u3002 \u73fe\u5728\u8981\u67e5\u770b\u3001\u7de8\u8f2f\u6216\u89e3\u5bc6\u9019\u4e9b\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u63d0\u4f9b\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\u4ee5\u53ca ansible-vault \u547d\u4ee4\uff1a $ ansible-vault edit credentials_dev.yml --vault-id dev@prompt","title":"\u4f7f\u7528\u591a\u500b Vault \u5bc6\u78bc"},{"location":"ansible/ansible-cheatsheet/#_8","text":"\u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u7b2c\u4e09\u65b9\u5de5\u5177\u901a\u904e Ansible \u81ea\u52d5\u914d\u7f6e\u670d\u52d9\u5668\u7684\u904e\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u4f86\u63d0\u4f9b\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u800c\u4e0d\u88ab\u63d0\u793a\u8f38\u5165\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u4f7f\u7528\u5e36\u6709 ansible-vault \u7684\u5bc6\u78bc\u6587\u4ef6\u4f86\u505a\u5230\u9019\u4e00\u9ede\u3002 \u5bc6\u78bc\u6587\u4ef6\u53ef\u4ee5\u662f\u7d14\u6587\u672c\u6587\u4ef6\u6216\u53ef\u57f7\u884c\u8173\u672c\u3002\u5982\u679c\u6587\u4ef6\u662f\u53ef\u57f7\u884c\u8173\u672c\uff0c\u5247\u6b64\u8173\u672c\u751f\u6210\u7684\u8f38\u51fa\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002\u5426\u5247\uff0c\u6587\u4ef6\u7684\u539f\u59cb\u5167\u5bb9\u5c07\u7528\u4f5c\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u3002 \u8981\u5728 ansible-vault \u4e2d\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c\u4efb\u4f55 vault \u547d\u4ee4\u6642\u63d0\u4f9b\u5bc6\u78bc\u6587\u4ef6\u7684\u8def\u5f91\uff1a $ ansible-vault create --vault-id dev@path/to/passfile credentials_dev.yml \u53ea\u8981\u8f38\u5165\u7684\u5bc6\u78bc\u76f8\u540c\uff0cAnsible \u4e0d\u6703\u5340\u5206\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u7684\u5167\u5bb9\u6216\u5bc6\u78bc\u6587\u4ef6\u4f5c\u70ba\u5bc6\u78bc\u6e90\u7684\u5167\u5bb9\u3002\u5be6\u969b\u4e0a\uff0c\u9019\u610f\u5473\u8457\u53ef\u4ee5\u4f7f\u7528\u63d0\u793a\u52a0\u5bc6\u6587\u4ef6\uff0c\u7136\u5f8c\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u5b58\u5132\u8207\u63d0\u793a\u65b9\u6cd5\u4f7f\u7528\u7684\u76f8\u540c\u5bc6\u78bc\u3002\u53cd\u4e4b\u4ea6\u7136\uff1a\u60a8\u53ef\u4ee5\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u52a0\u5bc6\u5167\u5bb9\uff0c\u7136\u5f8c\u4f7f\u7528\u63d0\u793a\u65b9\u6cd5\uff0c\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u76f8\u540c\u7684\u5bc6\u78bc\u3002 \u70ba\u4e86\u63d0\u9ad8\u9748\u6d3b\u6027\u548c\u5b89\u5168\u6027\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Python \u8173\u672c\u5f9e\u5176\u4ed6\u4f86\u6e90\u7372\u53d6\u5bc6\u78bc\uff0c\u800c\u4e0d\u662f\u5c07\u60a8\u7684\u4fdd\u7ba1\u5eab\u5bc6\u78bc\u5b58\u5132\u5728\u7d14\u6587\u672c\u6587\u4ef6\u4e2d\u3002\u5b98\u65b9 Ansible \u5b58\u5132\u5eab\u5305\u542b\u4e00\u4e9b Vault \u8173\u672c\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5728\u5275\u5efa\u9069\u5408\u9805\u76ee\u7279\u5b9a\u9700\u6c42\u7684\u81ea\u5b9a\u7fa9\u8173\u672c\u6642\u53c3\u8003\u9019\u4e9b\u793a\u4f8b\u3002","title":"\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6"},{"location":"ansible/ansible-cheatsheet/#ansible-vault_1","text":"\u6bcf\u7576\u60a8\u904b\u884c\u4f7f\u7528\u5148\u524d\u901a\u904e ansible-vault \u52a0\u5bc6\u7684\u6578\u64da\u7684 playbook \u6642\uff0c\u60a8\u90fd\u9700\u8981\u5411 playbook \u547d\u4ee4\u63d0\u4f9b vault \u5bc6\u78bc\u3002 \u5982\u679c\u60a8\u5728\u52a0\u5bc6\u6b64 playbook \u4e2d\u4f7f\u7528\u7684\u6578\u64da\u6642\u4f7f\u7528\u4e86\u9ed8\u8a8d\u9078\u9805\u548c\u63d0\u793a\u5bc6\u78bc\u6e90\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u9078\u9805 --ask-vault-pass \u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u5bc6\u78bc\uff1a $ ansible-playbook myplaybook.yml --ask-vault-pass \u5982\u679c\u60a8\u4f7f\u7528\u5bc6\u78bc\u6587\u4ef6\u800c\u4e0d\u662f\u63d0\u793a\u8f38\u5165\u5bc6\u78bc\uff0c\u5247\u61c9\u4f7f\u7528\u9078\u9805 --vault-password-file \u4ee3\u66ff\uff1a $ ansible-playbook myplaybook.yml --vault-password-file my_vault_password.py \u5982\u679c\u60a8\u4f7f\u7528\u5728\u4fdd\u7ba1\u5eab ID \u4e0b\u52a0\u5bc6\u7684\u6578\u64da\uff0c\u5247\u9700\u8981\u63d0\u4f9b\u8207\u9996\u6b21\u52a0\u5bc6\u6578\u64da\u6642\u76f8\u540c\u7684\u4fdd\u7ba1\u5eab ID \u548c\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@prompt \u5982\u679c\u4f7f\u7528\u5e36\u6709\u60a8\u7684\u4fdd\u7ba1\u5eab ID \u7684\u5bc6\u78bc\u6587\u4ef6\uff0c\u60a8\u61c9\u8a72\u63d0\u4f9b\u6a19\u7c64\uff0c\u5f8c\u8ddf\u5bc6\u78bc\u6587\u4ef6\u7684\u5b8c\u6574\u8def\u5f91\u4f5c\u70ba\u5bc6\u78bc\u6e90\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py \u5982\u679c\u60a8\u7684\u904a\u6232\u4f7f\u7528\u591a\u500b\u4fdd\u96aa\u5eab\uff0c\u60a8\u61c9\u8a72\u70ba\u6bcf\u500b\u4fdd\u96aa\u5eab\u63d0\u4f9b\u4e00\u500b --vault-id \u53c3\u6578\uff0c\u6c92\u6709\u7279\u5b9a\u7684\u9806\u5e8f\uff1a $ ansible-playbook myplaybook.yml --vault-id dev@vault_password.py --vault-id test@prompt --vault-id ci@prompt","title":"\u904b\u884c\u901a\u904e Ansible Vault \u52a0\u5bc6\u6578\u64da\u7684\u5287\u672c"},{"location":"ansible/ansible-cheatsheet/#_9","text":"\u5982\u679c\u60a8\u5728\u57f7\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u9047\u5230\u932f\u8aa4\uff0c\u6700\u597d\u589e\u52a0\u8f38\u51fa\u8a73\u7d30\u7a0b\u5ea6\u4ee5\u7372\u53d6\u6709\u95dc\u554f\u984c\u7684\u66f4\u591a\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u5305\u542b -v \u9078\u9805\u4f86\u505a\u5230\u9019\u4e00\u9ede\uff1a $ ansible-playbook myplaybook.yml -v \u5982\u679c\u60a8\u9700\u8981\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528 -vvv\uff0c\u9019\u5c07\u589e\u52a0\u8f38\u51fa\u7684\u8a73\u7d30\u7a0b\u5ea6\u3002\u5982\u679c\u60a8\u7121\u6cd5\u901a\u904e Ansible \u9023\u63a5\u5230\u9060\u7a0b\u7bc0\u9ede\uff0c\u8acb\u4f7f\u7528 -vvvv \u7372\u53d6\u9023\u63a5\u8abf\u8a66\u4fe1\u606f\uff1a $ ansible-playbook myplaybook.yml -vvvv","title":"\u8abf\u8a66"},{"location":"ansible/ansible-cheatsheet/#_10","text":"\u672c\u6307\u5357\u6db5\u84cb\u4e86\u60a8\u5728\u914d\u7f6e\u670d\u52d9\u5668\u6642\u53ef\u80fd\u4f7f\u7528\u7684\u4e00\u4e9b\u6700\u5e38\u898b\u7684 Ansible \u547d\u4ee4\uff0c\u4f8b\u5982\u5982\u4f55\u5728\u7bc0\u9ede\u4e0a\u57f7\u884c\u9060\u7a0b\u547d\u4ee4\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5404\u7a2e\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u904b\u884c playbook\u3002 \u60a8\u53ef\u80fd\u6703\u767c\u73fe\u5176\u4ed6\u547d\u4ee4\u8b8a\u9ad4\u548c\u6a19\u8a8c\u5c0d\u60a8\u7684 Ansible \u5de5\u4f5c\u6d41\u7a0b\u5f88\u6709\u7528\u3002\u8981\u7372\u5f97\u6240\u6709\u53ef\u7528\u9078\u9805\u7684\u6982\u89bd\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5e6b\u52a9\u547d\u4ee4\uff1a $ ansible --help \u5982\u679c\u60a8\u60f3\u66f4\u5168\u9762\u5730\u4e86\u89e3 Ansible \u53ca\u5176\u6240\u6709\u53ef\u7528\u547d\u4ee4\u548c\u529f\u80fd\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94\u3002 \u5982\u679c\u60a8\u60f3\u67e5\u770b Ansible \u7684\u53e6\u4e00\u500b\u5be6\u969b\u793a\u4f8b\uff0c\u8acb\u67e5\u770b\u6211\u5011\u95dc\u65bc\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u6307\u5357\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/ansible-intro/","text":"\u4f7f\u7528 Ansible \u90e8\u7f72\u74b0\u5883 \u00b6 \u5728\u6211\u5011\u6210\u529f\u5229\u7528 Vagrant \u6a21\u64ec\u51fa\u6240\u9700\u7684\u74b0\u5883\u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528 Ansible \u9019\u5957\u81ea\u52d5\u5316\u5de5\u5177\u4f86\u9032\u884c\u90e8\u7f72\u4e86\u3002 Ansible \u4ecb\u7d39 \u00b6 Ansible \u662f\u4ec0\u9ebc\uff1f \u00b6 \u76f8\u4fe1\u5927\u5bb6\u61c9\u8a72\u90fd\u6709\u904e\u91cd\u704c\u96fb\u8166\u7684\u7d93\u9a57\u3002\u6bcf\u4e00\u6b21\u5728\u96fb\u8166\u91cd\u65b0\u5b89\u88dd\u5f8c\uff0c\u6211\u5011\u90fd\u9700\u8981\u82b1\u5927\u91cf\u7684\u6642\u9593\u628a\u5e73\u5e38\u5e38\u7528\u7684\u8edf\u9ad4\u4e00\u4e00\u91cd\u65b0\u88dd\u4e0a\uff0c\u6709\u4e9b\u8edf\u9ad4\u53ef\u80fd\u9084\u8981\u9032\u884c\u500b\u5225\u7684\u5fae\u8abf\uff0c\u800c\u9019\u6a23\u7e41\u7463\u7684\u6b65\u9a5f\u540c\u6a23\u4e5f\u6703\u767c\u751f\u5728\u8edf\u9ad4\u90e8\u7f72\u7684\u4f3a\u670d\u5668\u4e0a\u3002 \u70ba\u4e86\u904b\u884c\u958b\u767c\u51fa\u4f86\u7684\u8edf\u9ad4\uff0c\u958b\u767c\u4eba\u54e1\u5011\u5f80\u5f80\u9700\u8981\u8981\u82b1\u8cbb\u5927\u91cf\u7684\u6642\u9593\u5728\u4f3a\u670d\u5668\u4e0a\u5b89\u88dd\u6240\u6709\u6240\u9700\u7684\u5957\u4ef6 (packages) \u6216\u662f\u670d\u52d9\u4f9d\u8cf4 (dependency)\uff0c\u800c\u5728\u5b89\u88dd\u7684\u904e\u7a0b\u4e2d\u82e5\u6709\u758f\u5ffd\uff0c\u9084\u5f88\u6709\u53ef\u80fd\u9020\u6210\u90e8\u7f72\u7a0b\u5f0f\u767c\u751f\u7121\u9810\u671f\u7684\u932f\u8aa4\u3002\u56e0\u6b64\uff0c\u81ea\u52d5\u5316\u5c31\u662f\u56e0\u70ba\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u7a2e\u6982\u5ff5\u3002 \u82e5\u6211\u5011\u53ef\u4ee5\u5c07\u6bcf\u4e00\u6b21\u90e8\u7f72\u7684\u6b65\u9a5f\u5beb\u6210\u4e00\u500b\u81ea\u52d5\u5316\u7684\u6a19\u6e96\u4f5c\u696d\u7a0b\u5e8f (Standard Operating Procedures, SOP)\uff0c\u9664\u4e86\u53ef\u4ee5\u6709\u6548\u7e2e\u77ed\u6bcf\u6b21\u7684\u90e8\u7f72\u6642\u9593\u53ca\u964d\u4f4e\u51fa\u932f\u7387\u5916\uff0c\u5728\u672a\u4f86\u9700\u8981\u5347\u7d1a\u90e8\u7f72\u74b0\u5883\uff0c\u4e5f\u6703\u76f8\u5c0d\u5bb9\u6613\u8a31\u591a\u3002\u800c Ansible \u5c31\u662f\u76ee\u524d\u696d\u754c\u6700\u5e38\u4f7f\u7528\u7684\u81ea\u52d5\u5316\u5de5\u5177\u4e4b\u4e00\u3002 \u70ba\u4ec0\u9ebc\u8981\u9078\u64c7 Ansible\uff1f \u00b6 \u76ee\u524d\u696d\u754c\u4e2d\u4e3b\u6d41\u7684\u81ea\u52d5\u5316\u90e8\u7f72\u5de5\u5177\u9664\u4e86 Ansible \u4e4b\u5916\u9084\u6709 Chef\u3001Otter\u3001Puppet\u3001SaltStack \u7b49\u7b49\u3002\u6bcf\u4e00\u500b\u9663\u71df\u90fd\u6709\u5927\u91cf\u7684\u64c1\u8b77\u8005\u4ee5\u53ca\u5404\u81ea\u7684\u512a\u7f3a\u9ede\uff0c\u5176\u5be6\u5728\u9019\u500b\u554f\u984c\u4e0a\u4e26\u6c92\u6709\u8ab0\u7d55\u5c0d\u512a\u65bc\u8ab0\u7684\u7b54\u6848\u3002\u4e4b\u6240\u4ee5\u9078\u64c7 Ansible \u4f5c\u70ba\u81ea\u52d5\u5316\u7684\u5de5\u5177\uff0c\u4e3b\u8981\u539f\u56e0\u662f\u56e0\u70ba Ansible \u771f\u7684\u5bb9\u6613\u5b78\u7fd2\u8a31\u591a\u3002\u5728\u9078\u64c7\u5de5\u5177\u7684\u904e\u7a0b\u4e2d\uff0c\u6211\u76f8\u4fe1\u6700\u91cd\u8981\u7684\u8003\u91cf\u61c9\u8a72\u5728\u65bc\u6211\u5011\u80fd\u4e0d\u80fd\u5920\u5728\u6700\u77ed\u7684\u6642\u9593\u5167\u638c\u63e1\u9019\u500b\u5de5\u5177\u4e26\u6709\u6548\u5730\u89e3\u6c7a\u6211\u5011\u6240\u9047\u5230\u7684\u554f\u984c\u3002 \u5728\u9019\u6a23\u7684\u524d\u63d0\u4e0b\uff0cAnsible \u5c31\u6210\u70ba\u8a31\u591a\u958b\u767c\u5718\u968a\u7684\u9996\u9078\u4e86\u3002\u9664\u4e86\u5bb9\u6613\u5b78\u7fd2\u4e4b\u5916\uff0cAnsible \u672c\u8eab\u5728 GitHub \u4e0a\u4e5f\u662f\u4e00\u500b\u958b\u6e90\u7684\u5c08\u6848\u3002\u6709\u4e86\u5927\u91cf\u958b\u767c\u4eba\u54e1\u7684\u5e6b\u52a9\u53ca\u56de\u994b\uff0cAnsible \u9019\u5957\u8edf\u9ad4\u7684\u6210\u9577\u901f\u5ea6\u5176\u5be6\u662f\u771f\u7684\u76f8\u7576\u9a5a\u4eba\u7684\u3002 Ansible \u7684\u9700\u6c42 \u00b6 \u7531\u65bc Ansible \u662f\u4f7f\u7528 Python \u958b\u767c\u7684\u4e00\u5957\u514d\u8cbb\u8edf\u9ad4\uff0c\u8981\u900f\u904e Ansible \u5728\u9059\u63a7\u7bc0\u9ede (remote node) \u4e0a\u914d\u7f6e\u74b0\u5883\uff0c\u552f\u4e8c\u7684\u689d\u4ef6\u53ea\u6709\uff1a \u5b89\u88dd Python \u900f\u904e SSH \u9032\u884c\u9023\u7dda \u5728\u73fe\u5728\u5927\u90e8\u5206\u7684 Linux \u4e3b\u6a5f\u4e0a\uff0c\u57fa\u672c\u4e0a Python \u5df2\u7d93\u90fd\u662f\u57fa\u672c\u914d\u5099\u4e86\uff0c\u6240\u4ee5\u9019\u6a23\u7684\u8981\u6c42\u7b49\u65bc\u6c92\u6709\u8981\u6c42\u3002\u6211\u5011\u53ea\u9700\u8981\u5728\u5b89\u88dd\u597d Ansible \u7684\u4e3b\u6a5f (control machine) \u4e0a\u900f\u904e SSH \u8207\u9059\u63a7\u7bc0\u9ede\u6e9d\u901a\uff0c\u5c31\u53ef\u4ee5\u8f15\u9b06\u505a\u5230\u4e00\u9375\u90e8\u7f72\uff01 Ansible \u5b89\u88dd \u00b6 \u5728 Ansible \u88e1\uff0c\u6703\u628a\u6240\u6709\u6a5f\u5668\u7684\u89d2\u8272\u505a\u4ee5\u4e0b\u5169\u7a2e\u5340\u5206\uff1a \u63a7\u5236\u4e3b\u6a5f (Control Machine) \uff1a\u9867\u540d\u601d\u7fa9\uff0c\u9019\u985e\u4e3b\u6a5f\u53ef\u4ee5\u900f\u904e\u904b\u884c Ansible \u7684\u5287\u672c (playbook) \u5c0d\u7ba1\u7406\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u3002 \u7ba1\u7406\u7bc0\u9ede (Managed Node) \uff1a\u4e5f\u7a31\u70ba\u9059\u63a7\u7bc0\u9ede (Remote Node)\u3002\u76f8\u5c0d\u65bc\u63a7\u5236\u4e3b\u6a5f\uff0c\u9019\u985e\u7bc0\u9ede\u5c31\u662f\u6211\u5011\u900f\u904e Ansible \u9032\u884c\u90e8\u7f72\u7684\u5c0d\u8c61\u3002 \u5c0d\u65bc\u9019\u5169\u7a2e\u4e0d\u540c\u7684\u5c0d\u8c61\uff0c\u5728\u5b89\u88dd / \u4f7f\u7528 Ansible \u7684\u6642\u5019\u4e5f\u6709\u4e0d\u540c\u7684\u9700\u6c42\u3002 \u5b89\u88dd Ansible \u5728\u63a7\u5236\u4e3b\u6a5f \u00b6 \u7531\u65bc Ansible \u662f\u4e00\u5957\u958b\u6e90\u7684\u8edf\u9ad4\uff0c\u6240\u4ee5\u5728\u76ee\u524d\u5927\u90e8\u5206\u7684\u4e3b\u6d41\u4f5c\u696d\u7cfb\u7d71\u4e0a\u90fd\u5df2\u7d93\u53ef\u4ee5\u900f\u904e\u5c0d\u61c9\u7684\u5957\u4ef6\u7ba1\u7406 (package manager) \u9032\u884c\u5b89\u88dd\u4e86\u3002\u4ee5\u4e0b\u5217\u51fa\u5e7e\u500b\u6211\u4e3b\u8981\u6bd4\u8f03\u5e38\u7528\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u65b9\u6cd5\uff1a Ubuntu CentOS/RHEL $ sudo apt update $ sudo apt install software-properties-common $ sudo add-apt-repository --yes --update ppa:ansible/ansible $ sudo apt install ansible $ sudo yum install epel-release $ sudo yum install ansible \u5b89\u88dd\u597d\u4ee5\u5f8c\uff0c\u78ba\u8a8d Ansible \u5df2\u7d93\u5b89\u88dd\u5b8c\u6210\uff1a $ ansible --version ansible [ core 2 .12.7 ] config file = /etc/ansible/ansible.cfg configured module search path = [ '/home/dxlab/.ansible/plugins/modules' , '/usr/share/ansible/plugins/modules' ] ansible python module location = /usr/lib/python3/dist-packages/ansible ansible collection location = /home/dxlab/.ansible/collections:/usr/share/ansible/collections executable location = /usr/bin/ansible python version = 3 .10.4 ( main, Jun 29 2022 , 12 :14:53 ) [ GCC 11 .2.0 ] jinja version = 3 .0.3 libyaml = True \u5b89\u88dd Ansible \u5728\u7ba1\u7406\u7bc0\u9ede \u00b6 \u4e0d\u9700\u8981\uff01\u900f\u904e Ansible \u7ba1\u7406\u7684\u7ba1\u7406\u7bc0\u9ede\u5b8c\u5168\u4e0d\u9700\u8981\u5b89\u88dd Ansible\u3002\u5982\u4e0a\u500b\u7ae0\u7bc0\u6240\u8ff0\uff0c\u6211\u5011\u53ea\u9700\u8981\u78ba\u4fdd\u9019\u500b\u7ba1\u7406\u7bc0\u9ede\u53ef\u4ee5\u900f\u904e SSH \u8207\u63a7\u5236\u4e3b\u6a5f\u6e9d\u901a\uff0c\u4e26\u5df2\u5b89\u88dd Python 2.6 \u4ee5\u4e0a\u7684\u7248\u672c\u5c31\u53ef\u4ee5\u900f\u904e\u63a7\u5236\u4e3b\u6a5f\u7ba1\u7406\u4e86\u3002 \u5b89\u88dd Ansible-lint \u00b6 \u5728\u7de8\u5beb\u7a0b\u5f0f/\u8173\u672c\u7684\u6642\u5019\uff0c\u6211\u90fd\u6703\u7fd2\u6163\u53bb\u627e\u5c0d\u61c9\u8a9e\u8a00\u7684 linter \u4f86\u7fd2\u6163\u8a72\u8a9e\u8a00\u7684\u98a8\u683c\u3002\u96d6\u7136 Ansbile \u4e26\u4e0d\u662f\u4e00\u7a2e\u7a0b\u5f0f\u8a9e\u8a00\uff0c\u4f46\u5b83\u4e5f\u6709\u4e00\u500b\u5c0d\u61c9\u7684 linter - Ansible-lint\u3002\u6211\u6703\u5efa\u8b70\u5927\u5bb6\u53ef\u4ee5\u5b89\u88dd\u9019\u500b\u5c0f\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u5e6b\u52a9\u4f60\u78ba\u4fdd\u5beb\u51fa\u4f86\u7684\u8173\u672c\u54c1\u8cea\u662f\u6709\u4e00\u5b9a\u6c34\u6e96\u7684\u3002 sudo pip install ansible-lint \u6aa2\u67e5\uff1a ansible-lint 6.2.1 using ansible 2.12.6 \u64b0\u5beb\u7b2c\u4e00\u500b Playbook \u00b6 \u7576\u78ba\u8a8d Ansible \u5df2\u7d93\u6b63\u78ba\u5730\u5b89\u88dd\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4e4b\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u5c31\u53ef\u4ee5\u6e96\u5099\u900f\u904e Ansible \u5c0d\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u4e86\u3002\u7136\u800c\uff0c\u6211\u5011\u8981\u5982\u4f55\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u5c0d\u9059\u63a7\u7bc0\u9ede\u505a\u4e9b\u4ec0\u9ebc\u5462\uff1f\u5728 Ansible \u7684\u4e16\u754c\u88e1\uff0c\u6211\u5011\u662f\u900f\u904e\u7de8\u5beb \u5287\u672c (playbook) \u4f86\u544a\u8a34 Ansible \u63a5\u4e0b\u4f86\u9700\u8981\u505a\u7684\u4e8b\u9805\u3002 \u7531\u65bc Ansible \u7684\u5287\u672c\u662f\u7528 YAML (YAML Ain't Markup Language) \u9019\u7a2e\u8a9e\u8a00\u4f86\u64b0\u5beb\uff0c\u800c\u9019\u500b\u8a9e\u8a00\u6700\u5927\u7684\u7279\u8272\u5c31\u662f\u5177\u6709\u9ad8\u5ea6\u53ef\u8b80\u6027\uff0c\u56e0\u6b64\u7121\u8ad6\u6709\u6c92\u6709\u7a0b\u5f0f\u8a9e\u8a00\u7684\u57fa\u790e\uff0c\u7406\u8ad6\u4e0a\u4efb\u4f55\u4eba\u5728\u770b\u5230\u4e00\u4efd\u597d\u7684 Ansible playbook \u7684\u6642\u5019\u61c9\u8a72\u90fd\u662f\u975e\u5e38\u5bb9\u6613\u7406\u89e3\u53ca\u8457\u624b\u4fee\u6539\u7dad\u8b77\u7684\u3002 \u7b2c\u4e00\u500b playbook \u00b6 \u4ee5\u4e0b\u5148\u7528\u4e00\u500b\u975e\u5e38\u7c21\u55ae\u7684\u7bc4\u4f8b\u4f86\u4ecb\u7d39 playbook \u7684\u904b\u4f5c\u65b9\u5f0f\u3002\u6211\u5011\u5148\u5275\u5efa\u4e00\u500b playbook \u6a94\u6848\uff0c\u5c07\u5176\u547d\u540d\u70ba playbook.yml \u4e26\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u4e0b (e.g. vagrant_getting_started/playbook.yml)\u3002\u63a5\u8457\uff0c\u958b\u555f\u6a94\u6848\u4e26\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u76f8\u4fe1\u5927\u5bb6\u5c31\u7b97\u5f9e\u4f86\u6c92\u6709\u5beb\u904e Ansible \u7684 playbook\uff0c\u61c9\u8a72\u9084\u662f\u4e0d\u96e3\u731c\u51fa\u9019\u4efd playbook \u5728\u505a\u4e9b\u4ec0\u9ebc\u3002\u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u5728\u9019\u4efd playbook \u4e2d\u5b9a\u7fa9\u4e86\u4efb\u52d9\u6e05\u55ae tasks \u4ee5\u53ca\u90e8\u7f72\u5c0d\u8c61 hosts: sre001 \u3002 \u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u5728\u4e4b\u524d\u7684\u7ae0\u7bc0\u4e2d\u6211\u5011\u63d0\u5230\u4e86\u6700\u597d\u628a\u6bcf\u4e00\u500b\u865b\u64ec\u4e3b\u6a5f\u90fd\u505a\u547d\u540d\u3002\u4e3b\u6a5f\u547d\u540d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u900f\u904e\u4e3b\u6a5f\u7684\u540d\u7a31\u76f4\u63a5\u9032\u884c\u64cd\u4f5c\uff08\u6211\u5011\u6703\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u63d0\u5230\u82e5\u4e0d\u900f\u904e Vagrant \u8981\u5982\u4f55\u547d\u540d\u4e3b\u6a5f\uff09\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e name \u9019\u500b\u6a19\u7c64\u66ff\u4efb\u52d9\u6e05\u55ae\u4e2d\u7684\u6bcf\u500b task \u5206\u5225\u547d\u540d\u3002\u5728\u63a5\u4e0b\u4f86\u904b\u884c playbook \u7684\u904e\u7a0b\u4e2d\u82e5\u767c\u751f\u932f\u8aa4\uff0c\u6211\u5011\u4e5f\u6703\u6bd4\u8f03\u6e05\u695a\u662f\u5728\u54ea\u4e00\u500b\u74b0\u7bc0\u4e0a\u51fa\u4e86\u554f\u984c\u3002 \u5728\u9019\u500b playbook \u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u5169\u500b task\uff1a 1. test connection Info \u6211\u5011\u5728\u9019\u500b task \u4e2d\uff0c\u547c\u53eb\u4e86 Ansible \u7684\u5167\u5efa\u6e2c\u8a66\u6a21\u7d44 (module) - ping \u3002\u9019\u500b\u6a21\u7d44\u7684\u76ee\u7684\u975e\u5e38\u985e\u4f3c\u5728\u5b78\u7fd2\u6bcf\u500b\u8a9e\u8a00\u4e00\u958b\u59cb\u7df4\u7fd2\u7684 \"Hello World\" \u7a0b\u5f0f\u3002\u5176\u4e3b\u8981\u662f\u7528\u4f86\u6e2c\u8a66\u64cd\u63a7\u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u6b63\u78ba\u5730\u8207\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u6e9d\u901a\uff0c\u5982\u679c\u9023\u7dda\u6b63\u5e38\uff0c\u9059\u63a7\u7bc0\u9ede\u5c31\u6703\u56de\u50b3\u4e00\u500b \"pong\" \u7684\u8a0a\u606f\u7d66\u63a7\u5236\u4e3b\u6a5f\u3002\u63a5\u8457\uff0c\u6211\u5011\u900f\u904e\u53e6\u4e00\u500b Ansible \u5167\u5efa\u6a21\u7d44 - register \u628a\u9059\u63a7\u7bc0\u9ede\u56de\u50b3\u7684\u8a0a\u606f\u5b58\u6210\u8b8a\u6578 (variable) \u7684\u5f62\u5f0f\u3002 \u6ce8\u610f\uff1a\u6b64\u8655\u7684 ping \u4e26\u975e\u5efa\u7acb\u5728 ICMP \u5354\u5b9a\u4e0b\u7684 ping \u6307\u4ee4\uff0c\u53ea\u662f\u7d14 Ansible \u958b\u767c\u7684\u4e00\u500b\u7c21\u55ae\u6e2c\u8a66\u6a21\u7d44\u3002 \u6a21\u7d44: ansible.builtin.ping 2. print debug message Info \u5728\u4e0a\u4e00\u500b task \u4e2d\uff0c\u6211\u5011\u5df2\u7d93\u628a ping \u5f8c\u7684\u7d50\u679c\u5b58\u5728 message \u9019\u500b\u8b8a\u6578\u4e2d\u4e86\u3002\u6211\u5011\u53ef\u4ee5\u5229\u7528 debug \u9019\u500b\u6a21\u7d44\u628a\u5132\u5b58\u7684\u8a0a\u606f\u8f38\u51fa\u5230\u6211\u5011\u7684\u7d42\u7aef\u6a5f\u4e0a\u3002\u5728 Ansible \u4e2d\uff0c\u82e5\u8981\u8abf\u7528\u5132\u5b58\u8b8a\u6578\uff0c\u6211\u5011\u5fc5\u9808\u5728\u8b8a\u6578\u540d\u7a31\u5916\u52a0\u4e0a\u5169\u500b\u5927\u62ec\u5f27 - {{ }} \u4f86\u544a\u8a34 Ansible \u5927\u62ec\u5f27\u5167\u7684\u662f\u4e00\u500b\u8b8a\u6578 \uff08\u5982\u679c\u8b8a\u6578\u5728\u63cf\u8ff0\u53e5 (statement) \u7684\u958b\u982d\uff0c\u9084\u5fc5\u9808\u8981\u984d\u5916\u52a0\u4e0a\u4e00\u500b\u96d9\u5f15\u865f - \"\"\uff09\u3002 \u6a21\u7d44: ansible.builtin.debug \u6aa2\u67e5 playbook \u00b6 \u5229\u7528 Ansible-lint \u4f86\u6aa2\u67e5 playbook: $ ansible-lint playbook.yml \u5982\u679c\u6c92\u6709\u770b\u5230\u4efb\u4f55\u8f38\u51fa\u5c31\u8868\u793a\u4f60\u7684 playbook \u5b8c\u5168\u6c92\u6709\u554f\u984c\uff01\u4e0d\u904e\u70ba\u4e86\u5c55\u793a Ansible-lint \u7684\u63d0\u793a\u6548\u679c\uff0c\u6211\u5728 playbook \u7684\u7b2c\u4e94\u884c\u53e5\u5c3e\u52a0\u4e0a\u4e00\u500b\u7a7a\u767d\uff1a - name: test connection ~ \u63a5\u8457\uff0c\u91cd\u65b0\u8f38\u5165\u525b\u525b\u7684\u6307\u4ee4\uff1a $ ansible-lint playbook.yml WARNING Listing 1 violation ( s ) that are fatal yaml: trailing spaces ( yaml [ trailing-spaces ]) playbook.yml:5 You can skip specific rules or tags by adding them to your configuration file: # .config/ansible-lint.yml warn_list: # or 'skip_list' to silence them completely - yaml # Violations reported by yamllint. Finished with 1 failure ( s ) , 0 warning ( s ) on 1 files. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 Ansible-lint \u544a\u8a34\u6211\u5011\u5728 playbook.yml:5 \u7b2c\u4e94\u884c\u7684\u5730\u65b9\u6709\u500b\u5f8c\u7db4\u7a7a\u767d (trailing whitespace)\uff0c\u70ba\u4e86\u4fdd\u6301\u7a0b\u5f0f\u78bc\u7684\u7c21\u6f54\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u5176\u522a\u9664\u3002 \u5728\u5b9a\u7fa9\u597d\u4e86\u6211\u5011\u7684\u7b2c\u4e00\u500b playbook \u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u662f\u5982\u4f55\u904b\u884c\u6211\u5011\u5beb\u597d\u7684 playbook\u3002 \u904b\u884c playbook \u00b6 \u8981\u900f\u904e Ansible \u4f86\u904b\u884c playbook \u76f8\u7576\u5bb9\u6613\uff0c\u6211\u5011\u53ea\u8981\u4f7f\u7528 ansible-playbook \u7684\u6307\u4ee4\u5c31\u53ef\u4ee5\u8f15\u6613\u904b\u884c\u6211\u5011\u7de8\u5beb\u597d\u7684 playbook\uff1a $ ansible-playbook playbook.yml \u57f7\u884c\u5b8c\u7562\u5f8c\u6211\u5011\u61c9\u8a72\u53ef\u4ee5\u5728\u7d42\u7aef\u6a5f\u4e0a\u770b\u5230\u4ee5\u4e0b\u7684\u8f38\u51fa\uff1a [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all' [WARNING]: Could not match supplied host pattern, ignoring: sre001 PLAY [sre001] ***************************************************************************************************************************************************************** skipping: no hosts matched PLAY RECAP ******************************************************************************************************************************************************************** \u4ec0\u9ebc\u662f inventory? \u00b6 \u5728\u770b\u5230\u8f38\u51fa\u7d50\u679c\u5f8c\uff0c\u6211\u76f8\u4fe1\u5927\u90e8\u5206\u7684\u8b80\u8005\u53ef\u80fd\u6703\u7d0d\u60b6\u70ba\u4ec0\u9ebc\u8f38\u51fa\u7d50\u679c\u6c92\u6709\u4efb\u4f55\u57f7\u884c\u6210\u529f\u6216\u5931\u6557\u7684\u8cc7\u8a0a\u3002\u5f9e\u7d42\u7aef\u6a5f\u7684\u7d50\u679c\u6211\u5011\u53ef\u4ee5\u77e5\u9053 Ansible \u4ec0\u9ebc\u4efb\u52d9\u90fd\u6c92\u6709\u505a\uff0c\u9019\u6a23\u7684\u7d50\u679c\u4e5f\u4e0d\u662f\u6211\u5011\u6240\u9810\u671f\u7684\u3002\u5728\u89e3\u6c7a\u9019\u554f\u984c\u4e4b\u524d\uff0c\u8b93\u6211\u5011\u5148\u56de\u61b6\u4e00\u4e0b\u6211\u5011\u4e4b\u524d\u64b0\u5beb\u7684 playbook.yml \uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u5f9e\u9019\u4efd playbook \u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5f88\u6e05\u695a\u5730\u770b\u5230 Ansible \u61c9\u8a72\u8981\u5c0d sre001 \u9019\u53f0\u4e3b\u6a5f\u9032\u884c\u4efb\u52d9\u6e05\u55ae\u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002\u5728\u4e4b\u524d Vagrant \u4ecb\u7d39\u4e2d\uff0c\u6211\u5011\u7684\u78ba\u5c0d\u904b\u884c\u8d77\u4f86\u7684\u4e3b\u6a5f\u9032\u884c\u4e86\u547d\u540d\uff0c\u7136\u800c\uff0c\u6211\u5011\u537b\u5f9e\u4f86\u6c92\u6709\u544a\u8a34 Ansible \u904e\u54ea\u4e00\u53f0\u4e3b\u6a5f\u662f sre001 \u3002 \u56e0\u6b64\uff0c\u89e3\u6c7a\u9019\u500b\u554f\u984c\u6700\u76f4\u63a5\u7684\u65b9\u6cd5\u5c31\u662f\u5b9a\u7fa9\u4e00\u500b\u4e3b\u6a5f\u5217\u8868 inventory \u4e26\u8b93 Ansible \u53c3\u7167\uff0c\u9019\u6a23 Ansible \u624d\u6703\u77e5\u9053\u8a72\u5c0d\u8ab0\u505a\u4ec0\u9ebc\u4e8b\u3002 \u70ba\u4e86\u77e5\u9053 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u8a73\u7d30\u8cc7\u6599\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e vagrant ssh-config \u4f86\u5217\u51fa\u4e3b\u6a5f\u7684\u76f8\u95dc\u8cc7\u8a0a\uff1a $ vagrant ssh-config Host sre001 HostName 127 .0.0.1 User vagrant Port 2201 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL Tip \u6bcf\u4e00\u500b\u4eba\u7684\u56de\u61c9\u53ef\u80fd\u56e0\u500b\u4eba\u672c\u6a5f\u7684\u72c0\u6cc1\u6703\u6709\u6240\u4e0d\u540c\uff0c\u8acb\u7279\u5225\u6ce8\u610f Port \u8207 IdentifyFile \u7684\u8cc7\u8a0a\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728\u7576\u4e0b\u7684\u76ee\u9304\u4e0b\u65b0\u589e\u4e00\u500b\u6a94\u6848\u4e26\u547d\u540d\u70ba inventory . \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 Vagrantfile \u7136\u5f8c\u5728\u6a94\u6848\u5167\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a [sre001] 127.0.0.1 ansible_port=2201 ansible_user=vagrant ansible_ssh_common_args='-o StrictHostKeyChecking=no' \u6839\u64da vagrant ssh-config \u5217\u51fa\u4f86\u7684\u4e3b\u6a5f\u8cc7\u8a0a\uff0c\u6211\u5011\u5728 inventory \u4e2d\u4f9d\u5e8f\u5b9a\u7fa9\u4e86 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u9023\u7dda IP\u3001port \u5165\u53e3\u4ee5\u53ca\u767b\u5165\u4f7f\u7528\u8005\u7684\u8eab\u4efd\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u91cd\u65b0\u57f7\u884c\u904b\u884c\u6307\u4ee4\uff0c\u4e26\u5c07\u9019\u4efd\u4e3b\u6a5f\u6e05\u55ae\u6307\u5b9a\u7d66 Ansible \u53c3\u7167\uff1a $ ansible-playbook -i inventory playbook.yml \u73fe\u5728\uff0c\u8f38\u51fa\u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** fatal: [127.0.0.1]: UNREACHABLE! => {\"changed\": false, \"msg\": \"Failed to connect to the host via ssh: @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\n@ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @\\r\\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\\r\\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\\r\\nIt is also possible that a host key has just been changed.\\r\\nThe fingerprint for the ECDSA key sent by the remote host is\\nSHA256:7WcamAcB+cK5FXwfTxMiXBeovKpBFqpv4k4J6JzODYw.\\r\\nPlease contact your system administrator.\\r\\nAdd correct host key in /home/dxlab/.ssh/known_hosts to get rid of this message.\\r\\nOffending ECDSA key in /home/dxlab/.ssh/known_hosts:3\\r\\n remove with:\\r\\n ssh-keygen -f \\\"/home/dxlab/.ssh/known_hosts\\\" -R \\\"[127.0.0.1]:2201\\\"\\r\\nECDSA host key for [127.0.0.1]:2201 has changed and you have requested strict checking.\\r\\nHost key verification failed.\", \"unreachable\": true} PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=0 changed=0 unreachable=1 failed=0 skipped=0 rescued=0 ignored=0 \u73fe\u5728 Ansible \u77e5\u9053\u8ab0\u662f sre001 \u4e86\uff01\u4e0d\u904e\uff0c\u770b\u8d77\u4f86 Ansible \u4f3c\u4e4e\u4e26\u6c92\u6709\u8fa8\u6cd5\u5c07\u6211\u5011 playbook \u4e2d\u5b9a\u7fa9\u52d5\u4f5c\u6210\u529f\u5730\u90e8\u7f72\u5230 sre001 \u4e0a\u3002 \u8a2d\u5b9a PRIVATE_KEY_FILE \u00b6 \u5f9e\u4e0a\u9762\u7684\u932f\u8aa4\u8a0a\u606f (error message) \u4e2d\u6211\u5011\u53ef\u4ee5\u77e5\u9053\u90e8\u7f72\u5931\u6557\u7684\u539f\u56e0\u767c\u751f\u5728 SSH \u9023\u7dda\u5931\u6557\u3002\u9084\u8a18\u5f97\u6211\u5011\u8aaa\u904e\u4f7f\u7528 Ansible \u90e8\u7f72\u9059\u63a7\u7bc0\u9ede\u5fc5\u9808\u8981\u900f\u904e SSH \u9023\u7dda\u55ce\uff1f\u4e00\u822c\u4f86\u8aaa\uff0c\u6211\u5011\u5982\u679c\u8981\u900f\u904e SSH \u5b58\u53d6\u7db2\u7ad9\u6211\u5011\u6703\u9810\u8a2d\u5c07\u7522\u751f\u51fa\u4f86\u7684\u516c\u7528\u91d1\u9470 (public key) \u5b58\u653e\u5728 ~/.ssh/ \u7684\u8def\u5f91\u4e0b\uff0c\u7136\u5f8c\u518d\u624b\u52d5\u5c07\u9019\u7d44\u91d1\u9470\u52a0\u5230\u6211\u5011\u60f3\u8981\u6388\u6b0a\u7684\u670d\u52d9\u5217\u8868\u4e0a\u3002 \u4e0d\u904e\uff0c\u56e0\u70ba\u6211\u5011\u662f\u4f7f\u7528 Vagrant \u5efa\u7acb\u8d77\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u4f5c\u70ba\u7df4\u7fd2\uff0cVagrant \u5176\u5be6\u5df2\u7d93\u4e8b\u5148\u5e6b\u6211\u5011\u628a\u63a7\u5236\u4e3b\u6a5f\u8207\u9059\u63a7\u7bc0\u9ede\u505a\u597d SSH \u914d\u5c0d\u4e86\uff0c\u6240\u4ee5\u6211\u5011\u4e26\u4e0d\u9700\u8981\u624b\u52d5\u8a2d\u5b9a\u9019\u500b\u90e8\u5206\u3002\u5f9e\u4e0a\u9762\u7684 vagrant ssh-config \u8f38\u51fa\u7684\u7d50\u679c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u4e00\u500b\u7279\u6b8a\u7684\u53c3\u6578\uff1a IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key \u9019\u500b\u53c3\u6578\u544a\u8a34\u4e86\u6211\u5011\u9019\u53f0\u865b\u64ec\u4e3b\u6a5f private key \u7684\u5b58\u653e\u4f4d\u7f6e\uff0c\u6211\u5011\u53ea\u9700\u8981\u900f\u904e\u4ee5\u4e0b\u6307\u4ee4\uff0c\u5c07\u9019\u500b\u6a94\u6848\u7684\u8def\u5f91\u6307\u5b9a\u7d66 Ansible\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6210\u529f\u904b\u884c\u6211\u5011\u7684 playbook \u56c9\uff01 $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u904b\u884c\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [test connection] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [print debug message] **************************************************************************************************************************************************** ok: [127.0.0.1] => { \"msg\": { \"changed\": false, \"failed\": false, \"ping\": \"pong\" } } PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6210\u529f\u63a5\u6536\u5230\u5f9e sre001 \u56de\u50b3\u56de\u4f86\u7684 \"pong\" \u4e86\uff01 Ansible Role \u521d\u767b\u5834 \u00b6 \u73fe\u5728\u5927\u5bb6\u61c9\u8a72\u4e86\u89e3\u5982\u4f55\u64b0\u5beb Ansible playbook \uff0c\u4e26\u5c07\u6211\u5011\u7684\u5de5\u4f5c\u6e05\u55ae\u4ee5 task \u7684\u65b9\u5f0f\u5728 playbook \u4e2d\u8868\u5217\u4e0b\u4f86\u3002\u7136\u800c\uff0c\u5982\u679c Ansible \u53ea\u80fd\u505a\u5230\u9019\u6a23\u7684\u7a0b\u5ea6\uff0c\u5145\u5176\u91cf\u6211\u5011\u53ea\u80fd\u8aaa\u9019\u662f\u4e00\u500b\u6bd4\u8f03\u65b9\u4fbf\u95b1\u8b80\u7684 Shell script \u7f77\u4e86\u3002\u82e5\u662f\u4eca\u5929\u6211\u5011\u6e05\u55ae\u4e2d\u7684\u4efb\u52d9\u6709\u4e0a\u767e\u500b\uff0c\u9019\u6a23\u6211\u5011\u7684 playbook \u4e5f\u53ef\u80fd\u6703\u8b8a\u5f97\u975e\u5e38\u5197\u9577\uff0c\u5c31\u7b97\u8a9e\u6cd5\u518d\u5982\u4f55\u6613\u8b80\uff0c\u6574\u9ad4\u800c\u8a00 playbook \u9084\u662f\u6703\u8b8a\u5f97\u5341\u5206\u96e3\u4ee5\u7406\u89e3\u3002 \u53e6\u5916\uff0c\u5f88\u591a\u6642\u5019\u5176\u5be6\u6211\u5011\u6703\u5e0c\u671b\u6709\u90e8\u5206\u7684\u90e8\u7f72\u5167\u5bb9\u662f\u53ef\u4ee5\u88ab\u5176\u4ed6\u4e0d\u540c\u7684 playbook \u91cd\u65b0\u4f7f\u7528\u3002\u8209\u4f8b\u4f86\u8aaa\uff0c\u5f88\u591a\u670d\u52d9\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 pip \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u4f86\u9032\u884c\u5b89\u88dd\uff0c\u6211\u5011\u4e26\u4e0d\u6703\u5e0c\u671b\u5728\u6bcf\u4e00\u500b\u4e0d\u540c\u7684 playbook \u4e2d\u90fd\u8981\u91cd\u65b0\u5b9a\u7fa9\u4e00\u6b21 pip \u7684\u5b89\u88dd\u65b9\u6cd5\u3002 \u56e0\u6b64\uff0c\u70ba\u4e86\u89e3\u6c7a\u4e0a\u8ff0\u7684\u554f\u984c\uff0cAnsible \u63d0\u4f9b\u4e86\u6211\u5011\u5728\u64b0\u5beb\u81ea\u52d5\u5316\u8173\u672c\u6642\u4e00\u500b\u89d2\u8272 role \u7684\u6982\u5ff5\u3002\u6211\u5011\u53ef\u4ee5\u900f\u904e\u64b0\u5beb\u5c6c\u65bc\u81ea\u5df1\u7684 role \u4f86\u8b93\u6240\u6709 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u85c9\u6b64\u63d0\u5347\u900f\u904e Ansible \u81ea\u52d5\u5316\u7684\u9748\u6d3b\u5ea6\u3002 \u7b2c\u4e00\u500b role \u00b6 \u8003\u91cf\u5230\u7531\u65bc\u5b89\u88dd cURL \u7684\u9019\u500b\u5de5\u4f5c\u5f88\u53ef\u80fd\u6703\u5728\u672a\u4f86\u983b\u7e41\u5730\u88ab\u4e0d\u540c\u7684 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u56e0\u6b64\uff0c\u6211\u5011\u9078\u64c7\u628a\u5b89\u88dd cURL \u7684\u65b9\u6cd5\u5beb\u6210\u4e00\u500b\u53ef\u4ee5\u91cd\u8907\u88ab\u5229\u7528\u7684 role \uff0c\u800c\u975e playbook \u4e2d\u7684\u4e00\u500b task\u3002 \u8b93\u6211\u5011\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848 (\u65b0\u589e roles/curl/main.yml )\uff1a workspace \u251c\u2500\u2500 Vagrantfile \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 roles \u2514\u2500\u2500 curl \u2514\u2500\u2500 tasks \u2514\u2500\u2500 main.yml \u5728\u9019\u500b\u7d50\u69cb\u4e0b\uff0c curl \u5c31\u662f\u6211\u5011\u7684\u7b2c\u4e00\u500b role \u7684\u540d\u7a31\uff0c\u800c\u9019\u500b role \u7684\u5de5\u4f5c\u6d41\u7a0b\u5c31\u6703\u88ab\u6211\u5011\u5b9a\u7fa9\u5728\u4e0b\u9762\u7684 tasks/main.yml \u4e4b\u4e2d\u3002\u73fe\u5728\u6253\u958b curl/tasks/main.yml \u4e26\u5728\u5176\u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a curl/tasks/main.yml --- - name : install curl ansible.builtin.apt : name : curl \u6211\u5011\u5728\u9019\u500b role \u7684\u5167\u5bb9\u4e2d\u547c\u53eb\u4e86 Ansible \u5167\u5efa\u6a21\u7d44 apt \uff0c\u4e26\u5229\u7528\u5b83\u76f4\u63a5\u9032\u884c cURL \u7684\u5b89\u88dd\u3002\u63a5\u8457\uff0c\u6253\u958b\u6211\u5011\u7684 playbook.yml\uff0c\u4e26\u4fee\u6539\u70ba\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : ironman roles : - { role : curl , become : yes } \u6211\u5011\u522a\u9664\u4e86\u4e4b\u524d\u7528\u4f86\u6e2c\u8a66\u7684 ping \u5287\u78bc (play)\uff0c\u4e26\u5728\u9019\u500b playbook \u4e2d\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u57f7\u884c curl \u9019\u500b\u6211\u5011\u525b\u5b9a\u7fa9\u597d\u7684 role\u3002\u5176\u4e2d\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c become \u4ee3\u8868\u6211\u5011\u8981\u5347\u9ad8\u7576\u524d\u4f7f\u7528\u8005\u6b0a\u9650 \uff08\u7b49\u6548\u65bc Unix / Linux \u4e2d\u7684 sudo \u6307\u4ee4\uff09\u4f86\u904b\u884c\u7576\u524d\u5de5\u4f5c\u3002 \u6700\u5f8c\uff0c\u91cd\u65b0\u904b\u884c\u6211\u5011\u7684 playbook $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u5f97\u5230\u4ee5\u4e0b\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] **************************************************************************************************************************************************** ok: [127.0.0.1] PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u914d\u7f6e ansible.cfg \u00b6 \u6709\u4e9b\u6642\u5019\u6211\u5011\u60f3\u8981\u628a\u76f8\u95dc\u7684roles\u7f6e\u653e\u7684\u8def\u5f91\u505a\u4e0d\u540c\u7684\u898f\u5283\u6642\uff0cAnsible \u5c31\u6703\u627e\u4e0d\u5230\u5c0d\u61c9 role \u6a94\u6848\u7684\u4f4d\u7f6e\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5c31\u5fc5\u9808\u900f\u904e\u8a2d\u5b9a Ansible \u7684\u914d\u7f6e\u6a94\u6848 - ansible.cfg \u4f86\u8a2d\u7f6e role \u8def\u5f91 (path)\u3002 \u65b0\u589e\u4e00\u500b\u6a94\u6848 ansible.cfg \u4e26\u52a0\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a ansible.cfg [sre001] roles_path = ./roles \u82e5\u9ede\u9032\u5b98\u65b9\u914d\u7f6e\u6587\u4ef6\u7684\u8aaa\u660e\u9801\u9762\uff0c\u53ef\u4ee5\u767c\u73fe\u9664\u4e86 roles_path \u4e4b\u5916\u9084\u6709\u4e00\u5927\u5806\u53c3\u6578\u53ef\u4ee5\u4f9d\u64da\u4f7f\u7528\u8005\u7684\u9700\u6c42\u9032\u884c\u975e\u5e38\u6709\u5f48\u6027\u7684\u914d\u7f6e\u3002\u5176\u4e2d\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u9019\u500b\u793a\u7bc4\u88e1\u9762\u6211\u662f\u5c07 ansible.cfg \u9019\u500b\u914d\u7f6e\u6a94\u6848\u7f6e\u65bc\u6211\u5011\u5de5\u4f5c\u8cc7\u6599\u593e\u4e4b\u4e0b\uff0c\u76ee\u524d\u5177\u9ad4\u8cc7\u6599\u593e\u7d50\u69cb\u5982\u4e0b\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u2514\u2500\u2500 curl \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4f46\u5f9e\u5b98\u65b9\u6587\u4ef6\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u767c\u73fe\u9664\u4e86\u5c07\u914d\u7f6e\u6a94\u6848\u653e\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u5e95\u4e0b\u5916\uff0c\u9084\u6709\u5176\u4ed6\u5e7e\u7a2e\u4e0d\u540c\u7684\u914d\u7f6e\u65b9\u5f0f\uff1a \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf ANSIBLE_CONFIG \u7f6e\u65bc\u7576\u524d\u76ee\u9304\u4e0b\u7684 ansible.cfg \uff08\u9019\u6b21\u7bc4\u4f8b\u4e2d\u4f7f\u7528\u7684\u65b9\u6cd5\uff09 \u7f6e\u65bc\u6839\u76ee\u9304\u4e0b\u7684 .ansible.cfg \u7f6e\u65bc /etc/ansible/ \u4e0b\u7684 ansible.cfg \u82e5\u6211\u5011\u540c\u6642\u5206\u5225\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u5b58\u5728\u5728\u7cfb\u7d71\u4e2d\uff0cAnsible \u6703\u4f9d\u7167\u4e0a\u8ff0\u9806\u5e8f\u9010\u4e00\u67e5\u627e\u6587\u4ef6\uff0c\u82e5\u627e\u5230\u5176\u4e2d\u4e00\u500b\uff0c\u5c31\u6703\u4f9d\u5176\u8a2d\u5b9a\u9032\u884c\u914d\u7f6e\uff0c\u4e26\u4e0d\u518d\u7e7c\u7e8c\u67e5\u627e\u3002 \u5efa\u7acb Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2 \u00b6 \u5728\u5b8c\u6210\u7b2c\u4e00\u500b\u7c21\u55ae\u7684 role \u4e4b\u5f8c\uff0c\u8b93\u6211\u5011\u8a66\u8457\u5b89\u88dd\u4e00\u500bCI/CD\u7684\u5de5\u5177 Jenkins\u3002 \u81ea\u52d5\u5316 Jenkins \u5b89\u88dd \u00b6 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-jenkins-on-ubuntu-20-04 Jenkins \u5728 Ubuntu \u4e0a\u7684\u5b89\u88dd\u65b9\u5f0f\uff1a $ wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add - $ sudo sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list' $ sudo apt update $ sudo apt install jenkins \u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u6703\u5f9e Jenkins \u5b98\u65b9\u91cb\u51fa\u7684 Debian \u5957\u4ef6\u5eab\u4e2d\u5c07\u5bc6\u9470 (key) \u52a0\u5165\u672c\u5730\uff0c\u4e26\u65b0\u589e\u5c0d\u61c9\u7684\u5009\u5eab (repository) \u5165\u53e3\u3002\u6700\u5f8c\uff0c\u518d\u900f\u904e apt \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u9032\u884c Jenkins \u7684\u5b89\u88dd\u3002\u73fe\u5728\u8b93\u6211\u5011\u628a\u4e0a\u9762\u7684\u6307\u4ee4\u7ffb\u8b6f\u6210 Ansible \u7684\u8173\u672c\uff1a --- - name : add jenkins key ansible.builtin.apt_key : url : https://pkg.jenkins.io/debian-stable/jenkins.io.key state : present - name : add jenkins repository ansible.builtin.apt_repository : repo : deb http://pkg.jenkins.io/debian-stable binary/ state : present - name : install jenkins ansible.builtin.apt : name : jenkins update_cache : yes Tip \u5728\u9019\u6b21\u7684\u4efb\u52d9\u4e2d\u6211\u5011\u4f7f\u7528\u4e86\u4e09\u500bAnsible\u7684\u6a21\u7d44: ansible.builtin.apt_key \u6a21\u7d44 ansible.builtin.apt_repository \u6a21\u7d44 ansible.builtin.apt \u6a21\u7d44 \u5176\u4e2d apt_key \u53ca apt_repository \u90fd\u662f Ansible \u5df2\u7d93\u5167\u5efa\u7684\u5169\u500b\u6a21\u7d44\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5229\u7528\u5b83\u5011\u9032\u884c\u5bc6\u9470\u53ca\u5009\u5eab\u7684\u65b0\u589e\uff0c\u66f4\u591a\u7d30\u7bc0\u64cd\u4f5c\u53ef\u4ee5\u5728\u5b98\u65b9\u7684\u6587\u4ef6\u4e0a\u67e5\u770b\u3002\u800c\u5728 install jenkins \u9019\u500b task \u4e4b\u4e0b\u7684 update_cache \u5176\u5be6\u5c31\u662f\u7b49\u6548\u65bc\u6211\u5011\u5728\u4e00\u822c Ubuntu / Debian \u7cfb\u7d71\u4e0b\u4f7f\u7528 apt-get update \u7684\u6307\u4ee4\uff0c\u82e5\u5728\u64cd\u4f5c Ansible \u7684 apt \u9019\u500b\u6a21\u7d44\u6642\u4f7f\u7528\u4e86 update_cache: yes\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u6703\u5148\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 apt \u5957\u4ef6\u7ba1\u7406\u9032\u884c\u5347\u7d1a\u624d\u505a\u63a5\u4e0b\u4f86\u7684\u52d5\u4f5c\u3002 \u89e3\u91cb\u5b8c\u8981\u505a\u7684\u4e8b\u4ee5\u5f8c\uff0c\u9019\u6b21\u6211\u4e5f\u8981\u540c\u6642\u5c07\u6574\u500b\u5b89\u88dd Jenkins \u7684\u6d41\u7a0b\u5beb\u6210\u53e6\u5916\u4e00\u500b role\u3002\u4e00\u6a23\u7684\uff0c\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e jenkins \u9019\u500b role\uff0c\u4e26\u5728 roles/jenkins/tasks/main.yml \u4e2d\u8f38\u5165\u4ee5\u4e0a\u5167\u5bb9\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 jenkins \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u73fe\u5728\u6211\u5011\u6709\u5169\u500b roles \u4e86\u3002\u56de\u5230\u6211\u5011\u7684 playbook.yml \u4f5c\u4ee5\u4e0b\u7684\u8abf\u6574: playbook.yml --- - hosts : sre001 roles : - { role : curl , become : yes } - { role : jenkins , become : yes } \u91cd\u65b0\u57f7\u884c playbook: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml PLAY [sre001] ************************************************************************************************************* TASK [Gathering Facts] **************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] ************************************************************************************************ ok: [127.0.0.1] TASK [jenkins : add jenkins key] ****************************************************************************************** changed: [127.0.0.1] TASK [jenkins : add jenkins repository] *********************************************************************************** changed: [127.0.0.1] TASK [jenkins : install jenkins] ****************************************************************************************** fatal: [127.0.0.1]: FAILED! => {\"cache_update_time\": 1654304408, \"cache_updated\": true, \"changed\": false, \"msg\": \"'/usr/bin/apt-get -y -o \\\"Dpkg::Options::=--force-confdef\\\" -o \\\"Dpkg::Options::=--force-confold\\\" install 'jenkins'' failed: E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"rc\": 100, \"stderr\": \"E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"stderr_lines\": [\"E: Sub-process /usr/bin/dpkg returned an error code (1)\"], \"stdout\": \"Reading package lists...\\nBuilding dependency tree...\\nReading state information...\\nThe following additional packages will be installed:\\n net-tools\\nThe following NEW packages will be installed:\\n jenkins net-tools\\n0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\\nNeed to get 91.6 MB of archives.\\nAfter this operation, 95.9 MB of additional disk space will be used.\\nGet:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\\nGet:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\\nFetched 91.6 MB in 12s (7,593 kB/s)\\nSelecting previously unselected package net-tools.\\r\\n(Reading database ... \\r(Reading database ... 5%\\r(Reading database ... 10%\\r(Reading database ... 15%\\r(Reading database ... 20%\\r(Reading database ... 25%\\r(Reading database ... 30%\\r(Reading database ... 35%\\r(Reading database ... 40%\\r(Reading database ... 45%\\r(Reading database ... 50%\\r(Reading database ... 55%\\r(Reading database ... 60%\\r(Reading database ... 65%\\r(Reading database ... 70%\\r(Reading database ... 75%\\r(Reading database ... 80%\\r(Reading database ... 85%\\r(Reading database ... 90%\\r(Reading database ... 95%\\r(Reading database ... 100%\\r(Reading database ... 63489 files and directories currently installed.)\\r\\nPreparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\\r\\nUnpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSelecting previously unselected package jenkins.\\r\\nPreparing to unpack .../jenkins_2.332.3_all.deb ...\\r\\nUnpacking jenkins (2.332.3) ...\\r\\nSetting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSetting up jenkins (2.332.3) ...\\r\\nCreated symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\\r\\nJob for jenkins.service failed because the control process exited with error code.\\r\\nSee \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\\r\\ninvoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\\r\\n\u25cf jenkins.service - Jenkins Continuous Integration Server\\r\\n Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\\r\\n Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\\r\\n Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\\r\\n Main PID: 3569 (code=exited, status=1/FAILURE)\\r\\ndpkg: error processing package jenkins (--configure):\\r\\n installed jenkins package post-installation script subprocess returned error exit status 1\\r\\nProcessing triggers for man-db (2.9.1-1) ...\\r\\nProcessing triggers for systemd (245.4-4ubuntu3.17) ...\\r\\nErrors were encountered while processing:\\r\\n jenkins\\r\\n\", \"stdout_lines\": [\"Reading package lists...\", \"Building dependency tree...\", \"Reading state information...\", \"The following additional packages will be installed:\", \" net-tools\", \"The following NEW packages will be installed:\", \" jenkins net-tools\", \"0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\", \"Need to get 91.6 MB of archives.\", \"After this operation, 95.9 MB of additional disk space will be used.\", \"Get:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\", \"Get:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\", \"Fetched 91.6 MB in 12s (7,593 kB/s)\", \"Selecting previously unselected package net-tools.\", \"(Reading database ... \", \"(Reading database ... 5%\", \"(Reading database ... 10%\", \"(Reading database ... 15%\", \"(Reading database ... 20%\", \"(Reading database ... 25%\", \"(Reading database ... 30%\", \"(Reading database ... 35%\", \"(Reading database ... 40%\", \"(Reading database ... 45%\", \"(Reading database ... 50%\", \"(Reading database ... 55%\", \"(Reading database ... 60%\", \"(Reading database ... 65%\", \"(Reading database ... 70%\", \"(Reading database ... 75%\", \"(Reading database ... 80%\", \"(Reading database ... 85%\", \"(Reading database ... 90%\", \"(Reading database ... 95%\", \"(Reading database ... 100%\", \"(Reading database ... 63489 files and directories currently installed.)\", \"Preparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\", \"Unpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Selecting previously unselected package jenkins.\", \"Preparing to unpack .../jenkins_2.332.3_all.deb ...\", \"Unpacking jenkins (2.332.3) ...\", \"Setting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Setting up jenkins (2.332.3) ...\", \"Created symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\", \"Job for jenkins.service failed because the control process exited with error code.\", \"See \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\", \"invoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\", \"\u25cf jenkins.service - Jenkins Continuous Integration Server\", \" Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\", \" Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\", \" Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\", \" Main PID: 3569 (code=exited, status=1/FAILURE)\", \"dpkg: error processing package jenkins (--configure):\", \" installed jenkins package post-installation script subprocess returned error exit status 1\", \"Processing triggers for man-db (2.9.1-1) ...\", \"Processing triggers for systemd (245.4-4ubuntu3.17) ...\", \"Errors were encountered while processing:\", \" jenkins\"]} PLAY RECAP **************************************************************************************************************** 127.0.0.1 : ok=4 changed=2 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 \u57f7\u884c\u7684\u7d50\u679c\u5728 install jenkins \u51fa\u73fe\u5931\u6557\u3002\u53bb\u67e5\u8a62 Jenkins \u5b98\u7db2\u767c\u73fe Jenkins \u5fc5\u9700\u8981\u4f9d\u8cf4 Java \u624d\u80fd\u5920\u6b63\u78ba\u904b\u884c\u4e4b\u524d\uff0c\u4e5f\u5c31\u662f\u8aaa\u9664\u4e86\u5728 ansible \u4e2d\u8a2d\u5b9a\u5b89\u88dd Java \u4e4b\u5916, \u9084\u5fc5\u9700\u8b93 jenkins \u662f\u5728 java \u5b89\u88dd\u5b8c\u4e4b\u5f8c\u624d\u80fd\u63a5\u7e8c\u5b89\u88dd\u3002 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-on-ubuntu-20-04#installing-specific-versions-of-openjdk Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2 \u00b6 \u5728 Ansible \u7684\u4e16\u754c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e\u5b9a\u7fa9 role \u8207 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2 role dependencies \u4f86\u63d0\u5347\u6bcf\u4e00\u500b role \u7684\u53ef\u8b80\u6027\u8207\u76f8\u4e92\u7684\u4f9d\u8cf4\u3002\u5c31\u4ee5\u4e0a\u9762\u7684\u4f8b\u5b50\u800c\u8a00\uff0c\u6211\u5011\u5e0c\u671b\u6240\u6709\u90e8\u7f72 Jenkins \u7684\u4f3a\u670d\u5668\u90fd\u9810\u5148\u642d\u8f09\u597d Java\uff0c\u82e5\u7528 Ansible \u7684\u89d2\u5ea6\u601d\u8003\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u5e0c\u671b jenkins \u9019\u500b role \u4f9d\u8cf4\u65bc openjre \u9019\u500b role\u3002\u6211\u5011\u53ef\u4ee5\u5728\u6bcf\u4e00\u500b role \u7684\u8cc7\u6599\u593e\u4e2d\u900f\u904e meta \u9019\u500b\u5b50\u76ee\u9304\u5b9a\u7fa9\u9019\u6a23\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u5177\u9ad4\u6b65\u9a5f\u5982\u4e0b\uff1a \u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u5728 roles \u7684\u76ee\u9304\u4e0b\u5efa\u7acb openjre\\tasks \u7684\u5b50\u76ee\u9304\u4e26\u4e14\u5efa\u7acb\u4e00\u500b\u65b0\u6a94\u6848 main.yml : openjre\\tasks\\main.yml --- - name : install openjre ansible.builtin.apt : name : default-jre update_cache : yes \u4e0a\u8ff0\u7684 role \u6703\u7528\u4f86\u5b89\u88dd Java JRE runtime\u3002 jenkins/meta/main.yml --- dependencies : - { role : openjre , become : yes } \u5b9a\u7fa9 jenkins \u9019\u500b role \u4f9d\u8cf4\u4e8e openjre \u7684 role\u3002 \u56de\u5230 playbook.yml \u4e2d\u522a\u9664\u539f\u672c\u547c\u53eb curl role \u7684\u90e8\u5206\uff0c\u53ea\u7559\u4e0b jenkins\uff1a: playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=5 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6839\u64da role \u7684\u65b0\u7d50\u69cb\uff0c\u6211\u5011\u6bcf\u6b21\u53ea\u8981\u547c\u53eb jenkins \u9019\u500b role\uff0c\u5728\u5b89\u88dd Jenkins \u4e4b\u524d\uff0cAnsible \u5c31\u6703\u81ea\u52d5\u5148\u5e6b\u6211\u5011\u628a\u6240\u6709\u5b9a\u7fa9\u5728 meta \u4e2d\u7684\u670d\u52d9\u4f9d\u8cf4\u5b89\u88dd\u597d\u3002\u82e5\u672a\u4f86\u5728 jenkins \u9019\u500b role \u4e0a\u8981\u65b0\u589e\u6216\u79fb\u9664\u670d\u52d9\u4f9d\u8cf4\uff0c\u6211\u5011\u53ea\u9700\u8981\u56de\u5230 meta \u4e2d\u505a\u4fee\u6539\u5373\u53ef\u3002 \u900f\u904e\u5b9a\u7fa9 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u6211\u5011\u53ef\u4ee5\u5728 playbook \u4e2d\u53ea\u55ae\u7d14\u547c\u53eb\u9700\u8981\u7684 role\uff0c\u800c\u4e0d\u7528\u56de\u5230\u5e95\u5c64\u601d\u8003\u904b\u884c\u9019\u500b role \u4e4b\u524d\u6211\u5011\u9084\u9700\u8981\u5b89\u88dd\u4ec0\u9ebc\u984d\u5916\u7684\u670d\u52d9\u3002\u9019\u6a23\u7684\u8a2d\u8a08\u908f\u8f2f\u4e0d\u4f46\u53ef\u4ee5\u5c07\u6bcf\u4e00\u500b role \u90fd\u8996\u70ba\u5df2\u7d93\u5b8c\u5168\u53ef\u4ee5\u7528\u7684\u5de5\u5177\uff0c\u5728\u7dad\u8b77\u7684\u89d2\u5ea6\u4e0a\u4e5f\u4f7f\u5b89\u88dd\u7d50\u69cb\u66f4\u4f73\u6e05\u6670\u6613\u61c2\u3002 \u958b\u767c\u4eba\u54e1\u904e\u53bb\u5f80\u5f80\u56e0\u70ba\u7e41\u7463\u7684\u5b89\u88dd\u6d41\u7a0b\u96e3\u514d\u758f\u5ffd\u5176\u4e2d\u5e7e\u500b\u524d\u7f6e\u670d\u52d9\u5b89\u88dd\uff0c\u9032\u800c\u5c0e\u81f4\u5f8c\u9762\u90e8\u7f72\u6d41\u7a0b\u767c\u751f\u7684\u932f\u8aa4\uff0c\u900f\u904e\u9019\u6a23\u7684\u8a2d\u8a08\u6d41\u7a0b\uff0c\u5c07\u53ef\u4ee5\u5fb9\u5e95\u88ab\u89e3\u6c7a\u3002 Role \u8de8\u7cfb\u7d71\u7684\u9748\u6d3b\u5ea6 \u00b6 \u6211\u5011\u5c07\u65b0\u589e\u4e00\u500b role \u7528\u4f86\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u55ae\u4e00\u500b role \u540c\u6642\u652f\u63f4\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u7684\u4e3b\u6a5f\u3002 \u5b89\u88dd Git \u00b6 \u5beb\u53e6\u4e00\u500b\u7368\u7acb\u7684 role \u4f86\u5b89\u88dd Git\u3002\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e git \u9019\u500b role\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 git \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4e26\u5728 roles/git/tasks/main.yml \u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a roles/git/tasks/main.yml --- - name : install git ansible.builtin.yum : name : git-all when : ansible_distribution == 'CentOS' - name : install git ansible.builtin.apt : name : git when : ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian' \u9664\u4e86\u975e\u5e38\u985e\u4f3c\u65bc\u4e4b\u524d curl \u9019\u500b role \u7684\u5b89\u88dd\u6d41\u7a0b\uff0c\u9019\u6b21\u6211\u5011\u5728 role \u88e1\u9762\u52a0\u4e0a\u4e86\u7cfb\u7d71\u5224\u65b7\u689d\u4ef6\u3002\u7531\u65bc Ubuntu \u8ddf Debian \u9019\u5169\u7a2e\u4e3b\u8981\u7684 Linux \u4f5c\u696d\u7cfb\u7d71\u9810\u8a2d\u90fd\u662f\u642d\u8f09 apt \u505a\u70ba\u5957\u4ef6\u7ba1\u7406\uff0c\u6240\u4ee5\u7576\u6211\u5011\u4eca\u5929\u53ea\u8981\u904b\u884c\u9019\u500b role\uff0c\u4e26\u5224\u65b7\u9059\u63a7\u4e3b\u6a5f\u662f\u9019\u5169\u500b\u4f5c\u696d\u7cfb\u7d71\u4e4b\u4e00\u7684\u6642\u5019\uff0c\u6211\u5011\u5c31\u6703\u904b\u884c\u4e0a\u9762\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002 \u53e6\u5916\uff0c\u7531\u65bc git \u9019\u500b role \u7406\u8ad6\u4e0a\u5728\u672a\u4f86\u88ab\u91cd\u8907\u5229\u7528\u5230\u7684\u983b\u7387\u6703\u975e\u5e38\u9ad8\uff0c\u56e0\u6b64\u6211\u5728\u9019\u88e1\u540c\u6642\u4e5f\u65b0\u589e\u4e86\u5728 CentOS \u9019\u5957\u4f5c\u696d\u7cfb\u7d71\u4e0a\u4f7f\u7528 yum \u5b89\u88dd Git \u7684\u65b9\u6cd5\uff08\u5728 yum \u5957\u4ef6\u7ba1\u7406\u7cfb\u7d71\u4e2d\uff0cGit \u5957\u4ef6\u7684\u540d\u7a31\u8207 apt \u7cfb\u7d71\u4e26\u4e0d\u76f8\u540c\uff09\uff0c\u4ee5\u589e\u52a0\u9019\u500b role \u7684\u4f7f\u7528\u9748\u6d3b\u6027\u3002 \u63a5\u8457\u4fee\u6539 playbook.yml : playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } - { role : git , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] TASK [git : install git] *********************************************************************************** skipping: [127.0.0.1] TASK [git : install git] *********************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=6 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u6211\u5011\u53ef\u4ee5\u770b\u5230 Ansible \u6703\u6839\u64da\u5c0d\u61c9\u7684\u4f5c\u696d\u7cfb\u7d71\u5224\u65b7\u54ea\u4e9b tasks \u53ef\u4ee5\u88ab\u7565\u904e (skipping)\uff0c\u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u6211\u5011\u4e0d\u9700\u8981\u7279\u5225\u70ba\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u4fdd\u5b58\u591a\u4efd\u7248\u672c\u7684 role\uff0c\u53ea\u8981\u5c08\u6ce8\u5728\u540c\u4e00\u500b role \u4e2d\u958b\u767c\u7576\u524d\u4efb\u52d9\u5373\u53ef\u3002 \u53e6\u5916\uff0c\u82e5\u4ed4\u7d30\u95b1\u8b80\u5728\u7d42\u7aef\u6a5f\u4e0a\u986f\u793a\u7684 Ansible \u5b89\u88dd\u6d41\u7a0b\uff0c\u61c9\u8a72\u6703\u767c\u73fe\u5df2\u7d93\u88ab\u5b89\u88dd\u904e\u7684\u670d\u52d9\u4e26\u4e0d\u6703\u4e00\u76f4\u91cd\u8907\u88ab\u5b89\u88dd\u3002\u986f\u793a\u70ba changed \u8868\u793a\u9059\u63a7\u4e3b\u6a5f\u5728\u9019\u6b21\u904b\u884c playbook \u7684\u904e\u7a0b\u88e1\uff0cAnsible \u5728\u8a72\u9805 task \u4e2d\u5c0d\u7cfb\u7d71\u505a\u4e86\u6539\u8b8a\uff1bok \u5247\u8868\u793a\u8a72 task \u7684\u5b8c\u6210\u689d\u4ef6\u5df2\u6eff\u8db3\uff0c\u6240\u4ee5 Ansible \u4e26\u4e0d\u6703\u984d\u5916\u5c0d\u4e3b\u6a5f\u505a\u5176\u4ed6\u8b8a\u52d5\u3002 \u7279\u5225\u9700\u8981\u89e3\u91cb\u7684\u662f\uff0c\u82e5\u6211\u5011\u4f7f\u7528\u4e86 update_cache: yes \u9019\u9805\u5c6c\u6027\u4f86\u900f\u904e\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u5b89\u88dd\u670d\u52d9\u3002\u6211\u5011\u6bcf\u6b21\u5b89\u88dd\u670d\u52d9\u524d\u90fd\u6703\u8a66\u5716\u5c07\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u7684\u7248\u672c\u90fd\u66f4\u65b0\u5230\u7576\u524d\u6700\u65b0\u7248\u672c\uff0c\u7136\u5f8c\u624d\u9032\u884c\u5b89\u88dd\u6b65\u9a5f\uff0c\u56e0\u6b64\u6bcf\u6b21 task \u7684\u72c0\u614b\u90fd\u5c07\u6703\u986f\u793a\u70ba changed\u3002 Ansible Galaxy \u00b6 Ansible Galaxy \u662f\u4e00\u500b Ansible \u5b98\u65b9\u63d0\u4f9b\u7684 Ansible Role \u5171\u4eab\u5e73\u53f0\u3002\u6240\u6709 Ansible \u7684\u4f7f\u7528\u8005\u90fd\u53ef\u4ee5\u81ea\u7531\u4e0a\u50b3\u81ea\u5df1\u7684 role \u8207\u5168\u4e16\u754c\u7684\u958b\u767c\u4eba\u54e1\u5206\u4eab\u3002 \u5728\u63a5\u5230\u4efb\u52d9\u9700\u6c42\u524d\uff0c\u5efa\u8b70\u8b80\u8005\u53ef\u4ee5\u82b1\u500b\u5e7e\u5206\u9418\u5728\u4e0a\u9762\u7a0d\u5fae\u700f\u89bd\u4e00\u4e0b\uff0c\u770b\u770b\u662f\u5426\u6709\u9069\u5408\u81ea\u5df1\u4f7f\u7528\u7684\u73fe\u6210 role \u7684\u53ef\u4ee5\u7acb\u523b\u62ff\u4f86\u4f7f\u7528\u3002\u4e0d\u904e\uff0c\u70ba\u907f\u514d\u8b80\u8005\u6df7\u6dc6\uff0c\u9019\u6b21\u5c31\u4e0d\u7279\u5225\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 ansible-galaxy \u4f86\u8abf\u7528\u5176\u4ed6\u958b\u767c\u8005\u7684 role\uff0c\u6709\u8208\u8da3\u7684\u8b80\u8005\u53ef\u4ee5\u81ea\u884c\u53c3\u95b1\u5b98\u65b9\u4f7f\u7528\u6559\u5b78\u3002 \u8a2d\u5b9a Vagrant forward port \u00b6 \u7531\u65bc Jenkins \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 8080\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8a66\u8457\u628a\u9059\u63a7\u7bc0\u9ede\u7684 port 8080 \u5ee3\u64ad\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u3002\u4e0d\u904e\uff0c\u7531\u65bc port 8080 \u662f\u4e00\u500b\u975e\u5e38\u5bb9\u6613\u88ab\u5176\u4ed6\u670d\u52d9\u4f7f\u7528\u7684 port\uff0c\u70ba\u4e86\u907f\u514d\u885d\u7a81\uff0c\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u7684 port 9080\u3002 \u5728 Vagrantfile \u4e2d\uff0c\u76f4\u63a5\u5728 config.vm.define \"sre001\" \u8a72\u884c\u4e0b\u9762\u65b0\u589e\u4ee5\u4e0b\u8a2d\u5b9a\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"forwarded_port\" , guest : 8080 , host : 9080 end \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a $ vagrant reload \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a == > sre001: Attempting graceful shutdown of VM... == > sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > sre001: Clearing any previously set forwarded ports... == > sre001: Fixed port collision for 22 = > 2222 . Now on port 2201 . == > sre001: Clearing any previously set network interfaces... == > sre001: Preparing network interfaces based on configuration... sre001: Adapter 1 : nat == > sre001: Forwarding ports... sre001: 8080 ( guest ) = > 9080 ( host ) ( adapter 1 ) sre001: 22 ( guest ) = > 2201 ( host ) ( adapter 1 ) == > sre001: Running 'pre-boot' VM customizations... == > sre001: Booting VM... == > sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127 .0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key == > sre001: Machine booted and ready! == > sre001: Checking for guest additions in VM... == > sre001: Mounting shared folders... sre001: /vagrant = > /home/dxlab/opt/vagrant_getting_started == > sre001: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > sre001: flag to force provisioning. Provisioners marked to run always will still run. \u6211\u5011\u53ef\u4ee5\u5f9e\u4e0a\u9762\u8cc7\u8a0a\u4e2d\u770b\u5230 Vagrant \u5df2\u7d93\u5e6b\u6211\u5011\u628aVM\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u672c\u6a5f\u7684 port 9080 \u4e86\u3002\u73fe\u5728\u5617\u8a66\u900f\u904e\u700f\u89bd\u5668\u8a2a\u554f http://localhost:9080 \u5c31\u61c9\u8a72\u53ef\u4ee5\u9806\u5229\u9032\u5165 Jenkins \u7684\u521d\u59cb\u5316\u9801\u9762\u4e86\uff1a \u7d50\u8ad6 \u00b6 \u5f9e\u672c\u6b21\u7684\u5feb\u901f\u5165\u9580\u6559\u7a0b\u4e2d\u6211\u5011\u5feb\u901f\u5730\u4ecb\u8a54\u4e86 Ansible \u6700\u91cd\u8981\u7684\u57fa\u672c\u6982\u5ff5: ansible config inventory playbook tasks roles modules control node / manage node","title":"Ansible \u5feb\u901f\u5165\u9580"},{"location":"ansible/ansible-intro/#ansible","text":"\u5728\u6211\u5011\u6210\u529f\u5229\u7528 Vagrant \u6a21\u64ec\u51fa\u6240\u9700\u7684\u74b0\u5883\u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528 Ansible \u9019\u5957\u81ea\u52d5\u5316\u5de5\u5177\u4f86\u9032\u884c\u90e8\u7f72\u4e86\u3002","title":"\u4f7f\u7528 Ansible \u90e8\u7f72\u74b0\u5883"},{"location":"ansible/ansible-intro/#ansible_1","text":"","title":"Ansible \u4ecb\u7d39"},{"location":"ansible/ansible-intro/#ansible_2","text":"\u76f8\u4fe1\u5927\u5bb6\u61c9\u8a72\u90fd\u6709\u904e\u91cd\u704c\u96fb\u8166\u7684\u7d93\u9a57\u3002\u6bcf\u4e00\u6b21\u5728\u96fb\u8166\u91cd\u65b0\u5b89\u88dd\u5f8c\uff0c\u6211\u5011\u90fd\u9700\u8981\u82b1\u5927\u91cf\u7684\u6642\u9593\u628a\u5e73\u5e38\u5e38\u7528\u7684\u8edf\u9ad4\u4e00\u4e00\u91cd\u65b0\u88dd\u4e0a\uff0c\u6709\u4e9b\u8edf\u9ad4\u53ef\u80fd\u9084\u8981\u9032\u884c\u500b\u5225\u7684\u5fae\u8abf\uff0c\u800c\u9019\u6a23\u7e41\u7463\u7684\u6b65\u9a5f\u540c\u6a23\u4e5f\u6703\u767c\u751f\u5728\u8edf\u9ad4\u90e8\u7f72\u7684\u4f3a\u670d\u5668\u4e0a\u3002 \u70ba\u4e86\u904b\u884c\u958b\u767c\u51fa\u4f86\u7684\u8edf\u9ad4\uff0c\u958b\u767c\u4eba\u54e1\u5011\u5f80\u5f80\u9700\u8981\u8981\u82b1\u8cbb\u5927\u91cf\u7684\u6642\u9593\u5728\u4f3a\u670d\u5668\u4e0a\u5b89\u88dd\u6240\u6709\u6240\u9700\u7684\u5957\u4ef6 (packages) \u6216\u662f\u670d\u52d9\u4f9d\u8cf4 (dependency)\uff0c\u800c\u5728\u5b89\u88dd\u7684\u904e\u7a0b\u4e2d\u82e5\u6709\u758f\u5ffd\uff0c\u9084\u5f88\u6709\u53ef\u80fd\u9020\u6210\u90e8\u7f72\u7a0b\u5f0f\u767c\u751f\u7121\u9810\u671f\u7684\u932f\u8aa4\u3002\u56e0\u6b64\uff0c\u81ea\u52d5\u5316\u5c31\u662f\u56e0\u70ba\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u7a2e\u6982\u5ff5\u3002 \u82e5\u6211\u5011\u53ef\u4ee5\u5c07\u6bcf\u4e00\u6b21\u90e8\u7f72\u7684\u6b65\u9a5f\u5beb\u6210\u4e00\u500b\u81ea\u52d5\u5316\u7684\u6a19\u6e96\u4f5c\u696d\u7a0b\u5e8f (Standard Operating Procedures, SOP)\uff0c\u9664\u4e86\u53ef\u4ee5\u6709\u6548\u7e2e\u77ed\u6bcf\u6b21\u7684\u90e8\u7f72\u6642\u9593\u53ca\u964d\u4f4e\u51fa\u932f\u7387\u5916\uff0c\u5728\u672a\u4f86\u9700\u8981\u5347\u7d1a\u90e8\u7f72\u74b0\u5883\uff0c\u4e5f\u6703\u76f8\u5c0d\u5bb9\u6613\u8a31\u591a\u3002\u800c Ansible \u5c31\u662f\u76ee\u524d\u696d\u754c\u6700\u5e38\u4f7f\u7528\u7684\u81ea\u52d5\u5316\u5de5\u5177\u4e4b\u4e00\u3002","title":"Ansible \u662f\u4ec0\u9ebc\uff1f"},{"location":"ansible/ansible-intro/#ansible_3","text":"\u76ee\u524d\u696d\u754c\u4e2d\u4e3b\u6d41\u7684\u81ea\u52d5\u5316\u90e8\u7f72\u5de5\u5177\u9664\u4e86 Ansible \u4e4b\u5916\u9084\u6709 Chef\u3001Otter\u3001Puppet\u3001SaltStack \u7b49\u7b49\u3002\u6bcf\u4e00\u500b\u9663\u71df\u90fd\u6709\u5927\u91cf\u7684\u64c1\u8b77\u8005\u4ee5\u53ca\u5404\u81ea\u7684\u512a\u7f3a\u9ede\uff0c\u5176\u5be6\u5728\u9019\u500b\u554f\u984c\u4e0a\u4e26\u6c92\u6709\u8ab0\u7d55\u5c0d\u512a\u65bc\u8ab0\u7684\u7b54\u6848\u3002\u4e4b\u6240\u4ee5\u9078\u64c7 Ansible \u4f5c\u70ba\u81ea\u52d5\u5316\u7684\u5de5\u5177\uff0c\u4e3b\u8981\u539f\u56e0\u662f\u56e0\u70ba Ansible \u771f\u7684\u5bb9\u6613\u5b78\u7fd2\u8a31\u591a\u3002\u5728\u9078\u64c7\u5de5\u5177\u7684\u904e\u7a0b\u4e2d\uff0c\u6211\u76f8\u4fe1\u6700\u91cd\u8981\u7684\u8003\u91cf\u61c9\u8a72\u5728\u65bc\u6211\u5011\u80fd\u4e0d\u80fd\u5920\u5728\u6700\u77ed\u7684\u6642\u9593\u5167\u638c\u63e1\u9019\u500b\u5de5\u5177\u4e26\u6709\u6548\u5730\u89e3\u6c7a\u6211\u5011\u6240\u9047\u5230\u7684\u554f\u984c\u3002 \u5728\u9019\u6a23\u7684\u524d\u63d0\u4e0b\uff0cAnsible \u5c31\u6210\u70ba\u8a31\u591a\u958b\u767c\u5718\u968a\u7684\u9996\u9078\u4e86\u3002\u9664\u4e86\u5bb9\u6613\u5b78\u7fd2\u4e4b\u5916\uff0cAnsible \u672c\u8eab\u5728 GitHub \u4e0a\u4e5f\u662f\u4e00\u500b\u958b\u6e90\u7684\u5c08\u6848\u3002\u6709\u4e86\u5927\u91cf\u958b\u767c\u4eba\u54e1\u7684\u5e6b\u52a9\u53ca\u56de\u994b\uff0cAnsible \u9019\u5957\u8edf\u9ad4\u7684\u6210\u9577\u901f\u5ea6\u5176\u5be6\u662f\u771f\u7684\u76f8\u7576\u9a5a\u4eba\u7684\u3002","title":"\u70ba\u4ec0\u9ebc\u8981\u9078\u64c7 Ansible\uff1f"},{"location":"ansible/ansible-intro/#ansible_4","text":"\u7531\u65bc Ansible \u662f\u4f7f\u7528 Python \u958b\u767c\u7684\u4e00\u5957\u514d\u8cbb\u8edf\u9ad4\uff0c\u8981\u900f\u904e Ansible \u5728\u9059\u63a7\u7bc0\u9ede (remote node) \u4e0a\u914d\u7f6e\u74b0\u5883\uff0c\u552f\u4e8c\u7684\u689d\u4ef6\u53ea\u6709\uff1a \u5b89\u88dd Python \u900f\u904e SSH \u9032\u884c\u9023\u7dda \u5728\u73fe\u5728\u5927\u90e8\u5206\u7684 Linux \u4e3b\u6a5f\u4e0a\uff0c\u57fa\u672c\u4e0a Python \u5df2\u7d93\u90fd\u662f\u57fa\u672c\u914d\u5099\u4e86\uff0c\u6240\u4ee5\u9019\u6a23\u7684\u8981\u6c42\u7b49\u65bc\u6c92\u6709\u8981\u6c42\u3002\u6211\u5011\u53ea\u9700\u8981\u5728\u5b89\u88dd\u597d Ansible \u7684\u4e3b\u6a5f (control machine) \u4e0a\u900f\u904e SSH \u8207\u9059\u63a7\u7bc0\u9ede\u6e9d\u901a\uff0c\u5c31\u53ef\u4ee5\u8f15\u9b06\u505a\u5230\u4e00\u9375\u90e8\u7f72\uff01","title":"Ansible \u7684\u9700\u6c42"},{"location":"ansible/ansible-intro/#ansible_5","text":"\u5728 Ansible \u88e1\uff0c\u6703\u628a\u6240\u6709\u6a5f\u5668\u7684\u89d2\u8272\u505a\u4ee5\u4e0b\u5169\u7a2e\u5340\u5206\uff1a \u63a7\u5236\u4e3b\u6a5f (Control Machine) \uff1a\u9867\u540d\u601d\u7fa9\uff0c\u9019\u985e\u4e3b\u6a5f\u53ef\u4ee5\u900f\u904e\u904b\u884c Ansible \u7684\u5287\u672c (playbook) \u5c0d\u7ba1\u7406\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u3002 \u7ba1\u7406\u7bc0\u9ede (Managed Node) \uff1a\u4e5f\u7a31\u70ba\u9059\u63a7\u7bc0\u9ede (Remote Node)\u3002\u76f8\u5c0d\u65bc\u63a7\u5236\u4e3b\u6a5f\uff0c\u9019\u985e\u7bc0\u9ede\u5c31\u662f\u6211\u5011\u900f\u904e Ansible \u9032\u884c\u90e8\u7f72\u7684\u5c0d\u8c61\u3002 \u5c0d\u65bc\u9019\u5169\u7a2e\u4e0d\u540c\u7684\u5c0d\u8c61\uff0c\u5728\u5b89\u88dd / \u4f7f\u7528 Ansible \u7684\u6642\u5019\u4e5f\u6709\u4e0d\u540c\u7684\u9700\u6c42\u3002","title":"Ansible \u5b89\u88dd"},{"location":"ansible/ansible-intro/#ansible_6","text":"\u7531\u65bc Ansible \u662f\u4e00\u5957\u958b\u6e90\u7684\u8edf\u9ad4\uff0c\u6240\u4ee5\u5728\u76ee\u524d\u5927\u90e8\u5206\u7684\u4e3b\u6d41\u4f5c\u696d\u7cfb\u7d71\u4e0a\u90fd\u5df2\u7d93\u53ef\u4ee5\u900f\u904e\u5c0d\u61c9\u7684\u5957\u4ef6\u7ba1\u7406 (package manager) \u9032\u884c\u5b89\u88dd\u4e86\u3002\u4ee5\u4e0b\u5217\u51fa\u5e7e\u500b\u6211\u4e3b\u8981\u6bd4\u8f03\u5e38\u7528\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u65b9\u6cd5\uff1a Ubuntu CentOS/RHEL $ sudo apt update $ sudo apt install software-properties-common $ sudo add-apt-repository --yes --update ppa:ansible/ansible $ sudo apt install ansible $ sudo yum install epel-release $ sudo yum install ansible \u5b89\u88dd\u597d\u4ee5\u5f8c\uff0c\u78ba\u8a8d Ansible \u5df2\u7d93\u5b89\u88dd\u5b8c\u6210\uff1a $ ansible --version ansible [ core 2 .12.7 ] config file = /etc/ansible/ansible.cfg configured module search path = [ '/home/dxlab/.ansible/plugins/modules' , '/usr/share/ansible/plugins/modules' ] ansible python module location = /usr/lib/python3/dist-packages/ansible ansible collection location = /home/dxlab/.ansible/collections:/usr/share/ansible/collections executable location = /usr/bin/ansible python version = 3 .10.4 ( main, Jun 29 2022 , 12 :14:53 ) [ GCC 11 .2.0 ] jinja version = 3 .0.3 libyaml = True","title":"\u5b89\u88dd Ansible \u5728\u63a7\u5236\u4e3b\u6a5f"},{"location":"ansible/ansible-intro/#ansible_7","text":"\u4e0d\u9700\u8981\uff01\u900f\u904e Ansible \u7ba1\u7406\u7684\u7ba1\u7406\u7bc0\u9ede\u5b8c\u5168\u4e0d\u9700\u8981\u5b89\u88dd Ansible\u3002\u5982\u4e0a\u500b\u7ae0\u7bc0\u6240\u8ff0\uff0c\u6211\u5011\u53ea\u9700\u8981\u78ba\u4fdd\u9019\u500b\u7ba1\u7406\u7bc0\u9ede\u53ef\u4ee5\u900f\u904e SSH \u8207\u63a7\u5236\u4e3b\u6a5f\u6e9d\u901a\uff0c\u4e26\u5df2\u5b89\u88dd Python 2.6 \u4ee5\u4e0a\u7684\u7248\u672c\u5c31\u53ef\u4ee5\u900f\u904e\u63a7\u5236\u4e3b\u6a5f\u7ba1\u7406\u4e86\u3002","title":"\u5b89\u88dd Ansible \u5728\u7ba1\u7406\u7bc0\u9ede"},{"location":"ansible/ansible-intro/#ansible-lint","text":"\u5728\u7de8\u5beb\u7a0b\u5f0f/\u8173\u672c\u7684\u6642\u5019\uff0c\u6211\u90fd\u6703\u7fd2\u6163\u53bb\u627e\u5c0d\u61c9\u8a9e\u8a00\u7684 linter \u4f86\u7fd2\u6163\u8a72\u8a9e\u8a00\u7684\u98a8\u683c\u3002\u96d6\u7136 Ansbile \u4e26\u4e0d\u662f\u4e00\u7a2e\u7a0b\u5f0f\u8a9e\u8a00\uff0c\u4f46\u5b83\u4e5f\u6709\u4e00\u500b\u5c0d\u61c9\u7684 linter - Ansible-lint\u3002\u6211\u6703\u5efa\u8b70\u5927\u5bb6\u53ef\u4ee5\u5b89\u88dd\u9019\u500b\u5c0f\u5de5\u5177\uff0c\u5b83\u53ef\u4ee5\u5e6b\u52a9\u4f60\u78ba\u4fdd\u5beb\u51fa\u4f86\u7684\u8173\u672c\u54c1\u8cea\u662f\u6709\u4e00\u5b9a\u6c34\u6e96\u7684\u3002 sudo pip install ansible-lint \u6aa2\u67e5\uff1a ansible-lint 6.2.1 using ansible 2.12.6","title":"\u5b89\u88dd Ansible-lint"},{"location":"ansible/ansible-intro/#playbook","text":"\u7576\u78ba\u8a8d Ansible \u5df2\u7d93\u6b63\u78ba\u5730\u5b89\u88dd\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4e4b\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u5c31\u53ef\u4ee5\u6e96\u5099\u900f\u904e Ansible \u5c0d\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u90e8\u7f72\u4e86\u3002\u7136\u800c\uff0c\u6211\u5011\u8981\u5982\u4f55\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u5c0d\u9059\u63a7\u7bc0\u9ede\u505a\u4e9b\u4ec0\u9ebc\u5462\uff1f\u5728 Ansible \u7684\u4e16\u754c\u88e1\uff0c\u6211\u5011\u662f\u900f\u904e\u7de8\u5beb \u5287\u672c (playbook) \u4f86\u544a\u8a34 Ansible \u63a5\u4e0b\u4f86\u9700\u8981\u505a\u7684\u4e8b\u9805\u3002 \u7531\u65bc Ansible \u7684\u5287\u672c\u662f\u7528 YAML (YAML Ain't Markup Language) \u9019\u7a2e\u8a9e\u8a00\u4f86\u64b0\u5beb\uff0c\u800c\u9019\u500b\u8a9e\u8a00\u6700\u5927\u7684\u7279\u8272\u5c31\u662f\u5177\u6709\u9ad8\u5ea6\u53ef\u8b80\u6027\uff0c\u56e0\u6b64\u7121\u8ad6\u6709\u6c92\u6709\u7a0b\u5f0f\u8a9e\u8a00\u7684\u57fa\u790e\uff0c\u7406\u8ad6\u4e0a\u4efb\u4f55\u4eba\u5728\u770b\u5230\u4e00\u4efd\u597d\u7684 Ansible playbook \u7684\u6642\u5019\u61c9\u8a72\u90fd\u662f\u975e\u5e38\u5bb9\u6613\u7406\u89e3\u53ca\u8457\u624b\u4fee\u6539\u7dad\u8b77\u7684\u3002","title":"\u64b0\u5beb\u7b2c\u4e00\u500b Playbook"},{"location":"ansible/ansible-intro/#playbook_1","text":"\u4ee5\u4e0b\u5148\u7528\u4e00\u500b\u975e\u5e38\u7c21\u55ae\u7684\u7bc4\u4f8b\u4f86\u4ecb\u7d39 playbook \u7684\u904b\u4f5c\u65b9\u5f0f\u3002\u6211\u5011\u5148\u5275\u5efa\u4e00\u500b playbook \u6a94\u6848\uff0c\u5c07\u5176\u547d\u540d\u70ba playbook.yml \u4e26\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u4e0b (e.g. vagrant_getting_started/playbook.yml)\u3002\u63a5\u8457\uff0c\u958b\u555f\u6a94\u6848\u4e26\u8f38\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u76f8\u4fe1\u5927\u5bb6\u5c31\u7b97\u5f9e\u4f86\u6c92\u6709\u5beb\u904e Ansible \u7684 playbook\uff0c\u61c9\u8a72\u9084\u662f\u4e0d\u96e3\u731c\u51fa\u9019\u4efd playbook \u5728\u505a\u4e9b\u4ec0\u9ebc\u3002\u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u5728\u9019\u4efd playbook \u4e2d\u5b9a\u7fa9\u4e86\u4efb\u52d9\u6e05\u55ae tasks \u4ee5\u53ca\u90e8\u7f72\u5c0d\u8c61 hosts: sre001 \u3002 \u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u5728\u4e4b\u524d\u7684\u7ae0\u7bc0\u4e2d\u6211\u5011\u63d0\u5230\u4e86\u6700\u597d\u628a\u6bcf\u4e00\u500b\u865b\u64ec\u4e3b\u6a5f\u90fd\u505a\u547d\u540d\u3002\u4e3b\u6a5f\u547d\u540d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u900f\u904e\u4e3b\u6a5f\u7684\u540d\u7a31\u76f4\u63a5\u9032\u884c\u64cd\u4f5c\uff08\u6211\u5011\u6703\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u63d0\u5230\u82e5\u4e0d\u900f\u904e Vagrant \u8981\u5982\u4f55\u547d\u540d\u4e3b\u6a5f\uff09\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e name \u9019\u500b\u6a19\u7c64\u66ff\u4efb\u52d9\u6e05\u55ae\u4e2d\u7684\u6bcf\u500b task \u5206\u5225\u547d\u540d\u3002\u5728\u63a5\u4e0b\u4f86\u904b\u884c playbook \u7684\u904e\u7a0b\u4e2d\u82e5\u767c\u751f\u932f\u8aa4\uff0c\u6211\u5011\u4e5f\u6703\u6bd4\u8f03\u6e05\u695a\u662f\u5728\u54ea\u4e00\u500b\u74b0\u7bc0\u4e0a\u51fa\u4e86\u554f\u984c\u3002 \u5728\u9019\u500b playbook \u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u5169\u500b task\uff1a 1. test connection Info \u6211\u5011\u5728\u9019\u500b task \u4e2d\uff0c\u547c\u53eb\u4e86 Ansible \u7684\u5167\u5efa\u6e2c\u8a66\u6a21\u7d44 (module) - ping \u3002\u9019\u500b\u6a21\u7d44\u7684\u76ee\u7684\u975e\u5e38\u985e\u4f3c\u5728\u5b78\u7fd2\u6bcf\u500b\u8a9e\u8a00\u4e00\u958b\u59cb\u7df4\u7fd2\u7684 \"Hello World\" \u7a0b\u5f0f\u3002\u5176\u4e3b\u8981\u662f\u7528\u4f86\u6e2c\u8a66\u64cd\u63a7\u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u6b63\u78ba\u5730\u8207\u9059\u63a7\u7bc0\u9ede\u9032\u884c\u6e9d\u901a\uff0c\u5982\u679c\u9023\u7dda\u6b63\u5e38\uff0c\u9059\u63a7\u7bc0\u9ede\u5c31\u6703\u56de\u50b3\u4e00\u500b \"pong\" \u7684\u8a0a\u606f\u7d66\u63a7\u5236\u4e3b\u6a5f\u3002\u63a5\u8457\uff0c\u6211\u5011\u900f\u904e\u53e6\u4e00\u500b Ansible \u5167\u5efa\u6a21\u7d44 - register \u628a\u9059\u63a7\u7bc0\u9ede\u56de\u50b3\u7684\u8a0a\u606f\u5b58\u6210\u8b8a\u6578 (variable) \u7684\u5f62\u5f0f\u3002 \u6ce8\u610f\uff1a\u6b64\u8655\u7684 ping \u4e26\u975e\u5efa\u7acb\u5728 ICMP \u5354\u5b9a\u4e0b\u7684 ping \u6307\u4ee4\uff0c\u53ea\u662f\u7d14 Ansible \u958b\u767c\u7684\u4e00\u500b\u7c21\u55ae\u6e2c\u8a66\u6a21\u7d44\u3002 \u6a21\u7d44: ansible.builtin.ping 2. print debug message Info \u5728\u4e0a\u4e00\u500b task \u4e2d\uff0c\u6211\u5011\u5df2\u7d93\u628a ping \u5f8c\u7684\u7d50\u679c\u5b58\u5728 message \u9019\u500b\u8b8a\u6578\u4e2d\u4e86\u3002\u6211\u5011\u53ef\u4ee5\u5229\u7528 debug \u9019\u500b\u6a21\u7d44\u628a\u5132\u5b58\u7684\u8a0a\u606f\u8f38\u51fa\u5230\u6211\u5011\u7684\u7d42\u7aef\u6a5f\u4e0a\u3002\u5728 Ansible \u4e2d\uff0c\u82e5\u8981\u8abf\u7528\u5132\u5b58\u8b8a\u6578\uff0c\u6211\u5011\u5fc5\u9808\u5728\u8b8a\u6578\u540d\u7a31\u5916\u52a0\u4e0a\u5169\u500b\u5927\u62ec\u5f27 - {{ }} \u4f86\u544a\u8a34 Ansible \u5927\u62ec\u5f27\u5167\u7684\u662f\u4e00\u500b\u8b8a\u6578 \uff08\u5982\u679c\u8b8a\u6578\u5728\u63cf\u8ff0\u53e5 (statement) \u7684\u958b\u982d\uff0c\u9084\u5fc5\u9808\u8981\u984d\u5916\u52a0\u4e0a\u4e00\u500b\u96d9\u5f15\u865f - \"\"\uff09\u3002 \u6a21\u7d44: ansible.builtin.debug","title":"\u7b2c\u4e00\u500b playbook"},{"location":"ansible/ansible-intro/#playbook_2","text":"\u5229\u7528 Ansible-lint \u4f86\u6aa2\u67e5 playbook: $ ansible-lint playbook.yml \u5982\u679c\u6c92\u6709\u770b\u5230\u4efb\u4f55\u8f38\u51fa\u5c31\u8868\u793a\u4f60\u7684 playbook \u5b8c\u5168\u6c92\u6709\u554f\u984c\uff01\u4e0d\u904e\u70ba\u4e86\u5c55\u793a Ansible-lint \u7684\u63d0\u793a\u6548\u679c\uff0c\u6211\u5728 playbook \u7684\u7b2c\u4e94\u884c\u53e5\u5c3e\u52a0\u4e0a\u4e00\u500b\u7a7a\u767d\uff1a - name: test connection ~ \u63a5\u8457\uff0c\u91cd\u65b0\u8f38\u5165\u525b\u525b\u7684\u6307\u4ee4\uff1a $ ansible-lint playbook.yml WARNING Listing 1 violation ( s ) that are fatal yaml: trailing spaces ( yaml [ trailing-spaces ]) playbook.yml:5 You can skip specific rules or tags by adding them to your configuration file: # .config/ansible-lint.yml warn_list: # or 'skip_list' to silence them completely - yaml # Violations reported by yamllint. Finished with 1 failure ( s ) , 0 warning ( s ) on 1 files. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 Ansible-lint \u544a\u8a34\u6211\u5011\u5728 playbook.yml:5 \u7b2c\u4e94\u884c\u7684\u5730\u65b9\u6709\u500b\u5f8c\u7db4\u7a7a\u767d (trailing whitespace)\uff0c\u70ba\u4e86\u4fdd\u6301\u7a0b\u5f0f\u78bc\u7684\u7c21\u6f54\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u5176\u522a\u9664\u3002 \u5728\u5b9a\u7fa9\u597d\u4e86\u6211\u5011\u7684\u7b2c\u4e00\u500b playbook \u5f8c\uff0c\u63a5\u4e0b\u4f86\u5c31\u662f\u5982\u4f55\u904b\u884c\u6211\u5011\u5beb\u597d\u7684 playbook\u3002","title":"\u6aa2\u67e5 playbook"},{"location":"ansible/ansible-intro/#playbook_3","text":"\u8981\u900f\u904e Ansible \u4f86\u904b\u884c playbook \u76f8\u7576\u5bb9\u6613\uff0c\u6211\u5011\u53ea\u8981\u4f7f\u7528 ansible-playbook \u7684\u6307\u4ee4\u5c31\u53ef\u4ee5\u8f15\u6613\u904b\u884c\u6211\u5011\u7de8\u5beb\u597d\u7684 playbook\uff1a $ ansible-playbook playbook.yml \u57f7\u884c\u5b8c\u7562\u5f8c\u6211\u5011\u61c9\u8a72\u53ef\u4ee5\u5728\u7d42\u7aef\u6a5f\u4e0a\u770b\u5230\u4ee5\u4e0b\u7684\u8f38\u51fa\uff1a [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all' [WARNING]: Could not match supplied host pattern, ignoring: sre001 PLAY [sre001] ***************************************************************************************************************************************************************** skipping: no hosts matched PLAY RECAP ********************************************************************************************************************************************************************","title":"\u904b\u884c playbook"},{"location":"ansible/ansible-intro/#inventory","text":"\u5728\u770b\u5230\u8f38\u51fa\u7d50\u679c\u5f8c\uff0c\u6211\u76f8\u4fe1\u5927\u90e8\u5206\u7684\u8b80\u8005\u53ef\u80fd\u6703\u7d0d\u60b6\u70ba\u4ec0\u9ebc\u8f38\u51fa\u7d50\u679c\u6c92\u6709\u4efb\u4f55\u57f7\u884c\u6210\u529f\u6216\u5931\u6557\u7684\u8cc7\u8a0a\u3002\u5f9e\u7d42\u7aef\u6a5f\u7684\u7d50\u679c\u6211\u5011\u53ef\u4ee5\u77e5\u9053 Ansible \u4ec0\u9ebc\u4efb\u52d9\u90fd\u6c92\u6709\u505a\uff0c\u9019\u6a23\u7684\u7d50\u679c\u4e5f\u4e0d\u662f\u6211\u5011\u6240\u9810\u671f\u7684\u3002\u5728\u89e3\u6c7a\u9019\u554f\u984c\u4e4b\u524d\uff0c\u8b93\u6211\u5011\u5148\u56de\u61b6\u4e00\u4e0b\u6211\u5011\u4e4b\u524d\u64b0\u5beb\u7684 playbook.yml \uff1a playbook.yml --- - hosts : sre001 tasks : # task 1 - name : test connection ansible.builtin.ping : register : message # task 2 - name : print debug message ansible.builtin.debug : msg : \"{{ message }}\" \u5f9e\u9019\u4efd playbook \u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5f88\u6e05\u695a\u5730\u770b\u5230 Ansible \u61c9\u8a72\u8981\u5c0d sre001 \u9019\u53f0\u4e3b\u6a5f\u9032\u884c\u4efb\u52d9\u6e05\u55ae\u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002\u5728\u4e4b\u524d Vagrant \u4ecb\u7d39\u4e2d\uff0c\u6211\u5011\u7684\u78ba\u5c0d\u904b\u884c\u8d77\u4f86\u7684\u4e3b\u6a5f\u9032\u884c\u4e86\u547d\u540d\uff0c\u7136\u800c\uff0c\u6211\u5011\u537b\u5f9e\u4f86\u6c92\u6709\u544a\u8a34 Ansible \u904e\u54ea\u4e00\u53f0\u4e3b\u6a5f\u662f sre001 \u3002 \u56e0\u6b64\uff0c\u89e3\u6c7a\u9019\u500b\u554f\u984c\u6700\u76f4\u63a5\u7684\u65b9\u6cd5\u5c31\u662f\u5b9a\u7fa9\u4e00\u500b\u4e3b\u6a5f\u5217\u8868 inventory \u4e26\u8b93 Ansible \u53c3\u7167\uff0c\u9019\u6a23 Ansible \u624d\u6703\u77e5\u9053\u8a72\u5c0d\u8ab0\u505a\u4ec0\u9ebc\u4e8b\u3002 \u70ba\u4e86\u77e5\u9053 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u8a73\u7d30\u8cc7\u6599\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e vagrant ssh-config \u4f86\u5217\u51fa\u4e3b\u6a5f\u7684\u76f8\u95dc\u8cc7\u8a0a\uff1a $ vagrant ssh-config Host sre001 HostName 127 .0.0.1 User vagrant Port 2201 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL Tip \u6bcf\u4e00\u500b\u4eba\u7684\u56de\u61c9\u53ef\u80fd\u56e0\u500b\u4eba\u672c\u6a5f\u7684\u72c0\u6cc1\u6703\u6709\u6240\u4e0d\u540c\uff0c\u8acb\u7279\u5225\u6ce8\u610f Port \u8207 IdentifyFile \u7684\u8cc7\u8a0a\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728\u7576\u4e0b\u7684\u76ee\u9304\u4e0b\u65b0\u589e\u4e00\u500b\u6a94\u6848\u4e26\u547d\u540d\u70ba inventory . \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 Vagrantfile \u7136\u5f8c\u5728\u6a94\u6848\u5167\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a [sre001] 127.0.0.1 ansible_port=2201 ansible_user=vagrant ansible_ssh_common_args='-o StrictHostKeyChecking=no' \u6839\u64da vagrant ssh-config \u5217\u51fa\u4f86\u7684\u4e3b\u6a5f\u8cc7\u8a0a\uff0c\u6211\u5011\u5728 inventory \u4e2d\u4f9d\u5e8f\u5b9a\u7fa9\u4e86 sre001 \u9019\u53f0\u4e3b\u6a5f\u7684\u9023\u7dda IP\u3001port \u5165\u53e3\u4ee5\u53ca\u767b\u5165\u4f7f\u7528\u8005\u7684\u8eab\u4efd\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u91cd\u65b0\u57f7\u884c\u904b\u884c\u6307\u4ee4\uff0c\u4e26\u5c07\u9019\u4efd\u4e3b\u6a5f\u6e05\u55ae\u6307\u5b9a\u7d66 Ansible \u53c3\u7167\uff1a $ ansible-playbook -i inventory playbook.yml \u73fe\u5728\uff0c\u8f38\u51fa\u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** fatal: [127.0.0.1]: UNREACHABLE! => {\"changed\": false, \"msg\": \"Failed to connect to the host via ssh: @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\n@ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @\\r\\n@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\\r\\nIT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!\\r\\nSomeone could be eavesdropping on you right now (man-in-the-middle attack)!\\r\\nIt is also possible that a host key has just been changed.\\r\\nThe fingerprint for the ECDSA key sent by the remote host is\\nSHA256:7WcamAcB+cK5FXwfTxMiXBeovKpBFqpv4k4J6JzODYw.\\r\\nPlease contact your system administrator.\\r\\nAdd correct host key in /home/dxlab/.ssh/known_hosts to get rid of this message.\\r\\nOffending ECDSA key in /home/dxlab/.ssh/known_hosts:3\\r\\n remove with:\\r\\n ssh-keygen -f \\\"/home/dxlab/.ssh/known_hosts\\\" -R \\\"[127.0.0.1]:2201\\\"\\r\\nECDSA host key for [127.0.0.1]:2201 has changed and you have requested strict checking.\\r\\nHost key verification failed.\", \"unreachable\": true} PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=0 changed=0 unreachable=1 failed=0 skipped=0 rescued=0 ignored=0 \u73fe\u5728 Ansible \u77e5\u9053\u8ab0\u662f sre001 \u4e86\uff01\u4e0d\u904e\uff0c\u770b\u8d77\u4f86 Ansible \u4f3c\u4e4e\u4e26\u6c92\u6709\u8fa8\u6cd5\u5c07\u6211\u5011 playbook \u4e2d\u5b9a\u7fa9\u52d5\u4f5c\u6210\u529f\u5730\u90e8\u7f72\u5230 sre001 \u4e0a\u3002","title":"\u4ec0\u9ebc\u662f inventory?"},{"location":"ansible/ansible-intro/#private_key_file","text":"\u5f9e\u4e0a\u9762\u7684\u932f\u8aa4\u8a0a\u606f (error message) \u4e2d\u6211\u5011\u53ef\u4ee5\u77e5\u9053\u90e8\u7f72\u5931\u6557\u7684\u539f\u56e0\u767c\u751f\u5728 SSH \u9023\u7dda\u5931\u6557\u3002\u9084\u8a18\u5f97\u6211\u5011\u8aaa\u904e\u4f7f\u7528 Ansible \u90e8\u7f72\u9059\u63a7\u7bc0\u9ede\u5fc5\u9808\u8981\u900f\u904e SSH \u9023\u7dda\u55ce\uff1f\u4e00\u822c\u4f86\u8aaa\uff0c\u6211\u5011\u5982\u679c\u8981\u900f\u904e SSH \u5b58\u53d6\u7db2\u7ad9\u6211\u5011\u6703\u9810\u8a2d\u5c07\u7522\u751f\u51fa\u4f86\u7684\u516c\u7528\u91d1\u9470 (public key) \u5b58\u653e\u5728 ~/.ssh/ \u7684\u8def\u5f91\u4e0b\uff0c\u7136\u5f8c\u518d\u624b\u52d5\u5c07\u9019\u7d44\u91d1\u9470\u52a0\u5230\u6211\u5011\u60f3\u8981\u6388\u6b0a\u7684\u670d\u52d9\u5217\u8868\u4e0a\u3002 \u4e0d\u904e\uff0c\u56e0\u70ba\u6211\u5011\u662f\u4f7f\u7528 Vagrant \u5efa\u7acb\u8d77\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u4f5c\u70ba\u7df4\u7fd2\uff0cVagrant \u5176\u5be6\u5df2\u7d93\u4e8b\u5148\u5e6b\u6211\u5011\u628a\u63a7\u5236\u4e3b\u6a5f\u8207\u9059\u63a7\u7bc0\u9ede\u505a\u597d SSH \u914d\u5c0d\u4e86\uff0c\u6240\u4ee5\u6211\u5011\u4e26\u4e0d\u9700\u8981\u624b\u52d5\u8a2d\u5b9a\u9019\u500b\u90e8\u5206\u3002\u5f9e\u4e0a\u9762\u7684 vagrant ssh-config \u8f38\u51fa\u7684\u7d50\u679c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u4e00\u500b\u7279\u6b8a\u7684\u53c3\u6578\uff1a IdentityFile /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key \u9019\u500b\u53c3\u6578\u544a\u8a34\u4e86\u6211\u5011\u9019\u53f0\u865b\u64ec\u4e3b\u6a5f private key \u7684\u5b58\u653e\u4f4d\u7f6e\uff0c\u6211\u5011\u53ea\u9700\u8981\u900f\u904e\u4ee5\u4e0b\u6307\u4ee4\uff0c\u5c07\u9019\u500b\u6a94\u6848\u7684\u8def\u5f91\u6307\u5b9a\u7d66 Ansible\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6210\u529f\u904b\u884c\u6211\u5011\u7684 playbook \u56c9\uff01 $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u904b\u884c\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [test connection] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [print debug message] **************************************************************************************************************************************************** ok: [127.0.0.1] => { \"msg\": { \"changed\": false, \"failed\": false, \"ping\": \"pong\" } } PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6210\u529f\u63a5\u6536\u5230\u5f9e sre001 \u56de\u50b3\u56de\u4f86\u7684 \"pong\" \u4e86\uff01","title":"\u8a2d\u5b9a PRIVATE_KEY_FILE"},{"location":"ansible/ansible-intro/#ansible-role","text":"\u73fe\u5728\u5927\u5bb6\u61c9\u8a72\u4e86\u89e3\u5982\u4f55\u64b0\u5beb Ansible playbook \uff0c\u4e26\u5c07\u6211\u5011\u7684\u5de5\u4f5c\u6e05\u55ae\u4ee5 task \u7684\u65b9\u5f0f\u5728 playbook \u4e2d\u8868\u5217\u4e0b\u4f86\u3002\u7136\u800c\uff0c\u5982\u679c Ansible \u53ea\u80fd\u505a\u5230\u9019\u6a23\u7684\u7a0b\u5ea6\uff0c\u5145\u5176\u91cf\u6211\u5011\u53ea\u80fd\u8aaa\u9019\u662f\u4e00\u500b\u6bd4\u8f03\u65b9\u4fbf\u95b1\u8b80\u7684 Shell script \u7f77\u4e86\u3002\u82e5\u662f\u4eca\u5929\u6211\u5011\u6e05\u55ae\u4e2d\u7684\u4efb\u52d9\u6709\u4e0a\u767e\u500b\uff0c\u9019\u6a23\u6211\u5011\u7684 playbook \u4e5f\u53ef\u80fd\u6703\u8b8a\u5f97\u975e\u5e38\u5197\u9577\uff0c\u5c31\u7b97\u8a9e\u6cd5\u518d\u5982\u4f55\u6613\u8b80\uff0c\u6574\u9ad4\u800c\u8a00 playbook \u9084\u662f\u6703\u8b8a\u5f97\u5341\u5206\u96e3\u4ee5\u7406\u89e3\u3002 \u53e6\u5916\uff0c\u5f88\u591a\u6642\u5019\u5176\u5be6\u6211\u5011\u6703\u5e0c\u671b\u6709\u90e8\u5206\u7684\u90e8\u7f72\u5167\u5bb9\u662f\u53ef\u4ee5\u88ab\u5176\u4ed6\u4e0d\u540c\u7684 playbook \u91cd\u65b0\u4f7f\u7528\u3002\u8209\u4f8b\u4f86\u8aaa\uff0c\u5f88\u591a\u670d\u52d9\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 pip \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u4f86\u9032\u884c\u5b89\u88dd\uff0c\u6211\u5011\u4e26\u4e0d\u6703\u5e0c\u671b\u5728\u6bcf\u4e00\u500b\u4e0d\u540c\u7684 playbook \u4e2d\u90fd\u8981\u91cd\u65b0\u5b9a\u7fa9\u4e00\u6b21 pip \u7684\u5b89\u88dd\u65b9\u6cd5\u3002 \u56e0\u6b64\uff0c\u70ba\u4e86\u89e3\u6c7a\u4e0a\u8ff0\u7684\u554f\u984c\uff0cAnsible \u63d0\u4f9b\u4e86\u6211\u5011\u5728\u64b0\u5beb\u81ea\u52d5\u5316\u8173\u672c\u6642\u4e00\u500b\u89d2\u8272 role \u7684\u6982\u5ff5\u3002\u6211\u5011\u53ef\u4ee5\u900f\u904e\u64b0\u5beb\u5c6c\u65bc\u81ea\u5df1\u7684 role \u4f86\u8b93\u6240\u6709 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u85c9\u6b64\u63d0\u5347\u900f\u904e Ansible \u81ea\u52d5\u5316\u7684\u9748\u6d3b\u5ea6\u3002","title":"Ansible Role \u521d\u767b\u5834"},{"location":"ansible/ansible-intro/#role","text":"\u8003\u91cf\u5230\u7531\u65bc\u5b89\u88dd cURL \u7684\u9019\u500b\u5de5\u4f5c\u5f88\u53ef\u80fd\u6703\u5728\u672a\u4f86\u983b\u7e41\u5730\u88ab\u4e0d\u540c\u7684 playbook \u91cd\u8907\u4f7f\u7528\uff0c\u56e0\u6b64\uff0c\u6211\u5011\u9078\u64c7\u628a\u5b89\u88dd cURL \u7684\u65b9\u6cd5\u5beb\u6210\u4e00\u500b\u53ef\u4ee5\u91cd\u8907\u88ab\u5229\u7528\u7684 role \uff0c\u800c\u975e playbook \u4e2d\u7684\u4e00\u500b task\u3002 \u8b93\u6211\u5011\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848 (\u65b0\u589e roles/curl/main.yml )\uff1a workspace \u251c\u2500\u2500 Vagrantfile \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u2514\u2500\u2500 roles \u2514\u2500\u2500 curl \u2514\u2500\u2500 tasks \u2514\u2500\u2500 main.yml \u5728\u9019\u500b\u7d50\u69cb\u4e0b\uff0c curl \u5c31\u662f\u6211\u5011\u7684\u7b2c\u4e00\u500b role \u7684\u540d\u7a31\uff0c\u800c\u9019\u500b role \u7684\u5de5\u4f5c\u6d41\u7a0b\u5c31\u6703\u88ab\u6211\u5011\u5b9a\u7fa9\u5728\u4e0b\u9762\u7684 tasks/main.yml \u4e4b\u4e2d\u3002\u73fe\u5728\u6253\u958b curl/tasks/main.yml \u4e26\u5728\u5176\u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a curl/tasks/main.yml --- - name : install curl ansible.builtin.apt : name : curl \u6211\u5011\u5728\u9019\u500b role \u7684\u5167\u5bb9\u4e2d\u547c\u53eb\u4e86 Ansible \u5167\u5efa\u6a21\u7d44 apt \uff0c\u4e26\u5229\u7528\u5b83\u76f4\u63a5\u9032\u884c cURL \u7684\u5b89\u88dd\u3002\u63a5\u8457\uff0c\u6253\u958b\u6211\u5011\u7684 playbook.yml\uff0c\u4e26\u4fee\u6539\u70ba\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : ironman roles : - { role : curl , become : yes } \u6211\u5011\u522a\u9664\u4e86\u4e4b\u524d\u7528\u4f86\u6e2c\u8a66\u7684 ping \u5287\u78bc (play)\uff0c\u4e26\u5728\u9019\u500b playbook \u4e2d\u544a\u8a34 Ansible \u6211\u5011\u60f3\u8981\u57f7\u884c curl \u9019\u500b\u6211\u5011\u525b\u5b9a\u7fa9\u597d\u7684 role\u3002\u5176\u4e2d\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c become \u4ee3\u8868\u6211\u5011\u8981\u5347\u9ad8\u7576\u524d\u4f7f\u7528\u8005\u6b0a\u9650 \uff08\u7b49\u6548\u65bc Unix / Linux \u4e2d\u7684 sudo \u6307\u4ee4\uff09\u4f86\u904b\u884c\u7576\u524d\u5de5\u4f5c\u3002 \u6700\u5f8c\uff0c\u91cd\u65b0\u904b\u884c\u6211\u5011\u7684 playbook $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u5f97\u5230\u4ee5\u4e0b\u7d50\u679c\uff1a PLAY [sre001] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ******************************************************************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] **************************************************************************************************************************************************** ok: [127.0.0.1] PLAY RECAP ******************************************************************************************************************************************************************** 127.0.0.1 : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"\u7b2c\u4e00\u500b role"},{"location":"ansible/ansible-intro/#ansiblecfg","text":"\u6709\u4e9b\u6642\u5019\u6211\u5011\u60f3\u8981\u628a\u76f8\u95dc\u7684roles\u7f6e\u653e\u7684\u8def\u5f91\u505a\u4e0d\u540c\u7684\u898f\u5283\u6642\uff0cAnsible \u5c31\u6703\u627e\u4e0d\u5230\u5c0d\u61c9 role \u6a94\u6848\u7684\u4f4d\u7f6e\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5c31\u5fc5\u9808\u900f\u904e\u8a2d\u5b9a Ansible \u7684\u914d\u7f6e\u6a94\u6848 - ansible.cfg \u4f86\u8a2d\u7f6e role \u8def\u5f91 (path)\u3002 \u65b0\u589e\u4e00\u500b\u6a94\u6848 ansible.cfg \u4e26\u52a0\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a ansible.cfg [sre001] roles_path = ./roles \u82e5\u9ede\u9032\u5b98\u65b9\u914d\u7f6e\u6587\u4ef6\u7684\u8aaa\u660e\u9801\u9762\uff0c\u53ef\u4ee5\u767c\u73fe\u9664\u4e86 roles_path \u4e4b\u5916\u9084\u6709\u4e00\u5927\u5806\u53c3\u6578\u53ef\u4ee5\u4f9d\u64da\u4f7f\u7528\u8005\u7684\u9700\u6c42\u9032\u884c\u975e\u5e38\u6709\u5f48\u6027\u7684\u914d\u7f6e\u3002\u5176\u4e2d\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u5728\u9019\u500b\u793a\u7bc4\u88e1\u9762\u6211\u662f\u5c07 ansible.cfg \u9019\u500b\u914d\u7f6e\u6a94\u6848\u7f6e\u65bc\u6211\u5011\u5de5\u4f5c\u8cc7\u6599\u593e\u4e4b\u4e0b\uff0c\u76ee\u524d\u5177\u9ad4\u8cc7\u6599\u593e\u7d50\u69cb\u5982\u4e0b\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u2514\u2500\u2500 curl \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4f46\u5f9e\u5b98\u65b9\u6587\u4ef6\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u767c\u73fe\u9664\u4e86\u5c07\u914d\u7f6e\u6a94\u6848\u653e\u7f6e\u65bc\u5de5\u4f5c\u76ee\u9304\u5e95\u4e0b\u5916\uff0c\u9084\u6709\u5176\u4ed6\u5e7e\u7a2e\u4e0d\u540c\u7684\u914d\u7f6e\u65b9\u5f0f\uff1a \u8a2d\u7f6e\u74b0\u5883\u8b8a\u91cf ANSIBLE_CONFIG \u7f6e\u65bc\u7576\u524d\u76ee\u9304\u4e0b\u7684 ansible.cfg \uff08\u9019\u6b21\u7bc4\u4f8b\u4e2d\u4f7f\u7528\u7684\u65b9\u6cd5\uff09 \u7f6e\u65bc\u6839\u76ee\u9304\u4e0b\u7684 .ansible.cfg \u7f6e\u65bc /etc/ansible/ \u4e0b\u7684 ansible.cfg \u82e5\u6211\u5011\u540c\u6642\u5206\u5225\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u5b58\u5728\u5728\u7cfb\u7d71\u4e2d\uff0cAnsible \u6703\u4f9d\u7167\u4e0a\u8ff0\u9806\u5e8f\u9010\u4e00\u67e5\u627e\u6587\u4ef6\uff0c\u82e5\u627e\u5230\u5176\u4e2d\u4e00\u500b\uff0c\u5c31\u6703\u4f9d\u5176\u8a2d\u5b9a\u9032\u884c\u914d\u7f6e\uff0c\u4e26\u4e0d\u518d\u7e7c\u7e8c\u67e5\u627e\u3002","title":"\u914d\u7f6e ansible.cfg"},{"location":"ansible/ansible-intro/#ansible-role_1","text":"\u5728\u5b8c\u6210\u7b2c\u4e00\u500b\u7c21\u55ae\u7684 role \u4e4b\u5f8c\uff0c\u8b93\u6211\u5011\u8a66\u8457\u5b89\u88dd\u4e00\u500bCI/CD\u7684\u5de5\u5177 Jenkins\u3002","title":"\u5efa\u7acb Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2"},{"location":"ansible/ansible-intro/#jenkins","text":"\u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-jenkins-on-ubuntu-20-04 Jenkins \u5728 Ubuntu \u4e0a\u7684\u5b89\u88dd\u65b9\u5f0f\uff1a $ wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add - $ sudo sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list' $ sudo apt update $ sudo apt install jenkins \u7c21\u55ae\u4f86\u8aaa\uff0c\u6211\u5011\u6703\u5f9e Jenkins \u5b98\u65b9\u91cb\u51fa\u7684 Debian \u5957\u4ef6\u5eab\u4e2d\u5c07\u5bc6\u9470 (key) \u52a0\u5165\u672c\u5730\uff0c\u4e26\u65b0\u589e\u5c0d\u61c9\u7684\u5009\u5eab (repository) \u5165\u53e3\u3002\u6700\u5f8c\uff0c\u518d\u900f\u904e apt \u9019\u500b\u5957\u4ef6\u7ba1\u7406\u9032\u884c Jenkins \u7684\u5b89\u88dd\u3002\u73fe\u5728\u8b93\u6211\u5011\u628a\u4e0a\u9762\u7684\u6307\u4ee4\u7ffb\u8b6f\u6210 Ansible \u7684\u8173\u672c\uff1a --- - name : add jenkins key ansible.builtin.apt_key : url : https://pkg.jenkins.io/debian-stable/jenkins.io.key state : present - name : add jenkins repository ansible.builtin.apt_repository : repo : deb http://pkg.jenkins.io/debian-stable binary/ state : present - name : install jenkins ansible.builtin.apt : name : jenkins update_cache : yes Tip \u5728\u9019\u6b21\u7684\u4efb\u52d9\u4e2d\u6211\u5011\u4f7f\u7528\u4e86\u4e09\u500bAnsible\u7684\u6a21\u7d44: ansible.builtin.apt_key \u6a21\u7d44 ansible.builtin.apt_repository \u6a21\u7d44 ansible.builtin.apt \u6a21\u7d44 \u5176\u4e2d apt_key \u53ca apt_repository \u90fd\u662f Ansible \u5df2\u7d93\u5167\u5efa\u7684\u5169\u500b\u6a21\u7d44\uff0c\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5229\u7528\u5b83\u5011\u9032\u884c\u5bc6\u9470\u53ca\u5009\u5eab\u7684\u65b0\u589e\uff0c\u66f4\u591a\u7d30\u7bc0\u64cd\u4f5c\u53ef\u4ee5\u5728\u5b98\u65b9\u7684\u6587\u4ef6\u4e0a\u67e5\u770b\u3002\u800c\u5728 install jenkins \u9019\u500b task \u4e4b\u4e0b\u7684 update_cache \u5176\u5be6\u5c31\u662f\u7b49\u6548\u65bc\u6211\u5011\u5728\u4e00\u822c Ubuntu / Debian \u7cfb\u7d71\u4e0b\u4f7f\u7528 apt-get update \u7684\u6307\u4ee4\uff0c\u82e5\u5728\u64cd\u4f5c Ansible \u7684 apt \u9019\u500b\u6a21\u7d44\u6642\u4f7f\u7528\u4e86 update_cache: yes\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u6703\u5148\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 apt \u5957\u4ef6\u7ba1\u7406\u9032\u884c\u5347\u7d1a\u624d\u505a\u63a5\u4e0b\u4f86\u7684\u52d5\u4f5c\u3002 \u89e3\u91cb\u5b8c\u8981\u505a\u7684\u4e8b\u4ee5\u5f8c\uff0c\u9019\u6b21\u6211\u4e5f\u8981\u540c\u6642\u5c07\u6574\u500b\u5b89\u88dd Jenkins \u7684\u6d41\u7a0b\u5beb\u6210\u53e6\u5916\u4e00\u500b role\u3002\u4e00\u6a23\u7684\uff0c\u5728\u5de5\u4f5c\u8cc7\u6599\u593e\u4e0b\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e jenkins \u9019\u500b role\uff0c\u4e26\u5728 roles/jenkins/tasks/main.yml \u4e2d\u8f38\u5165\u4ee5\u4e0a\u5167\u5bb9\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 jenkins \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u73fe\u5728\u6211\u5011\u6709\u5169\u500b roles \u4e86\u3002\u56de\u5230\u6211\u5011\u7684 playbook.yml \u4f5c\u4ee5\u4e0b\u7684\u8abf\u6574: playbook.yml --- - hosts : sre001 roles : - { role : curl , become : yes } - { role : jenkins , become : yes } \u91cd\u65b0\u57f7\u884c playbook: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml PLAY [sre001] ************************************************************************************************************* TASK [Gathering Facts] **************************************************************************************************** ok: [127.0.0.1] TASK [curl : install curl] ************************************************************************************************ ok: [127.0.0.1] TASK [jenkins : add jenkins key] ****************************************************************************************** changed: [127.0.0.1] TASK [jenkins : add jenkins repository] *********************************************************************************** changed: [127.0.0.1] TASK [jenkins : install jenkins] ****************************************************************************************** fatal: [127.0.0.1]: FAILED! => {\"cache_update_time\": 1654304408, \"cache_updated\": true, \"changed\": false, \"msg\": \"'/usr/bin/apt-get -y -o \\\"Dpkg::Options::=--force-confdef\\\" -o \\\"Dpkg::Options::=--force-confold\\\" install 'jenkins'' failed: E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"rc\": 100, \"stderr\": \"E: Sub-process /usr/bin/dpkg returned an error code (1)\\n\", \"stderr_lines\": [\"E: Sub-process /usr/bin/dpkg returned an error code (1)\"], \"stdout\": \"Reading package lists...\\nBuilding dependency tree...\\nReading state information...\\nThe following additional packages will be installed:\\n net-tools\\nThe following NEW packages will be installed:\\n jenkins net-tools\\n0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\\nNeed to get 91.6 MB of archives.\\nAfter this operation, 95.9 MB of additional disk space will be used.\\nGet:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\\nGet:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\\nFetched 91.6 MB in 12s (7,593 kB/s)\\nSelecting previously unselected package net-tools.\\r\\n(Reading database ... \\r(Reading database ... 5%\\r(Reading database ... 10%\\r(Reading database ... 15%\\r(Reading database ... 20%\\r(Reading database ... 25%\\r(Reading database ... 30%\\r(Reading database ... 35%\\r(Reading database ... 40%\\r(Reading database ... 45%\\r(Reading database ... 50%\\r(Reading database ... 55%\\r(Reading database ... 60%\\r(Reading database ... 65%\\r(Reading database ... 70%\\r(Reading database ... 75%\\r(Reading database ... 80%\\r(Reading database ... 85%\\r(Reading database ... 90%\\r(Reading database ... 95%\\r(Reading database ... 100%\\r(Reading database ... 63489 files and directories currently installed.)\\r\\nPreparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\\r\\nUnpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSelecting previously unselected package jenkins.\\r\\nPreparing to unpack .../jenkins_2.332.3_all.deb ...\\r\\nUnpacking jenkins (2.332.3) ...\\r\\nSetting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\\r\\nSetting up jenkins (2.332.3) ...\\r\\nCreated symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\\r\\nJob for jenkins.service failed because the control process exited with error code.\\r\\nSee \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\\r\\ninvoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\\r\\n\u25cf jenkins.service - Jenkins Continuous Integration Server\\r\\n Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\\r\\n Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\\r\\n Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\\r\\n Main PID: 3569 (code=exited, status=1/FAILURE)\\r\\ndpkg: error processing package jenkins (--configure):\\r\\n installed jenkins package post-installation script subprocess returned error exit status 1\\r\\nProcessing triggers for man-db (2.9.1-1) ...\\r\\nProcessing triggers for systemd (245.4-4ubuntu3.17) ...\\r\\nErrors were encountered while processing:\\r\\n jenkins\\r\\n\", \"stdout_lines\": [\"Reading package lists...\", \"Building dependency tree...\", \"Reading state information...\", \"The following additional packages will be installed:\", \" net-tools\", \"The following NEW packages will be installed:\", \" jenkins net-tools\", \"0 upgraded, 2 newly installed, 0 to remove and 1 not upgraded.\", \"Need to get 91.6 MB of archives.\", \"After this operation, 95.9 MB of additional disk space will be used.\", \"Get:2 http://archive.ubuntu.com/ubuntu focal/main amd64 net-tools amd64 1.60+git20180626.aebd88e-1ubuntu1 [196 kB]\", \"Get:1 https://pkg.jenkins.io/debian-stable binary/ jenkins 2.332.3 [91.4 MB]\", \"Fetched 91.6 MB in 12s (7,593 kB/s)\", \"Selecting previously unselected package net-tools.\", \"(Reading database ... \", \"(Reading database ... 5%\", \"(Reading database ... 10%\", \"(Reading database ... 15%\", \"(Reading database ... 20%\", \"(Reading database ... 25%\", \"(Reading database ... 30%\", \"(Reading database ... 35%\", \"(Reading database ... 40%\", \"(Reading database ... 45%\", \"(Reading database ... 50%\", \"(Reading database ... 55%\", \"(Reading database ... 60%\", \"(Reading database ... 65%\", \"(Reading database ... 70%\", \"(Reading database ... 75%\", \"(Reading database ... 80%\", \"(Reading database ... 85%\", \"(Reading database ... 90%\", \"(Reading database ... 95%\", \"(Reading database ... 100%\", \"(Reading database ... 63489 files and directories currently installed.)\", \"Preparing to unpack .../net-tools_1.60+git20180626.aebd88e-1ubuntu1_amd64.deb ...\", \"Unpacking net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Selecting previously unselected package jenkins.\", \"Preparing to unpack .../jenkins_2.332.3_all.deb ...\", \"Unpacking jenkins (2.332.3) ...\", \"Setting up net-tools (1.60+git20180626.aebd88e-1ubuntu1) ...\", \"Setting up jenkins (2.332.3) ...\", \"Created symlink /etc/systemd/system/multi-user.target.wants/jenkins.service \u2192 /lib/systemd/system/jenkins.service.\", \"Job for jenkins.service failed because the control process exited with error code.\", \"See \\\"systemctl status jenkins.service\\\" and \\\"journalctl -xe\\\" for details.\", \"invoke-rc.d: initscript jenkins, action \\\"start\\\" failed.\", \"\u25cf jenkins.service - Jenkins Continuous Integration Server\", \" Loaded: loaded (\\u001b]8;;file://ubuntu-focal/lib/systemd/system/jenkins.service\\u0007/lib/systemd/system/jenkins.service\\u001b]8;;\\u0007; enabled; vendor preset: enabled)\", \" Active: activating (auto-restart) (Result: exit-code) since Sat 2022-06-04 01:00:24 UTC; 7ms ago\", \" Process: 3569 ExecStart=/usr/bin/jenkins \\u001b[0;1;31m(code=exited, status=1/FAILURE)\\u001b[0m\", \" Main PID: 3569 (code=exited, status=1/FAILURE)\", \"dpkg: error processing package jenkins (--configure):\", \" installed jenkins package post-installation script subprocess returned error exit status 1\", \"Processing triggers for man-db (2.9.1-1) ...\", \"Processing triggers for systemd (245.4-4ubuntu3.17) ...\", \"Errors were encountered while processing:\", \" jenkins\"]} PLAY RECAP **************************************************************************************************************** 127.0.0.1 : ok=4 changed=2 unreachable=0 failed=1 skipped=0 rescued=0 ignored=0 \u57f7\u884c\u7684\u7d50\u679c\u5728 install jenkins \u51fa\u73fe\u5931\u6557\u3002\u53bb\u67e5\u8a62 Jenkins \u5b98\u7db2\u767c\u73fe Jenkins \u5fc5\u9700\u8981\u4f9d\u8cf4 Java \u624d\u80fd\u5920\u6b63\u78ba\u904b\u884c\u4e4b\u524d\uff0c\u4e5f\u5c31\u662f\u8aaa\u9664\u4e86\u5728 ansible \u4e2d\u8a2d\u5b9a\u5b89\u88dd Java \u4e4b\u5916, \u9084\u5fc5\u9700\u8b93 jenkins \u662f\u5728 java \u5b89\u88dd\u5b8c\u4e4b\u5f8c\u624d\u80fd\u63a5\u7e8c\u5b89\u88dd\u3002 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-install-java-with-apt-on-ubuntu-20-04#installing-specific-versions-of-openjdk","title":"\u81ea\u52d5\u5316 Jenkins \u5b89\u88dd"},{"location":"ansible/ansible-intro/#ansible-role_2","text":"\u5728 Ansible \u7684\u4e16\u754c\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u900f\u904e\u5b9a\u7fa9 role \u8207 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2 role dependencies \u4f86\u63d0\u5347\u6bcf\u4e00\u500b role \u7684\u53ef\u8b80\u6027\u8207\u76f8\u4e92\u7684\u4f9d\u8cf4\u3002\u5c31\u4ee5\u4e0a\u9762\u7684\u4f8b\u5b50\u800c\u8a00\uff0c\u6211\u5011\u5e0c\u671b\u6240\u6709\u90e8\u7f72 Jenkins \u7684\u4f3a\u670d\u5668\u90fd\u9810\u5148\u642d\u8f09\u597d Java\uff0c\u82e5\u7528 Ansible \u7684\u89d2\u5ea6\u601d\u8003\uff0c\u9019\u5c31\u610f\u5473\u8457\u6211\u5011\u5e0c\u671b jenkins \u9019\u500b role \u4f9d\u8cf4\u65bc openjre \u9019\u500b role\u3002\u6211\u5011\u53ef\u4ee5\u5728\u6bcf\u4e00\u500b role \u7684\u8cc7\u6599\u593e\u4e2d\u900f\u904e meta \u9019\u500b\u5b50\u76ee\u9304\u5b9a\u7fa9\u9019\u6a23\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u5177\u9ad4\u6b65\u9a5f\u5982\u4e0b\uff1a \u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e\u6a94\u6848\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u5728 roles \u7684\u76ee\u9304\u4e0b\u5efa\u7acb openjre\\tasks \u7684\u5b50\u76ee\u9304\u4e26\u4e14\u5efa\u7acb\u4e00\u500b\u65b0\u6a94\u6848 main.yml : openjre\\tasks\\main.yml --- - name : install openjre ansible.builtin.apt : name : default-jre update_cache : yes \u4e0a\u8ff0\u7684 role \u6703\u7528\u4f86\u5b89\u88dd Java JRE runtime\u3002 jenkins/meta/main.yml --- dependencies : - { role : openjre , become : yes } \u5b9a\u7fa9 jenkins \u9019\u500b role \u4f9d\u8cf4\u4e8e openjre \u7684 role\u3002 \u56de\u5230 playbook.yml \u4e2d\u522a\u9664\u539f\u672c\u547c\u53eb curl role \u7684\u90e8\u5206\uff0c\u53ea\u7559\u4e0b jenkins\uff1a: playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=5 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6839\u64da role \u7684\u65b0\u7d50\u69cb\uff0c\u6211\u5011\u6bcf\u6b21\u53ea\u8981\u547c\u53eb jenkins \u9019\u500b role\uff0c\u5728\u5b89\u88dd Jenkins \u4e4b\u524d\uff0cAnsible \u5c31\u6703\u81ea\u52d5\u5148\u5e6b\u6211\u5011\u628a\u6240\u6709\u5b9a\u7fa9\u5728 meta \u4e2d\u7684\u670d\u52d9\u4f9d\u8cf4\u5b89\u88dd\u597d\u3002\u82e5\u672a\u4f86\u5728 jenkins \u9019\u500b role \u4e0a\u8981\u65b0\u589e\u6216\u79fb\u9664\u670d\u52d9\u4f9d\u8cf4\uff0c\u6211\u5011\u53ea\u9700\u8981\u56de\u5230 meta \u4e2d\u505a\u4fee\u6539\u5373\u53ef\u3002 \u900f\u904e\u5b9a\u7fa9 role \u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u6211\u5011\u53ef\u4ee5\u5728 playbook \u4e2d\u53ea\u55ae\u7d14\u547c\u53eb\u9700\u8981\u7684 role\uff0c\u800c\u4e0d\u7528\u56de\u5230\u5e95\u5c64\u601d\u8003\u904b\u884c\u9019\u500b role \u4e4b\u524d\u6211\u5011\u9084\u9700\u8981\u5b89\u88dd\u4ec0\u9ebc\u984d\u5916\u7684\u670d\u52d9\u3002\u9019\u6a23\u7684\u8a2d\u8a08\u908f\u8f2f\u4e0d\u4f46\u53ef\u4ee5\u5c07\u6bcf\u4e00\u500b role \u90fd\u8996\u70ba\u5df2\u7d93\u5b8c\u5168\u53ef\u4ee5\u7528\u7684\u5de5\u5177\uff0c\u5728\u7dad\u8b77\u7684\u89d2\u5ea6\u4e0a\u4e5f\u4f7f\u5b89\u88dd\u7d50\u69cb\u66f4\u4f73\u6e05\u6670\u6613\u61c2\u3002 \u958b\u767c\u4eba\u54e1\u904e\u53bb\u5f80\u5f80\u56e0\u70ba\u7e41\u7463\u7684\u5b89\u88dd\u6d41\u7a0b\u96e3\u514d\u758f\u5ffd\u5176\u4e2d\u5e7e\u500b\u524d\u7f6e\u670d\u52d9\u5b89\u88dd\uff0c\u9032\u800c\u5c0e\u81f4\u5f8c\u9762\u90e8\u7f72\u6d41\u7a0b\u767c\u751f\u7684\u932f\u8aa4\uff0c\u900f\u904e\u9019\u6a23\u7684\u8a2d\u8a08\u6d41\u7a0b\uff0c\u5c07\u53ef\u4ee5\u5fb9\u5e95\u88ab\u89e3\u6c7a\u3002","title":"Ansible Role \u7684\u4f9d\u8cf4\u95dc\u4fc2"},{"location":"ansible/ansible-intro/#role_1","text":"\u6211\u5011\u5c07\u65b0\u589e\u4e00\u500b role \u7528\u4f86\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u55ae\u4e00\u500b role \u540c\u6642\u652f\u63f4\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u7684\u4e3b\u6a5f\u3002","title":"Role \u8de8\u7cfb\u7d71\u7684\u9748\u6d3b\u5ea6"},{"location":"ansible/ansible-intro/#git","text":"\u5beb\u53e6\u4e00\u500b\u7368\u7acb\u7684 role \u4f86\u5b89\u88dd Git\u3002\u4f9d\u7167\u4ee5\u4e0b\u7d50\u69cb\u65b0\u589e git \u9019\u500b role\uff1a workspace \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 inventory \u251c\u2500\u2500 playbook.yml \u251c\u2500\u2500 roles \u2502 \u251c\u2500\u2500 curl \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u251c\u2500\u2500 git \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yaml \u2502 \u251c\u2500\u2500 jenkins \u2502 \u2502 \u251c\u2500\u2500 meta \u2502 \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2502 \u2514\u2500\u2500 tasks \u2502 \u2502 \u2514\u2500\u2500 main.yml \u2502 \u2514\u2500\u2500 openjre \u2502 \u2514\u2500\u2500 tasks \u2502 \u2514\u2500\u2500 main.yml \u2514\u2500\u2500 Vagrantfile \u4e26\u5728 roles/git/tasks/main.yml \u4e2d\u5beb\u5165\u4ee5\u4e0b\u5167\u5bb9\uff1a roles/git/tasks/main.yml --- - name : install git ansible.builtin.yum : name : git-all when : ansible_distribution == 'CentOS' - name : install git ansible.builtin.apt : name : git when : ansible_distribution == 'Ubuntu' or ansible_distribution == 'Debian' \u9664\u4e86\u975e\u5e38\u985e\u4f3c\u65bc\u4e4b\u524d curl \u9019\u500b role \u7684\u5b89\u88dd\u6d41\u7a0b\uff0c\u9019\u6b21\u6211\u5011\u5728 role \u88e1\u9762\u52a0\u4e0a\u4e86\u7cfb\u7d71\u5224\u65b7\u689d\u4ef6\u3002\u7531\u65bc Ubuntu \u8ddf Debian \u9019\u5169\u7a2e\u4e3b\u8981\u7684 Linux \u4f5c\u696d\u7cfb\u7d71\u9810\u8a2d\u90fd\u662f\u642d\u8f09 apt \u505a\u70ba\u5957\u4ef6\u7ba1\u7406\uff0c\u6240\u4ee5\u7576\u6211\u5011\u4eca\u5929\u53ea\u8981\u904b\u884c\u9019\u500b role\uff0c\u4e26\u5224\u65b7\u9059\u63a7\u4e3b\u6a5f\u662f\u9019\u5169\u500b\u4f5c\u696d\u7cfb\u7d71\u4e4b\u4e00\u7684\u6642\u5019\uff0c\u6211\u5011\u5c31\u6703\u904b\u884c\u4e0a\u9762\u5b9a\u7fa9\u7684\u4efb\u52d9\u3002 \u53e6\u5916\uff0c\u7531\u65bc git \u9019\u500b role \u7406\u8ad6\u4e0a\u5728\u672a\u4f86\u88ab\u91cd\u8907\u5229\u7528\u5230\u7684\u983b\u7387\u6703\u975e\u5e38\u9ad8\uff0c\u56e0\u6b64\u6211\u5728\u9019\u88e1\u540c\u6642\u4e5f\u65b0\u589e\u4e86\u5728 CentOS \u9019\u5957\u4f5c\u696d\u7cfb\u7d71\u4e0a\u4f7f\u7528 yum \u5b89\u88dd Git \u7684\u65b9\u6cd5\uff08\u5728 yum \u5957\u4ef6\u7ba1\u7406\u7cfb\u7d71\u4e2d\uff0cGit \u5957\u4ef6\u7684\u540d\u7a31\u8207 apt \u7cfb\u7d71\u4e26\u4e0d\u76f8\u540c\uff09\uff0c\u4ee5\u589e\u52a0\u9019\u500b role \u7684\u4f7f\u7528\u9748\u6d3b\u6027\u3002 \u63a5\u8457\u4fee\u6539 playbook.yml : playbook.yml --- - hosts : sre001 roles : - { role : jenkins , become : yes } - { role : git , become : yes } \u91cd\u65b0\u904b\u884c playbook.yml: $ ansible-playbook -i inventory --private-key /home/dxlab/opt/vagrant_getting_started/.vagrant/machines/sre001/virtualbox/private_key playbook.yml \u7d50\u679c\u5982\u4e0b\uff1a PLAY [sre001] ********************************************************************************************** TASK [Gathering Facts] ************************************************************************************* ok: [127.0.0.1] TASK [openjre : install openjre] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins key] *************************************************************************** ok: [127.0.0.1] TASK [jenkins : add jenkins repository] ******************************************************************** ok: [127.0.0.1] TASK [jenkins : install jenkins] *************************************************************************** ok: [127.0.0.1] TASK [git : install git] *********************************************************************************** skipping: [127.0.0.1] TASK [git : install git] *********************************************************************************** ok: [127.0.0.1] PLAY RECAP ************************************************************************************************* 127.0.0.1 : ok=6 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u6211\u5011\u53ef\u4ee5\u770b\u5230 Ansible \u6703\u6839\u64da\u5c0d\u61c9\u7684\u4f5c\u696d\u7cfb\u7d71\u5224\u65b7\u54ea\u4e9b tasks \u53ef\u4ee5\u88ab\u7565\u904e (skipping)\uff0c\u9019\u4e5f\u662f\u70ba\u4ec0\u9ebc\u6211\u5011\u4e0d\u9700\u8981\u7279\u5225\u70ba\u4e0d\u540c\u4f5c\u696d\u7cfb\u7d71\u4fdd\u5b58\u591a\u4efd\u7248\u672c\u7684 role\uff0c\u53ea\u8981\u5c08\u6ce8\u5728\u540c\u4e00\u500b role \u4e2d\u958b\u767c\u7576\u524d\u4efb\u52d9\u5373\u53ef\u3002 \u53e6\u5916\uff0c\u82e5\u4ed4\u7d30\u95b1\u8b80\u5728\u7d42\u7aef\u6a5f\u4e0a\u986f\u793a\u7684 Ansible \u5b89\u88dd\u6d41\u7a0b\uff0c\u61c9\u8a72\u6703\u767c\u73fe\u5df2\u7d93\u88ab\u5b89\u88dd\u904e\u7684\u670d\u52d9\u4e26\u4e0d\u6703\u4e00\u76f4\u91cd\u8907\u88ab\u5b89\u88dd\u3002\u986f\u793a\u70ba changed \u8868\u793a\u9059\u63a7\u4e3b\u6a5f\u5728\u9019\u6b21\u904b\u884c playbook \u7684\u904e\u7a0b\u88e1\uff0cAnsible \u5728\u8a72\u9805 task \u4e2d\u5c0d\u7cfb\u7d71\u505a\u4e86\u6539\u8b8a\uff1bok \u5247\u8868\u793a\u8a72 task \u7684\u5b8c\u6210\u689d\u4ef6\u5df2\u6eff\u8db3\uff0c\u6240\u4ee5 Ansible \u4e26\u4e0d\u6703\u984d\u5916\u5c0d\u4e3b\u6a5f\u505a\u5176\u4ed6\u8b8a\u52d5\u3002 \u7279\u5225\u9700\u8981\u89e3\u91cb\u7684\u662f\uff0c\u82e5\u6211\u5011\u4f7f\u7528\u4e86 update_cache: yes \u9019\u9805\u5c6c\u6027\u4f86\u900f\u904e\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u5b89\u88dd\u670d\u52d9\u3002\u6211\u5011\u6bcf\u6b21\u5b89\u88dd\u670d\u52d9\u524d\u90fd\u6703\u8a66\u5716\u5c07\u5957\u4ef6\u7ba1\u7406\u5de5\u5177\u7684\u7248\u672c\u90fd\u66f4\u65b0\u5230\u7576\u524d\u6700\u65b0\u7248\u672c\uff0c\u7136\u5f8c\u624d\u9032\u884c\u5b89\u88dd\u6b65\u9a5f\uff0c\u56e0\u6b64\u6bcf\u6b21 task \u7684\u72c0\u614b\u90fd\u5c07\u6703\u986f\u793a\u70ba changed\u3002","title":"\u5b89\u88dd Git"},{"location":"ansible/ansible-intro/#ansible-galaxy","text":"Ansible Galaxy \u662f\u4e00\u500b Ansible \u5b98\u65b9\u63d0\u4f9b\u7684 Ansible Role \u5171\u4eab\u5e73\u53f0\u3002\u6240\u6709 Ansible \u7684\u4f7f\u7528\u8005\u90fd\u53ef\u4ee5\u81ea\u7531\u4e0a\u50b3\u81ea\u5df1\u7684 role \u8207\u5168\u4e16\u754c\u7684\u958b\u767c\u4eba\u54e1\u5206\u4eab\u3002 \u5728\u63a5\u5230\u4efb\u52d9\u9700\u6c42\u524d\uff0c\u5efa\u8b70\u8b80\u8005\u53ef\u4ee5\u82b1\u500b\u5e7e\u5206\u9418\u5728\u4e0a\u9762\u7a0d\u5fae\u700f\u89bd\u4e00\u4e0b\uff0c\u770b\u770b\u662f\u5426\u6709\u9069\u5408\u81ea\u5df1\u4f7f\u7528\u7684\u73fe\u6210 role \u7684\u53ef\u4ee5\u7acb\u523b\u62ff\u4f86\u4f7f\u7528\u3002\u4e0d\u904e\uff0c\u70ba\u907f\u514d\u8b80\u8005\u6df7\u6dc6\uff0c\u9019\u6b21\u5c31\u4e0d\u7279\u5225\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 ansible-galaxy \u4f86\u8abf\u7528\u5176\u4ed6\u958b\u767c\u8005\u7684 role\uff0c\u6709\u8208\u8da3\u7684\u8b80\u8005\u53ef\u4ee5\u81ea\u884c\u53c3\u95b1\u5b98\u65b9\u4f7f\u7528\u6559\u5b78\u3002","title":"Ansible Galaxy"},{"location":"ansible/ansible-intro/#vagrant-forward-port","text":"\u7531\u65bc Jenkins \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 8080\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8a66\u8457\u628a\u9059\u63a7\u7bc0\u9ede\u7684 port 8080 \u5ee3\u64ad\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u3002\u4e0d\u904e\uff0c\u7531\u65bc port 8080 \u662f\u4e00\u500b\u975e\u5e38\u5bb9\u6613\u88ab\u5176\u4ed6\u670d\u52d9\u4f7f\u7528\u7684 port\uff0c\u70ba\u4e86\u907f\u514d\u885d\u7a81\uff0c\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07\u9059\u63a7\u7bc0\u9ede\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u63a7\u5236\u4e3b\u6a5f\u4e0a\u7684 port 9080\u3002 \u5728 Vagrantfile \u4e2d\uff0c\u76f4\u63a5\u5728 config.vm.define \"sre001\" \u8a72\u884c\u4e0b\u9762\u65b0\u589e\u4ee5\u4e0b\u8a2d\u5b9a\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"forwarded_port\" , guest : 8080 , host : 9080 end \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a $ vagrant reload \u9019\u6a23\u8868\u793a\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5728\u63a7\u5236\u4e3b\u6a5f\u4e0a\u4f7f\u7528 port 9080 \u4f86\u8a2a\u554f\u9059\u63a7\u7bc0\u9ede\u4e0a port 8080 \u7684\u670d\u52d9\u3002\u73fe\u5728\u91cd\u65b0\u555f\u52d5 Vagrant \u4e3b\u6a5f\u4f86\u8b93\u65b0\u8a2d\u5b9a\u751f\u6548\uff1a == > sre001: Attempting graceful shutdown of VM... == > sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > sre001: Clearing any previously set forwarded ports... == > sre001: Fixed port collision for 22 = > 2222 . Now on port 2201 . == > sre001: Clearing any previously set network interfaces... == > sre001: Preparing network interfaces based on configuration... sre001: Adapter 1 : nat == > sre001: Forwarding ports... sre001: 8080 ( guest ) = > 9080 ( host ) ( adapter 1 ) sre001: 22 ( guest ) = > 2201 ( host ) ( adapter 1 ) == > sre001: Running 'pre-boot' VM customizations... == > sre001: Booting VM... == > sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127 .0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key == > sre001: Machine booted and ready! == > sre001: Checking for guest additions in VM... == > sre001: Mounting shared folders... sre001: /vagrant = > /home/dxlab/opt/vagrant_getting_started == > sre001: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > sre001: flag to force provisioning. Provisioners marked to run always will still run. \u6211\u5011\u53ef\u4ee5\u5f9e\u4e0a\u9762\u8cc7\u8a0a\u4e2d\u770b\u5230 Vagrant \u5df2\u7d93\u5e6b\u6211\u5011\u628aVM\u4e0a\u7684 port 8080 \u6620\u5c04\u5230\u672c\u6a5f\u7684 port 9080 \u4e86\u3002\u73fe\u5728\u5617\u8a66\u900f\u904e\u700f\u89bd\u5668\u8a2a\u554f http://localhost:9080 \u5c31\u61c9\u8a72\u53ef\u4ee5\u9806\u5229\u9032\u5165 Jenkins \u7684\u521d\u59cb\u5316\u9801\u9762\u4e86\uff1a","title":"\u8a2d\u5b9a Vagrant forward port"},{"location":"ansible/ansible-intro/#_1","text":"\u5f9e\u672c\u6b21\u7684\u5feb\u901f\u5165\u9580\u6559\u7a0b\u4e2d\u6211\u5011\u5feb\u901f\u5730\u4ecb\u8a54\u4e86 Ansible \u6700\u91cd\u8981\u7684\u57fa\u672c\u6982\u5ff5: ansible config inventory playbook tasks roles modules control node / manage node","title":"\u7d50\u8ad6"},{"location":"ansible/use_sshpass_to_login_for_ansible/","text":"\u5728 Ansible \u4f7f\u7528\u57fa\u65bc SSH \u5bc6\u78bc\u7684\u767b\u5165 \u00b6 \u539f\u6587: https://linuxhint.com/how_to_use_sshpass_to_login_for_ansible/ \u5728\u672c\u6587\u4e2d\uff0c\u6211\u5c07\u5411\u60a8\u5c55\u793a\u5982\u4f55\u4f7f\u7528\u57fa\u65bc SSH \u5bc6\u78bc\u7684\u767b\u5165\u548c sshpass \u4f86\u904b\u884c Ansible playbook\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u5982\u679c\u60a8\u60f3\u5617\u8a66\u672c\u6587\u4e2d\u8a0e\u8ad6\u7684\u793a\u4f8b\uff0c \u4f60\u5fc5\u9808\u5728\u60a8\u7684\u6a5f\u53f0\u4e0a\u5b89\u88dd Ansible\u3002 \u4f60\u5fc5\u9808\u81f3\u5c11\u6709\u4e00\u500b\u53ef\u4ee5\u5f9e Ansible \u9023\u63a5\u7684 Ubuntu/Debian \u4e3b\u6a5f\u3002 \u4f60\u9084\u9700\u8981\u5728\u4f60\u7684\u8a08\u7b97\u6a5f\u4e0a\u5b89\u88dd sshpass \u5728\u672c\u6587\u4e2d\u5411\u60a8\u5c55\u793a\u5982\u4f55\u5728 Ubuntu/Debian \u548c CentOS/RHEL \u4e0a\u5b89\u88dd sshpass \u3002\u5982\u679c\u60a8\u7684\u7cfb\u7d71\u4e0a\u5c1a\u672a\u5b89\u88dd\u9019\u4e9b\u7a0b\u5e8f\uff0c\u8acb\u4e0d\u8981\u64d4\u5fc3\u3002 \u5728 Ubuntu/Debian \u4e0a\u5b89\u88dd sshpass \u00b6 \u7a0b\u5e8f sshpass \u5728 Ubuntu/Debian \u7684\u5b98\u65b9\u8edf\u4ef6\u5305\u5b58\u5132\u5eab\u4e2d\u53ef\u7528\u3002\u60a8\u53ef\u4ee5\u8f15\u9b06\u5730\u5728\u60a8\u7684\u8a08\u7b97\u6a5f\u4e0a\u5b89\u88dd\u6b64\u7a0b\u5e8f\u3002 \u5728 Ubuntu/Debian \u4e0a\u5b89\u88dd sshpass \u5728 CentOS 8/RHEL 8 \u4e0a\u5b89\u88dd sshpass \u9996\u5148\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u66f4\u65b0 APT \u5305\u5b58\u5132\u5eab\u7de9\u5b58\uff1a $ sudo apt update \u73fe\u5728\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd sshpass\uff1a $ sudo apt install sshpass -y sshpass \u5728 CentOS 8/RHEL 8 \u7684 EPEL \u5b58\u5132\u5eab\u4e2d\u53ef\u7528\u3002\u60a8\u5fc5\u9808\u555f\u7528 EPEL \u5b58\u5132\u5eab\u624d\u80fd\u5b89\u88dd sshpass\u3002 \u9996\u5148\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u66f4\u65b0 DNF \u5305\u5b58\u5132\u5eab\u7de9\u5b58\uff1a $ sudo dnf makecache \u63a5\u4e0b\u4f86\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd EPEL \u5b58\u5132\u5eab\u5305\uff1a $ sudo dnf install epel-release -y \u73fe\u5728\u61c9\u8a72\u5b89\u88dd EPEL \u5b58\u5132\u5eab\u5305\u4e26\u4e14\u61c9\u8a72\u555f\u7528 EPEL \u5b58\u5132\u5eab\u3002 \u518d\u6b21\u66f4\u65b0 DNF \u5305\u5009\u5eab\u7de9\u5b58\uff0c\u5982\u4e0b\uff1a $ sudo dnf makecache \u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd sshpass\uff1a $ sudo dnf install sshpass -y \u5230\u9019\u500b\u6b65\u9a5f sshpass \u61c9\u8a72\u5b89\u88dd\u597d\u4e86\uff0c\u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u958b\u59cb\u9032\u884c\u6709\u95dc ansilbe \u5c08\u6848\u7684\u914d\u7f6e\u3002 \u8a2d\u7f6e Ansible \u5c08\u6848\u76ee\u9304 \u00b6 \u5275\u5efa\u5c08\u6848\u76ee\u9304 sshpass/ \u548c\u6240\u6709\u5fc5\u9700\u7684\u5b50\u76ee\u9304\uff08\u5728\u60a8\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u4e2d\uff09\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ mkdir -pv ~/sshpass/ { files,playbooks } \u5c0e\u822a\u5230\u9805\u76ee\u76ee\u9304\uff0c\u5982\u4e0b\uff1a $ cd ~/sshpass/ \u5275\u5efa\u4e3b\u6a5f\u6e05\u55ae\u6587\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ nano hosts \u6bd4\u5982\uff1a hosts vm01 ansible_host=10.16.10.11 ansible_user=my_vm_user vm01 - \u4e3b\u6a5f hostname \u6216\u662f\u4e3b\u6a5f\u5225\u540d (alias)\uff0c\u5982\u679c\u6c92\u6709\u8a2d\u5b9a ansible_host \u7684\u8a71\uff0c\u90a3\u9ebc\u5c31\u5f97\u8a2d\u5b9a\u7684\u662f DNS \u53ef\u89e3\u6790\u7684\u4e3b\u6a5f FQDN\u3002 ansible_host - ansible \u8981\u9023\u7dda\u7684\u5230\u7684\u4e3b\u6a5f IP address ansible_user - ansible \u8981\u4f7f\u7528 ssh \u9023\u7dda\u9032\u53bb\u6642\u6240\u4f7f\u7528\u7684\u7528\u6236\u540d ansible_ssh_pass (optional)- ansible \u8981\u4f7f\u7528 ssh \u9023\u7dda\u9032\u53bb\u6642\u6240\u4f7f\u7528\u7684\u7528\u6236\u5bc6\u78bc ansible_become (optional)- ansible \u9700\u8981\u5207\u63db\u6210 root \u89d2\u8272\u7684 flag (\"true/yes\") ansible_become_method (optional) - \u53ef\u4f7f\u7528\u7684\u5207\u63db\u65b9\u6cd5 sudo/su/pbrun/pfexec/doas/dzdo/ksu ansible_become_user (optional) - ansible \u9700\u8981\u5207\u63db\u89d2\u8272\u7528\u6236, \u9810\u8a2d\u662f root ansible_become_password (optional) - ansible \u9700\u8981\u5207\u63db\u89d2\u8272\u7528\u6236\u7684\u7528\u6236\u5bc6\u78bc \u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6dfb\u52a0\u60a8\u7684\u4e3b\u6a5f IP \u6216 FQDN \u540d\u7a31\u3002 \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002 \u5728\u9805\u76ee\u76ee\u9304\u4e0b\u5275\u5efa\u4e00\u500bAnsible\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u4e0b\uff1a $ nano ansible.cfg Rancher Manage Cluster \u73fe\u5728\uff0c\u5728 ansible.cfg \u6587\u4ef6\u4e2d\u9375\u5165\u4ee5\u4e0b\u5167\u5bb9\u3002 ansible.cfg [defaults] inventory = hosts host_key_checking = False \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002 \u5728 Ansible \u4e2d\u6e2c\u8a66\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304 \u00b6 \u63a5\u4e0b\u4f86\uff0c\u5617\u8a66 ping \u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u4e3b\u6a5f\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible all -u { user_name } -m ping Info \u6ce8\u610f\uff1a \u9019\u88e1\uff0c -u \u9078\u9805\u7528\u65bc\u544a\u8a34 ansible \u4ee5\u54ea\u500b\u7528\u6236\u8eab\u4efd\u767b\u9304\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5c07\u662f\u7528\u6236 shovon \u3002\u5f9e\u73fe\u5728\u958b\u59cb\uff0c\u5728\u6574\u500b\u6f14\u793a\u904e\u7a0b\u4e2d\uff0c\u5c07\u6b64\u7528\u6236\u540d\u66ff\u63db\u70ba\u60a8\u7684\u7528\u6236\u540d\u3002 \u5982\u60a8\u6240\u898b\uff0c\u6211\u7121\u6cd5\u767b\u9304\u4e3b\u6a5f\u4e26\u904b\u884c\u4efb\u4f55\u547d\u4ee4\u3002 vm01 | UNREACHABLE! => { \"changed\": false, \"msg\": \"Failed to connect to the host via ssh: dxlab@192.168.56.8: Permission denied (publickey,password).\", \"unreachable\": true } \u8981\u5f37\u5236 Ansible \u8a62\u554f\u7528\u6236\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\u5e36\u6709 --ask-pass \u53c3\u6578\u7684 ansible \u547d\u4ee4\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible all -u { user_name } --ask-pass -m ping Ansible \u6703\u8981\u6c42\u8f38\u5165\u7528\u6236\u7684 SSH \u5bc6\u78bc\u3002\u73fe\u5728\uff0c\u8f38\u5165\u60a8\u7684 SSH \u5bc6\u78bc\uff08\u7528\u6236\u767b\u9304\u5bc6\u78bc\uff09\u4e26\u6309 \u3002 \u73fe\u5728\u6211\u5011\u53ef\u4ee5 ping \u901a\u4e3b\u6a5f\uff0c\u5982\u4e0b\uff1a vm01 | SUCCESS => { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python3\" }, \"changed\": false, \"ping\": \"pong\" } Playbook \u57fa\u65bc Ansible \u5bc6\u78bc\u7684 SSH \u767b\u9304 \u00b6 \u904b\u884c Ansible playbook \u6642\uff0c\u53ef\u4ee5\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304\u3002\u8b93\u6211\u5011\u770b\u4e00\u500b\u4f8b\u5b50\u3002 \u9996\u5148\u5728 playbooks/ \u76ee\u9304\u4e0b\u65b0\u5efa\u4e00\u500b\u65b0\u7684 playbook askpass1.yaml \uff0c\u6bd4\u8f38\u5165\u5167\u5bb9\u5982\u4e0b\uff1a - hosts : all user : shovon tasks : - name : Ping all hosts ping : - name : Print a message debug : msg : 'All set' \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002 \u904b\u884c askpass1.yaml playbook\uff0c\u5982\u4e0b\uff1a $ ansible-playbook playbooks/askpass1.yaml \u5982\u60a8\u6240\u898b\uff0c\u6211\u7121\u6cd5\u9023\u63a5\u5230\u4e3b\u6a5f\u3002\u60a8\u53ef\u4ee5\u770b\u5230\u9019\u662f\u56e0\u70ba\u6211\u6c92\u6709\u904b\u884c\u5e36\u6709 --ask-pass \u9078\u9805\u7684 ansible-playbook \u547d\u4ee4\u3002 \u7d50\u679c\u5982\u4e0b: $ ansible-playbook playbooks/askpass1.yaml PLAY [all] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************* fatal: [vm01]: UNREACHABLE! => {\"changed\": false, \"msg\": \"Failed to connect to the host via ssh: dxlab@192.168.56.8: Permission denied (publickey,password).\", \"unreachable\": true} PLAY RECAP ************************************************************************************************************************************* vm01 : ok=0 changed=0 unreachable=1 failed=0 skipped=0 rescued=0 ignored=0 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u4f7f\u7528 --ask-pass \u9078\u9805\u904b\u884c askpass1.yaml playbook\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook --ask-pass playbooks/askpass1.yaml SSH password: PLAY [ all ] ************************************************************************************************************************************* TASK [ Gathering Facts ] ************************************************************************************************************************* ok: [ vm01 ] TASK [ Ping all hosts ] ************************************************************************************************************************** ok: [ vm01 ] TASK [ Print a message ] ************************************************************************************************************************* ok: [ vm01 ] = > { \"msg\" : \"All set\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 3 changed = 0 unreachable = 0 failed = 0 skipped = 0 rescued = 0 ignored = 0 \u5982\u60a8\u6240\u898b\uff0cAnsible \u8981\u6c42\u8f38\u5165 SSH \u5bc6\u78bc\u3002\u8f38\u5165\u60a8\u7684 SSH \u5bc6\u78bc\u4e26\u6309 \u3002playbook askpass1.yaml \u73fe\u5728\u61c9\u8a72\u53ef\u4ee5\u6210\u529f\u904b\u884c\u3002 \u7528\u65bc Playbook \u7684 Ansible sudo \u5bc6\u78bc\u767b\u9304 \u00b6 --ask-pass \u9078\u9805\u5c07\u50c5\u8a62\u554f SSH \u767b\u9304\u5bc6\u78bc\u3002\u5982\u679c\u60a8\u9084\u60f3\u8f38\u5165 sudo \u5bc6\u78bc\u600e\u9ebc\u8fa6\uff1f\u60a8\u5c07\u5728\u63a5\u4e0b\u4f86\u7684\u6b65\u9a5f\u4e2d\u770b\u5230\u5982\u4f55\u57f7\u884c\u6b64\u64cd\u4f5c\u3002 \u9996\u5148\u5728 playbooks/ \u76ee\u9304\u4e0b\u65b0\u5efa playbook askpass2.yaml \uff0c\u5982\u4e0b\uff1a askpass2.yaml - hosts : all user : shovon become : True tasks : - name : Install apache2 Package apt : name : apache2 state : latest - name : Make sure apache2 service is running service : name : apache2 state : started enabled : True - name : Copy index.html file to server copy : src : ../files/index.html dest : /var/www/html/index.html mode : 0644 owner : www-data group : www-data \u5728\u9019\u88e1\uff0c\u6211\u4f7f\u7528\u4e86\u547d\u4ee4 become: True \u4f86\u544a\u8a34 Ansible \u4ee5 sudo \u6b0a\u9650\u904b\u884c\u9019\u500b playbook\u3002\u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58 askpass2.yaml \u6587\u4ef6\u3002 \u5728 files/ \u76ee\u9304\u4e0b\u5275\u5efa\u4e00\u500b index.html \u6587\u4ef6\uff0c\u5982\u4e0b\uff1a $ nano files/index.html \u5728 index.html \u6587\u4ef6\u4e2d\u9375\u5165\u4ee5\u4e0b HTML \u4ee3\u78bc\uff1a index.html <!DOCTYPE html> < html > < head > < title > Homepage </ title > </ head > < body > < h1 > Hello World </ h1 > < p > It works </ p > </ body > </ html > \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X \u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 --ask-pass \u9078\u9805\u904b\u884c askpass2.yaml playbook\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook --ask-pass playbooks/askpass2.yaml SSH password: PLAY [ all ] ************************************************************************************************************************************* TASK [ Gathering Facts ] ************************************************************************************************************************* fatal: [ vm01 ] : FAILED! = > { \"msg\" : \"Missing sudo password\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 0 changed = 0 unreachable = 0 failed = 1 skipped = 0 rescued = 0 ignored = 0 \u4f46\u662f\u5373\u4f7f\u60a8\u63d0\u4f9b SSH \u5bc6\u78bc\uff0cplaybook \u4ecd\u7136\u53ef\u80fd\u7121\u6cd5\u904b\u884c\u3002\u9019\u6a23\u505a\u7684\u539f\u56e0\u662f\u56e0\u70ba\u60a8\u5fc5\u9808\u544a\u8a34 Ansible \u63d0\u793a\u8f38\u5165 sudo \u5bc6\u78bc\u4ee5\u53ca SSH \u5bc6\u78bc\u3002 \u60a8\u53ef\u4ee5\u5728\u904b\u884c playbook \u6642\u4f7f\u7528 --ask-become-pass \u9078\u9805\u544a\u8a34 Ansible \u8a62\u554f sudo \u5bc6\u78bc\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook --ask-pass --ask-become-pass playbooks/askpass2.yaml SSH password: BECOME password [ defaults to SSH password ] : PLAY [ all ] ************************************************************************************************************************************* TASK [ Gathering Facts ] ************************************************************************************************************************* fatal: [ vm01 ] : FAILED! = > { \"ansible_facts\" : {} , \"changed\" : false, \"failed_modules\" : { \"ansible.legacy.setup\" : { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"failed\" : true, \"module_stderr\" : \"Shared connection to 192.168.56.8 closed.\\r\\n\" , \"module_stdout\" : \"\\r\\ndxlab is not in the sudoers file. This incident will be reported.\\r\\n\" , \"msg\" : \"MODULE FAILURE\\nSee stdout/stderr for the exact error\" , \"rc\" : 1 }} , \"msg\" : \"The following modules failed to execute: ansible.legacy.setup\\n\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 0 changed = 0 unreachable = 0 failed = 1 skipped = 0 rescued = 0 ignored = 0 Ansible \u5c07\u63d0\u793a\u60a8\u8f38\u5165 SSH \u5bc6\u78bc\u3002\u63a5\u4e0b\u4f86\uff0cAnsible \u5c07\u63d0\u793a\u60a8\u8f38\u5165 sudo \u5bc6\u78bc\u3002\u5982\u679c\u60a8\u7684 sudo \u5bc6\u78bc\u8207 SSH \u5bc6\u78bc\u76f8\u540c\uff08\u5f88\u53ef\u80fd\uff09\uff0c\u8acb\u5c07\u5176\u7559\u7a7a\u4e26\u6309 \u3002 ... TASK [ Gathering Facts ] ************************************************************************************************************************* fatal: [ vm01 ] : FAILED! = > { \"ansible_facts\" : {} , \"changed\" : false, \"failed_modules\" : { \"ansible.legacy.setup\" : { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"failed\" : true, \"module_stderr\" : \"Shared connection to 192.168.56.8 closed.\\r\\n\" , \"module_stdout\" : \"\\r\\ndxlab is not in the sudoers file. This incident will be reported.\\r\\n\" , \"msg\" : \"MODULE FAILURE\\nSee stdout/stderr for the exact error\" , \"rc\" : 1 }} , \"msg\" : \"The following modules failed to execute: ansible.legacy.setup\\n\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 0 changed = 0 unreachable = 0 failed = 1 skipped = 0 rescued = 0 ignored = 0 ... \u4e0a\u8ff0\u7684\u932f\u8aa4\u8a0a\u606f xxx is not in the sudoers file \u4ee3\u8868\u8005 ssh \u767b\u5165\u7684\u5e33\u6236\u4e26\u6c92\u6709\u88ab\u8a2d\u7f6e\u9032 suoers \u6a94\u6848\u5c0e\u81f4\u4e86\u554f\u984c\u3002 Linux \u628a\u7528\u6236\u548c\u7fa4\u7d44\u7684 sudo \u6b0a\u9650\u5728 /etc/sudoers \u6587\u4ef6\u4e2d\u5b9a\u7fa9\u3002\u5c07\u7528\u6236\u6dfb\u52a0\u5230\u6b64\u6587\u4ef6\u5141\u8a31\u60a8\u6388\u4e88\u5c0d\u547d\u4ee4\u7684\u81ea\u5b9a\u7fa9\u8a2a\u554f\u6b0a\u9650\u4e26\u914d\u7f6e\u81ea\u5b9a\u7fa9\u5b89\u5168\u7b56\u7565\u3002 \u767b\u5165\u6709\u554f\u984c\u7684\u6a5f\u53f0\u5e76\u4e14\u5207\u63db\u5e76\u4e14\u4f7f\u7528 root \u5e33\u6236\u4f86\u5c07 \u5c07 vagrant ssh-user \u52a0\u5165 Sudoer \u7684\u5217\u8868\uff1a $ sudo usermod -aG sudo shovon \u518d\u91cd\u65b0\u57f7\u884c\u4e00\u6b21 playbook: $ ansible-playbook --ask-pass --ask-become-pass playbooks/askpass2.yaml SSH password: BECOME password [ defaults to SSH password ] : PLAY [ all ] *********************************************************************************************************************************** TASK [ Gathering Facts ] *********************************************************************************************************************** ok: [ vm01 ] TASK [ Install apache2 Package ] *************************************************************************************************************** changed: [ vm01 ] TASK [ Make sure apache2 service is running ] ************************************************************************************************** ok: [ vm01 ] TASK [ Copy index.html file to server ] ******************************************************************************************************** changed: [ vm01 ] PLAY RECAP *********************************************************************************************************************************** vm01 : ok = 4 changed = 2 unreachable = 0 failed = 0 skipped = 0 rescued = 0 ignored = 0 \u5982\u60a8\u6240\u898b\uff0c\u5287\u672c\u904b\u884c\u6210\u529f\u3002 \u914d\u7f6e\u81ea\u52d5\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304\u548c sudo \u5bc6\u78bc\u767b\u9304 \u00b6 \u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u548c sudo \u767b\u9304\uff0c\u4f46\u4e0d\u60f3\u5728\u6bcf\u6b21\u904b\u884c playbook \u6642\u90fd\u8f38\u5165 SSH \u5bc6\u78bc\u548c sudo \u5bc6\u78bc\u3002\u5982\u679c\u662f\u9019\u7a2e\u60c5\u6cc1\uff0c\u90a3\u9ebc\u672c\u7bc0\u9069\u5408\u60a8\u3002 \u8981\u5728\u4e0d\u63d0\u793a\u8f38\u5165\u5bc6\u78bc\u7684\u60c5\u6cc1\u4e0b\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304\u548c sudo \u767b\u9304\uff0c\u60a8\u6240\u8981\u505a\u7684\u5c31\u662f\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6dfb\u52a0 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u3002 \u9996\u5148\uff0c\u6253\u958b hosts \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u5982\u4e0b\uff1a $ nano hosts \u5982\u679c\u6e05\u55ae\u6587\u4ef6\u4e2d\u6709\u591a\u500b\u4e3b\u6a5f\u4e26\u4e14\u6bcf\u500b\u4e3b\u6a5f\u90fd\u6709\u4e0d\u540c\u7684\u5bc6\u78bc\uff0c\u5247\u6dfb\u52a0 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u4f5c\u70ba\u4e3b\u6a5f\u8b8a\u91cf\uff08\u5728\u6bcf\u500b\u4e3b\u6a5f\u4e4b\u5f8c\uff09\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u8acb\u52d9\u5fc5\u5c07 secret \u66ff\u63db\u70ba\u60a8\u7684 SSH \u548c sudo \u5bc6\u78bc\u3002 vm01 ansible_host=192.168.56.9 ansible_port=22 ansible_user=dxlab ansible_ssh_pass=****** ansible_become_pass=******* \u5982\u679c\u6240\u6709\u6216\u90e8\u5206\u4e3b\u6a5f\u7684\u5bc6\u78bc\u76f8\u540c\uff0c\u5247\u53ef\u4ee5\u5c07 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u6dfb\u52a0\u70ba\u4e3b\u6a5f\u7fa4\u7d44\u8b8a\u91cf\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002 \u5728\u9019\u88e1\uff0c\u6211\u53ea\u6709\u4e00\u500b\u4e3b\u6a5f\uff0c\u6240\u4ee5\u6211\u70ba all \u7d44\uff08\u5eab\u5b58\u6587\u4ef6\u4e2d\u7684\u6240\u6709\u4e3b\u6a5f\uff09\u6dfb\u52a0\u4e86 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u3002\u4f46\u662f\uff0c\u60a8\u4e5f\u53ef\u4ee5\u70ba\u5176\u4ed6\u7279\u5b9a\u7d44\u6dfb\u52a0\u9019\u4e9b\u8b8a\u91cf\u3002 vm01 ansible_host=192.168.56.9 ansible_port=22 [all:vars] ansible_user=dxlab ansible_ssh_pass=***** ansible_become_pass=***** \u5728\u4e3b\u6a5f\u6e05\u55ae\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5b8c ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u4e3b\u6a5f\u6e05\u55ae\u6587\u4ef6\u3002 \u60a8\u73fe\u5728\u53ef\u4ee5\u904b\u884c askpass2.yaml \u5287\u672c\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook playbooks/askpass2.yaml PLAY [ all ] ***************************************************************************************************************************************************** TASK [ Gathering Facts ] ***************************************************************************************************************************************** ok: [ vm01 ] TASK [ Install apache2 Package ] ********************************************************************************************************************************* ok: [ vm01 ] TASK [ Make sure apache2 service is running ] ******************************************************************************************************************** ok: [ vm01 ] TASK [ Copy index.html file to server ] ************************************************************************************************************************** ok: [ vm01 ] PLAY RECAP ***************************************************************************************************************************************************** vm01 : ok = 4 changed = 0 unreachable = 0 failed = 0 skipped = 0 rescued = 0 ignored = 0 \u5982\u60a8\u6240\u898b\uff0cplaybook \u904b\u884c\u6210\u529f\uff0c\u5118\u7ba1\u5b83\u6c92\u6709\u8981\u6c42\u8f38\u5165 SSH \u5bc6\u78bc\u6216 sudo \u5bc6\u78bc\u3002 \u56e0\u6b64\uff0c\u9019\u5c31\u662f\u5728 Ansible \u4e2d\u4f7f\u7528 sshpass \u9032\u884c\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u548c sudo \u767b\u9304\u7684\u65b9\u5f0f\u3002","title":"Ansible \u4f7f\u7528\u57fa\u65bc SSH \u5bc6\u78bc\u767b\u5165"},{"location":"ansible/use_sshpass_to_login_for_ansible/#ansible-ssh","text":"\u539f\u6587: https://linuxhint.com/how_to_use_sshpass_to_login_for_ansible/ \u5728\u672c\u6587\u4e2d\uff0c\u6211\u5c07\u5411\u60a8\u5c55\u793a\u5982\u4f55\u4f7f\u7528\u57fa\u65bc SSH \u5bc6\u78bc\u7684\u767b\u5165\u548c sshpass \u4f86\u904b\u884c Ansible playbook\u3002","title":"\u5728 Ansible \u4f7f\u7528\u57fa\u65bc SSH \u5bc6\u78bc\u7684\u767b\u5165"},{"location":"ansible/use_sshpass_to_login_for_ansible/#_1","text":"\u5982\u679c\u60a8\u60f3\u5617\u8a66\u672c\u6587\u4e2d\u8a0e\u8ad6\u7684\u793a\u4f8b\uff0c \u4f60\u5fc5\u9808\u5728\u60a8\u7684\u6a5f\u53f0\u4e0a\u5b89\u88dd Ansible\u3002 \u4f60\u5fc5\u9808\u81f3\u5c11\u6709\u4e00\u500b\u53ef\u4ee5\u5f9e Ansible \u9023\u63a5\u7684 Ubuntu/Debian \u4e3b\u6a5f\u3002 \u4f60\u9084\u9700\u8981\u5728\u4f60\u7684\u8a08\u7b97\u6a5f\u4e0a\u5b89\u88dd sshpass \u5728\u672c\u6587\u4e2d\u5411\u60a8\u5c55\u793a\u5982\u4f55\u5728 Ubuntu/Debian \u548c CentOS/RHEL \u4e0a\u5b89\u88dd sshpass \u3002\u5982\u679c\u60a8\u7684\u7cfb\u7d71\u4e0a\u5c1a\u672a\u5b89\u88dd\u9019\u4e9b\u7a0b\u5e8f\uff0c\u8acb\u4e0d\u8981\u64d4\u5fc3\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/use_sshpass_to_login_for_ansible/#ubuntudebian-sshpass","text":"\u7a0b\u5e8f sshpass \u5728 Ubuntu/Debian \u7684\u5b98\u65b9\u8edf\u4ef6\u5305\u5b58\u5132\u5eab\u4e2d\u53ef\u7528\u3002\u60a8\u53ef\u4ee5\u8f15\u9b06\u5730\u5728\u60a8\u7684\u8a08\u7b97\u6a5f\u4e0a\u5b89\u88dd\u6b64\u7a0b\u5e8f\u3002 \u5728 Ubuntu/Debian \u4e0a\u5b89\u88dd sshpass \u5728 CentOS 8/RHEL 8 \u4e0a\u5b89\u88dd sshpass \u9996\u5148\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u66f4\u65b0 APT \u5305\u5b58\u5132\u5eab\u7de9\u5b58\uff1a $ sudo apt update \u73fe\u5728\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd sshpass\uff1a $ sudo apt install sshpass -y sshpass \u5728 CentOS 8/RHEL 8 \u7684 EPEL \u5b58\u5132\u5eab\u4e2d\u53ef\u7528\u3002\u60a8\u5fc5\u9808\u555f\u7528 EPEL \u5b58\u5132\u5eab\u624d\u80fd\u5b89\u88dd sshpass\u3002 \u9996\u5148\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u66f4\u65b0 DNF \u5305\u5b58\u5132\u5eab\u7de9\u5b58\uff1a $ sudo dnf makecache \u63a5\u4e0b\u4f86\uff0c\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd EPEL \u5b58\u5132\u5eab\u5305\uff1a $ sudo dnf install epel-release -y \u73fe\u5728\u61c9\u8a72\u5b89\u88dd EPEL \u5b58\u5132\u5eab\u5305\u4e26\u4e14\u61c9\u8a72\u555f\u7528 EPEL \u5b58\u5132\u5eab\u3002 \u518d\u6b21\u66f4\u65b0 DNF \u5305\u5009\u5eab\u7de9\u5b58\uff0c\u5982\u4e0b\uff1a $ sudo dnf makecache \u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd sshpass\uff1a $ sudo dnf install sshpass -y \u5230\u9019\u500b\u6b65\u9a5f sshpass \u61c9\u8a72\u5b89\u88dd\u597d\u4e86\uff0c\u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u958b\u59cb\u9032\u884c\u6709\u95dc ansilbe \u5c08\u6848\u7684\u914d\u7f6e\u3002","title":"\u5728 Ubuntu/Debian \u4e0a\u5b89\u88dd sshpass"},{"location":"ansible/use_sshpass_to_login_for_ansible/#ansible","text":"\u5275\u5efa\u5c08\u6848\u76ee\u9304 sshpass/ \u548c\u6240\u6709\u5fc5\u9700\u7684\u5b50\u76ee\u9304\uff08\u5728\u60a8\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u4e2d\uff09\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ mkdir -pv ~/sshpass/ { files,playbooks } \u5c0e\u822a\u5230\u9805\u76ee\u76ee\u9304\uff0c\u5982\u4e0b\uff1a $ cd ~/sshpass/ \u5275\u5efa\u4e3b\u6a5f\u6e05\u55ae\u6587\u4ef6\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ nano hosts \u6bd4\u5982\uff1a hosts vm01 ansible_host=10.16.10.11 ansible_user=my_vm_user vm01 - \u4e3b\u6a5f hostname \u6216\u662f\u4e3b\u6a5f\u5225\u540d (alias)\uff0c\u5982\u679c\u6c92\u6709\u8a2d\u5b9a ansible_host \u7684\u8a71\uff0c\u90a3\u9ebc\u5c31\u5f97\u8a2d\u5b9a\u7684\u662f DNS \u53ef\u89e3\u6790\u7684\u4e3b\u6a5f FQDN\u3002 ansible_host - ansible \u8981\u9023\u7dda\u7684\u5230\u7684\u4e3b\u6a5f IP address ansible_user - ansible \u8981\u4f7f\u7528 ssh \u9023\u7dda\u9032\u53bb\u6642\u6240\u4f7f\u7528\u7684\u7528\u6236\u540d ansible_ssh_pass (optional)- ansible \u8981\u4f7f\u7528 ssh \u9023\u7dda\u9032\u53bb\u6642\u6240\u4f7f\u7528\u7684\u7528\u6236\u5bc6\u78bc ansible_become (optional)- ansible \u9700\u8981\u5207\u63db\u6210 root \u89d2\u8272\u7684 flag (\"true/yes\") ansible_become_method (optional) - \u53ef\u4f7f\u7528\u7684\u5207\u63db\u65b9\u6cd5 sudo/su/pbrun/pfexec/doas/dzdo/ksu ansible_become_user (optional) - ansible \u9700\u8981\u5207\u63db\u89d2\u8272\u7528\u6236, \u9810\u8a2d\u662f root ansible_become_password (optional) - ansible \u9700\u8981\u5207\u63db\u89d2\u8272\u7528\u6236\u7684\u7528\u6236\u5bc6\u78bc \u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6dfb\u52a0\u60a8\u7684\u4e3b\u6a5f IP \u6216 FQDN \u540d\u7a31\u3002 \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002 \u5728\u9805\u76ee\u76ee\u9304\u4e0b\u5275\u5efa\u4e00\u500bAnsible\u914d\u7f6e\u6587\u4ef6\uff0c\u5982\u4e0b\uff1a $ nano ansible.cfg Rancher Manage Cluster \u73fe\u5728\uff0c\u5728 ansible.cfg \u6587\u4ef6\u4e2d\u9375\u5165\u4ee5\u4e0b\u5167\u5bb9\u3002 ansible.cfg [defaults] inventory = hosts host_key_checking = False \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002","title":"\u8a2d\u7f6e Ansible \u5c08\u6848\u76ee\u9304"},{"location":"ansible/use_sshpass_to_login_for_ansible/#ansible-ssh_1","text":"\u63a5\u4e0b\u4f86\uff0c\u5617\u8a66 ping \u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u4e3b\u6a5f\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible all -u { user_name } -m ping Info \u6ce8\u610f\uff1a \u9019\u88e1\uff0c -u \u9078\u9805\u7528\u65bc\u544a\u8a34 ansible \u4ee5\u54ea\u500b\u7528\u6236\u8eab\u4efd\u767b\u9304\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5c07\u662f\u7528\u6236 shovon \u3002\u5f9e\u73fe\u5728\u958b\u59cb\uff0c\u5728\u6574\u500b\u6f14\u793a\u904e\u7a0b\u4e2d\uff0c\u5c07\u6b64\u7528\u6236\u540d\u66ff\u63db\u70ba\u60a8\u7684\u7528\u6236\u540d\u3002 \u5982\u60a8\u6240\u898b\uff0c\u6211\u7121\u6cd5\u767b\u9304\u4e3b\u6a5f\u4e26\u904b\u884c\u4efb\u4f55\u547d\u4ee4\u3002 vm01 | UNREACHABLE! => { \"changed\": false, \"msg\": \"Failed to connect to the host via ssh: dxlab@192.168.56.8: Permission denied (publickey,password).\", \"unreachable\": true } \u8981\u5f37\u5236 Ansible \u8a62\u554f\u7528\u6236\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\u5e36\u6709 --ask-pass \u53c3\u6578\u7684 ansible \u547d\u4ee4\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible all -u { user_name } --ask-pass -m ping Ansible \u6703\u8981\u6c42\u8f38\u5165\u7528\u6236\u7684 SSH \u5bc6\u78bc\u3002\u73fe\u5728\uff0c\u8f38\u5165\u60a8\u7684 SSH \u5bc6\u78bc\uff08\u7528\u6236\u767b\u9304\u5bc6\u78bc\uff09\u4e26\u6309 \u3002 \u73fe\u5728\u6211\u5011\u53ef\u4ee5 ping \u901a\u4e3b\u6a5f\uff0c\u5982\u4e0b\uff1a vm01 | SUCCESS => { \"ansible_facts\": { \"discovered_interpreter_python\": \"/usr/bin/python3\" }, \"changed\": false, \"ping\": \"pong\" }","title":"\u5728 Ansible \u4e2d\u6e2c\u8a66\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304"},{"location":"ansible/use_sshpass_to_login_for_ansible/#playbook-ansible-ssh","text":"\u904b\u884c Ansible playbook \u6642\uff0c\u53ef\u4ee5\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304\u3002\u8b93\u6211\u5011\u770b\u4e00\u500b\u4f8b\u5b50\u3002 \u9996\u5148\u5728 playbooks/ \u76ee\u9304\u4e0b\u65b0\u5efa\u4e00\u500b\u65b0\u7684 playbook askpass1.yaml \uff0c\u6bd4\u8f38\u5165\u5167\u5bb9\u5982\u4e0b\uff1a - hosts : all user : shovon tasks : - name : Ping all hosts ping : - name : Print a message debug : msg : 'All set' \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002 \u904b\u884c askpass1.yaml playbook\uff0c\u5982\u4e0b\uff1a $ ansible-playbook playbooks/askpass1.yaml \u5982\u60a8\u6240\u898b\uff0c\u6211\u7121\u6cd5\u9023\u63a5\u5230\u4e3b\u6a5f\u3002\u60a8\u53ef\u4ee5\u770b\u5230\u9019\u662f\u56e0\u70ba\u6211\u6c92\u6709\u904b\u884c\u5e36\u6709 --ask-pass \u9078\u9805\u7684 ansible-playbook \u547d\u4ee4\u3002 \u7d50\u679c\u5982\u4e0b: $ ansible-playbook playbooks/askpass1.yaml PLAY [all] ************************************************************************************************************************************* TASK [Gathering Facts] ************************************************************************************************************************* fatal: [vm01]: UNREACHABLE! => {\"changed\": false, \"msg\": \"Failed to connect to the host via ssh: dxlab@192.168.56.8: Permission denied (publickey,password).\", \"unreachable\": true} PLAY RECAP ************************************************************************************************************************************* vm01 : ok=0 changed=0 unreachable=1 failed=0 skipped=0 rescued=0 ignored=0 : ok=3 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u4f7f\u7528 --ask-pass \u9078\u9805\u904b\u884c askpass1.yaml playbook\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook --ask-pass playbooks/askpass1.yaml SSH password: PLAY [ all ] ************************************************************************************************************************************* TASK [ Gathering Facts ] ************************************************************************************************************************* ok: [ vm01 ] TASK [ Ping all hosts ] ************************************************************************************************************************** ok: [ vm01 ] TASK [ Print a message ] ************************************************************************************************************************* ok: [ vm01 ] = > { \"msg\" : \"All set\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 3 changed = 0 unreachable = 0 failed = 0 skipped = 0 rescued = 0 ignored = 0 \u5982\u60a8\u6240\u898b\uff0cAnsible \u8981\u6c42\u8f38\u5165 SSH \u5bc6\u78bc\u3002\u8f38\u5165\u60a8\u7684 SSH \u5bc6\u78bc\u4e26\u6309 \u3002playbook askpass1.yaml \u73fe\u5728\u61c9\u8a72\u53ef\u4ee5\u6210\u529f\u904b\u884c\u3002","title":"Playbook \u57fa\u65bc Ansible \u5bc6\u78bc\u7684 SSH \u767b\u9304"},{"location":"ansible/use_sshpass_to_login_for_ansible/#playbook-ansible-sudo","text":"--ask-pass \u9078\u9805\u5c07\u50c5\u8a62\u554f SSH \u767b\u9304\u5bc6\u78bc\u3002\u5982\u679c\u60a8\u9084\u60f3\u8f38\u5165 sudo \u5bc6\u78bc\u600e\u9ebc\u8fa6\uff1f\u60a8\u5c07\u5728\u63a5\u4e0b\u4f86\u7684\u6b65\u9a5f\u4e2d\u770b\u5230\u5982\u4f55\u57f7\u884c\u6b64\u64cd\u4f5c\u3002 \u9996\u5148\u5728 playbooks/ \u76ee\u9304\u4e0b\u65b0\u5efa playbook askpass2.yaml \uff0c\u5982\u4e0b\uff1a askpass2.yaml - hosts : all user : shovon become : True tasks : - name : Install apache2 Package apt : name : apache2 state : latest - name : Make sure apache2 service is running service : name : apache2 state : started enabled : True - name : Copy index.html file to server copy : src : ../files/index.html dest : /var/www/html/index.html mode : 0644 owner : www-data group : www-data \u5728\u9019\u88e1\uff0c\u6211\u4f7f\u7528\u4e86\u547d\u4ee4 become: True \u4f86\u544a\u8a34 Ansible \u4ee5 sudo \u6b0a\u9650\u904b\u884c\u9019\u500b playbook\u3002\u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58 askpass2.yaml \u6587\u4ef6\u3002 \u5728 files/ \u76ee\u9304\u4e0b\u5275\u5efa\u4e00\u500b index.html \u6587\u4ef6\uff0c\u5982\u4e0b\uff1a $ nano files/index.html \u5728 index.html \u6587\u4ef6\u4e2d\u9375\u5165\u4ee5\u4e0b HTML \u4ee3\u78bc\uff1a index.html <!DOCTYPE html> < html > < head > < title > Homepage </ title > </ head > < body > < h1 > Hello World </ h1 > < p > It works </ p > </ body > </ html > \u5b8c\u6210\u6b64\u6b65\u9a5f\u5f8c\uff0c\u6309 + X \u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u6587\u4ef6\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 --ask-pass \u9078\u9805\u904b\u884c askpass2.yaml playbook\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook --ask-pass playbooks/askpass2.yaml SSH password: PLAY [ all ] ************************************************************************************************************************************* TASK [ Gathering Facts ] ************************************************************************************************************************* fatal: [ vm01 ] : FAILED! = > { \"msg\" : \"Missing sudo password\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 0 changed = 0 unreachable = 0 failed = 1 skipped = 0 rescued = 0 ignored = 0 \u4f46\u662f\u5373\u4f7f\u60a8\u63d0\u4f9b SSH \u5bc6\u78bc\uff0cplaybook \u4ecd\u7136\u53ef\u80fd\u7121\u6cd5\u904b\u884c\u3002\u9019\u6a23\u505a\u7684\u539f\u56e0\u662f\u56e0\u70ba\u60a8\u5fc5\u9808\u544a\u8a34 Ansible \u63d0\u793a\u8f38\u5165 sudo \u5bc6\u78bc\u4ee5\u53ca SSH \u5bc6\u78bc\u3002 \u60a8\u53ef\u4ee5\u5728\u904b\u884c playbook \u6642\u4f7f\u7528 --ask-become-pass \u9078\u9805\u544a\u8a34 Ansible \u8a62\u554f sudo \u5bc6\u78bc\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook --ask-pass --ask-become-pass playbooks/askpass2.yaml SSH password: BECOME password [ defaults to SSH password ] : PLAY [ all ] ************************************************************************************************************************************* TASK [ Gathering Facts ] ************************************************************************************************************************* fatal: [ vm01 ] : FAILED! = > { \"ansible_facts\" : {} , \"changed\" : false, \"failed_modules\" : { \"ansible.legacy.setup\" : { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"failed\" : true, \"module_stderr\" : \"Shared connection to 192.168.56.8 closed.\\r\\n\" , \"module_stdout\" : \"\\r\\ndxlab is not in the sudoers file. This incident will be reported.\\r\\n\" , \"msg\" : \"MODULE FAILURE\\nSee stdout/stderr for the exact error\" , \"rc\" : 1 }} , \"msg\" : \"The following modules failed to execute: ansible.legacy.setup\\n\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 0 changed = 0 unreachable = 0 failed = 1 skipped = 0 rescued = 0 ignored = 0 Ansible \u5c07\u63d0\u793a\u60a8\u8f38\u5165 SSH \u5bc6\u78bc\u3002\u63a5\u4e0b\u4f86\uff0cAnsible \u5c07\u63d0\u793a\u60a8\u8f38\u5165 sudo \u5bc6\u78bc\u3002\u5982\u679c\u60a8\u7684 sudo \u5bc6\u78bc\u8207 SSH \u5bc6\u78bc\u76f8\u540c\uff08\u5f88\u53ef\u80fd\uff09\uff0c\u8acb\u5c07\u5176\u7559\u7a7a\u4e26\u6309 \u3002 ... TASK [ Gathering Facts ] ************************************************************************************************************************* fatal: [ vm01 ] : FAILED! = > { \"ansible_facts\" : {} , \"changed\" : false, \"failed_modules\" : { \"ansible.legacy.setup\" : { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"failed\" : true, \"module_stderr\" : \"Shared connection to 192.168.56.8 closed.\\r\\n\" , \"module_stdout\" : \"\\r\\ndxlab is not in the sudoers file. This incident will be reported.\\r\\n\" , \"msg\" : \"MODULE FAILURE\\nSee stdout/stderr for the exact error\" , \"rc\" : 1 }} , \"msg\" : \"The following modules failed to execute: ansible.legacy.setup\\n\" } PLAY RECAP ************************************************************************************************************************************* vm01 : ok = 0 changed = 0 unreachable = 0 failed = 1 skipped = 0 rescued = 0 ignored = 0 ... \u4e0a\u8ff0\u7684\u932f\u8aa4\u8a0a\u606f xxx is not in the sudoers file \u4ee3\u8868\u8005 ssh \u767b\u5165\u7684\u5e33\u6236\u4e26\u6c92\u6709\u88ab\u8a2d\u7f6e\u9032 suoers \u6a94\u6848\u5c0e\u81f4\u4e86\u554f\u984c\u3002 Linux \u628a\u7528\u6236\u548c\u7fa4\u7d44\u7684 sudo \u6b0a\u9650\u5728 /etc/sudoers \u6587\u4ef6\u4e2d\u5b9a\u7fa9\u3002\u5c07\u7528\u6236\u6dfb\u52a0\u5230\u6b64\u6587\u4ef6\u5141\u8a31\u60a8\u6388\u4e88\u5c0d\u547d\u4ee4\u7684\u81ea\u5b9a\u7fa9\u8a2a\u554f\u6b0a\u9650\u4e26\u914d\u7f6e\u81ea\u5b9a\u7fa9\u5b89\u5168\u7b56\u7565\u3002 \u767b\u5165\u6709\u554f\u984c\u7684\u6a5f\u53f0\u5e76\u4e14\u5207\u63db\u5e76\u4e14\u4f7f\u7528 root \u5e33\u6236\u4f86\u5c07 \u5c07 vagrant ssh-user \u52a0\u5165 Sudoer \u7684\u5217\u8868\uff1a $ sudo usermod -aG sudo shovon \u518d\u91cd\u65b0\u57f7\u884c\u4e00\u6b21 playbook: $ ansible-playbook --ask-pass --ask-become-pass playbooks/askpass2.yaml SSH password: BECOME password [ defaults to SSH password ] : PLAY [ all ] *********************************************************************************************************************************** TASK [ Gathering Facts ] *********************************************************************************************************************** ok: [ vm01 ] TASK [ Install apache2 Package ] *************************************************************************************************************** changed: [ vm01 ] TASK [ Make sure apache2 service is running ] ************************************************************************************************** ok: [ vm01 ] TASK [ Copy index.html file to server ] ******************************************************************************************************** changed: [ vm01 ] PLAY RECAP *********************************************************************************************************************************** vm01 : ok = 4 changed = 2 unreachable = 0 failed = 0 skipped = 0 rescued = 0 ignored = 0 \u5982\u60a8\u6240\u898b\uff0c\u5287\u672c\u904b\u884c\u6210\u529f\u3002","title":"\u7528\u65bc Playbook \u7684 Ansible sudo \u5bc6\u78bc\u767b\u9304"},{"location":"ansible/use_sshpass_to_login_for_ansible/#ssh-sudo","text":"\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u548c sudo \u767b\u9304\uff0c\u4f46\u4e0d\u60f3\u5728\u6bcf\u6b21\u904b\u884c playbook \u6642\u90fd\u8f38\u5165 SSH \u5bc6\u78bc\u548c sudo \u5bc6\u78bc\u3002\u5982\u679c\u662f\u9019\u7a2e\u60c5\u6cc1\uff0c\u90a3\u9ebc\u672c\u7bc0\u9069\u5408\u60a8\u3002 \u8981\u5728\u4e0d\u63d0\u793a\u8f38\u5165\u5bc6\u78bc\u7684\u60c5\u6cc1\u4e0b\u4f7f\u7528\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304\u548c sudo \u767b\u9304\uff0c\u60a8\u6240\u8981\u505a\u7684\u5c31\u662f\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6dfb\u52a0 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u3002 \u9996\u5148\uff0c\u6253\u958b hosts \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u5982\u4e0b\uff1a $ nano hosts \u5982\u679c\u6e05\u55ae\u6587\u4ef6\u4e2d\u6709\u591a\u500b\u4e3b\u6a5f\u4e26\u4e14\u6bcf\u500b\u4e3b\u6a5f\u90fd\u6709\u4e0d\u540c\u7684\u5bc6\u78bc\uff0c\u5247\u6dfb\u52a0 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u4f5c\u70ba\u4e3b\u6a5f\u8b8a\u91cf\uff08\u5728\u6bcf\u500b\u4e3b\u6a5f\u4e4b\u5f8c\uff09\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u8acb\u52d9\u5fc5\u5c07 secret \u66ff\u63db\u70ba\u60a8\u7684 SSH \u548c sudo \u5bc6\u78bc\u3002 vm01 ansible_host=192.168.56.9 ansible_port=22 ansible_user=dxlab ansible_ssh_pass=****** ansible_become_pass=******* \u5982\u679c\u6240\u6709\u6216\u90e8\u5206\u4e3b\u6a5f\u7684\u5bc6\u78bc\u76f8\u540c\uff0c\u5247\u53ef\u4ee5\u5c07 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u6dfb\u52a0\u70ba\u4e3b\u6a5f\u7fa4\u7d44\u8b8a\u91cf\uff0c\u5982\u4e0b\u4f8b\u6240\u793a\u3002 \u5728\u9019\u88e1\uff0c\u6211\u53ea\u6709\u4e00\u500b\u4e3b\u6a5f\uff0c\u6240\u4ee5\u6211\u70ba all \u7d44\uff08\u5eab\u5b58\u6587\u4ef6\u4e2d\u7684\u6240\u6709\u4e3b\u6a5f\uff09\u6dfb\u52a0\u4e86 ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u3002\u4f46\u662f\uff0c\u60a8\u4e5f\u53ef\u4ee5\u70ba\u5176\u4ed6\u7279\u5b9a\u7d44\u6dfb\u52a0\u9019\u4e9b\u8b8a\u91cf\u3002 vm01 ansible_host=192.168.56.9 ansible_port=22 [all:vars] ansible_user=dxlab ansible_ssh_pass=***** ansible_become_pass=***** \u5728\u4e3b\u6a5f\u6e05\u55ae\u6587\u4ef6\u4e2d\u6dfb\u52a0\u5b8c ansible_ssh_pass \u548c ansible_become_pass \u8b8a\u91cf\u5f8c\uff0c\u6309 + X\uff0c\u7136\u5f8c\u6309 Y \u548c \u4fdd\u5b58\u4e3b\u6a5f\u6e05\u55ae\u6587\u4ef6\u3002 \u60a8\u73fe\u5728\u53ef\u4ee5\u904b\u884c askpass2.yaml \u5287\u672c\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ ansible-playbook playbooks/askpass2.yaml PLAY [ all ] ***************************************************************************************************************************************************** TASK [ Gathering Facts ] ***************************************************************************************************************************************** ok: [ vm01 ] TASK [ Install apache2 Package ] ********************************************************************************************************************************* ok: [ vm01 ] TASK [ Make sure apache2 service is running ] ******************************************************************************************************************** ok: [ vm01 ] TASK [ Copy index.html file to server ] ************************************************************************************************************************** ok: [ vm01 ] PLAY RECAP ***************************************************************************************************************************************************** vm01 : ok = 4 changed = 0 unreachable = 0 failed = 0 skipped = 0 rescued = 0 ignored = 0 \u5982\u60a8\u6240\u898b\uff0cplaybook \u904b\u884c\u6210\u529f\uff0c\u5118\u7ba1\u5b83\u6c92\u6709\u8981\u6c42\u8f38\u5165 SSH \u5bc6\u78bc\u6216 sudo \u5bc6\u78bc\u3002 \u56e0\u6b64\uff0c\u9019\u5c31\u662f\u5728 Ansible \u4e2d\u4f7f\u7528 sshpass \u9032\u884c\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u548c sudo \u767b\u9304\u7684\u65b9\u5f0f\u3002","title":"\u914d\u7f6e\u81ea\u52d5\u57fa\u65bc\u5bc6\u78bc\u7684 SSH \u767b\u9304\u548c sudo \u5bc6\u78bc\u767b\u9304"},{"location":"ansible/vagrant-intro/","text":"\u4f7f\u7528 Vagrant \u6a21\u64ec\u74b0\u5883 \u00b6 \u7531\u65bc\u5728 DevOps \u7684\u5be6\u52d9\u64cd\u4f5c\u4e0a\u6211\u5011\u5e38\u5e38\u6703\u540c\u6642\u64cd\u4f5c\u591a\u53f0\u6a5f\u5668\uff0c\u6240\u4ee5\u5728\u6b63\u5f0f\u9032\u5165\u63a5\u4e0b\u4f86\u7684\u8ab2\u7a0b\u524d\uff0c\u6211\u60f3\u8981\u5148\u82b1\u4e00\u9ede\u7bc7\u5e45\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Vagrant \u4f86\u6a21\u64ec\u6211\u5011\u7684\u5b78\u7fd2\u74b0\u5883\u3002 Vagrant \u662f\u4ec0\u9ebc\uff1f \u00b6 \u5728\u90e8\u7f72\u8edf\u9ad4\u670d\u52d9\u7684\u968e\u6bb5\uff0c\u958b\u767c\u4eba\u54e1\u5e38\u5e38\u6703\u5229\u7528\u865b\u64ec\u4e3b\u6a5f\u4f86\u6a21\u64ec\u53ca\u914d\u7f6e\u958b\u767c\u74b0\u5883\u3002Vagrant \u5c31\u662f\u57fa\u65bc\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u500b\u670d\u52d9\u3002\u8207\u50b3\u7d71\u4f7f\u7528 VirtualBox \u900f\u904e\u5716\u5f62\u4f7f\u7528\u8005\u4ecb\u9762 (Graphical User Interface, GUI) \u64cd\u4f5c\u865b\u64ec\u4e3b\u6a5f\u6709\u4e00\u9ede\u4e0d\u540c\u7684\u662f\uff0cVagrant \u4e3b\u8981\u662f\u4f7f\u7528\u547d\u4ee4\u5217\u4ecb\u9762 (command-line interface, CLI) \u4f86\u8207\u865b\u64ec\u4e3b\u6a5f\u505a\u6e9d\u901a\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u5c07\u6703\u904b\u7528\u5927\u91cf\u7684\u547d\u4ee4\u5217\u4f86\u9032\u884c\u64cd\u4f5c\u3002 Vagrant \u53ca\u76f8\u95dc\u8edf\u9ad4\u5b89\u88dd \u00b6 \u5b89\u88dd Vagrant \u00b6 Ubuntu/Debian CentOS/RHEL curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add - sudo apt-add-repository \"deb [arch=amd64] https://apt.releases.hashicorp.com $( lsb_release -cs ) main\" sudo apt-get update && sudo apt-get install vagrant sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo sudo yum -y install vagrant \u5176\u5b83\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u624b\u6cd5\u8acb\u53c3\u95b1: https://www.vagrantup.com/downloads \u9a57\u8b49\u5b89\u88dd \u00b6 \u5b89\u88dd Vagrant \u5f8c\uff0c\u901a\u904e\u6253\u958b\u65b0\u7684\u547d\u4ee4\u63d0\u793a\u7b26\u6216\u63a7\u5236\u53f0\u4f86\u9a57\u8b49\u5b89\u88dd\u662f\u5426\u6b63\u5e38\uff0c\u4e26\u6aa2\u67e5 vagrant \u662f\u5426\u53ef\u7528\u3002 $ vagrant Usage: vagrant [options] <command> [<args>] -v, --version Print the version and exit. -h, --help Print this help. # ... \u5b89\u88dd VirtualBox \u00b6 Vagrant \u652f\u6301\u4e0d\u540c\u7684\u865b\u64ec\u5316\u7522\u54c1\uff0c\u4f8b\u5982\uff1b VirtualBox\u3001VMware Fusion \u6216 Hyper-V\u3002\u5728\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528 VirtualBox \u4f86\u8b93\u5b78\u54e1\u7df4\u7fd2\u3002 \u8acb\u6839\u64da VirtualBox \u5b98\u7db2\u4e0a\u7684\u6307\u793a\u4f86\u9032\u884c\u5b89\u88dd: https://www.virtualbox.org/wiki/Downloads \u5275\u5efa\u4e00\u53f0\u865b\u64ec\u6a5f \u00b6 \u5275\u5efa\u4e00\u500b\u76ee\u9304 \u00b6 \u914d\u7f6e\u4efb\u4f55 Vagrant \u5c08\u6848\u7684\u7b2c\u4e00\u6b65\u662f\u5275\u5efa\u4e00\u500b Vagrantfile \u3002 Vagrantfile \u5141\u8a31\u4f60\uff1a \u6a19\u8a18 project \u7684\u6839\u76ee\u9304\u3002 Vagrant \u4e2d\u7684\u8a31\u591a\u914d\u7f6e\u9078\u9805\u90fd\u662f\u76f8\u5c0d\u65bc\u9019\u500b\u6839\u76ee\u9304\u7684\u3002 \u63cf\u8ff0\u904b\u884c\u5c08\u6848\u6240\u9700\u7684 VM \u548c\u8cc7\u6e90\u985e\u578b\uff0c\u4ee5\u53ca\u8981\u5b89\u88dd\u7684\u8edf\u4ef6\u4ee5\u53ca\u4f60\u5e0c\u671b\u5982\u4f55\u8a2a\u554f\u5b83\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_getting_started $ cd vagrant_getting_started \u521d\u59cb\u5316\u5c08\u6848 \u00b6 Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a hashcorp/bionic64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" end \u555f\u52d5\u865b\u64ec\u6a5f VM \u00b6 \u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220523.0.0' is up to date... ==> default: A newer version of the box 'ubuntu/focal64' for provider 'virtualbox' is ==> default: available! You currently have version '20220523.0.0'. The latest is version ==> default: '20220530.0.0'. Run `vagrant box update` to update. ==> default: Setting the name of the VM: vagrant_getting_started_default_1654224585969_14799 ==> default: Fixed port collision for 22 => 2222. Now on port 2201. ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat ==> default: Forwarding ports... default: 22 (guest) => 2201 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_getting_started SSH\u9032\u5165\u865b\u64ec\u6a5f \u00b6 Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Fri Jun 3 02:52:55 UTC 2022 System load: 0.12 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 20% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed \u6aa2\u67e5\u6a5f\u5668\u72c0\u614b \u00b6 \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u767c\u73fe\u96d6\u7136\u865b\u64ec\u6a5f\u5df2\u7d93\u6210\u529f\u904b\u884c\uff0c\u4f46\u4e3b\u6a5f\u540d\u7a31\u986f\u793a\u70ba default \u3002\u9019\u7a2e\u6a21\u7cca\u7684\u540d\u7a31\u5728\u7ba1\u7406\u4e3b\u6a5f\u6578\u91cf\u591a\u8d77\u4f86\u5f8c\u5e38\u5e38\u6703\u9020\u6210\u958b\u767c\u8005\u7684\u56f0\u64fe\u3002\u70ba\u4e86\u907f\u514d\u6df7\u6dc6\uff0c\u6211\u5011\u53ef\u4ee5\u5148\u7528 vagrant halt \u5c07\u76ee\u524d\u7684\u865b\u64ec\u6a5f\u66ab\u505c\u6216\u662f\u4f7f\u7528 vagrant destroy \u76f4\u63a5\u6467\u6bc0 (destroy)\u3002\u63a5\u4e0b\u4f86\uff0c\u5728 Vagrantfile \u4e2d\u52a0\u5165\u4e0b\u5217\u8a2d\u7f6e\u4f86\u66ff\u6211\u5011\u7684\u865b\u64ec\u6a5f\u547d\u540d\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" end \u91cd\u65b0\u555f\u52d5: $ vagrant up Bringing machine 'sre001' up with 'virtualbox' provider... ==> sre001: Importing base box 'ubuntu/focal64'... ==> sre001: Matching MAC address for NAT networking... ==> sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> sre001: Setting the name of the VM: vagrant_getting_started_sre001_1654228247885_34312 ==> sre001: Fixed port collision for 22 => 2222. Now on port 2201. ==> sre001: Clearing any previously set network interfaces... ==> sre001: Preparing network interfaces based on configuration... sre001: Adapter 1: nat ==> sre001: Forwarding ports... sre001: 22 (guest) => 2201 (host) (adapter 1) ==> sre001: Running 'pre-boot' VM customizations... ==> sre001: Booting VM... ==> sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127.0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key sre001: sre001: Vagrant insecure key detected. Vagrant will automatically replace sre001: this with a newly generated keypair for better security. sre001: sre001: Inserting generated public key within guest... sre001: Removing insecure key from the guest if it's present... sre001: Key inserted! Disconnecting and reconnecting using new SSH key... ==> sre001: Machine booted and ready! ==> sre001: Checking for guest additions in VM... ==> sre001: Mounting shared folders... sre001: /vagrant => /home/dxlab/opt/vagrant_getting_started \u518d\u6aa2\u67e5\u4e00\u6b21\u865b\u64ec\u6a5f\u904b\u884c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: sre001 running (virtualbox) \u6b63\u5982\u6211\u5011\u9810\u671f\u7684\uff0c\u865b\u64ec\u6a5f\u6709\u81ea\u5df1\u7684\u540d\u5b57\u5566\uff01 \u53d6\u5f97\u52d5\u614b IP (DHCP) \u00b6 \u5982\u679c\u60f3\u8981\u8b93 Vagrnt \u7684\u865b\u64ec\u6a5f\u6709\u53ef\u88ab\u5916\u90e8\u9023\u63a5\u7684\u7368\u7acb IP\uff0c\u5728 Vagrantfile \u589e\u52a0\u8a2d\u5b9a: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"private_network\" , type : \"dhcp\" end \u66ab\u505c\u6a5f\u5668 (Suspend) \u00b6 \u66ab\u505c\u865b\u64ec\u6a5f\u5c07\u505c\u6b62\u5b83\u4e26\u4fdd\u5b58\u5176\u7576\u524d\u904b\u884c\u72c0\u614b\u3002\u73fe\u5728\u8b93\u6211\u5011\u66ab\u505c\u6a5f\u5668\u3002 $ vagrant suspend ==> default: Saving VM state and suspending execution... \u7576\u4f60\u9700\u8981\u518d\u6b21\u958b\u59cb\u5de5\u4f5c\u6642\uff0c\u8acb\u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f\uff0c\u5b83\u7684\u72c0\u614b\u5c07\u5f9e\u4f60\u505c\u6b62\u7684\u5730\u65b9\u6062\u5fa9\u3002\u518d\u6b21\u555f\u52d5\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u66ab\u505c\u6a5f\u5668\u65e8\u5728\u5feb\u901f\u505c\u6b62\u548c\u958b\u59cb\u5de5\u4f5c\u3002\u7f3a\u9ede\u662f\u865b\u64ec\u6a5f\u5728\u639b\u8d77\u6642\u4ecd\u6703\u4f7f\u7528\u78c1\u76e4\u7a7a\u9593\uff0c\u4e26\u4e14\u9700\u8981\u984d\u5916\u7684\u78c1\u76e4\u7a7a\u9593\u4f86\u5b58\u5132\u865b\u64ec\u6a5f RAM \u7684\u72c0\u614b\u3002 \u505c\u6b62\u6a5f\u5668 (Halt) \u00b6 \u505c\u6b62\u865b\u64ec\u6a5f\u5c07\u6b63\u5e38\u7684\u6d41\u7a0b\u4f86\u95dc\u9589\u4f86\u8cd3\u64cd\u4f5c\u7cfb\u7d71\u4e26\u95dc\u9589\u4f86\u8cd3\u8a08\u7b97\u6a5f\u3002\u7acb\u5373\u505c\u6b62\u60a8\u7684\u6a5f\u5668\u3002 $ vagrant halt ==> default: Attempting graceful shutdown of VM... \u505c\u6b62\u60a8\u7684\u6a5f\u5668\u5c07\u4e7e\u6de8\u5730\u95dc\u9589\u5b83\uff0c\u4fdd\u7559\u78c1\u76e4\u7684\u5167\u5bb9\u4e26\u5141\u8a31\u4f60\u4e7e\u6de8\u5730\u518d\u6b21\u555f\u52d5\u5b83\u3002\u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u505c\u6b62\u7684\u5ba2\u6236\u6a5f\u5c07\u9700\u8981\u66f4\u591a\u6642\u9593\u624d\u80fd\u5f9e\u51b7\u555f\u52d5\u958b\u59cb\uff0c\u4e26\u4e14\u4ecd\u6703\u4f54\u7528\u78c1\u76e4\u7a7a\u9593\u3002 \u92b7\u9664\u6a5f\u5668 VM \u00b6 \u56de\u5230\u4e3b\u6a5f\u5f8c\uff0c\u505c\u6b62 Vagrant \u7ba1\u7406\u7684\u6a5f\u5668\u4e26\u522a\u9664\u5728\u6a5f\u5668\u5275\u5efa\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u6309\u201c\u662f\u201d\u78ba\u8a8d\u3002 $ vagrant destroy default: Are you sure you want to destroy the 'default' VM? [y/N] y ==> default: Forcing shutdown of VM... ==> default: Destroying VM and associated drives... \u79fb\u9664 VM box \u93e1\u50cf \u00b6 vagrant destroy \u547d\u4ee4\u4e0d\u6703\u522a\u9664\u4e0b\u8f09\u7684 VM box \u93e1\u50cf\u3002 \u5217\u51fa\u4f60\u7684 VM box \u4e0b\u8f09\u93e1\u50cf\u6587\u4ef6\u3002 $ vagrant box list ubuntu/focal64 (virtualbox, 20220523.0.0) \u4f7f\u7528 remove \u5b50\u547d\u4ee4\u522a\u9664 VM box \u93e1\u50cf\u6587\u4ef6\uff0c\u63d0\u4f9b VM box \u93e1\u50cf\u7684\u540d\u7a31\u3002 vagrant box remove ubuntu/focal64 Removing box 'ubuntu/focal64' (v20220523.0.0) with provider 'virtualbox'... (\u88dc\u5145) \u5275\u5efa\u65b0\u7684\u5e33\u6236\u8207\u4fee\u6539 root \u5bc6\u78bc \u00b6 \u5982\u679c\u4e0d\u60f3\u8981\u4f7f\u7528 Vagrant \u9810\u5efa\u7684 vagrant \u5e33\u865f\u4f86\u767b\u5165 VM\u3002\u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u9032\u5230 VM \u88e1\u982d\u53bb\u4fee\u6539 root \u5e33\u865f\u6216\u662f\u65b0\u589e\u52a0\u4f7f\u7528\u8005\u5e33\u865f\u3002 \u9996\u5148\u4f7f\u7528 vagrant ssh \u767b\u5165: $ vagrant ssh \u5728 Linux \u4e2d\u53ef\u4f7f\u7528\u4e0b\u5217\u65b9\u5f0f\u5207\u63db\u5230 root \u5e33\u865f: \u4f7f\u7528 sudo su : \u6b64\u65b9\u5f0f\u662f\u5047\u8a2d\u6709\u4e00\u500b\u5e33\u865f\u70ba tom\uff0c\u4f7f\u7528 tom \u767b\u5165\u5f8c\u53ef\u4ee5\u5207\u63db\u8eab\u5206\u5230 root\uff0c\u4f46\u4ecd\u7136\u9084\u662f\u7528 tom \u7684\u89d2\u8272\uff0c\u50c5\u9700\u8f38\u5165 tom \u5bc6\u78bc\u3002 \u4f7f\u7528 sudo su - : \u6b64\u65b9\u5f0f\u5247\u662f\u5c07\u5e33\u865f\u63db\u6210 root \u7684\u89d2\u8272\uff0c\u56e0\u6b64\u540c\u6642\u5177\u5099 root \u7684\u6b0a\u9650\uff0c\u50c5\u9700\u8f38\u5165 tom \u5bc6\u78bc\u3002 \u4f7f\u7528 su root : \u6b64\u65b9\u5f0f\u662f\u63db\u6210 root \u4e5f\u540c\u6642\u5177\u5099 root \u7684\u6b0a\u9650\uff0c\u4f46\u524d\u63d0\u662f\u8981\u8f38\u5165 root \u5bc6\u78bc\u3002 \u8b93\u6211\u5011\u4f7f\u7528 sudo su \u4f86\u5207\u63db\u6210 root \u5e33\u865f: $ sudo su \u73fe\u5728\u4f60\u662f root \u7528\u6236\u3002\u60a8\u53ef\u4ee5\u66f4\u65b0 root \u5bc6\u78bc\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ sudo -i $ passwd \u5141\u8a31\u4f7f\u7528 password \u4f86\u767b\u5165 : \u73fe\u5728\u7de8\u8f2f\u6587\u4ef6 /etc/ssh/sshd_config \u4e2d\u7684\u4ee5\u4e0b\u7684\u5167\u5bb9: ... PermitRootLogin yes ... PasswordAuthentication yes ... \u5275\u5efa\u81ea\u5df1\u7684\u7528\u6236\u5e33\u6236 \uff1a $ adduser { new_user } \u7b49\u5230\u5b83\u8981\u6c42\u8f38\u5165\u5bc6\u78bc\u3002 \u5c07\u4f7f\u7528\u8005\u52a0\u5165 sudo \u7fa4\u7d44 : $ sudo usermod -aG sudo { user } \u628a Vagrant \u6253\u7684 VM \u91cd\u65b0\u8f09\u5165 : \u56de\u5230\u5bbf\u4e3b\u6a5f\u7684 terminal \u4e26\u57f7\u884c\u4e0b\u5217\u547d\u4ee4: $ vagrant reload \u7d50\u8ad6 \u00b6 \u4f60\u5df2\u7d93\u6210\u529f\u5730\u5275\u5efa\u4e86\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e26\u8207\u4e4b\u4e92\u52d5\uff01","title":"Vagrant \u5feb\u901f\u5165\u9580"},{"location":"ansible/vagrant-intro/#vagrant","text":"\u7531\u65bc\u5728 DevOps \u7684\u5be6\u52d9\u64cd\u4f5c\u4e0a\u6211\u5011\u5e38\u5e38\u6703\u540c\u6642\u64cd\u4f5c\u591a\u53f0\u6a5f\u5668\uff0c\u6240\u4ee5\u5728\u6b63\u5f0f\u9032\u5165\u63a5\u4e0b\u4f86\u7684\u8ab2\u7a0b\u524d\uff0c\u6211\u60f3\u8981\u5148\u82b1\u4e00\u9ede\u7bc7\u5e45\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Vagrant \u4f86\u6a21\u64ec\u6211\u5011\u7684\u5b78\u7fd2\u74b0\u5883\u3002","title":"\u4f7f\u7528 Vagrant \u6a21\u64ec\u74b0\u5883"},{"location":"ansible/vagrant-intro/#vagrant_1","text":"\u5728\u90e8\u7f72\u8edf\u9ad4\u670d\u52d9\u7684\u968e\u6bb5\uff0c\u958b\u767c\u4eba\u54e1\u5e38\u5e38\u6703\u5229\u7528\u865b\u64ec\u4e3b\u6a5f\u4f86\u6a21\u64ec\u53ca\u914d\u7f6e\u958b\u767c\u74b0\u5883\u3002Vagrant \u5c31\u662f\u57fa\u65bc\u9019\u6a23\u7684\u9700\u6c42\u7522\u751f\u7684\u4e00\u500b\u670d\u52d9\u3002\u8207\u50b3\u7d71\u4f7f\u7528 VirtualBox \u900f\u904e\u5716\u5f62\u4f7f\u7528\u8005\u4ecb\u9762 (Graphical User Interface, GUI) \u64cd\u4f5c\u865b\u64ec\u4e3b\u6a5f\u6709\u4e00\u9ede\u4e0d\u540c\u7684\u662f\uff0cVagrant \u4e3b\u8981\u662f\u4f7f\u7528\u547d\u4ee4\u5217\u4ecb\u9762 (command-line interface, CLI) \u4f86\u8207\u865b\u64ec\u4e3b\u6a5f\u505a\u6e9d\u901a\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5728\u63a5\u4e0b\u4f86\u7684\u7ae0\u7bc0\u4e2d\u5c07\u6703\u904b\u7528\u5927\u91cf\u7684\u547d\u4ee4\u5217\u4f86\u9032\u884c\u64cd\u4f5c\u3002","title":"Vagrant \u662f\u4ec0\u9ebc\uff1f"},{"location":"ansible/vagrant-intro/#vagrant_2","text":"","title":"Vagrant \u53ca\u76f8\u95dc\u8edf\u9ad4\u5b89\u88dd"},{"location":"ansible/vagrant-intro/#vagrant_3","text":"Ubuntu/Debian CentOS/RHEL curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add - sudo apt-add-repository \"deb [arch=amd64] https://apt.releases.hashicorp.com $( lsb_release -cs ) main\" sudo apt-get update && sudo apt-get install vagrant sudo yum install -y yum-utils sudo yum-config-manager --add-repo https://rpm.releases.hashicorp.com/RHEL/hashicorp.repo sudo yum -y install vagrant \u5176\u5b83\u4f5c\u696d\u7cfb\u7d71\u7684\u5b89\u88dd\u624b\u6cd5\u8acb\u53c3\u95b1: https://www.vagrantup.com/downloads","title":"\u5b89\u88dd Vagrant"},{"location":"ansible/vagrant-intro/#_1","text":"\u5b89\u88dd Vagrant \u5f8c\uff0c\u901a\u904e\u6253\u958b\u65b0\u7684\u547d\u4ee4\u63d0\u793a\u7b26\u6216\u63a7\u5236\u53f0\u4f86\u9a57\u8b49\u5b89\u88dd\u662f\u5426\u6b63\u5e38\uff0c\u4e26\u6aa2\u67e5 vagrant \u662f\u5426\u53ef\u7528\u3002 $ vagrant Usage: vagrant [options] <command> [<args>] -v, --version Print the version and exit. -h, --help Print this help. # ...","title":"\u9a57\u8b49\u5b89\u88dd"},{"location":"ansible/vagrant-intro/#virtualbox","text":"Vagrant \u652f\u6301\u4e0d\u540c\u7684\u865b\u64ec\u5316\u7522\u54c1\uff0c\u4f8b\u5982\uff1b VirtualBox\u3001VMware Fusion \u6216 Hyper-V\u3002\u5728\u672c\u6559\u7a0b\u4e2d\u4f7f\u7528 VirtualBox \u4f86\u8b93\u5b78\u54e1\u7df4\u7fd2\u3002 \u8acb\u6839\u64da VirtualBox \u5b98\u7db2\u4e0a\u7684\u6307\u793a\u4f86\u9032\u884c\u5b89\u88dd: https://www.virtualbox.org/wiki/Downloads","title":"\u5b89\u88dd VirtualBox"},{"location":"ansible/vagrant-intro/#_2","text":"","title":"\u5275\u5efa\u4e00\u53f0\u865b\u64ec\u6a5f"},{"location":"ansible/vagrant-intro/#_3","text":"\u914d\u7f6e\u4efb\u4f55 Vagrant \u5c08\u6848\u7684\u7b2c\u4e00\u6b65\u662f\u5275\u5efa\u4e00\u500b Vagrantfile \u3002 Vagrantfile \u5141\u8a31\u4f60\uff1a \u6a19\u8a18 project \u7684\u6839\u76ee\u9304\u3002 Vagrant \u4e2d\u7684\u8a31\u591a\u914d\u7f6e\u9078\u9805\u90fd\u662f\u76f8\u5c0d\u65bc\u9019\u500b\u6839\u76ee\u9304\u7684\u3002 \u63cf\u8ff0\u904b\u884c\u5c08\u6848\u6240\u9700\u7684 VM \u548c\u8cc7\u6e90\u985e\u578b\uff0c\u4ee5\u53ca\u8981\u5b89\u88dd\u7684\u8edf\u4ef6\u4ee5\u53ca\u4f60\u5e0c\u671b\u5982\u4f55\u8a2a\u554f\u5b83\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_getting_started $ cd vagrant_getting_started","title":"\u5275\u5efa\u4e00\u500b\u76ee\u9304"},{"location":"ansible/vagrant-intro/#_4","text":"Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a hashcorp/bionic64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" end","title":"\u521d\u59cb\u5316\u5c08\u6848"},{"location":"ansible/vagrant-intro/#vm","text":"\u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220523.0.0' is up to date... ==> default: A newer version of the box 'ubuntu/focal64' for provider 'virtualbox' is ==> default: available! You currently have version '20220523.0.0'. The latest is version ==> default: '20220530.0.0'. Run `vagrant box update` to update. ==> default: Setting the name of the VM: vagrant_getting_started_default_1654224585969_14799 ==> default: Fixed port collision for 22 => 2222. Now on port 2201. ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat ==> default: Forwarding ports... default: 22 (guest) => 2201 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_getting_started","title":"\u555f\u52d5\u865b\u64ec\u6a5f VM"},{"location":"ansible/vagrant-intro/#ssh","text":"Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Fri Jun 3 02:52:55 UTC 2022 System load: 0.12 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 20% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed","title":"SSH\u9032\u5165\u865b\u64ec\u6a5f"},{"location":"ansible/vagrant-intro/#_5","text":"\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`. \u6211\u5011\u53ef\u4ee5\u6e05\u695a\u767c\u73fe\u96d6\u7136\u865b\u64ec\u6a5f\u5df2\u7d93\u6210\u529f\u904b\u884c\uff0c\u4f46\u4e3b\u6a5f\u540d\u7a31\u986f\u793a\u70ba default \u3002\u9019\u7a2e\u6a21\u7cca\u7684\u540d\u7a31\u5728\u7ba1\u7406\u4e3b\u6a5f\u6578\u91cf\u591a\u8d77\u4f86\u5f8c\u5e38\u5e38\u6703\u9020\u6210\u958b\u767c\u8005\u7684\u56f0\u64fe\u3002\u70ba\u4e86\u907f\u514d\u6df7\u6dc6\uff0c\u6211\u5011\u53ef\u4ee5\u5148\u7528 vagrant halt \u5c07\u76ee\u524d\u7684\u865b\u64ec\u6a5f\u66ab\u505c\u6216\u662f\u4f7f\u7528 vagrant destroy \u76f4\u63a5\u6467\u6bc0 (destroy)\u3002\u63a5\u4e0b\u4f86\uff0c\u5728 Vagrantfile \u4e2d\u52a0\u5165\u4e0b\u5217\u8a2d\u7f6e\u4f86\u66ff\u6211\u5011\u7684\u865b\u64ec\u6a5f\u547d\u540d\uff1a Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" end \u91cd\u65b0\u555f\u52d5: $ vagrant up Bringing machine 'sre001' up with 'virtualbox' provider... ==> sre001: Importing base box 'ubuntu/focal64'... ==> sre001: Matching MAC address for NAT networking... ==> sre001: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> sre001: Setting the name of the VM: vagrant_getting_started_sre001_1654228247885_34312 ==> sre001: Fixed port collision for 22 => 2222. Now on port 2201. ==> sre001: Clearing any previously set network interfaces... ==> sre001: Preparing network interfaces based on configuration... sre001: Adapter 1: nat ==> sre001: Forwarding ports... sre001: 22 (guest) => 2201 (host) (adapter 1) ==> sre001: Running 'pre-boot' VM customizations... ==> sre001: Booting VM... ==> sre001: Waiting for machine to boot. This may take a few minutes... sre001: SSH address: 127.0.0.1:2201 sre001: SSH username: vagrant sre001: SSH auth method: private key sre001: sre001: Vagrant insecure key detected. Vagrant will automatically replace sre001: this with a newly generated keypair for better security. sre001: sre001: Inserting generated public key within guest... sre001: Removing insecure key from the guest if it's present... sre001: Key inserted! Disconnecting and reconnecting using new SSH key... ==> sre001: Machine booted and ready! ==> sre001: Checking for guest additions in VM... ==> sre001: Mounting shared folders... sre001: /vagrant => /home/dxlab/opt/vagrant_getting_started \u518d\u6aa2\u67e5\u4e00\u6b21\u865b\u64ec\u6a5f\u904b\u884c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: sre001 running (virtualbox) \u6b63\u5982\u6211\u5011\u9810\u671f\u7684\uff0c\u865b\u64ec\u6a5f\u6709\u81ea\u5df1\u7684\u540d\u5b57\u5566\uff01","title":"\u6aa2\u67e5\u6a5f\u5668\u72c0\u614b"},{"location":"ansible/vagrant-intro/#ip-dhcp","text":"\u5982\u679c\u60f3\u8981\u8b93 Vagrnt \u7684\u865b\u64ec\u6a5f\u6709\u53ef\u88ab\u5916\u90e8\u9023\u63a5\u7684\u7368\u7acb IP\uff0c\u5728 Vagrantfile \u589e\u52a0\u8a2d\u5b9a: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . define \"sre001\" config . vm . network \"private_network\" , type : \"dhcp\" end","title":"\u53d6\u5f97\u52d5\u614b IP (DHCP)"},{"location":"ansible/vagrant-intro/#suspend","text":"\u66ab\u505c\u865b\u64ec\u6a5f\u5c07\u505c\u6b62\u5b83\u4e26\u4fdd\u5b58\u5176\u7576\u524d\u904b\u884c\u72c0\u614b\u3002\u73fe\u5728\u8b93\u6211\u5011\u66ab\u505c\u6a5f\u5668\u3002 $ vagrant suspend ==> default: Saving VM state and suspending execution... \u7576\u4f60\u9700\u8981\u518d\u6b21\u958b\u59cb\u5de5\u4f5c\u6642\uff0c\u8acb\u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f\uff0c\u5b83\u7684\u72c0\u614b\u5c07\u5f9e\u4f60\u505c\u6b62\u7684\u5730\u65b9\u6062\u5fa9\u3002\u518d\u6b21\u555f\u52d5\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u66ab\u505c\u6a5f\u5668\u65e8\u5728\u5feb\u901f\u505c\u6b62\u548c\u958b\u59cb\u5de5\u4f5c\u3002\u7f3a\u9ede\u662f\u865b\u64ec\u6a5f\u5728\u639b\u8d77\u6642\u4ecd\u6703\u4f7f\u7528\u78c1\u76e4\u7a7a\u9593\uff0c\u4e26\u4e14\u9700\u8981\u984d\u5916\u7684\u78c1\u76e4\u7a7a\u9593\u4f86\u5b58\u5132\u865b\u64ec\u6a5f RAM \u7684\u72c0\u614b\u3002","title":"\u66ab\u505c\u6a5f\u5668 (Suspend)"},{"location":"ansible/vagrant-intro/#halt","text":"\u505c\u6b62\u865b\u64ec\u6a5f\u5c07\u6b63\u5e38\u7684\u6d41\u7a0b\u4f86\u95dc\u9589\u4f86\u8cd3\u64cd\u4f5c\u7cfb\u7d71\u4e26\u95dc\u9589\u4f86\u8cd3\u8a08\u7b97\u6a5f\u3002\u7acb\u5373\u505c\u6b62\u60a8\u7684\u6a5f\u5668\u3002 $ vagrant halt ==> default: Attempting graceful shutdown of VM... \u505c\u6b62\u60a8\u7684\u6a5f\u5668\u5c07\u4e7e\u6de8\u5730\u95dc\u9589\u5b83\uff0c\u4fdd\u7559\u78c1\u76e4\u7684\u5167\u5bb9\u4e26\u5141\u8a31\u4f60\u4e7e\u6de8\u5730\u518d\u6b21\u555f\u52d5\u5b83\u3002\u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668\u3002 $ vagrant up Bringing machine 'default' up with 'virtualbox' provider... ==> default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... ==> default: Resuming suspended VM... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2201 default: SSH username: vagrant default: SSH auth method: private key \u505c\u6b62\u7684\u5ba2\u6236\u6a5f\u5c07\u9700\u8981\u66f4\u591a\u6642\u9593\u624d\u80fd\u5f9e\u51b7\u555f\u52d5\u958b\u59cb\uff0c\u4e26\u4e14\u4ecd\u6703\u4f54\u7528\u78c1\u76e4\u7a7a\u9593\u3002","title":"\u505c\u6b62\u6a5f\u5668 (Halt)"},{"location":"ansible/vagrant-intro/#vm_1","text":"\u56de\u5230\u4e3b\u6a5f\u5f8c\uff0c\u505c\u6b62 Vagrant \u7ba1\u7406\u7684\u6a5f\u5668\u4e26\u522a\u9664\u5728\u6a5f\u5668\u5275\u5efa\u904e\u7a0b\u4e2d\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u6309\u201c\u662f\u201d\u78ba\u8a8d\u3002 $ vagrant destroy default: Are you sure you want to destroy the 'default' VM? [y/N] y ==> default: Forcing shutdown of VM... ==> default: Destroying VM and associated drives...","title":"\u92b7\u9664\u6a5f\u5668 VM"},{"location":"ansible/vagrant-intro/#vm-box","text":"vagrant destroy \u547d\u4ee4\u4e0d\u6703\u522a\u9664\u4e0b\u8f09\u7684 VM box \u93e1\u50cf\u3002 \u5217\u51fa\u4f60\u7684 VM box \u4e0b\u8f09\u93e1\u50cf\u6587\u4ef6\u3002 $ vagrant box list ubuntu/focal64 (virtualbox, 20220523.0.0) \u4f7f\u7528 remove \u5b50\u547d\u4ee4\u522a\u9664 VM box \u93e1\u50cf\u6587\u4ef6\uff0c\u63d0\u4f9b VM box \u93e1\u50cf\u7684\u540d\u7a31\u3002 vagrant box remove ubuntu/focal64 Removing box 'ubuntu/focal64' (v20220523.0.0) with provider 'virtualbox'...","title":"\u79fb\u9664 VM box \u93e1\u50cf"},{"location":"ansible/vagrant-intro/#root","text":"\u5982\u679c\u4e0d\u60f3\u8981\u4f7f\u7528 Vagrant \u9810\u5efa\u7684 vagrant \u5e33\u865f\u4f86\u767b\u5165 VM\u3002\u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u9032\u5230 VM \u88e1\u982d\u53bb\u4fee\u6539 root \u5e33\u865f\u6216\u662f\u65b0\u589e\u52a0\u4f7f\u7528\u8005\u5e33\u865f\u3002 \u9996\u5148\u4f7f\u7528 vagrant ssh \u767b\u5165: $ vagrant ssh \u5728 Linux \u4e2d\u53ef\u4f7f\u7528\u4e0b\u5217\u65b9\u5f0f\u5207\u63db\u5230 root \u5e33\u865f: \u4f7f\u7528 sudo su : \u6b64\u65b9\u5f0f\u662f\u5047\u8a2d\u6709\u4e00\u500b\u5e33\u865f\u70ba tom\uff0c\u4f7f\u7528 tom \u767b\u5165\u5f8c\u53ef\u4ee5\u5207\u63db\u8eab\u5206\u5230 root\uff0c\u4f46\u4ecd\u7136\u9084\u662f\u7528 tom \u7684\u89d2\u8272\uff0c\u50c5\u9700\u8f38\u5165 tom \u5bc6\u78bc\u3002 \u4f7f\u7528 sudo su - : \u6b64\u65b9\u5f0f\u5247\u662f\u5c07\u5e33\u865f\u63db\u6210 root \u7684\u89d2\u8272\uff0c\u56e0\u6b64\u540c\u6642\u5177\u5099 root \u7684\u6b0a\u9650\uff0c\u50c5\u9700\u8f38\u5165 tom \u5bc6\u78bc\u3002 \u4f7f\u7528 su root : \u6b64\u65b9\u5f0f\u662f\u63db\u6210 root \u4e5f\u540c\u6642\u5177\u5099 root \u7684\u6b0a\u9650\uff0c\u4f46\u524d\u63d0\u662f\u8981\u8f38\u5165 root \u5bc6\u78bc\u3002 \u8b93\u6211\u5011\u4f7f\u7528 sudo su \u4f86\u5207\u63db\u6210 root \u5e33\u865f: $ sudo su \u73fe\u5728\u4f60\u662f root \u7528\u6236\u3002\u60a8\u53ef\u4ee5\u66f4\u65b0 root \u5bc6\u78bc\uff0c\u5982\u4e0b\u6240\u793a\uff1a $ sudo -i $ passwd \u5141\u8a31\u4f7f\u7528 password \u4f86\u767b\u5165 : \u73fe\u5728\u7de8\u8f2f\u6587\u4ef6 /etc/ssh/sshd_config \u4e2d\u7684\u4ee5\u4e0b\u7684\u5167\u5bb9: ... PermitRootLogin yes ... PasswordAuthentication yes ... \u5275\u5efa\u81ea\u5df1\u7684\u7528\u6236\u5e33\u6236 \uff1a $ adduser { new_user } \u7b49\u5230\u5b83\u8981\u6c42\u8f38\u5165\u5bc6\u78bc\u3002 \u5c07\u4f7f\u7528\u8005\u52a0\u5165 sudo \u7fa4\u7d44 : $ sudo usermod -aG sudo { user } \u628a Vagrant \u6253\u7684 VM \u91cd\u65b0\u8f09\u5165 : \u56de\u5230\u5bbf\u4e3b\u6a5f\u7684 terminal \u4e26\u57f7\u884c\u4e0b\u5217\u547d\u4ee4: $ vagrant reload","title":"(\u88dc\u5145) \u5275\u5efa\u65b0\u7684\u5e33\u6236\u8207\u4fee\u6539 root \u5bc6\u78bc"},{"location":"ansible/vagrant-intro/#_6","text":"\u4f60\u5df2\u7d93\u6210\u529f\u5730\u5275\u5efa\u4e86\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e26\u8207\u4e4b\u4e92\u52d5\uff01","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial/ansible-install-docker/","text":"\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u00b6 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-20-04 \u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u7684\u4e00\u6b21\u6027\u6027\u8cea\uff0c\u670d\u52d9\u5668\u81ea\u52d5\u5316\u73fe\u5728\u5728\u7cfb\u7d71\u7ba1\u7406\u4e2d\u767c\u63ee\u8457\u91cd\u8981\u4f5c\u7528\u3002 Ansible \u7b49\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u901a\u5e38\u7528\u65bc\u901a\u904e\u70ba\u65b0\u670d\u52d9\u5668\u5efa\u7acb\u6a19\u6e96\u7a0b\u5e8f\u4f86\u7c21\u5316\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u904e\u7a0b\uff0c\u540c\u6642\u6e1b\u5c11\u8207\u624b\u52d5\u8a2d\u7f6e\u76f8\u95dc\u7684\u4eba\u70ba\u932f\u8aa4\u3002 Ansible \u63d0\u4f9b\u4e86\u4e00\u500b\u7c21\u55ae\u7684\u67b6\u69cb\uff0c\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\u3002\u5b83\u9084\u63d0\u4f9b\u4e86\u4e00\u7d44\u5f37\u5927\u7684\u529f\u80fd\u548c\u5167\u7f6e\u6a21\u584a\uff0c\u6709\u52a9\u65bc\u7de8\u5beb\u81ea\u52d5\u5316\u8173\u672c\u3002 \u672c\u6559\u7a0b\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u57f7\u884c\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u7684\u6307\u5357\u4e2d\u5305\u542b\u7684\u6b65\u9a5f\u3002 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u7ba1\u7406\u5bb9\u5668\u7684\u904e\u7a0b\uff0c\u9019\u4e9b\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u7684\u884c\u70ba\u65b9\u5f0f\u8207\u865b\u64ec\u6a5f\u76f8\u4f3c\uff0c\u4f46\u66f4\u4fbf\u651c\u3001\u5c0d\u8cc7\u6e90\u66f4\u53cb\u597d\uff0c\u4e26\u4e14\u5c0d\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u7684\u4f9d\u8cf4\u7a0b\u5ea6\u66f4\u9ad8\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u70ba\u4e86\u57f7\u884c\u672c\u6307\u5357\u4e2d\u7684\u5287\u672c\u63d0\u4f9b\u7684\u81ea\u52d5\u8a2d\u7f6e\uff0c\u4f60\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede \uff1a\u4e00\u53f0\u5b89\u88dd\u4e86 Ansible \u4e26\u914d\u7f6e\u70ba\u4f7f\u7528 SSH \u5bc6\u9470\u9023\u63a5\u5230 Ansible \u4e3b\u6a5f\u7684 Ubuntu 20.04 \u6a5f\u5668\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u6709\u4e00\u500b\u5177\u6709 sudo \u6b0a\u9650\u7684\u666e\u901a\u7528\u6236\u4e26\u555f\u7528\u4e86\u9632\u706b\u7246\uff0c\u5982\u6211\u5011\u7684 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u4e2d\u6240\u8ff0\u3002\u8981\u8a2d\u7f6e Ansible\uff0c\u8acb\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u9032\u884c\u64cd\u4f5c\u3002 \u4e00\u53f0\u6216\u591a\u53f0 Ansible \u4e3b\u6a5f \uff1a\u4e00\u53f0\u6216\u591a\u53f0\u9060\u7a0b Ubuntu 20.04 \u670d\u52d9\u5668\u4e4b\u524d\u5df2\u6309\u7167 \u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u81ea\u52d5\u5316\u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u6307\u5357 \u9032\u884c\u8a2d\u7f6e\u3002 \u9019\u500b Playbook \u6709\u4ec0\u9ebc\u4f5c\u7528\uff1f \u00b6 \u9019\u500b Ansible playbook \u63d0\u4f9b\u4e86\u4e00\u7a2e\u66ff\u4ee3\u65b9\u6cd5\u4f86\u624b\u52d5\u904b\u884c\u6211\u5011\u7684\u6307\u5357\u4e2d\u6982\u8ff0\u7684\u904e\u7a0b\uff0c\u8a72\u6307\u5357\u662f \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u3002\u8a2d\u7f6e\u4f60\u7684\u5287\u672c\u4e00\u6b21\uff0c\u7136\u5f8c\u5728\u6bcf\u6b21\u5b89\u88dd\u5f8c\u4f7f\u7528\u5b83\u3002 \u904b\u884c\u6b64 playbook \u5c07\u5728\u4f60\u7684 Ansible \u4e3b\u6a5f\u4e0a\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5b89\u88dd aptitude \uff0cAnsible \u9996\u9078\u5b83\u4f5c\u70ba apt \u5305\u7ba1\u7406\u5668\u7684\u66ff\u4ee3\u54c1\u3002 \u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u3002 \u5b89\u88dd Docker GPG APT \u5bc6\u9470\u3002 \u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 apt \u6e90\u9ede\u3002 \u5b89\u88dd Docker\u3002 \u901a\u904e pip \u5b89\u88dd Python Docker \u6a21\u584a\u3002 \u5f9e Docker Hub \u62c9\u53d6 default_container_image \u6307\u5b9a\u7684\u9ed8\u8a8d\u93e1\u50cf\u3002 \u5275\u5efa\u7531 container_count \u8b8a\u91cf\u5b9a\u7fa9\u7684\u5bb9\u5668\u6578\u91cf\uff0c\u6bcf\u500b\u5bb9\u5668\u4f7f\u7528 default_container_image \u5b9a\u7fa9\u7684\u93e1\u50cf\uff0c\u4e26\u5728\u6bcf\u500b\u65b0\u5bb9\u5668\u4e2d\u57f7\u884c default_container_command \u4e2d\u5b9a\u7fa9\u7684\u547d\u4ee4\u3002 \u4e00\u65e6 playbook \u5b8c\u6210\u904b\u884c\uff0c\u4f60\u5c07\u6839\u64da\u4f60\u5728\u914d\u7f6e\u8b8a\u91cf\u4e2d\u5b9a\u7fa9\u7684\u9078\u9805\u5275\u5efa\u8a31\u591a\u5bb9\u5668\u3002 \u9996\u5148\uff0c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u670d\u52d9\u5668\u4e0a\u767b\u9304\u555f\u7528 sudo \u7684\u7528\u6236\u3002 1. \u6e96\u5099\u4f60\u7684 Playbook \u00b6 playbook.yml \u6587\u4ef6\u662f\u5b9a\u7fa9\u6240\u6709 task \u7684\u5730\u65b9\u3002 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u4f46\u9996\u5148\uff0c\u4f7f\u7528\u4f60\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u5275\u5efa\u4f60\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u5c07\u6253\u958b\u4e00\u500b\u7a7a\u7684 YAML \u6587\u4ef6\u3002\u5728\u958b\u59cb\u5411\u4f60\u7684 playbook \u6dfb\u52a0\u4efb\u52d9\u4e4b\u524d\uff0c\u8acb\u5148\u6dfb\u52a0\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1 \u5e7e\u4e4e\u4f60\u9047\u5230\u7684\u6bcf\u4e00\u500b playbook \u90fd\u6703\u4ee5\u985e\u4f3c\u7684\u8072\u660e\u958b\u982d\u3002 hosts \u8072\u660e Ansible \u63a7\u5236\u7bc0\u9ede\u5c07\u4f7f\u7528\u6b64 playbook \u5b9a\u4f4d\u54ea\u4e9b\u670d\u52d9\u5668\u3002 become \u72c0\u614b\u662f\u5426\u6240\u6709\u547d\u4ee4\u90fd\u5c07\u4f7f\u7528\u5347\u7d1a\u7684 root \u6b0a\u9650\u5b8c\u6210\u3002 vars \u5141\u8a31\u4f60\u5c07\u6578\u64da\u5b58\u5132\u5728\u8b8a\u91cf\u4e2d\u3002\u5982\u679c\u4f60\u6c7a\u5b9a\u5c07\u4f86\u66f4\u6539\u9019\u4e9b\uff0c\u4f60\u53ea\u9700\u5728\u6587\u4ef6\u4e2d\u7de8\u8f2f\u9019\u4e9b\u55ae\u884c\u3002\u4ee5\u4e0b\u662f\u6bcf\u500b\u8b8a\u91cf\u7684\u7c21\u8981\u8aaa\u660e\uff1a container_count \uff1a\u8981\u5275\u5efa\u7684\u5bb9\u5668\u6578\u3002 default_container_name \uff1a\u9ed8\u8a8d\u5bb9\u5668\u540d\u7a31\u3002 default_container_image \uff1a\u5275\u5efa\u5bb9\u5668\u6642\u4f7f\u7528\u7684\u9ed8\u8a8d Docker \u6620\u50cf\u3002 default_container_command \uff1a\u5728\u65b0\u5bb9\u5668\u4e0a\u904b\u884c\u7684\u9ed8\u8a8d\u547d\u4ee4\u3002 2. \u5c07\u5b89\u88dd\u5957\u4ef6\u7684\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook \u00b6 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c Ansible \u5728 playbook \u4e2d\u6309\u7167\u5f9e\u4e0a\u5230\u4e0b\u7684\u9806\u5e8f\u540c\u6b65\u57f7\u884c\u4efb\u52d9 \u3002\u9019\u610f\u5473\u8457\u4efb\u52d9\u9806\u5e8f\u5f88\u91cd\u8981\uff0c\u4f60\u53ef\u4ee5\u653e\u5fc3\u5730\u5047\u8a2d\u4e00\u500b\u4efb\u52d9\u5c07\u5728\u4e0b\u4e00\u500b\u4efb\u52d9\u958b\u59cb\u4e4b\u524d\u5b8c\u6210\u57f7\u884c\u3002 \u6b64 playbook \u4e2d\u7684\u6240\u6709\u4efb\u52d9\u90fd\u53ef\u4ee5\u7368\u7acb\u5b58\u5728\uff0c\u4e26\u53ef\u5728\u4f60\u7684\u5176\u4ed6\u5287\u672c\u4e2d\u91cd\u8907\u4f7f\u7528\u3002 \u6dfb\u52a0\u5b89\u88dd aptitude \uff08\u8207 Linux \u5305\u7ba1\u7406\u5668\u4ea4\u4e92\u7684\u5de5\u5177\uff09\u548c\u5b89\u88dd\u6240\u9700\u7cfb\u7d71\u5305\u7684\u7b2c\u4e00\u500b\u4efb\u52d9\u3002 Ansible \u5c07\u78ba\u4fdd\u9019\u4e9b\u8edf\u4ef6\u5305\u59cb\u7d42\u5b89\u88dd\u5728\u4f60\u7684\u670d\u52d9\u5668\u4e0a\uff1a playbook.yml tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true \u5728\u9019\u88e1\uff0c\u4f60\u4f7f\u7528 apt Ansible \u5167\u7f6e\u6a21\u584a\u4f86\u6307\u5c0e Ansible \u5b89\u88dd\u4f60\u7684\u5957\u4ef6\u3002 Ansible \u4e2d\u7684\u6a21\u584a\u662f\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u5982\u679c aptitude \u4e0d\u53ef\u7528\uff0cAnsible \u6703\u5b89\u5168\u5730\u4f7f\u7528 apt \u4f86\u5b89\u88dd\u8edf\u4ef6\u5305\uff0c\u4f46 Ansible \u6b77\u4f86\u504f\u611b aptitude\u3002 \u4f60\u53ef\u4ee5\u6839\u64da\u81ea\u5df1\u7684\u559c\u597d\u6dfb\u52a0\u6216\u522a\u9664\u8edf\u4ef6\u5957\u4ef6\u3002\u9019\u5c07\u78ba\u4fdd\u6240\u6709\u8edf\u4ef6\u5957\u4ef6\u4e0d\u50c5\u5b58\u5728\uff0c\u800c\u4e14\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u4e26\u4e14\u5728\u8abf\u7528 apt \u66f4\u65b0\u5f8c\u5b8c\u6210\u3002 3. \u5c07 Docker \u5b89\u88dd\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook \u00b6 \u4f60\u7684\u4efb\u52d9\u5c07\u5f9e\u5b98\u65b9\u5b58\u5132\u5eab\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\u3002\u6dfb\u52a0 Docker GPG \u5bc6\u9470\u4ee5\u9a57\u8b49\u4e0b\u8f09\uff0c\u6dfb\u52a0\u5b98\u65b9\u5b58\u5132\u5eab\u4f5c\u70ba\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u4e26\u5c07\u5b89\u88dd Docker\u3002\u6b64\u5916\uff0c\u9084\u5c07\u5b89\u88dd Python \u7684 Docker \u6a21\u584a\uff1a playbook.yml - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker \u4f60\u6703\u770b\u5230 apt_key \u548c apt_repository \u5167\u7f6e Ansible \u6a21\u584a\u9996\u5148\u6307\u5411\u6b63\u78ba\u7684 URL\uff0c\u7136\u5f8c\u8ca0\u8cac\u78ba\u4fdd\u5b83\u5011\u5b58\u5728\u3002\u9019\u5141\u8a31\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\uff0c\u4ee5\u53ca\u4f7f\u7528 pip \u5b89\u88dd Python \u6a21\u584a\u3002 4. \u5c07 Docker \u6620\u50cf\u548c\u5bb9\u5668\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook \u00b6 Docker \u5bb9\u5668\u7684\u5be6\u969b\u5275\u5efa\u5f9e\u62c9\u53d6\u6240\u9700\u7684 Docker \u6620\u50cf\u958b\u59cb\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e9b\u93e1\u50cf\u4f86\u81ea\u5b98\u65b9\u7684 Docker Hub\u3002\u4f7f\u7528\u6b64\u6620\u50cf\uff0c\u5c07\u6839\u64da\u5287\u672c\u9802\u90e8\u8072\u660e\u7684\u8b8a\u91cf\u6240\u898f\u5b9a\u7684\u898f\u7bc4\u5275\u5efa\u5bb9\u5668\uff1a playbook.yml - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} docker_image \u7528\u65bc\u63d0\u53d6\u8981\u7528\u4f5c\u5bb9\u5668\u57fa\u790e\u7684 Docker \u6620\u50cf\u3002 docker_container \u5141\u8a31\u4f60\u6307\u5b9a\u4f60\u5275\u5efa\u7684\u5bb9\u5668\u7684\u7d30\u7bc0\uff0c\u4ee5\u53ca\u4f60\u60f3\u8981\u50b3\u905e\u5b83\u5011\u7684\u547d\u4ee4\u3002 with_sequence \u662f Ansible \u5275\u5efa\u5faa\u74b0\u7684\u65b9\u5f0f\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5c07\u6839\u64da\u4f60\u6307\u5b9a\u7684\u8a08\u6578\u5faa\u74b0\u5275\u5efa\u5bb9\u5668\u3002\u9019\u662f\u4e00\u500b\u57fa\u672c\u7684\u8a08\u6578\u5faa\u74b0\uff0c\u6240\u4ee5\u9019\u88e1\u7684 item \u8b8a\u91cf\u63d0\u4f9b\u4e86\u4e00\u500b\u4ee3\u8868\u7576\u524d\u5faa\u74b0\u8fed\u4ee3\u7684\u6578\u5b57\u3002\u9019\u500b\u6578\u5b57\u5728\u9019\u88e1\u7528\u4f86\u547d\u540d\u4f60\u7684\u5bb9\u5668\u3002 5. \u56de\u9867\u4f60\u7684\u5b8c\u6574 Playbook \u00b6 \u4f60\u7684 playbook \u61c9\u5927\u81f4\u5982\u4e0b\u6240\u793a\uff0c\u6839\u64da\u4f60\u7684\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u7565\u6709\u4e0d\u540c\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1d tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} \u96a8\u610f\u4fee\u6539\u6b64\u624b\u518a\u4ee5\u6700\u9069\u5408\u4f60\u81ea\u5df1\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u7684\u500b\u4eba\u9700\u6c42\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 docker_image \u6a21\u584a\u5c07\u6620\u50cf\u63a8\u9001\u5230 Docker Hub \u6216\u4f7f\u7528 docker_container \u6a21\u584a\u4f86\u8a2d\u7f6e\u5bb9\u5668\u7db2\u7d61\u3002 \u4e00\u65e6\u4f60\u5c0d\u4f60\u7684\u5287\u672c\u611f\u5230\u6eff\u610f\uff0c\u4f60\u53ef\u4ee5\u9000\u51fa\u4f60\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4fdd\u5b58\u3002 6. \u904b\u884c\u4f60\u7684 Playbook \u00b6 \u4f60\u73fe\u5728\u5df2\u6e96\u5099\u597d\u5728\u4e00\u53f0\u6216\u591a\u53f0\u670d\u52d9\u5668\u4e0a\u904b\u884c\u6b64 playbook\u3002\u5927\u591a\u6578\u5287\u672c\u9ed8\u8a8d\u914d\u7f6e\u70ba\u5728\u4f60\u5eab\u5b58\u4e2d\u7684\u6bcf\u53f0\u670d\u52d9\u5668\u4e0a\u57f7\u884c\uff0c\u4f46\u9019\u6b21\u4f60\u5c07\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\u3002 \u8981\u50c5\u5728 server1 \u4e0a\u57f7\u884c playbook\uff0c\u4ee5 sammy \u8eab\u4efd\u9023\u63a5\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible-playbook playbook.yml -l server1 -u sammy -l \u6a19\u8a8c\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\uff0c-u \u6a19\u8a8c\u6307\u5b9a\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u767b\u9304\u7684\u7528\u6236\u3002\u4f60\u6703\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a Output . . . changed: [server1] TASK [Create default containers] ***************************************************************************************************************** changed: [server1] => (item=1) changed: [server1] => (item=2) changed: [server1] => (item=3) changed: [server1] => (item=4) PLAY RECAP *************************************************************************************************************************************** server1 : ok=9 changed=8 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u9019\u8868\u660e\u4f60\u7684\u670d\u52d9\u5668\u8a2d\u7f6e\u5df2\u5b8c\u6210\uff01\u4f60\u7684\u8f38\u51fa\u4e0d\u5fc5\u5b8c\u5168\u76f8\u540c\uff0c\u4f46\u96f6\u6545\u969c\u5f88\u91cd\u8981\u3002 \u7576 playbook \u904b\u884c\u5b8c\u6210\u5f8c\uff0c\u901a\u904e SSH \u767b\u9304\u5230 Ansible \u63d0\u4f9b\u7684\u670d\u52d9\u5668\uff0c\u6aa2\u67e5\u5bb9\u5668\u662f\u5426\u5275\u5efa\u6210\u529f\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u767b\u9304\u9060\u7a0b\u670d\u52d9\u5668\uff1a ssh sammy@your_remote_server_ip vagrant ssh \u4e26\u5217\u51fa\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684 Docker \u5bb9\u5668\uff1a $ sudo docker ps -a \u4f60\u61c9\u8a72\u6703\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff1a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 9885b07bb59b ubuntu \"sleep 1d\" 3 minutes ago Created docker4 06d42806b828 ubuntu \"sleep 1d\" 3 minutes ago Created docker3 83a27e8fe4db ubuntu \"sleep 1d\" 3 minutes ago Created docker2 c6e52400d0c9 ubuntu \"sleep 1d\" 3 minutes ago Created docker1 \u9019\u610f\u5473\u8457 playbook \u4e2d\u5b9a\u7fa9\u7684\u5bb9\u5668\u5df2\u6210\u529f\u5275\u5efa\u3002\u7531\u65bc\u9019\u662f playbook \u4e2d\u7684\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\uff0c\u56e0\u6b64\u5b83\u9084\u78ba\u8a8d playbook \u5df2\u5728\u6b64\u670d\u52d9\u5668\u4e0a\u5b8c\u5168\u57f7\u884c\u3002 \u7d50\u8ad6 \u00b6 \u81ea\u52d5\u5316\u4f60\u7684\u57fa\u790e\u8a2d\u65bd\u8a2d\u7f6e\u4e0d\u50c5\u53ef\u4ee5\u7bc0\u7701\u4f60\u7684\u6642\u9593\uff0c\u800c\u4e14\u9084\u6709\u52a9\u65bc\u78ba\u4fdd\u4f60\u7684\u670d\u52d9\u5668\u9075\u5faa\u53ef\u6839\u64da\u4f60\u7684\u9700\u6c42\u9032\u884c\u5b9a\u5236\u7684\u6a19\u6e96\u914d\u7f6e\u3002\u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u7684\u5206\u4f48\u5f0f\u7279\u6027\u4ee5\u53ca\u4e0d\u540c\u66ab\u5b58\u74b0\u5883\u4e4b\u9593\u5c0d\u4e00\u81f4\u6027\u7684\u9700\u6c42\uff0c\u9019\u6a23\u7684\u81ea\u52d5\u5316\u5df2\u6210\u70ba\u8a31\u591a\u5718\u968a\u958b\u767c\u904e\u7a0b\u4e2d\u7684\u6838\u5fc3\u7d44\u4ef6\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u4f60\u6f14\u793a\u77ad\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u5316\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u904e\u7a0b\u3002\u56e0\u70ba\u6bcf\u500b\u4eba\u5728\u4f7f\u7528\u5bb9\u5668\u6642\u901a\u5e38\u6709\u4e0d\u540c\u7684\u9700\u6c42\uff0c\u6211\u5011\u9f13\u52f5\u4f60\u67e5\u770b\u5b98\u65b9 Ansible \u6587\u6a94\u4ee5\u7372\u53d6\u66f4\u591a\u4fe1\u606f\u548c docker_container Ansible \u6a21\u584a\u7684\u7528\u4f8b\u3002","title":"\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker"},{"location":"ansible/tutorial/ansible-install-docker/#ansible-ubuntu-2004-docker","text":"\u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-use-ansible-to-install-and-set-up-docker-on-ubuntu-20-04 \u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u74b0\u5883\u7684\u4e00\u6b21\u6027\u6027\u8cea\uff0c\u670d\u52d9\u5668\u81ea\u52d5\u5316\u73fe\u5728\u5728\u7cfb\u7d71\u7ba1\u7406\u4e2d\u767c\u63ee\u8457\u91cd\u8981\u4f5c\u7528\u3002 Ansible \u7b49\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u901a\u5e38\u7528\u65bc\u901a\u904e\u70ba\u65b0\u670d\u52d9\u5668\u5efa\u7acb\u6a19\u6e96\u7a0b\u5e8f\u4f86\u7c21\u5316\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u904e\u7a0b\uff0c\u540c\u6642\u6e1b\u5c11\u8207\u624b\u52d5\u8a2d\u7f6e\u76f8\u95dc\u7684\u4eba\u70ba\u932f\u8aa4\u3002 Ansible \u63d0\u4f9b\u4e86\u4e00\u500b\u7c21\u55ae\u7684\u67b6\u69cb\uff0c\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\u3002\u5b83\u9084\u63d0\u4f9b\u4e86\u4e00\u7d44\u5f37\u5927\u7684\u529f\u80fd\u548c\u5167\u7f6e\u6a21\u584a\uff0c\u6709\u52a9\u65bc\u7de8\u5beb\u81ea\u52d5\u5316\u8173\u672c\u3002 \u672c\u6559\u7a0b\u8aaa\u660e\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u57f7\u884c\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u7684\u6307\u5357\u4e2d\u5305\u542b\u7684\u6b65\u9a5f\u3002 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u7ba1\u7406\u5bb9\u5668\u7684\u904e\u7a0b\uff0c\u9019\u4e9b\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u7684\u884c\u70ba\u65b9\u5f0f\u8207\u865b\u64ec\u6a5f\u76f8\u4f3c\uff0c\u4f46\u66f4\u4fbf\u651c\u3001\u5c0d\u8cc7\u6e90\u66f4\u53cb\u597d\uff0c\u4e26\u4e14\u5c0d\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u7684\u4f9d\u8cf4\u7a0b\u5ea6\u66f4\u9ad8\u3002","title":"\u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker"},{"location":"ansible/tutorial/ansible-install-docker/#_1","text":"\u70ba\u4e86\u57f7\u884c\u672c\u6307\u5357\u4e2d\u7684\u5287\u672c\u63d0\u4f9b\u7684\u81ea\u52d5\u8a2d\u7f6e\uff0c\u4f60\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede \uff1a\u4e00\u53f0\u5b89\u88dd\u4e86 Ansible \u4e26\u914d\u7f6e\u70ba\u4f7f\u7528 SSH \u5bc6\u9470\u9023\u63a5\u5230 Ansible \u4e3b\u6a5f\u7684 Ubuntu 20.04 \u6a5f\u5668\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u6709\u4e00\u500b\u5177\u6709 sudo \u6b0a\u9650\u7684\u666e\u901a\u7528\u6236\u4e26\u555f\u7528\u4e86\u9632\u706b\u7246\uff0c\u5982\u6211\u5011\u7684 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u4e2d\u6240\u8ff0\u3002\u8981\u8a2d\u7f6e Ansible\uff0c\u8acb\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u7684\u6307\u5357 \u9032\u884c\u64cd\u4f5c\u3002 \u4e00\u53f0\u6216\u591a\u53f0 Ansible \u4e3b\u6a5f \uff1a\u4e00\u53f0\u6216\u591a\u53f0\u9060\u7a0b Ubuntu 20.04 \u670d\u52d9\u5668\u4e4b\u524d\u5df2\u6309\u7167 \u5982\u4f55\u4f7f\u7528 Ansible \u5728 Ubuntu 20.04 \u4e0a\u81ea\u52d5\u5316\u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u7684\u6307\u5357 \u9032\u884c\u8a2d\u7f6e\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial/ansible-install-docker/#playbook","text":"\u9019\u500b Ansible playbook \u63d0\u4f9b\u4e86\u4e00\u7a2e\u66ff\u4ee3\u65b9\u6cd5\u4f86\u624b\u52d5\u904b\u884c\u6211\u5011\u7684\u6307\u5357\u4e2d\u6982\u8ff0\u7684\u904e\u7a0b\uff0c\u8a72\u6307\u5357\u662f \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u3002\u8a2d\u7f6e\u4f60\u7684\u5287\u672c\u4e00\u6b21\uff0c\u7136\u5f8c\u5728\u6bcf\u6b21\u5b89\u88dd\u5f8c\u4f7f\u7528\u5b83\u3002 \u904b\u884c\u6b64 playbook \u5c07\u5728\u4f60\u7684 Ansible \u4e3b\u6a5f\u4e0a\u57f7\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5b89\u88dd aptitude \uff0cAnsible \u9996\u9078\u5b83\u4f5c\u70ba apt \u5305\u7ba1\u7406\u5668\u7684\u66ff\u4ee3\u54c1\u3002 \u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u3002 \u5b89\u88dd Docker GPG APT \u5bc6\u9470\u3002 \u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 apt \u6e90\u9ede\u3002 \u5b89\u88dd Docker\u3002 \u901a\u904e pip \u5b89\u88dd Python Docker \u6a21\u584a\u3002 \u5f9e Docker Hub \u62c9\u53d6 default_container_image \u6307\u5b9a\u7684\u9ed8\u8a8d\u93e1\u50cf\u3002 \u5275\u5efa\u7531 container_count \u8b8a\u91cf\u5b9a\u7fa9\u7684\u5bb9\u5668\u6578\u91cf\uff0c\u6bcf\u500b\u5bb9\u5668\u4f7f\u7528 default_container_image \u5b9a\u7fa9\u7684\u93e1\u50cf\uff0c\u4e26\u5728\u6bcf\u500b\u65b0\u5bb9\u5668\u4e2d\u57f7\u884c default_container_command \u4e2d\u5b9a\u7fa9\u7684\u547d\u4ee4\u3002 \u4e00\u65e6 playbook \u5b8c\u6210\u904b\u884c\uff0c\u4f60\u5c07\u6839\u64da\u4f60\u5728\u914d\u7f6e\u8b8a\u91cf\u4e2d\u5b9a\u7fa9\u7684\u9078\u9805\u5275\u5efa\u8a31\u591a\u5bb9\u5668\u3002 \u9996\u5148\uff0c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u670d\u52d9\u5668\u4e0a\u767b\u9304\u555f\u7528 sudo \u7684\u7528\u6236\u3002","title":"\u9019\u500b Playbook \u6709\u4ec0\u9ebc\u4f5c\u7528\uff1f"},{"location":"ansible/tutorial/ansible-install-docker/#1-playbook","text":"playbook.yml \u6587\u4ef6\u662f\u5b9a\u7fa9\u6240\u6709 task \u7684\u5730\u65b9\u3002 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u4f46\u9996\u5148\uff0c\u4f7f\u7528\u4f60\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u5275\u5efa\u4f60\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u5c07\u6253\u958b\u4e00\u500b\u7a7a\u7684 YAML \u6587\u4ef6\u3002\u5728\u958b\u59cb\u5411\u4f60\u7684 playbook \u6dfb\u52a0\u4efb\u52d9\u4e4b\u524d\uff0c\u8acb\u5148\u6dfb\u52a0\u4ee5\u4e0b\u5167\u5bb9\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1 \u5e7e\u4e4e\u4f60\u9047\u5230\u7684\u6bcf\u4e00\u500b playbook \u90fd\u6703\u4ee5\u985e\u4f3c\u7684\u8072\u660e\u958b\u982d\u3002 hosts \u8072\u660e Ansible \u63a7\u5236\u7bc0\u9ede\u5c07\u4f7f\u7528\u6b64 playbook \u5b9a\u4f4d\u54ea\u4e9b\u670d\u52d9\u5668\u3002 become \u72c0\u614b\u662f\u5426\u6240\u6709\u547d\u4ee4\u90fd\u5c07\u4f7f\u7528\u5347\u7d1a\u7684 root \u6b0a\u9650\u5b8c\u6210\u3002 vars \u5141\u8a31\u4f60\u5c07\u6578\u64da\u5b58\u5132\u5728\u8b8a\u91cf\u4e2d\u3002\u5982\u679c\u4f60\u6c7a\u5b9a\u5c07\u4f86\u66f4\u6539\u9019\u4e9b\uff0c\u4f60\u53ea\u9700\u5728\u6587\u4ef6\u4e2d\u7de8\u8f2f\u9019\u4e9b\u55ae\u884c\u3002\u4ee5\u4e0b\u662f\u6bcf\u500b\u8b8a\u91cf\u7684\u7c21\u8981\u8aaa\u660e\uff1a container_count \uff1a\u8981\u5275\u5efa\u7684\u5bb9\u5668\u6578\u3002 default_container_name \uff1a\u9ed8\u8a8d\u5bb9\u5668\u540d\u7a31\u3002 default_container_image \uff1a\u5275\u5efa\u5bb9\u5668\u6642\u4f7f\u7528\u7684\u9ed8\u8a8d Docker \u6620\u50cf\u3002 default_container_command \uff1a\u5728\u65b0\u5bb9\u5668\u4e0a\u904b\u884c\u7684\u9ed8\u8a8d\u547d\u4ee4\u3002","title":"1. \u6e96\u5099\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#2-playbook","text":"\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c Ansible \u5728 playbook \u4e2d\u6309\u7167\u5f9e\u4e0a\u5230\u4e0b\u7684\u9806\u5e8f\u540c\u6b65\u57f7\u884c\u4efb\u52d9 \u3002\u9019\u610f\u5473\u8457\u4efb\u52d9\u9806\u5e8f\u5f88\u91cd\u8981\uff0c\u4f60\u53ef\u4ee5\u653e\u5fc3\u5730\u5047\u8a2d\u4e00\u500b\u4efb\u52d9\u5c07\u5728\u4e0b\u4e00\u500b\u4efb\u52d9\u958b\u59cb\u4e4b\u524d\u5b8c\u6210\u57f7\u884c\u3002 \u6b64 playbook \u4e2d\u7684\u6240\u6709\u4efb\u52d9\u90fd\u53ef\u4ee5\u7368\u7acb\u5b58\u5728\uff0c\u4e26\u53ef\u5728\u4f60\u7684\u5176\u4ed6\u5287\u672c\u4e2d\u91cd\u8907\u4f7f\u7528\u3002 \u6dfb\u52a0\u5b89\u88dd aptitude \uff08\u8207 Linux \u5305\u7ba1\u7406\u5668\u4ea4\u4e92\u7684\u5de5\u5177\uff09\u548c\u5b89\u88dd\u6240\u9700\u7cfb\u7d71\u5305\u7684\u7b2c\u4e00\u500b\u4efb\u52d9\u3002 Ansible \u5c07\u78ba\u4fdd\u9019\u4e9b\u8edf\u4ef6\u5305\u59cb\u7d42\u5b89\u88dd\u5728\u4f60\u7684\u670d\u52d9\u5668\u4e0a\uff1a playbook.yml tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true \u5728\u9019\u88e1\uff0c\u4f60\u4f7f\u7528 apt Ansible \u5167\u7f6e\u6a21\u584a\u4f86\u6307\u5c0e Ansible \u5b89\u88dd\u4f60\u7684\u5957\u4ef6\u3002 Ansible \u4e2d\u7684\u6a21\u584a\u662f\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u5982\u679c aptitude \u4e0d\u53ef\u7528\uff0cAnsible \u6703\u5b89\u5168\u5730\u4f7f\u7528 apt \u4f86\u5b89\u88dd\u8edf\u4ef6\u5305\uff0c\u4f46 Ansible \u6b77\u4f86\u504f\u611b aptitude\u3002 \u4f60\u53ef\u4ee5\u6839\u64da\u81ea\u5df1\u7684\u559c\u597d\u6dfb\u52a0\u6216\u522a\u9664\u8edf\u4ef6\u5957\u4ef6\u3002\u9019\u5c07\u78ba\u4fdd\u6240\u6709\u8edf\u4ef6\u5957\u4ef6\u4e0d\u50c5\u5b58\u5728\uff0c\u800c\u4e14\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u4e26\u4e14\u5728\u8abf\u7528 apt \u66f4\u65b0\u5f8c\u5b8c\u6210\u3002","title":"2. \u5c07\u5b89\u88dd\u5957\u4ef6\u7684\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#3-docker-playbook","text":"\u4f60\u7684\u4efb\u52d9\u5c07\u5f9e\u5b98\u65b9\u5b58\u5132\u5eab\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\u3002\u6dfb\u52a0 Docker GPG \u5bc6\u9470\u4ee5\u9a57\u8b49\u4e0b\u8f09\uff0c\u6dfb\u52a0\u5b98\u65b9\u5b58\u5132\u5eab\u4f5c\u70ba\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u4e26\u5c07\u5b89\u88dd Docker\u3002\u6b64\u5916\uff0c\u9084\u5c07\u5b89\u88dd Python \u7684 Docker \u6a21\u584a\uff1a playbook.yml - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker \u4f60\u6703\u770b\u5230 apt_key \u548c apt_repository \u5167\u7f6e Ansible \u6a21\u584a\u9996\u5148\u6307\u5411\u6b63\u78ba\u7684 URL\uff0c\u7136\u5f8c\u8ca0\u8cac\u78ba\u4fdd\u5b83\u5011\u5b58\u5728\u3002\u9019\u5141\u8a31\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Docker\uff0c\u4ee5\u53ca\u4f7f\u7528 pip \u5b89\u88dd Python \u6a21\u584a\u3002","title":"3. \u5c07 Docker \u5b89\u88dd\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#4-docker-playbook","text":"Docker \u5bb9\u5668\u7684\u5be6\u969b\u5275\u5efa\u5f9e\u62c9\u53d6\u6240\u9700\u7684 Docker \u6620\u50cf\u958b\u59cb\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e9b\u93e1\u50cf\u4f86\u81ea\u5b98\u65b9\u7684 Docker Hub\u3002\u4f7f\u7528\u6b64\u6620\u50cf\uff0c\u5c07\u6839\u64da\u5287\u672c\u9802\u90e8\u8072\u660e\u7684\u8b8a\u91cf\u6240\u898f\u5b9a\u7684\u898f\u7bc4\u5275\u5efa\u5bb9\u5668\uff1a playbook.yml - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} docker_image \u7528\u65bc\u63d0\u53d6\u8981\u7528\u4f5c\u5bb9\u5668\u57fa\u790e\u7684 Docker \u6620\u50cf\u3002 docker_container \u5141\u8a31\u4f60\u6307\u5b9a\u4f60\u5275\u5efa\u7684\u5bb9\u5668\u7684\u7d30\u7bc0\uff0c\u4ee5\u53ca\u4f60\u60f3\u8981\u50b3\u905e\u5b83\u5011\u7684\u547d\u4ee4\u3002 with_sequence \u662f Ansible \u5275\u5efa\u5faa\u74b0\u7684\u65b9\u5f0f\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5c07\u6839\u64da\u4f60\u6307\u5b9a\u7684\u8a08\u6578\u5faa\u74b0\u5275\u5efa\u5bb9\u5668\u3002\u9019\u662f\u4e00\u500b\u57fa\u672c\u7684\u8a08\u6578\u5faa\u74b0\uff0c\u6240\u4ee5\u9019\u88e1\u7684 item \u8b8a\u91cf\u63d0\u4f9b\u4e86\u4e00\u500b\u4ee3\u8868\u7576\u524d\u5faa\u74b0\u8fed\u4ee3\u7684\u6578\u5b57\u3002\u9019\u500b\u6578\u5b57\u5728\u9019\u88e1\u7528\u4f86\u547d\u540d\u4f60\u7684\u5bb9\u5668\u3002","title":"4. \u5c07 Docker \u6620\u50cf\u548c\u5bb9\u5668\u4efb\u52d9\u6dfb\u52a0\u5230\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#5-playbook","text":"\u4f60\u7684 playbook \u61c9\u5927\u81f4\u5982\u4e0b\u6240\u793a\uff0c\u6839\u64da\u4f60\u7684\u81ea\u5b9a\u7fa9\u8a2d\u7f6e\u7565\u6709\u4e0d\u540c\uff1a playbook.yml --- - hosts : all become : true vars : container_count : 4 default_container_name : docker default_container_image : ubuntu default_container_command : sleep 1d tasks : - name : Install aptitude apt : name : aptitude state : latest update_cache : true - name : Install required system packages apt : pkg : - apt-transport-https - ca-certificates - curl - software-properties-common - python3-pip - virtualenv - python3-setuptools state : latest update_cache : true - name : Add Docker GPG apt Key apt_key : url : https://download.docker.com/linux/ubuntu/gpg state : present - name : Add Docker Repository apt_repository : repo : deb https://download.docker.com/linux/ubuntu focal stable state : present - name : Update apt and install docker-ce apt : name : docker-ce state : latest update_cache : true - name : Install Docker Module for Python pip : name : docker - name : Pull default Docker image community.docker.docker_image : name : \"{{ default_container_image }}\" source : pull - name : Create default containers community.docker.docker_container : name : \"{{ default_container_name }}{{ item }}\" image : \"{{ default_container_image }}\" command : \"{{ default_container_command }}\" state : present with_sequence : count={{ container_count }} \u96a8\u610f\u4fee\u6539\u6b64\u624b\u518a\u4ee5\u6700\u9069\u5408\u4f60\u81ea\u5df1\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u7684\u500b\u4eba\u9700\u6c42\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 docker_image \u6a21\u584a\u5c07\u6620\u50cf\u63a8\u9001\u5230 Docker Hub \u6216\u4f7f\u7528 docker_container \u6a21\u584a\u4f86\u8a2d\u7f6e\u5bb9\u5668\u7db2\u7d61\u3002 \u4e00\u65e6\u4f60\u5c0d\u4f60\u7684\u5287\u672c\u611f\u5230\u6eff\u610f\uff0c\u4f60\u53ef\u4ee5\u9000\u51fa\u4f60\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4fdd\u5b58\u3002","title":"5. \u56de\u9867\u4f60\u7684\u5b8c\u6574 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#6-playbook","text":"\u4f60\u73fe\u5728\u5df2\u6e96\u5099\u597d\u5728\u4e00\u53f0\u6216\u591a\u53f0\u670d\u52d9\u5668\u4e0a\u904b\u884c\u6b64 playbook\u3002\u5927\u591a\u6578\u5287\u672c\u9ed8\u8a8d\u914d\u7f6e\u70ba\u5728\u4f60\u5eab\u5b58\u4e2d\u7684\u6bcf\u53f0\u670d\u52d9\u5668\u4e0a\u57f7\u884c\uff0c\u4f46\u9019\u6b21\u4f60\u5c07\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\u3002 \u8981\u50c5\u5728 server1 \u4e0a\u57f7\u884c playbook\uff0c\u4ee5 sammy \u8eab\u4efd\u9023\u63a5\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible-playbook playbook.yml -l server1 -u sammy -l \u6a19\u8a8c\u6307\u5b9a\u4f60\u7684\u670d\u52d9\u5668\uff0c-u \u6a19\u8a8c\u6307\u5b9a\u8981\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u767b\u9304\u7684\u7528\u6236\u3002\u4f60\u6703\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a Output . . . changed: [server1] TASK [Create default containers] ***************************************************************************************************************** changed: [server1] => (item=1) changed: [server1] => (item=2) changed: [server1] => (item=3) changed: [server1] => (item=4) PLAY RECAP *************************************************************************************************************************************** server1 : ok=9 changed=8 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u9019\u8868\u660e\u4f60\u7684\u670d\u52d9\u5668\u8a2d\u7f6e\u5df2\u5b8c\u6210\uff01\u4f60\u7684\u8f38\u51fa\u4e0d\u5fc5\u5b8c\u5168\u76f8\u540c\uff0c\u4f46\u96f6\u6545\u969c\u5f88\u91cd\u8981\u3002 \u7576 playbook \u904b\u884c\u5b8c\u6210\u5f8c\uff0c\u901a\u904e SSH \u767b\u9304\u5230 Ansible \u63d0\u4f9b\u7684\u670d\u52d9\u5668\uff0c\u6aa2\u67e5\u5bb9\u5668\u662f\u5426\u5275\u5efa\u6210\u529f\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u767b\u9304\u9060\u7a0b\u670d\u52d9\u5668\uff1a ssh sammy@your_remote_server_ip vagrant ssh \u4e26\u5217\u51fa\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u7684 Docker \u5bb9\u5668\uff1a $ sudo docker ps -a \u4f60\u61c9\u8a72\u6703\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff1a CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES 9885b07bb59b ubuntu \"sleep 1d\" 3 minutes ago Created docker4 06d42806b828 ubuntu \"sleep 1d\" 3 minutes ago Created docker3 83a27e8fe4db ubuntu \"sleep 1d\" 3 minutes ago Created docker2 c6e52400d0c9 ubuntu \"sleep 1d\" 3 minutes ago Created docker1 \u9019\u610f\u5473\u8457 playbook \u4e2d\u5b9a\u7fa9\u7684\u5bb9\u5668\u5df2\u6210\u529f\u5275\u5efa\u3002\u7531\u65bc\u9019\u662f playbook \u4e2d\u7684\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\uff0c\u56e0\u6b64\u5b83\u9084\u78ba\u8a8d playbook \u5df2\u5728\u6b64\u670d\u52d9\u5668\u4e0a\u5b8c\u5168\u57f7\u884c\u3002","title":"6. \u904b\u884c\u4f60\u7684 Playbook"},{"location":"ansible/tutorial/ansible-install-docker/#_2","text":"\u81ea\u52d5\u5316\u4f60\u7684\u57fa\u790e\u8a2d\u65bd\u8a2d\u7f6e\u4e0d\u50c5\u53ef\u4ee5\u7bc0\u7701\u4f60\u7684\u6642\u9593\uff0c\u800c\u4e14\u9084\u6709\u52a9\u65bc\u78ba\u4fdd\u4f60\u7684\u670d\u52d9\u5668\u9075\u5faa\u53ef\u6839\u64da\u4f60\u7684\u9700\u6c42\u9032\u884c\u5b9a\u5236\u7684\u6a19\u6e96\u914d\u7f6e\u3002\u7531\u65bc\u73fe\u4ee3\u61c9\u7528\u7a0b\u5e8f\u7684\u5206\u4f48\u5f0f\u7279\u6027\u4ee5\u53ca\u4e0d\u540c\u66ab\u5b58\u74b0\u5883\u4e4b\u9593\u5c0d\u4e00\u81f4\u6027\u7684\u9700\u6c42\uff0c\u9019\u6a23\u7684\u81ea\u52d5\u5316\u5df2\u6210\u70ba\u8a31\u591a\u5718\u968a\u958b\u767c\u904e\u7a0b\u4e2d\u7684\u6838\u5fc3\u7d44\u4ef6\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u4f60\u6f14\u793a\u77ad\u5982\u4f55\u4f7f\u7528 Ansible \u81ea\u52d5\u5316\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u8a2d\u7f6e Docker \u7684\u904e\u7a0b\u3002\u56e0\u70ba\u6bcf\u500b\u4eba\u5728\u4f7f\u7528\u5bb9\u5668\u6642\u901a\u5e38\u6709\u4e0d\u540c\u7684\u9700\u6c42\uff0c\u6211\u5011\u9f13\u52f5\u4f60\u67e5\u770b\u5b98\u65b9 Ansible \u6587\u6a94\u4ee5\u7372\u53d6\u66f4\u591a\u4fe1\u606f\u548c docker_container Ansible \u6a21\u584a\u7684\u7528\u4f8b\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/","text":"\u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u00b6 \u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-22-04 \u914d\u7f6e\u7ba1\u7406\u7cfb\u7d71\u65e8\u5728\u70ba\u7ba1\u7406\u54e1\u548c\u904b\u71df\u5718\u968a\u7c21\u5316\u63a7\u5236\u5927\u91cf\u670d\u52d9\u5668\u7684\u904e\u7a0b\u3002\u5b83\u5011\u5141\u8a31\u60a8\u5f9e\u4e00\u500b\u4e2d\u592e\u4f4d\u7f6e\u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u63a7\u5236\u8a31\u591a\u4e0d\u540c\u7684\u7cfb\u7d71\u3002 \u96d6\u7136\u6709\u8a31\u591a\u6d41\u884c\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u53ef\u7528\u65bc Linux \u7cfb\u7d71\uff0c\u4f8b\u5982 Chef \u548c Puppet\uff0c\u4f46\u9019\u4e9b\u5de5\u5177\u901a\u5e38\u6bd4\u8a31\u591a\u4eba\u60f3\u8981\u6216\u9700\u8981\u7684\u8907\u96dc\u3002 Ansible \u662f\u9019\u4e9b\u9078\u9805\u7684\u7d55\u4f73\u66ff\u4ee3\u54c1\uff0c\u56e0\u70ba\u5b83\u63d0\u4f9b\u7684\u67b6\u69cb\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\uff0c\u4f7f\u7528 SSH \u4f86\u57f7\u884c\u81ea\u52d5\u5316\u4efb\u52d9\u4e26\u4f7f\u7528 YAML \u6587\u4ef6\u4f86\u5b9a\u7fa9\u914d\u7f6e\u7d30\u7bc0\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u8a0e\u8ad6\u5982\u4f55\u5728 Ubuntu 22.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd Ansible\uff0c\u4e26\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u8a72\u8edf\u4ef6\u7684\u4e00\u4e9b\u57fa\u790e\u77e5\u8b58\u3002\u6709\u95dc Ansible \u4f5c\u70ba\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u7684\u66f4\u9ad8\u7d1a\u6982\u8ff0\uff0c\u8acb\u53c3\u95b1 An Introduction to Configuration Management with Ansible \u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u8981\u9075\u5faa\u672c\u6559\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede\uff1aAnsible \u63a7\u5236\u7bc0\u9ede\u662f\u6211\u5011\u5c07\u7528\u4f86\u901a\u904e SSH \u9023\u63a5\u548c\u63a7\u5236 Ansible \u4e3b\u6a5f\u7684\u6a5f\u5668\u3002\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u53ef\u4ee5\u662f\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216\u5c08\u7528\u65bc\u904b\u884c Ansible \u7684\u670d\u52d9\u5668\uff0c\u4f46\u672c\u6307\u5357\u5047\u5b9a\u60a8\u7684\u63a7\u5236\u7bc0\u9ede\u662f Ubuntu 22.04 \u7cfb\u7d71\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u5177\u6709\uff1a \u5177\u6709 sudo \u6b0a\u9650\u7684\u975e root \u7528\u6236 \u3002\u8981\u9032\u884c\u6b64\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u7684 Ubuntu 22.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u7684\u7b2c 2 \u6b65\u548c\u7b2c 3 \u6b65\u9032\u884c\u64cd\u4f5c\u3002\u4f46\u662f\uff0c\u8acb\u6ce8\u610f\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u9060\u7a0b\u670d\u52d9\u5668\u4f5c\u70ba Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u5247\u61c9\u9075\u5faa\u672c\u6307\u5357\u7684\u6bcf\u500b\u6b65\u9a5f\u3002\u9019\u6a23\u505a\u5c07\u4f7f\u7528 ufw \u5728\u670d\u52d9\u5668\u4e0a\u914d\u7f6e\u9632\u706b\u7246\u4e26\u555f\u7528\u5c0d\u975e root \u7528\u6236\u914d\u7f6e\u6587\u4ef6\u7684\u5916\u90e8\u8a2a\u554f\uff0c\u9019\u5169\u8005\u90fd\u5c07\u6709\u52a9\u65bc\u4fdd\u6301\u9060\u7a0b\u670d\u52d9\u5668\u7684\u5b89\u5168\u3002 \u8207\u6b64\u7528\u6236\u95dc\u806f\u7684 SSH \u5bc6\u9470\u5c0d \u3002\u8981\u9032\u884c\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u8a2d\u7f6e SSH \u5bc6\u9470\u7684\u6307\u5357 \u7684\u7b2c 1 \u6b65\u9032\u884c\u64cd\u4f5c\u3002 Step 1 \u2014 Installing Ansible \u00b6 \u8981\u958b\u59cb\u4f7f\u7528 Ansible \u4f5c\u70ba\u7ba1\u7406\u670d\u52d9\u5668\u57fa\u790e\u67b6\u69cb\u7684\u4e00\u7a2e\u65b9\u5f0f\uff0c\u60a8\u9700\u8981\u5728\u5c07\u7528\u4f5c Ansible \u63a7\u5236\u7bc0\u9ede\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd Ansible \u8edf\u4ef6\u3002\u6211\u5011\u5c07\u70ba\u6b64\u4f7f\u7528\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5237\u65b0\u7cfb\u7d71\u7684\u5305\u7d22\u5f15\uff1a $ sudo apt update \u5728\u6b64\u66f4\u65b0\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5b89\u88dd Ansible \u8edf\u4ef6\uff1a $ sudo apt install ansible \u63d0\u793a\u78ba\u8a8d\u5b89\u88dd\u6642\u6309 Y \u3002\u5982\u679c\u7cfb\u7d71\u63d0\u793a\u60a8\u91cd\u65b0\u555f\u52d5\u4efb\u4f55\u670d\u52d9\uff0c\u8acb\u6309 ENTER \u63a5\u53d7\u9ed8\u8a8d\u8a2d\u7f6e\u4e26\u7e7c\u7e8c\u3002 \u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u73fe\u5728\u64c1\u6709\u7ba1\u7406\u4e3b\u6a5f\u6240\u9700\u200b\u200b\u7684\u6240\u6709\u8edf\u4ef6\u3002\u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\uff0c\u4ee5\u4fbf Ansible \u53ef\u4ee5\u8207\u60a8\u7684\u8a17\u7ba1\u7bc0\u9ede\u901a\u4fe1\u3002 Step 2 \u2014 Setting Up the Inventory File \u00b6 Inventory \u6e05\u55ae\u6587\u4ef6\u5305\u542b\u6709\u95dc\u60a8\u5c07\u4f7f\u7528 Ansible \u7ba1\u7406\u7684\u4e3b\u6a5f\u7684\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u5728 inventory \u6e05\u55ae\u6587\u4ef6\u4e2d\u5305\u542b\u5f9e\u4e00\u53f0\u5230\u6578\u767e\u53f0\u670d\u52d9\u5668\u7684\u4efb\u610f\u4f4d\u7f6e\uff0c\u4e26\u4e14\u53ef\u4ee5\u5c07\u4e3b\u6a5f\u7d44\u7e54\u6210\u7fa4\u7d44\u548c\u5b50\u7fa4\u7d44\u3002Inventory \u6e05\u55ae\u6587\u4ef6\u9084\u7d93\u5e38\u7528\u65bc\u8a2d\u7f6e\u50c5\u5c0d\u7279\u5b9a\u4e3b\u6a5f\u6216\u7d44\u6709\u6548\u7684\u8b8a\u91cf\uff0c\u4ee5\u4fbf\u5728\u5287\u672c\u548c\u6a21\u677f\u4e2d\u4f7f\u7528\u3002\u4e00\u4e9b\u8b8a\u91cf\u4e5f\u6703\u5f71\u97ff playbook \u7684\u904b\u884c\u65b9\u5f0f\uff0c\u4f8b\u5982\u6211\u5011\u7a0d\u5f8c\u6703\u770b\u5230\u7684 ansible_python_interpreter \u8b8a\u91cf\u3002 \u8981\u7de8\u8f2f\u9ed8\u8a8d Ansible \u7684 inventory \u6e05\u55ae\u7684\u5167\u5bb9\uff0c\u9996\u5148\u4f7f\u7528 mkdir \u547d\u4ee4\u5275\u5efa /etc/ansible \u76ee\u9304\u3002\u7136\u5f8c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u6587\u672c\u7de8\u8f2f\u5668\u6253\u958b /etc/ansible/hosts \u6587\u4ef6\uff1a $ sudo mkdir /etc/ansible $ sudo nano /etc/ansible/hosts Tip \u5118\u7ba1 Ansible \u901a\u5e38\u6703\u5728 etc/ansible/hosts \u4e2d\u5275\u5efa\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\uff0c\u4f46\u60a8\u53ef\u4ee5\u5728\u4efb\u4f55\u66f4\u9069\u5408\u60a8\u9700\u6c42\u7684\u4f4d\u7f6e\u81ea\u7531\u5275\u5efa\u6e05\u55ae\u6587\u4ef6\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u53c3\u6578\u63d0\u4f9b\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u7684\u8def\u5f91\u3002\u4f7f\u7528\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u6587\u4ef6\u662f\u4e00\u7a2e\u5f88\u597d\u7684\u505a\u6cd5\uff0c\u53ef\u4ee5\u6700\u5927\u7a0b\u5ea6\u5730\u964d\u4f4e\u5728\u932f\u8aa4\u7684\u670d\u52d9\u5668\u7d44\u4e0a\u904b\u884c\u5287\u672c\u7684\u98a8\u96aa\u3002 Ansible \u5b89\u88dd\u63d0\u4f9b\u7684\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u5305\u542b\u8a31\u591a\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5c07\u5b83\u5011\u7528\u4f5c\u8a2d\u7f6e\u6e05\u55ae\u7684\u53c3\u8003\u3002\u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba [servers] \u7684\u7d44\uff0c\u5176\u4e2d\u5305\u542b\u4e09\u500b\u4e0d\u540c\u7684\u670d\u52d9\u5668\uff0c\u6bcf\u500b\u670d\u52d9\u5668\u7531\u4e00\u500b\u81ea\u5b9a\u7fa9\u5225\u540d\u6a19\u8b58\uff1a server1 \u3001 server2 \u548c server3 \u3002\u8acb\u52d9\u5fc5\u5c07\u7a81\u51fa\u4e0b\u5217\u986f\u793a\u7684 IP \u66ff\u63db\u70ba\u4f60\u8981\u63a7\u5236\u7684 Ansible \u4e3b\u6a5f\u7684 IP \u5730\u5740\u3002 /etc/ansible/hosts [servers] server1 ansible_host=203.0.113.111 server2 ansible_host=203.0.113.112 server3 ansible_host=203.0.113.113 [all:vars] ansible_python_interpreter=/usr/bin/python3 all:vars \u5b50\u7fa4\u7d44\u8a2d\u7f6e ansible_python_interpreter \u4e3b\u6a5f\u53c3\u6578\uff0c\u8a72\u53c3\u6578\u5c07\u5c0d\u8a72\u6e05\u55ae\u4e2d\u5305\u542b\u7684\u6240\u6709\u4e3b\u6a5f\u6709\u6548\u3002\u6b64\u53c3\u6578\u78ba\u4fdd\u9060\u7a0b\u670d\u52d9\u5668\u4f7f\u7528 /usr/bin/python3 Python 3 \u53ef\u57f7\u884c\u6587\u4ef6\uff0c\u800c\u4e0d\u662f /usr/bin/python (Python 2.7)\uff0c\u9019\u5728\u6700\u8fd1\u7684 Ubuntu \u7248\u672c\u4e2d\u4e0d\u5b58\u5728\u3002 \u5b8c\u6210\u5f8c\uff0c\u6309 CTRL+X \u7136\u5f8c\u6309 Y \u548c ENTER \u78ba\u8a8d\u66f4\u6539\uff0c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002 \u6bcf\u7576\u60a8\u60f3\u6aa2\u67e5\u5eab\u5b58\u6642\uff0c\u90fd\u53ef\u4ee5\u904b\u884c\uff1a $ ansible-inventory --list -y \u60a8\u5c07\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff0c\u4f46\u5305\u542b\u60a8\u81ea\u5df1\u7684\u670d\u52d9\u5668\u57fa\u790e\u8a2d\u65bd\uff0c\u5982\u6e05\u55ae\u6587\u4ef6\u4e2d\u6240\u5b9a\u7fa9\uff1a all : children : servers : hosts : server1 : ansible_host : 203.0.113.111 ansible_python_interpreter : /usr/bin/python3 server2 : ansible_host : 203.0.113.112 ansible_python_interpreter : /usr/bin/python3 server3 : ansible_host : 203.0.113.113 ansible_python_interpreter : /usr/bin/python3 ungrouped : {} \u73fe\u5728\u60a8\u5df2\u7d93\u914d\u7f6e\u4e86\u6e05\u55ae\u6587\u4ef6\uff0c\u60a8\u64c1\u6709\u6e2c\u8a66\u8207 Ansible \u4e3b\u6a5f\u7684\u9023\u63a5\u6240\u9700\u7684\u4e00\u5207\u3002 Step 3 \u2014 Testing Connection \u00b6 \u5728\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\u4ee5\u5305\u542b\u60a8\u7684\u670d\u52d9\u5668\u4e4b\u5f8c\uff0c\u662f\u6642\u5019\u6aa2\u67e5 Ansible \u662f\u5426\u80fd\u5920\u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\u4e26\u901a\u904e SSH \u904b\u884c\u547d\u4ee4\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ubuntu root \u5e33\u6236\uff0c\u56e0\u70ba\u9019\u901a\u5e38\u662f\u65b0\u5275\u5efa\u7684\u670d\u52d9\u5668\u4e0a\u9ed8\u8a8d\u53ef\u7528\u7684\u552f\u4e00\u5e33\u6236\u3002\u5982\u679c\u60a8\u7684 Ansible \u4e3b\u6a5f\u5df2\u7d93\u5275\u5efa\u4e86\u4e00\u500b\u666e\u901a\u7684 sudo \u7528\u6236\uff0c\u6211\u5011\u9f13\u52f5\u60a8\u6539\u7528\u8a72\u5e33\u6236\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 -u \u53c3\u6578\u4f86\u6307\u5b9a\u9060\u7a0b\u7cfb\u7d71\u7528\u6236\u3002\u5982\u679c\u672a\u63d0\u4f9b\uff0cAnsible \u5c07\u5617\u8a66\u4ee5\u60a8\u7576\u524d\u7cfb\u7d71\u7528\u6236\u7684\u8eab\u4efd\u9023\u63a5\u5230\u63a7\u5236\u7bc0\u9ede\u3002 \u5f9e\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216 Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u904b\u884c\uff1a $ ansible all -m ping -u root \u6b64\u547d\u4ee4\u5c07\u4f7f\u7528 Ansible \u7684\u5167\u7f6e ping \u6a21\u584a\u5728\u9ed8\u8a8d\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u904b\u884c\u9023\u63a5\u6e2c\u8a66\uff0c\u4ee5 root \u8eab\u4efd\u9023\u63a5\u3002 ping \u6a21\u584a\u5c07\u6e2c\u8a66\uff1a \u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u8a2a\u554f\uff1b \u5982\u679c\u60a8\u64c1\u6709\u6709\u6548\u7684 SSH \u6191\u64da\uff1b \u5982\u679c\u4e3b\u6a5f\u80fd\u5920\u4f7f\u7528 Python \u904b\u884c Ansible \u6a21\u584a\u3002 \u4f60\u61c9\u8a72\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a server1 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server2 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server3 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } \u5982\u679c\u9019\u662f\u60a8\u7b2c\u4e00\u6b21\u901a\u904e SSH \u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\uff0c\u7cfb\u7d71\u6703\u8981\u6c42\u60a8\u78ba\u8a8d\u901a\u904e Ansible \u9023\u63a5\u7684\u4e3b\u6a5f\u7684\u771f\u5be6\u6027\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u9375\u5165 yes \uff0c\u7136\u5f8c\u6309 ENTER \u78ba\u8a8d\u3002 \u4e00\u65e6\u60a8\u5f9e\u4e3b\u6a5f\u6536\u5230 \u201c pong \u201d \u56de\u8986\uff0c\u9019\u610f\u5473\u8457\u60a8\u5df2\u6e96\u5099\u597d\u5728\u8a72\u670d\u52d9\u5668\u4e0a\u904b\u884c Ansible \u547d\u4ee4\u548c playbook\u3002 Info \u5982\u679c\u60a8\u7121\u6cd5\u5f9e\u670d\u52d9\u5668\u7372\u5f97\u6210\u529f\u7684\u97ff\u61c9\uff0c\u8acb\u67e5\u770b\u6211\u5011\u7684 Ansible \u5099\u5fd8\u55ae\u6307\u5357 \uff0c\u4e86\u89e3\u6709\u95dc\u5982\u4f55\u4f7f\u7528\u4e0d\u540c\u9023\u63a5\u9078\u9805\u904b\u884c Ansible \u547d\u4ee4\u7684\u66f4\u591a\u4fe1\u606f\u3002 Step 4 \u2014 Running Ad-Hoc Commands (Optional) \u00b6 \u5728\u78ba\u8a8d\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u80fd\u5920\u8207\u60a8\u7684\u4e3b\u6a5f\u901a\u4fe1\u5f8c\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u5728\u60a8\u7684\u670d\u52d9\u5668\u4e0a\u904b\u884c\u81e8\u6642\u547d\u4ee4\u548c playbook\u3002 \u60a8\u901a\u5e38\u901a\u904e SSH \u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4efb\u4f55\u547d\u4ee4\u90fd\u53ef\u4ee5\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u670d\u52d9\u5668\u4e0a\u4f7f\u7528 Ansible \u904b\u884c\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u6240\u6709\u670d\u52d9\u5668\u4e0a\u7684\u78c1\u76e4\u4f7f\u7528\u60c5\u6cc1\uff1a $ ansible all -a \"df -h\" -u root \u7d50\u679c: server1 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 3.9G 0 3.9G 0% /dev tmpfs 798M 624K 798M 1% /run /dev/vda1 155G 2.3G 153G 2% / tmpfs 3.9G 0 3.9G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 3.9G 0 3.9G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 798M 0 798M 0% /run/user/0 server2 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 2.0G 0 2.0G 0% /dev tmpfs 395M 608K 394M 1% /run /dev/vda1 78G 2.2G 76G 3% / tmpfs 2.0G 0 2.0G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 2.0G 0 2.0G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 395M 0 395M 0% /run/user/0 ... \u7a81\u51fa\u986f\u793a\u7684\u547d\u4ee4 df -h \u53ef\u4ee5\u66ff\u63db\u70ba\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u3002 \u60a8\u9084\u53ef\u4ee5\u901a\u904e ad-hoc \u547d\u4ee4\u57f7\u884c Ansible \u5176\u5b83\u6a21\u584a\uff0c\u985e\u4f3c\u65bc\u6211\u5011\u4e4b\u524d\u4f7f\u7528 ping \u6a21\u584a\u6e2c\u8a66\u9023\u63a5\u6240\u505a\u7684\u64cd\u4f5c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u662f\u6211\u5011\u5982\u4f55\u4f7f\u7528 apt \u6a21\u584a\u5728\u5eab\u5b58\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 vim \uff1a $ ansible all -m apt -a \"name=vim state=latest\" -u root \u5728\u904b\u884c Ansible \u547d\u4ee4\u6642\uff0c\u60a8\u9084\u53ef\u4ee5\u91dd\u5c0d\u55ae\u500b\u4e3b\u6a5f\u4ee5\u53ca\u7d44\u7fa4\u548c\u5b50\u7fa4\u7d44\u3002\u4f8b\u5982\uff0c\u9019\u662f\u60a8\u6aa2\u67e5\u670d\u52d9\u5668\u7d44\u4e2d\u6bcf\u500b\u4e3b\u6a5f\u7684\u6b63\u5e38\u904b\u884c\u6642\u9593\u7684\u65b9\u5f0f\uff1a $ ansible servers -a \"uptime\" -u root \u6211\u5011\u53ef\u4ee5\u901a\u904e\u7528\u5192\u865f\u5206\u9694\u4f86\u6307\u5b9a\u591a\u500b\u4e3b\u6a5f\uff1a $ ansible server1:server2 -m ping -u root \u6709\u95dc\u5982\u4f55\u4f7f\u7528 Ansible \u7684\u66f4\u591a\u4fe1\u606f\uff0c\u5305\u62ec\u5982\u4f55\u57f7\u884c playbook \u4ee5\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u6211\u5011\u7684 Ansible \u53c3\u8003\u6307\u5357 \u3002 \u7d50\u8ad6 \u00b6 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u60a8\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible \u4e26\u8a2d\u7f6e\u4e86\u4e00\u500b\u6e05\u55ae\u6587\u4ef6\u4ee5\u5f9e Ansible \u63a7\u5236\u7bc0\u9ede\u57f7\u884c\u81e8\u6642\u547d\u4ee4\u3002 \u4e00\u65e6\u60a8\u78ba\u8a8d\u60a8\u80fd\u5920\u5f9e\u4e2d\u592e Ansible \u63a7\u5236\u5668\u6a5f\u5668\u9023\u63a5\u548c\u63a7\u5236\u60a8\u7684\u57fa\u790e\u67b6\u69cb\uff0c\u60a8\u5c31\u53ef\u4ee5\u5728\u9019\u4e9b\u4e3b\u6a5f\u4e0a\u57f7\u884c\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u6216\u5287\u672c\u3002","title":"\u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#ubuntu-2204-ansible","text":"\u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-ansible-on-ubuntu-22-04 \u914d\u7f6e\u7ba1\u7406\u7cfb\u7d71\u65e8\u5728\u70ba\u7ba1\u7406\u54e1\u548c\u904b\u71df\u5718\u968a\u7c21\u5316\u63a7\u5236\u5927\u91cf\u670d\u52d9\u5668\u7684\u904e\u7a0b\u3002\u5b83\u5011\u5141\u8a31\u60a8\u5f9e\u4e00\u500b\u4e2d\u592e\u4f4d\u7f6e\u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u63a7\u5236\u8a31\u591a\u4e0d\u540c\u7684\u7cfb\u7d71\u3002 \u96d6\u7136\u6709\u8a31\u591a\u6d41\u884c\u7684\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u53ef\u7528\u65bc Linux \u7cfb\u7d71\uff0c\u4f8b\u5982 Chef \u548c Puppet\uff0c\u4f46\u9019\u4e9b\u5de5\u5177\u901a\u5e38\u6bd4\u8a31\u591a\u4eba\u60f3\u8981\u6216\u9700\u8981\u7684\u8907\u96dc\u3002 Ansible \u662f\u9019\u4e9b\u9078\u9805\u7684\u7d55\u4f73\u66ff\u4ee3\u54c1\uff0c\u56e0\u70ba\u5b83\u63d0\u4f9b\u7684\u67b6\u69cb\u4e0d\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u5b89\u88dd\u7279\u6b8a\u8edf\u4ef6\uff0c\u4f7f\u7528 SSH \u4f86\u57f7\u884c\u81ea\u52d5\u5316\u4efb\u52d9\u4e26\u4f7f\u7528 YAML \u6587\u4ef6\u4f86\u5b9a\u7fa9\u914d\u7f6e\u7d30\u7bc0\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u8a0e\u8ad6\u5982\u4f55\u5728 Ubuntu 22.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd Ansible\uff0c\u4e26\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528\u8a72\u8edf\u4ef6\u7684\u4e00\u4e9b\u57fa\u790e\u77e5\u8b58\u3002\u6709\u95dc Ansible \u4f5c\u70ba\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u7684\u66f4\u9ad8\u7d1a\u6982\u8ff0\uff0c\u8acb\u53c3\u95b1 An Introduction to Configuration Management with Ansible \u3002","title":"\u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#_1","text":"\u8981\u9075\u5faa\u672c\u6559\u7a0b\uff0c\u60a8\u5c07\u9700\u8981\uff1a \u4e00\u500b Ansible \u63a7\u5236\u7bc0\u9ede\uff1aAnsible \u63a7\u5236\u7bc0\u9ede\u662f\u6211\u5011\u5c07\u7528\u4f86\u901a\u904e SSH \u9023\u63a5\u548c\u63a7\u5236 Ansible \u4e3b\u6a5f\u7684\u6a5f\u5668\u3002\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u53ef\u4ee5\u662f\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216\u5c08\u7528\u65bc\u904b\u884c Ansible \u7684\u670d\u52d9\u5668\uff0c\u4f46\u672c\u6307\u5357\u5047\u5b9a\u60a8\u7684\u63a7\u5236\u7bc0\u9ede\u662f Ubuntu 22.04 \u7cfb\u7d71\u3002\u78ba\u4fdd\u63a7\u5236\u7bc0\u9ede\u5177\u6709\uff1a \u5177\u6709 sudo \u6b0a\u9650\u7684\u975e root \u7528\u6236 \u3002\u8981\u9032\u884c\u6b64\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u7684 Ubuntu 22.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357 \u7684\u7b2c 2 \u6b65\u548c\u7b2c 3 \u6b65\u9032\u884c\u64cd\u4f5c\u3002\u4f46\u662f\uff0c\u8acb\u6ce8\u610f\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u9060\u7a0b\u670d\u52d9\u5668\u4f5c\u70ba Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u5247\u61c9\u9075\u5faa\u672c\u6307\u5357\u7684\u6bcf\u500b\u6b65\u9a5f\u3002\u9019\u6a23\u505a\u5c07\u4f7f\u7528 ufw \u5728\u670d\u52d9\u5668\u4e0a\u914d\u7f6e\u9632\u706b\u7246\u4e26\u555f\u7528\u5c0d\u975e root \u7528\u6236\u914d\u7f6e\u6587\u4ef6\u7684\u5916\u90e8\u8a2a\u554f\uff0c\u9019\u5169\u8005\u90fd\u5c07\u6709\u52a9\u65bc\u4fdd\u6301\u9060\u7a0b\u670d\u52d9\u5668\u7684\u5b89\u5168\u3002 \u8207\u6b64\u7528\u6236\u95dc\u806f\u7684 SSH \u5bc6\u9470\u5c0d \u3002\u8981\u9032\u884c\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u6211\u5011\u95dc\u65bc \u5982\u4f55\u5728 Ubuntu 22.04 \u4e0a\u8a2d\u7f6e SSH \u5bc6\u9470\u7684\u6307\u5357 \u7684\u7b2c 1 \u6b65\u9032\u884c\u64cd\u4f5c\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-1-installing-ansible","text":"\u8981\u958b\u59cb\u4f7f\u7528 Ansible \u4f5c\u70ba\u7ba1\u7406\u670d\u52d9\u5668\u57fa\u790e\u67b6\u69cb\u7684\u4e00\u7a2e\u65b9\u5f0f\uff0c\u60a8\u9700\u8981\u5728\u5c07\u7528\u4f5c Ansible \u63a7\u5236\u7bc0\u9ede\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd Ansible \u8edf\u4ef6\u3002\u6211\u5011\u5c07\u70ba\u6b64\u4f7f\u7528\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5237\u65b0\u7cfb\u7d71\u7684\u5305\u7d22\u5f15\uff1a $ sudo apt update \u5728\u6b64\u66f4\u65b0\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5b89\u88dd Ansible \u8edf\u4ef6\uff1a $ sudo apt install ansible \u63d0\u793a\u78ba\u8a8d\u5b89\u88dd\u6642\u6309 Y \u3002\u5982\u679c\u7cfb\u7d71\u63d0\u793a\u60a8\u91cd\u65b0\u555f\u52d5\u4efb\u4f55\u670d\u52d9\uff0c\u8acb\u6309 ENTER \u63a5\u53d7\u9ed8\u8a8d\u8a2d\u7f6e\u4e26\u7e7c\u7e8c\u3002 \u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u73fe\u5728\u64c1\u6709\u7ba1\u7406\u4e3b\u6a5f\u6240\u9700\u200b\u200b\u7684\u6240\u6709\u8edf\u4ef6\u3002\u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u4ecb\u7d39\u5982\u4f55\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\uff0c\u4ee5\u4fbf Ansible \u53ef\u4ee5\u8207\u60a8\u7684\u8a17\u7ba1\u7bc0\u9ede\u901a\u4fe1\u3002","title":"Step 1 \u2014 Installing Ansible"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-2-setting-up-the-inventory-file","text":"Inventory \u6e05\u55ae\u6587\u4ef6\u5305\u542b\u6709\u95dc\u60a8\u5c07\u4f7f\u7528 Ansible \u7ba1\u7406\u7684\u4e3b\u6a5f\u7684\u4fe1\u606f\u3002\u60a8\u53ef\u4ee5\u5728 inventory \u6e05\u55ae\u6587\u4ef6\u4e2d\u5305\u542b\u5f9e\u4e00\u53f0\u5230\u6578\u767e\u53f0\u670d\u52d9\u5668\u7684\u4efb\u610f\u4f4d\u7f6e\uff0c\u4e26\u4e14\u53ef\u4ee5\u5c07\u4e3b\u6a5f\u7d44\u7e54\u6210\u7fa4\u7d44\u548c\u5b50\u7fa4\u7d44\u3002Inventory \u6e05\u55ae\u6587\u4ef6\u9084\u7d93\u5e38\u7528\u65bc\u8a2d\u7f6e\u50c5\u5c0d\u7279\u5b9a\u4e3b\u6a5f\u6216\u7d44\u6709\u6548\u7684\u8b8a\u91cf\uff0c\u4ee5\u4fbf\u5728\u5287\u672c\u548c\u6a21\u677f\u4e2d\u4f7f\u7528\u3002\u4e00\u4e9b\u8b8a\u91cf\u4e5f\u6703\u5f71\u97ff playbook \u7684\u904b\u884c\u65b9\u5f0f\uff0c\u4f8b\u5982\u6211\u5011\u7a0d\u5f8c\u6703\u770b\u5230\u7684 ansible_python_interpreter \u8b8a\u91cf\u3002 \u8981\u7de8\u8f2f\u9ed8\u8a8d Ansible \u7684 inventory \u6e05\u55ae\u7684\u5167\u5bb9\uff0c\u9996\u5148\u4f7f\u7528 mkdir \u547d\u4ee4\u5275\u5efa /etc/ansible \u76ee\u9304\u3002\u7136\u5f8c\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u6587\u672c\u7de8\u8f2f\u5668\u6253\u958b /etc/ansible/hosts \u6587\u4ef6\uff1a $ sudo mkdir /etc/ansible $ sudo nano /etc/ansible/hosts Tip \u5118\u7ba1 Ansible \u901a\u5e38\u6703\u5728 etc/ansible/hosts \u4e2d\u5275\u5efa\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\uff0c\u4f46\u60a8\u53ef\u4ee5\u5728\u4efb\u4f55\u66f4\u9069\u5408\u60a8\u9700\u6c42\u7684\u4f4d\u7f6e\u81ea\u7531\u5275\u5efa\u6e05\u55ae\u6587\u4ef6\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u5728\u904b\u884c Ansible \u547d\u4ee4\u548c playbook \u6642\u4f7f\u7528 -i \u53c3\u6578\u63d0\u4f9b\u81ea\u5b9a\u7fa9\u6e05\u55ae\u6587\u4ef6\u7684\u8def\u5f91\u3002\u4f7f\u7528\u6bcf\u500b\u9805\u76ee\u7684\u6e05\u55ae\u6587\u4ef6\u662f\u4e00\u7a2e\u5f88\u597d\u7684\u505a\u6cd5\uff0c\u53ef\u4ee5\u6700\u5927\u7a0b\u5ea6\u5730\u964d\u4f4e\u5728\u932f\u8aa4\u7684\u670d\u52d9\u5668\u7d44\u4e0a\u904b\u884c\u5287\u672c\u7684\u98a8\u96aa\u3002 Ansible \u5b89\u88dd\u63d0\u4f9b\u7684\u9ed8\u8a8d\u6e05\u55ae\u6587\u4ef6\u5305\u542b\u8a31\u591a\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5c07\u5b83\u5011\u7528\u4f5c\u8a2d\u7f6e\u6e05\u55ae\u7684\u53c3\u8003\u3002\u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba [servers] \u7684\u7d44\uff0c\u5176\u4e2d\u5305\u542b\u4e09\u500b\u4e0d\u540c\u7684\u670d\u52d9\u5668\uff0c\u6bcf\u500b\u670d\u52d9\u5668\u7531\u4e00\u500b\u81ea\u5b9a\u7fa9\u5225\u540d\u6a19\u8b58\uff1a server1 \u3001 server2 \u548c server3 \u3002\u8acb\u52d9\u5fc5\u5c07\u7a81\u51fa\u4e0b\u5217\u986f\u793a\u7684 IP \u66ff\u63db\u70ba\u4f60\u8981\u63a7\u5236\u7684 Ansible \u4e3b\u6a5f\u7684 IP \u5730\u5740\u3002 /etc/ansible/hosts [servers] server1 ansible_host=203.0.113.111 server2 ansible_host=203.0.113.112 server3 ansible_host=203.0.113.113 [all:vars] ansible_python_interpreter=/usr/bin/python3 all:vars \u5b50\u7fa4\u7d44\u8a2d\u7f6e ansible_python_interpreter \u4e3b\u6a5f\u53c3\u6578\uff0c\u8a72\u53c3\u6578\u5c07\u5c0d\u8a72\u6e05\u55ae\u4e2d\u5305\u542b\u7684\u6240\u6709\u4e3b\u6a5f\u6709\u6548\u3002\u6b64\u53c3\u6578\u78ba\u4fdd\u9060\u7a0b\u670d\u52d9\u5668\u4f7f\u7528 /usr/bin/python3 Python 3 \u53ef\u57f7\u884c\u6587\u4ef6\uff0c\u800c\u4e0d\u662f /usr/bin/python (Python 2.7)\uff0c\u9019\u5728\u6700\u8fd1\u7684 Ubuntu \u7248\u672c\u4e2d\u4e0d\u5b58\u5728\u3002 \u5b8c\u6210\u5f8c\uff0c\u6309 CTRL+X \u7136\u5f8c\u6309 Y \u548c ENTER \u78ba\u8a8d\u66f4\u6539\uff0c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002 \u6bcf\u7576\u60a8\u60f3\u6aa2\u67e5\u5eab\u5b58\u6642\uff0c\u90fd\u53ef\u4ee5\u904b\u884c\uff1a $ ansible-inventory --list -y \u60a8\u5c07\u770b\u5230\u8207\u6b64\u985e\u4f3c\u7684\u8f38\u51fa\uff0c\u4f46\u5305\u542b\u60a8\u81ea\u5df1\u7684\u670d\u52d9\u5668\u57fa\u790e\u8a2d\u65bd\uff0c\u5982\u6e05\u55ae\u6587\u4ef6\u4e2d\u6240\u5b9a\u7fa9\uff1a all : children : servers : hosts : server1 : ansible_host : 203.0.113.111 ansible_python_interpreter : /usr/bin/python3 server2 : ansible_host : 203.0.113.112 ansible_python_interpreter : /usr/bin/python3 server3 : ansible_host : 203.0.113.113 ansible_python_interpreter : /usr/bin/python3 ungrouped : {} \u73fe\u5728\u60a8\u5df2\u7d93\u914d\u7f6e\u4e86\u6e05\u55ae\u6587\u4ef6\uff0c\u60a8\u64c1\u6709\u6e2c\u8a66\u8207 Ansible \u4e3b\u6a5f\u7684\u9023\u63a5\u6240\u9700\u7684\u4e00\u5207\u3002","title":"Step 2 \u2014 Setting Up the Inventory File"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-3-testing-connection","text":"\u5728\u8a2d\u7f6e\u6e05\u55ae\u6587\u4ef6\u4ee5\u5305\u542b\u60a8\u7684\u670d\u52d9\u5668\u4e4b\u5f8c\uff0c\u662f\u6642\u5019\u6aa2\u67e5 Ansible \u662f\u5426\u80fd\u5920\u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\u4e26\u901a\u904e SSH \u904b\u884c\u547d\u4ee4\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ubuntu root \u5e33\u6236\uff0c\u56e0\u70ba\u9019\u901a\u5e38\u662f\u65b0\u5275\u5efa\u7684\u670d\u52d9\u5668\u4e0a\u9ed8\u8a8d\u53ef\u7528\u7684\u552f\u4e00\u5e33\u6236\u3002\u5982\u679c\u60a8\u7684 Ansible \u4e3b\u6a5f\u5df2\u7d93\u5275\u5efa\u4e86\u4e00\u500b\u666e\u901a\u7684 sudo \u7528\u6236\uff0c\u6211\u5011\u9f13\u52f5\u60a8\u6539\u7528\u8a72\u5e33\u6236\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 -u \u53c3\u6578\u4f86\u6307\u5b9a\u9060\u7a0b\u7cfb\u7d71\u7528\u6236\u3002\u5982\u679c\u672a\u63d0\u4f9b\uff0cAnsible \u5c07\u5617\u8a66\u4ee5\u60a8\u7576\u524d\u7cfb\u7d71\u7528\u6236\u7684\u8eab\u4efd\u9023\u63a5\u5230\u63a7\u5236\u7bc0\u9ede\u3002 \u5f9e\u60a8\u7684\u672c\u5730\u6a5f\u5668\u6216 Ansible \u63a7\u5236\u7bc0\u9ede\uff0c\u904b\u884c\uff1a $ ansible all -m ping -u root \u6b64\u547d\u4ee4\u5c07\u4f7f\u7528 Ansible \u7684\u5167\u7f6e ping \u6a21\u584a\u5728\u9ed8\u8a8d\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u7bc0\u9ede\u4e0a\u904b\u884c\u9023\u63a5\u6e2c\u8a66\uff0c\u4ee5 root \u8eab\u4efd\u9023\u63a5\u3002 ping \u6a21\u584a\u5c07\u6e2c\u8a66\uff1a \u4e3b\u6a5f\u662f\u5426\u53ef\u4ee5\u8a2a\u554f\uff1b \u5982\u679c\u60a8\u64c1\u6709\u6709\u6548\u7684 SSH \u6191\u64da\uff1b \u5982\u679c\u4e3b\u6a5f\u80fd\u5920\u4f7f\u7528 Python \u904b\u884c Ansible \u6a21\u584a\u3002 \u4f60\u61c9\u8a72\u5f97\u5230\u985e\u4f3c\u9019\u6a23\u7684\u8f38\u51fa\uff1a server1 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server2 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } server3 | SUCCESS => { \"changed\": false, \"ping\": \"pong\" } \u5982\u679c\u9019\u662f\u60a8\u7b2c\u4e00\u6b21\u901a\u904e SSH \u9023\u63a5\u5230\u9019\u4e9b\u670d\u52d9\u5668\uff0c\u7cfb\u7d71\u6703\u8981\u6c42\u60a8\u78ba\u8a8d\u901a\u904e Ansible \u9023\u63a5\u7684\u4e3b\u6a5f\u7684\u771f\u5be6\u6027\u3002\u51fa\u73fe\u63d0\u793a\u6642\uff0c\u9375\u5165 yes \uff0c\u7136\u5f8c\u6309 ENTER \u78ba\u8a8d\u3002 \u4e00\u65e6\u60a8\u5f9e\u4e3b\u6a5f\u6536\u5230 \u201c pong \u201d \u56de\u8986\uff0c\u9019\u610f\u5473\u8457\u60a8\u5df2\u6e96\u5099\u597d\u5728\u8a72\u670d\u52d9\u5668\u4e0a\u904b\u884c Ansible \u547d\u4ee4\u548c playbook\u3002 Info \u5982\u679c\u60a8\u7121\u6cd5\u5f9e\u670d\u52d9\u5668\u7372\u5f97\u6210\u529f\u7684\u97ff\u61c9\uff0c\u8acb\u67e5\u770b\u6211\u5011\u7684 Ansible \u5099\u5fd8\u55ae\u6307\u5357 \uff0c\u4e86\u89e3\u6709\u95dc\u5982\u4f55\u4f7f\u7528\u4e0d\u540c\u9023\u63a5\u9078\u9805\u904b\u884c Ansible \u547d\u4ee4\u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"Step 3 \u2014 Testing Connection"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#step-4-running-ad-hoc-commands-optional","text":"\u5728\u78ba\u8a8d\u60a8\u7684 Ansible \u63a7\u5236\u7bc0\u9ede\u80fd\u5920\u8207\u60a8\u7684\u4e3b\u6a5f\u901a\u4fe1\u5f8c\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u5728\u60a8\u7684\u670d\u52d9\u5668\u4e0a\u904b\u884c\u81e8\u6642\u547d\u4ee4\u548c playbook\u3002 \u60a8\u901a\u5e38\u901a\u904e SSH \u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u7684\u4efb\u4f55\u547d\u4ee4\u90fd\u53ef\u4ee5\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u6307\u5b9a\u7684\u670d\u52d9\u5668\u4e0a\u4f7f\u7528 Ansible \u904b\u884c\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u6240\u6709\u670d\u52d9\u5668\u4e0a\u7684\u78c1\u76e4\u4f7f\u7528\u60c5\u6cc1\uff1a $ ansible all -a \"df -h\" -u root \u7d50\u679c: server1 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 3.9G 0 3.9G 0% /dev tmpfs 798M 624K 798M 1% /run /dev/vda1 155G 2.3G 153G 2% / tmpfs 3.9G 0 3.9G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 3.9G 0 3.9G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 798M 0 798M 0% /run/user/0 server2 | CHANGED | rc=0 >> Filesystem Size Used Avail Use% Mounted on udev 2.0G 0 2.0G 0% /dev tmpfs 395M 608K 394M 1% /run /dev/vda1 78G 2.2G 76G 3% / tmpfs 2.0G 0 2.0G 0% /dev/shm tmpfs 5.0M 0 5.0M 0% /run/lock tmpfs 2.0G 0 2.0G 0% /sys/fs/cgroup /dev/vda15 105M 3.6M 101M 4% /boot/efi tmpfs 395M 0 395M 0% /run/user/0 ... \u7a81\u51fa\u986f\u793a\u7684\u547d\u4ee4 df -h \u53ef\u4ee5\u66ff\u63db\u70ba\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u3002 \u60a8\u9084\u53ef\u4ee5\u901a\u904e ad-hoc \u547d\u4ee4\u57f7\u884c Ansible \u5176\u5b83\u6a21\u584a\uff0c\u985e\u4f3c\u65bc\u6211\u5011\u4e4b\u524d\u4f7f\u7528 ping \u6a21\u584a\u6e2c\u8a66\u9023\u63a5\u6240\u505a\u7684\u64cd\u4f5c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b\u662f\u6211\u5011\u5982\u4f55\u4f7f\u7528 apt \u6a21\u584a\u5728\u5eab\u5b58\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 vim \uff1a $ ansible all -m apt -a \"name=vim state=latest\" -u root \u5728\u904b\u884c Ansible \u547d\u4ee4\u6642\uff0c\u60a8\u9084\u53ef\u4ee5\u91dd\u5c0d\u55ae\u500b\u4e3b\u6a5f\u4ee5\u53ca\u7d44\u7fa4\u548c\u5b50\u7fa4\u7d44\u3002\u4f8b\u5982\uff0c\u9019\u662f\u60a8\u6aa2\u67e5\u670d\u52d9\u5668\u7d44\u4e2d\u6bcf\u500b\u4e3b\u6a5f\u7684\u6b63\u5e38\u904b\u884c\u6642\u9593\u7684\u65b9\u5f0f\uff1a $ ansible servers -a \"uptime\" -u root \u6211\u5011\u53ef\u4ee5\u901a\u904e\u7528\u5192\u865f\u5206\u9694\u4f86\u6307\u5b9a\u591a\u500b\u4e3b\u6a5f\uff1a $ ansible server1:server2 -m ping -u root \u6709\u95dc\u5982\u4f55\u4f7f\u7528 Ansible \u7684\u66f4\u591a\u4fe1\u606f\uff0c\u5305\u62ec\u5982\u4f55\u57f7\u884c playbook \u4ee5\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u6211\u5011\u7684 Ansible \u53c3\u8003\u6307\u5357 \u3002","title":"Step 4 \u2014 Running Ad-Hoc Commands (Optional)"},{"location":"ansible/tutorial/how-to-install-and-configure-ansible-on-ubuntu-22-04/#_2","text":"\u5728\u672c\u6307\u5357\u4e2d\uff0c\u60a8\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible \u4e26\u8a2d\u7f6e\u4e86\u4e00\u500b\u6e05\u55ae\u6587\u4ef6\u4ee5\u5f9e Ansible \u63a7\u5236\u7bc0\u9ede\u57f7\u884c\u81e8\u6642\u547d\u4ee4\u3002 \u4e00\u65e6\u60a8\u78ba\u8a8d\u60a8\u80fd\u5920\u5f9e\u4e2d\u592e Ansible \u63a7\u5236\u5668\u6a5f\u5668\u9023\u63a5\u548c\u63a7\u5236\u60a8\u7684\u57fa\u790e\u67b6\u69cb\uff0c\u60a8\u5c31\u53ef\u4ee5\u5728\u9019\u4e9b\u4e3b\u6a5f\u4e0a\u57f7\u884c\u60a8\u60f3\u8981\u7684\u4efb\u4f55\u547d\u4ee4\u6216\u5287\u672c\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial/ubuntu-insall-docker/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Docker \u00b6 \u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u5728\u5bb9\u5668\u4e2d\u7ba1\u7406\u61c9\u7528\u7a0b\u5e8f\u9032\u7a0b\u7684\u904e\u7a0b\u3002\u5bb9\u5668\u8b93\u4f60\u53ef\u4ee5\u5728\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u4e2d\u904b\u884c\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5b83\u5011\u985e\u4f3c\u65bc\u865b\u64ec\u6a5f\uff0c\u4f46\u5bb9\u5668\u66f4\u4fbf\u651c\u3001\u66f4\u8cc7\u6e90\u53cb\u597d\uff0c\u4e26\u4e14\u66f4\u4f9d\u8cf4\u65bc\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u4f60\u5c07\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u793e\u5340\u7248 (CE)\u3002\u4f60\u5c07\u5b89\u88dd Docker \u672c\u8eab\uff0c\u4f7f\u7528\u5bb9\u5668\u548c\u6620\u50cf\u6a94\uff0c\u4e26\u5c07\u6620\u50cf\u6a94\u63a8\u9001\u5230 Docker \u5b58\u5132\u5eab\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u8981\u5b78\u7fd2\u672c\u6559\u7a0b\uff0c\u4f60\u5c07\u9700\u8981\u6e96\u5099\u4ee5\u4e0b\u74b0\u5883\uff1a \u6309\u7167 Ubuntu 20.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357\u8a2d\u7f6e\u4e00\u53f0 Ubuntu 20.04 \u670d\u52d9\u5668\uff0c\u5305\u62ec sudo \u975e root \u7528\u6236\u548c\u9632\u706b\u7246\u3002(\u5728\u672c\u6559\u7a0b\u4e2d\u6211\u5011\u4f7f\u7528Vagrant\u8207VirtualBox\u4f86\u555f\u52d5\u4e00\u53f0VM) Docker Hub \u4e0a\u7684\u5e33\u6236\uff0c\u5982\u679c\u4f60\u5e0c\u671b\u5275\u5efa\u81ea\u5df1\u7684\u5716\u50cf\u4e26\u5c07\u5b83\u5011\u63a8\u9001\u5230 Docker Hub\uff0c\u5982\u6b65\u9a5f 7 \u548c 8 \u6240\u793a\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ubuntu_install_docker $ cd ubuntu_install_docker $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u7d50\u679c: Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue Jun 7 21:29:14 UTC 2022 System load: 0.06 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update \u5b89\u88dd Docker \u00b6 Ubuntu \u5b98\u65b9\u5b58\u5132\u5eab\u4e2d\u63d0\u4f9b\u7684 Docker \u5b89\u88dd\u5305\u53ef\u80fd\u4e0d\u662f\u6700\u65b0\u7248\u672c\u3002\u70ba\u78ba\u4fdd\u6211\u5011\u7372\u5f97\u6700\u65b0\u7248\u672c\uff0c\u6211\u5011\u5c07\u5f9e\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u5b89\u88dd Docker\u3002\u70ba\u6b64\uff0c\u6211\u5011\u5c07\u6dfb\u52a0\u4e00\u500b\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u5f9e Docker \u6dfb\u52a0 GPG \u5bc6\u9470\u4ee5\u78ba\u4fdd\u4e0b\u8f09\u6709\u6548\uff0c\u7136\u5f8c\u5b89\u88dd\u5957\u4ef6\u3002 \u9996\u5148\uff0c\u66f4\u65b0\u73fe\u6709\u7684\u8edf\u4ef6\u5957\u4ef6\u5217\u8868\uff1a $ sudo apt update \u63a5\u4e0b\u4f86\uff0c\u5b89\u88dd\u4e00\u4e9b\u5fc5\u5099\u5957\u4ef6\uff0c\u8b93 apt \u53ef\u901a\u904e HTTPS \u4f86\u4e0b\u8f09\u5957\u4ef6\uff1a $ sudo apt install apt-transport-https ca-certificates curl software-properties-common \u7136\u5f8c\u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u7684 GPG \u5bc6\u9470\u6dfb\u52a0\u5230\u4f60\u7684\u7cfb\u7d71\uff1a $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - \u5c07 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 APT \u5957\u4ef6\u6e90\u5217\u8868\uff1a $ sudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable\" \u9019\u4e5f\u5c07\u4f7f\u7528\u65b0\u6dfb\u52a0\u7684 repo \u4e2d\u7684 Docker \u5957\u4ef6\u66f4\u65b0\u6211\u5011\u7684\u5957\u4ef6\u6578\u64da\u5eab\u3002 \u78ba\u4fdd\u4f60\u8981\u5f9e Docker \u5b58\u5132\u5eab\u800c\u4e0d\u662f\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u9032\u884c\u5b89\u88dd\uff1a $ apt-cache policy docker-ce \u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u5118\u7ba1 Docker \u7684\u7248\u672c\u865f\u53ef\u80fd\u4e0d\u540c\uff1a docker-ce: Installed: (none) Candidate: 5:20.10.17~3-0~ubuntu-focal Version table: 5:20.10.17~3-0~ubuntu-focal 500 500 https://download.docker.com/linux/ubuntu focal/stable amd64 Packages ... ... \u8acb\u6ce8\u610f\uff0c\u6b64\u6642\u6211\u5011\u9084\u672a\u5b89\u88dd docker-ce\uff0c\u4f46\u5b89\u88dd\u7684\u5019\u9078\u8005\u4f86\u81ea Ubuntu 20.04 \u7684 Docker \u5b58\u5132\u5eab\u3002 \u6700\u5f8c\uff0c\u5b89\u88dd Docker\uff1a $ sudo apt install docker-ce Docker \u73fe\u5728\u61c9\u8a72\u5df2\u5b89\u88dd\uff0c\u5b88\u8b77\u7a0b\u5e8f\u5df2\u555f\u52d5\uff0c\u4e26\u4e14\u8a72\u9032\u7a0b\u5df2\u555f\u7528\u4ee5\u5728\u865b\u64ec\u6a5f\u555f\u52d5\u6642\u555f\u52d5\u3002\u6aa2\u67e5\u5b83\u662f\u5426\u6b63\u5728\u904b\u884c\uff1a $ sudo systemctl status docker \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff0c\u8868\u660e\u8a72\u670d\u52d9\u8655\u65bc\u6d3b\u52d5\u72c0\u614b\u4e14\u6b63\u5728\u904b\u884c\uff1a Processing triggers for systemd (245.4-4ubuntu3.17) ... vagrant@ubuntu-focal:~$ sudo systemctl status docker \u25cf docker.service - Docker Application Container Engine Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2022-06-07 21:53:53 UTC; 1min 39s ago TriggeredBy: \u25cf docker.socket Docs: https://docs.docker.com Main PID: 5211 (dockerd) Tasks: 8 Memory: 30.6M CGroup: /system.slice/docker.service \u2514\u25005211 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Docker"},{"location":"ansible/tutorial/ubuntu-insall-docker/#ubuntu-2004-docker","text":"\u539f\u6587: https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-20-04 Docker \u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u7c21\u5316\u4e86\u5728\u5bb9\u5668\u4e2d\u7ba1\u7406\u61c9\u7528\u7a0b\u5e8f\u9032\u7a0b\u7684\u904e\u7a0b\u3002\u5bb9\u5668\u8b93\u4f60\u53ef\u4ee5\u5728\u8cc7\u6e90\u9694\u96e2\u7684\u9032\u7a0b\u4e2d\u904b\u884c\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5b83\u5011\u985e\u4f3c\u65bc\u865b\u64ec\u6a5f\uff0c\u4f46\u5bb9\u5668\u66f4\u4fbf\u651c\u3001\u66f4\u8cc7\u6e90\u53cb\u597d\uff0c\u4e26\u4e14\u66f4\u4f9d\u8cf4\u65bc\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u4f60\u5c07\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u4f7f\u7528 Docker \u793e\u5340\u7248 (CE)\u3002\u4f60\u5c07\u5b89\u88dd Docker \u672c\u8eab\uff0c\u4f7f\u7528\u5bb9\u5668\u548c\u6620\u50cf\u6a94\uff0c\u4e26\u5c07\u6620\u50cf\u6a94\u63a8\u9001\u5230 Docker \u5b58\u5132\u5eab\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Docker"},{"location":"ansible/tutorial/ubuntu-insall-docker/#_1","text":"\u8981\u5b78\u7fd2\u672c\u6559\u7a0b\uff0c\u4f60\u5c07\u9700\u8981\u6e96\u5099\u4ee5\u4e0b\u74b0\u5883\uff1a \u6309\u7167 Ubuntu 20.04 \u521d\u59cb\u670d\u52d9\u5668\u8a2d\u7f6e\u6307\u5357\u8a2d\u7f6e\u4e00\u53f0 Ubuntu 20.04 \u670d\u52d9\u5668\uff0c\u5305\u62ec sudo \u975e root \u7528\u6236\u548c\u9632\u706b\u7246\u3002(\u5728\u672c\u6559\u7a0b\u4e2d\u6211\u5011\u4f7f\u7528Vagrant\u8207VirtualBox\u4f86\u555f\u52d5\u4e00\u53f0VM) Docker Hub \u4e0a\u7684\u5e33\u6236\uff0c\u5982\u679c\u4f60\u5e0c\u671b\u5275\u5efa\u81ea\u5df1\u7684\u5716\u50cf\u4e26\u5c07\u5b83\u5011\u63a8\u9001\u5230 Docker Hub\uff0c\u5982\u6b65\u9a5f 7 \u548c 8 \u6240\u793a\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ubuntu_install_docker $ cd ubuntu_install_docker $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh \u7d50\u679c: Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-113-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Tue Jun 7 21:29:14 UTC 2022 System load: 0.06 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% 1 update can be applied immediately. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial/ubuntu-insall-docker/#docker","text":"Ubuntu \u5b98\u65b9\u5b58\u5132\u5eab\u4e2d\u63d0\u4f9b\u7684 Docker \u5b89\u88dd\u5305\u53ef\u80fd\u4e0d\u662f\u6700\u65b0\u7248\u672c\u3002\u70ba\u78ba\u4fdd\u6211\u5011\u7372\u5f97\u6700\u65b0\u7248\u672c\uff0c\u6211\u5011\u5c07\u5f9e\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u5b89\u88dd Docker\u3002\u70ba\u6b64\uff0c\u6211\u5011\u5c07\u6dfb\u52a0\u4e00\u500b\u65b0\u7684\u5957\u4ef6\u6e90\uff0c\u5f9e Docker \u6dfb\u52a0 GPG \u5bc6\u9470\u4ee5\u78ba\u4fdd\u4e0b\u8f09\u6709\u6548\uff0c\u7136\u5f8c\u5b89\u88dd\u5957\u4ef6\u3002 \u9996\u5148\uff0c\u66f4\u65b0\u73fe\u6709\u7684\u8edf\u4ef6\u5957\u4ef6\u5217\u8868\uff1a $ sudo apt update \u63a5\u4e0b\u4f86\uff0c\u5b89\u88dd\u4e00\u4e9b\u5fc5\u5099\u5957\u4ef6\uff0c\u8b93 apt \u53ef\u901a\u904e HTTPS \u4f86\u4e0b\u8f09\u5957\u4ef6\uff1a $ sudo apt install apt-transport-https ca-certificates curl software-properties-common \u7136\u5f8c\u5c07\u5b98\u65b9 Docker \u5b58\u5132\u5eab\u7684 GPG \u5bc6\u9470\u6dfb\u52a0\u5230\u4f60\u7684\u7cfb\u7d71\uff1a $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - \u5c07 Docker \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 APT \u5957\u4ef6\u6e90\u5217\u8868\uff1a $ sudo add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable\" \u9019\u4e5f\u5c07\u4f7f\u7528\u65b0\u6dfb\u52a0\u7684 repo \u4e2d\u7684 Docker \u5957\u4ef6\u66f4\u65b0\u6211\u5011\u7684\u5957\u4ef6\u6578\u64da\u5eab\u3002 \u78ba\u4fdd\u4f60\u8981\u5f9e Docker \u5b58\u5132\u5eab\u800c\u4e0d\u662f\u9ed8\u8a8d\u7684 Ubuntu \u5b58\u5132\u5eab\u9032\u884c\u5b89\u88dd\uff1a $ apt-cache policy docker-ce \u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u5118\u7ba1 Docker \u7684\u7248\u672c\u865f\u53ef\u80fd\u4e0d\u540c\uff1a docker-ce: Installed: (none) Candidate: 5:20.10.17~3-0~ubuntu-focal Version table: 5:20.10.17~3-0~ubuntu-focal 500 500 https://download.docker.com/linux/ubuntu focal/stable amd64 Packages ... ... \u8acb\u6ce8\u610f\uff0c\u6b64\u6642\u6211\u5011\u9084\u672a\u5b89\u88dd docker-ce\uff0c\u4f46\u5b89\u88dd\u7684\u5019\u9078\u8005\u4f86\u81ea Ubuntu 20.04 \u7684 Docker \u5b58\u5132\u5eab\u3002 \u6700\u5f8c\uff0c\u5b89\u88dd Docker\uff1a $ sudo apt install docker-ce Docker \u73fe\u5728\u61c9\u8a72\u5df2\u5b89\u88dd\uff0c\u5b88\u8b77\u7a0b\u5e8f\u5df2\u555f\u52d5\uff0c\u4e26\u4e14\u8a72\u9032\u7a0b\u5df2\u555f\u7528\u4ee5\u5728\u865b\u64ec\u6a5f\u555f\u52d5\u6642\u555f\u52d5\u3002\u6aa2\u67e5\u5b83\u662f\u5426\u6b63\u5728\u904b\u884c\uff1a $ sudo systemctl status docker \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\u4ee5\u4e0b\u5167\u5bb9\uff0c\u8868\u660e\u8a72\u670d\u52d9\u8655\u65bc\u6d3b\u52d5\u72c0\u614b\u4e14\u6b63\u5728\u904b\u884c\uff1a Processing triggers for systemd (245.4-4ubuntu3.17) ... vagrant@ubuntu-focal:~$ sudo systemctl status docker \u25cf docker.service - Docker Application Container Engine Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled) Active: active (running) since Tue 2022-06-07 21:53:53 UTC; 1min 39s ago TriggeredBy: \u25cf docker.socket Docs: https://docs.docker.com Main PID: 5211 (dockerd) Tasks: 8 Memory: 30.6M CGroup: /system.slice/docker.service \u2514\u25005211 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock","title":"\u5b89\u88dd Docker"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/","text":"Ansible AWX \u57fa\u672c\u4f7f\u7528\u548c\u914d\u7f6e \u00b6 AWX \u662f\u4e00\u500b\u958b\u6e90 Web \u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u70ba Ansible \u63d0\u4f9b\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\u3002\u5b83\u662f Ansible Tower \u7684\u958b\u6e90\u7248\u672c\u3002 AWX \u5141\u8a31\u60a8\u4f7f\u7528 Web \u754c\u9762\u7ba1\u7406 Ansible \u5287\u672c\u3001\u6e05\u55ae\u548c\u5b89\u6392\u4f5c\u696d\u904b\u884c\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u5411\u60a8\u5c55\u793a Ansible AWX \u7684\u57fa\u672c\u7528\u6cd5\u3002\u56e0\u6b64\uff0c\u60a8\u9700\u8981\u4e00\u53f0\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible AWX \u7684\u670d\u52d9\u5668\u3002\u6211\u5011\u4ecb\u7d39\u4e86\u4e00\u4e9b\u60a8\u5fc5\u9808\u4e86\u89e3\u7684 Ansible AWX \u57fa\u672c\u914d\u7f6e\uff0c\u4f8b\u5982\u8a2d\u7f6e\u6191\u64da\u3001\u5eab\u5b58\u3001\u8a2d\u7f6e\u548c\u904b\u884c\u4f5c\u696d\u6a21\u677f\u7b49\u3002 1. Ansible AWX \u74b0\u5883\u8a2d\u7f6e\u548c\u914d\u7f6e \u00b6 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ansible AWX \u5100\u8868\u677f\u90e8\u7f72\u548c\u904b\u884c Ansible playbook \u4ee5\u9032\u884c\u57fa\u672c LEMP \u5b89\u88dd\u3002 \u9996\u5148\u8acb\u6839\u64da \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX \u7684\u6559\u7a0b\u4f86\u5b89\u88dd\u8207\u555f\u52d5 Ansible AWX\u3002 $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA 2. \u5275\u5efa\u4e00\u53f0Ansible\u7ba1\u7406\u7d50\u9ede\u7684\u865b\u64ec\u4e3b\u6a5f \u00b6 \u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u4f7f\u7528 Vagrant \u4f86\u914d\u7f6e\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u3002 \u5275\u5efa\u4e00\u500b\u76ee\u9304 \u00b6 \u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_ansible_awx $ cd vagrant_ansible_awx \u521d\u59cb\u5316\u5c08\u6848 \u00b6 Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a ubuntu/focal64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"private_network\" , type : \"dhcp\" end \u555f\u52d5\u865b\u64ec\u6a5f VM \u00b6 \u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220610.0.0' is up to date... ==> default: Setting the name of the VM: vagrant_ansible_awx_default_1655334451195_65866 ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat default: Adapter 2: hostonly ==> default: Forwarding ports... default: 22 (guest) => 2222 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Configuring and enabling network interfaces... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_ansible_awx SSH\u9032\u5165\u865b\u64ec\u6a5f \u00b6 Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-117-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jun 15 23:09:53 UTC 2022 System load: 0.18 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% IPv4 address for enp0s8: 192.168.56.5 Info \u5f9e\u767b\u5165\u7684console\u8a0a\u606f\u4e2d\u53ef\u5f97\u77e5\u9019\u500b\u865b\u64ec\u6a5f\u5f9e DHCP \u670d\u52d9\u4e2d\u53d6\u5f97\u7684 IP \u4f4d\u5740 \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed \u6aa2\u67e5\u6a5f\u5668\u72c0\u614b \u00b6 \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`. 3. \u5728 AWX \u4e2d\u8a2d\u5b9a Credentials \u00b6 \u9996\u5148\uff0c\u6211\u5011\u9700\u8981\u5728 Ansible AWX \u914d\u7f6e\u7ba1\u7406\u7bc0\u9ede\u7684\u6191\u8b49\u3002\u5b83\u7528\u65bc\u5c0d\u8a17\u7ba1\u7684\u670d\u52d9\u5668\u555f\u52d5\u548c\u904b\u884c\u4f5c\u696d\u3001\u8207\u5eab\u5b58\u6e90\u540c\u6b65\u548c\u5c0e\u5165\u9805\u76ee\u6642\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible AWX \u652f\u6301\u591a\u7a2e\u6191\u8b49\uff0c\u5305\u62ec\u901a\u904e SSH \u8eab\u4efd\u9a57\u8b49\u7684 VM \u6a5f\u5668\u3001Amazon Web Services\u3001Google Compute Engine\u3001OpenStack\u3001Vault \u5bc6\u78bc\u3001\u6e90\u4ee3\u78bc\u63a7\u5236\u7b49\u3002 \u8981\u8a2d\u7f6e\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 Credentials \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca Add \u6309\u9215\u3002 \u73fe\u5728\u9375\u5165\u6191\u8b49 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u5c07 \u201cCredential Type\u201d \u6307\u5b9a\u70ba \u201cMachine\u201d\u3002 \u7c21\u55ae\u5730\u8aaa\uff0c\u201cMachine\u201d\u6191\u8b49\u5c07\u5141\u8a31\u60a8\u4f7f\u7528 SSH \u8eab\u4efd\u9a57\u8b49\u4f86\u7ba1\u7406\u670d\u52d9\u5668\u3002\u5b83\u652f\u6301\u5bc6\u78bc\u548c\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002\u56e0\u6b64\uff0c\u8f38\u5165\u7528\u6236\u540d vagrant \u4e26\u7c98\u8cbc\u8a72\u7528\u6236\u7684\u79c1\u9470\u3002 \u7136\u5f8c\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u6700\u5f8c\u6aa2\u67e5\u6211\u5011\u662f\u5426\u5df2\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible AWX \u6191\u8b49\u985e\u578b\u201c\u6a5f\u5668\u201d\u3002 4. \u5728 AWX \u4e2d\u8a2d\u5b9a Inventory \u00b6 Inventory \u662f\u7531 Ansible AWX \u7ba1\u7406\u7684\u4e3b\u6a5f\u670d\u52d9\u5668\u6e05\u55ae\u8207\u7fa4\u7d44\u8cc7\u8a0a\u3002Inventory \u5141\u8a31\u60a8\u5275\u5efa\u4e00\u500b\u5305\u542b\u591a\u500b\u4e3b\u6a5f\u670d\u52d9\u5668\u7684\u7fa4\u7d44\u3002\u4e26\u4e14\u53ef\u4ee5\u66f4\u8f15\u9b06\u5730\u7ba1\u7406\u5177\u6709\u4e0d\u540c\u74b0\u5883\u7684\u4e0d\u540c\u670d\u52d9\u5668\u3002 \u70ba\u4e86\u7ba1\u7406\u548c\u63d0\u4f9b\u670d\u52d9\u5668\uff0c\u6211\u5011\u5fc5\u9808\u5275\u5efa\u4e00\u500b\u65b0\u7684 Inventory \u7fa4\u7d44\uff0c\u7136\u5f8c\u5c07\u670d\u52d9\u5668\u4e3b\u6a5f\u6dfb\u52a0\u5230\u8a72\u7fa4\u7d44\u4e2d\u3002 \u8981\u6dfb\u52a0\u65b0\u5eab\u5b58\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 \u201cInventory\u201d \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u4e26\u9078\u64c7\u201c\u5eab\u5b58\u201d\u3002 \u8f38\u5165 Inventory \u7684 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u55ae\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u73fe\u5728\u55ae\u64ca \u201cHosts\u201d \u9078\u9805\u5361\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u6dfb\u52a0\u65b0\u4e3b\u6a5f\u3002 \u9375\u5165\u201cName\u201d\u3001\u201cDescription\u201d \u548c \u201cVariables\u201d \u4ee5\u53ca\u76ee\u6a19\u6a5f\u5668 IP \u5730\u5740 \u201cansible_host: 192.168.56.5\u201d \u7684\u9644\u52a0\u914d\u7f6e\u3002 \u73fe\u5728\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u9700\u8981\u901a\u904e\u4f7f\u7528 ping \u547d\u4ee4\u6aa2\u67e5\u4e3b\u6a5f\u4f86\u78ba\u4fdd\u4e3b\u6a5f\u914d\u7f6e\u3002 \u8fd4\u56de\u201c\u4e3b\u6a5f\u201d\u9078\u9805\u5361\uff0c\u52fe\u9078\u4e3b\u6a5f\u7684\u540d\u7a31\u670d\u52d9\u5668\uff0c\u7136\u5f8c\u55ae\u64ca\u201c\u904b\u884c\u547d\u4ee4\u201d\u6309\u9215\u3002 \u73fe\u5728\u9078\u64c7\u540d\u70ba\u201c ping \u201d\u7684\u201c\u6a21\u584a\u201d\uff0c\u7136\u5f8c\u55ae\u64ca\u201cNext\u201d\u6309\u9215\u3002","title":"Ansible AWX \u57fa\u672c\u4f7f\u7528\u548c\u914d\u7f6e"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#ansible-awx","text":"AWX \u662f\u4e00\u500b\u958b\u6e90 Web \u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u70ba Ansible \u63d0\u4f9b\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\u3002\u5b83\u662f Ansible Tower \u7684\u958b\u6e90\u7248\u672c\u3002 AWX \u5141\u8a31\u60a8\u4f7f\u7528 Web \u754c\u9762\u7ba1\u7406 Ansible \u5287\u672c\u3001\u6e05\u55ae\u548c\u5b89\u6392\u4f5c\u696d\u904b\u884c\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u5411\u60a8\u5c55\u793a Ansible AWX \u7684\u57fa\u672c\u7528\u6cd5\u3002\u56e0\u6b64\uff0c\u60a8\u9700\u8981\u4e00\u53f0\u5df2\u7d93\u5b89\u88dd\u4e86 Ansible AWX \u7684\u670d\u52d9\u5668\u3002\u6211\u5011\u4ecb\u7d39\u4e86\u4e00\u4e9b\u60a8\u5fc5\u9808\u4e86\u89e3\u7684 Ansible AWX \u57fa\u672c\u914d\u7f6e\uff0c\u4f8b\u5982\u8a2d\u7f6e\u6191\u64da\u3001\u5eab\u5b58\u3001\u8a2d\u7f6e\u548c\u904b\u884c\u4f5c\u696d\u6a21\u677f\u7b49\u3002","title":"Ansible AWX \u57fa\u672c\u4f7f\u7528\u548c\u914d\u7f6e"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#1-ansible-awx","text":"\u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Ansible AWX \u5100\u8868\u677f\u90e8\u7f72\u548c\u904b\u884c Ansible playbook \u4ee5\u9032\u884c\u57fa\u672c LEMP \u5b89\u88dd\u3002 \u9996\u5148\u8acb\u6839\u64da \u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX \u7684\u6559\u7a0b\u4f86\u5b89\u88dd\u8207\u555f\u52d5 Ansible AWX\u3002 $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA","title":"1. Ansible AWX \u74b0\u5883\u8a2d\u7f6e\u548c\u914d\u7f6e"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#2-ansible","text":"\u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u4f7f\u7528 Vagrant \u4f86\u914d\u7f6e\u4e00\u53f0\u865b\u64ec\u4e3b\u6a5f\u3002","title":"2. \u5275\u5efa\u4e00\u53f0Ansible\u7ba1\u7406\u7d50\u9ede\u7684\u865b\u64ec\u4e3b\u6a5f"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#_1","text":"\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir vagrant_ansible_awx $ cd vagrant_ansible_awx","title":"\u5275\u5efa\u4e00\u500b\u76ee\u9304"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#_2","text":"Vagrant \u6709\u4e00\u500b\u7528\u65bc\u521d\u59cb\u5316\u9805\u76ee\u7684\u5167\u7f6e\u547d\u4ee4 vagrant init \uff0c\u5b83\u53ef\u4ee5\u5c07\u4e00\u500b\u9810\u5148\u69cb\u5efa\u597d\u7684 VM Image Box \u548c URL \u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u521d\u59cb\u5316\u76ee\u9304\u4e26\u6307\u5b9a ubuntu/focal64 \u7684 VM image\u3002 $ vagrant init ubuntu/focal64 A `Vagrantfile` has been placed in this directory. You are now ready to `vagrant up` your first virtual environment! Please read the comments in the Vagrantfile as well as documentation on `vagrantup.com` for more information on using Vagrant. Vagrant \u521d\u59cb\u5316\u4e4b\u5f8c\u6703\u5728\u7576\u524d\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b Vagrantfile \u6a94\u6848\u3002\u4f60\u53ef\u7528\u4efb\u4f55\u4e00\u7a2e\u6587\u5b57\u7de8\u8f2f\u5668\u6253\u958b Vagrantfile \uff0c\u5176\u4e2d\u5305\u542b\u4e00\u4e9b\u8a3b\u91cb\u548c\u793a\u4f8b\u3002\u5728\u4ee5\u4e0b\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u4fee\u6539\u6b64\u6587\u4ef6\u3002 Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"private_network\" , type : \"dhcp\" end","title":"\u521d\u59cb\u5316\u5c08\u6848"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#vm","text":"\u73fe\u5728\u4f60\u5df2\u7d93\u521d\u59cb\u5316\u4e86\u4f60\u7684\u5c08\u6848\u4e26\u914d\u7f6e\u4e86\u4e00\u500bVM Box\u4f9b\u5b83\u4f7f\u7528\uff0c\u662f\u6642\u5019\u555f\u52d5\u4f60\u7684\u7b2c\u4e00\u500b Vagrant \u74b0\u5883\u4e86\u3002 \u5f9e\u4f60\u7684\u7d42\u7aef\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ vagrant up \u5728\u5e7e\u5206\u9418\u5167\uff0c\u6b64\u547d\u4ee4\u5c07\u5b8c\u6210\uff0c\u4f60\u5c07\u64c1\u6709\u4e00\u500b\u904b\u884c Ubuntu \u7684\u865b\u64ec\u6a5f\u3002 Bringing machine 'default' up with 'virtualbox' provider... ==> default: Importing base box 'ubuntu/focal64'... ==> default: Matching MAC address for NAT networking... ==> default: Checking if box 'ubuntu/focal64' version '20220610.0.0' is up to date... ==> default: Setting the name of the VM: vagrant_ansible_awx_default_1655334451195_65866 ==> default: Clearing any previously set network interfaces... ==> default: Preparing network interfaces based on configuration... default: Adapter 1: nat default: Adapter 2: hostonly ==> default: Forwarding ports... default: 22 (guest) => 2222 (host) (adapter 1) ==> default: Running 'pre-boot' VM customizations... ==> default: Booting VM... ==> default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127.0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key default: default: Vagrant insecure key detected. Vagrant will automatically replace default: this with a newly generated keypair for better security. default: default: Inserting generated public key within guest... default: Removing insecure key from the guest if it's present... default: Key inserted! Disconnecting and reconnecting using new SSH key... ==> default: Machine booted and ready! ==> default: Checking for guest additions in VM... ==> default: Configuring and enabling network interfaces... ==> default: Mounting shared folders... default: /vagrant => /home/dxlab/opt/vagrant_ansible_awx","title":"\u555f\u52d5\u865b\u64ec\u6a5f VM"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#ssh","text":"Vagrant \u6703\u5728\u6c92\u6709 UI \u7684\u60c5\u6cc1\u4e0b\u904b\u884c\u865b\u64ec\u6a5f\u3002\u70ba\u4e86\u8b49\u660e\u5b83\u6b63\u5728\u904b\u884c\uff0c\u4f60\u53ef\u4ee5\u901a\u904e SSH \u9032\u5165\u6a5f\u5668\uff1a $ vagrant ssh Welcome to Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-117-generic x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jun 15 23:09:53 UTC 2022 System load: 0.18 Processes: 122 Usage of /: 3.5% of 38.71GB Users logged in: 0 Memory usage: 21% IPv4 address for enp0s3: 10.0.2.15 Swap usage: 0% IPv4 address for enp0s8: 192.168.56.5 Info \u5f9e\u767b\u5165\u7684console\u8a0a\u606f\u4e2d\u53ef\u5f97\u77e5\u9019\u500b\u865b\u64ec\u6a5f\u5f9e DHCP \u670d\u52d9\u4e2d\u53d6\u5f97\u7684 IP \u4f4d\u5740 \u6b64\u547d\u4ee4\u5c07\u4f7f\u958b\u555f\u4e00\u500b SSH \u9023\u7dda\u4f86\u8207 VM \u4e92\u52d5\u3002\u82b1\u9ede\u6642\u9593\u60f3\u4e00\u60f3\u525b\u525b\u767c\u751f\u4e86\u4ec0\u9ebc\uff1a\u53ea\u9700\u5728\u7d42\u7aef\u4e2d\u9032\u884c\u4e00\u884c\u914d\u7f6e\u548c\u4e00\u500b\u547d\u4ee4\uff0c\u6211\u5011\u5c31\u5275\u5efa\u4e86\u4e00\u500b\u529f\u80fd\u9f4a\u5168\u3001\u53ef\u901a\u904e SSH \u8a2a\u554f\u7684\u865b\u64ec\u6a5f\u3002 \u4f7f\u7528 CTRL+D \u6216\u767b\u51fa\u4f86\u7d42\u6b62 SSH\u3002 vagrant@ubuntu-focal:~$ logout Connection to 127.0.0.1 closed","title":"SSH\u9032\u5165\u865b\u64ec\u6a5f"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#_3","text":"\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 vagrant status \u4f86\u78ba\u8a8d\u7576\u524d Vagrant \u4e3b\u6a5f\u7684\u904b\u4f5c\u72c0\u6cc1\uff1a $ vagrant status Current machine states: default running (virtualbox) The VM is running. To stop this VM, you can run `vagrant halt` to shut it down forcefully, or you can run `vagrant suspend` to simply suspend the virtual machine. In either case, to restart it again, simply run `vagrant up`.","title":"\u6aa2\u67e5\u6a5f\u5668\u72c0\u614b"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#3-awx-credentials","text":"\u9996\u5148\uff0c\u6211\u5011\u9700\u8981\u5728 Ansible AWX \u914d\u7f6e\u7ba1\u7406\u7bc0\u9ede\u7684\u6191\u8b49\u3002\u5b83\u7528\u65bc\u5c0d\u8a17\u7ba1\u7684\u670d\u52d9\u5668\u555f\u52d5\u548c\u904b\u884c\u4f5c\u696d\u3001\u8207\u5eab\u5b58\u6e90\u540c\u6b65\u548c\u5c0e\u5165\u9805\u76ee\u6642\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cAnsible AWX \u652f\u6301\u591a\u7a2e\u6191\u8b49\uff0c\u5305\u62ec\u901a\u904e SSH \u8eab\u4efd\u9a57\u8b49\u7684 VM \u6a5f\u5668\u3001Amazon Web Services\u3001Google Compute Engine\u3001OpenStack\u3001Vault \u5bc6\u78bc\u3001\u6e90\u4ee3\u78bc\u63a7\u5236\u7b49\u3002 \u8981\u8a2d\u7f6e\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 Credentials \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca Add \u6309\u9215\u3002 \u73fe\u5728\u9375\u5165\u6191\u8b49 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u5c07 \u201cCredential Type\u201d \u6307\u5b9a\u70ba \u201cMachine\u201d\u3002 \u7c21\u55ae\u5730\u8aaa\uff0c\u201cMachine\u201d\u6191\u8b49\u5c07\u5141\u8a31\u60a8\u4f7f\u7528 SSH \u8eab\u4efd\u9a57\u8b49\u4f86\u7ba1\u7406\u670d\u52d9\u5668\u3002\u5b83\u652f\u6301\u5bc6\u78bc\u548c\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u57fa\u65bc\u5bc6\u9470\u7684\u8eab\u4efd\u9a57\u8b49\u3002\u56e0\u6b64\uff0c\u8f38\u5165\u7528\u6236\u540d vagrant \u4e26\u7c98\u8cbc\u8a72\u7528\u6236\u7684\u79c1\u9470\u3002 \u7136\u5f8c\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u6700\u5f8c\u6aa2\u67e5\u6211\u5011\u662f\u5426\u5df2\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible AWX \u6191\u8b49\u985e\u578b\u201c\u6a5f\u5668\u201d\u3002","title":"3. \u5728 AWX \u4e2d\u8a2d\u5b9a Credentials"},{"location":"ansible/tutorial_awx/ansible-awx-guide-basic-usage-and-configuration/#4-awx-inventory","text":"Inventory \u662f\u7531 Ansible AWX \u7ba1\u7406\u7684\u4e3b\u6a5f\u670d\u52d9\u5668\u6e05\u55ae\u8207\u7fa4\u7d44\u8cc7\u8a0a\u3002Inventory \u5141\u8a31\u60a8\u5275\u5efa\u4e00\u500b\u5305\u542b\u591a\u500b\u4e3b\u6a5f\u670d\u52d9\u5668\u7684\u7fa4\u7d44\u3002\u4e26\u4e14\u53ef\u4ee5\u66f4\u8f15\u9b06\u5730\u7ba1\u7406\u5177\u6709\u4e0d\u540c\u74b0\u5883\u7684\u4e0d\u540c\u670d\u52d9\u5668\u3002 \u70ba\u4e86\u7ba1\u7406\u548c\u63d0\u4f9b\u670d\u52d9\u5668\uff0c\u6211\u5011\u5fc5\u9808\u5275\u5efa\u4e00\u500b\u65b0\u7684 Inventory \u7fa4\u7d44\uff0c\u7136\u5f8c\u5c07\u670d\u52d9\u5668\u4e3b\u6a5f\u6dfb\u52a0\u5230\u8a72\u7fa4\u7d44\u4e2d\u3002 \u8981\u6dfb\u52a0\u65b0\u5eab\u5b58\uff0c\u8acb\u55ae\u64ca\u5de6\u5074\u7684 \u201cInventory\u201d \u83dc\u55ae\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u4e26\u9078\u64c7\u201c\u5eab\u5b58\u201d\u3002 \u8f38\u5165 Inventory \u7684 \u201cName\u201d \u548c \u201cDescription\u201d\uff0c\u7136\u5f8c\u55ae\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u73fe\u5728\u55ae\u64ca \u201cHosts\u201d \u9078\u9805\u5361\uff0c\u7136\u5f8c\u55ae\u64ca \u201cAdd\u201d \u6309\u9215\u6dfb\u52a0\u65b0\u4e3b\u6a5f\u3002 \u9375\u5165\u201cName\u201d\u3001\u201cDescription\u201d \u548c \u201cVariables\u201d \u4ee5\u53ca\u76ee\u6a19\u6a5f\u5668 IP \u5730\u5740 \u201cansible_host: 192.168.56.5\u201d \u7684\u9644\u52a0\u914d\u7f6e\u3002 \u73fe\u5728\u9ede\u64ca \u201cSave\u201d \u6309\u9215\u3002 \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u9700\u8981\u901a\u904e\u4f7f\u7528 ping \u547d\u4ee4\u6aa2\u67e5\u4e3b\u6a5f\u4f86\u78ba\u4fdd\u4e3b\u6a5f\u914d\u7f6e\u3002 \u8fd4\u56de\u201c\u4e3b\u6a5f\u201d\u9078\u9805\u5361\uff0c\u52fe\u9078\u4e3b\u6a5f\u7684\u540d\u7a31\u670d\u52d9\u5668\uff0c\u7136\u5f8c\u55ae\u64ca\u201c\u904b\u884c\u547d\u4ee4\u201d\u6309\u9215\u3002 \u73fe\u5728\u9078\u64c7\u540d\u70ba\u201c ping \u201d\u7684\u201c\u6a21\u584a\u201d\uff0c\u7136\u5f8c\u55ae\u64ca\u201cNext\u201d\u6309\u9215\u3002","title":"4. \u5728 AWX \u4e2d\u8a2d\u5b9a Inventory"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX \u00b6 \u6b61\u8fce\u95b1\u8b80\u4eca\u5929\u7684\u6307\u5357\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u4f7f\u7528 Minikube \u5b89\u88dd Ansible AWX\u3002 Ansible AWX \u662f\u4e00\u500b\u958b\u6e90\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u500b\u57fa\u65bc Web \u7684\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\uff0c\u7528\u65bc\u8f15\u9b06\u3001\u5354\u4f5c\u5730\u7ba1\u7406 Ansible Playbooks \u548c Inventories\u3002 AWX \u5141\u8a31\u60a8\u5f9e Web \u754c\u9762\u96c6\u4e2d\u7ba1\u7406 Ansible \u5287\u672c\u3001\u5eab\u5b58\u3001\u6a5f\u5bc6\u548c\u8a08\u5283\u4f5c\u696d\u3002\u5728 Ubuntu 20.04 Linux \u7cfb\u7d71\u4e0a\u5b89\u88dd AWX \u5f88\u5bb9\u6613\u3002\u4f7f\u7528\u4e0b\u9762\u5171\u4eab\u7684\u6b65\u9a5f\u5728 Ubuntu 20.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible AWX\u3002 \u5f9e AWX 18.0 \u7248\u958b\u59cb\uff0c\u63a8\u85a6\u7684\u5b89\u88dd\u65b9\u6cd5\u662f\u901a\u904e AWX Operator \u3002\u7531\u65bc operator \u5b89\u88dd\u65b9\u5f0f\u9700\u8981 Kubernetes \u96c6\u7fa4\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Minikube \u5728 Ubuntu Linux \u4e0a\u57f7\u884c\u55ae\u7bc0\u9ede Kubernetes \u5b89\u88dd\u3002 \u8a2d\u7f6e\u6700\u4f4e\u8981\u6c42 \u00b6 Ubuntu 20.04 LTS \u670d\u52d9\u5668 \u81f3\u5c11 8GB \u7684\u200b\u200b RAM 4vcpus 10GB \u53ef\u7528\u78c1\u76e4\u5b58\u5132\u7a7a\u9593 \u4f7f\u7528 sudo \u9032\u884c ssh \u7684 root \u6216\u7528\u6236 1. \u66f4\u65b0 Ubuntu \u7cfb\u7d71 \u00b6 \u66f4\u65b0\u548c\u5347\u7d1a\u60a8\u7684\u7cfb\u7d71 sudo apt update sudo apt -y upgrade && sudo systemctl reboot 2. \u5b89\u88dd\u55ae\u7bc0\u9ede Minikube \u00b6 \u53c3\u8003 \u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube \u4f86\u555f\u52d5\u55ae\u7bc0\u9ede\u7684 Kubernetes\u3002 $ minikube start --cpus = 4 --memory = 6g --addons = ingress \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \u2757 Your cgroup does not allow setting memory. \u25aa More information: https://docs.docker.com/engine/install/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 4 , Memory = 6144MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass, ingress \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u90e8\u7f72 Minikube \u5f8c\uff0c\u6aa2\u67e5\u7bc0\u9ede\u548c kube-apiserver \u901a\u4fe1\u662f\u5426\u6309\u9810\u671f\u5de5\u4f5c\u3002 $ kubectl get nodes NAME STATUS ROLES AGE VERSION minikube Ready control-plane,master 115s v1.23.3 kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE ingress-nginx ingress-nginx-admission-create-8c749 0 /1 Completed 0 2m40s ingress-nginx ingress-nginx-admission-patch-vszkd 0 /1 Completed 1 2m40s ingress-nginx ingress-nginx-controller-cc8496874-zjw2b 1 /1 Running 0 2m40s kube-system coredns-64897985d-2n22v 1 /1 Running 0 2m40s kube-system etcd-minikube 1 /1 Running 0 2m51s kube-system kube-apiserver-minikube 1 /1 Running 0 2m55s kube-system kube-controller-manager-minikube 1 /1 Running 0 2m54s kube-system kube-proxy-vkr58 1 /1 Running 0 2m40s kube-system kube-scheduler-minikube 1 /1 Running 0 2m52s kube-system storage-provisioner 1 /1 Running 0 2m50s 3. \u57fa\u672c\u5b89\u88dd \u00b6 \u64c1\u6709\u4e00\u500b\u6b63\u5728\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Kustomize \u5c07 AWX Operator \u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa4\u4e2d\u3002\u4ee5\u4e0b\u8173\u672c\u6aa2\u6e2c\u60a8\u7684\u64cd\u4f5c\u7cfb\u7d71\u4e26\u5c07\u9069\u7576\u7684 kustomize \u4e8c\u9032\u88fd\u6587\u4ef6\u4e0b\u8f09\u5230\u60a8\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u3002 $ curl -s \"https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh\" | bash $ sudo mv kustomize /usr/local/bin/ \u9996\u5148\u5f9e AWX Operator \u7684 Github \u4e0a\u67e5\u627e\u6700\u65b0\u91cb\u51fa\u7684\u7248\u672c: https://github.com/ansible/awx-operator/releases \u8209\u4f8b\u4f86\u8aaa\u5728\u73fe\u5728\u7576\u4e0b2022/06/15\u67e5\u627e\u6642\u770b\u5230\u6700\u65b0\u7684\u7248\u672c\u662f 0.22.0 \u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba kustomization.yaml \u7684\u6587\u4ef6\uff0c\u5176\u5167\u5bb9\u5982\u4e0b(\u8acb\u4f7f\u7528\u67e5\u627e\u5230\u7684\u7248\u672c\u4f86\u66ff\u4ee3 <tag> \u7684\u6a19\u7c64)\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : # Find the latest tag here: https://github.com/ansible/awx-operator/releases - github.com/ansible/awx-operator/config/default?ref=<tag> # Set the image tags to match the git version from above images : - name : quay.io/ansible/awx-operator newTag : <tag> # Specify a custom namespace in which to install AWX namespace : awx Info \u63d0\u793a\uff1a\u5982\u679c\u60a8\u9700\u8981\u66f4\u6539AWX Operator\u7684\u4efb\u4f55\u9ed8\u8a8d\u8a2d\u7f6e\uff08\u4f8b\u5982 resources.limits\uff09\uff0c\u60a8\u53ef\u4ee5\u5728 kustomization.yaml \u6587\u4ef6\u7684\u5e95\u90e8\u6dfb\u52a0\u88dc\u4e01\u3002 \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd\u6e05\u55ae\uff1a $ kustomize build . | kubectl apply -f - namespace/awx created customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com created serviceaccount/awx-operator-controller-manager created role.rbac.authorization.k8s.io/awx-operator-awx-manager-role created role.rbac.authorization.k8s.io/awx-operator-leader-election-role created clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader created clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role created rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding created rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding created configmap/awx-operator-awx-manager-config created service/awx-operator-controller-manager-metrics-service created deployment.apps/awx-operator-controller-manager created \u7a0d\u7b49\u4e00\u4e0b\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 awx-operator \u904b\u884c\u5728 Kubernetes \u88e1\uff1a $ kubectl get pods -n awx NAME READY STATUS RESTARTS AGE awx-operator-controller-manager-c6554d8f-v9vbn 2 /2 Running 0 2m10s \u70ba\u4e86\u8b93\u6211\u5011\u4e0d\u5fc5\u4e00\u76f4\u91cd\u8907\u9375\u5165 -n awx \uff0c\u8b93\u6211\u5011\u70ba kubectl \u8a2d\u7f6e\u7576\u524d\u9810\u8a2d\u7684\u547d\u540d\u7a7a\u9593\uff1a $ kubectl config set-context --current --namespace = awx Context \"minikube\" modified. \u63a5\u4e0b\u4f86\uff0c\u4f7f\u7528\u4ee5\u4e0b\u5efa\u8b70\u7684\u5167\u5bb9\u5728\u540c\u4e00\u6587\u4ef6\u593e\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba awx-demo.yaml \u7684\u6587\u4ef6\u3002\u5176\u4e2d metadata.name \u8a2d\u5b9a\u7684\u5c07\u662f\u751f\u6210\u7684 AWX \u90e8\u7f72\u7684\u540d\u7a31\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u5c07\u591a\u500b AWX \u5be6\u4f8b\u90e8\u7f72\u5230\u540c\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff0c\u8acb\u52d9\u5fc5\u4f7f\u7528\u552f\u4e00\u540d\u7a31\u3002 awx-demo.yaml --- apiVersion : awx.ansible.com/v1beta1 kind : AWX metadata : name : awx-demo spec : service_type : nodeport \u78ba\u4fdd\u5c07\u6b64\u65b0\u6587\u4ef6\u6dfb\u52a0\u5230 kustomization.yaml \u6587\u4ef6\u4e2d\u7684 \u201cresources\u201d \u5217\u8868\u4e2d\uff1a ... resources : - github.com/ansible/awx-operator/config/default?ref=<tag> # Add this extra line: - awx-demo.yaml ... \u6700\u5f8c\uff0c\u518d\u6b21\u904b\u884c kustomize \u5728\u96c6\u7fa4\u4e2d\u5275\u5efa AWX \u5be6\u4f8b\uff1a $ kustomize build . | kubectl apply -f - \u7d50\u679c: namespace/awx unchanged customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com unchanged serviceaccount/awx-operator-controller-manager unchanged role.rbac.authorization.k8s.io/awx-operator-awx-manager-role configured role.rbac.authorization.k8s.io/awx-operator-leader-election-role unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding unchanged clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding unchanged configmap/awx-operator-awx-manager-config unchanged service/awx-operator-controller-manager-metrics-service unchanged deployment.apps/awx-operator-controller-manager unchanged awx.awx.ansible.com/awx-demo created \u5e7e\u5206\u9418\u5f8c\uff0c\u5728 Kubernetes \u4e2d\u5c07\u770b\u5230\u65b0\u90e8\u7f72\u7684 AWX \u5be6\u4f8b\u3002\u60a8\u53ef\u4ee5\u67e5\u770b operator pod \u65e5\u8a8c\u4ee5\u4e86\u89e3\u5b89\u88dd\u904e\u7a0b\u7684\u4f4d\u7f6e\uff1a $ kubectl logs -f deployments/awx-operator-controller-manager -c awx-manager \u5e7e\u79d2\u9418\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 AWX Operator \u958b\u59cb\u5275\u5efa\u65b0\u8cc7\u6e90\uff1a $ kubectl get pods -l \"app.kubernetes.io/managed-by=awx-operator\" NAME READY STATUS RESTARTS AGE awx-demo-fb89f8dd-rz42r 4 /4 Running 0 3m7s awx-demo-postgres-0 1 /1 Running 0 4m3s $ kubectl get svc -l \"app.kubernetes.io/managed-by=awx-operator\" NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE awx-demo-postgres ClusterIP None <none> 5432 /TCP 4m42s awx-demo-service NodePort 10 .99.232.78 <none> 80 :30080/TCP 3m48s \u90e8\u7f72\u5f8c\uff0c\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u8a2a\u554f AWX \u5be6\u4f8b\uff1a $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#ubuntu-2004-ansible-awx","text":"\u6b61\u8fce\u95b1\u8b80\u4eca\u5929\u7684\u6307\u5357\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u4f7f\u7528 Minikube \u5b89\u88dd Ansible AWX\u3002 Ansible AWX \u662f\u4e00\u500b\u958b\u6e90\u5de5\u5177\uff0c\u5b83\u63d0\u4f9b\u4e86\u4e00\u500b\u57fa\u65bc Web \u7684\u7528\u6236\u754c\u9762\u3001REST API \u548c\u4efb\u52d9\u5f15\u64ce\uff0c\u7528\u65bc\u8f15\u9b06\u3001\u5354\u4f5c\u5730\u7ba1\u7406 Ansible Playbooks \u548c Inventories\u3002 AWX \u5141\u8a31\u60a8\u5f9e Web \u754c\u9762\u96c6\u4e2d\u7ba1\u7406 Ansible \u5287\u672c\u3001\u5eab\u5b58\u3001\u6a5f\u5bc6\u548c\u8a08\u5283\u4f5c\u696d\u3002\u5728 Ubuntu 20.04 Linux \u7cfb\u7d71\u4e0a\u5b89\u88dd AWX \u5f88\u5bb9\u6613\u3002\u4f7f\u7528\u4e0b\u9762\u5171\u4eab\u7684\u6b65\u9a5f\u5728 Ubuntu 20.04 \u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible AWX\u3002 \u5f9e AWX 18.0 \u7248\u958b\u59cb\uff0c\u63a8\u85a6\u7684\u5b89\u88dd\u65b9\u6cd5\u662f\u901a\u904e AWX Operator \u3002\u7531\u65bc operator \u5b89\u88dd\u65b9\u5f0f\u9700\u8981 Kubernetes \u96c6\u7fa4\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Minikube \u5728 Ubuntu Linux \u4e0a\u57f7\u884c\u55ae\u7bc0\u9ede Kubernetes \u5b89\u88dd\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Ansible AWX"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#_1","text":"Ubuntu 20.04 LTS \u670d\u52d9\u5668 \u81f3\u5c11 8GB \u7684\u200b\u200b RAM 4vcpus 10GB \u53ef\u7528\u78c1\u76e4\u5b58\u5132\u7a7a\u9593 \u4f7f\u7528 sudo \u9032\u884c ssh \u7684 root \u6216\u7528\u6236","title":"\u8a2d\u7f6e\u6700\u4f4e\u8981\u6c42"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#1-ubuntu","text":"\u66f4\u65b0\u548c\u5347\u7d1a\u60a8\u7684\u7cfb\u7d71 sudo apt update sudo apt -y upgrade && sudo systemctl reboot","title":"1. \u66f4\u65b0 Ubuntu \u7cfb\u7d71"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#2-minikube","text":"\u53c3\u8003 \u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube \u4f86\u555f\u52d5\u55ae\u7bc0\u9ede\u7684 Kubernetes\u3002 $ minikube start --cpus = 4 --memory = 6g --addons = ingress \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \u2757 Your cgroup does not allow setting memory. \u25aa More information: https://docs.docker.com/engine/install/linux-postinstall/#your-kernel-does-not-support-cgroup-swap-limit-capabilities \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 4 , Memory = 6144MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass, ingress \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u90e8\u7f72 Minikube \u5f8c\uff0c\u6aa2\u67e5\u7bc0\u9ede\u548c kube-apiserver \u901a\u4fe1\u662f\u5426\u6309\u9810\u671f\u5de5\u4f5c\u3002 $ kubectl get nodes NAME STATUS ROLES AGE VERSION minikube Ready control-plane,master 115s v1.23.3 kubectl get pods -A NAMESPACE NAME READY STATUS RESTARTS AGE ingress-nginx ingress-nginx-admission-create-8c749 0 /1 Completed 0 2m40s ingress-nginx ingress-nginx-admission-patch-vszkd 0 /1 Completed 1 2m40s ingress-nginx ingress-nginx-controller-cc8496874-zjw2b 1 /1 Running 0 2m40s kube-system coredns-64897985d-2n22v 1 /1 Running 0 2m40s kube-system etcd-minikube 1 /1 Running 0 2m51s kube-system kube-apiserver-minikube 1 /1 Running 0 2m55s kube-system kube-controller-manager-minikube 1 /1 Running 0 2m54s kube-system kube-proxy-vkr58 1 /1 Running 0 2m40s kube-system kube-scheduler-minikube 1 /1 Running 0 2m52s kube-system storage-provisioner 1 /1 Running 0 2m50s","title":"2. \u5b89\u88dd\u55ae\u7bc0\u9ede Minikube"},{"location":"ansible/tutorial_awx/how-to-install-ansible-awx/#3","text":"\u64c1\u6709\u4e00\u500b\u6b63\u5728\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Kustomize \u5c07 AWX Operator \u90e8\u7f72\u5230\u60a8\u7684\u96c6\u7fa4\u4e2d\u3002\u4ee5\u4e0b\u8173\u672c\u6aa2\u6e2c\u60a8\u7684\u64cd\u4f5c\u7cfb\u7d71\u4e26\u5c07\u9069\u7576\u7684 kustomize \u4e8c\u9032\u88fd\u6587\u4ef6\u4e0b\u8f09\u5230\u60a8\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u3002 $ curl -s \"https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh\" | bash $ sudo mv kustomize /usr/local/bin/ \u9996\u5148\u5f9e AWX Operator \u7684 Github \u4e0a\u67e5\u627e\u6700\u65b0\u91cb\u51fa\u7684\u7248\u672c: https://github.com/ansible/awx-operator/releases \u8209\u4f8b\u4f86\u8aaa\u5728\u73fe\u5728\u7576\u4e0b2022/06/15\u67e5\u627e\u6642\u770b\u5230\u6700\u65b0\u7684\u7248\u672c\u662f 0.22.0 \u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba kustomization.yaml \u7684\u6587\u4ef6\uff0c\u5176\u5167\u5bb9\u5982\u4e0b(\u8acb\u4f7f\u7528\u67e5\u627e\u5230\u7684\u7248\u672c\u4f86\u66ff\u4ee3 <tag> \u7684\u6a19\u7c64)\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : # Find the latest tag here: https://github.com/ansible/awx-operator/releases - github.com/ansible/awx-operator/config/default?ref=<tag> # Set the image tags to match the git version from above images : - name : quay.io/ansible/awx-operator newTag : <tag> # Specify a custom namespace in which to install AWX namespace : awx Info \u63d0\u793a\uff1a\u5982\u679c\u60a8\u9700\u8981\u66f4\u6539AWX Operator\u7684\u4efb\u4f55\u9ed8\u8a8d\u8a2d\u7f6e\uff08\u4f8b\u5982 resources.limits\uff09\uff0c\u60a8\u53ef\u4ee5\u5728 kustomization.yaml \u6587\u4ef6\u7684\u5e95\u90e8\u6dfb\u52a0\u88dc\u4e01\u3002 \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88dd\u6e05\u55ae\uff1a $ kustomize build . | kubectl apply -f - namespace/awx created customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com created customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com created serviceaccount/awx-operator-controller-manager created role.rbac.authorization.k8s.io/awx-operator-awx-manager-role created role.rbac.authorization.k8s.io/awx-operator-leader-election-role created clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader created clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role created rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding created rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding created clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding created configmap/awx-operator-awx-manager-config created service/awx-operator-controller-manager-metrics-service created deployment.apps/awx-operator-controller-manager created \u7a0d\u7b49\u4e00\u4e0b\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 awx-operator \u904b\u884c\u5728 Kubernetes \u88e1\uff1a $ kubectl get pods -n awx NAME READY STATUS RESTARTS AGE awx-operator-controller-manager-c6554d8f-v9vbn 2 /2 Running 0 2m10s \u70ba\u4e86\u8b93\u6211\u5011\u4e0d\u5fc5\u4e00\u76f4\u91cd\u8907\u9375\u5165 -n awx \uff0c\u8b93\u6211\u5011\u70ba kubectl \u8a2d\u7f6e\u7576\u524d\u9810\u8a2d\u7684\u547d\u540d\u7a7a\u9593\uff1a $ kubectl config set-context --current --namespace = awx Context \"minikube\" modified. \u63a5\u4e0b\u4f86\uff0c\u4f7f\u7528\u4ee5\u4e0b\u5efa\u8b70\u7684\u5167\u5bb9\u5728\u540c\u4e00\u6587\u4ef6\u593e\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba awx-demo.yaml \u7684\u6587\u4ef6\u3002\u5176\u4e2d metadata.name \u8a2d\u5b9a\u7684\u5c07\u662f\u751f\u6210\u7684 AWX \u90e8\u7f72\u7684\u540d\u7a31\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u5c07\u591a\u500b AWX \u5be6\u4f8b\u90e8\u7f72\u5230\u540c\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff0c\u8acb\u52d9\u5fc5\u4f7f\u7528\u552f\u4e00\u540d\u7a31\u3002 awx-demo.yaml --- apiVersion : awx.ansible.com/v1beta1 kind : AWX metadata : name : awx-demo spec : service_type : nodeport \u78ba\u4fdd\u5c07\u6b64\u65b0\u6587\u4ef6\u6dfb\u52a0\u5230 kustomization.yaml \u6587\u4ef6\u4e2d\u7684 \u201cresources\u201d \u5217\u8868\u4e2d\uff1a ... resources : - github.com/ansible/awx-operator/config/default?ref=<tag> # Add this extra line: - awx-demo.yaml ... \u6700\u5f8c\uff0c\u518d\u6b21\u904b\u884c kustomize \u5728\u96c6\u7fa4\u4e2d\u5275\u5efa AWX \u5be6\u4f8b\uff1a $ kustomize build . | kubectl apply -f - \u7d50\u679c: namespace/awx unchanged customresourcedefinition.apiextensions.k8s.io/awxbackups.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxrestores.awx.ansible.com unchanged customresourcedefinition.apiextensions.k8s.io/awxs.awx.ansible.com unchanged serviceaccount/awx-operator-controller-manager unchanged role.rbac.authorization.k8s.io/awx-operator-awx-manager-role configured role.rbac.authorization.k8s.io/awx-operator-leader-election-role unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-metrics-reader unchanged clusterrole.rbac.authorization.k8s.io/awx-operator-proxy-role unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-awx-manager-rolebinding unchanged rolebinding.rbac.authorization.k8s.io/awx-operator-leader-election-rolebinding unchanged clusterrolebinding.rbac.authorization.k8s.io/awx-operator-proxy-rolebinding unchanged configmap/awx-operator-awx-manager-config unchanged service/awx-operator-controller-manager-metrics-service unchanged deployment.apps/awx-operator-controller-manager unchanged awx.awx.ansible.com/awx-demo created \u5e7e\u5206\u9418\u5f8c\uff0c\u5728 Kubernetes \u4e2d\u5c07\u770b\u5230\u65b0\u90e8\u7f72\u7684 AWX \u5be6\u4f8b\u3002\u60a8\u53ef\u4ee5\u67e5\u770b operator pod \u65e5\u8a8c\u4ee5\u4e86\u89e3\u5b89\u88dd\u904e\u7a0b\u7684\u4f4d\u7f6e\uff1a $ kubectl logs -f deployments/awx-operator-controller-manager -c awx-manager \u5e7e\u79d2\u9418\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 AWX Operator \u958b\u59cb\u5275\u5efa\u65b0\u8cc7\u6e90\uff1a $ kubectl get pods -l \"app.kubernetes.io/managed-by=awx-operator\" NAME READY STATUS RESTARTS AGE awx-demo-fb89f8dd-rz42r 4 /4 Running 0 3m7s awx-demo-postgres-0 1 /1 Running 0 4m3s $ kubectl get svc -l \"app.kubernetes.io/managed-by=awx-operator\" NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE awx-demo-postgres ClusterIP None <none> 5432 /TCP 4m42s awx-demo-service NodePort 10 .99.232.78 <none> 80 :30080/TCP 3m48s \u90e8\u7f72\u5f8c\uff0c\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u8a2a\u554f AWX \u5be6\u4f8b\uff1a $ minikube service awx-demo-service --url -n awx http://192.168.49.2:30080 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u7ba1\u7406\u54e1\u7528\u6236\u662f admin \uff0c\u5bc6\u78bc\u5132\u653e\u5728 -admin-password \u5bc6\u78bc\u4e2d\u3002\u8981\u6aa2\u7d22\u7ba1\u7406\u54e1\u5bc6\u78bc\uff0c\u8acb\u904b\u884c\uff1a $ kubectl get secret awx-demo-admin-password -o jsonpath = \"{.data.password}\" | base64 --decode E9ByxRu4Nn1jXzzF7oCKH7Gux9nJjmRA","title":"3. \u57fa\u672c\u5b89\u88dd"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible \u00b6 Ansible playbook \u4f7f\u7528 YAML \u683c\u5f0f\u4f86\u5b9a\u7fa9\u4e00\u500b\u6216\u591a\u500b\u5287\u672c\u3002\u5287\u672c\u662f\u4e00\u7d44\u6709\u5e8f\u7684\u4efb\u52d9\uff0c\u9019\u4e9b\u4efb\u52d9\u4ee5\u81ea\u52d5\u5316\u6d41\u7a0b\u7684\u65b9\u5f0f\u6392\u5217\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\u3002 \u5728 playbook \u6587\u4ef6\u4e2d\uff0cplays \u88ab\u5b9a\u7fa9\u70ba YAML \u5217\u8868\u3002\u5178\u578b\u7684 playbook \u662f\u5f9e\u78ba\u5b9a\u54ea\u4e9b\u4e3b\u6a5f\u662f\u8a72\u7279\u5b9a\u8a2d\u7f6e\u7684\u76ee\u6a19\u958b\u59cb\u3002\u9019\u662f\u901a\u904e hosts \u6307\u4ee4\u5b8c\u6210\u7684\u3002 \u5c07 hosts \u6307\u4ee4\u8a2d\u7f6e\u70ba all \u662f\u4e00\u7a2e\u5e38\u898b\u7684\u9078\u64c7\uff0c\u56e0\u70ba\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u5e36\u6709 -l \u53c3\u6578\u7684 ansible-playbook \u547d\u4ee4\u4f86\u5728\u57f7\u884c\u6642\u6307\u5b9a\u81ea\u52d5\u8a2d\u5b9a\u7684\u76ee\u6a19\u3002\u9019\u5141\u8a31\u4f60\u5728\u4e0d\u540c\u7684\u670d\u52d9\u5668\u6216\u7d44\u4e0a\u904b\u884c\u76f8\u540c\u7684 playbook\uff0c\u800c\u7121\u9700\u6bcf\u6b21\u90fd\u66f4\u6539 playbook \u6587\u4ef6\u3002 \u524d\u7f6e\u6e96\u5099 \u00b6 \u9996\u5148\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u53ef\u4ee5\u5728\u5176\u4e2d\u4fdd\u5b58\u7df4\u7fd2\u624b\u518a\u3002\u9996\u5148\uff0c\u78ba\u4fdd\u4f60\u4f4d\u65bc Ubuntu \u7528\u6236\u7684\u4e3b\u76ee\u9304\u4e2d\u3002\u5f9e\u90a3\u88e1\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba ansible-practice \u7684\u76ee\u9304\uff0c\u7136\u5f8c\u4f7f\u7528 cd \u547d\u4ee4\u5c0e\u822a\u5230\u8a72\u76ee\u9304\uff1a $ mkdir ansible-practice $ cd ansible-practice \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-practice/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" } Ansible Playbook \u5287\u672c \u00b6 \u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u65b0\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook-01.yml \u4ee5\u4e0b\u5287\u672c\u5b9a\u7fa9\u4e86\u91dd\u5c0d\u7d66\u5b9a\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u4e3b\u6a5f\u7684\u5287\u672c\u3002\u5b83\u5305\u542b\u4e00\u500b\u6253\u5370\u8abf\u8a66\u6d88\u606f\u7684\u4efb\u52d9\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u4f60\u7684 playbook-01.yml \u6587\u4ef6\u4e2d\uff1a playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f nano\uff0c\u4f60\u53ef\u4ee5\u901a\u904e\u9375\u5165 CTRL+X\u3001Y \u548c ENTER \u4f86\u78ba\u8a8d\u3002 \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u4f46\u8acb\u52d9\u5fc5\u66f4\u6539\u9019\u4e9b\u8a73\u7d30\u4fe1\u606f\u4ee5\u8207\u4f60\u81ea\u5df1\u7684\u5eab\u5b58\u6587\u4ef6\u548c\u7ba1\u7406\u7528\u6236\u4fdd\u6301\u4e00\u81f4\uff1a $ ansible-playbook -i inventory playbook-01.yml \u7d50\u679c: PLAY [all] *************************************************************************** TASK [Gathering Facts] *************************************************************** ok: [demo-vm] TASK [Print message] ***************************************************************** ok: [demo-vm] => { \"msg\": \"Hello Ansible World\" } PLAY RECAP *************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u7d50\u8ad6 \u00b6 \u4f60\u53ef\u80fd\u5df2\u7d93\u6ce8\u610f\u5230\uff0c\u5373\u4f7f\u4f60\u5728 playbook \u4e2d\u53ea\u5b9a\u7fa9\u4e86\u4e00\u500b\u4efb\u52d9\uff0cplay \u8f38\u51fa\u4e2d\u4e5f\u5217\u51fa\u4e86\u5169\u500b\u4efb\u52d9\u3002\u5728\u6bcf\u6b21\u64ad\u653e\u958b\u59cb\u6642\uff0cAnsible \u9ed8\u8a8d\u57f7\u884c\u4e00\u500b\u984d\u5916\u7684\u4efb\u52d9\uff0c\u8a72\u4efb\u52d9\u6536\u96c6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u7684\u4fe1\u606f\uff08\u7a31\u70ba facts \uff09\u3002\u56e0\u70ba\u53ef\u4ee5\u5728\u5287\u672c\u4e0a\u4f7f\u7528 fact \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u7684\u884c\u70ba\uff0c\u6240\u4ee5\u4e8b\u5be6\u6536\u96c6\u4efb\u52d9\u5fc5\u9808\u5728\u57f7\u884c\u4efb\u4f55\u5176\u4ed6\u4efb\u52d9\u4e4b\u524d\u767c\u751f\u3002 \u6211\u5011\u5c07\u5728\u672c\u7cfb\u5217\u7684\u5f8c\u9762\u90e8\u5206\u4e86\u89e3\u6709\u95dc Ansible fact \u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"\u5982\u4f55\u5275\u5efa\u8207\u904b\u884c"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#ubuntu-2004-ansible","text":"Ansible playbook \u4f7f\u7528 YAML \u683c\u5f0f\u4f86\u5b9a\u7fa9\u4e00\u500b\u6216\u591a\u500b\u5287\u672c\u3002\u5287\u672c\u662f\u4e00\u7d44\u6709\u5e8f\u7684\u4efb\u52d9\uff0c\u9019\u4e9b\u4efb\u52d9\u4ee5\u81ea\u52d5\u5316\u6d41\u7a0b\u7684\u65b9\u5f0f\u6392\u5217\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u751f\u7522\u74b0\u5883\u3002 \u5728 playbook \u6587\u4ef6\u4e2d\uff0cplays \u88ab\u5b9a\u7fa9\u70ba YAML \u5217\u8868\u3002\u5178\u578b\u7684 playbook \u662f\u5f9e\u78ba\u5b9a\u54ea\u4e9b\u4e3b\u6a5f\u662f\u8a72\u7279\u5b9a\u8a2d\u7f6e\u7684\u76ee\u6a19\u958b\u59cb\u3002\u9019\u662f\u901a\u904e hosts \u6307\u4ee4\u5b8c\u6210\u7684\u3002 \u5c07 hosts \u6307\u4ee4\u8a2d\u7f6e\u70ba all \u662f\u4e00\u7a2e\u5e38\u898b\u7684\u9078\u64c7\uff0c\u56e0\u70ba\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u5e36\u6709 -l \u53c3\u6578\u7684 ansible-playbook \u547d\u4ee4\u4f86\u5728\u57f7\u884c\u6642\u6307\u5b9a\u81ea\u52d5\u8a2d\u5b9a\u7684\u76ee\u6a19\u3002\u9019\u5141\u8a31\u4f60\u5728\u4e0d\u540c\u7684\u670d\u52d9\u5668\u6216\u7d44\u4e0a\u904b\u884c\u76f8\u540c\u7684 playbook\uff0c\u800c\u7121\u9700\u6bcf\u6b21\u90fd\u66f4\u6539 playbook \u6587\u4ef6\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Ansible"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#_1","text":"\u9996\u5148\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u53ef\u4ee5\u5728\u5176\u4e2d\u4fdd\u5b58\u7df4\u7fd2\u624b\u518a\u3002\u9996\u5148\uff0c\u78ba\u4fdd\u4f60\u4f4d\u65bc Ubuntu \u7528\u6236\u7684\u4e3b\u76ee\u9304\u4e2d\u3002\u5f9e\u90a3\u88e1\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba ansible-practice \u7684\u76ee\u9304\uff0c\u7136\u5f8c\u4f7f\u7528 cd \u547d\u4ee4\u5c0e\u822a\u5230\u8a72\u76ee\u9304\uff1a $ mkdir ansible-practice $ cd ansible-practice \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-practice/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" }","title":"\u524d\u7f6e\u6e96\u5099"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#ansible-playbook","text":"\u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u65b0\u7684 playbook \u6587\u4ef6\uff1a $ nano playbook-01.yml \u4ee5\u4e0b\u5287\u672c\u5b9a\u7fa9\u4e86\u91dd\u5c0d\u7d66\u5b9a\u6e05\u55ae\u4e2d\u7684\u6240\u6709\u4e3b\u6a5f\u7684\u5287\u672c\u3002\u5b83\u5305\u542b\u4e00\u500b\u6253\u5370\u8abf\u8a66\u6d88\u606f\u7684\u4efb\u52d9\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u4f60\u7684 playbook-01.yml \u6587\u4ef6\u4e2d\uff1a playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002\u5982\u679c\u4f60\u4f7f\u7528\u7684\u662f nano\uff0c\u4f60\u53ef\u4ee5\u901a\u904e\u9375\u5165 CTRL+X\u3001Y \u548c ENTER \u4f86\u78ba\u8a8d\u3002 \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff0c\u4f46\u8acb\u52d9\u5fc5\u66f4\u6539\u9019\u4e9b\u8a73\u7d30\u4fe1\u606f\u4ee5\u8207\u4f60\u81ea\u5df1\u7684\u5eab\u5b58\u6587\u4ef6\u548c\u7ba1\u7406\u7528\u6236\u4fdd\u6301\u4e00\u81f4\uff1a $ ansible-playbook -i inventory playbook-01.yml \u7d50\u679c: PLAY [all] *************************************************************************** TASK [Gathering Facts] *************************************************************** ok: [demo-vm] TASK [Print message] ***************************************************************** ok: [demo-vm] => { \"msg\": \"Hello Ansible World\" } PLAY RECAP *************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0","title":"Ansible Playbook \u5287\u672c"},{"location":"ansible/tutorial_playbook/creating-and-running-your-first-ansible-playbook/#_2","text":"\u4f60\u53ef\u80fd\u5df2\u7d93\u6ce8\u610f\u5230\uff0c\u5373\u4f7f\u4f60\u5728 playbook \u4e2d\u53ea\u5b9a\u7fa9\u4e86\u4e00\u500b\u4efb\u52d9\uff0cplay \u8f38\u51fa\u4e2d\u4e5f\u5217\u51fa\u4e86\u5169\u500b\u4efb\u52d9\u3002\u5728\u6bcf\u6b21\u64ad\u653e\u958b\u59cb\u6642\uff0cAnsible \u9ed8\u8a8d\u57f7\u884c\u4e00\u500b\u984d\u5916\u7684\u4efb\u52d9\uff0c\u8a72\u4efb\u52d9\u6536\u96c6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u7684\u4fe1\u606f\uff08\u7a31\u70ba facts \uff09\u3002\u56e0\u70ba\u53ef\u4ee5\u5728\u5287\u672c\u4e0a\u4f7f\u7528 fact \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u7684\u884c\u70ba\uff0c\u6240\u4ee5\u4e8b\u5be6\u6536\u96c6\u4efb\u52d9\u5fc5\u9808\u5728\u57f7\u884c\u4efb\u4f55\u5176\u4ed6\u4efb\u52d9\u4e4b\u524d\u767c\u751f\u3002 \u6211\u5011\u5c07\u5728\u672c\u7cfb\u5217\u7684\u5f8c\u9762\u90e8\u5206\u4e86\u89e3\u6709\u95dc Ansible fact \u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial_playbook/how-to-access-system-information-facts-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u8a2a\u554f\u7cfb\u7d71\u4fe1\u606f\uff08Facts\uff09 \u00b6 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5728\u57f7\u884c playbook \u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u96c6\u4e4b\u524d\uff0cAnsible \u5c07\u82b1\u4e00\u4e9b\u6642\u9593\u4f86\u6536\u96c6\u6709\u95dc\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u7684\u4fe1\u606f\u3002\u9019\u4e9b\u4fe1\u606f\uff08\u7a31\u70baFacts\uff09\u5305\u542b\u8af8\u5982\u7db2\u7d61\u63a5\u53e3\u548c\u5730\u5740\u3001\u9060\u7a0b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u64cd\u4f5c\u7cfb\u7d71\u548c\u53ef\u7528\u5167\u5b58\u7b49\u8a73\u7d30\u4fe1\u606f\u3002 Ansible \u4ee5 JSON \u683c\u5f0f\u5b58\u5132 \u4e8b\u5be6 \uff0c\u9805\u76ee\u6309\u7bc0\u9ede\u5206\u7d44\u3002\u8981\u6aa2\u67e5\u60a8\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u6709\u54ea\u4e9b\u985e\u578b\u7684\u4fe1\u606f\u53ef\u7528\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ad hoc \u547d\u4ee4\u904b\u884c setup \u6a21\u584a\uff1a $ ansible all -i inventory -m setup \u7d50\u679c: { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ], \"ansible_all_ipv6_addresses\" : [ \"fe80::45:8eff:fe95:1bba\" ], \"ansible_apparmor\" : { \"status\" : \"enabled\" }, \"ansible_architecture\" : \"x86_64\" , \"ansible_bios_date\" : \"12/01/2006\" , \"ansible_bios_vendor\" : \"innotek GmbH\" , \"ansible_bios_version\" : \"VirtualBox\" , \"ansible_board_asset_tag\" : \"NA\" , \"ansible_board_name\" : \"VirtualBox\" , \"ansible_board_serial\" : \"NA\" , \"ansible_board_vendor\" : \"Oracle Corporation\" , \"ansible_board_version\" : \"1.2\" , \"ansible_chassis_asset_tag\" : \"NA\" , \"ansible_chassis_serial\" : \"NA\" , \"ansible_chassis_vendor\" : \"Oracle Corporation\" , \"ansible_chassis_version\" : \"NA\" , \"ansible_cmdline\" : { \"BOOT_IMAGE\" : \"/boot/vmlinuz-5.4.0-113-generic\" , \"console\" : \"ttyS0\" , \"ro\" : true , \"root\" : \"UUID=e42c9539-b31f-497a-98f5-47111033eed3\" }, \"ansible_date_time\" : { \"date\" : \"2022-06-08\" , \"day\" : \"08\" , \"epoch\" : \"1654679603\" , \"epoch_int\" : \"1654679603\" , \"hour\" : \"09\" , \"iso8601\" : \"2022-06-08T09:13:23Z\" , \"iso8601_basic\" : \"20220608T091323507293\" , \"iso8601_basic_short\" : \"20220608T091323\" , \"iso8601_micro\" : \"2022-06-08T09:13:23.507293Z\" , \"minute\" : \"13\" , \"month\" : \"06\" , \"second\" : \"23\" , \"time\" : \"09:13:23\" , \"tz\" : \"UTC\" , \"tz_dst\" : \"UTC\" , \"tz_offset\" : \"+0000\" , \"weekday\" : \"Wednesday\" , \"weekday_number\" : \"3\" , \"weeknumber\" : \"23\" , \"year\" : \"2022\" }, \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" }, \"ansible_default_ipv6\" : {} }, ... ... } \u6b64\u547d\u4ee4\u5c07\u8f38\u51fa\u5305\u542b\u6709\u95dc\u60a8\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u5ee3\u6cdb JSON\u3002\u8981\u7372\u53d6\u8a72\u6578\u64da\u7684\u5b50\u96c6\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 filter \u53c3\u6578\u4e26\u63d0\u4f9b\u6a21\u5f0f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u60f3\u7372\u53d6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u4e2d\u6240\u6709 IPv4 \u5730\u5740\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible all -i inventory -m setup -a \"filter=*ipv4*\" \u7d50\u679c: demo-vm | SUCCESS = > { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ] , \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" } , \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false } \u4e00\u65e6\u4f60\u627e\u5230\u4e86\u5c0d\u4f60\u7684\u81ea\u52d5\u5316\u6709\u7528\u7684 fact \uff0c\u4f60\u5c31\u53ef\u4ee5\u76f8\u61c9\u5730\u66f4\u65b0\u4f60\u7684\u5287\u672c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b playbook \u5c07\u6253\u5370\u51fa\u9ed8\u8a8d\u7db2\u7d61\u63a5\u53e3\u7684 IPv4 \u5730\u5740\u3002\u5f9e\u524d\u9762\u7684\u547d\u4ee4\u8f38\u51fa\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u901a\u904e Ansible \u63d0\u4f9b\u7684 JSON \u4e2d\u7684 ansible_default_ipv4.address \u53ef\u4ee5\u5f97\u5230\u9019\u500b\u503c\u3002 \u5728 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-03.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-03.yml --- - hosts : all tasks : - name : print facts debug : msg : \"IPv4 address: {{ ansible_default_ipv4.address }}\" \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-03.yml \u7576\u60a8\u904b\u884c playbook \u6642\uff0c\u60a8\u5c07\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u60a8\u7684\u9060\u7a0b\u670d\u52d9\u5668\u7684 IPv4 \u5730\u5740\uff0c\u5982\u9810\u671f\u7684\u90a3\u6a23\uff1a PLAY [all] ******************************************************************************************************************* TASK [Gathering Facts] ******************************************************************************************************* ok: [demo-vm] TASK [print facts] *********************************************************************************************************** ok: [demo-vm] => { \"msg\": \"IPv4 address: 10.0.2.15\" } PLAY RECAP ******************************************************************************************************************* demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 Facts \u5c01\u88dd\u4e86\u91cd\u8981\u7684\u5143\u6578\u64da\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u9019\u4e9b\u5143\u6578\u64da\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u60a8\u7684\u5287\u672c\u3002\u8981\u8a73\u7d30\u4e86\u89e3\u60a8\u53ef\u4ee5\u901a\u904e\u4e8b\u5be6 facts \u7372\u5f97\u7684\u6240\u6709\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u8a2a\u554f\u7cfb\u7d71\u4fe1\u606f"},{"location":"ansible/tutorial_playbook/how-to-access-system-information-facts-in-ansible-playbooks/#ansible-playbooks-facts","text":"\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5728\u57f7\u884c playbook \u4e2d\u5b9a\u7fa9\u7684\u4efb\u52d9\u96c6\u4e4b\u524d\uff0cAnsible \u5c07\u82b1\u4e00\u4e9b\u6642\u9593\u4f86\u6536\u96c6\u6709\u95dc\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u7684\u4fe1\u606f\u3002\u9019\u4e9b\u4fe1\u606f\uff08\u7a31\u70baFacts\uff09\u5305\u542b\u8af8\u5982\u7db2\u7d61\u63a5\u53e3\u548c\u5730\u5740\u3001\u9060\u7a0b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u64cd\u4f5c\u7cfb\u7d71\u548c\u53ef\u7528\u5167\u5b58\u7b49\u8a73\u7d30\u4fe1\u606f\u3002 Ansible \u4ee5 JSON \u683c\u5f0f\u5b58\u5132 \u4e8b\u5be6 \uff0c\u9805\u76ee\u6309\u7bc0\u9ede\u5206\u7d44\u3002\u8981\u6aa2\u67e5\u60a8\u6b63\u5728\u914d\u7f6e\u7684\u7cfb\u7d71\u6709\u54ea\u4e9b\u985e\u578b\u7684\u4fe1\u606f\u53ef\u7528\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ad hoc \u547d\u4ee4\u904b\u884c setup \u6a21\u584a\uff1a $ ansible all -i inventory -m setup \u7d50\u679c: { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ], \"ansible_all_ipv6_addresses\" : [ \"fe80::45:8eff:fe95:1bba\" ], \"ansible_apparmor\" : { \"status\" : \"enabled\" }, \"ansible_architecture\" : \"x86_64\" , \"ansible_bios_date\" : \"12/01/2006\" , \"ansible_bios_vendor\" : \"innotek GmbH\" , \"ansible_bios_version\" : \"VirtualBox\" , \"ansible_board_asset_tag\" : \"NA\" , \"ansible_board_name\" : \"VirtualBox\" , \"ansible_board_serial\" : \"NA\" , \"ansible_board_vendor\" : \"Oracle Corporation\" , \"ansible_board_version\" : \"1.2\" , \"ansible_chassis_asset_tag\" : \"NA\" , \"ansible_chassis_serial\" : \"NA\" , \"ansible_chassis_vendor\" : \"Oracle Corporation\" , \"ansible_chassis_version\" : \"NA\" , \"ansible_cmdline\" : { \"BOOT_IMAGE\" : \"/boot/vmlinuz-5.4.0-113-generic\" , \"console\" : \"ttyS0\" , \"ro\" : true , \"root\" : \"UUID=e42c9539-b31f-497a-98f5-47111033eed3\" }, \"ansible_date_time\" : { \"date\" : \"2022-06-08\" , \"day\" : \"08\" , \"epoch\" : \"1654679603\" , \"epoch_int\" : \"1654679603\" , \"hour\" : \"09\" , \"iso8601\" : \"2022-06-08T09:13:23Z\" , \"iso8601_basic\" : \"20220608T091323507293\" , \"iso8601_basic_short\" : \"20220608T091323\" , \"iso8601_micro\" : \"2022-06-08T09:13:23.507293Z\" , \"minute\" : \"13\" , \"month\" : \"06\" , \"second\" : \"23\" , \"time\" : \"09:13:23\" , \"tz\" : \"UTC\" , \"tz_dst\" : \"UTC\" , \"tz_offset\" : \"+0000\" , \"weekday\" : \"Wednesday\" , \"weekday_number\" : \"3\" , \"weeknumber\" : \"23\" , \"year\" : \"2022\" }, \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" }, \"ansible_default_ipv6\" : {} }, ... ... } \u6b64\u547d\u4ee4\u5c07\u8f38\u51fa\u5305\u542b\u6709\u95dc\u60a8\u7684\u670d\u52d9\u5668\u4fe1\u606f\u7684\u5ee3\u6cdb JSON\u3002\u8981\u7372\u53d6\u8a72\u6578\u64da\u7684\u5b50\u96c6\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 filter \u53c3\u6578\u4e26\u63d0\u4f9b\u6a21\u5f0f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u60f3\u7372\u53d6\u6709\u95dc\u9060\u7a0b\u7bc0\u9ede\u4e2d\u6240\u6709 IPv4 \u5730\u5740\u7684\u4fe1\u606f\uff0c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a $ ansible all -i inventory -m setup -a \"filter=*ipv4*\" \u7d50\u679c: demo-vm | SUCCESS = > { \"ansible_facts\" : { \"ansible_all_ipv4_addresses\" : [ \"10.0.2.15\" ] , \"ansible_default_ipv4\" : { \"address\" : \"10.0.2.15\" , \"alias\" : \"enp0s3\" , \"broadcast\" : \"10.0.2.255\" , \"gateway\" : \"10.0.2.2\" , \"interface\" : \"enp0s3\" , \"macaddress\" : \"02:45:8e:95:1b:ba\" , \"mtu\" : 1500 , \"netmask\" : \"255.255.255.0\" , \"network\" : \"10.0.2.0\" , \"type\" : \"ether\" } , \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false } \u4e00\u65e6\u4f60\u627e\u5230\u4e86\u5c0d\u4f60\u7684\u81ea\u52d5\u5316\u6709\u7528\u7684 fact \uff0c\u4f60\u5c31\u53ef\u4ee5\u76f8\u61c9\u5730\u66f4\u65b0\u4f60\u7684\u5287\u672c\u3002\u4f8b\u5982\uff0c\u4ee5\u4e0b playbook \u5c07\u6253\u5370\u51fa\u9ed8\u8a8d\u7db2\u7d61\u63a5\u53e3\u7684 IPv4 \u5730\u5740\u3002\u5f9e\u524d\u9762\u7684\u547d\u4ee4\u8f38\u51fa\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u901a\u904e Ansible \u63d0\u4f9b\u7684 JSON \u4e2d\u7684 ansible_default_ipv4.address \u53ef\u4ee5\u5f97\u5230\u9019\u500b\u503c\u3002 \u5728 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-03.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-03.yml --- - hosts : all tasks : - name : print facts debug : msg : \"IPv4 address: {{ ansible_default_ipv4.address }}\" \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-03.yml \u7576\u60a8\u904b\u884c playbook \u6642\uff0c\u60a8\u5c07\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u60a8\u7684\u9060\u7a0b\u670d\u52d9\u5668\u7684 IPv4 \u5730\u5740\uff0c\u5982\u9810\u671f\u7684\u90a3\u6a23\uff1a PLAY [all] ******************************************************************************************************************* TASK [Gathering Facts] ******************************************************************************************************* ok: [demo-vm] TASK [print facts] *********************************************************************************************************** ok: [demo-vm] => { \"msg\": \"IPv4 address: 10.0.2.15\" } PLAY RECAP ******************************************************************************************************************* demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 Facts \u5c01\u88dd\u4e86\u91cd\u8981\u7684\u5143\u6578\u64da\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u9019\u4e9b\u5143\u6578\u64da\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u60a8\u7684\u5287\u672c\u3002\u8981\u8a73\u7d30\u4e86\u89e3\u60a8\u53ef\u4ee5\u901a\u904e\u4e8b\u5be6 facts \u7372\u5f97\u7684\u6240\u6709\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Ansible \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u8a2a\u554f\u7cfb\u7d71\u4fe1\u606f\uff08Facts\uff09"},{"location":"ansible/tutorial_playbook/how-to-create-and-use-templates-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f \u00b6 \u6a21\u677f\u5141\u8a31\u60a8\u4f7f\u7528\u57fa\u65bc Jinja2 \u6a21\u677f\u7cfb\u7d71 \u7684\u9810\u5b9a\u7fa9\u6a21\u578b\u5728\u7bc0\u9ede\u4e0a\u5275\u5efa\u65b0\u6587\u4ef6\u3002 Ansible \u6a21\u677f\u901a\u5e38\u4fdd\u5b58\u70ba .tpl \u6587\u4ef6\uff0c\u4e26\u652f\u6301\u4f7f\u7528\u8b8a\u91cf\u3001\u5faa\u74b0\u548c\u689d\u4ef6\u8868\u9054\u5f0f\u3002 \u6a21\u677f\u901a\u5e38\u7528\u65bc\u57fa\u65bc\u8b8a\u91cf\u503c\u914d\u7f6e\u670d\u52d9\uff0c\u9019\u4e9b\u8b8a\u91cf\u503c\u53ef\u4ee5\u5728\u5287\u672c\u672c\u8eab\u3001\u5305\u542b\u7684\u8b8a\u91cf\u6587\u4ef6\u4e2d\u6216\u901a\u904e facts \u7372\u5f97\u3002\u9019\u4f7f\u60a8\u80fd\u5920\u5275\u5efa\u66f4\u901a\u7528\u7684\u8a2d\u7f6e\uff0c\u4ee5\u6839\u64da\u52d5\u614b\u4fe1\u606f\u8abf\u6574\u884c\u70ba\u3002 \u8981\u901a\u904e\u5be6\u969b\u793a\u4f8b\u5617\u8a66\u6b64\u529f\u80fd\uff0c\u8acb\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u4ee5\u5728\u60a8\u7684 ansible-practice \u76ee\u9304\u4e2d\u4fdd\u5b58\u975e\u5287\u672c\u6587\u4ef6\uff1a $ mkdir ~/ansible-practice/files \u63a5\u4e0b\u4f86\uff0c\u70ba HTML \u767b\u9304\u9801\u9762\u5275\u5efa\u4e00\u500b\u65b0\u6a21\u677f\u6587\u4ef6\u3002\u7a0d\u5f8c\uff0c\u6211\u5011\u5c07\u8a2d\u7f6e\u4e00\u500b\u5287\u672c\uff0c\u5b83\u5c07\u914d\u7f6e\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4ee5\u4f7f\u7528 Nginx \u63d0\u4f9b\u767b\u9304\u9801\u9762\uff1a $ nano ~/ansible-practice/files/landing-page.html.j2 \u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a landing-page.html.j2 <!doctype html> < html lang = \"en\" > < head > < meta charset = \"utf-8\" > < title > {{ page_title }} </ title > < meta name = \"description\" content = \"Created with Ansible\" > </ head > < body > < h1 > {{ page_title }} </ h1 > < p > {{ page_description }} </ p > </ body > </ html > \u9019\u500b\u6a21\u677f\u4f7f\u7528\u4e86\u5169\u500b\u8b8a\u91cf\uff0c\u7576\u6a21\u677f\u61c9\u7528\u5230 playbook \u4e2d\u6642\u5fc5\u9808\u63d0\u4f9b\uff1a page_title \u548c page_description \u3002 \u4ee5\u4e0b playbook \u8a2d\u7f6e\u6240\u9700\u7684\u8b8a\u91cf\uff0c\u5b89\u88dd Nginx\uff0c\u7136\u5f8c\u61c9\u7528\u6307\u5b9a\u7684\u6a21\u677f\u4f86\u66ff\u63db\u4f4d\u65bc /var/www/html/index.nginx-debian.html \u7684\u73fe\u6709\u9ed8\u8a8d Nginx \u767b\u9304\u9801\u9762\u3002\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 ufw \u6a21\u584a\u555f\u7528\u9632\u706b\u7246\u5728\u7aef\u53e3 80 \u4e0a\u958b\u653e tcp \u8a2a\u554f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-11.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-11.yml --- - hosts : all become : yes vars : page_title : My Landing Page page_description : This is my landing page description. tasks : - name : Install Nginx apt : name : nginx state : latest - name : Apply Page Template template : src : files/landing-page.html.j2 dest : /var/www/html/index.nginx-debian.html - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp \u7531\u65bc Nginx \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 80 \u3002\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07VM\u4e0a\u7684 port 80 \u6620\u5c04\u5230\u672c\u6a5f\u4e0a\u7684 port 9080 \u3002 \u4fee\u6539 Vagrantfile: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"forwarded_port\" , guest : 80 , host : 9080 end \u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668: $ vagrant reload == > default: Attempting graceful shutdown of VM... == > default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > default: Clearing any previously set forwarded ports... == > default: Clearing any previously set network interfaces... == > default: Preparing network interfaces based on configuration... default: Adapter 1 : nat == > default: Forwarding ports... default: 80 ( guest ) = > 9080 ( host ) ( adapter 1 ) default: 22 ( guest ) = > 2222 ( host ) ( adapter 1 ) == > default: Running 'pre-boot' VM customizations... == > default: Booting VM... == > default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127 .0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key == > default: Machine booted and ready! == > default: Checking for guest additions in VM... == > default: Mounting shared folders... default: /vagrant = > /home/dxlab/opt/ws_ansible/ansible-cheatsheet == > default: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > default: flag to force provisioning. Provisioners marked to run always will still run. \u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-11.yml -u vagrant -K \u64ad\u653e\u7d50\u675f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5f9e\u700f\u89bd\u5668\u8a2a\u554f Web \u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\u3002\u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u9801\u9762\uff1a \u9019\u610f\u5473\u8457\u60a8\u7684\u5287\u672c\u6309\u9810\u671f\u5de5\u4f5c\uff0c\u4e26\u4e14\u9ed8\u8a8d\u7684 Nginx \u9801\u9762\u5df2\u88ab\u60a8\u5275\u5efa\u7684\u6a21\u677f\u66ff\u63db\u3002","title":"\u5982\u4f55\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f"},{"location":"ansible/tutorial_playbook/how-to-create-and-use-templates-in-ansible-playbooks/#ansible-playbook","text":"\u6a21\u677f\u5141\u8a31\u60a8\u4f7f\u7528\u57fa\u65bc Jinja2 \u6a21\u677f\u7cfb\u7d71 \u7684\u9810\u5b9a\u7fa9\u6a21\u578b\u5728\u7bc0\u9ede\u4e0a\u5275\u5efa\u65b0\u6587\u4ef6\u3002 Ansible \u6a21\u677f\u901a\u5e38\u4fdd\u5b58\u70ba .tpl \u6587\u4ef6\uff0c\u4e26\u652f\u6301\u4f7f\u7528\u8b8a\u91cf\u3001\u5faa\u74b0\u548c\u689d\u4ef6\u8868\u9054\u5f0f\u3002 \u6a21\u677f\u901a\u5e38\u7528\u65bc\u57fa\u65bc\u8b8a\u91cf\u503c\u914d\u7f6e\u670d\u52d9\uff0c\u9019\u4e9b\u8b8a\u91cf\u503c\u53ef\u4ee5\u5728\u5287\u672c\u672c\u8eab\u3001\u5305\u542b\u7684\u8b8a\u91cf\u6587\u4ef6\u4e2d\u6216\u901a\u904e facts \u7372\u5f97\u3002\u9019\u4f7f\u60a8\u80fd\u5920\u5275\u5efa\u66f4\u901a\u7528\u7684\u8a2d\u7f6e\uff0c\u4ee5\u6839\u64da\u52d5\u614b\u4fe1\u606f\u8abf\u6574\u884c\u70ba\u3002 \u8981\u901a\u904e\u5be6\u969b\u793a\u4f8b\u5617\u8a66\u6b64\u529f\u80fd\uff0c\u8acb\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u4ee5\u5728\u60a8\u7684 ansible-practice \u76ee\u9304\u4e2d\u4fdd\u5b58\u975e\u5287\u672c\u6587\u4ef6\uff1a $ mkdir ~/ansible-practice/files \u63a5\u4e0b\u4f86\uff0c\u70ba HTML \u767b\u9304\u9801\u9762\u5275\u5efa\u4e00\u500b\u65b0\u6a21\u677f\u6587\u4ef6\u3002\u7a0d\u5f8c\uff0c\u6211\u5011\u5c07\u8a2d\u7f6e\u4e00\u500b\u5287\u672c\uff0c\u5b83\u5c07\u914d\u7f6e\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4ee5\u4f7f\u7528 Nginx \u63d0\u4f9b\u767b\u9304\u9801\u9762\uff1a $ nano ~/ansible-practice/files/landing-page.html.j2 \u5c07\u4ee5\u4e0b\u5167\u5bb9\u6dfb\u52a0\u5230\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a landing-page.html.j2 <!doctype html> < html lang = \"en\" > < head > < meta charset = \"utf-8\" > < title > {{ page_title }} </ title > < meta name = \"description\" content = \"Created with Ansible\" > </ head > < body > < h1 > {{ page_title }} </ h1 > < p > {{ page_description }} </ p > </ body > </ html > \u9019\u500b\u6a21\u677f\u4f7f\u7528\u4e86\u5169\u500b\u8b8a\u91cf\uff0c\u7576\u6a21\u677f\u61c9\u7528\u5230 playbook \u4e2d\u6642\u5fc5\u9808\u63d0\u4f9b\uff1a page_title \u548c page_description \u3002 \u4ee5\u4e0b playbook \u8a2d\u7f6e\u6240\u9700\u7684\u8b8a\u91cf\uff0c\u5b89\u88dd Nginx\uff0c\u7136\u5f8c\u61c9\u7528\u6307\u5b9a\u7684\u6a21\u677f\u4f86\u66ff\u63db\u4f4d\u65bc /var/www/html/index.nginx-debian.html \u7684\u73fe\u6709\u9ed8\u8a8d Nginx \u767b\u9304\u9801\u9762\u3002\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 ufw \u6a21\u584a\u555f\u7528\u9632\u706b\u7246\u5728\u7aef\u53e3 80 \u4e0a\u958b\u653e tcp \u8a2a\u554f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-11.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-11.yml --- - hosts : all become : yes vars : page_title : My Landing Page page_description : This is my landing page description. tasks : - name : Install Nginx apt : name : nginx state : latest - name : Apply Page Template template : src : files/landing-page.html.j2 dest : /var/www/html/index.nginx-debian.html - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp \u7531\u65bc Nginx \u9810\u8a2d\u662f\u904b\u884c\u5728\u4e3b\u6a5f\u7684 port 80 \u3002\u6211\u5011\u5c07\u5229\u7528 forwarded_port \u9019\u500b\u53c3\u6578\u4f86\u5c07VM\u4e0a\u7684 port 80 \u6620\u5c04\u5230\u672c\u6a5f\u4e0a\u7684 port 9080 \u3002 \u4fee\u6539 Vagrantfile: Vagrantfile Vagrant . configure ( \"2\" ) do | config | config . vm . box = \"ubuntu/focal64\" config . vm . network \"forwarded_port\" , guest : 80 , host : 9080 end \u91cd\u65b0\u555f\u52d5\u4f60\u7684\u6a5f\u5668: $ vagrant reload == > default: Attempting graceful shutdown of VM... == > default: Checking if box 'ubuntu/focal64' version '20220530.0.0' is up to date... == > default: Clearing any previously set forwarded ports... == > default: Clearing any previously set network interfaces... == > default: Preparing network interfaces based on configuration... default: Adapter 1 : nat == > default: Forwarding ports... default: 80 ( guest ) = > 9080 ( host ) ( adapter 1 ) default: 22 ( guest ) = > 2222 ( host ) ( adapter 1 ) == > default: Running 'pre-boot' VM customizations... == > default: Booting VM... == > default: Waiting for machine to boot. This may take a few minutes... default: SSH address: 127 .0.0.1:2222 default: SSH username: vagrant default: SSH auth method: private key == > default: Machine booted and ready! == > default: Checking for guest additions in VM... == > default: Mounting shared folders... default: /vagrant = > /home/dxlab/opt/ws_ansible/ansible-cheatsheet == > default: Machine already provisioned. Run ` vagrant provision ` or use the ` --provision ` == > default: flag to force provisioning. Provisioners marked to run always will still run. \u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-11.yml -u vagrant -K \u64ad\u653e\u7d50\u675f\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5f9e\u700f\u89bd\u5668\u8a2a\u554f Web \u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\u3002\u4f60\u6703\u770b\u5230\u9019\u6a23\u7684\u9801\u9762\uff1a \u9019\u610f\u5473\u8457\u60a8\u7684\u5287\u672c\u6309\u9810\u671f\u5de5\u4f5c\uff0c\u4e26\u4e14\u9ed8\u8a8d\u7684 Nginx \u9801\u9762\u5df2\u88ab\u60a8\u5275\u5efa\u7684\u6a21\u677f\u66ff\u63db\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f"},{"location":"ansible/tutorial_playbook/how-to-define-and-use-handlers-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u548c\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f \u00b6 \u7c21\u800c\u8a00\u4e4b\uff0c\u8655\u7406\u7a0b\u5e8f handler \u662f\u7279\u6b8a\u4efb\u52d9\uff0c\u53ea\u6709\u5728\u901a\u904e notify \u6307\u4ee4\u89f8\u767c\u6642\u624d\u6703\u57f7\u884c\u3002\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u6642\u57f7\u884c\uff0c\u4e00\u65e6\u6240\u6709\u4efb\u52d9\u5b8c\u6210\u3002 \u5728 Ansible \u4e2d\uff0c\u8655\u7406\u7a0b\u5e8f\u901a\u5e38\u7528\u65bc \u555f\u52d5 \u3001 \u91cd\u65b0\u52a0\u8f09 \u3001 \u91cd\u65b0\u555f\u52d5 \u548c \u505c\u6b62\u670d\u52d9 \u3002\u5982\u679c\u60a8\u7684\u5287\u672c\u6d89\u53ca\u66f4\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5247\u5f88\u6709\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u4ee5\u4f7f\u66f4\u6539\u751f\u6548\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u70ba\u8a72\u670d\u52d9\u5b9a\u7fa9\u4e00\u500b\u8655\u7406\u7a0b\u5e8f\uff0c\u4e26\u5c07 notify \u6307\u4ee4\u5305\u542b\u5728\u4efb\u4f55\u9700\u8981\u8a72\u670d\u52d9\u8655\u7406\u7a0b\u5e8f\u7684\u4efb\u52d9\u4e2d\u3002 \u5728\u672c\u7cfb\u5217\u7684 \u5982\u4f55\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f \u4e2d\uff0c\u60a8\u5df2\u7d93\u4e86\u89e3\u77ad\u5982\u4f55\u4f7f\u7528\u6a21\u677f\u5c07\u9ed8\u8a8d Nginx \u9801\u9762\u66ff\u63db\u70ba\u81ea\u5b9a\u7fa9 HTML \u767b\u9304\u9801\u9762\u3002\u5be6\u969b\u4e0a\uff0c\u5728\u8a2d\u7f6e Nginx Web \u670d\u52d9\u5668\u6642\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u5728\u7ad9\u9ede\u53ef\u7528\u76ee\u9304\u4e2d\u5305\u542b\u65b0\u7684\u670d\u52d9\u5668\u584a\u6587\u4ef6\u3001\u5275\u5efa\u7b26\u865f\u93c8\u63a5\u6216\u66f4\u6539\u9700\u8981\u91cd\u65b0\u52a0\u8f09\u6216\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u5668\u7684\u8a2d\u7f6e\u3002 \u8003\u616e\u5230\u9019\u7a2e\u60c5\u6cc1\uff0c\u91cd\u555f Nginx \u670d\u52d9\u7684\u8655\u7406\u7a0b\u5e8f\u5982\u4e0b\u6240\u793a\uff1a ... handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u89f8\u767c\u6b64\u8655\u7406\u7a0b\u5e8f\uff0c\u60a8\u9700\u8981\u5728\u4efb\u4f55\u9700\u8981\u5728 Nginx \u670d\u52d9\u5668\u4e0a\u91cd\u65b0\u555f\u52d5\u7684\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b notify \u6307\u4ee4\u3002 \u4ee5\u4e0b playbook \u4f7f\u7528\u5167\u7f6e\u7684 Ansible \u7684 replace \u6a21\u584a\u4f86\u66ff\u63db Nginx \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u9ed8\u8a8d\u6587\u6a94\u6839\u76ee\u9304 ( document root )\u3002\u8a72\u6a21\u584a\u6839\u64da regexp \u5b9a\u7fa9\u7684\u6b63\u5247\u8868\u9054\u5f0f\u5728\u6587\u4ef6\u4e2d\u67e5\u627e\u6a21\u5f0f\uff0c\u7136\u5f8c\u5c07\u627e\u5230\u7684\u4efb\u4f55\u5339\u914d\u9805\u66ff\u63db\u70ba replace \u5b9a\u7fa9\u7684\u5167\u5bb9\u3002\u7136\u5f8c\uff0c\u8a72\u4efb\u52d9\u5411 Restart Nginx \u8655\u7406\u7a0b\u5e8f\u767c\u9001\u901a\u77e5\u4ee5\u76e1\u5feb\u91cd\u65b0\u555f\u52d5\u3002\u9019\u610f\u5473\u8457\uff0c\u89f8\u767c\u91cd\u555f\u7684\u6b21\u6578\u7121\u95dc\u7dca\u8981\uff0c\u5b83\u53ea\u6703\u5728\u6240\u6709\u4efb\u52d9\u5df2\u7d93\u5b8c\u6210\u57f7\u884c\u4e26\u4e14\u8655\u7406\u7a0b\u5e8f\u958b\u59cb\u904b\u884c\u6642\u624d\u6703\u767c\u751f\u3002\u6b64\u5916\uff0c\u7576\u6c92\u6709\u627e\u5230\u5339\u914d\u9805\u6642\uff0c\u4e0d\u6703\u5c0d\u7cfb\u7d71\u9032\u884c\u4efb\u4f55\u66f4\u6539\uff0c\u56e0\u6b64\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-12.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-12.yml --- - hosts : all become : yes vars : page_title : My Second Landing Page page_description : This is my second landing page description. doc_root : /var/www/mypage tasks : - name : Install Nginx apt : name : nginx state : latest - name : Make sure new doc root exists file : path : \"{{ doc_root }}\" state : directory mode : '0755' - name : Apply Page Template template : src : files/landing-page.html.j2 dest : \"{{ doc_root }}/index.html\" - name : Replace document root on default Nginx configuration replace : path : /etc/nginx/sites-available/default regexp : '(\\s+)root /var/www/html;(\\s+.*)?$' replace : \\g<1>root {{ doc_root }};\\g<2> notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u4f7f\u7528\u8655\u7406\u7a0b\u5e8f handler \u6642\u8981\u8a18\u4f4f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u5b83\u5011\u50c5\u5728\u5b9a\u7fa9 notify \u89f8\u767c\u5668\u7684\u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u66f4\u6539\u6642\u624d\u88ab\u89f8\u767c\u3002\u8003\u616e\u5230\u9019\u500b playbook\uff0c\u5b83\u7b2c\u4e00\u6b21\u904b\u884c replace \u4efb\u52d9\u6642\u6703\u66f4\u6539 Nginx \u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u6b64\u5c07\u904b\u884c\u91cd\u555f\u3002\u7136\u800c\uff0c\u5728\u96a8\u5f8c\u7684\u57f7\u884c\u4e2d\uff0c\u7531\u65bc\u8981\u66ff\u63db\u7684\u5b57\u7b26\u4e32\u4e0d\u518d\u5b58\u5728\u65bc\u6587\u4ef6\u4e2d\uff0c\u56e0\u6b64\u8a72\u4efb\u52d9\u4e0d\u6703\u5c0e\u81f4\u4efb\u4f55\u66f4\u6539\uff0c\u4e5f\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u57f7\u884c\u3002 \u5982\u679c\u60a8\u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-12.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Install Nginx] ******************************************************************************************************************************************************* ok: [demo-vm] TASK [Make sure new doc root exists] *************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Page Template] ************************************************************************************************************************************************* changed: [demo-vm] TASK [Replace document root on default Nginx configuration] **************************************************************************************************************** changed: [demo-vm] TASK [Allow all access to tcp port 80] ************************************************************************************************************************************* ok: [demo-vm] RUNNING HANDLER [Restart Nginx] ******************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=7 changed=4 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u60a8\u67e5\u770b\u8f38\u51fa\uff0c\u60a8\u6703\u770b\u5230\u201cRestart Nginx\u201d\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u4e4b\u524d\u6b63\u5728\u57f7\u884c\u3002\u5982\u679c\u60a8\u73fe\u5728\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684 IP \u5730\u5740\uff0c\u60a8\u5c07\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a \u5728\u672c\u7cfb\u5217\u7684\u4e0b\u4e00\u90e8\u5206\u548c\u6700\u5f8c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u9023\u63a5\u6240\u6709\u7684\u9ede\uff0c\u4e26\u7de8\u5beb\u4e00\u500b\u81ea\u52d5\u8a2d\u7f6e\u9060\u7a0b Nginx \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u7684\u5287\u672c\u3002","title":"\u5982\u4f55\u5b9a\u7fa9\u548c\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f"},{"location":"ansible/tutorial_playbook/how-to-define-and-use-handlers-in-ansible-playbooks/#ansible-playbook","text":"\u7c21\u800c\u8a00\u4e4b\uff0c\u8655\u7406\u7a0b\u5e8f handler \u662f\u7279\u6b8a\u4efb\u52d9\uff0c\u53ea\u6709\u5728\u901a\u904e notify \u6307\u4ee4\u89f8\u767c\u6642\u624d\u6703\u57f7\u884c\u3002\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u6642\u57f7\u884c\uff0c\u4e00\u65e6\u6240\u6709\u4efb\u52d9\u5b8c\u6210\u3002 \u5728 Ansible \u4e2d\uff0c\u8655\u7406\u7a0b\u5e8f\u901a\u5e38\u7528\u65bc \u555f\u52d5 \u3001 \u91cd\u65b0\u52a0\u8f09 \u3001 \u91cd\u65b0\u555f\u52d5 \u548c \u505c\u6b62\u670d\u52d9 \u3002\u5982\u679c\u60a8\u7684\u5287\u672c\u6d89\u53ca\u66f4\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u5247\u5f88\u6709\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u4ee5\u4f7f\u66f4\u6539\u751f\u6548\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u9700\u8981\u70ba\u8a72\u670d\u52d9\u5b9a\u7fa9\u4e00\u500b\u8655\u7406\u7a0b\u5e8f\uff0c\u4e26\u5c07 notify \u6307\u4ee4\u5305\u542b\u5728\u4efb\u4f55\u9700\u8981\u8a72\u670d\u52d9\u8655\u7406\u7a0b\u5e8f\u7684\u4efb\u52d9\u4e2d\u3002 \u5728\u672c\u7cfb\u5217\u7684 \u5982\u4f55\u5275\u5efa\u548c\u4f7f\u7528\u6a21\u677f \u4e2d\uff0c\u60a8\u5df2\u7d93\u4e86\u89e3\u77ad\u5982\u4f55\u4f7f\u7528\u6a21\u677f\u5c07\u9ed8\u8a8d Nginx \u9801\u9762\u66ff\u63db\u70ba\u81ea\u5b9a\u7fa9 HTML \u767b\u9304\u9801\u9762\u3002\u5be6\u969b\u4e0a\uff0c\u5728\u8a2d\u7f6e Nginx Web \u670d\u52d9\u5668\u6642\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u5728\u7ad9\u9ede\u53ef\u7528\u76ee\u9304\u4e2d\u5305\u542b\u65b0\u7684\u670d\u52d9\u5668\u584a\u6587\u4ef6\u3001\u5275\u5efa\u7b26\u865f\u93c8\u63a5\u6216\u66f4\u6539\u9700\u8981\u91cd\u65b0\u52a0\u8f09\u6216\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u5668\u7684\u8a2d\u7f6e\u3002 \u8003\u616e\u5230\u9019\u7a2e\u60c5\u6cc1\uff0c\u91cd\u555f Nginx \u670d\u52d9\u7684\u8655\u7406\u7a0b\u5e8f\u5982\u4e0b\u6240\u793a\uff1a ... handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u89f8\u767c\u6b64\u8655\u7406\u7a0b\u5e8f\uff0c\u60a8\u9700\u8981\u5728\u4efb\u4f55\u9700\u8981\u5728 Nginx \u670d\u52d9\u5668\u4e0a\u91cd\u65b0\u555f\u52d5\u7684\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b notify \u6307\u4ee4\u3002 \u4ee5\u4e0b playbook \u4f7f\u7528\u5167\u7f6e\u7684 Ansible \u7684 replace \u6a21\u584a\u4f86\u66ff\u63db Nginx \u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u9ed8\u8a8d\u6587\u6a94\u6839\u76ee\u9304 ( document root )\u3002\u8a72\u6a21\u584a\u6839\u64da regexp \u5b9a\u7fa9\u7684\u6b63\u5247\u8868\u9054\u5f0f\u5728\u6587\u4ef6\u4e2d\u67e5\u627e\u6a21\u5f0f\uff0c\u7136\u5f8c\u5c07\u627e\u5230\u7684\u4efb\u4f55\u5339\u914d\u9805\u66ff\u63db\u70ba replace \u5b9a\u7fa9\u7684\u5167\u5bb9\u3002\u7136\u5f8c\uff0c\u8a72\u4efb\u52d9\u5411 Restart Nginx \u8655\u7406\u7a0b\u5e8f\u767c\u9001\u901a\u77e5\u4ee5\u76e1\u5feb\u91cd\u65b0\u555f\u52d5\u3002\u9019\u610f\u5473\u8457\uff0c\u89f8\u767c\u91cd\u555f\u7684\u6b21\u6578\u7121\u95dc\u7dca\u8981\uff0c\u5b83\u53ea\u6703\u5728\u6240\u6709\u4efb\u52d9\u5df2\u7d93\u5b8c\u6210\u57f7\u884c\u4e26\u4e14\u8655\u7406\u7a0b\u5e8f\u958b\u59cb\u904b\u884c\u6642\u624d\u6703\u767c\u751f\u3002\u6b64\u5916\uff0c\u7576\u6c92\u6709\u627e\u5230\u5339\u914d\u9805\u6642\uff0c\u4e0d\u6703\u5c0d\u7cfb\u7d71\u9032\u884c\u4efb\u4f55\u66f4\u6539\uff0c\u56e0\u6b64\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-12.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-12.yml --- - hosts : all become : yes vars : page_title : My Second Landing Page page_description : This is my second landing page description. doc_root : /var/www/mypage tasks : - name : Install Nginx apt : name : nginx state : latest - name : Make sure new doc root exists file : path : \"{{ doc_root }}\" state : directory mode : '0755' - name : Apply Page Template template : src : files/landing-page.html.j2 dest : \"{{ doc_root }}/index.html\" - name : Replace document root on default Nginx configuration replace : path : /etc/nginx/sites-available/default regexp : '(\\s+)root /var/www/html;(\\s+.*)?$' replace : \\g<1>root {{ doc_root }};\\g<2> notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u4f7f\u7528\u8655\u7406\u7a0b\u5e8f handler \u6642\u8981\u8a18\u4f4f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u5b83\u5011\u50c5\u5728\u5b9a\u7fa9 notify \u89f8\u767c\u5668\u7684\u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u66f4\u6539\u6642\u624d\u88ab\u89f8\u767c\u3002\u8003\u616e\u5230\u9019\u500b playbook\uff0c\u5b83\u7b2c\u4e00\u6b21\u904b\u884c replace \u4efb\u52d9\u6642\u6703\u66f4\u6539 Nginx \u914d\u7f6e\u6587\u4ef6\uff0c\u56e0\u6b64\u5c07\u904b\u884c\u91cd\u555f\u3002\u7136\u800c\uff0c\u5728\u96a8\u5f8c\u7684\u57f7\u884c\u4e2d\uff0c\u7531\u65bc\u8981\u66ff\u63db\u7684\u5b57\u7b26\u4e32\u4e0d\u518d\u5b58\u5728\u65bc\u6587\u4ef6\u4e2d\uff0c\u56e0\u6b64\u8a72\u4efb\u52d9\u4e0d\u6703\u5c0e\u81f4\u4efb\u4f55\u66f4\u6539\uff0c\u4e5f\u4e0d\u6703\u89f8\u767c\u8655\u7406\u7a0b\u5e8f\u57f7\u884c\u3002 \u5982\u679c\u60a8\u904b\u884c\u6b64 playbook\uff0c\u8acb\u8a18\u4f4f\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-12.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Install Nginx] ******************************************************************************************************************************************************* ok: [demo-vm] TASK [Make sure new doc root exists] *************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Page Template] ************************************************************************************************************************************************* changed: [demo-vm] TASK [Replace document root on default Nginx configuration] **************************************************************************************************************** changed: [demo-vm] TASK [Allow all access to tcp port 80] ************************************************************************************************************************************* ok: [demo-vm] RUNNING HANDLER [Restart Nginx] ******************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=7 changed=4 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u60a8\u67e5\u770b\u8f38\u51fa\uff0c\u60a8\u6703\u770b\u5230\u201cRestart Nginx\u201d\u8655\u7406\u7a0b\u5e8f\u5728\u64ad\u653e\u7d50\u675f\u4e4b\u524d\u6b63\u5728\u57f7\u884c\u3002\u5982\u679c\u60a8\u73fe\u5728\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684 IP \u5730\u5740\uff0c\u60a8\u5c07\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a \u5728\u672c\u7cfb\u5217\u7684\u4e0b\u4e00\u90e8\u5206\u548c\u6700\u5f8c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u9023\u63a5\u6240\u6709\u7684\u9ede\uff0c\u4e26\u7de8\u5beb\u4e00\u500b\u81ea\u52d5\u8a2d\u7f6e\u9060\u7a0b Nginx \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u7684\u5287\u672c\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u548c\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f"},{"location":"ansible/tutorial_playbook/how-to-define-tasks-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u4efb\u52d9 \u00b6 \u4efb\u52d9 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u5287\u672c Playbook \u901a\u5e38\u5305\u542b\u4e00\u7cfb\u5217\u670d\u52d9\u65bc\u67d0\u500b\u76ee\u6a19\u7684\u4efb\u52d9\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u9060\u7a0b\u74b0\u5883\u3002 Ansible \u6309\u7167\u5b83\u5011\u5728\u5287\u672c\u4e2d\u5b9a\u7fa9\u7684\u9806\u5e8f\u57f7\u884c\u4efb\u52d9\u3002\u5728\u81ea\u52d5\u5316\u8af8\u5982\u8a2d\u7f6e LEMP \u670d\u52d9\u5668\u4e4b\u985e\u7684\u904e\u7a0b\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u8a55\u4f30\u54ea\u4e9b\u624b\u52d5\u6b65\u9a5f\u662f\u5fc5\u8981\u7684\uff0c\u4ee5\u53ca\u5b83\u5011\u5fc5\u9808\u5b8c\u6210\u7684\u9806\u5e8f\u624d\u80fd\u5b8c\u6210\u6240\u6709\u5de5\u4f5c\u3002\u7136\u5f8c\uff0c\u4f60\u5c07\u80fd\u5920\u78ba\u5b9a\u9700\u8981\u54ea\u4e9b\u4efb\u52d9\u4ee5\u53ca\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e9b\u6a21\u584a\u4ee5\u66f4\u5c11\u7684\u6b65\u9a5f\u5be6\u73fe\u76ee\u6a19\u3002 \u6a21\u584a\u63d0\u4f9b\u4e86\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u9019\u4e9b\u4e5f\u7d93\u5e38\u7528\u65bc\u8de8\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7d71\u62bd\u8c61\u547d\u4ee4\u3002 \u7576\u4f60\u5728\u672c\u6307\u5357\u7684\u524d\u4e00\u90e8\u5206\u5275\u5efa\u4f60\u7684\u7b2c\u4e00\u500b playbook \u6642\uff0c\u4f60\u5b9a\u7fa9\u4e86\u4e00\u500b\u4f7f\u7528\u8abf\u8a66\u8f38\u51fa\u6d88\u606f\u7684\u4efb\u52d9\u3002\u8b93\u6211\u5011\u518d\u770b\u770b\u90a3\u500b playbook\u3002 playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u6bcf\u4e00\u500b task \u4efb\u52d9\u88ab\u5b9a\u7fa9\u5728\u7d1a\u5225\u4e4b\u4e0b\u3002 name \u5c6c\u6027\u5b9a\u7fa9\u4e86\u5728\u8a72\u4efb\u52d9\u5373\u5c07\u57f7\u884c\u6642\u5c07\u88ab\u6253\u5370\u51fa\u4f86\u7684\u8f38\u51fa\u3002 \u793a\u4f8b\u4efb\u52d9\u8abf\u7528 debug \u6a21\u584a\uff0c\u5b83\u5141\u8a31\u60a8\u5728playbook\u7684\u57f7\u884c\u4e2d\u986f\u793a\u6d88\u606f\u3002\u4f8b\u5982\uff0c\u9019\u4e9b\u6d88\u606f\u53ef\u7528\u65bc\u986f\u793a\u8abf\u8a66\u4fe1\u606f\uff0c\u4f8b\u5982\u8b8a\u91cf\u7684\u5167\u5bb9\u6216\u547d\u4ee4\u8fd4\u56de\u7684\u8f38\u51fa\u6d88\u606f\u3002 \u6bcf\u500b\u6a21\u584a\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u7d44\u9078\u9805\u548c\u5c6c\u6027\u3002 debug \u6a21\u584a\u9700\u8981\u4e00\u500b\u540d\u70ba msg \u7684\u5c6c\u6027\uff0c\u5176\u4e2d\u5305\u542b\u8981\u6253\u5370\u7684\u6d88\u606f\u3002\u7279\u5225\u6ce8\u610f\u7e2e\u9032\uff082 \u500b\u7a7a\u683c\uff09\uff0c\u56e0\u70ba msg \u5fc5\u9808\u662f debug \u4e2d\u7684\u5c6c\u6027\u3002","title":"\u5982\u4f55\u5b9a\u7fa9\u4efb\u52d9"},{"location":"ansible/tutorial_playbook/how-to-define-tasks-in-ansible-playbooks/#ansible-playbook","text":"\u4efb\u52d9 Task \u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 Ansible playbook \u81ea\u52d5\u57f7\u884c\u7684\u6700\u5c0f\u64cd\u4f5c\u55ae\u5143\u3002\u5287\u672c Playbook \u901a\u5e38\u5305\u542b\u4e00\u7cfb\u5217\u670d\u52d9\u65bc\u67d0\u500b\u76ee\u6a19\u7684\u4efb\u52d9\uff0c\u4f8b\u5982\u8a2d\u7f6e Web \u670d\u52d9\u5668\u6216\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u9060\u7a0b\u74b0\u5883\u3002 Ansible \u6309\u7167\u5b83\u5011\u5728\u5287\u672c\u4e2d\u5b9a\u7fa9\u7684\u9806\u5e8f\u57f7\u884c\u4efb\u52d9\u3002\u5728\u81ea\u52d5\u5316\u8af8\u5982\u8a2d\u7f6e LEMP \u670d\u52d9\u5668\u4e4b\u985e\u7684\u904e\u7a0b\u4e4b\u524d\uff0c\u4f60\u9700\u8981\u8a55\u4f30\u54ea\u4e9b\u624b\u52d5\u6b65\u9a5f\u662f\u5fc5\u8981\u7684\uff0c\u4ee5\u53ca\u5b83\u5011\u5fc5\u9808\u5b8c\u6210\u7684\u9806\u5e8f\u624d\u80fd\u5b8c\u6210\u6240\u6709\u5de5\u4f5c\u3002\u7136\u5f8c\uff0c\u4f60\u5c07\u80fd\u5920\u78ba\u5b9a\u9700\u8981\u54ea\u4e9b\u4efb\u52d9\u4ee5\u53ca\u53ef\u4ee5\u4f7f\u7528\u54ea\u4e9b\u6a21\u584a\u4ee5\u66f4\u5c11\u7684\u6b65\u9a5f\u5be6\u73fe\u76ee\u6a19\u3002 \u6a21\u584a\u63d0\u4f9b\u4e86\u57f7\u884c\u64cd\u4f5c\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u5426\u5247\u4f60\u5fc5\u9808\u5c07\u5176\u4f5c\u70ba\u539f\u59cb bash \u547d\u4ee4\u904b\u884c\u3002\u9019\u4e9b\u4e5f\u7d93\u5e38\u7528\u65bc\u8de8\u4e0d\u540c\u64cd\u4f5c\u7cfb\u7d71\u62bd\u8c61\u547d\u4ee4\u3002 \u7576\u4f60\u5728\u672c\u6307\u5357\u7684\u524d\u4e00\u90e8\u5206\u5275\u5efa\u4f60\u7684\u7b2c\u4e00\u500b playbook \u6642\uff0c\u4f60\u5b9a\u7fa9\u4e86\u4e00\u500b\u4f7f\u7528\u8abf\u8a66\u8f38\u51fa\u6d88\u606f\u7684\u4efb\u52d9\u3002\u8b93\u6211\u5011\u518d\u770b\u770b\u90a3\u500b playbook\u3002 playbook-01.yml --- - hosts : all tasks : - name : Print message debug : msg : Hello Ansible World \u6bcf\u4e00\u500b task \u4efb\u52d9\u88ab\u5b9a\u7fa9\u5728\u7d1a\u5225\u4e4b\u4e0b\u3002 name \u5c6c\u6027\u5b9a\u7fa9\u4e86\u5728\u8a72\u4efb\u52d9\u5373\u5c07\u57f7\u884c\u6642\u5c07\u88ab\u6253\u5370\u51fa\u4f86\u7684\u8f38\u51fa\u3002 \u793a\u4f8b\u4efb\u52d9\u8abf\u7528 debug \u6a21\u584a\uff0c\u5b83\u5141\u8a31\u60a8\u5728playbook\u7684\u57f7\u884c\u4e2d\u986f\u793a\u6d88\u606f\u3002\u4f8b\u5982\uff0c\u9019\u4e9b\u6d88\u606f\u53ef\u7528\u65bc\u986f\u793a\u8abf\u8a66\u4fe1\u606f\uff0c\u4f8b\u5982\u8b8a\u91cf\u7684\u5167\u5bb9\u6216\u547d\u4ee4\u8fd4\u56de\u7684\u8f38\u51fa\u6d88\u606f\u3002 \u6bcf\u500b\u6a21\u584a\u90fd\u6709\u81ea\u5df1\u7684\u4e00\u7d44\u9078\u9805\u548c\u5c6c\u6027\u3002 debug \u6a21\u584a\u9700\u8981\u4e00\u500b\u540d\u70ba msg \u7684\u5c6c\u6027\uff0c\u5176\u4e2d\u5305\u542b\u8981\u6253\u5370\u7684\u6d88\u606f\u3002\u7279\u5225\u6ce8\u610f\u7e2e\u9032\uff082 \u500b\u7a7a\u683c\uff09\uff0c\u56e0\u70ba msg \u5fc5\u9808\u662f debug \u4e2d\u7684\u5c6c\u6027\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u5b9a\u7fa9\u4efb\u52d9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 (Nginx) \u4e0a\u4f7f\u7528 Ansible \u90e8\u7f72\u975c\u614b HTML \u7db2\u7ad9 \u00b6 \u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx \u5982\u679c\u4f60\u6b63\u5728\u95b1\u8b80\u672c\u7cfb\u5217\u7684\u6240\u6709\u90e8\u5206\uff0c\u90a3\u9ebc\u6b64\u6642\u4f60\u61c9\u8a72\u719f\u6089\u5b89\u88dd\u7cfb\u7d71\u5305\u3001\u61c9\u7528\u6a21\u677f\u548c\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f\u3002\u5728\u672c\u7cfb\u5217\u7684\u9019\u4e00\u90e8\u5206\u4e2d\uff0c\u4f60\u5c07\u4f7f\u7528\u5230\u76ee\u524d\u70ba\u6b62\u6240\u898b\u7684\u5167\u5bb9\u4f86\u5275\u5efa\u4e00\u500b playbook\uff0c\u8a72 playbook \u53ef\u4ee5\u81ea\u52d5\u8a2d\u7f6e Nginx \u670d\u52d9\u5668\u4ee5\u5728 Ubuntu 20.04 \u4e0a\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-nginx-demo\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-nginx-demo $ cd ansible-nginx-demo \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" } \u53d6\u5f97\u6f14\u793a\u7528\u7684\u975c\u614b\u7db2\u7ad9 \u00b6 \u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u975c\u614b HTML \u7db2\u7ad9\uff0c\u9019\u662f \u5982\u4f55\u5728 HTML \u4e2d\u7de8\u78bc\u7cfb\u5217 \u7684\u6559\u5b78\u4e2d\u6240\u69cb\u5efa\u7684\u7db2\u7ad9\u3002\u9996\u5148\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f09\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a $ curl -L https://github.com/do-community/html_demo_site/archive/refs/heads/main.zip -o html_demo.zip % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0 100 385k 0 385k 0 0 316k 0 --:--:-- 0 :00:01 --:--:-- 316k \u4f60\u9700\u8981\u89e3\u58d3\u7e2e\u624d\u80fd\u89e3\u58d3\u7e2e\u6b64\u4e0b\u8f09\u7684\u5167\u5bb9\u3002\u70ba\u78ba\u4fdd\u4f60\u5df2\u5b89\u88dd\u6b64\u5de5\u5177\uff0c\u8acb\u904b\u884c\uff1a $ sudo apt install unzip \u7136\u5f8c\uff0c\u89e3\u58d3\u7e2e\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a unzip html_demo.zip \u9019\u5c07\u5728\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u4e0a\u5275\u5efa\u4e00\u500b\u540d\u70ba html_demo_site-main \u7684\u65b0\u76ee\u9304\u3002\u73fe\u5728\u5de5\u4f5c\u76ee\u9304\u7684\u7d50\u69cb\u5982\u4e0b\uff1a $ tree . . \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 html_demo_site-main \u2502 \u251c\u2500\u2500 about.html \u2502 \u251c\u2500\u2500 images \u2502 \u2502 \u251c\u2500\u2500 background.jpg \u2502 \u2502 \u251c\u2500\u2500 large-profile.jpg \u2502 \u2502 \u2514\u2500\u2500 small-profile.jpeg \u2502 \u251c\u2500\u2500 index.html \u2502 \u251c\u2500\u2500 LICENSE \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 html_demo.zip \u251c\u2500\u2500 inventory \u2514\u2500\u2500 Vagrantfile \u70ba Nginx \u7684\u914d\u7f6e\u5275\u5efa\u6a21\u677f \u00b6 \u73fe\u5728\u6211\u5011\u5c07\u8a2d\u7f6e\u914d\u7f6e\u9060\u7a0b Web \u670d\u52d9\u5668\u6240\u9700\u7684 Nginx \u8a2d\u5b9a\u6a21\u677f\u3002\u5728\u5de5\u4f5c\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\u593e\u4f86\u4fdd\u5b58\u5176\u5b83\u975e playbook \u7684\u6587\u4ef6\uff1a $ mkdir files \u7136\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba nginx.conf.j2 \u7684\u65b0\u6587\u4ef6\uff1a $ nano files/nginx.conf.j2 \u6b64\u6a21\u677f\u6587\u4ef6\u5305\u542b\u975c\u614b HTML \u7db2\u7ad9\u7684 Nginx \u670d\u52d9\u5668\u584a\u914d\u7f6e\u3002\u5b83\u4f7f\u7528\u4e09\u500b\u8b8a\u91cf\uff1a document_root \u3001 app_root \u548c server_name \u3002\u6211\u5011\u7a0d\u5f8c\u6703\u5728\u5275\u5efa playbook \u6642\u5b9a\u7fa9\u9019\u4e9b\u8b8a\u91cf\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u8907\u88fd\u5230\u4f60\u7684\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a nginx.conf.j2 server { listen 80; root {{ document_root }}/{{ app_root }}; index index.html index.htm; server_name {{ server_name }}; location / { default_type \"text/html\"; try_files $uri.html $uri $uri/ =404; } } \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002 \u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible playbook \u00b6 \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible \u5287\u672c\u4e26\u8a2d\u7f6e\u6211\u5011\u5728\u672c\u6559\u7a0b\u4e0a\u4e00\u90e8\u5206\u4e2d\u4f7f\u7528\u7684\u8b8a\u91cf\u3002\u6253\u958b\u4e00\u500b\u540d\u70ba playbook.yml \u7684\u65b0\u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u500b playbook \u5c07 hosts \u5b9a\u7fa9\u8a2d\u7f6e\u70ba all \u548c\u4e00\u500b become \u6307\u4ee4\u958b\u59cb\uff0c\u8a72\u6307\u4ee4\u544a\u8a34 Ansible \u9ed8\u8a8d\u4ee5 root \u7528\u6236\u8eab\u4efd\u904b\u884c\u6240\u6709\u4efb\u52d9\uff08\u8207\u4f7f\u7528 sudo \u624b\u52d5\u904b\u884c\u547d\u4ee4\u76f8\u540c\uff09\u3002 \u5728\u672c\u5287\u672c\u7684 var \u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e09\u500b\u8b8a\u91cf\uff1a server_name \u3001 document_root \u548c app_root \u3002\u9019\u4e9b\u8b8a\u91cf\u5728 Nginx \u914d\u7f6e\u6a21\u677f\u4e2d\u7528\u65bc\u8a2d\u7f6e\u6b64 Web \u670d\u52d9\u5668\u5c07\u97ff\u61c9\u7684\u57df\u540d\u6216 IP \u5730\u5740\uff0c\u4ee5\u53ca\u7db2\u7ad9\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u7684\u5b8c\u6574\u8def\u5f91\u3002\u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ansible_default_ipv4.address \u4e8b\u5be6\u8b8a\u91cf\uff0c\u56e0\u70ba\u5b83\u5305\u542b\u9060\u7a0b\u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c\u5b83\u5728 DNS \u670d\u52d9\u4e2d\u6b63\u78ba\u914d\u7f6e\u4e86\u4e00\u500b\u57df\u540d\u4ee5\u6307\u5411\u9019\u500b\u670d\u52d9\u5668\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www/html app_root : html_demo_site-main tasks : \u4f60\u53ef\u4ee5\u66ab\u6642\u4fdd\u6301\u6b64\u6587\u4ef6\u6253\u958b\u3002\u63a5\u4e0b\u4f86\u7684\u90e8\u5206\u5c07\u5f15\u5c0e\u4f60\u5b8c\u6210\u6240\u6709\u9700\u8981\u5305\u542b\u5728\u672c\u6559\u7a0b\u4e2d\u4ee5\u4f7f\u5176\u5b8c\u5168\u6b63\u5e38\u904b\u884c\u7684\u4efb\u52d9\u3002 \u5b89\u88dd\u6240\u9700\u7684\u8edf\u4ef6\u5305 \u00b6 \u4ee5\u4e0b\u4efb\u52d9\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd nginx \u5305\uff1a ansible-nginx-demo/playbook.yml - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes \u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u7bc0\u9ede \u00b6 \u4e0b\u4e00\u500b\u4efb\u52d9\u5c07\u4f7f\u7528ansible copy \u5167\u7f6e\u6a21\u584a\u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u6587\u6a94\u6839\u76ee\u9304\u3002\u6211\u5011\u5c07\u4f7f\u7528 document_root \u8b8a\u91cf\u5728\u670d\u52d9\u5668\u4e0a\u8a2d\u7f6e\u61c9\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u6587\u4ef6\u593e\u7684\u76ee\u6a19\u3002 ansible-nginx-demo/playbook.yml - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve \u61c9\u7528\u548c\u555f\u7528\u81ea\u5b9a\u7fa9 Nginx \u914d\u7f6e \u00b6 \u6211\u5011\u73fe\u5728\u5c07\u61c9\u7528 Nginx \u6a21\u677f\uff0c\u8a72\u6a21\u677f\u5c07\u914d\u7f6e Web \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u4f60\u7684\u975c\u614b HTML \u6587\u4ef6\u3002\u5728 /etc/nginx/sites-available \u8a2d\u7f6e\u914d\u7f6e\u6587\u4ef6\u5f8c\uff0c\u6211\u5011\u5c07\u5728 /etc/nginx-sites-enabled \u4e2d\u5275\u5efa\u6307\u5411\u8a72\u6587\u4ef6\u7684\u7b26\u865f\u93c8\u63a5\uff0c\u4e26\u901a\u77e5 Nginx \u670d\u52d9\u4ee5\u9032\u884c\u5f8c\u7e8c\u91cd\u555f\u3002\u6574\u500b\u904e\u7a0b\u5c07\u9700\u8981\u5169\u500b\u55ae\u7368\u7684\u4efb\u52d9\uff1a ansible-nginx-demo/playbook.yml - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx \u5728 UFW \u4e0a\u5141\u8a31\u7aef\u53e3 80 \u00b6 ufw \u7684\u5168\u540d\u662f Uncomplicated Firewall\uff0c\u610f\u601d\u662f\u4e0d\u8907\u96dc\u7684\u9632\u706b\u7246\u3002\u5b83\u7684\u6307\u4ee4\u4e0d\u4f46\u597d\u8a18\uff0c\u5beb\u597d\u7684\u898f\u5247\u4e5f\u6dfa\u986f\u6613\u61c2\uff0c\u4e0d\u6703\u50cf iptables \u7684\u88f9\u8173\u5e03\u53c8\u81ed\u53c8\u9577\u3002 ansible-nginx-demo/playbook.yml - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp \u70ba Nginx \u670d\u52d9\u5275\u5efa Handler \u00b6 \u8981\u5b8c\u6210\u9019\u500b\u5287\u672c\uff0c\u5269\u4e0b\u8981\u505a\u7684\u5c31\u662f\u8a2d\u7f6e Restart Nginx \u8655\u7406\u7a0b\u5e8f\uff1a ansible-nginx-demo/playbook.yml handlers : - name : Restart Nginx service : name : nginx state : restarted \u904b\u884c\u5b8c\u6210\u7684\u5287\u672c \u00b6 \u5728 playbook \u6587\u4ef6\u4e2d\u5305\u542b\u6240\u6709\u5fc5\u9700\u7684\u4efb\u52d9\u5f8c\uff0c\u5b83\u5c07\u5982\u4e0b\u6240\u793a\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www app_root : html_demo_site-main tasks : - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u56e0\u70ba playbook \u9700\u8981 sudo \u624d\u80fd\u904b\u884c\uff0c\u6240\u4ee5\u6211\u5011\u9084\u5305\u62ec -K \u53c3\u6578\uff0c\u4ee5\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u9060\u7a0b\u7528\u6236\u7684 sudo \u5bc6\u78bc\uff1a $ ansible-playbook playbook.yml \u7d50\u679c: $ ansible-playbook playbook.yml PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and install Nginx] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Copy website files to the server's document root] ************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Nginx template] ****************************************************************************************************************************************************************** changed: [demo-vm] TASK [Enable new site] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Allow all access to tcp port 80] ******************************************************************************************************************************************************* changed: [demo-vm] RUNNING HANDLER [Restart Nginx] ************************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=7 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u7531\u65bc\u6211\u5011\u4f7f\u7528\u4e86Vagrant\u8207VirtualBox\u4f86\u555f\u52d5VM\uff0c\u9700\u8981\u5728 Vagrantfile \u88e1\u8a2d\u5b9a port-forward \u7684\u53c3\u6578: Vagrantfile Vagrant.configure(\"2\") do |config| config.vm.box = \"ubuntu/focal64\" config.vm.network \"forwarded_port\", guest: 80, host: 8080 end \u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f: $ vagrant reload \u5b8c\u6210\u5f8c\uff0c\u5982\u679c\u4f60\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684\u4e3b\u6a5f\u540d\u6216 IP \u5730\u5740(\u6211\u5011\u628a\u7db2\u7ad9\u6620\u5c04\u5230\u672c\u6a5f\u7684port: 8080): http://localhost:8080 \u4f60\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a \u7d50\u8ad6 \u00b6 \u606d\u559c\uff0c\u4f60\u5df2\u4f7f\u7528 Ansible \u6210\u529f\u5730\u5c07\u975c\u614b HTML \u7db2\u7ad9\u90e8\u7f72\u5230\u9060\u7a0b Nginx \u670d\u52d9\u5668\u3002 \u5982\u679c\u4f60\u5c0d\u6f14\u793a\u7db2\u7ad9\u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u9032\u884c\u4e86\u66f4\u6539\uff0c\u4f60\u53ef\u4ee5\u518d\u6b21\u904b\u884c playbook\uff0c\u8907\u88fd\u4efb\u52d9\u5c07\u78ba\u4fdd\u4efb\u4f55\u6587\u4ef6\u66f4\u6539\u90fd\u53cd\u6620\u5728\u9060\u7a0b\u4e3b\u6a5f\u4e2d\u3002\u56e0\u70ba Ansible \u5177\u6709\u51aa\u7b49\u884c\u70ba\uff0c\u6240\u4ee5\u591a\u6b21\u904b\u884c playbook \u4e0d\u6703\u89f8\u767c\u5df2\u7d93\u5c0d\u7cfb\u7d71\u9032\u884c\u7684\u66f4\u6539\u3002","title":"\u5982\u4f55\u4f7f\u7528Nginx\u90e8\u7f72\u975c\u614bHTML\u7db2\u7ad9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#ubuntu-2004-nginx-ansible-html","text":"\u53c3\u8003: https://www.digitalocean.com/community/tutorials/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx \u5982\u679c\u4f60\u6b63\u5728\u95b1\u8b80\u672c\u7cfb\u5217\u7684\u6240\u6709\u90e8\u5206\uff0c\u90a3\u9ebc\u6b64\u6642\u4f60\u61c9\u8a72\u719f\u6089\u5b89\u88dd\u7cfb\u7d71\u5305\u3001\u61c9\u7528\u6a21\u677f\u548c\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u8655\u7406\u7a0b\u5e8f\u3002\u5728\u672c\u7cfb\u5217\u7684\u9019\u4e00\u90e8\u5206\u4e2d\uff0c\u4f60\u5c07\u4f7f\u7528\u5230\u76ee\u524d\u70ba\u6b62\u6240\u898b\u7684\u5167\u5bb9\u4f86\u5275\u5efa\u4e00\u500b playbook\uff0c\u8a72 playbook \u53ef\u4ee5\u81ea\u52d5\u8a2d\u7f6e Nginx \u670d\u52d9\u5668\u4ee5\u5728 Ubuntu 20.04 \u4e0a\u8a17\u7ba1\u975c\u614b HTML \u7db2\u7ad9\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 (Nginx) \u4e0a\u4f7f\u7528 Ansible \u90e8\u7f72\u975c\u614b HTML \u7db2\u7ad9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_1","text":"\u9996\u5148\u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\uff0c\u4f60\u5c07\u5728\u5176\u4e2d\u8a2d\u7f6e Ansible \u6587\u4ef6\u548c\u4e00\u500b\u6f14\u793a\u975c\u614b HTML \u7db2\u7ad9\u4ee5\u90e8\u7f72\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u9019\u53ef\u4ee5\u5728\u4f60\u7684\u4e3b\u6587\u4ef6\u593e\u4e2d\u4f60\u9078\u64c7\u7684\u4efb\u4f55\u4f4d\u7f6e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ~/ansible-nginx-demo\u3002 \u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u65b0\u76ee\u9304\u5e76\u4e14\u5207\u63db\u5230\u65b0\u76ee\u9304\u88e1\u3002 $ mkdir ansible-nginx-demo $ cd ansible-nginx-demo \u4f7f\u7528 Vagrant \u8207 VirtualBox \u4f86\u5728\u672c\u6a5f\u555f\u52d5\u4e00\u53f0 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f\u3002 $ vagrant init ubuntu/focal64 $ vagrant up $ vagrant ssh-config \u53d6\u5f97\u865b\u64ec\u6a5f\u7684IP\u8207ssh port: Host default HostName 127.0.0.1 User vagrant Port 2203 UserKnownHostsFile /dev/null StrictHostKeyChecking no PasswordAuthentication no IdentityFile /home/dxlab/opt/ws_ansible/ansible-nginx-demo/.vagrant/machines/default/virtualbox/private_key IdentitiesOnly yes LogLevel FATAL \u5275\u5efa inventory \u6a94\u6848: inventory demo-vm ansible_host=127.0.0.1 ansible_port=2203 demo-vm \u6211\u5011\u7d66\u4e88\u9019\u500b\u865b\u64ec\u6a5f\u7684\u4e00\u500b\u4e3b\u6a5f\u540d ansible_host Ansible \u8981\u9023\u7dda\u7684\u63a7\u5236\u7bc0\u9ede IP ansible_port Ansible \u8981\u4f7f\u7528SSH\u9023\u7dda\u7684port number \u5275\u5efa ansible.cfg \u6a94\u6848: ansible.cfg [defaults] inventory = inventory remote_user = vagrant private_key_file = .vagrant/machines/default/virtualbox/private_key host_key_checking = False inventory Ansible \u63a7\u5236\u7bc0\u9ede\u4e3b\u6a5f\u8cc7\u8a0a\u5217\u8868\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d remote_user Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u8981\u767b\u5165\u7684\u4f7f\u7528\u8005ID private_key_file Ansible \u8981\u9023\u7dda\u5230\u7bc0\u9ede\u4e3b\u6a5f\u6642\u7684\u9023\u7dda\u6191\u8b49\u6a94\u6848\u4f4d\u7f6e\u8207\u6a94\u540d \u9a57\u8b49 Ansible \u53ef\u9023\u63a5\u81f3 Ubuntu 20.04 \u7684\u865b\u64ec\u6a5f: $ ansible all -m ping demo-vm | SUCCESS = > { \"ansible_facts\" : { \"discovered_interpreter_python\" : \"/usr/bin/python3\" } , \"changed\" : false, \"ping\" : \"pong\" }","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_2","text":"\u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u975c\u614b HTML \u7db2\u7ad9\uff0c\u9019\u662f \u5982\u4f55\u5728 HTML \u4e2d\u7de8\u78bc\u7cfb\u5217 \u7684\u6559\u5b78\u4e2d\u6240\u69cb\u5efa\u7684\u7db2\u7ad9\u3002\u9996\u5148\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f09\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a $ curl -L https://github.com/do-community/html_demo_site/archive/refs/heads/main.zip -o html_demo.zip % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0 100 385k 0 385k 0 0 316k 0 --:--:-- 0 :00:01 --:--:-- 316k \u4f60\u9700\u8981\u89e3\u58d3\u7e2e\u624d\u80fd\u89e3\u58d3\u7e2e\u6b64\u4e0b\u8f09\u7684\u5167\u5bb9\u3002\u70ba\u78ba\u4fdd\u4f60\u5df2\u5b89\u88dd\u6b64\u5de5\u5177\uff0c\u8acb\u904b\u884c\uff1a $ sudo apt install unzip \u7136\u5f8c\uff0c\u89e3\u58d3\u7e2e\u6f14\u793a\u7db2\u7ad9\u6587\u4ef6\uff1a unzip html_demo.zip \u9019\u5c07\u5728\u7576\u524d\u7684\u5de5\u4f5c\u76ee\u9304\u4e0a\u5275\u5efa\u4e00\u500b\u540d\u70ba html_demo_site-main \u7684\u65b0\u76ee\u9304\u3002\u73fe\u5728\u5de5\u4f5c\u76ee\u9304\u7684\u7d50\u69cb\u5982\u4e0b\uff1a $ tree . . \u251c\u2500\u2500 ansible.cfg \u251c\u2500\u2500 html_demo_site-main \u2502 \u251c\u2500\u2500 about.html \u2502 \u251c\u2500\u2500 images \u2502 \u2502 \u251c\u2500\u2500 background.jpg \u2502 \u2502 \u251c\u2500\u2500 large-profile.jpg \u2502 \u2502 \u2514\u2500\u2500 small-profile.jpeg \u2502 \u251c\u2500\u2500 index.html \u2502 \u251c\u2500\u2500 LICENSE \u2502 \u2514\u2500\u2500 README.md \u251c\u2500\u2500 html_demo.zip \u251c\u2500\u2500 inventory \u2514\u2500\u2500 Vagrantfile","title":"\u53d6\u5f97\u6f14\u793a\u7528\u7684\u975c\u614b\u7db2\u7ad9"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#nginx","text":"\u73fe\u5728\u6211\u5011\u5c07\u8a2d\u7f6e\u914d\u7f6e\u9060\u7a0b Web \u670d\u52d9\u5668\u6240\u9700\u7684 Nginx \u8a2d\u5b9a\u6a21\u677f\u3002\u5728\u5de5\u4f5c\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\u593e\u4f86\u4fdd\u5b58\u5176\u5b83\u975e playbook \u7684\u6587\u4ef6\uff1a $ mkdir files \u7136\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba nginx.conf.j2 \u7684\u65b0\u6587\u4ef6\uff1a $ nano files/nginx.conf.j2 \u6b64\u6a21\u677f\u6587\u4ef6\u5305\u542b\u975c\u614b HTML \u7db2\u7ad9\u7684 Nginx \u670d\u52d9\u5668\u584a\u914d\u7f6e\u3002\u5b83\u4f7f\u7528\u4e09\u500b\u8b8a\u91cf\uff1a document_root \u3001 app_root \u548c server_name \u3002\u6211\u5011\u7a0d\u5f8c\u6703\u5728\u5275\u5efa playbook \u6642\u5b9a\u7fa9\u9019\u4e9b\u8b8a\u91cf\u3002\u5c07\u4ee5\u4e0b\u5167\u5bb9\u8907\u88fd\u5230\u4f60\u7684\u6a21\u677f\u6587\u4ef6\u4e2d\uff1a nginx.conf.j2 server { listen 80; root {{ document_root }}/{{ app_root }}; index index.html index.htm; server_name {{ server_name }}; location / { default_type \"text/html\"; try_files $uri.html $uri $uri/ =404; } } \u5b8c\u6210\u5f8c\u4fdd\u5b58\u4e26\u95dc\u9589\u6587\u4ef6\u3002","title":"\u70ba Nginx \u7684\u914d\u7f6e\u5275\u5efa\u6a21\u677f"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#ansible-playbook","text":"\u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible \u5287\u672c\u4e26\u8a2d\u7f6e\u6211\u5011\u5728\u672c\u6559\u7a0b\u4e0a\u4e00\u90e8\u5206\u4e2d\u4f7f\u7528\u7684\u8b8a\u91cf\u3002\u6253\u958b\u4e00\u500b\u540d\u70ba playbook.yml \u7684\u65b0\u6587\u4ef6\uff1a $ nano playbook.yml \u9019\u500b playbook \u5c07 hosts \u5b9a\u7fa9\u8a2d\u7f6e\u70ba all \u548c\u4e00\u500b become \u6307\u4ee4\u958b\u59cb\uff0c\u8a72\u6307\u4ee4\u544a\u8a34 Ansible \u9ed8\u8a8d\u4ee5 root \u7528\u6236\u8eab\u4efd\u904b\u884c\u6240\u6709\u4efb\u52d9\uff08\u8207\u4f7f\u7528 sudo \u624b\u52d5\u904b\u884c\u547d\u4ee4\u76f8\u540c\uff09\u3002 \u5728\u672c\u5287\u672c\u7684 var \u90e8\u5206\u4e2d\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e09\u500b\u8b8a\u91cf\uff1a server_name \u3001 document_root \u548c app_root \u3002\u9019\u4e9b\u8b8a\u91cf\u5728 Nginx \u914d\u7f6e\u6a21\u677f\u4e2d\u7528\u65bc\u8a2d\u7f6e\u6b64 Web \u670d\u52d9\u5668\u5c07\u97ff\u61c9\u7684\u57df\u540d\u6216 IP \u5730\u5740\uff0c\u4ee5\u53ca\u7db2\u7ad9\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u7684\u5b8c\u6574\u8def\u5f91\u3002\u5c0d\u65bc\u9019\u500b\u6f14\u793a\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ansible_default_ipv4.address \u4e8b\u5be6\u8b8a\u91cf\uff0c\u56e0\u70ba\u5b83\u5305\u542b\u9060\u7a0b\u670d\u52d9\u5668\u7684\u516c\u5171 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c\u5b83\u5728 DNS \u670d\u52d9\u4e2d\u6b63\u78ba\u914d\u7f6e\u4e86\u4e00\u500b\u57df\u540d\u4ee5\u6307\u5411\u9019\u500b\u670d\u52d9\u5668\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www/html app_root : html_demo_site-main tasks : \u4f60\u53ef\u4ee5\u66ab\u6642\u4fdd\u6301\u6b64\u6587\u4ef6\u6253\u958b\u3002\u63a5\u4e0b\u4f86\u7684\u90e8\u5206\u5c07\u5f15\u5c0e\u4f60\u5b8c\u6210\u6240\u6709\u9700\u8981\u5305\u542b\u5728\u672c\u6559\u7a0b\u4e2d\u4ee5\u4f7f\u5176\u5b8c\u5168\u6b63\u5e38\u904b\u884c\u7684\u4efb\u52d9\u3002","title":"\u5275\u5efa\u4e00\u500b\u65b0\u7684 Ansible playbook"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_3","text":"\u4ee5\u4e0b\u4efb\u52d9\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd nginx \u5305\uff1a ansible-nginx-demo/playbook.yml - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes","title":"\u5b89\u88dd\u6240\u9700\u7684\u8edf\u4ef6\u5305"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_4","text":"\u4e0b\u4e00\u500b\u4efb\u52d9\u5c07\u4f7f\u7528ansible copy \u5167\u7f6e\u6a21\u584a\u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u6587\u6a94\u6839\u76ee\u9304\u3002\u6211\u5011\u5c07\u4f7f\u7528 document_root \u8b8a\u91cf\u5728\u670d\u52d9\u5668\u4e0a\u8a2d\u7f6e\u61c9\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u6587\u4ef6\u593e\u7684\u76ee\u6a19\u3002 ansible-nginx-demo/playbook.yml - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve","title":"\u5c07\u7db2\u7ad9\u6587\u4ef6\u4e0a\u50b3\u5230\u9060\u7a0b\u7bc0\u9ede"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#nginx_1","text":"\u6211\u5011\u73fe\u5728\u5c07\u61c9\u7528 Nginx \u6a21\u677f\uff0c\u8a72\u6a21\u677f\u5c07\u914d\u7f6e Web \u670d\u52d9\u5668\u4ee5\u8a17\u7ba1\u4f60\u7684\u975c\u614b HTML \u6587\u4ef6\u3002\u5728 /etc/nginx/sites-available \u8a2d\u7f6e\u914d\u7f6e\u6587\u4ef6\u5f8c\uff0c\u6211\u5011\u5c07\u5728 /etc/nginx-sites-enabled \u4e2d\u5275\u5efa\u6307\u5411\u8a72\u6587\u4ef6\u7684\u7b26\u865f\u93c8\u63a5\uff0c\u4e26\u901a\u77e5 Nginx \u670d\u52d9\u4ee5\u9032\u884c\u5f8c\u7e8c\u91cd\u555f\u3002\u6574\u500b\u904e\u7a0b\u5c07\u9700\u8981\u5169\u500b\u55ae\u7368\u7684\u4efb\u52d9\uff1a ansible-nginx-demo/playbook.yml - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx","title":"\u61c9\u7528\u548c\u555f\u7528\u81ea\u5b9a\u7fa9 Nginx \u914d\u7f6e"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#ufw-80","text":"ufw \u7684\u5168\u540d\u662f Uncomplicated Firewall\uff0c\u610f\u601d\u662f\u4e0d\u8907\u96dc\u7684\u9632\u706b\u7246\u3002\u5b83\u7684\u6307\u4ee4\u4e0d\u4f46\u597d\u8a18\uff0c\u5beb\u597d\u7684\u898f\u5247\u4e5f\u6dfa\u986f\u6613\u61c2\uff0c\u4e0d\u6703\u50cf iptables \u7684\u88f9\u8173\u5e03\u53c8\u81ed\u53c8\u9577\u3002 ansible-nginx-demo/playbook.yml - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp","title":"\u5728 UFW \u4e0a\u5141\u8a31\u7aef\u53e3 80"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#nginx-handler","text":"\u8981\u5b8c\u6210\u9019\u500b\u5287\u672c\uff0c\u5269\u4e0b\u8981\u505a\u7684\u5c31\u662f\u8a2d\u7f6e Restart Nginx \u8655\u7406\u7a0b\u5e8f\uff1a ansible-nginx-demo/playbook.yml handlers : - name : Restart Nginx service : name : nginx state : restarted","title":"\u70ba Nginx \u670d\u52d9\u5275\u5efa Handler"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_5","text":"\u5728 playbook \u6587\u4ef6\u4e2d\u5305\u542b\u6240\u6709\u5fc5\u9700\u7684\u4efb\u52d9\u5f8c\uff0c\u5b83\u5c07\u5982\u4e0b\u6240\u793a\uff1a ansible-nginx-demo/playbook.yml --- - hosts : all become : yes vars : server_name : \"{{ ansible_default_ipv4.address }}\" document_root : /var/www app_root : html_demo_site-main tasks : - name : Update apt cache and install Nginx apt : name : nginx state : latest update_cache : yes - name : Copy website files to the server's document root copy : src : \"{{ app_root }}\" dest : \"{{ document_root }}\" mode : preserve - name : Apply Nginx template template : src : files/nginx.conf.j2 dest : /etc/nginx/sites-available/default notify : Restart Nginx - name : Enable new site file : src : /etc/nginx/sites-available/default dest : /etc/nginx/sites-enabled/default state : link notify : Restart Nginx - name : Allow all access to tcp port 80 ufw : rule : allow port : '80' proto : tcp handlers : - name : Restart Nginx service : name : nginx state : restarted \u8981\u5728\u4f60\u5728\u6e05\u55ae\u6587\u4ef6\u4e2d\u8a2d\u7f6e\u7684\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u4f60\u5728\u672c\u7cfb\u5217\u4ecb\u7d39\u4e2d\u904b\u884c\u9023\u63a5\u6e2c\u8a66\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook \u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\u548c sammy \u7528\u6236\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\u3002\u56e0\u70ba playbook \u9700\u8981 sudo \u624d\u80fd\u904b\u884c\uff0c\u6240\u4ee5\u6211\u5011\u9084\u5305\u62ec -K \u53c3\u6578\uff0c\u4ee5\u5728 Ansible \u63d0\u793a\u6642\u63d0\u4f9b\u9060\u7a0b\u7528\u6236\u7684 sudo \u5bc6\u78bc\uff1a $ ansible-playbook playbook.yml \u7d50\u679c: $ ansible-playbook playbook.yml PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and install Nginx] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Copy website files to the server's document root] ************************************************************************************************************************************** changed: [demo-vm] TASK [Apply Nginx template] ****************************************************************************************************************************************************************** changed: [demo-vm] TASK [Enable new site] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [Allow all access to tcp port 80] ******************************************************************************************************************************************************* changed: [demo-vm] RUNNING HANDLER [Restart Nginx] ************************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=7 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u7531\u65bc\u6211\u5011\u4f7f\u7528\u4e86Vagrant\u8207VirtualBox\u4f86\u555f\u52d5VM\uff0c\u9700\u8981\u5728 Vagrantfile \u88e1\u8a2d\u5b9a port-forward \u7684\u53c3\u6578: Vagrantfile Vagrant.configure(\"2\") do |config| config.vm.box = \"ubuntu/focal64\" config.vm.network \"forwarded_port\", guest: 80, host: 8080 end \u91cd\u65b0\u555f\u52d5\u865b\u64ec\u6a5f: $ vagrant reload \u5b8c\u6210\u5f8c\uff0c\u5982\u679c\u4f60\u8f49\u5230\u700f\u89bd\u5668\u4e26\u8a2a\u554f\u670d\u52d9\u5668\u7684\u4e3b\u6a5f\u540d\u6216 IP \u5730\u5740(\u6211\u5011\u628a\u7db2\u7ad9\u6620\u5c04\u5230\u672c\u6a5f\u7684port: 8080): http://localhost:8080 \u4f60\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\uff1a","title":"\u904b\u884c\u5b8c\u6210\u7684\u5287\u672c"},{"location":"ansible/tutorial_playbook/how-to-deploy-a-static-html-website-with-ansible-on-ubuntu-20-04-nginx/#_6","text":"\u606d\u559c\uff0c\u4f60\u5df2\u4f7f\u7528 Ansible \u6210\u529f\u5730\u5c07\u975c\u614b HTML \u7db2\u7ad9\u90e8\u7f72\u5230\u9060\u7a0b Nginx \u670d\u52d9\u5668\u3002 \u5982\u679c\u4f60\u5c0d\u6f14\u793a\u7db2\u7ad9\u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u9032\u884c\u4e86\u66f4\u6539\uff0c\u4f60\u53ef\u4ee5\u518d\u6b21\u904b\u884c playbook\uff0c\u8907\u88fd\u4efb\u52d9\u5c07\u78ba\u4fdd\u4efb\u4f55\u6587\u4ef6\u66f4\u6539\u90fd\u53cd\u6620\u5728\u9060\u7a0b\u4e3b\u6a5f\u4e2d\u3002\u56e0\u70ba Ansible \u5177\u6709\u51aa\u7b49\u884c\u70ba\uff0c\u6240\u4ee5\u591a\u6b21\u904b\u884c playbook \u4e0d\u6703\u89f8\u767c\u5df2\u7d93\u5c0d\u7cfb\u7d71\u9032\u884c\u7684\u66f4\u6539\u3002","title":"\u7d50\u8ad6"},{"location":"ansible/tutorial_playbook/how-to-install-and-manage-system-packages-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u5b89\u88dd\u548c\u7ba1\u7406\u7cfb\u7d71\u5305 \u00b6 \u81ea\u52d5\u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u662f Ansible playbook \u4e2d\u7684\u4e00\u9805\u5e38\u898b\u64cd\u4f5c\u4efb\u52d9\uff0c\u56e0\u70ba\u5178\u578b\u7684\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\u9700\u8981\u4f86\u81ea\u4e0d\u540c\u4f86\u6e90\u7684\u8edf\u4ef6\u3002 apt \u6a21\u584a\u7ba1\u7406\u57fa\u65bc Debian \u7684 Linux \u64cd\u4f5c\u7cfb\u7d71\uff08\u4f8b\u5982 Ubuntu\uff09\u4e0a\u7684\u7cfb\u7d71\u5305\uff0c\u9019\u662f\u6211\u5011\u5728\u672c\u6307\u5357\u4e2d\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u4f7f\u7528\u7684\u767c\u884c\u7248\u3002\u4ee5\u4e0b\u5287\u672c\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u78ba\u4fdd\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd\u4e86 Vim \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-09.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-09.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim is installed apt : name : vim update_cache : yes \u8acb\u6ce8\u610f\uff0c\u6211\u5011\u5728 playbook \u7684\u958b\u982d\u5305\u542b\u4e86 become \u6307\u4ee4\u3002\u9019\u662f\u5fc5\u9700\u7684\uff0c\u56e0\u70ba\u5b89\u88dd\u8edf\u4ef6\u5305\u9700\u8981\u7ba1\u7406\u7cfb\u7d71\u6b0a\u9650\u3002 \u522a\u9664\u5305\u7684\u65b9\u5f0f\u8207\u6b64\u985e\u4f3c\uff0c\u552f\u4e00\u7684\u8b8a\u5316\u662f\u60a8\u5fc5\u9808\u5c07\u5305\u72c0\u614b\u5b9a\u7fa9\u70ba\u4e0d\u5b58\u5728\u3002 state \u6307\u4ee4\u7684\u9ed8\u8a8d\u503c\u662f present \uff0c\u9019\u5c07\u78ba\u4fdd\u8edf\u4ef6\u5305\u5b89\u88dd\u5728\u7cfb\u7d71\u4e0a\uff0c\u7121\u8ad6\u7248\u672c\u5982\u4f55\u3002\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5c07\u5b89\u88dd\u8a72\u8edf\u4ef6\u5305\u3002\u70ba\u78ba\u4fdd\u60a8\u64c1\u6709\u6700\u65b0\u7248\u672c\u7684\u8edf\u4ef6\u5305\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 latest \u4ee3\u66ff\u3002\u5982\u679c\u8a72\u8edf\u4ef6\u5305\u4e0d\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u9019\u5c07\u5c0e\u81f4 apt \u66f4\u65b0\u8acb\u6c42\u7684\u8edf\u4ef6\u5305\u3002 \u8acb\u8a18\u4f4f\u5728\u904b\u884c\u6b64 playbook \u6642\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-09.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim is installed] ********************************************************************************************************************* ok: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5b89\u88dd\u591a\u500b\u5305\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 loop \u4e26\u63d0\u4f9b\u4e00\u500b\u9663\u5217\uff0c\u5176\u4e2d\u5305\u542b\u60a8\u8981\u5b89\u88dd\u7684\u5305\u7684\u540d\u7a31\u3002\u4ee5\u4e0b playbook \u5c07\u78ba\u4fdd\u5b89\u88dd\u5305 vim\u3001unzip \u548c curl \u4e26\u8655\u65bc\u6700\u65b0\u7248\u672c\u3002 \u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-10.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-10.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim, Curl and Unzip are installed apt : name : \"{{ item }}\" update_cache : yes loop : - vim - curl - unzip \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\uff0c\u4e26\u4e14\u4e0d\u8981\u5fd8\u8a18\u5305\u542b -K \u9078\u9805\uff0c\u56e0\u70ba\u6b64 playbook \u9700\u8981\u7ba1\u7406\u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-09.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim, Curl and Unzip are installed] **************************************************************************************************** ok: [demo-vm] => (item=vim) ok: [demo-vm] => (item=curl) changed: [demo-vm] => (item=unzip) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u95dc\u65bc\u5982\u4f55\u7ba1\u7406\u7cfb\u7d71\u5305\u7684\u66f4\u591a\u7d30\u7bc0\uff0c\u5305\u62ec\u5982\u4f55\u522a\u9664\u5305\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u9ad8\u7d1aapt\u9078\u9805\uff0c\u53ef\u4ee5\u53c3\u8003 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5b89\u88dd\u548c\u7ba1\u7406\u7cfb\u7d71\u5305"},{"location":"ansible/tutorial_playbook/how-to-install-and-manage-system-packages-in-ansible-playbooks/#ansible-playbooks","text":"\u81ea\u52d5\u5b89\u88dd\u6240\u9700\u7684\u7cfb\u7d71\u5305\u662f Ansible playbook \u4e2d\u7684\u4e00\u9805\u5e38\u898b\u64cd\u4f5c\u4efb\u52d9\uff0c\u56e0\u70ba\u5178\u578b\u7684\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\u9700\u8981\u4f86\u81ea\u4e0d\u540c\u4f86\u6e90\u7684\u8edf\u4ef6\u3002 apt \u6a21\u584a\u7ba1\u7406\u57fa\u65bc Debian \u7684 Linux \u64cd\u4f5c\u7cfb\u7d71\uff08\u4f8b\u5982 Ubuntu\uff09\u4e0a\u7684\u7cfb\u7d71\u5305\uff0c\u9019\u662f\u6211\u5011\u5728\u672c\u6307\u5357\u4e2d\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u4f7f\u7528\u7684\u767c\u884c\u7248\u3002\u4ee5\u4e0b\u5287\u672c\u5c07\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u7136\u5f8c\u78ba\u4fdd\u5728\u9060\u7a0b\u7bc0\u9ede\u4e0a\u5b89\u88dd\u4e86 Vim \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-09.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-09.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim is installed apt : name : vim update_cache : yes \u8acb\u6ce8\u610f\uff0c\u6211\u5011\u5728 playbook \u7684\u958b\u982d\u5305\u542b\u4e86 become \u6307\u4ee4\u3002\u9019\u662f\u5fc5\u9700\u7684\uff0c\u56e0\u70ba\u5b89\u88dd\u8edf\u4ef6\u5305\u9700\u8981\u7ba1\u7406\u7cfb\u7d71\u6b0a\u9650\u3002 \u522a\u9664\u5305\u7684\u65b9\u5f0f\u8207\u6b64\u985e\u4f3c\uff0c\u552f\u4e00\u7684\u8b8a\u5316\u662f\u60a8\u5fc5\u9808\u5c07\u5305\u72c0\u614b\u5b9a\u7fa9\u70ba\u4e0d\u5b58\u5728\u3002 state \u6307\u4ee4\u7684\u9ed8\u8a8d\u503c\u662f present \uff0c\u9019\u5c07\u78ba\u4fdd\u8edf\u4ef6\u5305\u5b89\u88dd\u5728\u7cfb\u7d71\u4e0a\uff0c\u7121\u8ad6\u7248\u672c\u5982\u4f55\u3002\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u5c07\u5b89\u88dd\u8a72\u8edf\u4ef6\u5305\u3002\u70ba\u78ba\u4fdd\u60a8\u64c1\u6709\u6700\u65b0\u7248\u672c\u7684\u8edf\u4ef6\u5305\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 latest \u4ee3\u66ff\u3002\u5982\u679c\u8a72\u8edf\u4ef6\u5305\u4e0d\u5728\u6700\u65b0\u7248\u672c\u4e0a\uff0c\u9019\u5c07\u5c0e\u81f4 apt \u66f4\u65b0\u8acb\u6c42\u7684\u8edf\u4ef6\u5305\u3002 \u8acb\u8a18\u4f4f\u5728\u904b\u884c\u6b64 playbook \u6642\u63d0\u4f9b -K \u9078\u9805\uff0c\u56e0\u70ba\u5b83\u9700\u8981 sudo \u6b0a\u9650\uff1a ansible-playbook -i inventory playbook-09.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim is installed] ********************************************************************************************************************* ok: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5b89\u88dd\u591a\u500b\u5305\u6642\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 loop \u4e26\u63d0\u4f9b\u4e00\u500b\u9663\u5217\uff0c\u5176\u4e2d\u5305\u542b\u60a8\u8981\u5b89\u88dd\u7684\u5305\u7684\u540d\u7a31\u3002\u4ee5\u4e0b playbook \u5c07\u78ba\u4fdd\u5b89\u88dd\u5305 vim\u3001unzip \u548c curl \u4e26\u8655\u65bc\u6700\u65b0\u7248\u672c\u3002 \u5728 Ansible \u63a7\u5236\u7bc0\u9ede\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-10.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-10.yml --- - hosts : all become : yes tasks : - name : Update apt cache and make sure Vim, Curl and Unzip are installed apt : name : \"{{ item }}\" update_cache : yes loop : - vim - curl - unzip \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\uff0c\u4e26\u4e14\u4e0d\u8981\u5fd8\u8a18\u5305\u542b -K \u9078\u9805\uff0c\u56e0\u70ba\u6b64 playbook \u9700\u8981\u7ba1\u7406\u6b0a\u9650\uff1a $ ansible-playbook -i inventory playbook-09.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache and make sure Vim, Curl and Unzip are installed] **************************************************************************************************** ok: [demo-vm] => (item=vim) ok: [demo-vm] => (item=curl) changed: [demo-vm] => (item=unzip) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u95dc\u65bc\u5982\u4f55\u7ba1\u7406\u7cfb\u7d71\u5305\u7684\u66f4\u591a\u7d30\u7bc0\uff0c\u5305\u62ec\u5982\u4f55\u522a\u9664\u5305\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u9ad8\u7d1aapt\u9078\u9805\uff0c\u53ef\u4ee5\u53c3\u8003 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 Ansible Playbooks \u4e2d\u5b89\u88dd\u548c\u7ba1\u7406\u7cfb\u7d71\u5305"},{"location":"ansible/tutorial_playbook/how-to-use-conditionals-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 ansible-playbooks \u4e2d\u4f7f\u7528\u689d\u4ef6 \u00b6 \u5728 Ansible\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u5728\u57f7\u884c\u4efb\u52d9\u4e4b\u524d\u8981\u6eff\u8db3\u7684\u689d\u4ef6\u3002\u5982\u679c\u689d\u4ef6\u4e0d\u6eff\u8db3\uff0c\u5247\u8df3\u904e\u8a72\u4efb\u52d9\u3002\u9019\u662f\u901a\u904e when \u95dc\u9375\u5b57\u5b8c\u6210\u7684\uff0c\u5b83\u63a5\u53d7\u901a\u5e38\u57fa\u65bc \u8b8a\u91cf \u6216 \u4e8b\u5be6 \u7684\u8868\u9054\u5f0f\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u5169\u500b\u8b8a\u91cf\uff1a create_user_file \u548c user \u3002\u7576 create_user_file \u88ab\u8a55\u4f30\u70ba true \u6642\uff0c\u5c07\u5728 user \u8b8a\u91cf\u5b9a\u7fa9\u7684\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff1a \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-04.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : yes - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u8981\u5f9e\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u672c\u7cfb\u5217\u4e2d\u7684\u5176\u4ed6 playbook \u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-04.yml \u7576\u6eff\u8db3\u689d\u4ef6\u6642 (create_user_file\uff1dtrue)\uff0c\u60a8\u5c07\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u66f4\u6539\u7684\u72c0\u614b\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u5c07 create_user_file \u7684\u503c\u66f4\u6539\u70ba no \uff0c\u5247\u689d\u4ef6\u5c07\u88ab\u8a55\u4f30\u70ba false \u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u6703\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u8df3\u904e\u72c0\u614b\uff0c\u8868\u793a\u4efb\u52d9\u672a\u57f7\u884c\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : no - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u518d\u57f7\u884c\u4e00\u6b21 playbook: $ ansible-playbook -i inventory playbook-04.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=1 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5728 Ansible playbook \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u689d\u4ef6\u8a9e\u53e5\u7684\u4e00\u500b\u5e38\u898b\u7528\u9014\u662f\u5c07\u5b83\u5011\u8207 register \u7d50\u5408\uff0c\u9019\u662f\u4e00\u500b\u5275\u5efa\u65b0\u8b8a\u91cf\u4e26\u5c07\u5176\u5206\u914d\u7d66\u5f9e\u547d\u4ee4\u7372\u5f97\u7684\u8f38\u51fa\u7684\u95dc\u9375\u5b57\u3002\u9019\u6a23\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u5916\u90e8\u547d\u4ee4\u4f86\u8a55\u4f30\u4efb\u52d9\u7684\u57f7\u884c\u3002 \u9700\u8981\u6ce8\u610f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u60a8\u7528\u65bc\u8a55\u4f30\u689d\u4ef6\u7684\u547d\u4ee4\u5931\u6557\uff0cAnsible \u5c07\u4e2d\u65b7\u64ad\u653e\u3002\u51fa\u65bc\u9019\u500b\u539f\u56e0\uff0c\u60a8\u9700\u8981\u5728\u6240\u8ff0\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b\u8a2d\u7f6e\u70ba yes \u7684 ignore_errors \u6307\u4ee4\uff0c\u9019\u5c07\u4f7f Ansible \u7e7c\u7e8c\u57f7\u884c\u4e0b\u4e00\u500b\u4efb\u52d9\u4e26\u7e7c\u7e8c\u64ad\u653e\u3002 \u4ee5\u4e0b\u793a\u4f8b\u53ea\u6703\u5728\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff0c\u4ee5\u9632\u8a72\u6587\u4ef6\u5c1a\u4e0d\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ls \u547d\u4ee4\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u4f46\u662f\uff0c\u5982\u679c\u6587\u4ef6\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 debug \u6a21\u584a\u986f\u793a\u4e00\u689d\u6d88\u606f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-05.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-05.yml --- - hosts : all vars : - user : vagrant tasks : - name : Check if file already exists command : ls /home/{{ user }}/myfile register : file_exists ignore_errors : yes - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : file_exists is failed - name : show message if file exists debug : msg : The user file already exists. when : file_exists is succeeded \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7b2c\u4e00\u6b21\u904b\u884c\u6b64 playbook \u6642\uff0c\u547d\u4ee4 Check if file already exists \u5c07\u5931\u6557\uff0c\u56e0\u70ba\u8a72\u6587\u4ef6\u4e0d\u5b58\u5728\u65bc\u8a72\u8def\u5f91\u4e2d\u3002\u7136\u5f8c\u5c07\u57f7\u884c create file for user \u5275\u5efa\u6587\u4ef6\u7684\u4efb\u52d9\uff0c\u800c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9 show message if file exists \u5c07\u88ab\u8df3\u904e\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** fatal: [demo-vm]: FAILED! => {\"changed\": true, \"cmd\": [\"ls\", \"/home/vagrant/myfile\"], \"delta\": \"0:00:00.002623\", \"end\": \"2022-06-08 23:00:34.377372\", \"msg\": \"non-zero return code\", \"rc\": 2, \"start\": \"2022-06-08 23:00:34.374749\", \"stderr\": \"ls: cannot access '/home/vagrant/myfile': No such file or directory\", \"stderr_lines\": [\"ls: cannot access '/home/vagrant/myfile': No such file or directory\"], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=1 rescued=0 ignored=1 \u5f9e\u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 create file for user \u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u8b8a\u5316\uff0c\u9019\u610f\u5473\u8457\u6587\u4ef6\u5df2\u5275\u5efa\u3002\u73fe\u5728\uff0c\u518d\u6b21\u904b\u884c playbook\uff0c\u4f60\u6703\u5f97\u5230\u4e0d\u540c\u7684\u7d50\u679c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** changed: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"The user file already exists.\" } PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=1 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5982\u679c\u60a8\u60f3\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u689d\u4ef6\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u4f7f\u7528\u689d\u4ef6"},{"location":"ansible/tutorial_playbook/how-to-use-conditionals-in-ansible-playbooks/#ansible-playbooks","text":"\u5728 Ansible\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u5728\u57f7\u884c\u4efb\u52d9\u4e4b\u524d\u8981\u6eff\u8db3\u7684\u689d\u4ef6\u3002\u5982\u679c\u689d\u4ef6\u4e0d\u6eff\u8db3\uff0c\u5247\u8df3\u904e\u8a72\u4efb\u52d9\u3002\u9019\u662f\u901a\u904e when \u95dc\u9375\u5b57\u5b8c\u6210\u7684\uff0c\u5b83\u63a5\u53d7\u901a\u5e38\u57fa\u65bc \u8b8a\u91cf \u6216 \u4e8b\u5be6 \u7684\u8868\u9054\u5f0f\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5b9a\u7fa9\u4e86\u5169\u500b\u8b8a\u91cf\uff1a create_user_file \u548c user \u3002\u7576 create_user_file \u88ab\u8a55\u4f30\u70ba true \u6642\uff0c\u5c07\u5728 user \u8b8a\u91cf\u5b9a\u7fa9\u7684\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff1a \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-04.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : yes - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u8981\u5f9e\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u5728\u670d\u52d9\u5668\u4e0a\u57f7\u884c\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u672c\u7cfb\u5217\u4e2d\u7684\u5176\u4ed6 playbook \u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a $ ansible-playbook -i inventory playbook-04.yml \u7576\u6eff\u8db3\u689d\u4ef6\u6642 (create_user_file\uff1dtrue)\uff0c\u60a8\u5c07\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u66f4\u6539\u7684\u72c0\u614b\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u5982\u679c\u5c07 create_user_file \u7684\u503c\u66f4\u6539\u70ba no \uff0c\u5247\u689d\u4ef6\u5c07\u88ab\u8a55\u4f30\u70ba false \u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u60a8\u6703\u5728\u64ad\u653e\u8f38\u51fa\u4e2d\u770b\u5230\u8df3\u904e\u72c0\u614b\uff0c\u8868\u793a\u4efb\u52d9\u672a\u57f7\u884c\uff1a playbook-04.yml --- - hosts : all vars : - create_user_file : no - user : vagrant tasks : - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : create_user_file \u518d\u57f7\u884c\u4e00\u6b21 playbook: $ ansible-playbook -i inventory playbook-04.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=1 changed=0 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5728 Ansible playbook \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0c\u689d\u4ef6\u8a9e\u53e5\u7684\u4e00\u500b\u5e38\u898b\u7528\u9014\u662f\u5c07\u5b83\u5011\u8207 register \u7d50\u5408\uff0c\u9019\u662f\u4e00\u500b\u5275\u5efa\u65b0\u8b8a\u91cf\u4e26\u5c07\u5176\u5206\u914d\u7d66\u5f9e\u547d\u4ee4\u7372\u5f97\u7684\u8f38\u51fa\u7684\u95dc\u9375\u5b57\u3002\u9019\u6a23\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u5916\u90e8\u547d\u4ee4\u4f86\u8a55\u4f30\u4efb\u52d9\u7684\u57f7\u884c\u3002 \u9700\u8981\u6ce8\u610f\u7684\u4e00\u4ef6\u91cd\u8981\u4e8b\u60c5\u662f\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u60a8\u7528\u65bc\u8a55\u4f30\u689d\u4ef6\u7684\u547d\u4ee4\u5931\u6557\uff0cAnsible \u5c07\u4e2d\u65b7\u64ad\u653e\u3002\u51fa\u65bc\u9019\u500b\u539f\u56e0\uff0c\u60a8\u9700\u8981\u5728\u6240\u8ff0\u4efb\u52d9\u4e2d\u5305\u542b\u4e00\u500b\u8a2d\u7f6e\u70ba yes \u7684 ignore_errors \u6307\u4ee4\uff0c\u9019\u5c07\u4f7f Ansible \u7e7c\u7e8c\u57f7\u884c\u4e0b\u4e00\u500b\u4efb\u52d9\u4e26\u7e7c\u7e8c\u64ad\u653e\u3002 \u4ee5\u4e0b\u793a\u4f8b\u53ea\u6703\u5728\u7528\u6236\u4e3b\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u65b0\u6587\u4ef6\uff0c\u4ee5\u9632\u8a72\u6587\u4ef6\u5c1a\u4e0d\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 ls \u547d\u4ee4\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u4f46\u662f\uff0c\u5982\u679c\u6587\u4ef6\u5b58\u5728\uff0c\u6211\u5011\u5c07\u4f7f\u7528 debug \u6a21\u584a\u986f\u793a\u4e00\u689d\u6d88\u606f\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-05.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-05.yml --- - hosts : all vars : - user : vagrant tasks : - name : Check if file already exists command : ls /home/{{ user }}/myfile register : file_exists ignore_errors : yes - name : create file for user file : path : /home/{{ user }}/myfile state : touch when : file_exists is failed - name : show message if file exists debug : msg : The user file already exists. when : file_exists is succeeded \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7b2c\u4e00\u6b21\u904b\u884c\u6b64 playbook \u6642\uff0c\u547d\u4ee4 Check if file already exists \u5c07\u5931\u6557\uff0c\u56e0\u70ba\u8a72\u6587\u4ef6\u4e0d\u5b58\u5728\u65bc\u8a72\u8def\u5f91\u4e2d\u3002\u7136\u5f8c\u5c07\u57f7\u884c create file for user \u5275\u5efa\u6587\u4ef6\u7684\u4efb\u52d9\uff0c\u800c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9 show message if file exists \u5c07\u88ab\u8df3\u904e\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** fatal: [demo-vm]: FAILED! => {\"changed\": true, \"cmd\": [\"ls\", \"/home/vagrant/myfile\"], \"delta\": \"0:00:00.002623\", \"end\": \"2022-06-08 23:00:34.377372\", \"msg\": \"non-zero return code\", \"rc\": 2, \"start\": \"2022-06-08 23:00:34.374749\", \"stderr\": \"ls: cannot access '/home/vagrant/myfile': No such file or directory\", \"stderr_lines\": [\"ls: cannot access '/home/vagrant/myfile': No such file or directory\"], \"stdout\": \"\", \"stdout_lines\": []} ...ignoring TASK [create file for user] ************************************************************************************************************************************************ changed: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** skipping: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=1 rescued=0 ignored=1 \u5f9e\u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 create file for user \u4efb\u52d9\u5c0e\u81f4\u670d\u52d9\u5668\u767c\u751f\u8b8a\u5316\uff0c\u9019\u610f\u5473\u8457\u6587\u4ef6\u5df2\u5275\u5efa\u3002\u73fe\u5728\uff0c\u518d\u6b21\u904b\u884c playbook\uff0c\u4f60\u6703\u5f97\u5230\u4e0d\u540c\u7684\u7d50\u679c\uff1a $ ansible-playbook -i inventory playbook-05.yml \u7d50\u679c: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Check if file already exists] **************************************************************************************************************************************** changed: [demo-vm] TASK [create file for user] ************************************************************************************************************************************************ skipping: [demo-vm] TASK [show message if file exists] ***************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"The user file already exists.\" } PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=1 unreachable=0 failed=0 skipped=1 rescued=0 ignored=0 \u5982\u679c\u60a8\u60f3\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u5728 Ansible playbook \u4e2d\u4f7f\u7528\u689d\u4ef6\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 ansible-playbooks \u4e2d\u4f7f\u7528\u689d\u4ef6"},{"location":"ansible/tutorial_playbook/how-to-use-loops-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u5faa\u74b0 \u00b6 \u5728\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u6642\uff0c\u6709\u6642\u60a8\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u503c\u91cd\u8907\u57f7\u884c\u76f8\u540c\u7684\u4efb\u52d9\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u6539\u591a\u500b\u6587\u4ef6\u7684\u6b0a\u9650\uff0c\u6216\u5275\u5efa\u591a\u500b\u7528\u6236\u3002\u70ba\u907f\u514d\u5728 playbook \u6587\u4ef6\u4e2d\u591a\u6b21\u91cd\u8907\u8a72\u4efb\u52d9\uff0c\u6700\u597d\u4f7f\u7528 loop \u3002 \u5728\u7de8\u7a0b\u4e2d\uff0c loop \u5141\u8a31\u60a8\u91cd\u8907\u6307\u4ee4\uff0c\u901a\u5e38\u76f4\u5230\u6eff\u8db3\u67d0\u500b\u689d\u4ef6\u3002 Ansible \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u5faa\u74b0\u65b9\u6cd5\uff0c\u5176\u4e2d loop \u95dc\u9375\u5b57\u662f\u9577\u671f\u517c\u5bb9\u6027\u6700\u63a8\u85a6\u7684\u9078\u9805\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5728 /tmp \u76ee\u9304\u4e0b\u8981\u5275\u5efa\u4e09\u500b\u4e0d\u540c\u7684\u6587\u4ef6\u3002\u5b83\u5728\u4f7f\u7528\u4e09\u500b\u4e0d\u540c\u503c\u5be6\u73fe\u5faa\u74b0\u7684\u4efb\u52d9\u4e2d\u4f7f\u7528\u6587\u4ef6\u6a21\u584a\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-06.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-06.yml --- - hosts : all tasks : - name : creates users files file : path : /tmp/ansible-{{ item }} state : touch loop : - sammy - erika - brian \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-06.yml \u4f60\u6703\u5f97\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u986f\u793a\u5faa\u74b0\u4e2d\u4f7f\u7528\u7684\u6bcf\u500b\u55ae\u7368\u7684\u9805\u76ee\u503c\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [creates user files] ************************************************************************************************************************************************** changed: [demo-vm] => (item=sammy) changed: [demo-vm] => (item=erika) changed: [demo-vm] => (item=brain) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6709\u95dc\u5728\u7de8\u5beb Ansible playbook \u6642\u5982\u4f55\u4f7f\u7528\u5faa\u74b0\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u4f7f\u7528\u5faa\u74b0"},{"location":"ansible/tutorial_playbook/how-to-use-loops-in-ansible-playbooks/#ansible-playbook","text":"\u5728\u81ea\u52d5\u5316\u670d\u52d9\u5668\u8a2d\u7f6e\u6642\uff0c\u6709\u6642\u60a8\u9700\u8981\u4f7f\u7528\u4e0d\u540c\u7684\u503c\u91cd\u8907\u57f7\u884c\u76f8\u540c\u7684\u4efb\u52d9\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u66f4\u6539\u591a\u500b\u6587\u4ef6\u7684\u6b0a\u9650\uff0c\u6216\u5275\u5efa\u591a\u500b\u7528\u6236\u3002\u70ba\u907f\u514d\u5728 playbook \u6587\u4ef6\u4e2d\u591a\u6b21\u91cd\u8907\u8a72\u4efb\u52d9\uff0c\u6700\u597d\u4f7f\u7528 loop \u3002 \u5728\u7de8\u7a0b\u4e2d\uff0c loop \u5141\u8a31\u60a8\u91cd\u8907\u6307\u4ee4\uff0c\u901a\u5e38\u76f4\u5230\u6eff\u8db3\u67d0\u500b\u689d\u4ef6\u3002 Ansible \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u5faa\u74b0\u65b9\u6cd5\uff0c\u5176\u4e2d loop \u95dc\u9375\u5b57\u662f\u9577\u671f\u517c\u5bb9\u6027\u6700\u63a8\u85a6\u7684\u9078\u9805\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5728 /tmp \u76ee\u9304\u4e0b\u8981\u5275\u5efa\u4e09\u500b\u4e0d\u540c\u7684\u6587\u4ef6\u3002\u5b83\u5728\u4f7f\u7528\u4e09\u500b\u4e0d\u540c\u503c\u5be6\u73fe\u5faa\u74b0\u7684\u4efb\u52d9\u4e2d\u4f7f\u7528\u6587\u4ef6\u6a21\u584a\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-06.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-06.yml --- - hosts : all tasks : - name : creates users files file : path : /tmp/ansible-{{ item }} state : touch loop : - sammy - erika - brian \u7136\u5f8c\uff0c\u4f7f\u7528\u8207\u524d\u9762\u793a\u4f8b\u76f8\u540c\u7684\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u4f7f\u7528\u4e86\u4e00\u500b\u540d\u70ba inventory \u7684\u5eab\u5b58\u6587\u4ef6\uff0c\u4f46\u662f\u60a8\u61c9\u8a72\u76f8\u61c9\u5730\u66f4\u6539\u9019\u4e9b\u503c\uff1a $ ansible-playbook -i inventory playbook-06.yml \u4f60\u6703\u5f97\u5230\u9019\u6a23\u7684\u8f38\u51fa\uff0c\u986f\u793a\u5faa\u74b0\u4e2d\u4f7f\u7528\u7684\u6bcf\u500b\u55ae\u7368\u7684\u9805\u76ee\u503c\uff1a PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [creates user files] ************************************************************************************************************************************************** changed: [demo-vm] => (item=sammy) changed: [demo-vm] => (item=erika) changed: [demo-vm] => (item=brain) PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6709\u95dc\u5728\u7de8\u5beb Ansible playbook \u6642\u5982\u4f55\u4f7f\u7528\u5faa\u74b0\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u5faa\u74b0"},{"location":"ansible/tutorial_playbook/how-to-use-variables-in-ansible-playbooks/","text":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u8b8a\u91cf \u00b6 Ansible \u652f\u6301\u4f7f\u7528 \u8b8a\u91cf \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u548c\u5287\u672c\u7684\u57f7\u884c\u3002\u9019\u6a23\uff0c\u5c31\u53ef\u4ee5\u5c07\u540c\u4e00\u5287\u672c\u7528\u65bc\u4e0d\u540c\u7684\u76ee\u6a19\u548c\u74b0\u5883\u3002 \u8b8a\u91cf \u53ef\u4ee5\u4f86\u81ea\u4e0d\u540c\u7684\u4f86\u6e90\uff0c\u4f8b\u5982\u5287\u672c\u6587\u4ef6\u672c\u8eab\u6216\u5287\u672c\u4e2d\u5c0e\u5165\u7684\u5916\u90e8\u8b8a\u91cf\u6587\u4ef6\u3002\u7576\u4f7f\u7528\u5b9a\u7fa9\u540c\u540d\u8b8a\u91cf\u7684\u591a\u500b\u8b8a\u91cf\u6e90\u6642\uff0c\u5c07\u61c9\u7528\u7279\u6b8a\u512a\u5148\u7d1a\u898f\u5247\u3002 \u70ba\u4e86\u4e86\u89e3\u8b8a\u91cf\u5728\u5be6\u8e10\u4e2d\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6e2c\u8a66 playbook\uff0c\u5b83\u5c07\u6253\u5370\u5169\u500b\u8b8a\u91cf\u7684\u503c\uff0c username \u548c home_dir \u3002\u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-02.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-02.yml --- - hosts: all vars: - username: vagrant - home: /home/vagrant tasks: - name: print variables debug: msg: \"Username: {{ username }}, Home dir: {{ home }}\" playbook \u7684 vars \u90e8\u5206\u5b9a\u7fa9\u4e86\u5c07\u5728\u8a72 play \u7bc4\u570d\u5167\u8981\u6ce8\u5165\u7684\u8b8a\u91cf\u5217\u8868\u3002\u6240\u6709\u4efb\u52d9\u4ee5\u53ca\u53ef\u80fd\u5305\u542b\u5728 playbook \u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u6216\u6a21\u677f\u90fd\u53ef\u4ee5\u8a2a\u554f\u9019\u4e9b\u8b8a\u91cf\u3002 \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a ansible-playbook -i inventory playbook-02.yml \u7d50\u679c: PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [print variables] *********************************************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"Username: vagrant, Home dir: /home/vagrant\" } PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6253\u5370\u8b8a\u91cf\u4efb\u52d9\u5c07\u4f7f\u7528\u8abf\u8a66\u6a21\u584a\u6253\u5370\u6211\u5011\u5728\u5287\u672c\u7684 vars \u5340\u584a\u4e2d\u5b9a\u7fa9\u7684\u5169\u500b\u8b8a\u91cf\u7684\u503c\u3002","title":"\u5982\u4f55\u4f7f\u7528\u8b8a\u91cf"},{"location":"ansible/tutorial_playbook/how-to-use-variables-in-ansible-playbooks/#ansible-playbook","text":"Ansible \u652f\u6301\u4f7f\u7528 \u8b8a\u91cf \u4f86\u66f4\u597d\u5730\u81ea\u5b9a\u7fa9\u4efb\u52d9\u548c\u5287\u672c\u7684\u57f7\u884c\u3002\u9019\u6a23\uff0c\u5c31\u53ef\u4ee5\u5c07\u540c\u4e00\u5287\u672c\u7528\u65bc\u4e0d\u540c\u7684\u76ee\u6a19\u548c\u74b0\u5883\u3002 \u8b8a\u91cf \u53ef\u4ee5\u4f86\u81ea\u4e0d\u540c\u7684\u4f86\u6e90\uff0c\u4f8b\u5982\u5287\u672c\u6587\u4ef6\u672c\u8eab\u6216\u5287\u672c\u4e2d\u5c0e\u5165\u7684\u5916\u90e8\u8b8a\u91cf\u6587\u4ef6\u3002\u7576\u4f7f\u7528\u5b9a\u7fa9\u540c\u540d\u8b8a\u91cf\u7684\u591a\u500b\u8b8a\u91cf\u6e90\u6642\uff0c\u5c07\u61c9\u7528\u7279\u6b8a\u512a\u5148\u7d1a\u898f\u5247\u3002 \u70ba\u4e86\u4e86\u89e3\u8b8a\u91cf\u5728\u5be6\u8e10\u4e2d\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u6211\u5011\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6e2c\u8a66 playbook\uff0c\u5b83\u5c07\u6253\u5370\u5169\u500b\u8b8a\u91cf\u7684\u503c\uff0c username \u548c home_dir \u3002\u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-02.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-02.yml --- - hosts: all vars: - username: vagrant - home: /home/vagrant tasks: - name: print variables debug: msg: \"Username: {{ username }}, Home dir: {{ home }}\" playbook \u7684 vars \u90e8\u5206\u5b9a\u7fa9\u4e86\u5c07\u5728\u8a72 play \u7bc4\u570d\u5167\u8981\u6ce8\u5165\u7684\u8b8a\u91cf\u5217\u8868\u3002\u6240\u6709\u4efb\u52d9\u4ee5\u53ca\u53ef\u80fd\u5305\u542b\u5728 playbook \u4e2d\u7684\u4efb\u4f55\u6587\u4ef6\u6216\u6a21\u677f\u90fd\u53ef\u4ee5\u8a2a\u554f\u9019\u4e9b\u8b8a\u91cf\u3002 \u8981\u5728\u60a8\u7684\u6e05\u55ae\u6587\u4ef6\u4e2d\u7684\u670d\u52d9\u5668\u4e0a\u5617\u8a66\u6b64 playbook\uff0c\u8acb\u4f7f\u7528\u60a8\u4e4b\u524d\u5728\u904b\u884c\u6211\u5011\u7684\u7b2c\u4e00\u500b\u793a\u4f8b\u6642\u4f7f\u7528\u7684\u76f8\u540c\u9023\u63a5\u53c3\u6578\u904b\u884c ansible-playbook\u3002\u540c\u6a23\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u4e00\u500b\u540d\u70ba inventory \u7684\u6e05\u55ae\u6587\u4ef6\u9023\u63a5\u5230\u9060\u7a0b\u670d\u52d9\u5668\uff1a ansible-playbook -i inventory playbook-02.yml \u7d50\u679c: PLAY [all] *********************************************************************************************************************************************************************************** TASK [Gathering Facts] *********************************************************************************************************************************************************************** ok: [demo-vm] TASK [print variables] *********************************************************************************************************************************************************************** ok: [demo-vm] => { \"msg\": \"Username: vagrant, Home dir: /home/vagrant\" } PLAY RECAP *********************************************************************************************************************************************************************************** demo-vm : ok=2 changed=0 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u6253\u5370\u8b8a\u91cf\u4efb\u52d9\u5c07\u4f7f\u7528\u8abf\u8a66\u6a21\u584a\u6253\u5370\u6211\u5011\u5728\u5287\u672c\u7684 vars \u5340\u584a\u4e2d\u5b9a\u7fa9\u7684\u5169\u500b\u8b8a\u91cf\u7684\u503c\u3002","title":"\u5982\u4f55\u5728 Ansible Playbook \u4e2d\u4f7f\u7528\u8b8a\u91cf"},{"location":"ansible/tutorial_playbook/understanding-privilege-escalation-in-ansible-playbooks/","text":"\u4e86\u89e3 Ansible Playbook \u4e2d\u7684\u6b0a\u9650\u63d0\u5347 \u00b6 \u5c31\u50cf\u60a8\u5728\u7d42\u7aef\u4e0a\u57f7\u884c\u7684\u5e38\u898f\u547d\u4ee4\u4e00\u6a23\uff0c\u67d0\u4e9b\u4efb\u52d9\u9700\u8981\u7279\u6b8a\u6b0a\u9650\u624d\u80fd\u8b93 Ansible \u5728\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4e0a\u6210\u529f\u57f7\u884c\u5b83\u5011\u3002 \u4e86\u89e3\u6b0a\u9650\u63d0\u6607\u5728 Ansible \u4e2d\u7684\u5de5\u4f5c\u539f\u7406\u975e\u5e38\u91cd\u8981\uff0c\u9019\u6a23\u60a8\u5c31\u53ef\u4ee5\u4f7f\u7528\u9069\u7576\u7684\u6b0a\u9650\u57f7\u884c\u4efb\u52d9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4efb\u52d9\u5c07\u4ee5\u9023\u63a5\u7528\u6236\u8eab\u4efd\u904b\u884c - \u9019\u53ef\u80fd\u662f root \u6216\u4efb\u4f55\u5177\u6709 SSH \u8a2a\u554f\u6e05\u55ae\u6587\u4ef6\u4e2d\u9060\u7a0b\u7bc0\u9ede\u7684\u5e38\u898f\u7528\u6236\u3002 \u8981\u904b\u884c\u5177\u6709\u64f4\u5c55\u6b0a\u9650\u7684\u547d\u4ee4\uff0c\u4f8b\u5982\u9700\u8981 sudo \u7684\u547d\u4ee4\uff0c\u60a8\u9700\u8981\u5728 playbook \u4e2d\u5305\u542b\u8a2d\u5b9a become \u6307\u4ee4\u3002\u9019\u53ef\u4ee5\u4f5c\u70ba\u5c0d\u8a72 playbook \u4e2d\u6240\u6709\u4efb\u52d9\u6709\u6548\u7684\u5168\u5c40\u8a2d\u7f6e\u4f86\u5b8c\u6210\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba\u6bcf\u500b\u4efb\u52d9\u61c9\u7528\u7684\u55ae\u7368\u6307\u4ee4\u4f86\u5b8c\u6210\u3002\u6839\u64da\u60a8\u7684 sudo \u7528\u6236\u5728\u9060\u7a0b\u7bc0\u9ede\u4e2d\u7684\u8a2d\u7f6e\u65b9\u5f0f\uff0c\u60a8\u53ef\u80fd\u9084\u9700\u8981\u63d0\u4f9b\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002\u4ee5\u4e0b\u793a\u4f8b\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u9019\u662f\u4e00\u9805\u9700\u8981 root \u6b0a\u9650\u7684\u4efb\u52d9\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-07.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-07.yml --- - hosts : all become : yes tasks : - name : Update apt cache apt : update_cache : yes \u8981\u904b\u884c\u9019\u500b playbook\uff0c\u60a8\u9700\u8981\u5728 ansible-playbook \u547d\u4ee4\u4e2d\u5305\u542b -K \u9078\u9805\u3002\u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u6307\u5b9a\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002 $ ansible-playbook -i inventory playbook-07.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u60a8\u9084\u53ef\u4ee5\u5728\u57f7\u884c\u4efb\u52d9\u6216\u64ad\u653e\u6642\u66f4\u6539\u8981\u5207\u63db\u5230\u7684\u7528\u6236\u3002\u70ba\u6b64\uff0c\u8acb\u5c07 become_user \u6307\u4ee4\u8a2d\u7f6e\u70ba\u60a8\u8981\u5207\u63db\u5230\u7684\u9060\u7a0b\u7528\u6236\u7684\u540d\u7a31\u3002\u7576\u60a8\u5728 playbook \u4e2d\u6709\u591a\u500b\u4f9d\u8cf4 sudo \u7684\u4efb\u52d9\u6642\uff0c\u9019\u5f88\u6709\u7528\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u4efb\u52d9\u61c9\u8a72\u4f5c\u70ba\u60a8\u7684\u666e\u901a\u7528\u6236\u904b\u884c\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u672c\u6b21\u64ad\u653e\u4e2d\u7684\u6240\u6709\u4efb\u52d9\u9ed8\u8a8d\u4f7f\u7528 sudo \u57f7\u884c\u3002\u9019\u662f\u5728\u64ad\u653e\u7d1a\u5225\u8a2d\u7f6e\u7684\uff0c\u5c31\u5728\u4e3b\u6a5f\u5b9a\u7fa9\u4e4b\u5f8c\u3002\u7b2c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 root \u6b0a\u9650\u5728 /tmp \u4e0a\u5275\u5efa\u4e00\u500b\u6587\u4ef6\uff0c\u56e0\u70ba\u9019\u662f\u9ed8\u8a8d\u7684 become_user \u503c\u3002\u7136\u800c\uff0c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u5b9a\u7fa9\u4e86\u5b83\u81ea\u5df1\u7684 become_user \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-08.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-08.yml --- - hosts : all become : yes vars : user : \"{{ ansible_env.USER }}\" tasks : - name : Create root file file : path : /tmp/my_file_root state : touch - name : Create user file become_user : \"{{ user }}\" file : path : /tmp/my_file_{{ user }} state : touch ansible_env.USER \u7684\u4e8b\u5be6(fact)\u5305\u542b\u9023\u63a5\u7528\u6236\u7684\u7528\u6236\u540d\uff0c\u53ef\u4ee5\u5728\u4f7f\u7528 -u \u9078\u9805\u904b\u884c ansible-playbook \u547d\u4ee4\u6642\u5728\u57f7\u884c\u6642\u5b9a\u7fa9\u3002\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u4ee5 vagrant \u7684\u8eab\u4efd\u9032\u884c\u9023\u63a5\uff1a $ ansible-playbook -i inventory playbook-08.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Create root file] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Create user file] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u8b93\u6211\u5011\u767b\u5165\u5230\u9019\u53f0VM\u53bb\u9a57\u8b49: $ vagrant ssh $ ls -la /tmp/my_file* -rw-r--r-- 1 root root 0 Jun 9 23 :37 /tmp/my_file_root \u6709\u95dc Ansible \u4e2d\u6b0a\u9650\u63d0\u5347\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u4e86\u89e3\u6b0a\u9650\u63d0\u5347"},{"location":"ansible/tutorial_playbook/understanding-privilege-escalation-in-ansible-playbooks/#ansible-playbook","text":"\u5c31\u50cf\u60a8\u5728\u7d42\u7aef\u4e0a\u57f7\u884c\u7684\u5e38\u898f\u547d\u4ee4\u4e00\u6a23\uff0c\u67d0\u4e9b\u4efb\u52d9\u9700\u8981\u7279\u6b8a\u6b0a\u9650\u624d\u80fd\u8b93 Ansible \u5728\u60a8\u7684\u9060\u7a0b\u7bc0\u9ede\u4e0a\u6210\u529f\u57f7\u884c\u5b83\u5011\u3002 \u4e86\u89e3\u6b0a\u9650\u63d0\u6607\u5728 Ansible \u4e2d\u7684\u5de5\u4f5c\u539f\u7406\u975e\u5e38\u91cd\u8981\uff0c\u9019\u6a23\u60a8\u5c31\u53ef\u4ee5\u4f7f\u7528\u9069\u7576\u7684\u6b0a\u9650\u57f7\u884c\u4efb\u52d9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4efb\u52d9\u5c07\u4ee5\u9023\u63a5\u7528\u6236\u8eab\u4efd\u904b\u884c - \u9019\u53ef\u80fd\u662f root \u6216\u4efb\u4f55\u5177\u6709 SSH \u8a2a\u554f\u6e05\u55ae\u6587\u4ef6\u4e2d\u9060\u7a0b\u7bc0\u9ede\u7684\u5e38\u898f\u7528\u6236\u3002 \u8981\u904b\u884c\u5177\u6709\u64f4\u5c55\u6b0a\u9650\u7684\u547d\u4ee4\uff0c\u4f8b\u5982\u9700\u8981 sudo \u7684\u547d\u4ee4\uff0c\u60a8\u9700\u8981\u5728 playbook \u4e2d\u5305\u542b\u8a2d\u5b9a become \u6307\u4ee4\u3002\u9019\u53ef\u4ee5\u4f5c\u70ba\u5c0d\u8a72 playbook \u4e2d\u6240\u6709\u4efb\u52d9\u6709\u6548\u7684\u5168\u5c40\u8a2d\u7f6e\u4f86\u5b8c\u6210\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba\u6bcf\u500b\u4efb\u52d9\u61c9\u7528\u7684\u55ae\u7368\u6307\u4ee4\u4f86\u5b8c\u6210\u3002\u6839\u64da\u60a8\u7684 sudo \u7528\u6236\u5728\u9060\u7a0b\u7bc0\u9ede\u4e2d\u7684\u8a2d\u7f6e\u65b9\u5f0f\uff0c\u60a8\u53ef\u80fd\u9084\u9700\u8981\u63d0\u4f9b\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002\u4ee5\u4e0b\u793a\u4f8b\u66f4\u65b0 apt \u7de9\u5b58\uff0c\u9019\u662f\u4e00\u9805\u9700\u8981 root \u6b0a\u9650\u7684\u4efb\u52d9\u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-07.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-07.yml --- - hosts : all become : yes tasks : - name : Update apt cache apt : update_cache : yes \u8981\u904b\u884c\u9019\u500b playbook\uff0c\u60a8\u9700\u8981\u5728 ansible-playbook \u547d\u4ee4\u4e2d\u5305\u542b -K \u9078\u9805\u3002\u9019\u5c07\u4f7f Ansible \u63d0\u793a\u60a8\u8f38\u5165\u6307\u5b9a\u7528\u6236\u7684 sudo \u5bc6\u78bc\u3002 $ ansible-playbook -i inventory playbook-07.yml -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Update apt cache] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=2 changed=1 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u60a8\u9084\u53ef\u4ee5\u5728\u57f7\u884c\u4efb\u52d9\u6216\u64ad\u653e\u6642\u66f4\u6539\u8981\u5207\u63db\u5230\u7684\u7528\u6236\u3002\u70ba\u6b64\uff0c\u8acb\u5c07 become_user \u6307\u4ee4\u8a2d\u7f6e\u70ba\u60a8\u8981\u5207\u63db\u5230\u7684\u9060\u7a0b\u7528\u6236\u7684\u540d\u7a31\u3002\u7576\u60a8\u5728 playbook \u4e2d\u6709\u591a\u500b\u4f9d\u8cf4 sudo \u7684\u4efb\u52d9\u6642\uff0c\u9019\u5f88\u6709\u7528\uff0c\u4f46\u4e5f\u6709\u4e00\u4e9b\u4efb\u52d9\u61c9\u8a72\u4f5c\u70ba\u60a8\u7684\u666e\u901a\u7528\u6236\u904b\u884c\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u672c\u6b21\u64ad\u653e\u4e2d\u7684\u6240\u6709\u4efb\u52d9\u9ed8\u8a8d\u4f7f\u7528 sudo \u57f7\u884c\u3002\u9019\u662f\u5728\u64ad\u653e\u7d1a\u5225\u8a2d\u7f6e\u7684\uff0c\u5c31\u5728\u4e3b\u6a5f\u5b9a\u7fa9\u4e4b\u5f8c\u3002\u7b2c\u4e00\u500b\u4efb\u52d9\u4f7f\u7528 root \u6b0a\u9650\u5728 /tmp \u4e0a\u5275\u5efa\u4e00\u500b\u6587\u4ef6\uff0c\u56e0\u70ba\u9019\u662f\u9ed8\u8a8d\u7684 become_user \u503c\u3002\u7136\u800c\uff0c\u6700\u5f8c\u4e00\u500b\u4efb\u52d9\u5b9a\u7fa9\u4e86\u5b83\u81ea\u5df1\u7684 become_user \u3002 \u5728\u4f60\u7684 ansible-practice \u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba playbook-08.yml \u7684\u65b0\u6587\u4ef6\uff1a playbook-08.yml --- - hosts : all become : yes vars : user : \"{{ ansible_env.USER }}\" tasks : - name : Create root file file : path : /tmp/my_file_root state : touch - name : Create user file become_user : \"{{ user }}\" file : path : /tmp/my_file_{{ user }} state : touch ansible_env.USER \u7684\u4e8b\u5be6(fact)\u5305\u542b\u9023\u63a5\u7528\u6236\u7684\u7528\u6236\u540d\uff0c\u53ef\u4ee5\u5728\u4f7f\u7528 -u \u9078\u9805\u904b\u884c ansible-playbook \u547d\u4ee4\u6642\u5728\u57f7\u884c\u6642\u5b9a\u7fa9\u3002\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u4ee5 vagrant \u7684\u8eab\u4efd\u9032\u884c\u9023\u63a5\uff1a $ ansible-playbook -i inventory playbook-08.yml -u vagrant -K \u7d50\u679c: BECOME password: PLAY [all] ***************************************************************************************************************************************************************** TASK [Gathering Facts] ***************************************************************************************************************************************************** ok: [demo-vm] TASK [Create root file] **************************************************************************************************************************************************** changed: [demo-vm] TASK [Create user file] **************************************************************************************************************************************************** changed: [demo-vm] PLAY RECAP ***************************************************************************************************************************************************************** demo-vm : ok=3 changed=2 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0 \u8b93\u6211\u5011\u767b\u5165\u5230\u9019\u53f0VM\u53bb\u9a57\u8b49: $ vagrant ssh $ ls -la /tmp/my_file* -rw-r--r-- 1 root root 0 Jun 9 23 :37 /tmp/my_file_root \u6709\u95dc Ansible \u4e2d\u6b0a\u9650\u63d0\u5347\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u4e86\u89e3 Ansible Playbook \u4e2d\u7684\u6b0a\u9650\u63d0\u5347"},{"location":"argocd/applicationset/argo-cd-integration/","text":"ApplicationSet \u63a7\u5236\u5668\u5982\u4f55\u8207 Argo CD \u4ea4\u4e92 \u00b6 \u7576\u60a8\u5275\u5efa\u3001\u66f4\u65b0\u6216\u522a\u9664 ApplicationSet \u8cc7\u6e90\u6642\uff0cApplicationSet \u63a7\u5236\u5668\u6703\u901a\u904e\u5275\u5efa\u3001\u66f4\u65b0\u6216\u522a\u9664\u4e00\u500b\u6216\u591a\u500b\u76f8\u61c9\u7684 Argo CD Application \u8cc7\u6e90\u4f86\u97ff\u61c9\u3002 \u4e8b\u5be6\u4e0a\uff0cApplicationSet \u63a7\u5236\u5668\u7684\u552f\u4e00\u8077\u8cac\u662f\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u5167\u5275\u5efa\u3001\u66f4\u65b0\u548c\u522a\u9664 Application \u8cc7\u6e90\u3002\u63a7\u5236\u5668\u7684\u552f\u4e00\u5de5\u4f5c\u662f\u78ba\u4fdd Application \u8cc7\u6e90\u8207\u5b9a\u7fa9\u7684\u8072\u660e\u6027 ApplicationSet \u8cc7\u6e90\u4fdd\u6301\u4e00\u81f4\uff0c\u50c5\u6b64\u800c\u5df2\u3002 \u56e0\u6b64 ApplicationSet \u63a7\u5236\u5668\uff1a \u4e0d\u5275\u5efa/\u4fee\u6539/\u522a\u9664 Kubernetes \u8cc7\u6e90\uff08 Application CR \u9664\u5916\uff09 \u4e0d\u9023\u63a5\u5230\u90e8\u7f72 Argo CD \u4ee5\u5916\u7684\u96c6\u7fa4 \u4e0d\u8207\u90e8\u7f72 Argo CD \u4ee5\u5916\u7684\u547d\u540d\u7a7a\u9593\u4ea4\u4e92 \u662f Argo CD \u672c\u8eab\u8ca0\u8cac\u5be6\u969b\u90e8\u7f72\u751f\u6210\u7684\u5b50 Application \u8cc7\u6e90\uff0c\u4f8b\u5982 Deployments\u3001Services \u548c ConfigMaps\u3002 ApplicationSet \u63a7\u5236\u5668\u56e0\u6b64\u53ef\u4ee5\u88ab\u8a8d\u70ba\u662f\u4e00\u500b Application \u201c\u5de5\u5ee0\u201d\uff0c\u5c07\u4e00\u500b ApplicationSet \u8cc7\u6e90\u4f5c\u70ba\u8f38\u5165\uff0c\u4e26\u8f38\u51fa\u4e00\u500b\u6216\u591a\u500b\u8207\u8a72\u96c6\u5408\u7684\u53c3\u6578\u76f8\u5c0d\u61c9\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u3002 \u5728\u6b64\u5716\u4e2d\uff0c\u5b9a\u7fa9\u4e86\u4e00\u500b ApplicationSet \u8cc7\u6e90\uff0cApplicationSet \u63a7\u5236\u5668\u8ca0\u8cac\u5275\u5efa\u76f8\u61c9\u7684 Application \u8cc7\u6e90\u3002\u751f\u6210\u7684\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7136\u5f8c\u7531 Argo CD \u7ba1\u7406\uff1a\u5373 Argo CD \u8ca0\u8cac\u5be6\u969b\u90e8\u7f72\u5b50\u8cc7\u6e90\u3002 Argo CD \u6839\u64da Application \u898f\u7bc4\u5b57\u6bb5\u4e2d\u5b9a\u7fa9\u7684 Git \u5b58\u5132\u5eab\u7684\u5167\u5bb9\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u8cc7\u6e90\uff0c\u90e8\u7f72\u4f8b\u5982\u90e8\u7f72\u3001\u670d\u52d9\u548c\u5176\u4ed6\u8cc7\u6e90\u3002 ApplicationSet \u7684\u5275\u5efa\u3001\u66f4\u65b0\u6216\u522a\u9664\u5c07\u76f4\u63a5\u5f71\u97ff Argo CD \u547d\u540d\u7a7a\u9593\u4e2d\u7684 Application \u3002\u540c\u6a23\uff0c\u96c6\u7fa4\u4e8b\u4ef6\uff08\u4f7f\u7528\u96c6\u7fa4\u751f\u6210\u5668\u6642\u6dfb\u52a0/\u522a\u9664 Argo CD \u96c6\u7fa4\u6a5f\u5bc6\uff09\u6216 Git \u4e2d\u7684\u66f4\u6539\uff08\u4f7f\u7528 Git \u751f\u6210\u5668\u6642\uff09\u5c07\u7528\u4f5c ApplicationSet \u63a7\u5236\u5668\u7684\u8f38\u5165\uff0c\u4ee5\u69cb\u5efa\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u3002 Argo CD \u548c ApplicationSet \u63a7\u5236\u5668\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u78ba\u4fdd\u5b58\u5728\u4e00\u7d44\u4e00\u81f4\u7684 Application \u8cc7\u6e90\uff0c\u4e26\u8de8\u76ee\u6a19\u96c6\u7fa4\u90e8\u7f72\u3002","title":"ApplicationSet \u63a7\u5236\u5668\u8207 Argo CD \u6574\u5408"},{"location":"argocd/applicationset/argo-cd-integration/#applicationset-argo-cd","text":"\u7576\u60a8\u5275\u5efa\u3001\u66f4\u65b0\u6216\u522a\u9664 ApplicationSet \u8cc7\u6e90\u6642\uff0cApplicationSet \u63a7\u5236\u5668\u6703\u901a\u904e\u5275\u5efa\u3001\u66f4\u65b0\u6216\u522a\u9664\u4e00\u500b\u6216\u591a\u500b\u76f8\u61c9\u7684 Argo CD Application \u8cc7\u6e90\u4f86\u97ff\u61c9\u3002 \u4e8b\u5be6\u4e0a\uff0cApplicationSet \u63a7\u5236\u5668\u7684\u552f\u4e00\u8077\u8cac\u662f\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u5167\u5275\u5efa\u3001\u66f4\u65b0\u548c\u522a\u9664 Application \u8cc7\u6e90\u3002\u63a7\u5236\u5668\u7684\u552f\u4e00\u5de5\u4f5c\u662f\u78ba\u4fdd Application \u8cc7\u6e90\u8207\u5b9a\u7fa9\u7684\u8072\u660e\u6027 ApplicationSet \u8cc7\u6e90\u4fdd\u6301\u4e00\u81f4\uff0c\u50c5\u6b64\u800c\u5df2\u3002 \u56e0\u6b64 ApplicationSet \u63a7\u5236\u5668\uff1a \u4e0d\u5275\u5efa/\u4fee\u6539/\u522a\u9664 Kubernetes \u8cc7\u6e90\uff08 Application CR \u9664\u5916\uff09 \u4e0d\u9023\u63a5\u5230\u90e8\u7f72 Argo CD \u4ee5\u5916\u7684\u96c6\u7fa4 \u4e0d\u8207\u90e8\u7f72 Argo CD \u4ee5\u5916\u7684\u547d\u540d\u7a7a\u9593\u4ea4\u4e92 \u662f Argo CD \u672c\u8eab\u8ca0\u8cac\u5be6\u969b\u90e8\u7f72\u751f\u6210\u7684\u5b50 Application \u8cc7\u6e90\uff0c\u4f8b\u5982 Deployments\u3001Services \u548c ConfigMaps\u3002 ApplicationSet \u63a7\u5236\u5668\u56e0\u6b64\u53ef\u4ee5\u88ab\u8a8d\u70ba\u662f\u4e00\u500b Application \u201c\u5de5\u5ee0\u201d\uff0c\u5c07\u4e00\u500b ApplicationSet \u8cc7\u6e90\u4f5c\u70ba\u8f38\u5165\uff0c\u4e26\u8f38\u51fa\u4e00\u500b\u6216\u591a\u500b\u8207\u8a72\u96c6\u5408\u7684\u53c3\u6578\u76f8\u5c0d\u61c9\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u3002 \u5728\u6b64\u5716\u4e2d\uff0c\u5b9a\u7fa9\u4e86\u4e00\u500b ApplicationSet \u8cc7\u6e90\uff0cApplicationSet \u63a7\u5236\u5668\u8ca0\u8cac\u5275\u5efa\u76f8\u61c9\u7684 Application \u8cc7\u6e90\u3002\u751f\u6210\u7684\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7136\u5f8c\u7531 Argo CD \u7ba1\u7406\uff1a\u5373 Argo CD \u8ca0\u8cac\u5be6\u969b\u90e8\u7f72\u5b50\u8cc7\u6e90\u3002 Argo CD \u6839\u64da Application \u898f\u7bc4\u5b57\u6bb5\u4e2d\u5b9a\u7fa9\u7684 Git \u5b58\u5132\u5eab\u7684\u5167\u5bb9\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u8cc7\u6e90\uff0c\u90e8\u7f72\u4f8b\u5982\u90e8\u7f72\u3001\u670d\u52d9\u548c\u5176\u4ed6\u8cc7\u6e90\u3002 ApplicationSet \u7684\u5275\u5efa\u3001\u66f4\u65b0\u6216\u522a\u9664\u5c07\u76f4\u63a5\u5f71\u97ff Argo CD \u547d\u540d\u7a7a\u9593\u4e2d\u7684 Application \u3002\u540c\u6a23\uff0c\u96c6\u7fa4\u4e8b\u4ef6\uff08\u4f7f\u7528\u96c6\u7fa4\u751f\u6210\u5668\u6642\u6dfb\u52a0/\u522a\u9664 Argo CD \u96c6\u7fa4\u6a5f\u5bc6\uff09\u6216 Git \u4e2d\u7684\u66f4\u6539\uff08\u4f7f\u7528 Git \u751f\u6210\u5668\u6642\uff09\u5c07\u7528\u4f5c ApplicationSet \u63a7\u5236\u5668\u7684\u8f38\u5165\uff0c\u4ee5\u69cb\u5efa\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u3002 Argo CD \u548c ApplicationSet \u63a7\u5236\u5668\u4e00\u8d77\u5de5\u4f5c\uff0c\u4ee5\u78ba\u4fdd\u5b58\u5728\u4e00\u7d44\u4e00\u81f4\u7684 Application \u8cc7\u6e90\uff0c\u4e26\u8de8\u76ee\u6a19\u96c6\u7fa4\u90e8\u7f72\u3002","title":"ApplicationSet \u63a7\u5236\u5668\u5982\u4f55\u8207 Argo CD \u4ea4\u4e92"},{"location":"argocd/applicationset/intro/","text":"ApplicationSet \u63a7\u5236\u5668\u7c21\u4ecb \u00b6 \u539f\u6587: https://argocd-applicationset.readthedocs.io/en/stable/ ApplicationSet \u63a7\u5236\u5668\u662f\u4e00\u500b Kubernetes \u63a7\u5236\u5668 \uff0c\u5b83\u589e\u52a0\u4e86\u5c0d ApplicationSet CustomResourceDefinition (CRD) \u7684\u652f\u6301\u3002\u5728\u8de8\u5927\u91cf\u96c6\u7fa4\u548c monorepos \u7ba1\u7406 Argo CD \u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u6b64\u63a7\u5236\u5668/CRD \u53ef\u5be6\u73fe\u81ea\u52d5\u5316\u548c\u66f4\u5927\u7684\u9748\u6d3b\u6027\uff0c\u6b64\u5916\uff0c\u5b83\u9084\u53ef\u4ee5\u5728\u591a\u79df\u6236 Kubernetes \u96c6\u7fa4\u4e0a\u4f7f\u7528\u81ea\u52a9\u670d\u52d9\u3002 ApplicationSet \u63a7\u5236\u5668\u8207\u73fe\u6709\u7684 Argo CD \u5b89\u88dd \u4e00\u8d77\u5de5\u4f5c\u3002 Argo CD \u662f\u4e00\u500b\u8072\u660e\u6027\u7684 GitOps \u6301\u7e8c\u4ea4\u4ed8\u5de5\u5177\uff0c\u5b83\u5141\u8a31\u958b\u767c\u4eba\u54e1\u5728\u5176\u73fe\u6709\u7684 Git \u5de5\u4f5c\u6d41\u4e2d\u5b9a\u7fa9\u548c\u63a7\u5236 Kubernetes \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7684\u90e8\u7f72\u3002 ApplicationSet \u63a7\u5236\u5668\u8207 Argo CD \u4e00\u8d77\u88ab\u5b89\u88dd\uff0c\u5b83\u901a\u904e\u6dfb\u52a0\u984d\u5916\u7684\u529f\u80fd\u4f86\u652f\u6301\u4ee5\u96c6\u7fa4\u7ba1\u7406\u54e1\u70ba\u4e2d\u5fc3\u7684\u5834\u666f\u4f86\u88dc\u5145 Argo CD \u7ba1\u7406\u7684\u529f\u80fd\u3002 ApplicationSet \u63a7\u5236\u5668\u63d0\u4f9b\uff1a \u901a\u904e Argo CD \u4f7f\u7528\u55ae\u500b Kubernetes \u6e05\u55ae\u4f86\u5b9a\u4f4d\u591a\u500b Kubernetes \u96c6\u7fa4\u7684\u80fd\u529b \u4f7f\u7528\u55ae\u500b Kubernetes \u6e05\u55ae\u901a\u904e Argo CD \u5f9e\u4e00\u500b\u6216\u591a\u500b Git \u5b58\u5132\u5eab\u90e8\u7f72\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u80fd\u529b \u6539\u9032\u4e86\u5c0d monorepos \u7684\u652f\u6301\uff1a\u5728 Argo CD \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0cmonorepo \u662f\u5728\u55ae\u500b Git \u5b58\u5132\u5eab\u4e2d\u5b9a\u7fa9\u7684\u591a\u500b Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90 \u5728\u591a\u79df\u6236\u96c6\u7fa4\u4e2d\uff0c\u63d0\u9ad8\u55ae\u500b\u96c6\u7fa4\u79df\u6236\u4f7f\u7528 Argo CD \u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u7684\u80fd\u529b\uff08\u7121\u9700\u8b93\u7279\u6b0a\u96c6\u7fa4\u7ba1\u7406\u54e1\u53c3\u8207\u555f\u7528\u76ee\u6a19\u96c6\u7fa4/\u547d\u540d\u7a7a\u9593\uff09 ApplicationSet \u8cc7\u6e90 \u00b6 \u9019\u500b\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u4e00\u500b\u65b0\u7684 ApplicationSet \u985e\u578b\u7684\u7559\u8a00\u7c3f\u8cc7\u6e90\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - list : elements : - cluster : engineering-dev url : https://1.2.3.4 - cluster : engineering-prod url : https://2.4.6.8 - cluster : finance-preprod url : https://9.8.7.6 template : metadata : name : '{{cluster}}-guestbook' spec : source : repoURL : https://github.com/infra-team/cluster-deployments.git targetRevision : HEAD path : guestbook/{{cluster}} destination : server : '{{url}}' namespace : guestbook \u96d6\u7136\u6709\u591a\u7a2e\u985e\u578b\u7684\u751f\u6210\u5668\u53ef\u7528\u65bc ApplicationSet \u8cc7\u6e90\uff0c\u4f46\u6b64\u793a\u4f8b\u4f7f\u7528 List generator \uff0c\u5b83\u53ea\u5305\u542b\u4e00\u500b\u56fa\u5b9a\u7684\u3001\u8981\u5b9a\u4f4d\u7684\u96c6\u7fa4\u7684\u6587\u5b57\u5217\u8868\u3002\u4e00\u65e6 ApplicationSet \u63a7\u5236\u5668\u8655\u7406\u4e86 ApplicationSet \u8cc7\u6e90\uff0c\u6b64\u96c6\u7fa4\u5217\u8868\u5c07\u662f Argo CD \u90e8\u7f72\u7559\u8a00\u7c3f\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7684\u96c6\u7fa4\u3002 \u751f\u6210\u5668 \uff0c\u4f8b\u5982 List \u751f\u6210\u5668\uff0c\u8ca0\u8cac\u751f\u6210\u53c3\u6578\u3002\u53c3\u6578\u662f\u5728 \u6a21\u677f \u5448\u73fe\u671f\u9593\u66ff\u63db\u5230\u6a21\u677f\u4e2d\u7684\u9375\u503c\u5c0d\uff1aApplicationSet \u8cc7\u6e90\u7684\u90e8\u5206\u3002 ApplicationSet \u63a7\u5236\u5668\u7576\u524d\u652f\u6301\u591a\u7a2e\u751f\u6210\u5668\uff1a List generator \uff1a\u6839\u64da\u96c6\u7fa4\u540d\u7a31/URL\u503c\u7684\u56fa\u5b9a\u5217\u8868\u751f\u6210\u53c3\u6578\uff0c\u5982\u4e0a\u4f8b\u6240\u793a\u3002 Cluster generator \uff1a\u96c6\u7fa4\u751f\u6210\u5668\u4e0d\u662f\u96c6\u7fa4\u7684\u6587\u5b57\u5217\u8868\uff08\u8207\u5217\u8868\u751f\u6210\u5668\u4e00\u6a23\uff09\uff0c\u800c\u662f\u6839\u64da Argo CD \u4e2d\u5b9a\u7fa9\u7684\u96c6\u7fa4\u81ea\u52d5\u751f\u6210\u96c6\u7fa4\u53c3\u6578\u3002 Git generator \uff1aGit \u751f\u6210\u5668\u6839\u64da\u751f\u6210\u5668\u8cc7\u6e90\u4e2d\u5b9a\u7fa9\u7684 Git \u5b58\u5132\u5eab\u4e2d\u5305\u542b\u7684 \u6587\u4ef6 \u6216 \u6587\u4ef6\u593e \u751f\u6210\u53c3\u6578\u3002 \u5305\u542b JSON \u503c\u7684\u6587\u4ef6\u5c07\u88ab\u89e3\u6790\u4e26\u8f49\u63db\u70ba\u6a21\u677f\u53c3\u6578\u3002 Git \u5b58\u5132\u5eab\u4e2d\u7684\u5404\u500b\u76ee\u9304\u8def\u5f91\u4e5f\u53ef\u4ee5\u7528\u4f5c\u53c3\u6578\u503c\u3002 Matrix generator \uff1a\u77e9\u9663\u751f\u6210\u5668\u7d50\u5408\u4e86\u5176\u4ed6\u5169\u500b\u751f\u6210\u5668\u7684\u751f\u6210\u53c3\u6578\u3002 \u6709\u95dc\u55ae\u500b\u751f\u6210\u5668\u4ee5\u53ca\u4e0a\u9762\u672a\u5217\u51fa\u7684\u5176\u4ed6\u751f\u6210\u5668\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u751f\u6210\u5668\u90e8\u5206 \u3002 \u53c3\u6578\u66ff\u63db\u5230\u6a21\u677f\u4e2d \u00b6 \u8207\u4f7f\u7528\u54ea\u500b\u751f\u6210\u5668\u7121\u95dc\uff0c\u751f\u6210\u5668\u751f\u6210\u7684\u53c3\u6578\u88ab\u66ff\u63db\u70ba\u6a21\u677f\u4e2d\u7684 {{parameter name}} \u503c (\u91dd\u5c0d ApplicationSet \u8cc7\u6e90\u7684\u90e8\u5206)\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c List generator \u5b9a\u7fa9\u4e86 cluster \u548c url \u53c3\u6578\uff0c\u7136\u5f8c\u5206\u5225\u66ff\u63db\u70ba\u6a21\u677f\u7684 {{cluster}} \u548c {{url}} \u503c\u3002 \u66ff\u63db\u5f8c\uff0c\u6b64\u7559\u8a00\u7c3f ApplicationSet \u8cc7\u6e90\u5c07\u61c9\u7528\u65bc Kubernetes \u96c6\u7fa4\uff1a ApplicationSet \u63a7\u5236\u5668\u8655\u7406\u751f\u6210\u5668\u689d\u76ee\uff0c\u751f\u6210\u4e00\u7d44 \u6a21\u677f\u53c3\u6578 \u3002 \u9019\u4e9b\u53c3\u6578\u88ab\u66ff\u63db\u5230\u6a21\u677f\u4e2d\uff0c\u6bcf\u7d44\u53c3\u6578\u4e00\u6b21\u3002 \u6bcf\u500b\u6e32\u67d3\u7684\u6a21\u677f\u90fd\u88ab\u8f49\u63db\u70ba Argo CD Application \u8cc7\u6e90\uff0c\u7136\u5f8c\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u5167\u5275\u5efa\uff08\u6216\u66f4\u65b0\uff09\u8a72\u8cc7\u6e90\u3002 \u6700\u5f8c\uff0cArgo CD \u63a7\u5236\u5668\u88ab\u901a\u77e5\u9019\u4e9b Application \u8cc7\u6e90\u4e26\u8ca0\u8cac\u8655\u7406\u5b83\u5011\u3002 \u5728\u6211\u5011\u7684\u793a\u4f8b\u4e2d\u5b9a\u7fa9\u4e86\u4e09\u500b\u4e0d\u540c\u7684\u96c6\u7fa4: engineering-dev \u3001 engineering-prod \u548c finance-preprod \uff0c\u9019\u500b\u8a2d\u5b9a\u5c07\u7522\u751f\u4e09\u500b\u65b0\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\uff1a\u6bcf\u500b\u96c6\u7fa4\u4e00\u500b\u3002 \u4ee5\u4e0b\u662f\u7d93\u53a4\u904e\u4e0a\u8ff0 1.2.3.4 \u6b65\u9a5f\u5f8c\u70ba engineering-dev \u96c6\u7fa4\u6240\u5275\u5efa\u7684 Application \u8cc7\u6e90\u7684\u793a\u4f8b\uff1a apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : engineering-dev-guestbook spec : source : repoURL : https://github.com/infra-team/cluster-deployments.git targetRevision : HEAD path : guestbook/engineering-dev destination : server : https://1.2.3.4 namespace : guestbook \u6211\u5011\u53ef\u4ee5\u770b\u5230\u751f\u6210\u7684\u503c\u5df2\u7d93\u88ab\u66ff\u63db\u5230\u6a21\u677f\u7684 server \u548c path \u5b57\u6bb5\u4e2d\uff0c\u4e26\u4e14\u6a21\u677f\u5df2\u7d93\u88ab\u6e32\u67d3\u6210\u4e00\u500b\u5b8c\u6574\u7684 Argo CD Application \u3002 \u73fe\u5728\u4e5f\u53ef\u4ee5\u5f9e Argo CD UI \u4e2d\u770b\u5230\u61c9\u7528\u7a0b\u5e8f\uff1a ApplicationSet \u63a7\u5236\u5668\u5c07\u78ba\u4fdd\u5c0d ApplicationSet \u8cc7\u6e90\u6240\u505a\u7684\u4efb\u4f55\u66f4\u6539\u3001\u66f4\u65b0\u6216\u522a\u9664\u90fd\u6703\u81ea\u52d5\u61c9\u7528\u65bc\u76f8\u61c9\u7684 Application(s) \u3002 \u4f8b\u5982\uff0c\u5982\u679c\u4e00\u500b\u65b0\u7684\u96c6\u7fa4/URL \u5217\u8868\u689d\u76ee\u88ab\u6dfb\u52a0\u5230\u5217\u8868\u751f\u6210\u5668\uff0c\u4e00\u500b\u65b0\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u5c07\u76f8\u61c9\u5730\u70ba\u9019\u500b\u65b0\u96c6\u7fa4\u5275\u5efa\u3002\u5c0d\u7559\u8a00\u7c3f ApplicationSet \u8cc7\u6e90\u6240\u505a\u7684\u4efb\u4f55\u7de8\u8f2f\u90fd\u6703\u5f71\u97ff\u7531\u8a72\u8cc7\u6e90\u5be6\u4f8b\u5316\u7684\u6240\u6709 Argo CD Application \uff0c\u5305\u62ec\u65b0\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u96d6\u7136 List \u751f\u6210\u5668\u7684\u96c6\u7fa4\u6587\u5b57\u5217\u8868\u76f8\u7576\u7c21\u55ae\uff0c\u4f46 ApplicationSet \u63a7\u5236\u5668\u4e2d\u7684\u5176\u4ed6\u53ef\u7528\u751f\u6210\u5668\u652f\u6301\u66f4\u8907\u96dc\u7684\u5834\u666f\u3002","title":"\u7c21\u4ecb"},{"location":"argocd/applicationset/intro/#applicationset","text":"\u539f\u6587: https://argocd-applicationset.readthedocs.io/en/stable/ ApplicationSet \u63a7\u5236\u5668\u662f\u4e00\u500b Kubernetes \u63a7\u5236\u5668 \uff0c\u5b83\u589e\u52a0\u4e86\u5c0d ApplicationSet CustomResourceDefinition (CRD) \u7684\u652f\u6301\u3002\u5728\u8de8\u5927\u91cf\u96c6\u7fa4\u548c monorepos \u7ba1\u7406 Argo CD \u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u6b64\u63a7\u5236\u5668/CRD \u53ef\u5be6\u73fe\u81ea\u52d5\u5316\u548c\u66f4\u5927\u7684\u9748\u6d3b\u6027\uff0c\u6b64\u5916\uff0c\u5b83\u9084\u53ef\u4ee5\u5728\u591a\u79df\u6236 Kubernetes \u96c6\u7fa4\u4e0a\u4f7f\u7528\u81ea\u52a9\u670d\u52d9\u3002 ApplicationSet \u63a7\u5236\u5668\u8207\u73fe\u6709\u7684 Argo CD \u5b89\u88dd \u4e00\u8d77\u5de5\u4f5c\u3002 Argo CD \u662f\u4e00\u500b\u8072\u660e\u6027\u7684 GitOps \u6301\u7e8c\u4ea4\u4ed8\u5de5\u5177\uff0c\u5b83\u5141\u8a31\u958b\u767c\u4eba\u54e1\u5728\u5176\u73fe\u6709\u7684 Git \u5de5\u4f5c\u6d41\u4e2d\u5b9a\u7fa9\u548c\u63a7\u5236 Kubernetes \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7684\u90e8\u7f72\u3002 ApplicationSet \u63a7\u5236\u5668\u8207 Argo CD \u4e00\u8d77\u88ab\u5b89\u88dd\uff0c\u5b83\u901a\u904e\u6dfb\u52a0\u984d\u5916\u7684\u529f\u80fd\u4f86\u652f\u6301\u4ee5\u96c6\u7fa4\u7ba1\u7406\u54e1\u70ba\u4e2d\u5fc3\u7684\u5834\u666f\u4f86\u88dc\u5145 Argo CD \u7ba1\u7406\u7684\u529f\u80fd\u3002 ApplicationSet \u63a7\u5236\u5668\u63d0\u4f9b\uff1a \u901a\u904e Argo CD \u4f7f\u7528\u55ae\u500b Kubernetes \u6e05\u55ae\u4f86\u5b9a\u4f4d\u591a\u500b Kubernetes \u96c6\u7fa4\u7684\u80fd\u529b \u4f7f\u7528\u55ae\u500b Kubernetes \u6e05\u55ae\u901a\u904e Argo CD \u5f9e\u4e00\u500b\u6216\u591a\u500b Git \u5b58\u5132\u5eab\u90e8\u7f72\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u80fd\u529b \u6539\u9032\u4e86\u5c0d monorepos \u7684\u652f\u6301\uff1a\u5728 Argo CD \u7684\u4e0a\u4e0b\u6587\u4e2d\uff0cmonorepo \u662f\u5728\u55ae\u500b Git \u5b58\u5132\u5eab\u4e2d\u5b9a\u7fa9\u7684\u591a\u500b Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90 \u5728\u591a\u79df\u6236\u96c6\u7fa4\u4e2d\uff0c\u63d0\u9ad8\u55ae\u500b\u96c6\u7fa4\u79df\u6236\u4f7f\u7528 Argo CD \u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u7684\u80fd\u529b\uff08\u7121\u9700\u8b93\u7279\u6b0a\u96c6\u7fa4\u7ba1\u7406\u54e1\u53c3\u8207\u555f\u7528\u76ee\u6a19\u96c6\u7fa4/\u547d\u540d\u7a7a\u9593\uff09","title":"ApplicationSet \u63a7\u5236\u5668\u7c21\u4ecb"},{"location":"argocd/applicationset/intro/#applicationset_1","text":"\u9019\u500b\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u4e00\u500b\u65b0\u7684 ApplicationSet \u985e\u578b\u7684\u7559\u8a00\u7c3f\u8cc7\u6e90\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - list : elements : - cluster : engineering-dev url : https://1.2.3.4 - cluster : engineering-prod url : https://2.4.6.8 - cluster : finance-preprod url : https://9.8.7.6 template : metadata : name : '{{cluster}}-guestbook' spec : source : repoURL : https://github.com/infra-team/cluster-deployments.git targetRevision : HEAD path : guestbook/{{cluster}} destination : server : '{{url}}' namespace : guestbook \u96d6\u7136\u6709\u591a\u7a2e\u985e\u578b\u7684\u751f\u6210\u5668\u53ef\u7528\u65bc ApplicationSet \u8cc7\u6e90\uff0c\u4f46\u6b64\u793a\u4f8b\u4f7f\u7528 List generator \uff0c\u5b83\u53ea\u5305\u542b\u4e00\u500b\u56fa\u5b9a\u7684\u3001\u8981\u5b9a\u4f4d\u7684\u96c6\u7fa4\u7684\u6587\u5b57\u5217\u8868\u3002\u4e00\u65e6 ApplicationSet \u63a7\u5236\u5668\u8655\u7406\u4e86 ApplicationSet \u8cc7\u6e90\uff0c\u6b64\u96c6\u7fa4\u5217\u8868\u5c07\u662f Argo CD \u90e8\u7f72\u7559\u8a00\u7c3f\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7684\u96c6\u7fa4\u3002 \u751f\u6210\u5668 \uff0c\u4f8b\u5982 List \u751f\u6210\u5668\uff0c\u8ca0\u8cac\u751f\u6210\u53c3\u6578\u3002\u53c3\u6578\u662f\u5728 \u6a21\u677f \u5448\u73fe\u671f\u9593\u66ff\u63db\u5230\u6a21\u677f\u4e2d\u7684\u9375\u503c\u5c0d\uff1aApplicationSet \u8cc7\u6e90\u7684\u90e8\u5206\u3002 ApplicationSet \u63a7\u5236\u5668\u7576\u524d\u652f\u6301\u591a\u7a2e\u751f\u6210\u5668\uff1a List generator \uff1a\u6839\u64da\u96c6\u7fa4\u540d\u7a31/URL\u503c\u7684\u56fa\u5b9a\u5217\u8868\u751f\u6210\u53c3\u6578\uff0c\u5982\u4e0a\u4f8b\u6240\u793a\u3002 Cluster generator \uff1a\u96c6\u7fa4\u751f\u6210\u5668\u4e0d\u662f\u96c6\u7fa4\u7684\u6587\u5b57\u5217\u8868\uff08\u8207\u5217\u8868\u751f\u6210\u5668\u4e00\u6a23\uff09\uff0c\u800c\u662f\u6839\u64da Argo CD \u4e2d\u5b9a\u7fa9\u7684\u96c6\u7fa4\u81ea\u52d5\u751f\u6210\u96c6\u7fa4\u53c3\u6578\u3002 Git generator \uff1aGit \u751f\u6210\u5668\u6839\u64da\u751f\u6210\u5668\u8cc7\u6e90\u4e2d\u5b9a\u7fa9\u7684 Git \u5b58\u5132\u5eab\u4e2d\u5305\u542b\u7684 \u6587\u4ef6 \u6216 \u6587\u4ef6\u593e \u751f\u6210\u53c3\u6578\u3002 \u5305\u542b JSON \u503c\u7684\u6587\u4ef6\u5c07\u88ab\u89e3\u6790\u4e26\u8f49\u63db\u70ba\u6a21\u677f\u53c3\u6578\u3002 Git \u5b58\u5132\u5eab\u4e2d\u7684\u5404\u500b\u76ee\u9304\u8def\u5f91\u4e5f\u53ef\u4ee5\u7528\u4f5c\u53c3\u6578\u503c\u3002 Matrix generator \uff1a\u77e9\u9663\u751f\u6210\u5668\u7d50\u5408\u4e86\u5176\u4ed6\u5169\u500b\u751f\u6210\u5668\u7684\u751f\u6210\u53c3\u6578\u3002 \u6709\u95dc\u55ae\u500b\u751f\u6210\u5668\u4ee5\u53ca\u4e0a\u9762\u672a\u5217\u51fa\u7684\u5176\u4ed6\u751f\u6210\u5668\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u751f\u6210\u5668\u90e8\u5206 \u3002","title":"ApplicationSet \u8cc7\u6e90"},{"location":"argocd/applicationset/intro/#_1","text":"\u8207\u4f7f\u7528\u54ea\u500b\u751f\u6210\u5668\u7121\u95dc\uff0c\u751f\u6210\u5668\u751f\u6210\u7684\u53c3\u6578\u88ab\u66ff\u63db\u70ba\u6a21\u677f\u4e2d\u7684 {{parameter name}} \u503c (\u91dd\u5c0d ApplicationSet \u8cc7\u6e90\u7684\u90e8\u5206)\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c List generator \u5b9a\u7fa9\u4e86 cluster \u548c url \u53c3\u6578\uff0c\u7136\u5f8c\u5206\u5225\u66ff\u63db\u70ba\u6a21\u677f\u7684 {{cluster}} \u548c {{url}} \u503c\u3002 \u66ff\u63db\u5f8c\uff0c\u6b64\u7559\u8a00\u7c3f ApplicationSet \u8cc7\u6e90\u5c07\u61c9\u7528\u65bc Kubernetes \u96c6\u7fa4\uff1a ApplicationSet \u63a7\u5236\u5668\u8655\u7406\u751f\u6210\u5668\u689d\u76ee\uff0c\u751f\u6210\u4e00\u7d44 \u6a21\u677f\u53c3\u6578 \u3002 \u9019\u4e9b\u53c3\u6578\u88ab\u66ff\u63db\u5230\u6a21\u677f\u4e2d\uff0c\u6bcf\u7d44\u53c3\u6578\u4e00\u6b21\u3002 \u6bcf\u500b\u6e32\u67d3\u7684\u6a21\u677f\u90fd\u88ab\u8f49\u63db\u70ba Argo CD Application \u8cc7\u6e90\uff0c\u7136\u5f8c\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u5167\u5275\u5efa\uff08\u6216\u66f4\u65b0\uff09\u8a72\u8cc7\u6e90\u3002 \u6700\u5f8c\uff0cArgo CD \u63a7\u5236\u5668\u88ab\u901a\u77e5\u9019\u4e9b Application \u8cc7\u6e90\u4e26\u8ca0\u8cac\u8655\u7406\u5b83\u5011\u3002 \u5728\u6211\u5011\u7684\u793a\u4f8b\u4e2d\u5b9a\u7fa9\u4e86\u4e09\u500b\u4e0d\u540c\u7684\u96c6\u7fa4: engineering-dev \u3001 engineering-prod \u548c finance-preprod \uff0c\u9019\u500b\u8a2d\u5b9a\u5c07\u7522\u751f\u4e09\u500b\u65b0\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\uff1a\u6bcf\u500b\u96c6\u7fa4\u4e00\u500b\u3002 \u4ee5\u4e0b\u662f\u7d93\u53a4\u904e\u4e0a\u8ff0 1.2.3.4 \u6b65\u9a5f\u5f8c\u70ba engineering-dev \u96c6\u7fa4\u6240\u5275\u5efa\u7684 Application \u8cc7\u6e90\u7684\u793a\u4f8b\uff1a apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : engineering-dev-guestbook spec : source : repoURL : https://github.com/infra-team/cluster-deployments.git targetRevision : HEAD path : guestbook/engineering-dev destination : server : https://1.2.3.4 namespace : guestbook \u6211\u5011\u53ef\u4ee5\u770b\u5230\u751f\u6210\u7684\u503c\u5df2\u7d93\u88ab\u66ff\u63db\u5230\u6a21\u677f\u7684 server \u548c path \u5b57\u6bb5\u4e2d\uff0c\u4e26\u4e14\u6a21\u677f\u5df2\u7d93\u88ab\u6e32\u67d3\u6210\u4e00\u500b\u5b8c\u6574\u7684 Argo CD Application \u3002 \u73fe\u5728\u4e5f\u53ef\u4ee5\u5f9e Argo CD UI \u4e2d\u770b\u5230\u61c9\u7528\u7a0b\u5e8f\uff1a ApplicationSet \u63a7\u5236\u5668\u5c07\u78ba\u4fdd\u5c0d ApplicationSet \u8cc7\u6e90\u6240\u505a\u7684\u4efb\u4f55\u66f4\u6539\u3001\u66f4\u65b0\u6216\u522a\u9664\u90fd\u6703\u81ea\u52d5\u61c9\u7528\u65bc\u76f8\u61c9\u7684 Application(s) \u3002 \u4f8b\u5982\uff0c\u5982\u679c\u4e00\u500b\u65b0\u7684\u96c6\u7fa4/URL \u5217\u8868\u689d\u76ee\u88ab\u6dfb\u52a0\u5230\u5217\u8868\u751f\u6210\u5668\uff0c\u4e00\u500b\u65b0\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u5c07\u76f8\u61c9\u5730\u70ba\u9019\u500b\u65b0\u96c6\u7fa4\u5275\u5efa\u3002\u5c0d\u7559\u8a00\u7c3f ApplicationSet \u8cc7\u6e90\u6240\u505a\u7684\u4efb\u4f55\u7de8\u8f2f\u90fd\u6703\u5f71\u97ff\u7531\u8a72\u8cc7\u6e90\u5be6\u4f8b\u5316\u7684\u6240\u6709 Argo CD Application \uff0c\u5305\u62ec\u65b0\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u96d6\u7136 List \u751f\u6210\u5668\u7684\u96c6\u7fa4\u6587\u5b57\u5217\u8868\u76f8\u7576\u7c21\u55ae\uff0c\u4f46 ApplicationSet \u63a7\u5236\u5668\u4e2d\u7684\u5176\u4ed6\u53ef\u7528\u751f\u6210\u5668\u652f\u6301\u66f4\u8907\u96dc\u7684\u5834\u666f\u3002","title":"\u53c3\u6578\u66ff\u63db\u5230\u6a21\u677f\u4e2d"},{"location":"argocd/applicationset/template/","text":"Templates \u00b6 ApplicationSet spec \u7684\u6a21\u677f\u5b57\u6bb5\u7528\u65bc\u751f\u6210 Argo CD Application \u8cc7\u6e90\u3002 Template fields \u00b6 \u901a\u904e\u5c07\u4f86\u81ea\u751f\u6210\u5668\u7684\u53c3\u6578\u8207\u6a21\u677f\u7684\u5b57\u6bb5\uff08\u901a\u904e {{values}} \uff09\u7d44\u5408\u4f86\u5275\u5efa Argo CD \u61c9\u7528\u7a0b\u5e8f\uff0c\u4e26\u5f9e\u4e2d\u751f\u6210\u5177\u9ad4\u7684\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u4e26\u5c07\u5176\u61c9\u7528\u65bc\u96c6\u7fa4\u3002 \u9019\u662f\u4f86\u81ea\u96c6\u7fa4\u751f\u6210\u5668\u7684\u6a21\u677f subfields \uff1a # (...) template : metadata : name : '{{cluster}}-guestbook' spec : source : repoURL : https://github.com/infra-team/cluster-deployments.git targetRevision : HEAD path : guestbook/{{cluster}} destination : server : '{{url}}' namespace : guestbook \u6a21\u677f subfields \u76f4\u63a5\u5c0d\u61c9\u65bc Argo CD Application \u8cc7\u6e90\u7684\u898f\u7bc4 \uff1a project \u662f\u6307\u6b63\u5728\u4f7f\u7528\u7684 Argo CD \u9805\u76ee \uff08\u9019\u88e1\u53ef\u4ee5\u4f7f\u7528\u9ed8\u8a8d\u503c\u4f86\u5229\u7528\u9ed8\u8a8d\u7684 Argo CD \u9805\u76ee\uff09 source \u5b9a\u7fa9\u5f9e\u54ea\u500b Git \u5b58\u5132\u5eab\u4e2d\u63d0\u53d6\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae repoURL \uff1a\u5b58\u5132\u5eab\u7684 URL\uff08\u4f8b\u5982 https://github.com/argoproj/argocd-example-apps.git \uff09 targetRevision \uff1a\u5b58\u5132\u5eab\u7684\u4fee\u8a02\u7248\uff08\u6a19\u7c64/\u5206\u652f/\u63d0\u4ea4\uff09\uff08\u4f8b\u5982 HEAD\uff09 path \uff1aKubernetes \u6e05\u55ae\uff08\u548c/\u6216 Helm\u3001Kustomize\u3001Jsonnet \u8cc7\u6e90\uff09\u6240\u5728\u7684\u5b58\u5132\u5eab\u4e2d\u7684\u8def\u5f91 destination \uff1a\u5b9a\u7fa9\u8981\u90e8\u7f72\u5230\u54ea\u500b Kubernetes \u96c6\u7fa4/\u547d\u540d\u7a7a\u9593 name \uff1a\u8981\u90e8\u7f72\u5230\u7684\u96c6\u7fa4\u7684\u540d\u7a31\uff08\u5728 Argo CD \u4e2d\uff09 server \uff1a\u96c6\u7fa4\u7684 API Server URL\uff08\u4f8b\u5982\uff1a https://kubernetes.default.svc \uff09 namespace \uff1a\u5f9e source \u90e8\u7f72\u6e05\u55ae\u7684\u76ee\u6a19\u547d\u540d\u7a7a\u9593\uff08\u793a\u4f8b\uff1amy-app-namespace\uff09 Info \u5f15\u7528\u7684\u96c6\u7fa4\u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0cApplicationSet \u63a7\u5236\u5668\u624d\u80fd\u4f7f\u7528\u5b83\u5011 \u53ea\u80fd\u6307\u5b9a name \u6216 server \u4e4b\u4e00\uff1a\u5982\u679c\u5169\u8005\u90fd\u6307\u5b9a\uff0c\u5247\u8fd4\u56de\u932f\u8aa4\u3002 \u6a21\u677f\u7684\u5143\u6578\u64da\u5b57\u6bb5\u4e5f\u53ef\u7528\u65bc\u8a2d\u7f6e\u61c9\u7528\u7a0b\u5e8f\u540d\u7a31\uff0c\u6216\u70ba\u61c9\u7528\u7a0b\u5e8f\u6dfb\u52a0\u6a19\u7c64\u6216\u8a3b\u91cb\u3002 \u96d6\u7136 ApplicationSet \u898f\u7bc4\u63d0\u4f9b\u4e86\u4e00\u7a2e\u57fa\u672c\u7684\u6a21\u677f\u5f62\u5f0f\uff0c\u4f46\u5b83\u4e26\u4e0d\u6253\u7b97\u53d6\u4ee3 Kustomize\u3001Helm \u6216 Jsonnet \u7b49\u5de5\u5177\u7684\u6210\u719f\u914d\u7f6e\u7ba1\u7406\u529f\u80fd\u3002 Generator templates \u00b6 \u9664\u4e86\u5728 ApplicationSet \u8cc7\u6e90\u7684 .spec.template \u4e2d\u6307\u5b9a\u6a21\u677f\u5916\uff0c\u9084\u53ef\u4ee5\u5728\u751f\u6210\u5668\u4e2d\u6307\u5b9a\u6a21\u677f\u3002\u9019\u5c0d\u65bc\u8986\u84cb spec -level \u6a21\u677f\u7684\u503c\u5f88\u6709\u7528\u3002 \u751f\u6210\u5668\u7684 template \u5b57\u6bb5\u512a\u5148\u65bc\u6a21\u677f spec \u5b57\u6bb5\uff1a \u5982\u679c\u5169\u500b\u6a21\u677f\u5305\u542b\u76f8\u540c\u7684\u5b57\u6bb5\uff0c\u5247\u5c07\u4f7f\u7528\u751f\u6210\u5668\u7684\u5b57\u6bb5\u503c\u3002 \u5982\u679c\u9019\u4e9b\u6a21\u677f\u7684\u5b57\u6bb5\u4e2d\u53ea\u6709\u4e00\u500b\u5177\u6709\u503c\uff0c\u5247\u5c07\u4f7f\u7528\u8a72\u503c\u3002 \u56e0\u6b64\uff0c\u751f\u6210\u5668\u6a21\u677f\u53ef\u4ee5\u88ab\u8a8d\u70ba\u662f\u91dd\u5c0d\u5916\u90e8 spec -level \u6a21\u677f\u5b57\u6bb5\u7684\u88dc\u4e01\u3002 apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - list : elements : - cluster : engineering-dev url : https://kubernetes.default.svc template : metadata : {} spec : project : \"default\" source : revision : HEAD repoURL : https://github.com/argoproj/applicationset.git # New path value is generated here: path : 'examples/template-override/{{cluster}}-override' destination : {} template : metadata : name : '{{cluster}}-guestbook' spec : project : \"default\" source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD # This 'default' value is not used: it is is replaced by the generator's template path, above path : examples/template-override/default destination : server : '{{url}}' namespace : guestbook \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u5728\u672c\u4f8b\u4e2d\uff0c ApplicationSet \u63a7\u5236\u5668\u5c07\u4f7f\u7528 List \u751f\u6210\u5668\u751f\u6210\u7684\u8def\u5f91\u800c\u4e0d\u662f .spec.template \u4e2d\u5b9a\u7fa9\u7684\u8def\u5f91\u503c\u4f86\u751f\u6210 Application \u8cc7\u6e90\u3002","title":"\u7bc4\u672c fields"},{"location":"argocd/applicationset/template/#templates","text":"ApplicationSet spec \u7684\u6a21\u677f\u5b57\u6bb5\u7528\u65bc\u751f\u6210 Argo CD Application \u8cc7\u6e90\u3002","title":"Templates"},{"location":"argocd/applicationset/template/#template-fields","text":"\u901a\u904e\u5c07\u4f86\u81ea\u751f\u6210\u5668\u7684\u53c3\u6578\u8207\u6a21\u677f\u7684\u5b57\u6bb5\uff08\u901a\u904e {{values}} \uff09\u7d44\u5408\u4f86\u5275\u5efa Argo CD \u61c9\u7528\u7a0b\u5e8f\uff0c\u4e26\u5f9e\u4e2d\u751f\u6210\u5177\u9ad4\u7684\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u4e26\u5c07\u5176\u61c9\u7528\u65bc\u96c6\u7fa4\u3002 \u9019\u662f\u4f86\u81ea\u96c6\u7fa4\u751f\u6210\u5668\u7684\u6a21\u677f subfields \uff1a # (...) template : metadata : name : '{{cluster}}-guestbook' spec : source : repoURL : https://github.com/infra-team/cluster-deployments.git targetRevision : HEAD path : guestbook/{{cluster}} destination : server : '{{url}}' namespace : guestbook \u6a21\u677f subfields \u76f4\u63a5\u5c0d\u61c9\u65bc Argo CD Application \u8cc7\u6e90\u7684\u898f\u7bc4 \uff1a project \u662f\u6307\u6b63\u5728\u4f7f\u7528\u7684 Argo CD \u9805\u76ee \uff08\u9019\u88e1\u53ef\u4ee5\u4f7f\u7528\u9ed8\u8a8d\u503c\u4f86\u5229\u7528\u9ed8\u8a8d\u7684 Argo CD \u9805\u76ee\uff09 source \u5b9a\u7fa9\u5f9e\u54ea\u500b Git \u5b58\u5132\u5eab\u4e2d\u63d0\u53d6\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae repoURL \uff1a\u5b58\u5132\u5eab\u7684 URL\uff08\u4f8b\u5982 https://github.com/argoproj/argocd-example-apps.git \uff09 targetRevision \uff1a\u5b58\u5132\u5eab\u7684\u4fee\u8a02\u7248\uff08\u6a19\u7c64/\u5206\u652f/\u63d0\u4ea4\uff09\uff08\u4f8b\u5982 HEAD\uff09 path \uff1aKubernetes \u6e05\u55ae\uff08\u548c/\u6216 Helm\u3001Kustomize\u3001Jsonnet \u8cc7\u6e90\uff09\u6240\u5728\u7684\u5b58\u5132\u5eab\u4e2d\u7684\u8def\u5f91 destination \uff1a\u5b9a\u7fa9\u8981\u90e8\u7f72\u5230\u54ea\u500b Kubernetes \u96c6\u7fa4/\u547d\u540d\u7a7a\u9593 name \uff1a\u8981\u90e8\u7f72\u5230\u7684\u96c6\u7fa4\u7684\u540d\u7a31\uff08\u5728 Argo CD \u4e2d\uff09 server \uff1a\u96c6\u7fa4\u7684 API Server URL\uff08\u4f8b\u5982\uff1a https://kubernetes.default.svc \uff09 namespace \uff1a\u5f9e source \u90e8\u7f72\u6e05\u55ae\u7684\u76ee\u6a19\u547d\u540d\u7a7a\u9593\uff08\u793a\u4f8b\uff1amy-app-namespace\uff09 Info \u5f15\u7528\u7684\u96c6\u7fa4\u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0cApplicationSet \u63a7\u5236\u5668\u624d\u80fd\u4f7f\u7528\u5b83\u5011 \u53ea\u80fd\u6307\u5b9a name \u6216 server \u4e4b\u4e00\uff1a\u5982\u679c\u5169\u8005\u90fd\u6307\u5b9a\uff0c\u5247\u8fd4\u56de\u932f\u8aa4\u3002 \u6a21\u677f\u7684\u5143\u6578\u64da\u5b57\u6bb5\u4e5f\u53ef\u7528\u65bc\u8a2d\u7f6e\u61c9\u7528\u7a0b\u5e8f\u540d\u7a31\uff0c\u6216\u70ba\u61c9\u7528\u7a0b\u5e8f\u6dfb\u52a0\u6a19\u7c64\u6216\u8a3b\u91cb\u3002 \u96d6\u7136 ApplicationSet \u898f\u7bc4\u63d0\u4f9b\u4e86\u4e00\u7a2e\u57fa\u672c\u7684\u6a21\u677f\u5f62\u5f0f\uff0c\u4f46\u5b83\u4e26\u4e0d\u6253\u7b97\u53d6\u4ee3 Kustomize\u3001Helm \u6216 Jsonnet \u7b49\u5de5\u5177\u7684\u6210\u719f\u914d\u7f6e\u7ba1\u7406\u529f\u80fd\u3002","title":"Template fields"},{"location":"argocd/applicationset/template/#generator-templates","text":"\u9664\u4e86\u5728 ApplicationSet \u8cc7\u6e90\u7684 .spec.template \u4e2d\u6307\u5b9a\u6a21\u677f\u5916\uff0c\u9084\u53ef\u4ee5\u5728\u751f\u6210\u5668\u4e2d\u6307\u5b9a\u6a21\u677f\u3002\u9019\u5c0d\u65bc\u8986\u84cb spec -level \u6a21\u677f\u7684\u503c\u5f88\u6709\u7528\u3002 \u751f\u6210\u5668\u7684 template \u5b57\u6bb5\u512a\u5148\u65bc\u6a21\u677f spec \u5b57\u6bb5\uff1a \u5982\u679c\u5169\u500b\u6a21\u677f\u5305\u542b\u76f8\u540c\u7684\u5b57\u6bb5\uff0c\u5247\u5c07\u4f7f\u7528\u751f\u6210\u5668\u7684\u5b57\u6bb5\u503c\u3002 \u5982\u679c\u9019\u4e9b\u6a21\u677f\u7684\u5b57\u6bb5\u4e2d\u53ea\u6709\u4e00\u500b\u5177\u6709\u503c\uff0c\u5247\u5c07\u4f7f\u7528\u8a72\u503c\u3002 \u56e0\u6b64\uff0c\u751f\u6210\u5668\u6a21\u677f\u53ef\u4ee5\u88ab\u8a8d\u70ba\u662f\u91dd\u5c0d\u5916\u90e8 spec -level \u6a21\u677f\u5b57\u6bb5\u7684\u88dc\u4e01\u3002 apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - list : elements : - cluster : engineering-dev url : https://kubernetes.default.svc template : metadata : {} spec : project : \"default\" source : revision : HEAD repoURL : https://github.com/argoproj/applicationset.git # New path value is generated here: path : 'examples/template-override/{{cluster}}-override' destination : {} template : metadata : name : '{{cluster}}-guestbook' spec : project : \"default\" source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD # This 'default' value is not used: it is is replaced by the generator's template path, above path : examples/template-override/default destination : server : '{{url}}' namespace : guestbook \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u5728\u672c\u4f8b\u4e2d\uff0c ApplicationSet \u63a7\u5236\u5668\u5c07\u4f7f\u7528 List \u751f\u6210\u5668\u751f\u6210\u7684\u8def\u5f91\u800c\u4e0d\u662f .spec.template \u4e2d\u5b9a\u7fa9\u7684\u8def\u5f91\u503c\u4f86\u751f\u6210 Application \u8cc7\u6e90\u3002","title":"Generator templates"},{"location":"argocd/applicationset/use-cases/","text":"ApplicationSet \u63a7\u5236\u5668\u7684\u7528\u4f8b \u00b6 \u501f\u52a9\u751f\u6210\u5668\u7684\u6982\u5ff5\uff0cApplicationSet \u63a7\u5236\u5668\u63d0\u4f9b\u4e86\u4e00\u7d44\u5f37\u5927\u7684\u5de5\u5177\u4f86\u81ea\u52d5\u5316 Argo CD \u61c9\u7528\u7a0b\u5e8f\u7684\u6a21\u677f\u548c\u4fee\u6539\u3002\u751f\u6210\u5668\u5f9e\u5404\u7a2e\u4f86\u6e90\u751f\u6210\u6a21\u677f\u53c3\u6578\u6578\u64da\uff0c\u5305\u62ec Argo CD \u96c6\u7fa4\u548c Git \u5b58\u5132\u5eab\uff0c\u652f\u6301\u548c\u555f\u7528\u65b0\u7684\u7528\u4f8b\u3002 \u96d6\u7136\u9019\u4e9b\u5de5\u5177\u53ef\u7528\u65bc\u4efb\u4f55\u6240\u9700\u7684\u76ee\u7684\uff0c\u4f46\u4ee5\u4e0b\u662f ApplicationSet \u63a7\u5236\u5668\u65e8\u5728\u652f\u6301\u7684\u4e00\u4e9b\u7279\u5b9a\u7528\u4f8b\u3002 \u7528\u4f8b\uff1a\u96c6\u7fa4\u9644\u52a0\u7d44\u4ef6 \u00b6 ApplicationSet \u63a7\u5236\u5668\u7684\u521d\u59cb\u8a2d\u8a08\u91cd\u9ede\u662f\u8b93\u57fa\u790e\u67b6\u69cb\u5718\u968a\u7684 Kubernetes \u96c6\u7fa4\u7ba1\u7406\u54e1\u80fd\u5920\u8de8\u5927\u91cf\u96c6\u7fa4\u81ea\u52d5\u5275\u5efa\u5927\u91cf\u591a\u6a23\u5316\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\uff0c\u4e26\u5c07\u9019\u4e9b\u61c9\u7528\u7a0b\u5e8f\u4f5c\u70ba\u4e00\u500b\u55ae\u5143\u9032\u884c\u7ba1\u7406\u3002\u70ba\u4ec0\u9ebc\u9700\u8981\u9019\u6a23\u505a\u7684\u4e00\u500b\u4f8b\u5b50\u662f\u96c6\u7fa4\u9644\u52a0\u7528\u4f8b\u3002 \u5728\u96c6\u7fa4\u63d2\u4ef6\u7528\u4f8b\u4e2d\uff0c\u7ba1\u7406\u54e1\u8ca0\u8cac\u70ba\u4e00\u500b\u6216\u591a\u500b Kubernetes \u96c6\u7fa4\u63d0\u4f9b\u96c6\u7fa4\u63d2\u4ef6\uff1a\u96c6\u7fa4\u63d2\u4ef6\u662f\u8af8\u5982 Prometheus operator \u4e4b\u985e\u7684\u904b\u7b97\u7b26\uff0c\u6216\u8af8\u5982 argo-workflows \u63a7\u5236\u5668 \u4e4b\u985e\u7684\u63a7\u5236\u5668\uff08 [Argo \u751f\u614b\u7cfb\u7d71]( https://argoproj.github.io/ \uff09\u3002 \u901a\u5e38\uff0c\u958b\u767c\u5718\u968a\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u9019\u4e9b\u9644\u52a0\u7d44\u4ef6\uff08\u4f8b\u5982\uff0c\u4f5c\u70ba\u591a\u79df\u6236\u96c6\u7fa4\u7684\u79df\u6236\uff0c\u4ed6\u5011\u53ef\u80fd\u5e0c\u671b\u5411 Prometheus \u63d0\u4f9b\u6307\u6a19\u6578\u64da\u6216\u901a\u904e Argo Workflows \u7de8\u6392\u5de5\u4f5c\u6d41\uff09\u3002 \u7531\u65bc\u5b89\u88dd\u9019\u4e9b\u9644\u52a0\u7d44\u4ef6\u9700\u8981\u96c6\u7fa4\u7d1a\u5225\u7684\u6b0a\u9650\uff0c\u800c\u4e0d\u662f\u7531\u55ae\u500b\u958b\u767c\u5718\u968a\u6301\u6709\uff0c\u56e0\u6b64\u5b89\u88dd\u662f\u7d44\u7e54\u7684\u57fa\u790e\u67b6\u69cb/\u904b\u71df\u5718\u968a\u7684\u8cac\u4efb\uff0c\u5728\u5927\u578b\u7d44\u7e54\u4e2d\uff0c\u8a72\u5718\u968a\u53ef\u80fd\u8ca0\u8cac\u6578\u5341\u3001\u6578\u767e\u6216\u6578\u5343\u500bKubernetes \u96c6\u7fa4\uff08\u5b9a\u671f\u6dfb\u52a0/\u4fee\u6539/\u522a\u9664\u65b0\u96c6\u7fa4\uff09\u3002 \u8de8\u5927\u91cf\u96c6\u7fa4\u64f4\u5c55\u4e26\u81ea\u52d5\u97ff\u61c9\u65b0\u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u7684\u9700\u8981\uff0c\u5fc5\u7136\u8981\u6c42\u67d0\u7a2e\u5f62\u5f0f\u7684\u81ea\u52d5\u5316\u3002\u9032\u4e00\u6b65\u7684\u8981\u6c42\u662f\u5141\u8a31\u4f7f\u7528\u7279\u5b9a\u6a19\u6e96\uff08\u4f8b\u5982\u5206\u671f\u8207\u751f\u7522\uff09\u5c07\u9644\u52a0\u7d44\u4ef6\u5b9a\u4f4d\u5230\u96c6\u7fa4\u5b50\u96c6\u3002 \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u57fa\u790e\u67b6\u69cb\u5718\u968a\u7dad\u8b77\u4e86\u4e00\u500b Git \u5b58\u5132\u5eab\uff0c\u5176\u4e2d\u5305\u542b Argo Workflows \u63a7\u5236\u5668\u548c Prometheus operator\u7684\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002 \u57fa\u790e\u67b6\u69cb\u5718\u968a\u5e0c\u671b\u4f7f\u7528 Argo CD \u5c07\u9019\u5169\u500b\u9644\u52a0\u7d44\u4ef6\u90e8\u7f72\u5230\u5927\u91cf\u96c6\u7fa4\uff0c\u4e26\u4e14\u540c\u6a23\u5e0c\u671b\u8f15\u9b06\u7ba1\u7406\u65b0\u96c6\u7fa4\u7684\u5275\u5efa/\u522a\u9664\u3002 \u5728\u9019\u500b\u7528\u4f8b\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 ApplicationSet \u63a7\u5236\u5668\u7684 List\u3001Cluster \u6216 Git \u751f\u6210\u5668\u4f86\u63d0\u4f9b\u6240\u9700\u7684\u884c\u70ba\uff1a List generator \uff1a\u7ba1\u7406\u54e1\u7dad\u8b77\u5169\u500b ApplicationSet \u8cc7\u6e90\uff0c\u4e00\u500b\u7528\u65bc\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff08Workflows \u548c Prometheus\uff09\uff0c\u4e26\u5728\u6bcf\u500b\u7684\u5217\u8868\u751f\u6210\u5668\u5143\u7d20\u4e2d\u5305\u542b\u4ed6\u5011\u5e0c\u671b\u5b9a\u4f4d\u7684\u96c6\u7fa4\u5217\u8868\u3002 \u4f7f\u7528\u6b64\u751f\u6210\u5668\uff0c\u6dfb\u52a0/\u522a\u9664\u96c6\u7fa4\u9700\u8981\u624b\u52d5\u66f4\u65b0 ApplicationSet \u8cc7\u6e90\u7684\u5217\u8868\u5143\u7d20\u3002 Cluster generator \uff1a\u7ba1\u7406\u54e1\u7dad\u8b77\u5169\u500b ApplicationSet \u8cc7\u6e90\uff0c\u4e00\u500b\u7528\u65bc\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff08Workflows \u548c Prometheus\uff09\uff0c\u4e26\u78ba\u4fdd\u6240\u6709\u65b0\u96c6\u7fa4\u90fd\u5728 Argo CD \u4e2d\u5b9a\u7fa9\u3002 \u7531\u65bc Cluster generator \u81ea\u52d5\u6aa2\u6e2c\u4e26\u5b9a\u4f4d\u5728 Argo CD \u4e2d\u5b9a\u7fa9\u7684\u96c6\u7fa4\uff0c\u56e0\u6b64\u5f9e Argo CD \u6dfb\u52a0/\u522a\u9664\u96c6\u7fa4 \u5c07\u81ea\u52d5\u5c0e\u81f4 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\uff08\u91dd\u5c0d\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff09\u7531 ApplicationSet \u63a7\u5236\u5668\u5275\u5efa\u3002 Git generator \uff1aGit \u751f\u6210\u5668\u662f\u6700\u9748\u6d3b/\u6700\u5f37\u5927\u7684\u751f\u6210\u5668\uff0c\u56e0\u6b64\u6709\u8a31\u591a\u4e0d\u540c\u7684\u65b9\u6cd5\u4f86\u8655\u7406\u9019\u500b\u7528\u4f8b\u3002\u9019\u88e1\u6709\u4e00\u4e9b\uff1a \u4f7f\u7528 Git generator files \u5b57\u6bb5\uff1a\u96c6\u7fa4\u5217\u8868\u4f5c\u70ba JSON \u6587\u4ef6\u4fdd\u5b58\u5728 Git \u5b58\u5132\u5eab\u4e2d\u3002\u901a\u904e Git \u63d0\u4ea4\u66f4\u65b0 JSON \u6587\u4ef6\u6703\u5c0e\u81f4\u6dfb\u52a0/\u522a\u9664\u65b0\u96c6\u7fa4\u3002 \u4f7f\u7528 Git generator directories \u5b57\u6bb5\uff1a\u5c0d\u65bc\u6bcf\u500b\u76ee\u6a19\u96c6\u7fa4\uff0c\u8a72\u540d\u7a31\u7684\u5c0d\u61c9\u76ee\u9304\u5b58\u5728\u65bc Git \u5b58\u5132\u5eab\u4e2d\u3002\u901a\u904e Git \u63d0\u4ea4\u6dfb\u52a0/\u4fee\u6539\u76ee\u9304\u5c07\u89f8\u767c\u5177\u6709\u5171\u4eab\u76ee\u9304\u540d\u7a31\u7684\u96c6\u7fa4\u7684\u66f4\u65b0\u3002 \u6709\u95dc\u6bcf\u500b\u751f\u6210\u5668\u7684\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u751f\u6210\u5668\u90e8\u5206\u3002 \u7528\u4f8b\uff1amonorepos \u00b6 \u5728 monorepo \u7528\u4f8b\u4e2d\uff0cKubernetes \u96c6\u7fa4\u7ba1\u7406\u54e1\u5f9e\u55ae\u500b Git \u5b58\u5132\u5eab\u7ba1\u7406\u55ae\u500b Kubernetes \u96c6\u7fa4\u7684\u6574\u500b\u72c0\u614b\u3002 \u5408\u4f75\u5230 Git \u5b58\u5132\u5eab\u4e2d\u7684\u6e05\u55ae\u66f4\u6539\u61c9\u81ea\u52d5\u90e8\u7f72\u5230\u96c6\u7fa4\u3002 \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u57fa\u790e\u67b6\u69cb\u5718\u968a\u7dad\u8b77\u4e00\u500b Git \u5b58\u5132\u5eab\uff0c\u5176\u4e2d\u5305\u542b Argo Workflows \u63a7\u5236\u5668\u548c Prometheus \u64cd\u4f5c\u54e1\u7684\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002\u7368\u7acb\u958b\u767c\u5718\u968a\u9084\u6dfb\u52a0\u4e86\u4ed6\u5011\u5e0c\u671b\u90e8\u7f72\u5230\u96c6\u7fa4\u7684\u5176\u4ed6\u670d\u52d9\u3002 \u5c0d Git \u5b58\u5132\u5eab\u6240\u505a\u7684\u66f4\u6539\u2014\u2014\u4f8b\u5982\uff0c\u66f4\u65b0\u5df2\u90e8\u7f72\u5de5\u4ef6\u7684\u7248\u672c\u2014\u2014\u61c9\u8a72\u6703\u81ea\u52d5\u5c0e\u81f4 Argo CD \u5c07\u8a72\u66f4\u65b0\u61c9\u7528\u65bc\u76f8\u61c9\u7684 Kubernetes \u96c6\u7fa4\u3002 Git generator \u53ef\u7528\u65bc\u652f\u6301\u6b64\u7528\u4f8b\uff1a - Git generator directories \u5b57\u6bb5\u53ef\u7528\u65bc\u6307\u5b9a\u5305\u542b\u8981\u90e8\u7f72\u7684\u5404\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u7279\u5b9a\u5b50\u76ee\u9304\uff08\u4f7f\u7528\u901a\u914d\u7b26\uff09\u3002 - Git generator files \u5b57\u6bb5\u53ef\u4ee5\u5f15\u7528\u5305\u542b JSON \u5143\u6578\u64da\u7684 Git \u5b58\u5132\u5eab\u6587\u4ef6\uff0c\u8a72\u5143\u6578\u64da\u63cf\u8ff0\u8981\u90e8\u7f72\u7684\u5404\u500b\u61c9\u7528\u7a0b\u5e8f\u3002 \u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Git \u751f\u6210\u5668\u6587\u6a94\u3002 \u7528\u4f8b\uff1a\u591a\u79df\u6236\u96c6\u7fa4\u4e0a\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u81ea\u52a9\u670d\u52d9 \u00b6 \u81ea\u52a9\u670d\u52d9\u7528\u4f8b\u65e8\u5728\u8b93\u958b\u767c\u4eba\u54e1\uff08\u4f5c\u70ba\u591a\u79df\u6236 Kubernetes \u96c6\u7fa4\u7684\u6700\u7d42\u7528\u6236\uff09\u5177\u6709\u66f4\u5927\u7684\u9748\u6d3b\u6027\uff1a \u4f7f\u7528 Argo CD \u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u5c07\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u55ae\u500b\u96c6\u7fa4 \u4f7f\u7528 Argo CD \u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u90e8\u7f72\u5230\u591a\u500b\u96c6\u7fa4 \u4f46\u662f\uff0c\u5728\u9019\u5169\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u4f7f\u9019\u4e9b\u958b\u767c\u4eba\u54e1\u80fd\u5920\u5728\u4e0d\u9700\u8981\u96c6\u7fa4\u7ba1\u7406\u54e1\u53c3\u8207\u7684\u60c5\u6cc1\u4e0b\u9019\u6a23\u505a\uff08\u4ee3\u8868\u4ed6\u5011\u5275\u5efa\u5fc5\u8981\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f/AppProject \u8cc7\u6e90\uff09 \u6b64\u7528\u4f8b\u7684\u4e00\u500b\u6f5b\u5728\u89e3\u6c7a\u65b9\u6848\u662f\u958b\u767c\u5718\u968a\u5728 Git \u5b58\u5132\u5eab\uff08\u5305\u542b\u4ed6\u5011\u5e0c\u671b\u90e8\u7f72\u7684\u6e05\u55ae\uff09\u4e2d\u4ee5\u61c9\u7528\u7a0b\u5e8f\u6a21\u5f0f\u5b9a\u7fa9 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\uff0c\u7136\u5f8c\u96c6\u7fa4\u7ba1\u7406\u54e1\u53ef\u4ee5\u67e5\u770b/\u63a5\u53d7\u66f4\u6539\u901a\u904e\u5408\u4f75\u8acb\u6c42\u5230\u6b64\u5b58\u5132\u5eab\u3002 \u96d6\u7136\u9019\u807d\u8d77\u4f86\u50cf\u662f\u4e00\u500b\u6709\u6548\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u4f46\u4e00\u500b\u4e3b\u8981\u7f3a\u9ede\u662f\u9700\u8981\u9ad8\u5ea6\u4fe1\u4efb/\u5be9\u67e5\u624d\u80fd\u63a5\u53d7\u5305\u542b Argo CD \u61c9\u7528\u7a0b\u5e8f\u898f\u7bc4\u66f4\u6539\u7684\u63d0\u4ea4\u3002\u9019\u662f\u56e0\u70ba\u61c9\u7528\u898f\u7bc4\u4e2d\u5305\u542b\u8a31\u591a\u654f\u611f\u5b57\u6bb5\uff0c\u5305\u62ec\u9805\u76ee\u3001\u96c6\u7fa4\u548c\u547d\u540d\u7a7a\u9593\u3002\u7121\u610f\u7684\u5408\u4f75\u53ef\u80fd\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u8a2a\u554f\u5b83\u5011\u4e0d\u5c6c\u65bc\u7684\u540d\u7a31\u7a7a\u9593/\u96c6\u7fa4\u3002 \u56e0\u6b64\uff0c\u5728\u81ea\u52a9\u670d\u52d9\u7528\u4f8b\u4e2d\uff0c\u7ba1\u7406\u54e1\u5e0c\u671b\u53ea\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u898f\u7bc4\u7684\u67d0\u4e9b\u5b57\u6bb5\u7531\u958b\u767c\u4eba\u54e1\u63a7\u5236\uff08\u4f8b\u5982 Git \u6e90\u5b58\u5132\u5eab\uff09\uff0c\u800c\u4e0d\u5141\u8a31\u5176\u4ed6\u5b57\u6bb5\uff08\u4f8b\u5982\u76ee\u6a19\u547d\u540d\u7a7a\u9593\u6216\u76ee\u6a19\u96c6\u7fa4\uff0c\u61c9\u8a72\u53d7\u5230\u9650\u5236\uff09 . \u5e78\u904b\u7684\u662f\uff0cApplicationSet \u63a7\u5236\u5668\u70ba\u6b64\u7528\u4f8b\u63d0\u4f9b\u4e86\u53e6\u4e00\u7a2e\u89e3\u6c7a\u65b9\u6848\uff1a\u96c6\u7fa4\u7ba1\u7406\u54e1\u53ef\u4ee5\u5b89\u5168\u5730\u5275\u5efa\u4e00\u500b ApplicationSet \u8cc7\u6e90\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u500b Git \u751f\u6210\u5668\uff0c\u8a72\u751f\u6210\u5668\u4f7f\u7528\u6a21\u677f\u5b57\u6bb5\u5c07\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7684\u90e8\u7f72\u9650\u5236\u70ba\u56fa\u5b9a\u503c\uff0c\u540c\u6642\u5141\u8a31\u958b\u767c\u4eba\u54e1\u81ea\u5b9a\u7fa9\u201c\u5b89\u5168\u201d\u5b57\u6bb5\uff0c\u96a8\u610f\u3002 kind : ApplicationSet # (...) spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git files : - path : \"apps/**/config.json\" template : spec : project : dev-team-one # project is restricted source : # developers may customize app details using JSON files from above repo URL repoURL : {{ app.source }} targetRevision : {{ app.revision }} path : {{ app.path }} destination : name : production-cluster # cluster is restricted namespace : dev-team-one # namespace is restricted \u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Git \u751f\u6210\u5668\u3002","title":"\u7528\u4f8b"},{"location":"argocd/applicationset/use-cases/#applicationset","text":"\u501f\u52a9\u751f\u6210\u5668\u7684\u6982\u5ff5\uff0cApplicationSet \u63a7\u5236\u5668\u63d0\u4f9b\u4e86\u4e00\u7d44\u5f37\u5927\u7684\u5de5\u5177\u4f86\u81ea\u52d5\u5316 Argo CD \u61c9\u7528\u7a0b\u5e8f\u7684\u6a21\u677f\u548c\u4fee\u6539\u3002\u751f\u6210\u5668\u5f9e\u5404\u7a2e\u4f86\u6e90\u751f\u6210\u6a21\u677f\u53c3\u6578\u6578\u64da\uff0c\u5305\u62ec Argo CD \u96c6\u7fa4\u548c Git \u5b58\u5132\u5eab\uff0c\u652f\u6301\u548c\u555f\u7528\u65b0\u7684\u7528\u4f8b\u3002 \u96d6\u7136\u9019\u4e9b\u5de5\u5177\u53ef\u7528\u65bc\u4efb\u4f55\u6240\u9700\u7684\u76ee\u7684\uff0c\u4f46\u4ee5\u4e0b\u662f ApplicationSet \u63a7\u5236\u5668\u65e8\u5728\u652f\u6301\u7684\u4e00\u4e9b\u7279\u5b9a\u7528\u4f8b\u3002","title":"ApplicationSet \u63a7\u5236\u5668\u7684\u7528\u4f8b"},{"location":"argocd/applicationset/use-cases/#_1","text":"ApplicationSet \u63a7\u5236\u5668\u7684\u521d\u59cb\u8a2d\u8a08\u91cd\u9ede\u662f\u8b93\u57fa\u790e\u67b6\u69cb\u5718\u968a\u7684 Kubernetes \u96c6\u7fa4\u7ba1\u7406\u54e1\u80fd\u5920\u8de8\u5927\u91cf\u96c6\u7fa4\u81ea\u52d5\u5275\u5efa\u5927\u91cf\u591a\u6a23\u5316\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\uff0c\u4e26\u5c07\u9019\u4e9b\u61c9\u7528\u7a0b\u5e8f\u4f5c\u70ba\u4e00\u500b\u55ae\u5143\u9032\u884c\u7ba1\u7406\u3002\u70ba\u4ec0\u9ebc\u9700\u8981\u9019\u6a23\u505a\u7684\u4e00\u500b\u4f8b\u5b50\u662f\u96c6\u7fa4\u9644\u52a0\u7528\u4f8b\u3002 \u5728\u96c6\u7fa4\u63d2\u4ef6\u7528\u4f8b\u4e2d\uff0c\u7ba1\u7406\u54e1\u8ca0\u8cac\u70ba\u4e00\u500b\u6216\u591a\u500b Kubernetes \u96c6\u7fa4\u63d0\u4f9b\u96c6\u7fa4\u63d2\u4ef6\uff1a\u96c6\u7fa4\u63d2\u4ef6\u662f\u8af8\u5982 Prometheus operator \u4e4b\u985e\u7684\u904b\u7b97\u7b26\uff0c\u6216\u8af8\u5982 argo-workflows \u63a7\u5236\u5668 \u4e4b\u985e\u7684\u63a7\u5236\u5668\uff08 [Argo \u751f\u614b\u7cfb\u7d71]( https://argoproj.github.io/ \uff09\u3002 \u901a\u5e38\uff0c\u958b\u767c\u5718\u968a\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u9019\u4e9b\u9644\u52a0\u7d44\u4ef6\uff08\u4f8b\u5982\uff0c\u4f5c\u70ba\u591a\u79df\u6236\u96c6\u7fa4\u7684\u79df\u6236\uff0c\u4ed6\u5011\u53ef\u80fd\u5e0c\u671b\u5411 Prometheus \u63d0\u4f9b\u6307\u6a19\u6578\u64da\u6216\u901a\u904e Argo Workflows \u7de8\u6392\u5de5\u4f5c\u6d41\uff09\u3002 \u7531\u65bc\u5b89\u88dd\u9019\u4e9b\u9644\u52a0\u7d44\u4ef6\u9700\u8981\u96c6\u7fa4\u7d1a\u5225\u7684\u6b0a\u9650\uff0c\u800c\u4e0d\u662f\u7531\u55ae\u500b\u958b\u767c\u5718\u968a\u6301\u6709\uff0c\u56e0\u6b64\u5b89\u88dd\u662f\u7d44\u7e54\u7684\u57fa\u790e\u67b6\u69cb/\u904b\u71df\u5718\u968a\u7684\u8cac\u4efb\uff0c\u5728\u5927\u578b\u7d44\u7e54\u4e2d\uff0c\u8a72\u5718\u968a\u53ef\u80fd\u8ca0\u8cac\u6578\u5341\u3001\u6578\u767e\u6216\u6578\u5343\u500bKubernetes \u96c6\u7fa4\uff08\u5b9a\u671f\u6dfb\u52a0/\u4fee\u6539/\u522a\u9664\u65b0\u96c6\u7fa4\uff09\u3002 \u8de8\u5927\u91cf\u96c6\u7fa4\u64f4\u5c55\u4e26\u81ea\u52d5\u97ff\u61c9\u65b0\u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u7684\u9700\u8981\uff0c\u5fc5\u7136\u8981\u6c42\u67d0\u7a2e\u5f62\u5f0f\u7684\u81ea\u52d5\u5316\u3002\u9032\u4e00\u6b65\u7684\u8981\u6c42\u662f\u5141\u8a31\u4f7f\u7528\u7279\u5b9a\u6a19\u6e96\uff08\u4f8b\u5982\u5206\u671f\u8207\u751f\u7522\uff09\u5c07\u9644\u52a0\u7d44\u4ef6\u5b9a\u4f4d\u5230\u96c6\u7fa4\u5b50\u96c6\u3002 \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u57fa\u790e\u67b6\u69cb\u5718\u968a\u7dad\u8b77\u4e86\u4e00\u500b Git \u5b58\u5132\u5eab\uff0c\u5176\u4e2d\u5305\u542b Argo Workflows \u63a7\u5236\u5668\u548c Prometheus operator\u7684\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002 \u57fa\u790e\u67b6\u69cb\u5718\u968a\u5e0c\u671b\u4f7f\u7528 Argo CD \u5c07\u9019\u5169\u500b\u9644\u52a0\u7d44\u4ef6\u90e8\u7f72\u5230\u5927\u91cf\u96c6\u7fa4\uff0c\u4e26\u4e14\u540c\u6a23\u5e0c\u671b\u8f15\u9b06\u7ba1\u7406\u65b0\u96c6\u7fa4\u7684\u5275\u5efa/\u522a\u9664\u3002 \u5728\u9019\u500b\u7528\u4f8b\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 ApplicationSet \u63a7\u5236\u5668\u7684 List\u3001Cluster \u6216 Git \u751f\u6210\u5668\u4f86\u63d0\u4f9b\u6240\u9700\u7684\u884c\u70ba\uff1a List generator \uff1a\u7ba1\u7406\u54e1\u7dad\u8b77\u5169\u500b ApplicationSet \u8cc7\u6e90\uff0c\u4e00\u500b\u7528\u65bc\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff08Workflows \u548c Prometheus\uff09\uff0c\u4e26\u5728\u6bcf\u500b\u7684\u5217\u8868\u751f\u6210\u5668\u5143\u7d20\u4e2d\u5305\u542b\u4ed6\u5011\u5e0c\u671b\u5b9a\u4f4d\u7684\u96c6\u7fa4\u5217\u8868\u3002 \u4f7f\u7528\u6b64\u751f\u6210\u5668\uff0c\u6dfb\u52a0/\u522a\u9664\u96c6\u7fa4\u9700\u8981\u624b\u52d5\u66f4\u65b0 ApplicationSet \u8cc7\u6e90\u7684\u5217\u8868\u5143\u7d20\u3002 Cluster generator \uff1a\u7ba1\u7406\u54e1\u7dad\u8b77\u5169\u500b ApplicationSet \u8cc7\u6e90\uff0c\u4e00\u500b\u7528\u65bc\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff08Workflows \u548c Prometheus\uff09\uff0c\u4e26\u78ba\u4fdd\u6240\u6709\u65b0\u96c6\u7fa4\u90fd\u5728 Argo CD \u4e2d\u5b9a\u7fa9\u3002 \u7531\u65bc Cluster generator \u81ea\u52d5\u6aa2\u6e2c\u4e26\u5b9a\u4f4d\u5728 Argo CD \u4e2d\u5b9a\u7fa9\u7684\u96c6\u7fa4\uff0c\u56e0\u6b64\u5f9e Argo CD \u6dfb\u52a0/\u522a\u9664\u96c6\u7fa4 \u5c07\u81ea\u52d5\u5c0e\u81f4 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\uff08\u91dd\u5c0d\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff09\u7531 ApplicationSet \u63a7\u5236\u5668\u5275\u5efa\u3002 Git generator \uff1aGit \u751f\u6210\u5668\u662f\u6700\u9748\u6d3b/\u6700\u5f37\u5927\u7684\u751f\u6210\u5668\uff0c\u56e0\u6b64\u6709\u8a31\u591a\u4e0d\u540c\u7684\u65b9\u6cd5\u4f86\u8655\u7406\u9019\u500b\u7528\u4f8b\u3002\u9019\u88e1\u6709\u4e00\u4e9b\uff1a \u4f7f\u7528 Git generator files \u5b57\u6bb5\uff1a\u96c6\u7fa4\u5217\u8868\u4f5c\u70ba JSON \u6587\u4ef6\u4fdd\u5b58\u5728 Git \u5b58\u5132\u5eab\u4e2d\u3002\u901a\u904e Git \u63d0\u4ea4\u66f4\u65b0 JSON \u6587\u4ef6\u6703\u5c0e\u81f4\u6dfb\u52a0/\u522a\u9664\u65b0\u96c6\u7fa4\u3002 \u4f7f\u7528 Git generator directories \u5b57\u6bb5\uff1a\u5c0d\u65bc\u6bcf\u500b\u76ee\u6a19\u96c6\u7fa4\uff0c\u8a72\u540d\u7a31\u7684\u5c0d\u61c9\u76ee\u9304\u5b58\u5728\u65bc Git \u5b58\u5132\u5eab\u4e2d\u3002\u901a\u904e Git \u63d0\u4ea4\u6dfb\u52a0/\u4fee\u6539\u76ee\u9304\u5c07\u89f8\u767c\u5177\u6709\u5171\u4eab\u76ee\u9304\u540d\u7a31\u7684\u96c6\u7fa4\u7684\u66f4\u65b0\u3002 \u6709\u95dc\u6bcf\u500b\u751f\u6210\u5668\u7684\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u751f\u6210\u5668\u90e8\u5206\u3002","title":"\u7528\u4f8b\uff1a\u96c6\u7fa4\u9644\u52a0\u7d44\u4ef6"},{"location":"argocd/applicationset/use-cases/#monorepos","text":"\u5728 monorepo \u7528\u4f8b\u4e2d\uff0cKubernetes \u96c6\u7fa4\u7ba1\u7406\u54e1\u5f9e\u55ae\u500b Git \u5b58\u5132\u5eab\u7ba1\u7406\u55ae\u500b Kubernetes \u96c6\u7fa4\u7684\u6574\u500b\u72c0\u614b\u3002 \u5408\u4f75\u5230 Git \u5b58\u5132\u5eab\u4e2d\u7684\u6e05\u55ae\u66f4\u6539\u61c9\u81ea\u52d5\u90e8\u7f72\u5230\u96c6\u7fa4\u3002 \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u57fa\u790e\u67b6\u69cb\u5718\u968a\u7dad\u8b77\u4e00\u500b Git \u5b58\u5132\u5eab\uff0c\u5176\u4e2d\u5305\u542b Argo Workflows \u63a7\u5236\u5668\u548c Prometheus \u64cd\u4f5c\u54e1\u7684\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002\u7368\u7acb\u958b\u767c\u5718\u968a\u9084\u6dfb\u52a0\u4e86\u4ed6\u5011\u5e0c\u671b\u90e8\u7f72\u5230\u96c6\u7fa4\u7684\u5176\u4ed6\u670d\u52d9\u3002 \u5c0d Git \u5b58\u5132\u5eab\u6240\u505a\u7684\u66f4\u6539\u2014\u2014\u4f8b\u5982\uff0c\u66f4\u65b0\u5df2\u90e8\u7f72\u5de5\u4ef6\u7684\u7248\u672c\u2014\u2014\u61c9\u8a72\u6703\u81ea\u52d5\u5c0e\u81f4 Argo CD \u5c07\u8a72\u66f4\u65b0\u61c9\u7528\u65bc\u76f8\u61c9\u7684 Kubernetes \u96c6\u7fa4\u3002 Git generator \u53ef\u7528\u65bc\u652f\u6301\u6b64\u7528\u4f8b\uff1a - Git generator directories \u5b57\u6bb5\u53ef\u7528\u65bc\u6307\u5b9a\u5305\u542b\u8981\u90e8\u7f72\u7684\u5404\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u7279\u5b9a\u5b50\u76ee\u9304\uff08\u4f7f\u7528\u901a\u914d\u7b26\uff09\u3002 - Git generator files \u5b57\u6bb5\u53ef\u4ee5\u5f15\u7528\u5305\u542b JSON \u5143\u6578\u64da\u7684 Git \u5b58\u5132\u5eab\u6587\u4ef6\uff0c\u8a72\u5143\u6578\u64da\u63cf\u8ff0\u8981\u90e8\u7f72\u7684\u5404\u500b\u61c9\u7528\u7a0b\u5e8f\u3002 \u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Git \u751f\u6210\u5668\u6587\u6a94\u3002","title":"\u7528\u4f8b\uff1amonorepos"},{"location":"argocd/applicationset/use-cases/#argo-cd","text":"\u81ea\u52a9\u670d\u52d9\u7528\u4f8b\u65e8\u5728\u8b93\u958b\u767c\u4eba\u54e1\uff08\u4f5c\u70ba\u591a\u79df\u6236 Kubernetes \u96c6\u7fa4\u7684\u6700\u7d42\u7528\u6236\uff09\u5177\u6709\u66f4\u5927\u7684\u9748\u6d3b\u6027\uff1a \u4f7f\u7528 Argo CD \u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u5c07\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u55ae\u500b\u96c6\u7fa4 \u4f7f\u7528 Argo CD \u4ee5\u81ea\u52d5\u5316\u65b9\u5f0f\u90e8\u7f72\u5230\u591a\u500b\u96c6\u7fa4 \u4f46\u662f\uff0c\u5728\u9019\u5169\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u4f7f\u9019\u4e9b\u958b\u767c\u4eba\u54e1\u80fd\u5920\u5728\u4e0d\u9700\u8981\u96c6\u7fa4\u7ba1\u7406\u54e1\u53c3\u8207\u7684\u60c5\u6cc1\u4e0b\u9019\u6a23\u505a\uff08\u4ee3\u8868\u4ed6\u5011\u5275\u5efa\u5fc5\u8981\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f/AppProject \u8cc7\u6e90\uff09 \u6b64\u7528\u4f8b\u7684\u4e00\u500b\u6f5b\u5728\u89e3\u6c7a\u65b9\u6848\u662f\u958b\u767c\u5718\u968a\u5728 Git \u5b58\u5132\u5eab\uff08\u5305\u542b\u4ed6\u5011\u5e0c\u671b\u90e8\u7f72\u7684\u6e05\u55ae\uff09\u4e2d\u4ee5\u61c9\u7528\u7a0b\u5e8f\u6a21\u5f0f\u5b9a\u7fa9 Argo CD \u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\uff0c\u7136\u5f8c\u96c6\u7fa4\u7ba1\u7406\u54e1\u53ef\u4ee5\u67e5\u770b/\u63a5\u53d7\u66f4\u6539\u901a\u904e\u5408\u4f75\u8acb\u6c42\u5230\u6b64\u5b58\u5132\u5eab\u3002 \u96d6\u7136\u9019\u807d\u8d77\u4f86\u50cf\u662f\u4e00\u500b\u6709\u6548\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u4f46\u4e00\u500b\u4e3b\u8981\u7f3a\u9ede\u662f\u9700\u8981\u9ad8\u5ea6\u4fe1\u4efb/\u5be9\u67e5\u624d\u80fd\u63a5\u53d7\u5305\u542b Argo CD \u61c9\u7528\u7a0b\u5e8f\u898f\u7bc4\u66f4\u6539\u7684\u63d0\u4ea4\u3002\u9019\u662f\u56e0\u70ba\u61c9\u7528\u898f\u7bc4\u4e2d\u5305\u542b\u8a31\u591a\u654f\u611f\u5b57\u6bb5\uff0c\u5305\u62ec\u9805\u76ee\u3001\u96c6\u7fa4\u548c\u547d\u540d\u7a7a\u9593\u3002\u7121\u610f\u7684\u5408\u4f75\u53ef\u80fd\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u8a2a\u554f\u5b83\u5011\u4e0d\u5c6c\u65bc\u7684\u540d\u7a31\u7a7a\u9593/\u96c6\u7fa4\u3002 \u56e0\u6b64\uff0c\u5728\u81ea\u52a9\u670d\u52d9\u7528\u4f8b\u4e2d\uff0c\u7ba1\u7406\u54e1\u5e0c\u671b\u53ea\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u898f\u7bc4\u7684\u67d0\u4e9b\u5b57\u6bb5\u7531\u958b\u767c\u4eba\u54e1\u63a7\u5236\uff08\u4f8b\u5982 Git \u6e90\u5b58\u5132\u5eab\uff09\uff0c\u800c\u4e0d\u5141\u8a31\u5176\u4ed6\u5b57\u6bb5\uff08\u4f8b\u5982\u76ee\u6a19\u547d\u540d\u7a7a\u9593\u6216\u76ee\u6a19\u96c6\u7fa4\uff0c\u61c9\u8a72\u53d7\u5230\u9650\u5236\uff09 . \u5e78\u904b\u7684\u662f\uff0cApplicationSet \u63a7\u5236\u5668\u70ba\u6b64\u7528\u4f8b\u63d0\u4f9b\u4e86\u53e6\u4e00\u7a2e\u89e3\u6c7a\u65b9\u6848\uff1a\u96c6\u7fa4\u7ba1\u7406\u54e1\u53ef\u4ee5\u5b89\u5168\u5730\u5275\u5efa\u4e00\u500b ApplicationSet \u8cc7\u6e90\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u500b Git \u751f\u6210\u5668\uff0c\u8a72\u751f\u6210\u5668\u4f7f\u7528\u6a21\u677f\u5b57\u6bb5\u5c07\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u7684\u90e8\u7f72\u9650\u5236\u70ba\u56fa\u5b9a\u503c\uff0c\u540c\u6642\u5141\u8a31\u958b\u767c\u4eba\u54e1\u81ea\u5b9a\u7fa9\u201c\u5b89\u5168\u201d\u5b57\u6bb5\uff0c\u96a8\u610f\u3002 kind : ApplicationSet # (...) spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git files : - path : \"apps/**/config.json\" template : spec : project : dev-team-one # project is restricted source : # developers may customize app details using JSON files from above repo URL repoURL : {{ app.source }} targetRevision : {{ app.revision }} path : {{ app.path }} destination : name : production-cluster # cluster is restricted namespace : dev-team-one # namespace is restricted \u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Git \u751f\u6210\u5668\u3002","title":"\u7528\u4f8b\uff1a\u591a\u79df\u6236\u96c6\u7fa4\u4e0a\u7684 Argo CD \u61c9\u7528\u7a0b\u5e8f\u81ea\u52a9\u670d\u52d9"},{"location":"argocd/applicationset/generators/","text":"Generators \u00b6 \u751f\u6210\u5668\u8ca0\u8cac\u751f\u6210\u53c3\u6578\uff0c\u7136\u5f8c\u5c07\u5176\u6e32\u67d3\u5230\u6a21\u677f\u4e2d\uff1a ApplicationSet \u8cc7\u6e90\u7684\u5b57\u6bb5\u3002\u6709\u95dc\u751f\u6210\u5668\u5982\u4f55\u4f7f\u7528\u6a21\u677f\u5275\u5efa Argo CD Application \u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 \u7c21\u4ecb \u3002 \u751f\u6210\u5668\u4e3b\u8981\u57fa\u65bc\u5b83\u5011\u7528\u4f86\u751f\u6210\u6a21\u677f\u53c3\u6578\u7684\u6578\u64da\u6e90\u3002\u4f8b\u5982\uff1a\u5217\u8868\u751f\u6210\u5668\u5f9e\u6587\u5b57\u5217\u8868\u4e2d\u63d0\u4f9b\u4e00\u7d44\u53c3\u6578\uff0c\u96c6\u7fa4\u751f\u6210\u5668\u4f7f\u7528 Argo CD \u96c6\u7fa4\u5217\u8868\u4f5c\u70ba\u6e90\uff0cGit \u751f\u6210\u5668\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4e2d\u7684\u6587\u4ef6/\u76ee\u9304\uff0c\u7b49\u7b49\u3002 \u5728\u64b0\u5beb\u672c\u6587\u6642\uff0c\u6709\u4e03\u7a2e\u751f\u6210\u5668\uff1a List generator : \u5217\u8868\u751f\u6210\u5668\u5141\u8a31\u60a8\u6839\u64da\u96c6\u7fa4\u540d\u7a31/URL \u503c\u7684\u56fa\u5b9a\u5217\u8868\u5c07 Argo CD \u61c9\u7528\u7a0b\u5e8f\u5b9a\u4f4d\u5230\u96c6\u7fa4\u3002 Cluster generator : \u96c6\u7fa4\u751f\u6210\u5668\u5141\u8a31\u60a8\u6839\u64da\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff08\u4e26\u7531\u5176\u7ba1\u7406\uff09\u7684\u96c6\u7fa4\u5217\u8868\uff08\u5305\u62ec\u81ea\u52d5\u97ff\u61c9\u4f86\u81ea Argo CD \u7684\u96c6\u7fa4\u6dfb\u52a0/\u522a\u9664\u4e8b\u4ef6\uff09\u5c07 Argo CD \u61c9\u7528\u7a0b\u5e8f\u5b9a\u4f4d\u5230\u96c6\u7fa4\u3002 Git generator : Git \u751f\u6210\u5668\u5141\u8a31\u60a8\u57fa\u65bc Git \u5b58\u5132\u5eab\u4e2d\u7684\u6587\u4ef6\u6216\u57fa\u65bc Git \u5b58\u5132\u5eab\u7684\u76ee\u9304\u7d50\u69cb\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u3002 Matrix generator : \u77e9\u9663\u751f\u6210\u5668\u53ef\u7528\u65bc\u7d44\u5408\u5169\u500b\u7368\u7acb\u751f\u6210\u5668\u7684\u751f\u6210\u53c3\u6578\u3002 Merge generator : Merge \u751f\u6210\u5668\u53ef\u7528\u65bc\u5408\u4f75\u5169\u500b\u6216\u591a\u500b\u751f\u6210\u5668\u7684\u751f\u6210\u53c3\u6578\u3002\u5176\u4ed6\u751f\u6210\u5668\u53ef\u4ee5\u8986\u84cb\u57fa\u672c\u751f\u6210\u5668\u7684\u503c\u3002 SCM Provider generator : SCM \u63d0\u4f9b\u8005\u751f\u6210\u5668\u4f7f\u7528 SCM \u63d0\u4f9b\u8005\uff08\u4f8b\u5982 GitHub\uff09\u7684 API \u4f86\u81ea\u52d5\u767c\u73fe\u7d44\u7e54\u5167\u7684\u5b58\u5132\u5eab\u3002 Pull Request generator : \u62c9\u53d6\u8acb\u6c42\u751f\u6210\u5668\u4f7f\u7528 SCMaaS \u63d0\u4f9b\u8005\uff08\u4f8b\u5982 GitHub\uff09\u7684 API \u4f86\u81ea\u52d5\u767c\u73fe\u5b58\u5132\u5eab\u4e2d\u6253\u958b\u7684\u62c9\u53d6\u8acb\u6c42\u3002 Cluster Decision Resource generator : \u96c6\u7fa4\u6c7a\u7b56\u8cc7\u6e90\u751f\u6210\u5668\u7528\u65bc\u8207 Kubernetes \u81ea\u5b9a\u7fa9\u8cc7\u6e90\u4ea4\u4e92\uff0c\u9019\u4e9b\u8cc7\u6e90\u4f7f\u7528\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u7279\u5b9a\u908f\u8f2f\u4f86\u6c7a\u5b9a\u8981\u90e8\u7f72\u5230\u54ea\u4e00\u7d44 Argo CD \u96c6\u7fa4\u3002 \u5982\u679c\u60a8\u4e0d\u719f\u6089\u751f\u6210\u5668\uff0c\u8acb\u5f9e List generator \u548c Cluster generator \u958b\u59cb\u3002\u6709\u95dc\u66f4\u9ad8\u7d1a\u7684\u7528\u4f8b\uff0c\u8acb\u53c3\u95b1\u4e0a\u9762\u5176\u9918\u751f\u6210\u5668\u7684\u6587\u6a94\u3002","title":"\u751f\u6210\u5668\u7c21\u4ecb"},{"location":"argocd/applicationset/generators/#generators","text":"\u751f\u6210\u5668\u8ca0\u8cac\u751f\u6210\u53c3\u6578\uff0c\u7136\u5f8c\u5c07\u5176\u6e32\u67d3\u5230\u6a21\u677f\u4e2d\uff1a ApplicationSet \u8cc7\u6e90\u7684\u5b57\u6bb5\u3002\u6709\u95dc\u751f\u6210\u5668\u5982\u4f55\u4f7f\u7528\u6a21\u677f\u5275\u5efa Argo CD Application \u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 \u7c21\u4ecb \u3002 \u751f\u6210\u5668\u4e3b\u8981\u57fa\u65bc\u5b83\u5011\u7528\u4f86\u751f\u6210\u6a21\u677f\u53c3\u6578\u7684\u6578\u64da\u6e90\u3002\u4f8b\u5982\uff1a\u5217\u8868\u751f\u6210\u5668\u5f9e\u6587\u5b57\u5217\u8868\u4e2d\u63d0\u4f9b\u4e00\u7d44\u53c3\u6578\uff0c\u96c6\u7fa4\u751f\u6210\u5668\u4f7f\u7528 Argo CD \u96c6\u7fa4\u5217\u8868\u4f5c\u70ba\u6e90\uff0cGit \u751f\u6210\u5668\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4e2d\u7684\u6587\u4ef6/\u76ee\u9304\uff0c\u7b49\u7b49\u3002 \u5728\u64b0\u5beb\u672c\u6587\u6642\uff0c\u6709\u4e03\u7a2e\u751f\u6210\u5668\uff1a List generator : \u5217\u8868\u751f\u6210\u5668\u5141\u8a31\u60a8\u6839\u64da\u96c6\u7fa4\u540d\u7a31/URL \u503c\u7684\u56fa\u5b9a\u5217\u8868\u5c07 Argo CD \u61c9\u7528\u7a0b\u5e8f\u5b9a\u4f4d\u5230\u96c6\u7fa4\u3002 Cluster generator : \u96c6\u7fa4\u751f\u6210\u5668\u5141\u8a31\u60a8\u6839\u64da\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff08\u4e26\u7531\u5176\u7ba1\u7406\uff09\u7684\u96c6\u7fa4\u5217\u8868\uff08\u5305\u62ec\u81ea\u52d5\u97ff\u61c9\u4f86\u81ea Argo CD \u7684\u96c6\u7fa4\u6dfb\u52a0/\u522a\u9664\u4e8b\u4ef6\uff09\u5c07 Argo CD \u61c9\u7528\u7a0b\u5e8f\u5b9a\u4f4d\u5230\u96c6\u7fa4\u3002 Git generator : Git \u751f\u6210\u5668\u5141\u8a31\u60a8\u57fa\u65bc Git \u5b58\u5132\u5eab\u4e2d\u7684\u6587\u4ef6\u6216\u57fa\u65bc Git \u5b58\u5132\u5eab\u7684\u76ee\u9304\u7d50\u69cb\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u3002 Matrix generator : \u77e9\u9663\u751f\u6210\u5668\u53ef\u7528\u65bc\u7d44\u5408\u5169\u500b\u7368\u7acb\u751f\u6210\u5668\u7684\u751f\u6210\u53c3\u6578\u3002 Merge generator : Merge \u751f\u6210\u5668\u53ef\u7528\u65bc\u5408\u4f75\u5169\u500b\u6216\u591a\u500b\u751f\u6210\u5668\u7684\u751f\u6210\u53c3\u6578\u3002\u5176\u4ed6\u751f\u6210\u5668\u53ef\u4ee5\u8986\u84cb\u57fa\u672c\u751f\u6210\u5668\u7684\u503c\u3002 SCM Provider generator : SCM \u63d0\u4f9b\u8005\u751f\u6210\u5668\u4f7f\u7528 SCM \u63d0\u4f9b\u8005\uff08\u4f8b\u5982 GitHub\uff09\u7684 API \u4f86\u81ea\u52d5\u767c\u73fe\u7d44\u7e54\u5167\u7684\u5b58\u5132\u5eab\u3002 Pull Request generator : \u62c9\u53d6\u8acb\u6c42\u751f\u6210\u5668\u4f7f\u7528 SCMaaS \u63d0\u4f9b\u8005\uff08\u4f8b\u5982 GitHub\uff09\u7684 API \u4f86\u81ea\u52d5\u767c\u73fe\u5b58\u5132\u5eab\u4e2d\u6253\u958b\u7684\u62c9\u53d6\u8acb\u6c42\u3002 Cluster Decision Resource generator : \u96c6\u7fa4\u6c7a\u7b56\u8cc7\u6e90\u751f\u6210\u5668\u7528\u65bc\u8207 Kubernetes \u81ea\u5b9a\u7fa9\u8cc7\u6e90\u4ea4\u4e92\uff0c\u9019\u4e9b\u8cc7\u6e90\u4f7f\u7528\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u7279\u5b9a\u908f\u8f2f\u4f86\u6c7a\u5b9a\u8981\u90e8\u7f72\u5230\u54ea\u4e00\u7d44 Argo CD \u96c6\u7fa4\u3002 \u5982\u679c\u60a8\u4e0d\u719f\u6089\u751f\u6210\u5668\uff0c\u8acb\u5f9e List generator \u548c Cluster generator \u958b\u59cb\u3002\u6709\u95dc\u66f4\u9ad8\u7d1a\u7684\u7528\u4f8b\uff0c\u8acb\u53c3\u95b1\u4e0a\u9762\u5176\u9918\u751f\u6210\u5668\u7684\u6587\u6a94\u3002","title":"Generators"},{"location":"argocd/applicationset/generators/generators-cluster/","text":"Cluster Generator \u00b6 \u5728 Argo CD \u4e2d\uff0c\u8a17\u7ba1\u96c6\u7fa4\u5b58\u5132\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u7684 Secrets \u4e2d\u3002 ApplicationSet \u63a7\u5236\u5668\u4f7f\u7528\u9019\u4e9b\u76f8\u540c\u7684 Secret \u4f86\u751f\u6210\u53c3\u6578\u4f86\u8b58\u5225\u548c\u5b9a\u4f4d\u53ef\u7528\u7684\u96c6\u7fa4\u3002 \u5c0d\u65bc\u8a3b\u518a\u9032 Argo CD \u7684\u6bcf\u500b\u96c6\u7fa4\uff0c\u96c6\u7fa4\u751f\u6210\u5668\u6703\u6839\u64da\u5728\u96c6\u7fa4\u5bc6\u9470\u4e2d\u627e\u5230\u7684\u9805\u76ee\u5217\u8868\u751f\u6210\u53c3\u6578\u3002 \u5b83\u6703\u81ea\u52d5\u70ba\u6bcf\u500b\u96c6\u7fa4\u7684 Application \u6a21\u677f\u63d0\u4f9b\u4ee5\u4e0b\u53c3\u6578\u503c\uff1a name nameNormalized \uff08 name \u4f46\u898f\u7bc4\u5316\u70ba\u50c5\u5305\u542b\u5c0f\u5beb\u5b57\u6bcd\u6578\u5b57\u5b57\u7b26\uff0c - \u6216 . \uff09 server metadata.labels.<key> (\u5c0d\u65bc Secret \u4e2d\u7684\u6bcf\u500b\u6a19\u7c64) metadata.annotations.<key> (\u5c0d\u65bc Secret \u4e2d\u7684\u6bcf\u500b\u8a3b\u91cb) Info \u5982\u679c\u60a8\u7684\u96c6\u7fa4\u540d\u7a31\u5305\u542b\u5c0d Kubernetes \u8cc7\u6e90\u540d\u7a31\u7121\u6548\u7684\u5b57\u7b26\uff08\u4f8b\u5982\u4e0b\u5283\u7dda\uff09\uff0c\u8acb\u4f7f\u7528 nameNormalized \u53c3\u6578\u3002\u9019\u53ef\u4ee5\u9632\u6b62\u5448\u73fe\u540d\u7a31\u70ba my_cluster-app1 \u7684\u7121\u6548 Kubernetes \u8cc7\u6e90\uff0c\u800c\u662f\u5c07\u5b83\u5011\u8f49\u63db\u70ba my-cluster-app1 \u3002 \u5728 Argo CD \u96c6\u7fa4 Secrets \u4e2d\u662f\u63cf\u8ff0\u96c6\u7fa4\u7684\u6578\u64da\u5b57\u6bb5\uff1a kind : Secret data : # \u5728 Kubernetes \u4e2d\uff0c\u9019\u4e9b\u5b57\u6bb5\u5be6\u969b\u4e0a\u662f\u7528 Base64 \u7de8\u78bc\u7684\uff1b\u70ba\u4e86\u65b9\u4fbf\u8d77\u898b\uff0c\u5b83\u5011\u5728\u9019\u88e1\u88ab\u89e3\u78bc\u3002 # (\u5b83\u5011\u5728\u96c6\u7fa4\u751f\u6210\u5668\u4f5c\u70ba\u53c3\u6578\u50b3\u905e\u6642\u540c\u6a23\u88ab\u89e3\u78bc) config : \"{'tlsClientConfig':{'insecure':false}}\" name : \"in-cluster2\" server : \"https://kubernetes.default.svc\" metadata : labels : argocd.argoproj.io/secret-type : cluster # (...) Cluster Generator \u5c07\u81ea\u52d5\u8b58\u5225\u4f7f\u7528 Argo CD \u5b9a\u7fa9\u7684\u96c6\u7fa4\uff0c\u4e26\u63d0\u53d6\u96c6\u7fa4\u6578\u64da\u4f5c\u70ba\u53c3\u6578\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - clusters : {} # Automatically use all clusters defined within Argo CD template : metadata : name : '{{name}}-guestbook' # 'name' field of the Secret spec : project : \"default\" source : repoURL : https://github.com/argoproj/argocd-example-apps/ targetRevision : HEAD path : guestbook destination : server : '{{server}}' # 'server' field of the secret namespace : guestbook (\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002) \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u96c6\u7fa4\u5bc6\u9470\u7684 name \u548c server \u5b57\u6bb5\u7528\u65bc\u586b\u5145 Application \u8cc7\u6e90 name \u548c server \uff08\u7136\u5f8c\u7528\u65bc\u5b9a\u4f4d\u540c\u4e00\u96c6\u7fa4\uff09\u3002 Label selector \u00b6 Label selector \u53ef\u7528\u65bc\u5c07\u76ee\u6a19\u96c6\u7fa4\u7684\u7bc4\u570d\u7e2e\u5c0f\u5230\u50c5\u5339\u914d\u7279\u5b9a\u6a19\u7c64\u7684\u96c6\u7fa4\uff1a kind : ApplicationSet metadata : name : guestbook spec : generators : - clusters : selector : matchLabels : staging : true template : # (...) \u9019\u5c07\u5339\u914d\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\u7684 Argo CD \u96c6\u7fa4 secret\uff1a kind : Secret data : # (... fields as above ...) metadata : labels : argocd.argoproj.io/secret-type : cluster staging : \"true\" # (...) Cluster selector \u9084\u652f\u6301\u57fa\u65bc set-based \u7684\u9700\u6c42\uff0c\u4f9b \u591a\u500b\u6838\u5fc3 Kubernetes \u8cc7\u6e90\u4f7f\u7528 \u3002 Deploying to the local cluster \u00b6 \u5728 Argo CD \u4e2d\uff0c\u201c\u672c\u5730\u96c6\u7fa4\u201d\u662f\u5b89\u88dd Argo CD\uff08\u548c ApplicationSet \u63a7\u5236\u5668\uff09\u7684\u96c6\u7fa4\u3002\u9019\u662f\u70ba\u4e86\u5c07\u5176\u8207\u201c\u9060\u7a0b\u96c6\u7fa4\u201d\u5340\u5206\u958b\u4f86\uff0c\u5f8c\u8005\u662f\u90a3\u4e9b\u4ee5 \u8072\u660e\u65b9\u5f0f \u6216\u901a\u904e Argo CD CLI \u6dfb\u52a0\u5230 Argo CD \u7684\u96c6\u7fa4\u3002 \u5c0d\u65bc\u8207\u96c6\u7fa4\u9078\u64c7\u5668\u5339\u914d\u7684\u6bcf\u500b\u96c6\u7fa4\uff0c\u96c6\u7fa4\u751f\u6210\u5668\u5c07\u81ea\u52d5\u5b9a\u4f4d\u672c\u5730\u548c\u975e\u672c\u5730\u96c6\u7fa4\u3002 \u5982\u679c\u60a8\u5e0c\u671b\u50c5\u91dd\u5c0d\u61c9\u7528\u7a0b\u5e8f\u7684\u9060\u7a0b\u96c6\u7fa4\uff08\u4f8b\u5982\uff0c\u60a8\u60f3\u6392\u9664\u672c\u5730\u96c6\u7fa4\uff09\uff0c\u5247\u4f7f\u7528\u5e36\u6709\u6a19\u7c64\u7684\u96c6\u7fa4\u9078\u64c7\u5668\uff0c\u4f8b\u5982\uff1a spec : generators : - clusters : selector : matchLabels : argocd.argoproj.io/secret-type : cluster \u6b64 selector \u5c07\u8207\u9ed8\u8a8d\u672c\u5730\u96c6\u7fa4\u4e0d\u5339\u914d\uff0c\u56e0\u70ba\u9ed8\u8a8d\u672c\u5730\u96c6\u7fa4\u6c92\u6709 Secret\uff08\u56e0\u6b64\u8a72\u5bc6\u9470\u4e0a\u6c92\u6709 argocd.argoproj.io/secret-type \u6a19\u7c64\uff09\u3002\u5728\u8a72\u6a19\u7c64\u4e0a\u9078\u64c7\u7684\u4efb\u4f55\u96c6\u7fa4\u9078\u64c7\u5668\u90fd\u5c07\u81ea\u52d5\u6392\u9664\u9ed8\u8a8d\u7684\u672c\u5730\u96c6\u7fa4\u3002 \u4f46\u662f\uff0c\u5982\u679c\u60a8\u78ba\u5be6\u5e0c\u671b\u540c\u6642\u91dd\u5c0d\u672c\u5730\u548c\u975e\u672c\u5730\u96c6\u7fa4\uff0c\u540c\u6642\u9084\u4f7f\u7528\u6a19\u7c64\u5339\u914d\uff0c\u60a8\u53ef\u4ee5\u5728 Argo CD Web UI \u4e2d\u70ba\u672c\u5730\u96c6\u7fa4\u5275\u5efa\u4e00\u500b\u79d8\u5bc6\uff1a \u5728 Argo CD Web UI \u4e2d\uff0c\u9078\u64c7 Settings \uff0c\u7136\u5f8c\u9078\u64c7 Clusters \u3002 \u9078\u64c7\u60a8\u7684\u672c\u5730\u96c6\u7fa4\uff0c\u901a\u5e38\u547d\u540d\u70ba in-cluster \u3002 \u9ede\u64ca Edit \u6309\u9215\uff0c\u7136\u5f8c\u5c07\u96c6\u7fa4\u7684\u540d\u7a31\u66f4\u6539\u70ba\u53e6\u4e00\u500b\u503c\uff0c\u4f8b\u5982 in-cluster-local \u3002\u9019\u88e1\u7684\u4efb\u4f55\u5176\u4ed6\u503c\u90fd\u53ef\u4ee5\u3002 \u4fdd\u6301\u6240\u6709\u5176\u4ed6\u5b57\u6bb5\u4e0d\u8b8a\u3002 \u9ede\u64ca Save \u3002 \u9019\u4e9b\u6b65\u9a5f\u53ef\u80fd\u770b\u8d77\u4f86\u9055\u53cd\u76f4\u89ba\uff0c\u4f46\u66f4\u6539\u672c\u5730\u96c6\u7fa4\u7684\u9ed8\u8a8d\u503c\u4e4b\u4e00\u7684\u884c\u70ba\u6703\u5c0e\u81f4 Argo CD Web UI \u70ba\u8a72\u96c6\u7fa4\u5275\u5efa\u4e00\u500b\u65b0\u7684\u79d8\u5bc6\u3002\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u4e2d\uff0c\u60a8\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4e00\u500b\u540d\u70ba cluster-(cluster suffix) \u7684 Secret \u8cc7\u6e90\uff0c\u5176\u6a19\u7c64\u70ba \"argocd.argoproj.io/secret-type\": \"cluster\" \u3002\u60a8\u4e5f\u53ef\u4ee5\u4ee5\u8072\u660e\u65b9\u5f0f\u6216\u4f7f\u7528 CLI \u4f7f\u7528 argocd cluster add \"(context name)\" --in-cluster \uff0c\u800c\u4e0d\u662f\u901a\u904e Web UI\u3002 Pass additional key-value pairs via values field \u00b6 \u60a8\u53ef\u4ee5\u901a\u904e\u96c6\u7fa4\u751f\u6210\u5668\u7684 values \u5b57\u6bb5\u50b3\u905e\u984d\u5916\u7684\u4efb\u610f\u5b57\u7b26\u4e32\u9375\u503c\u5c0d\u3002\u901a\u904e\u503c\u5b57\u6bb5\u6dfb\u52a0\u7684\u503c\u4f5c\u70ba\u503c\u6dfb\u52a0\u3002(field) \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6839\u64da\u96c6\u7fa4\u5bc6\u9470\u4e0a\u7684\u5339\u914d\u6a19\u7c64\u50b3\u905e\u4fee\u8a02\u53c3\u6578\u503c\uff1a spec : generators : - clusters : selector : matchLabels : type : 'staging' # A key-value map for arbitrary parameters values : revision : HEAD # staging clusters use HEAD branch - clusters : selector : matchLabels : type : 'production' values : # production uses a different revision value, for 'stable' branch revision : stable template : metadata : name : '{{name}}-guestbook' spec : project : \"default\" source : repoURL : https://github.com/argoproj/argocd-example-apps/ # The cluster values field for each generator will be substituted here: targetRevision : '{{values.revision}}' path : guestbook destination : server : '{{server}}' namespace : guestbook \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u4f86\u81ea generators.clusters \u5b57\u6bb5\u7684\u4fee\u8a02\u503c\u4f5c\u70ba values.revision \u50b3\u905e\u5230\u6a21\u677f\u4e2d\uff0c\u5305\u542b HEAD \u6216 stable \uff08\u57fa\u65bc\u751f\u6210\u53c3\u6578\u96c6\u7684\u751f\u6210\u5668\uff09\u3002 Info \u524d\u7db4\u7e3d\u662f\u9644\u52a0\u5728\u901a\u904e generators.clusters.values \u5b57\u6bb5\u63d0\u4f9b\u7684\u503c\u4e4b\u524d\u3002\u78ba\u4fdd\u5728\u4f7f\u7528\u6a21\u677f\u6642\u5728\u53c3\u6578\u540d\u7a31\u4e2d\u5305\u542b\u6b64\u524d\u7db4\u3002","title":"Cluster Generator"},{"location":"argocd/applicationset/generators/generators-cluster/#cluster-generator","text":"\u5728 Argo CD \u4e2d\uff0c\u8a17\u7ba1\u96c6\u7fa4\u5b58\u5132\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u7684 Secrets \u4e2d\u3002 ApplicationSet \u63a7\u5236\u5668\u4f7f\u7528\u9019\u4e9b\u76f8\u540c\u7684 Secret \u4f86\u751f\u6210\u53c3\u6578\u4f86\u8b58\u5225\u548c\u5b9a\u4f4d\u53ef\u7528\u7684\u96c6\u7fa4\u3002 \u5c0d\u65bc\u8a3b\u518a\u9032 Argo CD \u7684\u6bcf\u500b\u96c6\u7fa4\uff0c\u96c6\u7fa4\u751f\u6210\u5668\u6703\u6839\u64da\u5728\u96c6\u7fa4\u5bc6\u9470\u4e2d\u627e\u5230\u7684\u9805\u76ee\u5217\u8868\u751f\u6210\u53c3\u6578\u3002 \u5b83\u6703\u81ea\u52d5\u70ba\u6bcf\u500b\u96c6\u7fa4\u7684 Application \u6a21\u677f\u63d0\u4f9b\u4ee5\u4e0b\u53c3\u6578\u503c\uff1a name nameNormalized \uff08 name \u4f46\u898f\u7bc4\u5316\u70ba\u50c5\u5305\u542b\u5c0f\u5beb\u5b57\u6bcd\u6578\u5b57\u5b57\u7b26\uff0c - \u6216 . \uff09 server metadata.labels.<key> (\u5c0d\u65bc Secret \u4e2d\u7684\u6bcf\u500b\u6a19\u7c64) metadata.annotations.<key> (\u5c0d\u65bc Secret \u4e2d\u7684\u6bcf\u500b\u8a3b\u91cb) Info \u5982\u679c\u60a8\u7684\u96c6\u7fa4\u540d\u7a31\u5305\u542b\u5c0d Kubernetes \u8cc7\u6e90\u540d\u7a31\u7121\u6548\u7684\u5b57\u7b26\uff08\u4f8b\u5982\u4e0b\u5283\u7dda\uff09\uff0c\u8acb\u4f7f\u7528 nameNormalized \u53c3\u6578\u3002\u9019\u53ef\u4ee5\u9632\u6b62\u5448\u73fe\u540d\u7a31\u70ba my_cluster-app1 \u7684\u7121\u6548 Kubernetes \u8cc7\u6e90\uff0c\u800c\u662f\u5c07\u5b83\u5011\u8f49\u63db\u70ba my-cluster-app1 \u3002 \u5728 Argo CD \u96c6\u7fa4 Secrets \u4e2d\u662f\u63cf\u8ff0\u96c6\u7fa4\u7684\u6578\u64da\u5b57\u6bb5\uff1a kind : Secret data : # \u5728 Kubernetes \u4e2d\uff0c\u9019\u4e9b\u5b57\u6bb5\u5be6\u969b\u4e0a\u662f\u7528 Base64 \u7de8\u78bc\u7684\uff1b\u70ba\u4e86\u65b9\u4fbf\u8d77\u898b\uff0c\u5b83\u5011\u5728\u9019\u88e1\u88ab\u89e3\u78bc\u3002 # (\u5b83\u5011\u5728\u96c6\u7fa4\u751f\u6210\u5668\u4f5c\u70ba\u53c3\u6578\u50b3\u905e\u6642\u540c\u6a23\u88ab\u89e3\u78bc) config : \"{'tlsClientConfig':{'insecure':false}}\" name : \"in-cluster2\" server : \"https://kubernetes.default.svc\" metadata : labels : argocd.argoproj.io/secret-type : cluster # (...) Cluster Generator \u5c07\u81ea\u52d5\u8b58\u5225\u4f7f\u7528 Argo CD \u5b9a\u7fa9\u7684\u96c6\u7fa4\uff0c\u4e26\u63d0\u53d6\u96c6\u7fa4\u6578\u64da\u4f5c\u70ba\u53c3\u6578\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - clusters : {} # Automatically use all clusters defined within Argo CD template : metadata : name : '{{name}}-guestbook' # 'name' field of the Secret spec : project : \"default\" source : repoURL : https://github.com/argoproj/argocd-example-apps/ targetRevision : HEAD path : guestbook destination : server : '{{server}}' # 'server' field of the secret namespace : guestbook (\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002) \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u96c6\u7fa4\u5bc6\u9470\u7684 name \u548c server \u5b57\u6bb5\u7528\u65bc\u586b\u5145 Application \u8cc7\u6e90 name \u548c server \uff08\u7136\u5f8c\u7528\u65bc\u5b9a\u4f4d\u540c\u4e00\u96c6\u7fa4\uff09\u3002","title":"Cluster Generator"},{"location":"argocd/applicationset/generators/generators-cluster/#label-selector","text":"Label selector \u53ef\u7528\u65bc\u5c07\u76ee\u6a19\u96c6\u7fa4\u7684\u7bc4\u570d\u7e2e\u5c0f\u5230\u50c5\u5339\u914d\u7279\u5b9a\u6a19\u7c64\u7684\u96c6\u7fa4\uff1a kind : ApplicationSet metadata : name : guestbook spec : generators : - clusters : selector : matchLabels : staging : true template : # (...) \u9019\u5c07\u5339\u914d\u5305\u542b\u4ee5\u4e0b\u5167\u5bb9\u7684 Argo CD \u96c6\u7fa4 secret\uff1a kind : Secret data : # (... fields as above ...) metadata : labels : argocd.argoproj.io/secret-type : cluster staging : \"true\" # (...) Cluster selector \u9084\u652f\u6301\u57fa\u65bc set-based \u7684\u9700\u6c42\uff0c\u4f9b \u591a\u500b\u6838\u5fc3 Kubernetes \u8cc7\u6e90\u4f7f\u7528 \u3002","title":"Label selector"},{"location":"argocd/applicationset/generators/generators-cluster/#deploying-to-the-local-cluster","text":"\u5728 Argo CD \u4e2d\uff0c\u201c\u672c\u5730\u96c6\u7fa4\u201d\u662f\u5b89\u88dd Argo CD\uff08\u548c ApplicationSet \u63a7\u5236\u5668\uff09\u7684\u96c6\u7fa4\u3002\u9019\u662f\u70ba\u4e86\u5c07\u5176\u8207\u201c\u9060\u7a0b\u96c6\u7fa4\u201d\u5340\u5206\u958b\u4f86\uff0c\u5f8c\u8005\u662f\u90a3\u4e9b\u4ee5 \u8072\u660e\u65b9\u5f0f \u6216\u901a\u904e Argo CD CLI \u6dfb\u52a0\u5230 Argo CD \u7684\u96c6\u7fa4\u3002 \u5c0d\u65bc\u8207\u96c6\u7fa4\u9078\u64c7\u5668\u5339\u914d\u7684\u6bcf\u500b\u96c6\u7fa4\uff0c\u96c6\u7fa4\u751f\u6210\u5668\u5c07\u81ea\u52d5\u5b9a\u4f4d\u672c\u5730\u548c\u975e\u672c\u5730\u96c6\u7fa4\u3002 \u5982\u679c\u60a8\u5e0c\u671b\u50c5\u91dd\u5c0d\u61c9\u7528\u7a0b\u5e8f\u7684\u9060\u7a0b\u96c6\u7fa4\uff08\u4f8b\u5982\uff0c\u60a8\u60f3\u6392\u9664\u672c\u5730\u96c6\u7fa4\uff09\uff0c\u5247\u4f7f\u7528\u5e36\u6709\u6a19\u7c64\u7684\u96c6\u7fa4\u9078\u64c7\u5668\uff0c\u4f8b\u5982\uff1a spec : generators : - clusters : selector : matchLabels : argocd.argoproj.io/secret-type : cluster \u6b64 selector \u5c07\u8207\u9ed8\u8a8d\u672c\u5730\u96c6\u7fa4\u4e0d\u5339\u914d\uff0c\u56e0\u70ba\u9ed8\u8a8d\u672c\u5730\u96c6\u7fa4\u6c92\u6709 Secret\uff08\u56e0\u6b64\u8a72\u5bc6\u9470\u4e0a\u6c92\u6709 argocd.argoproj.io/secret-type \u6a19\u7c64\uff09\u3002\u5728\u8a72\u6a19\u7c64\u4e0a\u9078\u64c7\u7684\u4efb\u4f55\u96c6\u7fa4\u9078\u64c7\u5668\u90fd\u5c07\u81ea\u52d5\u6392\u9664\u9ed8\u8a8d\u7684\u672c\u5730\u96c6\u7fa4\u3002 \u4f46\u662f\uff0c\u5982\u679c\u60a8\u78ba\u5be6\u5e0c\u671b\u540c\u6642\u91dd\u5c0d\u672c\u5730\u548c\u975e\u672c\u5730\u96c6\u7fa4\uff0c\u540c\u6642\u9084\u4f7f\u7528\u6a19\u7c64\u5339\u914d\uff0c\u60a8\u53ef\u4ee5\u5728 Argo CD Web UI \u4e2d\u70ba\u672c\u5730\u96c6\u7fa4\u5275\u5efa\u4e00\u500b\u79d8\u5bc6\uff1a \u5728 Argo CD Web UI \u4e2d\uff0c\u9078\u64c7 Settings \uff0c\u7136\u5f8c\u9078\u64c7 Clusters \u3002 \u9078\u64c7\u60a8\u7684\u672c\u5730\u96c6\u7fa4\uff0c\u901a\u5e38\u547d\u540d\u70ba in-cluster \u3002 \u9ede\u64ca Edit \u6309\u9215\uff0c\u7136\u5f8c\u5c07\u96c6\u7fa4\u7684\u540d\u7a31\u66f4\u6539\u70ba\u53e6\u4e00\u500b\u503c\uff0c\u4f8b\u5982 in-cluster-local \u3002\u9019\u88e1\u7684\u4efb\u4f55\u5176\u4ed6\u503c\u90fd\u53ef\u4ee5\u3002 \u4fdd\u6301\u6240\u6709\u5176\u4ed6\u5b57\u6bb5\u4e0d\u8b8a\u3002 \u9ede\u64ca Save \u3002 \u9019\u4e9b\u6b65\u9a5f\u53ef\u80fd\u770b\u8d77\u4f86\u9055\u53cd\u76f4\u89ba\uff0c\u4f46\u66f4\u6539\u672c\u5730\u96c6\u7fa4\u7684\u9ed8\u8a8d\u503c\u4e4b\u4e00\u7684\u884c\u70ba\u6703\u5c0e\u81f4 Argo CD Web UI \u70ba\u8a72\u96c6\u7fa4\u5275\u5efa\u4e00\u500b\u65b0\u7684\u79d8\u5bc6\u3002\u5728 Argo CD \u547d\u540d\u7a7a\u9593\u4e2d\uff0c\u60a8\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4e00\u500b\u540d\u70ba cluster-(cluster suffix) \u7684 Secret \u8cc7\u6e90\uff0c\u5176\u6a19\u7c64\u70ba \"argocd.argoproj.io/secret-type\": \"cluster\" \u3002\u60a8\u4e5f\u53ef\u4ee5\u4ee5\u8072\u660e\u65b9\u5f0f\u6216\u4f7f\u7528 CLI \u4f7f\u7528 argocd cluster add \"(context name)\" --in-cluster \uff0c\u800c\u4e0d\u662f\u901a\u904e Web UI\u3002","title":"Deploying to the local cluster"},{"location":"argocd/applicationset/generators/generators-cluster/#pass-additional-key-value-pairs-via-values-field","text":"\u60a8\u53ef\u4ee5\u901a\u904e\u96c6\u7fa4\u751f\u6210\u5668\u7684 values \u5b57\u6bb5\u50b3\u905e\u984d\u5916\u7684\u4efb\u610f\u5b57\u7b26\u4e32\u9375\u503c\u5c0d\u3002\u901a\u904e\u503c\u5b57\u6bb5\u6dfb\u52a0\u7684\u503c\u4f5c\u70ba\u503c\u6dfb\u52a0\u3002(field) \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6839\u64da\u96c6\u7fa4\u5bc6\u9470\u4e0a\u7684\u5339\u914d\u6a19\u7c64\u50b3\u905e\u4fee\u8a02\u53c3\u6578\u503c\uff1a spec : generators : - clusters : selector : matchLabels : type : 'staging' # A key-value map for arbitrary parameters values : revision : HEAD # staging clusters use HEAD branch - clusters : selector : matchLabels : type : 'production' values : # production uses a different revision value, for 'stable' branch revision : stable template : metadata : name : '{{name}}-guestbook' spec : project : \"default\" source : repoURL : https://github.com/argoproj/argocd-example-apps/ # The cluster values field for each generator will be substituted here: targetRevision : '{{values.revision}}' path : guestbook destination : server : '{{server}}' namespace : guestbook \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u4f86\u81ea generators.clusters \u5b57\u6bb5\u7684\u4fee\u8a02\u503c\u4f5c\u70ba values.revision \u50b3\u905e\u5230\u6a21\u677f\u4e2d\uff0c\u5305\u542b HEAD \u6216 stable \uff08\u57fa\u65bc\u751f\u6210\u53c3\u6578\u96c6\u7684\u751f\u6210\u5668\uff09\u3002 Info \u524d\u7db4\u7e3d\u662f\u9644\u52a0\u5728\u901a\u904e generators.clusters.values \u5b57\u6bb5\u63d0\u4f9b\u7684\u503c\u4e4b\u524d\u3002\u78ba\u4fdd\u5728\u4f7f\u7528\u6a21\u677f\u6642\u5728\u53c3\u6578\u540d\u7a31\u4e2d\u5305\u542b\u6b64\u524d\u7db4\u3002","title":"Pass additional key-value pairs via values field"},{"location":"argocd/applicationset/generators/generators-git/","text":"Git Generator \u00b6 Git generator \u5305\u542b\u5169\u500b\u5b50\u985e\u578b\uff1a Git directory generator \u548c Git file generator \u3002 Git Generator: Directories \u00b6 Git directory generator \u662f Git \u751f\u6210\u5668\u7684\u5169\u500b\u5b50\u985e\u578b\u4e4b\u4e00\uff0c\u5b83\u4f7f\u7528\u6307\u5b9a Git \u5b58\u5132\u5eab\u7684\u76ee\u9304\u7d50\u69cb\u751f\u6210\u53c3\u6578\u3002\u5047\u8a2d\u60a8\u6709\u4e00\u500b\u5177\u6709\u4ee5\u4e0b\u76ee\u9304\u7d50\u69cb\u7684 Git \u5b58\u5132\u5eab\uff1a \u251c\u2500\u2500 argo-workflows \u2502 \u251c\u2500\u2500 kustomization.yaml \u2502 \u2514\u2500\u2500 namespace-install.yaml \u2514\u2500\u2500 prometheus-operator \u251c\u2500\u2500 Chart.yaml \u251c\u2500\u2500 README.md \u251c\u2500\u2500 requirements.yaml \u2514\u2500\u2500 values.yaml \u6b64\u5b58\u5132\u5eab\u5305\u542b\u5169\u500b\u76ee\u9304\uff0c\u4e00\u500b\u7528\u65bc\u90e8\u7f72\u7684\u6bcf\u500b\u5de5\u4f5c\u8ca0\u8f09\uff1a Argo Workflow \u63a7\u5236\u5668\u81ea\u5b9a\u7fa9 YAML \u6587\u4ef6 Prometheus Operator Helm chart \u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u793a\u4f8b\u90e8\u7f72\u9019\u5169\u500b\u5de5\u4f5c\u8ca0\u8f09\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : cluster-addons spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git revision : HEAD directories : - path : examples/git-generator-directory/cluster-addons/* template : metadata : name : '{{path[0]}}' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : '{{path}}' destination : server : https://kubernetes.default.svc namespace : '{{path.basename}}' \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u751f\u6210\u5668\u53c3\u6578\u70ba\uff1a {{path}} \uff1a \u8207\u8def\u5f91\u901a\u914d\u7b26\u5339\u914d\u7684 Git \u5b58\u5132\u5eab\u4e2d\u7684\u76ee\u9304\u8def\u5f91\u3002 {{path[n]}} \uff1a Git \u5b58\u5132\u5eab\u4e2d\u8207\u8def\u5f91\u901a\u914d\u7b26\u5339\u914d\u7684\u76ee\u9304\u8def\u5f91\uff0c\u62c6\u5206\u70ba\u6578\u7d44\u5143\u7d20\uff08 n - \u6578\u7d44\u7d22\u5f15\uff09 {{path.basename}} \uff1a \u5c0d\u65bc\u8207\u8def\u5f91\u901a\u914d\u7b26\u5339\u914d\u7684 Git \u5b58\u5132\u5eab\u4e2d\u7684\u4efb\u4f55\u76ee\u9304\u8def\u5f91\uff0c\u5c07\u63d0\u53d6\u6700\u53f3\u908a\u7684\u8def\u5f91\u540d\uff08\u4f8b\u5982 /directory/directory2 \u5c07\u751f\u6210 directory2 \uff09\u3002 {{path.basenameNormalized}} \uff1a \u6b64\u5b57\u6bb5\u8207 path.basename \u76f8\u540c\uff0c\u4f46\u4e0d\u652f\u6301\u7684\u5b57\u7b26\u66ff\u63db\u70ba -\uff08\u4f8b\u5982 /directory/directory_2 \u7684\u8def\u5f91\uff0c\u800c directory_2 \u7684 path.basename \u5c07\u5728\u6b64\u8655\u751f\u6210 directory-2 \uff09\u3002 \u6bcf\u7576\u5c07\u65b0\u7684 Helm chart/Kustomize YAML/Application/plain \u5b50\u6587\u4ef6\u593e\u6dfb\u52a0\u5230 Git \u5b58\u5132\u5eab\u6642\uff0cApplicationSet \u63a7\u5236\u5668\u5c07\u6aa2\u6e2c\u5230\u6b64\u66f4\u6539\u4e26\u81ea\u52d5\u5c07\u751f\u6210\u7684\u6e05\u55ae\u90e8\u7f72\u5230\u65b0\u7684\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u4e2d\u3002 \u8207\u5176\u4ed6\u751f\u6210\u5668\u4e00\u6a23\uff0c\u96c6\u7fa4\u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0c\u4ee5\u4fbf\u70ba\u5b83\u5011\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u3002 Exclude \u76ee\u9304 \u00b6 Git \u76ee\u9304\u751f\u6210\u5668\u5c07\u81ea\u52d5\u6392\u9664\u4ee5 . \uff08\u4f8b\u5982 .git \uff09\u3002 Git \u76ee\u9304\u751f\u6210\u5668\u9084\u652f\u6301 exclude \u9078\u9805\uff0c\u4ee5\u4fbf\u5c07\u5b58\u5132\u5eab\u4e2d\u7684\u76ee\u9304\u6392\u9664\u5728 ApplicationSet \u63a7\u5236\u5668\u7684\u6383\u63cf\u7bc4\u570d\u4e4b\u5916\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : cluster-addons spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git revision : HEAD directories : - path : examples/git-generator-directory/excludes/cluster-addons/* - path : examples/git-generator-directory/excludes/cluster-addons/exclude-helm-guestbook exclude : true template : metadata : name : '{{path.basename}}' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : '{{path}}' destination : server : https://kubernetes.default.svc namespace : '{{path.basename}}' \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u6b64\u793a\u4f8b\u5f9e\u70ba\u6b64 ApplictionSet \u8cc7\u6e90\u6383\u63cf\u7684\u76ee\u9304\u5217\u8868\u4e2d\u6392\u9664 exclude-helm-guestbook \u76ee\u9304\u3002 Info \u5982\u679c\u4e00\u500b\u76ee\u9304\u8207\u81f3\u5c11\u4e00\u500b exclude \u6a21\u5f0f\u5339\u914d\uff0c\u5b83\u5c07\u88ab\u6392\u9664\u3002\u6216\u8005\uff0c\u63db\u4e00\u7a2e\u8aaa\u6cd5\uff0cexclude \u898f\u5247\u512a\u5148\u65bc include \u898f\u5247\u3002 \u4f5c\u70ba\u63a8\u8ad6\uff0c\u5305\u542b/\u6392\u9664\u54ea\u4e9b\u76ee\u9304\u4e0d\u53d7\u76ee\u9304\u5b57\u6bb5\u5217\u8868\u4e2d\u8def\u5f91\u9806\u5e8f\u7684\u5f71\u97ff\uff08\u56e0\u70ba\u5982\u4e0a\u6240\u8ff0\uff0c\u6392\u9664\u898f\u5247\u59cb\u7d42\u512a\u5148\u65bc\u5305\u542b\u898f\u5247\uff09\u3002 \u4f8b\u5982\uff0c\u5c0d\u65bc\u9019\u4e9b\u76ee\u9304\uff1a . \u2514\u2500\u2500 d \u251c\u2500\u2500 e \u251c\u2500\u2500 f \u2514\u2500\u2500 g \u5047\u8a2d\u60a8\u60f3\u5305\u542b /d/e \uff0c\u4f46\u6392\u9664 /d/f \u548c /d/g \u3002\u9019\u5c07\u4e0d\u8d77\u4f5c\u7528\uff1a - path : /d/e exclude : false - path : /d/* exclude : true \u70ba\u4ec0\u9ebc\uff1f\u56e0\u70ba exclude /d/* \u6392\u9664\u898f\u5247\u5c07\u512a\u5148\u65bc /d/e \u5305\u542b\u898f\u5247\u3002\u7576 ApplicationSet \u63a7\u5236\u5668\u8655\u7406 Git \u5b58\u5132\u5eab\u4e2d\u7684 /d/e \u8def\u5f91\u6642\uff0c\u63a7\u5236\u5668\u6aa2\u6e2c\u5230\u81f3\u5c11\u5339\u914d\u4e00\u500b\u6392\u9664\u898f\u5247\uff0c\u56e0\u6b64\u4e0d\u61c9\u6383\u63cf\u8a72\u76ee\u9304\u3002 \u76f8\u53cd\uff0c\u60a8\u9700\u8981\u9019\u6a23\u505a\uff1a - path : /d/* - path : /d/f exclude : true - path : /d/g exclude : true \u6216\u8005\uff0c\u66f4\u77ed\u7684\u65b9\u6cd5\uff08\u4f7f\u7528 path.Match \u8a9e\u6cd5\uff09\u662f\uff1a - path : /d/* - path : /d/[f|g] exclude : true Git Generator\uff1aFiles \u00b6 Git \u6587\u4ef6\u751f\u6210\u5668\u662f Git \u751f\u6210\u5668\u7684\u7b2c\u4e8c\u500b\u5b50\u985e\u578b\u3002 Git \u6587\u4ef6\u751f\u6210\u5668\u4f7f\u7528\u5728\u6307\u5b9a\u5b58\u5132\u5eab\u4e2d\u627e\u5230\u7684 JSON/YAML \u6587\u4ef6\u7684\u5167\u5bb9\u751f\u6210\u53c3\u6578\u3002 \u5047\u8a2d\u60a8\u6709\u4e00\u500b\u5177\u6709\u4ee5\u4e0b\u76ee\u9304\u7d50\u69cb\u7684 Git \u5b58\u5132\u5eab\uff1a \u251c\u2500\u2500 apps \u2502 \u2514\u2500\u2500 guestbook \u2502 \u251c\u2500\u2500 guestbook-ui-deployment.yaml \u2502 \u251c\u2500\u2500 guestbook-ui-svc.yaml \u2502 \u2514\u2500\u2500 kustomization.yaml \u251c\u2500\u2500 cluster-config \u2502 \u2514\u2500\u2500 engineering \u2502 \u251c\u2500\u2500 dev \u2502 \u2502 \u2514\u2500\u2500 config.json \u2502 \u2514\u2500\u2500 prod \u2502 \u2514\u2500\u2500 config.json \u2514\u2500\u2500 git-generator-files.yaml \u6587\u4ef6\u593e\u662f\uff1a guestbook \u5305\u542b\u7528\u65bc\u7c21\u55ae\u7559\u8a00\u7c3f\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u8cc7\u6e90 cluster-config \u5305\u542b\u63cf\u8ff0\u5404\u500b engineering \u96c6\u7fa4\u7684 JSON/YAML \u6587\u4ef6\uff1a\u4e00\u500b\u7528\u65bc\u958b\u767c\uff0c\u4e00\u500b\u7528\u65bc\u751f\u7522\u3002 git-generator-files.yaml \u662f\u5c07\u7559\u8a00\u7c3f\u90e8\u7f72\u5230\u6307\u5b9a\u96c6\u7fa4\u7684\u793a\u4f8b ApplicationSet \u8cc7\u6e90\u3002 config.json \u6587\u4ef6\u5305\u542b\u63cf\u8ff0\u96c6\u7fa4\u7684\u4fe1\u606f\uff08\u4ee5\u53ca\u984d\u5916\u7684\u6a23\u672c\u6578\u64da\uff09\uff1a config.json { \"aws_account\" : \"123456\" , \"asset_id\" : \"11223344\" , \"cluster\" : { \"owner\" : \"cluster-admin@company.com\" , \"name\" : \"engineering-dev\" , \"address\" : \"https://1.2.3.4\" } } Git \u751f\u6210\u5668\u6703\u81ea\u52d5\u767c\u73fe\u5305\u542b\u5c0d config.json \u6587\u4ef6\u7684\u66f4\u6539\u7684 Git \u63d0\u4ea4\uff0c\u9019\u4e9b\u6587\u4ef6\u7684\u5167\u5bb9\u6703\u88ab\u89e3\u6790\u4e26\u8f49\u63db\u70ba\u6a21\u677f\u53c3\u6578\u3002\u4ee5\u4e0b\u662f\u70ba\u4e0a\u8ff0 JSON \u751f\u6210\u7684\u53c3\u6578\uff1a aws_account: 123456 asset_id: 11223344 cluster.owner: cluster-admin@company.com cluster.name: engineering-dev cluster.address: https://1.2.3.4 \u6240\u6709\u767c\u73fe\u7684 config.json \u6587\u4ef6\u7684\u751f\u6210\u53c3\u6578\u5c07\u88ab\u66ff\u63db\u70ba ApplicationSet \u6a21\u677f\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git revision : HEAD files : - path : \"examples/git-generator-files-discovery/cluster-config/**/config.json\" template : metadata : name : '{{cluster.name}}-guestbook' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : \"examples/git-generator-files-discovery/apps/guestbook\" destination : server : '{{cluster.address}}' namespace : guestbook \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u5728 cluster-config \u76ee\u9304\u4e0b\u627e\u5230\u7684\u4efb\u4f55 config.json \u6587\u4ef6\u90fd\u5c07\u6839\u64da\u6307\u5b9a\u7684\u8def\u5f91\u901a\u914d\u7b26\u6a21\u5f0f\u9032\u884c\u53c3\u6578\u5316\u3002\u5728\u6bcf\u500b\u6587\u4ef6\u4e2d\uff0cJSON \u5b57\u6bb5\u88ab\u6241\u5e73\u5316\u70ba\u9375/\u503c\u5c0d\uff0c\u6b64 ApplicationSet \u793a\u4f8b\u4f7f\u7528 cluster.address \u4f5c\u70ba\u6a21\u677f\u4e2d\u7684 cluster.name \u53c3\u6578\u3002 \u8207\u5176\u4ed6\u751f\u6210\u5668\u4e00\u6a23\uff0c\u96c6\u7fa4\u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0c\u4ee5\u4fbf\u70ba\u5b83\u5011\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u3002 \u9664\u4e86\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6241\u5e73\u5316\u9375/\u503c\u5c0d\u4e4b\u5916\uff0c\u9084\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u751f\u6210\u5668\u53c3\u6578\uff1a {{path}} : Git \u5b58\u5132\u5eab\u4e2d\u5305\u542b\u5339\u914d\u914d\u7f6e\u6587\u4ef6\u7684\u6587\u4ef6\u593e\u7684\u8def\u5f91\u3002\u793a\u4f8b\uff1a /clusters/clusterA \uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u662f /clusters/clusterA/config.json {{path[n]}}: Git \u5b58\u5132\u5eab\u4e2d\u5339\u914d\u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f91\uff0c\u62c6\u5206\u70ba\u6578\u7d44\u5143\u7d20\uff08n - \u6578\u7d44\u7d22\u5f15\uff09\u3002\u793a\u4f8b\uff1a path[0]: clusters , path[1]: clusterA {{path.basename}}: \u5305\u542b\u914d\u7f6e\u6587\u4ef6\u7684\u6587\u4ef6\u593e\u8def\u5f91\u7684\u57fa\u672c\u540d\u7a31\uff08\u4f8b\u5982 clusterA\uff0c\u4e0a\u9762\u7684\u793a\u4f8b\u3002\uff09 {{path.basenameNormalized}}: \u8a72\u5b57\u6bb5\u8207 path.basename \u76f8\u540c\uff0c\u5c07\u4e0d\u652f\u6301\u7684\u5b57\u7b26\u66ff\u63db\u70ba - \uff08\u4f8b\u5982 /directory/directory_2 \u7684\u8def\u5f91\uff0c\u800c directory_2 \u7684 path.basename \u5c07\u5728\u6b64\u8655\u751f\u6210 directory-2 \uff09\u3002 Webhook \u914d\u7f6e \u00b6 \u4f7f\u7528 Git \u751f\u6210\u5668\u6642\uff0c ApplicationSet \u6bcf\u4e09\u5206\u9418\u8f2a\u8a62\u4e00\u6b21 Git \u5b58\u5132\u5eab\u4ee5\u6aa2\u6e2c\u66f4\u6539\u3002\u70ba\u4e86\u6d88\u9664\u8f2a\u8a62\u7684\u9019\u7a2e\u5ef6\u9072\uff0c\u53ef\u4ee5\u5c07 ApplicationSet webhook \u670d\u52d9\u5668\u914d\u7f6e\u70ba\u63a5\u6536 webhook \u4e8b\u4ef6\u3002 ApplicationSet \u652f\u6301\u4f86\u81ea GitHub \u548c GitLab \u7684 Git webhook \u901a\u77e5\u3002\u4ee5\u4e0b\u8aaa\u660e\u5982\u4f55\u70ba GitHub \u914d\u7f6e Git webhook\uff0c\u4f46\u76f8\u540c\u7684\u904e\u7a0b\u61c9\u8a72\u9069\u7528\u65bc\u5176\u4ed6\u63d0\u4f9b\u7a0b\u5e8f\u3002 Info ApplicationSet \u5c07 webhook \u670d\u52d9\u5668\u516c\u958b\u70ba ClusterIP \u985e\u578b\u7684\u670d\u52d9\u3002\u9700\u8981\u5275\u5efa\u4e00\u500b Ingress \u8cc7\u6e90\u4f86\u5c07\u6b64\u670d\u52d9\u516c\u958b\u7d66 webhook \u6e90\u3002 1. \u5728 Git \u63d0\u4f9b\u8005\u4e2d\u5275\u5efa webhook \u00b6 \u5728\u60a8\u7684 Git \u63d0\u4f9b\u7a0b\u5e8f\u4e2d\uff0c\u5c0e\u822a\u5230\u53ef\u4ee5\u914d\u7f6e webhook \u7684\u8a2d\u7f6e\u9801\u9762\u3002 Git \u63d0\u4f9b\u7a0b\u5e8f\u4e2d\u914d\u7f6e\u7684\u6709\u6548\u8ca0\u8f09 URL \u61c9\u4f7f\u7528 ApplicationSet \u5be6\u4f8b\u7684 /api/webhook \u7aef\u9ede\uff08\u4f8b\u5982 https://applicationset.example.com/api/webhook \uff09\u3002\u5982\u679c\u60a8\u5e0c\u671b\u4f7f\u7528\u5171\u4eab\u5bc6\u9470\uff0c\u8acb\u5728\u5bc6\u9470\u4e2d\u8f38\u5165\u4efb\u610f\u503c\u3002\u5728\u4e0b\u4e00\u6b65\u914d\u7f6e webhook \u6642\u5c07\u4f7f\u7528\u6b64\u503c\u3002 Info \u5728 GitHub \u4e2d\u5275\u5efa webhook \u6642\uff0c\u201c\u5167\u5bb9\u985e\u578b\u201d\u9700\u8981\u8a2d\u7f6e\u70ba\u201capplication/json\u201d\u3002\u7528\u65bc\u8655\u7406\u9264\u5b50\u7684\u5eab\u4e0d\u652f\u6301\u9ed8\u8a8d\u503c\u201c\u200b\u200bapplication/x-www-form-urlencoded\u201d 2. \u4f7f\u7528 webhook secret \u914d\u7f6e ApplicationSet\uff08\u53ef\u9078\uff09 \u00b6 \u914d\u7f6e webhook \u5171\u4eab\u5bc6\u9470\u662f\u53ef\u9078\u7684\uff0c\u56e0\u70ba ApplicationSet \u4ecd\u7136\u6703\u5237\u65b0 Git \u751f\u6210\u5668\u751f\u6210\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5373\u4f7f\u662f\u672a\u7d93\u8eab\u4efd\u9a57\u8b49\u7684 webhook \u4e8b\u4ef6\u3002\u9019\u6a23\u505a\u662f\u5b89\u5168\u7684\uff0c\u56e0\u70ba webhook \u6709\u6548\u8ca0\u8f09\u7684\u5167\u5bb9\u88ab\u8a8d\u70ba\u662f\u4e0d\u53ef\u4fe1\u7684\uff0c\u4e26\u4e14\u53ea\u6703\u5c0e\u81f4\u61c9\u7528\u7a0b\u5e8f\u7684\u5237\u65b0\uff08\u9019\u500b\u904e\u7a0b\u5df2\u7d93\u4ee5\u4e09\u5206\u9418\u7684\u9593\u9694\u767c\u751f\uff09\u3002\u5982\u679c ApplicationSet \u53ef\u516c\u958b\u8a2a\u554f\uff0c\u5247\u5efa\u8b70\u914d\u7f6e webhook secret \u4ee5\u9632\u6b62 DDoS \u653b\u64ca\u3002 \u5728 argocd-secret kubernetes secret \u4e2d\uff0c\u5305\u542b\u5728\u6b65\u9a5f 1 \u4e2d\u914d\u7f6e\u7684 Git \u63d0\u4f9b\u7a0b\u5e8f\u7684 webhook secret\u3002 \u7de8\u8f2f Argo CD kubernetes secret\uff1a kubectl edit secret argocd-secret -n argocd Tip \u63d0\u793a\uff1a\u70ba\u4e86\u65b9\u4fbf\u8f38\u5165\u79d8\u5bc6\uff0ckubernetes \u652f\u6301\u5728 stringData \u5b57\u6bb5\u4e2d\u8f38\u5165\u79d8\u5bc6\uff0c\u9019\u6a23\u5c31\u7701\u53bb\u4e86\u5c0d\u503c\u9032\u884c base64 \u7de8\u78bc\u4e26\u5c07\u5176\u8907\u88fd\u5230\u6578\u64da\u5b57\u6bb5\u7684\u9ebb\u7169\u3002\u53ea\u9700\u5c07\u6b65\u9a5f 1 \u4e2d\u5275\u5efa\u7684\u5171\u4eab webhook \u5bc6\u9470\u8907\u88fd\u5230 stringData \u5b57\u6bb5\u4e0b\u7684\u76f8\u61c9 GitHub/GitLab/BitBucket \u9375\uff1a apiVersion : v1 kind : Secret metadata : name : argocd-secret namespace : argocd type : Opaque data : ... stringData : # github webhook secret webhook.github.secret : shhhh! it's a github secret # gitlab webhook secret webhook.gitlab.secret : shhhh! it's a gitlab secret \u4fdd\u5b58\u5f8c\uff0c\u8acb\u91cd\u555f ApplicationSet pod \u4ee5\u4f7f\u66f4\u6539\u751f\u6548\u3002","title":"Git Generator"},{"location":"argocd/applicationset/generators/generators-git/#git-generator","text":"Git generator \u5305\u542b\u5169\u500b\u5b50\u985e\u578b\uff1a Git directory generator \u548c Git file generator \u3002","title":"Git Generator"},{"location":"argocd/applicationset/generators/generators-git/#git-generator-directories","text":"Git directory generator \u662f Git \u751f\u6210\u5668\u7684\u5169\u500b\u5b50\u985e\u578b\u4e4b\u4e00\uff0c\u5b83\u4f7f\u7528\u6307\u5b9a Git \u5b58\u5132\u5eab\u7684\u76ee\u9304\u7d50\u69cb\u751f\u6210\u53c3\u6578\u3002\u5047\u8a2d\u60a8\u6709\u4e00\u500b\u5177\u6709\u4ee5\u4e0b\u76ee\u9304\u7d50\u69cb\u7684 Git \u5b58\u5132\u5eab\uff1a \u251c\u2500\u2500 argo-workflows \u2502 \u251c\u2500\u2500 kustomization.yaml \u2502 \u2514\u2500\u2500 namespace-install.yaml \u2514\u2500\u2500 prometheus-operator \u251c\u2500\u2500 Chart.yaml \u251c\u2500\u2500 README.md \u251c\u2500\u2500 requirements.yaml \u2514\u2500\u2500 values.yaml \u6b64\u5b58\u5132\u5eab\u5305\u542b\u5169\u500b\u76ee\u9304\uff0c\u4e00\u500b\u7528\u65bc\u90e8\u7f72\u7684\u6bcf\u500b\u5de5\u4f5c\u8ca0\u8f09\uff1a Argo Workflow \u63a7\u5236\u5668\u81ea\u5b9a\u7fa9 YAML \u6587\u4ef6 Prometheus Operator Helm chart \u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u793a\u4f8b\u90e8\u7f72\u9019\u5169\u500b\u5de5\u4f5c\u8ca0\u8f09\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : cluster-addons spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git revision : HEAD directories : - path : examples/git-generator-directory/cluster-addons/* template : metadata : name : '{{path[0]}}' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : '{{path}}' destination : server : https://kubernetes.default.svc namespace : '{{path.basename}}' \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u751f\u6210\u5668\u53c3\u6578\u70ba\uff1a {{path}} \uff1a \u8207\u8def\u5f91\u901a\u914d\u7b26\u5339\u914d\u7684 Git \u5b58\u5132\u5eab\u4e2d\u7684\u76ee\u9304\u8def\u5f91\u3002 {{path[n]}} \uff1a Git \u5b58\u5132\u5eab\u4e2d\u8207\u8def\u5f91\u901a\u914d\u7b26\u5339\u914d\u7684\u76ee\u9304\u8def\u5f91\uff0c\u62c6\u5206\u70ba\u6578\u7d44\u5143\u7d20\uff08 n - \u6578\u7d44\u7d22\u5f15\uff09 {{path.basename}} \uff1a \u5c0d\u65bc\u8207\u8def\u5f91\u901a\u914d\u7b26\u5339\u914d\u7684 Git \u5b58\u5132\u5eab\u4e2d\u7684\u4efb\u4f55\u76ee\u9304\u8def\u5f91\uff0c\u5c07\u63d0\u53d6\u6700\u53f3\u908a\u7684\u8def\u5f91\u540d\uff08\u4f8b\u5982 /directory/directory2 \u5c07\u751f\u6210 directory2 \uff09\u3002 {{path.basenameNormalized}} \uff1a \u6b64\u5b57\u6bb5\u8207 path.basename \u76f8\u540c\uff0c\u4f46\u4e0d\u652f\u6301\u7684\u5b57\u7b26\u66ff\u63db\u70ba -\uff08\u4f8b\u5982 /directory/directory_2 \u7684\u8def\u5f91\uff0c\u800c directory_2 \u7684 path.basename \u5c07\u5728\u6b64\u8655\u751f\u6210 directory-2 \uff09\u3002 \u6bcf\u7576\u5c07\u65b0\u7684 Helm chart/Kustomize YAML/Application/plain \u5b50\u6587\u4ef6\u593e\u6dfb\u52a0\u5230 Git \u5b58\u5132\u5eab\u6642\uff0cApplicationSet \u63a7\u5236\u5668\u5c07\u6aa2\u6e2c\u5230\u6b64\u66f4\u6539\u4e26\u81ea\u52d5\u5c07\u751f\u6210\u7684\u6e05\u55ae\u90e8\u7f72\u5230\u65b0\u7684\u61c9\u7528\u7a0b\u5e8f\u8cc7\u6e90\u4e2d\u3002 \u8207\u5176\u4ed6\u751f\u6210\u5668\u4e00\u6a23\uff0c\u96c6\u7fa4\u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0c\u4ee5\u4fbf\u70ba\u5b83\u5011\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u3002","title":"Git Generator: Directories"},{"location":"argocd/applicationset/generators/generators-git/#exclude","text":"Git \u76ee\u9304\u751f\u6210\u5668\u5c07\u81ea\u52d5\u6392\u9664\u4ee5 . \uff08\u4f8b\u5982 .git \uff09\u3002 Git \u76ee\u9304\u751f\u6210\u5668\u9084\u652f\u6301 exclude \u9078\u9805\uff0c\u4ee5\u4fbf\u5c07\u5b58\u5132\u5eab\u4e2d\u7684\u76ee\u9304\u6392\u9664\u5728 ApplicationSet \u63a7\u5236\u5668\u7684\u6383\u63cf\u7bc4\u570d\u4e4b\u5916\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : cluster-addons spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git revision : HEAD directories : - path : examples/git-generator-directory/excludes/cluster-addons/* - path : examples/git-generator-directory/excludes/cluster-addons/exclude-helm-guestbook exclude : true template : metadata : name : '{{path.basename}}' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : '{{path}}' destination : server : https://kubernetes.default.svc namespace : '{{path.basename}}' \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u6b64\u793a\u4f8b\u5f9e\u70ba\u6b64 ApplictionSet \u8cc7\u6e90\u6383\u63cf\u7684\u76ee\u9304\u5217\u8868\u4e2d\u6392\u9664 exclude-helm-guestbook \u76ee\u9304\u3002 Info \u5982\u679c\u4e00\u500b\u76ee\u9304\u8207\u81f3\u5c11\u4e00\u500b exclude \u6a21\u5f0f\u5339\u914d\uff0c\u5b83\u5c07\u88ab\u6392\u9664\u3002\u6216\u8005\uff0c\u63db\u4e00\u7a2e\u8aaa\u6cd5\uff0cexclude \u898f\u5247\u512a\u5148\u65bc include \u898f\u5247\u3002 \u4f5c\u70ba\u63a8\u8ad6\uff0c\u5305\u542b/\u6392\u9664\u54ea\u4e9b\u76ee\u9304\u4e0d\u53d7\u76ee\u9304\u5b57\u6bb5\u5217\u8868\u4e2d\u8def\u5f91\u9806\u5e8f\u7684\u5f71\u97ff\uff08\u56e0\u70ba\u5982\u4e0a\u6240\u8ff0\uff0c\u6392\u9664\u898f\u5247\u59cb\u7d42\u512a\u5148\u65bc\u5305\u542b\u898f\u5247\uff09\u3002 \u4f8b\u5982\uff0c\u5c0d\u65bc\u9019\u4e9b\u76ee\u9304\uff1a . \u2514\u2500\u2500 d \u251c\u2500\u2500 e \u251c\u2500\u2500 f \u2514\u2500\u2500 g \u5047\u8a2d\u60a8\u60f3\u5305\u542b /d/e \uff0c\u4f46\u6392\u9664 /d/f \u548c /d/g \u3002\u9019\u5c07\u4e0d\u8d77\u4f5c\u7528\uff1a - path : /d/e exclude : false - path : /d/* exclude : true \u70ba\u4ec0\u9ebc\uff1f\u56e0\u70ba exclude /d/* \u6392\u9664\u898f\u5247\u5c07\u512a\u5148\u65bc /d/e \u5305\u542b\u898f\u5247\u3002\u7576 ApplicationSet \u63a7\u5236\u5668\u8655\u7406 Git \u5b58\u5132\u5eab\u4e2d\u7684 /d/e \u8def\u5f91\u6642\uff0c\u63a7\u5236\u5668\u6aa2\u6e2c\u5230\u81f3\u5c11\u5339\u914d\u4e00\u500b\u6392\u9664\u898f\u5247\uff0c\u56e0\u6b64\u4e0d\u61c9\u6383\u63cf\u8a72\u76ee\u9304\u3002 \u76f8\u53cd\uff0c\u60a8\u9700\u8981\u9019\u6a23\u505a\uff1a - path : /d/* - path : /d/f exclude : true - path : /d/g exclude : true \u6216\u8005\uff0c\u66f4\u77ed\u7684\u65b9\u6cd5\uff08\u4f7f\u7528 path.Match \u8a9e\u6cd5\uff09\u662f\uff1a - path : /d/* - path : /d/[f|g] exclude : true","title":"Exclude \u76ee\u9304"},{"location":"argocd/applicationset/generators/generators-git/#git-generatorfiles","text":"Git \u6587\u4ef6\u751f\u6210\u5668\u662f Git \u751f\u6210\u5668\u7684\u7b2c\u4e8c\u500b\u5b50\u985e\u578b\u3002 Git \u6587\u4ef6\u751f\u6210\u5668\u4f7f\u7528\u5728\u6307\u5b9a\u5b58\u5132\u5eab\u4e2d\u627e\u5230\u7684 JSON/YAML \u6587\u4ef6\u7684\u5167\u5bb9\u751f\u6210\u53c3\u6578\u3002 \u5047\u8a2d\u60a8\u6709\u4e00\u500b\u5177\u6709\u4ee5\u4e0b\u76ee\u9304\u7d50\u69cb\u7684 Git \u5b58\u5132\u5eab\uff1a \u251c\u2500\u2500 apps \u2502 \u2514\u2500\u2500 guestbook \u2502 \u251c\u2500\u2500 guestbook-ui-deployment.yaml \u2502 \u251c\u2500\u2500 guestbook-ui-svc.yaml \u2502 \u2514\u2500\u2500 kustomization.yaml \u251c\u2500\u2500 cluster-config \u2502 \u2514\u2500\u2500 engineering \u2502 \u251c\u2500\u2500 dev \u2502 \u2502 \u2514\u2500\u2500 config.json \u2502 \u2514\u2500\u2500 prod \u2502 \u2514\u2500\u2500 config.json \u2514\u2500\u2500 git-generator-files.yaml \u6587\u4ef6\u593e\u662f\uff1a guestbook \u5305\u542b\u7528\u65bc\u7c21\u55ae\u7559\u8a00\u7c3f\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u8cc7\u6e90 cluster-config \u5305\u542b\u63cf\u8ff0\u5404\u500b engineering \u96c6\u7fa4\u7684 JSON/YAML \u6587\u4ef6\uff1a\u4e00\u500b\u7528\u65bc\u958b\u767c\uff0c\u4e00\u500b\u7528\u65bc\u751f\u7522\u3002 git-generator-files.yaml \u662f\u5c07\u7559\u8a00\u7c3f\u90e8\u7f72\u5230\u6307\u5b9a\u96c6\u7fa4\u7684\u793a\u4f8b ApplicationSet \u8cc7\u6e90\u3002 config.json \u6587\u4ef6\u5305\u542b\u63cf\u8ff0\u96c6\u7fa4\u7684\u4fe1\u606f\uff08\u4ee5\u53ca\u984d\u5916\u7684\u6a23\u672c\u6578\u64da\uff09\uff1a config.json { \"aws_account\" : \"123456\" , \"asset_id\" : \"11223344\" , \"cluster\" : { \"owner\" : \"cluster-admin@company.com\" , \"name\" : \"engineering-dev\" , \"address\" : \"https://1.2.3.4\" } } Git \u751f\u6210\u5668\u6703\u81ea\u52d5\u767c\u73fe\u5305\u542b\u5c0d config.json \u6587\u4ef6\u7684\u66f4\u6539\u7684 Git \u63d0\u4ea4\uff0c\u9019\u4e9b\u6587\u4ef6\u7684\u5167\u5bb9\u6703\u88ab\u89e3\u6790\u4e26\u8f49\u63db\u70ba\u6a21\u677f\u53c3\u6578\u3002\u4ee5\u4e0b\u662f\u70ba\u4e0a\u8ff0 JSON \u751f\u6210\u7684\u53c3\u6578\uff1a aws_account: 123456 asset_id: 11223344 cluster.owner: cluster-admin@company.com cluster.name: engineering-dev cluster.address: https://1.2.3.4 \u6240\u6709\u767c\u73fe\u7684 config.json \u6587\u4ef6\u7684\u751f\u6210\u53c3\u6578\u5c07\u88ab\u66ff\u63db\u70ba ApplicationSet \u6a21\u677f\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - git : repoURL : https://github.com/argoproj/applicationset.git revision : HEAD files : - path : \"examples/git-generator-files-discovery/cluster-config/**/config.json\" template : metadata : name : '{{cluster.name}}-guestbook' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : \"examples/git-generator-files-discovery/apps/guestbook\" destination : server : '{{cluster.address}}' namespace : guestbook \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u5728 cluster-config \u76ee\u9304\u4e0b\u627e\u5230\u7684\u4efb\u4f55 config.json \u6587\u4ef6\u90fd\u5c07\u6839\u64da\u6307\u5b9a\u7684\u8def\u5f91\u901a\u914d\u7b26\u6a21\u5f0f\u9032\u884c\u53c3\u6578\u5316\u3002\u5728\u6bcf\u500b\u6587\u4ef6\u4e2d\uff0cJSON \u5b57\u6bb5\u88ab\u6241\u5e73\u5316\u70ba\u9375/\u503c\u5c0d\uff0c\u6b64 ApplicationSet \u793a\u4f8b\u4f7f\u7528 cluster.address \u4f5c\u70ba\u6a21\u677f\u4e2d\u7684 cluster.name \u53c3\u6578\u3002 \u8207\u5176\u4ed6\u751f\u6210\u5668\u4e00\u6a23\uff0c\u96c6\u7fa4\u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0c\u4ee5\u4fbf\u70ba\u5b83\u5011\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u3002 \u9664\u4e86\u914d\u7f6e\u6587\u4ef6\u4e2d\u7684\u6241\u5e73\u5316\u9375/\u503c\u5c0d\u4e4b\u5916\uff0c\u9084\u63d0\u4f9b\u4e86\u4ee5\u4e0b\u751f\u6210\u5668\u53c3\u6578\uff1a {{path}} : Git \u5b58\u5132\u5eab\u4e2d\u5305\u542b\u5339\u914d\u914d\u7f6e\u6587\u4ef6\u7684\u6587\u4ef6\u593e\u7684\u8def\u5f91\u3002\u793a\u4f8b\uff1a /clusters/clusterA \uff0c\u5982\u679c\u914d\u7f6e\u6587\u4ef6\u662f /clusters/clusterA/config.json {{path[n]}}: Git \u5b58\u5132\u5eab\u4e2d\u5339\u914d\u914d\u7f6e\u6587\u4ef6\u7684\u8def\u5f91\uff0c\u62c6\u5206\u70ba\u6578\u7d44\u5143\u7d20\uff08n - \u6578\u7d44\u7d22\u5f15\uff09\u3002\u793a\u4f8b\uff1a path[0]: clusters , path[1]: clusterA {{path.basename}}: \u5305\u542b\u914d\u7f6e\u6587\u4ef6\u7684\u6587\u4ef6\u593e\u8def\u5f91\u7684\u57fa\u672c\u540d\u7a31\uff08\u4f8b\u5982 clusterA\uff0c\u4e0a\u9762\u7684\u793a\u4f8b\u3002\uff09 {{path.basenameNormalized}}: \u8a72\u5b57\u6bb5\u8207 path.basename \u76f8\u540c\uff0c\u5c07\u4e0d\u652f\u6301\u7684\u5b57\u7b26\u66ff\u63db\u70ba - \uff08\u4f8b\u5982 /directory/directory_2 \u7684\u8def\u5f91\uff0c\u800c directory_2 \u7684 path.basename \u5c07\u5728\u6b64\u8655\u751f\u6210 directory-2 \uff09\u3002","title":"Git Generator\uff1aFiles"},{"location":"argocd/applicationset/generators/generators-git/#webhook","text":"\u4f7f\u7528 Git \u751f\u6210\u5668\u6642\uff0c ApplicationSet \u6bcf\u4e09\u5206\u9418\u8f2a\u8a62\u4e00\u6b21 Git \u5b58\u5132\u5eab\u4ee5\u6aa2\u6e2c\u66f4\u6539\u3002\u70ba\u4e86\u6d88\u9664\u8f2a\u8a62\u7684\u9019\u7a2e\u5ef6\u9072\uff0c\u53ef\u4ee5\u5c07 ApplicationSet webhook \u670d\u52d9\u5668\u914d\u7f6e\u70ba\u63a5\u6536 webhook \u4e8b\u4ef6\u3002 ApplicationSet \u652f\u6301\u4f86\u81ea GitHub \u548c GitLab \u7684 Git webhook \u901a\u77e5\u3002\u4ee5\u4e0b\u8aaa\u660e\u5982\u4f55\u70ba GitHub \u914d\u7f6e Git webhook\uff0c\u4f46\u76f8\u540c\u7684\u904e\u7a0b\u61c9\u8a72\u9069\u7528\u65bc\u5176\u4ed6\u63d0\u4f9b\u7a0b\u5e8f\u3002 Info ApplicationSet \u5c07 webhook \u670d\u52d9\u5668\u516c\u958b\u70ba ClusterIP \u985e\u578b\u7684\u670d\u52d9\u3002\u9700\u8981\u5275\u5efa\u4e00\u500b Ingress \u8cc7\u6e90\u4f86\u5c07\u6b64\u670d\u52d9\u516c\u958b\u7d66 webhook \u6e90\u3002","title":"Webhook \u914d\u7f6e"},{"location":"argocd/applicationset/generators/generators-git/#1-git-webhook","text":"\u5728\u60a8\u7684 Git \u63d0\u4f9b\u7a0b\u5e8f\u4e2d\uff0c\u5c0e\u822a\u5230\u53ef\u4ee5\u914d\u7f6e webhook \u7684\u8a2d\u7f6e\u9801\u9762\u3002 Git \u63d0\u4f9b\u7a0b\u5e8f\u4e2d\u914d\u7f6e\u7684\u6709\u6548\u8ca0\u8f09 URL \u61c9\u4f7f\u7528 ApplicationSet \u5be6\u4f8b\u7684 /api/webhook \u7aef\u9ede\uff08\u4f8b\u5982 https://applicationset.example.com/api/webhook \uff09\u3002\u5982\u679c\u60a8\u5e0c\u671b\u4f7f\u7528\u5171\u4eab\u5bc6\u9470\uff0c\u8acb\u5728\u5bc6\u9470\u4e2d\u8f38\u5165\u4efb\u610f\u503c\u3002\u5728\u4e0b\u4e00\u6b65\u914d\u7f6e webhook \u6642\u5c07\u4f7f\u7528\u6b64\u503c\u3002 Info \u5728 GitHub \u4e2d\u5275\u5efa webhook \u6642\uff0c\u201c\u5167\u5bb9\u985e\u578b\u201d\u9700\u8981\u8a2d\u7f6e\u70ba\u201capplication/json\u201d\u3002\u7528\u65bc\u8655\u7406\u9264\u5b50\u7684\u5eab\u4e0d\u652f\u6301\u9ed8\u8a8d\u503c\u201c\u200b\u200bapplication/x-www-form-urlencoded\u201d","title":"1. \u5728 Git \u63d0\u4f9b\u8005\u4e2d\u5275\u5efa webhook"},{"location":"argocd/applicationset/generators/generators-git/#2-webhook-secret-applicationset","text":"\u914d\u7f6e webhook \u5171\u4eab\u5bc6\u9470\u662f\u53ef\u9078\u7684\uff0c\u56e0\u70ba ApplicationSet \u4ecd\u7136\u6703\u5237\u65b0 Git \u751f\u6210\u5668\u751f\u6210\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5373\u4f7f\u662f\u672a\u7d93\u8eab\u4efd\u9a57\u8b49\u7684 webhook \u4e8b\u4ef6\u3002\u9019\u6a23\u505a\u662f\u5b89\u5168\u7684\uff0c\u56e0\u70ba webhook \u6709\u6548\u8ca0\u8f09\u7684\u5167\u5bb9\u88ab\u8a8d\u70ba\u662f\u4e0d\u53ef\u4fe1\u7684\uff0c\u4e26\u4e14\u53ea\u6703\u5c0e\u81f4\u61c9\u7528\u7a0b\u5e8f\u7684\u5237\u65b0\uff08\u9019\u500b\u904e\u7a0b\u5df2\u7d93\u4ee5\u4e09\u5206\u9418\u7684\u9593\u9694\u767c\u751f\uff09\u3002\u5982\u679c ApplicationSet \u53ef\u516c\u958b\u8a2a\u554f\uff0c\u5247\u5efa\u8b70\u914d\u7f6e webhook secret \u4ee5\u9632\u6b62 DDoS \u653b\u64ca\u3002 \u5728 argocd-secret kubernetes secret \u4e2d\uff0c\u5305\u542b\u5728\u6b65\u9a5f 1 \u4e2d\u914d\u7f6e\u7684 Git \u63d0\u4f9b\u7a0b\u5e8f\u7684 webhook secret\u3002 \u7de8\u8f2f Argo CD kubernetes secret\uff1a kubectl edit secret argocd-secret -n argocd Tip \u63d0\u793a\uff1a\u70ba\u4e86\u65b9\u4fbf\u8f38\u5165\u79d8\u5bc6\uff0ckubernetes \u652f\u6301\u5728 stringData \u5b57\u6bb5\u4e2d\u8f38\u5165\u79d8\u5bc6\uff0c\u9019\u6a23\u5c31\u7701\u53bb\u4e86\u5c0d\u503c\u9032\u884c base64 \u7de8\u78bc\u4e26\u5c07\u5176\u8907\u88fd\u5230\u6578\u64da\u5b57\u6bb5\u7684\u9ebb\u7169\u3002\u53ea\u9700\u5c07\u6b65\u9a5f 1 \u4e2d\u5275\u5efa\u7684\u5171\u4eab webhook \u5bc6\u9470\u8907\u88fd\u5230 stringData \u5b57\u6bb5\u4e0b\u7684\u76f8\u61c9 GitHub/GitLab/BitBucket \u9375\uff1a apiVersion : v1 kind : Secret metadata : name : argocd-secret namespace : argocd type : Opaque data : ... stringData : # github webhook secret webhook.github.secret : shhhh! it's a github secret # gitlab webhook secret webhook.gitlab.secret : shhhh! it's a gitlab secret \u4fdd\u5b58\u5f8c\uff0c\u8acb\u91cd\u555f ApplicationSet pod \u4ee5\u4f7f\u66f4\u6539\u751f\u6548\u3002","title":"2. \u4f7f\u7528 webhook secret \u914d\u7f6e ApplicationSet\uff08\u53ef\u9078\uff09"},{"location":"argocd/applicationset/generators/generators-list/","text":"List Generator \u00b6 List generator \u6839\u64da\u9375/\u503c\u5c0d\u7684\u5217\u8868\u751f\u6210\u53c3\u6578\uff08\u53ea\u8981\u503c\u662f\u5b57\u7b26\u4e32\u503c\uff09\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6211\u5011\u4ee5\u540d\u70ba engineering-dev \u7684\u672c\u5730\u96c6\u7fa4\u70ba\u76ee\u6a19\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - list : elements : - cluster : engineering-dev url : https://kubernetes.default.svc # - cluster: engineering-prod # url: https://kubernetes.default.svc # foo: bar template : metadata : name : '{{cluster}}-guestbook' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : examples/list-generator/guestbook/{{cluster}} destination : server : '{{url}}' namespace : guestbook \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u5217\u8868\u751f\u6210\u5668\u5c07 url \u548c cluster \u5b57\u6bb5\u4f5c\u70ba\u53c3\u6578\u50b3\u905e\u5230\u6a21\u677f\u4e2d\u3002\u5982\u679c\u6211\u5011\u60f3\u6dfb\u52a0\u7b2c\u4e8c\u500b\u74b0\u5883\uff0c\u6211\u5011\u53ef\u4ee5\u53d6\u6d88\u8a3b\u91cb\u7b2c\u4e8c\u500b\u5143\u7d20\uff0cApplicationSet \u63a7\u5236\u5668\u6703\u81ea\u52d5\u5c07\u5176\u5b9a\u4f4d\u5230\u5b9a\u7fa9\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u5728 ApplicationSet v0.1.0 \u7248\u672c\u4e2d\uff0c\u53ea\u80fd\u6307\u5b9a url \u548c cluster \u5143\u7d20\u5b57\u6bb5\uff08\u52a0\u4e0a\u4efb\u610f\u503c\uff09\u3002\u5f9e ApplicationSet v0.2.0 \u958b\u59cb\uff0c\u652f\u6301\u4efb\u4f55\u9375/\u503c\u5143\u7d20\u5c0d\uff08\u9019\u4e5f\u5b8c\u5168\u5411\u5f8c\u517c\u5bb9 v0.1.0 \u5f62\u5f0f\uff09\uff1a spec : generators : - list : elements : # v0.1.0 form - requires cluster/url keys: - cluster : engineering-dev url : https://kubernetes.default.svc values : additional : value # v0.2.0+ form - does not require cluster/URL keys # (but they are still supported). - staging : \"true\" gitRepo : https://kubernetes.default.svc # (...) Info \u9019\u4e9b clusters \u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0c\u4ee5\u4fbf\u70ba\u9019\u4e9b\u503c\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u3002 ApplicationSet \u63a7\u5236\u5668\u4e0d\u6703\u5728 Argo CD \u4e2d\u5275\u5efa\u96c6\u7fa4\uff08\u4f8b\u5982\uff0c\u5b83\u6c92\u6709\u9019\u6a23\u505a\u7684\u6191\u64da\uff09\u3002","title":"List Generator"},{"location":"argocd/applicationset/generators/generators-list/#list-generator","text":"List generator \u6839\u64da\u9375/\u503c\u5c0d\u7684\u5217\u8868\u751f\u6210\u53c3\u6578\uff08\u53ea\u8981\u503c\u662f\u5b57\u7b26\u4e32\u503c\uff09\u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6211\u5011\u4ee5\u540d\u70ba engineering-dev \u7684\u672c\u5730\u96c6\u7fa4\u70ba\u76ee\u6a19\uff1a apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : guestbook spec : generators : - list : elements : - cluster : engineering-dev url : https://kubernetes.default.svc # - cluster: engineering-prod # url: https://kubernetes.default.svc # foo: bar template : metadata : name : '{{cluster}}-guestbook' spec : project : default source : repoURL : https://github.com/argoproj/applicationset.git targetRevision : HEAD path : examples/list-generator/guestbook/{{cluster}} destination : server : '{{url}}' namespace : guestbook \uff08\u5b8c\u6574\u7684\u4f8b\u5b50\u53ef\u4ee5\u5728 \u9019\u88e1 \u627e\u5230\u3002\uff09 \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u5217\u8868\u751f\u6210\u5668\u5c07 url \u548c cluster \u5b57\u6bb5\u4f5c\u70ba\u53c3\u6578\u50b3\u905e\u5230\u6a21\u677f\u4e2d\u3002\u5982\u679c\u6211\u5011\u60f3\u6dfb\u52a0\u7b2c\u4e8c\u500b\u74b0\u5883\uff0c\u6211\u5011\u53ef\u4ee5\u53d6\u6d88\u8a3b\u91cb\u7b2c\u4e8c\u500b\u5143\u7d20\uff0cApplicationSet \u63a7\u5236\u5668\u6703\u81ea\u52d5\u5c07\u5176\u5b9a\u4f4d\u5230\u5b9a\u7fa9\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u5728 ApplicationSet v0.1.0 \u7248\u672c\u4e2d\uff0c\u53ea\u80fd\u6307\u5b9a url \u548c cluster \u5143\u7d20\u5b57\u6bb5\uff08\u52a0\u4e0a\u4efb\u610f\u503c\uff09\u3002\u5f9e ApplicationSet v0.2.0 \u958b\u59cb\uff0c\u652f\u6301\u4efb\u4f55\u9375/\u503c\u5143\u7d20\u5c0d\uff08\u9019\u4e5f\u5b8c\u5168\u5411\u5f8c\u517c\u5bb9 v0.1.0 \u5f62\u5f0f\uff09\uff1a spec : generators : - list : elements : # v0.1.0 form - requires cluster/url keys: - cluster : engineering-dev url : https://kubernetes.default.svc values : additional : value # v0.2.0+ form - does not require cluster/URL keys # (but they are still supported). - staging : \"true\" gitRepo : https://kubernetes.default.svc # (...) Info \u9019\u4e9b clusters \u5fc5\u9808\u5df2\u7d93\u5728 Argo CD \u4e2d\u5b9a\u7fa9\uff0c\u4ee5\u4fbf\u70ba\u9019\u4e9b\u503c\u751f\u6210\u61c9\u7528\u7a0b\u5e8f\u3002 ApplicationSet \u63a7\u5236\u5668\u4e0d\u6703\u5728 Argo CD \u4e2d\u5275\u5efa\u96c6\u7fa4\uff08\u4f8b\u5982\uff0c\u5b83\u6c92\u6709\u9019\u6a23\u505a\u7684\u6191\u64da\uff09\u3002","title":"List Generator"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/","text":"\u4f7f\u7528 GitOps \u548c Argo CD Vault \u63d2\u4ef6\u9032\u884c Secret \u7ba1\u7406 \u00b6 \u539f\u6587: https://colinwilson.uk/2022/03/27/secret-management-with-gitops-and-argo-cd-vault-plugin/ GitOps \u5f88\u68d2\uff01\u4ec0\u9ebc\u662f GitOps\uff1f Info GitOps \u662f\u4e00\u7a2e\u9032\u884c Kubernetes \u96c6\u7fa4\u7ba1\u7406\u548c\u61c9\u7528\u4ea4\u4ed8\u7684\u65b9\u6cd5\u3002 GitOps \u901a\u904e\u4f7f\u7528 Git \u4f5c\u70ba\u8072\u660e\u6027\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u7684\u55ae\u4e00\u4e8b\u5be6\u4f86\u6e90\u4f86\u5de5\u4f5c\u3002 \u66f4\u7c21\u55ae\u5730\u8aaa\uff0cGitOps \u5141\u8a31\u60a8\u901a\u904e Git \u4ee5\u4ee3\u78bc\u7684\u5f62\u5f0f\u8a2d\u7f6e\u548c\u7ba1\u7406\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u3002 \u4f46\u662f\u5bc6\u78bc\u3001api \u4ee4\u724c\u3001\u6578\u64da\u5eab\u6191\u8b49\u548c\u5176\u4ed6\u79d8\u5bc6\u5462\uff1f\u9019\u4e9b\u4e5f\u53ef\u4ee5\u5b58\u5132\u5728 Git \u4e2d\u55ce\uff1f\u4e0d\uff01\uff01\uff01\u5728 Git \u4e2d\u5b58\u5132\u79d8\u5bc6\u662f\u4e00\u500b\u975e\u5e38\u7cdf\u7cd5\u7684\u4e3b\u610f\u3002\u9019\u5c31\u5f15\u51fa\u4e86\u4e00\u500b\u5e38\u898b\u7684\u554f\u984c\uff0c\u201c\u4f60\u5982\u4f55\u4f7f\u7528 GitOps \u8655\u7406\u79d8\u5bc6\uff1f\u201d\u3002 \u4f5c\u6cd5\u6709\u597d\u5e7e\u7a2e\u3002\u4e00\u7a2e\u5e38\u898b\u7684\u65b9\u6cd5\u662f\u5c0d\u6a5f\u5bc6\u672c\u8eab\u4f7f\u7528\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08\u4f8b\u5982 HashiCorp Vault\uff09\uff0c\u4e26\u4f7f\u7528\u53e6\u4e00\u500b\u5de5\u5177\uff08\u6216\u591a\u500b\u5de5\u5177\uff09\u5f9e\u7ba1\u7406\u5de5\u5177\u4e2d\u63d0\u53d6\u9019\u4e9b\u6a5f\u5bc6\u4e26\u5c07\u5b83\u5011\u201c\u6ce8\u5165\u201d\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002 \u672c\u6559\u7a0b\u6db5\u84cb\u4e86\u4f7f\u7528 Argo CD Vault Plugin \u7ba1\u7406\u6a5f\u5bc6\u7684\u7279\u5b9a\u5834\u666f\u3002 Argo CD Vault Plugin\uff08\u9867\u540d\u601d\u7fa9\uff09\u662f\u4e00\u500b Argo CD \u914d\u7f6e\u7ba1\u7406\u63d2\u4ef6\uff0c\u8207\u8a31\u591a\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08HashiCorp Vault\u3001IBM Cloud Secrets Manager\u3001AWS Secrets Manager \u7b49\uff09\u517c\u5bb9\u3002\u672c\u6559\u7a0b\u4ecb\u7d39\u4e86\u5b83\u8207 HashiCorp Vault \u7684\u96c6\u6210\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u5c0d\u65bc\u672c\u6307\u5357\uff0c\u60a8\u5c07\u9700\u8981\u4ee5\u4e0b\u5167\u5bb9\uff1a HashiCorp Vault \u5b89\u88dd Terraform\u3001Kubernetes\u3001Git/GitHub \u548c Traefik \u7684\u521d\u5b78\u8005\u5230\u4e2d\u7d1a\u77e5\u8b58 Terraform \u2265 v0.15 Argo CD Vault \u63d2\u4ef6\u7684\u5de5\u4f5c\u539f\u7406 \u00b6 Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u5c07\u4f54\u4f4d\u7b26 placeholder \u5b58\u5132\u5728 git \u4e2d\uff0c\u800c\u4e0d\u662f\u5be6\u969b\u7684 Kubernetes secret \u3002 \u6240\u4ee5\u4e00\u500b\u5178\u578b\u7684 yaml/manifest secret \u7bc4\u4f8b\u5982\u4e0b: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : bXlfZmlyc3Rfc2VjcmV0 Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u6211\u5011\u5c07 TOKEN \u7684\u503c\u66ff\u63db\u70ba\u4f54\u4f4d\u7b26 placeholder \u7136\u5f8c\u518d\u5b58\u5132\u5728 git \u4e2d\uff0c\u4f8b\u5982: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : <myToken> \u4e0b\u5716\u8aaa\u660e\u4e86 Argo CD Vault \u63d2\u4ef6\u5c07\u6a5f\u5bc6\u6ce8\u5165 Kubernetes \u96c6\u7fa4\u7684\u904e\u7a0b\u4e2d\u7684\u6b65\u9a5f\uff1a Argo CD \u5f9e Git Repo \u62c9\u53d6 Secret manifest \u6a21\u677f Vault \u63d2\u4ef6\u7531\u6a21\u677f\u4e2d\u5b58\u5728\u7684\u4f54\u4f4d\u7b26\u89f8\u767c \u8a72\u63d2\u4ef6\u901a\u904e Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e26\u62c9\u53d6 secret\uff08\u6839\u64da avp.kubernetes.io/path \u8a3b\u89e3\u8a2d\u7f6e\u7684\u8def\u5f91\u5b9a\u4f4d\uff09 \u6aa2\u7d22\u5230\u7684\u79d8\u5bc6\u88ab\u6ce8\u5165\u5230\u6a21\u677f\u4e2d\uff0c\u66ff\u63db\u4f54\u4f4d\u7b26 Argo CD \u7136\u5f8c\u5c07\u66f4\u65b0\u7684\u6e05\u55ae\u61c9\u7528\u5230 Kubernetes Tip Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc secret\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc deployment\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc\u79d8\u5bc6\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc\u90e8\u7f72\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002 ArgoCD \u5b89\u88dd \u00b6 \u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s \u66dd\u9732 ArgoCD \u670d\u52d9 \u00b6 \u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684\u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' \u4f7f\u7528 ArgoCD Web UI \u00b6 \u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002 \u5b89\u88dd ArgoCD-Vault-Plugin \u00b6","title":"\u4f7f\u7528 Argo CD Vault \u63d2\u4ef6\u9032\u884c Secret \u7ba1\u7406"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#gitops-argo-cd-vault-secret","text":"\u539f\u6587: https://colinwilson.uk/2022/03/27/secret-management-with-gitops-and-argo-cd-vault-plugin/ GitOps \u5f88\u68d2\uff01\u4ec0\u9ebc\u662f GitOps\uff1f Info GitOps \u662f\u4e00\u7a2e\u9032\u884c Kubernetes \u96c6\u7fa4\u7ba1\u7406\u548c\u61c9\u7528\u4ea4\u4ed8\u7684\u65b9\u6cd5\u3002 GitOps \u901a\u904e\u4f7f\u7528 Git \u4f5c\u70ba\u8072\u660e\u6027\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u7684\u55ae\u4e00\u4e8b\u5be6\u4f86\u6e90\u4f86\u5de5\u4f5c\u3002 \u66f4\u7c21\u55ae\u5730\u8aaa\uff0cGitOps \u5141\u8a31\u60a8\u901a\u904e Git \u4ee5\u4ee3\u78bc\u7684\u5f62\u5f0f\u8a2d\u7f6e\u548c\u7ba1\u7406\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u3002 \u4f46\u662f\u5bc6\u78bc\u3001api \u4ee4\u724c\u3001\u6578\u64da\u5eab\u6191\u8b49\u548c\u5176\u4ed6\u79d8\u5bc6\u5462\uff1f\u9019\u4e9b\u4e5f\u53ef\u4ee5\u5b58\u5132\u5728 Git \u4e2d\u55ce\uff1f\u4e0d\uff01\uff01\uff01\u5728 Git \u4e2d\u5b58\u5132\u79d8\u5bc6\u662f\u4e00\u500b\u975e\u5e38\u7cdf\u7cd5\u7684\u4e3b\u610f\u3002\u9019\u5c31\u5f15\u51fa\u4e86\u4e00\u500b\u5e38\u898b\u7684\u554f\u984c\uff0c\u201c\u4f60\u5982\u4f55\u4f7f\u7528 GitOps \u8655\u7406\u79d8\u5bc6\uff1f\u201d\u3002 \u4f5c\u6cd5\u6709\u597d\u5e7e\u7a2e\u3002\u4e00\u7a2e\u5e38\u898b\u7684\u65b9\u6cd5\u662f\u5c0d\u6a5f\u5bc6\u672c\u8eab\u4f7f\u7528\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08\u4f8b\u5982 HashiCorp Vault\uff09\uff0c\u4e26\u4f7f\u7528\u53e6\u4e00\u500b\u5de5\u5177\uff08\u6216\u591a\u500b\u5de5\u5177\uff09\u5f9e\u7ba1\u7406\u5de5\u5177\u4e2d\u63d0\u53d6\u9019\u4e9b\u6a5f\u5bc6\u4e26\u5c07\u5b83\u5011\u201c\u6ce8\u5165\u201d\u5230 Kubernetes \u96c6\u7fa4\u4e2d\u3002 \u672c\u6559\u7a0b\u6db5\u84cb\u4e86\u4f7f\u7528 Argo CD Vault Plugin \u7ba1\u7406\u6a5f\u5bc6\u7684\u7279\u5b9a\u5834\u666f\u3002 Argo CD Vault Plugin\uff08\u9867\u540d\u601d\u7fa9\uff09\u662f\u4e00\u500b Argo CD \u914d\u7f6e\u7ba1\u7406\u63d2\u4ef6\uff0c\u8207\u8a31\u591a\u6a5f\u5bc6\u7ba1\u7406\u5de5\u5177\uff08HashiCorp Vault\u3001IBM Cloud Secrets Manager\u3001AWS Secrets Manager \u7b49\uff09\u517c\u5bb9\u3002\u672c\u6559\u7a0b\u4ecb\u7d39\u4e86\u5b83\u8207 HashiCorp Vault \u7684\u96c6\u6210\u3002","title":"\u4f7f\u7528 GitOps \u548c Argo CD Vault \u63d2\u4ef6\u9032\u884c Secret \u7ba1\u7406"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#_1","text":"\u5c0d\u65bc\u672c\u6307\u5357\uff0c\u60a8\u5c07\u9700\u8981\u4ee5\u4e0b\u5167\u5bb9\uff1a HashiCorp Vault \u5b89\u88dd Terraform\u3001Kubernetes\u3001Git/GitHub \u548c Traefik \u7684\u521d\u5b78\u8005\u5230\u4e2d\u7d1a\u77e5\u8b58 Terraform \u2265 v0.15","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#argo-cd-vault","text":"Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u5c07\u4f54\u4f4d\u7b26 placeholder \u5b58\u5132\u5728 git \u4e2d\uff0c\u800c\u4e0d\u662f\u5be6\u969b\u7684 Kubernetes secret \u3002 \u6240\u4ee5\u4e00\u500b\u5178\u578b\u7684 yaml/manifest secret \u7bc4\u4f8b\u5982\u4e0b: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : bXlfZmlyc3Rfc2VjcmV0 Argo CD Vault \u63d2\u4ef6\u5141\u8a31\u6211\u5011\u5c07 TOKEN \u7684\u503c\u66ff\u63db\u70ba\u4f54\u4f4d\u7b26 placeholder \u7136\u5f8c\u518d\u5b58\u5132\u5728 git \u4e2d\uff0c\u4f8b\u5982: apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : TOKEN : <myToken> \u4e0b\u5716\u8aaa\u660e\u4e86 Argo CD Vault \u63d2\u4ef6\u5c07\u6a5f\u5bc6\u6ce8\u5165 Kubernetes \u96c6\u7fa4\u7684\u904e\u7a0b\u4e2d\u7684\u6b65\u9a5f\uff1a Argo CD \u5f9e Git Repo \u62c9\u53d6 Secret manifest \u6a21\u677f Vault \u63d2\u4ef6\u7531\u6a21\u677f\u4e2d\u5b58\u5728\u7684\u4f54\u4f4d\u7b26\u89f8\u767c \u8a72\u63d2\u4ef6\u901a\u904e Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e26\u62c9\u53d6 secret\uff08\u6839\u64da avp.kubernetes.io/path \u8a3b\u89e3\u8a2d\u7f6e\u7684\u8def\u5f91\u5b9a\u4f4d\uff09 \u6aa2\u7d22\u5230\u7684\u79d8\u5bc6\u88ab\u6ce8\u5165\u5230\u6a21\u677f\u4e2d\uff0c\u66ff\u63db\u4f54\u4f4d\u7b26 Argo CD \u7136\u5f8c\u5c07\u66f4\u65b0\u7684\u6e05\u55ae\u61c9\u7528\u5230 Kubernetes Tip Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc secret\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc deployment\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002","title":"Argo CD Vault \u63d2\u4ef6\u7684\u5de5\u4f5c\u539f\u7406"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#kubernetes","text":"\u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 Argo CD Vault \u63d2\u4ef6\u4e26\u975e\u5c08\u9580\u7528\u65bc\u79d8\u5bc6\u3002\u5b83\u9084\u53ef\u4ee5\u7528\u65bc\u90e8\u7f72\u3001configMaps \u6216\u4efb\u4f55\u5176\u4ed6 Kubernetes \u8cc7\u6e90\u3002 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd","text":"\u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s","title":"ArgoCD \u5b89\u88dd"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd_1","text":"\u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684\u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0'","title":"\u66dd\u9732 ArgoCD \u670d\u52d9"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd-web-ui","text":"\u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002","title":"\u4f7f\u7528 ArgoCD Web UI"},{"location":"argocd/argocd-vault-plugin/secret-management-argocd-vault/#argocd-vault-plugin","text":"","title":"\u5b89\u88dd ArgoCD-Vault-Plugin"},{"location":"argocd/tutorial/","text":"\u6b61\u8fce\u4f86\u5230 ArgoCD \u6559\u7a0b \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/index.html ArgoCD \u00b6 Argo CD \u662f\u7528\u65bc Kubernetes \u7684\u5ba3\u544a\u5f0f GitOps \u6301\u7e8c\u4ea4\u4ed8\u5de5\u5177\u3002 \u5b83\u9075\u5faa GitOps \u6a21\u5f0f\uff0c\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u5b9a\u7fa9\u6240\u9700\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u7684\u4e8b\u5be6\u4f86\u6e90\u3002 \u5b83\u5728\u6307\u5b9a\u7684\u76ee\u6a19\u74b0\u5883\u4e2d\u81ea\u52d5\u90e8\u7f72\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u3002\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u53ef\u4ee5\u8ddf\u8e2a\u5206\u652f\u3001\u6a19\u7c64\u7684\u66f4\u65b0\uff0c\u6216\u5728 Git \u63d0\u4ea4\u6642\u56fa\u5b9a\u5230\u7279\u5b9a\u7248\u672c\u7684\u6e05\u55ae\u3002 GitOps \u00b6 GitOps \u662f\u4e00\u7d44\u5229\u7528 Git \u5de5\u4f5c\u6d41\u4f86\u7ba1\u7406\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u7684\u5be6\u8e10\u3002\u901a\u904e\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u4e8b\u5be6\u4f86\u6e90\uff0c\u5b83\u5141\u8a31 DevOps \u5718\u968a\u5c07\u96c6\u7fa4\u914d\u7f6e\u7684\u6574\u500b\u72c0\u614b\u5b58\u5132\u5728 Git \u4e2d\uff0c\u4ee5\u4fbf\u66f4\u6539\u8ddf\u8e2a\u662f\u53ef\u898b\u548c\u53ef\u5be9\u8a08\u7684\u3002 GitOps \u901a\u904e\u5c07\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u5b9a\u7fa9\u70ba\u201c\u4ee3\u78bc\u201d\u4f86\u7c21\u5316\u8de8\u591a\u500b\u96c6\u7fa4\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u66f4\u6539\u7684\u50b3\u64ad\u3002 \u78ba\u4fdd\u96c6\u7fa4\u5177\u6709\u76f8\u4f3c\u7684\u914d\u7f6e\u3001\u76e3\u63a7\u6216\u5b58\u5132\u72c0\u614b\u3002 \u5f9e\u5df2\u77e5\u72c0\u614b\u6062\u5fa9\u6216\u91cd\u65b0\u5275\u5efa\u96c6\u7fa4\u3002 \u5275\u5efa\u5177\u6709\u5df2\u77e5\u72c0\u614b\u7684\u96c6\u7fa4\u3002 \u5c07\u914d\u7f6e\u66f4\u6539\u61c9\u7528\u6216\u9084\u539f\u5230\u591a\u500b\u96c6\u7fa4\u3002 \u5c07\u6a21\u677f\u5316\u914d\u7f6e\u8207\u4e0d\u540c\u7684\u74b0\u5883\u76f8\u95dc\u806f\u3002","title":"ArgoCD \u6559\u7a0b\u7c21\u4ecb"},{"location":"argocd/tutorial/#argocd","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/index.html","title":"\u6b61\u8fce\u4f86\u5230 ArgoCD \u6559\u7a0b"},{"location":"argocd/tutorial/#argocd_1","text":"Argo CD \u662f\u7528\u65bc Kubernetes \u7684\u5ba3\u544a\u5f0f GitOps \u6301\u7e8c\u4ea4\u4ed8\u5de5\u5177\u3002 \u5b83\u9075\u5faa GitOps \u6a21\u5f0f\uff0c\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u5b9a\u7fa9\u6240\u9700\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u7684\u4e8b\u5be6\u4f86\u6e90\u3002 \u5b83\u5728\u6307\u5b9a\u7684\u76ee\u6a19\u74b0\u5883\u4e2d\u81ea\u52d5\u90e8\u7f72\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u72c0\u614b\u3002\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u53ef\u4ee5\u8ddf\u8e2a\u5206\u652f\u3001\u6a19\u7c64\u7684\u66f4\u65b0\uff0c\u6216\u5728 Git \u63d0\u4ea4\u6642\u56fa\u5b9a\u5230\u7279\u5b9a\u7248\u672c\u7684\u6e05\u55ae\u3002","title":"ArgoCD"},{"location":"argocd/tutorial/#gitops","text":"GitOps \u662f\u4e00\u7d44\u5229\u7528 Git \u5de5\u4f5c\u6d41\u4f86\u7ba1\u7406\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u7684\u5be6\u8e10\u3002\u901a\u904e\u4f7f\u7528 Git \u5b58\u5132\u5eab\u4f5c\u70ba\u4e8b\u5be6\u4f86\u6e90\uff0c\u5b83\u5141\u8a31 DevOps \u5718\u968a\u5c07\u96c6\u7fa4\u914d\u7f6e\u7684\u6574\u500b\u72c0\u614b\u5b58\u5132\u5728 Git \u4e2d\uff0c\u4ee5\u4fbf\u66f4\u6539\u8ddf\u8e2a\u662f\u53ef\u898b\u548c\u53ef\u5be9\u8a08\u7684\u3002 GitOps \u901a\u904e\u5c07\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u5b9a\u7fa9\u70ba\u201c\u4ee3\u78bc\u201d\u4f86\u7c21\u5316\u8de8\u591a\u500b\u96c6\u7fa4\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u66f4\u6539\u7684\u50b3\u64ad\u3002 \u78ba\u4fdd\u96c6\u7fa4\u5177\u6709\u76f8\u4f3c\u7684\u914d\u7f6e\u3001\u76e3\u63a7\u6216\u5b58\u5132\u72c0\u614b\u3002 \u5f9e\u5df2\u77e5\u72c0\u614b\u6062\u5fa9\u6216\u91cd\u65b0\u5275\u5efa\u96c6\u7fa4\u3002 \u5275\u5efa\u5177\u6709\u5df2\u77e5\u72c0\u614b\u7684\u96c6\u7fa4\u3002 \u5c07\u914d\u7f6e\u66f4\u6539\u61c9\u7528\u6216\u9084\u539f\u5230\u591a\u500b\u96c6\u7fa4\u3002 \u5c07\u6a21\u677f\u5316\u914d\u7f6e\u8207\u4e0d\u540c\u7684\u74b0\u5883\u76f8\u95dc\u806f\u3002","title":"GitOps"},{"location":"argocd/tutorial/01-setup/","text":"\u8a2d\u5b9a \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/01-setup.html \u76f8\u95dc\u9700\u8981\u7684 CLI \u5de5\u5177 \u00b6 \u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u9700\u8981\u4ee5\u4e0b CLI \u5de5\u5177\u3002\u5728\u958b\u59cb\u5b78\u7fd2\u4efb\u4f55\u6559\u7a0b\u7ae0\u7bc0\u4e4b\u524d\uff0c\u8acb\u5148\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\u5011\u3002 Tool Linux Git Download Docker Download K3D v5.4.4 Download kubectl v1.20.2 Download argocd v2.0.0 Download kustomize v4.1.2 Download \u4ee5\u4e0b CLI \u5de5\u5177\u5c0d\u65bc\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u662f\u53ef\u9078\u7684\u3002\u5118\u7ba1\u5728\u6559\u7a0b\u4e2d\u4f7f\u7528\u4e86\u5b83\u5011\uff0c\u4f46\u60a8\u53ef\u4ee5\u6beb\u7121\u554f\u984c\u5730\u4f7f\u7528\u5176\u4ed6\u7684\u3002 \u53d6\u5f97\u6559\u7a0b\u8cc7\u6e90 \u00b6 \u5728\u958b\u59cb\u8a2d\u7f6e\u74b0\u5883\u4e4b\u524d\uff0c\u8b93\u6211\u5011 clone \u6559\u7a0b\u6e90\u78bc\u4e26\u5c07 TUTORIAL_HOME \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6559\u7a0b\u7684\u6839\u76ee\u9304\uff1a $ git clone https://github.com/redhat-scholars/argocd-tutorial.git gitops $ export TUTORIAL_HOME = \" $( pwd ) /gitops\" $ cd $TUTORIAL_HOME \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002 ArgoCD \u5b89\u88dd \u00b6 \u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml \u7d50\u679c: customresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created customresourcedefinition.apiextensions.k8s.io/applicationsets.argoproj.io created customresourcedefinition.apiextensions.k8s.io/appprojects.argoproj.io created serviceaccount/argocd-application-controller created serviceaccount/argocd-applicationset-controller created serviceaccount/argocd-dex-server created serviceaccount/argocd-notifications-controller created serviceaccount/argocd-redis created serviceaccount/argocd-repo-server created serviceaccount/argocd-server created role.rbac.authorization.k8s.io/argocd-application-controller created role.rbac.authorization.k8s.io/argocd-applicationset-controller created role.rbac.authorization.k8s.io/argocd-dex-server created role.rbac.authorization.k8s.io/argocd-notifications-controller created role.rbac.authorization.k8s.io/argocd-server created clusterrole.rbac.authorization.k8s.io/argocd-application-controller created clusterrole.rbac.authorization.k8s.io/argocd-server created rolebinding.rbac.authorization.k8s.io/argocd-application-controller created rolebinding.rbac.authorization.k8s.io/argocd-applicationset-controller created rolebinding.rbac.authorization.k8s.io/argocd-dex-server created rolebinding.rbac.authorization.k8s.io/argocd-notifications-controller created rolebinding.rbac.authorization.k8s.io/argocd-redis created rolebinding.rbac.authorization.k8s.io/argocd-server created clusterrolebinding.rbac.authorization.k8s.io/argocd-application-controller created clusterrolebinding.rbac.authorization.k8s.io/argocd-server created configmap/argocd-cm created configmap/argocd-cmd-params-cm created configmap/argocd-gpg-keys-cm created configmap/argocd-notifications-cm created configmap/argocd-rbac-cm created configmap/argocd-ssh-known-hosts-cm created configmap/argocd-tls-certs-cm created secret/argocd-notifications-secret created secret/argocd-secret created service/argocd-applicationset-controller created service/argocd-dex-server created service/argocd-metrics created service/argocd-notifications-controller-metrics created service/argocd-redis created service/argocd-repo-server created service/argocd-server created service/argocd-server-metrics created deployment.apps/argocd-applicationset-controller created deployment.apps/argocd-dex-server created deployment.apps/argocd-notifications-controller created deployment.apps/argocd-redis created deployment.apps/argocd-repo-server created deployment.apps/argocd-server created statefulset.apps/argocd-application-controller created networkpolicy.networking.k8s.io/argocd-application-controller-network-policy created networkpolicy.networking.k8s.io/argocd-dex-server-network-policy created networkpolicy.networking.k8s.io/argocd-redis-network-policy created networkpolicy.networking.k8s.io/argocd-repo-server-network-policy created networkpolicy.networking.k8s.io/argocd-server-network-policy created Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s","title":"ArgoCD \u5b89\u88dd\u8a2d\u5b9a"},{"location":"argocd/tutorial/01-setup/#_1","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/01-setup.html","title":"\u8a2d\u5b9a"},{"location":"argocd/tutorial/01-setup/#cli","text":"\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u9700\u8981\u4ee5\u4e0b CLI \u5de5\u5177\u3002\u5728\u958b\u59cb\u5b78\u7fd2\u4efb\u4f55\u6559\u7a0b\u7ae0\u7bc0\u4e4b\u524d\uff0c\u8acb\u5148\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\u5011\u3002 Tool Linux Git Download Docker Download K3D v5.4.4 Download kubectl v1.20.2 Download argocd v2.0.0 Download kustomize v4.1.2 Download \u4ee5\u4e0b CLI \u5de5\u5177\u5c0d\u65bc\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u662f\u53ef\u9078\u7684\u3002\u5118\u7ba1\u5728\u6559\u7a0b\u4e2d\u4f7f\u7528\u4e86\u5b83\u5011\uff0c\u4f46\u60a8\u53ef\u4ee5\u6beb\u7121\u554f\u984c\u5730\u4f7f\u7528\u5176\u4ed6\u7684\u3002","title":"\u76f8\u95dc\u9700\u8981\u7684 CLI \u5de5\u5177"},{"location":"argocd/tutorial/01-setup/#_2","text":"\u5728\u958b\u59cb\u8a2d\u7f6e\u74b0\u5883\u4e4b\u524d\uff0c\u8b93\u6211\u5011 clone \u6559\u7a0b\u6e90\u78bc\u4e26\u5c07 TUTORIAL_HOME \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6559\u7a0b\u7684\u6839\u76ee\u9304\uff1a $ git clone https://github.com/redhat-scholars/argocd-tutorial.git gitops $ export TUTORIAL_HOME = \" $( pwd ) /gitops\" $ cd $TUTORIAL_HOME","title":"\u53d6\u5f97\u6559\u7a0b\u8cc7\u6e90"},{"location":"argocd/tutorial/01-setup/#kubernetes","text":"\u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"argocd/tutorial/01-setup/#argocd","text":"\u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml \u7d50\u679c: customresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created customresourcedefinition.apiextensions.k8s.io/applicationsets.argoproj.io created customresourcedefinition.apiextensions.k8s.io/appprojects.argoproj.io created serviceaccount/argocd-application-controller created serviceaccount/argocd-applicationset-controller created serviceaccount/argocd-dex-server created serviceaccount/argocd-notifications-controller created serviceaccount/argocd-redis created serviceaccount/argocd-repo-server created serviceaccount/argocd-server created role.rbac.authorization.k8s.io/argocd-application-controller created role.rbac.authorization.k8s.io/argocd-applicationset-controller created role.rbac.authorization.k8s.io/argocd-dex-server created role.rbac.authorization.k8s.io/argocd-notifications-controller created role.rbac.authorization.k8s.io/argocd-server created clusterrole.rbac.authorization.k8s.io/argocd-application-controller created clusterrole.rbac.authorization.k8s.io/argocd-server created rolebinding.rbac.authorization.k8s.io/argocd-application-controller created rolebinding.rbac.authorization.k8s.io/argocd-applicationset-controller created rolebinding.rbac.authorization.k8s.io/argocd-dex-server created rolebinding.rbac.authorization.k8s.io/argocd-notifications-controller created rolebinding.rbac.authorization.k8s.io/argocd-redis created rolebinding.rbac.authorization.k8s.io/argocd-server created clusterrolebinding.rbac.authorization.k8s.io/argocd-application-controller created clusterrolebinding.rbac.authorization.k8s.io/argocd-server created configmap/argocd-cm created configmap/argocd-cmd-params-cm created configmap/argocd-gpg-keys-cm created configmap/argocd-notifications-cm created configmap/argocd-rbac-cm created configmap/argocd-ssh-known-hosts-cm created configmap/argocd-tls-certs-cm created secret/argocd-notifications-secret created secret/argocd-secret created service/argocd-applicationset-controller created service/argocd-dex-server created service/argocd-metrics created service/argocd-notifications-controller-metrics created service/argocd-redis created service/argocd-repo-server created service/argocd-server created service/argocd-server-metrics created deployment.apps/argocd-applicationset-controller created deployment.apps/argocd-dex-server created deployment.apps/argocd-notifications-controller created deployment.apps/argocd-redis created deployment.apps/argocd-repo-server created deployment.apps/argocd-server created statefulset.apps/argocd-application-controller created networkpolicy.networking.k8s.io/argocd-application-controller-network-policy created networkpolicy.networking.k8s.io/argocd-dex-server-network-policy created networkpolicy.networking.k8s.io/argocd-redis-network-policy created networkpolicy.networking.k8s.io/argocd-repo-server-network-policy created networkpolicy.networking.k8s.io/argocd-server-network-policy created Info \u5b89\u88dd ArgoCD \u7d44\u4ef6\u9700\u8981\u5e7e\u5206\u9418\u6642\u9593\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u72c0\u614b\uff1a watch kubectl get pods -n argocd \u4f60\u53ef\u4ee5\u4f7f\u7528 Ctrl + C \u4f86\u7d42\u6b62 watch \u6210\u529f\u90e8\u7f72 ArgoCD \u5c07\u986f\u793a\u4ee5\u4e0b pod\uff1a NAME READY STATUS RESTARTS AGE argocd-application-controller-0 1 /1 Running 0 2m18s argocd-dex-server-5dd657bd9-2r24r 1 /1 Running 0 2m19s argocd-redis-759b6bc7f4-bnljg 1 /1 Running 0 2m19s argocd-repo-server-6c495f858f-p5267 1 /1 Running 0 2m18s argocd-server-859b4b5578-cv2qx 1 /1 Running 0 2m18s","title":"ArgoCD \u5b89\u88dd"},{"location":"argocd/tutorial/02-getting_started/","text":"ArgoCD \u5165\u9580 \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/02-getting_started.html \u78ba\u8a8d Argo CD \u5df2\u555f\u52d5\u4e26\u904b\u884c\u5f8c\uff0c\u8b93\u6211\u5011\u63a2\u7d22\u5982\u4f55\u8a2a\u554f\u548c\u7ba1\u7406 Argo CD\u3002 \u66dd\u9732 ArgoCD \u670d\u52d9 \u00b6 \u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684 Web UI \u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' Tip Kubernetes \u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u4e00\u500b\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u904e Kubernetes \u5ba2\u6236\u7aef\u4e3b\u6a5f\u7aef\u53e3\u8f49\u767c\u5728 Kubernetes \u5167\u90e8\u7db2\u7d61\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u5b83\u7d81\u5b9a\u5230 127.0.0.1 \u4e26\u4e14\u5b83\u4e0d\u6703\u63a5\u53d7\u4f86\u81ea\u5916\u90e8\u4e3b\u6a5f\u7684\u8acb\u6c42\u3002 \u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u8a9e\u6cd5\u5982\u4e0b\u3002 kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] \u6211\u5728\u4e0b\u9762\u7d66\u51fa\u4e00\u500b\u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u4f8b\u5b50\u3002\u4e0b\u9762\u7684\u547d\u4ee4\u6703\u5c07\u5728\u7aef\u53e3 443 \u4e2d\u904b\u884c\u7684\u670d\u52d9\u7aef\u53e3\u8f49\u767c\u5230 kubectl \u5ba2\u6236\u7aef\u4e3b\u6a5f\u4e2d\u7684\u7aef\u53e3 8443\u3002 $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 \u7576\u6211\u5617\u8a66\u4f7f\u7528\u5ba2\u6236\u7aef\u8a08\u7b97\u6a5f\u7684 IP \u5730\u5740\u548c\u7aef\u53e3\u5f9e\u53e6\u4e00\u53f0\u8a08\u7b97\u6a5f\u6253\u958b\u6b64 URL \u6642\uff0c\u5b83\u4e0d\u8d77\u4f5c\u7528\u3002\u539f\u56e0\u662f\u56e0\u70ba8080\u7aef\u53e3\u7d81\u5b9a\u4e86 127.0.0.1 \u3002 \u70ba\u4e86\u8b93\u5b83\u5de5\u4f5c\uff0c\u6211\u5011\u5fc5\u9808\u8b93\u9019\u500b\u7aef\u53e3\u76e3\u807d 0.0.0.0\u3002 \u9019\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u6dfb\u52a0\u9644\u52a0\u53c3\u6578\u4f86\u8f15\u9b06\u5be6\u73fe\u3002\u8a9e\u6cd5\u5982\u4e0b\u3002 $ kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0' \u6709\u95dc Kubernetes Port Forwarding \u7684\u8a73\u7d30\u8aaa\u660e\u53c3\u95b1: Use Port Forwarding to Access Applications in a Cluster \u9023\u63a5\u5230 ArgoCD \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528 CLI \u6216 Web \u63a7\u5236\u53f0\u9023\u63a5\u5230 ArgoCD\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cArgoCD \u6703\u751f\u6210\u4e00\u500b\u7ba1\u7406\u54e1\u7528\u6236\uff0c\u4ee5\u53ca\u5728\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc\u3002 \u4f7f\u7528 CLI \u9023\u63a5 \u00b6 \u5b89\u88dd argocd CLI \u7684\u5de5\u5177: $ curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 $ wget https://github.com/argoproj/argo-cd/releases/download/v2.4.3/argocd-linux-amd64 $ chmod +x /usr/local/bin/argocd \u4f7f\u7528 argocd CLI \u767b\u9304 ArgoCD \u5be6\u4f8b \u00b6 \u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528 ArgoCD cli \u767b\u9304\u5230 ArgoCD\uff1a $ argocd login --insecure --grpc-web $argoURL --username admin --password $argoPass 'admin:login' logged in successfully Context '0.0.0.0:8443' updated \u8207 Web \u63a7\u5236\u53f0\u9023\u63a5 \u00b6 \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002 \u90e8\u7f72\u7bc4\u4f8b\u61c9\u7528\u7a0b\u5e8f \u00b6 \u5c0d\u65bc\u672c\u6559\u7a0b\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Redhat \u5728 Github \u516c\u958b\u7684 GitOps \u7bc4\u4f8b\u5b58\u5132\u5eab\u3002\u6211\u5011\u5c07\u4f7f\u7528\u9019\u500b repo \u4f86\u90e8\u7f72\u6211\u5011\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u4e26\u5305\u542b\u6e05\u55ae\u4f86\u90e8\u7f72\u6211\u5011\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u3002 Redhat Developer Demo: https://github.com/redhat-developer-demos/openshift-gitops-examples \u61c9\u7528\u7a0b\u5e8f Manifest \u66f4\u65b0\u8207\u4fdd\u5b58\u5728 Git Repo \u00b6 \u61c9\u7528\u7a0b\u5e8f\u8981\u8a2d\u5b9a\u5728 Kubernetes \u88e1\u7684 manifet \u6e05\u55ae\u5305\u62ec\uff1a Namespace: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ns.yaml bgd-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : bgd spec : {} status : {} Deployment: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-deployment.yaml bgd-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : labels : app : bgd name : bgd namespace : bgd spec : replicas : 1 selector : matchLabels : app : bgd strategy : {} template : metadata : labels : app : bgd spec : containers : - image : quay.io/redhatworkshops/bgd:latest name : bgd env : - name : COLOR value : \"blue\" resources : {} --- Service: NodePort \u985e\u578b\u7684\u670d\u52d9\uff1a \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-svc.yaml bgd-svc.yaml --- apiVersion : v1 kind : Service metadata : labels : app : bgd name : bgd namespace : bgd spec : type : NodePort ports : - port : 8080 protocol : TCP targetPort : 8080 selector : app : bgd --- Ingress: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ingress.yaml bgd-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : bgd spec : rules : - host : bgd.devnation http : paths : - path : / pathType : Prefix backend : service : name : bgd port : number : 8080 \u8a2d\u5b9a \u61c9\u7528\u7a0b\u5e8f Argo \u7684 Application \u7269\u4ef6 \u00b6 ArgoCD \u5b9a\u7fa9\u4e86\u4e00\u500b Kubernetes \u5ba2\u88fd\u7684API (CRD) \u7269\u4ef6 Application \u3002\u4f60\u5fc5\u9808\u9019\u6a23\u5b9a\u7fa9 Application \u5f8c ArgoCD \u624d\u77e5\u9053\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u61c9\u7528\u9019\u4e9b\u6e05\u55ae\u3002 \u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u5728 ArgoCD \u4e2d\u5b9a\u7fa9\u548c\u61c9\u7528\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002\u8b93\u6211\u5011\u6aa2\u67e5\u7528\u65bc\u90e8\u7f72\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u7684 bgd-app.yaml \u4e26\u5c07\u5176\u5206\u89e3\u4e00\u4e0b\uff1a bgd-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgd-app namespace : argocd spec : destination : namespace : bgd server : https://kubernetes.default.svc # 1 project : default # 2 source : # 3 path : apps/bgd/overlays/bgd repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : # 4 automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u76ee\u6a19\u670d\u52d9\u5668\u662f\u6211\u5011\u5b89\u88dd ArgoCD \u7684\u670d\u52d9\u5668\u3002 \u5728 ArgoCD \u7684\u9ed8\u8a8d\u9805\u76ee (.spec.project) \u4e2d\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u3002 YAML \u6240\u5728\u7684\u6e05\u55ae\u5b58\u5132\u5eab\u548c\u8981\u67e5\u627e\u7684\u8def\u5f91\u3002 syncPolicy \u8a2d\u7f6e\u70ba false\u3002\u8acb\u6ce8\u610f\uff0c\u60a8\u53ef\u4ee5\u8b93 Argo CD \u81ea\u52d5\u540c\u6b65 repo\u3002 Application CR (CustomResource) \u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u61c9\u7528\uff1a $ kubectl apply -f documentation/modules/ROOT/examples/minikube/bgd-app/bgd-app.yaml application.argoproj.io/bgd-app created \u6211\u5011\u53ef\u5728 ArgoCD UI \u4e2d\u89c0\u5bdf\u5230 bgd-app \u7684\u5275\u5efa\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u5c07\u5e36\u60a8\u9032\u5165\u6982\u89bd\u9801\u9762\u3002\u60a8\u53ef\u80fd\u6703\u770b\u5230\u5b83\u4ecd\u5728\u9032\u884c\u4e2d\u6216\u5b8c\u5168\u540c\u6b65\u3002 Tip \u60a8\u53ef\u80fd\u9700\u8981\u9ede\u64ca\u6b64\u9801\u9762\u4e0a\u7684\u986f\u793a\u96b1\u85cf\u8cc7\u6e90\u624d\u80fd\u67e5\u770b\u5168\u90e8\u5167\u5bb9 \u6b64\u6642\u61c9\u7528\u7a0b\u5e8f\u61c9\u8a72\u5df2\u555f\u52d5\u4e26\u6b63\u5728\u904b\u884c\u3002 \u60a8\u53ef\u4ee5\u770b\u5230\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\uff1a $ kubectl get all -n bgd \u8f38\u51fa\u61c9\u5982\u4e0b\u6240\u793a\uff1a NAME READY STATUS RESTARTS AGE pod/bgd-788cb756f7-kz448 1/1 Running 0 10m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/bgd ClusterIP 172.30.111.118 <none> 8080/TCP 10m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/bgd 1/1 1 1 10m \u9996\u5148\u7b49\u5f85\u90e8\u7f72\u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd deployment \"bgd\" successfully rolled out \u7136\u5f8c\u8a2a\u554f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u7531\u65bc\u6211\u5011\u4f7f\u7528\u4e86 Kubernetes Ingress \u7684 Domain Name (Hostname) \u8a2d\u5b9a\u4f86\u9032\u884c\u5c0d\u4e0d\u540c Web \u670d\u52d9\u7684\u6620\u5c04\u3002\u6211\u5011\u5fc5\u9808\u5229\u7528\u67d0\u7a2eName resolving\u7684\u670d\u52d9\u4f86\u89e3\u6790 bgd.devnation \u7684\u7db2\u57df\u540d\u5230\u672c\u6a5f\u7684 IP Address\u3002\u6700\u7c21\u6613\u7684\u65b9\u6cd5\u5c31\u662f\u5728\u4e3b\u6a5f\u7684hosts \u6a94\u88e1\u982d\u624b\u52d5\u8a2d\u5b9a\u7db2\u5740\u8207 IP \u6620\u5c04\u3002 Info \u5c07\u8dd1 K3D \u7684\u4e3b\u6a5f IP \u548c Ingress \u88e1\u5b9a\u7fa9\u7684\u4e3b\u6a5f\u540d bgd.devnation \u6dfb\u52a0\u5230\u4f60\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 Windows Linux Windows \u7cfb\u7d71\u7684 hosts \u8a2d\u5b9a\u6a94\u8def\u5f91\u662f\uff1a C:\\WINDOWS\\system32\\drivers\\etc\\hosts \u9019\u500b hosts \u8a2d\u5b9a\u6a94\u7684\u5167\u5bb9\u9810\u8a2d\u61c9\u8a72\u90fd\u53ea\u6709\u8a3b\u89e3\uff08# \u958b\u982d\u7684\u5c31\u662f\u8a3b\u89e3\uff09\uff0c\u6c92\u6709\u4ec0\u9ebc\u7279\u5225\u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u6a94\u6848\u7684\u6700\u5f8c\u52a0\u4e0a\u81ea\u5df1\u7684\u8a2d\u5b9a\uff0c\u7b2c\u4e00\u500b\u6b04\u4f4d\u662f IP \u4f4d\u5740\uff0c\u7136\u5f8c\u4f7f\u7528\u7a7a\u767d\u6216 Tab \u5206\u9694\uff0c\u7b2c\u4e8c\u500b\u6b04\u4f4d\u5c31\u653e\u4e3b\u6a5f\u7684 FQDN\uff08\u4e5f\u5c31\u662f\u7db2\u5740\uff09\u3002 # Copyright (c) 1993-2009 Microsoft Corp. # # This is a sample HOSTS file used by Microsoft TCP/IP for Windows. # # This file contains the mappings of IP addresses to host names. Each # entry should be kept on an individual line. The IP address should # be placed in the first column followed by the corresponding host name. # The IP address and the host name should be separated by at least one # space. # # Additionally, comments (such as these) may be inserted on individual # lines or following the machine name denoted by a '#' symbol. # # For example: # # 102.54.94.97 rhino.acme.com # source server # 38.25.63.10 x.acme.com # x client host # localhost name resolution is handled within DNS itself. # 127.0.0.1 localhost # ::1 localhost xxx.xxx.xxx.xxx bgd.devnation bgdk.devnation Tip \u8acb\u5c07 xxx.xxx.xxx.xxx \u66ff\u63db\u6210\u8dd1 K3D \u670d\u52d9\u7684\u4e3b\u6a5f IP! \u5728 Linux \u7cfb\u7d71\u4e0a hosts \u8a2d\u5b9a\u6a94\u653e\u5728 /etc/hosts \u5982\u679c\u8981\u4fee\u6539\u5b83\uff0c\u8981\u4f7f\u7528 root \u7ba1\u7406\u8005\u6b0a\u9650\u4fee\u6539\uff1a sudo vi /etc/hosts /etc/hosts 127.0.0.1 localhost 127.0.1.1 dxlab-ThinkPad-T580 xxx.xxx.xxx.xxx bgd.devnation bgdk.devnation # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters Tip \u8acb\u5c07 xxx.xxx.xxx.xxx \u66ff\u63db\u6210\u8dd1 K3D \u670d\u52d9\u7684\u4e3b\u6a5f IP! Info \u7531\u65bc\u6211\u5011\u8981\u4f7f\u7528 Ingress \u4f86\u63a5\u5165\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u88e1\u7684 application\u3002\u5728 Kubernetes \u4e2d\u4e3b\u8981\u6709\u5169\u7a2e\u6a21\u5f0f: \u6a21\u5f0f1. \u4f7f\u7528\u8def\u5f91\u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u6a21\u5f0f2. \u4f7f\u7528 Domain Name (Hostname) \u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u672c\u7bc4\u4f8b\u4f7f\u7528\u7684\u662f \u6a21\u5f0f2 \u3002 \u6211\u5011\u7684 Kubernetes \u662f\u4f7f\u7528\u4e0b\u5217\u7684\u547d\u4ee4\u6240\u5275\u5efa\u7684: $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" \u4ee3\u8868\u8457\u6211\u5011\u628a K3D \u88e1\u7684 Ingress Control \u6620\u5c04\u5230\u672c\u6a5f\u7684 8081 \u7aef\u53e3\u3002 \u56e0\u6b64\u4f60\u53ef\u4f7f\u7528\u700f\u89bd\u5668 http://bgd.devnation:8081 \u4f86\u9023\u63a5\u5230\u525b\u525b\u4f48\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 \u8b93\u6211\u5011\u4ecb\u7d39\u4e00\u500b\u8b8a\u5316\uff01\u4fee\u88dc\u5be6\u6642\u6e05\u55ae\u4ee5\u5c07\u6846\u7684\u984f\u8272\u5f9e\u85cd\u8272\u66f4\u6539\u70ba\u7da0\u8272\uff1a $ kubectl -n bgd patch deploy/bgd --type = 'json' -p = '[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/env/0/value\", \"value\":\"green\"}]' \u7b49\u5f85 rollout \u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd \u5982\u679c\u60a8\u5237\u65b0\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6b63\u5728\u904b\u884c\u7684\u9078\u9805\u5361\uff0c\u60a8\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4e00\u500b\u7da0\u8272\u65b9\u584a\u3002 \u67e5\u770b\u60a8\u7684 Argo CD Web UI\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 Argo \u5c07\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6aa2\u6e2c\u70ba \u201c Out of Sync \u201d\u3002 \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002 \u60a8\u53ef\u4ee5\u901a\u904e Argo CD \u518d\u6b21\u540c\u6b65\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u9996\u5148\u9ede\u64ca SYNC \u7136\u5f8c\u9ede\u64ca\u3000 SYNCHRONIZE \u76f8\u53cd\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\uff1a $ argocd app sync bgd-app \u540c\u6b65\u904e\u7a0b\u5b8c\u6210\u5f8c\uff0cArgo CD UI \u61c9\u8a72\u5c07\u61c9\u7528\u7a0b\u5e8f\u6a19\u8a18\u70ba\u540c\u6b65\u3002 \u5982\u679c\u60a8\u5728\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u9078\u9805\u5361\u4e0a\u91cd\u65b0\u52a0\u8f09\u9801\u9762\u3002\u5b83\u61c9\u8a72\u56de\u5230\u85cd\u8272\u65b9\u584a\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u8a2d\u7f6e Application \u7684 manifest \u4f86\u8a2d\u7f6e Argo CD \u4ee5\u81ea\u52d5\u7cfe\u6b63\u6f02\u79fb\u3002 \u4f8b\u5b50\uff1a spec: syncPolicy: automated: prune: true selfHeal: true \u6216\u8005\uff0c\u5728\u6211\u5011\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e8b\u5f8c\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ kubectl patch application/bgd-app -n argocd --type = merge -p = '{\"spec\":{\"syncPolicy\":{\"automated\":{\"prune\":true,\"selfHeal\":true}}}}' \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002 GitOps \u6982\u5ff5\u56de\u9867 \u00b6 CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo\uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002","title":"ArgoCD \u5165\u9580"},{"location":"argocd/tutorial/02-getting_started/#argocd","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/02-getting_started.html \u78ba\u8a8d Argo CD \u5df2\u555f\u52d5\u4e26\u904b\u884c\u5f8c\uff0c\u8b93\u6211\u5011\u63a2\u7d22\u5982\u4f55\u8a2a\u554f\u548c\u7ba1\u7406 Argo CD\u3002","title":"ArgoCD \u5165\u9580"},{"location":"argocd/tutorial/02-getting_started/#argocd_1","text":"\u70ba\u4e86\u7c21\u5316\u5b78\u7fd2\uff0c\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u5c07 argocd \u7684 Web UI \u670d\u52d9\u66dd\u9732\u51fa\u4f86\u3002\u6253\u958b\u4e00\u500b\u65b0\u7684 terminal \u4e26\u8f38\u5165\u4e0b\u5217\u7684\u547d\u4ee4\uff1a $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' Tip Kubernetes \u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u4e00\u500b\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u904e Kubernetes \u5ba2\u6236\u7aef\u4e3b\u6a5f\u7aef\u53e3\u8f49\u767c\u5728 Kubernetes \u5167\u90e8\u7db2\u7d61\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u5b83\u7d81\u5b9a\u5230 127.0.0.1 \u4e26\u4e14\u5b83\u4e0d\u6703\u63a5\u53d7\u4f86\u81ea\u5916\u90e8\u4e3b\u6a5f\u7684\u8acb\u6c42\u3002 \u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u8a9e\u6cd5\u5982\u4e0b\u3002 kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] \u6211\u5728\u4e0b\u9762\u7d66\u51fa\u4e00\u500b\u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u4f8b\u5b50\u3002\u4e0b\u9762\u7684\u547d\u4ee4\u6703\u5c07\u5728\u7aef\u53e3 443 \u4e2d\u904b\u884c\u7684\u670d\u52d9\u7aef\u53e3\u8f49\u767c\u5230 kubectl \u5ba2\u6236\u7aef\u4e3b\u6a5f\u4e2d\u7684\u7aef\u53e3 8443\u3002 $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 \u7576\u6211\u5617\u8a66\u4f7f\u7528\u5ba2\u6236\u7aef\u8a08\u7b97\u6a5f\u7684 IP \u5730\u5740\u548c\u7aef\u53e3\u5f9e\u53e6\u4e00\u53f0\u8a08\u7b97\u6a5f\u6253\u958b\u6b64 URL \u6642\uff0c\u5b83\u4e0d\u8d77\u4f5c\u7528\u3002\u539f\u56e0\u662f\u56e0\u70ba8080\u7aef\u53e3\u7d81\u5b9a\u4e86 127.0.0.1 \u3002 \u70ba\u4e86\u8b93\u5b83\u5de5\u4f5c\uff0c\u6211\u5011\u5fc5\u9808\u8b93\u9019\u500b\u7aef\u53e3\u76e3\u807d 0.0.0.0\u3002 \u9019\u53ef\u4ee5\u901a\u904e\u5728\u547d\u4ee4\u4e2d\u6dfb\u52a0\u9644\u52a0\u53c3\u6578\u4f86\u8f15\u9b06\u5be6\u73fe\u3002\u8a9e\u6cd5\u5982\u4e0b\u3002 $ kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0' \u6709\u95dc Kubernetes Port Forwarding \u7684\u8a73\u7d30\u8aaa\u660e\u53c3\u95b1: Use Port Forwarding to Access Applications in a Cluster","title":"\u66dd\u9732 ArgoCD \u670d\u52d9"},{"location":"argocd/tutorial/02-getting_started/#argocd_2","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528 CLI \u6216 Web \u63a7\u5236\u53f0\u9023\u63a5\u5230 ArgoCD\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cArgoCD \u6703\u751f\u6210\u4e00\u500b\u7ba1\u7406\u54e1\u7528\u6236\uff0c\u4ee5\u53ca\u5728\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc\u3002","title":"\u9023\u63a5\u5230 ArgoCD"},{"location":"argocd/tutorial/02-getting_started/#cli","text":"\u5b89\u88dd argocd CLI \u7684\u5de5\u5177: $ curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 $ wget https://github.com/argoproj/argo-cd/releases/download/v2.4.3/argocd-linux-amd64 $ chmod +x /usr/local/bin/argocd","title":"\u4f7f\u7528 CLI \u9023\u63a5"},{"location":"argocd/tutorial/02-getting_started/#argocd-cli-argocd","text":"\u53d6\u5f97\u90e8\u7f72 ArgoCD \u6642\u751f\u6210\u7684\u96a8\u6a5f\u5bc6\u78bc: $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) $ echo $argoPass \u5c07 ArgoCD \u7db2\u7d61\u4f4d\u5740\u8a2d\u6210\u74b0\u5883\u8b8a\u6578\uff1a # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ echo $argoURL \u4f7f\u7528 ArgoCD cli \u767b\u9304\u5230 ArgoCD\uff1a $ argocd login --insecure --grpc-web $argoURL --username admin --password $argoPass 'admin:login' logged in successfully Context '0.0.0.0:8443' updated","title":"\u4f7f\u7528 argocd CLI \u767b\u9304 ArgoCD \u5be6\u4f8b"},{"location":"argocd/tutorial/02-getting_started/#web","text":"\u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5 ArgoCD \u63a7\u5236\u53f0\u3002 \u4f7f\u7528\u7528\u6236 admin \u548c\u4e0a\u4e00\u6b65\u4e2d\u63d0\u53d6\u7684\u5bc6\u78bc\u8a2a\u554f ArgoCD \u63a7\u5236\u53f0\uff1a \u767b\u9304\u5f8c\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u4ee5\u4e0b\u9801\u9762\u3002 \u9019\u662f Argo CD Web UI\u3002","title":"\u8207 Web \u63a7\u5236\u53f0\u9023\u63a5"},{"location":"argocd/tutorial/02-getting_started/#_1","text":"\u5c0d\u65bc\u672c\u6559\u7a0b\uff0c\u6211\u5011\u5c07\u4f7f\u7528 Redhat \u5728 Github \u516c\u958b\u7684 GitOps \u7bc4\u4f8b\u5b58\u5132\u5eab\u3002\u6211\u5011\u5c07\u4f7f\u7528\u9019\u500b repo \u4f86\u90e8\u7f72\u6211\u5011\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u4e26\u5305\u542b\u6e05\u55ae\u4f86\u90e8\u7f72\u6211\u5011\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u3002 Redhat Developer Demo: https://github.com/redhat-developer-demos/openshift-gitops-examples","title":"\u90e8\u7f72\u7bc4\u4f8b\u61c9\u7528\u7a0b\u5e8f"},{"location":"argocd/tutorial/02-getting_started/#manifest-git-repo","text":"\u61c9\u7528\u7a0b\u5e8f\u8981\u8a2d\u5b9a\u5728 Kubernetes \u88e1\u7684 manifet \u6e05\u55ae\u5305\u62ec\uff1a Namespace: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ns.yaml bgd-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : bgd spec : {} status : {} Deployment: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-deployment.yaml bgd-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : labels : app : bgd name : bgd namespace : bgd spec : replicas : 1 selector : matchLabels : app : bgd strategy : {} template : metadata : labels : app : bgd spec : containers : - image : quay.io/redhatworkshops/bgd:latest name : bgd env : - name : COLOR value : \"blue\" resources : {} --- Service: NodePort \u985e\u578b\u7684\u670d\u52d9\uff1a \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-svc.yaml bgd-svc.yaml --- apiVersion : v1 kind : Service metadata : labels : app : bgd name : bgd namespace : bgd spec : type : NodePort ports : - port : 8080 protocol : TCP targetPort : 8080 selector : app : bgd --- Ingress: \u6e90\u78bc\u8def\u5f91: openshift-gitops-examples/apps/bgd/overlays/bgd/bgd-ingress.yaml bgd-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : bgd spec : rules : - host : bgd.devnation http : paths : - path : / pathType : Prefix backend : service : name : bgd port : number : 8080","title":"\u61c9\u7528\u7a0b\u5e8f Manifest \u66f4\u65b0\u8207\u4fdd\u5b58\u5728 Git Repo"},{"location":"argocd/tutorial/02-getting_started/#argo-application","text":"ArgoCD \u5b9a\u7fa9\u4e86\u4e00\u500b Kubernetes \u5ba2\u88fd\u7684API (CRD) \u7269\u4ef6 Application \u3002\u4f60\u5fc5\u9808\u9019\u6a23\u5b9a\u7fa9 Application \u5f8c ArgoCD \u624d\u77e5\u9053\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u61c9\u7528\u9019\u4e9b\u6e05\u55ae\u3002 \u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u5728 ArgoCD \u4e2d\u5b9a\u7fa9\u548c\u61c9\u7528\u61c9\u7528\u7a0b\u5e8f\u6e05\u55ae\u3002\u8b93\u6211\u5011\u6aa2\u67e5\u7528\u65bc\u90e8\u7f72\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u7684 bgd-app.yaml \u4e26\u5c07\u5176\u5206\u89e3\u4e00\u4e0b\uff1a bgd-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgd-app namespace : argocd spec : destination : namespace : bgd server : https://kubernetes.default.svc # 1 project : default # 2 source : # 3 path : apps/bgd/overlays/bgd repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : # 4 automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u76ee\u6a19\u670d\u52d9\u5668\u662f\u6211\u5011\u5b89\u88dd ArgoCD \u7684\u670d\u52d9\u5668\u3002 \u5728 ArgoCD \u7684\u9ed8\u8a8d\u9805\u76ee (.spec.project) \u4e2d\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u3002 YAML \u6240\u5728\u7684\u6e05\u55ae\u5b58\u5132\u5eab\u548c\u8981\u67e5\u627e\u7684\u8def\u5f91\u3002 syncPolicy \u8a2d\u7f6e\u70ba false\u3002\u8acb\u6ce8\u610f\uff0c\u60a8\u53ef\u4ee5\u8b93 Argo CD \u81ea\u52d5\u540c\u6b65 repo\u3002 Application CR (CustomResource) \u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u61c9\u7528\uff1a $ kubectl apply -f documentation/modules/ROOT/examples/minikube/bgd-app/bgd-app.yaml application.argoproj.io/bgd-app created \u6211\u5011\u53ef\u5728 ArgoCD UI \u4e2d\u89c0\u5bdf\u5230 bgd-app \u7684\u5275\u5efa\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u5c07\u5e36\u60a8\u9032\u5165\u6982\u89bd\u9801\u9762\u3002\u60a8\u53ef\u80fd\u6703\u770b\u5230\u5b83\u4ecd\u5728\u9032\u884c\u4e2d\u6216\u5b8c\u5168\u540c\u6b65\u3002 Tip \u60a8\u53ef\u80fd\u9700\u8981\u9ede\u64ca\u6b64\u9801\u9762\u4e0a\u7684\u986f\u793a\u96b1\u85cf\u8cc7\u6e90\u624d\u80fd\u67e5\u770b\u5168\u90e8\u5167\u5bb9 \u6b64\u6642\u61c9\u7528\u7a0b\u5e8f\u61c9\u8a72\u5df2\u555f\u52d5\u4e26\u6b63\u5728\u904b\u884c\u3002 \u60a8\u53ef\u4ee5\u770b\u5230\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u7684\u6240\u6709\u8cc7\u6e90\uff1a $ kubectl get all -n bgd \u8f38\u51fa\u61c9\u5982\u4e0b\u6240\u793a\uff1a NAME READY STATUS RESTARTS AGE pod/bgd-788cb756f7-kz448 1/1 Running 0 10m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/bgd ClusterIP 172.30.111.118 <none> 8080/TCP 10m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/bgd 1/1 1 1 10m \u9996\u5148\u7b49\u5f85\u90e8\u7f72\u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd deployment \"bgd\" successfully rolled out \u7136\u5f8c\u8a2a\u554f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u7531\u65bc\u6211\u5011\u4f7f\u7528\u4e86 Kubernetes Ingress \u7684 Domain Name (Hostname) \u8a2d\u5b9a\u4f86\u9032\u884c\u5c0d\u4e0d\u540c Web \u670d\u52d9\u7684\u6620\u5c04\u3002\u6211\u5011\u5fc5\u9808\u5229\u7528\u67d0\u7a2eName resolving\u7684\u670d\u52d9\u4f86\u89e3\u6790 bgd.devnation \u7684\u7db2\u57df\u540d\u5230\u672c\u6a5f\u7684 IP Address\u3002\u6700\u7c21\u6613\u7684\u65b9\u6cd5\u5c31\u662f\u5728\u4e3b\u6a5f\u7684hosts \u6a94\u88e1\u982d\u624b\u52d5\u8a2d\u5b9a\u7db2\u5740\u8207 IP \u6620\u5c04\u3002 Info \u5c07\u8dd1 K3D \u7684\u4e3b\u6a5f IP \u548c Ingress \u88e1\u5b9a\u7fa9\u7684\u4e3b\u6a5f\u540d bgd.devnation \u6dfb\u52a0\u5230\u4f60\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 Windows Linux Windows \u7cfb\u7d71\u7684 hosts \u8a2d\u5b9a\u6a94\u8def\u5f91\u662f\uff1a C:\\WINDOWS\\system32\\drivers\\etc\\hosts \u9019\u500b hosts \u8a2d\u5b9a\u6a94\u7684\u5167\u5bb9\u9810\u8a2d\u61c9\u8a72\u90fd\u53ea\u6709\u8a3b\u89e3\uff08# \u958b\u982d\u7684\u5c31\u662f\u8a3b\u89e3\uff09\uff0c\u6c92\u6709\u4ec0\u9ebc\u7279\u5225\u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u6a94\u6848\u7684\u6700\u5f8c\u52a0\u4e0a\u81ea\u5df1\u7684\u8a2d\u5b9a\uff0c\u7b2c\u4e00\u500b\u6b04\u4f4d\u662f IP \u4f4d\u5740\uff0c\u7136\u5f8c\u4f7f\u7528\u7a7a\u767d\u6216 Tab \u5206\u9694\uff0c\u7b2c\u4e8c\u500b\u6b04\u4f4d\u5c31\u653e\u4e3b\u6a5f\u7684 FQDN\uff08\u4e5f\u5c31\u662f\u7db2\u5740\uff09\u3002 # Copyright (c) 1993-2009 Microsoft Corp. # # This is a sample HOSTS file used by Microsoft TCP/IP for Windows. # # This file contains the mappings of IP addresses to host names. Each # entry should be kept on an individual line. The IP address should # be placed in the first column followed by the corresponding host name. # The IP address and the host name should be separated by at least one # space. # # Additionally, comments (such as these) may be inserted on individual # lines or following the machine name denoted by a '#' symbol. # # For example: # # 102.54.94.97 rhino.acme.com # source server # 38.25.63.10 x.acme.com # x client host # localhost name resolution is handled within DNS itself. # 127.0.0.1 localhost # ::1 localhost xxx.xxx.xxx.xxx bgd.devnation bgdk.devnation Tip \u8acb\u5c07 xxx.xxx.xxx.xxx \u66ff\u63db\u6210\u8dd1 K3D \u670d\u52d9\u7684\u4e3b\u6a5f IP! \u5728 Linux \u7cfb\u7d71\u4e0a hosts \u8a2d\u5b9a\u6a94\u653e\u5728 /etc/hosts \u5982\u679c\u8981\u4fee\u6539\u5b83\uff0c\u8981\u4f7f\u7528 root \u7ba1\u7406\u8005\u6b0a\u9650\u4fee\u6539\uff1a sudo vi /etc/hosts /etc/hosts 127.0.0.1 localhost 127.0.1.1 dxlab-ThinkPad-T580 xxx.xxx.xxx.xxx bgd.devnation bgdk.devnation # The following lines are desirable for IPv6 capable hosts ::1 ip6-localhost ip6-loopback fe00::0 ip6-localnet ff00::0 ip6-mcastprefix ff02::1 ip6-allnodes ff02::2 ip6-allrouters Tip \u8acb\u5c07 xxx.xxx.xxx.xxx \u66ff\u63db\u6210\u8dd1 K3D \u670d\u52d9\u7684\u4e3b\u6a5f IP! Info \u7531\u65bc\u6211\u5011\u8981\u4f7f\u7528 Ingress \u4f86\u63a5\u5165\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u88e1\u7684 application\u3002\u5728 Kubernetes \u4e2d\u4e3b\u8981\u6709\u5169\u7a2e\u6a21\u5f0f: \u6a21\u5f0f1. \u4f7f\u7528\u8def\u5f91\u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u6a21\u5f0f2. \u4f7f\u7528 Domain Name (Hostname) \u4f86\u9032\u884c\u5c0d\u4e0d\u540c\u670d\u52d9\u7684\u6620\u5c04 \u672c\u7bc4\u4f8b\u4f7f\u7528\u7684\u662f \u6a21\u5f0f2 \u3002 \u6211\u5011\u7684 Kubernetes \u662f\u4f7f\u7528\u4e0b\u5217\u7684\u547d\u4ee4\u6240\u5275\u5efa\u7684: $ k3d cluster create [ Cluster Name ] -p \"8081:80@loadbalancer\" \u4ee3\u8868\u8457\u6211\u5011\u628a K3D \u88e1\u7684 Ingress Control \u6620\u5c04\u5230\u672c\u6a5f\u7684 8081 \u7aef\u53e3\u3002 \u56e0\u6b64\u4f60\u53ef\u4f7f\u7528\u700f\u89bd\u5668 http://bgd.devnation:8081 \u4f86\u9023\u63a5\u5230\u525b\u525b\u4f48\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 \u8b93\u6211\u5011\u4ecb\u7d39\u4e00\u500b\u8b8a\u5316\uff01\u4fee\u88dc\u5be6\u6642\u6e05\u55ae\u4ee5\u5c07\u6846\u7684\u984f\u8272\u5f9e\u85cd\u8272\u66f4\u6539\u70ba\u7da0\u8272\uff1a $ kubectl -n bgd patch deploy/bgd --type = 'json' -p = '[{\"op\": \"replace\", \"path\": \"/spec/template/spec/containers/0/env/0/value\", \"value\":\"green\"}]' \u7b49\u5f85 rollout \u5b8c\u6210\uff1a $ kubectl rollout status deploy/bgd -n bgd \u5982\u679c\u60a8\u5237\u65b0\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6b63\u5728\u904b\u884c\u7684\u9078\u9805\u5361\uff0c\u60a8\u73fe\u5728\u61c9\u8a72\u6703\u770b\u5230\u4e00\u500b\u7da0\u8272\u65b9\u584a\u3002 \u67e5\u770b\u60a8\u7684 Argo CD Web UI\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 Argo \u5c07\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6aa2\u6e2c\u70ba \u201c Out of Sync \u201d\u3002 \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002 \u60a8\u53ef\u4ee5\u901a\u904e Argo CD \u518d\u6b21\u540c\u6b65\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1a \u9996\u5148\u9ede\u64ca SYNC \u7136\u5f8c\u9ede\u64ca\u3000 SYNCHRONIZE \u76f8\u53cd\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\uff1a $ argocd app sync bgd-app \u540c\u6b65\u904e\u7a0b\u5b8c\u6210\u5f8c\uff0cArgo CD UI \u61c9\u8a72\u5c07\u61c9\u7528\u7a0b\u5e8f\u6a19\u8a18\u70ba\u540c\u6b65\u3002 \u5982\u679c\u60a8\u5728\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u9078\u9805\u5361\u4e0a\u91cd\u65b0\u52a0\u8f09\u9801\u9762\u3002\u5b83\u61c9\u8a72\u56de\u5230\u85cd\u8272\u65b9\u584a\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u8a2d\u7f6e Application \u7684 manifest \u4f86\u8a2d\u7f6e Argo CD \u4ee5\u81ea\u52d5\u7cfe\u6b63\u6f02\u79fb\u3002 \u4f8b\u5b50\uff1a spec: syncPolicy: automated: prune: true selfHeal: true \u6216\u8005\uff0c\u5728\u6211\u5011\u7684\u4f8b\u5b50\u4e2d\uff0c\u4e8b\u5f8c\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a $ kubectl patch application/bgd-app -n argocd --type = merge -p = '{\"spec\":{\"syncPolicy\":{\"automated\":{\"prune\":true,\"selfHeal\":true}}}}' \u4e0a\u8ff0\u7684\u7d50\u679c\u8aaa\u660e\u4e86\u5728\u4e00\u822cCI/CD\u7684\u6d41\u6c34\u7dda\u7684\u8a2d\u8a08\u4e2d\u5982\u679c\u5141\u8a31\u958b\u767c\u8005/\u904b\u7dad\u8005\u53ef\u76f4\u63a5\u64cd\u7e31 Kubernetes \u6703\u5c0e\u81f4\u7684\u7d50\u679c\u3002","title":"\u8a2d\u5b9a \u61c9\u7528\u7a0b\u5e8f Argo \u7684 Application \u7269\u4ef6"},{"location":"argocd/tutorial/02-getting_started/#gitops","text":"CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo\uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002","title":"GitOps \u6982\u5ff5\u56de\u9867"},{"location":"argocd/tutorial/03-kustomize/","text":"Kustomize \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/03-kustomize.html Kustomize \u904d\u6b77 Kubernetes \u6e05\u55ae\u4f86\u6dfb\u52a0\u3001\u522a\u9664\u6216\u66f4\u65b0\u914d\u7f6e\u9078\u9805\uff0c\u800c\u7121\u9700 fork \u3002\u5b83\u65e2\u53ef\u4ee5\u4f5c\u70ba\u7368\u7acb\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba kubectl \u7684\u539f\u751f\u64f4\u5c55\u4f7f\u7528\u3002 kustomize \u7684\u539f\u5247\u662f\uff1a \u914d\u7f6e\u5b9a\u5236\u7684\u7d14\u8072\u660e\u5f0f\u65b9\u6cd5 \u7ba1\u7406\u4efb\u610f\u6578\u91cf\u7684\u660e\u78ba\u5b9a\u5236\u7684 Kubernetes \u914d\u7f6e kustomize \u4f7f\u7528\u7684\u6bcf\u500b\u5de5\u4ef6\u90fd\u662f\u7d14 YAML\uff0c\u53ef\u4ee5\u9019\u6a23\u9032\u884c\u9a57\u8b49\u548c\u8655\u7406 \u4f5c\u70ba\u201c\u7121\u6a21\u677f\u201d\u7684\u6a21\u677f\u7cfb\u7d71\uff1b\u5b83\u9f13\u52f5\u4f7f\u7528 YAML \u800c\u4e0d folk \u5b83\u3002 \u63a2\u7d22 Kustomize \u00b6 \u63a2\u7d22 Kustomize CLI \u00b6 kustomize CLI \u61c9\u8a72\u5df2\u4f5c\u70balab\u8a2d\u7f6e\u7684\u4e00\u90e8\u5206\u5b89\u88dd\u3002\u9a57\u8b49\u5b83\u662f\u5426\u5df2\u5b89\u88dd\u3002 $ kustomize version --short \u9019\u61c9\u8a72\u986f\u793a\u7248\u672c\uff0c\u5b83\u61c9\u8a72\u770b\u8d77\u4f86\u50cf\u9019\u6a23\u3002 {Version:kustomize/v4.5.5 GitCommit:daa3e5e2c2d3a4b8c94021a7384bfb06734bcd26 BuildDate:2022-05-20T20:25:40Z GoOs:linux GoArch:amd64} Kustomize \u7684\u6838\u5fc3\u662f\u57fa\u65bc YAML \u69cb\u5efa\u672c\u6a5f Kubernetes \u6e05\u55ae\uff0c\u540c\u6642\u4fdd\u7559\u539f\u59cb YAML\u3002\u5b83\u4ee5\u201c\u7121\u6a21\u677f\u201d\u6a21\u677f\u683c\u5f0f\u5be6\u73fe\u4e86\u9019\u4e00\u9ede\u3002\u9019\u662f\u901a\u904e\u63d0\u4f9b\u4e00\u500b kustomization.yaml \u6587\u4ef6\u4f86\u5b8c\u6210\u7684\u3002 \u6211\u5011\u5c07\u5c08\u6ce8\u65bc\u5169\u500b\u5b50\u547d\u4ee4\uff0c build \u547d\u4ee4\u548c edit \u547d\u4ee4\u3002 build \u547d\u4ee4\u7372\u53d6 YAML \u6e90\uff08\u901a\u904e\u8def\u5f91\u6216 URL\uff09\u4e26\u5275\u5efa\u4e00\u500b\u65b0\u7684 YAML\uff0c\u8a72 YAML \u53ef\u4ee5\u901a\u904e\u7ba1\u9053\u50b3\u8f38\u5230 kubectl create \u3002\u6211\u5011\u5c07\u4f7f\u7528 documentation/modules/ROOT/examples/kustomize-build \u76ee\u9304\u4e2d\u7684\u793a\u4f8b\u3002 $ cd documentation/modules/ROOT/examples/kustomize-build \u5728\u9019\u88e1\u4f60\u61c9\u8a72\u770b\u5230\u5169\u500b\u6587\u4ef6\uff0c\u4e00\u500b kustomization.yaml \u6587\u4ef6\u548c\u4e00\u500b welcome.yaml \u6587\u4ef6\uff0c\u6211\u5011\u4f86\u770b\u770b\u5b83\u5011\u3002 welcome.yaml apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:latest name : welcome-php resources : {} \u9019\u500b\u6587\u4ef6\u6c92\u6709\u4ec0\u9ebc\u7279\u5225\u4e4b\u8655\u3002\u53ea\u662f\u4e00\u500b\u6a19\u6e96\u7684 Kubernetes \u6e05\u55ae\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u5011\u60f3\u5728\u6b64\u6e05\u55ae\u4e2d\u6dfb\u52a0\u6a19\u7c64\u800c\u4e0d\u5c0d\u5176\u9032\u884c\u7de8\u8f2f\u600e\u9ebc\u8fa6\uff1f\u9019\u5c31\u662f kustomization.yaml \u6587\u4ef6\u7684\u7528\u6b66\u4e4b\u5730\u3002 kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u6b63\u5982\u60a8\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u7684\u90a3\u6a23\uff0c\u6c92\u6709\u592a\u591a\u3002\u6b64\u793a\u4f8b\u7684\u5169\u500b\u90e8\u5206\u662f resources \u548c patchesJson6902 \u90e8\u5206\u3002 resources \u662f\u5b58\u5132\u5176\u4ed6\u6e05\u55ae\u7684\u55ae\u500b\u6587\u4ef6\u3001\u76ee\u9304\u548c/\u6216 URL \u7684\u6578\u7d44\u3002\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u53ea\u662f\u52a0\u8f09\u4e00\u500b\u6587\u4ef6\u3002 patchesJson6902 \u662f kustomize \u652f\u6301\u7684\u4fee\u88dc RFC\u3002\u5982\u60a8\u6240\u898b\uff0c\u5728 patchJson6902 \u6587\u4ef6\u4e2d\uff0c\u6211\u6b63\u5728\u5411\u6b64\u6e05\u55ae\u6dfb\u52a0\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u4ee5\u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e2d\u95b1\u8b80\u6709\u95dc\u53ef\u7528\u65bc \u4fee\u88dc \u7684\u9078\u9805 \u901a\u904e build \u69cb\u5efa\u6b64\u6e05\u55ae\uff1a $ kustomize build \u60a8\u53ef\u4ee5\u770b\u5230\u65b0\u6a19\u7c64\u5df2\u6dfb\u52a0\u5230\u6e05\u55ae\u4e2d\uff01 apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php testkey : testvalue name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:ffcd15 name : welcome-php resources : {} \u60a8\u53ef\u4ee5\u4f7f\u7528 kustomize \u7de8\u8f2f\u547d\u4ee4\u800c\u4e0d\u662f\u7de8\u5beb YAML\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5c07\u6b64 Deployment \u4f7f\u7528\u7684\u6620\u50cf\u6a19\u7c64\u5f9e latest \u66f4\u6539\u70ba ffcd15 \uff1a $ kustomize edit set image quay.io/redhatworkshops/welcome-php:ffcd15 \u9019\u5c07\u4f7f\u7528\u5716\u50cf\u90e8\u5206\u66f4\u65b0 kustomization.yaml \u6587\u4ef6\u3002 $ cat kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u73fe\u5728\u7576\u4f60\u904b\u884c\u6642\uff1a $ kustomize build . \u60a8\u4e0d\u50c5\u61c9\u8a72\u770b\u5230\u65b0\u6a19\u7c64\uff0c\u9084\u61c9\u8a72\u770b\u5230\u65b0\u7684 ffcd15 \u93e1\u50cf\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u80fd\u5fc5\u9808\u95dc\u9589 kustomization.yaml \u9078\u9805\u5361\u4e26\u91cd\u65b0\u6253\u958b\u5b83\u624d\u80fd\u67e5\u770b\u66f4\u6539\u3002 \u60a8\u53ef\u4ee5\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u73fe\u6709\u7684 YAML \u4e26\u91dd\u5c0d\u60a8\u7684\u7279\u5b9a\u74b0\u5883\u5c0d\u5176\u9032\u884c\u4fee\u6539\uff0c\u800c\u7121\u9700\u8907\u88fd\u6216\u7de8\u8f2f\u539f\u59cb\u6587\u4ef6\u3002 Kustomize \u53ef\u7528\u65bc\u7de8\u5beb\u65b0\u7684 YAML \u6587\u4ef6\u6216\u88ab\u5c0e\u5165 kubectl \u547d\u4ee4\u3002\u4f8b\u5b50\uff1a $ kustomize build . | kubectl apply -f - \u4f7f\u7528 Kubectl \u63a2\u7d22 Kustomize \u00b6 \u5f9e Kubernetes 1.14 \u958b\u59cb\uff0c kubectl \u547d\u4ee4\u5167\u7f6e\u4e86\u5c0d Kustomize \u7684\u652f\u6301\u3002 \u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize --help \u9019\u5c07\u904b\u884c kustomize \u69cb\u5efa\u547d\u4ee4\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize \u5118\u7ba1\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u5c07\u5176\u901a\u904e\u7ba1\u9053\u50b3\u905e\u5230\u61c9\u7528\u547d\u4ee4\u4e2d\uff0c\u4f46\u60a8\u4e0d\u5fc5\u9019\u6a23\u505a\u3002 kubectl apply \u547d\u4ee4\u5177\u6709 -k \u9078\u9805\uff0c\u8a72\u9078\u9805\u5c07\u5728\u61c9\u7528\u6e05\u55ae\u4e4b\u524d\u904b\u884c\u69cb\u5efa\u3002 \u8981\u5c0d\u6b64\u9032\u884c\u6e2c\u8a66\uff0c\u9996\u5148\u5275\u5efa\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff1a $ kubectl create namespace kustomize-test \u63a5\u4e0b\u4f86\u78ba\u4fdd\u60a8\u5728\u547d\u540d\u7a7a\u9593\u4e2d\uff1a $ kubectl config set-context --current --namespace = kustomize-test \u6700\u5f8c\u904b\u884c\u547d\u4ee4\u4f86\u69cb\u5efa\u548c\u61c9\u7528\u6e05\u55ae\uff1a $ kubectl apply -k ./ Info \u6ce8\u610f \u60a8\u4e0d\u50c5\u53ef\u4ee5\u50b3\u905e\u76ee\u9304\uff0c\u9084\u53ef\u4ee5\u50b3\u905e URL\u3002\u552f\u4e00\u7684\u8981\u6c42\u662f\u8def\u5f91\u4e2d\u6709\u4e00\u500b kustomization.yaml \u6587\u4ef6\u3002 \u9019\u61c9\u8a72\u6703\u5275\u5efa\u90e8\u7f72\uff0c\u4e26\u4e14\u60a8\u61c9\u8a72\u6703\u770b\u5230\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u904b\u884c\u7684 pod\uff1a $ kubectl get pods -n kustomize-test \u60a8\u53ef\u4ee5\u770b\u5230\u90e8\u7f72\u662f\u4f7f\u7528\u9644\u52a0\u6a19\u7c64\u5275\u5efa\u7684\uff1a $ kubectl get deployment welcome-php -o jsonpath = '{.metadata.labels}' | jq -r \u6b64\u5916\uff0c\u93e1\u50cf\u5df2\u6839\u64da\u6240\u505a\u7684\u81ea\u5b9a\u7fa9\u9032\u884c\u4e86\u66f4\u65b0\uff1a $ kubectl get deploy welcome-php -o jsonpath = '{.spec.template.spec.containers[].image}{\"\\n\"}' \u5982\u60a8\u6240\u898b\uff0ckustomize \u662f\u4e00\u500b\u5f37\u5927\u7684\u5de5\u5177\u3002 \u60a8\u73fe\u5728\u53ef\u4ee5\u5b89\u5168\u5730\u522a\u9664\u6b64\u547d\u540d\u7a7a\u9593\uff1a $ kubectl delete namespace kustomize-test \u90e8\u7f72 Kustomized \u61c9\u7528\u7a0b\u5e8f \u00b6 \u5728\u4e0a\u4e00\u7ae0\u4e2d\uff0c\u60a8\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4e86\u89e3\u4e86\u9019\u4e00\u9ede\uff1b\u6574\u500b\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\uff08\u5305\u62ec\u57fa\u790e\u8a2d\u65bd\uff09\u90fd\u53cd\u6620\u5728 git repo \u4e2d\u3002\u6311\u6230\u5728\u65bc\u5982\u4f55\u5728\u4e0d\u5fa9\u5236 YAML \u7684\u60c5\u6cc1\u4e0b\u505a\u5230\u9019\u4e00\u9ede\u3002 \u73fe\u5728\u60a8\u5df2\u7d93\u63a2\u7d22\u4e86 kustomize\uff0c\u8b93\u6211\u5011\u770b\u770b\u5b83\u5982\u4f55\u878d\u5165 Argo CD \u4ee5\u53ca\u5982\u4f55\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4f7f\u7528\u5b83\u3002 \u5728\u7e7c\u7e8c\u4e4b\u524d\uff0c\u56de\u5230\u4e3b\u76ee\u9304\uff1a cd ~ Argo CD Web \u63a7\u5236\u53f0 \u00b6 \u8a2a\u554f Argo CD Web \u63a7\u5236\u53f0\u3002 \u4e00\u65e6\u60a8\u63a5\u53d7\u4e86\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 Argo CD \u767b\u9304\u5c4f\u5e55\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u767b\u9304 Username: admin Password: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d VoNuPLkxJdwMOLCI Kustomized \u61c9\u7528\u7a0b\u5e8f \u00b6 Argo CD \u539f\u751f\u652f\u6301 Kustomize\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u907f\u514d\u70ba\u6bcf\u500b\u90e8\u7f72\u91cd\u8907 YAML\u3002\u5982\u679c\u60a8\u6709\u4e0d\u540c\u7684\u74b0\u5883\u6216\u8981\u90e8\u7f72\u7684\u96c6\u7fa4\uff0c\u9019\u7279\u5225\u597d\u7528\u3002 \u770b\u4e00\u4e0b Application \u5b9a\u7fa9\uff1a bgdk-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgdk-app namespace : argocd spec : destination : namespace : bgdk server : https://kubernetes.default.svc project : default source : path : apps/bgd/overlays/bgdk repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u6b64\u61c9\u7528\u7a0b\u5e8f\u6307\u5411\u76f8\u540c\u7684 \u5b58\u5132\u5eab \u4f46\u4e0d\u540c\u7684 \u76ee\u9304 \u3002 \u770b\u4e00\u4e0b kustomization.yaml \u6587\u4ef6\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization namespace : bgdk resources : - ../../base - bgdk-ns.yaml patchesJson6902 : - target : version : v1 group : apps kind : Deployment name : bgd namespace : bgdk patch : |- - op: replace path: /spec/template/spec/containers/0/env/0/value value: yellow - target : version : v1 group : networking.k8s.io kind : Ingress name : bgd namespace : bgdk patch : |- - op: replace path: /spec/rules/0/host value: bgdk.devnation \u9019\u500b kustomization.yaml \u7372\u53d6\u57fa\u790e\u61c9\u7528\u7a0b\u5e8f\u4e26\u4fee\u88dc\u6e05\u55ae\uff0c\u4ee5\u4fbf\u6211\u5011\u5f97\u5230\u9ec3\u8272\u65b9\u584a\u800c\u4e0d\u662f\u85cd\u8272\u65b9\u584a\u3002\u5b83\u9084\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230 bgdk \u547d\u540d\u7a7a\u9593\uff08\u7531\u6587\u4ef6\u7684\u547d\u540d\u7a7a\u9593\uff1a\u90e8\u5206\u9336\u793a\uff09\u4e26\u5c07\u9019\u500b\u65b0\u547d\u540d\u7a7a\u9593\u7684 Ingress \u4e3b\u6a5f\u540d\u66f4\u65b0\u70ba bgdk.devnation \u3002 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d bgdk.devnation \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 \u4f8b\u5b50\uff1a /etc/hosts 192.168.39.242 bgd.devnation bgdk.devnation \u9019\u61c9\u8a72\u6703\u5728 Argo CD UI \u4e0a\u5411\u60a8\u986f\u793a\u5169\u500b\u61c9\u7528\u7a0b\u5e8f\u3002 \u6253\u958b\u61c9\u7528\u7a0b\u5e8f\u7684 Ingress \u6216 Route\u3002 \u5982\u60a8\u6240\u898b\uff0c\u4f7f\u7528\u60a8\u7684\u81ea\u5b9a\u7fa9\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\uff01\u56de\u9867\u6211\u5011\u525b\u525b\u6240\u505a\u7684\u3002 \u90e8\u7f72\u4e86\u4e00\u500b\u540d\u70ba bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5e36\u6709\u4e00\u500b\u85cd\u8272\u65b9\u584a\u3002 \u90e8\u7f72\u4e86\u53e6\u4e00\u500b\u57fa\u65bc bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u7a31\u70ba bgdk \u61c9\u7528\u7a0b\u5e8f bgdk \u90e8\u7f72\u5728\u5b83\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\uff0c\u4e26\u5177\u6709\u90e8\u7f72\u81ea\u5b9a\u7fa9\u3002 \u5168\u90e8\u7121\u9700\u8907\u5236 YAML\uff01","title":"Kustomize"},{"location":"argocd/tutorial/03-kustomize/#kustomize","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/03-kustomize.html Kustomize \u904d\u6b77 Kubernetes \u6e05\u55ae\u4f86\u6dfb\u52a0\u3001\u522a\u9664\u6216\u66f4\u65b0\u914d\u7f6e\u9078\u9805\uff0c\u800c\u7121\u9700 fork \u3002\u5b83\u65e2\u53ef\u4ee5\u4f5c\u70ba\u7368\u7acb\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba kubectl \u7684\u539f\u751f\u64f4\u5c55\u4f7f\u7528\u3002 kustomize \u7684\u539f\u5247\u662f\uff1a \u914d\u7f6e\u5b9a\u5236\u7684\u7d14\u8072\u660e\u5f0f\u65b9\u6cd5 \u7ba1\u7406\u4efb\u610f\u6578\u91cf\u7684\u660e\u78ba\u5b9a\u5236\u7684 Kubernetes \u914d\u7f6e kustomize \u4f7f\u7528\u7684\u6bcf\u500b\u5de5\u4ef6\u90fd\u662f\u7d14 YAML\uff0c\u53ef\u4ee5\u9019\u6a23\u9032\u884c\u9a57\u8b49\u548c\u8655\u7406 \u4f5c\u70ba\u201c\u7121\u6a21\u677f\u201d\u7684\u6a21\u677f\u7cfb\u7d71\uff1b\u5b83\u9f13\u52f5\u4f7f\u7528 YAML \u800c\u4e0d folk \u5b83\u3002","title":"Kustomize"},{"location":"argocd/tutorial/03-kustomize/#kustomize_1","text":"","title":"\u63a2\u7d22 Kustomize"},{"location":"argocd/tutorial/03-kustomize/#kustomize-cli","text":"kustomize CLI \u61c9\u8a72\u5df2\u4f5c\u70balab\u8a2d\u7f6e\u7684\u4e00\u90e8\u5206\u5b89\u88dd\u3002\u9a57\u8b49\u5b83\u662f\u5426\u5df2\u5b89\u88dd\u3002 $ kustomize version --short \u9019\u61c9\u8a72\u986f\u793a\u7248\u672c\uff0c\u5b83\u61c9\u8a72\u770b\u8d77\u4f86\u50cf\u9019\u6a23\u3002 {Version:kustomize/v4.5.5 GitCommit:daa3e5e2c2d3a4b8c94021a7384bfb06734bcd26 BuildDate:2022-05-20T20:25:40Z GoOs:linux GoArch:amd64} Kustomize \u7684\u6838\u5fc3\u662f\u57fa\u65bc YAML \u69cb\u5efa\u672c\u6a5f Kubernetes \u6e05\u55ae\uff0c\u540c\u6642\u4fdd\u7559\u539f\u59cb YAML\u3002\u5b83\u4ee5\u201c\u7121\u6a21\u677f\u201d\u6a21\u677f\u683c\u5f0f\u5be6\u73fe\u4e86\u9019\u4e00\u9ede\u3002\u9019\u662f\u901a\u904e\u63d0\u4f9b\u4e00\u500b kustomization.yaml \u6587\u4ef6\u4f86\u5b8c\u6210\u7684\u3002 \u6211\u5011\u5c07\u5c08\u6ce8\u65bc\u5169\u500b\u5b50\u547d\u4ee4\uff0c build \u547d\u4ee4\u548c edit \u547d\u4ee4\u3002 build \u547d\u4ee4\u7372\u53d6 YAML \u6e90\uff08\u901a\u904e\u8def\u5f91\u6216 URL\uff09\u4e26\u5275\u5efa\u4e00\u500b\u65b0\u7684 YAML\uff0c\u8a72 YAML \u53ef\u4ee5\u901a\u904e\u7ba1\u9053\u50b3\u8f38\u5230 kubectl create \u3002\u6211\u5011\u5c07\u4f7f\u7528 documentation/modules/ROOT/examples/kustomize-build \u76ee\u9304\u4e2d\u7684\u793a\u4f8b\u3002 $ cd documentation/modules/ROOT/examples/kustomize-build \u5728\u9019\u88e1\u4f60\u61c9\u8a72\u770b\u5230\u5169\u500b\u6587\u4ef6\uff0c\u4e00\u500b kustomization.yaml \u6587\u4ef6\u548c\u4e00\u500b welcome.yaml \u6587\u4ef6\uff0c\u6211\u5011\u4f86\u770b\u770b\u5b83\u5011\u3002 welcome.yaml apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:latest name : welcome-php resources : {} \u9019\u500b\u6587\u4ef6\u6c92\u6709\u4ec0\u9ebc\u7279\u5225\u4e4b\u8655\u3002\u53ea\u662f\u4e00\u500b\u6a19\u6e96\u7684 Kubernetes \u6e05\u55ae\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u6211\u5011\u60f3\u5728\u6b64\u6e05\u55ae\u4e2d\u6dfb\u52a0\u6a19\u7c64\u800c\u4e0d\u5c0d\u5176\u9032\u884c\u7de8\u8f2f\u600e\u9ebc\u8fa6\uff1f\u9019\u5c31\u662f kustomization.yaml \u6587\u4ef6\u7684\u7528\u6b66\u4e4b\u5730\u3002 kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u6b63\u5982\u60a8\u5728\u8f38\u51fa\u4e2d\u770b\u5230\u7684\u90a3\u6a23\uff0c\u6c92\u6709\u592a\u591a\u3002\u6b64\u793a\u4f8b\u7684\u5169\u500b\u90e8\u5206\u662f resources \u548c patchesJson6902 \u90e8\u5206\u3002 resources \u662f\u5b58\u5132\u5176\u4ed6\u6e05\u55ae\u7684\u55ae\u500b\u6587\u4ef6\u3001\u76ee\u9304\u548c/\u6216 URL \u7684\u6578\u7d44\u3002\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u53ea\u662f\u52a0\u8f09\u4e00\u500b\u6587\u4ef6\u3002 patchesJson6902 \u662f kustomize \u652f\u6301\u7684\u4fee\u88dc RFC\u3002\u5982\u60a8\u6240\u898b\uff0c\u5728 patchJson6902 \u6587\u4ef6\u4e2d\uff0c\u6211\u6b63\u5728\u5411\u6b64\u6e05\u55ae\u6dfb\u52a0\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u4ee5\u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e2d\u95b1\u8b80\u6709\u95dc\u53ef\u7528\u65bc \u4fee\u88dc \u7684\u9078\u9805 \u901a\u904e build \u69cb\u5efa\u6b64\u6e05\u55ae\uff1a $ kustomize build \u60a8\u53ef\u4ee5\u770b\u5230\u65b0\u6a19\u7c64\u5df2\u6dfb\u52a0\u5230\u6e05\u55ae\u4e2d\uff01 apiVersion : apps/v1 kind : Deployment metadata : creationTimestamp : null labels : app : welcome-php testkey : testvalue name : welcome-php spec : replicas : 1 selector : matchLabels : app : welcome-php strategy : {} template : metadata : creationTimestamp : null labels : app : welcome-php spec : containers : - image : quay.io/redhatworkshops/welcome-php:ffcd15 name : welcome-php resources : {} \u60a8\u53ef\u4ee5\u4f7f\u7528 kustomize \u7de8\u8f2f\u547d\u4ee4\u800c\u4e0d\u662f\u7de8\u5beb YAML\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5c07\u6b64 Deployment \u4f7f\u7528\u7684\u6620\u50cf\u6a19\u7c64\u5f9e latest \u66f4\u6539\u70ba ffcd15 \uff1a $ kustomize edit set image quay.io/redhatworkshops/welcome-php:ffcd15 \u9019\u5c07\u4f7f\u7528\u5716\u50cf\u90e8\u5206\u66f4\u65b0 kustomization.yaml \u6587\u4ef6\u3002 $ cat kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization resources : - ./welcome.yaml patchesJson6902 : - patch : |- - op: add path: /metadata/labels/testkey value: testvalue target : group : apps kind : Deployment name : welcome-php version : v1 images : - name : quay.io/redhatworkshops/welcome-php newTag : ffcd15 \u73fe\u5728\u7576\u4f60\u904b\u884c\u6642\uff1a $ kustomize build . \u60a8\u4e0d\u50c5\u61c9\u8a72\u770b\u5230\u65b0\u6a19\u7c64\uff0c\u9084\u61c9\u8a72\u770b\u5230\u65b0\u7684 ffcd15 \u93e1\u50cf\u6a19\u7c64\u3002 Info \u6ce8\u610f\u60a8\u53ef\u80fd\u5fc5\u9808\u95dc\u9589 kustomization.yaml \u9078\u9805\u5361\u4e26\u91cd\u65b0\u6253\u958b\u5b83\u624d\u80fd\u67e5\u770b\u66f4\u6539\u3002 \u60a8\u53ef\u4ee5\u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u73fe\u6709\u7684 YAML \u4e26\u91dd\u5c0d\u60a8\u7684\u7279\u5b9a\u74b0\u5883\u5c0d\u5176\u9032\u884c\u4fee\u6539\uff0c\u800c\u7121\u9700\u8907\u88fd\u6216\u7de8\u8f2f\u539f\u59cb\u6587\u4ef6\u3002 Kustomize \u53ef\u7528\u65bc\u7de8\u5beb\u65b0\u7684 YAML \u6587\u4ef6\u6216\u88ab\u5c0e\u5165 kubectl \u547d\u4ee4\u3002\u4f8b\u5b50\uff1a $ kustomize build . | kubectl apply -f -","title":"\u63a2\u7d22 Kustomize CLI"},{"location":"argocd/tutorial/03-kustomize/#kubectl-kustomize","text":"\u5f9e Kubernetes 1.14 \u958b\u59cb\uff0c kubectl \u547d\u4ee4\u5167\u7f6e\u4e86\u5c0d Kustomize \u7684\u652f\u6301\u3002 \u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize --help \u9019\u5c07\u904b\u884c kustomize \u69cb\u5efa\u547d\u4ee4\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u904b\u884c\u770b\u5230\u9019\u4e00\u9ede\uff1a $ kubectl kustomize \u5118\u7ba1\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u5c07\u5176\u901a\u904e\u7ba1\u9053\u50b3\u905e\u5230\u61c9\u7528\u547d\u4ee4\u4e2d\uff0c\u4f46\u60a8\u4e0d\u5fc5\u9019\u6a23\u505a\u3002 kubectl apply \u547d\u4ee4\u5177\u6709 -k \u9078\u9805\uff0c\u8a72\u9078\u9805\u5c07\u5728\u61c9\u7528\u6e05\u55ae\u4e4b\u524d\u904b\u884c\u69cb\u5efa\u3002 \u8981\u5c0d\u6b64\u9032\u884c\u6e2c\u8a66\uff0c\u9996\u5148\u5275\u5efa\u4e00\u500b\u547d\u540d\u7a7a\u9593\uff1a $ kubectl create namespace kustomize-test \u63a5\u4e0b\u4f86\u78ba\u4fdd\u60a8\u5728\u547d\u540d\u7a7a\u9593\u4e2d\uff1a $ kubectl config set-context --current --namespace = kustomize-test \u6700\u5f8c\u904b\u884c\u547d\u4ee4\u4f86\u69cb\u5efa\u548c\u61c9\u7528\u6e05\u55ae\uff1a $ kubectl apply -k ./ Info \u6ce8\u610f \u60a8\u4e0d\u50c5\u53ef\u4ee5\u50b3\u905e\u76ee\u9304\uff0c\u9084\u53ef\u4ee5\u50b3\u905e URL\u3002\u552f\u4e00\u7684\u8981\u6c42\u662f\u8def\u5f91\u4e2d\u6709\u4e00\u500b kustomization.yaml \u6587\u4ef6\u3002 \u9019\u61c9\u8a72\u6703\u5275\u5efa\u90e8\u7f72\uff0c\u4e26\u4e14\u60a8\u61c9\u8a72\u6703\u770b\u5230\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u904b\u884c\u7684 pod\uff1a $ kubectl get pods -n kustomize-test \u60a8\u53ef\u4ee5\u770b\u5230\u90e8\u7f72\u662f\u4f7f\u7528\u9644\u52a0\u6a19\u7c64\u5275\u5efa\u7684\uff1a $ kubectl get deployment welcome-php -o jsonpath = '{.metadata.labels}' | jq -r \u6b64\u5916\uff0c\u93e1\u50cf\u5df2\u6839\u64da\u6240\u505a\u7684\u81ea\u5b9a\u7fa9\u9032\u884c\u4e86\u66f4\u65b0\uff1a $ kubectl get deploy welcome-php -o jsonpath = '{.spec.template.spec.containers[].image}{\"\\n\"}' \u5982\u60a8\u6240\u898b\uff0ckustomize \u662f\u4e00\u500b\u5f37\u5927\u7684\u5de5\u5177\u3002 \u60a8\u73fe\u5728\u53ef\u4ee5\u5b89\u5168\u5730\u522a\u9664\u6b64\u547d\u540d\u7a7a\u9593\uff1a $ kubectl delete namespace kustomize-test","title":"\u4f7f\u7528 Kubectl \u63a2\u7d22 Kustomize"},{"location":"argocd/tutorial/03-kustomize/#kustomized","text":"\u5728\u4e0a\u4e00\u7ae0\u4e2d\uff0c\u60a8\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4e86\u89e3\u4e86\u9019\u4e00\u9ede\uff1b\u6574\u500b\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\uff08\u5305\u62ec\u57fa\u790e\u8a2d\u65bd\uff09\u90fd\u53cd\u6620\u5728 git repo \u4e2d\u3002\u6311\u6230\u5728\u65bc\u5982\u4f55\u5728\u4e0d\u5fa9\u5236 YAML \u7684\u60c5\u6cc1\u4e0b\u505a\u5230\u9019\u4e00\u9ede\u3002 \u73fe\u5728\u60a8\u5df2\u7d93\u63a2\u7d22\u4e86 kustomize\uff0c\u8b93\u6211\u5011\u770b\u770b\u5b83\u5982\u4f55\u878d\u5165 Argo CD \u4ee5\u53ca\u5982\u4f55\u5728 GitOps \u5de5\u4f5c\u6d41\u7a0b\u4e2d\u4f7f\u7528\u5b83\u3002 \u5728\u7e7c\u7e8c\u4e4b\u524d\uff0c\u56de\u5230\u4e3b\u76ee\u9304\uff1a cd ~","title":"\u90e8\u7f72 Kustomized \u61c9\u7528\u7a0b\u5e8f"},{"location":"argocd/tutorial/03-kustomize/#argo-cd-web","text":"\u8a2a\u554f Argo CD Web \u63a7\u5236\u53f0\u3002 \u4e00\u65e6\u60a8\u63a5\u53d7\u4e86\u81ea\u7c3d\u540d\u8b49\u66f8\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230 Argo CD \u767b\u9304\u5c4f\u5e55\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u767b\u9304 Username: admin Password: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d VoNuPLkxJdwMOLCI","title":"Argo CD Web \u63a7\u5236\u53f0"},{"location":"argocd/tutorial/03-kustomize/#kustomized_1","text":"Argo CD \u539f\u751f\u652f\u6301 Kustomize\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u907f\u514d\u70ba\u6bcf\u500b\u90e8\u7f72\u91cd\u8907 YAML\u3002\u5982\u679c\u60a8\u6709\u4e0d\u540c\u7684\u74b0\u5883\u6216\u8981\u90e8\u7f72\u7684\u96c6\u7fa4\uff0c\u9019\u7279\u5225\u597d\u7528\u3002 \u770b\u4e00\u4e0b Application \u5b9a\u7fa9\uff1a bgdk-app.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : bgdk-app namespace : argocd spec : destination : namespace : bgdk server : https://kubernetes.default.svc project : default source : path : apps/bgd/overlays/bgdk repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u6b64\u61c9\u7528\u7a0b\u5e8f\u6307\u5411\u76f8\u540c\u7684 \u5b58\u5132\u5eab \u4f46\u4e0d\u540c\u7684 \u76ee\u9304 \u3002 \u770b\u4e00\u4e0b kustomization.yaml \u6587\u4ef6\uff1a kustomization.yaml apiVersion : kustomize.config.k8s.io/v1beta1 kind : Kustomization namespace : bgdk resources : - ../../base - bgdk-ns.yaml patchesJson6902 : - target : version : v1 group : apps kind : Deployment name : bgd namespace : bgdk patch : |- - op: replace path: /spec/template/spec/containers/0/env/0/value value: yellow - target : version : v1 group : networking.k8s.io kind : Ingress name : bgd namespace : bgdk patch : |- - op: replace path: /spec/rules/0/host value: bgdk.devnation \u9019\u500b kustomization.yaml \u7372\u53d6\u57fa\u790e\u61c9\u7528\u7a0b\u5e8f\u4e26\u4fee\u88dc\u6e05\u55ae\uff0c\u4ee5\u4fbf\u6211\u5011\u5f97\u5230\u9ec3\u8272\u65b9\u584a\u800c\u4e0d\u662f\u85cd\u8272\u65b9\u584a\u3002\u5b83\u9084\u5c07\u61c9\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230 bgdk \u547d\u540d\u7a7a\u9593\uff08\u7531\u6587\u4ef6\u7684\u547d\u540d\u7a7a\u9593\uff1a\u90e8\u5206\u9336\u793a\uff09\u4e26\u5c07\u9019\u500b\u65b0\u547d\u540d\u7a7a\u9593\u7684 Ingress \u4e3b\u6a5f\u540d\u66f4\u65b0\u70ba bgdk.devnation \u3002 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d bgdk.devnation \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 /etc/hosts \u3002 \u4f8b\u5b50\uff1a /etc/hosts 192.168.39.242 bgd.devnation bgdk.devnation \u9019\u61c9\u8a72\u6703\u5728 Argo CD UI \u4e0a\u5411\u60a8\u986f\u793a\u5169\u500b\u61c9\u7528\u7a0b\u5e8f\u3002 \u6253\u958b\u61c9\u7528\u7a0b\u5e8f\u7684 Ingress \u6216 Route\u3002 \u5982\u60a8\u6240\u898b\uff0c\u4f7f\u7528\u60a8\u7684\u81ea\u5b9a\u7fa9\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\uff01\u56de\u9867\u6211\u5011\u525b\u525b\u6240\u505a\u7684\u3002 \u90e8\u7f72\u4e86\u4e00\u500b\u540d\u70ba bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5e36\u6709\u4e00\u500b\u85cd\u8272\u65b9\u584a\u3002 \u90e8\u7f72\u4e86\u53e6\u4e00\u500b\u57fa\u65bc bgd \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u7a31\u70ba bgdk \u61c9\u7528\u7a0b\u5e8f bgdk \u90e8\u7f72\u5728\u5b83\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\uff0c\u4e26\u5177\u6709\u90e8\u7f72\u81ea\u5b9a\u7fa9\u3002 \u5168\u90e8\u7121\u9700\u8907\u5236 YAML\uff01","title":"Kustomized \u61c9\u7528\u7a0b\u5e8f"},{"location":"argocd/tutorial/04-syncwaves-hooks/","text":"SyncWaves \u8207 Hooks \u00b6 \u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/04-syncwaves-hooks.html Argo CD \u4e2d\u4f7f\u7528 Syncwave \u4f86\u78ba\u5b9a\u6e05\u55ae\u5982\u4f55\u61c9\u7528\u65bc\u96c6\u7fa4\u3002 \u53e6\u4e00\u65b9\u9762\uff0c resource hooks \u5728\u4e0d\u540c\u968e\u6bb5\u5206\u89e3\u4e86\u9019\u4e9b\u6e05\u55ae\u7684\u4ea4\u4ed8\u3002 \u4f7f\u7528 syncwaves \u548c resource hooks \u7684\u7d44\u5408\uff0c\u60a8\u53ef\u4ee5\u63a7\u5236\u61c9\u7528\u7a0b\u5e8f\u7684 roll out \u65b9\u5f0f\u3002 \u672c\u793a\u4f8b\u5c07\u5f15\u5c0e\u60a8\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u4f7f\u7528 Syncwaves \u63a7\u5236\u90e8\u7f72\u9806\u5e8f \u63a2\u7d22 Resource Hooks \u7d44\u5408\u4f7f\u7528 Syncwaves \u548c Resource Hooks \u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u5e36\u6709\u6578\u64da\u5eab\u7684 TODO \u61c9\u7528\u7a0b\u5e8f\uff0c\u9664\u4e86\u90e8\u7f72\u6587\u4ef6\u4e4b\u5916\uff0c\u9084\u4f7f\u7528\u4e86 Syncwaves \u548c Resource Hooks : \u4f7f\u7528 Syncwaves \u00b6 Syncwave \u662f\u4e00\u7a2e\u547d\u4ee4 Argo CD \u5982\u4f55\u61c9\u7528\u5b58\u5132\u5728 git \u4e2d\u7684\u6e05\u55ae\u7684\u65b9\u6cd5\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6240\u6709\u6e05\u55ae\u90fd\u5177\u6709\u96f6\u6ce2\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/sync-wave \u8a3b\u91cb\u4f86\u8a2d\u7f6e\u9019\u4e9b\u3002 \u4f8b\u5b50\uff1a metadata : annotations : argocd.argoproj.io/sync-wave : \"2\" wave \u7684\u6578\u503c\u4e5f\u53ef\u4ee5\u662f \u8ca0 \u7684\u3002 metadata : annotations : argocd.argoproj.io/sync-wave : \"-5\" \u7576 Argo CD \u958b\u59cb\u540c\u6b65\u64cd\u4f5c\u6642\uff0c\u6e05\u55ae\u6309\u4ee5\u4e0b\u9806\u5e8f\u653e\u7f6e\uff1a \u4ed6\u5011\u6240\u8655\u7684\u968e\u6bb5\uff08\u6211\u5011\u5c07\u5728\u4e0b\u4e00\u7bc0\u4e2d\u4ecb\u7d39\u968e\u6bb5\uff09 \u8cc7\u6e90\u88ab\u8a3b\u91cb\u7684\u6ce2\u6b21\uff08\u5f9e\u6700\u4f4e\u503c\u5230\u6700\u9ad8\u503c\uff09 \u6309\u7a2e\u985e\uff08\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\uff0c\u7136\u5f8c\u662f\u670d\u52d9\uff0c\u7136\u5f8c\u662f\u90e8\u7f72\u7b49......\uff09 \u6309\u540d\u7a31\uff08\u5347\u5e8f\uff09 \u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e0a\u95b1\u8b80\u6709\u95dc Syncwaves \u7684\u66f4\u591a\u4fe1\u606f\u3002 \u63a2\u7d22 Manifests \u00b6 \u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u4ee5\u4e0b\u6e05\u55ae\uff1a Namespace \u7684 syncwave \u70ba -1 \uff1a todo-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : todo annotations : argocd.argoproj.io/sync-wave : \"-1\" PostgreSQL \u7684 syncwave \u8a2d\u70ba 0 : postgresql-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : name : postgresql namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : matchLabels : app : postgresql template : metadata : labels : app : postgresql spec : containers : - name : postgresql image : postgres:12 imagePullPolicy : Always ports : - name : tcp containerPort : 5432 env : - name : POSTGRES_PASSWORD value : admin - name : POSTGRES_USER value : admin - name : POSTGRES_DB value : todo PostgreSQL Service \u7684 syncwave \u8a2d\u70ba 0 : postgresql-service.yaml --- apiVersion : v1 kind : Service metadata : name : postgres namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : app : postgresql ports : - name : pgsql port : 5432 targetPort : 5432 Database table creation \u7684 syncwave \u8a2d\u70ba 1 : postgres-create-table.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-table namespace : todo annotations : argocd.argoproj.io/sync-wave : \"1\" spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : postgresql-client image : postgres:12 imagePullPolicy : Always env : - name : PGPASSWORD value : admin command : [ \"psql\" ] args : [ \"--host=postgresql\" , \"--username=admin\" , \"--no-password\" , \"--dbname=todo\" , \"--command=create table Todo (id bigint not null,completed boolean not null,ordering integer,title varchar(255),url varchar(255),primary key (id));create sequence hibernate_sequence start with 1 increment by 1;\" , ] restartPolicy : Never backoffLimit : 1 TODO application deployment \u7684 syncwave \u8a2d\u70ba 2 : todo-deployment.yaml --- apiVersion : \"v1\" kind : \"ServiceAccount\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo\u540c\u6b65\u6ce2 argocd.argoproj.io/sync-wave : \"2\" --- apiVersion : \"apps/v1\" kind : \"Deployment\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo annotations : argocd.argoproj.io/sync-wave : \"2\" spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" template : metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" spec : containers : - env : - name : \"KUBERNETES_NAMESPACE\" valueFrom : fieldRef : fieldPath : \"metadata.namespace\" image : \"quay.io/rhdevelopers/todo-gitops:1.0.0\" imagePullPolicy : \"Always\" name : \"todo-gitops\" ports : - containerPort : 8080 name : \"http\" protocol : \"TCP\" serviceAccount : \"todo-gitops\" TODO \u7db2\u8def\u914d\u7f6e\uff1a TODO Service \u7684 syncwave \u8a2d\u70ba 2 : todo-service.yaml --- apiVersion : \"v1\" kind : \"Service\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" annotations : argocd.argoproj.io/sync-wave : \"2\" namespace : todo spec : ports : - name : \"http\" port : 8080 targetPort : 8080 selector : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" type : \"NodePort\" TODO Ingress \u7684 syncwave \u8a2d\u70ba 3 : todo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : todo namespace : todo annotations : argocd.argoproj.io/sync-wave : \"3\" spec : rules : - host : todo.devnation http : paths : - path : / pathType : Prefix backend:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 service : name : todo-gitops port:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d `todo.devnation` \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 `/etc/hosts`\u3002 ``` title=\"/etc/hosts\" 192.168.39.242 bgd.devnation bgdk.devnation todo.devnation Argo CD \u5c07\u9996\u5148\u61c9\u7528\u547d\u540d\u7a7a\u9593\uff08\u56e0\u70ba\u5b83\u662f\u6700\u5c0f\u503c\uff09\uff0c\u4e26\u78ba\u4fdd\u5b83\u5728\u7e7c\u7e8c\u4e4b\u524d\u8fd4\u56de\u201c\u5065\u5eb7\u201d\u72c0\u614b\u3002 \u63a5\u4e0b\u4f86\uff0c\u5c07\u61c9\u7528 PostgreSQL \u90e8\u7f72\u3002\u4e4b\u5f8c\uff0c\u5831\u544a\u5065\u5eb7\u5c07\u7e7c\u7e8c\u4f7f\u7528\u5176\u9918\u8cc7\u6e90\u3002 Info Argo CD \u5728\u4e4b\u524d\u7684\u5831\u544a\u201c\u5065\u5eb7\u201d\u4e4b\u524d\u4e0d\u6703\u61c9\u7528\u4e0b\u4e00\u500b\u6e05\u55ae\u3002 \u63a2\u7d22 Resource Hooks \u00b6 \u73fe\u5728\u60a8\u5df2\u7d93\u719f\u6089\u4e86 syncwave \uff0c\u6211\u5011\u53ef\u4ee5\u958b\u59cb\u63a2\u7d22\u4f7f\u7528 resource hooks \u5206\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u3002 \u4f7f\u7528 hook \u53ef\u4ee5\u9032\u4e00\u6b65\u91cd\u65b0\u5b9a\u7fa9\u63a7\u5236\u540c\u6b65\u64cd\u4f5c\u3002 PreSync - \u5728\u540c\u6b65\u64cd\u4f5c\u4e4b\u524d\u904b\u884c\u3002\u9019\u53ef\u80fd\u985e\u4f3c\u65bc\u67b6\u69cb\u66f4\u6539\u4e4b\u524d\u7684\u6578\u64da\u5eab\u5099\u4efd\u3002 Sync - \u5728 PreSync \u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u5c07\u8207\u60a8\u7684\u6b63\u5e38\u6e05\u55ae\u4e00\u8d77\u904b\u884c\u3002 PostSync - \u5728\u540c\u6b65\u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u53ef\u4ee5\u662f\u8af8\u5982 Slack \u6d88\u606f\u6216\u96fb\u5b50\u90f5\u4ef6\u901a\u77e5\u4e4b\u985e\u7684\u6771\u897f\u3002 SyncFail - \u5982\u679c\u540c\u6b65\u64cd\u4f5c\u5931\u6557\u5247\u904b\u884c\u3002\u9019\u4e5f\u7528\u65bc\u767c\u9001\u901a\u77e5\u6216\u57f7\u884c\u5176\u4ed6\u898f\u907f\u64cd\u4f5c\u3002 \u8981\u555f\u7528\u540c\u6b65\uff0c\u8acb\u4f7f\u7528 argocd.argoproj.io/hook \u4f7f\u7528\u60a8\u8981\u7528\u65bc\u8a72\u8cc7\u6e90\u7684\u540c\u6b65\u985e\u578b\u4f86\u8a3b\u91cb\u7279\u5b9a\u5c0d\u8c61\u6e05\u55ae\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u60f3\u4f7f\u7528 PreSync \u9264\u5b50\uff1a metadata : annotations : argocd.argoproj.io/hook : PreSync \u60a8\u9084\u53ef\u4ee5\u5728\u6210\u529f/\u4e0d\u6210\u529f\u904b\u884c\u5f8c\u522a\u9664\u639b\u9264\u3002 HookSucceeded - \u8cc7\u6e90\u5728\u6210\u529f\u5f8c\u5c07\u88ab\u522a\u9664\u3002 HookFailed - \u5982\u679c\u8cc7\u6e90\u5931\u6557\uff0c\u8cc7\u6e90\u5c07\u88ab\u522a\u9664\u3002 BeforeHookCreation - \u5728\u5275\u5efa\u65b0\u8cc7\u6e90\u4e4b\u524d\u5c07\u522a\u9664\u8cc7\u6e90\uff08\u89f8\u767c\u65b0\u540c\u6b65\u6642\uff09\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/hook-delete-policy \u8a3b\u91cb\u4f86\u61c9\u7528\u9019\u4e9b\u3002\u4f8b\u5982 metadata : annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded Tips \u7531\u65bc\u540c\u6b65\u53ef\u80fd\u5728\u4efb\u4f55\u968e\u6bb5\u5931\u6557\uff0c\u60a8\u53ef\u80fd\u6703\u9047\u5230\u61c9\u7528\u7a0b\u5e8f\u6c38\u9060\u4e0d\u6703\u5831\u544a\u5065\u5eb7\u7684\u60c5\u6cc1\uff01 \u96d6\u7136\u9264\u5b50\u53ef\u4ee5\u662f\u4efb\u4f55\u8cc7\u6e90\uff0c\u4f46\u5b83\u5011\u901a\u5e38\u662f Pod \u548c/\u6216 Job\u3002 \u8981\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u8cc7\u6e90\u639b\u9264\u7684\u4fe1\u606f\uff0c\u8acb\u67e5\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002 \u63a2\u7d22\u6e05\u55ae \u00b6 \u770b\u770b\u9019\u500b PostSync \u6e05\u55ae\uff0c\u5b83\u767c\u9001\u4e00\u500b HTTP \u8acb\u6c42\u4f86\u63d2\u5165\u4e00\u500b\u65b0\u7684 TODO \u9805\uff1a todo-insert-data.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-insert annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : httpie image : alpine/httpie:2.4.0 imagePullPolicy : Always command : [ \"http\" ] args : [ \"POST\" , \"todo-gitops:8080/api\" , \"title=Finish ArgoCD tutorial\" , \"--ignore-stdin\" ] restartPolicy : Never backoffLimit : 1 Info \u9019\u610f\u5473\u8457\u8a72\u4f5c\u696d\u5c07\u5728\u540c\u6b65\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u4e4b\u5f8c\u5728 PostSync \u968e\u6bb5\u904b\u884c\u3002 \u57f7\u884c\u9806\u5e8f\u5982\u4e0b\u5716\u6240\u793a\uff1a \u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f \u00b6 \u60a8\u53ef\u4ee5\u901a\u904e\u8a2a\u554f repo \u67e5\u770b\u6240\u6709\u90e8\u7f72\u6587\u4ef6\u3002 \u770b\u770b\u9019\u500b\u6e05\u55ae\u6587\u4ef6\uff1a todo-application.yaml \uff1a todo-application.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : todo-app namespace : argocd spec : destination : namespace : todo server : https://kubernetes.default.svc project : default source : path : apps/todo repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u5b83\u5c07\u986f\u793a\u9019\u5c07\u5728 todo \u547d\u540d\u7a7a\u9593\u4e2d\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u6b64\u61c9\u7528\u7a0b\u5e8f\uff1a kubectl apply -f documentation/modules/ROOT/examples/minikube/todo-yaml/todo-application.yaml application.argoproj.io/todo-app created \u5728 Argo CD WebUI \u4e0a\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u53e6\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u51fa\u73fe\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u61c9\u5c07\u60a8\u5e36\u5230\u6a39\u8996\u5716\u3002 \u89c0\u5bdf\u540c\u6b65\u904e\u7a0b\u3002\u60a8\u5c07\u770b\u5230\u61c9\u7528\u8cc7\u6e90\u7684\u9806\u5e8f\uff0c\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\u5275\u5efa\uff0c\u6700\u5f8c\u662f\u5275\u5efa Route \u4ee5\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\u3002 \u4e00\u65e6\u61c9\u7528\u7a0b\u5e8f\u5b8c\u5168\u540c\u6b65\u3002\u67e5\u770b\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u548c\u4f5c\u696d\uff1a $ kubectl get pods -n todo \u60a8\u61c9\u8a72\u770b\u5230 Job \u5df2\u5b8c\u6210\uff0c\u4f46\u4ecd\u7136\u5b58\u5728\u3002 NAME READY STATUS RESTARTS AGE postgresql-599467fd86-cgj9v 1 /1 Running 0 32s todo-gitops-679d88f6f4-v4djp 1 /1 Running 0 19s todo-table-xhddk 0 /1 Completed 0 27s \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 todo-insert \u4f5c\u696d\u672a\u986f\u793a\uff0c\u56e0\u70ba\u5b83\u88ab\u914d\u7f6e\u70ba\u5982\u679c\u6210\u529f\u5247\u88ab\u522a\u9664\uff1a argocd.argoproj.io/hook-delete-policy : HookSucceeded","title":"SyncWaves \u8207 Hooks"},{"location":"argocd/tutorial/04-syncwaves-hooks/#syncwaves-hooks","text":"\u539f\u6587: https://redhat-scholars.github.io/argocd-tutorial/argocd-tutorial/04-syncwaves-hooks.html Argo CD \u4e2d\u4f7f\u7528 Syncwave \u4f86\u78ba\u5b9a\u6e05\u55ae\u5982\u4f55\u61c9\u7528\u65bc\u96c6\u7fa4\u3002 \u53e6\u4e00\u65b9\u9762\uff0c resource hooks \u5728\u4e0d\u540c\u968e\u6bb5\u5206\u89e3\u4e86\u9019\u4e9b\u6e05\u55ae\u7684\u4ea4\u4ed8\u3002 \u4f7f\u7528 syncwaves \u548c resource hooks \u7684\u7d44\u5408\uff0c\u60a8\u53ef\u4ee5\u63a7\u5236\u61c9\u7528\u7a0b\u5e8f\u7684 roll out \u65b9\u5f0f\u3002 \u672c\u793a\u4f8b\u5c07\u5f15\u5c0e\u60a8\u5b8c\u6210\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u4f7f\u7528 Syncwaves \u63a7\u5236\u90e8\u7f72\u9806\u5e8f \u63a2\u7d22 Resource Hooks \u7d44\u5408\u4f7f\u7528 Syncwaves \u548c Resource Hooks \u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u5e36\u6709\u6578\u64da\u5eab\u7684 TODO \u61c9\u7528\u7a0b\u5e8f\uff0c\u9664\u4e86\u90e8\u7f72\u6587\u4ef6\u4e4b\u5916\uff0c\u9084\u4f7f\u7528\u4e86 Syncwaves \u548c Resource Hooks :","title":"SyncWaves \u8207 Hooks"},{"location":"argocd/tutorial/04-syncwaves-hooks/#syncwaves","text":"Syncwave \u662f\u4e00\u7a2e\u547d\u4ee4 Argo CD \u5982\u4f55\u61c9\u7528\u5b58\u5132\u5728 git \u4e2d\u7684\u6e05\u55ae\u7684\u65b9\u6cd5\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6240\u6709\u6e05\u55ae\u90fd\u5177\u6709\u96f6\u6ce2\uff0c\u4f46\u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/sync-wave \u8a3b\u91cb\u4f86\u8a2d\u7f6e\u9019\u4e9b\u3002 \u4f8b\u5b50\uff1a metadata : annotations : argocd.argoproj.io/sync-wave : \"2\" wave \u7684\u6578\u503c\u4e5f\u53ef\u4ee5\u662f \u8ca0 \u7684\u3002 metadata : annotations : argocd.argoproj.io/sync-wave : \"-5\" \u7576 Argo CD \u958b\u59cb\u540c\u6b65\u64cd\u4f5c\u6642\uff0c\u6e05\u55ae\u6309\u4ee5\u4e0b\u9806\u5e8f\u653e\u7f6e\uff1a \u4ed6\u5011\u6240\u8655\u7684\u968e\u6bb5\uff08\u6211\u5011\u5c07\u5728\u4e0b\u4e00\u7bc0\u4e2d\u4ecb\u7d39\u968e\u6bb5\uff09 \u8cc7\u6e90\u88ab\u8a3b\u91cb\u7684\u6ce2\u6b21\uff08\u5f9e\u6700\u4f4e\u503c\u5230\u6700\u9ad8\u503c\uff09 \u6309\u7a2e\u985e\uff08\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\uff0c\u7136\u5f8c\u662f\u670d\u52d9\uff0c\u7136\u5f8c\u662f\u90e8\u7f72\u7b49......\uff09 \u6309\u540d\u7a31\uff08\u5347\u5e8f\uff09 \u5728\u5b98\u65b9\u6587\u6a94\u7ad9\u9ede\u4e0a\u95b1\u8b80\u6709\u95dc Syncwaves \u7684\u66f4\u591a\u4fe1\u606f\u3002","title":"\u4f7f\u7528 Syncwaves"},{"location":"argocd/tutorial/04-syncwaves-hooks/#manifests","text":"\u6211\u5011\u5c07\u90e8\u7f72\u7684\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u4ee5\u4e0b\u6e05\u55ae\uff1a Namespace \u7684 syncwave \u70ba -1 \uff1a todo-namespace.yaml apiVersion : v1 kind : Namespace metadata : name : todo annotations : argocd.argoproj.io/sync-wave : \"-1\" PostgreSQL \u7684 syncwave \u8a2d\u70ba 0 : postgresql-deployment.yaml --- apiVersion : apps/v1 kind : Deployment metadata : name : postgresql namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : matchLabels : app : postgresql template : metadata : labels : app : postgresql spec : containers : - name : postgresql image : postgres:12 imagePullPolicy : Always ports : - name : tcp containerPort : 5432 env : - name : POSTGRES_PASSWORD value : admin - name : POSTGRES_USER value : admin - name : POSTGRES_DB value : todo PostgreSQL Service \u7684 syncwave \u8a2d\u70ba 0 : postgresql-service.yaml --- apiVersion : v1 kind : Service metadata : name : postgres namespace : todo annotations : argocd.argoproj.io/sync-wave : \"0\" spec : selector : app : postgresql ports : - name : pgsql port : 5432 targetPort : 5432 Database table creation \u7684 syncwave \u8a2d\u70ba 1 : postgres-create-table.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-table namespace : todo annotations : argocd.argoproj.io/sync-wave : \"1\" spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : postgresql-client image : postgres:12 imagePullPolicy : Always env : - name : PGPASSWORD value : admin command : [ \"psql\" ] args : [ \"--host=postgresql\" , \"--username=admin\" , \"--no-password\" , \"--dbname=todo\" , \"--command=create table Todo (id bigint not null,completed boolean not null,ordering integer,title varchar(255),url varchar(255),primary key (id));create sequence hibernate_sequence start with 1 increment by 1;\" , ] restartPolicy : Never backoffLimit : 1 TODO application deployment \u7684 syncwave \u8a2d\u70ba 2 : todo-deployment.yaml --- apiVersion : \"v1\" kind : \"ServiceAccount\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo\u540c\u6b65\u6ce2 argocd.argoproj.io/sync-wave : \"2\" --- apiVersion : \"apps/v1\" kind : \"Deployment\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" namespace : todo annotations : argocd.argoproj.io/sync-wave : \"2\" spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" template : metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" spec : containers : - env : - name : \"KUBERNETES_NAMESPACE\" valueFrom : fieldRef : fieldPath : \"metadata.namespace\" image : \"quay.io/rhdevelopers/todo-gitops:1.0.0\" imagePullPolicy : \"Always\" name : \"todo-gitops\" ports : - containerPort : 8080 name : \"http\" protocol : \"TCP\" serviceAccount : \"todo-gitops\" TODO \u7db2\u8def\u914d\u7f6e\uff1a TODO Service \u7684 syncwave \u8a2d\u70ba 2 : todo-service.yaml --- apiVersion : \"v1\" kind : \"Service\" metadata : labels : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" name : \"todo-gitops\" annotations : argocd.argoproj.io/sync-wave : \"2\" namespace : todo spec : ports : - name : \"http\" port : 8080 targetPort : 8080 selector : app.kubernetes.io/name : \"todo-gitops\" app.kubernetes.io/version : \"1.0.0\" type : \"NodePort\" TODO Ingress \u7684 syncwave \u8a2d\u70ba 3 : todo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : todo namespace : todo annotations : argocd.argoproj.io/sync-wave : \"3\" spec : rules : - host : todo.devnation http : paths : - path : / pathType : Prefix backend:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 service : name : todo-gitops port:\u63a2\u7d22\u8cc7\u6e90\u639b\u9264 \u5c07 Minikube IP (minikube ip) \u548c Ingress \u4e3b\u6a5f\u540d `todo.devnation` \u6dfb\u52a0\u5230\u60a8\u7684\u4e3b\u6a5f\u6587\u4ef6\u4e2d\uff0c\u4f8b\u5982 `/etc/hosts`\u3002 ``` title=\"/etc/hosts\" 192.168.39.242 bgd.devnation bgdk.devnation todo.devnation Argo CD \u5c07\u9996\u5148\u61c9\u7528\u547d\u540d\u7a7a\u9593\uff08\u56e0\u70ba\u5b83\u662f\u6700\u5c0f\u503c\uff09\uff0c\u4e26\u78ba\u4fdd\u5b83\u5728\u7e7c\u7e8c\u4e4b\u524d\u8fd4\u56de\u201c\u5065\u5eb7\u201d\u72c0\u614b\u3002 \u63a5\u4e0b\u4f86\uff0c\u5c07\u61c9\u7528 PostgreSQL \u90e8\u7f72\u3002\u4e4b\u5f8c\uff0c\u5831\u544a\u5065\u5eb7\u5c07\u7e7c\u7e8c\u4f7f\u7528\u5176\u9918\u8cc7\u6e90\u3002 Info Argo CD \u5728\u4e4b\u524d\u7684\u5831\u544a\u201c\u5065\u5eb7\u201d\u4e4b\u524d\u4e0d\u6703\u61c9\u7528\u4e0b\u4e00\u500b\u6e05\u55ae\u3002","title":"\u63a2\u7d22 Manifests"},{"location":"argocd/tutorial/04-syncwaves-hooks/#resource-hooks","text":"\u73fe\u5728\u60a8\u5df2\u7d93\u719f\u6089\u4e86 syncwave \uff0c\u6211\u5011\u53ef\u4ee5\u958b\u59cb\u63a2\u7d22\u4f7f\u7528 resource hooks \u5206\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u3002 \u4f7f\u7528 hook \u53ef\u4ee5\u9032\u4e00\u6b65\u91cd\u65b0\u5b9a\u7fa9\u63a7\u5236\u540c\u6b65\u64cd\u4f5c\u3002 PreSync - \u5728\u540c\u6b65\u64cd\u4f5c\u4e4b\u524d\u904b\u884c\u3002\u9019\u53ef\u80fd\u985e\u4f3c\u65bc\u67b6\u69cb\u66f4\u6539\u4e4b\u524d\u7684\u6578\u64da\u5eab\u5099\u4efd\u3002 Sync - \u5728 PreSync \u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u5c07\u8207\u60a8\u7684\u6b63\u5e38\u6e05\u55ae\u4e00\u8d77\u904b\u884c\u3002 PostSync - \u5728\u540c\u6b65\u6210\u529f\u904b\u884c\u5f8c\u904b\u884c\u3002\u9019\u53ef\u4ee5\u662f\u8af8\u5982 Slack \u6d88\u606f\u6216\u96fb\u5b50\u90f5\u4ef6\u901a\u77e5\u4e4b\u985e\u7684\u6771\u897f\u3002 SyncFail - \u5982\u679c\u540c\u6b65\u64cd\u4f5c\u5931\u6557\u5247\u904b\u884c\u3002\u9019\u4e5f\u7528\u65bc\u767c\u9001\u901a\u77e5\u6216\u57f7\u884c\u5176\u4ed6\u898f\u907f\u64cd\u4f5c\u3002 \u8981\u555f\u7528\u540c\u6b65\uff0c\u8acb\u4f7f\u7528 argocd.argoproj.io/hook \u4f7f\u7528\u60a8\u8981\u7528\u65bc\u8a72\u8cc7\u6e90\u7684\u540c\u6b65\u985e\u578b\u4f86\u8a3b\u91cb\u7279\u5b9a\u5c0d\u8c61\u6e05\u55ae\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u60f3\u4f7f\u7528 PreSync \u9264\u5b50\uff1a metadata : annotations : argocd.argoproj.io/hook : PreSync \u60a8\u9084\u53ef\u4ee5\u5728\u6210\u529f/\u4e0d\u6210\u529f\u904b\u884c\u5f8c\u522a\u9664\u639b\u9264\u3002 HookSucceeded - \u8cc7\u6e90\u5728\u6210\u529f\u5f8c\u5c07\u88ab\u522a\u9664\u3002 HookFailed - \u5982\u679c\u8cc7\u6e90\u5931\u6557\uff0c\u8cc7\u6e90\u5c07\u88ab\u522a\u9664\u3002 BeforeHookCreation - \u5728\u5275\u5efa\u65b0\u8cc7\u6e90\u4e4b\u524d\u5c07\u522a\u9664\u8cc7\u6e90\uff08\u89f8\u767c\u65b0\u540c\u6b65\u6642\uff09\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 argocd.argoproj.io/hook-delete-policy \u8a3b\u91cb\u4f86\u61c9\u7528\u9019\u4e9b\u3002\u4f8b\u5982 metadata : annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded Tips \u7531\u65bc\u540c\u6b65\u53ef\u80fd\u5728\u4efb\u4f55\u968e\u6bb5\u5931\u6557\uff0c\u60a8\u53ef\u80fd\u6703\u9047\u5230\u61c9\u7528\u7a0b\u5e8f\u6c38\u9060\u4e0d\u6703\u5831\u544a\u5065\u5eb7\u7684\u60c5\u6cc1\uff01 \u96d6\u7136\u9264\u5b50\u53ef\u4ee5\u662f\u4efb\u4f55\u8cc7\u6e90\uff0c\u4f46\u5b83\u5011\u901a\u5e38\u662f Pod \u548c/\u6216 Job\u3002 \u8981\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u8cc7\u6e90\u639b\u9264\u7684\u4fe1\u606f\uff0c\u8acb\u67e5\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002","title":"\u63a2\u7d22 Resource Hooks"},{"location":"argocd/tutorial/04-syncwaves-hooks/#_1","text":"\u770b\u770b\u9019\u500b PostSync \u6e05\u55ae\uff0c\u5b83\u767c\u9001\u4e00\u500b HTTP \u8acb\u6c42\u4f86\u63d2\u5165\u4e00\u500b\u65b0\u7684 TODO \u9805\uff1a todo-insert-data.yaml apiVersion : batch/v1 kind : Job metadata : name : todo-insert annotations : argocd.argoproj.io/hook : PostSync argocd.argoproj.io/hook-delete-policy : HookSucceeded spec : ttlSecondsAfterFinished : 100 template : spec : containers : - name : httpie image : alpine/httpie:2.4.0 imagePullPolicy : Always command : [ \"http\" ] args : [ \"POST\" , \"todo-gitops:8080/api\" , \"title=Finish ArgoCD tutorial\" , \"--ignore-stdin\" ] restartPolicy : Never backoffLimit : 1 Info \u9019\u610f\u5473\u8457\u8a72\u4f5c\u696d\u5c07\u5728\u540c\u6b65\u968e\u6bb5\u61c9\u7528\u6e05\u55ae\u4e4b\u5f8c\u5728 PostSync \u968e\u6bb5\u904b\u884c\u3002 \u57f7\u884c\u9806\u5e8f\u5982\u4e0b\u5716\u6240\u793a\uff1a","title":"\u63a2\u7d22\u6e05\u55ae"},{"location":"argocd/tutorial/04-syncwaves-hooks/#_2","text":"\u60a8\u53ef\u4ee5\u901a\u904e\u8a2a\u554f repo \u67e5\u770b\u6240\u6709\u90e8\u7f72\u6587\u4ef6\u3002 \u770b\u770b\u9019\u500b\u6e05\u55ae\u6587\u4ef6\uff1a todo-application.yaml \uff1a todo-application.yaml apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : todo-app namespace : argocd spec : destination : namespace : todo server : https://kubernetes.default.svc project : default source : path : apps/todo repoURL : https://github.com/redhat-developer-demos/openshift-gitops-examples targetRevision : minikube syncPolicy : automated : prune : true selfHeal : false syncOptions : - CreateNamespace=true \u5b83\u5c07\u986f\u793a\u9019\u5c07\u5728 todo \u547d\u540d\u7a7a\u9593\u4e2d\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u6b64\u61c9\u7528\u7a0b\u5e8f\uff1a kubectl apply -f documentation/modules/ROOT/examples/minikube/todo-yaml/todo-application.yaml application.argoproj.io/todo-app created \u5728 Argo CD WebUI \u4e0a\uff0c\u60a8\u61c9\u8a72\u6703\u770b\u5230\u53e6\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u51fa\u73fe\u3002 \u9ede\u64ca\u6b64\u201c\u5361\u7247\u201d\u61c9\u5c07\u60a8\u5e36\u5230\u6a39\u8996\u5716\u3002 \u89c0\u5bdf\u540c\u6b65\u904e\u7a0b\u3002\u60a8\u5c07\u770b\u5230\u61c9\u7528\u8cc7\u6e90\u7684\u9806\u5e8f\uff0c\u9996\u5148\u662f\u547d\u540d\u7a7a\u9593\u5275\u5efa\uff0c\u6700\u5f8c\u662f\u5275\u5efa Route \u4ee5\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\u3002 \u4e00\u65e6\u61c9\u7528\u7a0b\u5e8f\u5b8c\u5168\u540c\u6b65\u3002\u67e5\u770b\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u548c\u4f5c\u696d\uff1a $ kubectl get pods -n todo \u60a8\u61c9\u8a72\u770b\u5230 Job \u5df2\u5b8c\u6210\uff0c\u4f46\u4ecd\u7136\u5b58\u5728\u3002 NAME READY STATUS RESTARTS AGE postgresql-599467fd86-cgj9v 1 /1 Running 0 32s todo-gitops-679d88f6f4-v4djp 1 /1 Running 0 19s todo-table-xhddk 0 /1 Completed 0 27s \u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u61c9\u5982\u4e0b\u6240\u793a\u3002 todo-insert \u4f5c\u696d\u672a\u986f\u793a\uff0c\u56e0\u70ba\u5b83\u88ab\u914d\u7f6e\u70ba\u5982\u679c\u6210\u529f\u5247\u88ab\u522a\u9664\uff1a argocd.argoproj.io/hook-delete-policy : HookSucceeded","title":"\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/","text":"Argo CD ApplicationSet Controller \u00b6 \u539f\u6587: https://medium.com/starbugs/argo-cd-applicationset-controller-%E4%B8%96%E7%95%8C%E7%82%BA%E6%88%91%E8%80%8C%E8%BD%89%E5%8B%95-a837f9392298 Argo CD \u5728 Multi-Cluster \u7684\u7ba1\u7406\u6a21\u5f0f\uff0c\u5fc5\u9808\u5148\u5728 Primary Cluster \u5b89\u88dd Argo CD\uff0c\u7136\u5f8c\u518d\u900f\u904e\u9019\u500b Primary Cluster \u53bb\u7ba1\u7406\u5176\u4ed6\u7684 Cluster\uff0c\u5c6c\u65bc Primary \u8207 Secondary \u7684\u67b6\u69cb\uff0c\u56e0\u6b64\u5fc5\u9808\u8981\u8b93 Primary Cluster \u6709\u6b0a\u9650\u53bb\u5b58\u53d6 Secondary Cluster, \u5f7c\u6b64\u4e4b\u9593\u7684\u7db2\u8def\u7576\u7136\u5c31\u8981\u6253\u901a\u3002 Argo CD \u4e2d\u6709\u4e00\u500b\u7528\u4f86 Bootstrap Cluster \u7684 App of Apps Pattern \u7121\u6cd5\u5728 Primary & Secondary \u7684\u67b6\u69cb\u4e0b\u8f15\u6613\u5730\u4f7f\u7528\uff0c\u56e0\u70ba\u5176\u4e2d\u6703\u7528\u5230 Argo CD \u5167\u624d\u6709\u7684 Application CRD\uff0c\u53ef\u662f Secondary Cluster \u4e26\u6c92\u6709\u5b89\u88dd Argo CD\uff0c\u9019\u6a23\u4e00\u4f86\u88ab\u7ba1\u7406\u7684 Secondary Cluster \u4e5f\u60f3\u8981\u4e00\u6b21\u5b89\u88dd\u597d\u6240\u6709\u5957\u4ef6\u8981\u5982\u4f55\u9054\u6210\u5462\uff1f\uff01Argo CD V2.0 \u767c\u5e03\u7684\u6642\u5019\uff0c\u63a8\u51fa\u4e86\u53ef\u4ee5\u8ddf Argo CD \u4e00\u8d77\u642d\u914d\u4f7f\u7528\u7684 ApplicationSet Controller \u4f86\u5f4c\u88dc\u4e4b\u524d\u529f\u80fd\u7684\u4e0d\u8db3\uff0c\u800c\u6b64\u7bc7\u6587\u7ae0\u4e3b\u8981\u5c31\u662f\u4f86\u8aaa\u660e Argo CD ApplicationSet Controller\u3002 ApplicationSet \u63a7\u5236\u5668 \u00b6 apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : prometheus finalizers : - resources-finalizer.argocd.argoproj.io spec : destination : server : https://kubernetes.default.svc namespace : default project : default source : path : infrastructure/solar-system/sun/prometheus repoURL : https://github.com/smalltown/argo-galaxy.git targetRevision : HEAD syncPolicy : automated : prune : true selfHeal : true \u5728 Argo CD \u4e2d\u6700\u57fa\u672c\u7684\u5143\u7d20\u5c31\u662f Application CRD\uff0c\u5b83\u5b9a\u7fa9\u8981\u5982\u4f55\u5b89\u88dd\u4e00\u500b\u61c9\u7528\u5728 K8s Cluster \u4e2d\uff0c\u4ee5\u4e0a\u9762\u7684 YAML \u6a94\u6848\u7576\u4f5c\u4f8b\u5b50\uff0c\u4ed6\u662f\u4e00\u500b\u53eb\u505a Prometheus \u7684 Application CRD\u3002 Destination \u5b9a\u7fa9\u8981\u5b89\u88dd Prometheus \u5230\u54ea\u4e00\u5ea7 K8s Cluster \u4e2d\u7684\u7684\u54ea\u4e00\u500b Namespace Source \u5247\u662f\u6307\u5b89\u88dd Prometheus \u7684 Kubernetes Manifest \u5b58\u653e\u65bc\u4f55\u8655 SyncPolicy \u5247\u662f Agro CD \u7528\u4f86\u76e3\u63a7 Prometheus \u5728 K8s Cluster \u4e2d\u7684\u771f\u5be6\u72c0\u614b\u548c Source \u4e2d\u5b9a\u7fa9\u7684\u662f\u5426\u76f8\u540c\uff0c\u4e0d\u540c\u7684\u8a71\u5c31\u53ef\u4ee5\u5e6b\u5fd9\u9032\u884c\u540c\u6b65\u6642\u7684\u898f\u5247 Argo CD ApplicationSet Controller \u53ef\u4ee5\u8aaa\u662f Application CRD \u7684\u5a01\u529b\u52a0\u5f37\u7248\uff0c\u5b83\u8b93\u4f7f\u7528\u8005\u53ef\u4ee5\u5728\u55ae\u500b YAML \u6a94\u6848\u5167\u50cf\u662f\u5beb\u7a0b\u5f0f\u4f7f\u7528 For Loop \u4e00\u6a23\uff0c\u96a8\u4f7f\u7528\u8005\u7684\u9700\u6c42\u4e00\u6b21\u6027\u5730\u5efa\u7acb\u5927\u91cf\u7684 Application CRD\uff0c\u800c\u9019\u500b For Loop \u7684\u529f\u80fd\u53eb\u505a Generator\uff0c\u76ee\u524d\u63a8\u51fa\u7684\u7248\u672c\u4e2d\u5171\u6709\u56db\u7a2e Generator: Cluster Generator, Git Directory Generator, Git File Generator, List Generator\uff0c\u5e95\u4e0b\u6703\u4f7f\u7528\u5be6\u969b\u7bc4\u4f8b\u4f86\u6f14\u793a\u9019\u56db\u7a2e Generator \u5982\u4f55\u89e3\u653e Kubernetes \u7dad\u904b\u4eba\u54e1\u7684\u96d9\u624b\u8207\u6642\u9593\u3002 \u74b0\u5883\u6e96\u5099 \u00b6 \u70ba\u4e86\u589e\u52a0\u4e00\u9ede\u8da3\u5473\u6027\uff0c\u6240\u4ee5\u6c92\u6709\u4f7f\u7528 Alpha, Beta \u548c Production \u7684\u5b57\u773c\uff0c\u9019\u908a\u4ee5\u5927\u5bb6\u5c45\u4f4f\u7684\u592a\u967d\u7cfb\u4f86\u7576\u547d\u540d\u898f\u5247\uff0c\u592a\u967d (Sun) \u5c31\u662f\u5b89\u88dd\u6709 Argo CD \u7684 Primary K8s Cluster, \u800c\u5176\u4ed6\u7684\u884c\u661f\u5c31\u662f\u88ab Argo CD \u6240\u7ba1\u7406\u7684 Secondary K8s Cluster\uff0c\u5730\u7403\u4e0a\u7684\u4e03\u5927\u6d32\u5c31\u985e\u6bd4\u70ba K8s Namespace\uff0c\u5927\u5bb6\u4e00\u8d77\u4f86\u7576\u5275\u4e16\u795e\uff01 \u6839\u64da\u5e95\u4e0b\u7684\u6b65\u9a5f\u5c07\u6703\u5728\u672c\u5730\u7aef\u5275\u5efa 4 \u5ea7 K8s Cluster (Sun, Mercury, Venus \u548c Earth)\uff0c\u4e26\u4e14\u5c07 Argo CD \u548c Argo CD ApplicationSet Controller \u5b89\u88dd\u5728 K8s Cluster Sun, \u7136\u5f8c\u628a\u53e6\u5916\u4e09\u5ea7 K8s Cluster Mercury, Venus \u548c Earth \u8a3b\u518a\u5230 Argo CD \u4e2d\u88ab\u7d0d\u7ba1\u3002 \u76f8\u95dc\u9700\u8981\u7684 CLI \u5de5\u5177 \u00b6 \u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u9700\u8981\u4ee5\u4e0b CLI \u5de5\u5177\u3002\u5728\u958b\u59cb\u5b78\u7fd2\u4efb\u4f55\u6559\u7a0b\u7ae0\u7bc0\u4e4b\u524d\uff0c\u8acb\u5148\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\u5011\u3002 Tool Linux Git Download Docker Download K3D v5.4.4 Download kubectl v1.20.2 Download argocd v2.0.0 Download kustomize v4.1.2 Download \u4ee5\u4e0b CLI \u5de5\u5177\u5c0d\u65bc\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u662f\u53ef\u9078\u7684\u3002\u5118\u7ba1\u5728\u6559\u7a0b\u4e2d\u4f7f\u7528\u4e86\u5b83\u5011\uff0c\u4f46\u60a8\u53ef\u4ee5\u6beb\u7121\u554f\u984c\u5730\u4f7f\u7528\u5176\u4ed6\u7684\u3002 \u53d6\u5f97\u6559\u7a0b\u8cc7\u6e90 \u00b6 \u5728\u958b\u59cb\u8a2d\u7f6e\u74b0\u5883\u4e4b\u524d\uff0c\u8b93\u6211\u5011 clone \u6559\u7a0b\u6e90\u78bc\u4e26\u5c07 TUTORIAL_HOME \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6559\u7a0b\u7684\u6839\u76ee\u9304\uff1a # \u6709\u8208\u8da3\u4e00\u8d77\u624b\u628a\u624b\u73a9\u73a9\u770b\u7684\u4eba\u8acb\u5148\u628a Repository Git Clone \u5230\u672c\u5730\u7aef $ git clone https://github.com/smalltown/argocd-galaxy.git argocd-galaxy $ export TUTORIAL_HOME = \" $( pwd ) /argocd-galaxy\" $ cd $TUTORIAL_HOME \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u63a5\u8457\u4f86\u5efa\u7acb\u6574\u500b\u592a\u967d\u7cfb K8s Cluster\uff01 \u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 \u5148\u5efa\u7acb K8s Cluster Sun \u4e26\u4e14\u5b89\u88dd Argo CD \u65bc\u5176\u4e2d $ k3d cluster create sun --api-port 61000 -p \"6180:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 6180 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002 \u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a # \u5b89\u88dd Argo CD $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml # \u78ba\u8a8d\u5b89\u88dd\u6210\u529f $ kubectl get crd NAME CREATED AT applications.argoproj.io 2022 -07-28T13:45:38Z applicationsets.argoproj.io 2022 -07-28T13:45:38Z appprojects.argoproj.io 2022 -07-28T13:45:38Z $ kubectl get pod -n argocd NAME READY STATUS RESTARTS AGE argocd-redis-55d64cd8bf-p6mxm 1 /1 Running 0 107s argocd-applicationset-controller-7f89dd8cc6-tl9h7 1 /1 Running 0 107s argocd-notifications-controller-54557bc8fb-868m4 1 /1 Running 0 107s argocd-application-controller-0 1 /1 Running 0 107s argocd-dex-server-56d495844c-kk7c5 1 /1 Running 0 107s argocd-server-67c697dcb7-vd9pt 1 /1 Running 0 107s argocd-repo-server-6bfcfb9698-28rrl 1 /1 Running 0 107s \u5b89\u88dd\u5b8c Argo CD \u4e4b\u5f8c\u6709\u5169\u500b\u65b9\u5f0f\u53ef\u4ee5\u5b58\u53d6\uff0c\u4e00\u500b\u662f\u900f\u904e kubectl \u4f7f\u7528 Port Forward \u7684\u65b9\u5f0f\uff0c\u518d\u4f7f\u7528 Browser \u4f86\u5b58\u53d6 Argo CD \u7684 UI\uff0c\u53e6\u5916\u4e00\u500b\u5247\u662f\u900f\u904e Argo CD CLI \u76f4\u63a5\u8ddf Argo CD \u6e9d\u901a\uff0c\u5e95\u4e0b\u5148\u793a\u7bc4 kubectl \u7684\u65b9\u5f0f\u3002 # \u5148\u53d6\u5f97 Argo CD admin \u5e33\u865f\u7684\u521d\u59cb\u5bc6\u78bc $ kubectl get -n argocd secret argocd-initial-admin-secret -o jsonpath = '{.data}' | jq .password -r | base64 -d # \u900f\u904e kubectl \u9032\u884c port forward $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' \u63a5\u8457\u6253\u958b\u700f\u89bd\u5668\u62dc\u8a2a https://localhost:8443/ \u8f38\u5165\u5e33\u865f admin \u8207\u900f\u904e\u4e0a\u9762\u547d\u4ee4\u5f97\u5230\u7684\u521d\u59cb\u5bc6\u78bc\u5c31\u53ef\u4ee5\u767b\u5165\u6210\u529f\uff0c\u770b\u5230\u4ee5\u4e0b\u756b\u9762 \u518d\u5efa\u7acb\u8981\u88ab Argo CD \u7ba1\u7406\u7684 K8s Cluster \u00b6 # \u5efa\u7acb K8s Cluster Mercury $ k3d cluster create mercury --api-port 61001 -p \"6280:80@loadbalancer\" # \u5efa\u7acb K8s Cluster Venus $ k3d cluster create venus --api-port 61002 -p \"6380:80@loadbalancer\" # \u5efa\u7acb K8s Cluster Earth $ k3d cluster create earth --api-port 61003 -p \"6480:80@loadbalancer\" \u5c07\u65b0\u5efa\u7acb\u7684 K8s Cluster \u8ddf\u524d\u9762\u5b89\u88dd\u7684 Argo CD \u505a\u8a3b\u518a \u00b6 kind : Cluster apiVersion : kind.x-k8s.io/v1alpha4 networking : apiServerAddress : \"192.168.1.123\" apiServerPort : 8443 $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ argocd login --insecure --grpc-web $argoURL --username admin --password $argoPass 'admin:login' logged in successfully Context '0.0.0.0:8443' updated # \u8a3b\u518a K8s Cluster Mercury $ kubectl config use-context k3d-mercury Switched to context \"k3d-mercury\" . $ argocd cluster add k3d-mercury --name mercury \u56db\u7a2e\u985e\u5f62\u7684\u6f14\u793a \u00b6 Cluster Generator \u00b6 \u61c9\u7528\u60c5\u5883 \uff1aHPA (Horizontal Pod Autoscaler) \u662f K8s Cluster \u88ab\u666e\u904d\u4f7f\u7528\u7684\u4e00\u500b\u529f\u80fd\uff0c\u70ba\u4e86\u8981\u652f\u63f4\u9019\u500b\u529f\u80fd\uff0c\u9700\u8981\u5728\u6240\u6709\u7684 K8s Cluster \u5b89\u88dd Metrics Server\uff0c\u53ef\u662f\u4e00\u500b\u4e00\u500b\u5b89\u88dd\u5be6\u5728\u662f\u6709\u5920\u7d2f\u4eba\u7684\uff0c\u5047\u5982\u4f7f\u7528\u4e86 Argo CD ApplicationSet Controller \u6703\u8b8a\u6210\u5982\u4f55\u5462\uff1f \u7bc4\u4f8b : metrics-server.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : metrics-server namespace : argocd spec : generators : - clusters : {} # \u4f7f\u7528 Argo CD \u5167\u6240\u6709\u7684 K8s Cluster template : metadata : name : '{{name}}-metrics-server' # name \u6703\u7f6e\u63db\u70ba Cluster \u540d\u7a31 spec : project : default syncPolicy : automated : prune : true selfHeal : true source : repoURL : https://github.com/smalltown/argocd-galaxy targetRevision : main path : infrastructure/solar-system/basic/metrcis-server destination : server : '{{server}}' # server \u6703\u7f6e\u63db\u70ba Cluster API Endpoint namespace : kube-system \u5c31\u50cf\u4e0a\u9762\u63d0\u904e\u7684\uff0cApplicationSet \u5176\u5be6\u7b97\u662f Application \u7684\u5a01\u529b\u52a0\u5f37\u7248\uff0c\u53ef\u4ee5\u767c\u73fe\u4e3b\u8981\u6709\u5169\u500b\u4e0d\u4e00\u6a23\u7684\u5730\u65b9\uff0c1) \u591a\u4e86\u4e00\u500b generators \u7684 section 2) \u5728\u4e0b\u9762 template \u4e2d\u7684\u5b9a\u7fa9\u53ef\u4ee5\u4f7f\u7528 name \u548c server \u9032\u884c\u5b57\u4e32\u7684\u7f6e\u63db\uff0c\u800c\u9019\u908a\u53ef\u4ee5\u60f3\u50cf\u6210\u5982\u4e0b\u7684\u7a0b\u5f0f\u78bc\uff1a for cluster in argocd_clusters: create_argocd_application ( cluster [ \"name\" ] , cluster [ \"server\" ]) \u6240\u4ee5 ApplicationSet Controller \u6703\u5e6b\u5fd9\u6240\u6709\u88ab Argo CD \u7ba1\u7406\u7684 K8s Cluster \u65b0\u589e Metrics Server Argo CD Application\uff0c\u7dad\u904b\u4eba\u54e1\u5c31\u4e0d\u518d\u9700\u8981\u55ae\u7368\u70ba\u6bcf\u4e00\u5ea7 Cluster \u65b0\u589e\uff1b\u9664\u4e86\u50cf\u4e0a\u9762\u7684 generator \u4f7f\u7528 {} \u4f86\u4ee3\u8868\u6240\u6709\u88ab Argo CD \u6240\u7ba1\u7406\u7684 K8s Cluster \u4e4b\u5916\uff1b\u4e5f\u53ef\u4ee5\u4f7f\u7528 Label Selector\uff0c\u8b93 Application \u53ea\u5efa\u7acb\u5728\u7279\u5b9a\u7684 K8s Cluster \u4e0a\u3002 \u57f7\u884c\u7d50\u679c : \u5c07 Metrics Server \u7684 ApplicationSet CRD \u5efa\u7acb\u4e4b\u5f8c\uff0c\u6253\u958b\u700f\u89bd\u5668\u67e5\u770b Argo CD UI \u5c31\u53ef\u4ee5\u99ac\u4e0a\u770b\u5230 Metrics Server \u4e00\u77ac\u9593\u88ab\u81ea\u52d5\u5b89\u88dd\u5728 4 \u5ea7 Cluster \u4e0a\uff0c\u4e0d\u518d\u9700\u8981\u7169\u60f1\u6709\u6c92\u6709\u54ea\u4e00\u5ea7 Cluster \u9084\u6c92\u6709\u5b89\u88dd\u5230\u3002 # \u5efa\u7acb metrics server Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/basic/metrics-server.yaml Git Directory Generator \u00b6 \u61c9\u7528\u60c5\u5883 : \u6bcf\u6b21\u8981\u5efa\u7acb\u65b0\u7684 MicroService \u6642\uff0c\u4e00\u5b9a\u9700\u8981\u5148\u5efa\u7acb NameSpace\uff0c\u7136\u5f8c\u5728\u8a72 NameSpace \u65b0\u589e\u4e00\u4e9b ConfigMap \u4ee5\u53ca Secret \u7d66\u65b0\u7684 MicroService \u4f7f\u7528\uff0c\u9019\u6b21\u63a5\u5230\u7684\u5de5\u4f5c\u662f\u8981\u5728 K8s Cluster Earth \u65b0\u589e 7 \u500b NameSpace\uff0c\u6bcf\u6b21\u90fd\u8981\u505a\u4e00\u6a23\u7684\u4e8b\u60c5\u771f\u7684\u662f\u5f88\u4e4f\u5473\u3002 \u7bc4\u4f8b : bootstrap.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : earch-bootstrap namespace : argocd spec : generators : - git : repoURL : https://github.com/smalltown/argocd-galaxy revision : main directories : - path : infrastructure/solar-system/earth/continents/* template : metadata : name : '{{path.basename}}' # \u6b64\u5b57\u4e32\u6703\u7f6e\u63db\u6210 Sub-Folder \u540d\u7a31 spec : project : default syncPolicy : automated : prune : true selfHeal : true source : repoURL : https://github.com/smalltown/argocd-galaxy targetRevision : main path : infrastructure/solar-system/basic/bootstrap destination : server : https://#{IP_ADDRESS}:61003 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP namespace : '{{path.basename}}' # \u6b64\u5b57\u4e32\u6703\u7f6e\u63db\u6210 Sub-Folder \u540d\u7a31 \u9019\u908a\u4f7f\u7528\u7684 Generator \u70ba Git Directory \uff0c\u5b9a\u7fa9\u8981\u53bb\u54ea\u4e00\u500b Git Repository \u67e5\u770b\u5176\u8cc7\u6599\u593e\u7d50\u69cb\uff0c\u4f8b\u5982\u5728\u9019\u88e1\u6703\u53bb\u67e5\u770b\u5728 Earth \u7684 Continents Folder \u5e95\u4e0b\u5b58\u5728\u7684 Sub-Folder\uff0c\u6839\u64da\u9019\u4e9b Sub-Folder \u7684\u8cc7\u6599\u593e\u540d\u7a31\u4f86\u5efa\u7acb Argo CD Application\uff0c\u50cf\u9019\u908a\u6709\u4e03\u500b Sub-Folder \u6240\u4ee5\u5c31\u6703\u5efa\u7acb\u51fa\u4e03\u500b Argo CD Application\u3002 \u57f7\u884c\u7d50\u679c : \u5efa\u7acb\u5b8c Argo CD ApplicationSet Bootstrap \u4e4b\u5f8c\uff0c\u53ef\u4ee5\u770b\u5230 Argo CD UI Console \u81ea\u52d5\u591a\u4e86 7 \u500b Application \u51fa\u4f86\uff0c\u800c\u9019 7 \u500b Application \u6703\u6839\u64da\u7576\u521d Source \u4e2d\u5b9a\u7fa9\u7684 K8s Manifest \u5c07\u5c0d\u61c9\u7684 K8s Resource\u81ea\u52d5\u5efa\u7acb\u5b8c\u6210 (\u9019\u908a\u53ea\u6709\u7c21\u55ae\u5efa\u7acb NameSpace, \u771f\u5be6\u60c5\u6cc1\u53ef\u4ee5\u6839\u64da\u9700\u6c42\u589e\u52a0\u66f4\u591a\u7684 K8s Resource)\uff1b\u6240\u4ee5\u5047\u5982\u4eca\u5929\u53c8\u591a\u4e00\u500b MicroService \u6642\uff0c\u53ea\u9700\u8981\u65b0\u589e\u4e00\u500b\u8cc7\u6599\u593e\uff0c\u4e26\u4e14\u63d0\u4ea4\u5230 Git Repository \u4e2d\uff0cArgo CD ApplicationSet Controller \u5c31\u6703\u81ea\u52d5\u591a\u65b0\u589e\u4e00\u500b Application\u3002 # \u5efa\u7acb earth bootstrap Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/earth/basic/bootstrap.yaml # \u4f7f\u7528 kubectl \u9a57\u8b49 K8s Cluster Earth $ kubectl get namespaces NAME STATUS AGE africa Active 7m17s antarctica Active 7m17s asia Active 7m17s australia Active 7m17s default Active 11m europe Active 7m17s kube-node-lease Active 11m kube-public Active 11m kube-system Active 11m local-path-storage Active 11m north-america Active 7m17s south-america Active 7m17s Git File Generator \u00b6 \u61c9\u7528\u60c5\u5883 : \u4eca\u5929\u60f3\u8981\u5c07 K8s Cluster Earth \u88ab MicroService \u4f7f\u7528\u5230\u7684 NameSpace \u90fd\u52a0\u4e0a Resource Quota\uff0c\u4f46\u662f\u6bcf\u500b NameSpace \u5e95\u4e0b\u7684\u8a2d\u5b9a\u4e0d\u592a\u4e00\u6a23\uff0c\u4f8b\u5982\u6709\u7684\u662f\u8981\u904b\u884c CPU-Bound \u61c9\u7528\u670d\u52d9\uff0c\u6709\u7684\u5247\u662f Memory-Bound \u61c9\u7528\u670d\u52d9\uff0c\u8a72\u5982\u4f55\u662f\u597d\u5462\uff1f \u7bc4\u4f8b : resourcequota.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : resource-quota namespace : argocd spec : generators : - git : repoURL : https://github.com/smalltown/argocd-galaxy revision : main files : - path : \"infrastructure/solar-system/earth/continents/**/**/config.json\" template : metadata : name : '{{destination.namespace}}-resource-quota' labels : function : resource-quota spec : project : '{{project}}' syncPolicy : automated : prune : true selfHeal : true source : repoURL : '{{source.repoURL}}' targetRevision : '{{source.targetRevision}}' path : '{{source.path}}' destination : server : https://#{IP_ADDRESS}:61003 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP namespace : '{{destination.namespace}}' \u4e0a\u9762\u4f7f\u7528\u7684 Git Directory Generator\uff0c\u662f\u5229\u7528 Sub-Folder \u7684\u540d\u7a31\u4f86\u5efa\u7acb\u5c0d\u61c9\u7684 Argo CD Application\uff0c\u9664\u6b64\u4e4b\u5916 Application CRD \u88e1\u9762\u7684\u8a2d\u5b9a\u90fd\u662f\u5dee\u4e0d\u591a\u7684\uff1b\u4f46\u9019\u908a\u4f7f\u7528\u7684 Git File Generator \u8b93\u6bcf\u500b Application Template \u88e1\u9762\u7684 Source, SyncPolicy, Project \u6216\u662f Destination \u90fd\u53ef\u4ee5\u4f7f\u7528\u8b8a\u6578\u7f6e\u63db\u3002 config.json { \"project\" : \"default\" , \"source\" : { \"repoURL\" : \"https://github.com/smalltown/argocd-galaxy\" , \"targetRevision\" : \"main\" , \"path\" : \"infrastructure/solar-system/basic/resource-quota/cpu-bound\" }, \"destination\" : { \"namespace\" : \"africa\" } } \u53ef\u4ee5\u770b\u5230 ApplicationSet Controller \u6240\u8b80\u53d6\u7684 infrastructure/solar-system/earth/continents/ / /config.json \u9019\u500b JSON \u6a94\u6848\uff0c\u5b83\u4f7f\u7528\u88e1\u9762\u5b9a\u7fa9\u7684 Key/Value \u4f86\u9032\u884c Argo CD Application Template \u7684\u5b57\u4e32\u7f6e\u63db\uff0c\u7528\u4ee5\u9054\u6210\u5728\u540c\u4e00\u500b YAML \u6a94\u6848\u88e1\u7522\u751f\u51fa\u5404\u7a2e\u4e0d\u540c\u7684 Application\u3002 \u57f7\u884c\u7d50\u679c : \u4e00\u6a23\u5148\u628a Argo CD ApplicationSet CRD \u5275\u5efa\u8d77\u4f86\uff0c\u63a5\u8457\u5c31\u53ef\u4ee5\u5728 Argo CD UI Console \u770b\u5230 K8s Cluster Earth \u88e1\u9762\u7684\u6bcf\u500b NameSpace \u90fd\u5df2\u7d93\u81ea\u52d5\u7522\u751f\u597d Resource Quota \u7684 K8s Resource\uff0c\u800c\u4e14\u662f\u6839\u64da config.json \u88e1\u9762\u5b9a\u7fa9\u7684 Key/Value \u4f86\u5ba2\u88fd\u5316\u6bcf\u500b Argo CD Application\u3002 # \u5efa\u7acb Resource Quota Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/earth/basic/resourcequota.yaml List Generator \u00b6 \u61c9\u7528\u60c5\u5883 : \u4f7f\u7528 Prometheus \u4f86\u76e3\u63a7 K8s Cluster \u662f\u518d\u6b63\u5e38\u4e0d\u904e\u7684\u4e8b\u60c5\u4e86\uff0c\u5047\u5982\u4eca\u5929\u60f3\u8981\u5728 K8s Cluster Mercury, Venus \u548c Earth \u88e1\u9762\u540c\u6642\u5b89\u88dd\u7684\u8a71\uff0c\u8a72\u5982\u4f55\u4f7f\u7528 Argo CD ApplicationSet Controller \u4f86\u9054\u6210\u5462\uff1f \u7bc4\u4f8b : prometheus.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : prometheus namespace : argocd spec : generators : - list : elements : - cluster : mercury url : https://#{IP_ADDRESS}:61001 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP - cluster : venus url : https://#{IP_ADDRESS}:61002 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP - cluster : earth url : https://#{IP_ADDRESS}:61003 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP template : metadata : name : '{{cluster}}-prometheus' spec : project : default syncPolicy : automated : prune : true selfHeal : true source : repoURL : https://github.com/smalltown/argocd-galaxy targetRevision : main path : infrastructure/solar-system/basic/prometheus destination : server : '{{url}}' namespace : kube-system \u6700\u5f8c\u4e00\u500b List Generator \u8001\u5be6\u8aaa\u8ddf Cluster Generator \u529f\u80fd\u5dee\u4e0d\u591a\uff0c\u5728\u6700\u524d\u9762 Element \u4e2d\u5b9a\u7fa9\u6240\u8981\u5b89\u88dd Cluster \u7684\u540d\u7a31\u8ddf URL\uff0c\u4e0b\u9762\u7684 Application Template \u4e2d Destination \u7684 Server \u5c31\u53ef\u4ee5\u88ab\u81ea\u52d5\u7f6e\u63db\u3002 \u57f7\u884c\u7d50\u679c : \u4e00\u6a23\u5148\u628a Argo CD ApplicationSet CRD \u5275\u5efa\u8d77\u4f86\uff0c\u63a5\u8457\u5c31\u53ef\u4ee5\u5728 Argo CD UI Console \u770b\u5230\u4e09\u5ea7 K8s Cluster Mercury, Venus \u548c Earth \u90fd\u5df2\u7d93\u5b89\u88dd\u597d Prometheus\uff0c\u4e0d\u904e\u6211\u81ea\u5df1\u6703\u6bd4\u8f03\u559c\u6b61\u5728 Cluster \u8a2d\u5b9a\u597d Label\uff0c\u7136\u5f8c\u900f\u904e Cluster Generator \u4f86\u9054\u5230\u4e00\u6a23\u7684\u6548\u679c\u3002 # \u5efa\u7acb Prometheus Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/basic/prometheus.yaml \u8072\u660e\u5f0f\u8a2d\u7f6e \u00b6 \u4e0a\u9762\u5df2\u7d93\u628a\u5404\u7a2e ApplicationSet \u7684 Generator \u529f\u80fd\u6f14\u793a\u4e86\u4e00\u6b21\uff0c\u4f46\u5047\u5982\u5927\u5bb6\u9084\u6709\u5370\u8c61\u7684\u8a71\uff0c\u61c9\u8a72\u9084\u8a18\u5f97\u5728\u4e00\u958b\u59cb\u8a2d\u5b9a\u7684\u6642\u5019\uff0c\u6709\u4e9b\u6b65\u9a5f\u662f\u4f7f\u7528 CLI \u5728 Terminal \u5b8c\u6210\u7684\uff0c\u9019\u6709\u9ede\u9055\u53cd DevOps Everything as Code \u7684\u7cbe\u795e\uff0c\u6240\u4ee5\u5728\u9019\u500b Section \u6703\u4f86\u88dc\u5f37\u9019\u500b\u90e8\u4efd\u3002 \u96de\u548c\u86cb\u7684\u96e3\u984c \u00b6 \u53c3\u8003: The Chicken/Egg Conundrum: How Modern Stories are Best Told \u6211\u5011\u4e00\u958b\u59cb\u5728\u5b89\u88dd Argo CD \u548c Argo CD ApplicationSet Controller \u6642\uff0c\u662f\u76f4\u63a5\u4f7f\u7528 Helm CLI\uff0c\u6240\u4ee5\u6211\u5011\u5728\u9019\u908a\u628a Argo CD \u7684 Argo CD ApplicationSet \u7d66\u88dc\u4e0a (\u597d\u9952\u53e3)\uff0c\u9019\u6a23\u4e00\u4f86\u5c31\u9023\u8ca0\u8cac Configuration Management \u89d2\u8272\u7684 Argo CD \u672c\u8eab\u4e5f\u5c07\u81ea\u5df1\u7d0d\u5165\u7ba1\u7406\u3002 # \u5efa\u7acb Argo CD \u7684 Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/sun/argo.yaml \u6211\u5011\u4e00\u958b\u59cb\u5728\u5b89\u88dd Argo CD \u548c Argo CD ApplicationSet Controller \u6642\uff0c\u662f\u76f4\u63a5\u4f7f\u7528 Helm CLI\uff0c\u6240\u4ee5\u6211\u5011\u5728\u9019\u908a\u628a Argo CD \u7684 Argo CD ApplicationSet \u7d66\u88dc\u4e0a\uff0c\u9019\u6a23\u4e00\u4f86\u5c31\u9023\u8ca0\u8cac Configuration Management \u89d2\u8272\u7684 Argo CD \u672c\u8eab\u4e5f\u5c07\u81ea\u5df1\u7d0d\u5165\u7ba1\u7406\u3002 # \u5efa\u7acb Argo CD \u7684 Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/sun/argo.yaml \u8a3b\u518a\u8981\u63a7\u5236\u7684 K8S \u96c6\u7fa4 \u00b6 \u5728\u8a3b\u518a Argo CD Cluster \u6642\u662f\u4f7f\u7528 Argo CD CLI \u9054\u6210\uff0c\u4f46\u5176\u5be6\u4ed6\u4e5f\u53ea\u662f\u5728 K8s Cluster Sun \u7684 NameSpace \u88e1\u9762\u65b0\u589e\u4e00\u500b K8s Secret \u800c\u5df2\uff0c\u5927\u6982\u9577\u5f97\u50cf\u5e95\u4e0b\u9019\u6a23\u5b50\uff0cArgo CD \u4e3b\u8981\u900f\u904e Label argocd.argoproj.io/secret-type: cluster \u4f86\u5f97\u77e5\u9019\u662f\u4e00\u500b Cluster \u7684\u9023\u7dda\u8cc7\u8a0a\uff0c\u50cf\u6211\u81ea\u5df1\u662f\u900f\u904e Terraform \u5728\u5efa\u7acb\u597d K8s Cluster \u7684\u6642\u5019\u9806\u4fbf\u628a\u9019\u500b K8s Secret \u7522\u751f\u5728\u6709\u5b89\u88dd Argo CD \u7684 Primary K8s Cluster \u4e2d\uff0c\u9019\u6a23\u4e00\u4f86\u5c31\u53ef\u4ee5\u78ba\u5b9a\u9019\u4e00\u500b\u52d5\u4f5c\u662f Declarative\u3002 apiVersion : v1 kind : Secret metadata : name : mycluster-secret labels : argocd.argoproj.io/secret-type : cluster type : Opaque stringData : name : mycluster.com server : https://mycluster.com config : | ... \u9084\u6709\u5176\u4ed6\u66f4\u591a Argo CD \u8a2d\u5b9a\u90fd\u53ef\u4ee5\u4f7f\u7528 YAML \u6a94\u6848\u4f86\u64b0\u5beb\u8ddf\u5b9a\u7fa9\uff0c\u6709\u8208\u8da3\u7684\u4eba\u53ef\u4ee5\u53c3\u8003\u5b98\u65b9\u9019\u4efd Declarative Setup \u6587\u4ef6 \u3002 \u5b58\u5132\u5eab\u6587\u4ef6\u593e\u7d50\u69cb \u00b6 Folder Structure \u6c92\u6709\u5206\u597d\u58de\uff0c\u53ea\u8981\u9069\u5408\u81ea\u5df1\u7684\u958b\u767c\u5718\u968a\u5373\u53ef\uff0c\u9019\u908a\u628a\u7bc4\u4f8b\u4f7f\u7528\u5230\u7684\u8cc7\u6599\u593e\u7d50\u69cb\u7a0d\u5fae\u89e3\u91cb\u4e00\u4e0b\uff0c\u6211\u5c07 Argo CD CRD (Application & ApplicationSet) \u8207 K8s Manifest \u5206\u5225\u7f6e\u65bc\u4e0d\u540c\u7684\u8cc7\u6599\u593e\u5167\uff0c\u7136\u5f8c\u518d\u900f\u904e\u884c\u661f\u7cfb\u7d71\u4f86\u505a\u5206\u7fa4 \uff0c\u6240\u4ee5\u592a\u967d\u7cfb\u4e00\u7fa4\uff0c\u514b\u535c\u52d290 \u4e5f\u81ea\u6210\u4e00\u7fa4\uff0c\u88e1\u9762\u5c31\u662f\u4ed6\u5011\u7684\u884c\u661f\uff1b\u5c0d\u61c9\u5230\u73fe\u5be6\u5834\u666f\u5c31\u662f Production \u74b0\u5883\u4e00\u7fa4\uff0cNon-Production \u74b0\u5883\u4e00\u7fa4\uff0c\u6bcf\u4e00\u7fa4\u88e1\u9762\u90fd\u6703\u6709\u4e00\u5ea7 Primary K8s Cluster (\u5b89\u88dd\u6709 Argo CD \u90a3\u5ea7)\uff0c\u518d\u5f80\u4e0b\u4e00\u5c64\u5c31\u662f\u5404\u81ea\u6240\u7ba1\u7406\u7684 Alpha- , Beta- , Prod-* \u7b49 K8s Cluster\uff0c\u4e26\u4e14\u6703\u5e0c\u671b\u4e0d\u8981\u5c07 Helm Chart \u64fa\u5230\u9019\u500b Repository \u88e1\u4f86\uff0c\u800c\u662f\u53bb\u53c3\u7167\u5728\u5916\u90e8\u7684 Helm Repository\uff0c\u7528\u4ee5\u907f\u514d\u5718\u968a\u4e00\u8d77\u958b\u767c\u6642\u7684\u6df7\u4e82\u5c40\u9762\u3002 argocd-galaxy \u251c\u2500\u2500 applications \u2502 \u251c\u2500\u2500 kepler-90 \u2502 \u251c\u2500\u2500 ... \u2502 \u2514\u2500\u2500 solar-system \u2502 \u251c\u2500\u2500 basic \u2502 \u251c\u2500\u2500 earth \u2502 \u251c\u2500\u2500 ... \u2502 \u2514\u2500\u2500 sun \u2514\u2500\u2500 infrastructure \u251c\u2500\u2500 kepler-90 \u251c\u2500\u2500 ... \u2514\u2500\u2500 solar-system \u251c\u2500\u2500 basic \u251c\u2500\u2500 earth \u251c\u2500\u2500 mercury \u251c\u2500\u2500 sun \u2502 ... \u2514\u2500\u2500 venus \u2514\u2500\u2500 solar-system \u251c\u2500\u2500 basic \u251c\u2500\u2500 earth \u251c\u2500\u2500 mercury \u251c\u2500\u2500 sun \u2514\u2500\u2500 venus \u7d50\u8ad6 \u00b6 \u76ee\u524d Argo CD ApplicationSet Controller \u9084\u5728\u5f88\u65e9\u671f\u7684\u968e\u6bb5\uff0c\u4f8b\u5982 Git File Generator \u53ea\u80fd\u8b80\u53d6 JSON \u683c\u5f0f\u6a94\u6848\uff0cDestination \u7684 Server \u503c\u7121\u6cd5\u50cf Application CRD \u5167\u4e00\u6a23\u76f4\u63a5\u4f7f\u7528 Cluster \u540d\u7a31\uff0c\u4e5f\u9084\u6c92\u6709 If/Else \u7684\u529f\u80fd \uff1b\u4e0d\u904e\u5149\u662f\u76ee\u524d\u7684 Generator a.k.a. For Loop \u5c31\u53ef\u4ee5\u5e6b\u52a9\u7dad\u904b\u4eba\u54e1\u7701\u4e0b\u5f88\u591a\u5bf6\u8cb4\u7684\u6642\u9593\u3002 \u53c3\u8003 \u00b6 https://www.openshift.com/blog/getting-started-with-applicationsets https://argoproj.github.io/argo-cd/operator-manual/declarative-setup/ https://argoproj.github.io/argo-cd/user-guide/application-set/ https://github.com/argoproj/argo-cd/issues/1481","title":"ApplicationSet \u63a7\u5236\u5668"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#argo-cd-applicationset-controller","text":"\u539f\u6587: https://medium.com/starbugs/argo-cd-applicationset-controller-%E4%B8%96%E7%95%8C%E7%82%BA%E6%88%91%E8%80%8C%E8%BD%89%E5%8B%95-a837f9392298 Argo CD \u5728 Multi-Cluster \u7684\u7ba1\u7406\u6a21\u5f0f\uff0c\u5fc5\u9808\u5148\u5728 Primary Cluster \u5b89\u88dd Argo CD\uff0c\u7136\u5f8c\u518d\u900f\u904e\u9019\u500b Primary Cluster \u53bb\u7ba1\u7406\u5176\u4ed6\u7684 Cluster\uff0c\u5c6c\u65bc Primary \u8207 Secondary \u7684\u67b6\u69cb\uff0c\u56e0\u6b64\u5fc5\u9808\u8981\u8b93 Primary Cluster \u6709\u6b0a\u9650\u53bb\u5b58\u53d6 Secondary Cluster, \u5f7c\u6b64\u4e4b\u9593\u7684\u7db2\u8def\u7576\u7136\u5c31\u8981\u6253\u901a\u3002 Argo CD \u4e2d\u6709\u4e00\u500b\u7528\u4f86 Bootstrap Cluster \u7684 App of Apps Pattern \u7121\u6cd5\u5728 Primary & Secondary \u7684\u67b6\u69cb\u4e0b\u8f15\u6613\u5730\u4f7f\u7528\uff0c\u56e0\u70ba\u5176\u4e2d\u6703\u7528\u5230 Argo CD \u5167\u624d\u6709\u7684 Application CRD\uff0c\u53ef\u662f Secondary Cluster \u4e26\u6c92\u6709\u5b89\u88dd Argo CD\uff0c\u9019\u6a23\u4e00\u4f86\u88ab\u7ba1\u7406\u7684 Secondary Cluster \u4e5f\u60f3\u8981\u4e00\u6b21\u5b89\u88dd\u597d\u6240\u6709\u5957\u4ef6\u8981\u5982\u4f55\u9054\u6210\u5462\uff1f\uff01Argo CD V2.0 \u767c\u5e03\u7684\u6642\u5019\uff0c\u63a8\u51fa\u4e86\u53ef\u4ee5\u8ddf Argo CD \u4e00\u8d77\u642d\u914d\u4f7f\u7528\u7684 ApplicationSet Controller \u4f86\u5f4c\u88dc\u4e4b\u524d\u529f\u80fd\u7684\u4e0d\u8db3\uff0c\u800c\u6b64\u7bc7\u6587\u7ae0\u4e3b\u8981\u5c31\u662f\u4f86\u8aaa\u660e Argo CD ApplicationSet Controller\u3002","title":"Argo CD ApplicationSet Controller"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#applicationset","text":"apiVersion : argoproj.io/v1alpha1 kind : Application metadata : name : prometheus finalizers : - resources-finalizer.argocd.argoproj.io spec : destination : server : https://kubernetes.default.svc namespace : default project : default source : path : infrastructure/solar-system/sun/prometheus repoURL : https://github.com/smalltown/argo-galaxy.git targetRevision : HEAD syncPolicy : automated : prune : true selfHeal : true \u5728 Argo CD \u4e2d\u6700\u57fa\u672c\u7684\u5143\u7d20\u5c31\u662f Application CRD\uff0c\u5b83\u5b9a\u7fa9\u8981\u5982\u4f55\u5b89\u88dd\u4e00\u500b\u61c9\u7528\u5728 K8s Cluster \u4e2d\uff0c\u4ee5\u4e0a\u9762\u7684 YAML \u6a94\u6848\u7576\u4f5c\u4f8b\u5b50\uff0c\u4ed6\u662f\u4e00\u500b\u53eb\u505a Prometheus \u7684 Application CRD\u3002 Destination \u5b9a\u7fa9\u8981\u5b89\u88dd Prometheus \u5230\u54ea\u4e00\u5ea7 K8s Cluster \u4e2d\u7684\u7684\u54ea\u4e00\u500b Namespace Source \u5247\u662f\u6307\u5b89\u88dd Prometheus \u7684 Kubernetes Manifest \u5b58\u653e\u65bc\u4f55\u8655 SyncPolicy \u5247\u662f Agro CD \u7528\u4f86\u76e3\u63a7 Prometheus \u5728 K8s Cluster \u4e2d\u7684\u771f\u5be6\u72c0\u614b\u548c Source \u4e2d\u5b9a\u7fa9\u7684\u662f\u5426\u76f8\u540c\uff0c\u4e0d\u540c\u7684\u8a71\u5c31\u53ef\u4ee5\u5e6b\u5fd9\u9032\u884c\u540c\u6b65\u6642\u7684\u898f\u5247 Argo CD ApplicationSet Controller \u53ef\u4ee5\u8aaa\u662f Application CRD \u7684\u5a01\u529b\u52a0\u5f37\u7248\uff0c\u5b83\u8b93\u4f7f\u7528\u8005\u53ef\u4ee5\u5728\u55ae\u500b YAML \u6a94\u6848\u5167\u50cf\u662f\u5beb\u7a0b\u5f0f\u4f7f\u7528 For Loop \u4e00\u6a23\uff0c\u96a8\u4f7f\u7528\u8005\u7684\u9700\u6c42\u4e00\u6b21\u6027\u5730\u5efa\u7acb\u5927\u91cf\u7684 Application CRD\uff0c\u800c\u9019\u500b For Loop \u7684\u529f\u80fd\u53eb\u505a Generator\uff0c\u76ee\u524d\u63a8\u51fa\u7684\u7248\u672c\u4e2d\u5171\u6709\u56db\u7a2e Generator: Cluster Generator, Git Directory Generator, Git File Generator, List Generator\uff0c\u5e95\u4e0b\u6703\u4f7f\u7528\u5be6\u969b\u7bc4\u4f8b\u4f86\u6f14\u793a\u9019\u56db\u7a2e Generator \u5982\u4f55\u89e3\u653e Kubernetes \u7dad\u904b\u4eba\u54e1\u7684\u96d9\u624b\u8207\u6642\u9593\u3002","title":"ApplicationSet \u63a7\u5236\u5668"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_1","text":"\u70ba\u4e86\u589e\u52a0\u4e00\u9ede\u8da3\u5473\u6027\uff0c\u6240\u4ee5\u6c92\u6709\u4f7f\u7528 Alpha, Beta \u548c Production \u7684\u5b57\u773c\uff0c\u9019\u908a\u4ee5\u5927\u5bb6\u5c45\u4f4f\u7684\u592a\u967d\u7cfb\u4f86\u7576\u547d\u540d\u898f\u5247\uff0c\u592a\u967d (Sun) \u5c31\u662f\u5b89\u88dd\u6709 Argo CD \u7684 Primary K8s Cluster, \u800c\u5176\u4ed6\u7684\u884c\u661f\u5c31\u662f\u88ab Argo CD \u6240\u7ba1\u7406\u7684 Secondary K8s Cluster\uff0c\u5730\u7403\u4e0a\u7684\u4e03\u5927\u6d32\u5c31\u985e\u6bd4\u70ba K8s Namespace\uff0c\u5927\u5bb6\u4e00\u8d77\u4f86\u7576\u5275\u4e16\u795e\uff01 \u6839\u64da\u5e95\u4e0b\u7684\u6b65\u9a5f\u5c07\u6703\u5728\u672c\u5730\u7aef\u5275\u5efa 4 \u5ea7 K8s Cluster (Sun, Mercury, Venus \u548c Earth)\uff0c\u4e26\u4e14\u5c07 Argo CD \u548c Argo CD ApplicationSet Controller \u5b89\u88dd\u5728 K8s Cluster Sun, \u7136\u5f8c\u628a\u53e6\u5916\u4e09\u5ea7 K8s Cluster Mercury, Venus \u548c Earth \u8a3b\u518a\u5230 Argo CD \u4e2d\u88ab\u7d0d\u7ba1\u3002","title":"\u74b0\u5883\u6e96\u5099"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#cli","text":"\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u9700\u8981\u4ee5\u4e0b CLI \u5de5\u5177\u3002\u5728\u958b\u59cb\u5b78\u7fd2\u4efb\u4f55\u6559\u7a0b\u7ae0\u7bc0\u4e4b\u524d\uff0c\u8acb\u5148\u5b89\u88dd\u548c\u914d\u7f6e\u5b83\u5011\u3002 Tool Linux Git Download Docker Download K3D v5.4.4 Download kubectl v1.20.2 Download argocd v2.0.0 Download kustomize v4.1.2 Download \u4ee5\u4e0b CLI \u5de5\u5177\u5c0d\u65bc\u904b\u884c\u672c\u6559\u7a0b\u4e2d\u7684\u7df4\u7fd2\u662f\u53ef\u9078\u7684\u3002\u5118\u7ba1\u5728\u6559\u7a0b\u4e2d\u4f7f\u7528\u4e86\u5b83\u5011\uff0c\u4f46\u60a8\u53ef\u4ee5\u6beb\u7121\u554f\u984c\u5730\u4f7f\u7528\u5176\u4ed6\u7684\u3002","title":"\u76f8\u95dc\u9700\u8981\u7684 CLI \u5de5\u5177"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_2","text":"\u5728\u958b\u59cb\u8a2d\u7f6e\u74b0\u5883\u4e4b\u524d\uff0c\u8b93\u6211\u5011 clone \u6559\u7a0b\u6e90\u78bc\u4e26\u5c07 TUTORIAL_HOME \u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6559\u7a0b\u7684\u6839\u76ee\u9304\uff1a # \u6709\u8208\u8da3\u4e00\u8d77\u624b\u628a\u624b\u73a9\u73a9\u770b\u7684\u4eba\u8acb\u5148\u628a Repository Git Clone \u5230\u672c\u5730\u7aef $ git clone https://github.com/smalltown/argocd-galaxy.git argocd-galaxy $ export TUTORIAL_HOME = \" $( pwd ) /argocd-galaxy\" $ cd $TUTORIAL_HOME","title":"\u53d6\u5f97\u6559\u7a0b\u8cc7\u6e90"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#kubernetes","text":"\u63a5\u8457\u4f86\u5efa\u7acb\u6574\u500b\u592a\u967d\u7cfb K8s Cluster\uff01 \u5728\u6b64\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u90e8\u7f72 argocd \u4e26\u4f7f\u5176\u53ef\u901a\u904e ingress \u4f86\u8a2a\u554f\u3002\u56e0\u6b64\uff0c\u6211\u5011\u5fc5\u9808\u4ee5\u67d0\u7a2e\u65b9\u5f0f\u5275\u5efa Kubernetes \u96c6\u7fa4\uff0c\u4f7f\u5167\u90e8\u7aef\u53e3 80\uff08traefik ingress controller \u6b63\u5728\u76e3\u807d\u7684\u5730\u65b9\uff09\u66b4\u9732\u5728\u4e3b\u6a5f\u7cfb\u7d71\u4e0a\u3002 \u5148\u5efa\u7acb K8s Cluster Sun \u4e26\u4e14\u5b89\u88dd Argo CD \u65bc\u5176\u4e2d $ k3d cluster create sun --api-port 61000 -p \"6180:80@loadbalancer\" Info -p \"8081:80@loadbalancer\" \u610f\u5473\u8457\uff1a \u201c\u5c07\u4e3b\u6a5f\u7684 6180 \u7aef\u53e3\u6620\u5c04\u81f3 loadbalancer \u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3 \u63a5\u8457\u8b93\u6211\u5011\u5728 Kubernetes \u4e0a\u5b89\u88dd ArgoCD\u3002 \u5b89\u88dd ArgoCD \u4e26\u6aa2\u67e5 argocd \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6bcf\u500b pod \u662f\u5426\u6b63\u5e38\u904b\u884c\uff1a # \u5b89\u88dd Argo CD $ kubectl create namespace argocd $ kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml # \u78ba\u8a8d\u5b89\u88dd\u6210\u529f $ kubectl get crd NAME CREATED AT applications.argoproj.io 2022 -07-28T13:45:38Z applicationsets.argoproj.io 2022 -07-28T13:45:38Z appprojects.argoproj.io 2022 -07-28T13:45:38Z $ kubectl get pod -n argocd NAME READY STATUS RESTARTS AGE argocd-redis-55d64cd8bf-p6mxm 1 /1 Running 0 107s argocd-applicationset-controller-7f89dd8cc6-tl9h7 1 /1 Running 0 107s argocd-notifications-controller-54557bc8fb-868m4 1 /1 Running 0 107s argocd-application-controller-0 1 /1 Running 0 107s argocd-dex-server-56d495844c-kk7c5 1 /1 Running 0 107s argocd-server-67c697dcb7-vd9pt 1 /1 Running 0 107s argocd-repo-server-6bfcfb9698-28rrl 1 /1 Running 0 107s \u5b89\u88dd\u5b8c Argo CD \u4e4b\u5f8c\u6709\u5169\u500b\u65b9\u5f0f\u53ef\u4ee5\u5b58\u53d6\uff0c\u4e00\u500b\u662f\u900f\u904e kubectl \u4f7f\u7528 Port Forward \u7684\u65b9\u5f0f\uff0c\u518d\u4f7f\u7528 Browser \u4f86\u5b58\u53d6 Argo CD \u7684 UI\uff0c\u53e6\u5916\u4e00\u500b\u5247\u662f\u900f\u904e Argo CD CLI \u76f4\u63a5\u8ddf Argo CD \u6e9d\u901a\uff0c\u5e95\u4e0b\u5148\u793a\u7bc4 kubectl \u7684\u65b9\u5f0f\u3002 # \u5148\u53d6\u5f97 Argo CD admin \u5e33\u865f\u7684\u521d\u59cb\u5bc6\u78bc $ kubectl get -n argocd secret argocd-initial-admin-secret -o jsonpath = '{.data}' | jq .password -r | base64 -d # \u900f\u904e kubectl \u9032\u884c port forward $ kubectl port-forward svc/argocd-server -n argocd 8443 :443 --address = '0.0.0.0' \u63a5\u8457\u6253\u958b\u700f\u89bd\u5668\u62dc\u8a2a https://localhost:8443/ \u8f38\u5165\u5e33\u865f admin \u8207\u900f\u904e\u4e0a\u9762\u547d\u4ee4\u5f97\u5230\u7684\u521d\u59cb\u5bc6\u78bc\u5c31\u53ef\u4ee5\u767b\u5165\u6210\u529f\uff0c\u770b\u5230\u4ee5\u4e0b\u756b\u9762","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#argo-cd-k8s-cluster","text":"# \u5efa\u7acb K8s Cluster Mercury $ k3d cluster create mercury --api-port 61001 -p \"6280:80@loadbalancer\" # \u5efa\u7acb K8s Cluster Venus $ k3d cluster create venus --api-port 61002 -p \"6380:80@loadbalancer\" # \u5efa\u7acb K8s Cluster Earth $ k3d cluster create earth --api-port 61003 -p \"6480:80@loadbalancer\"","title":"\u518d\u5efa\u7acb\u8981\u88ab Argo CD \u7ba1\u7406\u7684 K8s Cluster"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#k8s-cluster-argo-cd","text":"kind : Cluster apiVersion : kind.x-k8s.io/v1alpha4 networking : apiServerAddress : \"192.168.1.123\" apiServerPort : 8443 $ argoPass = $( kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath = \"{.data.password}\" | base64 -d ) # base port-forward setting $ argoURL = 0 .0.0.0:8443 $ argocd login --insecure --grpc-web $argoURL --username admin --password $argoPass 'admin:login' logged in successfully Context '0.0.0.0:8443' updated # \u8a3b\u518a K8s Cluster Mercury $ kubectl config use-context k3d-mercury Switched to context \"k3d-mercury\" . $ argocd cluster add k3d-mercury --name mercury","title":"\u5c07\u65b0\u5efa\u7acb\u7684 K8s Cluster \u8ddf\u524d\u9762\u5b89\u88dd\u7684 Argo CD \u505a\u8a3b\u518a"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_3","text":"","title":"\u56db\u7a2e\u985e\u5f62\u7684\u6f14\u793a"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#cluster-generator","text":"\u61c9\u7528\u60c5\u5883 \uff1aHPA (Horizontal Pod Autoscaler) \u662f K8s Cluster \u88ab\u666e\u904d\u4f7f\u7528\u7684\u4e00\u500b\u529f\u80fd\uff0c\u70ba\u4e86\u8981\u652f\u63f4\u9019\u500b\u529f\u80fd\uff0c\u9700\u8981\u5728\u6240\u6709\u7684 K8s Cluster \u5b89\u88dd Metrics Server\uff0c\u53ef\u662f\u4e00\u500b\u4e00\u500b\u5b89\u88dd\u5be6\u5728\u662f\u6709\u5920\u7d2f\u4eba\u7684\uff0c\u5047\u5982\u4f7f\u7528\u4e86 Argo CD ApplicationSet Controller \u6703\u8b8a\u6210\u5982\u4f55\u5462\uff1f \u7bc4\u4f8b : metrics-server.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : metrics-server namespace : argocd spec : generators : - clusters : {} # \u4f7f\u7528 Argo CD \u5167\u6240\u6709\u7684 K8s Cluster template : metadata : name : '{{name}}-metrics-server' # name \u6703\u7f6e\u63db\u70ba Cluster \u540d\u7a31 spec : project : default syncPolicy : automated : prune : true selfHeal : true source : repoURL : https://github.com/smalltown/argocd-galaxy targetRevision : main path : infrastructure/solar-system/basic/metrcis-server destination : server : '{{server}}' # server \u6703\u7f6e\u63db\u70ba Cluster API Endpoint namespace : kube-system \u5c31\u50cf\u4e0a\u9762\u63d0\u904e\u7684\uff0cApplicationSet \u5176\u5be6\u7b97\u662f Application \u7684\u5a01\u529b\u52a0\u5f37\u7248\uff0c\u53ef\u4ee5\u767c\u73fe\u4e3b\u8981\u6709\u5169\u500b\u4e0d\u4e00\u6a23\u7684\u5730\u65b9\uff0c1) \u591a\u4e86\u4e00\u500b generators \u7684 section 2) \u5728\u4e0b\u9762 template \u4e2d\u7684\u5b9a\u7fa9\u53ef\u4ee5\u4f7f\u7528 name \u548c server \u9032\u884c\u5b57\u4e32\u7684\u7f6e\u63db\uff0c\u800c\u9019\u908a\u53ef\u4ee5\u60f3\u50cf\u6210\u5982\u4e0b\u7684\u7a0b\u5f0f\u78bc\uff1a for cluster in argocd_clusters: create_argocd_application ( cluster [ \"name\" ] , cluster [ \"server\" ]) \u6240\u4ee5 ApplicationSet Controller \u6703\u5e6b\u5fd9\u6240\u6709\u88ab Argo CD \u7ba1\u7406\u7684 K8s Cluster \u65b0\u589e Metrics Server Argo CD Application\uff0c\u7dad\u904b\u4eba\u54e1\u5c31\u4e0d\u518d\u9700\u8981\u55ae\u7368\u70ba\u6bcf\u4e00\u5ea7 Cluster \u65b0\u589e\uff1b\u9664\u4e86\u50cf\u4e0a\u9762\u7684 generator \u4f7f\u7528 {} \u4f86\u4ee3\u8868\u6240\u6709\u88ab Argo CD \u6240\u7ba1\u7406\u7684 K8s Cluster \u4e4b\u5916\uff1b\u4e5f\u53ef\u4ee5\u4f7f\u7528 Label Selector\uff0c\u8b93 Application \u53ea\u5efa\u7acb\u5728\u7279\u5b9a\u7684 K8s Cluster \u4e0a\u3002 \u57f7\u884c\u7d50\u679c : \u5c07 Metrics Server \u7684 ApplicationSet CRD \u5efa\u7acb\u4e4b\u5f8c\uff0c\u6253\u958b\u700f\u89bd\u5668\u67e5\u770b Argo CD UI \u5c31\u53ef\u4ee5\u99ac\u4e0a\u770b\u5230 Metrics Server \u4e00\u77ac\u9593\u88ab\u81ea\u52d5\u5b89\u88dd\u5728 4 \u5ea7 Cluster \u4e0a\uff0c\u4e0d\u518d\u9700\u8981\u7169\u60f1\u6709\u6c92\u6709\u54ea\u4e00\u5ea7 Cluster \u9084\u6c92\u6709\u5b89\u88dd\u5230\u3002 # \u5efa\u7acb metrics server Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/basic/metrics-server.yaml","title":"Cluster Generator"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#git-directory-generator","text":"\u61c9\u7528\u60c5\u5883 : \u6bcf\u6b21\u8981\u5efa\u7acb\u65b0\u7684 MicroService \u6642\uff0c\u4e00\u5b9a\u9700\u8981\u5148\u5efa\u7acb NameSpace\uff0c\u7136\u5f8c\u5728\u8a72 NameSpace \u65b0\u589e\u4e00\u4e9b ConfigMap \u4ee5\u53ca Secret \u7d66\u65b0\u7684 MicroService \u4f7f\u7528\uff0c\u9019\u6b21\u63a5\u5230\u7684\u5de5\u4f5c\u662f\u8981\u5728 K8s Cluster Earth \u65b0\u589e 7 \u500b NameSpace\uff0c\u6bcf\u6b21\u90fd\u8981\u505a\u4e00\u6a23\u7684\u4e8b\u60c5\u771f\u7684\u662f\u5f88\u4e4f\u5473\u3002 \u7bc4\u4f8b : bootstrap.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : earch-bootstrap namespace : argocd spec : generators : - git : repoURL : https://github.com/smalltown/argocd-galaxy revision : main directories : - path : infrastructure/solar-system/earth/continents/* template : metadata : name : '{{path.basename}}' # \u6b64\u5b57\u4e32\u6703\u7f6e\u63db\u6210 Sub-Folder \u540d\u7a31 spec : project : default syncPolicy : automated : prune : true selfHeal : true source : repoURL : https://github.com/smalltown/argocd-galaxy targetRevision : main path : infrastructure/solar-system/basic/bootstrap destination : server : https://#{IP_ADDRESS}:61003 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP namespace : '{{path.basename}}' # \u6b64\u5b57\u4e32\u6703\u7f6e\u63db\u6210 Sub-Folder \u540d\u7a31 \u9019\u908a\u4f7f\u7528\u7684 Generator \u70ba Git Directory \uff0c\u5b9a\u7fa9\u8981\u53bb\u54ea\u4e00\u500b Git Repository \u67e5\u770b\u5176\u8cc7\u6599\u593e\u7d50\u69cb\uff0c\u4f8b\u5982\u5728\u9019\u88e1\u6703\u53bb\u67e5\u770b\u5728 Earth \u7684 Continents Folder \u5e95\u4e0b\u5b58\u5728\u7684 Sub-Folder\uff0c\u6839\u64da\u9019\u4e9b Sub-Folder \u7684\u8cc7\u6599\u593e\u540d\u7a31\u4f86\u5efa\u7acb Argo CD Application\uff0c\u50cf\u9019\u908a\u6709\u4e03\u500b Sub-Folder \u6240\u4ee5\u5c31\u6703\u5efa\u7acb\u51fa\u4e03\u500b Argo CD Application\u3002 \u57f7\u884c\u7d50\u679c : \u5efa\u7acb\u5b8c Argo CD ApplicationSet Bootstrap \u4e4b\u5f8c\uff0c\u53ef\u4ee5\u770b\u5230 Argo CD UI Console \u81ea\u52d5\u591a\u4e86 7 \u500b Application \u51fa\u4f86\uff0c\u800c\u9019 7 \u500b Application \u6703\u6839\u64da\u7576\u521d Source \u4e2d\u5b9a\u7fa9\u7684 K8s Manifest \u5c07\u5c0d\u61c9\u7684 K8s Resource\u81ea\u52d5\u5efa\u7acb\u5b8c\u6210 (\u9019\u908a\u53ea\u6709\u7c21\u55ae\u5efa\u7acb NameSpace, \u771f\u5be6\u60c5\u6cc1\u53ef\u4ee5\u6839\u64da\u9700\u6c42\u589e\u52a0\u66f4\u591a\u7684 K8s Resource)\uff1b\u6240\u4ee5\u5047\u5982\u4eca\u5929\u53c8\u591a\u4e00\u500b MicroService \u6642\uff0c\u53ea\u9700\u8981\u65b0\u589e\u4e00\u500b\u8cc7\u6599\u593e\uff0c\u4e26\u4e14\u63d0\u4ea4\u5230 Git Repository \u4e2d\uff0cArgo CD ApplicationSet Controller \u5c31\u6703\u81ea\u52d5\u591a\u65b0\u589e\u4e00\u500b Application\u3002 # \u5efa\u7acb earth bootstrap Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/earth/basic/bootstrap.yaml # \u4f7f\u7528 kubectl \u9a57\u8b49 K8s Cluster Earth $ kubectl get namespaces NAME STATUS AGE africa Active 7m17s antarctica Active 7m17s asia Active 7m17s australia Active 7m17s default Active 11m europe Active 7m17s kube-node-lease Active 11m kube-public Active 11m kube-system Active 11m local-path-storage Active 11m north-america Active 7m17s south-america Active 7m17s","title":"Git Directory Generator"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#git-file-generator","text":"\u61c9\u7528\u60c5\u5883 : \u4eca\u5929\u60f3\u8981\u5c07 K8s Cluster Earth \u88ab MicroService \u4f7f\u7528\u5230\u7684 NameSpace \u90fd\u52a0\u4e0a Resource Quota\uff0c\u4f46\u662f\u6bcf\u500b NameSpace \u5e95\u4e0b\u7684\u8a2d\u5b9a\u4e0d\u592a\u4e00\u6a23\uff0c\u4f8b\u5982\u6709\u7684\u662f\u8981\u904b\u884c CPU-Bound \u61c9\u7528\u670d\u52d9\uff0c\u6709\u7684\u5247\u662f Memory-Bound \u61c9\u7528\u670d\u52d9\uff0c\u8a72\u5982\u4f55\u662f\u597d\u5462\uff1f \u7bc4\u4f8b : resourcequota.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : resource-quota namespace : argocd spec : generators : - git : repoURL : https://github.com/smalltown/argocd-galaxy revision : main files : - path : \"infrastructure/solar-system/earth/continents/**/**/config.json\" template : metadata : name : '{{destination.namespace}}-resource-quota' labels : function : resource-quota spec : project : '{{project}}' syncPolicy : automated : prune : true selfHeal : true source : repoURL : '{{source.repoURL}}' targetRevision : '{{source.targetRevision}}' path : '{{source.path}}' destination : server : https://#{IP_ADDRESS}:61003 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP namespace : '{{destination.namespace}}' \u4e0a\u9762\u4f7f\u7528\u7684 Git Directory Generator\uff0c\u662f\u5229\u7528 Sub-Folder \u7684\u540d\u7a31\u4f86\u5efa\u7acb\u5c0d\u61c9\u7684 Argo CD Application\uff0c\u9664\u6b64\u4e4b\u5916 Application CRD \u88e1\u9762\u7684\u8a2d\u5b9a\u90fd\u662f\u5dee\u4e0d\u591a\u7684\uff1b\u4f46\u9019\u908a\u4f7f\u7528\u7684 Git File Generator \u8b93\u6bcf\u500b Application Template \u88e1\u9762\u7684 Source, SyncPolicy, Project \u6216\u662f Destination \u90fd\u53ef\u4ee5\u4f7f\u7528\u8b8a\u6578\u7f6e\u63db\u3002 config.json { \"project\" : \"default\" , \"source\" : { \"repoURL\" : \"https://github.com/smalltown/argocd-galaxy\" , \"targetRevision\" : \"main\" , \"path\" : \"infrastructure/solar-system/basic/resource-quota/cpu-bound\" }, \"destination\" : { \"namespace\" : \"africa\" } } \u53ef\u4ee5\u770b\u5230 ApplicationSet Controller \u6240\u8b80\u53d6\u7684 infrastructure/solar-system/earth/continents/ / /config.json \u9019\u500b JSON \u6a94\u6848\uff0c\u5b83\u4f7f\u7528\u88e1\u9762\u5b9a\u7fa9\u7684 Key/Value \u4f86\u9032\u884c Argo CD Application Template \u7684\u5b57\u4e32\u7f6e\u63db\uff0c\u7528\u4ee5\u9054\u6210\u5728\u540c\u4e00\u500b YAML \u6a94\u6848\u88e1\u7522\u751f\u51fa\u5404\u7a2e\u4e0d\u540c\u7684 Application\u3002 \u57f7\u884c\u7d50\u679c : \u4e00\u6a23\u5148\u628a Argo CD ApplicationSet CRD \u5275\u5efa\u8d77\u4f86\uff0c\u63a5\u8457\u5c31\u53ef\u4ee5\u5728 Argo CD UI Console \u770b\u5230 K8s Cluster Earth \u88e1\u9762\u7684\u6bcf\u500b NameSpace \u90fd\u5df2\u7d93\u81ea\u52d5\u7522\u751f\u597d Resource Quota \u7684 K8s Resource\uff0c\u800c\u4e14\u662f\u6839\u64da config.json \u88e1\u9762\u5b9a\u7fa9\u7684 Key/Value \u4f86\u5ba2\u88fd\u5316\u6bcf\u500b Argo CD Application\u3002 # \u5efa\u7acb Resource Quota Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/earth/basic/resourcequota.yaml","title":"Git File Generator"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#list-generator","text":"\u61c9\u7528\u60c5\u5883 : \u4f7f\u7528 Prometheus \u4f86\u76e3\u63a7 K8s Cluster \u662f\u518d\u6b63\u5e38\u4e0d\u904e\u7684\u4e8b\u60c5\u4e86\uff0c\u5047\u5982\u4eca\u5929\u60f3\u8981\u5728 K8s Cluster Mercury, Venus \u548c Earth \u88e1\u9762\u540c\u6642\u5b89\u88dd\u7684\u8a71\uff0c\u8a72\u5982\u4f55\u4f7f\u7528 Argo CD ApplicationSet Controller \u4f86\u9054\u6210\u5462\uff1f \u7bc4\u4f8b : prometheus.yaml apiVersion : argoproj.io/v1alpha1 kind : ApplicationSet metadata : name : prometheus namespace : argocd spec : generators : - list : elements : - cluster : mercury url : https://#{IP_ADDRESS}:61001 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP - cluster : venus url : https://#{IP_ADDRESS}:61002 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP - cluster : earth url : https://#{IP_ADDRESS}:61003 # \u9019\u908a\u8981\u81ea\u5df1\u63db\u6210\u672c\u5730 IP template : metadata : name : '{{cluster}}-prometheus' spec : project : default syncPolicy : automated : prune : true selfHeal : true source : repoURL : https://github.com/smalltown/argocd-galaxy targetRevision : main path : infrastructure/solar-system/basic/prometheus destination : server : '{{url}}' namespace : kube-system \u6700\u5f8c\u4e00\u500b List Generator \u8001\u5be6\u8aaa\u8ddf Cluster Generator \u529f\u80fd\u5dee\u4e0d\u591a\uff0c\u5728\u6700\u524d\u9762 Element \u4e2d\u5b9a\u7fa9\u6240\u8981\u5b89\u88dd Cluster \u7684\u540d\u7a31\u8ddf URL\uff0c\u4e0b\u9762\u7684 Application Template \u4e2d Destination \u7684 Server \u5c31\u53ef\u4ee5\u88ab\u81ea\u52d5\u7f6e\u63db\u3002 \u57f7\u884c\u7d50\u679c : \u4e00\u6a23\u5148\u628a Argo CD ApplicationSet CRD \u5275\u5efa\u8d77\u4f86\uff0c\u63a5\u8457\u5c31\u53ef\u4ee5\u5728 Argo CD UI Console \u770b\u5230\u4e09\u5ea7 K8s Cluster Mercury, Venus \u548c Earth \u90fd\u5df2\u7d93\u5b89\u88dd\u597d Prometheus\uff0c\u4e0d\u904e\u6211\u81ea\u5df1\u6703\u6bd4\u8f03\u559c\u6b61\u5728 Cluster \u8a2d\u5b9a\u597d Label\uff0c\u7136\u5f8c\u900f\u904e Cluster Generator \u4f86\u9054\u5230\u4e00\u6a23\u7684\u6548\u679c\u3002 # \u5efa\u7acb Prometheus Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/basic/prometheus.yaml","title":"List Generator"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_4","text":"\u4e0a\u9762\u5df2\u7d93\u628a\u5404\u7a2e ApplicationSet \u7684 Generator \u529f\u80fd\u6f14\u793a\u4e86\u4e00\u6b21\uff0c\u4f46\u5047\u5982\u5927\u5bb6\u9084\u6709\u5370\u8c61\u7684\u8a71\uff0c\u61c9\u8a72\u9084\u8a18\u5f97\u5728\u4e00\u958b\u59cb\u8a2d\u5b9a\u7684\u6642\u5019\uff0c\u6709\u4e9b\u6b65\u9a5f\u662f\u4f7f\u7528 CLI \u5728 Terminal \u5b8c\u6210\u7684\uff0c\u9019\u6709\u9ede\u9055\u53cd DevOps Everything as Code \u7684\u7cbe\u795e\uff0c\u6240\u4ee5\u5728\u9019\u500b Section \u6703\u4f86\u88dc\u5f37\u9019\u500b\u90e8\u4efd\u3002","title":"\u8072\u660e\u5f0f\u8a2d\u7f6e"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_5","text":"\u53c3\u8003: The Chicken/Egg Conundrum: How Modern Stories are Best Told \u6211\u5011\u4e00\u958b\u59cb\u5728\u5b89\u88dd Argo CD \u548c Argo CD ApplicationSet Controller \u6642\uff0c\u662f\u76f4\u63a5\u4f7f\u7528 Helm CLI\uff0c\u6240\u4ee5\u6211\u5011\u5728\u9019\u908a\u628a Argo CD \u7684 Argo CD ApplicationSet \u7d66\u88dc\u4e0a (\u597d\u9952\u53e3)\uff0c\u9019\u6a23\u4e00\u4f86\u5c31\u9023\u8ca0\u8cac Configuration Management \u89d2\u8272\u7684 Argo CD \u672c\u8eab\u4e5f\u5c07\u81ea\u5df1\u7d0d\u5165\u7ba1\u7406\u3002 # \u5efa\u7acb Argo CD \u7684 Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/sun/argo.yaml \u6211\u5011\u4e00\u958b\u59cb\u5728\u5b89\u88dd Argo CD \u548c Argo CD ApplicationSet Controller \u6642\uff0c\u662f\u76f4\u63a5\u4f7f\u7528 Helm CLI\uff0c\u6240\u4ee5\u6211\u5011\u5728\u9019\u908a\u628a Argo CD \u7684 Argo CD ApplicationSet \u7d66\u88dc\u4e0a\uff0c\u9019\u6a23\u4e00\u4f86\u5c31\u9023\u8ca0\u8cac Configuration Management \u89d2\u8272\u7684 Argo CD \u672c\u8eab\u4e5f\u5c07\u81ea\u5df1\u7d0d\u5165\u7ba1\u7406\u3002 # \u5efa\u7acb Argo CD \u7684 Argo CD ApplicationSet CRD $ kubectl apply -f applications/solar-system/sun/argo.yaml","title":"\u96de\u548c\u86cb\u7684\u96e3\u984c"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#k8s","text":"\u5728\u8a3b\u518a Argo CD Cluster \u6642\u662f\u4f7f\u7528 Argo CD CLI \u9054\u6210\uff0c\u4f46\u5176\u5be6\u4ed6\u4e5f\u53ea\u662f\u5728 K8s Cluster Sun \u7684 NameSpace \u88e1\u9762\u65b0\u589e\u4e00\u500b K8s Secret \u800c\u5df2\uff0c\u5927\u6982\u9577\u5f97\u50cf\u5e95\u4e0b\u9019\u6a23\u5b50\uff0cArgo CD \u4e3b\u8981\u900f\u904e Label argocd.argoproj.io/secret-type: cluster \u4f86\u5f97\u77e5\u9019\u662f\u4e00\u500b Cluster \u7684\u9023\u7dda\u8cc7\u8a0a\uff0c\u50cf\u6211\u81ea\u5df1\u662f\u900f\u904e Terraform \u5728\u5efa\u7acb\u597d K8s Cluster \u7684\u6642\u5019\u9806\u4fbf\u628a\u9019\u500b K8s Secret \u7522\u751f\u5728\u6709\u5b89\u88dd Argo CD \u7684 Primary K8s Cluster \u4e2d\uff0c\u9019\u6a23\u4e00\u4f86\u5c31\u53ef\u4ee5\u78ba\u5b9a\u9019\u4e00\u500b\u52d5\u4f5c\u662f Declarative\u3002 apiVersion : v1 kind : Secret metadata : name : mycluster-secret labels : argocd.argoproj.io/secret-type : cluster type : Opaque stringData : name : mycluster.com server : https://mycluster.com config : | ... \u9084\u6709\u5176\u4ed6\u66f4\u591a Argo CD \u8a2d\u5b9a\u90fd\u53ef\u4ee5\u4f7f\u7528 YAML \u6a94\u6848\u4f86\u64b0\u5beb\u8ddf\u5b9a\u7fa9\uff0c\u6709\u8208\u8da3\u7684\u4eba\u53ef\u4ee5\u53c3\u8003\u5b98\u65b9\u9019\u4efd Declarative Setup \u6587\u4ef6 \u3002","title":"\u8a3b\u518a\u8981\u63a7\u5236\u7684 K8S \u96c6\u7fa4"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_6","text":"Folder Structure \u6c92\u6709\u5206\u597d\u58de\uff0c\u53ea\u8981\u9069\u5408\u81ea\u5df1\u7684\u958b\u767c\u5718\u968a\u5373\u53ef\uff0c\u9019\u908a\u628a\u7bc4\u4f8b\u4f7f\u7528\u5230\u7684\u8cc7\u6599\u593e\u7d50\u69cb\u7a0d\u5fae\u89e3\u91cb\u4e00\u4e0b\uff0c\u6211\u5c07 Argo CD CRD (Application & ApplicationSet) \u8207 K8s Manifest \u5206\u5225\u7f6e\u65bc\u4e0d\u540c\u7684\u8cc7\u6599\u593e\u5167\uff0c\u7136\u5f8c\u518d\u900f\u904e\u884c\u661f\u7cfb\u7d71\u4f86\u505a\u5206\u7fa4 \uff0c\u6240\u4ee5\u592a\u967d\u7cfb\u4e00\u7fa4\uff0c\u514b\u535c\u52d290 \u4e5f\u81ea\u6210\u4e00\u7fa4\uff0c\u88e1\u9762\u5c31\u662f\u4ed6\u5011\u7684\u884c\u661f\uff1b\u5c0d\u61c9\u5230\u73fe\u5be6\u5834\u666f\u5c31\u662f Production \u74b0\u5883\u4e00\u7fa4\uff0cNon-Production \u74b0\u5883\u4e00\u7fa4\uff0c\u6bcf\u4e00\u7fa4\u88e1\u9762\u90fd\u6703\u6709\u4e00\u5ea7 Primary K8s Cluster (\u5b89\u88dd\u6709 Argo CD \u90a3\u5ea7)\uff0c\u518d\u5f80\u4e0b\u4e00\u5c64\u5c31\u662f\u5404\u81ea\u6240\u7ba1\u7406\u7684 Alpha- , Beta- , Prod-* \u7b49 K8s Cluster\uff0c\u4e26\u4e14\u6703\u5e0c\u671b\u4e0d\u8981\u5c07 Helm Chart \u64fa\u5230\u9019\u500b Repository \u88e1\u4f86\uff0c\u800c\u662f\u53bb\u53c3\u7167\u5728\u5916\u90e8\u7684 Helm Repository\uff0c\u7528\u4ee5\u907f\u514d\u5718\u968a\u4e00\u8d77\u958b\u767c\u6642\u7684\u6df7\u4e82\u5c40\u9762\u3002 argocd-galaxy \u251c\u2500\u2500 applications \u2502 \u251c\u2500\u2500 kepler-90 \u2502 \u251c\u2500\u2500 ... \u2502 \u2514\u2500\u2500 solar-system \u2502 \u251c\u2500\u2500 basic \u2502 \u251c\u2500\u2500 earth \u2502 \u251c\u2500\u2500 ... \u2502 \u2514\u2500\u2500 sun \u2514\u2500\u2500 infrastructure \u251c\u2500\u2500 kepler-90 \u251c\u2500\u2500 ... \u2514\u2500\u2500 solar-system \u251c\u2500\u2500 basic \u251c\u2500\u2500 earth \u251c\u2500\u2500 mercury \u251c\u2500\u2500 sun \u2502 ... \u2514\u2500\u2500 venus \u2514\u2500\u2500 solar-system \u251c\u2500\u2500 basic \u251c\u2500\u2500 earth \u251c\u2500\u2500 mercury \u251c\u2500\u2500 sun \u2514\u2500\u2500 venus","title":"\u5b58\u5132\u5eab\u6587\u4ef6\u593e\u7d50\u69cb"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_7","text":"\u76ee\u524d Argo CD ApplicationSet Controller \u9084\u5728\u5f88\u65e9\u671f\u7684\u968e\u6bb5\uff0c\u4f8b\u5982 Git File Generator \u53ea\u80fd\u8b80\u53d6 JSON \u683c\u5f0f\u6a94\u6848\uff0cDestination \u7684 Server \u503c\u7121\u6cd5\u50cf Application CRD \u5167\u4e00\u6a23\u76f4\u63a5\u4f7f\u7528 Cluster \u540d\u7a31\uff0c\u4e5f\u9084\u6c92\u6709 If/Else \u7684\u529f\u80fd \uff1b\u4e0d\u904e\u5149\u662f\u76ee\u524d\u7684 Generator a.k.a. For Loop \u5c31\u53ef\u4ee5\u5e6b\u52a9\u7dad\u904b\u4eba\u54e1\u7701\u4e0b\u5f88\u591a\u5bf6\u8cb4\u7684\u6642\u9593\u3002","title":"\u7d50\u8ad6"},{"location":"argocd/tutorial/argo-cd-applicationset-controller/#_8","text":"https://www.openshift.com/blog/getting-started-with-applicationsets https://argoproj.github.io/argo-cd/operator-manual/declarative-setup/ https://argoproj.github.io/argo-cd/user-guide/application-set/ https://github.com/argoproj/argo-cd/issues/1481","title":"\u53c3\u8003"},{"location":"cicd/gitops/","text":"\u6dfa\u8ac7 GitOps \u7684\u6982\u5ff5 \u00b6 \u539f\u6587: https://www.hwchiu.com/gitops.html \u672c\u7bc7\u6587\u7ae0\u4e3b\u8981\u8ddf\u5927\u5bb6\u4ecb\u7d39\u9019\u5e7e\u5e74\u4f34\u96a8\u8005 Kubernetes \u51fa\u73fe\u7684\u4e00\u500b\u540d\u8a5e GitOps , \u5167\u5bb9\u4e3b\u8981\u6703\u5305\u542b: GitOps \u6982\u5ff5\u4ecb\u7d39 ArgoCD\u958b\u6e90\u5c08\u6848\u4ecb\u7d39 GitOps \u4ecb\u7d39 \u00b6 GitOps \u9019\u500b\u8a5e\u5c31\u6211\u4e86\u89e3\uff0c\u6700\u65e9\u662f\u7531 Weave Net \u6240\u63d0\u51fa\u7684\u6982\u5ff5\uff0c\u8981\u77ad\u89e3 GitOps \u7684\u512a\u52a3\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u9084\u662f\u900f\u904e\u6bd4\u8f03\u7684\u65b9\u5f0f\u4f86\u7406\u89e3 GitOps \u8207\u539f\u5148\u7fd2\u6163\u7684 CI/CD \u90e8\u7f72\u65b9\u5f0f\u7684\u5dee\u7570\u3002 Info \u8a3b: \u9019\u908a\u63a2\u8a0e\u7684\u6240\u6709\u67b6\u69cb\u90fd\u4ee5 Kubernetes \u70ba\u4e3b \u5e38\u898b\u7684 CD \u6d41\u7a0b \u00b6 \u4e0b\u5716\u662f\u4e00\u500b\u5e38\u898b\u7684 CD \u6d41\u6c34\u7dda\u6d41\u7a0b: \u9019\u500b\u7bc4\u4f8b\u4e2d\uff0c\u6211\u5011\u6709\u4e00\u4e9b\u57fa\u672c\u5143\u4ef6: Git Repo - \u9019\u500b Git Repository \u4e2d\u81f3\u5c11\u6703\u653e\u7f6e\u95dc\u65bc Kubernetes \u8cc7\u6e90\u7684\u63cf\u8ff0\u6a94\u6848(Manifests), \u53ef\u4ee5\u662f\u539f\u751f\u7684 Yaml\uff0c Helm Charts \u6216\u662f Kustomize \u7684\u6a94\u6848\u3002 CI/CD Pipeline - \u8b6c\u5982 Jenkins/Gilab CI/GitHub Action/CirecleCI \u7b49\u5e38\u898b\u7cfb\u7d71\uff0c\u9019\u500b Pipeline \u88e1\u9762\u6703\u6709\u4e00\u4e9b\u5de5\u4f5c\uff0c\u8b6c\u5982\u6e2c\u8a66\uff0c\u5efa\u7f6e Contianer Image, \u66f4\u65b0 Container Image\uff0c\u4ee5\u53ca\u8ddf Kubernetes \u6e9d\u901a Operator/Devloper - \u5be6\u969b\u4e0a\u64cd\u4f5c\u7684\u4eba\u54e1\uff0c\u8b6c\u5982\u5c08\u6848\u958b\u767c\u4eba\u54e1\u6216\u662f\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u3002 \u5c0d\u65bc\u958b\u767c\u4eba\u54e1\u4f86\u8aaa\uff0c\u53ef\u80fd\u6703\u900f\u904e 1) PullRequest/MergeRequest \u7684\u7522\u751f\uff0c 2) PR/MR \u88ab\u5408\u4f75\u6216\u662f\u6709\u7279\u5b9a\u7684 Tag \u88ab\u7522\u751f \u7b49\u8af8\u591a\u689d\u4ef6\u89f8\u767c CI/CD Pipeline \u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba\u3002 \u5c0d\u65bc\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u4f86\u8aaa\u53ef\u5df2\u900f\u904e 1)\u76f4\u63a5\u8981\u6c42 CI/CD Pipeline \u904b\u884c\u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba 2) \u76f4\u63a5\u5c0d\u76ee\u6a19 Kubernetes Cluster \u9032\u884c\u64cd\u63a7\u3002 \u5f9e\u4e0a\u8ff0\u7684\u7bc4\u4f8b\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u6c92\u6709\u56b4\u53b2\u7684\u53bb\u9650\u5236 \u76f4\u63a5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0 \u9019\u500b\u884c\u70ba\uff0c\u5c31\u6709\u5169\u500b\u4e0d\u540c\u7684\u89f8\u767c\u9ede\u53ef\u4ee5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0\uff0c\u9019\u7a2e\u60c5\u6cc1\u53ef\u80fd\u6703\u9020\u6210\u7684\u554f\u984c\u662f: \u6c92\u6709\u8fa6\u6cd5\u63a7\u7ba1 Kubernetes \u6b63\u5728\u904b\u884c\u7684\u8cc7\u6e90\u72c0\u614b (Living Status) \u8207 Kubernetes \u88ab\u671f\u671b\u7684\u8cc7\u6e90\u72c0\u614b (Desired Yaml) \u4e00\u81f4 \u7279\u5225\u662f\u7576\u6709\u4eba\u54e1\u6703\u76f4\u63a5\u900f\u904e kubectl edit, kubectl patch, \u4f7f\u7528\u67d0\u7a2eUI\u7b49\u65b9\u5f0f\u76f4\u63a5\u4fee\u6539\u904b\u884c\u72c0\u614b\u537b\u53c8\u6c92\u6709\u8981\u66f4\u65b0\u63cf\u8ff0\u8cc7\u6e90 (Yaml) \u6642\u66f4\u5bb9\u6613\u767c\u751f\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u9019\u500b\u90e8\u7f72\u7d50\u69cb\u9084\u6709\u4e00\u500b\u5bb9\u6613\u5f15\u4eba\u8a6c\u75c5\u7684\u554f\u984c\u5c31\u662f KUBECONFIG \u7684\u6563\u4f48\uff0c\u70ba\u4e86\u8b93\u5916\u90e8\u74b0\u5883(CI/CD Pipeline, \u7279\u5b9a\u4eba\u54e1 laptop) \u80fd\u5920\u5c0d Kubernetes \u9032\u884c\u64cd\u4f5c\uff0c\u5fc5\u9808\u8981\u5c07\u9023\u63a5 Kubernetes Cluster \u6240\u9700\u8981\u7684 KUBECONFIG (Token/Credentail/API Address:Port) \u7b49\u8cc7\u8a0a\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u9019\u7121\u7591\u9020\u6210\u4e86\u4e00\u4e9b\u5b89\u5168\u6027\u7684\u96b1\u6182\u3002 \u75db\u9ede \u00b6 \u7c21\u55ae\u6574\u7406\u4ee5\u4e0b\u4e0a\u8ff0\u90e8\u7f72\u6d41\u7a0b\u53ef\u80fd\u7684\u7f3a\u5931: Kubernetes Cluster \u7684\u9023\u7dda\u8cc7\u8a0a\u5fc5\u9808\u8981\u66b4\u9732\u5728\u5916\uff0c\u4e00\u65e6\u88ab\u5916\u754c\u62ff\u5230\u5247\u6574\u500b Cluster \u90fd\u6709\u88ab\u7834\u58de\u7684\u53ef\u80fd \u96e3\u4ee5\u78ba\u4fdd Kubernetes \u5167\u904b\u884c\u7684\u72c0\u614b\u8207\u63cf\u8ff0\u7684\u8cc7\u6e90\u6a94\u6848 (Yaml/Helm Chart) \u4e00\u81f4\uff0c\u56e0\u70ba\u6709\u592a\u591a\u5730\u65b9\u53ef\u4ee5\u9032\u884c\u64cd\u4f5c \u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u770b\u4e00\u4e0b\u5c0d\u65bc GitOps \u4f86\u8aaa\uff0c\u8981\u5982\u4f55\u89e3\u6c7a\u4e0a\u9762\u5169\u500b\u6f5b\u5728\u554f\u984c\uff0c\u4e26\u4e14\u662f\u900f\u904e\u4f55\u7a2e\u65b9\u5f0f\u4f86\u8655\u7406\u3002 GitOps \u00b6 GitOps \u7684\u6982\u5ff5\u5982\u4e0b\u5716\u5448\u73fe: \u8207\u524d\u8ff0\u7684\u90e8\u7f72\u65b9\u5f0f\u6700\u5927\u7684\u5dee\u8ddd\u5c31\u662f: CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo \uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002 \u6240\u4ee5\u9019\u908a\u91dd\u5c0d GitOps \u4e0b\u500b\u4e00\u500b\u7e3d\u7d50\uff1a KUBECONFIG \u4e0d\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u4e0d\u5e0c\u671b\u4efb\u4f55\u4eba/\u74b0\u5883\u6709\u8fa6\u6cd5\u76f4\u63a5\u5f9e\u5916\u90e8\u53bb\u64cd\u4f5c Kubernetes \u5c07\u6240\u6709\u63cf\u8ff0 Kubernetes \u8cc7\u6e90\u72c0\u614b\u7684\u6a94\u6848\uff08Yaml/Helm Chart)\u7528 Git \u4fdd\u5b58 Kubernetes \u5167\u6703\u5b89\u88dd\u76f8\u5c0d\u61c9\u7684 controller \u4f86\u76e3\u63a7 Git Repo \u7684\u66f4\u65b0\u4e26\u4e14\u5c07\u4e00\u5207\u7684\u66f4\u65b0\u90fd\u66f4\u65b0\u5230 kubernetes cluster \u5167 (\u53ef\u80fd\u7684\u512a\u52e2)\uff0c\u900f\u904e GitOps \u9019\u7a2e\u67b6\u69cb\uff0cKubernetes Cluster \u672c\u8eab\u4e0d\u9700\u8981\u5c07 API Server \u7684\u5b58\u53d6\u65b9\u5f0f\u7d66\u66b4\u9732\u51fa\u53bb\uff0c\u53ef\u4ee5\u900f\u904e Firewall \u7684\u65b9\u5f0f\u628a\u5e38\u898b\u7684 6443 \u9023\u63a5\u57e0\u7d66\u95dc\u9589\uff0c\u5c0d\u65bc\u5b89\u5168\u6027\u4f86\u8aaa\u4e5f\u662f\u6e1b\u5c11\u4e86\u4e00\u4e9b\u6f5b\u5728\u7684\u554f\u984c\u3002 ArgoCD \u958b\u6e90\u5c08\u6848\u4ecb\u7d39 \u00b6 \u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u63a2\u8a0e\u4e00\u500b\u5be6\u73fe GitOps \u7684\u958b\u6e90\u5c08\u6848 ArgoCD\uff0c\u9019\u908a\u4e0d\u6703\u6709\u592a\u4ed4\u7d30\u7684 Demo \u8207\u64cd\u4f5c\uff0c\u4e3b\u8981\u662f\u91dd\u5c0d\u67b6\u69cb\u4f86\u9032\u884c\u4ecb\u7d39\u3002 ArgoCD \u7684\u67b6\u69cb\u5f15\u7528\u5176\u5b98\u7db2: \u9019\u500b\u67b6\u69cb\u5716\u5206\u6210\u5e7e\u500b\u90e8\u5206\u4f86\u770b\u3002 ArgoCD \u65bc Kubernetes Cluster \u5167\u5b89\u88dd\u7684\u670d\u52d9\uff0c\u9019\u4e9b\u670d\u52d9\u5305\u542b\u4e86 Argo API Server : \u63d0\u4f9b\u4ecb\u9762\u7d66\u5916\u754c\u64cd\u63a7 ArgoCD \u670d\u52d9\uff0c\u672c\u8eab\u63d0\u4f9b\u4e86 CLI, GUI \u4ee5\u53ca gRPC/REST \u7b49\u4ecb\u9762\uff0c\u6700\u7c21\u55ae\u7684 Demo \u53ef\u4ee5\u4f7f\u7528 GUI \u4f86\u64cd\u4f5c\u3002 Repository Service : \u672c\u8eab\u4f5c\u70ba\u4e00\u500b\u9060\u65b9 Git Repo \u7684\u672c\u5730\u5feb\u53d6\uff0c\u4e3b\u8981\u662f\u5132\u5b58\u8a72 Git Repo \u5167\u7684\u8cc7\u6e90\u9810\u671f\u6a94\u6848 (Yaml/Helm Chart) Application Controller : \u8ca0\u8cac\u8ddf Kubernetes \u6e9d\u901a\uff0c\u6703\u6bd4\u8f03 Kubernetes Cluster \u5167\u7684\u904b\u884c\u72c0\u614b (living status) \u4ee5\u53ca Git Repository \u5167\u6240\u63cf\u8ff0\u7684\u8cc7\u6e90\u9810\u671f\u72c0\u614b (Yaml/Helm Chart), \u4e26\u4e14\u66f4\u65b0 Kubernetes Cluster \u4e00\u65e6\u767c\u73fe Git Repository \u5167\u6709\u66f4\u52d5 \u4e0a\u65b9\u7684 Git Repo, \u8a72 Git Repo \u672c\u8eab\u6709\u5169\u7a2e\u65b9\u5f0f\u8207 ArgoCD \u4e92\u52d5 Webhook \u4e3b\u52d5\u544a\u77e5 ArgoCD ArgoCD \u672c\u8eab\u5b9a\u671f\u53bb\u89c0\u5bdf Git Repo \u7684\u72c0\u614b\uff0c\u4e26\u4e14\u4e00\u65e6\u6709\u66f4\u65b0\u5c31\u6703\u8b93 Controller \u4f86\u66f4\u65b0\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f \u5de6\u65b9\u7684\u958b\u767c\u4eba\u54e1/\u7dad\u8b77\u4eba\u54e1\uff0c\u9019\u4e9b\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI/gRPC/REST \u7b49\u65b9\u5f0f\u4f86\u64cd\u4f5c ArgoCD \u7684\u670d\u52d9\u3002 \u958b\u767c\u4eba\u54e1\u53ef\u4ee5\u900f\u904e\u5c0d Git Repo \u7684\u4fee\u6539\u8207\u5408\u4f75\u4f86\u89f8\u767c ArgoCD \u90e8\u7f72\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI \u7b49\u65b9\u5f0f\u4f86\u89c0\u5bdf\u8207\u8a2d\u5b9a\u7576\u524d\u61c9\u7528\u7a0b\u5f0f\u7684\u72c0\u614b \u5de6\u4e0b\u65b9\u7684\u662f Hook \u9ede\uff0c ArgoCD \u672c\u8eab\u91dd\u5c0d Git Repo \u66f4\u65b0\u524d\u5f8c\u6709\u63d0\u4f9b\u76f8\u95dc\u7684 Hook\uff0c\u53ef\u4ee5\u5728\u9019\u908a\u5c07\u76f8\u95dc\u7684\u8a0a\u606f\u8207\u5176\u4ed6\u7cfb\u7d71\u929c\u63a5\uff0c\u8b6c\u5982 Slack, Webhook \u7b49\uff0c\u8b93\u4f60\u7684\u7cfb\u7d71\u80fd\u5920\u6709\u8fa6\u6cd5\u63a5\u6536\u5230\u7576\u524d\u90e8\u7f72\u7684\u72c0\u6cc1 \u53f3\u4e0b\u65b9\u5247\u662f\u76ee\u6a19\u7684 Kubernetes Cluster \u5c0d\u65bc ArgoCD \u4f86\u8aaa\uff0c\u672c\u8eab\u8981\u5148\u900f\u904e\u4e00\u5957 Kubernetes \u4f86\u67b6\u8a2d\u670d\u52d9\uff0c\u63a5\u8005\u8a72 ArgoCD \u53ef\u4ee5\u91dd\u5c0d\u4e0d\u540c\u7684 Kuberentes Cluster \u9032\u884c\u8a2d\u5b9a\u8207\u5b58\u53d6\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u5982\u679c\u4f60\u74b0\u5883\u5167\u6709\u591a\u5957 Kubernetes Cluster, \u53ef\u4ee5\u53ea\u7528\u4e00\u5957 ArgoCD \u4f86\u7ba1\u7406\u9019\u4e9b Kubernetes Cluster\uff0c\u5c07\u95dc\u6ce8\u7684 Git Repo \u7d66\u90e8\u7f72\u5230\u4e0d\u540c Kubernetes Cluster \u5167\u7684\u4e0d\u540c namespace \u4e0b\u3002 \u4f7f\u7528\u7bc4\u4f8b \u00b6 \u5b98\u7db2\u7684 \u4f7f\u7528\u7bc4\u4f8b , \u6709\u8208\u8da3\u7684\u53ef\u4ee5\u53c3\u8003\u9023\u7d50\u4f86\u8a2d\u5b9a\u73a9\u770b\u770b\uff0c\u57fa\u672c\u4e0a\u5168\u90e8\u90fd\u662f\u57fa\u65bc GUI \u4f86\u9032\u884c\u64cd\u4f5c \u4ee5\u4e0b\u5716\u7247\u90fd\u4f86\u81ea\u5b98\u7db2\u7bc4\u4f8b: \u4e0a\u5716\u7bc4\u4f8b\u5c31\u662f\u5efa\u7acb\u4e00\u500b Application , \u5176\u8ffd\u8e64\u7684 Git Repo \u662f https://github.com/argoproj/argocd-example-apps \uff0c\u4e26\u4e14\u8ffd\u8e64\u7684\u662f\u76ee\u6a19 Repo \u7684 HEAD(latest) branch \u4e0b\u7684 guestbook \u8cc7\u6599\u593e\u5167\u7684\u8cc7\u6e90\u63cf\u8ff0\u6a94\u6848\u3002 \u6b64\u5916\u7576\u6709\u4efb\u4f55\u66f4\u65b0\u7684\u6642\u5019\uff0c\u6703\u5c07\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f\u90e8\u7f72\u5230 https://kubernetes.default.svc \u8a72 API server \u6240\u5c0d\u61c9\u7684 Kubernetes Cluster \u5167\uff0c\u4e26\u4e14\u653e\u5230 default namespace\u3002 ArgoCD \u672c\u8eab\u4e5f\u6703\u900f\u904e GUI \u7684\u65b9\u5f0f\u4f86\u8996\u89ba\u5316\u5448\u73fe\u90e8\u7f72\u7684\u8cc7\u6e90\uff0c\u5305\u542b\u5176\u72c0\u614b\uff0c\u540d\u7a31\u4ee5\u53ca\u5f7c\u6b64\u7684\u95dc\u4fc2\u3002 \u7e3d\u7d50 \u00b6 GitOps \u95dc\u6ce8\u7684\u662f\u5982\u4f55\u81ea\u52d5\u5316\u90e8\u7f72(CD)\uff0c\u8ddf CI, Pipeline \u95dc\u4fc2\u4e0d\u5927 GitOps \u8981\u6c42\u7684\u662f\u4ee5 Git Repo \u70ba\u4f86\u6e90\uff0c\u5982\u679c\u8981\u5c0d\u61c9\u7528\u7a0b\u5f0f\u9032\u7248\u6216\u662f\u9000\u7248\uff0c\u90fd\u76f4\u63a5\u5c0d Git \u4fee\u6b63\u5373\u53ef\uff0c\u5f8c\u7e8c\u8b93\u76f8\u95dc\u7684 Controller \u4f86\u5e6b\u5fd9\u540c\u6b65\u8cc7\u6e90\u72c0\u614b \u91dd\u5c0d\u4e0d\u80fd\u5920\u88ab\u5916\u754c\u5b58\u53d6\u7684 Kubernetes Cluster\u4f86\u8aaa\uff0c GitOps \u7684\u6982\u5ff5\u53ef\u4ee5\u89e3\u6c7a\u81ea\u52d5\u90e8\u7f72\u7684\u56f0\u5883\uff0c\u540c\u6642\u4e5f\u80fd\u5920\u6e1b\u5c11\u5916\u6d29 KUBECONFIG \u9019\u500b\u6a94\u6848\u7684\u6f5b\u5728\u6027","title":"GitOps \u7684\u6982\u5ff5"},{"location":"cicd/gitops/#gitops","text":"\u539f\u6587: https://www.hwchiu.com/gitops.html \u672c\u7bc7\u6587\u7ae0\u4e3b\u8981\u8ddf\u5927\u5bb6\u4ecb\u7d39\u9019\u5e7e\u5e74\u4f34\u96a8\u8005 Kubernetes \u51fa\u73fe\u7684\u4e00\u500b\u540d\u8a5e GitOps , \u5167\u5bb9\u4e3b\u8981\u6703\u5305\u542b: GitOps \u6982\u5ff5\u4ecb\u7d39 ArgoCD\u958b\u6e90\u5c08\u6848\u4ecb\u7d39","title":"\u6dfa\u8ac7 GitOps \u7684\u6982\u5ff5"},{"location":"cicd/gitops/#gitops_1","text":"GitOps \u9019\u500b\u8a5e\u5c31\u6211\u4e86\u89e3\uff0c\u6700\u65e9\u662f\u7531 Weave Net \u6240\u63d0\u51fa\u7684\u6982\u5ff5\uff0c\u8981\u77ad\u89e3 GitOps \u7684\u512a\u52a3\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u9084\u662f\u900f\u904e\u6bd4\u8f03\u7684\u65b9\u5f0f\u4f86\u7406\u89e3 GitOps \u8207\u539f\u5148\u7fd2\u6163\u7684 CI/CD \u90e8\u7f72\u65b9\u5f0f\u7684\u5dee\u7570\u3002 Info \u8a3b: \u9019\u908a\u63a2\u8a0e\u7684\u6240\u6709\u67b6\u69cb\u90fd\u4ee5 Kubernetes \u70ba\u4e3b","title":"GitOps \u4ecb\u7d39"},{"location":"cicd/gitops/#cd","text":"\u4e0b\u5716\u662f\u4e00\u500b\u5e38\u898b\u7684 CD \u6d41\u6c34\u7dda\u6d41\u7a0b: \u9019\u500b\u7bc4\u4f8b\u4e2d\uff0c\u6211\u5011\u6709\u4e00\u4e9b\u57fa\u672c\u5143\u4ef6: Git Repo - \u9019\u500b Git Repository \u4e2d\u81f3\u5c11\u6703\u653e\u7f6e\u95dc\u65bc Kubernetes \u8cc7\u6e90\u7684\u63cf\u8ff0\u6a94\u6848(Manifests), \u53ef\u4ee5\u662f\u539f\u751f\u7684 Yaml\uff0c Helm Charts \u6216\u662f Kustomize \u7684\u6a94\u6848\u3002 CI/CD Pipeline - \u8b6c\u5982 Jenkins/Gilab CI/GitHub Action/CirecleCI \u7b49\u5e38\u898b\u7cfb\u7d71\uff0c\u9019\u500b Pipeline \u88e1\u9762\u6703\u6709\u4e00\u4e9b\u5de5\u4f5c\uff0c\u8b6c\u5982\u6e2c\u8a66\uff0c\u5efa\u7f6e Contianer Image, \u66f4\u65b0 Container Image\uff0c\u4ee5\u53ca\u8ddf Kubernetes \u6e9d\u901a Operator/Devloper - \u5be6\u969b\u4e0a\u64cd\u4f5c\u7684\u4eba\u54e1\uff0c\u8b6c\u5982\u5c08\u6848\u958b\u767c\u4eba\u54e1\u6216\u662f\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u3002 \u5c0d\u65bc\u958b\u767c\u4eba\u54e1\u4f86\u8aaa\uff0c\u53ef\u80fd\u6703\u900f\u904e 1) PullRequest/MergeRequest \u7684\u7522\u751f\uff0c 2) PR/MR \u88ab\u5408\u4f75\u6216\u662f\u6709\u7279\u5b9a\u7684 Tag \u88ab\u7522\u751f \u7b49\u8af8\u591a\u689d\u4ef6\u89f8\u767c CI/CD Pipeline \u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba\u3002 \u5c0d\u65bc\u67b6\u69cb\u7dad\u904b\u4eba\u54e1\u4f86\u8aaa\u53ef\u5df2\u900f\u904e 1)\u76f4\u63a5\u8981\u6c42 CI/CD Pipeline \u904b\u884c\u4f86\u9032\u884c\u5f8c\u7e8c\u884c\u70ba 2) \u76f4\u63a5\u5c0d\u76ee\u6a19 Kubernetes Cluster \u9032\u884c\u64cd\u63a7\u3002 \u5f9e\u4e0a\u8ff0\u7684\u7bc4\u4f8b\u4e2d\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u6c92\u6709\u56b4\u53b2\u7684\u53bb\u9650\u5236 \u76f4\u63a5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0 \u9019\u500b\u884c\u70ba\uff0c\u5c31\u6709\u5169\u500b\u4e0d\u540c\u7684\u89f8\u767c\u9ede\u53ef\u4ee5\u5c0d Kubernetes \u9032\u884c\u66f4\u65b0\uff0c\u9019\u7a2e\u60c5\u6cc1\u53ef\u80fd\u6703\u9020\u6210\u7684\u554f\u984c\u662f: \u6c92\u6709\u8fa6\u6cd5\u63a7\u7ba1 Kubernetes \u6b63\u5728\u904b\u884c\u7684\u8cc7\u6e90\u72c0\u614b (Living Status) \u8207 Kubernetes \u88ab\u671f\u671b\u7684\u8cc7\u6e90\u72c0\u614b (Desired Yaml) \u4e00\u81f4 \u7279\u5225\u662f\u7576\u6709\u4eba\u54e1\u6703\u76f4\u63a5\u900f\u904e kubectl edit, kubectl patch, \u4f7f\u7528\u67d0\u7a2eUI\u7b49\u65b9\u5f0f\u76f4\u63a5\u4fee\u6539\u904b\u884c\u72c0\u614b\u537b\u53c8\u6c92\u6709\u8981\u66f4\u65b0\u63cf\u8ff0\u8cc7\u6e90 (Yaml) \u6642\u66f4\u5bb9\u6613\u767c\u751f\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u9019\u500b\u90e8\u7f72\u7d50\u69cb\u9084\u6709\u4e00\u500b\u5bb9\u6613\u5f15\u4eba\u8a6c\u75c5\u7684\u554f\u984c\u5c31\u662f KUBECONFIG \u7684\u6563\u4f48\uff0c\u70ba\u4e86\u8b93\u5916\u90e8\u74b0\u5883(CI/CD Pipeline, \u7279\u5b9a\u4eba\u54e1 laptop) \u80fd\u5920\u5c0d Kubernetes \u9032\u884c\u64cd\u4f5c\uff0c\u5fc5\u9808\u8981\u5c07\u9023\u63a5 Kubernetes Cluster \u6240\u9700\u8981\u7684 KUBECONFIG (Token/Credentail/API Address:Port) \u7b49\u8cc7\u8a0a\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u9019\u7121\u7591\u9020\u6210\u4e86\u4e00\u4e9b\u5b89\u5168\u6027\u7684\u96b1\u6182\u3002","title":"\u5e38\u898b\u7684 CD \u6d41\u7a0b"},{"location":"cicd/gitops/#_1","text":"\u7c21\u55ae\u6574\u7406\u4ee5\u4e0b\u4e0a\u8ff0\u90e8\u7f72\u6d41\u7a0b\u53ef\u80fd\u7684\u7f3a\u5931: Kubernetes Cluster \u7684\u9023\u7dda\u8cc7\u8a0a\u5fc5\u9808\u8981\u66b4\u9732\u5728\u5916\uff0c\u4e00\u65e6\u88ab\u5916\u754c\u62ff\u5230\u5247\u6574\u500b Cluster \u90fd\u6709\u88ab\u7834\u58de\u7684\u53ef\u80fd \u96e3\u4ee5\u78ba\u4fdd Kubernetes \u5167\u904b\u884c\u7684\u72c0\u614b\u8207\u63cf\u8ff0\u7684\u8cc7\u6e90\u6a94\u6848 (Yaml/Helm Chart) \u4e00\u81f4\uff0c\u56e0\u70ba\u6709\u592a\u591a\u5730\u65b9\u53ef\u4ee5\u9032\u884c\u64cd\u4f5c \u63a5\u4e0b\u4f86\u6211\u5011\u5c31\u770b\u4e00\u4e0b\u5c0d\u65bc GitOps \u4f86\u8aaa\uff0c\u8981\u5982\u4f55\u89e3\u6c7a\u4e0a\u9762\u5169\u500b\u6f5b\u5728\u554f\u984c\uff0c\u4e26\u4e14\u662f\u900f\u904e\u4f55\u7a2e\u65b9\u5f0f\u4f86\u8655\u7406\u3002","title":"\u75db\u9ede"},{"location":"cicd/gitops/#gitops_2","text":"GitOps \u7684\u6982\u5ff5\u5982\u4e0b\u5716\u5448\u73fe: \u8207\u524d\u8ff0\u7684\u90e8\u7f72\u65b9\u5f0f\u6700\u5927\u7684\u5dee\u8ddd\u5c31\u662f: CI/CD Pipeline \u5167\u4e0d\u9032\u884c\u4efb\u4f55\u90e8\u7f72\u52d5\u4f5c \u8cc7\u6e90\u7684\u63cf\u8ff0\u72c0\u614b (Yaml/Helm Chart) \u653e\u5728 Git \u88e1\u9762\uff0cGit \u4f5c\u70ba Single Source of Truth\u7684\u89d2\u8272 Kubernetes \u5167\u90e8\u6709\u4e00\u500b Controller \u6703\u5b9a\u671f\u53bb\u5075\u6e2c Git \u7684\u8b8a\u5316\uff0c\u4e26\u4e14\u628a Git \u5167\u7684\u8b8a\u52d5\u90fd\u66f4\u65b0\u5230 Kubernetes \u88e1\u9762 \u9019\u610f\u5473\u8005\u4efb\u4f55\u4eba\u5982\u679c\u60f3\u8981\u5c0d Kubernetes Cluster \u9032\u884c\u4fee\u6539\uff0c\u53ea\u6709\u4e00\u500b\u8fa6\u6cd5\u5c31\u662f \u66f4\u65b0 Git Repo \uff0c\u4e00\u65e6 Git Repo \u5167\u63cf\u8ff0\u7684 Yaml/Helm Chart \u6709\u4efb\u4f55\u4fee\u6539\uff0cKubernetes Cluster \u5167\u7684 Controller \u6703\u8ca0\u8cac\u5c07\u9019\u4e9b\u8b8a\u52d5\u7684\u5dee\u7570\u6027\u66f4\u65b0\u5230 Kubernetes Cluster \u5167\u3002 \u56e0\u6b64 Git repo \u5c31\u662f\u552f\u4e00\u7684\u4f86\u6e90\uff0c\u540c\u6642\u900f\u904e Git \u7248\u672c\u63a7\u5236\u7684\u7279\u6027\uff0c\u5982\u679c\u60f3\u8981\u91dd\u5c0d\u8cc7\u6e90\u9032\u884c\u7248\u672c\u66f4\u52d5, rollback \u7b49\u64cd\u4f5c\uff0c\u76f4\u63a5\u91dd\u5c0d Git \u7ba1\u7406\uff08\u8b6c\u5982 git revert)\u3002 \u6b64\u5916\uff0cGitOps \u7684\u904e\u7a0b\u4e2d\uff0c\u4efb\u4f55\u4eba\u90fd\u4e0d\u61c9\u8a72\u76f4\u63a5\u5c0d Kubernetes Cluster \u76f4\u63a5\u64cd\u4f5c\uff0c\u56e0\u6b64\u4e5f\u4e0d\u9700\u8981\u5c07 KUBECONFIG \u9019\u500b\u6a94\u6848\u7d66\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u5b89\u5168\u6027\u7684\u96b1\u6182\u4e5f\u5c31\u8fce\u5203\u800c\u89e3\u3002 \u6240\u4ee5\u9019\u908a\u91dd\u5c0d GitOps \u4e0b\u500b\u4e00\u500b\u7e3d\u7d50\uff1a KUBECONFIG \u4e0d\u5206\u4eab\u51fa\u53bb\uff0c\u56e0\u6b64\u4e0d\u5e0c\u671b\u4efb\u4f55\u4eba/\u74b0\u5883\u6709\u8fa6\u6cd5\u76f4\u63a5\u5f9e\u5916\u90e8\u53bb\u64cd\u4f5c Kubernetes \u5c07\u6240\u6709\u63cf\u8ff0 Kubernetes \u8cc7\u6e90\u72c0\u614b\u7684\u6a94\u6848\uff08Yaml/Helm Chart)\u7528 Git \u4fdd\u5b58 Kubernetes \u5167\u6703\u5b89\u88dd\u76f8\u5c0d\u61c9\u7684 controller \u4f86\u76e3\u63a7 Git Repo \u7684\u66f4\u65b0\u4e26\u4e14\u5c07\u4e00\u5207\u7684\u66f4\u65b0\u90fd\u66f4\u65b0\u5230 kubernetes cluster \u5167 (\u53ef\u80fd\u7684\u512a\u52e2)\uff0c\u900f\u904e GitOps \u9019\u7a2e\u67b6\u69cb\uff0cKubernetes Cluster \u672c\u8eab\u4e0d\u9700\u8981\u5c07 API Server \u7684\u5b58\u53d6\u65b9\u5f0f\u7d66\u66b4\u9732\u51fa\u53bb\uff0c\u53ef\u4ee5\u900f\u904e Firewall \u7684\u65b9\u5f0f\u628a\u5e38\u898b\u7684 6443 \u9023\u63a5\u57e0\u7d66\u95dc\u9589\uff0c\u5c0d\u65bc\u5b89\u5168\u6027\u4f86\u8aaa\u4e5f\u662f\u6e1b\u5c11\u4e86\u4e00\u4e9b\u6f5b\u5728\u7684\u554f\u984c\u3002","title":"GitOps"},{"location":"cicd/gitops/#argocd","text":"\u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u63a2\u8a0e\u4e00\u500b\u5be6\u73fe GitOps \u7684\u958b\u6e90\u5c08\u6848 ArgoCD\uff0c\u9019\u908a\u4e0d\u6703\u6709\u592a\u4ed4\u7d30\u7684 Demo \u8207\u64cd\u4f5c\uff0c\u4e3b\u8981\u662f\u91dd\u5c0d\u67b6\u69cb\u4f86\u9032\u884c\u4ecb\u7d39\u3002 ArgoCD \u7684\u67b6\u69cb\u5f15\u7528\u5176\u5b98\u7db2: \u9019\u500b\u67b6\u69cb\u5716\u5206\u6210\u5e7e\u500b\u90e8\u5206\u4f86\u770b\u3002 ArgoCD \u65bc Kubernetes Cluster \u5167\u5b89\u88dd\u7684\u670d\u52d9\uff0c\u9019\u4e9b\u670d\u52d9\u5305\u542b\u4e86 Argo API Server : \u63d0\u4f9b\u4ecb\u9762\u7d66\u5916\u754c\u64cd\u63a7 ArgoCD \u670d\u52d9\uff0c\u672c\u8eab\u63d0\u4f9b\u4e86 CLI, GUI \u4ee5\u53ca gRPC/REST \u7b49\u4ecb\u9762\uff0c\u6700\u7c21\u55ae\u7684 Demo \u53ef\u4ee5\u4f7f\u7528 GUI \u4f86\u64cd\u4f5c\u3002 Repository Service : \u672c\u8eab\u4f5c\u70ba\u4e00\u500b\u9060\u65b9 Git Repo \u7684\u672c\u5730\u5feb\u53d6\uff0c\u4e3b\u8981\u662f\u5132\u5b58\u8a72 Git Repo \u5167\u7684\u8cc7\u6e90\u9810\u671f\u6a94\u6848 (Yaml/Helm Chart) Application Controller : \u8ca0\u8cac\u8ddf Kubernetes \u6e9d\u901a\uff0c\u6703\u6bd4\u8f03 Kubernetes Cluster \u5167\u7684\u904b\u884c\u72c0\u614b (living status) \u4ee5\u53ca Git Repository \u5167\u6240\u63cf\u8ff0\u7684\u8cc7\u6e90\u9810\u671f\u72c0\u614b (Yaml/Helm Chart), \u4e26\u4e14\u66f4\u65b0 Kubernetes Cluster \u4e00\u65e6\u767c\u73fe Git Repository \u5167\u6709\u66f4\u52d5 \u4e0a\u65b9\u7684 Git Repo, \u8a72 Git Repo \u672c\u8eab\u6709\u5169\u7a2e\u65b9\u5f0f\u8207 ArgoCD \u4e92\u52d5 Webhook \u4e3b\u52d5\u544a\u77e5 ArgoCD ArgoCD \u672c\u8eab\u5b9a\u671f\u53bb\u89c0\u5bdf Git Repo \u7684\u72c0\u614b\uff0c\u4e26\u4e14\u4e00\u65e6\u6709\u66f4\u65b0\u5c31\u6703\u8b93 Controller \u4f86\u66f4\u65b0\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f \u5de6\u65b9\u7684\u958b\u767c\u4eba\u54e1/\u7dad\u8b77\u4eba\u54e1\uff0c\u9019\u4e9b\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI/gRPC/REST \u7b49\u65b9\u5f0f\u4f86\u64cd\u4f5c ArgoCD \u7684\u670d\u52d9\u3002 \u958b\u767c\u4eba\u54e1\u53ef\u4ee5\u900f\u904e\u5c0d Git Repo \u7684\u4fee\u6539\u8207\u5408\u4f75\u4f86\u89f8\u767c ArgoCD \u90e8\u7f72\u4eba\u54e1\u53ef\u4ee5\u900f\u904e UI/CLI \u7b49\u65b9\u5f0f\u4f86\u89c0\u5bdf\u8207\u8a2d\u5b9a\u7576\u524d\u61c9\u7528\u7a0b\u5f0f\u7684\u72c0\u614b \u5de6\u4e0b\u65b9\u7684\u662f Hook \u9ede\uff0c ArgoCD \u672c\u8eab\u91dd\u5c0d Git Repo \u66f4\u65b0\u524d\u5f8c\u6709\u63d0\u4f9b\u76f8\u95dc\u7684 Hook\uff0c\u53ef\u4ee5\u5728\u9019\u908a\u5c07\u76f8\u95dc\u7684\u8a0a\u606f\u8207\u5176\u4ed6\u7cfb\u7d71\u929c\u63a5\uff0c\u8b6c\u5982 Slack, Webhook \u7b49\uff0c\u8b93\u4f60\u7684\u7cfb\u7d71\u80fd\u5920\u6709\u8fa6\u6cd5\u63a5\u6536\u5230\u7576\u524d\u90e8\u7f72\u7684\u72c0\u6cc1 \u53f3\u4e0b\u65b9\u5247\u662f\u76ee\u6a19\u7684 Kubernetes Cluster \u5c0d\u65bc ArgoCD \u4f86\u8aaa\uff0c\u672c\u8eab\u8981\u5148\u900f\u904e\u4e00\u5957 Kubernetes \u4f86\u67b6\u8a2d\u670d\u52d9\uff0c\u63a5\u8005\u8a72 ArgoCD \u53ef\u4ee5\u91dd\u5c0d\u4e0d\u540c\u7684 Kuberentes Cluster \u9032\u884c\u8a2d\u5b9a\u8207\u5b58\u53d6\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u5982\u679c\u4f60\u74b0\u5883\u5167\u6709\u591a\u5957 Kubernetes Cluster, \u53ef\u4ee5\u53ea\u7528\u4e00\u5957 ArgoCD \u4f86\u7ba1\u7406\u9019\u4e9b Kubernetes Cluster\uff0c\u5c07\u95dc\u6ce8\u7684 Git Repo \u7d66\u90e8\u7f72\u5230\u4e0d\u540c Kubernetes Cluster \u5167\u7684\u4e0d\u540c namespace \u4e0b\u3002","title":"ArgoCD \u958b\u6e90\u5c08\u6848\u4ecb\u7d39"},{"location":"cicd/gitops/#_2","text":"\u5b98\u7db2\u7684 \u4f7f\u7528\u7bc4\u4f8b , \u6709\u8208\u8da3\u7684\u53ef\u4ee5\u53c3\u8003\u9023\u7d50\u4f86\u8a2d\u5b9a\u73a9\u770b\u770b\uff0c\u57fa\u672c\u4e0a\u5168\u90e8\u90fd\u662f\u57fa\u65bc GUI \u4f86\u9032\u884c\u64cd\u4f5c \u4ee5\u4e0b\u5716\u7247\u90fd\u4f86\u81ea\u5b98\u7db2\u7bc4\u4f8b: \u4e0a\u5716\u7bc4\u4f8b\u5c31\u662f\u5efa\u7acb\u4e00\u500b Application , \u5176\u8ffd\u8e64\u7684 Git Repo \u662f https://github.com/argoproj/argocd-example-apps \uff0c\u4e26\u4e14\u8ffd\u8e64\u7684\u662f\u76ee\u6a19 Repo \u7684 HEAD(latest) branch \u4e0b\u7684 guestbook \u8cc7\u6599\u593e\u5167\u7684\u8cc7\u6e90\u63cf\u8ff0\u6a94\u6848\u3002 \u6b64\u5916\u7576\u6709\u4efb\u4f55\u66f4\u65b0\u7684\u6642\u5019\uff0c\u6703\u5c07\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5f0f\u90e8\u7f72\u5230 https://kubernetes.default.svc \u8a72 API server \u6240\u5c0d\u61c9\u7684 Kubernetes Cluster \u5167\uff0c\u4e26\u4e14\u653e\u5230 default namespace\u3002 ArgoCD \u672c\u8eab\u4e5f\u6703\u900f\u904e GUI \u7684\u65b9\u5f0f\u4f86\u8996\u89ba\u5316\u5448\u73fe\u90e8\u7f72\u7684\u8cc7\u6e90\uff0c\u5305\u542b\u5176\u72c0\u614b\uff0c\u540d\u7a31\u4ee5\u53ca\u5f7c\u6b64\u7684\u95dc\u4fc2\u3002","title":"\u4f7f\u7528\u7bc4\u4f8b"},{"location":"cicd/gitops/#_3","text":"GitOps \u95dc\u6ce8\u7684\u662f\u5982\u4f55\u81ea\u52d5\u5316\u90e8\u7f72(CD)\uff0c\u8ddf CI, Pipeline \u95dc\u4fc2\u4e0d\u5927 GitOps \u8981\u6c42\u7684\u662f\u4ee5 Git Repo \u70ba\u4f86\u6e90\uff0c\u5982\u679c\u8981\u5c0d\u61c9\u7528\u7a0b\u5f0f\u9032\u7248\u6216\u662f\u9000\u7248\uff0c\u90fd\u76f4\u63a5\u5c0d Git \u4fee\u6b63\u5373\u53ef\uff0c\u5f8c\u7e8c\u8b93\u76f8\u95dc\u7684 Controller \u4f86\u5e6b\u5fd9\u540c\u6b65\u8cc7\u6e90\u72c0\u614b \u91dd\u5c0d\u4e0d\u80fd\u5920\u88ab\u5916\u754c\u5b58\u53d6\u7684 Kubernetes Cluster\u4f86\u8aaa\uff0c GitOps \u7684\u6982\u5ff5\u53ef\u4ee5\u89e3\u6c7a\u81ea\u52d5\u90e8\u7f72\u7684\u56f0\u5883\uff0c\u540c\u6642\u4e5f\u80fd\u5920\u6e1b\u5c11\u5916\u6d29 KUBECONFIG \u9019\u500b\u6a94\u6848\u7684\u6f5b\u5728\u6027","title":"\u7e3d\u7d50"},{"location":"coding/dotnet/backend/base/web-api-base/","text":"\u4f7f\u7528 ASP.NET Core \u5275\u5efa Web API \u00b6 \u539f\u6587: Tutorial: Create a web API with ASP.NET Core \u672c\u6559\u7a0b\u6559\u6388\u4f7f\u7528 ASP.NET Core \u69cb\u5efa Web API \u7684\u57fa\u790e\u77e5\u8b58\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5b78\u7fd2\u5982\u4f55\uff1a \u5275\u5efa\u4e00\u500b Web API \u9805\u76ee\u3002 \u6dfb\u52a0\u6a21\u578b\u985e\u548c\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u3002 \u4f7f\u7528 CRUD \u65b9\u6cd5\u69cb\u5efa\u63a7\u5236\u5668\u3002 \u914d\u7f6e\u8def\u7531\u3001URL \u8def\u5f91\u548c\u8fd4\u56de\u503c\u3002 \u4f7f\u7528 http-repl \u8abf\u7528 Web API\u3002 \u6700\u5f8c\uff0c\u60a8\u6709\u4e00\u500b Web API\uff0c\u53ef\u4ee5\u7ba1\u7406\u5b58\u5132\u5728\u6578\u64da\u5eab\u4e2d\u7684\u201c\u5f85\u8fa6\u4e8b\u9805\u201d\u9805\u76ee\u3002 \u6982\u8ff0 \u00b6 \u672c\u6559\u7a0b\u6703\u5275\u5efa\u4ee5\u4e0b API\uff1a API Description Request body Response body GET /api/todoitems Get all to-do items None Array of to-do items GET /api/todoitems/{id} Get an item by ID None To-do item POST /api/todoitems Add a new item To-do item To-do item PUT /api/todoitems/{id} Update an existing item To-do item None DELETE /api/todoitems/{id} Delete an item None None \u4e0b\u5716\u986f\u793a\u4e86\u61c9\u7528\u7a0b\u5e8f\u7684\u8a2d\u8a08\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 Visual Studio Code C# for Visual Studio Code (latest version) .NET 6.0 SDK \u5275\u5efa\u4e00\u500b web \u5c08\u6848 \u00b6 \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a .NET CLI dotnet new webapi -o TodoApi cd TodoApi dotnet add package Microsoft.EntityFrameworkCore.InMemory code -r ../TodoApi \u9019\u4e9b\u547d\u4ee4\uff1a \u5275\u5efa\u4e00\u500b\u65b0\u7684 Web API \u5c08\u6848\u4e26\u5728 Visual Studio Code \u4e2d\u6253\u958b\u5b83 \u6dfb\u52a0\u6240\u9700\u7684 NuGet \u5305 \u9019\u6642\u5019\u5c08\u6848\u76ee\u9304\u61c9\u8a72\u9577\u7684\u50cf: TodoApi/ \u251c\u2500\u2500 appsettings.Development.json \u251c\u2500\u2500 appsettings.json \u251c\u2500\u2500 bin \u2502 \u2514\u2500\u2500 Debug \u2502 \u2514\u2500\u2500 net6.0 \u2502 \u2514\u2500\u2500 ref \u251c\u2500\u2500 Controllers \u2502 \u2514\u2500\u2500 WeatherForecastController.cs \u251c\u2500\u2500 obj \u2502 \u251c\u2500\u2500 Debug \u2502 \u2502 \u2514\u2500\u2500 net6.0 \u2502 \u2502 \u251c\u2500\u2500 project.razor.json \u2502 \u2502 \u251c\u2500\u2500 ref \u2502 \u2502 \u251c\u2500\u2500 staticwebassets \u2502 \u2502 \u251c\u2500\u2500 TodoApi.AssemblyInfo.cs \u2502 \u2502 \u251c\u2500\u2500 TodoApi.AssemblyInfoInputs.cache \u2502 \u2502 \u251c\u2500\u2500 TodoApi.assets.cache \u2502 \u2502 \u251c\u2500\u2500 TodoApi.csproj.AssemblyReference.cache \u2502 \u2502 \u251c\u2500\u2500 TodoApi.GeneratedMSBuildEditorConfig.editorconfig \u2502 \u2502 \u2514\u2500\u2500 TodoApi.GlobalUsings.g.cs \u2502 \u251c\u2500\u2500 project.assets.json \u2502 \u251c\u2500\u2500 project.nuget.cache \u2502 \u251c\u2500\u2500 TodoApi.csproj.nuget.dgspec.json \u2502 \u251c\u2500\u2500 TodoApi.csproj.nuget.g.props \u2502 \u2514\u2500\u2500 TodoApi.csproj.nuget.g.targets \u251c\u2500\u2500 Program.cs \u251c\u2500\u2500 Properties \u2502 \u2514\u2500\u2500 launchSettings.json \u251c\u2500\u2500 TodoApi.csproj \u2514\u2500\u2500 WeatherForecast.cs \u6e2c\u8a66\u5c08\u6848\u57fa\u672c\u7d50\u69cb \u00b6 \u5c08\u6848\u6a21\u677f\u6703\u5275\u5efa\u4e00\u500b\u652f\u6301 Swagger \u7684 WeatherForecast API\u3002 \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\uff1a dotnet run \u7d50\u679c: Building... info: Microsoft.Hosting.Lifetime [ 14 ] Now listening on: https://localhost:7255 info: Microsoft.Hosting.Lifetime [ 14 ] Now listening on: http://localhost:5298 info: Microsoft.Hosting.Lifetime [ 0 ] Application started. Press Ctrl+C to shut down. info: Microsoft.Hosting.Lifetime [ 0 ] Hosting environment: Development info: Microsoft.Hosting.Lifetime [ 0 ] Content root path: /home/dxlab/opt/ws_dotnet/TodoApi/ \u5728\u700f\u89bd\u5668\u4e2d\uff0c\u5c0e\u822a\u5230 https://localhost:<port>/swagger \uff0c\u5176\u4e2d \u662f\u8f38\u51fa\u4e2d\u986f\u793a\u7684\u96a8\u6a5f\u9078\u64c7\u7684\u7aef\u53e3\u865f\u3002 \u4f7f\u7528 curl \u4f86\u6e2c\u8a66\u4e00\u4e0b API: curl -k https://localhost:<port>/weatherforecast | jq \u7d50\u679c: [ { \"date\" : \"2022-09-21T14:19:44.3566076+08:00\" , \"temperatureC\" : -4 , \"temperatureF\" : 25 , \"summary\" : \"Hot\" }, { \"date\" : \"2022-09-22T14:19:44.3566213+08:00\" , \"temperatureC\" : -16 , \"temperatureF\" : 4 , \"summary\" : \"Warm\" }, { \"date\" : \"2022-09-23T14:19:44.356622+08:00\" , \"temperatureC\" : 30 , \"temperatureF\" : 85 , \"summary\" : \"Scorching\" }, { \"date\" : \"2022-09-24T14:19:44.3566224+08:00\" , \"temperatureC\" : 24 , \"temperatureF\" : 75 , \"summary\" : \"Freezing\" }, { \"date\" : \"2022-09-25T14:19:44.3566229+08:00\" , \"temperatureC\" : 3 , \"temperatureF\" : 37 , \"summary\" : \"Cool\" } ] \u6dfb\u52a0 model \u985e\u5225 \u00b6 Model \u662f\u4e00\u7d44\u8868\u793a\u61c9\u7528\u7a0b\u5e8f\u7ba1\u7406\u7684\u6578\u64da\u7684\u985e\u5225\u3002\u6b64\u61c9\u7528\u7a0b\u5e8f\u7684\u6a21\u578b\u662f\u55ae\u500b TodoItem \u985e\u5225 \u3002 \u6dfb\u52a0\u4e00\u500b\u540d\u70ba Models \u7684\u6587\u4ef6\u593e\u3002 \u4f7f\u7528\u4ee5\u4e0b\u4ee3\u78bc\u5c07 TodoItem.cs \u6587\u4ef6\u6dfb\u52a0\u5230 Models \u6587\u4ef6\u593e\uff1a TodoItem.cs namespace TodoApi.Models { public class TodoItem { public long Id { get ; set ; } public string? Name { get ; set ; } public bool IsComplete { get ; set ; } } } Id \u5c6c\u6027\u7528\u4f5c\u95dc\u4fc2\u6578\u64da\u5eab\u4e2d\u7684\u552f\u4e00\u9375\u3002 Model \u985e\u5225\u53ef\u4ee5\u653e\u5728\u9805\u76ee\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\uff0c\u4f46\u6309\u7167\u6163\u4f8b\u4f7f\u7528 Models \u6587\u4ef6\u593e\u3002 \u6dfb\u52a0\u6578\u64da\u5eab\u4e0a\u4e0b\u6587 \u00b6 \u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u662f\u5354\u8abf\u6578\u64da\u6a21\u578b\u7684 Entity Framework \u529f\u80fd\u7684\u4e3b\u8981\u985e\u5225\u3002\u6b64\u985e\u662f\u901a\u904e\u6d3e\u751f\u81ea Microsoft.EntityFrameworkCore.DbContext \u985e\u5225\u800c\u5275\u5efa\u7684\u3002 TodoContext.cs using Microsoft.EntityFrameworkCore ; using System.Diagnostics.CodeAnalysis ; namespace TodoApi.Models { public class TodoContext : DbContext { public TodoContext ( DbContextOptions < TodoContext > options ) : base ( options ) { } public DbSet < TodoItem > TodoItems { get ; set ; } = null !; } } \u8a3b\u518a database context \u00b6 \u5728 ASP.NET Core \u4e2d\uff0cdatabase context\u7b49\u670d\u52d9\u5fc5\u9808\u8a3b\u518a\u5230\u4f9d\u8cf4\u6ce8\u5165 (DI) \u5bb9\u5668\u4e2d\u3002\u5bb9\u5668\u70ba\u63a7\u5236\u5668\u63d0\u4f9b\u670d\u52d9\u3002 \u4f7f\u7528\u4ee5\u4e0b\u4ee3\u78bc\u66f4\u65b0 Program.cs \uff1a Program.cs using Microsoft.EntityFrameworkCore ; using TodoApi.Models ; var builder = WebApplication . CreateBuilder ( args ); // Add services to the container. builder . Services . AddControllers (); builder . Services . AddDbContext < TodoContext >( opt => opt . UseInMemoryDatabase ( \"TodoList\" )); // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle builder . Services . AddEndpointsApiExplorer (); builder . Services . AddSwaggerGen (); var app = builder . Build (); // Configure the HTTP request pipeline. if ( app . Environment . IsDevelopment ()) { app . UseDeveloperExceptionPage (); } app . UseSwagger (); app . UseSwaggerUI (); // remark below line so dotnet api will allow using http & https //app.UseHttpsRedirection(); app . UseAuthorization (); app . MapControllers (); app . Run (); \u5c07\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u6dfb\u52a0\u5230 DI \u5bb9\u5668\u3002 \u6307\u5b9a\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u5c07\u4f7f\u7528\u5167\u5b58\u6578\u64da\u5eab\u3002 \u5275\u5efa controller \u985e\u5225 \u00b6 \u78ba\u4fdd\u60a8\u8fc4\u4eca\u70ba\u6b62\u6240\u505a\u7684\u6240\u6709\u66f4\u6539\u90fd\u5df2\u4fdd\u5b58\u3002 \u5f9e\u9805\u76ee\u6587\u4ef6\u593e\uff0c\u5373 TodoApi \u6587\u4ef6\u593e\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design dotnet add package Microsoft.EntityFrameworkCore.Design dotnet add package Microsoft.EntityFrameworkCore.SqlServer dotnet tool install -g dotnet-aspnet-codegenerator dotnet-aspnet-codegenerator controller -name TodoItemsController -async -api -m TodoItem -dc TodoContext -outDir Controllers \u524d\u9762\u7684\u547d\u4ee4\uff1a \u6dfb\u52a0\u8173\u624b\u67b6\u6240\u9700\u7684 NuGet \u5305\u3002 \u5b89\u88dd\u8173\u624b\u67b6\u5f15\u64ce dotnet-aspnet-codegenerator \u3002 \u751f\u6210 TodoItemsController \u985e\u5225\u3002 \u751f\u6210\u7684\u4ee3\u78bc\uff1a \u7528 [ApiController] \u5c6c\u6027\u6a19\u8a18\u985e\u3002\u6b64\u5c6c\u6027\u6307\u793a\u63a7\u5236\u5668\u97ff\u61c9 Web API \u8acb\u6c42\u3002\u6709\u95dc\u8a72\u5c6c\u6027\u555f\u7528\u7684\u7279\u5b9a\u884c\u70ba\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4f7f\u7528 ASP.NET Core \u5275\u5efa Web API\u3002 \u4f7f\u7528 DI \u5c07\u6578\u64da\u5eab\u4e0a\u4e0b\u6587 (TodoContext) \u6ce8\u5165\u63a7\u5236\u5668\u3002\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u7528\u65bc\u63a7\u5236\u5668\u4e2d\u7684\u6bcf\u500b CRUD \u65b9\u6cd5\u3002 ASP.NET Core \u6a21\u677f\u7528\u65bc\uff1a \u5e36\u6709\u8996\u5716\u7684\u63a7\u5236\u5668\u5728\u8def\u7531\u6a21\u677f\u4e2d\u5305\u542b [action]\u3002 API \u63a7\u5236\u5668\u5728\u8def\u7531\u6a21\u677f\u4e2d\u4e0d\u5305\u542b [action]\u3002 \u7576 [action] \u6a19\u8a18\u4e0d\u5728\u8def\u7531\u6a21\u677f\u4e2d\u6642\uff0c\u64cd\u4f5c\u540d\u7a31\u5c07\u5f9e\u8def\u7531\u4e2d\u6392\u9664\u3002\u4e5f\u5c31\u662f\u8aaa\uff0c\u64cd\u4f5c\u7684\u95dc\u806f\u65b9\u6cd5\u540d\u7a31\u4e0d\u6703\u5728\u5339\u914d\u7684\u8def\u7531\u4e2d\u4f7f\u7528\u3002 \u66f4\u65b0 PostTodoItem \u5275\u5efa\u65b9\u6cd5 \u00b6 \u66f4\u65b0 PostTodoItem \u4e2d\u7684 return \u8a9e\u53e5\u4f86\u4f7f\u7528 nameof \u904b\u7b97\u7b26\uff1a [HttpPost] public async Task < ActionResult < TodoItem >> PostTodoItem ( TodoItem todoItem ) { _context . TodoItems . Add ( todoItem ); await _context . SaveChangesAsync (); //return CreatedAtAction(\"GetTodoItem\", new { id = todoItem.Id }, todoItem); return CreatedAtAction ( nameof ( GetTodoItem ), new { id = todoItem . Id }, todoItem ); } \u4e0a\u8ff0\u4ee3\u78bc\u662f\u4e00\u500b HTTP POST \u65b9\u6cd5\uff0c\u5982 [HttpPost] \u5c6c\u6027\u6240\u793a\u3002\u8a72\u65b9\u6cd5\u5f9e HTTP \u8acb\u6c42\u7684\u6b63\u6587\u4e2d\u7372\u53d6\u5f85\u8fa6\u4e8b\u9805\u7684\u503c\u3002 \u6709\u95dc\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4f7f\u7528 Http[Verb] \u5c6c\u6027\u7684\u5c6c\u6027\u8def\u7531\u3002 CreatedAtAction \u65b9\u6cd5\uff1a \u5982\u679c\u6210\u529f\uff0c\u5247\u8fd4\u56de HTTP 201 \u72c0\u614b\u4ee3\u78bc\u3002 HTTP 201 \u662f\u5728\u670d\u52d9\u5668\u4e0a\u5275\u5efa\u65b0\u8cc7\u6e90\u7684 HTTP POST \u65b9\u6cd5\u7684\u6a19\u6e96\u97ff\u61c9\u3002 \u5c07 Location \u6a19\u982d\u6dfb\u52a0\u5230\u97ff\u61c9\u4e2d\u3002 Location \u6a19\u982d\u6307\u5b9a\u65b0\u5275\u5efa\u7684\u5f85\u8fa6\u4e8b\u9805\u7684 URI\u3002\u6709\u95dc\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 10.2.2 201 \u5df2\u5275\u5efa\u3002 \u5f15\u7528 GetTodoItem \u64cd\u4f5c\u4ee5\u5275\u5efa Location \u6a19\u982d\u7684 URI\u3002 C# nameof \u95dc\u9375\u5b57\u7528\u65bc\u907f\u514d\u5728 CreatedAtAction \u8abf\u7528\u4e2d\u5c0d\u64cd\u4f5c\u540d\u7a31\u9032\u884c\u786c\u7de8\u78bc\u3002 \u4fee\u6539\u555f\u52d5\u914d\u7f6e \u00b6 \u7a0b\u5f0f\u555f\u52d5\u6642\u8a2d\u5b9aAPI\u8981\u8046\u807d\u7684 tcp \u57e0\u865f (port: 5000): appsettings.json { \"Logging\" : { \"LogLevel\" : { \"Default\" : \"Information\" , \"Microsoft.AspNetCore\" : \"Warning\" } }, \"AllowedHosts\" : \"*\" , \"Kestrel\" : { \"Endpoints\" : { \"Http\" : { \"Url\" : \"http://*:5000\" } } } } \u6e2c\u8a66\u5c08\u6848\u57f7\u884c \u00b6 \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\uff1a dotnet run -e Production \u7d50\u679c: Building... warn: Microsoft.AspNetCore.Server.Kestrel [ 0 ] Overriding address ( es ) 'https://localhost:7255, http://localhost:5298' . Binding to endpoints defined via IConfiguration and/or UseKestrel () instead. info: Microsoft.Hosting.Lifetime [ 14 ] Now listening on: http:// [ :: ] :5000 info: Microsoft.Hosting.Lifetime [ 0 ] Application started. Press Ctrl+C to shut down. info: Microsoft.Hosting.Lifetime [ 0 ] Hosting environment: Development info: Microsoft.Hosting.Lifetime [ 0 ] Content root path: /home/dxlab/opt/ws_dotnet/TodoApi/ \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5\u5230 Swagger UI\u4f86\u9032\u884c\u7c21\u6613\u6e2c\u8a66 http://localhost:5000/swagger \u5bb9\u5668\u5316 ASP.NET Application \u00b6 \u5728\u5c07 .NET \u61c9\u7528\u7a0b\u5e8f\u6253\u5305\u6210 Docker \u6620\u50cf\u4e4b\u524d\uff0c\u9996\u5148\u9032\u884c\u61c9\u7528\u7684\u767c\u4f48\u3002\u6700\u597d\u8b93\u5bb9\u5668\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u5df2\u767c\u5e03\u7248\u672c\u3002\u8981\u767c\u4f48 ASP.NET \u61c9\u7528\u7a0b\u5e8f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a dotnet publish -c Release \u7d50\u679c: Microsoft ( R ) Build Engine version 17 .0.0+c9eb9dd64 for .NET Copyright ( C ) Microsoft Corporation. All rights reserved. Determining projects to restore... All projects are up-to-date for restore. TodoApi -> /home/dxlab/opt/ws_dotnet/TodoApi/bin/Release/net6.0/TodoApi.dll TodoApi -> /home/dxlab/opt/ws_dotnet/TodoApi/bin/Release/net6.0/publish/ \u6b64\u547d\u4ee4\u5c07\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7de8\u8b6f\u5230 Release \u6587\u4ef6\u593e\u3002\u5f9e\u5de5\u4f5c\u6587\u4ef6\u593e\u5230\u767c\u5e03\u6587\u4ef6\u593e\u7684\u8def\u5f91\u61c9\u8a72\u662f .\\App\\bin\\Release\\net6.0\\publish\\ \u5275\u5efa Dockerfile \u00b6 docker build \u547d\u4ee4\u4f7f\u7528 Dockerfile \u6587\u4ef6\u4f86\u5275\u5efa\u5bb9\u5668\u6620\u50cf\u3002\u8a72\u6587\u4ef6\u662f\u4e00\u500b\u540d\u70ba Dockerfile \u7684\u6587\u672c\u6587\u4ef6\uff0c\u6c92\u6709\u64f4\u5c55\u540d\u3002 \u5728\u5305\u542b .csproj \u7684\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba Dockerfile \u7684\u6587\u4ef6\uff0c\u7136\u5f8c\u5728\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\u6253\u958b\u5b83\u3002\u672c\u6559\u7a0b\u5c07\u4f7f\u7528 ASP.NET Core runtime\u6620\u50cf\u6a94\u3002 Dockerfile FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build-env WORKDIR /app # Copy everything COPY . ./ # Restore as distinct layers RUN dotnet restore # Build and publish a release RUN dotnet publish -c Release -o out # Build runtime image FROM mcr.microsoft.com/dotnet/aspnet:6.0 WORKDIR /app COPY --from = build-env /app/out . EXPOSE 5000 ENTRYPOINT [ \"dotnet\" , \"TodoApi.dll\" ] FROM \u95dc\u9375\u5b57\u9700\u8981\u6307\u5b9a\u4e00\u500b Docker \u5bb9\u5668\u93e1\u50cf\u540d\u7a31\u3002 Microsoft Container Registry (MCR, mcr.microsoft.com) \u662f Docker Hub \u7684\u4e00\u500b\u806f\u5408\u7d44\u7e54\uff0c\u5b83\u8a17\u7ba1\u53ef\u516c\u958b\u8a2a\u554f\u7684\u5bb9\u5668\u3002 dotnet \u5b57\u6bb5\u662f\u5bb9\u5668\u5b58\u5132\u5eab\uff0c\u800c sdk \u5b57\u6bb5\u662f\u5bb9\u5668\u6620\u50cf\u540d\u7a31\u3002\u8a72\u5bb9\u5668\u93e1\u50cf\u6a19\u6709 6.0\uff0c\u7528\u65bc\u7248\u672c\u63a7\u5236\u3002\u56e0\u6b64\uff0cmcr.microsoft.com/dotnet/aspnet:6.0 \u662f .NET 6.0 \u7684runtime\u3002 \u5f9e\u60a8\u7684\u7d42\u7aef\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a docker build -t donet-todoapi -f Dockerfile . Docker \u5c07\u8655\u7406 Dockerfile \u4e2d\u7684\u6bcf\u4e00\u884c\u6307\u4ee4\u3002 \u5728 docker build \u547d\u4ee4\u4e2d\u8a2d\u7f6e\u93e1\u50cf\u7684\u69cb\u5efa\u4e0a\u4e0b\u6587\u3002 -f \u65d7\u6a19\u6307\u5411 Dockerfile \u7684\u8def\u5f91\u3002\u6b64\u547d\u4ee4\u69cb\u5efa\u6620\u50cf\u4e26\u5275\u5efa\u4e00\u500b\u540d\u70ba donet-todoapi \u7684\u672c\u5730\u5b58\u5132\u5eab\uff0c\u8a72\u5b58\u5132\u5eab\u6307\u5411\u8a72\u6620\u50cf\u3002\u6b64\u547d\u4ee4\u5b8c\u6210\u5f8c\uff0c\u904b\u884c docker images \u4ee5\u67e5\u770b\u5df2\u5b89\u88dd\u7684\u5bb9\u5668\u93e1\u50cf\u5217\u8868\uff1a $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE dotnet-todoapi latest 822362ee2a75 About a minute ago 276MB \u555f\u52d5 Docker \u5bb9\u5668 \u00b6 \u7aef\u53e3\u6620\u5c04\u7528\u65bc\u8a2a\u554f\u5728 Docker \u5bb9\u5668\u5167\u904b\u884c\u7684\u670d\u52d9\u3002\u6211\u5011\u6253\u958b\u4e00\u500b\u4e3b\u6a5f\u7aef\u53e3\uff0c\u8b93\u6211\u5011\u53ef\u4ee5\u8a2a\u554f Docker \u5bb9\u5668\u5167\u76f8\u61c9\u7684\u958b\u653e\u7aef\u53e3\u3002\u7136\u5f8c\u6240\u6709\u5c0d\u4e3b\u6a5f\u7aef\u53e3\u7684\u8acb\u6c42\u90fd\u53ef\u4ee5\u91cd\u5b9a\u5411\u5230 Docker \u5bb9\u5668\u4e2d\u3002 docker run -it --rm -p 5000 :5000 dotnet-todoapi:latest","title":"\u4f7f\u7528 ASP.NET Core \u5275\u5efa Web API"},{"location":"coding/dotnet/backend/base/web-api-base/#aspnet-core-web-api","text":"\u539f\u6587: Tutorial: Create a web API with ASP.NET Core \u672c\u6559\u7a0b\u6559\u6388\u4f7f\u7528 ASP.NET Core \u69cb\u5efa Web API \u7684\u57fa\u790e\u77e5\u8b58\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5b78\u7fd2\u5982\u4f55\uff1a \u5275\u5efa\u4e00\u500b Web API \u9805\u76ee\u3002 \u6dfb\u52a0\u6a21\u578b\u985e\u548c\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u3002 \u4f7f\u7528 CRUD \u65b9\u6cd5\u69cb\u5efa\u63a7\u5236\u5668\u3002 \u914d\u7f6e\u8def\u7531\u3001URL \u8def\u5f91\u548c\u8fd4\u56de\u503c\u3002 \u4f7f\u7528 http-repl \u8abf\u7528 Web API\u3002 \u6700\u5f8c\uff0c\u60a8\u6709\u4e00\u500b Web API\uff0c\u53ef\u4ee5\u7ba1\u7406\u5b58\u5132\u5728\u6578\u64da\u5eab\u4e2d\u7684\u201c\u5f85\u8fa6\u4e8b\u9805\u201d\u9805\u76ee\u3002","title":"\u4f7f\u7528 ASP.NET Core \u5275\u5efa Web API"},{"location":"coding/dotnet/backend/base/web-api-base/#_1","text":"\u672c\u6559\u7a0b\u6703\u5275\u5efa\u4ee5\u4e0b API\uff1a API Description Request body Response body GET /api/todoitems Get all to-do items None Array of to-do items GET /api/todoitems/{id} Get an item by ID None To-do item POST /api/todoitems Add a new item To-do item To-do item PUT /api/todoitems/{id} Update an existing item To-do item None DELETE /api/todoitems/{id} Delete an item None None \u4e0b\u5716\u986f\u793a\u4e86\u61c9\u7528\u7a0b\u5e8f\u7684\u8a2d\u8a08\u3002","title":"\u6982\u8ff0"},{"location":"coding/dotnet/backend/base/web-api-base/#_2","text":"Visual Studio Code C# for Visual Studio Code (latest version) .NET 6.0 SDK","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"coding/dotnet/backend/base/web-api-base/#web","text":"\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a .NET CLI dotnet new webapi -o TodoApi cd TodoApi dotnet add package Microsoft.EntityFrameworkCore.InMemory code -r ../TodoApi \u9019\u4e9b\u547d\u4ee4\uff1a \u5275\u5efa\u4e00\u500b\u65b0\u7684 Web API \u5c08\u6848\u4e26\u5728 Visual Studio Code \u4e2d\u6253\u958b\u5b83 \u6dfb\u52a0\u6240\u9700\u7684 NuGet \u5305 \u9019\u6642\u5019\u5c08\u6848\u76ee\u9304\u61c9\u8a72\u9577\u7684\u50cf: TodoApi/ \u251c\u2500\u2500 appsettings.Development.json \u251c\u2500\u2500 appsettings.json \u251c\u2500\u2500 bin \u2502 \u2514\u2500\u2500 Debug \u2502 \u2514\u2500\u2500 net6.0 \u2502 \u2514\u2500\u2500 ref \u251c\u2500\u2500 Controllers \u2502 \u2514\u2500\u2500 WeatherForecastController.cs \u251c\u2500\u2500 obj \u2502 \u251c\u2500\u2500 Debug \u2502 \u2502 \u2514\u2500\u2500 net6.0 \u2502 \u2502 \u251c\u2500\u2500 project.razor.json \u2502 \u2502 \u251c\u2500\u2500 ref \u2502 \u2502 \u251c\u2500\u2500 staticwebassets \u2502 \u2502 \u251c\u2500\u2500 TodoApi.AssemblyInfo.cs \u2502 \u2502 \u251c\u2500\u2500 TodoApi.AssemblyInfoInputs.cache \u2502 \u2502 \u251c\u2500\u2500 TodoApi.assets.cache \u2502 \u2502 \u251c\u2500\u2500 TodoApi.csproj.AssemblyReference.cache \u2502 \u2502 \u251c\u2500\u2500 TodoApi.GeneratedMSBuildEditorConfig.editorconfig \u2502 \u2502 \u2514\u2500\u2500 TodoApi.GlobalUsings.g.cs \u2502 \u251c\u2500\u2500 project.assets.json \u2502 \u251c\u2500\u2500 project.nuget.cache \u2502 \u251c\u2500\u2500 TodoApi.csproj.nuget.dgspec.json \u2502 \u251c\u2500\u2500 TodoApi.csproj.nuget.g.props \u2502 \u2514\u2500\u2500 TodoApi.csproj.nuget.g.targets \u251c\u2500\u2500 Program.cs \u251c\u2500\u2500 Properties \u2502 \u2514\u2500\u2500 launchSettings.json \u251c\u2500\u2500 TodoApi.csproj \u2514\u2500\u2500 WeatherForecast.cs","title":"\u5275\u5efa\u4e00\u500b web \u5c08\u6848"},{"location":"coding/dotnet/backend/base/web-api-base/#_3","text":"\u5c08\u6848\u6a21\u677f\u6703\u5275\u5efa\u4e00\u500b\u652f\u6301 Swagger \u7684 WeatherForecast API\u3002 \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\uff1a dotnet run \u7d50\u679c: Building... info: Microsoft.Hosting.Lifetime [ 14 ] Now listening on: https://localhost:7255 info: Microsoft.Hosting.Lifetime [ 14 ] Now listening on: http://localhost:5298 info: Microsoft.Hosting.Lifetime [ 0 ] Application started. Press Ctrl+C to shut down. info: Microsoft.Hosting.Lifetime [ 0 ] Hosting environment: Development info: Microsoft.Hosting.Lifetime [ 0 ] Content root path: /home/dxlab/opt/ws_dotnet/TodoApi/ \u5728\u700f\u89bd\u5668\u4e2d\uff0c\u5c0e\u822a\u5230 https://localhost:<port>/swagger \uff0c\u5176\u4e2d \u662f\u8f38\u51fa\u4e2d\u986f\u793a\u7684\u96a8\u6a5f\u9078\u64c7\u7684\u7aef\u53e3\u865f\u3002 \u4f7f\u7528 curl \u4f86\u6e2c\u8a66\u4e00\u4e0b API: curl -k https://localhost:<port>/weatherforecast | jq \u7d50\u679c: [ { \"date\" : \"2022-09-21T14:19:44.3566076+08:00\" , \"temperatureC\" : -4 , \"temperatureF\" : 25 , \"summary\" : \"Hot\" }, { \"date\" : \"2022-09-22T14:19:44.3566213+08:00\" , \"temperatureC\" : -16 , \"temperatureF\" : 4 , \"summary\" : \"Warm\" }, { \"date\" : \"2022-09-23T14:19:44.356622+08:00\" , \"temperatureC\" : 30 , \"temperatureF\" : 85 , \"summary\" : \"Scorching\" }, { \"date\" : \"2022-09-24T14:19:44.3566224+08:00\" , \"temperatureC\" : 24 , \"temperatureF\" : 75 , \"summary\" : \"Freezing\" }, { \"date\" : \"2022-09-25T14:19:44.3566229+08:00\" , \"temperatureC\" : 3 , \"temperatureF\" : 37 , \"summary\" : \"Cool\" } ]","title":"\u6e2c\u8a66\u5c08\u6848\u57fa\u672c\u7d50\u69cb"},{"location":"coding/dotnet/backend/base/web-api-base/#model","text":"Model \u662f\u4e00\u7d44\u8868\u793a\u61c9\u7528\u7a0b\u5e8f\u7ba1\u7406\u7684\u6578\u64da\u7684\u985e\u5225\u3002\u6b64\u61c9\u7528\u7a0b\u5e8f\u7684\u6a21\u578b\u662f\u55ae\u500b TodoItem \u985e\u5225 \u3002 \u6dfb\u52a0\u4e00\u500b\u540d\u70ba Models \u7684\u6587\u4ef6\u593e\u3002 \u4f7f\u7528\u4ee5\u4e0b\u4ee3\u78bc\u5c07 TodoItem.cs \u6587\u4ef6\u6dfb\u52a0\u5230 Models \u6587\u4ef6\u593e\uff1a TodoItem.cs namespace TodoApi.Models { public class TodoItem { public long Id { get ; set ; } public string? Name { get ; set ; } public bool IsComplete { get ; set ; } } } Id \u5c6c\u6027\u7528\u4f5c\u95dc\u4fc2\u6578\u64da\u5eab\u4e2d\u7684\u552f\u4e00\u9375\u3002 Model \u985e\u5225\u53ef\u4ee5\u653e\u5728\u9805\u76ee\u4e2d\u7684\u4efb\u4f55\u4f4d\u7f6e\uff0c\u4f46\u6309\u7167\u6163\u4f8b\u4f7f\u7528 Models \u6587\u4ef6\u593e\u3002","title":"\u6dfb\u52a0 model \u985e\u5225"},{"location":"coding/dotnet/backend/base/web-api-base/#_4","text":"\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u662f\u5354\u8abf\u6578\u64da\u6a21\u578b\u7684 Entity Framework \u529f\u80fd\u7684\u4e3b\u8981\u985e\u5225\u3002\u6b64\u985e\u662f\u901a\u904e\u6d3e\u751f\u81ea Microsoft.EntityFrameworkCore.DbContext \u985e\u5225\u800c\u5275\u5efa\u7684\u3002 TodoContext.cs using Microsoft.EntityFrameworkCore ; using System.Diagnostics.CodeAnalysis ; namespace TodoApi.Models { public class TodoContext : DbContext { public TodoContext ( DbContextOptions < TodoContext > options ) : base ( options ) { } public DbSet < TodoItem > TodoItems { get ; set ; } = null !; } }","title":"\u6dfb\u52a0\u6578\u64da\u5eab\u4e0a\u4e0b\u6587"},{"location":"coding/dotnet/backend/base/web-api-base/#database-context","text":"\u5728 ASP.NET Core \u4e2d\uff0cdatabase context\u7b49\u670d\u52d9\u5fc5\u9808\u8a3b\u518a\u5230\u4f9d\u8cf4\u6ce8\u5165 (DI) \u5bb9\u5668\u4e2d\u3002\u5bb9\u5668\u70ba\u63a7\u5236\u5668\u63d0\u4f9b\u670d\u52d9\u3002 \u4f7f\u7528\u4ee5\u4e0b\u4ee3\u78bc\u66f4\u65b0 Program.cs \uff1a Program.cs using Microsoft.EntityFrameworkCore ; using TodoApi.Models ; var builder = WebApplication . CreateBuilder ( args ); // Add services to the container. builder . Services . AddControllers (); builder . Services . AddDbContext < TodoContext >( opt => opt . UseInMemoryDatabase ( \"TodoList\" )); // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle builder . Services . AddEndpointsApiExplorer (); builder . Services . AddSwaggerGen (); var app = builder . Build (); // Configure the HTTP request pipeline. if ( app . Environment . IsDevelopment ()) { app . UseDeveloperExceptionPage (); } app . UseSwagger (); app . UseSwaggerUI (); // remark below line so dotnet api will allow using http & https //app.UseHttpsRedirection(); app . UseAuthorization (); app . MapControllers (); app . Run (); \u5c07\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u6dfb\u52a0\u5230 DI \u5bb9\u5668\u3002 \u6307\u5b9a\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u5c07\u4f7f\u7528\u5167\u5b58\u6578\u64da\u5eab\u3002","title":"\u8a3b\u518a database context"},{"location":"coding/dotnet/backend/base/web-api-base/#controller","text":"\u78ba\u4fdd\u60a8\u8fc4\u4eca\u70ba\u6b62\u6240\u505a\u7684\u6240\u6709\u66f4\u6539\u90fd\u5df2\u4fdd\u5b58\u3002 \u5f9e\u9805\u76ee\u6587\u4ef6\u593e\uff0c\u5373 TodoApi \u6587\u4ef6\u593e\u4e2d\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design dotnet add package Microsoft.EntityFrameworkCore.Design dotnet add package Microsoft.EntityFrameworkCore.SqlServer dotnet tool install -g dotnet-aspnet-codegenerator dotnet-aspnet-codegenerator controller -name TodoItemsController -async -api -m TodoItem -dc TodoContext -outDir Controllers \u524d\u9762\u7684\u547d\u4ee4\uff1a \u6dfb\u52a0\u8173\u624b\u67b6\u6240\u9700\u7684 NuGet \u5305\u3002 \u5b89\u88dd\u8173\u624b\u67b6\u5f15\u64ce dotnet-aspnet-codegenerator \u3002 \u751f\u6210 TodoItemsController \u985e\u5225\u3002 \u751f\u6210\u7684\u4ee3\u78bc\uff1a \u7528 [ApiController] \u5c6c\u6027\u6a19\u8a18\u985e\u3002\u6b64\u5c6c\u6027\u6307\u793a\u63a7\u5236\u5668\u97ff\u61c9 Web API \u8acb\u6c42\u3002\u6709\u95dc\u8a72\u5c6c\u6027\u555f\u7528\u7684\u7279\u5b9a\u884c\u70ba\u7684\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4f7f\u7528 ASP.NET Core \u5275\u5efa Web API\u3002 \u4f7f\u7528 DI \u5c07\u6578\u64da\u5eab\u4e0a\u4e0b\u6587 (TodoContext) \u6ce8\u5165\u63a7\u5236\u5668\u3002\u6578\u64da\u5eab\u4e0a\u4e0b\u6587\u7528\u65bc\u63a7\u5236\u5668\u4e2d\u7684\u6bcf\u500b CRUD \u65b9\u6cd5\u3002 ASP.NET Core \u6a21\u677f\u7528\u65bc\uff1a \u5e36\u6709\u8996\u5716\u7684\u63a7\u5236\u5668\u5728\u8def\u7531\u6a21\u677f\u4e2d\u5305\u542b [action]\u3002 API \u63a7\u5236\u5668\u5728\u8def\u7531\u6a21\u677f\u4e2d\u4e0d\u5305\u542b [action]\u3002 \u7576 [action] \u6a19\u8a18\u4e0d\u5728\u8def\u7531\u6a21\u677f\u4e2d\u6642\uff0c\u64cd\u4f5c\u540d\u7a31\u5c07\u5f9e\u8def\u7531\u4e2d\u6392\u9664\u3002\u4e5f\u5c31\u662f\u8aaa\uff0c\u64cd\u4f5c\u7684\u95dc\u806f\u65b9\u6cd5\u540d\u7a31\u4e0d\u6703\u5728\u5339\u914d\u7684\u8def\u7531\u4e2d\u4f7f\u7528\u3002","title":"\u5275\u5efa controller \u985e\u5225"},{"location":"coding/dotnet/backend/base/web-api-base/#posttodoitem","text":"\u66f4\u65b0 PostTodoItem \u4e2d\u7684 return \u8a9e\u53e5\u4f86\u4f7f\u7528 nameof \u904b\u7b97\u7b26\uff1a [HttpPost] public async Task < ActionResult < TodoItem >> PostTodoItem ( TodoItem todoItem ) { _context . TodoItems . Add ( todoItem ); await _context . SaveChangesAsync (); //return CreatedAtAction(\"GetTodoItem\", new { id = todoItem.Id }, todoItem); return CreatedAtAction ( nameof ( GetTodoItem ), new { id = todoItem . Id }, todoItem ); } \u4e0a\u8ff0\u4ee3\u78bc\u662f\u4e00\u500b HTTP POST \u65b9\u6cd5\uff0c\u5982 [HttpPost] \u5c6c\u6027\u6240\u793a\u3002\u8a72\u65b9\u6cd5\u5f9e HTTP \u8acb\u6c42\u7684\u6b63\u6587\u4e2d\u7372\u53d6\u5f85\u8fa6\u4e8b\u9805\u7684\u503c\u3002 \u6709\u95dc\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4f7f\u7528 Http[Verb] \u5c6c\u6027\u7684\u5c6c\u6027\u8def\u7531\u3002 CreatedAtAction \u65b9\u6cd5\uff1a \u5982\u679c\u6210\u529f\uff0c\u5247\u8fd4\u56de HTTP 201 \u72c0\u614b\u4ee3\u78bc\u3002 HTTP 201 \u662f\u5728\u670d\u52d9\u5668\u4e0a\u5275\u5efa\u65b0\u8cc7\u6e90\u7684 HTTP POST \u65b9\u6cd5\u7684\u6a19\u6e96\u97ff\u61c9\u3002 \u5c07 Location \u6a19\u982d\u6dfb\u52a0\u5230\u97ff\u61c9\u4e2d\u3002 Location \u6a19\u982d\u6307\u5b9a\u65b0\u5275\u5efa\u7684\u5f85\u8fa6\u4e8b\u9805\u7684 URI\u3002\u6709\u95dc\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 10.2.2 201 \u5df2\u5275\u5efa\u3002 \u5f15\u7528 GetTodoItem \u64cd\u4f5c\u4ee5\u5275\u5efa Location \u6a19\u982d\u7684 URI\u3002 C# nameof \u95dc\u9375\u5b57\u7528\u65bc\u907f\u514d\u5728 CreatedAtAction \u8abf\u7528\u4e2d\u5c0d\u64cd\u4f5c\u540d\u7a31\u9032\u884c\u786c\u7de8\u78bc\u3002","title":"\u66f4\u65b0 PostTodoItem \u5275\u5efa\u65b9\u6cd5"},{"location":"coding/dotnet/backend/base/web-api-base/#_5","text":"\u7a0b\u5f0f\u555f\u52d5\u6642\u8a2d\u5b9aAPI\u8981\u8046\u807d\u7684 tcp \u57e0\u865f (port: 5000): appsettings.json { \"Logging\" : { \"LogLevel\" : { \"Default\" : \"Information\" , \"Microsoft.AspNetCore\" : \"Warning\" } }, \"AllowedHosts\" : \"*\" , \"Kestrel\" : { \"Endpoints\" : { \"Http\" : { \"Url\" : \"http://*:5000\" } } } }","title":"\u4fee\u6539\u555f\u52d5\u914d\u7f6e"},{"location":"coding/dotnet/backend/base/web-api-base/#_6","text":"\u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\uff1a dotnet run -e Production \u7d50\u679c: Building... warn: Microsoft.AspNetCore.Server.Kestrel [ 0 ] Overriding address ( es ) 'https://localhost:7255, http://localhost:5298' . Binding to endpoints defined via IConfiguration and/or UseKestrel () instead. info: Microsoft.Hosting.Lifetime [ 14 ] Now listening on: http:// [ :: ] :5000 info: Microsoft.Hosting.Lifetime [ 0 ] Application started. Press Ctrl+C to shut down. info: Microsoft.Hosting.Lifetime [ 0 ] Hosting environment: Development info: Microsoft.Hosting.Lifetime [ 0 ] Content root path: /home/dxlab/opt/ws_dotnet/TodoApi/ \u4f7f\u7528\u700f\u89bd\u5668\u4f86\u9023\u63a5\u5230 Swagger UI\u4f86\u9032\u884c\u7c21\u6613\u6e2c\u8a66 http://localhost:5000/swagger","title":"\u6e2c\u8a66\u5c08\u6848\u57f7\u884c"},{"location":"coding/dotnet/backend/base/web-api-base/#aspnet-application","text":"\u5728\u5c07 .NET \u61c9\u7528\u7a0b\u5e8f\u6253\u5305\u6210 Docker \u6620\u50cf\u4e4b\u524d\uff0c\u9996\u5148\u9032\u884c\u61c9\u7528\u7684\u767c\u4f48\u3002\u6700\u597d\u8b93\u5bb9\u5668\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u5df2\u767c\u5e03\u7248\u672c\u3002\u8981\u767c\u4f48 ASP.NET \u61c9\u7528\u7a0b\u5e8f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a dotnet publish -c Release \u7d50\u679c: Microsoft ( R ) Build Engine version 17 .0.0+c9eb9dd64 for .NET Copyright ( C ) Microsoft Corporation. All rights reserved. Determining projects to restore... All projects are up-to-date for restore. TodoApi -> /home/dxlab/opt/ws_dotnet/TodoApi/bin/Release/net6.0/TodoApi.dll TodoApi -> /home/dxlab/opt/ws_dotnet/TodoApi/bin/Release/net6.0/publish/ \u6b64\u547d\u4ee4\u5c07\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7de8\u8b6f\u5230 Release \u6587\u4ef6\u593e\u3002\u5f9e\u5de5\u4f5c\u6587\u4ef6\u593e\u5230\u767c\u5e03\u6587\u4ef6\u593e\u7684\u8def\u5f91\u61c9\u8a72\u662f .\\App\\bin\\Release\\net6.0\\publish\\","title":"\u5bb9\u5668\u5316 ASP.NET Application"},{"location":"coding/dotnet/backend/base/web-api-base/#dockerfile","text":"docker build \u547d\u4ee4\u4f7f\u7528 Dockerfile \u6587\u4ef6\u4f86\u5275\u5efa\u5bb9\u5668\u6620\u50cf\u3002\u8a72\u6587\u4ef6\u662f\u4e00\u500b\u540d\u70ba Dockerfile \u7684\u6587\u672c\u6587\u4ef6\uff0c\u6c92\u6709\u64f4\u5c55\u540d\u3002 \u5728\u5305\u542b .csproj \u7684\u76ee\u9304\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba Dockerfile \u7684\u6587\u4ef6\uff0c\u7136\u5f8c\u5728\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\u6253\u958b\u5b83\u3002\u672c\u6559\u7a0b\u5c07\u4f7f\u7528 ASP.NET Core runtime\u6620\u50cf\u6a94\u3002 Dockerfile FROM mcr.microsoft.com/dotnet/sdk:6.0 AS build-env WORKDIR /app # Copy everything COPY . ./ # Restore as distinct layers RUN dotnet restore # Build and publish a release RUN dotnet publish -c Release -o out # Build runtime image FROM mcr.microsoft.com/dotnet/aspnet:6.0 WORKDIR /app COPY --from = build-env /app/out . EXPOSE 5000 ENTRYPOINT [ \"dotnet\" , \"TodoApi.dll\" ] FROM \u95dc\u9375\u5b57\u9700\u8981\u6307\u5b9a\u4e00\u500b Docker \u5bb9\u5668\u93e1\u50cf\u540d\u7a31\u3002 Microsoft Container Registry (MCR, mcr.microsoft.com) \u662f Docker Hub \u7684\u4e00\u500b\u806f\u5408\u7d44\u7e54\uff0c\u5b83\u8a17\u7ba1\u53ef\u516c\u958b\u8a2a\u554f\u7684\u5bb9\u5668\u3002 dotnet \u5b57\u6bb5\u662f\u5bb9\u5668\u5b58\u5132\u5eab\uff0c\u800c sdk \u5b57\u6bb5\u662f\u5bb9\u5668\u6620\u50cf\u540d\u7a31\u3002\u8a72\u5bb9\u5668\u93e1\u50cf\u6a19\u6709 6.0\uff0c\u7528\u65bc\u7248\u672c\u63a7\u5236\u3002\u56e0\u6b64\uff0cmcr.microsoft.com/dotnet/aspnet:6.0 \u662f .NET 6.0 \u7684runtime\u3002 \u5f9e\u60a8\u7684\u7d42\u7aef\uff0c\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a docker build -t donet-todoapi -f Dockerfile . Docker \u5c07\u8655\u7406 Dockerfile \u4e2d\u7684\u6bcf\u4e00\u884c\u6307\u4ee4\u3002 \u5728 docker build \u547d\u4ee4\u4e2d\u8a2d\u7f6e\u93e1\u50cf\u7684\u69cb\u5efa\u4e0a\u4e0b\u6587\u3002 -f \u65d7\u6a19\u6307\u5411 Dockerfile \u7684\u8def\u5f91\u3002\u6b64\u547d\u4ee4\u69cb\u5efa\u6620\u50cf\u4e26\u5275\u5efa\u4e00\u500b\u540d\u70ba donet-todoapi \u7684\u672c\u5730\u5b58\u5132\u5eab\uff0c\u8a72\u5b58\u5132\u5eab\u6307\u5411\u8a72\u6620\u50cf\u3002\u6b64\u547d\u4ee4\u5b8c\u6210\u5f8c\uff0c\u904b\u884c docker images \u4ee5\u67e5\u770b\u5df2\u5b89\u88dd\u7684\u5bb9\u5668\u93e1\u50cf\u5217\u8868\uff1a $ docker images REPOSITORY TAG IMAGE ID CREATED SIZE dotnet-todoapi latest 822362ee2a75 About a minute ago 276MB","title":"\u5275\u5efa Dockerfile"},{"location":"coding/dotnet/backend/base/web-api-base/#docker","text":"\u7aef\u53e3\u6620\u5c04\u7528\u65bc\u8a2a\u554f\u5728 Docker \u5bb9\u5668\u5167\u904b\u884c\u7684\u670d\u52d9\u3002\u6211\u5011\u6253\u958b\u4e00\u500b\u4e3b\u6a5f\u7aef\u53e3\uff0c\u8b93\u6211\u5011\u53ef\u4ee5\u8a2a\u554f Docker \u5bb9\u5668\u5167\u76f8\u61c9\u7684\u958b\u653e\u7aef\u53e3\u3002\u7136\u5f8c\u6240\u6709\u5c0d\u4e3b\u6a5f\u7aef\u53e3\u7684\u8acb\u6c42\u90fd\u53ef\u4ee5\u91cd\u5b9a\u5411\u5230 Docker \u5bb9\u5668\u4e2d\u3002 docker run -it --rm -p 5000 :5000 dotnet-todoapi:latest","title":"\u555f\u52d5 Docker \u5bb9\u5668"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/","text":"\u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u539f\u6587: https://kartaca.com/en/k3s-kubernetes-cluster-setup-with-k3d/ \u5728\u672c\u6587\u4e2d\uff0c\u5c07\u8a0e\u8ad6\u5982\u4f55\u4f7f\u7528 Rancher \u7684\u5de5\u5177 K3D \u5728\u57fa\u65bc Linux \u7684\u64cd\u4f5c\u7cfb\u7d71\u4e2d\u5275\u5efa Kubernetes \u96c6\u7fa4\u3002 K3S (\u8f15\u91cf\u7d1a Kubernetes) \u00b6 K3S \u662f Rancher \u65bc 2019 \u5e74\u958b\u6e90\u767c\u5e03\u7684\u8f15\u91cf\u7d1a Kubernetes \u767c\u884c\u7248\u3002 K3S \u88ab\u8a2d\u8a08\u70ba 100MB \u4ee5\u4e0b\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u3002\u6b64\u5916\uff0c\u5b83\u662f\u4e00\u500b\u64c1\u6709 CNCF\uff08Cloud Native Computing Foundation\uff09\u8b49\u66f8\u7684 Kubernetes \u5de5\u5177\u3002\u7531\u65bc K3S \u7684\u8f15\u91cf\u7d1a\uff0c\u6211\u5011\u751a\u81f3\u53ef\u4ee5\u5728\u914d\u7f6e\u4f4e\u7684\u7cfb\u7d71\u4e2d\u5b89\u88dd Kubernetes \u96c6\u7fa4\u3002 K3S\u7684\u6700\u4f4e\u7cfb\u7d71\u8981\u6c42\u5982\u4e0b\uff1a Linux 3.10 512MB RAM (server) 75MB RAM (node) 200MB range K3D \u00b6 K3D \u662f\u4e00\u500b\u70ba\u6211\u5011\u63d0\u4f9b\u5feb\u901f\u642d\u5efa Kubernetes \u96c6\u7fa4\u7684\u5de5\u5177\u3002\u5275\u5efa K3D \u7684\u96c6\u7fa4\u662f\u8f15\u91cf\u7d1a\u7684\uff0c\u56e0\u70ba\u5b83\u5011\u57fa\u65bc\u6211\u4e0a\u9762\u63d0\u5230\u7684 K3S\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u4f7f\u7528 K3D\uff0c\u6211\u5011\u53ef\u4ee5\u5feb\u901f\u642d\u5efa\u4e00\u500b K3S \u96c6\u7fa4\uff0c\u7528\u6700\u5c11\u7684\u5de5\u4f5c\u91cf\u548c\u6700\u5c11\u7684\u8cc7\u6e90\u4f7f\u7528\u3002\u6b64\u5916\uff0c\u7531\u65bc K3D \u662f\u8de8\u5e73\u53f0\u7684\uff0c\u5b83\u53ef\u4ee5\u5728 Windows\u3001Mac OS \u548c Linux \u8a2d\u5099\u4e0a\u904b\u884c\uff0c\u4e26\u652f\u6301\u5275\u5efa\u591a\u500b\u96c6\u7fa4\u3002 \u5b89\u88dd \u00b6 Requirements\uff1a Docker Kubectl K3D Docker \u8a2d\u5b9a\u5b89\u88dd \u00b6 \u8981\u5feb\u901f\u5b89\u88dd Docker\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Rancher \u6e96\u5099\u7684\u8173\u672c\u548c\u6211\u5728\u4e0b\u9762\u7d66\u51fa\u7684\u547d\u4ee4\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167\u9069\u5408\u4f60\u5c07\u8981\u5b89\u88dd\u7684\u74b0\u5883\u7684\u5b89\u88dd\u6b65\u9a5f\u5f9e\u9019\u500b\u5730\u5740\u5b89\u88dd\u3002 [ Rancher Script ] $ curl https://releases.rancher.com/install-docker/19.03.sh | sh Kubectl \u8a2d\u5b9a\u5b89\u88dd \u00b6 \u60a8\u9700\u8981\u8a2d\u7f6e Kubectl \u4ee5\u8207 Kubernetes API \u901a\u4fe1\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u8f15\u9b06\u5b8c\u6210\u6b64\u64cd\u4f5c\u3002 $ curl -LO \"https://storage.googleapis.com/kubernetes-release/release/ $( curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ) /bin/linux/amd64/kubectl\" $ chmod +x ./kubectl $ sudo mv ./kubectl /usr/local/bin/kubectl \u5728\u5b89\u88dd\u5b8c\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9032\u884c Kubectl \u7248\u672c\u6aa2\u67e5\u3002 $ kubectl version --client K3D \u8a2d\u5b9a\u5b89\u88dd \u00b6 K3D \u8a2d\u7f6e\u975e\u5e38\u7c21\u55ae\uff0c\u60a8\u552f\u4e00\u9700\u8981\u505a\u7684\u5c31\u662f\u5728\u7d42\u7aef\u8f38\u5165\u4ee5\u4e0b\u547d\u4ee4\u3002\u5982\u679c\u60a8\u9858\u610f\uff0c\u53ef\u4ee5\u6839\u64da\u60a8\u7684\u74b0\u5883\u5f9e\u6b64\u5730\u5740\u9032\u884c\u8a2d\u7f6e\u6b65\u9a5f\u3002 $ wget -q -O - https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash \u60a8\u53ef\u4ee5\u901a\u904e\u7248\u672c\u6aa2\u67e5\u4f86\u9a57\u8b49\u60a8\u7684\u8a2d\u7f6e\uff0c\u70ba\u6b64\u60a8\u9700\u8981\u5728\u7d42\u7aef\u4e2d\u8f38\u5165\u4ee5\u4e0b\u6307\u4ee4\u3002 $ k3d --version K3D \u6307\u4ee4 \u00b6 K3D \u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u7684\u6307\u4ee4\u4f86\u5e6b\u52a9\u6211\u5011\u63a7\u5236 Kubernetes \u96c6\u7fa4\u7684\u76f8\u95dc\u8a2d\u5b9a\u8207\u64cd\u4f5c\u3002 $ k3d Usage: k3d [ flags ] k3d [ command ] Available Commands: cluster Manage cluster ( s ) completion Generate completion scripts for [ bash, zsh, fish, powershell | psh ] config Work with config file ( s ) help Help about any command image Handle container images. kubeconfig Manage kubeconfig ( s ) node Manage node ( s ) registry Manage registry/registries version Show k3d and default k3s version Flags: -h, --help help for k3d --timestamps Enable Log timestamps --trace Enable super verbose output ( trace logging ) --verbose Enable verbose output ( debug logging ) --version Show k3d and default k3s version Use \"k3d [command] --help\" for more information about a command. \u4f7f\u7528 k3d cluster \u547d\u4ee4: create \u5275\u5efa\u4e00\u500b\u65b0\u96c6\u7fa4 delete \u522a\u9664\u96c6\u7fa4\u3002 edit [EXPERIMENTAL] \u7de8\u8f2f\u96c6\u7fa4\u3002 list \u5217\u51fa\u96c6\u7fa4 start \u555f\u52d5\u73fe\u6709\u7684 k3d \u96c6\u7fa4 stop \u505c\u6b62\u73fe\u6709\u7684 k3d \u96c6\u7fa4 \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u73fe\u5728\u6211\u5011\u53ef\u4ee5\u7e7c\u7e8c\u9032\u884c\u96c6\u7fa4\u8a2d\u7f6e\u3002\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u540d\u7a31\u5275\u5efa\u96c6\u7fa4\u3002 $ k3d cluster create [ NAME ] \u7531\u65bc\u5b83\u5728\u7b2c\u4e00\u6b21\u5b89\u88dd\u6642\u6703\u4e0b\u8f09\u5927\u7d04 150\u2013200MB \u7684 docker \u6620\u50cf\uff0c\u56e0\u6b64\u5b89\u88dd\u6642\u9593\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7684\u4e92\u806f\u7db2\u901f\u5ea6\uff0c\u4f46\u9664\u975e\u60a8\u522a\u9664\u9019\u4e9b\u6620\u50cf\uff0c\u5426\u5247\u60a8\u7684\u4e0b\u4e00\u6b21\u96c6\u7fa4\u5b89\u88dd\u5c07\u82b1\u8cbb\u66f4\u5c11\u7684\u6642\u9593\u3002 INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .27.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u4f7f\u7528 k3d cluster list \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u5df2\u5275\u5efa\u7684\u96c6\u7fa4\u53ca\u5176\u72c0\u614b\u3002 $ k3d cluster list NAME SERVERS AGENTS LOADBALANCER k3s-default 1 /1 0 /0 true \u5982\u679c\u60a8\u6309\u7167\u9019\u4e9b\u6b65\u9a5f\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd K3D \u4e26\u5728\u6b64\u74b0\u5883\u4e2d\u5275\u5efa\u96c6\u7fa4\uff0c\u5247\u5728\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u6642\u7121\u6cd5\u8a2a\u554f\u6b64\u61c9\u7528\u7a0b\u5e8f\u3002\u56e0\u70ba\u6211\u5011\u4e0d\u5141\u8a31\u4efb\u4f55\u7aef\u53e3\uff0c\u6240\u4ee5\u53ea\u80fd\u5f9e\u96c6\u7fa4\u5167\u90e8\u8a2a\u554f\u5b83\u3002 \u5728\u4e0b\u4e00\u6b65\u4e2d\uff0c\u6211\u5c07\u8a0e\u8ad6\u5982\u4f55\u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 # Deletes all clusters $ k3d cluster delete -a # Deletes specified cluster $ k3d cluster delete [ name ] \u670d\u52d9\u66b4\u9732 \u00b6 \u5728\u4f7f\u7528 K3D \u6642\uff0c\u6211\u5011\u9700\u8981\u9810\u5148\u6253\u958b\u4e00\u500b\u7aef\u53e3\uff0c\u4f46\u5b83\u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u5f88\u591a\u65b9\u6cd5\u3002\u6211\u5011\u53ef\u4ee5\u4f5c\u70ba node-port \u6216\u901a\u904e Load Balancer \u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 K3D \u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e \u00b6 K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer Info the port-mapping construct 8081:80 @loadbalancer means: \u201cmap port 8081 from the host to port 80 on the container which matches the nodefilter loadbalancer\u201c \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u5275\u5efa\u7684\u90e8\u7f72\u3002 $ kubectl create service clusterip nginx --tcp = 80 :80 \u6aa2\u67e5\u7d50\u679c: $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 88s nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 15s \u6210\u529f\u5275\u5efa\u670d\u52d9\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u8a2d\u7f6e\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u73fe\u5728\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u540d\u70ba demo-ingress.yaml \u7684\u6587\u4ef6\u4e26\u7de8\u8f2f\u5176\u5167\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u8a73\u7d30\u7684 ingress \u8a2d\u5b9a\u898f\u5247\u898b: Kubernetes - Ingress demo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"false\" spec : rules : - http : paths : - path : / pathType : Prefix backend : service : name : nginx port : number : 80 \u5728 Kubernetes \u4e0a\u90e8\u7f72 ingress: $ kubectl create -f demo-ingress.yaml \u9019\u6a23\uff0c\u6211\u5011\u5c31\u5b8c\u6210\u4e86\u525b\u525b\u5275\u5efa\u7684\u6f14\u793a nginx \u61c9\u7528\u7684\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u4f7f\u7528 kubectl get pod,svc,ing \u547d\u4ee4\u5275\u5efa\u7684 Kubernetes \u5c0d\u8c61\u3002 $ kubectl get pod,svc,ing NAME READY STATUS RESTARTS AGE pod/nginx-7848d4b86f-xdbfx 1 /1 Running 0 111s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 2m37s service/nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 84s NAME CLASS HOSTS ADDRESS PORTS AGE ingress.networking.k8s.io/nginx <none> * 172 .31.0.2 80 21s \u5982\u679c\u60a8\u6709\u4e0a\u8ff0\u8f38\u51fa\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u5982\u679c\u60a8\u5728\u81ea\u5df1\u7684\u8a08\u7b97\u6a5f\u4e0a\u4f7f\u7528 localhost \u5b8c\u6210\u4e86\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8a2a\u554f nginx \u9801\u9762\uff0c\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b8c\u6210\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u9a57\u8b49\u5b89\u88dd\u3002 $ curl localhost:8081/ K3D NodePort \u8a2d\u7f6e \u00b6 K3D \u9700\u8981\u986f\u793a\u5730\u544a\u8a34\u5b83\u6253\u958b\u67d0\u500b\u7aef\u53e3\u7bc4\u570d\u3002\u8b93\u6211\u7e7c\u7e8c\u4e0b\u9762\u7684\u4f8b\u5b50\u3002 $ k3d cluster create --agents 1 -p 30000-30010:30000-30010@agent:0 -p 8081:80@loadbalancer \u6211\u5011\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e86\u4e00\u500b\u65b0\u53c3\u6578\u3002 Docker \u7528\u6236\u7d93\u5e38\u4f7f\u7528\u201c-p\u201d\uff08\u767c\u5e03\uff09\u53c3\u6578\u3002\u6709\u4e86\u9019\u500b\u53c3\u6578\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6253\u958b\u4e3b\u6a5f\u5bb9\u5668\u7aef\u53e3\u4e86\u3002\u6211\u5011\u5728\u4e0a\u9762\u505a\u4e86\u9019\u500b\uff0c\u5728\u4e3b\u6a5f\u7aef\u548c\u5bb9\u5668\u7aef\u90fd\u6253\u958b\u4e86 30000-30010 \u7aef\u53e3\u7bc4\u570d\u3002(Kubernetes default node port range: 30000\u201332767) Info \u6ce8\u610f\uff1a\u6211\u4e0d\u5efa\u8b70\u914d\u7f6e\u7cfb\u7d71\u6253\u958b 30000-32767 \u7bc4\u570d\uff0c\u56e0\u70ba\u6253\u958b\u7aef\u53e3\u6642 RAM \u4f7f\u7528\u91cf\u6703\u986f\u8457\u589e\u52a0\u3002 \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u4f7f\u7528 nodeport \u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u90e8\u7f72\u7684 nginx \u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba demo-nodeport.yaml \u7684\u6587\u4ef6\u4e26\u6dfb\u52a0\u4ee5\u4e0b\u884c\u4e26\u4fdd\u5b58\u5b83\u3002 demo-nodeport.yaml apiVersion : v1 kind : Service metadata : labels : app : nginx name : nginx spec : ports : - name : 80-80 nodePort : 30008 port : 80 protocol : TCP targetPort : 80 selector : app : nginx type : NodePort \u5728 Kubernetes \u4e0a\u90e8\u7f72 service: $ kubectl create -f demo-nodeport.yaml \u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8207 nodeport \u6240\u6620\u5c04\u7684\u7aef\u53e3\u4f86\u8a2a\u554f nginx \u9801\u9762\u3002 $ curl localhost:30008/","title":"\u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d-kubernetes","text":"\u539f\u6587: https://kartaca.com/en/k3s-kubernetes-cluster-setup-with-k3d/ \u5728\u672c\u6587\u4e2d\uff0c\u5c07\u8a0e\u8ad6\u5982\u4f55\u4f7f\u7528 Rancher \u7684\u5de5\u5177 K3D \u5728\u57fa\u65bc Linux \u7684\u64cd\u4f5c\u7cfb\u7d71\u4e2d\u5275\u5efa Kubernetes \u96c6\u7fa4\u3002","title":"\u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3s-kubernetes","text":"K3S \u662f Rancher \u65bc 2019 \u5e74\u958b\u6e90\u767c\u5e03\u7684\u8f15\u91cf\u7d1a Kubernetes \u767c\u884c\u7248\u3002 K3S \u88ab\u8a2d\u8a08\u70ba 100MB \u4ee5\u4e0b\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u3002\u6b64\u5916\uff0c\u5b83\u662f\u4e00\u500b\u64c1\u6709 CNCF\uff08Cloud Native Computing Foundation\uff09\u8b49\u66f8\u7684 Kubernetes \u5de5\u5177\u3002\u7531\u65bc K3S \u7684\u8f15\u91cf\u7d1a\uff0c\u6211\u5011\u751a\u81f3\u53ef\u4ee5\u5728\u914d\u7f6e\u4f4e\u7684\u7cfb\u7d71\u4e2d\u5b89\u88dd Kubernetes \u96c6\u7fa4\u3002 K3S\u7684\u6700\u4f4e\u7cfb\u7d71\u8981\u6c42\u5982\u4e0b\uff1a Linux 3.10 512MB RAM (server) 75MB RAM (node) 200MB range","title":"K3S (\u8f15\u91cf\u7d1a Kubernetes)"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d","text":"K3D \u662f\u4e00\u500b\u70ba\u6211\u5011\u63d0\u4f9b\u5feb\u901f\u642d\u5efa Kubernetes \u96c6\u7fa4\u7684\u5de5\u5177\u3002\u5275\u5efa K3D \u7684\u96c6\u7fa4\u662f\u8f15\u91cf\u7d1a\u7684\uff0c\u56e0\u70ba\u5b83\u5011\u57fa\u65bc\u6211\u4e0a\u9762\u63d0\u5230\u7684 K3S\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u4f7f\u7528 K3D\uff0c\u6211\u5011\u53ef\u4ee5\u5feb\u901f\u642d\u5efa\u4e00\u500b K3S \u96c6\u7fa4\uff0c\u7528\u6700\u5c11\u7684\u5de5\u4f5c\u91cf\u548c\u6700\u5c11\u7684\u8cc7\u6e90\u4f7f\u7528\u3002\u6b64\u5916\uff0c\u7531\u65bc K3D \u662f\u8de8\u5e73\u53f0\u7684\uff0c\u5b83\u53ef\u4ee5\u5728 Windows\u3001Mac OS \u548c Linux \u8a2d\u5099\u4e0a\u904b\u884c\uff0c\u4e26\u652f\u6301\u5275\u5efa\u591a\u500b\u96c6\u7fa4\u3002","title":"K3D"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#_1","text":"Requirements\uff1a Docker Kubectl K3D","title":"\u5b89\u88dd"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#docker","text":"\u8981\u5feb\u901f\u5b89\u88dd Docker\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Rancher \u6e96\u5099\u7684\u8173\u672c\u548c\u6211\u5728\u4e0b\u9762\u7d66\u51fa\u7684\u547d\u4ee4\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167\u9069\u5408\u4f60\u5c07\u8981\u5b89\u88dd\u7684\u74b0\u5883\u7684\u5b89\u88dd\u6b65\u9a5f\u5f9e\u9019\u500b\u5730\u5740\u5b89\u88dd\u3002 [ Rancher Script ] $ curl https://releases.rancher.com/install-docker/19.03.sh | sh","title":"Docker \u8a2d\u5b9a\u5b89\u88dd"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#kubectl","text":"\u60a8\u9700\u8981\u8a2d\u7f6e Kubectl \u4ee5\u8207 Kubernetes API \u901a\u4fe1\uff0c\u60a8\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u6b65\u9a5f\u8f15\u9b06\u5b8c\u6210\u6b64\u64cd\u4f5c\u3002 $ curl -LO \"https://storage.googleapis.com/kubernetes-release/release/ $( curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ) /bin/linux/amd64/kubectl\" $ chmod +x ./kubectl $ sudo mv ./kubectl /usr/local/bin/kubectl \u5728\u5b89\u88dd\u5b8c\u4e4b\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9032\u884c Kubectl \u7248\u672c\u6aa2\u67e5\u3002 $ kubectl version --client","title":"Kubectl \u8a2d\u5b9a\u5b89\u88dd"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d_1","text":"K3D \u8a2d\u7f6e\u975e\u5e38\u7c21\u55ae\uff0c\u60a8\u552f\u4e00\u9700\u8981\u505a\u7684\u5c31\u662f\u5728\u7d42\u7aef\u8f38\u5165\u4ee5\u4e0b\u547d\u4ee4\u3002\u5982\u679c\u60a8\u9858\u610f\uff0c\u53ef\u4ee5\u6839\u64da\u60a8\u7684\u74b0\u5883\u5f9e\u6b64\u5730\u5740\u9032\u884c\u8a2d\u7f6e\u6b65\u9a5f\u3002 $ wget -q -O - https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash \u60a8\u53ef\u4ee5\u901a\u904e\u7248\u672c\u6aa2\u67e5\u4f86\u9a57\u8b49\u60a8\u7684\u8a2d\u7f6e\uff0c\u70ba\u6b64\u60a8\u9700\u8981\u5728\u7d42\u7aef\u4e2d\u8f38\u5165\u4ee5\u4e0b\u6307\u4ee4\u3002 $ k3d --version","title":"K3D \u8a2d\u5b9a\u5b89\u88dd"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d_2","text":"K3D \u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u7684\u6307\u4ee4\u4f86\u5e6b\u52a9\u6211\u5011\u63a7\u5236 Kubernetes \u96c6\u7fa4\u7684\u76f8\u95dc\u8a2d\u5b9a\u8207\u64cd\u4f5c\u3002 $ k3d Usage: k3d [ flags ] k3d [ command ] Available Commands: cluster Manage cluster ( s ) completion Generate completion scripts for [ bash, zsh, fish, powershell | psh ] config Work with config file ( s ) help Help about any command image Handle container images. kubeconfig Manage kubeconfig ( s ) node Manage node ( s ) registry Manage registry/registries version Show k3d and default k3s version Flags: -h, --help help for k3d --timestamps Enable Log timestamps --trace Enable super verbose output ( trace logging ) --verbose Enable verbose output ( debug logging ) --version Show k3d and default k3s version Use \"k3d [command] --help\" for more information about a command. \u4f7f\u7528 k3d cluster \u547d\u4ee4: create \u5275\u5efa\u4e00\u500b\u65b0\u96c6\u7fa4 delete \u522a\u9664\u96c6\u7fa4\u3002 edit [EXPERIMENTAL] \u7de8\u8f2f\u96c6\u7fa4\u3002 list \u5217\u51fa\u96c6\u7fa4 start \u555f\u52d5\u73fe\u6709\u7684 k3d \u96c6\u7fa4 stop \u505c\u6b62\u73fe\u6709\u7684 k3d \u96c6\u7fa4","title":"K3D \u6307\u4ee4"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#kubernetes","text":"\u73fe\u5728\u6211\u5011\u53ef\u4ee5\u7e7c\u7e8c\u9032\u884c\u96c6\u7fa4\u8a2d\u7f6e\u3002\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u958b\u59cb\u4f7f\u7528\u60a8\u9078\u64c7\u7684\u540d\u7a31\u5275\u5efa\u96c6\u7fa4\u3002 $ k3d cluster create [ NAME ] \u7531\u65bc\u5b83\u5728\u7b2c\u4e00\u6b21\u5b89\u88dd\u6642\u6703\u4e0b\u8f09\u5927\u7d04 150\u2013200MB \u7684 docker \u6620\u50cf\uff0c\u56e0\u6b64\u5b89\u88dd\u6642\u9593\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7684\u4e92\u806f\u7db2\u901f\u5ea6\uff0c\u4f46\u9664\u975e\u60a8\u522a\u9664\u9019\u4e9b\u6620\u50cf\uff0c\u5426\u5247\u60a8\u7684\u4e0b\u4e00\u6b21\u96c6\u7fa4\u5b89\u88dd\u5c07\u82b1\u8cbb\u66f4\u5c11\u7684\u6642\u9593\u3002 INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .27.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u4f7f\u7528 k3d cluster list \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u5df2\u5275\u5efa\u7684\u96c6\u7fa4\u53ca\u5176\u72c0\u614b\u3002 $ k3d cluster list NAME SERVERS AGENTS LOADBALANCER k3s-default 1 /1 0 /0 true \u5982\u679c\u60a8\u6309\u7167\u9019\u4e9b\u6b65\u9a5f\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd K3D \u4e26\u5728\u6b64\u74b0\u5883\u4e2d\u5275\u5efa\u96c6\u7fa4\uff0c\u5247\u5728\u5b89\u88dd\u61c9\u7528\u7a0b\u5e8f\u6642\u7121\u6cd5\u8a2a\u554f\u6b64\u61c9\u7528\u7a0b\u5e8f\u3002\u56e0\u70ba\u6211\u5011\u4e0d\u5141\u8a31\u4efb\u4f55\u7aef\u53e3\uff0c\u6240\u4ee5\u53ea\u80fd\u5f9e\u96c6\u7fa4\u5167\u90e8\u8a2a\u554f\u5b83\u3002 \u5728\u4e0b\u4e00\u6b65\u4e2d\uff0c\u6211\u5c07\u8a0e\u8ad6\u5982\u4f55\u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 # Deletes all clusters $ k3d cluster delete -a # Deletes specified cluster $ k3d cluster delete [ name ]","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#_2","text":"\u5728\u4f7f\u7528 K3D \u6642\uff0c\u6211\u5011\u9700\u8981\u9810\u5148\u6253\u958b\u4e00\u500b\u7aef\u53e3\uff0c\u4f46\u5b83\u70ba\u6211\u5011\u63d0\u4f9b\u4e86\u5f88\u591a\u65b9\u6cd5\u3002\u6211\u5011\u53ef\u4ee5\u4f5c\u70ba node-port \u6216\u901a\u904e Load Balancer \u8a2a\u554f\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002","title":"\u670d\u52d9\u66b4\u9732"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d_3","text":"K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer Info the port-mapping construct 8081:80 @loadbalancer means: \u201cmap port 8081 from the host to port 80 on the container which matches the nodefilter loadbalancer\u201c \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u5275\u5efa\u7684\u90e8\u7f72\u3002 $ kubectl create service clusterip nginx --tcp = 80 :80 \u6aa2\u67e5\u7d50\u679c: $ kubectl get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 88s nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 15s \u6210\u529f\u5275\u5efa\u670d\u52d9\u5f8c\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u8a2d\u7f6e\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u73fe\u5728\u8b93\u6211\u5011\u5275\u5efa\u4e00\u500b\u540d\u70ba demo-ingress.yaml \u7684\u6587\u4ef6\u4e26\u7de8\u8f2f\u5176\u5167\u5bb9\uff0c\u5982\u4e0b\u6240\u793a\u3002 \u8a73\u7d30\u7684 ingress \u8a2d\u5b9a\u898f\u5247\u898b: Kubernetes - Ingress demo-ingress.yaml apiVersion : networking.k8s.io/v1 kind : Ingress metadata : name : nginx annotations : ingress.kubernetes.io/ssl-redirect : \"false\" spec : rules : - http : paths : - path : / pathType : Prefix backend : service : name : nginx port : number : 80 \u5728 Kubernetes \u4e0a\u90e8\u7f72 ingress: $ kubectl create -f demo-ingress.yaml \u9019\u6a23\uff0c\u6211\u5011\u5c31\u5b8c\u6210\u4e86\u525b\u525b\u5275\u5efa\u7684\u6f14\u793a nginx \u61c9\u7528\u7684\u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e\u3002\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u4f7f\u7528 kubectl get pod,svc,ing \u547d\u4ee4\u5275\u5efa\u7684 Kubernetes \u5c0d\u8c61\u3002 $ kubectl get pod,svc,ing NAME READY STATUS RESTARTS AGE pod/nginx-7848d4b86f-xdbfx 1 /1 Running 0 111s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 2m37s service/nginx ClusterIP 10 .43.72.227 <none> 80 /TCP 84s NAME CLASS HOSTS ADDRESS PORTS AGE ingress.networking.k8s.io/nginx <none> * 172 .31.0.2 80 21s \u5982\u679c\u60a8\u6709\u4e0a\u8ff0\u8f38\u51fa\uff0c\u6211\u5011\u73fe\u5728\u53ef\u4ee5\u5c0d\u5176\u9032\u884c\u6e2c\u8a66\u3002\u5982\u679c\u60a8\u5728\u81ea\u5df1\u7684\u8a08\u7b97\u6a5f\u4e0a\u4f7f\u7528 localhost \u5b8c\u6210\u4e86\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8a2a\u554f nginx \u9801\u9762\uff0c\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b8c\u6210\u5b89\u88dd\uff0c\u5247\u53ef\u4ee5\u9a57\u8b49\u5b89\u88dd\u3002 $ curl localhost:8081/","title":"K3D \u8ca0\u8f09\u5747\u8861\u5668\u8a2d\u7f6e"},{"location":"kubernetes/01-getting-started/learning-env/k3d/k3s-kubernetes-cluster-setup-with-k3d/#k3d-nodeport","text":"K3D \u9700\u8981\u986f\u793a\u5730\u544a\u8a34\u5b83\u6253\u958b\u67d0\u500b\u7aef\u53e3\u7bc4\u570d\u3002\u8b93\u6211\u7e7c\u7e8c\u4e0b\u9762\u7684\u4f8b\u5b50\u3002 $ k3d cluster create --agents 1 -p 30000-30010:30000-30010@agent:0 -p 8081:80@loadbalancer \u6211\u5011\u5728\u4e0a\u9762\u7684\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e86\u4e00\u500b\u65b0\u53c3\u6578\u3002 Docker \u7528\u6236\u7d93\u5e38\u4f7f\u7528\u201c-p\u201d\uff08\u767c\u5e03\uff09\u53c3\u6578\u3002\u6709\u4e86\u9019\u500b\u53c3\u6578\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u6253\u958b\u4e3b\u6a5f\u5bb9\u5668\u7aef\u53e3\u4e86\u3002\u6211\u5011\u5728\u4e0a\u9762\u505a\u4e86\u9019\u500b\uff0c\u5728\u4e3b\u6a5f\u7aef\u548c\u5bb9\u5668\u7aef\u90fd\u6253\u958b\u4e86 30000-30010 \u7aef\u53e3\u7bc4\u570d\u3002(Kubernetes default node port range: 30000\u201332767) Info \u6ce8\u610f\uff1a\u6211\u4e0d\u5efa\u8b70\u914d\u7f6e\u7cfb\u7d71\u6253\u958b 30000-32767 \u7bc4\u570d\uff0c\u56e0\u70ba\u6253\u958b\u7aef\u53e3\u6642 RAM \u4f7f\u7528\u91cf\u6703\u986f\u8457\u589e\u52a0\u3002 \u5b89\u88dd\u96c6\u7fa4\u5f8c\uff0c\u8b93\u6211\u5011\u555f\u52d5\u4e00\u500b\u793a\u4f8b Nginx \u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e0b\u9762\u7684 kubectl \u547d\u4ee4\u3002 $ kubectl create deployment nginx --image = nginx --port 80 \u4f7f\u7528\u6b64\u547d\u4ee4\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u70ba 80 \u4e26\u547d\u540d\u70ba demo \u7684 nginx \u6620\u50cf\u3002\u73fe\u5728\uff0c\u8b93\u6211\u5011\u4f7f\u7528 nodeport \u5275\u5efa\u4e00\u500b\u670d\u52d9\u4f86\u8a2a\u554f\u6211\u5011\u90e8\u7f72\u7684 nginx \u61c9\u7528\u7a0b\u5e8f\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba demo-nodeport.yaml \u7684\u6587\u4ef6\u4e26\u6dfb\u52a0\u4ee5\u4e0b\u884c\u4e26\u4fdd\u5b58\u5b83\u3002 demo-nodeport.yaml apiVersion : v1 kind : Service metadata : labels : app : nginx name : nginx spec : ports : - name : 80-80 nodePort : 30008 port : 80 protocol : TCP targetPort : 80 selector : app : nginx type : NodePort \u5728 Kubernetes \u4e0a\u90e8\u7f72 service: $ kubectl create -f demo-nodeport.yaml \u4f7f\u7528\u670d\u52d9\u5668 IP \u5730\u5740\u8207 nodeport \u6240\u6620\u5c04\u7684\u7aef\u53e3\u4f86\u8a2a\u554f nginx \u9801\u9762\u3002 $ curl localhost:30008/","title":"K3D NodePort \u8a2d\u7f6e"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/","text":"\u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube \u00b6 \u539f\u6587: https://www.linuxbuzz.com/how-to-install-minikube-on-ubuntu/ Minikube \u662f\u55ae\u7bc0\u9ede Kubernetes (k8s) \u96c6\u7fa4\uff0c\u53ef\u4ee5\u5b89\u88dd\u5728\u865b\u64ec\u6a5f\u4e2d\u3002\u5b83\u4e00\u822c\u7528\u65bc\u6e2c\u8a66\u548c\u958b\u767c\u74b0\u5883\u3002\u4efb\u4f55\u525b\u63a5\u89f8 Kubernetes \u4e26\u60f3\u5b78\u7fd2\u5b83\u7684\u4eba\u90fd\u5efa\u8b70\u4f7f\u7528 minikube\u3002\u56e0\u70ba\u5b83\u53ef\u4ee5\u975e\u5e38\u5bb9\u6613\u5730\u90e8\u7f72\u5728\u5e7e\u4e4e\u6240\u6709\u7684 Linux \u767c\u884c\u7248\u4e0a\uff0c\u6bd4\u5982 Ubuntu\u3001RHEL\u3001CentOS \u548c Debian\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u5728 Ubuntu 22.04 (Jammy Jellyfish) \u548c Ubuntu 20.04 (Focal Fossa) LTS \u4e0a\u5b89\u88dd Minikube\u3002 ubuntu \u7248\u672c\u4e0a\u7684\u6b65\u9a5f\u662f\u76f8\u540c\u7684\u3002 \u6700\u4f4e\u7cfb\u7d71\u8981\u6c42 \u00b6 2GB RAM \u6216\u66f4\u591a 2\u500bCPU\u6838\u5fc3\u6216\u66f4\u591a 20 GB \u786c\u76e4\u6216\u66f4\u591a \u5177\u6709 Sudo \u6b0a\u9650\u7684\u7528\u6236 Docker \u6216 VirtualBox \u6216 KVM \u7a69\u5b9a\u7684\u4e92\u806f\u7db2\u9023\u63a5 (internet connection) \u8b93\u6211\u5011\u6df1\u5165\u4e86\u89e3 Minikube \u7684\u5b89\u88dd\u6b65\u9a5f\u3002 1. \u5b89\u88dd Minikube \u5305\u4f9d\u8cf4\u9805 \u00b6 \u767b\u9304\u5230\u60a8\u7684 Ubuntu 22.04 / Ubuntu 20.04 \u7cfb\u7d71\u4e26\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u5b89\u88dd minikube \u5305\u4f9d\u8cf4\u9805\u3002 $ sudo apt update $ sudo apt install curl wget apt-transport-https -y Info \u6ce8\u610f\uff1a\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u4f7f\u7528 docker \u4f5c\u70ba Minikube \u7684\u57fa\u790e\uff0c\u4e26\u5047\u8a2d\u60a8\u7684\u7cfb\u7d71\u4e0a\u5df2\u7d93\u5b89\u88dd\u4e86\u5b83\u3002\u5982\u679c\u672a\u5b89\u88dd\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b\u5167\u5bb9\uff1a How to Install Docker on Ubuntu 22.04 / Ubuntu 20.04 LTS 2. \u4f7f\u7528 wget \u4e0b\u8f09 Minikube \u4e8c\u9032\u88fd\u6587\u4ef6 \u00b6 \u5728 wget \u547d\u4ee4\u4e0b\u904b\u884c\u4ee5\u4e0b\u8f09 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\uff0c $ wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \u4f7f\u7528 cp \u547d\u4ee4\u5c07\u4e0b\u8f09\u7684 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\u8907\u88fd\u5230 /usr/local/bin \u4e26\u4e0d\u8981\u5fd8\u8a18\u70ba\u5176\u8a2d\u7f6e\u53ef\u57f7\u884c\u6b0a\u9650\u3002 $ sudo cp minikube-linux-amd64 /usr/local/bin/minikube $ sudo chmod +x /usr/local/bin/minikube \u904b\u884c\u67e5\u770bminikube\u7248\u672c\uff0c $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7 3. \u4e0b\u8f09 kubectl \u00b6 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c CLI\uff0c\u7528\u65bc\u8207 Kubernetes \u96c6\u7fa4\u4ea4\u4e92\u3002\u4f7f\u7528 kubectl \u6211\u5011\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e0d\u540c\u7684\u8cc7\u6e90\u3002 \u8981\u4e0b\u8f09\u4e26\u5b89\u88dd kubectl \uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b wget \u547d\u4ee4\uff0c $ curl -LO https://storage.googleapis.com/kubernetes-release/release/ ` curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ` /bin/linux/amd64/kubectl \u5c07 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u79fb\u52d5\u5230 /usr/local/bin \u4e26\u5c0d\u5176\u8a2d\u7f6e\u57f7\u884c\u6b0a\u9650\u3002 $ chmod +x kubectl $ sudo mv kubectl /usr/local/bin/ \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9a57\u8b49 kubectl \u7248\u672c\uff0c $ kubectl version 4. \u4f7f\u7528 Docker \u9a45\u52d5\u7a0b\u5e8f\u555f\u52d5 Minikube \u00b6 \u7531\u65bc\u6211\u5011\u4f7f\u7528 docker \u4f5c\u70ba minikube \u7684\u57fa\u790e\uff0c\u6240\u4ee5\u904b\u884c\u4ee5\u4e0b minikube \u547d\u4ee4\u4f86\u555f\u52d5\u5b83\u3002 $ minikube start --driver = docker \u7d50\u679c: \ud83d\ude04 minikube v1.25.2 on Ubuntu 21.10 \u2728 Using the docker driver based on user configuration \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udcbe Downloading Kubernetes v1.23.3 preload ... > preloaded-images-k8s-v17-v1...: 505.68 MiB / 505.68 MiB 100.00% 11.91 Mi > gcr.io/k8s-minikube/kicbase: 379.06 MiB / 379.06 MiB 100.00% 8.14 MiB p/ \ud83d\udd25 Creating docker container (CPUs=2, Memory=3900MB) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20.10.12 ... \u25aa kubelet.housekeeping-interval=5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u592a\u597d\u4e86\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d minikube \u5df2\u6210\u529f\u555f\u52d5\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u60f3\u5728\u555f\u52d5 minikube \u6642\u50b3\u905e\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u53c3\u6578\uff0c\u8acb\u4f7f\u7528\u4e0b\u9762\u7684\u7bc4\u4f8b: $ minikube start --addons = ingress --cpus = 4 --cni = flannel --install-addons = true --kubernetes-version = stable --memory = 6g 5. \u9a57\u8b49 Minikube \u548c Kubernetes \u96c6\u7fa4\u72c0\u614b \u00b6 \u8981\u9a57\u8b49 minikube \u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured 6. \u5728 Minikube \u4e0a\u555f\u7528\u63d2\u4ef6 \u00b6 \u7576\u6211\u5011\u5b89\u88dd minikube \u6642\uff0c\u53ea\u555f\u7528\u4e86\u5e7e\u500b\u63d2\u4ef6\u3002\u8981\u67e5\u770b\u6240\u6709\u63d2\u4ef6\u53ca\u5176\u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube addons list | ----------------------------- | ---------- | -------------- | -------------------------------- | | ADDON NAME | PROFILE | STATUS | MAINTAINER | | ----------------------------- | ---------- | -------------- | -------------------------------- | | ambassador | minikube | disabled | third-party ( ambassador ) | | auto-pause | minikube | disabled | google | | csi-hostpath-driver | minikube | disabled | kubernetes | | dashboard | minikube | disabled | kubernetes | | default-storageclass | minikube | enabled \u2705 | kubernetes | | efk | minikube | disabled | third-party ( elastic ) | | freshpod | minikube | disabled | google | | gcp-auth | minikube | disabled | google | | gvisor | minikube | disabled | google | | helm-tiller | minikube | disabled | third-party ( helm ) | | ingress | minikube | disabled | unknown ( third-party ) | | ingress-dns | minikube | disabled | google | | istio | minikube | disabled | third-party ( istio ) | | istio-provisioner | minikube | disabled | third-party ( istio ) | | kong | minikube | disabled | third-party ( Kong HQ ) | | kubevirt | minikube | disabled | third-party ( kubevirt ) | | logviewer | minikube | disabled | unknown ( third-party ) | | metallb | minikube | disabled | third-party ( metallb ) | | metrics-server | minikube | disabled | kubernetes | | nvidia-driver-installer | minikube | disabled | google | | nvidia-gpu-device-plugin | minikube | disabled | third-party ( nvidia ) | | olm | minikube | disabled | third-party ( operator | | | | | framework ) | | pod-security-policy | minikube | disabled | unknown ( third-party ) | | portainer | minikube | disabled | portainer.io | | registry | minikube | disabled | google | | registry-aliases | minikube | disabled | unknown ( third-party ) | | registry-creds | minikube | disabled | third-party ( upmc enterprises ) | | storage-provisioner | minikube | enabled \u2705 | google | | storage-provisioner-gluster | minikube | disabled | unknown ( third-party ) | | volumesnapshots | minikube | disabled | kubernetes | | ----------------------------- | ---------- | -------------- | -------------------------------- | \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable ingress \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f The 'ingress' addon is enabled \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable dashboard \u25aa Using image kubernetesui/metrics-scraper:v1.0.7 \u25aa Using image kubernetesui/dashboard:v2.3.1 \ud83d\udca1 Some dashboard features require the metrics-server addon. To enable all features please run: minikube addons enable metrics-server \ud83c\udf1f The 'dashboard' addon is enabled 7. \u6e2c\u8a66 Kubernetes \u96c6\u7fa4 \u00b6 \u8981\u6e2c\u8a66 Kubernetes \u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u90e8\u7f72\u57fa\u65bc nginx \u7684\u90e8\u7f72\uff0c $ kubectl create deployment myapp --image = nginx --replicas = 2 $ kubectl get deployment myapp NAME READY UP-TO-DATE AVAILABLE AGE myapp 2 /2 2 2 30s \u901a\u904e\u516c\u958b\u90e8\u7f72\u5275\u5efa\u670d\u52d9 $ kubectl expose deployment myapp --type = NodePort --port = 80 service/myapp exposed \u901a\u904e\u904b\u884c\u7372\u53d6\u670d\u52d9 url $ minikube service myapp --url http://192.168.49.2:31258 \u73fe\u5728\u5617\u8a66\u4f7f\u7528 URL \u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff0c $ curl http://192.168.49.2:31258 \u5b8c\u7f8e\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d\u6211\u5011\u53ef\u4ee5\u8a2a\u554f nginx \u7db2\u9801\u3002 8. \u8a2a\u554f Kubernetes \u5100\u8868\u677f \u00b6 \u8981\u8a2a\u554f Kubernetes \u5100\u8868\u677f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4 $ minikube dashboard --url \ud83e\udd14 Verifying dashboard health ... \ud83d\ude80 Launching proxy ... \ud83e\udd14 Verifying proxy health ... http://127.0.0.1:44153/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ \u55ae\u64ca\u8f38\u51fa\u4e2d\u986f\u793a\u7684 url\uff0c\u5b83\u5c07\u6253\u958b Kubernetes \u5100\u8868\u677f\uff0c 9. \u7ba1\u7406 Minikube \u96c6\u7fa4 \u00b6 \u8981\u505c\u6b62 minikube\uff0c\u8acb\u904b\u884c $ minikube stop \u8981\u555f\u52d5 minikube\uff0c\u8acb\u904b\u884c $ minikube start \u522a\u9664minikube\u96c6\u7fa4\uff0c\u5148\u505c\u6b62\u518d\u522a\u9664 $ minikube delete","title":"\u5982\u4f55\u5728 Ubuntu 20.04 \u4e0a\u5b89\u88dd Minikube"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#ubuntu-2004-lts-minikube","text":"\u539f\u6587: https://www.linuxbuzz.com/how-to-install-minikube-on-ubuntu/ Minikube \u662f\u55ae\u7bc0\u9ede Kubernetes (k8s) \u96c6\u7fa4\uff0c\u53ef\u4ee5\u5b89\u88dd\u5728\u865b\u64ec\u6a5f\u4e2d\u3002\u5b83\u4e00\u822c\u7528\u65bc\u6e2c\u8a66\u548c\u958b\u767c\u74b0\u5883\u3002\u4efb\u4f55\u525b\u63a5\u89f8 Kubernetes \u4e26\u60f3\u5b78\u7fd2\u5b83\u7684\u4eba\u90fd\u5efa\u8b70\u4f7f\u7528 minikube\u3002\u56e0\u70ba\u5b83\u53ef\u4ee5\u975e\u5e38\u5bb9\u6613\u5730\u90e8\u7f72\u5728\u5e7e\u4e4e\u6240\u6709\u7684 Linux \u767c\u884c\u7248\u4e0a\uff0c\u6bd4\u5982 Ubuntu\u3001RHEL\u3001CentOS \u548c Debian\u3002 \u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u5728 Ubuntu 22.04 (Jammy Jellyfish) \u548c Ubuntu 20.04 (Focal Fossa) LTS \u4e0a\u5b89\u88dd Minikube\u3002 ubuntu \u7248\u672c\u4e0a\u7684\u6b65\u9a5f\u662f\u76f8\u540c\u7684\u3002","title":"\u5982\u4f55\u5728 Ubuntu 20.04 LTS \u4e0a\u5b89\u88dd Minikube"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#_1","text":"2GB RAM \u6216\u66f4\u591a 2\u500bCPU\u6838\u5fc3\u6216\u66f4\u591a 20 GB \u786c\u76e4\u6216\u66f4\u591a \u5177\u6709 Sudo \u6b0a\u9650\u7684\u7528\u6236 Docker \u6216 VirtualBox \u6216 KVM \u7a69\u5b9a\u7684\u4e92\u806f\u7db2\u9023\u63a5 (internet connection) \u8b93\u6211\u5011\u6df1\u5165\u4e86\u89e3 Minikube \u7684\u5b89\u88dd\u6b65\u9a5f\u3002","title":"\u6700\u4f4e\u7cfb\u7d71\u8981\u6c42"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#1-minikube","text":"\u767b\u9304\u5230\u60a8\u7684 Ubuntu 22.04 / Ubuntu 20.04 \u7cfb\u7d71\u4e26\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4f86\u5b89\u88dd minikube \u5305\u4f9d\u8cf4\u9805\u3002 $ sudo apt update $ sudo apt install curl wget apt-transport-https -y Info \u6ce8\u610f\uff1a\u5728\u672c\u6307\u5357\u4e2d\uff0c\u6211\u4f7f\u7528 docker \u4f5c\u70ba Minikube \u7684\u57fa\u790e\uff0c\u4e26\u5047\u8a2d\u60a8\u7684\u7cfb\u7d71\u4e0a\u5df2\u7d93\u5b89\u88dd\u4e86\u5b83\u3002\u5982\u679c\u672a\u5b89\u88dd\uff0c\u8acb\u53c3\u95b1\u4ee5\u4e0b\u5167\u5bb9\uff1a How to Install Docker on Ubuntu 22.04 / Ubuntu 20.04 LTS","title":"1. \u5b89\u88dd Minikube \u5305\u4f9d\u8cf4\u9805"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#2-wget-minikube","text":"\u5728 wget \u547d\u4ee4\u4e0b\u904b\u884c\u4ee5\u4e0b\u8f09 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\uff0c $ wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 \u4f7f\u7528 cp \u547d\u4ee4\u5c07\u4e0b\u8f09\u7684 minikube \u4e8c\u9032\u88fd\u6587\u4ef6\u8907\u88fd\u5230 /usr/local/bin \u4e26\u4e0d\u8981\u5fd8\u8a18\u70ba\u5176\u8a2d\u7f6e\u53ef\u57f7\u884c\u6b0a\u9650\u3002 $ sudo cp minikube-linux-amd64 /usr/local/bin/minikube $ sudo chmod +x /usr/local/bin/minikube \u904b\u884c\u67e5\u770bminikube\u7248\u672c\uff0c $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7","title":"2. \u4f7f\u7528 wget \u4e0b\u8f09 Minikube \u4e8c\u9032\u88fd\u6587\u4ef6"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#3-kubectl","text":"kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c CLI\uff0c\u7528\u65bc\u8207 Kubernetes \u96c6\u7fa4\u4ea4\u4e92\u3002\u4f7f\u7528 kubectl \u6211\u5011\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u90e8\u7f72\u4e0d\u540c\u7684\u8cc7\u6e90\u3002 \u8981\u4e0b\u8f09\u4e26\u5b89\u88dd kubectl \uff0c\u8acb\u4f7f\u7528\u4ee5\u4e0b wget \u547d\u4ee4\uff0c $ curl -LO https://storage.googleapis.com/kubernetes-release/release/ ` curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt ` /bin/linux/amd64/kubectl \u5c07 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u79fb\u52d5\u5230 /usr/local/bin \u4e26\u5c0d\u5176\u8a2d\u7f6e\u57f7\u884c\u6b0a\u9650\u3002 $ chmod +x kubectl $ sudo mv kubectl /usr/local/bin/ \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u9a57\u8b49 kubectl \u7248\u672c\uff0c $ kubectl version","title":"3. \u4e0b\u8f09 kubectl"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#4-docker-minikube","text":"\u7531\u65bc\u6211\u5011\u4f7f\u7528 docker \u4f5c\u70ba minikube \u7684\u57fa\u790e\uff0c\u6240\u4ee5\u904b\u884c\u4ee5\u4e0b minikube \u547d\u4ee4\u4f86\u555f\u52d5\u5b83\u3002 $ minikube start --driver = docker \u7d50\u679c: \ud83d\ude04 minikube v1.25.2 on Ubuntu 21.10 \u2728 Using the docker driver based on user configuration \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udcbe Downloading Kubernetes v1.23.3 preload ... > preloaded-images-k8s-v17-v1...: 505.68 MiB / 505.68 MiB 100.00% 11.91 Mi > gcr.io/k8s-minikube/kicbase: 379.06 MiB / 379.06 MiB 100.00% 8.14 MiB p/ \ud83d\udd25 Creating docker container (CPUs=2, Memory=3900MB) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20.10.12 ... \u25aa kubelet.housekeeping-interval=5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u592a\u597d\u4e86\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d minikube \u5df2\u6210\u529f\u555f\u52d5\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u60f3\u5728\u555f\u52d5 minikube \u6642\u50b3\u905e\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u53c3\u6578\uff0c\u8acb\u4f7f\u7528\u4e0b\u9762\u7684\u7bc4\u4f8b: $ minikube start --addons = ingress --cpus = 4 --cni = flannel --install-addons = true --kubernetes-version = stable --memory = 6g","title":"4. \u4f7f\u7528 Docker \u9a45\u52d5\u7a0b\u5e8f\u555f\u52d5 Minikube"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#5-minikube-kubernetes","text":"\u8981\u9a57\u8b49 minikube \u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured","title":"5. \u9a57\u8b49 Minikube \u548c Kubernetes \u96c6\u7fa4\u72c0\u614b"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#6-minikube","text":"\u7576\u6211\u5011\u5b89\u88dd minikube \u6642\uff0c\u53ea\u555f\u7528\u4e86\u5e7e\u500b\u63d2\u4ef6\u3002\u8981\u67e5\u770b\u6240\u6709\u63d2\u4ef6\u53ca\u5176\u72c0\u614b\uff0c\u8acb\u904b\u884c $ minikube addons list | ----------------------------- | ---------- | -------------- | -------------------------------- | | ADDON NAME | PROFILE | STATUS | MAINTAINER | | ----------------------------- | ---------- | -------------- | -------------------------------- | | ambassador | minikube | disabled | third-party ( ambassador ) | | auto-pause | minikube | disabled | google | | csi-hostpath-driver | minikube | disabled | kubernetes | | dashboard | minikube | disabled | kubernetes | | default-storageclass | minikube | enabled \u2705 | kubernetes | | efk | minikube | disabled | third-party ( elastic ) | | freshpod | minikube | disabled | google | | gcp-auth | minikube | disabled | google | | gvisor | minikube | disabled | google | | helm-tiller | minikube | disabled | third-party ( helm ) | | ingress | minikube | disabled | unknown ( third-party ) | | ingress-dns | minikube | disabled | google | | istio | minikube | disabled | third-party ( istio ) | | istio-provisioner | minikube | disabled | third-party ( istio ) | | kong | minikube | disabled | third-party ( Kong HQ ) | | kubevirt | minikube | disabled | third-party ( kubevirt ) | | logviewer | minikube | disabled | unknown ( third-party ) | | metallb | minikube | disabled | third-party ( metallb ) | | metrics-server | minikube | disabled | kubernetes | | nvidia-driver-installer | minikube | disabled | google | | nvidia-gpu-device-plugin | minikube | disabled | third-party ( nvidia ) | | olm | minikube | disabled | third-party ( operator | | | | | framework ) | | pod-security-policy | minikube | disabled | unknown ( third-party ) | | portainer | minikube | disabled | portainer.io | | registry | minikube | disabled | google | | registry-aliases | minikube | disabled | unknown ( third-party ) | | registry-creds | minikube | disabled | third-party ( upmc enterprises ) | | storage-provisioner | minikube | enabled \u2705 | google | | storage-provisioner-gluster | minikube | disabled | unknown ( third-party ) | | volumesnapshots | minikube | disabled | kubernetes | | ----------------------------- | ---------- | -------------- | -------------------------------- | \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable ingress \u25aa Using image k8s.gcr.io/ingress-nginx/controller:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \u25aa Using image k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1 \ud83d\udd0e Verifying ingress addon... \ud83c\udf1f The 'ingress' addon is enabled \u8981\u555f\u7528 ingress \u63d2\u4ef6\uff0c\u8acb\u904b\u884c $ minikube addons enable dashboard \u25aa Using image kubernetesui/metrics-scraper:v1.0.7 \u25aa Using image kubernetesui/dashboard:v2.3.1 \ud83d\udca1 Some dashboard features require the metrics-server addon. To enable all features please run: minikube addons enable metrics-server \ud83c\udf1f The 'dashboard' addon is enabled","title":"6. \u5728 Minikube \u4e0a\u555f\u7528\u63d2\u4ef6"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#7-kubernetes","text":"\u8981\u6e2c\u8a66 Kubernetes \u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u90e8\u7f72\u57fa\u65bc nginx \u7684\u90e8\u7f72\uff0c $ kubectl create deployment myapp --image = nginx --replicas = 2 $ kubectl get deployment myapp NAME READY UP-TO-DATE AVAILABLE AGE myapp 2 /2 2 2 30s \u901a\u904e\u516c\u958b\u90e8\u7f72\u5275\u5efa\u670d\u52d9 $ kubectl expose deployment myapp --type = NodePort --port = 80 service/myapp exposed \u901a\u904e\u904b\u884c\u7372\u53d6\u670d\u52d9 url $ minikube service myapp --url http://192.168.49.2:31258 \u73fe\u5728\u5617\u8a66\u4f7f\u7528 URL \u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff0c $ curl http://192.168.49.2:31258 \u5b8c\u7f8e\uff0c\u4ee5\u4e0a\u8f38\u51fa\u78ba\u8a8d\u6211\u5011\u53ef\u4ee5\u8a2a\u554f nginx \u7db2\u9801\u3002","title":"7. \u6e2c\u8a66 Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#8-kubernetes","text":"\u8981\u8a2a\u554f Kubernetes \u5100\u8868\u677f\uff0c\u8acb\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4 $ minikube dashboard --url \ud83e\udd14 Verifying dashboard health ... \ud83d\ude80 Launching proxy ... \ud83e\udd14 Verifying proxy health ... http://127.0.0.1:44153/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ \u55ae\u64ca\u8f38\u51fa\u4e2d\u986f\u793a\u7684 url\uff0c\u5b83\u5c07\u6253\u958b Kubernetes \u5100\u8868\u677f\uff0c","title":"8. \u8a2a\u554f Kubernetes \u5100\u8868\u677f"},{"location":"kubernetes/01-getting-started/learning-env/minikube/how-to-install-minikube-on-ubuntu/#9-minikube","text":"\u8981\u505c\u6b62 minikube\uff0c\u8acb\u904b\u884c $ minikube stop \u8981\u555f\u52d5 minikube\uff0c\u8acb\u904b\u884c $ minikube start \u522a\u9664minikube\u96c6\u7fa4\uff0c\u5148\u505c\u6b62\u518d\u522a\u9664 $ minikube delete","title":"9. \u7ba1\u7406 Minikube \u96c6\u7fa4"},{"location":"kubernetes/02-concepts/01-overview/k8s-intro/","text":"Kubernetes \u5bb9\u5668\u5e73\u81fa\u4ecb\u8a54 \u00b6 \u4f5c\u8005: \u5de8\u5b50\u5609 \u539f\u6587: Kubernetes\u5bb9\u5668\u5e73\u81fa ]( https://www.gushiciku.cn/dl/18xaG/zh-tw ) \u5bb9\u5668\u6280\u8853\u6b63\u5728\u985b\u8986\u50b3\u7d71\uff0c\u91cd\u69cb\u6574\u500b\u8edf\u9ad4\u4e16\u754c \uff0c\u6539\u8b8a\u8edf\u9ad4\u6280\u8853\u67b6\u69cb\uff0c\u5718\u968a\u4ea4\u4ed8\u6548\u7387\u4ee5\u53ca\u4ea4\u4ed8\u65b9\u5f0f\u3002\u901a\u904e\u906e\u853d\u5e95\u5c64\u8907\u96dc\u7570\u69cb\u7684\u57fa\u790e\u8a2d\u65bd\u74b0\u5883\uff0c\u4fdd\u969c\u8edf\u9ad4\u4e00\u81f4\u6027\u57f7\u884c\u6642\u74b0\u5883\uff0c\u8b93\u7814\u767c\u4eba\u54e1\u66f4\u52a0\u9ad8\u6548\u5730\u805a\u7126\u5728\u696d\u52d9\u908f\u8f2f\u3002 \u96d6\u7136 \u5bb9\u5668\u901a\u904e\u985b\u8986\u5f0f\u5275\u65b0\u906e\u853d\u5e95\u5c64\u8907\u96dc\u6027 \uff0c \u4f46\u662f\u5c0d\u5bb9\u5668\u90e8\u7f72\u904b\u7dad\uff0c\u7d66\u5bb9\u5668\u53e2\u96c6\u672c\u8eab\u7684\u904b\u7dad\u5718\u968a\u5e36\u4f86\u4e86\u65b0\u7684\u6311\u6230 \u3002\u8207\u50b3\u7d71\u865b\u64ec\u6a5f\u5668\u76f8\u6bd4\uff0c\u6975\u77ed\u7684\u90e8\u7f72\u57f7\u884c\u9031\u671f\uff0c\u66f4\u9ad8\u6548\u7684\u8cc7\u6e90\u4f7f\u7528\u7387\u3002\u5bb9\u5668\u7ba1\u7406\u8457\u6d77\u91cf\u7684\u5feb\u9031\u671f\u8f2a\u8f49\u7684\u7269\u4ef6\uff0c\u8981\u6c42\u66f4\u5fb9\u5e95\u7684\u81ea\u52d5\u5316\uff0c\u7b56\u7565\u555f\u52d5\u7684\u7ba1\u7406\u80fd\u529b\u3002 \u8a31\u591a\u5718\u968a\u90fd\u958b\u59cb\u8f49\u5411 Kubernetes \u5bb9\u5668\uff0c\u901a\u904e\u5bb9\u5668\u7de8\u6392\u53ca\u7ba1\u7406\u80fd\u529b\uff0c\u8f15\u9b06\u7dad\u8b77\u751f\u7522\u3001\u958b\u767c\u548c\u6e2c\u8a66\u74b0\u5883\uff0cKubernetes \u5df2\u6210\u70ba\u5bb9\u5668\u7de8\u6392\u548c\u7ba1\u7406\u7684\u4e8b\u5be6\u6a19\u6e96\uff0c\u4f01\u696d\u8981\u610f\u8b58\u5230 \u5bb9\u5668\u5c07\u6210\u70ba\u672a\u4f86\u95dc\u9375\u7684\u57fa\u790e\u8a2d\u65bd\u5e73\u81fa \u3002 Kubernetes \u5bb9\u5668\u5e73\u81fa \u00b6 \u5bb9\u5668\u662f\u65b0\u578b\u7684\u8f15\u91cf\u7d1a\u865b\u64ec\u5316 Kubernetes \u662f\u4e00\u500b\u958b\u6e90\u5bb9\u5668\u7de8\u6392\u5e73\u81fa\uff0c\u7ba1\u7406\u5927\u898f\u6a21\u5206\u6563\u5f0f\u5bb9\u5668\u5316\u8edf\u9ad4\u61c9\u7528\uff0cKubernetes \u63d0\u4f9b\u4e86\u7d71\u4e00\u7684 API \u4ecb\u9762\uff0c\u547c\u53eb API \u53ef\u662f\u8f15\u9b06\u5be6\u73fe Web \u61c9\u7528\u3001\u6279\u8655\u7406\u4f5c\u696d\u548c\u8cc7\u6599\u5eab\u7684\u90e8\u7f72\u3002 Kubernetes \u4e2d\u7684\u8edf\u9ad4\u61c9\u7528\u88ab\u6253\u5305\u6210\u8207\u74b0\u5883\u5b8c\u5168\u5206\u96e2\u7684\u5bb9\u5668\u6620\u8c61\uff0cKubernetes\u6703\u81ea\u52d5\u914d\u7f6e\u61c9\u7528\u4e26\u7dad\u8b77\u8ddf\u8e64\u8cc7\u6e90\u5206\u914d\u3002 Kubernetes \u662f\u8c37\u6b4c\u7684\u7b2c\u4e09\u4ee3\u5bb9\u5668\u7ba1\u7406\u7cfb\u7d71\uff0c\u662f Borg \u7368\u7279\u7684\u63a7\u5236\u5668\u548c Omega \u9748\u6d3b\u7684\u6392\u7a0b\u5668\u7684\u7d44\u5408\u3002\u76f8\u8f03\u50b3\u7d71VM\u865b\u64ec\u5316\uff0c\u5bb9\u5668\u662f\u8f15\u91cf\u7d1a\u865b\u64ec\u5316\u6280\u8853\uff0c\u5c0d\u8edf\u9ad4\u61c9\u7528\u800c\u8a00\uff0c\u5bb9\u5668\u5e36\u4f86\u4e00\u4e0b\u50f9\u503c\uff1a \u66f4\u654f\u6377\u7684\u4ea4\u4ed8\u6548\u7387\uff0c\u91cb\u653e\u7814\u767c\u4eba\u54e1\u8017\u8cbb\u5728\u74b0\u5883\u9664\u932f\u904e\u7a0b\uff0c\u66f4\u52a0\u805a\u7126\u696d\u52d9\u672c\u8eab\u908f\u8f2f \u66f4\u4f4e\u7684\u4f3a\u670d\u5668\u8cc7\u6e90\u6210\u672c\uff0c\u5bb9\u5668\u5316\u57f7\u884c\u53ef\u4ee5\u5927\u5e45\u63d0\u5347\u5e95\u5c64\u57fa\u790e\u8cc7\u6e90\u7684\u4f7f\u7528\u6548\u7387\u3002 \u66f4\u5927\u7bc4\u570d\u7684\u5dee\u7570\u5316\u8a2d\u65bd\u62bd\u8c61\u7d71\u4e00\uff0c\u5bb9\u5668\u9069\u914d\u80fd\u529b\u66f4\u5f37\uff0c\u5bb9\u5668\u5e7e\u4e4e\u53ef\u4ee5\u57f7\u884c\u5e02\u9762\u4e0a\u6240\u6709\u5e38\u898b\u88dd\u7f6e\u3002 \u5fae\u670d\u52d9\u67b6\u69cb \u662f\u7576\u524d\u6700\u70ba\u6d41\u884c\u7684\u8edf\u9ad4\u67b6\u69cb\uff0c\u63d0\u5021\u6a21\u7d44\u5316\uff0c\u677e\u8026\u5408\u7684\u8a2d\u8a08\u7406\u5ff5\uff0c\u4e00\u822c\u4e2d\u7b49\u5fae\u670d\u52d9\u67b6\u69cb\u5c08\u6848\uff0c\u6a21\u7d44\u6578\u91cf\u53ef\u9054\u5e7e\u5341\u5230\u4e0a\u767e\u7684\u898f\u6a21\uff0c\u901a\u904e\u624b\u5de5\u90e8\u7f72\u904b\u7dad\u5e7e\u4e4e\u4e0d\u80af\u80fd\uff1b\u91dd\u5c0d\u9019\u7a2e\u8907\u96dc\u61c9\u7528\u7a0b\u5f0f\uff0c\u5c24\u5176\u662f\u5143\u4ef6\u6578\u91cf\u6bd4\u8f03\u591a\u7684\u5834\u666f\uff0c\u5bb9\u5668Kubernetes\u6975\u5927\u5730\u7c21\u5316\u4e86\u90e8\u7f72\u66f4\u65b0\u5de5\u4f5c\u3002\u901a\u904e\u81ea\u52d5\u5316\u5bb9\u5668\u914d\u7f6e\u3001\u7c21\u5316\u64f4\u5145\u5957\u4ef6\u548c\u7ba1\u7406\u8cc7\u6e90\u5206\u914d\u7b49\u4f86\u5be6\u73fe\u751f\u7522\u7d1a\u5bb9\u5668\u7de8\u6392\u6cbb\u7406\u3002 Kubernetes \u7ba1\u7406\u53ca\u7de8\u6392 \u00b6 \u5bb9\u5668\u8ca0\u8f09\uff0c\u6392\u7a0b\u53ca\u8cc7\u6e90\u7ba1\u7406 \u6392\u7a0b\u5668\u548c\u6392\u7a0b \uff1aKubernetes \u6392\u7a0b\u7a0b\u5f0f\u6703\u5be6\u6642\u76e3\u6e2c\u53e2\u96c6\u5065\u5eb7\u72c0\u614b\u53ca\u57f7\u884c\u8ca0\u8f09\u60c5\u6cc1\uff0c\u901a\u904e\u547c\u53eb\u7b56\u7565\u667a\u6167\u7684\u5c07\u65b0\u5bb9\u5668\u5b89\u7f6e\u5728\u5408\u9069\u7684\u4f4d\u7f6e\u3002 \u670d\u52d9\u767c\u73fe\u548c\u8ca0\u8f09\u5747\u8861 \uff1a\u5fae\u670d\u52d9\u67b6\u69cb\u7684\u61c9\u7528\uff0c\u6a21\u7d44\u8d8a\u591a\u670d\u52d9\u8ddf\u8e64\u548c\u7ba1\u7406\u7684\u96e3\u5ea6\u5c31\u8d8a\u5927\u3002Kubernetes \u81ea\u52d5\u7ba1\u7406\u670d\u52d9\u767c\u73fe\u3002\u5be6\u6642\u8a18\u9304\u670d\u52d9\u5217\u8868\uff0c\u540c\u6642\u9084\u6703\u6aa2\u67e5\u670d\u52d9\u7684\u5065\u5eb7\u72c0\u6cc1\uff0c\u52d5\u614b\u8abf\u6574\u670d\u52d9\u5217\u8868\u3002Kubernetes\u9084\u5305\u542b\u4e86\u8ca0\u8f09\u5747\u8861\u3002\u8ca0\u8f09\u5747\u8861\u5668\u662f\u5728\u61c9\u7528\u526f\u672c\u4e4b\u9593\u5206\u914d\u548c\u5354\u8abf\u6d41\u91cf\u7684\u95dc\u9375\u5143\u4ef6\u3002Kubernete\u652f\u63f4\u6574\u5408\u81ea\u5b9a\u7fa9\u8ca0\u8f09\u5747\u8861\u89e3\u6c7a\u65b9\u6848\uff0c\u5982 HAProxy\uff0cNignx\u4ee5 \u53ca\u5171\u6709 LB \u670d\u52d9\u3002 \u8cc7\u6e90\u7ba1\u7406 \uff1aKubernetes \u6392\u7a0b\u7a0b\u5f0f\u901a\u904e CPU \u548c\u8a18\u61b6\u9ad4\u7b49\u57fa\u790e\u8cc7\u6e90\u4f7f\u7528\u7387\uff0c\u5c0d\u6574\u500b\u53e2\u96c6\u7684\u61c9\u7528\u9032\u884c\u5408\u7406\u6392\u7a0b\uff0c\u4fdd\u8b49\u6574\u500b\u53e2\u96c6\u61c9\u7528\u76f8\u5c0d\u7a69\u5b9a\u3002 Kubernetes \u512a\u52e2 \u00b6 \u5f48\u6027\u64f4\u5145\u5957\u4ef6 \uff1aKubernetes \u901a\u904e Cluster Autoscaler \u548c Horizontal Pod Autoscaler \u529f\u80fd\uff0c\u7d50\u5408\u4f7f\u7528\u8005\u914d\u7f6e\u7b56\u7565\uff0c\u5be6\u73fe\u53e2\u96c6\u81ea\u52d5\u5f48\u6027\u4f38\u7e2e\u80fd\u529b\u3002 \u53ef\u79fb\u690d\u6027 \uff1aKubernetes \u53ef\u4ee5\u5728\u4efb\u4f55\u5730\u65b9\u57f7\u884c\uff0c\u7121\u8ad6\u662f\u79c1\u6709\u8cc7\u6599\u4e2d\u5fc3\uff0c\u516c\u5171\u96f2\u9084\u662f\u516c\u5171\u548c\u79c1\u6709\u96f2\u7684\u6df7\u5408\u96f2\u5e95\u5c64\u57fa\u790e\u8a2d\u65bd\u3002 \u4e00\u81f4\u6027\u90e8\u7f72 \uff1a\u5bb9\u5668\u9ad4\u73fe\u4e86\u4e0d\u53ef\u8b8a\u57fa\u790e\u8a2d\u65bd\u7684\u7406\u5ff5\uff0c\u57f7\u884c\u61c9\u7528\u6240\u9700\u7684\u6240\u6709\u4f9d\u8cf4\u9805\u548c\u57f7\u884c\u6307\u4ee4\u90fd\u8207\u5bb9\u5668\u6253\u5305\u5728\u4e00\u8d77\u3002\u4e00\u81f4\u6027\u610f\u5473\u8457\u958b\u767c\u4eba\u54e1\u82b1\u66f4\u5c11\u7684\u6642\u9593\u9032\u884c\u9664\u932f\uff0c\u800c\u5c07\u4e3b\u8981\u7cbe\u529b\u7528\u65bc\u4ea4\u4ed8\u696d\u52d9\u50f9\u503c\u3002 \u7814\u767c\u904b\u7dad\u89e3\u8026 \uff1a\u7522\u54c1\u958b\u767c\u5718\u968a\u91cd\u8996\u5275\u65b0\uff0c\u5feb\u901f\u4ea4\u4ed8\u696d\u52d9\u9700\u6c42\uff1b\u800c\u904b\u7dad\u5718\u968a\u91cd\u8996\u7a69\u5b9a\u6027\uff0c\u5c0d\u8b8a\u5316\u6bd4\u8f03\u4fdd\u5b88\u3002\u5bb9\u5668\u61c9\u7528\u7684\u6a19\u6e96\u5316\uff0c\u5fb9\u5e95\u89e3\u8026\u7814\u767c\u904b\u7dad\u904e\u7a0b\uff1b\u540c\u6642 Kubernetes \u7684\u667a\u6167\u81ea\u52d5\u5316\uff0c\u6975\u5927\u7684\u964d\u4f4e\u904b\u7dad\u7684\u9580\u6abb\uff0c\u6e1b\u8f15\u904b\u7dad\u58d3\u529b\u3002 Kubernetes \u57fa\u672c\u67b6\u69cb \u00b6 Kubernetes \u5143\u4ef6\u67b6\u69cb\u5716 \u63a7\u5236\u5e73\u9762 \u5145\u7576 Kubernetes \u53e2\u96c6\u7684\u5927\u8166\u3002\u6392\u7a0b\u3001\u670d\u52d9\u767c\u73fe\u3001\u8ca0\u8f09\u5747\u8861\u548c\u8cc7\u6e90\u7ba1\u7406\u80fd\u529b\u90fd\u7531\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\uff0c\u5305\u542b\u6838\u5fc3\u5143\u4ef6\u5982\u4e0b\uff1a API server \uff1a\u4efb\u4f55\u5167\u90e8\u6216\u5916\u90e8\u8acb\u6c42\u90fd\u6703\u767c\u9001\u5230 API server\u3002 \u518d\u6709 API server \u78ba\u5b9a\u8acb\u6c42\u662f\u5426\u6709\u6548\u518d\u8f49\u767c\u5230\u5c0d\u61c9\u7684\u5143\u4ef6\u3002 etcd \uff1aetcd \u662f Kubernetes \u7684\u95dc\u9375\u5143\u4ef6\uff0c\u5132\u5b58\u53e2\u96c6\u72c0\u614b\u548c\u914d\u7f6e\u3002\u5982\u679c\u63a7\u5236\u5e73\u9762\u662f\u5927\u8166\uff0c\u90a3\u9ebc etcd \u5c31\u662f\u5132\u5b58\u8a18\u61b6\u7684\u5730\u65b9\u3002 Worker nodes \uff1a\u5de5\u4f5c\u7bc0\u9ede\u662f Kubernetes \u53e2\u96c6\u4e2d\u771f\u6b63\u627f\u63a5\u696d\u52d9\u61c9\u7528\u57f7\u884c\u8ca0\u8f09\u7684\uff0c\u55ae\u500b\u53e2\u96c6\u90fd\u6703\u6709\u591a\u500b\u5de5\u4f5c\u7bc0\u9ede\uff0c\u4e5f\u53ef\u901a\u904e Kubernetes \u5feb\u901f\u64f4\u5145\u5957\u4ef6\u5de5\u4f5c\u7bc0\u9ede\u3002 Kubelet \uff1akubelet \u662f\u57f7\u884c\u5728\u6bcf\u500b\u5de5\u4f5c\u7bc0\u9ede\u4e0a\uff0c\u8207\u63a7\u5236\u5e73\u9762\u901a\u8a0a\u4e26\u57f7\u884c\u7ba1\u7406\u64cd\u4f5c\u3002 \u5982\u679c\u63a7\u5236\u5e73\u9762\u662f\u5927\u8166\uff0c\u90a3\u9ebc kubelet \u5c31\u662f\u624b\u81c2\u3002 Container runtime engine \uff1a\u5bb9\u5668\u57f7\u884c\u6642\u5f15\u64ce\u57f7\u884c\u7b26\u5408 OCI \u6a19\u6e96\u7684\u61c9\u7528\u7a0b\u5f0f\u3002 \u5b83\u662f\u53ef\u79fb\u690d\u5bb9\u5668\u548c\u5e95\u5c64 Linux \u6838\u5fc3\u4e4b\u9593\u7684\u7ba1\u9053\u3002 \u5bb9\u5668\u751f\u614b\u9ad4\u7cfb \u00b6 \u96d6\u7136 Kubernetes \u63d0\u4f9b\u4e86\u53ef\u79fb\u690d\u6027\u3001\u53ef\u64f4\u5145\u5957\u4ef6\u6027\u548c\u81ea\u52d5\u5316\u3001\u7b56\u7565\u9a45\u52d5\u7684\u7ba1\u7406\u3002\u5f9e\u6574\u500b\u8edf\u9ad4\u5168\u751f\u547d\u9031\u671f\u4f86\u770b\uff0c\u5b83\u9084\u9700\u8981\u5728\u751f\u7522\u4e2d\u69cb\u5efa\u3001\u57f7\u884c\u548c\u64f4\u5145\u5957\u4ef6\u5bb9\u5668\u6240\u9700\u7684\u80fd\u529b\uff0c\u4f46\u66f4\u591a\u7684\u662f\u504f\u5e95\u5c64\u904b\u7dad\u7ba1\u7406\u5e73\u81fa\u3002 \u9084\u6709\u5728\u65e9\u671f\uff0c\u70ba\u4e86\u80fd\u5feb\u901f\u9069\u914d\u5404\u7a2e\u5834\u666f\uff0cKubernetes\u901a\u904e\u6a19\u6e96\u4f86\u64f4\u5145\u5957\u4ef6\u5e73\u81fa\u7684\u80fd\u529b\uff1b\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u7fa9\u8cc7\u6e90\uff08CRD\uff09\uff0c\u5bb9\u5668\u5132\u5b58\u4ecb\u9762\uff08CSI\uff09\u548c\u5bb9\u5668\u7db2\u8def\u4ecb\u9762\uff08CNI\uff09\u8f15\u9b06\u9069\u914d\u8907\u96dc\u74b0\u5883\u3002\u4f46\u662f\u540c\u6642\u4e5f\u50cfAndroid\u4e00\u6a23\uff0c\u788e\u7247\u5316\u592a\u56b4\u91cd\uff0c\u5404\u500b\u64f4\u5145\u5957\u4ef6\u5143\u4ef6\u80fd\u529b\u5c64\u6b21\u4e0d\u9f4a\uff0c\u5c0e\u81f4Kubernetes\u9700\u8981\u7d44\u88dd\uff0c\u5df2\u7d93\u6295\u7522\u7684\u53e2\u96c6\u5347\u7d1a\u56f0\u96e3\u3002","title":"K8S \u4ecb\u8a54"},{"location":"kubernetes/02-concepts/01-overview/k8s-intro/#kubernetes","text":"\u4f5c\u8005: \u5de8\u5b50\u5609 \u539f\u6587: Kubernetes\u5bb9\u5668\u5e73\u81fa ]( https://www.gushiciku.cn/dl/18xaG/zh-tw ) \u5bb9\u5668\u6280\u8853\u6b63\u5728\u985b\u8986\u50b3\u7d71\uff0c\u91cd\u69cb\u6574\u500b\u8edf\u9ad4\u4e16\u754c \uff0c\u6539\u8b8a\u8edf\u9ad4\u6280\u8853\u67b6\u69cb\uff0c\u5718\u968a\u4ea4\u4ed8\u6548\u7387\u4ee5\u53ca\u4ea4\u4ed8\u65b9\u5f0f\u3002\u901a\u904e\u906e\u853d\u5e95\u5c64\u8907\u96dc\u7570\u69cb\u7684\u57fa\u790e\u8a2d\u65bd\u74b0\u5883\uff0c\u4fdd\u969c\u8edf\u9ad4\u4e00\u81f4\u6027\u57f7\u884c\u6642\u74b0\u5883\uff0c\u8b93\u7814\u767c\u4eba\u54e1\u66f4\u52a0\u9ad8\u6548\u5730\u805a\u7126\u5728\u696d\u52d9\u908f\u8f2f\u3002 \u96d6\u7136 \u5bb9\u5668\u901a\u904e\u985b\u8986\u5f0f\u5275\u65b0\u906e\u853d\u5e95\u5c64\u8907\u96dc\u6027 \uff0c \u4f46\u662f\u5c0d\u5bb9\u5668\u90e8\u7f72\u904b\u7dad\uff0c\u7d66\u5bb9\u5668\u53e2\u96c6\u672c\u8eab\u7684\u904b\u7dad\u5718\u968a\u5e36\u4f86\u4e86\u65b0\u7684\u6311\u6230 \u3002\u8207\u50b3\u7d71\u865b\u64ec\u6a5f\u5668\u76f8\u6bd4\uff0c\u6975\u77ed\u7684\u90e8\u7f72\u57f7\u884c\u9031\u671f\uff0c\u66f4\u9ad8\u6548\u7684\u8cc7\u6e90\u4f7f\u7528\u7387\u3002\u5bb9\u5668\u7ba1\u7406\u8457\u6d77\u91cf\u7684\u5feb\u9031\u671f\u8f2a\u8f49\u7684\u7269\u4ef6\uff0c\u8981\u6c42\u66f4\u5fb9\u5e95\u7684\u81ea\u52d5\u5316\uff0c\u7b56\u7565\u555f\u52d5\u7684\u7ba1\u7406\u80fd\u529b\u3002 \u8a31\u591a\u5718\u968a\u90fd\u958b\u59cb\u8f49\u5411 Kubernetes \u5bb9\u5668\uff0c\u901a\u904e\u5bb9\u5668\u7de8\u6392\u53ca\u7ba1\u7406\u80fd\u529b\uff0c\u8f15\u9b06\u7dad\u8b77\u751f\u7522\u3001\u958b\u767c\u548c\u6e2c\u8a66\u74b0\u5883\uff0cKubernetes \u5df2\u6210\u70ba\u5bb9\u5668\u7de8\u6392\u548c\u7ba1\u7406\u7684\u4e8b\u5be6\u6a19\u6e96\uff0c\u4f01\u696d\u8981\u610f\u8b58\u5230 \u5bb9\u5668\u5c07\u6210\u70ba\u672a\u4f86\u95dc\u9375\u7684\u57fa\u790e\u8a2d\u65bd\u5e73\u81fa \u3002","title":"Kubernetes \u5bb9\u5668\u5e73\u81fa\u4ecb\u8a54"},{"location":"kubernetes/02-concepts/01-overview/k8s-intro/#kubernetes_1","text":"\u5bb9\u5668\u662f\u65b0\u578b\u7684\u8f15\u91cf\u7d1a\u865b\u64ec\u5316 Kubernetes \u662f\u4e00\u500b\u958b\u6e90\u5bb9\u5668\u7de8\u6392\u5e73\u81fa\uff0c\u7ba1\u7406\u5927\u898f\u6a21\u5206\u6563\u5f0f\u5bb9\u5668\u5316\u8edf\u9ad4\u61c9\u7528\uff0cKubernetes \u63d0\u4f9b\u4e86\u7d71\u4e00\u7684 API \u4ecb\u9762\uff0c\u547c\u53eb API \u53ef\u662f\u8f15\u9b06\u5be6\u73fe Web \u61c9\u7528\u3001\u6279\u8655\u7406\u4f5c\u696d\u548c\u8cc7\u6599\u5eab\u7684\u90e8\u7f72\u3002 Kubernetes \u4e2d\u7684\u8edf\u9ad4\u61c9\u7528\u88ab\u6253\u5305\u6210\u8207\u74b0\u5883\u5b8c\u5168\u5206\u96e2\u7684\u5bb9\u5668\u6620\u8c61\uff0cKubernetes\u6703\u81ea\u52d5\u914d\u7f6e\u61c9\u7528\u4e26\u7dad\u8b77\u8ddf\u8e64\u8cc7\u6e90\u5206\u914d\u3002 Kubernetes \u662f\u8c37\u6b4c\u7684\u7b2c\u4e09\u4ee3\u5bb9\u5668\u7ba1\u7406\u7cfb\u7d71\uff0c\u662f Borg \u7368\u7279\u7684\u63a7\u5236\u5668\u548c Omega \u9748\u6d3b\u7684\u6392\u7a0b\u5668\u7684\u7d44\u5408\u3002\u76f8\u8f03\u50b3\u7d71VM\u865b\u64ec\u5316\uff0c\u5bb9\u5668\u662f\u8f15\u91cf\u7d1a\u865b\u64ec\u5316\u6280\u8853\uff0c\u5c0d\u8edf\u9ad4\u61c9\u7528\u800c\u8a00\uff0c\u5bb9\u5668\u5e36\u4f86\u4e00\u4e0b\u50f9\u503c\uff1a \u66f4\u654f\u6377\u7684\u4ea4\u4ed8\u6548\u7387\uff0c\u91cb\u653e\u7814\u767c\u4eba\u54e1\u8017\u8cbb\u5728\u74b0\u5883\u9664\u932f\u904e\u7a0b\uff0c\u66f4\u52a0\u805a\u7126\u696d\u52d9\u672c\u8eab\u908f\u8f2f \u66f4\u4f4e\u7684\u4f3a\u670d\u5668\u8cc7\u6e90\u6210\u672c\uff0c\u5bb9\u5668\u5316\u57f7\u884c\u53ef\u4ee5\u5927\u5e45\u63d0\u5347\u5e95\u5c64\u57fa\u790e\u8cc7\u6e90\u7684\u4f7f\u7528\u6548\u7387\u3002 \u66f4\u5927\u7bc4\u570d\u7684\u5dee\u7570\u5316\u8a2d\u65bd\u62bd\u8c61\u7d71\u4e00\uff0c\u5bb9\u5668\u9069\u914d\u80fd\u529b\u66f4\u5f37\uff0c\u5bb9\u5668\u5e7e\u4e4e\u53ef\u4ee5\u57f7\u884c\u5e02\u9762\u4e0a\u6240\u6709\u5e38\u898b\u88dd\u7f6e\u3002 \u5fae\u670d\u52d9\u67b6\u69cb \u662f\u7576\u524d\u6700\u70ba\u6d41\u884c\u7684\u8edf\u9ad4\u67b6\u69cb\uff0c\u63d0\u5021\u6a21\u7d44\u5316\uff0c\u677e\u8026\u5408\u7684\u8a2d\u8a08\u7406\u5ff5\uff0c\u4e00\u822c\u4e2d\u7b49\u5fae\u670d\u52d9\u67b6\u69cb\u5c08\u6848\uff0c\u6a21\u7d44\u6578\u91cf\u53ef\u9054\u5e7e\u5341\u5230\u4e0a\u767e\u7684\u898f\u6a21\uff0c\u901a\u904e\u624b\u5de5\u90e8\u7f72\u904b\u7dad\u5e7e\u4e4e\u4e0d\u80af\u80fd\uff1b\u91dd\u5c0d\u9019\u7a2e\u8907\u96dc\u61c9\u7528\u7a0b\u5f0f\uff0c\u5c24\u5176\u662f\u5143\u4ef6\u6578\u91cf\u6bd4\u8f03\u591a\u7684\u5834\u666f\uff0c\u5bb9\u5668Kubernetes\u6975\u5927\u5730\u7c21\u5316\u4e86\u90e8\u7f72\u66f4\u65b0\u5de5\u4f5c\u3002\u901a\u904e\u81ea\u52d5\u5316\u5bb9\u5668\u914d\u7f6e\u3001\u7c21\u5316\u64f4\u5145\u5957\u4ef6\u548c\u7ba1\u7406\u8cc7\u6e90\u5206\u914d\u7b49\u4f86\u5be6\u73fe\u751f\u7522\u7d1a\u5bb9\u5668\u7de8\u6392\u6cbb\u7406\u3002","title":"Kubernetes \u5bb9\u5668\u5e73\u81fa"},{"location":"kubernetes/02-concepts/01-overview/k8s-intro/#kubernetes_2","text":"\u5bb9\u5668\u8ca0\u8f09\uff0c\u6392\u7a0b\u53ca\u8cc7\u6e90\u7ba1\u7406 \u6392\u7a0b\u5668\u548c\u6392\u7a0b \uff1aKubernetes \u6392\u7a0b\u7a0b\u5f0f\u6703\u5be6\u6642\u76e3\u6e2c\u53e2\u96c6\u5065\u5eb7\u72c0\u614b\u53ca\u57f7\u884c\u8ca0\u8f09\u60c5\u6cc1\uff0c\u901a\u904e\u547c\u53eb\u7b56\u7565\u667a\u6167\u7684\u5c07\u65b0\u5bb9\u5668\u5b89\u7f6e\u5728\u5408\u9069\u7684\u4f4d\u7f6e\u3002 \u670d\u52d9\u767c\u73fe\u548c\u8ca0\u8f09\u5747\u8861 \uff1a\u5fae\u670d\u52d9\u67b6\u69cb\u7684\u61c9\u7528\uff0c\u6a21\u7d44\u8d8a\u591a\u670d\u52d9\u8ddf\u8e64\u548c\u7ba1\u7406\u7684\u96e3\u5ea6\u5c31\u8d8a\u5927\u3002Kubernetes \u81ea\u52d5\u7ba1\u7406\u670d\u52d9\u767c\u73fe\u3002\u5be6\u6642\u8a18\u9304\u670d\u52d9\u5217\u8868\uff0c\u540c\u6642\u9084\u6703\u6aa2\u67e5\u670d\u52d9\u7684\u5065\u5eb7\u72c0\u6cc1\uff0c\u52d5\u614b\u8abf\u6574\u670d\u52d9\u5217\u8868\u3002Kubernetes\u9084\u5305\u542b\u4e86\u8ca0\u8f09\u5747\u8861\u3002\u8ca0\u8f09\u5747\u8861\u5668\u662f\u5728\u61c9\u7528\u526f\u672c\u4e4b\u9593\u5206\u914d\u548c\u5354\u8abf\u6d41\u91cf\u7684\u95dc\u9375\u5143\u4ef6\u3002Kubernete\u652f\u63f4\u6574\u5408\u81ea\u5b9a\u7fa9\u8ca0\u8f09\u5747\u8861\u89e3\u6c7a\u65b9\u6848\uff0c\u5982 HAProxy\uff0cNignx\u4ee5 \u53ca\u5171\u6709 LB \u670d\u52d9\u3002 \u8cc7\u6e90\u7ba1\u7406 \uff1aKubernetes \u6392\u7a0b\u7a0b\u5f0f\u901a\u904e CPU \u548c\u8a18\u61b6\u9ad4\u7b49\u57fa\u790e\u8cc7\u6e90\u4f7f\u7528\u7387\uff0c\u5c0d\u6574\u500b\u53e2\u96c6\u7684\u61c9\u7528\u9032\u884c\u5408\u7406\u6392\u7a0b\uff0c\u4fdd\u8b49\u6574\u500b\u53e2\u96c6\u61c9\u7528\u76f8\u5c0d\u7a69\u5b9a\u3002","title":"Kubernetes \u7ba1\u7406\u53ca\u7de8\u6392"},{"location":"kubernetes/02-concepts/01-overview/k8s-intro/#kubernetes_3","text":"\u5f48\u6027\u64f4\u5145\u5957\u4ef6 \uff1aKubernetes \u901a\u904e Cluster Autoscaler \u548c Horizontal Pod Autoscaler \u529f\u80fd\uff0c\u7d50\u5408\u4f7f\u7528\u8005\u914d\u7f6e\u7b56\u7565\uff0c\u5be6\u73fe\u53e2\u96c6\u81ea\u52d5\u5f48\u6027\u4f38\u7e2e\u80fd\u529b\u3002 \u53ef\u79fb\u690d\u6027 \uff1aKubernetes \u53ef\u4ee5\u5728\u4efb\u4f55\u5730\u65b9\u57f7\u884c\uff0c\u7121\u8ad6\u662f\u79c1\u6709\u8cc7\u6599\u4e2d\u5fc3\uff0c\u516c\u5171\u96f2\u9084\u662f\u516c\u5171\u548c\u79c1\u6709\u96f2\u7684\u6df7\u5408\u96f2\u5e95\u5c64\u57fa\u790e\u8a2d\u65bd\u3002 \u4e00\u81f4\u6027\u90e8\u7f72 \uff1a\u5bb9\u5668\u9ad4\u73fe\u4e86\u4e0d\u53ef\u8b8a\u57fa\u790e\u8a2d\u65bd\u7684\u7406\u5ff5\uff0c\u57f7\u884c\u61c9\u7528\u6240\u9700\u7684\u6240\u6709\u4f9d\u8cf4\u9805\u548c\u57f7\u884c\u6307\u4ee4\u90fd\u8207\u5bb9\u5668\u6253\u5305\u5728\u4e00\u8d77\u3002\u4e00\u81f4\u6027\u610f\u5473\u8457\u958b\u767c\u4eba\u54e1\u82b1\u66f4\u5c11\u7684\u6642\u9593\u9032\u884c\u9664\u932f\uff0c\u800c\u5c07\u4e3b\u8981\u7cbe\u529b\u7528\u65bc\u4ea4\u4ed8\u696d\u52d9\u50f9\u503c\u3002 \u7814\u767c\u904b\u7dad\u89e3\u8026 \uff1a\u7522\u54c1\u958b\u767c\u5718\u968a\u91cd\u8996\u5275\u65b0\uff0c\u5feb\u901f\u4ea4\u4ed8\u696d\u52d9\u9700\u6c42\uff1b\u800c\u904b\u7dad\u5718\u968a\u91cd\u8996\u7a69\u5b9a\u6027\uff0c\u5c0d\u8b8a\u5316\u6bd4\u8f03\u4fdd\u5b88\u3002\u5bb9\u5668\u61c9\u7528\u7684\u6a19\u6e96\u5316\uff0c\u5fb9\u5e95\u89e3\u8026\u7814\u767c\u904b\u7dad\u904e\u7a0b\uff1b\u540c\u6642 Kubernetes \u7684\u667a\u6167\u81ea\u52d5\u5316\uff0c\u6975\u5927\u7684\u964d\u4f4e\u904b\u7dad\u7684\u9580\u6abb\uff0c\u6e1b\u8f15\u904b\u7dad\u58d3\u529b\u3002","title":"Kubernetes \u512a\u52e2"},{"location":"kubernetes/02-concepts/01-overview/k8s-intro/#kubernetes_4","text":"Kubernetes \u5143\u4ef6\u67b6\u69cb\u5716 \u63a7\u5236\u5e73\u9762 \u5145\u7576 Kubernetes \u53e2\u96c6\u7684\u5927\u8166\u3002\u6392\u7a0b\u3001\u670d\u52d9\u767c\u73fe\u3001\u8ca0\u8f09\u5747\u8861\u548c\u8cc7\u6e90\u7ba1\u7406\u80fd\u529b\u90fd\u7531\u63a7\u5236\u5e73\u9762\u63d0\u4f9b\uff0c\u5305\u542b\u6838\u5fc3\u5143\u4ef6\u5982\u4e0b\uff1a API server \uff1a\u4efb\u4f55\u5167\u90e8\u6216\u5916\u90e8\u8acb\u6c42\u90fd\u6703\u767c\u9001\u5230 API server\u3002 \u518d\u6709 API server \u78ba\u5b9a\u8acb\u6c42\u662f\u5426\u6709\u6548\u518d\u8f49\u767c\u5230\u5c0d\u61c9\u7684\u5143\u4ef6\u3002 etcd \uff1aetcd \u662f Kubernetes \u7684\u95dc\u9375\u5143\u4ef6\uff0c\u5132\u5b58\u53e2\u96c6\u72c0\u614b\u548c\u914d\u7f6e\u3002\u5982\u679c\u63a7\u5236\u5e73\u9762\u662f\u5927\u8166\uff0c\u90a3\u9ebc etcd \u5c31\u662f\u5132\u5b58\u8a18\u61b6\u7684\u5730\u65b9\u3002 Worker nodes \uff1a\u5de5\u4f5c\u7bc0\u9ede\u662f Kubernetes \u53e2\u96c6\u4e2d\u771f\u6b63\u627f\u63a5\u696d\u52d9\u61c9\u7528\u57f7\u884c\u8ca0\u8f09\u7684\uff0c\u55ae\u500b\u53e2\u96c6\u90fd\u6703\u6709\u591a\u500b\u5de5\u4f5c\u7bc0\u9ede\uff0c\u4e5f\u53ef\u901a\u904e Kubernetes \u5feb\u901f\u64f4\u5145\u5957\u4ef6\u5de5\u4f5c\u7bc0\u9ede\u3002 Kubelet \uff1akubelet \u662f\u57f7\u884c\u5728\u6bcf\u500b\u5de5\u4f5c\u7bc0\u9ede\u4e0a\uff0c\u8207\u63a7\u5236\u5e73\u9762\u901a\u8a0a\u4e26\u57f7\u884c\u7ba1\u7406\u64cd\u4f5c\u3002 \u5982\u679c\u63a7\u5236\u5e73\u9762\u662f\u5927\u8166\uff0c\u90a3\u9ebc kubelet \u5c31\u662f\u624b\u81c2\u3002 Container runtime engine \uff1a\u5bb9\u5668\u57f7\u884c\u6642\u5f15\u64ce\u57f7\u884c\u7b26\u5408 OCI \u6a19\u6e96\u7684\u61c9\u7528\u7a0b\u5f0f\u3002 \u5b83\u662f\u53ef\u79fb\u690d\u5bb9\u5668\u548c\u5e95\u5c64 Linux \u6838\u5fc3\u4e4b\u9593\u7684\u7ba1\u9053\u3002","title":"Kubernetes \u57fa\u672c\u67b6\u69cb"},{"location":"kubernetes/02-concepts/01-overview/k8s-intro/#_1","text":"\u96d6\u7136 Kubernetes \u63d0\u4f9b\u4e86\u53ef\u79fb\u690d\u6027\u3001\u53ef\u64f4\u5145\u5957\u4ef6\u6027\u548c\u81ea\u52d5\u5316\u3001\u7b56\u7565\u9a45\u52d5\u7684\u7ba1\u7406\u3002\u5f9e\u6574\u500b\u8edf\u9ad4\u5168\u751f\u547d\u9031\u671f\u4f86\u770b\uff0c\u5b83\u9084\u9700\u8981\u5728\u751f\u7522\u4e2d\u69cb\u5efa\u3001\u57f7\u884c\u548c\u64f4\u5145\u5957\u4ef6\u5bb9\u5668\u6240\u9700\u7684\u80fd\u529b\uff0c\u4f46\u66f4\u591a\u7684\u662f\u504f\u5e95\u5c64\u904b\u7dad\u7ba1\u7406\u5e73\u81fa\u3002 \u9084\u6709\u5728\u65e9\u671f\uff0c\u70ba\u4e86\u80fd\u5feb\u901f\u9069\u914d\u5404\u7a2e\u5834\u666f\uff0cKubernetes\u901a\u904e\u6a19\u6e96\u4f86\u64f4\u5145\u5957\u4ef6\u5e73\u81fa\u7684\u80fd\u529b\uff1b\u53ef\u4ee5\u4f7f\u7528\u81ea\u5b9a\u7fa9\u8cc7\u6e90\uff08CRD\uff09\uff0c\u5bb9\u5668\u5132\u5b58\u4ecb\u9762\uff08CSI\uff09\u548c\u5bb9\u5668\u7db2\u8def\u4ecb\u9762\uff08CNI\uff09\u8f15\u9b06\u9069\u914d\u8907\u96dc\u74b0\u5883\u3002\u4f46\u662f\u540c\u6642\u4e5f\u50cfAndroid\u4e00\u6a23\uff0c\u788e\u7247\u5316\u592a\u56b4\u91cd\uff0c\u5404\u500b\u64f4\u5145\u5957\u4ef6\u5143\u4ef6\u80fd\u529b\u5c64\u6b21\u4e0d\u9f4a\uff0c\u5c0e\u81f4Kubernetes\u9700\u8981\u7d44\u88dd\uff0c\u5df2\u7d93\u6295\u7522\u7684\u53e2\u96c6\u5347\u7d1a\u56f0\u96e3\u3002","title":"\u5bb9\u5668\u751f\u614b\u9ad4\u7cfb"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/","text":"Kubernetes \u5bb9\u5668\u5e73\u81fa\u67b6\u69cb\u89e3\u6790 \u00b6 \u4f5c\u8005: \u5de8\u5b50\u5609 \u539f\u6587: Kubernetes \u5bb9\u5668\u5e73\u53f0\u67b6\u6784\u4e4b\u9053 Kubernetes\u662f \u4e00\u500b\u958b\u6e90\u5bb9\u5668\u7de8\u6392\u5e73\u81fa\uff0c\u7ba1\u7406\u5927\u898f\u6a21\u5206\u6563\u5f0f\u5bb9\u5668\u5316\u8edf\u9ad4\u61c9\u7528 \uff0c\u662f\u96f2\u8a08\u7b97\u767c\u5c55\u6f14\u9032\u7684\u4e00\u6b21\u5fb9\u5e95\u9769\u547d\u6027\u7684\u7a81\u7834\u3002Kubernetes \u662f\u8c37\u6b4c\u7684\u7b2c\u4e09\u4ee3\u5bb9\u5668\u7ba1\u7406\u7cfb\u7d71\uff0c\u662f Borg \u7368\u7279\u7684\u63a7\u5236\u5668\u548c Omega \u9748\u6d3b\u7684\u6392\u7a0b\u5668\u7684\u7d44\u5408\u3002Kubernetes \u4e2d\u7684\u61c9\u7528\u88ab\u6253\u5305\u6210\u8207\u74b0\u5883\u5b8c\u5168\u5206\u96e2\u7684\u5bb9\u5668\u6620\u8c61\uff0c\u4e26\u4e14\u81ea\u52d5\u914d\u7f6e\u61c9\u7528\u4e26\u7dad\u8b77\u8ddf\u8e64\u8cc7\u6e90\u5206\u914d\u3002 Kubernetes \u662f\u4ee5 \u61c9\u7528\u70ba\u4e2d\u5fc3 \u7684\u6280\u8853\u67b6\u69cb\u8207\u601d\u60f3\u7406\u5ff5\uff0c \u5411\u4e0b \u906e\u853d\u57fa\u790e\u8a2d\u65bd\u5dee\u7570\uff0c\u5be6\u73fe\u5e95\u5c64\u57fa\u790e\u8cc7\u6e90\u7d71\u4e00\u6392\u7a0b\u53ca\u7de8\u6392\uff1b \u5411\u4e0a \u901a\u904e\u5bb9\u5668\u6620\u8c61\u6a19\u6e96\u5316\u61c9\u7528\uff0c\u5be6\u73fe\u61c9\u7528\u8ca0\u8f09\u81ea\u52d5\u5316\u90e8\u7f72\uff1b\u4e2d\u9593\u901a\u904e Kubernetes \u901a\u7528\u7684\u7de8\u6392\u80fd\u529b\uff0c\u958b\u653e API \u4ee5\u53ca\u81ea\u5b9a\u7fa9 CRD \u64f4\u5145\u5957\u4ef6\u80fd\u529b\uff0c\u6253\u9020\u96f2\u539f\u751f\u4f5c\u696d\u7cfb\u7d71\u80fd\u529b\uff0c\u5f62\u6210\u96f2\u7aef\u8a08\u7b97\u65b0\u4ecb\u9762\uff1b\u52a9\u529b\u7814\u767c\u5718\u968a \u5feb\u901f\u69cb\u5efa\u6a19\u6e96\u5316\u3001\u5f48\u6027\u9ad8\u53ef\u9760\u3001\u677e\u8026\u5408\u3001\u6613\u7ba1\u7406\u7dad\u8b77\u7684\u61c9\u7528\u7cfb\u7d71\uff0c\u63d0\u5347\u4ea4\u4ed8\u6548\u7387\uff0c\u964d\u4f4e\u904b\u7dad\u8907\u96dc\u5ea6 \u3002Kubernetes \u5728\u6280\u8853\u67b6\u69cb\u65b9\u9762\u5177\u5099\u4e09\u500b\u80fd\u529b\uff1a \u654f\u6377\u7684\u5f48\u6027\u4f38\u7e2e\u80fd\u529b \uff1a\u4e0d\u540c\u65bc\u865b\u64ec\u6a5f\u5668\u5206\u9418\u7d1a\u7684\u5f48\u6027\u4f38\u7e2e\u97ff\u61c9\uff0c\u5bb9\u5668\u61c9\u7528\u53ef\u5be6\u73fe\u79d2\u7d1a\u751a\u81f3\u6beb\u79d2\u7d1a\u7684\u5f48\u6027\u4f38\u7e2e\u97ff\u61c9\uff1b \u667a\u6167\u7684\u670d\u52d9\u6545\u969c\u81ea\u6108\u80fd\u529b \uff1a\u5bb9\u5668\u61c9\u7528\u5177\u6709\u6975\u5f37\u7684\u81ea\u6108\u80fd\u529b\uff0c\u53ef\u5be6\u73fe\u61c9\u7528\u6545\u969c\u7684\u81ea\u52d5\u6458\u9664\u8207\u91cd\u69cb\uff1b \u5927\u898f\u6a21\u7684\u8907\u88fd\u5206\u767c\u80fd\u529b \uff1a\u5bb9\u5668\u61c9\u7528\u6a19\u6e96\u5316\u7684\u4ea4\u4ed8\u88fd\u54c1\uff0c\u53ef\u5be6\u73fe\u8de8\u5e73\u81fa\u3001\u8de8\u5340\u57df\uff0c\u96f2\u908a\u4e00\u9ad4\u898f\u6a21\u5316\u8907\u88fd\u5206\u767c\u90e8\u7f72\u80fd\u529b\u3002 Kubernetes \u6574\u9ad4\u67b6\u69cb \u00b6 Kubernetes \u4e3b\u5f9e\u5206\u6563\u5f0f\u67b6\u69cb\u5716 Kubernetes \u662f\u5178\u578b\u7684\u4e3b\u5f9e\u5206\u6563\u5f0f\u67b6\u69cb\uff0c\u7531 \u96c6\u4e2d\u5f0f\u7ba1\u7406\u7bc0\u9ede \uff08Master Node\uff09, \u5206\u6563\u5f0f\u7684\u5de5\u4f5c\u7bc0\u9ede \uff08Worker Node\uff09\u7d44\u6210\u4ee5\u53ca\u8f14\u52a9\u5de5\u5177\u7d44\u6210\u3002 \u96c6\u4e2d\u5f0f\u7ba1\u7406\u7bc0\u9ede Master Node \u00b6 \u96c6\u4e2d\u5f0f\u7ba1\u7406\u7bc0\u9ede \uff0c\u5c0d\u53e2\u96c6\u9032\u884c\u6392\u7a0b\u7ba1\u7406\uff0c\u6709\u56db\u5927\u6838\u5fc3\u5143\u4ef6: API Server \uff1a\u627f\u64d4\u53e2\u96c6\u7684\u9598\u9053\u5668\uff0c\u5be6\u73fe\u7d71\u4e00\u8a8d\u8b49\u9451\u6b0a\u5c0d\u5916\u670d\u52d9\uff0c\u540c\u6642\u4e5f\u662f\u7ba1\u7406 Node/Pod \u8cc7\u6e90\u4ee3\u7406\u901a\u9053\uff1b Scheduler \uff1a\u8cc7\u6e90\u6392\u7a0b\u5668\uff0c\u9664\u4e86 Kubernetes \u9810\u8a2d\u7684\u6392\u7a0b\u5668\uff0c\u4e5f\u652f\u63f4\u81ea\u5b9a\u7fa9\u6392\u7a0b\u5668\uff1b ETCD \uff1a\u53e2\u96c6\u72c0\u614b\u7d71\u4e00\u5132\u5b58\uff0c\u8207 Zookeeper \u985e\u4f3c\u7684 key-value \u5132\u5b58\uff1b Controller Manger \uff1a\u63a7\u5236\u7ba1\u7406\u5668\u5be6\u73fe\u81ea\u6108\u3001\u64f4\u5bb9\u3001\u61c9\u7528\u751f\u547d\u9031\u671f\u7ba1\u7406\u3001\u670d\u52d9\u767c\u73fe\u3001\u8def\u7531\u3001\u670d\u52d9\u7e6b\u7d50\u7b49\u80fd\u529b\uff1bKubernetes \u9810\u8a2d\u63d0\u4f9b Replication Controller\u3001Node Controller\u3001Namespace Controller\u3001Service Controller\u3001Endpoints Controller\u3001Persistent Controller\u3001DaemonSet Controller\u7b49\u63a7\u5236\u5668\u3002 \u5206\u6563\u5f0f\u7684\u5de5\u4f5c\u7bc0\u9ede Worker Node \u00b6 \u5206\u6563\u5f0f\u7684\u5de5\u4f5c\u7bc0\u9ede \uff0c\u5de5\u4f5c\u7bc0\u9ede\u57f7\u884c\u696d\u52d9\u61c9\u7528\u5bb9\u5668\uff1b\u9810\u8a2d\u6703\u57f7\u884c\u4e09\u5927\u6838\u5fc3\u5143\u4ef6\uff1a Kubelet \uff1a\u8207\u7ba1\u7406\u7bc0\u9ede\u901a\u8a0a\u4e26\u89f8\u767c\u6307\u4ee4\u57f7\u884c\uff0c\u7ba1\u7406\u9a45\u52d5\u7db2\u8def\uff0c\u5132\u5b58\u53ca\u5bb9\u5668\u57f7\u884c\u6642\uff1b Kube Proxy \uff1a\u901a\u904e DNS \u5be6\u73fe\u670d\u52d9\u767c\u73fe\uff0c\u85c9\u52a9 iptables \u898f\u5247\u5f15\u5c0e\u8a2a\u554f\u81f3\u670d\u52d9 IP\uff0c\u4e26\u5c07\u91cd\u5b9a\u5411\u81f3\u6b63\u78ba\u7684\u5f8c\u7aef\u61c9\u7528\uff0c\u5be6\u73fe\u9ad8\u53ef\u7528\u8ca0\u8f09\u5747\u8861\u80fd\u529b\uff1b Container Runtime \uff1a\u5bb9\u5668\u57f7\u884c\u6642\u3002\u70ba\u4e86\u64f4\u5145\u5957\u4ef6 Kubernetes \u5e73\u81fa\u9069\u914d\u80fd\u529b\uff0c\u540c\u6642\u4e5f\u6a19\u6e96\u5316\u6574\u500b\u751f\u614b\uff0c\u901a\u904e CNI \u8207 CSI \u6a19\u6e96\u898f\u7bc4\u7db2\u8def\u53ca\u5132\u5b58 \u7684\u64f4\u5145\u5957\u4ef6\uff1b\u901a\u904e CRI \u8207 OCI \u6a19\u6e96\u898f\u7bc4\u5bb9\u5668\u6620\u8c61\u53ca\u5bb9\u5668\u57f7\u884c \u6642\u7684\u64f4\u5145\u5957\u4ef6\uff1b\u76ee\u524d CRI \u652f\u63f4\u7684\u5bb9\u5668\u57f7\u884c\u6642\u6709 docker\u3001rkt\u3001cri-o\u3001frankti\u3001kata-containers \u548c clear-containers\u7b49\u3002 \u8f14\u52a9\u5de5\u5177 \u00b6 \u8f14\u52a9\u5de5\u5177\uff0c\u4e3b\u8981\u662f\u8f14\u52a9\u53e2\u96c6\u7ba1\u7406\u53ca\u7db2\u8def\u64f4\u5145\u5957\u4ef6: kubectl \u901a\u904e API Server \u9032\u884c\u4e92\u52d5\uff0c\u5be6\u73fe\u53e2\u96c6\u7ba1\u7406\u7684\u547d\u4ee4\u5217\u5de5\u5177\uff1b Dashboard \u662fKubernetes\u7684web\u4f7f\u7528\u8005\u7ba1\u7406\u76e3\u63a7\u4ecb\u9762\uff1b Core DNS \u662f\u53ef\u64f4\u5145\u5957\u4ef6\u7684 DNS \u4f3a\u670d\u5668\uff0c\u5be6\u73fe\u53e2\u96c6\u670d\u52d9\u767c\u73fe\u80fd\u529b\u3002 Kubernetes \u6838\u5fc3\u6982\u5ff5 \u00b6 POD \u5bb9\u5668\u7d44\uff0cKubernetes \u6700\u5c0f\u6392\u7a0b\u55ae\u5143 \u00b6 Pod \u662f Kubernetes \u7684\u6700\u5c0f\u6392\u7a0b\u53ca\u8cc7\u6e90\u5206\u914d\u55ae\u5143\uff0cPod \u4e4b\u9593\u76f8\u4e92\u9694\u96e2\uff0c\u901a\u5e38\u60c5\u6cc1\u4e00\u500b Pod \u53ea\u5efa\u8b70\u57f7\u884c\u4e00\u500b\u5bb9\u5668\uff0c\u7576\u67d0\u4e9b\u5bb9\u5668\u4e4b\u9593\u95dc\u4fc2\u975e\u5e38\u7dca\u5bc6\uff08Tightly coupled\uff09\uff0c\u53ef\u4ee5\u57f7\u884c\u5728\u540c\u4e00Pod \u57f7\u884c\u591a\u500b\u5bb9\u5668\u65b9\u4fbf\u4e00\u8d77\u6392\u7a0b\u7ba1\u7406\u3002\u4e00\u500b Pod \u5c31\u662f\u4e00\u500b\u61c9\u7528\u57f7\u884c\u5be6\u4f8b\uff0c\u901a\u904e\u540c\u6642\u57f7\u884c\u591a\u500b Pod \u4f86\u5be6\u73fe\u61c9\u7528\u6a6b\u5411\u64f4\u5145\u5957\u4ef6\u80fd\u529b\u3002Pod \u672c\u8eab\u6c92\u6709\u81ea\u6062\u5fa9\u80fd\u529b\uff0c\u7576\u6392\u7a0b\u6216\u57f7\u884c\u5931\u6557\u6642\uff0c\u9700\u8981\u7ba1\u7406\u7bc0\u9ede\u7684 Controller \u89f8\u767c\u5be6\u73fe Pod \u91cd\u555f\u3001\u91cd\u5efa\u6216\u9077\u79fb\u7b49\u64cd\u4f5c\u3002 Kubernetes \u6700\u5c0f\u6392\u7a0b Pod \u7684 Container \u5206\u985e\u53ca\u555f\u52d5\u904e\u7a0b \u5f9e Pod\u555f\u52d5\u904e\u7a0b \u4f86\u770b\uff0cPod \u5bb9\u5668\u4e3b\u8981\u662f Pause Container \uff0c Init Container \u4ee5\u53ca App Container \u4e09\u7a2e\u985e\u578b\u5bb9\u5668\u7d44\u6210\uff1a Pause Container \uff1a\u53c8\u53eb Infra Container\uff0cPod \u901a\u904e Pause Container \u5be6\u73fe Pod \u591a\u500b\u5bb9\u5668\u7db2\u8def\u5171\u4eab\uff0cPause Container \u6700\u5148\u555f\u52d5\u4e26\u7e6b\u7d50 Pod \u552f\u4e00 IP \u5730\u5740\u8207\u5404\u7a2e\u7db2\u8def\u8cc7\u6e90\uff0c\u5176\u4ed6\u5bb9\u5668\u901a\u904e\u52a0\u5165Pause Container \u7684 Network namespace \u4f86\u5be6\u73fe\u7db2\u8def\u5171\u4eab\u3002Pause \u662f C\u8a9e\u8a00\u5be6\u73fe\uff0c\u6620\u8c61\u975e\u5e38\u5c0f\u96bb\u6709700KB\u5de6\u53f3\uff0c\u4e26\u4e14\u6c38\u9060\u8655\u65bcPause(\u66ab\u505c)\u72c0\u614b\uff1b\u5b98\u65b9\u6620\u8c61\u662f gcr.io/google_containers/pause-amd64:3.0\uff0c\u540c\u6642\u4e5f\u652f\u63f4\u81ea\u5b9a\u7fa9\u3002 Init Container \uff1aPod \u4e2d\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b Init Container\uff0c\u6309\u7167\u9806\u5e8f\u4f9d\u6b21\u555f\u52d5\uff0c\u5728\u61c9\u7528 Container \u4e4b\u524d\u555f\u52d5\u4e26\u57f7\u884c\u4e00\u4e9b\u8f14\u52a9\u4efb\u52d9\uff0c\u6bd4\u5982\u57f7\u884c\u6307\u4ee4\u78bc\u3001\u62f7\u8c9d\u6a94\u6848\u5230\u5171\u4eab\u76ee\u9304\u3001\u65e5\u8a8c\u6536\u96c6\u3001\u61c9\u7528\u76e3\u63a7\u7b49\u3002\u5c07\u8f14\u52a9\u529f\u80fd\u8207\u4e3b\u696d\u52d9\u5bb9\u5668\u89e3\u8026\uff0c\u5be6\u73fe\u7368\u7acb\u91cb\u51fa\u548c\u80fd\u529b\u91cd\u7528\u3002 \u9664\u4e86\u4e0d\u652f\u63f4 Readiness Probe\uff0c\u5176\u4ed6\u8207\u7279\u6027\u8207\u666e\u901a\u5bb9\u5668\u4fdd\u6301\u4e00\u81f4\u3002 App Container \uff1aPod \u4e2d\u771f\u6b63\u627f\u63a5\u696d\u52d9\u7684 Container\uff0c\u4e00\u822c\u60c5\u6cc1\u6703\u7368\u7acb\u57f7\u884c\uff0c\u5982\u679c\u662f\u6709\u5fae\u670d\u52d9\u6cbb\u7406\u7b49\u9700\u6c42\u6703\u642d\u914d Sidecar Container \u4e00\u8d77\u57f7\u884c\u3002\u5728 Init Container \u555f\u52d5\u5b8c\u6210\u4e4b\u5f8c\uff0cApp Container \u6703\u4e26\u884c\u555f\u52d5\uff0c\u4f46\u662f\u9700\u8981\u7b49\u5f85\u6240\u6709 App Container \u8655\u65bc\u5c31\u7dd2\u72c0\u614b\uff0c\u6574\u500b Pod \u624d\u7b97\u555f\u52d5\u6210\u529f\u3002 \u5f9e POD \u7684\u8cc7\u6e90\u9694\u96e2 \u4f86\u770b\uff0cPod \u5bb9\u5668\u4e3b\u8981\u7531 Linux \u63d0\u4f9b\u7684 Namespace \u548c Cgroup \u80fd\u529b\u5be6\u73fe\u7684\uff0cNamespace \u5be6\u73fe\u7a0b\u5e8f\u9593\u9694\u96e2\uff0cCgroup \u5be6\u73fe\u7a0b\u5e8f\u8cc7\u6e90\u63a7\u5236\uff1b\u5176\u4e2d Namespace \u7531 ipc \u3001uts \u3001net \u3001mnt \u3001pid \u5404\u7a2e\u8cc7\u6e90\u7a7a\u9593\u806f\u5408\u7d44\u6210\u3002 CRI \u662f Kubernetes v1.5 \u5f15\u5165\u7684\uff0c\u5c07 Kubelet \u8207\u5bb9\u5668\u57f7\u884c runtime \u89e3\u8026\uff1bCRI \u4e2d\u5b9a\u7fa9\u4e86 \u5bb9\u5668 \u548c \u6620\u8c61 \u7684\u670d\u52d9\u7684\u4ecb\u9762\uff0c\u56e0\u70ba\u5bb9\u5668\u57f7\u884c\u6642\u8207\u6620\u8c61\u7684\u751f\u547d\u9031\u671f\u662f\u5f7c\u6b64\u9694\u96e2\u7684\uff0c\u6240\u4ee5\u5b9a\u7fa9\u4e86 RuntimeService \u548c ImageService \u5169\u500b\u670d\u52d9\uff0c\u5176\u4e2d RuntimeService \u4e3b\u8981\u5305\u542b Sandbox \u548c Container \u5169\u7a2e\u5bb9\u5668\u7684\u7ba1\u7406 gRPC \u4ecb\u9762\uff0cSandbox \u5c31\u662f\u4e0a\u9762 Pod \u555f\u52d5\u904e\u7a0b\u4e2d\u63d0\u5230\u7684 Pause \u5bb9\u5668 \u3002\u76ee\u524d\u652f\u63f4 CRI \u7684\u5f8c\u7aef\u6709 cri-o\uff0ccri-containerd\uff0crkt\uff0cfrakti\uff0cdocker \u7b49\uff0ccri-o \u662f\u7531 redhat \u767c\u8d77\u4e26\u958b\u6e90\u4e14\u7531\u793e\u7fa4\u9a45\u52d5\u7684 container-runtime\uff0c\u8f15\u91cf\u5316\u5c08\u70ba kubernetes \u800c\u751f\uff0c\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u66ff\u4ee3 docker \u4f5c\u70ba kubernetes \u53e2\u96c6\u7684\u5bb9\u5668\u57f7\u884c runtime\u3002 Volume \u5132\u5b58\u5377\uff0cKubernetes \u8907\u96dc\u7684\u5132\u5b58\u67b6\u69cb \u00b6 \u5132\u5b58\u975e\u5e38\u91cd\u8981\u95dc\u9375\uff0c\u540c\u6642\u4e5f\u662f\u751f\u614b\u8207\u6280\u8853\u90fd\u6bd4\u8f03\u8907\u96dc\u7684\u9818\u57df\uff0c\u5c31 linux\u3001window \u5169\u500b\u751f\u614b\u652f\u63f4\u7684\u6a94\u6848\u7cfb\u7d71\u5c31\u591a\u905420+\u3002\u5c0d\u65bc Kubernete \u5132\u5b58\u67b6\u69cb\u8a2d\u8a08\u4e00\u76f4\u5728\u6301\u7e8c\u6f14\u9032\u5b8c\u5584\uff0c\u70ba\u4e86\u5118\u53ef\u80fd\u591a\u5730\u76f8\u5bb9\u5404\u7a2e\u5132\u5b58\u5e73\u81fa\uff0cKubernetes \u4ee5 in-tree plugin \u7684\u5f62\u5f0f\u9810\u8a2d\u5c0d\u63a5\u5f88\u591a\u4e0d\u540c\u578b\u5225\u7684\u5132\u5b58\u7cfb\u7d71\uff1b\u540c\u6642\u4e5f\u652f\u63f4\u57fa\u65bc FlexVolume \u548c CSI \u5916\u639b\u4ee5 out-of-tree plugin \u4f86\u5be6\u73fe\u81ea\u5b9a\u7fa9\u5132\u5b58\u670d\u52d9\u3002 \u5c0d Kubernetes \u5132\u5b58\uff0c\u4e3b\u8981\u6709 \u61c9\u7528\u7684\u57fa\u672c\u914d\u7f6e\u6a94\u6848\u8b80\u53d6\u3001\u5bc6\u78bc\u91d1\u9470\u7ba1\u7406\uff1b\u61c9\u7528\u7684\u5132\u5b58\u72c0\u614b\u3001\u8cc7\u6599\u5b58\u53d6\uff0c\u4e0d\u540c\u61c9\u7528\u9593\u8cc7\u6599\u5171\u4eab \u7b49\u4e09\u5927\u4f7f\u7528\u5834\u666f\u3002\u76ee\u524d Kubernetes \u652f\u63f4\u7684 Volume Plugins \u5982\u4e0b\u8868\uff1a Temp Ephermeral(Local) Persistent(Networked) Others \u2022 Empty Dir \u2022 Host Path \u2022 Git Repo \u2022 Local \u2022 Secret \u2022 ConfigMap \u2022 DownwardAPI \u2022 AWS ElasticBlockStore(EBS) \u2022 GCE Persistent Disk \u2022 Azure Data Disk \u2022 Azure File Storage \u2022 vSphere \u2022 Ceph FS and RBD \u2022 GlusterFS \u2022 iSCSI \u2022 Cinder \u2022 Dell EMC ScalelO \u2022 Longhorn \u2022 ... \u2022 Flex Volume \u2022 Container Storage lnterface(CSI,new in vl.9) Empty Dir \uff1a\u751f\u547d\u9031\u671f\u8207 Pod \u4fdd\u6301\u4e00\u81f4\uff0c\u7576 Pod \u522a\u9664\u5f8c emptyDir \u4e2d\u7684\u8cc7\u6599\u4e5f\u6703\u88ab\u81ea\u52d5\u6e05\u9664\u3002\u7576\u524d emptyDir \u652f\u63f4\u7684\u578b\u5225\u6709\u8a18\u61b6\u9ad4\u3001\u5927\u9801\u8a18\u61b6\u9ad4\u3001Node \u7bc0\u9ede\u4e0a Pod \u6240\u5728\u7684\u6a94\u6848\u7cfb\u7d71\u3002 ConfigMap \uff1a\u4e3b\u8981\u662f\u627f\u64d4\u914d\u7f6e\u4e2d\u5fc3\uff0c\u7528\u65bc\u5132\u5b58\u61c9\u7528\u7684\u914d\u7f6e\u8cc7\u6599\uff0c\u6bd4\u5982 Springboot \u61c9\u7528 properties \u914d\u7f6e\u6a94\u6848\u8cc7\u6599\uff0c\u4f46\u662f\u7a7a\u9593\u5927\u5c0f\u9650\u5236\u5728 1MB \u5167\u3002 Secret \uff1a\u529f\u80fd\u8207 ConfigMap \u985e\u4f3c\uff0c\u7528\u65bc\u5132\u5b58\u61c9\u7528\u7684\u654f\u611f\u8cc7\u6599\uff0c\u6bd4\u5982\u8cc7\u6599\u5bc6\u78bc\u3001token\u3001\u8b49\u66f8\u7b49\uff0c\u53ef\u4ee5\u8207 ConfigMap \u806f\u5408\u4f7f\u7528\uff0c\u540c\u6a23\u7a7a\u9593\u5927\u5c0f\u9650\u5236\u5728 1MB \u5167\u3002 HostPath \uff1a\u5c07 Node \u7bc0\u9ede\u672c\u5730\u6a94\u6848\u7cfb\u7d71\u8def\u5f91\u5c0d\u6620\u5230 pod \u5bb9\u5668\u4e2d\u4f7f\u7528\u3002\u8207 emptyDir \u4e0d\u540c\u4e4b\u8655\u5c31\u662f Pod \u522a\u9664\u5f8c\uff0cHostPath \u4e2d\u7684\u8cc7\u6599 Kubernetes \u6839\u64da\u4f7f\u7528\u8005\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u4e0d\u88ab\u6e05\u9664\u3002 In-tree \u7db2\u8def\u5132\u5b58\uff1a\u7db2\u8def\u5132\u5b58\u8ddf\u96a8 Pod \u7684\u751f\u547d\u9031\u671f\uff0c\u901a\u904e\u5132\u5b58\u5916\u639b\u5c0d\u63a5\u4e0d\u540c\u578b\u5225\u5132\u5b58\uff1b\u5176\u4e2d FlexVolume \u96d6\u7136\u5141\u8a31\u81ea\u5b9a\u7fa9\u958b\u767c\u9a45\u52d5\u4f86\u639b\u8f09\u6372\u5230\u53e2\u96c6 Node \u7bc0\u9ede\u4e0a\u4f9b Pod \u4f7f\u7528\uff0c\u4f46\u751f\u547d\u9031\u671f\u8207 pod \u540c\u6b65\u3002 PersistentVolumeClaim \u7db2\u8def\u5132\u5b58\uff1a\u5177\u6709\u7368\u7acb\u7684\u751f\u547d\u9031\u671f\uff0c\u53ef\u4ee5\u901a\u904e\u5132\u5b58\u7684 out-tree \u5916\u639b\u5c0d\u63a5\u4e0d\u540c\u578b\u5225\u5132\u5b58\u3002\u7576\u524d\u652f\u63f4\u7684\u5132\u5b58\u5916\u639b\u578b\u5225\u6709 FlexVolume \u8207 CSI\u3002 \u5f15\u5165 PV\u3001PVC\u3001StorageClass \u4e4b\u5f8c\uff0c\u8cc7\u6e90\u7ba1\u63a7\u66f4\u52a0\u9748\u6d3b\uff0c\u5718\u968a\u8077\u8cac\u66f4\u52a0\u660e\u78ba\uff0c\u7814\u767c\u4eba\u54e1\u53ea\u9700\u8003\u616e\u5132\u5b58\u9700\u6c42\uff08IO\u3001\u5bb9\u91cf\u3001\u8a2a\u554f\u6a21\u5f0f\u7b49\uff09\uff0c\u4e0d\u9700\u8981\u95dc\u6ce8\u5e95\u5c64\u5132\u5b58\u7d30\u7bc0\uff1b\u5e95\u5c64\u8907\u96dc\u7684\u7d30\u7bc0\u90fd\u7531\u5c08\u696d\u7684\u53e2\u96c6\u7ba1\u7406\u8207\u5132\u5b58\u7ba1\u7406\u54e1\u4f86\u5b8c\u6210\u3002 CSI \u662f Kubernetes 1.9 \u7248\u672c\u958b\u59cb\u5f15\u5165\uff0c\u5efa\u7acb\u4e00\u5957\u6a19\u6e96\u7684\u5132\u5b58\u7ba1\u7406\u4ecb\u9762\uff0c\u901a\u904e\u8a72\u4ecb\u9762\u70ba\u5bb9\u5668\u63d0\u4f9b\u5132\u5b58\u670d\u52d9\u3002\u5f9e\u800c\u5be6\u73fe Kubernetes \u5e73\u81fa\u8207\u5132\u5b58\u670d\u52d9\u9a45\u52d5\u5b8c\u5168\u89e3\u8026\u3002CSI \u4e3b\u8981\u5305\u542b CSI Controller Server \u8207 CSI Node Server \u5169\u500b\u90e8\u5206, Controller Server \u4e3b\u8981\u5be6\u73fe\u5efa\u7acb\u3001\u522a\u9664\u3001\u639b\u8f09\u3001\u89e3\u9664\u5b89\u88dd\u7b49\u63a7\u5236\u529f\u80fd\uff1b Node Server \u4e3b\u8981\u5be6\u73fe\u7684\u662f Node \u7bc0\u9ede\u4e0a\u7684 mount\u3001unmount\u7684\u64cd\u4f5c\u3002 \u57fa\u65bc CSI \u5be6\u73fe\u7684\u6301\u4e45\u5316 Volume \u7684\u5275\u5efa\u548c\u639b\u8f09\u6d41\u7a0b\u5982\u4e0b\uff1a \u7528\u6236\u63d0\u4ea4 PVC\uff0cKubernetes \u5e73\u53f0\u81ea\u52d5\u5275\u5efa\u51fa PV Kubernetes \u5e73\u53f0\u5c07 PV \u548c PVC \u9032\u884c\u7d81\u5b9a \u90e8\u7f72 Pod \u4e26\u4f7f\u7528\u5df2\u5275\u5efa\u7684 PVC\uff0cKubernetes \u5c07 Pod \u8abf\u5ea6\u5230\u67d0\u5bbf\u4e3b\u6a5f Kubernetes \u5c07 PVC \u5c0d\u61c9\u7684 Volume \u9032\u884c Attach \u5230\u5c0d\u61c9\u5bbf\u4e3b\u6a5f \u5bbf\u4e3b\u6a5f\u4e0a\u7684 kubelet \u5b8c\u6210 Volume \u7684 Mount \u64cd\u4f5c CSI Controller Server \u548c External CSI SideCar \u662f\u901a\u904e Unix Socket \u4f86\u9032\u884c\u901a\u8a0a\u7684\uff0cCSI Node Server \u548c Kubelet \u4e5f\u662f\u901a\u904e Unix Socket \u4f86\u901a\u8a0a\u3002CSI \u5be6\u73fe\u985e\u4e5f\u65e5\u8da8\u5b8c\u5584\uff0c\u6bd4\u5982 ExpandCSIVolumes \u53ef\u4ee5\u5be6\u73fe\u6a94\u6848\u7cfb\u7d71\u64f4\u5bb9\uff1b VolumeSnapshotDataSource \u53ef\u4ee5\u5be6\u73fe\u8cc7\u6599\u5377\u7684\u5feb\u7167\uff1b VolumePVCDataSource \u5be6\u73fe\u81ea\u5b9a\u7fa9\u5b9a PVC \u8cc7\u6599\u4f86\u6e90\uff1bCSIInlineVolume\u5728Volume \u4e2d\u5b9a\u7fa9\u4e00\u4e9b CSI \u7684\u9a45\u52d5\u3002\u963f\u91cc\u96f2\u4e5f\u958b\u6e90\u4e86\u963f\u91cc\u96f2\u76e4\u3001NAS\u3001CPFS\u3001OSS\u3001LVM \u7b49 CSI\u5132\u5b58\u5916\u639b\u3002 Ingress \u8207 Service\uff0c\u767e\u82b1\u9f4a\u653e\u7684 Kubernetes \u7db2\u8def \u00b6 Kubernetes \u5bb9\u5668\u7db2\u8def\u975e\u5e38\u8907\u96dc\uff0c\u6d89\u53ca\u7684\u6982\u5ff5\u4e5f\u6bd4\u8f03\u591a\uff0c\u6bd4\u5982 Pod \u7db2\u8def\uff0cService \u7db2\u8def\uff0cCluster IP\uff0cNodePort\uff0cLoadBalancer \u548c Ingress \u7b49\uff0c\u70ba\u6b64\u5c07 Kubernetes \u7684\u7db2\u8def\u53c3\u8003TCP/IP\u5354\u8b70\u68e7\u62bd\u8c61\u70ba\u56db\u5c64\uff1a \u7b2c0\u5c64 \uff1aNode \u7bc0\u9ede\u7db2\u8def\u6bd4\u8f03\u7c21\u55ae\uff0c\u5c31\u662f\u4fdd\u8b49 Kubernetes \u7bc0\u9ede(\u7269\u7406\u6216\u865b\u64ec\u6a5f\u5668)\u4e4b\u9593\u80fd\u5920\u6b63\u5e38 IP \u5b9a\u5740\u548c\u4e92\u901a\u7684\u7db2\u8def\uff0c\u4e00\u822c\u7531\u5e95\u5c64(\u516c\u6709\u96f2\u6216\u8cc7\u6599\u4e2d\u5fc3) \u7db2\u8def\u57fa\u790e\u8a2d\u65bd\u652f\u63f4 \u3002 \u7b2c1\u5c64 \uff1aPod \u662f Kubernetes \u7684\u6700\u5c0f\u6392\u7a0b\u55ae\u5143\uff0c Pod \u7db2\u8def \u5c31\u662f\u78ba\u4fdd Kubernetes \u53e2\u96c6\u4e2d\u6240\u6709Pod(\u5305\u62ec\u540c\u4e00\u7bc0\u9ede\u53ca\u4e0d\u540c\u7bc0\u9ede\u4e0a\u7684Pod)\uff0c\u908f\u8f2f\u4e0a\u5728\u540c\u4e00\u500b\u5e73\u9762\u7db2\u8def\u5167\uff0c\u80fd\u5920\u76f8\u4e92 IP \u5b9a\u5740\u548c\u901a\u8a0a\u7684\u7db2\u8def\u3002\u662f\u5bb9\u5668\u7db2\u8def\u6700\u8907\u96dc\u90e8\u5206\uff0c\u901a\u904e\u5404\u7a2e\u5bb9\u5668\u7db2\u8def\u5916\u639b\u6eff\u8db3\u4e0d\u540c\u7db2\u8def\u9700\u6c42\uff0c\u901a\u904e CNI \u6a19\u6e96\u5316 \u53ca\u958b\u653e\u7db2\u8def\u81ea\u5b9a\u7fa9\u80fd\u529b\u3002 \u7b2c3\u5c64 \uff1a\u96d6\u7136\u55ae\u500b Pod \u90fd\u6709 IP\uff0c\u4f46\u662f\u8207 Pod \u751f\u547d\u9031\u671f\u4e00\u81f4\uff0c\u70ba\u4e86\u89e3\u6c7a\u4e00\u7d44\u76f8\u540c Pod \u7d71\u4e00\u7a69\u5b9a\u7684\u8a2a\u554f\u5730\u5740\uff0c\u4e26\u4e14\u5c07\u8acb\u6c42\u5747\u8861\u7684\u5206\u767c\u5230\u5f8c\u7aef Pod \u61c9\u7528\u670d\u52d9\u4e2d\u3002Kubernetes \u5f15\u5165\u4e86**Service \u7db2\u8def** \uff0c\u4ee5\u6b64\u5be6\u73fe \u670d\u52d9\u767c\u73fe(Service Discovery) \u548c \u8ca0\u8f09\u5747\u8861(Load Balancing) \u80fd\u529b\uff0c\u5e95\u5c64\u662f\u901a\u904e Kube-Proxy + iptables \u8f49\u767c\u5be6\u73fe\uff0c\u5c0d\u61c9\u7528\u7121\u4fb5\u5165\u4e14\u4e0d\u7a7f\u900f\u4ee3\u7406\uff0c\u6c92\u6709\u984d\u5916\u6548\u80fd\u640d\u8017\u3002 \u7b2c4\u5c64 \uff1aKubernetes Service \u7db2\u8def \u662f\u53e2\u96c6\u5167\u90e8\u7db2\u8def\uff0c\u53e2\u96c6\u5916\u90e8\u662f\u7121\u6cd5\u8a2a\u554f\uff0c\u9700\u8981\u5c07\u5167\u90e8\u670d\u52d9\u66b4\u9732\u5916\u90e8\u624d\u80fd\u8a2a\u554f\u3002Kubernetes \u901a\u904e NodePort \uff0c LoadBalancer \u548c Ingress \u591a\u500b\u65b9\u5f0f\u69cb\u5efa\u5916\u90e8\u7db2\u8def\u63a5\u5165\u80fd\u529b\u3002 \u578b\u5225 \u4f5c\u7528 \u5be6\u73fe \u7bc0\u9ede\u7db2\u8def Master/Worker\u7bc0\u9ede\u4e4b\u9593\u7db2\u8def\u4e92\u901a \u8def\u7531\u5668\uff0c\u4ea4\u63db\u6a5f\uff0c\u7db2\u7d61\u5361 Pod\u7db2\u8def Pod\u865b\u64ec\u6a5f\u5668\u4e4b\u9593\u4e92\u901a \u865b\u64ec\u7db2\u7d61\u5361\uff0c\u865b\u64ec\u7db2\u6a4b\uff0c\u7db2\u7d61\u5361\uff0c\u8def\u7531\u5668or\u8986\u84cb\u7db2\u8def Service\u7db2\u8def \u670d\u52d9\u767c\u73fe+\u8ca0\u8f09\u5747\u8861 Kube-proxy, Kubelet, Master, Kube-DNS NodePort \u5c07Service\u66b4\u9732\u5728\u7bc0\u9ede\u7db2\u8def\u4e0a Kube-proxy LoadBalancer \u5c07Service\u66b4\u9732\u5728\u516c\u7db2\u4e0a+\u8ca0\u8f09\u5747\u8861 \u516c\u6709\u4e91 LB + NodePort Ingress \u53cd\u5411\u8def\u7531\uff0c\u5b89\u5168\uff0c\u65e5\u8a8c\u76e3\u63a7 \uff08\u985e\u4f3c\u53cd\u5411\u4ee3\u7406or\u9598\u9053\u5668\uff09 Nginx/Envoy/Traefik/Zuul/SpringCloudGateway CNI \u6700\u65e9\u662f\u7531 CoreOS \u767c\u8d77\u7684\u5bb9\u5668\u7db2\u8def\u898f\u7bc4\uff0c\u662f Kubernetes \u7db2\u8def\u5916\u639b\u7684\u57fa\u790e\u3002Container Runtime \u5728\u5efa\u7acb\u5bb9\u5668\u6642\uff0c\u5148\u5efa\u7acb\u597d network namespace\uff0c\u518d\u547c\u53eb CNI \u5916\u639b\u70banetwork namespace \u914d\u7f6e\u7db2\u8def\uff0c\u6700\u5f8c\u555f\u52d5\u5bb9\u5668\u5167\u7a0b\u5e8f\u3002CNI \u5916\u639b\u5305\u62ec CNI Plugin \u8207 IPAM Plugin \u5169\u90e8\u5206\uff1a CNI Plugin \uff1a\u8ca0\u8cac\u914d\u7f6e\u7ba1\u7406\u5bb9\u5668\u7db2\u8def\uff0c\u5305\u62ec\u5169\u500b\u57fa\u672c\u7684\u4ecb\u9762\uff1a \u7db2\u8def\u914d\u7f6e: AddNetwork(net NetworkConfig, rt RuntimeConf) (types.Result, error) \u6e05\u7406\u7db2\u8def: DelNetwork(net NetworkConfig, rt RuntimeConf) error IPAM Plugin \uff1a\u8ca0\u8cac\u5bb9\u5668 IP \u5730\u5740\u5206\u914d\uff0c\u5be6\u73fe\u5305\u62ec host-local \u548c dhcp\u3002 \u5bb9\u5668\u7db2\u8def\u6280\u8853\u4e5f\u5728\u6301\u7e8c\u6f14\u9032\u767c\u5c55\uff0c\u793e\u7fa4\u958b\u6e90\u7684\u7db2\u8def\u5143\u4ef6\u773e\u591a\uff0c\u6bd4\u5982 Flannel\u3001Calico\u3001Cilium\u3001OVN \u7b49\uff0c\u6bcf\u500b\u5143\u4ef6\u90fd\u6709\u5404\u81ea\u7684\u512a\u9ede\u53ca\u9069\u61c9\u7684\u5834\u666f\uff0c\u96e3\u4ee5\u5f62\u6210\u5927\u4e00\u7d71\u7684\u5143\u4ef6\u53ca\u89e3\u6c7a\u65b9\u6848\u3002 Workload \u5de5\u4f5c\u8ca0\u8f09\uff0cKubernetes \u61c9\u7528\u4e2d\u5fc3\u7406\u5ff5 \u00b6 Kubernetes\u652f\u63f4\u591a\u7a2e\u578b\u5225\u7684\u5bb9\u5668\u5de5\u4f5c\u8ca0\u8f09\u53ca\u547c\u53eb\u95dc\u4fc2 Kubernetes \u901a\u904e \u5de5\u4f5c\u8ca0\u8f09 Workload \u5be6\u73fe\u61c9\u7528\u7ba1\u7406\u90e8\u7f72\u8207\u91cb\u51fa\uff0c\u8e10\u884c Kubernetes \u4ee5\u61c9\u7528\u70ba\u4e2d\u5fc3\u7684\u7406\u5ff5\u3002Kubernetes \u652f\u63f4\u591a\u7a2e\u578b\u5225\u7684\u5de5\u4f5c\u8ca0\u8f09\uff0c\u5305\u542b Deployment\u3001StatefulSet\u3001ReplicaSet\u3001Job\u3001CronJob\u3001DaemonSet\uff0c\u4ee5\u6eff\u8db3\u4e0d\u540c\u5834\u666f\u7684\u9700\u6c42\u3002 Deployment \u8207 ReplicaSet \uff1a\u66ff\u63db\u539f\u4f86\u7684 ReplicationController \u7269\u4ef6\uff0c\u7ba1\u7406\u90e8\u7f72 \u7121\u72c0\u614b\u61c9\u7528 \uff0cDeployment \u7ba1\u7406\u4e0d\u540c\u7248\u672c\u7684 ReplicaSet\uff0cReplicaSet \u7406\u76f8\u540c\u7248\u672c\u7684Pod\uff0c\u901a\u904e Deployment \u8abf\u6574 ReplicaSet \u7684\u7d42\u614b\u526f\u672c\u6578\uff0c\u63a7\u5236\u5668\u6703\u7dad\u6301\u5be6\u969b\u57f7\u884c\u7684 Pod \u6578\u91cf\u8207\u671f\u671b\u7684\u6578\u91cf\u4e00\u81f4\uff0cPod \u51fa\u6545\u969c\u6642\u6703\u81ea\u52d5\u91cd\u555f\u6216\u6062\u5fa9\u3002 StatefulSet \uff1a\u7ba1\u7406\u90e8\u7f72 \u6709\u72c0\u614b\u61c9\u7528 \uff0c\u5efa\u7acb\u7684 Pod \u64c1\u6709\u6839\u64da\u898f\u7bc4\u5efa\u7acb\u7684\u6301\u4e45\u578b\u8b58\u5225\u7b26\u865f\u3002Pod\u9077\u79fb\u6216\u92b7\u71ec\u91cd\u555f\u5f8c\uff0c\u8b58\u5225\u7b26\u865f\u4ecd\u6703\u4fdd\u7559\u3002\u5982\u6bcf\u500bPod\u6709\u5e8f\u865f\uff0c\u53ef\u4ee5\u6309\u5e8f\u865f\u5efa\u7acb\u66f4\u65b0\u6216\u522a\u9664\uff1bPod\u6709\u552f\u4e00\u7db2\u8def\u6a19\u8a8c (hostname)\u6216\u7368\u4eab\u7684\u5132\u5b58 PV,\u652f\u63f4\u7070\u5ea6\u4f48\u7f72\u7b49\u3002 DaemonSet \uff1a\u7ba1\u7406\u90e8\u7f72\u6bcf\u500b\u7bc0\u9ede\u57f7\u884c\u7684 \u5b88\u8b77\u4efb\u52d9 \uff0c\u5982\u76e3\u63a7\u3001\u65e5\u8a8c\u6536\u96c6\u7b49\u3002\u65b0\u52a0\u5165\u7684\u7bc0\u9ede\u4e5f\u57f7\u884c\uff0c\u79fb\u51fa\u7bc0\u9ede\u662f\u9700\u8981\u522a\u9664\u3002\u4e5f\u53ef\u4ee5\u901a\u904e\u6a19\u7c64\u7684\u6307\u5b9a\u57f7\u884c\u7bc0\u9ede\u3002 Job \u8207 Cronjob \uff1aJob\u662f \u4e00\u6b21\u6027\u4efb\u52d9 \uff0c\u53ef\u5efa\u7acb\u4e00\u500b\u6216\u591a\u500b Pod\uff0c\u76e3\u63a7 Pod \u662f\u5426\u6210\u529f\u57f7\u884c\u6216\u7d42\u6b62\uff1b\u6839\u64da Pod \u72c0\u614b\u8a2d\u5b9a\u91cd\u8907\u6b21\u6578\u3001\u4f75\u767c\u5ea6\u3001\u91cd\u555f\u7b56\u7565\u3002Cronjob \u662f\u5b9a\u6642\u6392\u7a0b\u7684 Job,\u53ef\u4ee5\u6307\u5b9a\u57f7\u884c\u6642\u9593\u3001\u7b49\u5f85\u6642\u9593\u3001\u662f\u5426\u4e26\u884c\u57f7\u884c\u3001\u57f7\u884c\u6b21\u6578\u9650\u5236\u3002 \u5728 Kubernetes \u751f\u614b\u4e2d\uff0c\u9084\u6709\u4e00\u4e9b\u63d0\u4f9b\u984d\u5916\u64cd\u4f5c\u7684\u7b2c\u4e09\u65b9\u5de5\u4f5c\u8ca0\u8f09\u3002\u540c\u6642\u4e5f\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 CRD \u81ea\u5b9a\u7fa9\u5de5\u4f5c\u8ca0\u8f09\u3002\u9084\u6709\u5c31\u662f Device Plugin \u9a45\u52d5\u7684\u786c\u9ad4\u5de5\u4f5c\u8ca0\u8f09\uff0c\u6703\u5728\u5f8c\u7e8c\u7ae0\u7bc0\u8a73\u7d30\u8b1b\u89e3\u3002 Controller \u63a7\u5236\u5668\uff0cKubernetes \u96c6\u63a7\u7ba1\u7406\u4e2d\u5fc3 \u00b6 Controller Manager \u4f5c\u70ba Kubernetes \u96c6\u63a7\u7ba1\u7406\u4e2d\u5fc3\uff0c\u8ca0\u8cac\u53e2\u96c6\u7684 Node\u3001Pod \u526f\u672c\u3001\u670d\u52d9\u7aef\u9ede\uff08Endpoint\uff09\u3001\u540d\u7a31\u7a7a\u9593\uff08Namespace\uff09\u3001\u670d\u52d9\u8cec\u865f\uff08ServiceAccount\uff09\u3001\u8cc7\u6e90\u5b9a\u984d\uff08ResourceQuota\uff09\u7684\u8cc7\u6e90\u7ba1\u7406\uff0c\u4e26\u901a\u904e API Server \u4ecb\u9762\u5be6\u6642\u76e3\u63a7\u53e2\u96c6\u7684\u6bcf\u500b\u8cc7\u6e90\u7269\u4ef6\u7684\u72c0\u614b\uff0c\u4e00\u65e6\u767c\u751f\u6545\u969c\u5c0e\u81f4\u7cfb\u7d71\u72c0\u614b\u767c\u751f\u8b8a\u5316\uff0c\u5c31\u6703\u7acb\u5373\u5617\u8a66\u4fee\u5fa9\u5230\u201c\u671f\u671b\u72c0\u614b\u201d\u3002 Replication Controller \uff1a\u4fdd\u8b49\u53e2\u96c6\u4e2d\u4e00\u500bRC\u6240\u95dc\u806f\u7684 Pod \u526f\u672c\u6578\u59cb\u7d42\u4fdd\u6301\u9810\u8a2d\u503c\u3002 ResourceQuota Controller \uff1a\u78ba\u4fdd Kubernetes \u4e2d\u7684\u8cc7\u6e90\u7269\u4ef6\u5728\u4efb\u4f55\u6642\u5019\u90fd\u4e0d\u6703\u8d85\u91cf\u4f54\u7528\u7cfb\u7d71\u7269\u7406\u8cc7\u6e90\u3002\u6709\u5bb9\u5668\uff0cPod \u4ee5\u53ca Namespace \u4e09\u500b\u7d1a\u5225\u3002 Namespace Controller \uff1a\u901a\u904e API Server \u5b9a\u6642\u8b80\u53d6 Namespace \u8cc7\u8a0a\u3002\u5982\u679c Namespace \u88ab API \u6a19\u8a18\u70ba\u512a\u96c5\u522a\u9664\uff08\u5373\u8a2d\u5b9a\u522a\u9664\u671f\u9650\uff0cDeletionTimestamp\uff09,\u5247\u5c07\u8a72Namespace \u72c0\u614b\u8a2d\u5b9a\u70ba \u201cTerminating\u201d,\u4e26\u5132\u5b58\u5230 etcd \u4e2d\u3002\u540c\u6642\u522a\u9664\u8a72 Namespace \u4e0b\u7684 ServiceAccount\u3001RC\u3001Pod \u7b49\u8cc7\u6e90\u7269\u4ef6\u3002 Endpoint Controller \uff1aEndpoints \u662f Service \u5c0d\u61c9\u6240\u6709 Pod \u526f\u672c\u7684\u8a2a\u554f\u5730\u5740\uff0cEndpoint Controller \u4e3b\u8981\u8ca0\u8cac\u76e3\u807d Service \u548c\u5c0d\u61c9\u7684 Pod \u526f\u672c\u7684\u8b8a\u5316\uff0c\u5f9e\u800c\u751f\u6210\u548c\u7dad\u8b77 Endpoints \u7269\u4ef6\u63a7\u5236\u5668\u3002 Deployment Controller \uff1aDeployment \u901a\u904e\u63a7\u5236 ReplicaSet\uff0cReplicaSet \u518d\u63a7\u5236 Pod\uff0c\u6700\u7d42\u7531 Deployment Controller \u9a45\u52d5\u9054\u5230\u671f\u671b\u72c0\u614b\uff0cDeployment Controller \u6703\u76e3\u807d DeploymentInformer\u3001ReplicaSetInformer\u3001PodInformer \u4e09\u7a2e\u8cc7\u6e90\u3002 \u53e6\u5916\uff0c\u5728 Kubernetes v1.6 \u5f15\u5165\u4e86\u96f2\u63a7\u5236\u7ba1\u7406\u5668 Cloud Controller Manager\uff08CCM\uff09\uff0c\u63d0\u4f9b\u8207\u6709\u96f2\u57fa\u790e\u7522\u54c1\u5c0d\u63a5\u7684\u652f\u63f4\uff0c\u5f8c\u7e8c\u4e5f\u6703\u8a73\u7d30\u8b1b\u89e3\u3002 \u7e3d\u7d50 \u00b6 \u7e3d\u7d50\u4e00\u4e0b\uff0cKubernetes \u4e0d\u50c5\u662f\u4e00\u500b\u5f37\u5927\u7684\u5bb9\u5668\u7de8\u6392\u7cfb\u7d71\u672c\u8eab\uff0c\u800c\u4e14\u4fc3\u9032\u4e86\u4e00\u500b\u9f90\u5927\u7684\u5de5\u5177\u548c\u670d\u52d9\u7684\u751f\u614b\u7cfb\u7d71\uff0c \u96f2\u539f\u751f\u6642\u4ee3\u7684\u4f5c\u696d\u7cfb\u7d71\uff0c\u5f62\u6210\u96f2\u7aef\u8a08\u7b97\u65b0\u4ecb\u9762 \u3002 \u5f9e\u8a2d\u8a08\u7406\u5ff5\u65b9\u9762 \uff0cKubernetes \u662f\u4ee5**\u61c9\u7528\u70ba\u4e2d\u5fc3**\u7684\u69cb\u5efa\u7406\u5ff5\uff0c \u5411\u4e0b \u906e\u853d\u57fa\u790e\u8a2d\u65bd\u5dee\u7570\uff0c\u5be6\u73fe\u5e95\u5c64\u57fa\u790e\u8cc7\u6e90\u7d71\u4e00\u6392\u7a0b\u53ca\u7de8\u6392\uff1b \u5411\u4e0a \u901a\u904e\u5bb9\u5668\u6620\u8c61\u6a19\u6e96\u5316\u61c9\u7528\uff0c\u5be6\u73fe\u61c9\u7528\u8ca0\u8f09\u81ea\u52d5\u5316\u90e8\u7f72\uff1b \u4e2d\u9593 \u901a\u904e Kubernetes \u901a\u7528\u7684\u7de8\u6392\u80fd\u529b\uff0c\u958b\u653e API \u4ee5\u53ca\u81ea\u5b9a\u7fa9 CRD \u64f4\u5145\u5957\u4ef6\u80fd\u529b\uff1b \u5f9e\u6280\u8853\u67b6\u69cb\u65b9\u9762 \uff0cKubernetes \u662f\u5178\u578b\u7684\u5206\u6563\u5f0f\u4e3b\u5f9e\u67b6\u69cb\uff0c\u7531 Master \u63a7\u5236\u7bc0\u9ede\u8207\u53ef\u4ee5\u6c34\u5e73\u64f4\u5145\u5957\u4ef6\u7684 Worker \u5de5\u4f5c\u7bc0\u9ede\u7d44\u6210\uff0cMaster \u5be6\u73fe\u96c6\u4e2d\u5f0f\u63a7\u5236\u7ba1\u7406\uff0cWorker \u5be6\u73fe\u5206\u6563\u5f0f\u57f7\u884c\uff1b\u8207 Openstack \u7684\u67b6\u69cb\u9084\u6709\u57fa\u65bc SpringCloud \u7814\u767c\u7684\u5206\u5fae\u670d\u696d\u52d9\u61c9\u7528\u6c92\u6709\u592a\u5927\u5340\u5225\u3002 \u5f9e\u8a2d\u8a08\u6a21\u5f0f\u65b9\u9762 \uff0cKubernetes \u901a\u904e\u5b9a\u7fa9\u5927\u91cf\u7684\u6a21\u578b\uff08\u539f\u8a9e\u3001\u8cc7\u6e90\u7269\u4ef6\u3001\u914d\u7f6e\u3001\u5e38\u7528\u7684 CRD\uff09\uff0c\u901a\u904e\u914d\u7f6e\u7ba1\u7406\u6a21\u578b\u5be6\u73fe\u53e2\u96c6\u8cc7\u6e90\u7684\u63a7\u5236\uff1b\u96d6\u7136\u6a21\u578b\u591a\u4e14\u8907\u96dc\uff0c\u4f46\u662f\u53ef\u4ee5\u5206\u5c64\uff08\u6838\u5fc3\u5c64\uff0c\u9694\u96e2\u8207\u670d\u52d9\u8a2a\u554f\u5c64\uff0c\u6392\u7a0b\u5c64\uff0c\u8cc7\u6e90\u5c64\uff09\u9010\u6b65\u7406\u89e3\u3002 \u5f9e\u5e73\u81fa\u64f4\u5145\u5957\u4ef6\u65b9\u9762 \uff0cKubernetes \u662f\u4e00\u500b\u958b\u653e\u53ef\u64f4\u5145\u5957\u4ef6\u5e73\u81fa\uff0c\u4e0d\u50c5\u6709\u958b\u767c\u7684 API\uff0c\u958b\u653e\u6a19\u6e96\uff08CNI\uff0cCSI\uff0cCRI\u7b49\uff09\u4ee5\u53ca CRD\uff0c\u4e0d\u50c5\u662f\u4e00\u500b\u55ae\u7d14\u57f7\u884c\u6642\u5e73\u81fa\uff0c\u540c\u6642\u9762\u5411\u904b\u7dad\u7684\u958b\u767c\u5e73\u81fa\u3002","title":"K8S \u67b6\u69cb\u89e3\u6790"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#kubernetes","text":"\u4f5c\u8005: \u5de8\u5b50\u5609 \u539f\u6587: Kubernetes \u5bb9\u5668\u5e73\u53f0\u67b6\u6784\u4e4b\u9053 Kubernetes\u662f \u4e00\u500b\u958b\u6e90\u5bb9\u5668\u7de8\u6392\u5e73\u81fa\uff0c\u7ba1\u7406\u5927\u898f\u6a21\u5206\u6563\u5f0f\u5bb9\u5668\u5316\u8edf\u9ad4\u61c9\u7528 \uff0c\u662f\u96f2\u8a08\u7b97\u767c\u5c55\u6f14\u9032\u7684\u4e00\u6b21\u5fb9\u5e95\u9769\u547d\u6027\u7684\u7a81\u7834\u3002Kubernetes \u662f\u8c37\u6b4c\u7684\u7b2c\u4e09\u4ee3\u5bb9\u5668\u7ba1\u7406\u7cfb\u7d71\uff0c\u662f Borg \u7368\u7279\u7684\u63a7\u5236\u5668\u548c Omega \u9748\u6d3b\u7684\u6392\u7a0b\u5668\u7684\u7d44\u5408\u3002Kubernetes \u4e2d\u7684\u61c9\u7528\u88ab\u6253\u5305\u6210\u8207\u74b0\u5883\u5b8c\u5168\u5206\u96e2\u7684\u5bb9\u5668\u6620\u8c61\uff0c\u4e26\u4e14\u81ea\u52d5\u914d\u7f6e\u61c9\u7528\u4e26\u7dad\u8b77\u8ddf\u8e64\u8cc7\u6e90\u5206\u914d\u3002 Kubernetes \u662f\u4ee5 \u61c9\u7528\u70ba\u4e2d\u5fc3 \u7684\u6280\u8853\u67b6\u69cb\u8207\u601d\u60f3\u7406\u5ff5\uff0c \u5411\u4e0b \u906e\u853d\u57fa\u790e\u8a2d\u65bd\u5dee\u7570\uff0c\u5be6\u73fe\u5e95\u5c64\u57fa\u790e\u8cc7\u6e90\u7d71\u4e00\u6392\u7a0b\u53ca\u7de8\u6392\uff1b \u5411\u4e0a \u901a\u904e\u5bb9\u5668\u6620\u8c61\u6a19\u6e96\u5316\u61c9\u7528\uff0c\u5be6\u73fe\u61c9\u7528\u8ca0\u8f09\u81ea\u52d5\u5316\u90e8\u7f72\uff1b\u4e2d\u9593\u901a\u904e Kubernetes \u901a\u7528\u7684\u7de8\u6392\u80fd\u529b\uff0c\u958b\u653e API \u4ee5\u53ca\u81ea\u5b9a\u7fa9 CRD \u64f4\u5145\u5957\u4ef6\u80fd\u529b\uff0c\u6253\u9020\u96f2\u539f\u751f\u4f5c\u696d\u7cfb\u7d71\u80fd\u529b\uff0c\u5f62\u6210\u96f2\u7aef\u8a08\u7b97\u65b0\u4ecb\u9762\uff1b\u52a9\u529b\u7814\u767c\u5718\u968a \u5feb\u901f\u69cb\u5efa\u6a19\u6e96\u5316\u3001\u5f48\u6027\u9ad8\u53ef\u9760\u3001\u677e\u8026\u5408\u3001\u6613\u7ba1\u7406\u7dad\u8b77\u7684\u61c9\u7528\u7cfb\u7d71\uff0c\u63d0\u5347\u4ea4\u4ed8\u6548\u7387\uff0c\u964d\u4f4e\u904b\u7dad\u8907\u96dc\u5ea6 \u3002Kubernetes \u5728\u6280\u8853\u67b6\u69cb\u65b9\u9762\u5177\u5099\u4e09\u500b\u80fd\u529b\uff1a \u654f\u6377\u7684\u5f48\u6027\u4f38\u7e2e\u80fd\u529b \uff1a\u4e0d\u540c\u65bc\u865b\u64ec\u6a5f\u5668\u5206\u9418\u7d1a\u7684\u5f48\u6027\u4f38\u7e2e\u97ff\u61c9\uff0c\u5bb9\u5668\u61c9\u7528\u53ef\u5be6\u73fe\u79d2\u7d1a\u751a\u81f3\u6beb\u79d2\u7d1a\u7684\u5f48\u6027\u4f38\u7e2e\u97ff\u61c9\uff1b \u667a\u6167\u7684\u670d\u52d9\u6545\u969c\u81ea\u6108\u80fd\u529b \uff1a\u5bb9\u5668\u61c9\u7528\u5177\u6709\u6975\u5f37\u7684\u81ea\u6108\u80fd\u529b\uff0c\u53ef\u5be6\u73fe\u61c9\u7528\u6545\u969c\u7684\u81ea\u52d5\u6458\u9664\u8207\u91cd\u69cb\uff1b \u5927\u898f\u6a21\u7684\u8907\u88fd\u5206\u767c\u80fd\u529b \uff1a\u5bb9\u5668\u61c9\u7528\u6a19\u6e96\u5316\u7684\u4ea4\u4ed8\u88fd\u54c1\uff0c\u53ef\u5be6\u73fe\u8de8\u5e73\u81fa\u3001\u8de8\u5340\u57df\uff0c\u96f2\u908a\u4e00\u9ad4\u898f\u6a21\u5316\u8907\u88fd\u5206\u767c\u90e8\u7f72\u80fd\u529b\u3002","title":"Kubernetes \u5bb9\u5668\u5e73\u81fa\u67b6\u69cb\u89e3\u6790"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#kubernetes_1","text":"Kubernetes \u4e3b\u5f9e\u5206\u6563\u5f0f\u67b6\u69cb\u5716 Kubernetes \u662f\u5178\u578b\u7684\u4e3b\u5f9e\u5206\u6563\u5f0f\u67b6\u69cb\uff0c\u7531 \u96c6\u4e2d\u5f0f\u7ba1\u7406\u7bc0\u9ede \uff08Master Node\uff09, \u5206\u6563\u5f0f\u7684\u5de5\u4f5c\u7bc0\u9ede \uff08Worker Node\uff09\u7d44\u6210\u4ee5\u53ca\u8f14\u52a9\u5de5\u5177\u7d44\u6210\u3002","title":"Kubernetes \u6574\u9ad4\u67b6\u69cb"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#master-node","text":"\u96c6\u4e2d\u5f0f\u7ba1\u7406\u7bc0\u9ede \uff0c\u5c0d\u53e2\u96c6\u9032\u884c\u6392\u7a0b\u7ba1\u7406\uff0c\u6709\u56db\u5927\u6838\u5fc3\u5143\u4ef6: API Server \uff1a\u627f\u64d4\u53e2\u96c6\u7684\u9598\u9053\u5668\uff0c\u5be6\u73fe\u7d71\u4e00\u8a8d\u8b49\u9451\u6b0a\u5c0d\u5916\u670d\u52d9\uff0c\u540c\u6642\u4e5f\u662f\u7ba1\u7406 Node/Pod \u8cc7\u6e90\u4ee3\u7406\u901a\u9053\uff1b Scheduler \uff1a\u8cc7\u6e90\u6392\u7a0b\u5668\uff0c\u9664\u4e86 Kubernetes \u9810\u8a2d\u7684\u6392\u7a0b\u5668\uff0c\u4e5f\u652f\u63f4\u81ea\u5b9a\u7fa9\u6392\u7a0b\u5668\uff1b ETCD \uff1a\u53e2\u96c6\u72c0\u614b\u7d71\u4e00\u5132\u5b58\uff0c\u8207 Zookeeper \u985e\u4f3c\u7684 key-value \u5132\u5b58\uff1b Controller Manger \uff1a\u63a7\u5236\u7ba1\u7406\u5668\u5be6\u73fe\u81ea\u6108\u3001\u64f4\u5bb9\u3001\u61c9\u7528\u751f\u547d\u9031\u671f\u7ba1\u7406\u3001\u670d\u52d9\u767c\u73fe\u3001\u8def\u7531\u3001\u670d\u52d9\u7e6b\u7d50\u7b49\u80fd\u529b\uff1bKubernetes \u9810\u8a2d\u63d0\u4f9b Replication Controller\u3001Node Controller\u3001Namespace Controller\u3001Service Controller\u3001Endpoints Controller\u3001Persistent Controller\u3001DaemonSet Controller\u7b49\u63a7\u5236\u5668\u3002","title":"\u96c6\u4e2d\u5f0f\u7ba1\u7406\u7bc0\u9ede Master Node"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#worker-node","text":"\u5206\u6563\u5f0f\u7684\u5de5\u4f5c\u7bc0\u9ede \uff0c\u5de5\u4f5c\u7bc0\u9ede\u57f7\u884c\u696d\u52d9\u61c9\u7528\u5bb9\u5668\uff1b\u9810\u8a2d\u6703\u57f7\u884c\u4e09\u5927\u6838\u5fc3\u5143\u4ef6\uff1a Kubelet \uff1a\u8207\u7ba1\u7406\u7bc0\u9ede\u901a\u8a0a\u4e26\u89f8\u767c\u6307\u4ee4\u57f7\u884c\uff0c\u7ba1\u7406\u9a45\u52d5\u7db2\u8def\uff0c\u5132\u5b58\u53ca\u5bb9\u5668\u57f7\u884c\u6642\uff1b Kube Proxy \uff1a\u901a\u904e DNS \u5be6\u73fe\u670d\u52d9\u767c\u73fe\uff0c\u85c9\u52a9 iptables \u898f\u5247\u5f15\u5c0e\u8a2a\u554f\u81f3\u670d\u52d9 IP\uff0c\u4e26\u5c07\u91cd\u5b9a\u5411\u81f3\u6b63\u78ba\u7684\u5f8c\u7aef\u61c9\u7528\uff0c\u5be6\u73fe\u9ad8\u53ef\u7528\u8ca0\u8f09\u5747\u8861\u80fd\u529b\uff1b Container Runtime \uff1a\u5bb9\u5668\u57f7\u884c\u6642\u3002\u70ba\u4e86\u64f4\u5145\u5957\u4ef6 Kubernetes \u5e73\u81fa\u9069\u914d\u80fd\u529b\uff0c\u540c\u6642\u4e5f\u6a19\u6e96\u5316\u6574\u500b\u751f\u614b\uff0c\u901a\u904e CNI \u8207 CSI \u6a19\u6e96\u898f\u7bc4\u7db2\u8def\u53ca\u5132\u5b58 \u7684\u64f4\u5145\u5957\u4ef6\uff1b\u901a\u904e CRI \u8207 OCI \u6a19\u6e96\u898f\u7bc4\u5bb9\u5668\u6620\u8c61\u53ca\u5bb9\u5668\u57f7\u884c \u6642\u7684\u64f4\u5145\u5957\u4ef6\uff1b\u76ee\u524d CRI \u652f\u63f4\u7684\u5bb9\u5668\u57f7\u884c\u6642\u6709 docker\u3001rkt\u3001cri-o\u3001frankti\u3001kata-containers \u548c clear-containers\u7b49\u3002","title":"\u5206\u6563\u5f0f\u7684\u5de5\u4f5c\u7bc0\u9ede Worker Node"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#_1","text":"\u8f14\u52a9\u5de5\u5177\uff0c\u4e3b\u8981\u662f\u8f14\u52a9\u53e2\u96c6\u7ba1\u7406\u53ca\u7db2\u8def\u64f4\u5145\u5957\u4ef6: kubectl \u901a\u904e API Server \u9032\u884c\u4e92\u52d5\uff0c\u5be6\u73fe\u53e2\u96c6\u7ba1\u7406\u7684\u547d\u4ee4\u5217\u5de5\u5177\uff1b Dashboard \u662fKubernetes\u7684web\u4f7f\u7528\u8005\u7ba1\u7406\u76e3\u63a7\u4ecb\u9762\uff1b Core DNS \u662f\u53ef\u64f4\u5145\u5957\u4ef6\u7684 DNS \u4f3a\u670d\u5668\uff0c\u5be6\u73fe\u53e2\u96c6\u670d\u52d9\u767c\u73fe\u80fd\u529b\u3002","title":"\u8f14\u52a9\u5de5\u5177"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#kubernetes_2","text":"","title":"Kubernetes \u6838\u5fc3\u6982\u5ff5"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#pod-kubernetes","text":"Pod \u662f Kubernetes \u7684\u6700\u5c0f\u6392\u7a0b\u53ca\u8cc7\u6e90\u5206\u914d\u55ae\u5143\uff0cPod \u4e4b\u9593\u76f8\u4e92\u9694\u96e2\uff0c\u901a\u5e38\u60c5\u6cc1\u4e00\u500b Pod \u53ea\u5efa\u8b70\u57f7\u884c\u4e00\u500b\u5bb9\u5668\uff0c\u7576\u67d0\u4e9b\u5bb9\u5668\u4e4b\u9593\u95dc\u4fc2\u975e\u5e38\u7dca\u5bc6\uff08Tightly coupled\uff09\uff0c\u53ef\u4ee5\u57f7\u884c\u5728\u540c\u4e00Pod \u57f7\u884c\u591a\u500b\u5bb9\u5668\u65b9\u4fbf\u4e00\u8d77\u6392\u7a0b\u7ba1\u7406\u3002\u4e00\u500b Pod \u5c31\u662f\u4e00\u500b\u61c9\u7528\u57f7\u884c\u5be6\u4f8b\uff0c\u901a\u904e\u540c\u6642\u57f7\u884c\u591a\u500b Pod \u4f86\u5be6\u73fe\u61c9\u7528\u6a6b\u5411\u64f4\u5145\u5957\u4ef6\u80fd\u529b\u3002Pod \u672c\u8eab\u6c92\u6709\u81ea\u6062\u5fa9\u80fd\u529b\uff0c\u7576\u6392\u7a0b\u6216\u57f7\u884c\u5931\u6557\u6642\uff0c\u9700\u8981\u7ba1\u7406\u7bc0\u9ede\u7684 Controller \u89f8\u767c\u5be6\u73fe Pod \u91cd\u555f\u3001\u91cd\u5efa\u6216\u9077\u79fb\u7b49\u64cd\u4f5c\u3002 Kubernetes \u6700\u5c0f\u6392\u7a0b Pod \u7684 Container \u5206\u985e\u53ca\u555f\u52d5\u904e\u7a0b \u5f9e Pod\u555f\u52d5\u904e\u7a0b \u4f86\u770b\uff0cPod \u5bb9\u5668\u4e3b\u8981\u662f Pause Container \uff0c Init Container \u4ee5\u53ca App Container \u4e09\u7a2e\u985e\u578b\u5bb9\u5668\u7d44\u6210\uff1a Pause Container \uff1a\u53c8\u53eb Infra Container\uff0cPod \u901a\u904e Pause Container \u5be6\u73fe Pod \u591a\u500b\u5bb9\u5668\u7db2\u8def\u5171\u4eab\uff0cPause Container \u6700\u5148\u555f\u52d5\u4e26\u7e6b\u7d50 Pod \u552f\u4e00 IP \u5730\u5740\u8207\u5404\u7a2e\u7db2\u8def\u8cc7\u6e90\uff0c\u5176\u4ed6\u5bb9\u5668\u901a\u904e\u52a0\u5165Pause Container \u7684 Network namespace \u4f86\u5be6\u73fe\u7db2\u8def\u5171\u4eab\u3002Pause \u662f C\u8a9e\u8a00\u5be6\u73fe\uff0c\u6620\u8c61\u975e\u5e38\u5c0f\u96bb\u6709700KB\u5de6\u53f3\uff0c\u4e26\u4e14\u6c38\u9060\u8655\u65bcPause(\u66ab\u505c)\u72c0\u614b\uff1b\u5b98\u65b9\u6620\u8c61\u662f gcr.io/google_containers/pause-amd64:3.0\uff0c\u540c\u6642\u4e5f\u652f\u63f4\u81ea\u5b9a\u7fa9\u3002 Init Container \uff1aPod \u4e2d\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b Init Container\uff0c\u6309\u7167\u9806\u5e8f\u4f9d\u6b21\u555f\u52d5\uff0c\u5728\u61c9\u7528 Container \u4e4b\u524d\u555f\u52d5\u4e26\u57f7\u884c\u4e00\u4e9b\u8f14\u52a9\u4efb\u52d9\uff0c\u6bd4\u5982\u57f7\u884c\u6307\u4ee4\u78bc\u3001\u62f7\u8c9d\u6a94\u6848\u5230\u5171\u4eab\u76ee\u9304\u3001\u65e5\u8a8c\u6536\u96c6\u3001\u61c9\u7528\u76e3\u63a7\u7b49\u3002\u5c07\u8f14\u52a9\u529f\u80fd\u8207\u4e3b\u696d\u52d9\u5bb9\u5668\u89e3\u8026\uff0c\u5be6\u73fe\u7368\u7acb\u91cb\u51fa\u548c\u80fd\u529b\u91cd\u7528\u3002 \u9664\u4e86\u4e0d\u652f\u63f4 Readiness Probe\uff0c\u5176\u4ed6\u8207\u7279\u6027\u8207\u666e\u901a\u5bb9\u5668\u4fdd\u6301\u4e00\u81f4\u3002 App Container \uff1aPod \u4e2d\u771f\u6b63\u627f\u63a5\u696d\u52d9\u7684 Container\uff0c\u4e00\u822c\u60c5\u6cc1\u6703\u7368\u7acb\u57f7\u884c\uff0c\u5982\u679c\u662f\u6709\u5fae\u670d\u52d9\u6cbb\u7406\u7b49\u9700\u6c42\u6703\u642d\u914d Sidecar Container \u4e00\u8d77\u57f7\u884c\u3002\u5728 Init Container \u555f\u52d5\u5b8c\u6210\u4e4b\u5f8c\uff0cApp Container \u6703\u4e26\u884c\u555f\u52d5\uff0c\u4f46\u662f\u9700\u8981\u7b49\u5f85\u6240\u6709 App Container \u8655\u65bc\u5c31\u7dd2\u72c0\u614b\uff0c\u6574\u500b Pod \u624d\u7b97\u555f\u52d5\u6210\u529f\u3002 \u5f9e POD \u7684\u8cc7\u6e90\u9694\u96e2 \u4f86\u770b\uff0cPod \u5bb9\u5668\u4e3b\u8981\u7531 Linux \u63d0\u4f9b\u7684 Namespace \u548c Cgroup \u80fd\u529b\u5be6\u73fe\u7684\uff0cNamespace \u5be6\u73fe\u7a0b\u5e8f\u9593\u9694\u96e2\uff0cCgroup \u5be6\u73fe\u7a0b\u5e8f\u8cc7\u6e90\u63a7\u5236\uff1b\u5176\u4e2d Namespace \u7531 ipc \u3001uts \u3001net \u3001mnt \u3001pid \u5404\u7a2e\u8cc7\u6e90\u7a7a\u9593\u806f\u5408\u7d44\u6210\u3002 CRI \u662f Kubernetes v1.5 \u5f15\u5165\u7684\uff0c\u5c07 Kubelet \u8207\u5bb9\u5668\u57f7\u884c runtime \u89e3\u8026\uff1bCRI \u4e2d\u5b9a\u7fa9\u4e86 \u5bb9\u5668 \u548c \u6620\u8c61 \u7684\u670d\u52d9\u7684\u4ecb\u9762\uff0c\u56e0\u70ba\u5bb9\u5668\u57f7\u884c\u6642\u8207\u6620\u8c61\u7684\u751f\u547d\u9031\u671f\u662f\u5f7c\u6b64\u9694\u96e2\u7684\uff0c\u6240\u4ee5\u5b9a\u7fa9\u4e86 RuntimeService \u548c ImageService \u5169\u500b\u670d\u52d9\uff0c\u5176\u4e2d RuntimeService \u4e3b\u8981\u5305\u542b Sandbox \u548c Container \u5169\u7a2e\u5bb9\u5668\u7684\u7ba1\u7406 gRPC \u4ecb\u9762\uff0cSandbox \u5c31\u662f\u4e0a\u9762 Pod \u555f\u52d5\u904e\u7a0b\u4e2d\u63d0\u5230\u7684 Pause \u5bb9\u5668 \u3002\u76ee\u524d\u652f\u63f4 CRI \u7684\u5f8c\u7aef\u6709 cri-o\uff0ccri-containerd\uff0crkt\uff0cfrakti\uff0cdocker \u7b49\uff0ccri-o \u662f\u7531 redhat \u767c\u8d77\u4e26\u958b\u6e90\u4e14\u7531\u793e\u7fa4\u9a45\u52d5\u7684 container-runtime\uff0c\u8f15\u91cf\u5316\u5c08\u70ba kubernetes \u800c\u751f\uff0c\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u66ff\u4ee3 docker \u4f5c\u70ba kubernetes \u53e2\u96c6\u7684\u5bb9\u5668\u57f7\u884c runtime\u3002","title":"POD \u5bb9\u5668\u7d44\uff0cKubernetes \u6700\u5c0f\u6392\u7a0b\u55ae\u5143"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#volume-kubernetes","text":"\u5132\u5b58\u975e\u5e38\u91cd\u8981\u95dc\u9375\uff0c\u540c\u6642\u4e5f\u662f\u751f\u614b\u8207\u6280\u8853\u90fd\u6bd4\u8f03\u8907\u96dc\u7684\u9818\u57df\uff0c\u5c31 linux\u3001window \u5169\u500b\u751f\u614b\u652f\u63f4\u7684\u6a94\u6848\u7cfb\u7d71\u5c31\u591a\u905420+\u3002\u5c0d\u65bc Kubernete \u5132\u5b58\u67b6\u69cb\u8a2d\u8a08\u4e00\u76f4\u5728\u6301\u7e8c\u6f14\u9032\u5b8c\u5584\uff0c\u70ba\u4e86\u5118\u53ef\u80fd\u591a\u5730\u76f8\u5bb9\u5404\u7a2e\u5132\u5b58\u5e73\u81fa\uff0cKubernetes \u4ee5 in-tree plugin \u7684\u5f62\u5f0f\u9810\u8a2d\u5c0d\u63a5\u5f88\u591a\u4e0d\u540c\u578b\u5225\u7684\u5132\u5b58\u7cfb\u7d71\uff1b\u540c\u6642\u4e5f\u652f\u63f4\u57fa\u65bc FlexVolume \u548c CSI \u5916\u639b\u4ee5 out-of-tree plugin \u4f86\u5be6\u73fe\u81ea\u5b9a\u7fa9\u5132\u5b58\u670d\u52d9\u3002 \u5c0d Kubernetes \u5132\u5b58\uff0c\u4e3b\u8981\u6709 \u61c9\u7528\u7684\u57fa\u672c\u914d\u7f6e\u6a94\u6848\u8b80\u53d6\u3001\u5bc6\u78bc\u91d1\u9470\u7ba1\u7406\uff1b\u61c9\u7528\u7684\u5132\u5b58\u72c0\u614b\u3001\u8cc7\u6599\u5b58\u53d6\uff0c\u4e0d\u540c\u61c9\u7528\u9593\u8cc7\u6599\u5171\u4eab \u7b49\u4e09\u5927\u4f7f\u7528\u5834\u666f\u3002\u76ee\u524d Kubernetes \u652f\u63f4\u7684 Volume Plugins \u5982\u4e0b\u8868\uff1a Temp Ephermeral(Local) Persistent(Networked) Others \u2022 Empty Dir \u2022 Host Path \u2022 Git Repo \u2022 Local \u2022 Secret \u2022 ConfigMap \u2022 DownwardAPI \u2022 AWS ElasticBlockStore(EBS) \u2022 GCE Persistent Disk \u2022 Azure Data Disk \u2022 Azure File Storage \u2022 vSphere \u2022 Ceph FS and RBD \u2022 GlusterFS \u2022 iSCSI \u2022 Cinder \u2022 Dell EMC ScalelO \u2022 Longhorn \u2022 ... \u2022 Flex Volume \u2022 Container Storage lnterface(CSI,new in vl.9) Empty Dir \uff1a\u751f\u547d\u9031\u671f\u8207 Pod \u4fdd\u6301\u4e00\u81f4\uff0c\u7576 Pod \u522a\u9664\u5f8c emptyDir \u4e2d\u7684\u8cc7\u6599\u4e5f\u6703\u88ab\u81ea\u52d5\u6e05\u9664\u3002\u7576\u524d emptyDir \u652f\u63f4\u7684\u578b\u5225\u6709\u8a18\u61b6\u9ad4\u3001\u5927\u9801\u8a18\u61b6\u9ad4\u3001Node \u7bc0\u9ede\u4e0a Pod \u6240\u5728\u7684\u6a94\u6848\u7cfb\u7d71\u3002 ConfigMap \uff1a\u4e3b\u8981\u662f\u627f\u64d4\u914d\u7f6e\u4e2d\u5fc3\uff0c\u7528\u65bc\u5132\u5b58\u61c9\u7528\u7684\u914d\u7f6e\u8cc7\u6599\uff0c\u6bd4\u5982 Springboot \u61c9\u7528 properties \u914d\u7f6e\u6a94\u6848\u8cc7\u6599\uff0c\u4f46\u662f\u7a7a\u9593\u5927\u5c0f\u9650\u5236\u5728 1MB \u5167\u3002 Secret \uff1a\u529f\u80fd\u8207 ConfigMap \u985e\u4f3c\uff0c\u7528\u65bc\u5132\u5b58\u61c9\u7528\u7684\u654f\u611f\u8cc7\u6599\uff0c\u6bd4\u5982\u8cc7\u6599\u5bc6\u78bc\u3001token\u3001\u8b49\u66f8\u7b49\uff0c\u53ef\u4ee5\u8207 ConfigMap \u806f\u5408\u4f7f\u7528\uff0c\u540c\u6a23\u7a7a\u9593\u5927\u5c0f\u9650\u5236\u5728 1MB \u5167\u3002 HostPath \uff1a\u5c07 Node \u7bc0\u9ede\u672c\u5730\u6a94\u6848\u7cfb\u7d71\u8def\u5f91\u5c0d\u6620\u5230 pod \u5bb9\u5668\u4e2d\u4f7f\u7528\u3002\u8207 emptyDir \u4e0d\u540c\u4e4b\u8655\u5c31\u662f Pod \u522a\u9664\u5f8c\uff0cHostPath \u4e2d\u7684\u8cc7\u6599 Kubernetes \u6839\u64da\u4f7f\u7528\u8005\u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u4e0d\u88ab\u6e05\u9664\u3002 In-tree \u7db2\u8def\u5132\u5b58\uff1a\u7db2\u8def\u5132\u5b58\u8ddf\u96a8 Pod \u7684\u751f\u547d\u9031\u671f\uff0c\u901a\u904e\u5132\u5b58\u5916\u639b\u5c0d\u63a5\u4e0d\u540c\u578b\u5225\u5132\u5b58\uff1b\u5176\u4e2d FlexVolume \u96d6\u7136\u5141\u8a31\u81ea\u5b9a\u7fa9\u958b\u767c\u9a45\u52d5\u4f86\u639b\u8f09\u6372\u5230\u53e2\u96c6 Node \u7bc0\u9ede\u4e0a\u4f9b Pod \u4f7f\u7528\uff0c\u4f46\u751f\u547d\u9031\u671f\u8207 pod \u540c\u6b65\u3002 PersistentVolumeClaim \u7db2\u8def\u5132\u5b58\uff1a\u5177\u6709\u7368\u7acb\u7684\u751f\u547d\u9031\u671f\uff0c\u53ef\u4ee5\u901a\u904e\u5132\u5b58\u7684 out-tree \u5916\u639b\u5c0d\u63a5\u4e0d\u540c\u578b\u5225\u5132\u5b58\u3002\u7576\u524d\u652f\u63f4\u7684\u5132\u5b58\u5916\u639b\u578b\u5225\u6709 FlexVolume \u8207 CSI\u3002 \u5f15\u5165 PV\u3001PVC\u3001StorageClass \u4e4b\u5f8c\uff0c\u8cc7\u6e90\u7ba1\u63a7\u66f4\u52a0\u9748\u6d3b\uff0c\u5718\u968a\u8077\u8cac\u66f4\u52a0\u660e\u78ba\uff0c\u7814\u767c\u4eba\u54e1\u53ea\u9700\u8003\u616e\u5132\u5b58\u9700\u6c42\uff08IO\u3001\u5bb9\u91cf\u3001\u8a2a\u554f\u6a21\u5f0f\u7b49\uff09\uff0c\u4e0d\u9700\u8981\u95dc\u6ce8\u5e95\u5c64\u5132\u5b58\u7d30\u7bc0\uff1b\u5e95\u5c64\u8907\u96dc\u7684\u7d30\u7bc0\u90fd\u7531\u5c08\u696d\u7684\u53e2\u96c6\u7ba1\u7406\u8207\u5132\u5b58\u7ba1\u7406\u54e1\u4f86\u5b8c\u6210\u3002 CSI \u662f Kubernetes 1.9 \u7248\u672c\u958b\u59cb\u5f15\u5165\uff0c\u5efa\u7acb\u4e00\u5957\u6a19\u6e96\u7684\u5132\u5b58\u7ba1\u7406\u4ecb\u9762\uff0c\u901a\u904e\u8a72\u4ecb\u9762\u70ba\u5bb9\u5668\u63d0\u4f9b\u5132\u5b58\u670d\u52d9\u3002\u5f9e\u800c\u5be6\u73fe Kubernetes \u5e73\u81fa\u8207\u5132\u5b58\u670d\u52d9\u9a45\u52d5\u5b8c\u5168\u89e3\u8026\u3002CSI \u4e3b\u8981\u5305\u542b CSI Controller Server \u8207 CSI Node Server \u5169\u500b\u90e8\u5206, Controller Server \u4e3b\u8981\u5be6\u73fe\u5efa\u7acb\u3001\u522a\u9664\u3001\u639b\u8f09\u3001\u89e3\u9664\u5b89\u88dd\u7b49\u63a7\u5236\u529f\u80fd\uff1b Node Server \u4e3b\u8981\u5be6\u73fe\u7684\u662f Node \u7bc0\u9ede\u4e0a\u7684 mount\u3001unmount\u7684\u64cd\u4f5c\u3002 \u57fa\u65bc CSI \u5be6\u73fe\u7684\u6301\u4e45\u5316 Volume \u7684\u5275\u5efa\u548c\u639b\u8f09\u6d41\u7a0b\u5982\u4e0b\uff1a \u7528\u6236\u63d0\u4ea4 PVC\uff0cKubernetes \u5e73\u53f0\u81ea\u52d5\u5275\u5efa\u51fa PV Kubernetes \u5e73\u53f0\u5c07 PV \u548c PVC \u9032\u884c\u7d81\u5b9a \u90e8\u7f72 Pod \u4e26\u4f7f\u7528\u5df2\u5275\u5efa\u7684 PVC\uff0cKubernetes \u5c07 Pod \u8abf\u5ea6\u5230\u67d0\u5bbf\u4e3b\u6a5f Kubernetes \u5c07 PVC \u5c0d\u61c9\u7684 Volume \u9032\u884c Attach \u5230\u5c0d\u61c9\u5bbf\u4e3b\u6a5f \u5bbf\u4e3b\u6a5f\u4e0a\u7684 kubelet \u5b8c\u6210 Volume \u7684 Mount \u64cd\u4f5c CSI Controller Server \u548c External CSI SideCar \u662f\u901a\u904e Unix Socket \u4f86\u9032\u884c\u901a\u8a0a\u7684\uff0cCSI Node Server \u548c Kubelet \u4e5f\u662f\u901a\u904e Unix Socket \u4f86\u901a\u8a0a\u3002CSI \u5be6\u73fe\u985e\u4e5f\u65e5\u8da8\u5b8c\u5584\uff0c\u6bd4\u5982 ExpandCSIVolumes \u53ef\u4ee5\u5be6\u73fe\u6a94\u6848\u7cfb\u7d71\u64f4\u5bb9\uff1b VolumeSnapshotDataSource \u53ef\u4ee5\u5be6\u73fe\u8cc7\u6599\u5377\u7684\u5feb\u7167\uff1b VolumePVCDataSource \u5be6\u73fe\u81ea\u5b9a\u7fa9\u5b9a PVC \u8cc7\u6599\u4f86\u6e90\uff1bCSIInlineVolume\u5728Volume \u4e2d\u5b9a\u7fa9\u4e00\u4e9b CSI \u7684\u9a45\u52d5\u3002\u963f\u91cc\u96f2\u4e5f\u958b\u6e90\u4e86\u963f\u91cc\u96f2\u76e4\u3001NAS\u3001CPFS\u3001OSS\u3001LVM \u7b49 CSI\u5132\u5b58\u5916\u639b\u3002","title":"Volume \u5132\u5b58\u5377\uff0cKubernetes \u8907\u96dc\u7684\u5132\u5b58\u67b6\u69cb"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#ingress-service-kubernetes","text":"Kubernetes \u5bb9\u5668\u7db2\u8def\u975e\u5e38\u8907\u96dc\uff0c\u6d89\u53ca\u7684\u6982\u5ff5\u4e5f\u6bd4\u8f03\u591a\uff0c\u6bd4\u5982 Pod \u7db2\u8def\uff0cService \u7db2\u8def\uff0cCluster IP\uff0cNodePort\uff0cLoadBalancer \u548c Ingress \u7b49\uff0c\u70ba\u6b64\u5c07 Kubernetes \u7684\u7db2\u8def\u53c3\u8003TCP/IP\u5354\u8b70\u68e7\u62bd\u8c61\u70ba\u56db\u5c64\uff1a \u7b2c0\u5c64 \uff1aNode \u7bc0\u9ede\u7db2\u8def\u6bd4\u8f03\u7c21\u55ae\uff0c\u5c31\u662f\u4fdd\u8b49 Kubernetes \u7bc0\u9ede(\u7269\u7406\u6216\u865b\u64ec\u6a5f\u5668)\u4e4b\u9593\u80fd\u5920\u6b63\u5e38 IP \u5b9a\u5740\u548c\u4e92\u901a\u7684\u7db2\u8def\uff0c\u4e00\u822c\u7531\u5e95\u5c64(\u516c\u6709\u96f2\u6216\u8cc7\u6599\u4e2d\u5fc3) \u7db2\u8def\u57fa\u790e\u8a2d\u65bd\u652f\u63f4 \u3002 \u7b2c1\u5c64 \uff1aPod \u662f Kubernetes \u7684\u6700\u5c0f\u6392\u7a0b\u55ae\u5143\uff0c Pod \u7db2\u8def \u5c31\u662f\u78ba\u4fdd Kubernetes \u53e2\u96c6\u4e2d\u6240\u6709Pod(\u5305\u62ec\u540c\u4e00\u7bc0\u9ede\u53ca\u4e0d\u540c\u7bc0\u9ede\u4e0a\u7684Pod)\uff0c\u908f\u8f2f\u4e0a\u5728\u540c\u4e00\u500b\u5e73\u9762\u7db2\u8def\u5167\uff0c\u80fd\u5920\u76f8\u4e92 IP \u5b9a\u5740\u548c\u901a\u8a0a\u7684\u7db2\u8def\u3002\u662f\u5bb9\u5668\u7db2\u8def\u6700\u8907\u96dc\u90e8\u5206\uff0c\u901a\u904e\u5404\u7a2e\u5bb9\u5668\u7db2\u8def\u5916\u639b\u6eff\u8db3\u4e0d\u540c\u7db2\u8def\u9700\u6c42\uff0c\u901a\u904e CNI \u6a19\u6e96\u5316 \u53ca\u958b\u653e\u7db2\u8def\u81ea\u5b9a\u7fa9\u80fd\u529b\u3002 \u7b2c3\u5c64 \uff1a\u96d6\u7136\u55ae\u500b Pod \u90fd\u6709 IP\uff0c\u4f46\u662f\u8207 Pod \u751f\u547d\u9031\u671f\u4e00\u81f4\uff0c\u70ba\u4e86\u89e3\u6c7a\u4e00\u7d44\u76f8\u540c Pod \u7d71\u4e00\u7a69\u5b9a\u7684\u8a2a\u554f\u5730\u5740\uff0c\u4e26\u4e14\u5c07\u8acb\u6c42\u5747\u8861\u7684\u5206\u767c\u5230\u5f8c\u7aef Pod \u61c9\u7528\u670d\u52d9\u4e2d\u3002Kubernetes \u5f15\u5165\u4e86**Service \u7db2\u8def** \uff0c\u4ee5\u6b64\u5be6\u73fe \u670d\u52d9\u767c\u73fe(Service Discovery) \u548c \u8ca0\u8f09\u5747\u8861(Load Balancing) \u80fd\u529b\uff0c\u5e95\u5c64\u662f\u901a\u904e Kube-Proxy + iptables \u8f49\u767c\u5be6\u73fe\uff0c\u5c0d\u61c9\u7528\u7121\u4fb5\u5165\u4e14\u4e0d\u7a7f\u900f\u4ee3\u7406\uff0c\u6c92\u6709\u984d\u5916\u6548\u80fd\u640d\u8017\u3002 \u7b2c4\u5c64 \uff1aKubernetes Service \u7db2\u8def \u662f\u53e2\u96c6\u5167\u90e8\u7db2\u8def\uff0c\u53e2\u96c6\u5916\u90e8\u662f\u7121\u6cd5\u8a2a\u554f\uff0c\u9700\u8981\u5c07\u5167\u90e8\u670d\u52d9\u66b4\u9732\u5916\u90e8\u624d\u80fd\u8a2a\u554f\u3002Kubernetes \u901a\u904e NodePort \uff0c LoadBalancer \u548c Ingress \u591a\u500b\u65b9\u5f0f\u69cb\u5efa\u5916\u90e8\u7db2\u8def\u63a5\u5165\u80fd\u529b\u3002 \u578b\u5225 \u4f5c\u7528 \u5be6\u73fe \u7bc0\u9ede\u7db2\u8def Master/Worker\u7bc0\u9ede\u4e4b\u9593\u7db2\u8def\u4e92\u901a \u8def\u7531\u5668\uff0c\u4ea4\u63db\u6a5f\uff0c\u7db2\u7d61\u5361 Pod\u7db2\u8def Pod\u865b\u64ec\u6a5f\u5668\u4e4b\u9593\u4e92\u901a \u865b\u64ec\u7db2\u7d61\u5361\uff0c\u865b\u64ec\u7db2\u6a4b\uff0c\u7db2\u7d61\u5361\uff0c\u8def\u7531\u5668or\u8986\u84cb\u7db2\u8def Service\u7db2\u8def \u670d\u52d9\u767c\u73fe+\u8ca0\u8f09\u5747\u8861 Kube-proxy, Kubelet, Master, Kube-DNS NodePort \u5c07Service\u66b4\u9732\u5728\u7bc0\u9ede\u7db2\u8def\u4e0a Kube-proxy LoadBalancer \u5c07Service\u66b4\u9732\u5728\u516c\u7db2\u4e0a+\u8ca0\u8f09\u5747\u8861 \u516c\u6709\u4e91 LB + NodePort Ingress \u53cd\u5411\u8def\u7531\uff0c\u5b89\u5168\uff0c\u65e5\u8a8c\u76e3\u63a7 \uff08\u985e\u4f3c\u53cd\u5411\u4ee3\u7406or\u9598\u9053\u5668\uff09 Nginx/Envoy/Traefik/Zuul/SpringCloudGateway CNI \u6700\u65e9\u662f\u7531 CoreOS \u767c\u8d77\u7684\u5bb9\u5668\u7db2\u8def\u898f\u7bc4\uff0c\u662f Kubernetes \u7db2\u8def\u5916\u639b\u7684\u57fa\u790e\u3002Container Runtime \u5728\u5efa\u7acb\u5bb9\u5668\u6642\uff0c\u5148\u5efa\u7acb\u597d network namespace\uff0c\u518d\u547c\u53eb CNI \u5916\u639b\u70banetwork namespace \u914d\u7f6e\u7db2\u8def\uff0c\u6700\u5f8c\u555f\u52d5\u5bb9\u5668\u5167\u7a0b\u5e8f\u3002CNI \u5916\u639b\u5305\u62ec CNI Plugin \u8207 IPAM Plugin \u5169\u90e8\u5206\uff1a CNI Plugin \uff1a\u8ca0\u8cac\u914d\u7f6e\u7ba1\u7406\u5bb9\u5668\u7db2\u8def\uff0c\u5305\u62ec\u5169\u500b\u57fa\u672c\u7684\u4ecb\u9762\uff1a \u7db2\u8def\u914d\u7f6e: AddNetwork(net NetworkConfig, rt RuntimeConf) (types.Result, error) \u6e05\u7406\u7db2\u8def: DelNetwork(net NetworkConfig, rt RuntimeConf) error IPAM Plugin \uff1a\u8ca0\u8cac\u5bb9\u5668 IP \u5730\u5740\u5206\u914d\uff0c\u5be6\u73fe\u5305\u62ec host-local \u548c dhcp\u3002 \u5bb9\u5668\u7db2\u8def\u6280\u8853\u4e5f\u5728\u6301\u7e8c\u6f14\u9032\u767c\u5c55\uff0c\u793e\u7fa4\u958b\u6e90\u7684\u7db2\u8def\u5143\u4ef6\u773e\u591a\uff0c\u6bd4\u5982 Flannel\u3001Calico\u3001Cilium\u3001OVN \u7b49\uff0c\u6bcf\u500b\u5143\u4ef6\u90fd\u6709\u5404\u81ea\u7684\u512a\u9ede\u53ca\u9069\u61c9\u7684\u5834\u666f\uff0c\u96e3\u4ee5\u5f62\u6210\u5927\u4e00\u7d71\u7684\u5143\u4ef6\u53ca\u89e3\u6c7a\u65b9\u6848\u3002","title":"Ingress \u8207 Service\uff0c\u767e\u82b1\u9f4a\u653e\u7684 Kubernetes \u7db2\u8def"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#workload-kubernetes","text":"Kubernetes\u652f\u63f4\u591a\u7a2e\u578b\u5225\u7684\u5bb9\u5668\u5de5\u4f5c\u8ca0\u8f09\u53ca\u547c\u53eb\u95dc\u4fc2 Kubernetes \u901a\u904e \u5de5\u4f5c\u8ca0\u8f09 Workload \u5be6\u73fe\u61c9\u7528\u7ba1\u7406\u90e8\u7f72\u8207\u91cb\u51fa\uff0c\u8e10\u884c Kubernetes \u4ee5\u61c9\u7528\u70ba\u4e2d\u5fc3\u7684\u7406\u5ff5\u3002Kubernetes \u652f\u63f4\u591a\u7a2e\u578b\u5225\u7684\u5de5\u4f5c\u8ca0\u8f09\uff0c\u5305\u542b Deployment\u3001StatefulSet\u3001ReplicaSet\u3001Job\u3001CronJob\u3001DaemonSet\uff0c\u4ee5\u6eff\u8db3\u4e0d\u540c\u5834\u666f\u7684\u9700\u6c42\u3002 Deployment \u8207 ReplicaSet \uff1a\u66ff\u63db\u539f\u4f86\u7684 ReplicationController \u7269\u4ef6\uff0c\u7ba1\u7406\u90e8\u7f72 \u7121\u72c0\u614b\u61c9\u7528 \uff0cDeployment \u7ba1\u7406\u4e0d\u540c\u7248\u672c\u7684 ReplicaSet\uff0cReplicaSet \u7406\u76f8\u540c\u7248\u672c\u7684Pod\uff0c\u901a\u904e Deployment \u8abf\u6574 ReplicaSet \u7684\u7d42\u614b\u526f\u672c\u6578\uff0c\u63a7\u5236\u5668\u6703\u7dad\u6301\u5be6\u969b\u57f7\u884c\u7684 Pod \u6578\u91cf\u8207\u671f\u671b\u7684\u6578\u91cf\u4e00\u81f4\uff0cPod \u51fa\u6545\u969c\u6642\u6703\u81ea\u52d5\u91cd\u555f\u6216\u6062\u5fa9\u3002 StatefulSet \uff1a\u7ba1\u7406\u90e8\u7f72 \u6709\u72c0\u614b\u61c9\u7528 \uff0c\u5efa\u7acb\u7684 Pod \u64c1\u6709\u6839\u64da\u898f\u7bc4\u5efa\u7acb\u7684\u6301\u4e45\u578b\u8b58\u5225\u7b26\u865f\u3002Pod\u9077\u79fb\u6216\u92b7\u71ec\u91cd\u555f\u5f8c\uff0c\u8b58\u5225\u7b26\u865f\u4ecd\u6703\u4fdd\u7559\u3002\u5982\u6bcf\u500bPod\u6709\u5e8f\u865f\uff0c\u53ef\u4ee5\u6309\u5e8f\u865f\u5efa\u7acb\u66f4\u65b0\u6216\u522a\u9664\uff1bPod\u6709\u552f\u4e00\u7db2\u8def\u6a19\u8a8c (hostname)\u6216\u7368\u4eab\u7684\u5132\u5b58 PV,\u652f\u63f4\u7070\u5ea6\u4f48\u7f72\u7b49\u3002 DaemonSet \uff1a\u7ba1\u7406\u90e8\u7f72\u6bcf\u500b\u7bc0\u9ede\u57f7\u884c\u7684 \u5b88\u8b77\u4efb\u52d9 \uff0c\u5982\u76e3\u63a7\u3001\u65e5\u8a8c\u6536\u96c6\u7b49\u3002\u65b0\u52a0\u5165\u7684\u7bc0\u9ede\u4e5f\u57f7\u884c\uff0c\u79fb\u51fa\u7bc0\u9ede\u662f\u9700\u8981\u522a\u9664\u3002\u4e5f\u53ef\u4ee5\u901a\u904e\u6a19\u7c64\u7684\u6307\u5b9a\u57f7\u884c\u7bc0\u9ede\u3002 Job \u8207 Cronjob \uff1aJob\u662f \u4e00\u6b21\u6027\u4efb\u52d9 \uff0c\u53ef\u5efa\u7acb\u4e00\u500b\u6216\u591a\u500b Pod\uff0c\u76e3\u63a7 Pod \u662f\u5426\u6210\u529f\u57f7\u884c\u6216\u7d42\u6b62\uff1b\u6839\u64da Pod \u72c0\u614b\u8a2d\u5b9a\u91cd\u8907\u6b21\u6578\u3001\u4f75\u767c\u5ea6\u3001\u91cd\u555f\u7b56\u7565\u3002Cronjob \u662f\u5b9a\u6642\u6392\u7a0b\u7684 Job,\u53ef\u4ee5\u6307\u5b9a\u57f7\u884c\u6642\u9593\u3001\u7b49\u5f85\u6642\u9593\u3001\u662f\u5426\u4e26\u884c\u57f7\u884c\u3001\u57f7\u884c\u6b21\u6578\u9650\u5236\u3002 \u5728 Kubernetes \u751f\u614b\u4e2d\uff0c\u9084\u6709\u4e00\u4e9b\u63d0\u4f9b\u984d\u5916\u64cd\u4f5c\u7684\u7b2c\u4e09\u65b9\u5de5\u4f5c\u8ca0\u8f09\u3002\u540c\u6642\u4e5f\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 CRD \u81ea\u5b9a\u7fa9\u5de5\u4f5c\u8ca0\u8f09\u3002\u9084\u6709\u5c31\u662f Device Plugin \u9a45\u52d5\u7684\u786c\u9ad4\u5de5\u4f5c\u8ca0\u8f09\uff0c\u6703\u5728\u5f8c\u7e8c\u7ae0\u7bc0\u8a73\u7d30\u8b1b\u89e3\u3002","title":"Workload \u5de5\u4f5c\u8ca0\u8f09\uff0cKubernetes \u61c9\u7528\u4e2d\u5fc3\u7406\u5ff5"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#controller-kubernetes","text":"Controller Manager \u4f5c\u70ba Kubernetes \u96c6\u63a7\u7ba1\u7406\u4e2d\u5fc3\uff0c\u8ca0\u8cac\u53e2\u96c6\u7684 Node\u3001Pod \u526f\u672c\u3001\u670d\u52d9\u7aef\u9ede\uff08Endpoint\uff09\u3001\u540d\u7a31\u7a7a\u9593\uff08Namespace\uff09\u3001\u670d\u52d9\u8cec\u865f\uff08ServiceAccount\uff09\u3001\u8cc7\u6e90\u5b9a\u984d\uff08ResourceQuota\uff09\u7684\u8cc7\u6e90\u7ba1\u7406\uff0c\u4e26\u901a\u904e API Server \u4ecb\u9762\u5be6\u6642\u76e3\u63a7\u53e2\u96c6\u7684\u6bcf\u500b\u8cc7\u6e90\u7269\u4ef6\u7684\u72c0\u614b\uff0c\u4e00\u65e6\u767c\u751f\u6545\u969c\u5c0e\u81f4\u7cfb\u7d71\u72c0\u614b\u767c\u751f\u8b8a\u5316\uff0c\u5c31\u6703\u7acb\u5373\u5617\u8a66\u4fee\u5fa9\u5230\u201c\u671f\u671b\u72c0\u614b\u201d\u3002 Replication Controller \uff1a\u4fdd\u8b49\u53e2\u96c6\u4e2d\u4e00\u500bRC\u6240\u95dc\u806f\u7684 Pod \u526f\u672c\u6578\u59cb\u7d42\u4fdd\u6301\u9810\u8a2d\u503c\u3002 ResourceQuota Controller \uff1a\u78ba\u4fdd Kubernetes \u4e2d\u7684\u8cc7\u6e90\u7269\u4ef6\u5728\u4efb\u4f55\u6642\u5019\u90fd\u4e0d\u6703\u8d85\u91cf\u4f54\u7528\u7cfb\u7d71\u7269\u7406\u8cc7\u6e90\u3002\u6709\u5bb9\u5668\uff0cPod \u4ee5\u53ca Namespace \u4e09\u500b\u7d1a\u5225\u3002 Namespace Controller \uff1a\u901a\u904e API Server \u5b9a\u6642\u8b80\u53d6 Namespace \u8cc7\u8a0a\u3002\u5982\u679c Namespace \u88ab API \u6a19\u8a18\u70ba\u512a\u96c5\u522a\u9664\uff08\u5373\u8a2d\u5b9a\u522a\u9664\u671f\u9650\uff0cDeletionTimestamp\uff09,\u5247\u5c07\u8a72Namespace \u72c0\u614b\u8a2d\u5b9a\u70ba \u201cTerminating\u201d,\u4e26\u5132\u5b58\u5230 etcd \u4e2d\u3002\u540c\u6642\u522a\u9664\u8a72 Namespace \u4e0b\u7684 ServiceAccount\u3001RC\u3001Pod \u7b49\u8cc7\u6e90\u7269\u4ef6\u3002 Endpoint Controller \uff1aEndpoints \u662f Service \u5c0d\u61c9\u6240\u6709 Pod \u526f\u672c\u7684\u8a2a\u554f\u5730\u5740\uff0cEndpoint Controller \u4e3b\u8981\u8ca0\u8cac\u76e3\u807d Service \u548c\u5c0d\u61c9\u7684 Pod \u526f\u672c\u7684\u8b8a\u5316\uff0c\u5f9e\u800c\u751f\u6210\u548c\u7dad\u8b77 Endpoints \u7269\u4ef6\u63a7\u5236\u5668\u3002 Deployment Controller \uff1aDeployment \u901a\u904e\u63a7\u5236 ReplicaSet\uff0cReplicaSet \u518d\u63a7\u5236 Pod\uff0c\u6700\u7d42\u7531 Deployment Controller \u9a45\u52d5\u9054\u5230\u671f\u671b\u72c0\u614b\uff0cDeployment Controller \u6703\u76e3\u807d DeploymentInformer\u3001ReplicaSetInformer\u3001PodInformer \u4e09\u7a2e\u8cc7\u6e90\u3002 \u53e6\u5916\uff0c\u5728 Kubernetes v1.6 \u5f15\u5165\u4e86\u96f2\u63a7\u5236\u7ba1\u7406\u5668 Cloud Controller Manager\uff08CCM\uff09\uff0c\u63d0\u4f9b\u8207\u6709\u96f2\u57fa\u790e\u7522\u54c1\u5c0d\u63a5\u7684\u652f\u63f4\uff0c\u5f8c\u7e8c\u4e5f\u6703\u8a73\u7d30\u8b1b\u89e3\u3002","title":"Controller \u63a7\u5236\u5668\uff0cKubernetes \u96c6\u63a7\u7ba1\u7406\u4e2d\u5fc3"},{"location":"kubernetes/02-concepts/02-cluster-architecture/k8s-architecture/#_2","text":"\u7e3d\u7d50\u4e00\u4e0b\uff0cKubernetes \u4e0d\u50c5\u662f\u4e00\u500b\u5f37\u5927\u7684\u5bb9\u5668\u7de8\u6392\u7cfb\u7d71\u672c\u8eab\uff0c\u800c\u4e14\u4fc3\u9032\u4e86\u4e00\u500b\u9f90\u5927\u7684\u5de5\u5177\u548c\u670d\u52d9\u7684\u751f\u614b\u7cfb\u7d71\uff0c \u96f2\u539f\u751f\u6642\u4ee3\u7684\u4f5c\u696d\u7cfb\u7d71\uff0c\u5f62\u6210\u96f2\u7aef\u8a08\u7b97\u65b0\u4ecb\u9762 \u3002 \u5f9e\u8a2d\u8a08\u7406\u5ff5\u65b9\u9762 \uff0cKubernetes \u662f\u4ee5**\u61c9\u7528\u70ba\u4e2d\u5fc3**\u7684\u69cb\u5efa\u7406\u5ff5\uff0c \u5411\u4e0b \u906e\u853d\u57fa\u790e\u8a2d\u65bd\u5dee\u7570\uff0c\u5be6\u73fe\u5e95\u5c64\u57fa\u790e\u8cc7\u6e90\u7d71\u4e00\u6392\u7a0b\u53ca\u7de8\u6392\uff1b \u5411\u4e0a \u901a\u904e\u5bb9\u5668\u6620\u8c61\u6a19\u6e96\u5316\u61c9\u7528\uff0c\u5be6\u73fe\u61c9\u7528\u8ca0\u8f09\u81ea\u52d5\u5316\u90e8\u7f72\uff1b \u4e2d\u9593 \u901a\u904e Kubernetes \u901a\u7528\u7684\u7de8\u6392\u80fd\u529b\uff0c\u958b\u653e API \u4ee5\u53ca\u81ea\u5b9a\u7fa9 CRD \u64f4\u5145\u5957\u4ef6\u80fd\u529b\uff1b \u5f9e\u6280\u8853\u67b6\u69cb\u65b9\u9762 \uff0cKubernetes \u662f\u5178\u578b\u7684\u5206\u6563\u5f0f\u4e3b\u5f9e\u67b6\u69cb\uff0c\u7531 Master \u63a7\u5236\u7bc0\u9ede\u8207\u53ef\u4ee5\u6c34\u5e73\u64f4\u5145\u5957\u4ef6\u7684 Worker \u5de5\u4f5c\u7bc0\u9ede\u7d44\u6210\uff0cMaster \u5be6\u73fe\u96c6\u4e2d\u5f0f\u63a7\u5236\u7ba1\u7406\uff0cWorker \u5be6\u73fe\u5206\u6563\u5f0f\u57f7\u884c\uff1b\u8207 Openstack \u7684\u67b6\u69cb\u9084\u6709\u57fa\u65bc SpringCloud \u7814\u767c\u7684\u5206\u5fae\u670d\u696d\u52d9\u61c9\u7528\u6c92\u6709\u592a\u5927\u5340\u5225\u3002 \u5f9e\u8a2d\u8a08\u6a21\u5f0f\u65b9\u9762 \uff0cKubernetes \u901a\u904e\u5b9a\u7fa9\u5927\u91cf\u7684\u6a21\u578b\uff08\u539f\u8a9e\u3001\u8cc7\u6e90\u7269\u4ef6\u3001\u914d\u7f6e\u3001\u5e38\u7528\u7684 CRD\uff09\uff0c\u901a\u904e\u914d\u7f6e\u7ba1\u7406\u6a21\u578b\u5be6\u73fe\u53e2\u96c6\u8cc7\u6e90\u7684\u63a7\u5236\uff1b\u96d6\u7136\u6a21\u578b\u591a\u4e14\u8907\u96dc\uff0c\u4f46\u662f\u53ef\u4ee5\u5206\u5c64\uff08\u6838\u5fc3\u5c64\uff0c\u9694\u96e2\u8207\u670d\u52d9\u8a2a\u554f\u5c64\uff0c\u6392\u7a0b\u5c64\uff0c\u8cc7\u6e90\u5c64\uff09\u9010\u6b65\u7406\u89e3\u3002 \u5f9e\u5e73\u81fa\u64f4\u5145\u5957\u4ef6\u65b9\u9762 \uff0cKubernetes \u662f\u4e00\u500b\u958b\u653e\u53ef\u64f4\u5145\u5957\u4ef6\u5e73\u81fa\uff0c\u4e0d\u50c5\u6709\u958b\u767c\u7684 API\uff0c\u958b\u653e\u6a19\u6e96\uff08CNI\uff0cCSI\uff0cCRI\u7b49\uff09\u4ee5\u53ca CRD\uff0c\u4e0d\u50c5\u662f\u4e00\u500b\u55ae\u7d14\u57f7\u884c\u6642\u5e73\u81fa\uff0c\u540c\u6642\u9762\u5411\u904b\u7dad\u7684\u958b\u767c\u5e73\u81fa\u3002","title":"\u7e3d\u7d50"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/","text":"Kubernetes \u7db2\u7d61\u901a\u4fe1\u4ecb\u7d39 \u00b6 \u539f\u6587: https://zhuanlan.zhihu.com/p/432235593 \u6574\u9ad4\u770b Kubernetes \u7db2\u7d61\u62d3\u64b2\u662f Cluster CIDR \u7d44\u6210\u7684\uff0c\u800c\u5728\u5be6\u969b\u7684\u7bc0\u9ede\u88e1\u9762\u9084\u6709 Pod CIDR\uff0c\u6240\u4ee5\u7db2\u7d61\u901a\u4fe1\u9700\u8981\u5148\u627e\u5230\u76ee\u6a19\u7bc0\u9ede\uff0c\u518d\u8f49\u7d66\u76ee\u6a19 pod\uff1b \u6574\u9ad4\u5c0d\u8c61\u7684\u5275\u5efa\u6d41\u7a0b\u5982\u4e0b\uff1a Cluster \u642d\u5efa \u00b6 \u5728\u5c40\u57df\u7db2\u7d61\u4e2d\u5206\u914d 192.168.0.0/16 \u7db2\u6bb5\u7684\u5730\u5740\u69cb\u5efa\u5c40\u57df\u7db2\u7d61\u7684\u901a\u4fe1\u7d50\u69cb IP \u6578\u91cf 65,536 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 65,534 Netmask \u63a9\u78bc 255.255.0.0 \u7db2\u7d61\u4f4d\u5740 192.168.0.0 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 192.168.0.1 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 192.168.255.254 \u5ee3\u64ad\u4f4d\u5740 192.168.255.254 \u8a3b\u518a\u7bc0\u9ede\u5230\u96c6\u7fa4 master\uff0c\u901a\u904e kubectl \u914d\u7f6e\u7bc0\u9ede\u7684 Pod CIDR \u5730\u5740\uff0c\u4f8b\u5982 NodeB \u914d\u7f6e 172.16.8.128/25 , NodeA \u914d\u7f6e 172.16.0.128/25 Cluster CIDR : 172.16.0.0/16 IP \u6578\u91cf 65,536 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 65,534 Netmask \u63a9\u78bc 255.255.0.0 \u7db2\u7d61\u4f4d\u5740 172.16.0.0 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 172.16.0.1 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 172.16.255.254 \u5ee3\u64ad\u4f4d\u5740 172.16.255.255 Pod CIDR (NodeB) : 172.16.8.128/25 IP \u6578\u91cf 126 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 124 Netmask \u63a9\u78bc 255.255.255.128 \u7db2\u7d61\u4f4d\u5740 172.16.8.128 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 172.16.8.129 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 172.16.8.254 \u5ee3\u64ad\u4f4d\u5740 172.16.8.255 Pod CIDR (NodeA) : 172.16.0.128/25 IP \u6578\u91cf 126 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 124 Netmask \u63a9\u78bc 255.255.255.128 \u7db2\u7d61\u4f4d\u5740 172.16.0.128 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 172.16.0.129 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 172.16.0.254 \u5ee3\u64ad\u4f4d\u5740 172.16.0.255 Node \u642d\u5efa \u00b6 \u7d93\u904e\u96c6\u7fa4\u7684 CIDR \u914d\u7f6e\u53ca\u7bc0\u9ede\u7684 CIDR \u914d\u7f6e\u4ee5\u5f8c\uff0cmaster \u670d\u52d9\u7aef control manage \u6703\u7d66 VPC \u914d\u7f6e\u8def\u7531\u8868\u9805\uff0c\u8f49\u767c\u7684 IP \u5730\u5740\u5339\u914d Pod CIDR \u6642\uff0c\u5c31\u5c07\u5305\u88dd\u7d66\u5c0d\u61c9\u7684\u7db2\u5361\u5730\u5740\u3002 \u5176\u6b21\u9084\u6703\u5275\u5efa\u865b\u64ec\u7db2\u6a4b cni0 \u53ca cni0 \u76f8\u95dc\u7684\u8def\u7531\uff0c\u5f9e\u5916\u9762\u9032\u4f86\u7684\u7db2\u7d61\u5305\uff0c\u5982\u679c\u5730\u5740\u5c6c\u65bc podCIDR\uff0c\u5373\u6703\u88ab\u8f49\u767c\u5230 cni0 \u5c40\u57df\u7db2\u88e1\u3002 Pod \u642d\u5efa \u00b6 \u9019\u500b\u968e\u6bb5\uff0ckubelet \u6703\u901a\u904e flannel cni \u7d66 pod \u5275\u5efa\u7db2\u7d61\u7a7a\u9593\u548c veth \u8a2d\u5099\uff0c\u7136\u5f8c\u628a veth \u52a0\u5165\u5230 cni0 \u865b\u64ec\u7db2\u6a4b\u88e1\uff0c\u4e26\u70ba\u4e4b\u5206\u914d pod CIDR \u4e2d\u7684 ip \u5730\u5740\u3002 Pod \u4e4b\u9593\u7684\u901a\u4fe1 \u00b6 \u5176\u4e2d\u672c\u5730\u901a\u4fe1\uff0c\u8aaa\u7684\u662f Pod \u5167\u90e8\u4e0d\u540c\u5bb9\u5668\u4e4b\u9593\u7684\u901a\u4fe1\u3002\u56e0\u70ba Pod \u5167\u5bb9\u5668\u4e4b\u9593\u5171\u4eab\u4e00\u500b\u7db2\u7d61\uff0c\u5b83\u5011\u4e4b\u9593\u7684\u901a\u4fe1\u53ef\u901a\u904e loopback \u8a2d\u5099\u5b8c\u6210\u3002 \u540c\u7bc0\u9ede Pod \u4e4b\u9593\u7684\u901a\u4fe1\u662f cni0 \u865b\u64ec\u7db2\u6a4b\u5167\u90e8\u9593\u7684\u901a\u4fe1\uff0c\u9019\u76f8\u7576\u4e8e\u4e00\u500b\u4e8c\u5c64\u5c40\u57df\u7db2\u7d61\u5167\u90e8\u7684\u901a\u4fe1\u3002 \u8de8\u7bc0\u9ede Pod \u901a\u4fe1\u7565\u5fae\u8907\u96dc\u4e00\u9ede\uff0c\u4f46\u4e5f\u5f88\u76f4\u89c0\u3002\u767c\u9001\u7aef\u6578\u64da\u5c01\u5305\u901a\u904e cni0 cni0 \u865b\u64ec\u7db2\u6a4b\u7684\u7db2\u95dc\uff0c\u6d41\u8f49\u5230\u7bc0\u9ede\u4e0a\uff0c\u7136\u5f8c\u7d93\u904e\u7bc0\u9ede eth0 \u767c\u9001\u7d66 VPN \u8def\u7531\u3002\u9019\u88e1\u4e0d\u6703\u7d93\u904e\u4efb\u4f55\u5c01\u5305\u64cd\u4f5c\u3002 \u7576 VPC \u8def\u7531\u6536\u5230\u6578\u64da\u5c01\u5305\u6642\uff0c\u5b83\u901a\u904e\u67e5\u8a62\u8def\u7531\u8868\u4f86\u78ba\u8a8d\u6578\u64da\u5c01\u5305\u76ee\u7684\u5730\uff0c\u5e76\u628a\u6578\u64da\u5c01\u5305\u767c\u9001\u7d66\u5c0d\u61c9\u7684\u7bc0\u9ede\u3002 \u800c\u9032\u53bb\u7bc0\u9ede\u4e4b\u5f8c\uff0c\u56e0 flanneld \u5728\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e86\u771f\u7684 cni0 \u7684\u8def\u7531\uff0c\u6578\u64da\u5c01\u5305\u6703\u88ab\u767c\u9001\u5230\u76ee\u7684\u5730\u7684 cni0 \u5340\u57df\u7db2\uff0c\u7136\u5f8c\u518d\u5230\u76ee\u7684\u5730 Pod\u3002 \u6700\u5f8c\u4e00\u7a2e\u60c5\u6cc1\uff0cPod \u8207\u975e Pod \u7db2\u7d61\u7684\u5be6\u9ad4\u901a\u4fe1\uff0c\u9700\u8981\u7d93\u904e\u7bc0\u9ede\u4e0a\u7684 iptables \u898f\u5247\u505a snat\uff0c\u800c\u6b64\u898f\u5247\u5c31\u662f flanneld \u4f9d\u636e\u547d\u4ee4\u884c ip-masq \u9078\u9805\u6240\u505a\u7684\u914d\u7f6e\u3002 \u7406\u89e3 Pod\uff0cService\uff0cIngress \u7684\u7db2\u7d61\u7d50\u69cb \u00b6 Pod \u6982\u5ff5 \u00b6 Pod \u5167\u5bb9\u5668\u4e4b\u9593\u5171\u4eab\u4e00\u500b\u7db2\u7d61\uff0c\u5b83\u5011\u4e4b\u9593\u7684\u901a\u4fe1\u901a\u904e loopback \u8a2d\u5099\u5b8c\u6210\u3002\u540c\u7bc0\u9ede Pod \u4e4b\u9593\u7684\u901a\u4fe1\u662f cni0 \u865b\u64ec\u7db2\u6a4b\u5167\u90e8\u9593\u7684\u901a\u4fe1\u3002 \u5728 pods \u7684 namespace \u4e2d\uff0cpods \u7684\u865b\u64ec\u7db2\u7d61\u63a5\u53e3\u70ba veth0 \uff1b\u5728\u5bbf\u4e3b\u6a5f\u4e0a\uff0c\u7269\u7406\u7db2\u7d61\u7684\u7db2\u7d61\u63a5\u53e3\u70ba eth0 \u3002 cni0 \u865b\u64ec\u7db2\u6a4b\u4f5c\u70ba veth0 \u7684\u9ed8\u8a8d\u7db2\u95dc\uff0c\u7528\u65bc\u548c\u5bbf\u4e3b\u6a5f\u7db2\u7d61\u7684\u901a\u4fe1\u3002 \u6240\u6709 pods \u7684 veth0 \u6240\u80fd\u5206\u914d\u7684IP\u662f\u4e00\u500b\u7368\u7acb\u7684 IP \u5730\u5740\u7bc4\u570d\uff0c\u4f86\u81ea\u65bc\u5275\u5efa cluster \u6642\u5019 kubeadm \u7684 --pod-network-cidr \u53c3\u6578\u8a2d\u5b9a\u7684 CIDR\uff0c\u9019\u88e1\u770b\u8d77\u4f86\u50cf\u662f172.17.0.0/24\uff0c\u662f\u4e00\u500bB\u985e\u5c40\u57df\u7db2IP\u5730\u5740\u6bb5\uff1b\u6240\u6709\u5bbf\u4e3b\u6a5f\u7684\u7db2\u7d61\u63a5\u53e3 eth0 \u6240\u80fd\u5206\u914d\u7684 IP \u662f\u5be6\u969b\u7269\u7406\u7db2\u7d61\u7684\u8a2d\u5b9a\uff0c\u4e00\u822c\u4f86\u81ea\u65bc\u5be6\u969b\u7269\u7406\u7db2\u7d61\u4e2d\u7684\u8def\u7531\u5668\u901a\u904e DHCP \u5206\u914d\u7684\uff0c\u9019\u88e1\u770b\u8d77\u4f86\u662f 10.100.0.0/24\uff0c\u662f\u4e00\u500bA\u985e\u5c40\u57df\u7db2IP\u5730\u5740\u6bb5\u3002 cni0 \u865b\u64ec\u7db2\u6a4b\u5efa\u7acb\u8d77 pod \u548c\u5176\u5bbf\u4e3b\u6a5f\u4e4b\u9593\u7684\u901a\u4fe1\uff0c\u4f46\u662f\u4e26\u6c92\u6709\u89e3\u6c7a\u5b8c\u554f\u984c\uff0c\u4e8b\u5be6\u4e0a\uff0c\u76f4\u5230\u9019\u88e1\u9084\u5c6c\u65bc Docker \u81ea\u8eab\u7684\u7bc4\u7587\uff0cK8s \u7684 pods \u9084\u8981\u80fd\u5920\u8207\u5176\u5b83\u5bbf\u4e3b\u6a5f\u7bc0\u9ede\u4e0a\u7684 pods \u901a\u4fe1\u3002 K8s \u4f7f\u7528 custom bridge \u4ee3\u66ff\u4e86 docker bridge\u3002\u7531\u6b64\uff0c\u5982\u679c\u5de6\u5074\u7684 pod \u60f3\u8a2a\u554f\u53f3\u5074\u7684 pod\uff0c\u5247 IP \u5c01\u5305\u6703\u901a\u904e bridge cbr0 \u4f86\u5230\u5de6\u5074\u5bbf\u4e3b\u6a5f\u7684 eth0 \uff0c\u7136\u5f8c\u67e5\u8a62\u5bbf\u4e3b\u6a5f\u4e0a\u7684\u8def\u7531\u4fe1\u606f\uff0c\u7e7c\u800c\u5c07 IP \u5c01\u5305\u9001\u5f80\u53f3\u5074\u7684\u5bbf\u4e3b\u6a5f\u7684 eth0 \uff0c\u7e7c\u800c\u518d\u9001\u5f80\u53f3\u5074\u7684 bridge cbr0 \uff0c\u6700\u5f8c\u9001\u5f80\u53f3\u5074\u7684 pod\u3002 \u8a2a\u554f\u662f\u53ef\u4ee5\u8a2a\u554f\u4e86\uff0c\u4f46\u662f\u76f8\u95dc\u7684\u554f\u984c\u5c31\u4f86\u4e86\uff0c\u800c\u4e14\u9084\u5f88\u591a: \u4e00\u500b\u670d\u52d9\u7d93\u5e38\u6703\u8d77\u591a\u500b pod\uff0c\u4f60\u5230\u5e95\u8a2a\u554f\u90a3\u500b pod \u7684 ip \u5462? pod \u7d93\u5e38\u6703\u56e0\u70ba\u5404\u7a2e\u539f\u56e0\u88ab\u8abf\u5ea6\uff0c\u8abf\u5ea6\u5f8c\u4e00\u500b pod \u7684 ip \u6703\u767c\u751f\u8b8a\u5316... pod \u7684 ip \u662f\u865b\u64ec\u7684\u4e14\u5c40\u57df\u7684\uff0c\u5728\u96c6\u7fa4\u5167\u90e8\u8a2a\u554f\u6c92\u6709\u554f\u984c\uff0c\u4f46\u662f\u5f9e k8s \u96c6\u7fa4\u7684\u5916\u90e8\u5982\u4f55\u8a2a\u554f pod \u7684 ip \u5462? \u89e3\u6c7a1\u30012\u554f\u984c\u7684\u7b54\u6848\u5c31\u662f\u53cd\u5411\u4ee3\u7406(Reverse proxy)\u548c\u8ca0\u8f09\u5747\u8861(Load balancer)\uff0c\u9019\u662f\u7531\u4f86\u5df2\u4e45\u7684\u6163\u4f8b\uff0c\u7531\u6b64\u6211\u5011\u5f15\u5165\u4e86 K8s \u7684 service\u3002 Service \u6982\u5ff5 \u00b6 Service \u662f\u7531 kube-proxy \u7d44\u4ef6\uff0c\u52a0\u4e0a Iptables \u4f86\u5171\u540c\u5be6\u73fe\u7684\u3002 Kube-proxy \u901a\u904e Infomer \u611f\u77e5\u5230 Service \u5c0d\u8c61\u7684\u6dfb\u52a0\u3002\u4f5c\u70ba\u5c0d\u9019\u500b\u4e8b\u4ef6\u7684\u76f8\u61c9\uff0c \u5b83\u5c31\u6703\u5728\u5bbf\u4e3b\u6a5f\u4e0a\u5275\u5efa\u4e00\u689d Iptables \u898f\u5247\uff0c \u898f\u5b9a\u51e1\u662f \u8a2a\u554f Service VIP \u90fd\u8df3\u8f49\u5230\u9019\u689dIptables \u898f\u5247\u4e0a\u9032\u884c\u8655\u7406\u3002 \u9019\u689d Iptables \u898f\u5247\u662f\u4ec0\u9ebc\u5462? \u5be6\u969b\u4e0a\u662f\u4e00\u7d44\u898f\u5247\uff0c \u4e00\u7d44\u96a8\u6a5f\u6a21\u5f0f\u7684 IPtables \u93c8\uff0c \u4e09\u689d\u93c8\u6307\u5411\u7684\u6700\u7d42\u76ee\u7684\u5730\uff0c\u5176\u5be6\u5c31\u662f\u9019\u500b Service \u4ee3\u7406\u7684\u4e09\u500bPod \u3002\u9019\u4e00\u7d44\u898f\u5247\u5c31\u662f Service\u5be6\u73fe\u8ca0\u8f09\u5747\u8861\u7684\u4f4d\u7f6e\u3002 \u5b9a\u7fa9Service\u7684\u65b9\u5f0f\u548c\u5404\u7a2e\u8cc7\u6e90\u5c0d\u8c61\u7684\u65b9\u5f0f\u985e\u578b\u4e00\u6a23\uff0c\u5047\u5b9a\u6211\u5011\u6709\u4e00\u7d44Pod\u670d\u52d9\uff0c\u5b83\u5011\u5c0d\u5916\u66b4\u9732\u4e86 80 \u7aef\u53e3\uff0c\u540c\u6642\u90fd\u88ab\u6253\u4e0a\u4e86app=myapp\u9019\u6a23\u7684\u6a19\u7c64\uff0c\u90a3\u9ebc\u6211\u5011\u5c31\u53ef\u4ee5\u50cf\u4e0b\u9762\u9019\u6a23\u4f86\u5b9a\u7fa9\u4e00\u500bService\u5c0d\u8c61\uff1a pod\u793a\u4f8b \uff1a mydeployment.yaml apiVersion : apps/v1 kind : Deployment metadata : name : test spec : selector : matchLabels : app : myapp replicas : 3 template : metadata : labels : app : myapp spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 80 service\u57fa\u65bcpod\u7684\u793a\u4f8b\uff1a myservice.yaml apiVersion : v1 kind : Service metadata : name : myservice spec : selector : app : myapp ports : - protocol : TCP port : 80 targetPort : 80 \u7136\u5f8c\u901a\u904e\u7684\u4f7f\u7528 kubectl create -f myservice.yaml \u5c31\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u540d\u70ba myservice \u7684 Service \u5c0d\u8c61\uff0c\u5b83\u6703\u5c07\u8acb\u6c42\u4ee3\u7406\u5230\u4f7f\u7528 TCP \u7aef\u53e3\u70ba 80\uff0c\u5177\u6709\u6a19\u7c64 app=myapp \u7684Pod\u4e0a\uff0c\u9019\u500b Service \u6703\u88ab\u7cfb\u7d71\u5206\u914d\u4e00\u500b\u6211\u5011\u4e0a\u9762\u8aaa\u7684 Cluster IP\uff0c\u8a72 Service \u9084\u6703\u6301\u7e8c\u7684\u76e3\u807d selector \u4e0b\u9762\u7684 Pod\uff0c\u6703\u628a\u9019\u4e9b Pod \u4fe1\u606f\u66f4\u65b0\u5230\u4e00\u500b\u540d\u70ba myservice \u7684Endpoints \u5c0d\u8c61\u4e0a\u53bb\uff0c\u9019\u500b\u5c0d\u8c61\u5c31\u985e\u4f3c\u65bc\u6211\u5011\u4e0a\u9762\u8aaa\u7684 Pod\u96c6\u5408\u4e86\u3002 \u5728\u5b9a\u7fa9 Service \u7684\u6642\u5019\u53ef\u4ee5\u6307\u5b9a\u4e00\u500b\u81ea\u5df1\u9700\u8981\u7684\u985e\u578b\u7684 Service\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u7684\u8a71\u9ed8\u8a8d\u662f ClusterIP \u985e\u578b\u3002\u53ef\u4ee5\u4f7f\u7528\u7684\u670d\u52d9\u985e\u578b\u5982\u4e0b\uff1a ClusterIP \uff1a\u901a\u904e\u96c6\u7fa4\u7684\u5167\u90e8 IP \u66b4\u9732\u670d\u52d9\uff0c\u9078\u64c7\u8a72\u503c\uff0c\u670d\u52d9\u53ea\u80fd\u5920\u5728\u96c6\u7fa4\u5167\u90e8\u53ef\u4ee5\u8a2a\u554f\uff0c\u9019\u4e5f\u662f\u9ed8\u8a8d\u7684ServiceType\u3002 NodePort \uff1a\u901a\u904e\u6bcf\u500b Node \u7bc0\u9ede\u4e0a\u7684 IP \u548c\u975c\u614b\u7aef\u53e3\uff08NodePort\uff09\u66b4\u9732\u670d\u52d9\u3002 NodePort \u670d\u52d9\u6703\u8def\u7531\u5230 ClusterIP \u670d\u52d9\uff0c\u9019\u500b ClusterIP \u670d\u52d9\u6703\u81ea\u52d5\u5275\u5efa\u3002\u901a\u904e\u8acb\u6c42 :\uff0c\u53ef\u4ee5\u5f9e\u96c6\u7fa4\u7684\u5916\u90e8\u8a2a\u554f\u4e00\u500b NodePort \u670d\u52d9\u3002 LoadBalancer \uff1a\u4f7f\u7528\u96f2\u63d0\u4f9b\u5546\u7684\u8ca0\u8f09\u5c40\u8861\u5668\uff0c\u53ef\u4ee5\u5411\u5916\u90e8\u66b4\u9732\u670d\u52d9\u3002\u5916\u90e8\u7684\u8ca0\u8f09\u5747\u8861\u5668\u53ef\u4ee5\u8def\u7531\u5230 NodePort \u670d\u52d9\u548c ClusterIP \u670d\u52d9\uff0c\u9019\u500b\u9700\u8981\u7d50\u5408\u5177\u9ad4\u7684\u96f2\u5ee0\u5546\u9032\u884c\u64cd\u4f5c\u3002 ExternalName \uff1a\u901a\u904e\u8fd4\u56de CNAME \u548c\u5b83\u7684\u503c\uff0c\u53ef\u4ee5\u5c07\u670d\u52d9\u6620\u5c04\u5230 externalName \u5b57\u6bb5\u7684\u5167\u5bb9\uff08\u4f8b\u5982\uff0c http://foo.bar.example.com \uff09\u3002 Ingress \u6982\u5ff5 \u00b6 Kubernetes \u5411\u5916\u90e8\u66b4\u9732\u670d\u52d9\u7684\u624b\u6cd5\u4e3b\u8981\u662f\u901a\u904e NodePort \u65b9\u5f0f\uff0c\u901a\u904e\u7d81\u5b9a\u5bbf\u4e3b\u6a5f\u7684\u67d0\u500b\u7aef\u53e3,\u7136\u5f8c\u9032\u884c pod \u7684\u8acb\u6c42\u8f49\u767c\u548c\u8ca0\u8f09\u5747\u8861\uff0c\u4f46\u9019\u7a2e\u65b9\u5f0f\u4e0b\u7f3a\u9677\u662f\uff1a Service \u53ef\u80fd\u6709\u5f88\u591a\u500b\uff0c\u5982\u679c\u6bcf\u500b\u90fd\u7d81\u5b9a\u4e00\u500b node \u4e3b\u6a5f\u7aef\u53e3\u7684\u8a71\uff0c\u4e3b\u6a5f\u9700\u8981\u958b\u653e\u5916\u570d\u4e00\u5806\u7684\u7aef\u53e3\u9032\u884c\u670d\u52d9\u8abf\u7528\uff0c\u7ba1\u7406\u6df7\u4e82\u7121\u6cd5\u61c9\u7528\u5f88\u591a\u516c\u53f8\u8981\u6c42\u7684\u9632\u706b\u7246\u898f\u5247\u3002 \u7406\u60f3\u7684\u65b9\u5f0f\u662f\u901a\u904e\u4e00\u500b\u5916\u90e8\u7684\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u7d81\u5b9a\u56fa\u5b9a\u7684\u7aef\u53e3\uff0c\u6bd4\u598280,\u7136\u5f8c\u6839\u64da\u57df\u540d\u6216\u8005\u670d\u52d9\u540d\u5411\u5f8c\u9762\u7684Service ip\u8f49\u767c\uff0cNginx\u5f88\u597d\u7684\u89e3\u6c7a\u4e86\u9019\u500b\u9700\u6c42\uff0c\u4f46\u554f\u984c\u662f\u5982\u679c\u6709\u65b0\u7684\u670d\u52d9\u52a0\u5165\uff0c\u5982\u4f55\u53bb\u4fee\u6539Nginx\u7684\u914d\u7f6e\uff0c\u4e26\u4e14\u52a0\u8f09\u9019\u4e9b\u914d\u7f6e\uff1f Kubernetes \u7d66\u51fa\u7684\u65b9\u6848\u5c31\u662f Ingress\uff0cIngress \u5305\u542b\u4e86\u5169\u5927\u4e3b\u4ef6 Ingress Controller \u548c Ingress\u3002 Ingress \u89e3\u6c7a\u7684\u662f\u65b0\u7684\u670d\u52d9\u52a0\u5165\u5f8c\uff0c\u57df\u540d\u548c\u670d\u52d9\u7684\u5c0d\u61c9\u554f\u984c\uff0c\u57fa\u672c\u4e0a\u662f\u4e00\u500b ingress \u7684\u5c0d\u8c61\uff0c\u901a\u904e yaml \u9032\u884c\u5275\u5efa\u548c\u66f4\u65b0\u9032\u884c\u52a0\u8f09\u3002 Ingress Controller \u662f\u5c07I ngress \u9019\u7a2e\u8b8a\u5316\u751f\u6210\u4e00\u6bb5 Nginx \u7684\u914d\u7f6e\uff0c\u7136\u5f8c\u5c07\u9019\u500b\u914d\u7f6e\u901a\u904eKubernetes API\u5beb\u5230 Nginx \u7684 Pod \u4e2d\uff0c\u7136\u5f8c reload.\uff08\u6ce8\u610f\uff1a\u5beb\u5165 nginx.conf \u7684\u4e0d\u662f service \u7684\u5730\u5740\uff0c\u800c\u662f service backend \u7684 pod \u7684\u5730\u5740\uff0c\u907f\u514d\u5728 service \u5728\u589e\u52a0\u4e00\u5c64\u8ca0\u8f09\u5747\u8861\u8f49\u767c\uff09","title":"K8S \u7db2\u7d61\u901a\u4fe1\u4ecb\u7d39"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#kubernetes","text":"\u539f\u6587: https://zhuanlan.zhihu.com/p/432235593 \u6574\u9ad4\u770b Kubernetes \u7db2\u7d61\u62d3\u64b2\u662f Cluster CIDR \u7d44\u6210\u7684\uff0c\u800c\u5728\u5be6\u969b\u7684\u7bc0\u9ede\u88e1\u9762\u9084\u6709 Pod CIDR\uff0c\u6240\u4ee5\u7db2\u7d61\u901a\u4fe1\u9700\u8981\u5148\u627e\u5230\u76ee\u6a19\u7bc0\u9ede\uff0c\u518d\u8f49\u7d66\u76ee\u6a19 pod\uff1b \u6574\u9ad4\u5c0d\u8c61\u7684\u5275\u5efa\u6d41\u7a0b\u5982\u4e0b\uff1a","title":"Kubernetes \u7db2\u7d61\u901a\u4fe1\u4ecb\u7d39"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#cluster","text":"\u5728\u5c40\u57df\u7db2\u7d61\u4e2d\u5206\u914d 192.168.0.0/16 \u7db2\u6bb5\u7684\u5730\u5740\u69cb\u5efa\u5c40\u57df\u7db2\u7d61\u7684\u901a\u4fe1\u7d50\u69cb IP \u6578\u91cf 65,536 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 65,534 Netmask \u63a9\u78bc 255.255.0.0 \u7db2\u7d61\u4f4d\u5740 192.168.0.0 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 192.168.0.1 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 192.168.255.254 \u5ee3\u64ad\u4f4d\u5740 192.168.255.254 \u8a3b\u518a\u7bc0\u9ede\u5230\u96c6\u7fa4 master\uff0c\u901a\u904e kubectl \u914d\u7f6e\u7bc0\u9ede\u7684 Pod CIDR \u5730\u5740\uff0c\u4f8b\u5982 NodeB \u914d\u7f6e 172.16.8.128/25 , NodeA \u914d\u7f6e 172.16.0.128/25 Cluster CIDR : 172.16.0.0/16 IP \u6578\u91cf 65,536 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 65,534 Netmask \u63a9\u78bc 255.255.0.0 \u7db2\u7d61\u4f4d\u5740 172.16.0.0 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 172.16.0.1 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 172.16.255.254 \u5ee3\u64ad\u4f4d\u5740 172.16.255.255 Pod CIDR (NodeB) : 172.16.8.128/25 IP \u6578\u91cf 126 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 124 Netmask \u63a9\u78bc 255.255.255.128 \u7db2\u7d61\u4f4d\u5740 172.16.8.128 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 172.16.8.129 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 172.16.8.254 \u5ee3\u64ad\u4f4d\u5740 172.16.8.255 Pod CIDR (NodeA) : 172.16.0.128/25 IP \u6578\u91cf 126 \u53ef\u7528 IP \u5730\u5740\u6578\u91cf 124 Netmask \u63a9\u78bc 255.255.255.128 \u7db2\u7d61\u4f4d\u5740 172.16.0.128 \u7b2c\u4e00\u500b\u53ef\u7528 IP \u4f4d\u5740 172.16.0.129 \u6700\u5f8c\u7684\u53ef\u7528 IP \u4f4d\u5740 172.16.0.254 \u5ee3\u64ad\u4f4d\u5740 172.16.0.255","title":"Cluster \u642d\u5efa"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#node","text":"\u7d93\u904e\u96c6\u7fa4\u7684 CIDR \u914d\u7f6e\u53ca\u7bc0\u9ede\u7684 CIDR \u914d\u7f6e\u4ee5\u5f8c\uff0cmaster \u670d\u52d9\u7aef control manage \u6703\u7d66 VPC \u914d\u7f6e\u8def\u7531\u8868\u9805\uff0c\u8f49\u767c\u7684 IP \u5730\u5740\u5339\u914d Pod CIDR \u6642\uff0c\u5c31\u5c07\u5305\u88dd\u7d66\u5c0d\u61c9\u7684\u7db2\u5361\u5730\u5740\u3002 \u5176\u6b21\u9084\u6703\u5275\u5efa\u865b\u64ec\u7db2\u6a4b cni0 \u53ca cni0 \u76f8\u95dc\u7684\u8def\u7531\uff0c\u5f9e\u5916\u9762\u9032\u4f86\u7684\u7db2\u7d61\u5305\uff0c\u5982\u679c\u5730\u5740\u5c6c\u65bc podCIDR\uff0c\u5373\u6703\u88ab\u8f49\u767c\u5230 cni0 \u5c40\u57df\u7db2\u88e1\u3002","title":"Node \u642d\u5efa"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#pod","text":"\u9019\u500b\u968e\u6bb5\uff0ckubelet \u6703\u901a\u904e flannel cni \u7d66 pod \u5275\u5efa\u7db2\u7d61\u7a7a\u9593\u548c veth \u8a2d\u5099\uff0c\u7136\u5f8c\u628a veth \u52a0\u5165\u5230 cni0 \u865b\u64ec\u7db2\u6a4b\u88e1\uff0c\u4e26\u70ba\u4e4b\u5206\u914d pod CIDR \u4e2d\u7684 ip \u5730\u5740\u3002","title":"Pod \u642d\u5efa"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#pod_1","text":"\u5176\u4e2d\u672c\u5730\u901a\u4fe1\uff0c\u8aaa\u7684\u662f Pod \u5167\u90e8\u4e0d\u540c\u5bb9\u5668\u4e4b\u9593\u7684\u901a\u4fe1\u3002\u56e0\u70ba Pod \u5167\u5bb9\u5668\u4e4b\u9593\u5171\u4eab\u4e00\u500b\u7db2\u7d61\uff0c\u5b83\u5011\u4e4b\u9593\u7684\u901a\u4fe1\u53ef\u901a\u904e loopback \u8a2d\u5099\u5b8c\u6210\u3002 \u540c\u7bc0\u9ede Pod \u4e4b\u9593\u7684\u901a\u4fe1\u662f cni0 \u865b\u64ec\u7db2\u6a4b\u5167\u90e8\u9593\u7684\u901a\u4fe1\uff0c\u9019\u76f8\u7576\u4e8e\u4e00\u500b\u4e8c\u5c64\u5c40\u57df\u7db2\u7d61\u5167\u90e8\u7684\u901a\u4fe1\u3002 \u8de8\u7bc0\u9ede Pod \u901a\u4fe1\u7565\u5fae\u8907\u96dc\u4e00\u9ede\uff0c\u4f46\u4e5f\u5f88\u76f4\u89c0\u3002\u767c\u9001\u7aef\u6578\u64da\u5c01\u5305\u901a\u904e cni0 cni0 \u865b\u64ec\u7db2\u6a4b\u7684\u7db2\u95dc\uff0c\u6d41\u8f49\u5230\u7bc0\u9ede\u4e0a\uff0c\u7136\u5f8c\u7d93\u904e\u7bc0\u9ede eth0 \u767c\u9001\u7d66 VPN \u8def\u7531\u3002\u9019\u88e1\u4e0d\u6703\u7d93\u904e\u4efb\u4f55\u5c01\u5305\u64cd\u4f5c\u3002 \u7576 VPC \u8def\u7531\u6536\u5230\u6578\u64da\u5c01\u5305\u6642\uff0c\u5b83\u901a\u904e\u67e5\u8a62\u8def\u7531\u8868\u4f86\u78ba\u8a8d\u6578\u64da\u5c01\u5305\u76ee\u7684\u5730\uff0c\u5e76\u628a\u6578\u64da\u5c01\u5305\u767c\u9001\u7d66\u5c0d\u61c9\u7684\u7bc0\u9ede\u3002 \u800c\u9032\u53bb\u7bc0\u9ede\u4e4b\u5f8c\uff0c\u56e0 flanneld \u5728\u7bc0\u9ede\u4e0a\u5275\u5efa\u4e86\u771f\u7684 cni0 \u7684\u8def\u7531\uff0c\u6578\u64da\u5c01\u5305\u6703\u88ab\u767c\u9001\u5230\u76ee\u7684\u5730\u7684 cni0 \u5340\u57df\u7db2\uff0c\u7136\u5f8c\u518d\u5230\u76ee\u7684\u5730 Pod\u3002 \u6700\u5f8c\u4e00\u7a2e\u60c5\u6cc1\uff0cPod \u8207\u975e Pod \u7db2\u7d61\u7684\u5be6\u9ad4\u901a\u4fe1\uff0c\u9700\u8981\u7d93\u904e\u7bc0\u9ede\u4e0a\u7684 iptables \u898f\u5247\u505a snat\uff0c\u800c\u6b64\u898f\u5247\u5c31\u662f flanneld \u4f9d\u636e\u547d\u4ee4\u884c ip-masq \u9078\u9805\u6240\u505a\u7684\u914d\u7f6e\u3002","title":"Pod \u4e4b\u9593\u7684\u901a\u4fe1"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#podserviceingress","text":"","title":"\u7406\u89e3 Pod\uff0cService\uff0cIngress \u7684\u7db2\u7d61\u7d50\u69cb"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#pod_2","text":"Pod \u5167\u5bb9\u5668\u4e4b\u9593\u5171\u4eab\u4e00\u500b\u7db2\u7d61\uff0c\u5b83\u5011\u4e4b\u9593\u7684\u901a\u4fe1\u901a\u904e loopback \u8a2d\u5099\u5b8c\u6210\u3002\u540c\u7bc0\u9ede Pod \u4e4b\u9593\u7684\u901a\u4fe1\u662f cni0 \u865b\u64ec\u7db2\u6a4b\u5167\u90e8\u9593\u7684\u901a\u4fe1\u3002 \u5728 pods \u7684 namespace \u4e2d\uff0cpods \u7684\u865b\u64ec\u7db2\u7d61\u63a5\u53e3\u70ba veth0 \uff1b\u5728\u5bbf\u4e3b\u6a5f\u4e0a\uff0c\u7269\u7406\u7db2\u7d61\u7684\u7db2\u7d61\u63a5\u53e3\u70ba eth0 \u3002 cni0 \u865b\u64ec\u7db2\u6a4b\u4f5c\u70ba veth0 \u7684\u9ed8\u8a8d\u7db2\u95dc\uff0c\u7528\u65bc\u548c\u5bbf\u4e3b\u6a5f\u7db2\u7d61\u7684\u901a\u4fe1\u3002 \u6240\u6709 pods \u7684 veth0 \u6240\u80fd\u5206\u914d\u7684IP\u662f\u4e00\u500b\u7368\u7acb\u7684 IP \u5730\u5740\u7bc4\u570d\uff0c\u4f86\u81ea\u65bc\u5275\u5efa cluster \u6642\u5019 kubeadm \u7684 --pod-network-cidr \u53c3\u6578\u8a2d\u5b9a\u7684 CIDR\uff0c\u9019\u88e1\u770b\u8d77\u4f86\u50cf\u662f172.17.0.0/24\uff0c\u662f\u4e00\u500bB\u985e\u5c40\u57df\u7db2IP\u5730\u5740\u6bb5\uff1b\u6240\u6709\u5bbf\u4e3b\u6a5f\u7684\u7db2\u7d61\u63a5\u53e3 eth0 \u6240\u80fd\u5206\u914d\u7684 IP \u662f\u5be6\u969b\u7269\u7406\u7db2\u7d61\u7684\u8a2d\u5b9a\uff0c\u4e00\u822c\u4f86\u81ea\u65bc\u5be6\u969b\u7269\u7406\u7db2\u7d61\u4e2d\u7684\u8def\u7531\u5668\u901a\u904e DHCP \u5206\u914d\u7684\uff0c\u9019\u88e1\u770b\u8d77\u4f86\u662f 10.100.0.0/24\uff0c\u662f\u4e00\u500bA\u985e\u5c40\u57df\u7db2IP\u5730\u5740\u6bb5\u3002 cni0 \u865b\u64ec\u7db2\u6a4b\u5efa\u7acb\u8d77 pod \u548c\u5176\u5bbf\u4e3b\u6a5f\u4e4b\u9593\u7684\u901a\u4fe1\uff0c\u4f46\u662f\u4e26\u6c92\u6709\u89e3\u6c7a\u5b8c\u554f\u984c\uff0c\u4e8b\u5be6\u4e0a\uff0c\u76f4\u5230\u9019\u88e1\u9084\u5c6c\u65bc Docker \u81ea\u8eab\u7684\u7bc4\u7587\uff0cK8s \u7684 pods \u9084\u8981\u80fd\u5920\u8207\u5176\u5b83\u5bbf\u4e3b\u6a5f\u7bc0\u9ede\u4e0a\u7684 pods \u901a\u4fe1\u3002 K8s \u4f7f\u7528 custom bridge \u4ee3\u66ff\u4e86 docker bridge\u3002\u7531\u6b64\uff0c\u5982\u679c\u5de6\u5074\u7684 pod \u60f3\u8a2a\u554f\u53f3\u5074\u7684 pod\uff0c\u5247 IP \u5c01\u5305\u6703\u901a\u904e bridge cbr0 \u4f86\u5230\u5de6\u5074\u5bbf\u4e3b\u6a5f\u7684 eth0 \uff0c\u7136\u5f8c\u67e5\u8a62\u5bbf\u4e3b\u6a5f\u4e0a\u7684\u8def\u7531\u4fe1\u606f\uff0c\u7e7c\u800c\u5c07 IP \u5c01\u5305\u9001\u5f80\u53f3\u5074\u7684\u5bbf\u4e3b\u6a5f\u7684 eth0 \uff0c\u7e7c\u800c\u518d\u9001\u5f80\u53f3\u5074\u7684 bridge cbr0 \uff0c\u6700\u5f8c\u9001\u5f80\u53f3\u5074\u7684 pod\u3002 \u8a2a\u554f\u662f\u53ef\u4ee5\u8a2a\u554f\u4e86\uff0c\u4f46\u662f\u76f8\u95dc\u7684\u554f\u984c\u5c31\u4f86\u4e86\uff0c\u800c\u4e14\u9084\u5f88\u591a: \u4e00\u500b\u670d\u52d9\u7d93\u5e38\u6703\u8d77\u591a\u500b pod\uff0c\u4f60\u5230\u5e95\u8a2a\u554f\u90a3\u500b pod \u7684 ip \u5462? pod \u7d93\u5e38\u6703\u56e0\u70ba\u5404\u7a2e\u539f\u56e0\u88ab\u8abf\u5ea6\uff0c\u8abf\u5ea6\u5f8c\u4e00\u500b pod \u7684 ip \u6703\u767c\u751f\u8b8a\u5316... pod \u7684 ip \u662f\u865b\u64ec\u7684\u4e14\u5c40\u57df\u7684\uff0c\u5728\u96c6\u7fa4\u5167\u90e8\u8a2a\u554f\u6c92\u6709\u554f\u984c\uff0c\u4f46\u662f\u5f9e k8s \u96c6\u7fa4\u7684\u5916\u90e8\u5982\u4f55\u8a2a\u554f pod \u7684 ip \u5462? \u89e3\u6c7a1\u30012\u554f\u984c\u7684\u7b54\u6848\u5c31\u662f\u53cd\u5411\u4ee3\u7406(Reverse proxy)\u548c\u8ca0\u8f09\u5747\u8861(Load balancer)\uff0c\u9019\u662f\u7531\u4f86\u5df2\u4e45\u7684\u6163\u4f8b\uff0c\u7531\u6b64\u6211\u5011\u5f15\u5165\u4e86 K8s \u7684 service\u3002","title":"Pod \u6982\u5ff5"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#service","text":"Service \u662f\u7531 kube-proxy \u7d44\u4ef6\uff0c\u52a0\u4e0a Iptables \u4f86\u5171\u540c\u5be6\u73fe\u7684\u3002 Kube-proxy \u901a\u904e Infomer \u611f\u77e5\u5230 Service \u5c0d\u8c61\u7684\u6dfb\u52a0\u3002\u4f5c\u70ba\u5c0d\u9019\u500b\u4e8b\u4ef6\u7684\u76f8\u61c9\uff0c \u5b83\u5c31\u6703\u5728\u5bbf\u4e3b\u6a5f\u4e0a\u5275\u5efa\u4e00\u689d Iptables \u898f\u5247\uff0c \u898f\u5b9a\u51e1\u662f \u8a2a\u554f Service VIP \u90fd\u8df3\u8f49\u5230\u9019\u689dIptables \u898f\u5247\u4e0a\u9032\u884c\u8655\u7406\u3002 \u9019\u689d Iptables \u898f\u5247\u662f\u4ec0\u9ebc\u5462? \u5be6\u969b\u4e0a\u662f\u4e00\u7d44\u898f\u5247\uff0c \u4e00\u7d44\u96a8\u6a5f\u6a21\u5f0f\u7684 IPtables \u93c8\uff0c \u4e09\u689d\u93c8\u6307\u5411\u7684\u6700\u7d42\u76ee\u7684\u5730\uff0c\u5176\u5be6\u5c31\u662f\u9019\u500b Service \u4ee3\u7406\u7684\u4e09\u500bPod \u3002\u9019\u4e00\u7d44\u898f\u5247\u5c31\u662f Service\u5be6\u73fe\u8ca0\u8f09\u5747\u8861\u7684\u4f4d\u7f6e\u3002 \u5b9a\u7fa9Service\u7684\u65b9\u5f0f\u548c\u5404\u7a2e\u8cc7\u6e90\u5c0d\u8c61\u7684\u65b9\u5f0f\u985e\u578b\u4e00\u6a23\uff0c\u5047\u5b9a\u6211\u5011\u6709\u4e00\u7d44Pod\u670d\u52d9\uff0c\u5b83\u5011\u5c0d\u5916\u66b4\u9732\u4e86 80 \u7aef\u53e3\uff0c\u540c\u6642\u90fd\u88ab\u6253\u4e0a\u4e86app=myapp\u9019\u6a23\u7684\u6a19\u7c64\uff0c\u90a3\u9ebc\u6211\u5011\u5c31\u53ef\u4ee5\u50cf\u4e0b\u9762\u9019\u6a23\u4f86\u5b9a\u7fa9\u4e00\u500bService\u5c0d\u8c61\uff1a pod\u793a\u4f8b \uff1a mydeployment.yaml apiVersion : apps/v1 kind : Deployment metadata : name : test spec : selector : matchLabels : app : myapp replicas : 3 template : metadata : labels : app : myapp spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 80 service\u57fa\u65bcpod\u7684\u793a\u4f8b\uff1a myservice.yaml apiVersion : v1 kind : Service metadata : name : myservice spec : selector : app : myapp ports : - protocol : TCP port : 80 targetPort : 80 \u7136\u5f8c\u901a\u904e\u7684\u4f7f\u7528 kubectl create -f myservice.yaml \u5c31\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u540d\u70ba myservice \u7684 Service \u5c0d\u8c61\uff0c\u5b83\u6703\u5c07\u8acb\u6c42\u4ee3\u7406\u5230\u4f7f\u7528 TCP \u7aef\u53e3\u70ba 80\uff0c\u5177\u6709\u6a19\u7c64 app=myapp \u7684Pod\u4e0a\uff0c\u9019\u500b Service \u6703\u88ab\u7cfb\u7d71\u5206\u914d\u4e00\u500b\u6211\u5011\u4e0a\u9762\u8aaa\u7684 Cluster IP\uff0c\u8a72 Service \u9084\u6703\u6301\u7e8c\u7684\u76e3\u807d selector \u4e0b\u9762\u7684 Pod\uff0c\u6703\u628a\u9019\u4e9b Pod \u4fe1\u606f\u66f4\u65b0\u5230\u4e00\u500b\u540d\u70ba myservice \u7684Endpoints \u5c0d\u8c61\u4e0a\u53bb\uff0c\u9019\u500b\u5c0d\u8c61\u5c31\u985e\u4f3c\u65bc\u6211\u5011\u4e0a\u9762\u8aaa\u7684 Pod\u96c6\u5408\u4e86\u3002 \u5728\u5b9a\u7fa9 Service \u7684\u6642\u5019\u53ef\u4ee5\u6307\u5b9a\u4e00\u500b\u81ea\u5df1\u9700\u8981\u7684\u985e\u578b\u7684 Service\uff0c\u5982\u679c\u4e0d\u6307\u5b9a\u7684\u8a71\u9ed8\u8a8d\u662f ClusterIP \u985e\u578b\u3002\u53ef\u4ee5\u4f7f\u7528\u7684\u670d\u52d9\u985e\u578b\u5982\u4e0b\uff1a ClusterIP \uff1a\u901a\u904e\u96c6\u7fa4\u7684\u5167\u90e8 IP \u66b4\u9732\u670d\u52d9\uff0c\u9078\u64c7\u8a72\u503c\uff0c\u670d\u52d9\u53ea\u80fd\u5920\u5728\u96c6\u7fa4\u5167\u90e8\u53ef\u4ee5\u8a2a\u554f\uff0c\u9019\u4e5f\u662f\u9ed8\u8a8d\u7684ServiceType\u3002 NodePort \uff1a\u901a\u904e\u6bcf\u500b Node \u7bc0\u9ede\u4e0a\u7684 IP \u548c\u975c\u614b\u7aef\u53e3\uff08NodePort\uff09\u66b4\u9732\u670d\u52d9\u3002 NodePort \u670d\u52d9\u6703\u8def\u7531\u5230 ClusterIP \u670d\u52d9\uff0c\u9019\u500b ClusterIP \u670d\u52d9\u6703\u81ea\u52d5\u5275\u5efa\u3002\u901a\u904e\u8acb\u6c42 :\uff0c\u53ef\u4ee5\u5f9e\u96c6\u7fa4\u7684\u5916\u90e8\u8a2a\u554f\u4e00\u500b NodePort \u670d\u52d9\u3002 LoadBalancer \uff1a\u4f7f\u7528\u96f2\u63d0\u4f9b\u5546\u7684\u8ca0\u8f09\u5c40\u8861\u5668\uff0c\u53ef\u4ee5\u5411\u5916\u90e8\u66b4\u9732\u670d\u52d9\u3002\u5916\u90e8\u7684\u8ca0\u8f09\u5747\u8861\u5668\u53ef\u4ee5\u8def\u7531\u5230 NodePort \u670d\u52d9\u548c ClusterIP \u670d\u52d9\uff0c\u9019\u500b\u9700\u8981\u7d50\u5408\u5177\u9ad4\u7684\u96f2\u5ee0\u5546\u9032\u884c\u64cd\u4f5c\u3002 ExternalName \uff1a\u901a\u904e\u8fd4\u56de CNAME \u548c\u5b83\u7684\u503c\uff0c\u53ef\u4ee5\u5c07\u670d\u52d9\u6620\u5c04\u5230 externalName \u5b57\u6bb5\u7684\u5167\u5bb9\uff08\u4f8b\u5982\uff0c http://foo.bar.example.com \uff09\u3002","title":"Service \u6982\u5ff5"},{"location":"kubernetes/02-concepts/05-svc-lb-network/k8s-network-intro/#ingress","text":"Kubernetes \u5411\u5916\u90e8\u66b4\u9732\u670d\u52d9\u7684\u624b\u6cd5\u4e3b\u8981\u662f\u901a\u904e NodePort \u65b9\u5f0f\uff0c\u901a\u904e\u7d81\u5b9a\u5bbf\u4e3b\u6a5f\u7684\u67d0\u500b\u7aef\u53e3,\u7136\u5f8c\u9032\u884c pod \u7684\u8acb\u6c42\u8f49\u767c\u548c\u8ca0\u8f09\u5747\u8861\uff0c\u4f46\u9019\u7a2e\u65b9\u5f0f\u4e0b\u7f3a\u9677\u662f\uff1a Service \u53ef\u80fd\u6709\u5f88\u591a\u500b\uff0c\u5982\u679c\u6bcf\u500b\u90fd\u7d81\u5b9a\u4e00\u500b node \u4e3b\u6a5f\u7aef\u53e3\u7684\u8a71\uff0c\u4e3b\u6a5f\u9700\u8981\u958b\u653e\u5916\u570d\u4e00\u5806\u7684\u7aef\u53e3\u9032\u884c\u670d\u52d9\u8abf\u7528\uff0c\u7ba1\u7406\u6df7\u4e82\u7121\u6cd5\u61c9\u7528\u5f88\u591a\u516c\u53f8\u8981\u6c42\u7684\u9632\u706b\u7246\u898f\u5247\u3002 \u7406\u60f3\u7684\u65b9\u5f0f\u662f\u901a\u904e\u4e00\u500b\u5916\u90e8\u7684\u8ca0\u8f09\u5747\u8861\u5668\uff0c\u7d81\u5b9a\u56fa\u5b9a\u7684\u7aef\u53e3\uff0c\u6bd4\u598280,\u7136\u5f8c\u6839\u64da\u57df\u540d\u6216\u8005\u670d\u52d9\u540d\u5411\u5f8c\u9762\u7684Service ip\u8f49\u767c\uff0cNginx\u5f88\u597d\u7684\u89e3\u6c7a\u4e86\u9019\u500b\u9700\u6c42\uff0c\u4f46\u554f\u984c\u662f\u5982\u679c\u6709\u65b0\u7684\u670d\u52d9\u52a0\u5165\uff0c\u5982\u4f55\u53bb\u4fee\u6539Nginx\u7684\u914d\u7f6e\uff0c\u4e26\u4e14\u52a0\u8f09\u9019\u4e9b\u914d\u7f6e\uff1f Kubernetes \u7d66\u51fa\u7684\u65b9\u6848\u5c31\u662f Ingress\uff0cIngress \u5305\u542b\u4e86\u5169\u5927\u4e3b\u4ef6 Ingress Controller \u548c Ingress\u3002 Ingress \u89e3\u6c7a\u7684\u662f\u65b0\u7684\u670d\u52d9\u52a0\u5165\u5f8c\uff0c\u57df\u540d\u548c\u670d\u52d9\u7684\u5c0d\u61c9\u554f\u984c\uff0c\u57fa\u672c\u4e0a\u662f\u4e00\u500b ingress \u7684\u5c0d\u8c61\uff0c\u901a\u904e yaml \u9032\u884c\u5275\u5efa\u548c\u66f4\u65b0\u9032\u884c\u52a0\u8f09\u3002 Ingress Controller \u662f\u5c07I ngress \u9019\u7a2e\u8b8a\u5316\u751f\u6210\u4e00\u6bb5 Nginx \u7684\u914d\u7f6e\uff0c\u7136\u5f8c\u5c07\u9019\u500b\u914d\u7f6e\u901a\u904eKubernetes API\u5beb\u5230 Nginx \u7684 Pod \u4e2d\uff0c\u7136\u5f8c reload.\uff08\u6ce8\u610f\uff1a\u5beb\u5165 nginx.conf \u7684\u4e0d\u662f service \u7684\u5730\u5740\uff0c\u800c\u662f service backend \u7684 pod \u7684\u5730\u5740\uff0c\u907f\u514d\u5728 service \u5728\u589e\u52a0\u4e00\u5c64\u8ca0\u8f09\u5747\u8861\u8f49\u767c\uff09","title":"Ingress \u6982\u5ff5"},{"location":"kubernetes/02-concepts/06-storage/","text":"\u5b58\u5132 \u00b6 Kubernetes \u5b58\u5132\u89e3\u6c7a\u65b9\u6848\u7a2e\u985e\u7e41\u591a\uff0c\u4e3b\u8981\u5206\u70ba\u56db\u5927\u985e\uff0c\u5206\u5225\u662f\u5206\u4f48\u5f0f\u6587\u4ef6\u5b58\u5132\uff0c\u5206\u4f48\u5f0f\u584a\u5b58\u5132\uff0cLocal-Disk \u548c\u50b3\u7d71 NAS\u3002 \u5206\u4f48\u5f0f\u584a\u5b58\u5132\uff1a\u5305\u62ec\u958b\u6e90\u793e\u5340\u7684 Ceph\uff0cSheepdog\uff0c\u5546\u696d\u7522\u54c1\u4e2d EMC \u7684 Scale IO\uff0cVmware \u7684 vSAN \u7b49\uff0c\u5206\u4f48\u5f0f\u584a\u5b58\u5132\u4e0d\u9069\u5408\u5bb9\u5668\u5834\u666f\uff0c\u95dc\u9375\u554f\u984c\u662f\u7f3a\u5931 RWX \u7684\u7279\u6027\u3002 \u5206\u4f48\u5f0f\u6587\u4ef6\u5b58\u5132\uff1a\u5305\u62ec\u958b\u6e90\u793e\u5340\u7684 Glusterfs\uff0cCephfs\uff0cLustre\uff0cMoosefs\uff0cLizardfs, Longhorn\uff0c\u5546\u696d\u7522\u54c1\u4e2d EMC \u7684 isilon\uff0cIBM \u7684 GPFS \u7b49\u3002\u5206\u4f48\u5f0f\u6587\u4ef6\u5b58\u5132\u9069\u5408\u5bb9\u5668\u5834\u666f\uff0c\u4f46\u662f\u6027\u80fd\u554f\u984c\u6bd4\u8f03\u9700\u8981\u53bb\u8861\u91cf\u8207\u8a55\u4f30\u3002 Local-Disk\uff1a\u6709\u660e\u986f\u7684\u7f3a\u9ede\uff0c\u5c24\u5176\u662f\u91dd\u5c0d\u6578\u64da\u5eab\uff0c\u5927\u6578\u64da\u985e\u7684\u61c9\u7528\u3002\u7bc0\u9ede\u6545\u969c\u5f8c\uff0c\u6578\u64da\u7684\u6062\u5fa9\u6642\u9593\u9577\uff0c\u5c0d\u696d\u52d9\u5f71\u97ff\u7bc4\u570d\u5ee3\u3002 \u50b3\u7d71 NAS\uff1a\u4e5f\u662f\u4e00\u7a2e\u6587\u4ef6\u5b58\u5132\uff0c\u4f46\u662f\u5e95\u5c64\u5354\u8b70\u662f\u6027\u80fd\u95dc\u9375\uff0c\u50b3\u7d71 NAS \u5df2\u7d93\u8ddf\u4e0d\u4e0a\u96f2\u539f\u751f\u6642\u4ee3\u767c\u5c55\u7684\u6f6e\u6d41\u8207\u8d70\u5411\u3002 Kubernetes v1.9 \u5f15\u5165\u7684\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 CSI \uff0c\u4e26\u65bc v1.13 \u7248\u672c\u6b63\u5f0f GA\u3002 CSI \u7684\u5f15\u5165\u6975\u5927\u7684\u589e\u5f37\u4e86\u5bb9\u5668\u5b58\u5132\u751f\u614b\u9ad4\u7cfb\uff0c\u6a19\u6e96\u5316\u5bb9\u5668\u5e73\u53f0\u8207\u5916\u90e8\u5b58\u5132\u7cfb\u7d71\u7684\u96c6\u6210\u3002\u6709\u72c0\u614b\u61c9\u7528\u4e0d\u9700\u8981\u4e86\u89e3\u5e95\u5c64\u5b58\u5132\u7cfb\u7d71\u7684\u4efb\u4f55\u4fe1\u606f\uff0c\u53ea\u9700\u5c07\u6578\u64da\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u6216\u584a\u8a2d\u5099\u7684\u5bb9\u5668\u5b58\u5132\u5377\uff0c\u7531\u5bb9\u5668\u5e73\u53f0\u900f\u660e\u5730\u8655\u7406\u5b58\u5132\u76f8\u95dc\u7684\u7de8\u6392\u8207\u8abf\u5ea6\u5de5\u4f5c\u3002 Kubernetes \u7684 Volume \u7684\u5275\u5efa\u548c\u639b\u8f09\u6d41\u7a0b\u5982\u4e0b\uff1a \u7528\u6236\u63d0\u4ea4 PVC\uff0cKubernetes \u5e73\u53f0\u81ea\u52d5\u5275\u5efa\u51fa PV Kubernetes \u5e73\u53f0\u5c07 PV \u548c PVC \u9032\u884c\u7d81\u5b9a \u90e8\u7f72 Pod \u4e26\u4f7f\u7528\u5df2\u5275\u5efa\u7684 PVC\uff0cKubernetes \u5c07 Pod \u8abf\u5ea6\u5230\u67d0\u5bbf\u4e3b\u6a5f Kubernetes \u5c07 PVC \u5c0d\u61c9\u7684 Volume \u9032\u884c Attach \u5230\u5c0d\u61c9\u5bbf\u4e3b\u6a5f \u5bbf\u4e3b\u6a5f\u4e0a\u7684 kubelet \u5b8c\u6210 Volume \u7684 Mount \u64cd\u4f5c \u7e3d\u7684\u4f86\u8aaa\uff0c\u5bb9\u5668\u5b58\u5132\u65b9\u6848\u7684\u9078\u64c7\uff0c\u9700\u8981\u57fa\u65bc\u5be6\u969b\u7684\u696d\u52d9\u9700\u6c42\u51fa\u767c\uff0c\u6df1\u523b\u7406\u89e3\u5bb9\u5668\u5e73\u53f0\u672a\u4f86\u627f\u8f09\u7684\u696d\u52d9\u985e\u578b\uff0c\u5982\u679c\u57fa\u65bc\u96f2\u5e73\u53f0\u69cb\u5efa\u96f2\u539f\u751f\u5e73\u53f0\uff0c\u76e1\u91cf\u8207 IaaS \u5e95\u5c64\u4fdd\u6301\u4e00\u81f4\uff0c\u540c\u6642\u9700\u8981\u8003\u616e\u5718\u968a\u7684\u6280\u8853\u5be6\u529b\uff0c\u958b\u6e90\u7522\u54c1\u5c0d\u6280\u8853\u80fd\u529b\u8981\u6c42\u6bd4\u8f03\u9ad8\uff0c\u9078\u64c7\u958b\u6e90\u7522\u54c1\uff0c\u6700\u597d\u6709\u76f8\u61c9\u7684\u6280\u8853\u4eba\u54e1\u5132\u5099\u3002\u5982\u679c\u6280\u8853\u5132\u5099\u4e0d\u8db3\uff0c\u6700\u597d\u662f\u9078\u64c7\u5546\u7528\u7522\u54c1\uff0c\u96d6\u7136\u6210\u672c\u9ad8\u9ede\u4f46\u7d93\u904e\u4e86\u773e\u591a\u4f01\u696d\u7684\u6280\u8853\u9a57\u8b49\u3002","title":"\u7c21\u4ecb"},{"location":"kubernetes/02-concepts/06-storage/#_1","text":"Kubernetes \u5b58\u5132\u89e3\u6c7a\u65b9\u6848\u7a2e\u985e\u7e41\u591a\uff0c\u4e3b\u8981\u5206\u70ba\u56db\u5927\u985e\uff0c\u5206\u5225\u662f\u5206\u4f48\u5f0f\u6587\u4ef6\u5b58\u5132\uff0c\u5206\u4f48\u5f0f\u584a\u5b58\u5132\uff0cLocal-Disk \u548c\u50b3\u7d71 NAS\u3002 \u5206\u4f48\u5f0f\u584a\u5b58\u5132\uff1a\u5305\u62ec\u958b\u6e90\u793e\u5340\u7684 Ceph\uff0cSheepdog\uff0c\u5546\u696d\u7522\u54c1\u4e2d EMC \u7684 Scale IO\uff0cVmware \u7684 vSAN \u7b49\uff0c\u5206\u4f48\u5f0f\u584a\u5b58\u5132\u4e0d\u9069\u5408\u5bb9\u5668\u5834\u666f\uff0c\u95dc\u9375\u554f\u984c\u662f\u7f3a\u5931 RWX \u7684\u7279\u6027\u3002 \u5206\u4f48\u5f0f\u6587\u4ef6\u5b58\u5132\uff1a\u5305\u62ec\u958b\u6e90\u793e\u5340\u7684 Glusterfs\uff0cCephfs\uff0cLustre\uff0cMoosefs\uff0cLizardfs, Longhorn\uff0c\u5546\u696d\u7522\u54c1\u4e2d EMC \u7684 isilon\uff0cIBM \u7684 GPFS \u7b49\u3002\u5206\u4f48\u5f0f\u6587\u4ef6\u5b58\u5132\u9069\u5408\u5bb9\u5668\u5834\u666f\uff0c\u4f46\u662f\u6027\u80fd\u554f\u984c\u6bd4\u8f03\u9700\u8981\u53bb\u8861\u91cf\u8207\u8a55\u4f30\u3002 Local-Disk\uff1a\u6709\u660e\u986f\u7684\u7f3a\u9ede\uff0c\u5c24\u5176\u662f\u91dd\u5c0d\u6578\u64da\u5eab\uff0c\u5927\u6578\u64da\u985e\u7684\u61c9\u7528\u3002\u7bc0\u9ede\u6545\u969c\u5f8c\uff0c\u6578\u64da\u7684\u6062\u5fa9\u6642\u9593\u9577\uff0c\u5c0d\u696d\u52d9\u5f71\u97ff\u7bc4\u570d\u5ee3\u3002 \u50b3\u7d71 NAS\uff1a\u4e5f\u662f\u4e00\u7a2e\u6587\u4ef6\u5b58\u5132\uff0c\u4f46\u662f\u5e95\u5c64\u5354\u8b70\u662f\u6027\u80fd\u95dc\u9375\uff0c\u50b3\u7d71 NAS \u5df2\u7d93\u8ddf\u4e0d\u4e0a\u96f2\u539f\u751f\u6642\u4ee3\u767c\u5c55\u7684\u6f6e\u6d41\u8207\u8d70\u5411\u3002 Kubernetes v1.9 \u5f15\u5165\u7684\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 CSI \uff0c\u4e26\u65bc v1.13 \u7248\u672c\u6b63\u5f0f GA\u3002 CSI \u7684\u5f15\u5165\u6975\u5927\u7684\u589e\u5f37\u4e86\u5bb9\u5668\u5b58\u5132\u751f\u614b\u9ad4\u7cfb\uff0c\u6a19\u6e96\u5316\u5bb9\u5668\u5e73\u53f0\u8207\u5916\u90e8\u5b58\u5132\u7cfb\u7d71\u7684\u96c6\u6210\u3002\u6709\u72c0\u614b\u61c9\u7528\u4e0d\u9700\u8981\u4e86\u89e3\u5e95\u5c64\u5b58\u5132\u7cfb\u7d71\u7684\u4efb\u4f55\u4fe1\u606f\uff0c\u53ea\u9700\u5c07\u6578\u64da\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u6216\u584a\u8a2d\u5099\u7684\u5bb9\u5668\u5b58\u5132\u5377\uff0c\u7531\u5bb9\u5668\u5e73\u53f0\u900f\u660e\u5730\u8655\u7406\u5b58\u5132\u76f8\u95dc\u7684\u7de8\u6392\u8207\u8abf\u5ea6\u5de5\u4f5c\u3002 Kubernetes \u7684 Volume \u7684\u5275\u5efa\u548c\u639b\u8f09\u6d41\u7a0b\u5982\u4e0b\uff1a \u7528\u6236\u63d0\u4ea4 PVC\uff0cKubernetes \u5e73\u53f0\u81ea\u52d5\u5275\u5efa\u51fa PV Kubernetes \u5e73\u53f0\u5c07 PV \u548c PVC \u9032\u884c\u7d81\u5b9a \u90e8\u7f72 Pod \u4e26\u4f7f\u7528\u5df2\u5275\u5efa\u7684 PVC\uff0cKubernetes \u5c07 Pod \u8abf\u5ea6\u5230\u67d0\u5bbf\u4e3b\u6a5f Kubernetes \u5c07 PVC \u5c0d\u61c9\u7684 Volume \u9032\u884c Attach \u5230\u5c0d\u61c9\u5bbf\u4e3b\u6a5f \u5bbf\u4e3b\u6a5f\u4e0a\u7684 kubelet \u5b8c\u6210 Volume \u7684 Mount \u64cd\u4f5c \u7e3d\u7684\u4f86\u8aaa\uff0c\u5bb9\u5668\u5b58\u5132\u65b9\u6848\u7684\u9078\u64c7\uff0c\u9700\u8981\u57fa\u65bc\u5be6\u969b\u7684\u696d\u52d9\u9700\u6c42\u51fa\u767c\uff0c\u6df1\u523b\u7406\u89e3\u5bb9\u5668\u5e73\u53f0\u672a\u4f86\u627f\u8f09\u7684\u696d\u52d9\u985e\u578b\uff0c\u5982\u679c\u57fa\u65bc\u96f2\u5e73\u53f0\u69cb\u5efa\u96f2\u539f\u751f\u5e73\u53f0\uff0c\u76e1\u91cf\u8207 IaaS \u5e95\u5c64\u4fdd\u6301\u4e00\u81f4\uff0c\u540c\u6642\u9700\u8981\u8003\u616e\u5718\u968a\u7684\u6280\u8853\u5be6\u529b\uff0c\u958b\u6e90\u7522\u54c1\u5c0d\u6280\u8853\u80fd\u529b\u8981\u6c42\u6bd4\u8f03\u9ad8\uff0c\u9078\u64c7\u958b\u6e90\u7522\u54c1\uff0c\u6700\u597d\u6709\u76f8\u61c9\u7684\u6280\u8853\u4eba\u54e1\u5132\u5099\u3002\u5982\u679c\u6280\u8853\u5132\u5099\u4e0d\u8db3\uff0c\u6700\u597d\u662f\u9078\u64c7\u5546\u7528\u7522\u54c1\uff0c\u96d6\u7136\u6210\u672c\u9ad8\u9ede\u4f46\u7d93\u904e\u4e86\u773e\u591a\u4f01\u696d\u7684\u6280\u8853\u9a57\u8b49\u3002","title":"\u5b58\u5132"},{"location":"kubernetes/02-concepts/07-configuration/configmap/","text":"ConfigMap \u00b6 ConfigMap \u662f\u4e00\u7a2e API \u5c0d\u8c61\uff0c\u7528\u4f86\u5c07\u975e\u6a5f\u5bc6\u6027\u7684\u6578\u64da\u4fdd\u5b58\u5230\u9375\u503c\u5c0d\u4e2d\u3002\u4f7f\u7528\u6642\uff0c Pods \u53ef\u4ee5\u5c07\u5176\u7528\u4f5c\u74b0\u5883\u8b8a\u91cf\u3001\u547d\u4ee4\u884c\u53c3\u6578\u6216\u8005\u5b58\u5132\u5377\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\u3002 ConfigMap \u5c07\u4f60\u7684\u74b0\u5883\u914d\u7f6e\u4fe1\u606f\u548c \u5bb9\u5668\u93e1\u50cf \u89e3\u8026\uff0c\u4fbf\u65bc\u61c9\u7528\u914d\u7f6e\u7684\u4fee\u6539\u3002 Warning ConfigMap \u4e26\u4e0d\u63d0\u4f9b\u4fdd\u5bc6\u6216\u8005\u52a0\u5bc6\u529f\u80fd\u3002\u5982\u679c\u4f60\u60f3\u5b58\u5132\u7684\u6578\u64da\u662f\u6a5f\u5bc6\u7684\uff0c\u8acb\u4f7f\u7528 Secret\uff0c \u6216\u8005\u4f7f\u7528\u5176\u4ed6\u7b2c\u4e09\u65b9\u5de5\u5177\u4f86\u4fdd\u8b49\u4f60\u7684\u6578\u64da\u7684\u79c1\u5bc6\u6027\uff0c\u800c\u4e0d\u662f\u7528 ConfigMap\u3002 \u52d5\u6a5f \u00b6 \u4f7f\u7528 ConfigMap \u4f86\u5c07\u4f60\u7684\u914d\u7f6e\u6578\u64da\u548c\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u5206\u958b\u3002 \u6bd4\u5982\uff0c\u5047\u8a2d\u4f60\u6b63\u5728\u958b\u767c\u4e00\u500b\u61c9\u7528\uff0c\u5b83\u53ef\u4ee5\u5728\u4f60\u81ea\u5df1\u7684\u96fb\u8166\u4e0a\uff08\u7528\u65bc\u958b\u767c\uff09\u548c\u5728\u96f2\u4e0a \uff08\u7528\u65bc\u5be6\u969b\u6d41\u91cf\uff09\u904b\u884c\u3002\u4f60\u7684\u4ee3\u78bc\u88e1\u6709\u4e00\u6bb5\u662f\u7528\u65bc\u67e5\u770b\u74b0\u5883\u8b8a\u91cf DATABASE_HOST\uff0c\u5728\u672c\u5730\u904b\u884c\u6642\uff0c \u4f60\u5c07\u9019\u500b\u8b8a\u91cf\u8a2d\u7f6e\u70ba localhost\uff0c\u5728\u96f2\u4e0a\uff0c\u4f60\u5c07\u5176\u8a2d\u7f6e\u70ba\u5f15\u7528 Kubernetes \u96c6\u7fa4\u4e2d\u7684 \u516c\u958b\u6578\u64da\u5eab\u7d44\u4ef6\u7684 \u670d\u52d9\u3002 \u9019\u8b93\u4f60\u53ef\u4ee5\u7372\u53d6\u5728\u96f2\u4e2d\u904b\u884c\u7684\u5bb9\u5668\u93e1\u50cf\uff0c\u4e26\u4e14\u5982\u679c\u6709\u9700\u8981\u7684\u8a71\uff0c\u5728\u672c\u5730\u8abf\u8a66\u5b8c\u5168\u76f8\u540c\u7684\u4ee3\u78bc\u3002 ConfigMap \u5728\u8a2d\u8a08\u4e0a\u4e0d\u662f\u7528\u4f86\u4fdd\u5b58\u5927\u91cf\u6578\u64da\u7684\u3002 \u5728 ConfigMap \u4e2d\u4fdd\u5b58\u7684\u6578\u64da\u4e0d\u53ef\u8d85\u904e 1 MiB \u3002\u5982\u679c\u4f60\u9700\u8981\u4fdd\u5b58\u8d85\u51fa\u6b64\u5c3a\u5bf8\u9650\u5236\u7684\u6578\u64da\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u8003\u616e\u639b\u8f09\u5b58\u5132\u5377 \u6216\u8005\u4f7f\u7528\u7368\u7acb\u7684\u6578\u64da\u5eab\u6216\u8005\u6587\u4ef6\u670d\u52d9\u3002 ConfigMap \u5c0d\u8c61 \u00b6 ConfigMap \u662f\u4e00\u500b API \u5c0d\u8c61 \uff0c \u8b93\u4f60\u53ef\u4ee5\u5b58\u5132\u5176\u4ed6\u5c0d\u8c61\u6240\u9700\u8981\u4f7f\u7528\u7684\u914d\u7f6e\u3002\u548c\u5176\u4ed6 Kubernetes \u5c0d\u8c61\u90fd\u6709\u4e00\u500b spec \u4e0d\u540c\u7684\u662f\uff0cConfigMap \u4f7f\u7528 data \u548c binaryData \u5b57\u6bb5\u3002\u9019\u4e9b\u5b57\u6bb5\u80fd\u5920\u63a5\u6536\u9375-\u503c\u5c0d\u4f5c\u70ba\u5176\u53d6\u503c\u3002 data \u548c binaryData \u5b57\u6bb5\u90fd\u662f\u53ef\u9078\u7684\u3002 data \u5b57\u6bb5\u8a2d\u8a08\u7528\u4f86\u4fdd\u5b58 UTF-8 \u5b57\u7b26\u4e32\uff0c\u800c binaryData \u5247\u88ab\u8a2d\u8a08\u7528\u4f86\u4fdd\u5b58\u4e8c\u9032\u5236\u6578\u64da\u4f5c\u70ba base64 \u7de8\u78bc\u7684\u5b57\u4e32\u3002 ConfigMap \u7684\u540d\u5b57\u5fc5\u9808\u662f\u4e00\u500b\u5408\u6cd5\u7684 DNS \u5b50\u57df\u540d \u3002 data \u6216 binaryData \u5b57\u6bb5\u4e0b\u9762\u7684\u6bcf\u500b\u9375\u7684\u540d\u7a31\u90fd\u5fc5\u9808\u7531\u5b57\u6bcd\u6578\u5b57\u5b57\u7b26\u6216\u8005 - \u3001 _ \u6216 . \u7d44\u6210\u3002\u5728 data \u4e0b\u4fdd\u5b58\u7684\u9375\u540d\u4e0d\u53ef\u4ee5\u8207\u5728 binaryData \u4e0b\u51fa\u73fe\u7684\u9375\u540d\u6709\u91cd\u758a\u3002 \u5f9e v1.19 \u958b\u59cb\uff0c\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4e00\u500b immutable \u5b57\u6bb5\u5230 ConfigMap \u5b9a\u7fa9\u4e2d\uff0c \u5275\u5efa \u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap \u3002 ConfigMaps \u548c Pods \u00b6 \u4f60\u53ef\u4ee5\u5beb\u4e00\u500b\u5f15\u7528 ConfigMap \u7684 Pod \u7684 spec \uff0c\u4e26\u6839\u64da ConfigMap \u4e2d\u7684\u6578\u64da\u5728\u8a72 Pod \u4e2d\u914d\u7f6e\u5bb9\u5668\u3002\u9019\u500b Pod \u548c ConfigMap \u5fc5\u9808\u8981\u5728\u540c\u4e00\u500b \u547d\u540d\u7a7a\u9593 \u4e2d\u3002 \u9019\u662f\u4e00\u500b ConfigMap \u7684\u793a\u4f8b\uff0c\u5b83\u7684\u4e00\u4e9b\u9375\u53ea\u6709\u4e00\u500b\u503c\uff0c\u5176\u4ed6\u9375\u7684\u503c\u770b\u8d77\u4f86\u50cf\u662f \u914d\u7f6e\u7684\u7247\u6bb5\u683c\u5f0f\u3002 apiVersion : v1 kind : ConfigMap metadata : name : game-demo data : # \u985e\u5c6c\u6027\u9375\uff1b\u6bcf\u4e00\u500b\u9375\u90fd\u6620\u5c04\u5230\u4e00\u500b\u7c21\u55ae\u7684\u503c player_initial_lives : \"3\" ui_properties_file_name : \"user-interface.properties\" # \u985e\u6587\u4ef6\u9375 game.properties : | enemy.types=aliens,monsters player.maximum-lives=5 user-interface.properties : | color.good=purple color.bad=yellow allow.textmode=true \u4f60\u53ef\u4ee5\u4f7f\u7528\u56db\u7a2e\u65b9\u5f0f\u4f86\u4f7f\u7528 ConfigMap \u914d\u7f6e Pod \u4e2d\u7684\u5bb9\u5668\uff1a \u5728\u5bb9\u5668\u547d\u4ee4\u548c\u53c3\u6578\u5167 \u5bb9\u5668\u7684\u74b0\u5883\u8b8a\u91cf \u5728\u53ea\u8b80\u5377\u88e1\u9762\u6dfb\u52a0\u4e00\u500b\u6587\u4ef6\uff0c\u8b93\u61c9\u7528\u4f86\u8b80\u53d6 \u7de8\u5beb\u4ee3\u78bc\u5728 Pod \u4e2d\u904b\u884c\uff0c\u4f7f\u7528 Kubernetes API \u4f86\u8b80\u53d6 ConfigMap \u9019\u4e9b\u4e0d\u540c\u7684\u65b9\u6cd5\u9069\u7528\u65bc\u4e0d\u540c\u7684\u6578\u64da\u4f7f\u7528\u65b9\u5f0f\u3002\u5c0d\u524d\u4e09\u500b\u65b9\u6cd5\uff0ckubelet \u4f7f\u7528 ConfigMap \u4e2d\u7684\u6578\u64da\u5728 Pod \u4e2d\u555f\u52d5\u5bb9\u5668\u3002 \u7b2c\u56db\u7a2e\u65b9\u6cd5\u610f\u5473\u8457\u4f60\u5fc5\u9808\u7de8\u5beb\u4ee3\u78bc\u624d\u80fd\u8b80\u53d6 ConfigMap \u548c\u5b83\u7684\u6578\u64da\u3002\u7136\u800c\uff0c \u7531\u65bc\u4f60\u662f\u76f4\u63a5\u4f7f\u7528 Kubernetes API\uff0c\u56e0\u6b64\u53ea\u8981 ConfigMap \u767c\u751f\u66f4\u6539\uff0c \u4f60\u7684\u61c9\u7528\u5c31\u80fd\u5920\u901a\u904e\u8a02\u95b1\u4f86\u7372\u53d6\u66f4\u65b0\uff0c\u4e26\u4e14\u5728\u9019\u6a23\u7684\u60c5\u6cc1\u767c\u751f\u7684\u6642\u5019\u505a\u51fa\u53cd\u61c9\u3002\u901a\u904e\u76f4\u63a5\u9032\u5165 Kubernetes API\uff0c\u9019\u500b\u6280\u8853\u4e5f\u53ef\u4ee5\u8b93\u4f60\u80fd\u5920\u7372\u53d6\u5230\u4e0d\u540c\u7684\u540d\u5b57\u7a7a\u9593\u88e1\u7684 ConfigMap\u3002 \u4e0b\u9762\u662f\u4e00\u500b Pod \u7684\u793a\u4f8b\uff0c\u5b83\u901a\u904e\u4f7f\u7528 game-demo \u4e2d\u7684\u503c\u4f86\u914d\u7f6e\u4e00\u500b Pod\uff1a apiVersion : v1 kind : Pod metadata : name : configmap-demo-pod spec : containers : - name : demo image : alpine command : [ \"sleep\" , \"3600\" ] env : # \u5b9a\u7fa9\u74b0\u5883\u8b8a\u91cf - name : PLAYER_INITIAL_LIVES # \u8acb\u6ce8\u610f\u9019\u91cc\u548c ConfigMap \u4e2d\u7684\u9375\u540d\u662f\u4e0d\u4e00\u6a23\u7684 valueFrom : configMapKeyRef : name : game-demo # \u9019\u500b\u503c\u4f86\u81ea ConfigMap key : player_initial_lives # \u9700\u8981\u53d6\u503c\u7684\u952e - name : UI_PROPERTIES_FILE_NAME valueFrom : configMapKeyRef : name : game-demo key : ui_properties_file_name volumeMounts : - name : config mountPath : \"/config\" readOnly : true volumes : # \u4f60\u53ef\u4ee5\u5728 Pod \u7d1a\u5225\u8a2d\u7f6e\u5377\uff0c\u7136\u5f8c\u5c07\u5176\u639b\u8f09\u5230 Pod \u5167\u7684\u5bb9\u5668\u4e2d - name : config configMap : # \u63d0\u4f9b\u4f60\u60f3\u8981\u639b\u8f09\u7684 ConfigMap \u7684\u540d\u5b57 name : game-demo # \u4f86\u81ea ConfigMap \u7684\u4e00\u7d44\u9375\uff0c\u5c07\u88ab\u5275\u5efa\u70ba\u6587\u4ef6 items : - key : \"game.properties\" path : \"game.properties\" - key : \"user-interface.properties\" path : \"user-interface.properties\" ConfigMap \u4e0d\u6703\u5340\u5206\u55ae\u884c\u5c6c\u6027\u503c\u548c\u591a\u884c\u985e\u4f3c\u6587\u4ef6\u7684\u503c\uff0c\u91cd\u8981\u7684\u662f Pods \u548c\u5176\u4ed6\u5c0d\u50cf\u5982\u4f55\u4f7f\u7528\u9019\u4e9b\u503c\u3002 \u4e0a\u9762\u7684\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u4e00\u500b\u5377\u4e26\u5c07\u5b83\u4f5c\u70ba /config \u6587\u4ef6\u593e\u639b\u8f09\u5230 demo \u5bb9\u5668\u5167\uff0c \u5275\u5efa\u5169\u500b\u6587\u4ef6\uff0c /config/game.properties \u548c /config/user-interface.properties \uff0c \u5118\u7ba1 ConfigMap \u4e2d\u5305\u542b\u4e86\u56db\u500b\u9375\u3002\u9019\u662f\u56e0\u70ba Pod \u5b9a\u7fa9\u4e2d\u5728 volumes \u7bc0\u6307\u5b9a\u4e86\u4e00\u500b items \u6578\u7d44\u3002\u5982\u679c\u4f60\u5b8c\u5168\u5ffd\u7565 items \u6578\u7d44\uff0c\u5247 ConfigMap \u4e2d\u7684\u6bcf\u500b\u9375\u90fd\u6703\u8b8a\u6210\u4e00\u500b\u8207\u8a72\u9375\u540c\u540d\u7684\u6587\u4ef6\uff0c \u56e0\u6b64\u4f60\u6703\u5f97\u5230\u56db\u500b\u6587\u4ef6\u3002 \u4f7f\u7528 ConfigMap \u00b6 ConfigMap \u53ef\u4ee5\u4f5c\u70ba\u6578\u64da\u5377\u639b\u8f09\u3002 ConfigMap \u4e5f\u53ef\u88ab\u7cfb\u7d71\u7684\u5176\u4ed6\u7d44\u4ef6\u4f7f\u7528\uff0c \u800c\u4e0d\u4e00\u5b9a\u76f4\u63a5\u66b4\u9732\u7d66 Pod\u3002\u4f8b\u5982\uff0cConfigMap \u53ef\u4ee5\u4fdd\u5b58\u7cfb\u7d71\u4e2d\u5176\u4ed6\u7d44\u4ef6\u8981\u4f7f\u7528\u7684\u914d\u7f6e\u6578\u64da\u3002 ConfigMap \u6700\u5e38\u898b\u7684\u7528\u6cd5\u662f\u70ba\u540c\u4e00\u547d\u540d\u7a7a\u9593\u88e1\u67d0 Pod \u4e2d\u904b\u884c\u7684\u5bb9\u5668\u57f7\u884c\u914d\u7f6e\u3002\u4f60\u4e5f\u53ef\u4ee5\u55ae\u7368\u4f7f\u7528 ConfigMap\u3002 \u6bd4\u5982\uff0c\u4f60\u53ef\u80fd\u6703\u9047\u5230\u57fa\u65bc ConfigMap \u4f86\u8abf\u6574\u5176\u884c\u70ba\u7684 \u63d2\u4ef6 \u6216\u8005 operator\u3002 \u5728 Pod \u4e2d\u5c07 ConfigMap \u7576\u505a\u6587\u4ef6\u4f7f\u7528 \u00b6 \u8981\u5728\u4e00\u500b Pod \u7684\u5b58\u5132\u5377\u4e2d\u4f7f\u7528 ConfigMap: \u5275\u5efa\u4e00\u500b ConfigMap \u5c0d\u50cf\u6216\u8005\u4f7f\u7528\u73fe\u6709\u7684 ConfigMap \u5c0d\u8c61\u3002\u591a\u500b Pod \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u500b ConfigMap\u3002 \u4fee\u6539 Pod \u5b9a\u7fa9\uff0c\u5728 spec.volumes[] \u4e0b\u6dfb\u52a0\u4e00\u500b\u5377\u3002\u70ba\u8a72\u5377\u8a2d\u7f6e\u4efb\u610f\u540d\u7a31\uff0c\u4e4b\u5f8c\u5c07 spec.volumes[].configMap.name \u5b57\u6bb5\u8a2d\u7f6e\u70ba\u5c0d\u4f60\u7684 ConfigMap \u5c0d\u8c61\u7684\u5f15\u7528\u3002 \u70ba\u6bcf\u500b\u9700\u8981\u8a72 ConfigMap \u7684\u5bb9\u5668\u6dfb\u52a0\u4e00\u500b .spec.containers[].volumeMounts[] \u3002\u8a2d\u7f6e .spec.containers[].volumeMounts[].readOnly=true \u4e26\u5c07 .spec.containers[].volumeMounts[].mountPath \u8a2d\u7f6e\u70ba\u4e00\u500b\u672a\u4f7f\u7528\u7684\u76ee\u9304\u540d\uff0c ConfigMap \u7684\u5167\u5bb9\u5c07\u51fa\u73fe\u5728\u8a72\u76ee\u9304\u4e2d\u3002 \u66f4\u6539\u4f60\u7684\u93e1\u50cf\u6216\u8005\u547d\u4ee4\u884c\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u80fd\u5920\u5f9e\u8a72\u76ee\u9304\u4e2d\u67e5\u627e\u6587\u4ef6\u3002 ConfigMap \u4e2d\u7684\u6bcf\u500b data \u9375\u6703\u8b8a\u6210 mountPath \u4e0b\u9762\u7684\u4e00\u500b\u6587\u4ef6\u540d\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u5c07 ConfigMap \u4ee5\u5377\u7684\u5f62\u5f0f\u9032\u884c\u639b\u8f09\u7684 Pod \u793a\u4f8b\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" readOnly : true volumes : - name : foo configMap : name : myconfigmap \u4f60\u5e0c\u671b\u4f7f\u7528\u7684\u6bcf\u500b ConfigMap \u90fd\u9700\u8981\u5728 spec.volumes \u4e2d\u88ab\u5f15\u7528\u5230\u3002 \u5982\u679c Pod \u4e2d\u6709\u591a\u500b\u5bb9\u5668\uff0c\u5247\u6bcf\u500b\u5bb9\u5668\u90fd\u9700\u8981\u81ea\u5df1\u7684 volumeMounts \u584a\uff0c\u4f46\u91dd\u5c0d\u6bcf\u500b ConfigMap\uff0c\u4f60\u53ea\u9700\u8981\u8a2d\u7f6e\u4e00\u500b spec.volumes \u584a\u3002 \u88ab\u639b\u8f09\u7684 ConfigMap \u5167\u5bb9\u6703\u88ab\u81ea\u52d5\u66f4\u65b0 \u00b6 \u7576\u5377\u4e2d\u4f7f\u7528\u7684 ConfigMap \u88ab\u66f4\u65b0\u6642\uff0c\u6240\u6295\u5c04\u7684\u9375\u6700\u7d42\u4e5f\u6703\u88ab\u66f4\u65b0\u3002 kubelet \u7d44\u4ef6\u6703\u5728\u6bcf\u6b21\u9031\u671f\u6027\u540c\u6b65\u6642\u6aa2\u67e5\u6240\u639b\u8f09\u7684 ConfigMap \u662f\u5426\u70ba\u6700\u65b0\u3002\u4e0d\u904e\uff0ckubelet \u4f7f\u7528\u7684\u662f\u5176\u672c\u5730\u7684\u9ad8\u901f\u7de9\u5b58\u4f86\u7372\u5f97 ConfigMap \u7684\u7576\u524d\u503c\u3002\u9ad8\u901f\u7de9\u5b58\u7684\u985e\u578b\u53ef\u4ee5\u901a\u904e KubeletConfiguration \u7d50\u69cb. \u7684 ConfigMapAndSecretChangeDetectionStrategy \u5b57\u6bb5\u4f86\u914d\u7f6e\u3002 ConfigMap \u65e2\u53ef\u4ee5\u901a\u904e watch \u64cd\u4f5c\u5be6\u73fe\u5167\u5bb9\u50b3\u64ad\uff08\u9ed8\u8a8d\u5f62\u5f0f\uff09\uff0c\u4e5f\u53ef\u5be6\u73fe\u57fa\u65bc TTL \u7684\u7de9\u5b58\uff0c\u9084\u53ef\u4ee5\u76f4\u63a5\u7d93\u904e\u6240\u6709\u8acb\u6c42\u91cd\u5b9a\u5411\u5230 API \u670d\u52d9\u5668\u3002\u56e0\u6b64\uff0c\u5f9e ConfigMap \u88ab\u66f4\u65b0\u7684\u90a3\u4e00\u523b\u7b97\u8d77\uff0c\u5230\u65b0\u7684\u4e3b\u9375\u88ab\u6295\u5c04\u5230 Pod \u4e2d\u53bb\uff0c \u9019\u4e00\u6642\u9593\u8de8\u5ea6\u53ef\u80fd\u8207 kubelet \u7684\u540c\u6b65\u9031\u671f\u52a0\u4e0a\u9ad8\u901f\u7de9\u5b58\u7684\u50b3\u64ad\u5ef6\u9072\u76f8\u7b49\u3002\u9019\u88e1\u7684\u50b3\u64ad\u5ef6\u9072\u53d6\u6c7a\u65bc\u6240\u9078\u7684\u9ad8\u901f\u7de9\u5b58\u985e\u578b \uff08\u5206\u5225\u5c0d\u61c9 watch \u64cd\u4f5c\u7684\u50b3\u64ad\u5ef6\u9072\u3001\u9ad8\u901f\u7de9\u5b58\u7684 TTL \u6642\u9577\u6216\u8005 0\uff09\u3002 \u4ee5\u74b0\u5883\u8b8a\u91cf\u65b9\u5f0f\u4f7f\u7528\u7684 ConfigMap \u6578\u64da\u4e0d\u6703\u88ab\u81ea\u52d5\u66f4\u65b0\u3002\u66f4\u65b0\u9019\u4e9b\u6578\u64da\u9700\u8981\u91cd\u65b0\u555f\u52d5 Pod\u3002 Info \u8aaa\u660e\uff1a \u4f7f\u7528 ConfigMap \u4f5c\u70ba subPath \u5377\u639b\u8f09\u7684\u5bb9\u5668\u5c07\u4e0d\u6703\u6536\u5230 ConfigMap \u7684\u66f4\u65b0\u3002 \u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap \u00b6 Kubernetes \u7279\u6027 Immutable Secret \u548c ConfigMaps \u63d0\u4f9b\u4e86\u4e00\u7a2e\u5c07\u5404\u500b Secret \u548c ConfigMap \u8a2d\u7f6e\u70ba\u4e0d\u53ef\u8b8a\u66f4\u7684\u9078\u9805\u3002\u5c0d\u65bc\u5927\u91cf\u4f7f\u7528 ConfigMap \u7684\u96c6\u7fa4 \uff08\u81f3\u5c11\u6709\u6578\u4e07\u500b\u5404\u4e0d\u76f8\u540c\u7684 ConfigMap \u7d66 Pod \u639b\u8f09\uff09\u800c\u8a00\uff0c\u7981\u6b62\u66f4\u6539 ConfigMap \u7684\u6578\u64da\u6709\u4ee5\u4e0b\u597d\u8655\uff1a \u4fdd\u8b77\u61c9\u7528\uff0c\u4f7f\u4e4b\u514d\u53d7\u610f\u5916\uff08\u4e0d\u60f3\u8981\u7684\uff09\u66f4\u65b0\u6240\u5e36\u4f86\u7684\u8ca0\u9762\u5f71\u97ff\u3002 \u901a\u904e\u5927\u5e45\u964d\u4f4e\u5c0d kube-apiserver \u7684\u58d3\u529b\u63d0\u5347\u96c6\u7fa4\u6027\u80fd\uff0c \u9019\u662f\u56e0\u70ba\u7cfb\u7d71\u6703\u95dc\u9589\u5c0d\u5df2\u6a19\u8a18\u70ba\u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap \u7684\u76e3\u8996\u64cd\u4f5c\u3002 \u6b64\u529f\u80fd\u7279\u6027\u7531 ImmutableEphemeralVolumes \u7279\u6027\u9580\u63a7 \u4f86\u63a7\u5236\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u5c07 immutable \u5b57\u6bb5\u8a2d\u7f6e\u70ba true \u5275\u5efa\u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap\u3002\u4f8b\u5982\uff1a apiVersion : v1 kind : ConfigMap metadata : ... data : ... immutable : true \u4e00\u65e6\u67d0 ConfigMap \u88ab\u6a19\u8a18\u70ba\u4e0d\u53ef\u8b8a\u66f4\uff0c\u5247 \u7121\u6cd5 \u9006\u8f49\u9019\u4e00\u8b8a\u5316\uff0c\uff0c\u4e5f\u7121\u6cd5\u66f4\u6539 data \u6216 binaryData \u5b57\u6bb5\u7684\u5167\u5bb9\u3002\u4f60\u53ea\u80fd\u522a\u9664\u4e26\u91cd\u5efa ConfigMap\u3002\u56e0\u70ba\u73fe\u6709\u7684 Pod \u6703\u7dad\u8b77\u4e00\u500b\u5df2\u88ab\u522a\u9664\u7684 ConfigMap \u7684\u639b\u8f09\u9ede\uff0c\u5efa\u8b70\u91cd\u65b0\u5275\u5efa\u9019\u4e9b Pods\u3002","title":"ConfigMap"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#configmap","text":"ConfigMap \u662f\u4e00\u7a2e API \u5c0d\u8c61\uff0c\u7528\u4f86\u5c07\u975e\u6a5f\u5bc6\u6027\u7684\u6578\u64da\u4fdd\u5b58\u5230\u9375\u503c\u5c0d\u4e2d\u3002\u4f7f\u7528\u6642\uff0c Pods \u53ef\u4ee5\u5c07\u5176\u7528\u4f5c\u74b0\u5883\u8b8a\u91cf\u3001\u547d\u4ee4\u884c\u53c3\u6578\u6216\u8005\u5b58\u5132\u5377\u4e2d\u7684\u914d\u7f6e\u6587\u4ef6\u3002 ConfigMap \u5c07\u4f60\u7684\u74b0\u5883\u914d\u7f6e\u4fe1\u606f\u548c \u5bb9\u5668\u93e1\u50cf \u89e3\u8026\uff0c\u4fbf\u65bc\u61c9\u7528\u914d\u7f6e\u7684\u4fee\u6539\u3002 Warning ConfigMap \u4e26\u4e0d\u63d0\u4f9b\u4fdd\u5bc6\u6216\u8005\u52a0\u5bc6\u529f\u80fd\u3002\u5982\u679c\u4f60\u60f3\u5b58\u5132\u7684\u6578\u64da\u662f\u6a5f\u5bc6\u7684\uff0c\u8acb\u4f7f\u7528 Secret\uff0c \u6216\u8005\u4f7f\u7528\u5176\u4ed6\u7b2c\u4e09\u65b9\u5de5\u5177\u4f86\u4fdd\u8b49\u4f60\u7684\u6578\u64da\u7684\u79c1\u5bc6\u6027\uff0c\u800c\u4e0d\u662f\u7528 ConfigMap\u3002","title":"ConfigMap"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#_1","text":"\u4f7f\u7528 ConfigMap \u4f86\u5c07\u4f60\u7684\u914d\u7f6e\u6578\u64da\u548c\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u5206\u958b\u3002 \u6bd4\u5982\uff0c\u5047\u8a2d\u4f60\u6b63\u5728\u958b\u767c\u4e00\u500b\u61c9\u7528\uff0c\u5b83\u53ef\u4ee5\u5728\u4f60\u81ea\u5df1\u7684\u96fb\u8166\u4e0a\uff08\u7528\u65bc\u958b\u767c\uff09\u548c\u5728\u96f2\u4e0a \uff08\u7528\u65bc\u5be6\u969b\u6d41\u91cf\uff09\u904b\u884c\u3002\u4f60\u7684\u4ee3\u78bc\u88e1\u6709\u4e00\u6bb5\u662f\u7528\u65bc\u67e5\u770b\u74b0\u5883\u8b8a\u91cf DATABASE_HOST\uff0c\u5728\u672c\u5730\u904b\u884c\u6642\uff0c \u4f60\u5c07\u9019\u500b\u8b8a\u91cf\u8a2d\u7f6e\u70ba localhost\uff0c\u5728\u96f2\u4e0a\uff0c\u4f60\u5c07\u5176\u8a2d\u7f6e\u70ba\u5f15\u7528 Kubernetes \u96c6\u7fa4\u4e2d\u7684 \u516c\u958b\u6578\u64da\u5eab\u7d44\u4ef6\u7684 \u670d\u52d9\u3002 \u9019\u8b93\u4f60\u53ef\u4ee5\u7372\u53d6\u5728\u96f2\u4e2d\u904b\u884c\u7684\u5bb9\u5668\u93e1\u50cf\uff0c\u4e26\u4e14\u5982\u679c\u6709\u9700\u8981\u7684\u8a71\uff0c\u5728\u672c\u5730\u8abf\u8a66\u5b8c\u5168\u76f8\u540c\u7684\u4ee3\u78bc\u3002 ConfigMap \u5728\u8a2d\u8a08\u4e0a\u4e0d\u662f\u7528\u4f86\u4fdd\u5b58\u5927\u91cf\u6578\u64da\u7684\u3002 \u5728 ConfigMap \u4e2d\u4fdd\u5b58\u7684\u6578\u64da\u4e0d\u53ef\u8d85\u904e 1 MiB \u3002\u5982\u679c\u4f60\u9700\u8981\u4fdd\u5b58\u8d85\u51fa\u6b64\u5c3a\u5bf8\u9650\u5236\u7684\u6578\u64da\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u8003\u616e\u639b\u8f09\u5b58\u5132\u5377 \u6216\u8005\u4f7f\u7528\u7368\u7acb\u7684\u6578\u64da\u5eab\u6216\u8005\u6587\u4ef6\u670d\u52d9\u3002","title":"\u52d5\u6a5f"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#configmap_1","text":"ConfigMap \u662f\u4e00\u500b API \u5c0d\u8c61 \uff0c \u8b93\u4f60\u53ef\u4ee5\u5b58\u5132\u5176\u4ed6\u5c0d\u8c61\u6240\u9700\u8981\u4f7f\u7528\u7684\u914d\u7f6e\u3002\u548c\u5176\u4ed6 Kubernetes \u5c0d\u8c61\u90fd\u6709\u4e00\u500b spec \u4e0d\u540c\u7684\u662f\uff0cConfigMap \u4f7f\u7528 data \u548c binaryData \u5b57\u6bb5\u3002\u9019\u4e9b\u5b57\u6bb5\u80fd\u5920\u63a5\u6536\u9375-\u503c\u5c0d\u4f5c\u70ba\u5176\u53d6\u503c\u3002 data \u548c binaryData \u5b57\u6bb5\u90fd\u662f\u53ef\u9078\u7684\u3002 data \u5b57\u6bb5\u8a2d\u8a08\u7528\u4f86\u4fdd\u5b58 UTF-8 \u5b57\u7b26\u4e32\uff0c\u800c binaryData \u5247\u88ab\u8a2d\u8a08\u7528\u4f86\u4fdd\u5b58\u4e8c\u9032\u5236\u6578\u64da\u4f5c\u70ba base64 \u7de8\u78bc\u7684\u5b57\u4e32\u3002 ConfigMap \u7684\u540d\u5b57\u5fc5\u9808\u662f\u4e00\u500b\u5408\u6cd5\u7684 DNS \u5b50\u57df\u540d \u3002 data \u6216 binaryData \u5b57\u6bb5\u4e0b\u9762\u7684\u6bcf\u500b\u9375\u7684\u540d\u7a31\u90fd\u5fc5\u9808\u7531\u5b57\u6bcd\u6578\u5b57\u5b57\u7b26\u6216\u8005 - \u3001 _ \u6216 . \u7d44\u6210\u3002\u5728 data \u4e0b\u4fdd\u5b58\u7684\u9375\u540d\u4e0d\u53ef\u4ee5\u8207\u5728 binaryData \u4e0b\u51fa\u73fe\u7684\u9375\u540d\u6709\u91cd\u758a\u3002 \u5f9e v1.19 \u958b\u59cb\uff0c\u4f60\u53ef\u4ee5\u6dfb\u52a0\u4e00\u500b immutable \u5b57\u6bb5\u5230 ConfigMap \u5b9a\u7fa9\u4e2d\uff0c \u5275\u5efa \u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap \u3002","title":"ConfigMap \u5c0d\u8c61"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#configmaps-pods","text":"\u4f60\u53ef\u4ee5\u5beb\u4e00\u500b\u5f15\u7528 ConfigMap \u7684 Pod \u7684 spec \uff0c\u4e26\u6839\u64da ConfigMap \u4e2d\u7684\u6578\u64da\u5728\u8a72 Pod \u4e2d\u914d\u7f6e\u5bb9\u5668\u3002\u9019\u500b Pod \u548c ConfigMap \u5fc5\u9808\u8981\u5728\u540c\u4e00\u500b \u547d\u540d\u7a7a\u9593 \u4e2d\u3002 \u9019\u662f\u4e00\u500b ConfigMap \u7684\u793a\u4f8b\uff0c\u5b83\u7684\u4e00\u4e9b\u9375\u53ea\u6709\u4e00\u500b\u503c\uff0c\u5176\u4ed6\u9375\u7684\u503c\u770b\u8d77\u4f86\u50cf\u662f \u914d\u7f6e\u7684\u7247\u6bb5\u683c\u5f0f\u3002 apiVersion : v1 kind : ConfigMap metadata : name : game-demo data : # \u985e\u5c6c\u6027\u9375\uff1b\u6bcf\u4e00\u500b\u9375\u90fd\u6620\u5c04\u5230\u4e00\u500b\u7c21\u55ae\u7684\u503c player_initial_lives : \"3\" ui_properties_file_name : \"user-interface.properties\" # \u985e\u6587\u4ef6\u9375 game.properties : | enemy.types=aliens,monsters player.maximum-lives=5 user-interface.properties : | color.good=purple color.bad=yellow allow.textmode=true \u4f60\u53ef\u4ee5\u4f7f\u7528\u56db\u7a2e\u65b9\u5f0f\u4f86\u4f7f\u7528 ConfigMap \u914d\u7f6e Pod \u4e2d\u7684\u5bb9\u5668\uff1a \u5728\u5bb9\u5668\u547d\u4ee4\u548c\u53c3\u6578\u5167 \u5bb9\u5668\u7684\u74b0\u5883\u8b8a\u91cf \u5728\u53ea\u8b80\u5377\u88e1\u9762\u6dfb\u52a0\u4e00\u500b\u6587\u4ef6\uff0c\u8b93\u61c9\u7528\u4f86\u8b80\u53d6 \u7de8\u5beb\u4ee3\u78bc\u5728 Pod \u4e2d\u904b\u884c\uff0c\u4f7f\u7528 Kubernetes API \u4f86\u8b80\u53d6 ConfigMap \u9019\u4e9b\u4e0d\u540c\u7684\u65b9\u6cd5\u9069\u7528\u65bc\u4e0d\u540c\u7684\u6578\u64da\u4f7f\u7528\u65b9\u5f0f\u3002\u5c0d\u524d\u4e09\u500b\u65b9\u6cd5\uff0ckubelet \u4f7f\u7528 ConfigMap \u4e2d\u7684\u6578\u64da\u5728 Pod \u4e2d\u555f\u52d5\u5bb9\u5668\u3002 \u7b2c\u56db\u7a2e\u65b9\u6cd5\u610f\u5473\u8457\u4f60\u5fc5\u9808\u7de8\u5beb\u4ee3\u78bc\u624d\u80fd\u8b80\u53d6 ConfigMap \u548c\u5b83\u7684\u6578\u64da\u3002\u7136\u800c\uff0c \u7531\u65bc\u4f60\u662f\u76f4\u63a5\u4f7f\u7528 Kubernetes API\uff0c\u56e0\u6b64\u53ea\u8981 ConfigMap \u767c\u751f\u66f4\u6539\uff0c \u4f60\u7684\u61c9\u7528\u5c31\u80fd\u5920\u901a\u904e\u8a02\u95b1\u4f86\u7372\u53d6\u66f4\u65b0\uff0c\u4e26\u4e14\u5728\u9019\u6a23\u7684\u60c5\u6cc1\u767c\u751f\u7684\u6642\u5019\u505a\u51fa\u53cd\u61c9\u3002\u901a\u904e\u76f4\u63a5\u9032\u5165 Kubernetes API\uff0c\u9019\u500b\u6280\u8853\u4e5f\u53ef\u4ee5\u8b93\u4f60\u80fd\u5920\u7372\u53d6\u5230\u4e0d\u540c\u7684\u540d\u5b57\u7a7a\u9593\u88e1\u7684 ConfigMap\u3002 \u4e0b\u9762\u662f\u4e00\u500b Pod \u7684\u793a\u4f8b\uff0c\u5b83\u901a\u904e\u4f7f\u7528 game-demo \u4e2d\u7684\u503c\u4f86\u914d\u7f6e\u4e00\u500b Pod\uff1a apiVersion : v1 kind : Pod metadata : name : configmap-demo-pod spec : containers : - name : demo image : alpine command : [ \"sleep\" , \"3600\" ] env : # \u5b9a\u7fa9\u74b0\u5883\u8b8a\u91cf - name : PLAYER_INITIAL_LIVES # \u8acb\u6ce8\u610f\u9019\u91cc\u548c ConfigMap \u4e2d\u7684\u9375\u540d\u662f\u4e0d\u4e00\u6a23\u7684 valueFrom : configMapKeyRef : name : game-demo # \u9019\u500b\u503c\u4f86\u81ea ConfigMap key : player_initial_lives # \u9700\u8981\u53d6\u503c\u7684\u952e - name : UI_PROPERTIES_FILE_NAME valueFrom : configMapKeyRef : name : game-demo key : ui_properties_file_name volumeMounts : - name : config mountPath : \"/config\" readOnly : true volumes : # \u4f60\u53ef\u4ee5\u5728 Pod \u7d1a\u5225\u8a2d\u7f6e\u5377\uff0c\u7136\u5f8c\u5c07\u5176\u639b\u8f09\u5230 Pod \u5167\u7684\u5bb9\u5668\u4e2d - name : config configMap : # \u63d0\u4f9b\u4f60\u60f3\u8981\u639b\u8f09\u7684 ConfigMap \u7684\u540d\u5b57 name : game-demo # \u4f86\u81ea ConfigMap \u7684\u4e00\u7d44\u9375\uff0c\u5c07\u88ab\u5275\u5efa\u70ba\u6587\u4ef6 items : - key : \"game.properties\" path : \"game.properties\" - key : \"user-interface.properties\" path : \"user-interface.properties\" ConfigMap \u4e0d\u6703\u5340\u5206\u55ae\u884c\u5c6c\u6027\u503c\u548c\u591a\u884c\u985e\u4f3c\u6587\u4ef6\u7684\u503c\uff0c\u91cd\u8981\u7684\u662f Pods \u548c\u5176\u4ed6\u5c0d\u50cf\u5982\u4f55\u4f7f\u7528\u9019\u4e9b\u503c\u3002 \u4e0a\u9762\u7684\u4f8b\u5b50\u5b9a\u7fa9\u4e86\u4e00\u500b\u5377\u4e26\u5c07\u5b83\u4f5c\u70ba /config \u6587\u4ef6\u593e\u639b\u8f09\u5230 demo \u5bb9\u5668\u5167\uff0c \u5275\u5efa\u5169\u500b\u6587\u4ef6\uff0c /config/game.properties \u548c /config/user-interface.properties \uff0c \u5118\u7ba1 ConfigMap \u4e2d\u5305\u542b\u4e86\u56db\u500b\u9375\u3002\u9019\u662f\u56e0\u70ba Pod \u5b9a\u7fa9\u4e2d\u5728 volumes \u7bc0\u6307\u5b9a\u4e86\u4e00\u500b items \u6578\u7d44\u3002\u5982\u679c\u4f60\u5b8c\u5168\u5ffd\u7565 items \u6578\u7d44\uff0c\u5247 ConfigMap \u4e2d\u7684\u6bcf\u500b\u9375\u90fd\u6703\u8b8a\u6210\u4e00\u500b\u8207\u8a72\u9375\u540c\u540d\u7684\u6587\u4ef6\uff0c \u56e0\u6b64\u4f60\u6703\u5f97\u5230\u56db\u500b\u6587\u4ef6\u3002","title":"ConfigMaps \u548c Pods"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#configmap_2","text":"ConfigMap \u53ef\u4ee5\u4f5c\u70ba\u6578\u64da\u5377\u639b\u8f09\u3002 ConfigMap \u4e5f\u53ef\u88ab\u7cfb\u7d71\u7684\u5176\u4ed6\u7d44\u4ef6\u4f7f\u7528\uff0c \u800c\u4e0d\u4e00\u5b9a\u76f4\u63a5\u66b4\u9732\u7d66 Pod\u3002\u4f8b\u5982\uff0cConfigMap \u53ef\u4ee5\u4fdd\u5b58\u7cfb\u7d71\u4e2d\u5176\u4ed6\u7d44\u4ef6\u8981\u4f7f\u7528\u7684\u914d\u7f6e\u6578\u64da\u3002 ConfigMap \u6700\u5e38\u898b\u7684\u7528\u6cd5\u662f\u70ba\u540c\u4e00\u547d\u540d\u7a7a\u9593\u88e1\u67d0 Pod \u4e2d\u904b\u884c\u7684\u5bb9\u5668\u57f7\u884c\u914d\u7f6e\u3002\u4f60\u4e5f\u53ef\u4ee5\u55ae\u7368\u4f7f\u7528 ConfigMap\u3002 \u6bd4\u5982\uff0c\u4f60\u53ef\u80fd\u6703\u9047\u5230\u57fa\u65bc ConfigMap \u4f86\u8abf\u6574\u5176\u884c\u70ba\u7684 \u63d2\u4ef6 \u6216\u8005 operator\u3002","title":"\u4f7f\u7528 ConfigMap"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#pod-configmap","text":"\u8981\u5728\u4e00\u500b Pod \u7684\u5b58\u5132\u5377\u4e2d\u4f7f\u7528 ConfigMap: \u5275\u5efa\u4e00\u500b ConfigMap \u5c0d\u50cf\u6216\u8005\u4f7f\u7528\u73fe\u6709\u7684 ConfigMap \u5c0d\u8c61\u3002\u591a\u500b Pod \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u500b ConfigMap\u3002 \u4fee\u6539 Pod \u5b9a\u7fa9\uff0c\u5728 spec.volumes[] \u4e0b\u6dfb\u52a0\u4e00\u500b\u5377\u3002\u70ba\u8a72\u5377\u8a2d\u7f6e\u4efb\u610f\u540d\u7a31\uff0c\u4e4b\u5f8c\u5c07 spec.volumes[].configMap.name \u5b57\u6bb5\u8a2d\u7f6e\u70ba\u5c0d\u4f60\u7684 ConfigMap \u5c0d\u8c61\u7684\u5f15\u7528\u3002 \u70ba\u6bcf\u500b\u9700\u8981\u8a72 ConfigMap \u7684\u5bb9\u5668\u6dfb\u52a0\u4e00\u500b .spec.containers[].volumeMounts[] \u3002\u8a2d\u7f6e .spec.containers[].volumeMounts[].readOnly=true \u4e26\u5c07 .spec.containers[].volumeMounts[].mountPath \u8a2d\u7f6e\u70ba\u4e00\u500b\u672a\u4f7f\u7528\u7684\u76ee\u9304\u540d\uff0c ConfigMap \u7684\u5167\u5bb9\u5c07\u51fa\u73fe\u5728\u8a72\u76ee\u9304\u4e2d\u3002 \u66f4\u6539\u4f60\u7684\u93e1\u50cf\u6216\u8005\u547d\u4ee4\u884c\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u80fd\u5920\u5f9e\u8a72\u76ee\u9304\u4e2d\u67e5\u627e\u6587\u4ef6\u3002 ConfigMap \u4e2d\u7684\u6bcf\u500b data \u9375\u6703\u8b8a\u6210 mountPath \u4e0b\u9762\u7684\u4e00\u500b\u6587\u4ef6\u540d\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u5c07 ConfigMap \u4ee5\u5377\u7684\u5f62\u5f0f\u9032\u884c\u639b\u8f09\u7684 Pod \u793a\u4f8b\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" readOnly : true volumes : - name : foo configMap : name : myconfigmap \u4f60\u5e0c\u671b\u4f7f\u7528\u7684\u6bcf\u500b ConfigMap \u90fd\u9700\u8981\u5728 spec.volumes \u4e2d\u88ab\u5f15\u7528\u5230\u3002 \u5982\u679c Pod \u4e2d\u6709\u591a\u500b\u5bb9\u5668\uff0c\u5247\u6bcf\u500b\u5bb9\u5668\u90fd\u9700\u8981\u81ea\u5df1\u7684 volumeMounts \u584a\uff0c\u4f46\u91dd\u5c0d\u6bcf\u500b ConfigMap\uff0c\u4f60\u53ea\u9700\u8981\u8a2d\u7f6e\u4e00\u500b spec.volumes \u584a\u3002","title":"\u5728 Pod \u4e2d\u5c07 ConfigMap \u7576\u505a\u6587\u4ef6\u4f7f\u7528"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#configmap_3","text":"\u7576\u5377\u4e2d\u4f7f\u7528\u7684 ConfigMap \u88ab\u66f4\u65b0\u6642\uff0c\u6240\u6295\u5c04\u7684\u9375\u6700\u7d42\u4e5f\u6703\u88ab\u66f4\u65b0\u3002 kubelet \u7d44\u4ef6\u6703\u5728\u6bcf\u6b21\u9031\u671f\u6027\u540c\u6b65\u6642\u6aa2\u67e5\u6240\u639b\u8f09\u7684 ConfigMap \u662f\u5426\u70ba\u6700\u65b0\u3002\u4e0d\u904e\uff0ckubelet \u4f7f\u7528\u7684\u662f\u5176\u672c\u5730\u7684\u9ad8\u901f\u7de9\u5b58\u4f86\u7372\u5f97 ConfigMap \u7684\u7576\u524d\u503c\u3002\u9ad8\u901f\u7de9\u5b58\u7684\u985e\u578b\u53ef\u4ee5\u901a\u904e KubeletConfiguration \u7d50\u69cb. \u7684 ConfigMapAndSecretChangeDetectionStrategy \u5b57\u6bb5\u4f86\u914d\u7f6e\u3002 ConfigMap \u65e2\u53ef\u4ee5\u901a\u904e watch \u64cd\u4f5c\u5be6\u73fe\u5167\u5bb9\u50b3\u64ad\uff08\u9ed8\u8a8d\u5f62\u5f0f\uff09\uff0c\u4e5f\u53ef\u5be6\u73fe\u57fa\u65bc TTL \u7684\u7de9\u5b58\uff0c\u9084\u53ef\u4ee5\u76f4\u63a5\u7d93\u904e\u6240\u6709\u8acb\u6c42\u91cd\u5b9a\u5411\u5230 API \u670d\u52d9\u5668\u3002\u56e0\u6b64\uff0c\u5f9e ConfigMap \u88ab\u66f4\u65b0\u7684\u90a3\u4e00\u523b\u7b97\u8d77\uff0c\u5230\u65b0\u7684\u4e3b\u9375\u88ab\u6295\u5c04\u5230 Pod \u4e2d\u53bb\uff0c \u9019\u4e00\u6642\u9593\u8de8\u5ea6\u53ef\u80fd\u8207 kubelet \u7684\u540c\u6b65\u9031\u671f\u52a0\u4e0a\u9ad8\u901f\u7de9\u5b58\u7684\u50b3\u64ad\u5ef6\u9072\u76f8\u7b49\u3002\u9019\u88e1\u7684\u50b3\u64ad\u5ef6\u9072\u53d6\u6c7a\u65bc\u6240\u9078\u7684\u9ad8\u901f\u7de9\u5b58\u985e\u578b \uff08\u5206\u5225\u5c0d\u61c9 watch \u64cd\u4f5c\u7684\u50b3\u64ad\u5ef6\u9072\u3001\u9ad8\u901f\u7de9\u5b58\u7684 TTL \u6642\u9577\u6216\u8005 0\uff09\u3002 \u4ee5\u74b0\u5883\u8b8a\u91cf\u65b9\u5f0f\u4f7f\u7528\u7684 ConfigMap \u6578\u64da\u4e0d\u6703\u88ab\u81ea\u52d5\u66f4\u65b0\u3002\u66f4\u65b0\u9019\u4e9b\u6578\u64da\u9700\u8981\u91cd\u65b0\u555f\u52d5 Pod\u3002 Info \u8aaa\u660e\uff1a \u4f7f\u7528 ConfigMap \u4f5c\u70ba subPath \u5377\u639b\u8f09\u7684\u5bb9\u5668\u5c07\u4e0d\u6703\u6536\u5230 ConfigMap \u7684\u66f4\u65b0\u3002","title":"\u88ab\u639b\u8f09\u7684 ConfigMap \u5167\u5bb9\u6703\u88ab\u81ea\u52d5\u66f4\u65b0"},{"location":"kubernetes/02-concepts/07-configuration/configmap/#configmap_4","text":"Kubernetes \u7279\u6027 Immutable Secret \u548c ConfigMaps \u63d0\u4f9b\u4e86\u4e00\u7a2e\u5c07\u5404\u500b Secret \u548c ConfigMap \u8a2d\u7f6e\u70ba\u4e0d\u53ef\u8b8a\u66f4\u7684\u9078\u9805\u3002\u5c0d\u65bc\u5927\u91cf\u4f7f\u7528 ConfigMap \u7684\u96c6\u7fa4 \uff08\u81f3\u5c11\u6709\u6578\u4e07\u500b\u5404\u4e0d\u76f8\u540c\u7684 ConfigMap \u7d66 Pod \u639b\u8f09\uff09\u800c\u8a00\uff0c\u7981\u6b62\u66f4\u6539 ConfigMap \u7684\u6578\u64da\u6709\u4ee5\u4e0b\u597d\u8655\uff1a \u4fdd\u8b77\u61c9\u7528\uff0c\u4f7f\u4e4b\u514d\u53d7\u610f\u5916\uff08\u4e0d\u60f3\u8981\u7684\uff09\u66f4\u65b0\u6240\u5e36\u4f86\u7684\u8ca0\u9762\u5f71\u97ff\u3002 \u901a\u904e\u5927\u5e45\u964d\u4f4e\u5c0d kube-apiserver \u7684\u58d3\u529b\u63d0\u5347\u96c6\u7fa4\u6027\u80fd\uff0c \u9019\u662f\u56e0\u70ba\u7cfb\u7d71\u6703\u95dc\u9589\u5c0d\u5df2\u6a19\u8a18\u70ba\u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap \u7684\u76e3\u8996\u64cd\u4f5c\u3002 \u6b64\u529f\u80fd\u7279\u6027\u7531 ImmutableEphemeralVolumes \u7279\u6027\u9580\u63a7 \u4f86\u63a7\u5236\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u5c07 immutable \u5b57\u6bb5\u8a2d\u7f6e\u70ba true \u5275\u5efa\u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap\u3002\u4f8b\u5982\uff1a apiVersion : v1 kind : ConfigMap metadata : ... data : ... immutable : true \u4e00\u65e6\u67d0 ConfigMap \u88ab\u6a19\u8a18\u70ba\u4e0d\u53ef\u8b8a\u66f4\uff0c\u5247 \u7121\u6cd5 \u9006\u8f49\u9019\u4e00\u8b8a\u5316\uff0c\uff0c\u4e5f\u7121\u6cd5\u66f4\u6539 data \u6216 binaryData \u5b57\u6bb5\u7684\u5167\u5bb9\u3002\u4f60\u53ea\u80fd\u522a\u9664\u4e26\u91cd\u5efa ConfigMap\u3002\u56e0\u70ba\u73fe\u6709\u7684 Pod \u6703\u7dad\u8b77\u4e00\u500b\u5df2\u88ab\u522a\u9664\u7684 ConfigMap \u7684\u639b\u8f09\u9ede\uff0c\u5efa\u8b70\u91cd\u65b0\u5275\u5efa\u9019\u4e9b Pods\u3002","title":"\u4e0d\u53ef\u8b8a\u66f4\u7684 ConfigMap"},{"location":"kubernetes/02-concepts/07-configuration/overview/","text":"\u914d\u7f6e\u6700\u4f73\u5be6\u8e10 \u00b6 \u672c\u6587\u6a94\u91cd\u9ede\u4ecb\u7d39\u4e26\u6574\u5408\u4e86\u6574\u500b Kubernetes \u7528\u6236\u6307\u5357\u3001\u5165\u9580\u6587\u6a94\u548c\u793a\u4f8b\u4e2d\u4ecb\u7d39\u7684\u914d\u7f6e\u6700\u4f73\u5be6\u8e10\u3002 \u4e00\u822c\u914d\u7f6e\u63d0\u793a \u00b6 \u5b9a\u7fa9\u914d\u7f6e\u6642\uff0c\u8acb\u6307\u5b9a\u6700\u65b0\u7684\u7a69\u5b9a API \u7248\u672c\u3002 \u5728\u63a8\u9001\u5230\u96c6\u7fa4\u4e4b\u524d\uff0c\u914d\u7f6e\u6587\u4ef6\u61c9\u5b58\u5132\u5728\u7248\u672c\u63a7\u5236\u4e2d\u3002\u9019\u5141\u8a31\u4f60\u5728\u5fc5\u8981\u6642\u5feb\u901f\u56de\u6efe\u914d\u7f6e\u66f4\u6539\u3002\u5b83\u9084\u6709\u52a9\u65bc\u96c6\u7fa4\u91cd\u65b0\u5275\u5efa\u548c\u6062\u5fa9\u3002 \u4f7f\u7528 YAML \u800c\u4e0d\u662f JSON \u7de8\u5beb\u914d\u7f6e\u6587\u4ef6\u3002\u96d6\u7136\u9019\u4e9b\u683c\u5f0f\u5e7e\u4e4e\u53ef\u4ee5\u5728\u6240\u6709\u5834\u666f\u4e2d\u4e92\u63db\u4f7f\u7528\uff0c\u4f46 YAML \u5f80\u5f80\u66f4\u52a0\u7528\u6236\u53cb\u597d\u3002 \u53ea\u8981\u6709\u610f\u7fa9\uff0c\u5c31\u5c07\u76f8\u95dc\u5c0d\u8c61\u5206\u7d44\u5230\u4e00\u500b\u6587\u4ef6\u4e2d\u3002\u4e00\u500b\u6587\u4ef6\u901a\u5e38\u6bd4\u5e7e\u500b\u6587\u4ef6\u66f4\u5bb9\u6613\u7ba1\u7406\u3002\u8acb\u53c3\u95b1 guestbook-all-in-one.yaml \u6587\u4ef6\u4f5c\u70ba\u6b64\u8a9e\u6cd5\u7684\u793a\u4f8b\u3002 \u53e6\u8acb\u6ce8\u610f\uff0c\u53ef\u4ee5\u5728\u76ee\u9304\u4e0a\u8abf\u7528\u8a31\u591a kubectl \u547d\u4ee4\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u7684\u76ee\u9304\u4e2d\u8abf\u7528 kubectl apply\u3002 \u9664\u975e\u5fc5\u8981\uff0c\u5426\u5247\u4e0d\u6307\u5b9a\u9ed8\u8a8d\u503c\uff1a\u7c21\u55ae\u7684\u6700\u5c0f\u914d\u7f6e\u6703\u964d\u4f4e\u932f\u8aa4\u7684\u53ef\u80fd\u6027\u3002 \u5c07\u5c0d\u8c61\u63cf\u8ff0\u653e\u5728\u8a3b\u91cb\u4e2d\uff0c\u4ee5\u4fbf\u66f4\u597d\u5730\u9032\u884c\u5167\u7701(introspection)\u3002 \u201cNaked\u201d Pods \u4e0e ReplicaSet\uff0cDeployment \u548c Jobs \u00b6 \u5982\u679c\u53ef\u80fd\uff0c\u4e0d\u8981\u4f7f\u7528\u7368\u7acb\u7684 Pods\uff08\u5373\uff0c\u672a\u7d81\u5b9a\u5230 ReplicaSet \u6216 Deployment \u7684 Pod\uff09\u3002\u5982\u679c\u7bc0\u9ede\u767c\u751f\u6545\u969c\uff0c\u5c07\u4e0d\u6703\u91cd\u65b0\u8abf\u5ea6\u7368\u7acb\u7684 Pods\u3002 Deployment \u65e2\u53ef\u4ee5\u5275\u5efa\u4e00\u500b ReplicaSet \u4f86\u78ba\u4fdd\u9810\u671f\u500b\u6578\u7684 Pod \u59cb\u7d42\u53ef\u7528\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u66ff\u63db Pod \u7684\u7b56\u7565\uff08\u4f8b\u5982 RollingUpdate\uff09\u3002\u9664\u4e86\u4e00\u4e9b\u986f\u5f0f\u7684 restartPolicy: Never \u5834\u666f\u5916\uff0cDeployment \u901a\u5e38\u6bd4\u76f4\u63a5\u5275\u5efa Pod \u8981\u597d\u5f97\u591a\u3002 Job \u4e5f\u53ef\u80fd\u662f\u5408\u9069\u7684\u9078\u64c7\u3002 \u670d\u52d9 \u00b6 \u5728\u5275\u5efa\u76f8\u61c9\u7684\u5f8c\u7aef\u5de5\u4f5c\u8ca0\u8f09\uff08Deployment \u6216 ReplicaSet\uff09\uff0c\u4ee5\u53ca\u5728\u9700\u8981\u8a2a\u554f\u5b83\u7684\u4efb\u4f55\u5de5\u4f5c\u8ca0\u8f09\u4e4b\u524d\u5275\u5efa \u670d\u52d9 \u3002\u7576 Kubernetes \u555f\u52d5\u5bb9\u5668\u6642\uff0c\u5b83\u63d0\u4f9b\u6307\u5411\u555f\u52d5\u5bb9\u5668\u6642\u6b63\u5728\u904b\u884c\u7684\u6240\u6709\u670d\u52d9\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u4f8b\u5982\uff0c\u5982\u679c\u5b58\u5728\u540d\u70ba foo \u7684\u670d\u52d9\uff0c\u5247\u6240\u6709\u5bb9\u5668\u5c07\u5728\u5176\u521d\u59cb\u74b0\u5883\u4e2d\u7372\u5f97\u4ee5\u4e0b\u8b8a\u91cf\u3002 FOO_SERVICE_HOST = <the host the Service is running on> FOO_SERVICE_PORT = <the port the Service is running on> \u9019\u78ba\u5be6\u610f\u5473\u8457\u5728\u9806\u5e8f\u4e0a\u7684\u8981\u6c42 - \u5fc5\u9808\u5728 Pod \u672c\u8eab\u88ab\u5275\u5efa\u4e4b\u524d\u5275\u5efa Pod \u60f3\u8981\u8a2a\u554f\u7684\u4efb\u4f55 Service\uff0c \u5426\u5247\u5c07\u74b0\u5883\u8b8a\u91cf\u4e0d\u6703\u751f\u6548\u3002 DNS \u6c92\u6709\u6b64\u9650\u5236\u3002 \u4e00\u500b\u975e\u5fc5\u8981\uff08\u5118\u7ba1\u5f37\u70c8\u63a8\u85a6\uff09\u7684 \u96c6\u7fa4\u63d2\u4ef6 \u662f DNS \u670d\u52d9\u5668\u3002 DNS \u670d\u52d9\u5668\u70ba\u65b0\u7684 Services \u76e3\u8996 Kubernetes API\uff0c\u4e26\u70ba\u6bcf\u500b\u5275\u5efa\u4e00\u7d44 DNS \u8a18\u9304\u3002\u5982\u679c\u5728\u6574\u500b\u96c6\u7fa4\u4e2d\u555f\u7528\u4e86 DNS\uff0c\u5247\u6240\u6709 Pods \u61c9\u8a72\u80fd\u5920\u81ea\u52d5\u5c0d Services \u9032\u884c\u540d\u7a31\u89e3\u6790\u3002 \u9664\u975e\u7d55\u5c0d\u5fc5\u8981\uff0c\u5426\u5247\u4e0d\u8981\u70ba Pod \u6307\u5b9a hostPort\u3002\u5c07 Pod \u7d81\u5b9a\u5230 hostPort \u6642\uff0c\u5b83\u6703\u9650\u5236 Pod \u53ef\u4ee5\u8abf\u5ea6\u7684\u4f4d\u7f6e\u6578\uff0c\u56e0\u70ba\u6bcf\u500b \u7d44\u5408\u5fc5\u9808\u662f\u552f\u4e00\u7684\u3002\u5982\u679c\u4f60\u6c92\u6709\u660e\u78ba\u6307\u5b9a hostIP \u548c protocol\uff0cKubernetes \u5c07\u4f7f\u7528 0.0.0.0 \u4f5c\u70ba\u9ed8\u8a8d hostIP \u548c TCP \u4f5c\u70ba\u9ed8\u8a8d protocol\u3002 \u5982\u679c\u4f60\u53ea\u9700\u8981\u8a2a\u554f\u7aef\u53e3\u4ee5\u9032\u884c\u8abf\u8a66\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 apiserver proxy \u6216 kubectl port-forward \u3002 \u5982\u679c\u4f60\u660e\u78ba\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u516c\u958b Pod \u7684\u7aef\u53e3\uff0c\u8acb\u5728\u4f7f\u7528 hostPort \u4e4b\u524d\u8003\u616e\u4f7f\u7528 NodePort \u670d\u52d9\u3002 \u4f7f\u7528\u6a19\u7c64 \u00b6 \u5b9a\u7fa9\u4e26\u4f7f\u7528\u6a19\u7c64\u4f86\u8b58\u5225\u61c9\u7528\u7a0b\u5e8f \u6216 Deployment \u7684 \u8a9e\u7fa9\u5c6c\u6027 \uff0c\u4f8b\u5982 { app.kubernetes.io/name: MyApp, tier: frontend, phase: test, deployment: v3 } \u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u6a19\u7c64\u70ba\u5176\u4ed6\u8cc7\u6e90\u9078\u64c7\u5408\u9069\u7684 Pod\uff1b \u4f8b\u5982\uff0c\u4e00\u500b\u9078\u64c7\u6240\u6709 tier: frontend Pod \u7684\u670d\u52d9\uff0c\u6216\u8005 app.kubernetes.io/name: MyApp \u7684\u6240\u6709 phase: test \u7d44\u4ef6\u3002\u6709\u95dc\u6b64\u65b9\u6cd5\u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 guestbook \u3002 \u901a\u904e\u5f9e\u9078\u64c7\u5668\u4e2d\u7701\u7565\u7279\u5b9a\u767c\u884c\u7248\u7684\u6a19\u7c64\uff0c\u53ef\u4ee5\u4f7f\u670d\u52d9\u8de8\u8d8a\u591a\u500b Deployment\u3002\u7576\u4f60\u9700\u8981\u4e0d\u505c\u6a5f\u7684\u60c5\u6cc1\u4e0b\u66f4\u65b0\u6b63\u5728\u904b\u884c\u7684\u670d\u52d9\uff0c\u53ef\u4ee5\u4f7f\u7528Deployment\u3002 Deployment \u63cf\u8ff0\u4e86\u5c0d\u8c61\u7684\u671f\u671b\u72c0\u614b\uff0c\u4e26\u4e14\u5982\u679c\u5c0d\u8a72\u898f\u7bc4\u7684\u66f4\u6539\u88ab\u6210\u529f\u61c9\u7528\uff0c \u5247 Deployment \u63a7\u5236\u5668\u4ee5\u53d7\u63a7\u901f\u7387\u5c07\u5be6\u969b\u72c0\u614b\u6539\u8b8a\u70ba\u671f\u671b\u72c0\u614b\u3002 \u5c0d\u65bc\u5e38\u898b\u5834\u666f\uff0c\u61c9\u4f7f\u7528 [Kubernetes \u901a\u7528 \u6a19\u7c64 \u3002\u9019\u4e9b\u6a19\u6e96\u5316\u7684\u6a19\u7c64\u8c50\u5bcc\u4e86\u5c0d\u8c61\u7684\u5143\u6578\u64da\uff0c\u4f7f\u5f97\u5305\u62ec kubectl \u548c \u5100\u8868\u677f\uff08Dashboard\uff09 \u9019\u4e9b\u5de5\u5177\u80fd\u5920\u4ee5\u53ef\u4e92\u64cd\u4f5c\u7684\u65b9\u5f0f\u5de5\u4f5c\u3002 \u4f60\u53ef\u4ee5\u64cd\u7e31\u6a19\u7c64\u9032\u884c\u8abf\u8a66\u3002\u7531\u65bc Kubernetes \u63a7\u5236\u5668\uff08\u4f8b\u5982 ReplicaSet\uff09\u548c\u670d\u52d9\u4f7f\u7528\u9078\u64c7\u5668\u6a19\u7c64\u4f86\u5339\u914d Pod\uff0c \u5f9e Pod \u4e2d\u522a\u9664\u76f8\u95dc\u6a19\u7c64\u5c07\u963b\u6b62\u5176\u88ab\u63a7\u5236\u5668\u8003\u616e\u6216\u7531\u670d\u52d9\u63d0\u4f9b\u670d\u52d9\u6d41\u91cf\u3002\u5982\u679c\u522a\u9664\u73fe\u6709 Pod \u7684\u6a19\u7c64\uff0c\u5176\u63a7\u5236\u5668\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684 Pod \u4f86\u53d6\u4ee3\u5b83\u3002\u9019\u662f\u5728\"\u9694\u96e2\"\u74b0\u5883\u4e2d\u8abf\u8a66\u5148\u524d\"\u6d3b\u8e8d\"\u7684 Pod \u7684\u6709\u7528\u65b9\u6cd5\u3002\u8981\u4ee5\u4ea4\u4e92\u65b9\u5f0f\u522a\u9664\u6216\u6dfb\u52a0\u6a19\u7c64\uff0c\u8acb\u4f7f\u7528 kubectl label \u3002 \u4f7f\u7528 kubectl \u00b6 \u4f7f\u7528 kubectl apply -f <directory> \u3002\u5b83\u5728 <directory> \u4e2d\u7684\u6240\u6709 .yaml\u3001.yml \u548c .json \u6587\u4ef6\u4e2d\u67e5\u627e Kubernetes \u914d\u7f6e\uff0c\u4e26\u5c07\u5176\u50b3\u905e\u7d66 apply \u3002 \u4f7f\u7528\u6a19\u7c64\u9078\u64c7\u5668\u9032\u884c get \u548c delete \u64cd\u4f5c\uff0c\u800c\u4e0d\u662f\u7279\u5b9a\u7684\u5c0d\u8c61\u540d\u7a31\u3002 \u8acb\u53c3\u95b1 \u6a19\u7c64\u9078\u64c7\u5668 \u548c \u6709\u6548\u4f7f\u7528\u6a19\u7c64 \u90e8\u5206\u3002 \u4f7f\u7528 kubectl run \u548c kubectl expose \u4f86\u5feb\u901f\u5275\u5efa\u55ae\u5bb9\u5668\u90e8\u7f72\u548c\u670d\u52d9\u3002\u6709\u95dc\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 \u4f7f\u7528\u670d\u52d9\u8a2a\u554f\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f \u3002","title":"\u914d\u7f6e\u6700\u4f73\u5be6\u8e10"},{"location":"kubernetes/02-concepts/07-configuration/overview/#_1","text":"\u672c\u6587\u6a94\u91cd\u9ede\u4ecb\u7d39\u4e26\u6574\u5408\u4e86\u6574\u500b Kubernetes \u7528\u6236\u6307\u5357\u3001\u5165\u9580\u6587\u6a94\u548c\u793a\u4f8b\u4e2d\u4ecb\u7d39\u7684\u914d\u7f6e\u6700\u4f73\u5be6\u8e10\u3002","title":"\u914d\u7f6e\u6700\u4f73\u5be6\u8e10"},{"location":"kubernetes/02-concepts/07-configuration/overview/#_2","text":"\u5b9a\u7fa9\u914d\u7f6e\u6642\uff0c\u8acb\u6307\u5b9a\u6700\u65b0\u7684\u7a69\u5b9a API \u7248\u672c\u3002 \u5728\u63a8\u9001\u5230\u96c6\u7fa4\u4e4b\u524d\uff0c\u914d\u7f6e\u6587\u4ef6\u61c9\u5b58\u5132\u5728\u7248\u672c\u63a7\u5236\u4e2d\u3002\u9019\u5141\u8a31\u4f60\u5728\u5fc5\u8981\u6642\u5feb\u901f\u56de\u6efe\u914d\u7f6e\u66f4\u6539\u3002\u5b83\u9084\u6709\u52a9\u65bc\u96c6\u7fa4\u91cd\u65b0\u5275\u5efa\u548c\u6062\u5fa9\u3002 \u4f7f\u7528 YAML \u800c\u4e0d\u662f JSON \u7de8\u5beb\u914d\u7f6e\u6587\u4ef6\u3002\u96d6\u7136\u9019\u4e9b\u683c\u5f0f\u5e7e\u4e4e\u53ef\u4ee5\u5728\u6240\u6709\u5834\u666f\u4e2d\u4e92\u63db\u4f7f\u7528\uff0c\u4f46 YAML \u5f80\u5f80\u66f4\u52a0\u7528\u6236\u53cb\u597d\u3002 \u53ea\u8981\u6709\u610f\u7fa9\uff0c\u5c31\u5c07\u76f8\u95dc\u5c0d\u8c61\u5206\u7d44\u5230\u4e00\u500b\u6587\u4ef6\u4e2d\u3002\u4e00\u500b\u6587\u4ef6\u901a\u5e38\u6bd4\u5e7e\u500b\u6587\u4ef6\u66f4\u5bb9\u6613\u7ba1\u7406\u3002\u8acb\u53c3\u95b1 guestbook-all-in-one.yaml \u6587\u4ef6\u4f5c\u70ba\u6b64\u8a9e\u6cd5\u7684\u793a\u4f8b\u3002 \u53e6\u8acb\u6ce8\u610f\uff0c\u53ef\u4ee5\u5728\u76ee\u9304\u4e0a\u8abf\u7528\u8a31\u591a kubectl \u547d\u4ee4\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u5728\u914d\u7f6e\u6587\u4ef6\u7684\u76ee\u9304\u4e2d\u8abf\u7528 kubectl apply\u3002 \u9664\u975e\u5fc5\u8981\uff0c\u5426\u5247\u4e0d\u6307\u5b9a\u9ed8\u8a8d\u503c\uff1a\u7c21\u55ae\u7684\u6700\u5c0f\u914d\u7f6e\u6703\u964d\u4f4e\u932f\u8aa4\u7684\u53ef\u80fd\u6027\u3002 \u5c07\u5c0d\u8c61\u63cf\u8ff0\u653e\u5728\u8a3b\u91cb\u4e2d\uff0c\u4ee5\u4fbf\u66f4\u597d\u5730\u9032\u884c\u5167\u7701(introspection)\u3002","title":"\u4e00\u822c\u914d\u7f6e\u63d0\u793a"},{"location":"kubernetes/02-concepts/07-configuration/overview/#naked-pods-replicasetdeployment-jobs","text":"\u5982\u679c\u53ef\u80fd\uff0c\u4e0d\u8981\u4f7f\u7528\u7368\u7acb\u7684 Pods\uff08\u5373\uff0c\u672a\u7d81\u5b9a\u5230 ReplicaSet \u6216 Deployment \u7684 Pod\uff09\u3002\u5982\u679c\u7bc0\u9ede\u767c\u751f\u6545\u969c\uff0c\u5c07\u4e0d\u6703\u91cd\u65b0\u8abf\u5ea6\u7368\u7acb\u7684 Pods\u3002 Deployment \u65e2\u53ef\u4ee5\u5275\u5efa\u4e00\u500b ReplicaSet \u4f86\u78ba\u4fdd\u9810\u671f\u500b\u6578\u7684 Pod \u59cb\u7d42\u53ef\u7528\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u66ff\u63db Pod \u7684\u7b56\u7565\uff08\u4f8b\u5982 RollingUpdate\uff09\u3002\u9664\u4e86\u4e00\u4e9b\u986f\u5f0f\u7684 restartPolicy: Never \u5834\u666f\u5916\uff0cDeployment \u901a\u5e38\u6bd4\u76f4\u63a5\u5275\u5efa Pod \u8981\u597d\u5f97\u591a\u3002 Job \u4e5f\u53ef\u80fd\u662f\u5408\u9069\u7684\u9078\u64c7\u3002","title":"\u201cNaked\u201d Pods \u4e0e ReplicaSet\uff0cDeployment \u548c Jobs"},{"location":"kubernetes/02-concepts/07-configuration/overview/#_3","text":"\u5728\u5275\u5efa\u76f8\u61c9\u7684\u5f8c\u7aef\u5de5\u4f5c\u8ca0\u8f09\uff08Deployment \u6216 ReplicaSet\uff09\uff0c\u4ee5\u53ca\u5728\u9700\u8981\u8a2a\u554f\u5b83\u7684\u4efb\u4f55\u5de5\u4f5c\u8ca0\u8f09\u4e4b\u524d\u5275\u5efa \u670d\u52d9 \u3002\u7576 Kubernetes \u555f\u52d5\u5bb9\u5668\u6642\uff0c\u5b83\u63d0\u4f9b\u6307\u5411\u555f\u52d5\u5bb9\u5668\u6642\u6b63\u5728\u904b\u884c\u7684\u6240\u6709\u670d\u52d9\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u4f8b\u5982\uff0c\u5982\u679c\u5b58\u5728\u540d\u70ba foo \u7684\u670d\u52d9\uff0c\u5247\u6240\u6709\u5bb9\u5668\u5c07\u5728\u5176\u521d\u59cb\u74b0\u5883\u4e2d\u7372\u5f97\u4ee5\u4e0b\u8b8a\u91cf\u3002 FOO_SERVICE_HOST = <the host the Service is running on> FOO_SERVICE_PORT = <the port the Service is running on> \u9019\u78ba\u5be6\u610f\u5473\u8457\u5728\u9806\u5e8f\u4e0a\u7684\u8981\u6c42 - \u5fc5\u9808\u5728 Pod \u672c\u8eab\u88ab\u5275\u5efa\u4e4b\u524d\u5275\u5efa Pod \u60f3\u8981\u8a2a\u554f\u7684\u4efb\u4f55 Service\uff0c \u5426\u5247\u5c07\u74b0\u5883\u8b8a\u91cf\u4e0d\u6703\u751f\u6548\u3002 DNS \u6c92\u6709\u6b64\u9650\u5236\u3002 \u4e00\u500b\u975e\u5fc5\u8981\uff08\u5118\u7ba1\u5f37\u70c8\u63a8\u85a6\uff09\u7684 \u96c6\u7fa4\u63d2\u4ef6 \u662f DNS \u670d\u52d9\u5668\u3002 DNS \u670d\u52d9\u5668\u70ba\u65b0\u7684 Services \u76e3\u8996 Kubernetes API\uff0c\u4e26\u70ba\u6bcf\u500b\u5275\u5efa\u4e00\u7d44 DNS \u8a18\u9304\u3002\u5982\u679c\u5728\u6574\u500b\u96c6\u7fa4\u4e2d\u555f\u7528\u4e86 DNS\uff0c\u5247\u6240\u6709 Pods \u61c9\u8a72\u80fd\u5920\u81ea\u52d5\u5c0d Services \u9032\u884c\u540d\u7a31\u89e3\u6790\u3002 \u9664\u975e\u7d55\u5c0d\u5fc5\u8981\uff0c\u5426\u5247\u4e0d\u8981\u70ba Pod \u6307\u5b9a hostPort\u3002\u5c07 Pod \u7d81\u5b9a\u5230 hostPort \u6642\uff0c\u5b83\u6703\u9650\u5236 Pod \u53ef\u4ee5\u8abf\u5ea6\u7684\u4f4d\u7f6e\u6578\uff0c\u56e0\u70ba\u6bcf\u500b \u7d44\u5408\u5fc5\u9808\u662f\u552f\u4e00\u7684\u3002\u5982\u679c\u4f60\u6c92\u6709\u660e\u78ba\u6307\u5b9a hostIP \u548c protocol\uff0cKubernetes \u5c07\u4f7f\u7528 0.0.0.0 \u4f5c\u70ba\u9ed8\u8a8d hostIP \u548c TCP \u4f5c\u70ba\u9ed8\u8a8d protocol\u3002 \u5982\u679c\u4f60\u53ea\u9700\u8981\u8a2a\u554f\u7aef\u53e3\u4ee5\u9032\u884c\u8abf\u8a66\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528 apiserver proxy \u6216 kubectl port-forward \u3002 \u5982\u679c\u4f60\u660e\u78ba\u9700\u8981\u5728\u7bc0\u9ede\u4e0a\u516c\u958b Pod \u7684\u7aef\u53e3\uff0c\u8acb\u5728\u4f7f\u7528 hostPort \u4e4b\u524d\u8003\u616e\u4f7f\u7528 NodePort \u670d\u52d9\u3002","title":"\u670d\u52d9"},{"location":"kubernetes/02-concepts/07-configuration/overview/#_4","text":"\u5b9a\u7fa9\u4e26\u4f7f\u7528\u6a19\u7c64\u4f86\u8b58\u5225\u61c9\u7528\u7a0b\u5e8f \u6216 Deployment \u7684 \u8a9e\u7fa9\u5c6c\u6027 \uff0c\u4f8b\u5982 { app.kubernetes.io/name: MyApp, tier: frontend, phase: test, deployment: v3 } \u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u6a19\u7c64\u70ba\u5176\u4ed6\u8cc7\u6e90\u9078\u64c7\u5408\u9069\u7684 Pod\uff1b \u4f8b\u5982\uff0c\u4e00\u500b\u9078\u64c7\u6240\u6709 tier: frontend Pod \u7684\u670d\u52d9\uff0c\u6216\u8005 app.kubernetes.io/name: MyApp \u7684\u6240\u6709 phase: test \u7d44\u4ef6\u3002\u6709\u95dc\u6b64\u65b9\u6cd5\u7684\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 guestbook \u3002 \u901a\u904e\u5f9e\u9078\u64c7\u5668\u4e2d\u7701\u7565\u7279\u5b9a\u767c\u884c\u7248\u7684\u6a19\u7c64\uff0c\u53ef\u4ee5\u4f7f\u670d\u52d9\u8de8\u8d8a\u591a\u500b Deployment\u3002\u7576\u4f60\u9700\u8981\u4e0d\u505c\u6a5f\u7684\u60c5\u6cc1\u4e0b\u66f4\u65b0\u6b63\u5728\u904b\u884c\u7684\u670d\u52d9\uff0c\u53ef\u4ee5\u4f7f\u7528Deployment\u3002 Deployment \u63cf\u8ff0\u4e86\u5c0d\u8c61\u7684\u671f\u671b\u72c0\u614b\uff0c\u4e26\u4e14\u5982\u679c\u5c0d\u8a72\u898f\u7bc4\u7684\u66f4\u6539\u88ab\u6210\u529f\u61c9\u7528\uff0c \u5247 Deployment \u63a7\u5236\u5668\u4ee5\u53d7\u63a7\u901f\u7387\u5c07\u5be6\u969b\u72c0\u614b\u6539\u8b8a\u70ba\u671f\u671b\u72c0\u614b\u3002 \u5c0d\u65bc\u5e38\u898b\u5834\u666f\uff0c\u61c9\u4f7f\u7528 [Kubernetes \u901a\u7528 \u6a19\u7c64 \u3002\u9019\u4e9b\u6a19\u6e96\u5316\u7684\u6a19\u7c64\u8c50\u5bcc\u4e86\u5c0d\u8c61\u7684\u5143\u6578\u64da\uff0c\u4f7f\u5f97\u5305\u62ec kubectl \u548c \u5100\u8868\u677f\uff08Dashboard\uff09 \u9019\u4e9b\u5de5\u5177\u80fd\u5920\u4ee5\u53ef\u4e92\u64cd\u4f5c\u7684\u65b9\u5f0f\u5de5\u4f5c\u3002 \u4f60\u53ef\u4ee5\u64cd\u7e31\u6a19\u7c64\u9032\u884c\u8abf\u8a66\u3002\u7531\u65bc Kubernetes \u63a7\u5236\u5668\uff08\u4f8b\u5982 ReplicaSet\uff09\u548c\u670d\u52d9\u4f7f\u7528\u9078\u64c7\u5668\u6a19\u7c64\u4f86\u5339\u914d Pod\uff0c \u5f9e Pod \u4e2d\u522a\u9664\u76f8\u95dc\u6a19\u7c64\u5c07\u963b\u6b62\u5176\u88ab\u63a7\u5236\u5668\u8003\u616e\u6216\u7531\u670d\u52d9\u63d0\u4f9b\u670d\u52d9\u6d41\u91cf\u3002\u5982\u679c\u522a\u9664\u73fe\u6709 Pod \u7684\u6a19\u7c64\uff0c\u5176\u63a7\u5236\u5668\u5c07\u5275\u5efa\u4e00\u500b\u65b0\u7684 Pod \u4f86\u53d6\u4ee3\u5b83\u3002\u9019\u662f\u5728\"\u9694\u96e2\"\u74b0\u5883\u4e2d\u8abf\u8a66\u5148\u524d\"\u6d3b\u8e8d\"\u7684 Pod \u7684\u6709\u7528\u65b9\u6cd5\u3002\u8981\u4ee5\u4ea4\u4e92\u65b9\u5f0f\u522a\u9664\u6216\u6dfb\u52a0\u6a19\u7c64\uff0c\u8acb\u4f7f\u7528 kubectl label \u3002","title":"\u4f7f\u7528\u6a19\u7c64"},{"location":"kubernetes/02-concepts/07-configuration/overview/#kubectl","text":"\u4f7f\u7528 kubectl apply -f <directory> \u3002\u5b83\u5728 <directory> \u4e2d\u7684\u6240\u6709 .yaml\u3001.yml \u548c .json \u6587\u4ef6\u4e2d\u67e5\u627e Kubernetes \u914d\u7f6e\uff0c\u4e26\u5c07\u5176\u50b3\u905e\u7d66 apply \u3002 \u4f7f\u7528\u6a19\u7c64\u9078\u64c7\u5668\u9032\u884c get \u548c delete \u64cd\u4f5c\uff0c\u800c\u4e0d\u662f\u7279\u5b9a\u7684\u5c0d\u8c61\u540d\u7a31\u3002 \u8acb\u53c3\u95b1 \u6a19\u7c64\u9078\u64c7\u5668 \u548c \u6709\u6548\u4f7f\u7528\u6a19\u7c64 \u90e8\u5206\u3002 \u4f7f\u7528 kubectl run \u548c kubectl expose \u4f86\u5feb\u901f\u5275\u5efa\u55ae\u5bb9\u5668\u90e8\u7f72\u548c\u670d\u52d9\u3002\u6709\u95dc\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 \u4f7f\u7528\u670d\u52d9\u8a2a\u554f\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f \u3002","title":"\u4f7f\u7528 kubectl"},{"location":"kubernetes/02-concepts/07-configuration/secret/","text":"Secret \u00b6 Secret \u662f\u4e00\u7a2e\u5305\u542b\u5c11\u91cf\u654f\u611f\u4fe1\u606f\u4f8b\u5982\u5bc6\u78bc\u3001\u4ee4\u724c\u6216\u5bc6\u9470\u7684\u5c0d\u8c61\u3002\u9019\u6a23\u7684\u4fe1\u606f\u53ef\u80fd\u6703\u88ab\u653e\u5728 Pod \u898f\u7d04\u4e2d\u6216\u8005\u93e1\u50cf\u4e2d\u3002\u4f7f\u7528 Secret \u610f\u5473\u8457\u4f60\u4e0d\u9700\u8981\u5728\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u4e2d\u5305\u542b\u6a5f\u5bc6\u6578\u64da\u3002 \u7531\u65bc\u5275\u5efa Secret \u53ef\u4ee5\u7368\u7acb\u65bc\u4f7f\u7528\u5b83\u5011\u7684 Pod\uff0c \u56e0\u6b64\u5728\u5275\u5efa\u3001\u67e5\u770b\u548c\u7de8\u8f2f Pod \u7684\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u66b4\u9732 Secret\uff08\u53ca\u5176\u6578\u64da\uff09\u7684\u98a8\u96aa\u8f03\u5c0f\u3002 Kubernetes \u548c\u5728\u96c6\u7fa4\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u4e5f\u53ef\u4ee5\u5c0d Secret \u63a1\u53d6\u984d\u5916\u7684\u9810\u9632\u63aa\u65bd\uff0c \u4f8b\u5982\u907f\u514d\u5c07\u6a5f\u5bc6\u6578\u64da\u5beb\u5165\u975e\u6613\u5931\u6027\u5b58\u5132\u3002 Secret \u985e\u4f3c\u65bc ConfigMap \u4f46\u5c08\u9580\u7528\u65bc\u4fdd\u5b58\u6a5f\u5bc6\u6578\u64da\u3002 Warning \u6ce8\u610f\uff1a \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cKubernetes Secret \u672a\u52a0\u5bc6\u5730\u5b58\u5132\u5728 API \u670d\u52d9\u5668\u7684\u5e95\u5c64\u6578\u64da\u5b58\u5132\uff08etcd\uff09\u4e2d\u3002\u4efb\u4f55\u64c1\u6709 API \u8a2a\u554f\u6b0a\u9650\u7684\u4eba\u90fd\u53ef\u4ee5\u6aa2\u7d22\u6216\u4fee\u6539 Secret\uff0c\u4efb\u4f55\u6709\u6b0a\u8a2a\u554f etcd \u7684\u4eba\u4e5f\u53ef\u4ee5\u3002\u6b64\u5916\uff0c\u4efb\u4f55\u6709\u6b0a\u9650\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa Pod \u7684\u4eba\u90fd\u53ef\u4ee5\u4f7f\u7528\u8a72\u8a2a\u554f\u6b0a\u9650\u8b80\u53d6\u8a72\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u4efb\u4f55 Secret\uff1b \u9019\u5305\u62ec\u9593\u63a5\u8a2a\u554f\uff0c\u4f8b\u5982\u5275\u5efa Deployment \u7684\u80fd\u529b\u3002 \u70ba\u4e86\u5b89\u5168\u5730\u4f7f\u7528 Secret\uff0c\u8acb\u81f3\u5c11\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u70ba Secret \u555f\u7528\u975c\u614b\u52a0\u5bc6 \uff1b \u555f\u7528\u6216\u914d\u7f6e RBAC \u898f\u5247 \u4f86\u9650\u5236\u8b80\u53d6\u548c\u5beb\u5165 Secret \u7684\u6578\u64da\uff08\u5305\u62ec\u901a\u904e\u9593\u63a5\u65b9\u5f0f\uff09\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u88ab\u51c6\u8a31\u5275\u5efa Pod \u7684\u4eba\u4e5f\u96b1\u5f0f\u5730\u88ab\u6388\u6b0a\u7372\u53d6 Secret \u5167\u5bb9\u3002 \u5728\u9069\u7576\u7684\u60c5\u6cc1\u4e0b\uff0c\u9084\u53ef\u4ee5\u4f7f\u7528 RBAC \u7b49\u6a5f\u5236\u4f86\u9650\u5236\u5141\u8a31\u54ea\u4e9b\u4e3b\u9ad4\u5275\u5efa\u65b0 Secret \u6216\u66ff\u63db\u73fe\u6709 Secret\u3002 \u53c3\u898b Secret \u7684\u4fe1\u606f\u5b89\u5168 \u4e86\u89e3\u8a73\u60c5\u3002 Secret \u7684\u4f7f\u7528 \u00b6 Pod \u53ef\u4ee5\u7528\u4e09\u7a2e\u65b9\u5f0f\u4e4b\u4e00\u4f86\u4f7f\u7528 Secret\uff1a \u4f5c\u70ba\u639b\u8f09\u5230\u4e00\u500b\u6216\u591a\u500b\u5bb9\u5668\u4e0a\u7684\u6372 \u4e2d\u7684 \u6587\u4ef6 \u3002 \u4f5c\u70ba \u5bb9\u5668\u7684\u74b0\u5883\u8b8a\u91cf \u3002 \u7531 kubelet \u5728\u70ba Pod \u62c9\u53d6\u93e1\u50cf\u6642\u4f7f\u7528 \u3002 Kubernetes \u63a7\u5236\u9762\u4e5f\u4f7f\u7528 Secret\uff1b \u4f8b\u5982\uff0c \u5f15\u5c0e\u4ee4\u724c Secret \u662f\u4e00\u7a2e\u5e6b\u52a9\u81ea\u52d5\u5316\u7bc0\u9ede\u8a3b\u518a\u7684\u6a5f\u5236\u3002 Secret \u7684\u66ff\u4ee3\u65b9\u6848 \u00b6 \u9664\u4e86\u4f7f\u7528 Secret \u4f86\u4fdd\u8b77\u6a5f\u5bc6\u6578\u64da\uff0c\u4f60\u4e5f\u53ef\u4ee5\u9078\u64c7\u4e00\u4e9b\u66ff\u4ee3\u65b9\u6848\u3002 \u4e0b\u9762\u662f\u4e00\u4e9b\u9078\u9805\uff1a \u5982\u679c\u4f60\u7684\u96f2\u539f\u751f\u7d44\u4ef6\u9700\u8981\u57f7\u884c\u8eab\u4efd\u8a8d\u8b49\u4f86\u8a2a\u554f\u4f60\u6240\u77e5\u9053\u7684\u3001\u5728\u540c\u4e00 Kubernetes \u96c6\u7fa4\u4e2d\u904b\u884c\u7684\u53e6\u4e00\u500b\u61c9\u7528\uff0c \u4f60\u53ef\u4ee5\u4f7f\u7528 ServiceAccount \u53ca\u5176\u4ee4\u724c\u4f86\u6a19\u8b58\u4f60\u7684\u5ba2\u6236\u7aef\u8eab\u4efd\u3002 \u4f60\u53ef\u4ee5\u904b\u884c\u7684\u7b2c\u4e09\u65b9\u5de5\u5177\u4e5f\u6709\u5f88\u591a\uff0c\u9019\u4e9b\u5de5\u5177\u53ef\u4ee5\u904b\u884c\u5728\u96c6\u7fa4\u5167\u6216\u96c6\u7fa4\u5916\uff0c\u63d0\u4f9b\u6a5f\u5bc6\u6578\u64da\u7ba1\u7406\u3002\u4f8b\u5982\uff0c\u9019\u4e00\u5de5\u5177\u53ef\u80fd\u662f Pod \u901a\u904e HTTPS \u8a2a\u554f\u7684\u4e00\u500b\u670d\u52d9\uff0c\u8a72\u670d\u52d9\u5728\u5ba2\u6236\u7aef\u80fd\u5920\u6b63\u78ba\u5730\u901a\u904e\u8eab\u4efd\u8a8d\u8b49 \uff08\u4f8b\u5982\uff0c\u901a\u904e ServiceAccount \u4ee4\u724c\uff09\u6642\uff0c\u63d0\u4f9b\u6a5f\u5bc6\u6578\u64da\u5167\u5bb9\u3002 \u5c31\u8eab\u4efd\u8a8d\u8b49\u800c\u8a00\uff0c\u4f60\u53ef\u4ee5\u70ba X.509 \u8b49\u66f8\u5be6\u73fe\u4e00\u500b\u5b9a\u5236\u7684\u7c3d\u540d\u8005\uff0c\u4e26\u4f7f\u7528 CertificateSigningRequest \u4f86\u8b93\u8a72\u7c3d\u540d\u8005\u70ba\u9700\u8981\u8b49\u66f8\u7684 Pod \u767c\u653e\u8b49\u66f8\u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b \u8a2d\u5099\u63d2\u4ef6 \u4f86\u5c07\u7bc0\u9ede\u672c\u5730\u7684\u52a0\u5bc6\u786c\u4ef6\u66b4\u9732\u7d66\u7279\u5b9a\u7684 Pod\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u5c07\u53ef\u4fe1\u4efb\u7684 Pod \u8abf\u5ea6\u5230\u63d0\u4f9b\u53ef\u4fe1\u5e73\u53f0\u6a21\u584a\uff08Trusted Platform Module\uff0cTPM\uff09\u7684\u7bc0\u9ede\u4e0a\u3002\u9019\u985e\u7bc0\u9ede\u662f\u53e6\u884c\u914d\u7f6e\u7684\u3002 \u4f60\u9084\u53ef\u4ee5\u5c07\u5982\u4e0a\u9078\u9805\u7684\u5169\u7a2e\u6216\u591a\u7a2e\u9032\u884c\u7d44\u5408\uff0c\u5305\u62ec\u76f4\u63a5\u4f7f\u7528 Secret \u5c0d\u8c61\u672c\u8eab\u4e5f\u662f\u4e00\u7a2e\u9078\u9805\u3002 \u4f8b\u5982\uff1a\u5be6\u73fe\uff08\u6216\u90e8\u7f72\uff09\u4e00\u500b operator\uff0c \u5f9e\u5916\u90e8\u670d\u52d9\u53d6\u56de\u751f\u547d\u671f\u5f88\u77ed\u7684\u6703\u8a71\u4ee4\u724c\uff0c\u4e4b\u5f8c\u57fa\u65bc\u9019\u4e9b\u751f\u547d\u671f\u5f88\u77ed\u7684\u6703\u8a71\u4ee4\u724c\u4f86\u5275\u5efa Secret\u3002\u904b\u884c\u5728\u96c6\u7fa4\u4e2d\u7684 Pod \u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u6703\u8a71\u4ee4\u724c\uff0c\u800c Operator \u5247\u78ba\u4fdd\u9019\u4e9b\u4ee4\u724c\u662f\u5408\u6cd5\u7684\u3002\u9019\u7a2e\u8cac\u6b0a\u5206\u96e2\u610f\u5473\u8457\u4f60\u53ef\u4ee5\u904b\u884c\u90a3\u4e9b\u4e0d\u4e86\u89e3\u6703\u8a71\u4ee4\u724c\u5982\u4f55\u767c\u653e\u8207\u5237\u65b0\u7684\u78ba\u5207\u6a5f\u5236\u7684 Pod\u3002 \u4f7f\u7528 Secret \u00b6 \u5275\u5efa Secret \u00b6 \u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u5275\u5efa Secret \u57fa\u65bc\u914d\u7f6e\u6587\u4ef6\u4f86\u5275\u5efa Secret \u4f7f\u7528 kustomize \u4f86\u5275\u5efa Secret \u5c0d Secret \u540d\u7a31\u8207\u6578\u64da\u7684\u7d04\u675f \u00b6 Secret \u5c0d\u8c61\u7684\u540d\u7a31\u5fc5\u9808\u662f\u5408\u6cd5\u7684 DNS \u5b50\u57df\u540d \u3002 \u5728\u70ba\u5275\u5efa Secret \u7de8\u5beb\u914d\u7f6e\u6587\u4ef6\u6642\uff0c\u4f60\u53ef\u4ee5\u8a2d\u7f6e data \u8207/\u6216 stringData \u5b57\u6bb5\u3002 data \u548c stringData \u5b57\u6bb5\u90fd\u662f\u53ef\u9078\u7684\u3002 data \u5b57\u6bb5\u4e2d\u6240\u6709\u9375\u503c\u90fd\u5fc5\u9808\u662f base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u3002\u5982\u679c\u4e0d\u5e0c\u671b\u57f7\u884c\u9019\u7a2e base64 \u5b57\u7b26\u4e32\u7684\u8f49\u63db\u64cd\u4f5c\uff0c\u4f60\u53ef\u4ee5\u9078\u64c7\u8a2d\u7f6e stringData \u5b57\u6bb5\uff0c\u5176\u4e2d\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u5b57\u7b26\u4e32\u4f5c\u70ba\u5176\u53d6\u503c\u3002 data \u548c stringData \u4e2d\u7684\u9375\u540d\u53ea\u80fd\u5305\u542b\u5b57\u6bcd\u3001\u6578\u5b57\u3001 - \u3001 _ \u6216 . \u5b57\u7b26\u3002 stringData \u5b57\u6bb5\u4e2d\u7684\u6240\u6709\u9375\u503c\u5c0d\u90fd\u6703\u5728\u5167\u90e8\u88ab\u5408\u4f75\u5230 data \u5b57\u6bb5\u4e2d\u3002\u5982\u679c\u67d0\u500b\u4e3b\u9375\u540c\u6642\u51fa\u73fe\u5728 data \u548c stringData \u5b57\u6bb5\u4e2d\uff0c stringData \u6240\u6307\u5b9a\u7684\u9375\u503c\u5177\u6709\u9ad8\u512a\u5148\u7d1a\u3002 \u5c3a\u5bf8\u9650\u5236 \u00b6 \u6bcf\u500b Secret \u7684\u5c3a\u5bf8\u6700\u591a\u70ba 1 MiB \u3002\u65bd\u52a0\u9019\u4e00\u9650\u5236\u662f\u70ba\u4e86\u907f\u514d\u7528\u6236\u5275\u5efa\u975e\u5e38\u5927\u7684 Secret\uff0c \u9032\u800c\u5c0e\u81f4 API \u670d\u52d9\u5668\u548c kubelet \u5167\u5b58\u8017\u76e1\u3002\u4e0d\u904e\u5275\u5efa\u5f88\u591a\u5c0f\u7684 Secret \u4e5f\u53ef\u80fd\u8017\u76e1\u5167\u5b58\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u8cc7\u6e90\u914d\u984d\u4f86\u7d04\u675f\u6bcf\u500b\u540d\u5b57\u7a7a\u9593\u4e2d Secret\uff08\u6216\u5176\u4ed6\u8cc7\u6e90\uff09\u7684\u500b\u6578\u3002 \u7de8\u8f2f Secret \u00b6 \u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl \u4f86\u7de8\u8f2f\u4e00\u500b\u5df2\u6709\u7684 Secret\uff1a kubectl edit secrets mysecret \u9019\u4e00\u547d\u4ee4\u6703\u555f\u52d5\u4f60\u7684\u9ed8\u8a8d\u7de8\u8f2f\u5668\uff0c\u5141\u8a31\u4f60\u66f4\u65b0 data \u5b57\u6bb5\u4e2d\u5b58\u653e\u7684 base64 \u7de8\u78bc\u7684 Secret \u503c\uff1b \u4f8b\u5982\uff1a # \u8acb\u7de8\u8f2f\u4ee5\u4e0b\u5c0d\u8c61\u3002\u4ee5 `#` \u958b\u982d\u7684\u5e7e\u884c\u5c07\u88ab\u5ffd\u7565\uff0c # \u4e14\u7a7a\u6587\u4ef6\u5c07\u653e\u68c4\u7de8\u8f2f\u3002\u5982\u679c\u4fdd\u5b58\u6b64\u6587\u4ef6\u6642\u51fa\u932f\uff0c # \u5247\u91cd\u65b0\u6253\u958b\u6b64\u6587\u4ef6\u6642\u4e5f\u6703\u6709\u76f8\u95dc\u6545\u969c\u3002 apiVersion : v1 data : username : YWRtaW4= password : MWYyZDFlMmU2N2Rm kind : Secret metadata : annotations : kubectl.kubernetes.io/last-applied-configuration : { ... } creationTimestamp : 2020-01-22T18:41:56Z name : mysecret namespace : default resourceVersion : \"164619\" uid : cfee02d6-c137-11e5-8d73-42010af00002 type : Opaque \u9019\u4e00\u793a\u4f8b\u6e05\u55ae\u5b9a\u7fa9\u4e86\u4e00\u500b Secret\uff0c\u5176 data \u5b57\u6bb5\u4e2d\u5305\u542b\u5169\u500b\u4e3b\u9375\uff1a username \u548c password \u3002\u6e05\u55ae\u4e2d\u7684\u5b57\u6bb5\u503c\u662f Base64 \u5b57\u7b26\u4e32\uff0c\u4e0d\u904e\uff0c\u7576\u4f60\u5728 Pod \u4e2d\u4f7f\u7528 Secret \u6642\uff0ckubelet \u70ba Pod \u53ca\u5176\u4e2d\u7684\u5bb9\u5668\u63d0\u4f9b\u7684\u662f \u89e3\u78bc \u5f8c\u7684\u6578\u64da\u3002 \u4f60\u53ef\u4ee5\u5728\u4e00\u500b Secret \u4e2d\u6253\u5305\u591a\u500b\u4e3b\u9375\u548c\u6578\u503c\uff0c\u4e5f\u53ef\u4ee5\u9078\u64c7\u4f7f\u7528\u591a\u500b Secret\uff0c \u5b8c\u5168\u53d6\u6c7a\u65bc\u54ea\u7a2e\u65b9\u5f0f\u6700\u65b9\u4fbf\u3002 \u4f7f\u7528 Secret \u00b6 Secret \u53ef\u4ee5\u4ee5\u6578\u64da\u5377\u7684\u5f62\u5f0f\u639b\u8f09\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba\u74b0\u5883\u8b8a\u91cf \u66b4\u9732\u7d66 Pod \u4e2d\u7684\u5bb9\u5668\u4f7f\u7528\u3002 Secret \u4e5f\u53ef\u7528\u65bc\u7cfb\u7d71\u4e2d\u7684\u5176\u4ed6\u90e8\u5206\uff0c\u800c\u4e0d\u662f\u4e00\u5b9a\u8981\u76f4\u63a5\u66b4\u9732\u7d66 Pod\u3002\u4f8b\u5982\uff0cSecret \u4e5f\u53ef\u4ee5\u5305\u542b\u7cfb\u7d71\u4e2d\u5176\u4ed6\u90e8\u5206\u5728\u66ff\u4f60\u8207\u5916\u90e8\u7cfb\u7d71\u4ea4\u4e92\u6642\u8981\u4f7f\u7528\u7684\u6191\u8b49\u6578\u64da\u3002 Kubernetes \u6703\u6aa2\u67e5 Secret \u7684\u6372\u6578\u64da\u6e90\uff0c\u78ba\u4fdd\u6240\u6307\u5b9a\u7684\u5c0d\u8c61\u5f15\u7528\u78ba\u5be6\u6307\u5411\u985e\u578b\u70ba Secret \u7684\u5c0d\u8c61\u3002\u56e0\u6b64\uff0c\u5982\u679c Pod \u4f9d\u8cf4\u65bc\u67d0 Secret\uff0c\u8a72 Secret \u5fc5\u9808\u5148\u65bc Pod \u88ab\u5275\u5efa\u3002 \u5982\u679c Secret \u5167\u5bb9\u7121\u6cd5\u53d6\u56de\uff08\u53ef\u80fd\u56e0\u70ba Secret \u5c1a\u4e0d\u5b58\u5728\u6216\u8005\u81e8\u6642\u6027\u5730\u51fa\u73fe API \u670d\u52d9\u5668\u7db2\u7d61\u9023\u63a5\u554f\u984c\uff09\uff0ckubelet \u6703\u5468\u671f\u6027\u5730\u91cd\u8a66 Pod \u904b\u884c\u64cd\u4f5c\u3002 kubelet \u4e5f\u6703\u70ba\u8a72 Pod \u5831\u544a Event \u4e8b\u4ef6\uff0c\u7d66\u51fa\u8b80\u53d6 Secret \u6642\u9047\u5230\u7684\u554f\u984c\u7d30\u7bc0\u3002 \u53ef\u9078\u7684(Optional) Secret \u00b6 \u7576\u4f60\u5b9a\u7fa9\u4e00\u500b\u57fa\u65bc Secret \u7684\u74b0\u5883\u8b8a\u91cf\u6642\uff0c\u4f60\u53ef\u4ee5\u5c07\u5176\u6a19\u8a18\u70ba\u53ef\u9078\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6240\u5f15\u7528\u7684 Secret \u90fd\u662f\u5fc5\u9700\u7684\u3002 \u53ea\u6709\u6240\u6709\u975e\u53ef\u9078\u7684 Secret \u90fd\u53ef\u7528\u6642\uff0cPod \u4e2d\u7684\u5bb9\u5668\u624d\u80fd\u555f\u52d5\u904b\u884c\u3002 \u5982\u679c Pod \u5f15\u7528\u4e86 Secret \u4e2d\u7684\u7279\u5b9a\u4e3b\u9375\uff0c\u800c\u96d6\u7136 Secret \u672c\u8eab\u5b58\u5728\uff0c\u5c0d\u61c9\u7684\u4e3b\u9375\u4e0d\u5b58\u5728\uff0c Pod \u555f\u52d5\u4e5f\u6703\u5931\u6557\u3002 \u5728 Pod \u4e2d\u4ee5\u6587\u4ef6\u5f62\u5f0f\u4f7f\u7528 Secret \u00b6 \u5982\u679c\u4f60\u5e0c\u671b\u5728 Pod \u4e2d\u8a2a\u554f Secret \u5167\u7684\u6578\u64da\uff0c\u4e00\u7a2e\u65b9\u5f0f\u662f\u8b93 Kubernetes \u5c07 Secret \u4ee5 Pod \u4e2d\u4e00\u500b\u6216\u591a\u500b\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u7684\u6587\u4ef6\u7684\u5f62\u5f0f\u5448\u73fe\u51fa\u4f86\u3002 \u8981\u914d\u7f6e\u9019\u7a2e\u884c\u70ba\uff0c\u4f60\u9700\u8981\uff1a \u5275\u5efa\u4e00\u500b Secret \u6216\u8005\u4f7f\u7528\u5df2\u6709\u7684 Secret\u3002\u591a\u500b Pod \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u500b Secret\u3002 \u66f4\u6539 Pod \u5b9a\u7fa9\uff0c\u5728 .spec.volumes[] \u4e0b\u6dfb\u52a0\u4e00\u500b\u5377\u3002\u6839\u64da\u9700\u8981\u70ba\u5377\u8a2d\u7f6e\u5176\u540d\u7a31\uff0c \u4e26\u5c07 .spec.volumes[].secret.secretName \u5b57\u6bb5\u8a2d\u7f6e\u70ba Secret \u5c0d\u8c61\u7684\u540d\u7a31\u3002 \u70ba\u6bcf\u500b\u9700\u8981\u8a72 Secret \u7684\u5bb9\u5668\u6dfb\u52a0 .spec.containers[].volumeMounts[] \u3002\u4e26\u5c07 .spec.containers[].volumeMounts[].readOnly \u8a2d\u7f6e\u70ba true \uff0c \u5c07 .spec.containers[].volumeMounts[].mountPath \u8a2d\u7f6e\u70ba\u5e0c\u671b Secret \u88ab\u653e\u7f6e\u7684\u3001\u76ee\u524d\u5c1a\u672a\u88ab\u4f7f\u7528\u7684\u8def\u5f91\u540d\u3002 \u66f4\u6539\u4f60\u7684\u93e1\u50cf\u6216\u547d\u4ee4\u884c\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u8b80\u53d6\u6240\u8a2d\u7f6e\u7684\u76ee\u9304\u4e0b\u7684\u6587\u4ef6\u3002 Secret \u7684 data \u6620\u5c04\u4e2d\u7684\u6bcf\u500b\u4e3b\u9375\u90fd\u6210\u70ba mountPath \u4e0b\u9762\u7684\u6587\u4ef6\u540d\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u901a\u904e\u5377\u4f86\u639b\u8f09\u540d\u70ba mysecret \u7684 Secret \u7684 Pod \u793a\u4f8b\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" readOnly : true volumes : - name : foo secret : secretName : mysecret optional : false # \u9ed8\u8a8d\u8a2d\u7f6e\uff0c\u610f\u5473\u8457 \"mysecret\" \u5fc5\u9808\u5df2\u7d93\u5b58\u5728 \u4f60\u8981\u8a2a\u554f\u7684\u6bcf\u500b Secret \u90fd\u9700\u8981\u901a\u904e .spec.volumes \u4f86\u5f15\u7528\u3002 \u5982\u679c Pod \u4e2d\u5305\u542b\u591a\u500b\u5bb9\u5668\uff0c\u5247\u6bcf\u500b\u5bb9\u5668\u9700\u8981\u81ea\u5df1\u7684 volumeMounts \u584a\uff0c \u4e0d\u904e\u91dd\u5c0d\u6bcf\u500b Secret \u800c\u8a00\uff0c\u53ea\u9700\u8981\u4e00\u4efd .spec.volumes \u8a2d\u7f6e\u3002 Info \u8aaa\u660e\uff1a Kubernetes v1.22 \u7248\u672c\u4e4b\u524d\u90fd\u6703\u81ea\u52d5\u5275\u5efa\u7528\u4f86\u8a2a\u554f Kubernetes API \u7684\u6191\u8b49\u3002\u9019\u4e00\u8001\u7684\u6a5f\u5236\u662f\u57fa\u65bc\u5275\u5efa\u53ef\u88ab\u639b\u8f09\u5230 Pod \u4e2d\u7684\u4ee4\u724c Secret \u4f86\u5be6\u73fe\u7684\u3002\u5728\u6700\u8fd1\u7684\u7248\u672c\u4e2d\uff0c\u5305\u62ec Kubernetes v1.24 \u4e2d\uff0cAPI \u6191\u64da\u662f\u76f4\u63a5\u901a\u904e TokenRequest API \u4f86\u7372\u5f97\u7684\uff0c\u9019\u4e00\u6191\u64da\u6703\u4f7f\u7528 \u6295\u5c04\u5377 \u639b\u8f09\u5230 Pod \u4e2d\u3002\u4f7f\u7528\u9019\u7a2e\u65b9\u5f0f\u7372\u5f97\u7684\u4ee4\u724c\u6709\u78ba\u5b9a\u7684\u751f\u547d\u671f\uff0c\u4e26\u4e14\u5728\u639b\u8f09\u5b83\u5011\u7684 Pod \u88ab\u522a\u9664\u6642\u81ea\u52d5\u4f5c\u5ee2\u3002 \u4f60\u4ecd\u7136\u53ef\u4ee5 \u624b\u52d5\u5275\u5efa \u670d\u52d9\u8cec\u865f\u4ee4\u724c\u3002\u4f8b\u5982\uff0c\u7576\u4f60\u9700\u8981\u4e00\u500b\u6c38\u9060\u90fd\u4e0d\u904e\u671f\u7684\u4ee4\u724c\u6642\u3002\u4e0d\u904e\uff0c\u4ecd\u7136\u5efa\u8b70\u4f7f\u7528 TokenRequest \u5b50\u8cc7\u6e90\u4f86\u7372\u5f97\u8a2a\u554f API \u670d\u52d9\u5668\u7684\u4ee4\u724c\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl create token \u547d\u4ee4\u8abf\u7528 TokenRequest API \u7372\u5f97\u4ee4\u724c\u3002 \u5c07 Secret \u9375\u6295\u5c04\u5230\u7279\u5b9a\u76ee\u9304 \u00b6 \u4f60\u4e5f\u53ef\u4ee5\u63a7\u5236 Secret \u9375\u6240\u6295\u5c04\u5230\u7684\u5377\u4e2d\u7684\u8def\u5f91\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 .spec.volumes[].secret.items \u5b57\u6bb5\u4f86\u66f4\u6539\u6bcf\u500b\u4e3b\u9375\u7684\u76ee\u6a19\u8def\u5f91\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" readOnly : true volumes : - name : foo secret : secretName : mysecret items : - key : username path : my-group/my-username \u5c07\u767c\u751f\u7684\u4e8b\u60c5\u5982\u4e0b\uff1a mysecret \u4e2d\u7684\u9375 username \u6703\u51fa\u73fe\u5728\u5bb9\u5668\u4e2d\u7684\u8def\u5f91\u70ba /etc/foo/my-group/my-username \uff0c \u800c\u4e0d\u662f /etc/foo/username \u3002 Secret \u5c0d\u8c61\u7684 password \u9375\u4e0d\u6703\u88ab\u6295\u5c04\u3002 \u5982\u679c\u4f7f\u7528\u4e86 .spec.volumes[].secret.items \uff0c\u5247\u53ea\u6709 items \u4e2d\u6307\u5b9a\u4e86\u7684\u4e3b\u9375\u6703\u88ab\u6295\u5c04\u3002\u5982\u679c\u8981\u4f7f\u7528 Secret \u4e2d\u7684\u6240\u6709\u4e3b\u9375\uff0c\u5247\u9700\u8981\u5c07\u5b83\u5011\u5168\u90e8\u679a\u8209\u5230 items \u5b57\u6bb5\u4e2d\u3002 \u5982\u679c\u4f60\u986f\u5f0f\u5730\u5217\u8209\u4e86\u4e3b\u9375\uff0c\u5247\u6240\u5217\u8209\u7684\u4e3b\u9375\u90fd\u5fc5\u9808\u5728\u5c0d\u61c9\u7684 Secret \u4e2d\u5b58\u5728\u3002\u5426\u5247\u6240\u5728\u7684\u5377\u4e0d\u6703\u88ab\u5275\u5efa\u3002 Secret \u6587\u4ef6\u7684\u8a2a\u554f\u6b0a\u9650 \u00b6 \u4f60\u53ef\u4ee5\u70ba\u67d0\u500b Secret \u4e3b\u9375\u8a2d\u7f6e POSIX \u6587\u4ef6\u8a2a\u554f\u6b0a\u9650\u4f4d\u3002\u5982\u679c\u4f60\u4e0d\u6307\u5b9a\u8a2a\u554f\u6b0a\u9650\uff0c\u9ed8\u8a8d\u6703\u4f7f\u7528 0644\u3002\u4f60\u4e5f\u53ef\u4ee5\u70ba\u6574\u500b Secret \u5377\u8a2d\u7f6e\u9ed8\u8a8d\u7684\u8a2a\u554f\u6a21\u5f0f\uff0c\u7136\u5f8c\u518d\u6839\u64da\u9700\u8981\u5728\u4e3b\u9375\u5c64\u9762\u91cd\u8f09\u3002 \u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u50cf\u4e0b\u9762\u9019\u6a23\u8a2d\u7f6e\u9ed8\u8a8d\u7684\u6a21\u5f0f\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" volumes : - name : foo secret : secretName : mysecret defaultMode : 0400 \u8a72 Secret \u88ab\u639b\u8f09\u5728 /etc/foo \u4e0b\uff0cSecret \u5377\u639b\u8f09\u6240\u5275\u5efa\u7684\u6240\u6709\u6587\u4ef6\u7684\u8a2a\u554f\u6a21\u5f0f\u90fd\u662f 0400\u3002 \u4f7f\u7528\u4f86\u81ea\u5377\u4e2d\u7684 Secret \u503c \u00b6 \u5728\u639b\u8f09\u4e86 Secret \u5377\u7684\u5bb9\u5668\u5167\uff0cSecret \u7684\u4e3b\u9375\u90fd\u5448\u73fe\u70ba\u6587\u4ef6\u3002 Secret \u7684\u53d6\u503c\u90fd\u662f Base64 \u7de8\u78bc\u7684\uff0c\u4fdd\u5b58\u5728\u9019\u4e9b\u6587\u4ef6\u4e2d\u3002 \u4e0b\u9762\u662f\u5728\u4e0a\u4f8b\u4e2d\u7684\u5bb9\u5668\u5167\u57f7\u884c\u547d\u4ee4\u7684\u7d50\u679c\uff1a ls /etc/foo/ \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a username password cat /etc/foo/username \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a admin cat /etc/foo/password \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a 1f2d1e2e67df \u5bb9\u5668\u4e2d\u7684\u7a0b\u5e8f\u8981\u8ca0\u8cac\u6839\u64da\u9700\u8981\u8b80\u53d6 Secret \u6578\u64da\u3002 \u639b\u8f09\u7684 Secret \u662f\u88ab\u81ea\u52d5\u66f4\u65b0\u7684 \u00b6 \u7576\u5377\u4e2d\u5305\u542b\u4f86\u81ea Secret \u7684\u6578\u64da\uff0c\u800c\u5c0d\u61c9\u7684 Secret \u88ab\u66f4\u65b0\uff0cKubernetes \u6703\u8ddf\u8e2a\u5230\u9019\u4e00\u64cd\u4f5c\u4e26\u66f4\u65b0\u5377\u4e2d\u7684\u6578\u64da\u3002\u66f4\u65b0\u7684\u65b9\u5f0f\u662f\u4fdd\u8b49\u6700\u7d42\u4e00\u81f4\u6027\u3002 Info \u8aaa\u660e\uff1a \u5c0d\u65bc\u4ee5 subPath \u5f62\u5f0f\u639b\u8f09 Secret \u5377\u7684\u5bb9\u5668\u800c\u8a00\uff0c \u5b83\u5011\u7121\u6cd5\u6536\u5230\u81ea\u52d5\u7684 Secret \u66f4\u65b0\u3002 Kubelet \u7d44\u4ef6\u6703\u7dad\u8b77\u4e00\u500b\u7de9\u5b58\uff0c\u5728\u5176\u4e2d\u4fdd\u5b58\u7bc0\u9ede\u4e0a Pod \u5377\u4e2d\u4f7f\u7528\u7684 Secret \u7684\u7576\u524d\u4e3b\u9375\u548c\u53d6\u503c\u3002\u4f60\u53ef\u4ee5\u914d\u7f6e kubelet \u5982\u4f55\u6aa2\u6e2c\u6240\u7de9\u5b58\u6578\u503c\u7684\u8b8a\u5316\u3002 kubelet \u914d\u7f6e\u4e2d\u7684 configMapAndSecretChangeDetectionStrategy \u5b57\u6bb5\u63a7\u5236 kubelet \u6240\u63a1\u7528\u7684\u7b56\u7565\u3002\u9ed8\u8a8d\u7684\u7b56\u7565\u662f Watch\u3002 \u5c0d Secret \u7684\u66f4\u65b0\u64cd\u4f5c\u65e2\u53ef\u4ee5\u901a\u904e API \u7684 watch \u6a5f\u5236\uff08\u9ed8\u8a8d\uff09\u4f86\u50b3\u64ad\uff0c \u57fa\u65bc\u8a2d\u7f6e\u4e86\u751f\u547d\u671f\u7684\u7de9\u5b58\u7372\u53d6\uff0c\u4e5f\u53ef\u4ee5\u901a\u904e kubelet \u7684\u540c\u6b65\u8ff4\u8def\u4f86\u5f9e\u96c6\u7fa4\u7684 API \u670d\u52d9\u5668\u4e0a\u8f2a\u8a62\u7372\u53d6\u3002 \u56e0\u6b64\uff0c\u5f9e Secret \u88ab\u66f4\u65b0\u5230\u65b0\u7684\u4e3b\u9375\u88ab\u6295\u5c04\u5230 Pod \u4e2d\uff0c\u4e2d\u9593\u5b58\u5728\u4e00\u500b\u5ef6\u9072\u3002\u9019\u4e00\u5ef6\u9072\u7684\u4e0a\u9650\u662f kubelet \u7684\u540c\u6b65\u9031\u671f\u52a0\u4e0a\u7de9\u5b58\u7684\u50b3\u64ad\u5ef6\u9072\uff0c \u5176\u4e2d\u7de9\u5b58\u7684\u50b3\u64ad\u5ef6\u9072\u53d6\u6c7a\u65bc\u6240\u9078\u64c7\u7684\u7de9\u5b58\u985e\u578b\u3002\u5c0d\u61c9\u4e0a\u4e00\u6bb5\u4e2d\u63d0\u5230\u7684\u5e7e\u7a2e\u50b3\u64ad\u6a5f\u5236\uff0c\u5ef6\u9072\u6642\u9577\u70ba watch \u7684\u50b3\u64ad\u5ef6\u9072\u3001\u6240\u914d\u7f6e\u7684\u7de9\u5b58 TTL \u6216\u8005\u5c0d\u65bc\u76f4\u63a5\u8f2a\u8a62\u800c\u8a00\u662f\u96f6\u3002 \u4ee5\u74b0\u5883\u8b8a\u91cf\u7684\u65b9\u5f0f\u4f7f\u7528 Secret \u00b6 \u5982\u679c\u9700\u8981\u5728 Pod \u4e2d\u4ee5\u74b0\u5883\u8b8a\u91cf \u7684\u5f62\u5f0f\u4f7f\u7528 Secret\uff1a \u5275\u5efa Secret\uff08\u6216\u8005\u4f7f\u7528\u73fe\u6709 Secret\uff09\u3002\u591a\u500b Pod \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u500b Secret\u3002 \u66f4\u6539 Pod \u5b9a\u7fa9\uff0c\u5728\u8981\u4f7f\u7528 Secret \u9375\u503c\u7684\u6bcf\u500b\u5bb9\u5668\u4e2d\u6dfb\u52a0\u8207\u6240\u4f7f\u7528\u7684\u4e3b\u9375\u5c0d\u61c9\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u8b80\u53d6 Secret \u4e3b\u9375\u7684\u74b0\u5883\u8b8a\u91cf\u61c9\u8a72\u5728 env[].valueFrom.secretKeyRef \u4e2d\u586b\u5beb Secret \u7684\u540d\u7a31\u548c\u4e3b\u9375\u540d\u7a31\u3002 \u66f4\u6539\u4f60\u7684\u93e1\u50cf\u6216\u547d\u4ee4\u884c\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u8b80\u53d6\u74b0\u5883\u8b8a\u91cf\u4e2d\u4fdd\u5b58\u7684\u503c\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f86\u4f7f\u7528 Secret \u7684\u793a\u4f8b Pod\uff1a apiVersion : v1 kind : Pod metadata : name : secret-env-pod spec : containers : - name : mycontainer image : redis env : - name : SECRET_USERNAME valueFrom : secretKeyRef : name : mysecret key : username optional : false # \u6b64\u503c\u70ba\u9ed8\u8a8d\u503c\uff1b\u610f\u5473\u8457 \"mysecret\" # \u5fc5\u9808\u5b58\u5728\u4e14\u5305\u542b\u540d\u70ba \"username\" \u7684\u4e3b\u9375 - name : SECRET_PASSWORD valueFrom : secretKeyRef : name : mysecret key : password optional : false # \u6b64\u503c\u70ba\u9ed8\u8a8d\u503c\uff1b\u610f\u5473\u8457 \"mysecret\" # \u5fc5\u9808\u5b58\u5728\u4e14\u5305\u542b\u540d\u70ba \"username\" \u7684\u4e3b\u9375 restartPolicy : Never \u975e\u6cd5\u74b0\u5883\u8b8a\u91cf \u00b6 \u5c0d\u65bc\u901a\u904e envFrom \u5b57\u6bb5\u4f86\u586b\u5145\u74b0\u5883\u8b8a\u91cf\u7684 Secret \u800c\u8a00\uff0c \u5982\u679c\u5176\u4e2d\u5305\u542b\u7684\u4e3b\u9375\u4e0d\u80fd\u88ab\u7576\u505a\u5408\u6cd5\u7684\u74b0\u5883\u8b8a\u91cf\u540d\uff0c\u9019\u4e9b\u4e3b\u9375\u6703\u88ab\u5ffd\u7565\u6389\u3002 Pod \u4ecd\u7136\u53ef\u4ee5\u555f\u52d5\u3002 \u5982\u679c\u4f60\u5b9a\u7fa9\u7684 Pod \u4e2d\u5305\u542b\u975e\u6cd5\u7684\u8b8a\u91cf\u540d\u7a31\uff0c\u5247 Pod \u53ef\u80fd\u555f\u52d5\u5931\u6557\uff0c \u6703\u5f62\u6210 reason \u70ba InvalidVariableNames \u7684\u4e8b\u4ef6\uff0c\u4ee5\u53ca\u5217\u8209\u88ab\u7565\u904e\u7684\u975e\u6cd5\u4e3b\u9375\u7684\u6d88\u606f\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u5c55\u793a\u4e86\u4e00\u500b Pod\uff0c\u5f15\u7528\u7684\u662f\u540d\u70ba mysecret \u7684 Secret\uff0c \u5176\u4e2d\u5305\u542b\u5169\u500b\u975e\u6cd5\u7684\u4e3b\u9375\uff1a 1badkey \u548c 2alsobad \u3002 kubectl get events \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a LASTSEEN FIRSTSEEN COUNT NAME KIND SUBOBJECT TYPE REASON 0s 0s 1 dapi-test-pod Pod Warning InvalidEnvironmentVariableNames kubelet, 127.0.0.1 Keys [1badkey, 2alsobad] from the EnvFrom secret default/mysecret were skipped since they are considered invalid environment variable names. \u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f7f\u7528 Secret \u503c \u00b6 \u5728\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f86\u4f7f\u7528 Secret \u7684\u5bb9\u5668\u4e2d\uff0cSecret \u4e3b\u9375\u5c55\u73fe\u70ba\u666e\u901a\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u9019\u4e9b\u8b8a\u91cf\u7684\u53d6\u503c\u662f Secret \u6578\u64da\u7684 Base64 \u89e3\u78bc\u503c\u3002 \u4e0b\u9762\u662f\u5728\u524d\u6587\u793a\u4f8b\u4e2d\u7684\u5bb9\u5668\u5167\u57f7\u884c\u547d\u4ee4\u7684\u7d50\u679c\uff1a echo \" $SECRET_USERNAME \" \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a admin echo \" $SECRET_PASSWORD \" \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a 1f2d1e2e67df Info \u8aaa\u660e\uff1a \u5982\u679c\u5bb9\u5668\u5df2\u7d93\u5728\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f86\u4f7f\u7528 Secret\uff0cSecret \u66f4\u65b0\u5728\u5bb9\u5668\u5167\u662f\u770b\u4e0d\u5230\u7684\uff0c \u9664\u975e\u5bb9\u5668\u88ab\u91cd\u555f\u3002\u6709\u4e00\u4e9b\u7b2c\u4e09\u65b9\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u80fd\u5920\u5728 Secret \u767c\u751f\u8b8a\u5316\u6642\u89f8\u767c\u5bb9\u5668\u91cd\u555f\u3002 \u5bb9\u5668\u93e1\u50cf\u62c9\u53d6 Secret \u00b6 \u5982\u679c\u4f60\u5617\u8a66\u5f9e\u79c1\u6709\u5009\u5eab\u62c9\u53d6\u5bb9\u5668\u93e1\u50cf\uff0c\u4f60\u9700\u8981\u4e00\u7a2e\u65b9\u5f0f\u8b93\u6bcf\u500b\u7bc0\u9ede\u4e0a\u7684 kubelet \u80fd\u5920\u5b8c\u6210\u8207\u93e1\u50cf\u5eab\u7684\u8eab\u4efd\u8a8d\u8b49\u3002\u4f60\u53ef\u4ee5\u914d\u7f6e \u93e1\u50cf\u62c9\u53d6 Secret \u4f86\u5be6\u73fe\u9019\u9ede\u3002 Secret \u662f\u5728 Pod \u5c64\u9762\u4f86\u914d\u7f6e\u7684\u3002 Pod \u7684 imagePullSecrets \u5b57\u6bb5\u662f\u4e00\u500b\u5c0d Pod \u6240\u5728\u7684\u540d\u5b57\u7a7a\u9593\u4e2d\u7684 Secret \u7684\u5f15\u7528\u5217\u8868\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 imagePullSecrets \u4f86\u5c07\u93e1\u50cf\u5009\u5eab\u8a2a\u554f\u6191\u64da\u50b3\u905e\u7d66 kubelet\u3002 kubelet \u4f7f\u7528\u9019\u500b\u4fe1\u606f\u4f86\u66ff\u4f60\u7684 Pod \u62c9\u53d6\u79c1\u6709\u93e1\u50cf\u3002\u53c3\u95b1 Pod API \u53c3\u8003 \u4e2d\u7684 PodSpec \u9032\u4e00\u6b65\u4e86\u89e3 imagePullSecrets \u5b57\u6bb5\u3002 \u4f7f\u7528 imagePullSecrets imagePullSecrets \u5b57\u6bb5\u662f\u4e00\u500b\u5217\u8868\uff0c\u5305\u542b\u5c0d\u540c\u4e00\u540d\u5b57\u7a7a\u9593\u4e2d Secret \u7684\u5f15\u7528\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 imagePullSecrets \u5c07\u5305\u542b Docker\uff08\u6216\u5176\u4ed6\uff09\u93e1\u50cf\u5009\u5eab\u5bc6\u78bc\u7684 Secret \u50b3\u905e\u7d66 kubelet\u3002 kubelet \u4f7f\u7528\u6b64\u4fe1\u606f\u4f86\u66ff Pod \u62c9\u53d6\u79c1\u6709\u93e1\u50cf\u3002\u53c3\u95b1 PodSpec API \u9032\u4e00\u6b65\u4e86\u89e3 imagePullSecrets \u5b57\u6bb5\u3002 \u624b\u52d5\u8a2d\u5b9a imagePullSecret \u4f60\u53ef\u4ee5\u901a\u904e\u95b1\u8b80 \u5bb9\u5668\u93e1\u50cf \u6587\u6a94\u4e86\u89e3\u5982\u4f55\u8a2d\u7f6e imagePullSecrets \u3002 \u8a2d\u7f6e imagePullSecrets \u70ba\u81ea\u52d5\u639b\u8f09 \u4f60\u53ef\u4ee5\u624b\u52d5\u5275\u5efa imagePullSecret \uff0c\u4e26\u5728\u4e00\u500b ServiceAccount \u4e2d\u5f15\u7528\u5b83\u3002\u5c0d\u4f7f\u7528\u8a72 ServiceAccount \u5275\u5efa\u7684\u6240\u6709 Pod\uff0c\u6216\u8005\u9ed8\u8a8d\u4f7f\u7528\u8a72 ServiceAccount \u5275\u5efa\u7684 Pod \u800c\u8a00\uff0c\u5176 imagePullSecrets \u5b57\u6bb5\u90fd\u6703\u8a2d\u7f6e\u70ba\u8a72\u670d\u52d9\u8cec\u865f\u3002\u8acb\u95b1\u8b80 \u5411\u670d\u52d9\u8cec\u865f\u6dfb\u52a0 ImagePullSecrets \u4f86\u8a73\u7d30\u4e86\u89e3\u9019\u4e00\u904e\u7a0b\u3002 \u5728\u975c\u614b Pod \u4e2d\u4f7f\u7528 Secret \u00b6 \u4f60\u4e0d\u53ef\u4ee5\u5728\u975c\u614b Pod \u4e2d\u4f7f\u7528 ConfigMap \u6216 Secret\u3002 \u4f7f\u7528\u5834\u666f \u00b6 \u4f7f\u7528\u5834\u666f\uff1a\u4f5c\u70ba\u5bb9\u5668\u74b0\u5883\u8b8a\u91cf \u00b6 \u5275\u5efa Secret\uff1a mysecret.yaml apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : USER_NAME : YWRtaW4= PASSWORD : MWYyZDFlMmU2N2Rm kubectl apply -f mysecret.yaml \u4f7f\u7528 envFrom \u4f86\u5c07 Secret \u7684\u6240\u6709\u6578\u64da\u5b9a\u7fa9\u70ba\u5bb9\u5668\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u4f86\u81ea Secret \u7684\u4e3b\u9375\u6210\u70ba Pod \u4e2d\u7684\u74b0\u5883\u8b8a\u91cf\u540d\u7a31\uff1a apiVersion : v1 kind : Pod metadata : name : secret-test-pod spec : containers : - name : test-container image : k8s.gcr.io/busybox command : [ \"/bin/sh\" , \"-c\" , \"env\" ] envFrom : - secretRef : name : mysecret restartPolicy : Never \u4f7f\u7528\u5834\u666f\uff1a\u5e36 SSH \u5bc6\u9470\u7684 Pod \u00b6 \u5275\u5efa\u5305\u542b\u4e00\u4e9b SSH \u5bc6\u9470\u7684 Secret\uff1a kubectl create secret generic ssh-key-secret --from-file = ssh-privatekey = /path/to/.ssh/id_rsa --from-file = ssh-publickey = /path/to/.ssh/id_rsa.pub \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a secret \"ssh-key-secret\" created \u4f60\u4e5f\u53ef\u4ee5\u5275\u5efa\u4e00\u500b kustomization.yaml \u6587\u4ef6\uff0c\u5728\u5176 secretGenerator \u5b57\u6bb5\u4e2d\u5305\u542b SSH \u5bc6\u9470\u3002 \u73fe\u5728\u4f60\u53ef\u4ee5\u5275\u5efa\u4e00\u500b Pod\uff0c\u5728\u5176\u4e2d\u8a2a\u554f\u5305\u542b SSH \u5bc6\u9470\u7684 Secret\uff0c\u4e26\u901a\u904e\u5377\u7684\u65b9\u5f0f\u4f86\u4f7f\u7528\u5b83\uff1a apiVersion : v1 kind : Pod metadata : name : secret-test-pod labels : name : secret-test spec : volumes : - name : secret-volume secret : secretName : ssh-key-secret containers : - name : ssh-test-container image : mySshImage volumeMounts : - name : secret-volume readOnly : true mountPath : \"/etc/secret-volume\" \u5bb9\u5668\u547d\u4ee4\u57f7\u884c\u6642\uff0c\u79d8\u9470\u7684\u6578\u64da\u53ef\u4ee5\u5728\u4e0b\u9762\u7684\u4f4d\u7f6e\u8a2a\u554f\u5230\uff1a /etc/secret-volume/ssh-publickey /etc/secret-volume/ssh-privatekey \u5bb9\u5668\u5c31\u53ef\u4ee5\u96a8\u4fbf\u4f7f\u7528 Secret \u6578\u64da\u4f86\u5efa\u7acb SSH \u9023\u63a5\u3002 \u4f7f\u7528\u5834\u666f\uff1a\u5e36\u6709\u751f\u7522\u3001\u6e2c\u8a66\u74b0\u5883\u6191\u64da\u7684 Pod \u00b6 \u9019\u4e00\u793a\u4f8b\u6240\u5c55\u793a\u7684\u4e00\u500b Pod \u6703\u4f7f\u7528\u5305\u542b\u751f\u7522\u74b0\u5883\u6191\u64da\u7684 Secret\uff0c\u53e6\u4e00\u500b Pod \u4f7f\u7528\u5305\u542b\u6e2c\u8a66\u74b0\u5883\u6191\u64da\u7684 Secret\u3002 \u4f60\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u5e36\u6709 secretGenerator \u5b57\u6bb5\u7684 kustomization.yaml \u6587\u4ef6\u6216\u8005\u904b\u884c kubectl create secret \u4f86\u5275\u5efa Secret\u3002 kubectl create secret generic prod-db-secret --from-literal = username = produser --from-literal = password = Y4nys7f11 \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a secret \"prod-db-secret\" created \u4f60\u4e5f\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u5305\u542b\u6e2c\u8a66\u74b0\u5883\u6191\u64da\u7684 Secret\uff1a kubectl create secret generic test-db-secret --from-literal = username = testuser --from-literal = password = iluvtests \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a secret \"test-db-secret\" created \u73fe\u5728\u751f\u6210 Pod\uff1a cat <<EOF > pod.yaml apiVersion: v1 kind: List items: - kind: Pod apiVersion: v1 metadata: name: prod-db-client-pod labels: name: prod-db-client spec: volumes: - name: secret-volume secret: secretName: prod-db-secret containers: - name: db-client-container image: myClientImage volumeMounts: - name: secret-volume readOnly: true mountPath: \"/etc/secret-volume\" - kind: Pod apiVersion: v1 metadata: name: test-db-client-pod labels: name: test-db-client spec: volumes: - name: secret-volume secret: secretName: test-db-secret containers: - name: db-client-container image: myClientImage volumeMounts: - name: secret-volume readOnly: true mountPath: \"/etc/secret-volume\" EOF \u5c07 Pod \u6dfb\u52a0\u5230\u540c\u4e00 kustomization.yaml \u6587\u4ef6\u4e2d\uff1a cat <<EOF >> kustomization.yaml resources: - pod.yaml EOF \u901a\u904e\u4e0b\u9762\u7684\u547d\u4ee4\u5728 API \u670d\u52d9\u5668\u4e0a\u61c9\u7528\u6240\u6709\u9019\u4e9b\u5c0d\u8c61\uff1a kubectl apply -k . \u5169\u500b\u6587\u4ef6\u90fd\u6703\u5728\u5176\u6587\u4ef6\u7cfb\u7d71\u4e2d\u51fa\u73fe\u4e0b\u9762\u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u4e2d\u5167\u5bb9\u662f\u5404\u500b\u5bb9\u5668\u7684\u74b0\u5883\u503c\uff1a /etc/secret-volume/username /etc/secret-volume/password \u6ce8\u610f\u9019\u5169\u500b Pod \u7684\u898f\u7d04\u4e2d\u53ea\u6709\u4e00\u500b\u5b57\u6bb5\u4e0d\u540c\u3002\u9019\u4fbf\u65bc\u57fa\u65bc\u76f8\u540c\u7684 Pod \u6a21\u677f\u751f\u6210\u5177\u6709\u4e0d\u540c\u80fd\u529b\u7684 Pod\u3002 \u4f60\u53ef\u4ee5\u901a\u904e\u4f7f\u7528\u5169\u500b\u670d\u52d9\u8cec\u865f\u4f86\u9032\u4e00\u6b65\u7c21\u5316\u9019\u4e00\u57fa\u672c\u7684 Pod \u898f\u7d04\uff1a prod-user \u670d\u52d9\u8cec\u865f\u4f7f\u7528 prod-db-secret test-user \u670d\u52d9\u8cec\u865f\u4f7f\u7528 test-db-secret Pod \u898f\u7d04\u7c21\u5316\u70ba\uff1a apiVersion : v1 kind : Pod metadata : name : prod-db-client-pod labels : name : prod-db-client spec : serviceAccount : prod-db-client containers : - name : db-client-container image : myClientImage \u4f7f\u7528\u5834\u666f\uff1a\u5728 Secret \u5377\u4e2d\u5e36\u53e5\u9ede\u7684\u6587\u4ef6 \u00b6 \u901a\u904e\u5b9a\u7fa9\u4ee5\u53e5\u9ede\uff08.\uff09\u958b\u982d\u7684\u4e3b\u9375\uff0c\u4f60\u53ef\u4ee5\u201c\u96b1\u85cf\u201d\u4f60\u7684\u6578\u64da\u3002\u9019\u4e9b\u4e3b\u9375\u4ee3\u8868\u7684\u662f\u4ee5\u53e5\u9ede\u958b\u982d\u7684\u6587\u4ef6\u6216\u201c\u96b1\u85cf\u201d\u6587\u4ef6\u3002\u4f8b\u5982\uff0c\u7576\u4e0b\u9762\u7684 Secret \u88ab\u639b\u8f09\u5230 secret-volume \u5377\u4e2d\u6642\uff1a apiVersion : v1 kind : Secret metadata : name : dotfile-secret data : .secret-file : dmFsdWUtMg0KDQo= --- apiVersion : v1 kind : Pod metadata : name : secret-dotfiles-pod spec : volumes : - name : secret-volume secret : secretName : dotfile-secret containers : - name : dotfile-test-container image : k8s.gcr.io/busybox command : - ls - \"-l\" - \"/etc/secret-volume\" volumeMounts : - name : secret-volume readOnly : true mountPath : \"/etc/secret-volume\" \u5377\u4e2d\u6703\u5305\u542b\u4e00\u500b\u540d\u70ba .secret-file \u7684\u6587\u4ef6\uff0c\u4e26\u4e14\u5bb9\u5668 dotfile-test-container \u4e2d\u6b64\u6587\u4ef6\u4f4d\u65bc\u8def\u5f91 /etc/secret-volume/.secret-file \u8655\u3002 Tip \u8aaa\u660e\uff1a \u4ee5\u53e5\u9ede\u958b\u982d\u7684\u6587\u4ef6\u6703\u5728 ls -l \u7684\u8f38\u51fa\u4e2d\u88ab\u96b1\u85cf\u8d77\u4f86\uff1b \u5217\u8209\u76ee\u9304\u5167\u5bb9\u6642\u4f60\u5fc5\u9808\u4f7f\u7528 ls -la \u624d\u80fd\u770b\u5230\u5b83\u5011\u3002 \u4f7f\u7528\u5834\u666f\uff1a\u50c5\u5c0d Pod \u4e2d\u4e00\u500b\u5bb9\u5668\u53ef\u898b\u7684 Secret \u00b6 \u8003\u616e\u4e00\u500b\u9700\u8981\u8655\u7406 HTTP \u8acb\u6c42\uff0c\u57f7\u884c\u67d0\u4e9b\u8907\u96dc\u7684\u696d\u52d9\u908f\u8f2f\uff0c\u4e4b\u5f8c\u4f7f\u7528 HMAC \u4f86\u5c0d\u67d0\u4e9b\u6d88\u606f\u9032\u884c\u7c3d\u540d\u7684\u7a0b\u5e8f\u3002\u56e0\u70ba\u9019\u4e00\u7a0b\u5e8f\u7684\u61c9\u7528\u908f\u8f2f\u5f88\u8907\u96dc\uff0c \u5176\u4e2d\u53ef\u80fd\u5305\u542b\u672a\u88ab\u6ce8\u610f\u5230\u7684\u9060\u7a0b\u670d\u52d9\u5668\u6587\u4ef6\u8b80\u53d6\u6f0f\u6d1e\uff0c \u9019\u7a2e\u6f0f\u6d1e\u53ef\u80fd\u6703\u628a\u79c1\u9470\u66b4\u9732\u7d66\u653b\u64ca\u8005\u3002 \u9019\u4e00\u7a0b\u5e8f\u53ef\u4ee5\u5206\u9694\u6210\u5169\u500b\u5bb9\u5668\u4e2d\u7684\u5169\u500b\u9032\u7a0b\uff1a\u524d\u7aef\u5bb9\u5668\u8981\u8655\u7406\u7528\u6236\u4ea4\u4e92\u548c\u696d\u52d9\u908f\u8f2f\uff0c \u4f46\u7121\u6cd5\u770b\u5230\u79c1\u9470\uff1b\u7c3d\u540d\u5bb9\u5668\u53ef\u4ee5\u770b\u5230\u79c1\u9470\uff0c\u4e26\u5c0d\u4f86\u81ea\u524d\u7aef\u7684\u7c21\u55ae\u7c3d\u540d\u8acb\u6c42\u4f5c\u51fa\u97ff\u61c9 \uff08\u4f8b\u5982\uff0c\u901a\u904e\u672c\u5730\u4e3b\u6a5f\u7db2\u7d61\uff09\u3002 \u63a1\u7528\u9019\u7a2e\u5283\u5206\u7684\u65b9\u6cd5\uff0c\u653b\u64ca\u8005\u73fe\u5728\u5fc5\u9808\u6b3a\u9a19\u61c9\u7528\u670d\u52d9\u5668\u4f86\u505a\u4e00\u4e9b\u5176\u4ed6\u64cd\u4f5c\uff0c \u800c\u9019\u4e9b\u64cd\u4f5c\u53ef\u80fd\u8981\u6bd4\u8b80\u53d6\u4e00\u500b\u6587\u4ef6\u8981\u5fa9\u96dc\u5f88\u591a\u3002 Secret \u7684\u985e\u578b \u00b6 \u5275\u5efa Secret \u6642\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Secret \u8cc7\u6e90\u7684 type \u5b57\u6bb5\uff0c\u6216\u8005\u8207\u5176\u7b49\u50f9\u7684 kubectl \u547d\u4ee4\u884c\u53c3\u6578\uff08\u5982\u679c\u6709\u7684\u8a71\uff09\u70ba\u5176\u8a2d\u7f6e\u985e\u578b\u3002 Secret \u985e\u578b\u6709\u52a9\u65bc\u5c0d Secret \u6578\u64da\u9032\u884c\u7de8\u7a0b\u8655\u7406\u3002 Kubernetes \u63d0\u4f9b\u82e5\u5e72\u7a2e\u5167\u7f6e\u7684\u985e\u578b\uff0c\u7528\u65bc\u4e00\u4e9b\u5e38\u898b\u7684\u4f7f\u7528\u5834\u666f\u3002\u91dd\u5c0d\u9019\u4e9b\u985e\u578b\uff0cKubernetes \u6240\u57f7\u884c\u7684\u5408\u6cd5\u6027\u6aa2\u67e5\u64cd\u4f5c\u4ee5\u53ca\u5c0d\u5176\u6240\u5be6\u65bd\u7684\u9650\u5236\u5404\u4e0d\u76f8\u540c\u3002 \u985e\u578b \u7528\u4f8b Opaque \u9810\u8a2d\u7684\u7684\u985e\u578b\u3002Base64 \u7de8\u78bc\u683c\u5f0f\u7684 Secret\uff0c\u7528\u4f86\u5b58\u5132\u5bc6\u78bc\u3001\u5bc6\u9470\u7b49\uff1b\u6578\u64da\u53ef\u901a\u904e base64 \u2013decode \u89e3\u78bc\u5f97\u5230\u539f\u59cb\u6578\u64da\uff0c\u6240\u4ee5\u52a0\u5bc6\u6027\u5f88\u5f31\u3002 kubernetes.io/service-account-token \u7528\u65bc\u88ab serviceaccount \u5f15\u7528\u3002 serviceaccout \u5275\u5efa\u6642 Kubernetes \u6703\u9ed8\u8a8d\u5275\u5efa\u5c0d\u61c9\u7684 secret\u3002 Pod \u5982\u679c\u4f7f\u7528\u4e86serviceaccount\uff0c\u5c0d\u61c9\u7684 secret \u6703\u81ea\u52d5\u639b\u8f09\u5230 Pod \u76ee\u9304 /run/secrets/kubernetes.io/serviceaccount \u4e2d\u3002 kubernetes.io/dockercfg ~/.dockercfg \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/dockerconfigjson ~/.docker/config.json \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/basic-auth \u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49 (Basic Auth)\u7684\u6191\u64da kubernetes.io/ssh-auth \u7528\u65bc SSH \u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da kubernetes.io/tls \u7528\u65bc TLS \u5ba2\u6236\u7aef\u6216\u8005\u670d\u52d9\u5668\u7aef\u7684\u6578\u64da bootstrap.kubernetes.io/token K8s \u7bc0\u9ede bootstrap \u4ee4\u724c\u6578\u64da \u901a\u904e\u70ba Secret \u5c0d\u8c61\u7684 type \u5b57\u6bb5\u8a2d\u7f6e\u4e00\u500b\u975e\u7a7a\u7684\u5b57\u7b26\u4e32\u503c\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5b9a\u7fa9\u4e26\u4f7f\u7528\u81ea\u5df1 Secret \u985e\u578b\uff08\u5982\u679c type \u503c\u70ba\u7a7a\u5b57\u7b26\u4e32\uff0c\u5247\u88ab\u8996\u70ba Opaque \u985e\u578b\uff09\u3002 Kubernetes \u4e26\u4e0d\u5c0d\u985e\u578b\u7684\u540d\u7a31\u4f5c\u4efb\u4f55\u9650\u5236\u3002\u4e0d\u904e\uff0c\u5982\u679c\u4f60\u8981\u4f7f\u7528\u5167\u7f6e\u985e\u578b\u4e4b\u4e00\uff0c \u5247\u4f60\u5fc5\u9808\u6eff\u8db3\u70ba\u8a72\u985e\u578b\u6240\u5b9a\u7fa9\u7684\u6240\u6709\u8981\u6c42\u3002 \u5982\u679c\u4f60\u8981\u5b9a\u7fa9\u4e00\u7a2e\u516c\u958b\u4f7f\u7528\u7684 Secret \u985e\u578b\uff0c\u8acb\u9075\u5b88 Secret \u985e\u578b\u7684\u7d04\u5b9a\u548c\u7d50\u69cb\uff0c \u5728\u985e\u578b\u540d\u7c3d\u540d\u6dfb\u52a0\u57df\u540d\uff0c\u4e26\u7528 / \u9694\u958b\u3002\u4f8b\u5982\uff1a cloud-hosting.example.net/cloud-api-credentials \u3002 Opaque Secret \u00b6 \u7576 Secret \u914d\u7f6e\u6587\u4ef6\u4e2d\u672a\u4f5c\u986f\u5f0f\u8a2d\u5b9a\u6642\uff0c\u9ed8\u8a8d\u7684 Secret \u985e\u578b\u662f Opaque\u3002\u7576\u4f60\u4f7f\u7528 kubectl \u4f86\u5275\u5efa\u4e00\u500b Secret \u6642\uff0c\u4f60\u6703\u4f7f\u7528 generic \u5b50\u547d\u4ee4\u4f86\u6a19\u660e\u8981\u5275\u5efa\u7684\u662f\u4e00\u500b Opaque \u985e\u578b Secret\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u547d\u4ee4\u6703\u5275\u5efa\u4e00\u500b\u7a7a\u7684 Opaque \u985e\u578b Secret \u5c0d\u8c61\uff1a kubectl create secret generic empty-secret kubectl get secret empty-secret \u8f38\u51fa\u985e\u4f3c\u65bc NAME TYPE DATA AGE empty-secret Opaque 0 2m6s DATA \u5217\u986f\u793a Secret \u4e2d\u4fdd\u5b58\u7684\u6578\u64da\u689d\u76ee\u500b\u6578\u3002\u5728\u9019\u500b\u4f8b\u5b50\u7a2e\uff0c 0 \u610f\u5473\u8457\u4f60\u525b\u525b\u5275\u5efa\u4e86\u4e00\u500b\u7a7a\u7684 Secret\u3002 \u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret \u00b6 \u985e\u578b\u70ba kubernetes.io/service-account-token \u7684 Secret \u7528\u4f86\u5b58\u653e\u6a19\u8b58\u67d0\u670d\u52d9\u8cec\u865f\u7684\u4ee4\u724c\u6191\u64da\u3002 \u5f9e v1.22 \u958b\u59cb\uff0c\u9019\u7a2e\u985e\u578b\u7684 Secret \u4e0d\u518d\u88ab\u7528\u4f86\u5411 Pod \u4e2d\u52a0\u8f09\u6191\u64da\u6578\u64da\uff0c \u5efa\u8b70\u901a\u904e TokenRequest API ( https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/authentication-resources/token-request-v1/ ) \u4f86\u7372\u5f97\u4ee4\u724c\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret \u5c0d\u8c61\u3002\u901a\u904e TokenRequest API \u7372\u5f97\u7684\u4ee4\u724c\u6bd4\u4fdd\u5b58\u5728 Secret \u5c0d\u50cf\u4e2d\u7684\u4ee4\u724c\u66f4\u52a0\u5b89\u5168\uff0c \u56e0\u70ba\u9019\u4e9b\u4ee4\u724c\u6709\u8457\u88ab\u9650\u5b9a\u7684\u751f\u547d\u671f\uff0c\u4e26\u4e14\u4e0d\u6703\u88ab\u5176\u4ed6 API \u5ba2\u6236\u7aef\u8b80\u53d6\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl create token \u547d\u4ee4\u8abf\u7528 TokenRequest API \u7372\u5f97\u4ee4\u724c\u3002 \u53ea\u6709\u5728\u4f60\u7121\u6cd5\u4f7f\u7528 TokenRequest API \u4f86\u7372\u53d6\u4ee4\u724c\uff0c \u4e26\u4e14\u4f60\u80fd\u5920\u63a5\u53d7\u56e0\u70ba\u5c07\u6c38\u4e0d\u904e\u671f\u7684\u4ee4\u724c\u6191\u64da\u5beb\u5165\u5230\u53ef\u8b80\u53d6\u7684 API \u5c0d\u8c61\u800c\u5e36\u4f86\u7684\u5b89\u5168\u98a8\u96aa\u6642\uff0c \u624d\u61c9\u8a72\u5275\u5efa\u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret \u5c0d\u8c61\u3002 \u4f7f\u7528\u9019\u7a2e Secret \u985e\u578b\u6642\uff0c\u4f60\u9700\u8981\u78ba\u4fdd\u5c0d\u8c61\u7684\u8a3b\u89e3 kubernetes.io/service-account-name \u88ab\u8a2d\u7f6e\u70ba\u67d0\u500b\u5df2\u6709\u7684\u670d\u52d9\u8cec\u865f\u540d\u7a31\u3002\u5982\u679c\u4f60\u540c\u6642\u8ca0\u8cac ServiceAccount \u548c Secret \u5c0d\u8c61\u7684\u5275\u5efa\uff0c\u61c9\u8a72\u5148\u5275\u5efa ServiceAccount \u5c0d\u8c61\u3002 \u7576 Secret \u5c0d\u50cf\u88ab\u5275\u5efa\u4e4b\u5f8c\uff0c\u67d0\u500b Kubernetes \u63a7\u5236\u5668\u6703\u586b\u5beb Secret \u7684\u5176\u5b83\u5b57\u6bb5\uff0c\u4f8b\u5982 kubernetes.io/service-account.uid \u8a3b\u89e3\u4ee5\u53ca data \u5b57\u6bb5\u4e2d\u7684 token \u9375\u503c\uff0c\u4f7f\u4e4b\u5305\u542b\u5be6\u969b\u7684\u4ee4\u724c\u5167\u5bb9\u3002 \u4e0b\u9762\u7684\u914d\u7f6e\u5be6\u4f8b\u8072\u660e\u4e86\u4e00\u500b\u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret\uff1a apiVersion : v1 kind : Secret metadata : name : secret-sa-sample annotations : kubernetes.io/service-account.name : \"sa-name\" type : kubernetes.io/service-account-token data : # \u4f60\u53ef\u4ee5\u50cf Opaque Secret \u4e00\u6837\u5728\u8fd9\u91cc\u6dfb\u52a0\u989d\u5916\u7684\u952e/\u503c\u5076\u5bf9 extra : YmFyCg== \u5275\u5efa\u4e86 Secret \u4e4b\u5f8c\uff0c\u7b49\u5f85 Kubernetes \u5728 data \u5b57\u6bb5\u4e2d\u586b\u5145 token \u4e3b\u9375\u3002 \u53c3\u8003 ServiceAccount \u6587\u6a94\u4e86\u89e3\u670d\u52d9\u8cec\u865f\u7684\u5de5\u4f5c\u539f\u7406\u3002\u4f60\u4e5f\u53ef\u4ee5\u67e5\u770b Pod \u8cc7\u6e90\u4e2d\u7684 automountServiceAccountToken \u548c serviceAccountName \u5b57\u6bb5\u6587\u6a94\uff0c \u9032\u4e00\u6b65\u4e86\u89e3\u5f9e Pod \u4e2d\u5f15\u7528\u670d\u52d9\u8cec\u865f\u6191\u64da\u3002 Docker \u914d\u7f6e Secret \u00b6 \u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u5169\u7a2e type \u503c\u4e4b\u4e00\u4f86\u5275\u5efa Secret\uff0c\u7528\u4ee5\u5b58\u653e\u7528\u65bc\u8a2a\u554f\u5bb9\u5668\u93e1\u50cf\u5009\u5eab\u7684\u6191\u64da\uff1a kubernetes.io/dockercfg kubernetes.io/dockerconfigjson kubernetes.io/dockercfg \u662f\u4e00\u7a2e\u4fdd\u7559\u985e\u578b\uff0c\u7528\u4f86\u5b58\u653e /.dockercfg \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\u3002\u8a72\u6587\u4ef6\u662f\u914d\u7f6e Docker \u547d\u4ee4\u884c\u7684\u4e00\u7a2e\u8001\u820a\u5f62\u5f0f\u3002\u4f7f\u7528\u6b64 Secret \u985e\u578b\u6642\uff0c\u4f60\u9700\u8981\u78ba\u4fdd Secret \u7684 data \u5b57\u6bb5\u4e2d\u5305\u542b\u540d\u70ba .dockercfg \u7684\u4e3b\u9375\uff0c\u5176\u5c0d\u61c9\u9375\u503c\u662f\u7528 base64 \u7de8\u78bc\u7684\u67d0 /.dockercfg` \u6587\u4ef6\u7684\u5167\u5bb9\u3002 \u985e\u578b kubernetes.io/dockerconfigjson \u88ab\u8a2d\u8a08\u7528\u4f86\u4fdd\u5b58 JSON \u6578\u64da\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c \u8a72 JSON \u4e5f\u9075\u5f9e ~/.docker/config.json \u6587\u4ef6\u7684\u683c\u5f0f\u898f\u5247\uff0c\u800c\u5f8c\u8005\u662f ~/.dockercfg \u7684\u65b0\u7248\u672c\u683c\u5f0f\u3002\u4f7f\u7528\u6b64 Secret \u985e\u578b\u6642\uff0cSecret \u5c0d\u8c61\u7684 data \u5b57\u6bb5\u5fc5\u9808\u5305\u542b .dockerconfigjson \u9375\uff0c\u5176\u9375\u503c\u70ba base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u5305\u542b ~/.docker/config.json \u6587\u4ef6\u7684\u5167\u5bb9\u3002 \u4e0b\u9762\u662f\u4e00\u500b kubernetes.io/dockercfg \u985e\u578b Secret \u7684\u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-dockercfg type : kubernetes.io/dockercfg data : .dockercfg : | \"<base64 encoded ~/.dockercfg file>\" \u7576\u4f60\u4f7f\u7528\u6e05\u55ae\u6587\u4ef6\u4f86\u5275\u5efa\u9019\u5169\u985e Secret \u6642\uff0cAPI \u670d\u52d9\u5668\u6703\u6aa2\u67e5 data \u5b57\u6bb5\u4e2d\u662f\u5426\u5b58\u5728\u6240\u671f\u671b\u7684\u4e3b\u9375\uff0c \u4e26\u4e14\u9a57\u8b49\u5176\u4e2d\u6240\u63d0\u4f9b\u7684\u9375\u503c\u662f\u5426\u662f\u5408\u6cd5\u7684 JSON \u6578\u64da\u3002\u4e0d\u904e\uff0cAPI \u670d\u52d9\u5668\u4e0d\u6703\u6aa2\u67e5 JSON \u6578\u64da\u672c\u8eab\u662f\u5426\u662f\u4e00\u500b\u5408\u6cd5\u7684 Docker \u914d\u7f6e\u6587\u4ef6\u5167\u5bb9\u3002 \u7576\u4f60\u6c92\u6709 Docker \u914d\u7f6e\u6587\u4ef6\uff0c\u6216\u8005\u4f60\u60f3\u4f7f\u7528 kubectl \u5275\u5efa\u4e00\u500b Secret \u4f86\u8a2a\u554f\u5bb9\u5668\u5009\u5eab\u6642\uff0c\u4f60\u53ef\u4ee5\u9019\u6a23\u505a\uff1a kubectl create secret docker-registry secret-tiger-docker \\ --docker-email = tiger@acme.example \\ --docker-username = tiger \\ --docker-password = pass1234 \\ --docker-server = my-registry.example:5000 \u4e0a\u9762\u7684\u547d\u4ee4\u5275\u5efa\u4e00\u500b\u985e\u578b\u70ba kubernetes.io/dockerconfigjson \u7684 Secret\u3002\u5982\u679c\u4f60\u5c0d .data.dockerconfigjson \u5167\u5bb9\u9032\u884c\u8f49\u5132\u4e26\u57f7\u884c base64 \u89e3\u78bc\uff1a kubectl get secret secret-tiger-docker -o jsonpath = '{.data.*}' | base64 -d \u90a3\u9ebc\u8f38\u51fa\u7b49\u50f9\u65bc\u9019\u500b JSON \u6587\u6a94\uff08\u9019\u4e5f\u662f\u4e00\u500b\u6709\u6548\u7684 Docker \u914d\u7f6e\u6587\u4ef6\uff09\uff1a { \"auths\" : { \"my-registry.example:5000\" : { \"username\" : \"tiger\" , \"password\" : \"pass1234\" , \"email\" : \"tiger@acme.example\" , \"auth\" : \"dGlnZXI6cGFzczEyMzQ=\" } } } \u57fa\u672c\u8eab\u4efd\u8a8d\u8b49 Secret \u00b6 kubernetes.io/basic-auth \u985e\u578b\u7528\u4f86\u5b58\u653e\u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49\u6240\u9700\u7684\u6191\u64da\u4fe1\u606f\u3002\u4f7f\u7528\u9019\u7a2e Secret \u985e\u578b\u6642\uff0cSecret \u7684 data \u5b57\u6bb5\u5fc5\u9808\u5305\u542b\u4ee5\u4e0b\u5169\u500b\u9375\u4e4b\u4e00\uff1a username : \u7528\u65bc\u8eab\u4efd\u8a8d\u8b49\u7684\u7528\u6236\u540d\uff1b password : \u7528\u65bc\u8eab\u4efd\u8a8d\u8b49\u7684\u5bc6\u78bc\u6216\u4ee4\u724c\u3002 \u4ee5\u4e0a\u5169\u500b\u9375\u7684\u9375\u503c\u90fd\u662f base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u3002\u7576\u7136\u4f60\u4e5f\u53ef\u4ee5\u5728\u5275\u5efa Secret \u6642\u4f7f\u7528 stringData \u5b57\u6bb5\u4f86\u63d0\u4f9b\u660e\u6587\u5f62\u5f0f\u7684\u5167\u5bb9\u3002\u4ee5\u4e0b\u6e05\u55ae\u662f\u57fa\u672c\u8eab\u4efd\u9a57\u8b49 Secret \u7684\u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-basic-auth type : kubernetes.io/basic-auth stringData : username : admin # kubernetes.io/basic-auth \u985e\u578b\u7684\u5fc5\u9700\u5b57\u6bb5 password : t0p-Secret # kubernetes.io/basic-auth \u985e\u578b\u7684\u5fc5\u9700\u5b57\u6bb5 \u63d0\u4f9b\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49\u985e\u578b\u7684 Secret \u50c5\u50c5\u662f\u51fa\u65bc\u65b9\u4fbf\u6027\u8003\u616e\u3002\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Opaque \u985e\u578b\u4f86\u4fdd\u5b58\u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da\u3002\u4e0d\u904e\uff0c\u4f7f\u7528\u9810\u5b9a\u7fa9\u7684\u3001\u516c\u958b\u7684 Secret \u985e\u578b\uff08 kubernetes.io/basic-auth \uff09 \u6709\u52a9\u65bc\u5e6b\u52a9\u5176\u4ed6\u7528\u6236\u7406\u89e3 Secret \u7684\u76ee\u7684\uff0c\u4e26\u4e14\u5c0d\u5176\u4e2d\u5b58\u5728\u7684\u4e3b\u9375\u5f62\u6210\u4e00\u7a2e\u7d04\u5b9a\u3002 API \u670d\u52d9\u5668\u6703\u6aa2\u67e5 Secret \u914d\u7f6e\u4e2d\u662f\u5426\u63d0\u4f9b\u4e86\u6240\u9700\u8981\u7684\u4e3b\u9375\u3002 SSH \u8eab\u4efd\u8a8d\u8b49 Secret \u00b6 Kubernetes \u6240\u63d0\u4f9b\u7684\u5167\u7f6e\u985e\u578b kubernetes.io/ssh-auth \u7528\u4f86\u5b58\u653e SSH \u8eab\u4efd\u8a8d\u8b49\u4e2d\u6240\u9700\u8981\u7684\u6191\u64da\u3002\u4f7f\u7528\u9019\u7a2e Secret \u985e\u578b\u6642\uff0c\u4f60\u5c31\u5fc5\u9808\u5728\u5176 data \uff08\u6216 stringData \uff09 \u5b57\u6bb5\u4e2d\u63d0\u4f9b\u4e00\u500b ssh-privatekey \u9375\u503c\u5c0d\uff0c\u4f5c\u70ba\u8981\u4f7f\u7528\u7684 SSH \u6191\u64da\u3002 \u4e0b\u9762\u7684\u6e05\u55ae\u662f\u4e00\u500b SSH \u516c\u9470/\u79c1\u9470\u8eab\u4efd\u8a8d\u8b49\u7684 Secret \u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-ssh-auth type : kubernetes.io/ssh-auth data : # \u6b64\u4f8b\u4e2d\u7684\u6578\u64da\u88ab\u622a\u65b7 ssh-privatekey : | MIIEpQIBAAKCAQEAulqb/Y ... \u63d0\u4f9b SSH \u8eab\u4efd\u8a8d\u8b49\u985e\u578b\u7684 Secret \u50c5\u50c5\u662f\u51fa\u65bc\u7528\u6236\u65b9\u4fbf\u6027\u8003\u616e\u3002\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Opaque \u985e\u578b\u4f86\u4fdd\u5b58\u7528\u65bc SSH \u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da\u3002\u4e0d\u904e\uff0c\u4f7f\u7528\u9810\u5b9a\u7fa9\u7684\u3001\u516c\u958b\u7684 Secret \u985e\u578b\uff08 kubernetes.io/ssh-auth \uff09 \u6709\u52a9\u65bc\u5176\u4ed6\u4eba\u7406\u89e3\u4f60\u7684 Secret \u7684\u7528\u9014\uff0c\u4e5f\u53ef\u4ee5\u5c31\u5176\u4e2d\u5305\u542b\u7684\u4e3b\u9375\u540d\u5f62\u6210\u7d04\u5b9a\u3002 API \u670d\u52d9\u5668\u78ba\u5be6\u6703\u6aa2\u67e5 Secret \u914d\u7f6e\u4e2d\u662f\u5426\u63d0\u4f9b\u4e86\u6240\u9700\u8981\u7684\u4e3b\u9375\u3002 TLS Secret \u00b6 Kubernetes \u63d0\u4f9b\u4e00\u7a2e\u5167\u7f6e\u7684 kubernetes.io/tls Secret \u985e\u578b\uff0c\u7528\u4f86\u5b58\u653e TLS \u5834\u5408\u901a\u5e38\u8981\u4f7f\u7528\u7684\u8b49\u66f8\u53ca\u5176\u76f8\u95dc\u5bc6\u9470\u3002 TLS Secret \u7684\u4e00\u7a2e\u5178\u578b\u7528\u6cd5\u662f\u70ba Ingress \u8cc7\u6e90\u914d\u7f6e\u50b3\u8f38\u904e\u7a0b\u4e2d\u7684\u6578\u64da\u52a0\u5bc6\uff0c\u4e0d\u904e\u4e5f\u53ef\u4ee5\u7528\u65bc\u5176\u4ed6\u8cc7\u6e90\u6216\u8005\u76f4\u63a5\u5728\u8ca0\u8f09\u4e2d\u4f7f\u7528\u3002\u7576\u4f7f\u7528\u6b64\u985e\u578b\u7684 Secret \u6642\uff0cSecret \u914d\u7f6e\u4e2d\u7684 data \uff08\u6216 stringData \uff09\u5b57\u6bb5\u5fc5\u9808\u5305\u542b tls.key \u548c tls.crt \u4e3b\u9375\uff0c\u5118\u7ba1 API \u670d\u52d9\u5668\u5be6\u969b\u4e0a\u4e26\u4e0d\u6703\u5c0d\u6bcf\u500b\u9375\u7684\u53d6\u503c\u4f5c\u9032\u4e00\u6b65\u7684\u5408\u6cd5\u6027\u6aa2\u67e5\u3002` \u4e0b\u9762\u7684 YAML \u5305\u542b\u4e00\u500b TLS Secret \u7684\u914d\u7f6e\u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-tls type : kubernetes.io/tls data : # \u6b64\u4f8b\u4e2d\u7684\u6578\u64da\u88ab\u622a\u65b7 tls.crt : | MIIC2DCCAcCgAwIBAgIBATANBgkqh ... tls.key : | MIIEpgIBAAKCAQEA7yn3bRHQ5FHMQ ... \u63d0\u4f9b TLS \u985e\u578b\u7684 Secret \u50c5\u50c5\u662f\u51fa\u65bc\u7528\u6236\u65b9\u4fbf\u6027\u8003\u616e\u3002\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Opaque \u985e\u578b\u4f86\u4fdd\u5b58\u7528\u65bc TLS \u670d\u52d9\u5668\u8207/\u6216\u5ba2\u6236\u7aef\u7684\u6191\u64da\u3002\u4e0d\u904e\uff0c\u4f7f\u7528\u5167\u7f6e\u7684 Secret \u985e\u578b\u7684\u6709\u52a9\u65bc\u5c0d\u6191\u64da\u683c\u5f0f\u9032\u884c\u6b78\u4e00\u5316\u8655\u7406\uff0c\u4e26\u4e14 API \u670d\u52d9\u5668\u78ba\u5be6\u6703\u6aa2\u67e5 Secret \u914d\u7f6e\u4e2d\u662f\u5426\u63d0\u4f9b\u4e86\u6240\u9700\u8981\u7684\u4e3b\u9375\u3002 \u7576\u4f7f\u7528 kubectl \u4f86\u5275\u5efa TLS Secret \u6642\uff0c\u4f60\u53ef\u4ee5\u50cf\u4e0b\u9762\u7684\u4f8b\u5b50\u4e00\u6a23\u4f7f\u7528 tls \u5b50\u547d\u4ee4\uff1a kubectl create secret tls my-tls-secret \\ --cert = path/to/cert/file \\ --key = path/to/key/file \u9019\u88e1\u7684\u516c\u9470/\u79c1\u9470\u5c0d\u90fd\u5fc5\u9808\u4e8b\u5148\u5df2\u5b58\u5728\u3002\u7528\u65bc --cert \u7684\u516c\u9470\u8b49\u66f8\u5fc5\u9808\u662f RFC 7468 \u4e2d 5.1 \u7bc0 \u4e2d\u6240\u898f\u5b9a\u7684 DER \u683c\u5f0f\uff0c\u4e14\u8207 --key \u6240\u7d66\u5b9a\u7684\u79c1\u9470\u5339\u914d\u3002\u79c1\u9470\u5fc5\u9808\u662f DER \u683c\u5f0f\u7684 PKCS #8 \uff08\u53c3\u898b RFC 7468 \u7b2c 11\u7bc0 \uff09\u3002 Info \u8aaa\u660e\uff1a \u985e\u578b\u70ba kubernetes.io/tls \u7684 Secret \u4e2d\u5305\u542b\u5bc6\u9470\u548c\u8b49\u66f8\u7684 DER \u6578\u64da\uff0c\u4ee5 Base64 \u683c\u5f0f\u7de8\u78bc\u3002\u5982\u679c\u4f60\u719f\u6089\u79c1\u9470\u548c\u8b49\u66f8\u7684 PEM \u683c\u5f0f\uff0cbase64 \u8207\u8a72\u683c\u5f0f\u76f8\u540c\uff0c\u53ea\u662f\u4f60\u9700\u8981\u7565\u904e PEM \u6578\u64da\u4e2d\u6240\u5305\u542b\u7684\u7b2c\u4e00\u884c\u548c\u6700\u5f8c\u4e00\u884c\u3002 \u4f8b\u5982\uff0c\u5c0d\u65bc\u8b49\u66f8\u800c\u8a00\uff0c\u4f60 \u4e0d\u8981 \u5305\u542b --------BEGIN CERTIFICATE----- \u548c -------END CERTIFICATE---- \u9019\u5169\u884c\u3002 \u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret \u00b6 \u901a\u904e\u5c07 Secret \u7684 type \u8a2d\u7f6e\u70ba bootstrap.kubernetes.io/token \u53ef\u4ee5\u5275\u5efa\u555f\u52d5\u5f15\u5c0e\u4ee4\u724c\u985e\u578b\u7684 Secret\u3002\u9019\u7a2e\u985e\u578b\u7684 Secret \u88ab\u8a2d\u8a08\u7528\u4f86\u652f\u6301\u7bc0\u9ede\u7684\u555f\u52d5\u5f15\u5c0e\u904e\u7a0b\u3002\u5176\u4e2d\u5305\u542b\u7528\u4f86\u70ba\u5468\u77e5\u7684 ConfigMap \u7c3d\u540d\u7684\u4ee4\u724c\u3002 \u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret \u901a\u5e38\u5275\u5efa\u65bc kube-system \u540d\u5b57\u7a7a\u9593\u5167\uff0c\u4e26\u4ee5 bootstrap-token-<\u4ee4\u724c ID> \u7684\u5f62\u5f0f\u547d\u540d\uff1b \u5176\u4e2d <\u4ee4\u724c ID> \u662f\u4e00\u500b\u7531 6 \u500b\u5b57\u7b26\u7d44\u6210\u7684\u5b57\u7b26\u4e32\uff0c\u7528\u4f5c\u4ee4\u724c\u7684\u6a19\u8b58\u3002 \u4ee5 Kubernetes \u6e05\u55ae\u6587\u4ef6\u7684\u5f62\u5f0f\uff0c\u67d0\u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret \u53ef\u80fd\u770b\u8d77\u4f86\u50cf\u4e0b\u9762\u9019\u6a23\uff1a apiVersion : v1 kind : Secret metadata : name : bootstrap-token-5emitj namespace : kube-system type : bootstrap.kubernetes.io/token data : auth-extra-groups : c3lzdGVtOmJvb3RzdHJhcHBlcnM6a3ViZWFkbTpkZWZhdWx0LW5vZGUtdG9rZW4= expiration : MjAyMC0wOS0xM1QwNDozOToxMFo= token-id : NWVtaXRq token-secret : a3E0Z2lodnN6emduMXAwcg== usage-bootstrap-authentication : dHJ1ZQ== usage-bootstrap-signing : dHJ1ZQ== \u555f\u52d5\u5f15\u5c0e\u4ee4\u724c\u985e\u578b\u7684 Secret \u6703\u5728 data \u5b57\u6bb5\u4e2d\u5305\u542b\u5982\u4e0b\u4e3b\u9375\uff1a token-id \uff1a\u7531 6 \u500b\u96a8\u6a5f\u5b57\u7b26\u7d44\u6210\u7684\u5b57\u7b26\u4e32\uff0c\u4f5c\u70ba\u4ee4\u724c\u7684\u6a19\u8b58\u7b26\u3002\u5fc5\u9700\u3002 token-secret \uff1a\u7531 16 \u500b\u96a8\u6a5f\u5b57\u7b26\u7d44\u6210\u7684\u5b57\u7b26\u4e32\uff0c\u5305\u542b\u5be6\u969b\u7684\u4ee4\u724c\u6a5f\u5bc6\u3002\u5fc5\u9700\u3002 description \uff1a\u4f9b\u7528\u6236\u95b1\u8b80\u7684\u5b57\u7b26\u4e32\uff0c\u63cf\u8ff0\u4ee4\u724c\u7684\u7528\u9014\u3002\u53ef\u9078\u3002 expiration \uff1a\u4e00\u500b\u4f7f\u7528 RFC3339 \u4f86\u7de8\u78bc\u7684 UTC \u7d55\u5c0d\u6642\u9593\uff0c\u7d66\u51fa\u4ee4\u724c\u8981\u904e\u671f\u7684\u6642\u9593\u3002\u53ef\u9078\u3002 usage-bootstrap-<usage> \uff1a\u5e03\u723e\u985e\u578b\u7684\u6a19\u8a8c\uff0c\u7528\u4f86\u6a19\u660e\u555f\u52d5\u5f15\u5c0e\u4ee4\u724c\u7684\u5176\u4ed6\u7528\u9014\u3002 auth-extra-groups \uff1a\u7528\u9017\u865f\u5206\u9694\u7684\u7d44\u540d\u5217\u8868\uff0c\u8eab\u4efd\u8a8d\u8b49\u6642\u9664\u88ab\u8a8d\u8b49\u70ba system:bootstrappers \u7d44\u4e4b\u5916\uff0c\u9084\u6703\u88ab\u6dfb\u52a0\u5230\u6240\u5217\u7684\u7528\u6236\u7d44\u4e2d\u3002 \u4e0a\u9762\u7684 YAML \u6587\u4ef6\u53ef\u80fd\u770b\u8d77\u4f86\u4ee4\u4eba\u8cbb\u89e3\uff0c\u56e0\u70ba\u5176\u4e2d\u7684\u6578\u503c\u5747\u70ba base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u3002\u5be6\u969b\u4e0a\uff0c\u4f60\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 YAML \u4f86\u5275\u5efa\u4e00\u500b\u4e00\u6a21\u4e00\u6a23\u7684 Secret\uff1a apiVersion : v1 kind : Secret metadata : # \u6ce8\u610f Secret \u7684\u547d\u540d\u65b9\u5f0f name : bootstrap-token-5emitj # \u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret \u901a\u5e38\u4f4d\u65bc kube-system \u540d\u5b57\u7a7a\u9593 namespace : kube-system type : bootstrap.kubernetes.io/token stringData : auth-extra-groups : \"system:bootstrappers:kubeadm:default-node-token\" expiration : \"2020-09-13T04:39:10Z\" # \u6b64\u4ee4\u724c ID \u88ab\u7528\u65bc\u751f\u6210 Secret \u540d\u7a31 token-id : \"5emitj\" token-secret : \"kq4gihvszzgn1p0r\" # \u6b64\u4ee4\u724c\u9084\u53ef\u7528\u65bc authentication \uff08\u8eab\u4efd\u8a8d\u8b49\uff09 usage-bootstrap-authentication : \"true\" # \u4e14\u53ef\u7528\u65bc signing \uff08\u8b49\u66f8\u7c64\u540d\uff09 usage-bootstrap-signing : \"true\" \u4e0d\u53ef\u66f4\u6539\u7684 Secret \u00b6 Kubernetes \u5141\u8a31\u4f60\u5c07\u7279\u5b9a\u7684 Secret\uff08\u548c ConfigMap\uff09\u6a19\u8a18\u70ba \u4e0d\u53ef\u66f4\u6539\uff08Immutable\uff09\u3002\u7981\u6b62\u66f4\u6539\u73fe\u6709 Secret \u7684\u6578\u64da\u6709\u4e0b\u5217\u597d\u8655\uff1a \u9632\u6b62\u610f\u5916\uff08\u6216\u975e\u9810\u671f\u7684\uff09\u66f4\u65b0\u5c0e\u81f4\u61c9\u7528\u7a0b\u5e8f\u4e2d\u65b7 \uff08\u5c0d\u65bc\u5927\u91cf\u4f7f\u7528 Secret \u7684\u96c6\u7fa4\u800c\u8a00\uff0c\u81f3\u5c11\u6578\u4e07\u500b\u4e0d\u540c\u7684 Secret \u4f9b Pod \u639b\u8f09\uff09\uff0c \u901a\u904e\u5c07 Secret \u6a19\u8a18\u70ba\u4e0d\u53ef\u8b8a\uff0c\u53ef\u4ee5\u6975\u5927\u964d\u4f4e kube-apiserver \u7684\u8ca0\u8f09\uff0c\u63d0\u5347\u96c6\u7fa4\u6027\u80fd\u3002 kubelet \u4e0d\u9700\u8981\u76e3\u8996\u90a3\u4e9b\u88ab\u6a19\u8a18\u70ba\u4e0d\u53ef\u66f4\u6539\u7684 Secret\u3002 \u5c07 Secret \u6a19\u8a18\u70ba\u4e0d\u53ef\u66f4\u6539 \u00b6 \u4f60\u53ef\u4ee5\u901a\u904e\u5c07 Secret \u7684 immutable \u5b57\u6bb5\u8a2d\u7f6e\u70ba true \u5275\u5efa\u4e0d\u53ef\u66f4\u6539\u7684 Secret\u3002\u4f8b\u5982\uff1a apiVersion : v1 kind : Secret metadata : ... data : ... immutable : true \u4f60\u4e5f\u53ef\u4ee5\u66f4\u6539\u73fe\u6709\u7684 Secret\uff0c\u4ee4\u5176\u4e0d\u53ef\u66f4\u6539\u3002 Info \u8aaa\u660e\uff1a \u4e00\u65e6\u4e00\u500b Secret \u6216 ConfigMap \u88ab\u6a19\u8a18\u70ba\u4e0d\u53ef\u66f4\u6539\uff0c\u64a4\u92b7\u6b64\u64cd\u4f5c\u6216\u8005\u66f4\u6539 data \u5b57\u6bb5\u7684\u5167\u5bb9\u90fd\u662f \u4e0d \u53ef\u80fd\u7684\u3002\u53ea\u80fd\u522a\u9664\u4e26\u91cd\u65b0\u5275\u5efa\u9019\u500b Secret\u3002\u73fe\u6709\u7684 Pod \u5c07\u7dad\u6301\u5c0d\u5df2\u522a\u9664 Secret \u7684\u639b\u8f09\u9ede -- \u5efa\u8b70\u91cd\u65b0\u5275\u5efa\u9019\u4e9b Pod\u3002 Secret \u7684\u4fe1\u606f\u5b89\u5168\u554f\u984c \u00b6 \u5118\u7ba1 ConfigMap \u548c Secret \u7684\u5de5\u4f5c\u65b9\u5f0f\u985e\u4f3c\uff0c\u4f46 Kubernetes \u5c0d Secret \u6709\u4e00\u4e9b\u984d\u5916\u7684\u4fdd\u8b77\u3002 Secret \u901a\u5e38\u4fdd\u5b58\u91cd\u8981\u6027\u5404\u7570\u7684\u6578\u503c\uff0c\u5176\u4e2d\u5f88\u591a\u90fd\u53ef\u80fd\u6703\u5c0e\u81f4 Kubernetes \u4e2d \uff08\u4f8b\u5982\uff0c\u670d\u52d9\u8cec\u865f\u4ee4\u724c\uff09\u6216\u5c0d\u5916\u90e8\u7cfb\u7d71\u7684\u7279\u6b0a\u63d0\u5347\u3002\u5373\u4f7f\u67d0\u4e9b\u500b\u5225\u61c9\u7528\u80fd\u5920\u63a8\u5c0e\u5b83\u671f\u671b\u4f7f\u7528\u7684 Secret \u7684\u80fd\u529b\uff0c \u540c\u4e00\u540d\u5b57\u7a7a\u9593\u4e2d\u7684\u5176\u4ed6\u61c9\u7528\u53ef\u80fd\u6703\u8b93\u9019\u7a2e\u5047\u5b9a\u4e0d\u6210\u7acb\u3002 \u53ea\u6709\u7576\u67d0\u500b\u7bc0\u9ede\u4e0a\u7684 Pod \u9700\u8981\u67d0 Secret \u6642\uff0c\u5c0d\u61c9\u7684 Secret \u624d\u6703\u88ab\u767c\u9001\u5230\u8a72\u7bc0\u9ede\u4e0a\u3002\u5982\u679c\u5c07 Secret \u639b\u8f09\u5230 Pod \u4e2d\uff0ckubelet \u6703\u5c07\u6578\u64da\u7684\u526f\u672c\u4fdd\u5b58\u5728\u5728 tmpfs \u4e2d\uff0c \u9019\u6a23\u6a5f\u5bc6\u7684\u6578\u64da\u4e0d\u6703\u88ab\u5beb\u5165\u5230\u6301\u4e45\u6027\u5b58\u5132\u4e2d\u3002\u4e00\u65e6\u4f9d\u8cf4\u65bc\u8a72 Secret \u7684 Pod \u88ab\u522a\u9664\uff0ckubelet \u6703\u522a\u9664\u4f86\u81ea\u65bc\u8a72 Secret \u7684\u6a5f\u5bc6\u6578\u64da\u7684\u672c\u5730\u526f\u672c\u3002 \u540c\u4e00\u500b Pod \u4e2d\u53ef\u80fd\u5305\u542b\u591a\u500b\u5bb9\u5668\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4f60\u6240\u5b9a\u7fa9\u7684\u5bb9\u5668\u53ea\u80fd\u8a2a\u554f\u9ed8\u8a8d ServiceAccount \u53ca\u5176\u76f8\u95dc Secret\u3002\u4f60\u5fc5\u9808\u986f\u5f0f\u5730\u5b9a\u7fa9\u74b0\u5883\u8b8a\u91cf\u6216\u8005\u5c07\u6372\u6620\u5c04\u5230\u5bb9\u5668\u4e2d\uff0c\u624d\u80fd\u70ba\u5bb9\u5668\u63d0\u4f9b\u5c0d\u5176\u4ed6 Secret \u7684\u8a2a\u554f\u3002 \u91dd\u5c0d\u540c\u4e00\u7bc0\u9ede\u4e0a\u7684\u591a\u500b Pod \u53ef\u80fd\u6709\u591a\u500b Secret\u3002\u4e0d\u904e\uff0c\u53ea\u6709\u67d0\u500b Pod \u6240\u8acb\u6c42\u7684 Secret \u624d\u6709\u53ef\u80fd\u5c0d Pod \u4e2d\u7684\u5bb9\u5668\u53ef\u898b\u3002\u56e0\u6b64\uff0c\u4e00\u500b Pod \u4e0d\u6703\u7372\u5f97\u8a2a\u554f\u5176\u4ed6 Pod \u7684 Secret \u7684\u6b0a\u9650\u3002 \u91dd\u5c0d\u958b\u767c\u4eba\u54e1\u7684\u5b89\u5168\u6027\u5efa\u8b70 \u00b6 \u61c9\u7528\u5728\u5f9e\u74b0\u5883\u8b8a\u91cf\u6216\u5377\u4e2d\u8b80\u53d6\u4e86\u6a5f\u5bc6\u4fe1\u606f\u5167\u5bb9\u4e4b\u5f8c\u4ecd\u8981\u5c0d\u5176\u9032\u884c\u4fdd\u8b77\u3002\u4f8b\u5982\uff0c \u4f60\u7684\u61c9\u7528\u61c9\u8a72\u907f\u514d\u7528\u660e\u6587\u7684\u65b9\u5f0f\u5c07 Secret \u6578\u64da\u5beb\u5165\u65e5\u8a8c\uff0c\u6216\u8005\u5c07\u5176\u50b3\u905e\u7d66\u4e0d\u53ef\u4fe1\u7684\u7b2c\u4e09\u65b9\u3002 \u5982\u679c\u4f60\u5728\u4e00\u500b Pod \u4e2d\u5b9a\u7fa9\u4e86\u591a\u500b\u5bb9\u5668\uff0c\u800c\u53ea\u6709\u4e00\u500b\u5bb9\u5668\u9700\u8981\u8a2a\u554f\u67d0 Secret\uff0c \u5b9a\u7fa9\u5377\u639b\u8f09\u6216\u74b0\u5883\u8b8a\u91cf\u914d\u7f6e\u6642\uff0c\u61c9\u78ba\u4fdd\u5176\u4ed6\u5bb9\u5668\u7121\u6cd5\u8a2a\u554f\u8a72 Secret\u3002 \u5982\u679c\u4f60\u901a\u904e\u6e05\u55ae\u4f86\u914d\u7f6e\u67d0 Secret\uff0c Secret \u6578\u64da\u4ee5 Base64 \u7684\u5f62\u5f0f\u7de8\u78bc\uff0c\u5c07\u6b64\u6587\u4ef6\u5171\u4eab\uff0c\u6216\u8005\u5c07\u5176\u6aa2\u5165\u5230\u67d0\u6e90\u78bc\u5009\u5eab\uff0c \u90fd\u610f\u5473\u8457 Secret \u5c0d\u65bc\u4efb\u4f55\u53ef\u4ee5\u8b80\u53d6\u6e05\u55ae\u7684\u4eba\u90fd\u662f\u53ef\u898b\u7684\u3002 Base64 - \u7de8\u78bc \u4e0d\u662f \u4e00\u7a2e\u52a0\u5bc6\u65b9\u6cd5\uff0c\u8207\u660e\u6587\u76f8\u6bd4\u6c92\u6709\u4efb\u4f55\u5b89\u5168\u6027\u63d0\u5347\u3002 \u90e8\u7f72\u8207 Secret API \u4ea4\u4e92\u7684\u61c9\u7528\u6642\uff0c\u4f60\u61c9\u8a72\u4f7f\u7528 RBAC \u9019\u985e \u9451\u6b0a\u7b56\u7565 \u4f86\u9650\u5236\u8a2a\u554f\u3002 \u5728 Kubernetes API \u4e2d\uff0c\u540d\u5b57\u7a7a\u9593\u5167\u5c0d Secret \u5c0d\u8c61\u7684 watch \u548c list \u8acb\u6c42\u662f\u975e\u5e38\u5f37\u5927\u7684\u80fd\u529b\u3002\u5728\u53ef\u80fd\u7684\u6642\u5019\u61c9\u8a72\u907f\u514d\u6388\u4e88\u9019\u985e\u8a2a\u554f\u6b0a\u9650\uff0c\u56e0\u70ba\u901a\u904e\u5217\u8209 Secret\uff0c \u5ba2\u6236\u7aef\u80fd\u5920\u67e5\u770b\u5c0d\u61c9\u540d\u5b57\u7a7a\u9593\u5167\u6240\u6709 Secret \u7684\u53d6\u503c\u3002 \u91dd\u5c0d\u96c6\u7fa4\u7ba1\u7406\u54e1\u7684\u5b89\u5168\u6027\u5efa\u8b70 \u00b6 \u4fdd\u7559\uff08\u4f7f\u7528 Kubernetes API\uff09\u5c0d\u96c6\u7fa4\u4e2d\u6240\u6709 Secret \u5c0d\u8c61\u57f7\u884c watch \u6216 list \u64cd\u4f5c\u7684\u80fd\u529b\uff0c \u9019\u6a23\u53ea\u6709\u7279\u6b0a\u7d1a\u6700\u9ad8\u3001\u7cfb\u7d71\u7d1a\u5225\u7684\u7d44\u4ef6\u80fd\u5920\u57f7\u884c\u9019\u985e\u64cd\u4f5c\u3002 \u5728\u90e8\u7f72\u9700\u8981\u901a\u904e Secret API \u4ea4\u4e92\u7684\u61c9\u7528\u6642\uff0c\u4f60\u61c9\u8a72\u901a\u904e\u4f7f\u7528 RBAC \u9019\u985e\u9451\u6b0a\u7b56\u7565\u4f86\u9650\u5236\u8a2a\u554f\u3002 \u5728 API \u670d\u52d9\u5668\u4e0a\uff0c\u5c0d\u8c61\uff08\u5305\u62ec Secret\uff09\u6703\u88ab\u6301\u4e45\u5316\u5230 etcd \u4e2d\uff1b \u56e0\u6b64\uff1a \u53ea\u61c9\u51c6\u8a31\u96c6\u7fa4\u7ba1\u7406\u54e1\u8a2a\u554f etcd\uff08\u5305\u62ec\u53ea\u8b80\u8a2a\u554f\uff09\uff1b \u70ba Secret \u5c0d\u8c61\u555f\u7528 \u975c\u614b\u52a0\u5bc6 \uff0c \u9019\u6a23\u9019\u4e9b Secret \u7684\u6578\u64da\u5c31\u4e0d\u6703\u4ee5\u660e\u6587\u7684\u5f62\u5f0f\u4fdd\u5b58\u5230 etcd \u4e2d\uff1b \u7576 etcd \u7684\u6301\u4e45\u5316\u5b58\u5132\u4e0d\u518d\u88ab\u4f7f\u7528\u6642\uff0c\u8acb\u8003\u616e\u5fb9\u5e95\u64e6\u9664\u5b58\u5132\u4ecb\u8cea\uff1b \u5982\u679c\u5b58\u5728\u591a\u500b etcd \u5be6\u4f8b\uff0c\u8acb\u78ba\u4fdd etcd \u4f7f\u7528 SSL/TLS \u4f86\u5b8c\u6210\u5176\u5c0d\u7b49\u901a\u4fe1\u3002","title":"Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret","text":"Secret \u662f\u4e00\u7a2e\u5305\u542b\u5c11\u91cf\u654f\u611f\u4fe1\u606f\u4f8b\u5982\u5bc6\u78bc\u3001\u4ee4\u724c\u6216\u5bc6\u9470\u7684\u5c0d\u8c61\u3002\u9019\u6a23\u7684\u4fe1\u606f\u53ef\u80fd\u6703\u88ab\u653e\u5728 Pod \u898f\u7d04\u4e2d\u6216\u8005\u93e1\u50cf\u4e2d\u3002\u4f7f\u7528 Secret \u610f\u5473\u8457\u4f60\u4e0d\u9700\u8981\u5728\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u4e2d\u5305\u542b\u6a5f\u5bc6\u6578\u64da\u3002 \u7531\u65bc\u5275\u5efa Secret \u53ef\u4ee5\u7368\u7acb\u65bc\u4f7f\u7528\u5b83\u5011\u7684 Pod\uff0c \u56e0\u6b64\u5728\u5275\u5efa\u3001\u67e5\u770b\u548c\u7de8\u8f2f Pod \u7684\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u66b4\u9732 Secret\uff08\u53ca\u5176\u6578\u64da\uff09\u7684\u98a8\u96aa\u8f03\u5c0f\u3002 Kubernetes \u548c\u5728\u96c6\u7fa4\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u4e5f\u53ef\u4ee5\u5c0d Secret \u63a1\u53d6\u984d\u5916\u7684\u9810\u9632\u63aa\u65bd\uff0c \u4f8b\u5982\u907f\u514d\u5c07\u6a5f\u5bc6\u6578\u64da\u5beb\u5165\u975e\u6613\u5931\u6027\u5b58\u5132\u3002 Secret \u985e\u4f3c\u65bc ConfigMap \u4f46\u5c08\u9580\u7528\u65bc\u4fdd\u5b58\u6a5f\u5bc6\u6578\u64da\u3002 Warning \u6ce8\u610f\uff1a \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cKubernetes Secret \u672a\u52a0\u5bc6\u5730\u5b58\u5132\u5728 API \u670d\u52d9\u5668\u7684\u5e95\u5c64\u6578\u64da\u5b58\u5132\uff08etcd\uff09\u4e2d\u3002\u4efb\u4f55\u64c1\u6709 API \u8a2a\u554f\u6b0a\u9650\u7684\u4eba\u90fd\u53ef\u4ee5\u6aa2\u7d22\u6216\u4fee\u6539 Secret\uff0c\u4efb\u4f55\u6709\u6b0a\u8a2a\u554f etcd \u7684\u4eba\u4e5f\u53ef\u4ee5\u3002\u6b64\u5916\uff0c\u4efb\u4f55\u6709\u6b0a\u9650\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa Pod \u7684\u4eba\u90fd\u53ef\u4ee5\u4f7f\u7528\u8a72\u8a2a\u554f\u6b0a\u9650\u8b80\u53d6\u8a72\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u4efb\u4f55 Secret\uff1b \u9019\u5305\u62ec\u9593\u63a5\u8a2a\u554f\uff0c\u4f8b\u5982\u5275\u5efa Deployment \u7684\u80fd\u529b\u3002 \u70ba\u4e86\u5b89\u5168\u5730\u4f7f\u7528 Secret\uff0c\u8acb\u81f3\u5c11\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u70ba Secret \u555f\u7528\u975c\u614b\u52a0\u5bc6 \uff1b \u555f\u7528\u6216\u914d\u7f6e RBAC \u898f\u5247 \u4f86\u9650\u5236\u8b80\u53d6\u548c\u5beb\u5165 Secret \u7684\u6578\u64da\uff08\u5305\u62ec\u901a\u904e\u9593\u63a5\u65b9\u5f0f\uff09\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u88ab\u51c6\u8a31\u5275\u5efa Pod \u7684\u4eba\u4e5f\u96b1\u5f0f\u5730\u88ab\u6388\u6b0a\u7372\u53d6 Secret \u5167\u5bb9\u3002 \u5728\u9069\u7576\u7684\u60c5\u6cc1\u4e0b\uff0c\u9084\u53ef\u4ee5\u4f7f\u7528 RBAC \u7b49\u6a5f\u5236\u4f86\u9650\u5236\u5141\u8a31\u54ea\u4e9b\u4e3b\u9ad4\u5275\u5efa\u65b0 Secret \u6216\u66ff\u63db\u73fe\u6709 Secret\u3002 \u53c3\u898b Secret \u7684\u4fe1\u606f\u5b89\u5168 \u4e86\u89e3\u8a73\u60c5\u3002","title":"Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_1","text":"Pod \u53ef\u4ee5\u7528\u4e09\u7a2e\u65b9\u5f0f\u4e4b\u4e00\u4f86\u4f7f\u7528 Secret\uff1a \u4f5c\u70ba\u639b\u8f09\u5230\u4e00\u500b\u6216\u591a\u500b\u5bb9\u5668\u4e0a\u7684\u6372 \u4e2d\u7684 \u6587\u4ef6 \u3002 \u4f5c\u70ba \u5bb9\u5668\u7684\u74b0\u5883\u8b8a\u91cf \u3002 \u7531 kubelet \u5728\u70ba Pod \u62c9\u53d6\u93e1\u50cf\u6642\u4f7f\u7528 \u3002 Kubernetes \u63a7\u5236\u9762\u4e5f\u4f7f\u7528 Secret\uff1b \u4f8b\u5982\uff0c \u5f15\u5c0e\u4ee4\u724c Secret \u662f\u4e00\u7a2e\u5e6b\u52a9\u81ea\u52d5\u5316\u7bc0\u9ede\u8a3b\u518a\u7684\u6a5f\u5236\u3002","title":"Secret \u7684\u4f7f\u7528"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_2","text":"\u9664\u4e86\u4f7f\u7528 Secret \u4f86\u4fdd\u8b77\u6a5f\u5bc6\u6578\u64da\uff0c\u4f60\u4e5f\u53ef\u4ee5\u9078\u64c7\u4e00\u4e9b\u66ff\u4ee3\u65b9\u6848\u3002 \u4e0b\u9762\u662f\u4e00\u4e9b\u9078\u9805\uff1a \u5982\u679c\u4f60\u7684\u96f2\u539f\u751f\u7d44\u4ef6\u9700\u8981\u57f7\u884c\u8eab\u4efd\u8a8d\u8b49\u4f86\u8a2a\u554f\u4f60\u6240\u77e5\u9053\u7684\u3001\u5728\u540c\u4e00 Kubernetes \u96c6\u7fa4\u4e2d\u904b\u884c\u7684\u53e6\u4e00\u500b\u61c9\u7528\uff0c \u4f60\u53ef\u4ee5\u4f7f\u7528 ServiceAccount \u53ca\u5176\u4ee4\u724c\u4f86\u6a19\u8b58\u4f60\u7684\u5ba2\u6236\u7aef\u8eab\u4efd\u3002 \u4f60\u53ef\u4ee5\u904b\u884c\u7684\u7b2c\u4e09\u65b9\u5de5\u5177\u4e5f\u6709\u5f88\u591a\uff0c\u9019\u4e9b\u5de5\u5177\u53ef\u4ee5\u904b\u884c\u5728\u96c6\u7fa4\u5167\u6216\u96c6\u7fa4\u5916\uff0c\u63d0\u4f9b\u6a5f\u5bc6\u6578\u64da\u7ba1\u7406\u3002\u4f8b\u5982\uff0c\u9019\u4e00\u5de5\u5177\u53ef\u80fd\u662f Pod \u901a\u904e HTTPS \u8a2a\u554f\u7684\u4e00\u500b\u670d\u52d9\uff0c\u8a72\u670d\u52d9\u5728\u5ba2\u6236\u7aef\u80fd\u5920\u6b63\u78ba\u5730\u901a\u904e\u8eab\u4efd\u8a8d\u8b49 \uff08\u4f8b\u5982\uff0c\u901a\u904e ServiceAccount \u4ee4\u724c\uff09\u6642\uff0c\u63d0\u4f9b\u6a5f\u5bc6\u6578\u64da\u5167\u5bb9\u3002 \u5c31\u8eab\u4efd\u8a8d\u8b49\u800c\u8a00\uff0c\u4f60\u53ef\u4ee5\u70ba X.509 \u8b49\u66f8\u5be6\u73fe\u4e00\u500b\u5b9a\u5236\u7684\u7c3d\u540d\u8005\uff0c\u4e26\u4f7f\u7528 CertificateSigningRequest \u4f86\u8b93\u8a72\u7c3d\u540d\u8005\u70ba\u9700\u8981\u8b49\u66f8\u7684 Pod \u767c\u653e\u8b49\u66f8\u3002 \u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b \u8a2d\u5099\u63d2\u4ef6 \u4f86\u5c07\u7bc0\u9ede\u672c\u5730\u7684\u52a0\u5bc6\u786c\u4ef6\u66b4\u9732\u7d66\u7279\u5b9a\u7684 Pod\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u5c07\u53ef\u4fe1\u4efb\u7684 Pod \u8abf\u5ea6\u5230\u63d0\u4f9b\u53ef\u4fe1\u5e73\u53f0\u6a21\u584a\uff08Trusted Platform Module\uff0cTPM\uff09\u7684\u7bc0\u9ede\u4e0a\u3002\u9019\u985e\u7bc0\u9ede\u662f\u53e6\u884c\u914d\u7f6e\u7684\u3002 \u4f60\u9084\u53ef\u4ee5\u5c07\u5982\u4e0a\u9078\u9805\u7684\u5169\u7a2e\u6216\u591a\u7a2e\u9032\u884c\u7d44\u5408\uff0c\u5305\u62ec\u76f4\u63a5\u4f7f\u7528 Secret \u5c0d\u8c61\u672c\u8eab\u4e5f\u662f\u4e00\u7a2e\u9078\u9805\u3002 \u4f8b\u5982\uff1a\u5be6\u73fe\uff08\u6216\u90e8\u7f72\uff09\u4e00\u500b operator\uff0c \u5f9e\u5916\u90e8\u670d\u52d9\u53d6\u56de\u751f\u547d\u671f\u5f88\u77ed\u7684\u6703\u8a71\u4ee4\u724c\uff0c\u4e4b\u5f8c\u57fa\u65bc\u9019\u4e9b\u751f\u547d\u671f\u5f88\u77ed\u7684\u6703\u8a71\u4ee4\u724c\u4f86\u5275\u5efa Secret\u3002\u904b\u884c\u5728\u96c6\u7fa4\u4e2d\u7684 Pod \u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u6703\u8a71\u4ee4\u724c\uff0c\u800c Operator \u5247\u78ba\u4fdd\u9019\u4e9b\u4ee4\u724c\u662f\u5408\u6cd5\u7684\u3002\u9019\u7a2e\u8cac\u6b0a\u5206\u96e2\u610f\u5473\u8457\u4f60\u53ef\u4ee5\u904b\u884c\u90a3\u4e9b\u4e0d\u4e86\u89e3\u6703\u8a71\u4ee4\u724c\u5982\u4f55\u767c\u653e\u8207\u5237\u65b0\u7684\u78ba\u5207\u6a5f\u5236\u7684 Pod\u3002","title":"Secret \u7684\u66ff\u4ee3\u65b9\u6848"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_3","text":"","title":"\u4f7f\u7528 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_4","text":"\u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u5275\u5efa Secret \u57fa\u65bc\u914d\u7f6e\u6587\u4ef6\u4f86\u5275\u5efa Secret \u4f7f\u7528 kustomize \u4f86\u5275\u5efa Secret","title":"\u5275\u5efa Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_5","text":"Secret \u5c0d\u8c61\u7684\u540d\u7a31\u5fc5\u9808\u662f\u5408\u6cd5\u7684 DNS \u5b50\u57df\u540d \u3002 \u5728\u70ba\u5275\u5efa Secret \u7de8\u5beb\u914d\u7f6e\u6587\u4ef6\u6642\uff0c\u4f60\u53ef\u4ee5\u8a2d\u7f6e data \u8207/\u6216 stringData \u5b57\u6bb5\u3002 data \u548c stringData \u5b57\u6bb5\u90fd\u662f\u53ef\u9078\u7684\u3002 data \u5b57\u6bb5\u4e2d\u6240\u6709\u9375\u503c\u90fd\u5fc5\u9808\u662f base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u3002\u5982\u679c\u4e0d\u5e0c\u671b\u57f7\u884c\u9019\u7a2e base64 \u5b57\u7b26\u4e32\u7684\u8f49\u63db\u64cd\u4f5c\uff0c\u4f60\u53ef\u4ee5\u9078\u64c7\u8a2d\u7f6e stringData \u5b57\u6bb5\uff0c\u5176\u4e2d\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u5b57\u7b26\u4e32\u4f5c\u70ba\u5176\u53d6\u503c\u3002 data \u548c stringData \u4e2d\u7684\u9375\u540d\u53ea\u80fd\u5305\u542b\u5b57\u6bcd\u3001\u6578\u5b57\u3001 - \u3001 _ \u6216 . \u5b57\u7b26\u3002 stringData \u5b57\u6bb5\u4e2d\u7684\u6240\u6709\u9375\u503c\u5c0d\u90fd\u6703\u5728\u5167\u90e8\u88ab\u5408\u4f75\u5230 data \u5b57\u6bb5\u4e2d\u3002\u5982\u679c\u67d0\u500b\u4e3b\u9375\u540c\u6642\u51fa\u73fe\u5728 data \u548c stringData \u5b57\u6bb5\u4e2d\uff0c stringData \u6240\u6307\u5b9a\u7684\u9375\u503c\u5177\u6709\u9ad8\u512a\u5148\u7d1a\u3002","title":"\u5c0d Secret \u540d\u7a31\u8207\u6578\u64da\u7684\u7d04\u675f"},{"location":"kubernetes/02-concepts/07-configuration/secret/#_1","text":"\u6bcf\u500b Secret \u7684\u5c3a\u5bf8\u6700\u591a\u70ba 1 MiB \u3002\u65bd\u52a0\u9019\u4e00\u9650\u5236\u662f\u70ba\u4e86\u907f\u514d\u7528\u6236\u5275\u5efa\u975e\u5e38\u5927\u7684 Secret\uff0c \u9032\u800c\u5c0e\u81f4 API \u670d\u52d9\u5668\u548c kubelet \u5167\u5b58\u8017\u76e1\u3002\u4e0d\u904e\u5275\u5efa\u5f88\u591a\u5c0f\u7684 Secret \u4e5f\u53ef\u80fd\u8017\u76e1\u5167\u5b58\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528\u8cc7\u6e90\u914d\u984d\u4f86\u7d04\u675f\u6bcf\u500b\u540d\u5b57\u7a7a\u9593\u4e2d Secret\uff08\u6216\u5176\u4ed6\u8cc7\u6e90\uff09\u7684\u500b\u6578\u3002","title":"\u5c3a\u5bf8\u9650\u5236"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_6","text":"\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl \u4f86\u7de8\u8f2f\u4e00\u500b\u5df2\u6709\u7684 Secret\uff1a kubectl edit secrets mysecret \u9019\u4e00\u547d\u4ee4\u6703\u555f\u52d5\u4f60\u7684\u9ed8\u8a8d\u7de8\u8f2f\u5668\uff0c\u5141\u8a31\u4f60\u66f4\u65b0 data \u5b57\u6bb5\u4e2d\u5b58\u653e\u7684 base64 \u7de8\u78bc\u7684 Secret \u503c\uff1b \u4f8b\u5982\uff1a # \u8acb\u7de8\u8f2f\u4ee5\u4e0b\u5c0d\u8c61\u3002\u4ee5 `#` \u958b\u982d\u7684\u5e7e\u884c\u5c07\u88ab\u5ffd\u7565\uff0c # \u4e14\u7a7a\u6587\u4ef6\u5c07\u653e\u68c4\u7de8\u8f2f\u3002\u5982\u679c\u4fdd\u5b58\u6b64\u6587\u4ef6\u6642\u51fa\u932f\uff0c # \u5247\u91cd\u65b0\u6253\u958b\u6b64\u6587\u4ef6\u6642\u4e5f\u6703\u6709\u76f8\u95dc\u6545\u969c\u3002 apiVersion : v1 data : username : YWRtaW4= password : MWYyZDFlMmU2N2Rm kind : Secret metadata : annotations : kubectl.kubernetes.io/last-applied-configuration : { ... } creationTimestamp : 2020-01-22T18:41:56Z name : mysecret namespace : default resourceVersion : \"164619\" uid : cfee02d6-c137-11e5-8d73-42010af00002 type : Opaque \u9019\u4e00\u793a\u4f8b\u6e05\u55ae\u5b9a\u7fa9\u4e86\u4e00\u500b Secret\uff0c\u5176 data \u5b57\u6bb5\u4e2d\u5305\u542b\u5169\u500b\u4e3b\u9375\uff1a username \u548c password \u3002\u6e05\u55ae\u4e2d\u7684\u5b57\u6bb5\u503c\u662f Base64 \u5b57\u7b26\u4e32\uff0c\u4e0d\u904e\uff0c\u7576\u4f60\u5728 Pod \u4e2d\u4f7f\u7528 Secret \u6642\uff0ckubelet \u70ba Pod \u53ca\u5176\u4e2d\u7684\u5bb9\u5668\u63d0\u4f9b\u7684\u662f \u89e3\u78bc \u5f8c\u7684\u6578\u64da\u3002 \u4f60\u53ef\u4ee5\u5728\u4e00\u500b Secret \u4e2d\u6253\u5305\u591a\u500b\u4e3b\u9375\u548c\u6578\u503c\uff0c\u4e5f\u53ef\u4ee5\u9078\u64c7\u4f7f\u7528\u591a\u500b Secret\uff0c \u5b8c\u5168\u53d6\u6c7a\u65bc\u54ea\u7a2e\u65b9\u5f0f\u6700\u65b9\u4fbf\u3002","title":"\u7de8\u8f2f Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_7","text":"Secret \u53ef\u4ee5\u4ee5\u6578\u64da\u5377\u7684\u5f62\u5f0f\u639b\u8f09\uff0c\u4e5f\u53ef\u4ee5\u4f5c\u70ba\u74b0\u5883\u8b8a\u91cf \u66b4\u9732\u7d66 Pod \u4e2d\u7684\u5bb9\u5668\u4f7f\u7528\u3002 Secret \u4e5f\u53ef\u7528\u65bc\u7cfb\u7d71\u4e2d\u7684\u5176\u4ed6\u90e8\u5206\uff0c\u800c\u4e0d\u662f\u4e00\u5b9a\u8981\u76f4\u63a5\u66b4\u9732\u7d66 Pod\u3002\u4f8b\u5982\uff0cSecret \u4e5f\u53ef\u4ee5\u5305\u542b\u7cfb\u7d71\u4e2d\u5176\u4ed6\u90e8\u5206\u5728\u66ff\u4f60\u8207\u5916\u90e8\u7cfb\u7d71\u4ea4\u4e92\u6642\u8981\u4f7f\u7528\u7684\u6191\u8b49\u6578\u64da\u3002 Kubernetes \u6703\u6aa2\u67e5 Secret \u7684\u6372\u6578\u64da\u6e90\uff0c\u78ba\u4fdd\u6240\u6307\u5b9a\u7684\u5c0d\u8c61\u5f15\u7528\u78ba\u5be6\u6307\u5411\u985e\u578b\u70ba Secret \u7684\u5c0d\u8c61\u3002\u56e0\u6b64\uff0c\u5982\u679c Pod \u4f9d\u8cf4\u65bc\u67d0 Secret\uff0c\u8a72 Secret \u5fc5\u9808\u5148\u65bc Pod \u88ab\u5275\u5efa\u3002 \u5982\u679c Secret \u5167\u5bb9\u7121\u6cd5\u53d6\u56de\uff08\u53ef\u80fd\u56e0\u70ba Secret \u5c1a\u4e0d\u5b58\u5728\u6216\u8005\u81e8\u6642\u6027\u5730\u51fa\u73fe API \u670d\u52d9\u5668\u7db2\u7d61\u9023\u63a5\u554f\u984c\uff09\uff0ckubelet \u6703\u5468\u671f\u6027\u5730\u91cd\u8a66 Pod \u904b\u884c\u64cd\u4f5c\u3002 kubelet \u4e5f\u6703\u70ba\u8a72 Pod \u5831\u544a Event \u4e8b\u4ef6\uff0c\u7d66\u51fa\u8b80\u53d6 Secret \u6642\u9047\u5230\u7684\u554f\u984c\u7d30\u7bc0\u3002","title":"\u4f7f\u7528 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#optional-secret","text":"\u7576\u4f60\u5b9a\u7fa9\u4e00\u500b\u57fa\u65bc Secret \u7684\u74b0\u5883\u8b8a\u91cf\u6642\uff0c\u4f60\u53ef\u4ee5\u5c07\u5176\u6a19\u8a18\u70ba\u53ef\u9078\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6240\u5f15\u7528\u7684 Secret \u90fd\u662f\u5fc5\u9700\u7684\u3002 \u53ea\u6709\u6240\u6709\u975e\u53ef\u9078\u7684 Secret \u90fd\u53ef\u7528\u6642\uff0cPod \u4e2d\u7684\u5bb9\u5668\u624d\u80fd\u555f\u52d5\u904b\u884c\u3002 \u5982\u679c Pod \u5f15\u7528\u4e86 Secret \u4e2d\u7684\u7279\u5b9a\u4e3b\u9375\uff0c\u800c\u96d6\u7136 Secret \u672c\u8eab\u5b58\u5728\uff0c\u5c0d\u61c9\u7684\u4e3b\u9375\u4e0d\u5b58\u5728\uff0c Pod \u555f\u52d5\u4e5f\u6703\u5931\u6557\u3002","title":"\u53ef\u9078\u7684(Optional) Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#pod-secret","text":"\u5982\u679c\u4f60\u5e0c\u671b\u5728 Pod \u4e2d\u8a2a\u554f Secret \u5167\u7684\u6578\u64da\uff0c\u4e00\u7a2e\u65b9\u5f0f\u662f\u8b93 Kubernetes \u5c07 Secret \u4ee5 Pod \u4e2d\u4e00\u500b\u6216\u591a\u500b\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u7684\u6587\u4ef6\u7684\u5f62\u5f0f\u5448\u73fe\u51fa\u4f86\u3002 \u8981\u914d\u7f6e\u9019\u7a2e\u884c\u70ba\uff0c\u4f60\u9700\u8981\uff1a \u5275\u5efa\u4e00\u500b Secret \u6216\u8005\u4f7f\u7528\u5df2\u6709\u7684 Secret\u3002\u591a\u500b Pod \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u500b Secret\u3002 \u66f4\u6539 Pod \u5b9a\u7fa9\uff0c\u5728 .spec.volumes[] \u4e0b\u6dfb\u52a0\u4e00\u500b\u5377\u3002\u6839\u64da\u9700\u8981\u70ba\u5377\u8a2d\u7f6e\u5176\u540d\u7a31\uff0c \u4e26\u5c07 .spec.volumes[].secret.secretName \u5b57\u6bb5\u8a2d\u7f6e\u70ba Secret \u5c0d\u8c61\u7684\u540d\u7a31\u3002 \u70ba\u6bcf\u500b\u9700\u8981\u8a72 Secret \u7684\u5bb9\u5668\u6dfb\u52a0 .spec.containers[].volumeMounts[] \u3002\u4e26\u5c07 .spec.containers[].volumeMounts[].readOnly \u8a2d\u7f6e\u70ba true \uff0c \u5c07 .spec.containers[].volumeMounts[].mountPath \u8a2d\u7f6e\u70ba\u5e0c\u671b Secret \u88ab\u653e\u7f6e\u7684\u3001\u76ee\u524d\u5c1a\u672a\u88ab\u4f7f\u7528\u7684\u8def\u5f91\u540d\u3002 \u66f4\u6539\u4f60\u7684\u93e1\u50cf\u6216\u547d\u4ee4\u884c\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u8b80\u53d6\u6240\u8a2d\u7f6e\u7684\u76ee\u9304\u4e0b\u7684\u6587\u4ef6\u3002 Secret \u7684 data \u6620\u5c04\u4e2d\u7684\u6bcf\u500b\u4e3b\u9375\u90fd\u6210\u70ba mountPath \u4e0b\u9762\u7684\u6587\u4ef6\u540d\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u901a\u904e\u5377\u4f86\u639b\u8f09\u540d\u70ba mysecret \u7684 Secret \u7684 Pod \u793a\u4f8b\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" readOnly : true volumes : - name : foo secret : secretName : mysecret optional : false # \u9ed8\u8a8d\u8a2d\u7f6e\uff0c\u610f\u5473\u8457 \"mysecret\" \u5fc5\u9808\u5df2\u7d93\u5b58\u5728 \u4f60\u8981\u8a2a\u554f\u7684\u6bcf\u500b Secret \u90fd\u9700\u8981\u901a\u904e .spec.volumes \u4f86\u5f15\u7528\u3002 \u5982\u679c Pod \u4e2d\u5305\u542b\u591a\u500b\u5bb9\u5668\uff0c\u5247\u6bcf\u500b\u5bb9\u5668\u9700\u8981\u81ea\u5df1\u7684 volumeMounts \u584a\uff0c \u4e0d\u904e\u91dd\u5c0d\u6bcf\u500b Secret \u800c\u8a00\uff0c\u53ea\u9700\u8981\u4e00\u4efd .spec.volumes \u8a2d\u7f6e\u3002 Info \u8aaa\u660e\uff1a Kubernetes v1.22 \u7248\u672c\u4e4b\u524d\u90fd\u6703\u81ea\u52d5\u5275\u5efa\u7528\u4f86\u8a2a\u554f Kubernetes API \u7684\u6191\u8b49\u3002\u9019\u4e00\u8001\u7684\u6a5f\u5236\u662f\u57fa\u65bc\u5275\u5efa\u53ef\u88ab\u639b\u8f09\u5230 Pod \u4e2d\u7684\u4ee4\u724c Secret \u4f86\u5be6\u73fe\u7684\u3002\u5728\u6700\u8fd1\u7684\u7248\u672c\u4e2d\uff0c\u5305\u62ec Kubernetes v1.24 \u4e2d\uff0cAPI \u6191\u64da\u662f\u76f4\u63a5\u901a\u904e TokenRequest API \u4f86\u7372\u5f97\u7684\uff0c\u9019\u4e00\u6191\u64da\u6703\u4f7f\u7528 \u6295\u5c04\u5377 \u639b\u8f09\u5230 Pod \u4e2d\u3002\u4f7f\u7528\u9019\u7a2e\u65b9\u5f0f\u7372\u5f97\u7684\u4ee4\u724c\u6709\u78ba\u5b9a\u7684\u751f\u547d\u671f\uff0c\u4e26\u4e14\u5728\u639b\u8f09\u5b83\u5011\u7684 Pod \u88ab\u522a\u9664\u6642\u81ea\u52d5\u4f5c\u5ee2\u3002 \u4f60\u4ecd\u7136\u53ef\u4ee5 \u624b\u52d5\u5275\u5efa \u670d\u52d9\u8cec\u865f\u4ee4\u724c\u3002\u4f8b\u5982\uff0c\u7576\u4f60\u9700\u8981\u4e00\u500b\u6c38\u9060\u90fd\u4e0d\u904e\u671f\u7684\u4ee4\u724c\u6642\u3002\u4e0d\u904e\uff0c\u4ecd\u7136\u5efa\u8b70\u4f7f\u7528 TokenRequest \u5b50\u8cc7\u6e90\u4f86\u7372\u5f97\u8a2a\u554f API \u670d\u52d9\u5668\u7684\u4ee4\u724c\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl create token \u547d\u4ee4\u8abf\u7528 TokenRequest API \u7372\u5f97\u4ee4\u724c\u3002","title":"\u5728 Pod \u4e2d\u4ee5\u6587\u4ef6\u5f62\u5f0f\u4f7f\u7528 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_8","text":"\u4f60\u4e5f\u53ef\u4ee5\u63a7\u5236 Secret \u9375\u6240\u6295\u5c04\u5230\u7684\u5377\u4e2d\u7684\u8def\u5f91\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 .spec.volumes[].secret.items \u5b57\u6bb5\u4f86\u66f4\u6539\u6bcf\u500b\u4e3b\u9375\u7684\u76ee\u6a19\u8def\u5f91\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" readOnly : true volumes : - name : foo secret : secretName : mysecret items : - key : username path : my-group/my-username \u5c07\u767c\u751f\u7684\u4e8b\u60c5\u5982\u4e0b\uff1a mysecret \u4e2d\u7684\u9375 username \u6703\u51fa\u73fe\u5728\u5bb9\u5668\u4e2d\u7684\u8def\u5f91\u70ba /etc/foo/my-group/my-username \uff0c \u800c\u4e0d\u662f /etc/foo/username \u3002 Secret \u5c0d\u8c61\u7684 password \u9375\u4e0d\u6703\u88ab\u6295\u5c04\u3002 \u5982\u679c\u4f7f\u7528\u4e86 .spec.volumes[].secret.items \uff0c\u5247\u53ea\u6709 items \u4e2d\u6307\u5b9a\u4e86\u7684\u4e3b\u9375\u6703\u88ab\u6295\u5c04\u3002\u5982\u679c\u8981\u4f7f\u7528 Secret \u4e2d\u7684\u6240\u6709\u4e3b\u9375\uff0c\u5247\u9700\u8981\u5c07\u5b83\u5011\u5168\u90e8\u679a\u8209\u5230 items \u5b57\u6bb5\u4e2d\u3002 \u5982\u679c\u4f60\u986f\u5f0f\u5730\u5217\u8209\u4e86\u4e3b\u9375\uff0c\u5247\u6240\u5217\u8209\u7684\u4e3b\u9375\u90fd\u5fc5\u9808\u5728\u5c0d\u61c9\u7684 Secret \u4e2d\u5b58\u5728\u3002\u5426\u5247\u6240\u5728\u7684\u5377\u4e0d\u6703\u88ab\u5275\u5efa\u3002","title":"\u5c07 Secret \u9375\u6295\u5c04\u5230\u7279\u5b9a\u76ee\u9304"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_9","text":"\u4f60\u53ef\u4ee5\u70ba\u67d0\u500b Secret \u4e3b\u9375\u8a2d\u7f6e POSIX \u6587\u4ef6\u8a2a\u554f\u6b0a\u9650\u4f4d\u3002\u5982\u679c\u4f60\u4e0d\u6307\u5b9a\u8a2a\u554f\u6b0a\u9650\uff0c\u9ed8\u8a8d\u6703\u4f7f\u7528 0644\u3002\u4f60\u4e5f\u53ef\u4ee5\u70ba\u6574\u500b Secret \u5377\u8a2d\u7f6e\u9ed8\u8a8d\u7684\u8a2a\u554f\u6a21\u5f0f\uff0c\u7136\u5f8c\u518d\u6839\u64da\u9700\u8981\u5728\u4e3b\u9375\u5c64\u9762\u91cd\u8f09\u3002 \u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u50cf\u4e0b\u9762\u9019\u6a23\u8a2d\u7f6e\u9ed8\u8a8d\u7684\u6a21\u5f0f\uff1a apiVersion : v1 kind : Pod metadata : name : mypod spec : containers : - name : mypod image : redis volumeMounts : - name : foo mountPath : \"/etc/foo\" volumes : - name : foo secret : secretName : mysecret defaultMode : 0400 \u8a72 Secret \u88ab\u639b\u8f09\u5728 /etc/foo \u4e0b\uff0cSecret \u5377\u639b\u8f09\u6240\u5275\u5efa\u7684\u6240\u6709\u6587\u4ef6\u7684\u8a2a\u554f\u6a21\u5f0f\u90fd\u662f 0400\u3002","title":"Secret \u6587\u4ef6\u7684\u8a2a\u554f\u6b0a\u9650"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_10","text":"\u5728\u639b\u8f09\u4e86 Secret \u5377\u7684\u5bb9\u5668\u5167\uff0cSecret \u7684\u4e3b\u9375\u90fd\u5448\u73fe\u70ba\u6587\u4ef6\u3002 Secret \u7684\u53d6\u503c\u90fd\u662f Base64 \u7de8\u78bc\u7684\uff0c\u4fdd\u5b58\u5728\u9019\u4e9b\u6587\u4ef6\u4e2d\u3002 \u4e0b\u9762\u662f\u5728\u4e0a\u4f8b\u4e2d\u7684\u5bb9\u5668\u5167\u57f7\u884c\u547d\u4ee4\u7684\u7d50\u679c\uff1a ls /etc/foo/ \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a username password cat /etc/foo/username \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a admin cat /etc/foo/password \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a 1f2d1e2e67df \u5bb9\u5668\u4e2d\u7684\u7a0b\u5e8f\u8981\u8ca0\u8cac\u6839\u64da\u9700\u8981\u8b80\u53d6 Secret \u6578\u64da\u3002","title":"\u4f7f\u7528\u4f86\u81ea\u5377\u4e2d\u7684 Secret \u503c"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_11","text":"\u7576\u5377\u4e2d\u5305\u542b\u4f86\u81ea Secret \u7684\u6578\u64da\uff0c\u800c\u5c0d\u61c9\u7684 Secret \u88ab\u66f4\u65b0\uff0cKubernetes \u6703\u8ddf\u8e2a\u5230\u9019\u4e00\u64cd\u4f5c\u4e26\u66f4\u65b0\u5377\u4e2d\u7684\u6578\u64da\u3002\u66f4\u65b0\u7684\u65b9\u5f0f\u662f\u4fdd\u8b49\u6700\u7d42\u4e00\u81f4\u6027\u3002 Info \u8aaa\u660e\uff1a \u5c0d\u65bc\u4ee5 subPath \u5f62\u5f0f\u639b\u8f09 Secret \u5377\u7684\u5bb9\u5668\u800c\u8a00\uff0c \u5b83\u5011\u7121\u6cd5\u6536\u5230\u81ea\u52d5\u7684 Secret \u66f4\u65b0\u3002 Kubelet \u7d44\u4ef6\u6703\u7dad\u8b77\u4e00\u500b\u7de9\u5b58\uff0c\u5728\u5176\u4e2d\u4fdd\u5b58\u7bc0\u9ede\u4e0a Pod \u5377\u4e2d\u4f7f\u7528\u7684 Secret \u7684\u7576\u524d\u4e3b\u9375\u548c\u53d6\u503c\u3002\u4f60\u53ef\u4ee5\u914d\u7f6e kubelet \u5982\u4f55\u6aa2\u6e2c\u6240\u7de9\u5b58\u6578\u503c\u7684\u8b8a\u5316\u3002 kubelet \u914d\u7f6e\u4e2d\u7684 configMapAndSecretChangeDetectionStrategy \u5b57\u6bb5\u63a7\u5236 kubelet \u6240\u63a1\u7528\u7684\u7b56\u7565\u3002\u9ed8\u8a8d\u7684\u7b56\u7565\u662f Watch\u3002 \u5c0d Secret \u7684\u66f4\u65b0\u64cd\u4f5c\u65e2\u53ef\u4ee5\u901a\u904e API \u7684 watch \u6a5f\u5236\uff08\u9ed8\u8a8d\uff09\u4f86\u50b3\u64ad\uff0c \u57fa\u65bc\u8a2d\u7f6e\u4e86\u751f\u547d\u671f\u7684\u7de9\u5b58\u7372\u53d6\uff0c\u4e5f\u53ef\u4ee5\u901a\u904e kubelet \u7684\u540c\u6b65\u8ff4\u8def\u4f86\u5f9e\u96c6\u7fa4\u7684 API \u670d\u52d9\u5668\u4e0a\u8f2a\u8a62\u7372\u53d6\u3002 \u56e0\u6b64\uff0c\u5f9e Secret \u88ab\u66f4\u65b0\u5230\u65b0\u7684\u4e3b\u9375\u88ab\u6295\u5c04\u5230 Pod \u4e2d\uff0c\u4e2d\u9593\u5b58\u5728\u4e00\u500b\u5ef6\u9072\u3002\u9019\u4e00\u5ef6\u9072\u7684\u4e0a\u9650\u662f kubelet \u7684\u540c\u6b65\u9031\u671f\u52a0\u4e0a\u7de9\u5b58\u7684\u50b3\u64ad\u5ef6\u9072\uff0c \u5176\u4e2d\u7de9\u5b58\u7684\u50b3\u64ad\u5ef6\u9072\u53d6\u6c7a\u65bc\u6240\u9078\u64c7\u7684\u7de9\u5b58\u985e\u578b\u3002\u5c0d\u61c9\u4e0a\u4e00\u6bb5\u4e2d\u63d0\u5230\u7684\u5e7e\u7a2e\u50b3\u64ad\u6a5f\u5236\uff0c\u5ef6\u9072\u6642\u9577\u70ba watch \u7684\u50b3\u64ad\u5ef6\u9072\u3001\u6240\u914d\u7f6e\u7684\u7de9\u5b58 TTL \u6216\u8005\u5c0d\u65bc\u76f4\u63a5\u8f2a\u8a62\u800c\u8a00\u662f\u96f6\u3002","title":"\u639b\u8f09\u7684 Secret \u662f\u88ab\u81ea\u52d5\u66f4\u65b0\u7684"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_12","text":"\u5982\u679c\u9700\u8981\u5728 Pod \u4e2d\u4ee5\u74b0\u5883\u8b8a\u91cf \u7684\u5f62\u5f0f\u4f7f\u7528 Secret\uff1a \u5275\u5efa Secret\uff08\u6216\u8005\u4f7f\u7528\u73fe\u6709 Secret\uff09\u3002\u591a\u500b Pod \u53ef\u4ee5\u5f15\u7528\u540c\u4e00\u500b Secret\u3002 \u66f4\u6539 Pod \u5b9a\u7fa9\uff0c\u5728\u8981\u4f7f\u7528 Secret \u9375\u503c\u7684\u6bcf\u500b\u5bb9\u5668\u4e2d\u6dfb\u52a0\u8207\u6240\u4f7f\u7528\u7684\u4e3b\u9375\u5c0d\u61c9\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u8b80\u53d6 Secret \u4e3b\u9375\u7684\u74b0\u5883\u8b8a\u91cf\u61c9\u8a72\u5728 env[].valueFrom.secretKeyRef \u4e2d\u586b\u5beb Secret \u7684\u540d\u7a31\u548c\u4e3b\u9375\u540d\u7a31\u3002 \u66f4\u6539\u4f60\u7684\u93e1\u50cf\u6216\u547d\u4ee4\u884c\uff0c\u4ee5\u4fbf\u7a0b\u5e8f\u8b80\u53d6\u74b0\u5883\u8b8a\u91cf\u4e2d\u4fdd\u5b58\u7684\u503c\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f86\u4f7f\u7528 Secret \u7684\u793a\u4f8b Pod\uff1a apiVersion : v1 kind : Pod metadata : name : secret-env-pod spec : containers : - name : mycontainer image : redis env : - name : SECRET_USERNAME valueFrom : secretKeyRef : name : mysecret key : username optional : false # \u6b64\u503c\u70ba\u9ed8\u8a8d\u503c\uff1b\u610f\u5473\u8457 \"mysecret\" # \u5fc5\u9808\u5b58\u5728\u4e14\u5305\u542b\u540d\u70ba \"username\" \u7684\u4e3b\u9375 - name : SECRET_PASSWORD valueFrom : secretKeyRef : name : mysecret key : password optional : false # \u6b64\u503c\u70ba\u9ed8\u8a8d\u503c\uff1b\u610f\u5473\u8457 \"mysecret\" # \u5fc5\u9808\u5b58\u5728\u4e14\u5305\u542b\u540d\u70ba \"username\" \u7684\u4e3b\u9375 restartPolicy : Never","title":"\u4ee5\u74b0\u5883\u8b8a\u91cf\u7684\u65b9\u5f0f\u4f7f\u7528 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#_2","text":"\u5c0d\u65bc\u901a\u904e envFrom \u5b57\u6bb5\u4f86\u586b\u5145\u74b0\u5883\u8b8a\u91cf\u7684 Secret \u800c\u8a00\uff0c \u5982\u679c\u5176\u4e2d\u5305\u542b\u7684\u4e3b\u9375\u4e0d\u80fd\u88ab\u7576\u505a\u5408\u6cd5\u7684\u74b0\u5883\u8b8a\u91cf\u540d\uff0c\u9019\u4e9b\u4e3b\u9375\u6703\u88ab\u5ffd\u7565\u6389\u3002 Pod \u4ecd\u7136\u53ef\u4ee5\u555f\u52d5\u3002 \u5982\u679c\u4f60\u5b9a\u7fa9\u7684 Pod \u4e2d\u5305\u542b\u975e\u6cd5\u7684\u8b8a\u91cf\u540d\u7a31\uff0c\u5247 Pod \u53ef\u80fd\u555f\u52d5\u5931\u6557\uff0c \u6703\u5f62\u6210 reason \u70ba InvalidVariableNames \u7684\u4e8b\u4ef6\uff0c\u4ee5\u53ca\u5217\u8209\u88ab\u7565\u904e\u7684\u975e\u6cd5\u4e3b\u9375\u7684\u6d88\u606f\u3002\u4e0b\u9762\u7684\u4f8b\u5b50\u4e2d\u5c55\u793a\u4e86\u4e00\u500b Pod\uff0c\u5f15\u7528\u7684\u662f\u540d\u70ba mysecret \u7684 Secret\uff0c \u5176\u4e2d\u5305\u542b\u5169\u500b\u975e\u6cd5\u7684\u4e3b\u9375\uff1a 1badkey \u548c 2alsobad \u3002 kubectl get events \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a LASTSEEN FIRSTSEEN COUNT NAME KIND SUBOBJECT TYPE REASON 0s 0s 1 dapi-test-pod Pod Warning InvalidEnvironmentVariableNames kubelet, 127.0.0.1 Keys [1badkey, 2alsobad] from the EnvFrom secret default/mysecret were skipped since they are considered invalid environment variable names.","title":"\u975e\u6cd5\u74b0\u5883\u8b8a\u91cf"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_13","text":"\u5728\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f86\u4f7f\u7528 Secret \u7684\u5bb9\u5668\u4e2d\uff0cSecret \u4e3b\u9375\u5c55\u73fe\u70ba\u666e\u901a\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u9019\u4e9b\u8b8a\u91cf\u7684\u53d6\u503c\u662f Secret \u6578\u64da\u7684 Base64 \u89e3\u78bc\u503c\u3002 \u4e0b\u9762\u662f\u5728\u524d\u6587\u793a\u4f8b\u4e2d\u7684\u5bb9\u5668\u5167\u57f7\u884c\u547d\u4ee4\u7684\u7d50\u679c\uff1a echo \" $SECRET_USERNAME \" \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a admin echo \" $SECRET_PASSWORD \" \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a 1f2d1e2e67df Info \u8aaa\u660e\uff1a \u5982\u679c\u5bb9\u5668\u5df2\u7d93\u5728\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f86\u4f7f\u7528 Secret\uff0cSecret \u66f4\u65b0\u5728\u5bb9\u5668\u5167\u662f\u770b\u4e0d\u5230\u7684\uff0c \u9664\u975e\u5bb9\u5668\u88ab\u91cd\u555f\u3002\u6709\u4e00\u4e9b\u7b2c\u4e09\u65b9\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u80fd\u5920\u5728 Secret \u767c\u751f\u8b8a\u5316\u6642\u89f8\u767c\u5bb9\u5668\u91cd\u555f\u3002","title":"\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u4f7f\u7528 Secret \u503c"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_14","text":"\u5982\u679c\u4f60\u5617\u8a66\u5f9e\u79c1\u6709\u5009\u5eab\u62c9\u53d6\u5bb9\u5668\u93e1\u50cf\uff0c\u4f60\u9700\u8981\u4e00\u7a2e\u65b9\u5f0f\u8b93\u6bcf\u500b\u7bc0\u9ede\u4e0a\u7684 kubelet \u80fd\u5920\u5b8c\u6210\u8207\u93e1\u50cf\u5eab\u7684\u8eab\u4efd\u8a8d\u8b49\u3002\u4f60\u53ef\u4ee5\u914d\u7f6e \u93e1\u50cf\u62c9\u53d6 Secret \u4f86\u5be6\u73fe\u9019\u9ede\u3002 Secret \u662f\u5728 Pod \u5c64\u9762\u4f86\u914d\u7f6e\u7684\u3002 Pod \u7684 imagePullSecrets \u5b57\u6bb5\u662f\u4e00\u500b\u5c0d Pod \u6240\u5728\u7684\u540d\u5b57\u7a7a\u9593\u4e2d\u7684 Secret \u7684\u5f15\u7528\u5217\u8868\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 imagePullSecrets \u4f86\u5c07\u93e1\u50cf\u5009\u5eab\u8a2a\u554f\u6191\u64da\u50b3\u905e\u7d66 kubelet\u3002 kubelet \u4f7f\u7528\u9019\u500b\u4fe1\u606f\u4f86\u66ff\u4f60\u7684 Pod \u62c9\u53d6\u79c1\u6709\u93e1\u50cf\u3002\u53c3\u95b1 Pod API \u53c3\u8003 \u4e2d\u7684 PodSpec \u9032\u4e00\u6b65\u4e86\u89e3 imagePullSecrets \u5b57\u6bb5\u3002 \u4f7f\u7528 imagePullSecrets imagePullSecrets \u5b57\u6bb5\u662f\u4e00\u500b\u5217\u8868\uff0c\u5305\u542b\u5c0d\u540c\u4e00\u540d\u5b57\u7a7a\u9593\u4e2d Secret \u7684\u5f15\u7528\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 imagePullSecrets \u5c07\u5305\u542b Docker\uff08\u6216\u5176\u4ed6\uff09\u93e1\u50cf\u5009\u5eab\u5bc6\u78bc\u7684 Secret \u50b3\u905e\u7d66 kubelet\u3002 kubelet \u4f7f\u7528\u6b64\u4fe1\u606f\u4f86\u66ff Pod \u62c9\u53d6\u79c1\u6709\u93e1\u50cf\u3002\u53c3\u95b1 PodSpec API \u9032\u4e00\u6b65\u4e86\u89e3 imagePullSecrets \u5b57\u6bb5\u3002 \u624b\u52d5\u8a2d\u5b9a imagePullSecret \u4f60\u53ef\u4ee5\u901a\u904e\u95b1\u8b80 \u5bb9\u5668\u93e1\u50cf \u6587\u6a94\u4e86\u89e3\u5982\u4f55\u8a2d\u7f6e imagePullSecrets \u3002 \u8a2d\u7f6e imagePullSecrets \u70ba\u81ea\u52d5\u639b\u8f09 \u4f60\u53ef\u4ee5\u624b\u52d5\u5275\u5efa imagePullSecret \uff0c\u4e26\u5728\u4e00\u500b ServiceAccount \u4e2d\u5f15\u7528\u5b83\u3002\u5c0d\u4f7f\u7528\u8a72 ServiceAccount \u5275\u5efa\u7684\u6240\u6709 Pod\uff0c\u6216\u8005\u9ed8\u8a8d\u4f7f\u7528\u8a72 ServiceAccount \u5275\u5efa\u7684 Pod \u800c\u8a00\uff0c\u5176 imagePullSecrets \u5b57\u6bb5\u90fd\u6703\u8a2d\u7f6e\u70ba\u8a72\u670d\u52d9\u8cec\u865f\u3002\u8acb\u95b1\u8b80 \u5411\u670d\u52d9\u8cec\u865f\u6dfb\u52a0 ImagePullSecrets \u4f86\u8a73\u7d30\u4e86\u89e3\u9019\u4e00\u904e\u7a0b\u3002","title":"\u5bb9\u5668\u93e1\u50cf\u62c9\u53d6 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#pod-secret_1","text":"\u4f60\u4e0d\u53ef\u4ee5\u5728\u975c\u614b Pod \u4e2d\u4f7f\u7528 ConfigMap \u6216 Secret\u3002","title":"\u5728\u975c\u614b Pod \u4e2d\u4f7f\u7528 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#_3","text":"","title":"\u4f7f\u7528\u5834\u666f"},{"location":"kubernetes/02-concepts/07-configuration/secret/#_4","text":"\u5275\u5efa Secret\uff1a mysecret.yaml apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : USER_NAME : YWRtaW4= PASSWORD : MWYyZDFlMmU2N2Rm kubectl apply -f mysecret.yaml \u4f7f\u7528 envFrom \u4f86\u5c07 Secret \u7684\u6240\u6709\u6578\u64da\u5b9a\u7fa9\u70ba\u5bb9\u5668\u7684\u74b0\u5883\u8b8a\u91cf\u3002\u4f86\u81ea Secret \u7684\u4e3b\u9375\u6210\u70ba Pod \u4e2d\u7684\u74b0\u5883\u8b8a\u91cf\u540d\u7a31\uff1a apiVersion : v1 kind : Pod metadata : name : secret-test-pod spec : containers : - name : test-container image : k8s.gcr.io/busybox command : [ \"/bin/sh\" , \"-c\" , \"env\" ] envFrom : - secretRef : name : mysecret restartPolicy : Never","title":"\u4f7f\u7528\u5834\u666f\uff1a\u4f5c\u70ba\u5bb9\u5668\u74b0\u5883\u8b8a\u91cf"},{"location":"kubernetes/02-concepts/07-configuration/secret/#ssh-pod","text":"\u5275\u5efa\u5305\u542b\u4e00\u4e9b SSH \u5bc6\u9470\u7684 Secret\uff1a kubectl create secret generic ssh-key-secret --from-file = ssh-privatekey = /path/to/.ssh/id_rsa --from-file = ssh-publickey = /path/to/.ssh/id_rsa.pub \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a secret \"ssh-key-secret\" created \u4f60\u4e5f\u53ef\u4ee5\u5275\u5efa\u4e00\u500b kustomization.yaml \u6587\u4ef6\uff0c\u5728\u5176 secretGenerator \u5b57\u6bb5\u4e2d\u5305\u542b SSH \u5bc6\u9470\u3002 \u73fe\u5728\u4f60\u53ef\u4ee5\u5275\u5efa\u4e00\u500b Pod\uff0c\u5728\u5176\u4e2d\u8a2a\u554f\u5305\u542b SSH \u5bc6\u9470\u7684 Secret\uff0c\u4e26\u901a\u904e\u5377\u7684\u65b9\u5f0f\u4f86\u4f7f\u7528\u5b83\uff1a apiVersion : v1 kind : Pod metadata : name : secret-test-pod labels : name : secret-test spec : volumes : - name : secret-volume secret : secretName : ssh-key-secret containers : - name : ssh-test-container image : mySshImage volumeMounts : - name : secret-volume readOnly : true mountPath : \"/etc/secret-volume\" \u5bb9\u5668\u547d\u4ee4\u57f7\u884c\u6642\uff0c\u79d8\u9470\u7684\u6578\u64da\u53ef\u4ee5\u5728\u4e0b\u9762\u7684\u4f4d\u7f6e\u8a2a\u554f\u5230\uff1a /etc/secret-volume/ssh-publickey /etc/secret-volume/ssh-privatekey \u5bb9\u5668\u5c31\u53ef\u4ee5\u96a8\u4fbf\u4f7f\u7528 Secret \u6578\u64da\u4f86\u5efa\u7acb SSH \u9023\u63a5\u3002","title":"\u4f7f\u7528\u5834\u666f\uff1a\u5e36 SSH \u5bc6\u9470\u7684 Pod"},{"location":"kubernetes/02-concepts/07-configuration/secret/#pod","text":"\u9019\u4e00\u793a\u4f8b\u6240\u5c55\u793a\u7684\u4e00\u500b Pod \u6703\u4f7f\u7528\u5305\u542b\u751f\u7522\u74b0\u5883\u6191\u64da\u7684 Secret\uff0c\u53e6\u4e00\u500b Pod \u4f7f\u7528\u5305\u542b\u6e2c\u8a66\u74b0\u5883\u6191\u64da\u7684 Secret\u3002 \u4f60\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u5e36\u6709 secretGenerator \u5b57\u6bb5\u7684 kustomization.yaml \u6587\u4ef6\u6216\u8005\u904b\u884c kubectl create secret \u4f86\u5275\u5efa Secret\u3002 kubectl create secret generic prod-db-secret --from-literal = username = produser --from-literal = password = Y4nys7f11 \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a secret \"prod-db-secret\" created \u4f60\u4e5f\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u5305\u542b\u6e2c\u8a66\u74b0\u5883\u6191\u64da\u7684 Secret\uff1a kubectl create secret generic test-db-secret --from-literal = username = testuser --from-literal = password = iluvtests \u8f38\u51fa\u985e\u4f3c\u65bc\uff1a secret \"test-db-secret\" created \u73fe\u5728\u751f\u6210 Pod\uff1a cat <<EOF > pod.yaml apiVersion: v1 kind: List items: - kind: Pod apiVersion: v1 metadata: name: prod-db-client-pod labels: name: prod-db-client spec: volumes: - name: secret-volume secret: secretName: prod-db-secret containers: - name: db-client-container image: myClientImage volumeMounts: - name: secret-volume readOnly: true mountPath: \"/etc/secret-volume\" - kind: Pod apiVersion: v1 metadata: name: test-db-client-pod labels: name: test-db-client spec: volumes: - name: secret-volume secret: secretName: test-db-secret containers: - name: db-client-container image: myClientImage volumeMounts: - name: secret-volume readOnly: true mountPath: \"/etc/secret-volume\" EOF \u5c07 Pod \u6dfb\u52a0\u5230\u540c\u4e00 kustomization.yaml \u6587\u4ef6\u4e2d\uff1a cat <<EOF >> kustomization.yaml resources: - pod.yaml EOF \u901a\u904e\u4e0b\u9762\u7684\u547d\u4ee4\u5728 API \u670d\u52d9\u5668\u4e0a\u61c9\u7528\u6240\u6709\u9019\u4e9b\u5c0d\u8c61\uff1a kubectl apply -k . \u5169\u500b\u6587\u4ef6\u90fd\u6703\u5728\u5176\u6587\u4ef6\u7cfb\u7d71\u4e2d\u51fa\u73fe\u4e0b\u9762\u7684\u6587\u4ef6\uff0c\u6587\u4ef6\u4e2d\u5167\u5bb9\u662f\u5404\u500b\u5bb9\u5668\u7684\u74b0\u5883\u503c\uff1a /etc/secret-volume/username /etc/secret-volume/password \u6ce8\u610f\u9019\u5169\u500b Pod \u7684\u898f\u7d04\u4e2d\u53ea\u6709\u4e00\u500b\u5b57\u6bb5\u4e0d\u540c\u3002\u9019\u4fbf\u65bc\u57fa\u65bc\u76f8\u540c\u7684 Pod \u6a21\u677f\u751f\u6210\u5177\u6709\u4e0d\u540c\u80fd\u529b\u7684 Pod\u3002 \u4f60\u53ef\u4ee5\u901a\u904e\u4f7f\u7528\u5169\u500b\u670d\u52d9\u8cec\u865f\u4f86\u9032\u4e00\u6b65\u7c21\u5316\u9019\u4e00\u57fa\u672c\u7684 Pod \u898f\u7d04\uff1a prod-user \u670d\u52d9\u8cec\u865f\u4f7f\u7528 prod-db-secret test-user \u670d\u52d9\u8cec\u865f\u4f7f\u7528 test-db-secret Pod \u898f\u7d04\u7c21\u5316\u70ba\uff1a apiVersion : v1 kind : Pod metadata : name : prod-db-client-pod labels : name : prod-db-client spec : serviceAccount : prod-db-client containers : - name : db-client-container image : myClientImage","title":"\u4f7f\u7528\u5834\u666f\uff1a\u5e36\u6709\u751f\u7522\u3001\u6e2c\u8a66\u74b0\u5883\u6191\u64da\u7684 Pod"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_15","text":"\u901a\u904e\u5b9a\u7fa9\u4ee5\u53e5\u9ede\uff08.\uff09\u958b\u982d\u7684\u4e3b\u9375\uff0c\u4f60\u53ef\u4ee5\u201c\u96b1\u85cf\u201d\u4f60\u7684\u6578\u64da\u3002\u9019\u4e9b\u4e3b\u9375\u4ee3\u8868\u7684\u662f\u4ee5\u53e5\u9ede\u958b\u982d\u7684\u6587\u4ef6\u6216\u201c\u96b1\u85cf\u201d\u6587\u4ef6\u3002\u4f8b\u5982\uff0c\u7576\u4e0b\u9762\u7684 Secret \u88ab\u639b\u8f09\u5230 secret-volume \u5377\u4e2d\u6642\uff1a apiVersion : v1 kind : Secret metadata : name : dotfile-secret data : .secret-file : dmFsdWUtMg0KDQo= --- apiVersion : v1 kind : Pod metadata : name : secret-dotfiles-pod spec : volumes : - name : secret-volume secret : secretName : dotfile-secret containers : - name : dotfile-test-container image : k8s.gcr.io/busybox command : - ls - \"-l\" - \"/etc/secret-volume\" volumeMounts : - name : secret-volume readOnly : true mountPath : \"/etc/secret-volume\" \u5377\u4e2d\u6703\u5305\u542b\u4e00\u500b\u540d\u70ba .secret-file \u7684\u6587\u4ef6\uff0c\u4e26\u4e14\u5bb9\u5668 dotfile-test-container \u4e2d\u6b64\u6587\u4ef6\u4f4d\u65bc\u8def\u5f91 /etc/secret-volume/.secret-file \u8655\u3002 Tip \u8aaa\u660e\uff1a \u4ee5\u53e5\u9ede\u958b\u982d\u7684\u6587\u4ef6\u6703\u5728 ls -l \u7684\u8f38\u51fa\u4e2d\u88ab\u96b1\u85cf\u8d77\u4f86\uff1b \u5217\u8209\u76ee\u9304\u5167\u5bb9\u6642\u4f60\u5fc5\u9808\u4f7f\u7528 ls -la \u624d\u80fd\u770b\u5230\u5b83\u5011\u3002","title":"\u4f7f\u7528\u5834\u666f\uff1a\u5728 Secret \u5377\u4e2d\u5e36\u53e5\u9ede\u7684\u6587\u4ef6"},{"location":"kubernetes/02-concepts/07-configuration/secret/#pod-secret_2","text":"\u8003\u616e\u4e00\u500b\u9700\u8981\u8655\u7406 HTTP \u8acb\u6c42\uff0c\u57f7\u884c\u67d0\u4e9b\u8907\u96dc\u7684\u696d\u52d9\u908f\u8f2f\uff0c\u4e4b\u5f8c\u4f7f\u7528 HMAC \u4f86\u5c0d\u67d0\u4e9b\u6d88\u606f\u9032\u884c\u7c3d\u540d\u7684\u7a0b\u5e8f\u3002\u56e0\u70ba\u9019\u4e00\u7a0b\u5e8f\u7684\u61c9\u7528\u908f\u8f2f\u5f88\u8907\u96dc\uff0c \u5176\u4e2d\u53ef\u80fd\u5305\u542b\u672a\u88ab\u6ce8\u610f\u5230\u7684\u9060\u7a0b\u670d\u52d9\u5668\u6587\u4ef6\u8b80\u53d6\u6f0f\u6d1e\uff0c \u9019\u7a2e\u6f0f\u6d1e\u53ef\u80fd\u6703\u628a\u79c1\u9470\u66b4\u9732\u7d66\u653b\u64ca\u8005\u3002 \u9019\u4e00\u7a0b\u5e8f\u53ef\u4ee5\u5206\u9694\u6210\u5169\u500b\u5bb9\u5668\u4e2d\u7684\u5169\u500b\u9032\u7a0b\uff1a\u524d\u7aef\u5bb9\u5668\u8981\u8655\u7406\u7528\u6236\u4ea4\u4e92\u548c\u696d\u52d9\u908f\u8f2f\uff0c \u4f46\u7121\u6cd5\u770b\u5230\u79c1\u9470\uff1b\u7c3d\u540d\u5bb9\u5668\u53ef\u4ee5\u770b\u5230\u79c1\u9470\uff0c\u4e26\u5c0d\u4f86\u81ea\u524d\u7aef\u7684\u7c21\u55ae\u7c3d\u540d\u8acb\u6c42\u4f5c\u51fa\u97ff\u61c9 \uff08\u4f8b\u5982\uff0c\u901a\u904e\u672c\u5730\u4e3b\u6a5f\u7db2\u7d61\uff09\u3002 \u63a1\u7528\u9019\u7a2e\u5283\u5206\u7684\u65b9\u6cd5\uff0c\u653b\u64ca\u8005\u73fe\u5728\u5fc5\u9808\u6b3a\u9a19\u61c9\u7528\u670d\u52d9\u5668\u4f86\u505a\u4e00\u4e9b\u5176\u4ed6\u64cd\u4f5c\uff0c \u800c\u9019\u4e9b\u64cd\u4f5c\u53ef\u80fd\u8981\u6bd4\u8b80\u53d6\u4e00\u500b\u6587\u4ef6\u8981\u5fa9\u96dc\u5f88\u591a\u3002","title":"\u4f7f\u7528\u5834\u666f\uff1a\u50c5\u5c0d Pod \u4e2d\u4e00\u500b\u5bb9\u5668\u53ef\u898b\u7684 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_16","text":"\u5275\u5efa Secret \u6642\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 Secret \u8cc7\u6e90\u7684 type \u5b57\u6bb5\uff0c\u6216\u8005\u8207\u5176\u7b49\u50f9\u7684 kubectl \u547d\u4ee4\u884c\u53c3\u6578\uff08\u5982\u679c\u6709\u7684\u8a71\uff09\u70ba\u5176\u8a2d\u7f6e\u985e\u578b\u3002 Secret \u985e\u578b\u6709\u52a9\u65bc\u5c0d Secret \u6578\u64da\u9032\u884c\u7de8\u7a0b\u8655\u7406\u3002 Kubernetes \u63d0\u4f9b\u82e5\u5e72\u7a2e\u5167\u7f6e\u7684\u985e\u578b\uff0c\u7528\u65bc\u4e00\u4e9b\u5e38\u898b\u7684\u4f7f\u7528\u5834\u666f\u3002\u91dd\u5c0d\u9019\u4e9b\u985e\u578b\uff0cKubernetes \u6240\u57f7\u884c\u7684\u5408\u6cd5\u6027\u6aa2\u67e5\u64cd\u4f5c\u4ee5\u53ca\u5c0d\u5176\u6240\u5be6\u65bd\u7684\u9650\u5236\u5404\u4e0d\u76f8\u540c\u3002 \u985e\u578b \u7528\u4f8b Opaque \u9810\u8a2d\u7684\u7684\u985e\u578b\u3002Base64 \u7de8\u78bc\u683c\u5f0f\u7684 Secret\uff0c\u7528\u4f86\u5b58\u5132\u5bc6\u78bc\u3001\u5bc6\u9470\u7b49\uff1b\u6578\u64da\u53ef\u901a\u904e base64 \u2013decode \u89e3\u78bc\u5f97\u5230\u539f\u59cb\u6578\u64da\uff0c\u6240\u4ee5\u52a0\u5bc6\u6027\u5f88\u5f31\u3002 kubernetes.io/service-account-token \u7528\u65bc\u88ab serviceaccount \u5f15\u7528\u3002 serviceaccout \u5275\u5efa\u6642 Kubernetes \u6703\u9ed8\u8a8d\u5275\u5efa\u5c0d\u61c9\u7684 secret\u3002 Pod \u5982\u679c\u4f7f\u7528\u4e86serviceaccount\uff0c\u5c0d\u61c9\u7684 secret \u6703\u81ea\u52d5\u639b\u8f09\u5230 Pod \u76ee\u9304 /run/secrets/kubernetes.io/serviceaccount \u4e2d\u3002 kubernetes.io/dockercfg ~/.dockercfg \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/dockerconfigjson ~/.docker/config.json \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/basic-auth \u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49 (Basic Auth)\u7684\u6191\u64da kubernetes.io/ssh-auth \u7528\u65bc SSH \u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da kubernetes.io/tls \u7528\u65bc TLS \u5ba2\u6236\u7aef\u6216\u8005\u670d\u52d9\u5668\u7aef\u7684\u6578\u64da bootstrap.kubernetes.io/token K8s \u7bc0\u9ede bootstrap \u4ee4\u724c\u6578\u64da \u901a\u904e\u70ba Secret \u5c0d\u8c61\u7684 type \u5b57\u6bb5\u8a2d\u7f6e\u4e00\u500b\u975e\u7a7a\u7684\u5b57\u7b26\u4e32\u503c\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5b9a\u7fa9\u4e26\u4f7f\u7528\u81ea\u5df1 Secret \u985e\u578b\uff08\u5982\u679c type \u503c\u70ba\u7a7a\u5b57\u7b26\u4e32\uff0c\u5247\u88ab\u8996\u70ba Opaque \u985e\u578b\uff09\u3002 Kubernetes \u4e26\u4e0d\u5c0d\u985e\u578b\u7684\u540d\u7a31\u4f5c\u4efb\u4f55\u9650\u5236\u3002\u4e0d\u904e\uff0c\u5982\u679c\u4f60\u8981\u4f7f\u7528\u5167\u7f6e\u985e\u578b\u4e4b\u4e00\uff0c \u5247\u4f60\u5fc5\u9808\u6eff\u8db3\u70ba\u8a72\u985e\u578b\u6240\u5b9a\u7fa9\u7684\u6240\u6709\u8981\u6c42\u3002 \u5982\u679c\u4f60\u8981\u5b9a\u7fa9\u4e00\u7a2e\u516c\u958b\u4f7f\u7528\u7684 Secret \u985e\u578b\uff0c\u8acb\u9075\u5b88 Secret \u985e\u578b\u7684\u7d04\u5b9a\u548c\u7d50\u69cb\uff0c \u5728\u985e\u578b\u540d\u7c3d\u540d\u6dfb\u52a0\u57df\u540d\uff0c\u4e26\u7528 / \u9694\u958b\u3002\u4f8b\u5982\uff1a cloud-hosting.example.net/cloud-api-credentials \u3002","title":"Secret \u7684\u985e\u578b"},{"location":"kubernetes/02-concepts/07-configuration/secret/#opaque-secret","text":"\u7576 Secret \u914d\u7f6e\u6587\u4ef6\u4e2d\u672a\u4f5c\u986f\u5f0f\u8a2d\u5b9a\u6642\uff0c\u9ed8\u8a8d\u7684 Secret \u985e\u578b\u662f Opaque\u3002\u7576\u4f60\u4f7f\u7528 kubectl \u4f86\u5275\u5efa\u4e00\u500b Secret \u6642\uff0c\u4f60\u6703\u4f7f\u7528 generic \u5b50\u547d\u4ee4\u4f86\u6a19\u660e\u8981\u5275\u5efa\u7684\u662f\u4e00\u500b Opaque \u985e\u578b Secret\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u547d\u4ee4\u6703\u5275\u5efa\u4e00\u500b\u7a7a\u7684 Opaque \u985e\u578b Secret \u5c0d\u8c61\uff1a kubectl create secret generic empty-secret kubectl get secret empty-secret \u8f38\u51fa\u985e\u4f3c\u65bc NAME TYPE DATA AGE empty-secret Opaque 0 2m6s DATA \u5217\u986f\u793a Secret \u4e2d\u4fdd\u5b58\u7684\u6578\u64da\u689d\u76ee\u500b\u6578\u3002\u5728\u9019\u500b\u4f8b\u5b50\u7a2e\uff0c 0 \u610f\u5473\u8457\u4f60\u525b\u525b\u5275\u5efa\u4e86\u4e00\u500b\u7a7a\u7684 Secret\u3002","title":"Opaque Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_17","text":"\u985e\u578b\u70ba kubernetes.io/service-account-token \u7684 Secret \u7528\u4f86\u5b58\u653e\u6a19\u8b58\u67d0\u670d\u52d9\u8cec\u865f\u7684\u4ee4\u724c\u6191\u64da\u3002 \u5f9e v1.22 \u958b\u59cb\uff0c\u9019\u7a2e\u985e\u578b\u7684 Secret \u4e0d\u518d\u88ab\u7528\u4f86\u5411 Pod \u4e2d\u52a0\u8f09\u6191\u64da\u6578\u64da\uff0c \u5efa\u8b70\u901a\u904e TokenRequest API ( https://kubernetes.io/zh-cn/docs/reference/kubernetes-api/authentication-resources/token-request-v1/ ) \u4f86\u7372\u5f97\u4ee4\u724c\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret \u5c0d\u8c61\u3002\u901a\u904e TokenRequest API \u7372\u5f97\u7684\u4ee4\u724c\u6bd4\u4fdd\u5b58\u5728 Secret \u5c0d\u50cf\u4e2d\u7684\u4ee4\u724c\u66f4\u52a0\u5b89\u5168\uff0c \u56e0\u70ba\u9019\u4e9b\u4ee4\u724c\u6709\u8457\u88ab\u9650\u5b9a\u7684\u751f\u547d\u671f\uff0c\u4e26\u4e14\u4e0d\u6703\u88ab\u5176\u4ed6 API \u5ba2\u6236\u7aef\u8b80\u53d6\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl create token \u547d\u4ee4\u8abf\u7528 TokenRequest API \u7372\u5f97\u4ee4\u724c\u3002 \u53ea\u6709\u5728\u4f60\u7121\u6cd5\u4f7f\u7528 TokenRequest API \u4f86\u7372\u53d6\u4ee4\u724c\uff0c \u4e26\u4e14\u4f60\u80fd\u5920\u63a5\u53d7\u56e0\u70ba\u5c07\u6c38\u4e0d\u904e\u671f\u7684\u4ee4\u724c\u6191\u64da\u5beb\u5165\u5230\u53ef\u8b80\u53d6\u7684 API \u5c0d\u8c61\u800c\u5e36\u4f86\u7684\u5b89\u5168\u98a8\u96aa\u6642\uff0c \u624d\u61c9\u8a72\u5275\u5efa\u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret \u5c0d\u8c61\u3002 \u4f7f\u7528\u9019\u7a2e Secret \u985e\u578b\u6642\uff0c\u4f60\u9700\u8981\u78ba\u4fdd\u5c0d\u8c61\u7684\u8a3b\u89e3 kubernetes.io/service-account-name \u88ab\u8a2d\u7f6e\u70ba\u67d0\u500b\u5df2\u6709\u7684\u670d\u52d9\u8cec\u865f\u540d\u7a31\u3002\u5982\u679c\u4f60\u540c\u6642\u8ca0\u8cac ServiceAccount \u548c Secret \u5c0d\u8c61\u7684\u5275\u5efa\uff0c\u61c9\u8a72\u5148\u5275\u5efa ServiceAccount \u5c0d\u8c61\u3002 \u7576 Secret \u5c0d\u50cf\u88ab\u5275\u5efa\u4e4b\u5f8c\uff0c\u67d0\u500b Kubernetes \u63a7\u5236\u5668\u6703\u586b\u5beb Secret \u7684\u5176\u5b83\u5b57\u6bb5\uff0c\u4f8b\u5982 kubernetes.io/service-account.uid \u8a3b\u89e3\u4ee5\u53ca data \u5b57\u6bb5\u4e2d\u7684 token \u9375\u503c\uff0c\u4f7f\u4e4b\u5305\u542b\u5be6\u969b\u7684\u4ee4\u724c\u5167\u5bb9\u3002 \u4e0b\u9762\u7684\u914d\u7f6e\u5be6\u4f8b\u8072\u660e\u4e86\u4e00\u500b\u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret\uff1a apiVersion : v1 kind : Secret metadata : name : secret-sa-sample annotations : kubernetes.io/service-account.name : \"sa-name\" type : kubernetes.io/service-account-token data : # \u4f60\u53ef\u4ee5\u50cf Opaque Secret \u4e00\u6837\u5728\u8fd9\u91cc\u6dfb\u52a0\u989d\u5916\u7684\u952e/\u503c\u5076\u5bf9 extra : YmFyCg== \u5275\u5efa\u4e86 Secret \u4e4b\u5f8c\uff0c\u7b49\u5f85 Kubernetes \u5728 data \u5b57\u6bb5\u4e2d\u586b\u5145 token \u4e3b\u9375\u3002 \u53c3\u8003 ServiceAccount \u6587\u6a94\u4e86\u89e3\u670d\u52d9\u8cec\u865f\u7684\u5de5\u4f5c\u539f\u7406\u3002\u4f60\u4e5f\u53ef\u4ee5\u67e5\u770b Pod \u8cc7\u6e90\u4e2d\u7684 automountServiceAccountToken \u548c serviceAccountName \u5b57\u6bb5\u6587\u6a94\uff0c \u9032\u4e00\u6b65\u4e86\u89e3\u5f9e Pod \u4e2d\u5f15\u7528\u670d\u52d9\u8cec\u865f\u6191\u64da\u3002","title":"\u670d\u52d9\u8cec\u865f\u4ee4\u724c Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#docker-secret","text":"\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u5169\u7a2e type \u503c\u4e4b\u4e00\u4f86\u5275\u5efa Secret\uff0c\u7528\u4ee5\u5b58\u653e\u7528\u65bc\u8a2a\u554f\u5bb9\u5668\u93e1\u50cf\u5009\u5eab\u7684\u6191\u64da\uff1a kubernetes.io/dockercfg kubernetes.io/dockerconfigjson kubernetes.io/dockercfg \u662f\u4e00\u7a2e\u4fdd\u7559\u985e\u578b\uff0c\u7528\u4f86\u5b58\u653e /.dockercfg \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\u3002\u8a72\u6587\u4ef6\u662f\u914d\u7f6e Docker \u547d\u4ee4\u884c\u7684\u4e00\u7a2e\u8001\u820a\u5f62\u5f0f\u3002\u4f7f\u7528\u6b64 Secret \u985e\u578b\u6642\uff0c\u4f60\u9700\u8981\u78ba\u4fdd Secret \u7684 data \u5b57\u6bb5\u4e2d\u5305\u542b\u540d\u70ba .dockercfg \u7684\u4e3b\u9375\uff0c\u5176\u5c0d\u61c9\u9375\u503c\u662f\u7528 base64 \u7de8\u78bc\u7684\u67d0 /.dockercfg` \u6587\u4ef6\u7684\u5167\u5bb9\u3002 \u985e\u578b kubernetes.io/dockerconfigjson \u88ab\u8a2d\u8a08\u7528\u4f86\u4fdd\u5b58 JSON \u6578\u64da\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c \u8a72 JSON \u4e5f\u9075\u5f9e ~/.docker/config.json \u6587\u4ef6\u7684\u683c\u5f0f\u898f\u5247\uff0c\u800c\u5f8c\u8005\u662f ~/.dockercfg \u7684\u65b0\u7248\u672c\u683c\u5f0f\u3002\u4f7f\u7528\u6b64 Secret \u985e\u578b\u6642\uff0cSecret \u5c0d\u8c61\u7684 data \u5b57\u6bb5\u5fc5\u9808\u5305\u542b .dockerconfigjson \u9375\uff0c\u5176\u9375\u503c\u70ba base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u5305\u542b ~/.docker/config.json \u6587\u4ef6\u7684\u5167\u5bb9\u3002 \u4e0b\u9762\u662f\u4e00\u500b kubernetes.io/dockercfg \u985e\u578b Secret \u7684\u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-dockercfg type : kubernetes.io/dockercfg data : .dockercfg : | \"<base64 encoded ~/.dockercfg file>\" \u7576\u4f60\u4f7f\u7528\u6e05\u55ae\u6587\u4ef6\u4f86\u5275\u5efa\u9019\u5169\u985e Secret \u6642\uff0cAPI \u670d\u52d9\u5668\u6703\u6aa2\u67e5 data \u5b57\u6bb5\u4e2d\u662f\u5426\u5b58\u5728\u6240\u671f\u671b\u7684\u4e3b\u9375\uff0c \u4e26\u4e14\u9a57\u8b49\u5176\u4e2d\u6240\u63d0\u4f9b\u7684\u9375\u503c\u662f\u5426\u662f\u5408\u6cd5\u7684 JSON \u6578\u64da\u3002\u4e0d\u904e\uff0cAPI \u670d\u52d9\u5668\u4e0d\u6703\u6aa2\u67e5 JSON \u6578\u64da\u672c\u8eab\u662f\u5426\u662f\u4e00\u500b\u5408\u6cd5\u7684 Docker \u914d\u7f6e\u6587\u4ef6\u5167\u5bb9\u3002 \u7576\u4f60\u6c92\u6709 Docker \u914d\u7f6e\u6587\u4ef6\uff0c\u6216\u8005\u4f60\u60f3\u4f7f\u7528 kubectl \u5275\u5efa\u4e00\u500b Secret \u4f86\u8a2a\u554f\u5bb9\u5668\u5009\u5eab\u6642\uff0c\u4f60\u53ef\u4ee5\u9019\u6a23\u505a\uff1a kubectl create secret docker-registry secret-tiger-docker \\ --docker-email = tiger@acme.example \\ --docker-username = tiger \\ --docker-password = pass1234 \\ --docker-server = my-registry.example:5000 \u4e0a\u9762\u7684\u547d\u4ee4\u5275\u5efa\u4e00\u500b\u985e\u578b\u70ba kubernetes.io/dockerconfigjson \u7684 Secret\u3002\u5982\u679c\u4f60\u5c0d .data.dockerconfigjson \u5167\u5bb9\u9032\u884c\u8f49\u5132\u4e26\u57f7\u884c base64 \u89e3\u78bc\uff1a kubectl get secret secret-tiger-docker -o jsonpath = '{.data.*}' | base64 -d \u90a3\u9ebc\u8f38\u51fa\u7b49\u50f9\u65bc\u9019\u500b JSON \u6587\u6a94\uff08\u9019\u4e5f\u662f\u4e00\u500b\u6709\u6548\u7684 Docker \u914d\u7f6e\u6587\u4ef6\uff09\uff1a { \"auths\" : { \"my-registry.example:5000\" : { \"username\" : \"tiger\" , \"password\" : \"pass1234\" , \"email\" : \"tiger@acme.example\" , \"auth\" : \"dGlnZXI6cGFzczEyMzQ=\" } } }","title":"Docker \u914d\u7f6e Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_18","text":"kubernetes.io/basic-auth \u985e\u578b\u7528\u4f86\u5b58\u653e\u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49\u6240\u9700\u7684\u6191\u64da\u4fe1\u606f\u3002\u4f7f\u7528\u9019\u7a2e Secret \u985e\u578b\u6642\uff0cSecret \u7684 data \u5b57\u6bb5\u5fc5\u9808\u5305\u542b\u4ee5\u4e0b\u5169\u500b\u9375\u4e4b\u4e00\uff1a username : \u7528\u65bc\u8eab\u4efd\u8a8d\u8b49\u7684\u7528\u6236\u540d\uff1b password : \u7528\u65bc\u8eab\u4efd\u8a8d\u8b49\u7684\u5bc6\u78bc\u6216\u4ee4\u724c\u3002 \u4ee5\u4e0a\u5169\u500b\u9375\u7684\u9375\u503c\u90fd\u662f base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u3002\u7576\u7136\u4f60\u4e5f\u53ef\u4ee5\u5728\u5275\u5efa Secret \u6642\u4f7f\u7528 stringData \u5b57\u6bb5\u4f86\u63d0\u4f9b\u660e\u6587\u5f62\u5f0f\u7684\u5167\u5bb9\u3002\u4ee5\u4e0b\u6e05\u55ae\u662f\u57fa\u672c\u8eab\u4efd\u9a57\u8b49 Secret \u7684\u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-basic-auth type : kubernetes.io/basic-auth stringData : username : admin # kubernetes.io/basic-auth \u985e\u578b\u7684\u5fc5\u9700\u5b57\u6bb5 password : t0p-Secret # kubernetes.io/basic-auth \u985e\u578b\u7684\u5fc5\u9700\u5b57\u6bb5 \u63d0\u4f9b\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49\u985e\u578b\u7684 Secret \u50c5\u50c5\u662f\u51fa\u65bc\u65b9\u4fbf\u6027\u8003\u616e\u3002\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Opaque \u985e\u578b\u4f86\u4fdd\u5b58\u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da\u3002\u4e0d\u904e\uff0c\u4f7f\u7528\u9810\u5b9a\u7fa9\u7684\u3001\u516c\u958b\u7684 Secret \u985e\u578b\uff08 kubernetes.io/basic-auth \uff09 \u6709\u52a9\u65bc\u5e6b\u52a9\u5176\u4ed6\u7528\u6236\u7406\u89e3 Secret \u7684\u76ee\u7684\uff0c\u4e26\u4e14\u5c0d\u5176\u4e2d\u5b58\u5728\u7684\u4e3b\u9375\u5f62\u6210\u4e00\u7a2e\u7d04\u5b9a\u3002 API \u670d\u52d9\u5668\u6703\u6aa2\u67e5 Secret \u914d\u7f6e\u4e2d\u662f\u5426\u63d0\u4f9b\u4e86\u6240\u9700\u8981\u7684\u4e3b\u9375\u3002","title":"\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#ssh-secret","text":"Kubernetes \u6240\u63d0\u4f9b\u7684\u5167\u7f6e\u985e\u578b kubernetes.io/ssh-auth \u7528\u4f86\u5b58\u653e SSH \u8eab\u4efd\u8a8d\u8b49\u4e2d\u6240\u9700\u8981\u7684\u6191\u64da\u3002\u4f7f\u7528\u9019\u7a2e Secret \u985e\u578b\u6642\uff0c\u4f60\u5c31\u5fc5\u9808\u5728\u5176 data \uff08\u6216 stringData \uff09 \u5b57\u6bb5\u4e2d\u63d0\u4f9b\u4e00\u500b ssh-privatekey \u9375\u503c\u5c0d\uff0c\u4f5c\u70ba\u8981\u4f7f\u7528\u7684 SSH \u6191\u64da\u3002 \u4e0b\u9762\u7684\u6e05\u55ae\u662f\u4e00\u500b SSH \u516c\u9470/\u79c1\u9470\u8eab\u4efd\u8a8d\u8b49\u7684 Secret \u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-ssh-auth type : kubernetes.io/ssh-auth data : # \u6b64\u4f8b\u4e2d\u7684\u6578\u64da\u88ab\u622a\u65b7 ssh-privatekey : | MIIEpQIBAAKCAQEAulqb/Y ... \u63d0\u4f9b SSH \u8eab\u4efd\u8a8d\u8b49\u985e\u578b\u7684 Secret \u50c5\u50c5\u662f\u51fa\u65bc\u7528\u6236\u65b9\u4fbf\u6027\u8003\u616e\u3002\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Opaque \u985e\u578b\u4f86\u4fdd\u5b58\u7528\u65bc SSH \u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da\u3002\u4e0d\u904e\uff0c\u4f7f\u7528\u9810\u5b9a\u7fa9\u7684\u3001\u516c\u958b\u7684 Secret \u985e\u578b\uff08 kubernetes.io/ssh-auth \uff09 \u6709\u52a9\u65bc\u5176\u4ed6\u4eba\u7406\u89e3\u4f60\u7684 Secret \u7684\u7528\u9014\uff0c\u4e5f\u53ef\u4ee5\u5c31\u5176\u4e2d\u5305\u542b\u7684\u4e3b\u9375\u540d\u5f62\u6210\u7d04\u5b9a\u3002 API \u670d\u52d9\u5668\u78ba\u5be6\u6703\u6aa2\u67e5 Secret \u914d\u7f6e\u4e2d\u662f\u5426\u63d0\u4f9b\u4e86\u6240\u9700\u8981\u7684\u4e3b\u9375\u3002","title":"SSH \u8eab\u4efd\u8a8d\u8b49 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#tls-secret","text":"Kubernetes \u63d0\u4f9b\u4e00\u7a2e\u5167\u7f6e\u7684 kubernetes.io/tls Secret \u985e\u578b\uff0c\u7528\u4f86\u5b58\u653e TLS \u5834\u5408\u901a\u5e38\u8981\u4f7f\u7528\u7684\u8b49\u66f8\u53ca\u5176\u76f8\u95dc\u5bc6\u9470\u3002 TLS Secret \u7684\u4e00\u7a2e\u5178\u578b\u7528\u6cd5\u662f\u70ba Ingress \u8cc7\u6e90\u914d\u7f6e\u50b3\u8f38\u904e\u7a0b\u4e2d\u7684\u6578\u64da\u52a0\u5bc6\uff0c\u4e0d\u904e\u4e5f\u53ef\u4ee5\u7528\u65bc\u5176\u4ed6\u8cc7\u6e90\u6216\u8005\u76f4\u63a5\u5728\u8ca0\u8f09\u4e2d\u4f7f\u7528\u3002\u7576\u4f7f\u7528\u6b64\u985e\u578b\u7684 Secret \u6642\uff0cSecret \u914d\u7f6e\u4e2d\u7684 data \uff08\u6216 stringData \uff09\u5b57\u6bb5\u5fc5\u9808\u5305\u542b tls.key \u548c tls.crt \u4e3b\u9375\uff0c\u5118\u7ba1 API \u670d\u52d9\u5668\u5be6\u969b\u4e0a\u4e26\u4e0d\u6703\u5c0d\u6bcf\u500b\u9375\u7684\u53d6\u503c\u4f5c\u9032\u4e00\u6b65\u7684\u5408\u6cd5\u6027\u6aa2\u67e5\u3002` \u4e0b\u9762\u7684 YAML \u5305\u542b\u4e00\u500b TLS Secret \u7684\u914d\u7f6e\u793a\u4f8b\uff1a apiVersion : v1 kind : Secret metadata : name : secret-tls type : kubernetes.io/tls data : # \u6b64\u4f8b\u4e2d\u7684\u6578\u64da\u88ab\u622a\u65b7 tls.crt : | MIIC2DCCAcCgAwIBAgIBATANBgkqh ... tls.key : | MIIEpgIBAAKCAQEA7yn3bRHQ5FHMQ ... \u63d0\u4f9b TLS \u985e\u578b\u7684 Secret \u50c5\u50c5\u662f\u51fa\u65bc\u7528\u6236\u65b9\u4fbf\u6027\u8003\u616e\u3002\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528 Opaque \u985e\u578b\u4f86\u4fdd\u5b58\u7528\u65bc TLS \u670d\u52d9\u5668\u8207/\u6216\u5ba2\u6236\u7aef\u7684\u6191\u64da\u3002\u4e0d\u904e\uff0c\u4f7f\u7528\u5167\u7f6e\u7684 Secret \u985e\u578b\u7684\u6709\u52a9\u65bc\u5c0d\u6191\u64da\u683c\u5f0f\u9032\u884c\u6b78\u4e00\u5316\u8655\u7406\uff0c\u4e26\u4e14 API \u670d\u52d9\u5668\u78ba\u5be6\u6703\u6aa2\u67e5 Secret \u914d\u7f6e\u4e2d\u662f\u5426\u63d0\u4f9b\u4e86\u6240\u9700\u8981\u7684\u4e3b\u9375\u3002 \u7576\u4f7f\u7528 kubectl \u4f86\u5275\u5efa TLS Secret \u6642\uff0c\u4f60\u53ef\u4ee5\u50cf\u4e0b\u9762\u7684\u4f8b\u5b50\u4e00\u6a23\u4f7f\u7528 tls \u5b50\u547d\u4ee4\uff1a kubectl create secret tls my-tls-secret \\ --cert = path/to/cert/file \\ --key = path/to/key/file \u9019\u88e1\u7684\u516c\u9470/\u79c1\u9470\u5c0d\u90fd\u5fc5\u9808\u4e8b\u5148\u5df2\u5b58\u5728\u3002\u7528\u65bc --cert \u7684\u516c\u9470\u8b49\u66f8\u5fc5\u9808\u662f RFC 7468 \u4e2d 5.1 \u7bc0 \u4e2d\u6240\u898f\u5b9a\u7684 DER \u683c\u5f0f\uff0c\u4e14\u8207 --key \u6240\u7d66\u5b9a\u7684\u79c1\u9470\u5339\u914d\u3002\u79c1\u9470\u5fc5\u9808\u662f DER \u683c\u5f0f\u7684 PKCS #8 \uff08\u53c3\u898b RFC 7468 \u7b2c 11\u7bc0 \uff09\u3002 Info \u8aaa\u660e\uff1a \u985e\u578b\u70ba kubernetes.io/tls \u7684 Secret \u4e2d\u5305\u542b\u5bc6\u9470\u548c\u8b49\u66f8\u7684 DER \u6578\u64da\uff0c\u4ee5 Base64 \u683c\u5f0f\u7de8\u78bc\u3002\u5982\u679c\u4f60\u719f\u6089\u79c1\u9470\u548c\u8b49\u66f8\u7684 PEM \u683c\u5f0f\uff0cbase64 \u8207\u8a72\u683c\u5f0f\u76f8\u540c\uff0c\u53ea\u662f\u4f60\u9700\u8981\u7565\u904e PEM \u6578\u64da\u4e2d\u6240\u5305\u542b\u7684\u7b2c\u4e00\u884c\u548c\u6700\u5f8c\u4e00\u884c\u3002 \u4f8b\u5982\uff0c\u5c0d\u65bc\u8b49\u66f8\u800c\u8a00\uff0c\u4f60 \u4e0d\u8981 \u5305\u542b --------BEGIN CERTIFICATE----- \u548c -------END CERTIFICATE---- \u9019\u5169\u884c\u3002","title":"TLS Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_19","text":"\u901a\u904e\u5c07 Secret \u7684 type \u8a2d\u7f6e\u70ba bootstrap.kubernetes.io/token \u53ef\u4ee5\u5275\u5efa\u555f\u52d5\u5f15\u5c0e\u4ee4\u724c\u985e\u578b\u7684 Secret\u3002\u9019\u7a2e\u985e\u578b\u7684 Secret \u88ab\u8a2d\u8a08\u7528\u4f86\u652f\u6301\u7bc0\u9ede\u7684\u555f\u52d5\u5f15\u5c0e\u904e\u7a0b\u3002\u5176\u4e2d\u5305\u542b\u7528\u4f86\u70ba\u5468\u77e5\u7684 ConfigMap \u7c3d\u540d\u7684\u4ee4\u724c\u3002 \u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret \u901a\u5e38\u5275\u5efa\u65bc kube-system \u540d\u5b57\u7a7a\u9593\u5167\uff0c\u4e26\u4ee5 bootstrap-token-<\u4ee4\u724c ID> \u7684\u5f62\u5f0f\u547d\u540d\uff1b \u5176\u4e2d <\u4ee4\u724c ID> \u662f\u4e00\u500b\u7531 6 \u500b\u5b57\u7b26\u7d44\u6210\u7684\u5b57\u7b26\u4e32\uff0c\u7528\u4f5c\u4ee4\u724c\u7684\u6a19\u8b58\u3002 \u4ee5 Kubernetes \u6e05\u55ae\u6587\u4ef6\u7684\u5f62\u5f0f\uff0c\u67d0\u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret \u53ef\u80fd\u770b\u8d77\u4f86\u50cf\u4e0b\u9762\u9019\u6a23\uff1a apiVersion : v1 kind : Secret metadata : name : bootstrap-token-5emitj namespace : kube-system type : bootstrap.kubernetes.io/token data : auth-extra-groups : c3lzdGVtOmJvb3RzdHJhcHBlcnM6a3ViZWFkbTpkZWZhdWx0LW5vZGUtdG9rZW4= expiration : MjAyMC0wOS0xM1QwNDozOToxMFo= token-id : NWVtaXRq token-secret : a3E0Z2lodnN6emduMXAwcg== usage-bootstrap-authentication : dHJ1ZQ== usage-bootstrap-signing : dHJ1ZQ== \u555f\u52d5\u5f15\u5c0e\u4ee4\u724c\u985e\u578b\u7684 Secret \u6703\u5728 data \u5b57\u6bb5\u4e2d\u5305\u542b\u5982\u4e0b\u4e3b\u9375\uff1a token-id \uff1a\u7531 6 \u500b\u96a8\u6a5f\u5b57\u7b26\u7d44\u6210\u7684\u5b57\u7b26\u4e32\uff0c\u4f5c\u70ba\u4ee4\u724c\u7684\u6a19\u8b58\u7b26\u3002\u5fc5\u9700\u3002 token-secret \uff1a\u7531 16 \u500b\u96a8\u6a5f\u5b57\u7b26\u7d44\u6210\u7684\u5b57\u7b26\u4e32\uff0c\u5305\u542b\u5be6\u969b\u7684\u4ee4\u724c\u6a5f\u5bc6\u3002\u5fc5\u9700\u3002 description \uff1a\u4f9b\u7528\u6236\u95b1\u8b80\u7684\u5b57\u7b26\u4e32\uff0c\u63cf\u8ff0\u4ee4\u724c\u7684\u7528\u9014\u3002\u53ef\u9078\u3002 expiration \uff1a\u4e00\u500b\u4f7f\u7528 RFC3339 \u4f86\u7de8\u78bc\u7684 UTC \u7d55\u5c0d\u6642\u9593\uff0c\u7d66\u51fa\u4ee4\u724c\u8981\u904e\u671f\u7684\u6642\u9593\u3002\u53ef\u9078\u3002 usage-bootstrap-<usage> \uff1a\u5e03\u723e\u985e\u578b\u7684\u6a19\u8a8c\uff0c\u7528\u4f86\u6a19\u660e\u555f\u52d5\u5f15\u5c0e\u4ee4\u724c\u7684\u5176\u4ed6\u7528\u9014\u3002 auth-extra-groups \uff1a\u7528\u9017\u865f\u5206\u9694\u7684\u7d44\u540d\u5217\u8868\uff0c\u8eab\u4efd\u8a8d\u8b49\u6642\u9664\u88ab\u8a8d\u8b49\u70ba system:bootstrappers \u7d44\u4e4b\u5916\uff0c\u9084\u6703\u88ab\u6dfb\u52a0\u5230\u6240\u5217\u7684\u7528\u6236\u7d44\u4e2d\u3002 \u4e0a\u9762\u7684 YAML \u6587\u4ef6\u53ef\u80fd\u770b\u8d77\u4f86\u4ee4\u4eba\u8cbb\u89e3\uff0c\u56e0\u70ba\u5176\u4e2d\u7684\u6578\u503c\u5747\u70ba base64 \u7de8\u78bc\u7684\u5b57\u7b26\u4e32\u3002\u5be6\u969b\u4e0a\uff0c\u4f60\u5b8c\u5168\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684 YAML \u4f86\u5275\u5efa\u4e00\u500b\u4e00\u6a21\u4e00\u6a23\u7684 Secret\uff1a apiVersion : v1 kind : Secret metadata : # \u6ce8\u610f Secret \u7684\u547d\u540d\u65b9\u5f0f name : bootstrap-token-5emitj # \u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret \u901a\u5e38\u4f4d\u65bc kube-system \u540d\u5b57\u7a7a\u9593 namespace : kube-system type : bootstrap.kubernetes.io/token stringData : auth-extra-groups : \"system:bootstrappers:kubeadm:default-node-token\" expiration : \"2020-09-13T04:39:10Z\" # \u6b64\u4ee4\u724c ID \u88ab\u7528\u65bc\u751f\u6210 Secret \u540d\u7a31 token-id : \"5emitj\" token-secret : \"kq4gihvszzgn1p0r\" # \u6b64\u4ee4\u724c\u9084\u53ef\u7528\u65bc authentication \uff08\u8eab\u4efd\u8a8d\u8b49\uff09 usage-bootstrap-authentication : \"true\" # \u4e14\u53ef\u7528\u65bc signing \uff08\u8b49\u66f8\u7c64\u540d\uff09 usage-bootstrap-signing : \"true\"","title":"\u555f\u52d5\u5f15\u5c0e\u4ee4\u724c Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_20","text":"Kubernetes \u5141\u8a31\u4f60\u5c07\u7279\u5b9a\u7684 Secret\uff08\u548c ConfigMap\uff09\u6a19\u8a18\u70ba \u4e0d\u53ef\u66f4\u6539\uff08Immutable\uff09\u3002\u7981\u6b62\u66f4\u6539\u73fe\u6709 Secret \u7684\u6578\u64da\u6709\u4e0b\u5217\u597d\u8655\uff1a \u9632\u6b62\u610f\u5916\uff08\u6216\u975e\u9810\u671f\u7684\uff09\u66f4\u65b0\u5c0e\u81f4\u61c9\u7528\u7a0b\u5e8f\u4e2d\u65b7 \uff08\u5c0d\u65bc\u5927\u91cf\u4f7f\u7528 Secret \u7684\u96c6\u7fa4\u800c\u8a00\uff0c\u81f3\u5c11\u6578\u4e07\u500b\u4e0d\u540c\u7684 Secret \u4f9b Pod \u639b\u8f09\uff09\uff0c \u901a\u904e\u5c07 Secret \u6a19\u8a18\u70ba\u4e0d\u53ef\u8b8a\uff0c\u53ef\u4ee5\u6975\u5927\u964d\u4f4e kube-apiserver \u7684\u8ca0\u8f09\uff0c\u63d0\u5347\u96c6\u7fa4\u6027\u80fd\u3002 kubelet \u4e0d\u9700\u8981\u76e3\u8996\u90a3\u4e9b\u88ab\u6a19\u8a18\u70ba\u4e0d\u53ef\u66f4\u6539\u7684 Secret\u3002","title":"\u4e0d\u53ef\u66f4\u6539\u7684 Secret"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_21","text":"\u4f60\u53ef\u4ee5\u901a\u904e\u5c07 Secret \u7684 immutable \u5b57\u6bb5\u8a2d\u7f6e\u70ba true \u5275\u5efa\u4e0d\u53ef\u66f4\u6539\u7684 Secret\u3002\u4f8b\u5982\uff1a apiVersion : v1 kind : Secret metadata : ... data : ... immutable : true \u4f60\u4e5f\u53ef\u4ee5\u66f4\u6539\u73fe\u6709\u7684 Secret\uff0c\u4ee4\u5176\u4e0d\u53ef\u66f4\u6539\u3002 Info \u8aaa\u660e\uff1a \u4e00\u65e6\u4e00\u500b Secret \u6216 ConfigMap \u88ab\u6a19\u8a18\u70ba\u4e0d\u53ef\u66f4\u6539\uff0c\u64a4\u92b7\u6b64\u64cd\u4f5c\u6216\u8005\u66f4\u6539 data \u5b57\u6bb5\u7684\u5167\u5bb9\u90fd\u662f \u4e0d \u53ef\u80fd\u7684\u3002\u53ea\u80fd\u522a\u9664\u4e26\u91cd\u65b0\u5275\u5efa\u9019\u500b Secret\u3002\u73fe\u6709\u7684 Pod \u5c07\u7dad\u6301\u5c0d\u5df2\u522a\u9664 Secret \u7684\u639b\u8f09\u9ede -- \u5efa\u8b70\u91cd\u65b0\u5275\u5efa\u9019\u4e9b Pod\u3002","title":"\u5c07 Secret \u6a19\u8a18\u70ba\u4e0d\u53ef\u66f4\u6539"},{"location":"kubernetes/02-concepts/07-configuration/secret/#secret_22","text":"\u5118\u7ba1 ConfigMap \u548c Secret \u7684\u5de5\u4f5c\u65b9\u5f0f\u985e\u4f3c\uff0c\u4f46 Kubernetes \u5c0d Secret \u6709\u4e00\u4e9b\u984d\u5916\u7684\u4fdd\u8b77\u3002 Secret \u901a\u5e38\u4fdd\u5b58\u91cd\u8981\u6027\u5404\u7570\u7684\u6578\u503c\uff0c\u5176\u4e2d\u5f88\u591a\u90fd\u53ef\u80fd\u6703\u5c0e\u81f4 Kubernetes \u4e2d \uff08\u4f8b\u5982\uff0c\u670d\u52d9\u8cec\u865f\u4ee4\u724c\uff09\u6216\u5c0d\u5916\u90e8\u7cfb\u7d71\u7684\u7279\u6b0a\u63d0\u5347\u3002\u5373\u4f7f\u67d0\u4e9b\u500b\u5225\u61c9\u7528\u80fd\u5920\u63a8\u5c0e\u5b83\u671f\u671b\u4f7f\u7528\u7684 Secret \u7684\u80fd\u529b\uff0c \u540c\u4e00\u540d\u5b57\u7a7a\u9593\u4e2d\u7684\u5176\u4ed6\u61c9\u7528\u53ef\u80fd\u6703\u8b93\u9019\u7a2e\u5047\u5b9a\u4e0d\u6210\u7acb\u3002 \u53ea\u6709\u7576\u67d0\u500b\u7bc0\u9ede\u4e0a\u7684 Pod \u9700\u8981\u67d0 Secret \u6642\uff0c\u5c0d\u61c9\u7684 Secret \u624d\u6703\u88ab\u767c\u9001\u5230\u8a72\u7bc0\u9ede\u4e0a\u3002\u5982\u679c\u5c07 Secret \u639b\u8f09\u5230 Pod \u4e2d\uff0ckubelet \u6703\u5c07\u6578\u64da\u7684\u526f\u672c\u4fdd\u5b58\u5728\u5728 tmpfs \u4e2d\uff0c \u9019\u6a23\u6a5f\u5bc6\u7684\u6578\u64da\u4e0d\u6703\u88ab\u5beb\u5165\u5230\u6301\u4e45\u6027\u5b58\u5132\u4e2d\u3002\u4e00\u65e6\u4f9d\u8cf4\u65bc\u8a72 Secret \u7684 Pod \u88ab\u522a\u9664\uff0ckubelet \u6703\u522a\u9664\u4f86\u81ea\u65bc\u8a72 Secret \u7684\u6a5f\u5bc6\u6578\u64da\u7684\u672c\u5730\u526f\u672c\u3002 \u540c\u4e00\u500b Pod \u4e2d\u53ef\u80fd\u5305\u542b\u591a\u500b\u5bb9\u5668\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u4f60\u6240\u5b9a\u7fa9\u7684\u5bb9\u5668\u53ea\u80fd\u8a2a\u554f\u9ed8\u8a8d ServiceAccount \u53ca\u5176\u76f8\u95dc Secret\u3002\u4f60\u5fc5\u9808\u986f\u5f0f\u5730\u5b9a\u7fa9\u74b0\u5883\u8b8a\u91cf\u6216\u8005\u5c07\u6372\u6620\u5c04\u5230\u5bb9\u5668\u4e2d\uff0c\u624d\u80fd\u70ba\u5bb9\u5668\u63d0\u4f9b\u5c0d\u5176\u4ed6 Secret \u7684\u8a2a\u554f\u3002 \u91dd\u5c0d\u540c\u4e00\u7bc0\u9ede\u4e0a\u7684\u591a\u500b Pod \u53ef\u80fd\u6709\u591a\u500b Secret\u3002\u4e0d\u904e\uff0c\u53ea\u6709\u67d0\u500b Pod \u6240\u8acb\u6c42\u7684 Secret \u624d\u6709\u53ef\u80fd\u5c0d Pod \u4e2d\u7684\u5bb9\u5668\u53ef\u898b\u3002\u56e0\u6b64\uff0c\u4e00\u500b Pod \u4e0d\u6703\u7372\u5f97\u8a2a\u554f\u5176\u4ed6 Pod \u7684 Secret \u7684\u6b0a\u9650\u3002","title":"Secret \u7684\u4fe1\u606f\u5b89\u5168\u554f\u984c"},{"location":"kubernetes/02-concepts/07-configuration/secret/#_5","text":"\u61c9\u7528\u5728\u5f9e\u74b0\u5883\u8b8a\u91cf\u6216\u5377\u4e2d\u8b80\u53d6\u4e86\u6a5f\u5bc6\u4fe1\u606f\u5167\u5bb9\u4e4b\u5f8c\u4ecd\u8981\u5c0d\u5176\u9032\u884c\u4fdd\u8b77\u3002\u4f8b\u5982\uff0c \u4f60\u7684\u61c9\u7528\u61c9\u8a72\u907f\u514d\u7528\u660e\u6587\u7684\u65b9\u5f0f\u5c07 Secret \u6578\u64da\u5beb\u5165\u65e5\u8a8c\uff0c\u6216\u8005\u5c07\u5176\u50b3\u905e\u7d66\u4e0d\u53ef\u4fe1\u7684\u7b2c\u4e09\u65b9\u3002 \u5982\u679c\u4f60\u5728\u4e00\u500b Pod \u4e2d\u5b9a\u7fa9\u4e86\u591a\u500b\u5bb9\u5668\uff0c\u800c\u53ea\u6709\u4e00\u500b\u5bb9\u5668\u9700\u8981\u8a2a\u554f\u67d0 Secret\uff0c \u5b9a\u7fa9\u5377\u639b\u8f09\u6216\u74b0\u5883\u8b8a\u91cf\u914d\u7f6e\u6642\uff0c\u61c9\u78ba\u4fdd\u5176\u4ed6\u5bb9\u5668\u7121\u6cd5\u8a2a\u554f\u8a72 Secret\u3002 \u5982\u679c\u4f60\u901a\u904e\u6e05\u55ae\u4f86\u914d\u7f6e\u67d0 Secret\uff0c Secret \u6578\u64da\u4ee5 Base64 \u7684\u5f62\u5f0f\u7de8\u78bc\uff0c\u5c07\u6b64\u6587\u4ef6\u5171\u4eab\uff0c\u6216\u8005\u5c07\u5176\u6aa2\u5165\u5230\u67d0\u6e90\u78bc\u5009\u5eab\uff0c \u90fd\u610f\u5473\u8457 Secret \u5c0d\u65bc\u4efb\u4f55\u53ef\u4ee5\u8b80\u53d6\u6e05\u55ae\u7684\u4eba\u90fd\u662f\u53ef\u898b\u7684\u3002 Base64 - \u7de8\u78bc \u4e0d\u662f \u4e00\u7a2e\u52a0\u5bc6\u65b9\u6cd5\uff0c\u8207\u660e\u6587\u76f8\u6bd4\u6c92\u6709\u4efb\u4f55\u5b89\u5168\u6027\u63d0\u5347\u3002 \u90e8\u7f72\u8207 Secret API \u4ea4\u4e92\u7684\u61c9\u7528\u6642\uff0c\u4f60\u61c9\u8a72\u4f7f\u7528 RBAC \u9019\u985e \u9451\u6b0a\u7b56\u7565 \u4f86\u9650\u5236\u8a2a\u554f\u3002 \u5728 Kubernetes API \u4e2d\uff0c\u540d\u5b57\u7a7a\u9593\u5167\u5c0d Secret \u5c0d\u8c61\u7684 watch \u548c list \u8acb\u6c42\u662f\u975e\u5e38\u5f37\u5927\u7684\u80fd\u529b\u3002\u5728\u53ef\u80fd\u7684\u6642\u5019\u61c9\u8a72\u907f\u514d\u6388\u4e88\u9019\u985e\u8a2a\u554f\u6b0a\u9650\uff0c\u56e0\u70ba\u901a\u904e\u5217\u8209 Secret\uff0c \u5ba2\u6236\u7aef\u80fd\u5920\u67e5\u770b\u5c0d\u61c9\u540d\u5b57\u7a7a\u9593\u5167\u6240\u6709 Secret \u7684\u53d6\u503c\u3002","title":"\u91dd\u5c0d\u958b\u767c\u4eba\u54e1\u7684\u5b89\u5168\u6027\u5efa\u8b70"},{"location":"kubernetes/02-concepts/07-configuration/secret/#_6","text":"\u4fdd\u7559\uff08\u4f7f\u7528 Kubernetes API\uff09\u5c0d\u96c6\u7fa4\u4e2d\u6240\u6709 Secret \u5c0d\u8c61\u57f7\u884c watch \u6216 list \u64cd\u4f5c\u7684\u80fd\u529b\uff0c \u9019\u6a23\u53ea\u6709\u7279\u6b0a\u7d1a\u6700\u9ad8\u3001\u7cfb\u7d71\u7d1a\u5225\u7684\u7d44\u4ef6\u80fd\u5920\u57f7\u884c\u9019\u985e\u64cd\u4f5c\u3002 \u5728\u90e8\u7f72\u9700\u8981\u901a\u904e Secret API \u4ea4\u4e92\u7684\u61c9\u7528\u6642\uff0c\u4f60\u61c9\u8a72\u901a\u904e\u4f7f\u7528 RBAC \u9019\u985e\u9451\u6b0a\u7b56\u7565\u4f86\u9650\u5236\u8a2a\u554f\u3002 \u5728 API \u670d\u52d9\u5668\u4e0a\uff0c\u5c0d\u8c61\uff08\u5305\u62ec Secret\uff09\u6703\u88ab\u6301\u4e45\u5316\u5230 etcd \u4e2d\uff1b \u56e0\u6b64\uff1a \u53ea\u61c9\u51c6\u8a31\u96c6\u7fa4\u7ba1\u7406\u54e1\u8a2a\u554f etcd\uff08\u5305\u62ec\u53ea\u8b80\u8a2a\u554f\uff09\uff1b \u70ba Secret \u5c0d\u8c61\u555f\u7528 \u975c\u614b\u52a0\u5bc6 \uff0c \u9019\u6a23\u9019\u4e9b Secret \u7684\u6578\u64da\u5c31\u4e0d\u6703\u4ee5\u660e\u6587\u7684\u5f62\u5f0f\u4fdd\u5b58\u5230 etcd \u4e2d\uff1b \u7576 etcd \u7684\u6301\u4e45\u5316\u5b58\u5132\u4e0d\u518d\u88ab\u4f7f\u7528\u6642\uff0c\u8acb\u8003\u616e\u5fb9\u5e95\u64e6\u9664\u5b58\u5132\u4ecb\u8cea\uff1b \u5982\u679c\u5b58\u5728\u591a\u500b etcd \u5be6\u4f8b\uff0c\u8acb\u78ba\u4fdd etcd \u4f7f\u7528 SSL/TLS \u4f86\u5b8c\u6210\u5176\u5c0d\u7b49\u901a\u4fe1\u3002","title":"\u91dd\u5c0d\u96c6\u7fa4\u7ba1\u7406\u54e1\u7684\u5b89\u5168\u6027\u5efa\u8b70"},{"location":"kubernetes/02-concepts/11-cluster-adm/a-practical-guide-to-k8s-logging/","text":"Kubernetes \u65e5\u8a8c\u8a18\u9304\u5be6\u7528\u6307\u5357 \u00b6 \u539f\u6587: https://logz.io/blog/a-practical-guide-to-kubernetes-logging/ Kubernetes \u5df2\u6210\u70ba\u5bb9\u5668\u7de8\u6392\u4e8b\u5be6\u4e0a\u7684\u884c\u696d\u6a19\u6e96\u3002\u5b83\u63d0\u4f9b\u4e86\u6709\u6548\u7ba1\u7406\u5177\u6709\u8072\u660e\u5f0f\u914d\u7f6e\u3001\u7c21\u55ae\u90e8\u7f72\u6a5f\u5236\u4ee5\u53ca\u64f4\u5c55\u548c\u81ea\u6211\u4fee\u5fa9\u529f\u80fd\u7684\u5927\u578b\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u6240\u9700\u7684\u62bd\u8c61\u3002 \u8207\u4efb\u4f55\u7cfb\u7d71\u4e00\u6a23\uff0c \u65e5\u8a8c \u53ef\u4ee5\u5e6b\u52a9\u5de5\u7a0b\u5e2b\u7372\u5f97\u5c0d\u5bb9\u5668\u548c\u5b83\u5011\u6240\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u7684\u53ef\u89c0\u5bdf\u6027\uff0c\u4e26\u4e14\u5b83\u5011\u6240\u8d77\u7684\u95dc\u9375\u4f5c\u7528\u5728\u8a31\u591a\u4ee5 Kubernetes \u6545\u969c\u70ba\u7279\u5fb5\u7684\u4e8b\u4ef6\u4e2d\u662f\u986f\u800c\u6613\u898b\u7684\u3002\u7136\u800c \u8981\u5b8c\u5584\u5730\u904b\u7dad\u3000Kubernetes \u5fc5\u9700\u9762\u76e3\u4e00\u7cfb\u5217\u7368\u7279\u7684\u65e5\u8a8c\u8a18\u9304\u6311\u6230\u3002 Kubernetes \u662f\u4e00\u500b\u9ad8\u5ea6\u5206\u4f48\u5f0f\u548c\u52d5\u614b\u7684\u74b0\u5883\u3002\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u904b\u884c\u6578\u5341\u53f0\u6a5f\u5668\u548c\u6578\u767e\u500b\u5bb9\u5668\uff0c\u9019\u4e9b\u5bb9\u5668\u53ef\u4ee5\u96a8\u6642\u7d42\u6b62\u3001\u91cd\u65b0\u555f\u52d5\u6216\u91cd\u65b0\u8abf\u5ea6\u3002\u7cfb\u7d71\u7684\u9019\u7a2e\u77ac\u614b\u548c\u52d5\u614b\u7279\u6027\u672c\u8eab\u5c31\u662f\u4e00\u500b\u6311\u6230\u3002 Kubernetes \u96c6\u7fa4\u9084\u5305\u542b\u9700\u8981\u76e3\u63a7\u7684\u591a\u500b\u62bd\u8c61\u5c64\uff0c\u6bcf\u500b\u62bd\u8c61\u5c64\u5c64\u90fd\u6703\u7522\u751f\u4e0d\u540c\u985e\u578b\u7684\u65e5\u8a8c\u3002 \u503c\u5f97\u6176\u5e78\u7684\u662f\uff0c\u6709\u5f88\u591a\u95dc\u65bc\u5982\u4f55\u4e86\u89e3 Kubernetes \u7684\u6587\u737b\u3002\u9084\u6709\u5404\u7a2e\u65e5\u8a8c\u5de5\u5177\u53ef\u4ee5\u8207 Kubernetes \u539f\u751f\u96c6\u6210\uff0c\u4ee5\u7c21\u5316\u4efb\u52d9\u3002\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u56de\u9867\u5176\u4e2d\u4e00\u4e9b\u5de5\u5177\u4ee5\u53ca Kubernetes \u65e5\u8a8c\u67b6\u69cb\u3002 \u4e00\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a\u4f7f\u7528 Kubelet \u9032\u884c\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u8a18\u9304 \u00b6 Logging to stdout and stderr standard output streams \u00b6 \u53ef\u4ee5\u5f9e Kubernetes \u96c6\u7fa4\u6536\u96c6\u7684\u7b2c\u4e00\u5c64\u65e5\u8a8c\u662f\u7531 \u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f \u751f\u6210\u7684\u65e5\u8a8c\u3002 \u6700\u4f73\u5be6\u8e10\u662f\u5c07\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u5beb\u5165\u6a19\u6e96\u8f38\u51fa ( stdout ) \u548c\u6a19\u6e96\u932f\u8aa4 ( stderr ) \u6d41 \u3002\u60a8\u4e0d\u5fc5\u64d4\u5fc3\u4e1f\u5931\u9019\u4e9b\u65e5\u8a8c\uff0c\u56e0\u70ba Kubernetes \u7684\u7bc0\u9ede\u4ee3\u7406 kubelet \u6703\u5728\u5f8c\u53f0\u6536\u96c6\u9019\u4e9b\u6d41\u4e26\u5c07\u5b83\u5011\u5beb\u5165\u672c\u5730\u6587\u4ef6\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u8a2a\u554f\u5b83\u5011\u3002 example.yaml apiVersion : v1 kind : Pod metadata : name : example spec : containers : - name : example image : busybox args : [ /bin/sh , -c , 'while true; do echo $(date); sleep 1; done' ] \u8981\u61c9\u7528\u6e05\u55ae\uff0c\u8acb\u904b\u884c\uff1a kubectl apply -f example.yaml \u67e5\u770b\u6b64\u5bb9\u5668\u7684\u65e5\u8a8c\uff1a kubectl logs pod/example \u8a72\u547d\u4ee4\u8abf\u7528\u8a72\u7bc0\u9ede\u4e0a\u7684 kubelet \u670d\u52d9\u4f86\u6aa2\u7d22\u65e5\u8a8c\u3002\u5982\u60a8\u6240\u898b\uff0c\u65e5\u8a8c\u88ab\u6536\u96c6\u4e26\u8207 Kubernetes \u4e00\u8d77\u5448\u73fe\u3002\u9019\u662f\u91dd\u5c0d\u96c6\u7fa4\u4e2d pod \u4e2d\u7684\u6bcf\u500b\u5bb9\u5668\u5b8c\u6210\u7684\u3002\u4f7f\u7528 kubectl \u6aa2\u7d22\u65e5\u8a8c\u4f7f\u60a8\u7121\u9700\u8a2a\u554f\u96c6\u7fa4\u4e2d\u7684\u5404\u500b\u7bc0\u9ede\u3002 Kubectl \u4e00\u6b21\u53ea\u80fd\u986f\u793a\u4e00\u500b pod \u7684\u65e5\u8a8c\u3002\u5982\u679c\u60a8\u9700\u8981\u5c07\u591a\u500b pod \u805a\u5408\u5230\u4e00\u500b\u6d41\u4e2d\uff0c\u5247\u9700\u8981\u4f7f\u7528 kubetail \u547d\u4ee4\uff0c\u6216\u8005\u6211\u5011\u5c07\u5728\u672c\u6587\u5f8c\u9762\u8a0e\u8ad6\u7684\u66f4\u9ad8\u7d1a\u5225\u7684\u65e5\u8a8c\u805a\u5408\u548c\u7ba1\u7406\u5de5\u5177\u3002 Using a sidecar for logging \u00b6 \u5982\u679c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4e0d\u8f38\u51fa\u5230 stdout \u548c stderr\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u5728\u61c9\u7528\u7a0b\u5e8f\u65c1\u908a\u90e8\u7f72\u4e00\u500b sidecar \u5bb9\u5668\uff0c\u5b83\u5c07\u7372\u53d6\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u4e26\u5c07\u5b83\u5011\u5206\u5225\u6d41\u5f0f\u50b3\u8f38\u5230 stdout \u548c stderr\u3002 \u9019\u6a23\u7684 sidecar \u6a21\u5f0f\u9084\u53ef\u4ee5\u57f7\u884c\u4e00\u4e9b\u65e5\u8a8c\u64cd\u4f5c\uff0c\u4f8b\u5982\u5c07\u7bc0\u9ede\u4e0a\u7684\u591a\u500b\u65e5\u8a8c\u6d41\u805a\u5408\u70ba\u4e00\u500b\uff0c\u6216\u8005\u5c07\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u6d41\u5206\u6210\u591a\u500b\u908f\u8f2f\u6d41\uff08\u6bcf\u500b\u908f\u8f2f\u6d41\u7531\u5c08\u7528\u7684 sidecar \u5be6\u4f8b\u8655\u7406\uff09\u3002 \u5c0d\u65bc\u6301\u4e45\u5316\u5bb9\u5668\u65e5\u8a8c\uff0c\u5e38\u898b\u7684\u505a\u6cd5\u662f\u5c07\u65e5\u8a8c\u5beb\u5165\u65e5\u8a8c\u6587\u4ef6\uff0c\u7136\u5f8c\u4f7f\u7528 sidecar \u5bb9\u5668\uff1a example2.yaml apiVersion : v1 kind : Pod metadata : name : example spec : containers : - name : example image : busybox args : - /bin/sh - -c - > while true; do echo \"$(date)\\n\" >> /var/log/example.log; sleep 1; done volumeMounts : - name : varlog mountPath : /var/log - name : sidecar image : busybox args : [ /bin/sh , -c , 'tail -f /var/log/example.log' ] volumeMounts : - name : varlog mountPath : /var/log volumes : - name : varlog emptyDir : {} \u5982\u4e0a\u9762\u7684 pod \u914d\u7f6e\u6240\u793a\uff0csidecar \u5bb9\u5668\u5c07\u8207\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u4e00\u8d77\u904b\u884c\u5728\u540c\u4e00\u500b pod \u4e2d\uff0c\u639b\u8f09\u76f8\u540c\u7684\u6372\u4e26\u5206\u5225\u8655\u7406\u65e5\u8a8c\u3002 Kubernetes \u65e5\u8a8c\u67b6\u69cb \u00b6 \u5982\u524d\u6240\u8ff0\uff0c\u8a18\u9304 Kubernetes \u7684\u4e00\u500b\u4e3b\u8981\u6311\u6230\u662f\u4e86\u89e3\u751f\u6210\u7684\u65e5\u8a8c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u5011\u3002\u5728\u4ee5\u4e0b\u90e8\u5206\u4e2d\uff0c\u6211\u5c07\u7814\u7a76\u7bc0\u9ede\u65e5\u8a8c\u8a18\u9304\u548c\u96c6\u7fa4\u65e5\u8a8c\u8a18\u9304\u3002","title":"Kubernetes \u65e5\u8a8c\u8a18\u9304\u5be6\u7528\u6307\u5357"},{"location":"kubernetes/02-concepts/11-cluster-adm/a-practical-guide-to-k8s-logging/#kubernetes","text":"\u539f\u6587: https://logz.io/blog/a-practical-guide-to-kubernetes-logging/ Kubernetes \u5df2\u6210\u70ba\u5bb9\u5668\u7de8\u6392\u4e8b\u5be6\u4e0a\u7684\u884c\u696d\u6a19\u6e96\u3002\u5b83\u63d0\u4f9b\u4e86\u6709\u6548\u7ba1\u7406\u5177\u6709\u8072\u660e\u5f0f\u914d\u7f6e\u3001\u7c21\u55ae\u90e8\u7f72\u6a5f\u5236\u4ee5\u53ca\u64f4\u5c55\u548c\u81ea\u6211\u4fee\u5fa9\u529f\u80fd\u7684\u5927\u578b\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u6240\u9700\u7684\u62bd\u8c61\u3002 \u8207\u4efb\u4f55\u7cfb\u7d71\u4e00\u6a23\uff0c \u65e5\u8a8c \u53ef\u4ee5\u5e6b\u52a9\u5de5\u7a0b\u5e2b\u7372\u5f97\u5c0d\u5bb9\u5668\u548c\u5b83\u5011\u6240\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u7684\u53ef\u89c0\u5bdf\u6027\uff0c\u4e26\u4e14\u5b83\u5011\u6240\u8d77\u7684\u95dc\u9375\u4f5c\u7528\u5728\u8a31\u591a\u4ee5 Kubernetes \u6545\u969c\u70ba\u7279\u5fb5\u7684\u4e8b\u4ef6\u4e2d\u662f\u986f\u800c\u6613\u898b\u7684\u3002\u7136\u800c \u8981\u5b8c\u5584\u5730\u904b\u7dad\u3000Kubernetes \u5fc5\u9700\u9762\u76e3\u4e00\u7cfb\u5217\u7368\u7279\u7684\u65e5\u8a8c\u8a18\u9304\u6311\u6230\u3002 Kubernetes \u662f\u4e00\u500b\u9ad8\u5ea6\u5206\u4f48\u5f0f\u548c\u52d5\u614b\u7684\u74b0\u5883\u3002\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u904b\u884c\u6578\u5341\u53f0\u6a5f\u5668\u548c\u6578\u767e\u500b\u5bb9\u5668\uff0c\u9019\u4e9b\u5bb9\u5668\u53ef\u4ee5\u96a8\u6642\u7d42\u6b62\u3001\u91cd\u65b0\u555f\u52d5\u6216\u91cd\u65b0\u8abf\u5ea6\u3002\u7cfb\u7d71\u7684\u9019\u7a2e\u77ac\u614b\u548c\u52d5\u614b\u7279\u6027\u672c\u8eab\u5c31\u662f\u4e00\u500b\u6311\u6230\u3002 Kubernetes \u96c6\u7fa4\u9084\u5305\u542b\u9700\u8981\u76e3\u63a7\u7684\u591a\u500b\u62bd\u8c61\u5c64\uff0c\u6bcf\u500b\u62bd\u8c61\u5c64\u5c64\u90fd\u6703\u7522\u751f\u4e0d\u540c\u985e\u578b\u7684\u65e5\u8a8c\u3002 \u503c\u5f97\u6176\u5e78\u7684\u662f\uff0c\u6709\u5f88\u591a\u95dc\u65bc\u5982\u4f55\u4e86\u89e3 Kubernetes \u7684\u6587\u737b\u3002\u9084\u6709\u5404\u7a2e\u65e5\u8a8c\u5de5\u5177\u53ef\u4ee5\u8207 Kubernetes \u539f\u751f\u96c6\u6210\uff0c\u4ee5\u7c21\u5316\u4efb\u52d9\u3002\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u56de\u9867\u5176\u4e2d\u4e00\u4e9b\u5de5\u5177\u4ee5\u53ca Kubernetes \u65e5\u8a8c\u67b6\u69cb\u3002","title":"Kubernetes \u65e5\u8a8c\u8a18\u9304\u5be6\u7528\u6307\u5357"},{"location":"kubernetes/02-concepts/11-cluster-adm/a-practical-guide-to-k8s-logging/#kubelet","text":"","title":"\u4e00\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a\u4f7f\u7528 Kubelet \u9032\u884c\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u8a18\u9304"},{"location":"kubernetes/02-concepts/11-cluster-adm/a-practical-guide-to-k8s-logging/#logging-to-stdout-and-stderr-standard-output-streams","text":"\u53ef\u4ee5\u5f9e Kubernetes \u96c6\u7fa4\u6536\u96c6\u7684\u7b2c\u4e00\u5c64\u65e5\u8a8c\u662f\u7531 \u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f \u751f\u6210\u7684\u65e5\u8a8c\u3002 \u6700\u4f73\u5be6\u8e10\u662f\u5c07\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u5beb\u5165\u6a19\u6e96\u8f38\u51fa ( stdout ) \u548c\u6a19\u6e96\u932f\u8aa4 ( stderr ) \u6d41 \u3002\u60a8\u4e0d\u5fc5\u64d4\u5fc3\u4e1f\u5931\u9019\u4e9b\u65e5\u8a8c\uff0c\u56e0\u70ba Kubernetes \u7684\u7bc0\u9ede\u4ee3\u7406 kubelet \u6703\u5728\u5f8c\u53f0\u6536\u96c6\u9019\u4e9b\u6d41\u4e26\u5c07\u5b83\u5011\u5beb\u5165\u672c\u5730\u6587\u4ef6\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u8a2a\u554f\u5b83\u5011\u3002 example.yaml apiVersion : v1 kind : Pod metadata : name : example spec : containers : - name : example image : busybox args : [ /bin/sh , -c , 'while true; do echo $(date); sleep 1; done' ] \u8981\u61c9\u7528\u6e05\u55ae\uff0c\u8acb\u904b\u884c\uff1a kubectl apply -f example.yaml \u67e5\u770b\u6b64\u5bb9\u5668\u7684\u65e5\u8a8c\uff1a kubectl logs pod/example \u8a72\u547d\u4ee4\u8abf\u7528\u8a72\u7bc0\u9ede\u4e0a\u7684 kubelet \u670d\u52d9\u4f86\u6aa2\u7d22\u65e5\u8a8c\u3002\u5982\u60a8\u6240\u898b\uff0c\u65e5\u8a8c\u88ab\u6536\u96c6\u4e26\u8207 Kubernetes \u4e00\u8d77\u5448\u73fe\u3002\u9019\u662f\u91dd\u5c0d\u96c6\u7fa4\u4e2d pod \u4e2d\u7684\u6bcf\u500b\u5bb9\u5668\u5b8c\u6210\u7684\u3002\u4f7f\u7528 kubectl \u6aa2\u7d22\u65e5\u8a8c\u4f7f\u60a8\u7121\u9700\u8a2a\u554f\u96c6\u7fa4\u4e2d\u7684\u5404\u500b\u7bc0\u9ede\u3002 Kubectl \u4e00\u6b21\u53ea\u80fd\u986f\u793a\u4e00\u500b pod \u7684\u65e5\u8a8c\u3002\u5982\u679c\u60a8\u9700\u8981\u5c07\u591a\u500b pod \u805a\u5408\u5230\u4e00\u500b\u6d41\u4e2d\uff0c\u5247\u9700\u8981\u4f7f\u7528 kubetail \u547d\u4ee4\uff0c\u6216\u8005\u6211\u5011\u5c07\u5728\u672c\u6587\u5f8c\u9762\u8a0e\u8ad6\u7684\u66f4\u9ad8\u7d1a\u5225\u7684\u65e5\u8a8c\u805a\u5408\u548c\u7ba1\u7406\u5de5\u5177\u3002","title":"Logging to stdout and stderr standard output streams"},{"location":"kubernetes/02-concepts/11-cluster-adm/a-practical-guide-to-k8s-logging/#using-a-sidecar-for-logging","text":"\u5982\u679c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4e0d\u8f38\u51fa\u5230 stdout \u548c stderr\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u5728\u61c9\u7528\u7a0b\u5e8f\u65c1\u908a\u90e8\u7f72\u4e00\u500b sidecar \u5bb9\u5668\uff0c\u5b83\u5c07\u7372\u53d6\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u4e26\u5c07\u5b83\u5011\u5206\u5225\u6d41\u5f0f\u50b3\u8f38\u5230 stdout \u548c stderr\u3002 \u9019\u6a23\u7684 sidecar \u6a21\u5f0f\u9084\u53ef\u4ee5\u57f7\u884c\u4e00\u4e9b\u65e5\u8a8c\u64cd\u4f5c\uff0c\u4f8b\u5982\u5c07\u7bc0\u9ede\u4e0a\u7684\u591a\u500b\u65e5\u8a8c\u6d41\u805a\u5408\u70ba\u4e00\u500b\uff0c\u6216\u8005\u5c07\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u6d41\u5206\u6210\u591a\u500b\u908f\u8f2f\u6d41\uff08\u6bcf\u500b\u908f\u8f2f\u6d41\u7531\u5c08\u7528\u7684 sidecar \u5be6\u4f8b\u8655\u7406\uff09\u3002 \u5c0d\u65bc\u6301\u4e45\u5316\u5bb9\u5668\u65e5\u8a8c\uff0c\u5e38\u898b\u7684\u505a\u6cd5\u662f\u5c07\u65e5\u8a8c\u5beb\u5165\u65e5\u8a8c\u6587\u4ef6\uff0c\u7136\u5f8c\u4f7f\u7528 sidecar \u5bb9\u5668\uff1a example2.yaml apiVersion : v1 kind : Pod metadata : name : example spec : containers : - name : example image : busybox args : - /bin/sh - -c - > while true; do echo \"$(date)\\n\" >> /var/log/example.log; sleep 1; done volumeMounts : - name : varlog mountPath : /var/log - name : sidecar image : busybox args : [ /bin/sh , -c , 'tail -f /var/log/example.log' ] volumeMounts : - name : varlog mountPath : /var/log volumes : - name : varlog emptyDir : {} \u5982\u4e0a\u9762\u7684 pod \u914d\u7f6e\u6240\u793a\uff0csidecar \u5bb9\u5668\u5c07\u8207\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u4e00\u8d77\u904b\u884c\u5728\u540c\u4e00\u500b pod \u4e2d\uff0c\u639b\u8f09\u76f8\u540c\u7684\u6372\u4e26\u5206\u5225\u8655\u7406\u65e5\u8a8c\u3002","title":"Using a sidecar for logging"},{"location":"kubernetes/02-concepts/11-cluster-adm/a-practical-guide-to-k8s-logging/#kubernetes_1","text":"\u5982\u524d\u6240\u8ff0\uff0c\u8a18\u9304 Kubernetes \u7684\u4e00\u500b\u4e3b\u8981\u6311\u6230\u662f\u4e86\u89e3\u751f\u6210\u7684\u65e5\u8a8c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u5011\u3002\u5728\u4ee5\u4e0b\u90e8\u5206\u4e2d\uff0c\u6211\u5c07\u7814\u7a76\u7bc0\u9ede\u65e5\u8a8c\u8a18\u9304\u548c\u96c6\u7fa4\u65e5\u8a8c\u8a18\u9304\u3002","title":"Kubernetes \u65e5\u8a8c\u67b6\u69cb"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/","text":"\u65e5\u8a8c\u5b8c\u6574\u6307\u5357 \u00b6 \u539f\u6587: https://sematext.com/guides/kubernetes-logging/ Kubernetes \u4e2d\u7684\u65e5\u8a8c\u8a18\u9304\u6709\u4f55\u4e0d\u540c \u00b6 Kubernetes \u4e2d\u7684 \u65e5\u8a8c\u805a\u5408 \u8207\u50b3\u7d71\u670d\u52d9\u5668\u6216\u865b\u64ec\u6a5f\u4e0a\u7684\u65e5\u8a8c\u8a18\u9304\u6709\u5f88\u5927\u4e0d\u540c\uff0c\u4e3b\u8981\u662f\u56e0\u70ba\u5b83\u7ba1\u7406\u5176\u61c9\u7528\u7a0b\u5e8f\uff08pod\uff09\u7684\u65b9\u5f0f\u3002 \u7576\u61c9\u7528\u7a0b\u5e8f\u5728\u865b\u64ec\u6a5f\u4e0a\u6b7b\u6a5f\u6642\uff0c\u65e5\u8a8c\u4ecd\u7136\u53ef\u88ab\u67e5\u627e\u5230\uff0c\u76f4\u5230\u60a8\u5c07\u5176\u522a\u9664\u3002 \u5728 Kubernetes \u4e2d\uff0c\u7576 pod \u88ab\u9a45\u9010\u3001\u5d29\u6f70\u3001\u522a\u9664\u6216\u5b89\u6392\u5728\u4e0d\u540c\u7684\u7bc0\u9ede\u4e0a\u6642\uff0c\u4f86\u81ea\u5bb9\u5668\u7684\u65e5\u8a8c\u5c31\u6703\u6d88\u5931\u3002\u7cfb\u7d71\u6703\u81ea\u884c\u6e05\u7406\u3002\u56e0\u6b64\uff0c\u60a8\u6703\u4e1f\u5931\u6709\u95dc\u7570\u5e38\u767c\u751f\u539f\u56e0\u7684\u4efb\u4f55\u4fe1\u606f \u3002 Kubernetes \u4e2d\u9ed8\u8a8d\u65e5\u8a8c\u7684\u77ac\u614b\u7279\u6027\u4f7f\u5f97\u5be6\u65bd\u96c6\u4e2d\u5f0f\u65e5\u8a8c\u7ba1\u7406\u89e3\u6c7a\u65b9\u6848\u8b8a\u5f97\u81f3\u95dc\u91cd\u8981\u3002 \u6211\u5011\u4e0d\u8981\u5fd8\u8a18 Kubernetes \u7684\u9ad8\u5ea6\u5206\u4f48\u5f0f\u548c\u52d5\u614b\u7279\u6027\u3002\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u4f7f\u7528\u591a\u53f0\u6a5f\u5668\uff0c\u6bcf\u53f0\u6a5f\u5668\u90fd\u6709\u591a\u500b\u5bb9\u5668\uff0c\u9019\u4e9b\u5bb9\u5668\u96a8\u6642\u53ef\u80fd\u5d29\u6f70\u3002 Kubernetes \u4e2d\u7684\u65e5\u8a8c\u8a18\u9304\u662f\u5982\u4f55\u5de5\u4f5c\u7684 \u00b6 \u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u5728 Kubernetes \u4e2d\u6536\u96c6\u65e5\u8a8c\uff1a 1. \u4f7f\u7528 Stdout \u548c Stderr \u7684\u57fa\u672c\u65e5\u8a8c\u8a18\u9304 \u00b6 \u5728\u50b3\u7d71\u7684\u670d\u52d9\u5668\u74b0\u5883\u4e2d\uff0c\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u88ab\u5beb\u5165\u4e00\u500b\u6587\u4ef6\uff0c\u4f8b\u5982 /var/log/app.log \u3002\u9019\u4e9b\u65e5\u8a8c\u53ef\u4ee5\u5728\u6bcf\u53f0\u670d\u52d9\u5668\u4e0a\u67e5\u770b\uff0c\u4e5f\u53ef\u4ee5\u7531\u65e5\u8a8c\u4ee3\u7406\u6536\u96c6\uff0c\u5c07\u5b83\u5011\u63a8\u9001\u5230\u4e2d\u5fc3\u4f4d\u7f6e\u4ee5\u9032\u884c\u65e5\u8a8c\u5206\u6790\u548c\u5b58\u5132\u3002 \u4f46\u662f\uff0c\u5728\u4f7f\u7528 Kubernetes \u6642\uff0c\u60a8\u9700\u8981\u8de8\u96c6\u7fa4\u4e2d\u7684\u591a\u500b\u7bc0\u9ede\u6536\u96c6\u591a\u500b\u81e8\u6642 pod\uff08\u61c9\u7528\u7a0b\u5e8f\uff09\u7684\u65e5\u8a8c\uff0c\u9019\u4f7f\u5f97\u9019\u7a2e\u65e5\u8a8c\u6536\u96c6\u65b9\u6cd5\u4e0d\u662f\u6700\u4f73\u7684\u3002\u8de8\u96c6\u7fa4\u4e2d\u7684\u591a\u500b\u670d\u52d9\u5668\u7ba1\u7406\u591a\u500b\u5bb9\u5668\u7684\u591a\u500b\u65e5\u8a8c\u6587\u4ef6\u9700\u8981\u4e00\u7a2e\u65b0\u7684\u3001\u66f4\u53ef\u9760\u7684\u65b9\u6cd5\u3002 \u76f8\u53cd\uff0c\u9ed8\u8a8d\u7684 Kubernetes \u65e5\u8a8c\u6846\u67b6\u5efa\u8b70\u5c07\u7bc0\u9ede\u4e0a\u6bcf\u500b\u5bb9\u5668\u7684\u6a19\u6e96\u8f38\u51fa (stdout) \u548c\u6a19\u6e96\u932f\u8aa4\u8f38\u51fa (stderr) \u81ea\u52d5\u5730\u6355\u7372\u5230\u7279\u5b9a\u7684\u65e5\u8a8c\u6587\u4ef6\u4e2d\u3002\u8a72\u6587\u4ef6\u7531 Kubernetes \u7ba1\u7406\uff0c\u901a\u5e38\u55ae\u4e00\u65e5\u8a8c\u7684\u5bb9\u91cf\u9650\u5236\u70ba 10MB\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u547d\u4ee4 kubectl logs <container name> \u67e5\u770b\u7279\u5b9a\u5bb9\u5668\u7684\u65e5\u8a8c\u3002 \u9019\u662f\u5728\u5bb9\u5668\u4e2d\u751f\u6210\u7684 Nginx \u65e5\u8a8c\u7684\u793a\u4f8b\u3002 kubectl logs <container name> [ Output ] 100 .116.72.129 - - [ 12 /Feb/2020:13:44:12 +0000 ] \"GET /api/user HTTP/1.1\" 200 84 127 .0.0.1 - - [ 12 /Feb/2020:13:44:17 +0000 ] \"GET /server-status?auto HTTP/1.1\" 200 918 10 .4.51.204 - - [ 12 /Feb/2020:13:44:19 +0000 ] \"GET / HTTP/1.1\" 200 3124 100 .116.72.129 - - [ 12 /Feb/2020:13:44:21 +0000 ] \"GET /api/register HTTP/1.1\" 200 84 100 .105.140.197 - - [ 12 /Feb/2020:13:44:21 +0000 ] \"POST /api/stats HTTP/1.1\" 200 122 \u5982\u679c\u8981\u8a2a\u554f\u5d29\u6f70\u5be6\u4f8b\u7684\u65e5\u8a8c\uff0c\u53ef\u4ee5\u4f7f\u7528 \u2013previous \u3002\u6b64\u65b9\u6cd5\u9069\u7528\u65bc\u5177\u6709\u5c11\u91cf\u5bb9\u5668\u548c\u5be6\u4f8b\u7684\u96c6\u7fa4\u3002\u5426\u5247\uff0c\u7576\u61c9\u7528\u7a0b\u5e8f\u6578\u91cf\u589e\u52a0\u4e26\u4e14\u96c6\u7fa4\u5728\u591a\u53f0\u6a5f\u5668\u4e0a\u904b\u884c\u6642\uff0c\u5f88\u96e3\u7ba1\u7406\u96c6\u7fa4\u65e5\u8a8c\u3002\u60a8\u9700\u8981\u4e00\u500b\u53ef\u64f4\u5c55\u7684\u89e3\u6c7a\u65b9\u6848\u3002 2. \u4f7f\u7528\u61c9\u7528\u7d1a\u65e5\u8a8c\u914d\u7f6e \u00b6 \u5982\u679c\u60a8\u4e0d\u60f3\u4f9d\u8cf4\u96c6\u7fa4\u914d\u7f6e\uff0c\u53ef\u4ee5\u4f7f\u7528\u61c9\u7528\u7a0b\u5e8f\u7d1a\u5225\u7684\u65e5\u8a8c\u8a18\u9304\u914d\u7f6e\u3002\u9019\u610f\u5473\u8457\u6bcf\u500b\u5bb9\u5668\u90fd\u6709\u81ea\u5df1\u7684\u65e5\u8a8c\u8a18\u9304\u914d\u7f6e\uff0c\u9019\u672c\u8eab\u5c31\u4f7f\u5f97\u65e5\u8a8c\u8a18\u9304\u8b8a\u5f97\u56f0\u96e3\u4e26\u4e14\u5bb9\u6613\u51fa\u932f\u3002\u6b64\u5916\uff0c\u914d\u7f6e\u4e2d\u7684\u4efb\u4f55\u66f4\u6539\u90fd\u9700\u8981\u60a8\u518d\u6b21\u90e8\u7f72\u6240\u6709\u8981\u76e3\u63a7\u7684\u5bb9\u5668\u3002 3. \u4f7f\u7528\u65e5\u8a8c\u4ee3\u7406 \u00b6 \u6700\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Fluentbit \u7b49\u65e5\u8a8c\u4ee3\u7406\u3002 \u65e5\u8a8c\u4ee3\u7406\u662f\u6536\u96c6 Kubernetes \u65e5\u8a8c\u4e26\u5c07\u5176\u767c\u9001\u5230\u4e2d\u5fc3\u4f4d\u7f6e\u7684\u5de5\u5177\u3002\u9019\u4e9b\u4ee3\u7406\u662f\u8f15\u91cf\u7d1a\u5bb9\u5668\uff0c\u53ef\u4ee5\u8a2a\u554f\u4e00\u500b\u76ee\u9304\uff0c\u5176\u4e2d\u5305\u542b\u4f86\u81ea\u7bc0\u9ede\u4e0a\u6240\u6709\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u8a8c\u3002\u9019\u662f\u6700\u7c21\u55ae\u548c\u6700\u597d\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u56e0\u70ba\u5b83\u4e0d\u6703\u5f71\u97ff\u5df2\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u4e26\u4e14\u7121\u8ad6\u60a8\u5411\u96c6\u7fa4\u6dfb\u52a0\u591a\u5c11\u7bc0\u9ede\uff0c\u5b83\u90fd\u662f\u5b8c\u5168\u53ef\u64f4\u5c55\u7684\u3002\u8a2d\u7f6e\u4e5f\u975e\u5e38\u7c21\u55ae\u3002\u53ea\u904b\u884c\u4e00\u500b\u547d\u4ee4\uff0c\u4f60\u5c31\u5b8c\u6210\u4e86\u3002 Kubernetes \u65e5\u8a8c\u7684\u985e\u578b \u00b6 \u5982\u524d\u6240\u8ff0\uff0c\u5728 Kubernetes \u4e2d\u6709\u4e0d\u540c\u5c64\u7d1a\u7684\u65e5\u8a8c\uff0c\u6240\u6709\u5c64\u7d1a\u90fd\u5305\u542b\u4e0d\u540c\u4f46\u6709\u7528\u7684\u4fe1\u606f\uff0c\u5177\u9ad4\u7684\u4f7f\u7528\u53d6\u6c7a\u65bc\u60a8\u7684\u5834\u666f\u3002\u5728 Kubernetes \u7cfb\u7d71\u4e2d\uff0c\u4e3b\u8981\u6709\u4e09\u7a2e\u985e\u578b\u7684\u65e5\u8a8c\uff1a\u5bb9\u5668\u65e5\u8a8c\u3001\u7bc0\u9ede\u65e5\u8a8c\u548c\u96c6\u7fa4\uff08\u6216\u7cfb\u7d71\u7d44\u4ef6\uff09\u65e5\u8a8c\u3002 \u5bb9\u5668\u65e5\u8a8c \u00b6 \u5bb9\u5668\u65e5\u8a8c\u662f\u7531\u60a8\u7684\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u751f\u6210\u7684\u65e5\u8a8c\u3002\u6355\u7372\u5bb9\u5668\u65e5\u8a8c\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u4f7f\u7528 stdout \u548c stderr \u3002 \u5047\u8a2d\u60a8\u6709\u4e00\u500b\u540d\u70ba app \u7684 Pod\uff0c\u60a8\u5728\u5176\u4e2d\u5c07\u67d0\u4e9b\u5167\u5bb9\u8a18\u9304\u5230\u6a19\u6e96\u8f38\u51fa\u3002 apiVersion : v1 kind : Pod metadata : name : app spec : containers : - name : count image : busybox args : [ /bin/sh , -c , 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done' ] \u901a\u904e\u904b\u884c\u61c9\u7528\u6b64\u914d\u7f6e\u6587\u4ef6\uff1a kubectl apply -f app.yaml \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u7372\u53d6\u65e5\u8a8c\uff1a kubectl logs app \u60a8\u5c07\u7acb\u5373\u5728\u7d42\u7aef\u7a97\u53e3\u4e2d\u770b\u5230\u8f38\u51fa\u3002 [Output] 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ... \u7bc0\u9ede\u65e5\u8a8c \u00b6 \u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u5beb\u5165 stdout \u6216 stderr \u7684\u6240\u6709\u5167\u5bb9\u90fd\u7531\u5bb9\u5668\u5f15\u64ce\u6d41\u5f0f\u50b3\u8f38\u5230\u67d0\u500b\u5730\u65b9\u2014\u2014\u5728 Kubernetes \u7684\u74b0\u5883\uff0c\u4f8b\u5982\uff0c\u50b3\u8f38\u5230\u65e5\u8a8c\u9a45\u52d5\u7a0b\u5e8f\u3002\u9019\u4e9b\u65e5\u8a8c\u901a\u5e38\u4f4d\u65bc\u4e3b\u6a5f\u4e0a\u7684 /var/log/pods \u76ee\u9304\u4e2d\u3002 \u5982\u679c\u5bb9\u5668\u91cd\u65b0\u555f\u52d5\uff0ckubelet \u6703\u5728\u7bc0\u9ede\u4e0a\u4fdd\u7559\u65e5\u8a8c\u3002\u70ba\u4e86\u9632\u6b62\u65e5\u8a8c\u586b\u6eff\u7bc0\u9ede\u4e0a\u7684\u6240\u6709\u53ef\u7528\u7a7a\u9593\uff0cKubernetes \u8a2d\u7f6e\u4e86\u65e5\u8a8c\u8f2a\u63db\u7b56\u7565\u3002\u56e0\u6b64\uff0c\u7576\u4e00\u500b pod \u88ab\u9010\u51fa\u7bc0\u9ede\u6642\uff0c\u6240\u6709\u76f8\u61c9\u7684\u5bb9\u5668\u4ee5\u53ca\u5b83\u5011\u7684\u65e5\u8a8c\u4e5f\u6703\u88ab\u9010\u51fa\u3002 \u6839\u64da\u60a8\u7684\u64cd\u4f5c\u7cfb\u7d71\u548c\u670d\u52d9\uff0c\u60a8\u53ef\u4ee5\u6536\u96c6\u5404\u7a2e\u7bc0\u9ede\u7d1a\u5225\u7684\u65e5\u8a8c\uff0c\u4f8b\u5982\u5167\u6838\u65e5\u8a8c\u6216 systemd \u65e5\u8a8c\u3002 \u5728\u5177\u6709 systemd \u7684\u7bc0\u9ede\u4e0a\uff0ckubelet \u548c container runtime \u90fd\u5beb\u5165 journald\u3002\u5982\u679c systemd \u4e0d\u5b58\u5728\uff0c\u5b83\u5011\u6703\u5beb\u5165 /var/log \u76ee\u9304\u4e2d\u7684 .log \u6587\u4ef6\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 journalctl \u547d\u4ee4\u8a2a\u554f systemd \u65e5\u8a8c\u3002\u9019\u5c07\u8f38\u51fa\u65e5\u8a8c\u884c\u5217\u8868\u3002\u5982\u679c\u60a8\u5728\u7bc0\u9ede\u4e0a\u6c92\u6709 systemd\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u50cf\u5728\u50b3\u7d71\u670d\u52d9\u5668\u74b0\u5883\u4e2d\u4e00\u6a23\u7ba1\u7406\u65e5\u8a8c\u3002 $ journalctl [ output ] -- Logs begin at Thu 2020 -01-23 09 :15:28 CET, end at Thu 2020 -01-23 14 :43:00 CET. -- Jan 23 09 :15:28 raha-pc systemd-journald [ 267 ] : Runtime journal ( /run/log/journal/ ) is 8 .0M, max 114 .2M, 106 .2M free. Jan 23 09 :15:28 pc kernel: microcode: microcode updated early to revision 0xd6, date = 2019 -10-03 \u96c6\u7fa4\uff08\u6216\u7cfb\u7d71\u7d44\u4ef6\uff09\u65e5\u8a8c \u00b6 Kubernetes \u96c6\u7fa4\u65e5\u8a8c\u662f\u6307 Kubernetes \u672c\u8eab\u53ca\u5176\u6240\u6709\u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c\uff0c\u6211\u5011\u53ef\u4ee5\u5340\u5206\u904b\u884c\u5728\u5bb9\u5668\u4e2d\u7684\u7d44\u4ef6\u548c\u4e0d\u904b\u884c\u5728\u5bb9\u5668\u4e2d\u7684\u7d44\u4ef6\u3002\u6bcf\u500b\u90fd\u6709\u81ea\u5df1\u7684\u89d2\u8272\uff0c\u8b93\u60a8\u6df1\u5165\u4e86\u89e3 Kubernetes \u7cfb\u7d71\u7684\u5065\u5eb7\u72c0\u6cc1\u3002\u4f8b\u5982\uff0ckube-scheduler\u3001kube-apiserver\u3001etcd \u548c kube-proxy \u5728\u5bb9\u5668\u5167\u904b\u884c\uff0c\u800c kubelet \u548c\u5bb9\u5668\u904b\u884c\u6642\u904b\u884c\u5728\u64cd\u4f5c\u7cfb\u7d71\u7d1a\u5225\uff0c\u901a\u5e38\u4f5c\u70ba systemd \u670d\u52d9\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5bb9\u5668\u5916\u7684\u7cfb\u7d71\u7d44\u4ef6\u5c07\u6587\u4ef6\u5beb\u5165 journald \uff0c\u800c\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684\u7d44\u4ef6\u5beb\u5165 /var/log \u76ee\u9304\u3002\u4f46\u662f\uff0c\u53ef\u4ee5\u9078\u64c7\u5c07\u5bb9\u5668\u5f15\u64ce\u914d\u7f6e\u70ba\u5c07\u65e5\u8a8c\u6d41\u5f0f\u50b3\u8f38\u5230\u9996\u9078\u4f4d\u7f6e\u3002 Kubernetes \u6c92\u6709\u70ba\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8a18\u9304\u63d0\u4f9b\u539f\u751f\u89e3\u6c7a\u65b9\u6848\u3002\u4f46\u662f\uff0c\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u65b9\u6cd5\uff1a \u4f7f\u7528\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u5728\u61c9\u7528\u7a0b\u5e8f pod \u4e2d\u6dfb\u52a0\u7528\u65bc\u65e5\u8a8c\u8a18\u9304\u7684 sidecar \u5bb9\u5668 \u76f4\u63a5\u5f9e\u61c9\u7528\u7a0b\u5e8f\u516c\u958b\u65e5\u8a8c\u3002 \u9664\u4e86\u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c\uff0c\u60a8\u9084\u53ef\u4ee5\u8a18\u9304 Kubernetes \u4e8b\u4ef6\u548c\u5be9\u8a08\u65e5\u8a8c\u3002 Kubernetes Events \u65e5\u8a8c \u00b6 Kubernetes \u4e8b\u4ef6\u5305\u542b\u6709\u95dc\u8cc7\u6e90\u72c0\u614b\u66f4\u6539\u6216\u932f\u8aa4\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u70ba\u4ec0\u9ebc pod \u88ab\u9a45\u9010\u6216\u8abf\u5ea6\u7a0b\u5e8f\u505a\u51fa\u4e86\u4ec0\u9ebc\u6c7a\u5b9a\uff0c\u4ee5\u53ca\u5176\u4ed6\u4fe1\u606f\u6027\u6d88\u606f\uff0c\u53ef\u63d0\u4f9b\u5c0d\u96c6\u7fa4\u5167\u90e8\u6b63\u5728\u767c\u751f\u7684\u4e8b\u60c5\u7684\u6d1e\u5bdf\u529b\u3002 \u4e8b\u4ef6\u662f\u5b58\u5132\u5728 master \u4e0a\u7684 apiserver \u4e2d\u7684 API \u5c0d\u8c61\u3002\u8207\u7bc0\u9ede\u65e5\u8a8c\u8a18\u9304\u985e\u4f3c\uff0c\u8a2d\u7f6e\u4e86\u522a\u9664\u6a5f\u5236\u4ee5\u907f\u514d\u4f7f\u7528\u6240\u6709\u4e3b\u7bc0\u9ede\u7684\u78c1\u76e4\u7a7a\u9593\u3002\u56e0\u6b64\uff0c Kubernetes \u5728\u6700\u5f8c\u4e00\u6b21\u767c\u751f\u4e00\u5c0f\u6642\u5f8c\u522a\u9664\u4e8b\u4ef6 \u3002\u5982\u679c\u60a8\u60f3\u5728\u66f4\u9577\u7684\u6642\u9593\u5167\u6355\u7372\u4e8b\u4ef6\uff0c\u60a8\u9700\u8981\u5b89\u88dd\u7b2c\u4e09\u65b9\u89e3\u6c7a\u65b9\u6848\uff0c\u5c31\u50cf\u6211\u5011\u5728\u4e0a\u9762\u7684\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u90e8\u5206\u4e2d\u89e3\u91cb\u7684\u90a3\u6a23\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5feb\u901f\u6aa2\u67e5\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u4e8b\u4ef6\uff1a kubectl get events -n <namespace> [Output] LAST SEEN TYPE REASON OBJECT MESSAGE 3m58s Normal NoPods kube-dns No matching pods found 9m31s Normal Killing pod/app Stopping container app 9m32s Normal DELETE pod/app Starting container app ... \u5982\u679c\u60a8\u4e0d\u60f3\u6aa2\u67e5\u6574\u500b\u547d\u540d\u7a7a\u9593\uff0c\u800c\u53ea\u60f3\u6aa2\u67e5\u55ae\u500b Pod\uff0c\u60a8\u4e5f\u53ef\u4ee5\u9019\u6a23\u505a\u3002 kubectl describe pod <pod-name> [ Output ] Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 41m default-scheduler Successfully assigned app to ip-xx-xx-xx-xx Normal Pulled 41m kubelet, ip-xx Container image \"app-image\" already present on machine Normal Created 41m kubelet, ip-xx Created container app Normal Started 41m kubelet, ip-xx Started container app \u7406\u60f3\u60c5\u6cc1\u4e0b\uff0c\u60a8\u6c38\u9060\u4e0d\u9700\u8981\u5728\u7d42\u7aef\u4e2d\u904b\u884c\u9019\u4e9b\u547d\u4ee4\uff0c\u800c\u662f\u4f7f\u7528\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8a18\u9304\u8a2d\u7f6e\u5c07\u9019\u4e9b\u4e8b\u4ef6\u767c\u9001\u5230\u4e00\u500b\u4e2d\u5fc3\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u5728\u5176\u4e2d\u67e5\u770b\u5b83\u5011\u4ee5\u53ca\u60a8\u64c1\u6709\u7684\u4efb\u4f55\u65e5\u8a8c\u3002 Kubernetes \u5be9\u8a08\u65e5\u8a8c \u00b6 Kubernetes \u5be9\u8a08\u65e5\u8a8c\u662f\u5c0d kube-apiserver \u7684\u6bcf\u6b21\u8abf\u7528\u7684\u8a73\u7d30\u63cf\u8ff0\u3002\u5b83\u5011\u63d0\u4f9b\u4e86\u6309\u6642\u9593\u9806\u5e8f\u6392\u5217\u7684\u6d3b\u52d5\uff0c\u9019\u4e9b\u6d3b\u52d5\u5c0e\u81f4\u7cfb\u7d71\u5728\u7279\u5b9a\u6642\u523b\u7684\u72c0\u614b\u3002\u5b83\u5011\u5c0d\u65bc\u5b89\u5168\u6027\u548c\u5408\u898f\u6027\u76ee\u7684\u975e\u5e38\u6709\u7528\uff0c\u53ef\u4ee5\u6e96\u78ba\u5730\u544a\u8a34\u60a8\u8ab0\u505a\u4e86\u4ec0\u9ebc\u3001\u4f55\u6642\u4ee5\u53ca\u5982\u4f55\u505a\u7684\u3002 Kubernetes Ingress \u65e5\u8a8c \u00b6 Kubernetes Ingress \u6b63\u5728\u6210\u70ba\u5c07\u4f86\u81ea\u96c6\u7fa4\u5916\u90e8\u7684 HTTP \u548c HTTPS \u8def\u7531\u66b4\u9732\u7d66\u96c6\u7fa4\u5167\u670d\u52d9\u7684\u4e8b\u5be6\u6a19\u6e96\u3002\u9019\u4f7f\u5f97\u5165\u53e3\u65e5\u8a8c\u5c0d\u65bc\u8ddf\u8e2a\u670d\u52d9\u6027\u80fd\u3001\u554f\u984c\u3001\u932f\u8aa4\u751a\u81f3\u96c6\u7fa4\u7684\u5b89\u5168\u6027\u975e\u5e38\u91cd\u8981\u3002 Kubernetes \u65e5\u8a8c\u6700\u4f73\u5be6\u8e10 \u00b6 \u60a8\u73fe\u5728\u53ef\u80fd\u5df2\u7d93\u77e5\u9053\uff0c\u65e5\u8a8c\u7cfb\u7d71\u7684\u8a2d\u8a08\u5728 Kubernetes \u7684\u74b0\u5883\u4e0b\u662f\u4e00\u500b\u6311\u6230\u3002\u4f46\u662f\uff0c\u6709\u8db3\u5920\u7684\u95dc\u65bc\u8a72\u4e3b\u984c\u7684\u6587\u737b\u4f86\u7de8\u8b6f\u60a8\u61c9\u8a72\u9075\u5faa\u7684\u6700\u4f73\u5be6\u8e10\u5217\u8868\uff0c\u4ee5\u78ba\u4fdd\u60a8\u6355\u7372\u6240\u9700\u7684\u65e5\u8a8c\u3002 \u8a2d\u7f6e\u65e5\u8a8c\u7cfb\u7d71 \u00b6 \u8a2a\u554f Kubernetes \u65e5\u8a8c\u76f8\u7576\u5bb9\u6613\u3002\u6311\u6230\u5728\u65bc\u5c07\u5b83\u5011\u767c\u9001\u548c\u5b58\u5132\u5230\u54ea\u88e1\uff0c\u4ee5\u4fbf\u5c07\u4f86\u4f7f\u7528\u3002\u7121\u8ad6\u60a8\u7684\u7528\u4f8b\u662f\u4ec0\u9ebc\uff0c\u60a8\u9078\u64c7\u7684\u65e5\u8a8c\u7ba1\u9053\uff08\u7121\u8ad6\u662f\u5167\u90e8\u7684\u9084\u662f\u670d\u52d9\u7684\uff09\u90fd\u9700\u8981\u5c07\u65e5\u8a8c\u767c\u9001\u5230\u4f4d\u65bc\u55ae\u7368\u548c\u9694\u96e2\u74b0\u5883\u4e2d\u7684\u4e2d\u5fc3\u4f4d\u7f6e\u3002 \u5efa\u7acb\u4fdd\u7559\u6a5f\u5236 \u00b6 \u7121\u8ad6\u60a8\u9078\u64c7\u5728\u5167\u90e8\u57f7\u884c\u65e5\u8a8c\u8a18\u9304\u9084\u662f\u4f7f\u7528\u7b2c\u4e09\u65b9\u670d\u52d9\uff0c\u65e5\u8a8c\u4ecd\u7136\u6703\u4f54\u7528\u5927\u91cf\u7a7a\u9593\u3002\u56e0\u6b64\uff0c\u8acb\u78ba\u4fdd\u60a8\u6709\u4e00\u500b\u660e\u78ba\u7684\u4fdd\u7559\u7b56\u7565\u4f86\u5b58\u5132\u65e5\u8a8c\u4ee5\u4f9b\u5c07\u4f86\u4f7f\u7528\u3002\u66f4\u9ad8\u7684\u4fdd\u7559\u653f\u7b56\u901a\u5e38\u6210\u672c\u66f4\u9ad8\u3002\u56e0\u6b64\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u6839\u64da\u60a8\u7684 Kubernetes \u74b0\u5883\u4f30\u8a08\u6240\u9700\u7684\u78c1\u76e4\u7a7a\u9593\u3002\u7576\u7136\uff0c\u8a17\u7ba1\u65e5\u8a8c\u670d\u52d9\u5c07\u964d\u4f4e\u8207 Kubernetes \u65e5\u8a8c\u76f8\u95dc\u7684\u57fa\u790e\u8a2d\u65bd\u6210\u672c\uff0c\u4e26\u63d0\u4f9b\u57fa\u65bc\u6578\u91cf\u7684\u6298\u6263\u3002 \u5c07\u65e5\u8a8c\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\u548c\u6a19\u6e96\u932f\u8aa4 \u00b6 \u5118\u7ba1\u9019\u662f\u9077\u79fb\u5230\u5bb9\u5668\u5316\u74b0\u5883\u6642\u7684\u6a19\u6e96\u505a\u6cd5\uff0c\u4f46\u4e00\u4e9b\u516c\u53f8\u4ecd\u7136\u7de8\u5beb\u8a18\u9304\u5230\u6587\u4ef6\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5c07\u65e5\u8a8c\u91cd\u5b9a\u5411\u5230 stdout \u548c stderr \u5141\u8a31 Kubernetes \u7684\u96c6\u4e2d\u5f0f\u65e5\u8a8c\u6846\u67b6\u767c\u63ee\u4f5c\u7528\uff0c\u4e26\u81ea\u52d5\u5c07\u65e5\u8a8c\u6d41\u5f0f\u50b3\u8f38\u5230\u4efb\u4f55\u6240\u9700\u7684\u4f4d\u7f6e\u3002 \u6b64\u5916\uff0c\u5c07\u932f\u8aa4\u5206\u96e2\u5230\u932f\u8aa4\u6d41\u4e2d\u6709\u52a9\u65bc\u65e5\u8a8c\u6536\u96c6\uff0c\u4e26\u4f7f\u60a8\u66f4\u5bb9\u6613\u904e\u6ffe\u65e5\u8a8c\u3002 \u4f7f\u7528\u55ae\u7368\u7684\u96c6\u7fa4\u9032\u884c\u958b\u767c\u548c\u751f\u7522 \u00b6 \u901a\u904e\u70ba dev \u548c prod \u5275\u5efa\u55ae\u7368\u7684\u96c6\u7fa4\uff0c\u60a8\u53ef\u4ee5\u907f\u514d\u8af8\u5982\u522a\u9664\u751f\u7522\u4e2d\u81f3\u95dc\u91cd\u8981\u7684 pod \u4e4b\u985e\u7684\u4e8b\u6545\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl config use-context \u547d\u4ee4\u5728\u5169\u8005\u4e4b\u9593\u8f15\u9b06\u5207\u63db\u3002\u60a8\u61c9\u8a72\u4f7f\u7528\u76f8\u540c\u7684\u65b9\u6cd5\u5c07 dev \u548c prod \u65e5\u8a8c\u4fdd\u5b58\u5728\u4e0d\u540c\u7684\u4f4d\u7f6e\u3002 \u907f\u514d\u4f7f\u7528 Sidecar \u5bb9\u5668\u9032\u884c\u65e5\u8a8c\u8a18\u9304 \u00b6 Kubernetes \u6700\u4f73\u5be6\u8e10\u6307\u51fa\uff0c\u60a8\u61c9\u8a72\u59cb\u7d42\u5617\u8a66\u6bcf\u500b pod \u64c1\u6709\u4e00\u500b\u5bb9\u5668\u5be6\u4f8b\u3002\u9019\u610f\u5473\u8457\u4e00\u500b pod \u61c9\u8a72\u53ea\u5177\u6709\u7531\u540c\u4e00\u93e1\u50cf\u5b9a\u7fa9\u7684\u540c\u4e00\u5bb9\u5668\u7684\u5be6\u4f8b\u3002\u7136\u5f8c\u53ef\u4ee5\u5728 pod \u4e2d\u5fa9\u5236\u6b64\u5bb9\u5668\uff0c\u4e26\u4e14\u60a8\u6700\u7d42\u53ef\u4ee5\u5728 pod \u4e2d\u64c1\u6709\u591a\u500b\u5bb9\u5668\u3002\u4f46\u662f\uff0c\u5b83\u5011\u4ecd\u7136\u662f\u5f9e\u540c\u4e00\u500b\u5be6\u4f8b\u69cb\u5efa\u7684\u3002 Sidecar \u662f\u540c\u4e00\u500b pod \u4e2d\u7684\u7b2c\u4e8c\u500b\u5bb9\u5668\uff0c\u5b83\u6355\u7372\u5be6\u969b\u61c9\u7528\u6240\u5728\u7684\u7b2c\u4e00\u500b\u5bb9\u5668\u7684\u8f38\u51fa\u3002\u56e0\u6b64\uff0c\u5b83\u5f9e\u6bcf\u500b pod \u7d1a\u5225\u4f54\u7528\u8cc7\u6e90\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u7684\u7bc0\u9ede\u4e0a\u6709 5 \u500b Pod \u904b\u884c\uff0c\u4e26\u4e14\u5e36\u6709 sidecar\uff0c\u90a3\u9ebc\u60a8\u5be6\u969b\u4e0a\u4f7f\u7528\u4e86 10 \u500b\u65e5\u8a8c\u5bb9\u5668\u3002 \u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0csidecar \u5bb9\u5668\u662f\u7121\u6cd5\u907f\u514d\u7684\uff0c\u4f8b\u5982\u7576\u60a8\u7121\u6cd5\u63a7\u5236\u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u5b83\u6703\u5c07\u65e5\u8a8c\u5beb\u5165\u6587\u4ef6\uff0c\u6216\u8005\u60a8\u60f3\u96b1\u85cf Kubernetes \u65e5\u8a8c\u6846\u67b6\u7684\u8f38\u51fa\u3002 \u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u89e3\u6c7a\u65b9\u6848\u662f\u4f7f\u7528\u55ae\u500b\u5bb9\u5668\u5f9e\u6574\u500b\u7bc0\u9ede\u4e00\u6b21\u6536\u96c6\u6240\u6709\u65e5\u8a8c\uff0c\u800c\u4e0d\u662f\u5728\u7bc0\u9ede\u7d1a\u5225\u6536\u96c6\u5b83\u5011\u3002","title":"\u65e5\u8a8c\u5b8c\u6574\u6307\u5357"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_1","text":"\u539f\u6587: https://sematext.com/guides/kubernetes-logging/","title":"\u65e5\u8a8c\u5b8c\u6574\u6307\u5357"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#kubernetes","text":"Kubernetes \u4e2d\u7684 \u65e5\u8a8c\u805a\u5408 \u8207\u50b3\u7d71\u670d\u52d9\u5668\u6216\u865b\u64ec\u6a5f\u4e0a\u7684\u65e5\u8a8c\u8a18\u9304\u6709\u5f88\u5927\u4e0d\u540c\uff0c\u4e3b\u8981\u662f\u56e0\u70ba\u5b83\u7ba1\u7406\u5176\u61c9\u7528\u7a0b\u5e8f\uff08pod\uff09\u7684\u65b9\u5f0f\u3002 \u7576\u61c9\u7528\u7a0b\u5e8f\u5728\u865b\u64ec\u6a5f\u4e0a\u6b7b\u6a5f\u6642\uff0c\u65e5\u8a8c\u4ecd\u7136\u53ef\u88ab\u67e5\u627e\u5230\uff0c\u76f4\u5230\u60a8\u5c07\u5176\u522a\u9664\u3002 \u5728 Kubernetes \u4e2d\uff0c\u7576 pod \u88ab\u9a45\u9010\u3001\u5d29\u6f70\u3001\u522a\u9664\u6216\u5b89\u6392\u5728\u4e0d\u540c\u7684\u7bc0\u9ede\u4e0a\u6642\uff0c\u4f86\u81ea\u5bb9\u5668\u7684\u65e5\u8a8c\u5c31\u6703\u6d88\u5931\u3002\u7cfb\u7d71\u6703\u81ea\u884c\u6e05\u7406\u3002\u56e0\u6b64\uff0c\u60a8\u6703\u4e1f\u5931\u6709\u95dc\u7570\u5e38\u767c\u751f\u539f\u56e0\u7684\u4efb\u4f55\u4fe1\u606f \u3002 Kubernetes \u4e2d\u9ed8\u8a8d\u65e5\u8a8c\u7684\u77ac\u614b\u7279\u6027\u4f7f\u5f97\u5be6\u65bd\u96c6\u4e2d\u5f0f\u65e5\u8a8c\u7ba1\u7406\u89e3\u6c7a\u65b9\u6848\u8b8a\u5f97\u81f3\u95dc\u91cd\u8981\u3002 \u6211\u5011\u4e0d\u8981\u5fd8\u8a18 Kubernetes \u7684\u9ad8\u5ea6\u5206\u4f48\u5f0f\u548c\u52d5\u614b\u7279\u6027\u3002\u5728\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u60a8\u5f88\u53ef\u80fd\u6703\u4f7f\u7528\u591a\u53f0\u6a5f\u5668\uff0c\u6bcf\u53f0\u6a5f\u5668\u90fd\u6709\u591a\u500b\u5bb9\u5668\uff0c\u9019\u4e9b\u5bb9\u5668\u96a8\u6642\u53ef\u80fd\u5d29\u6f70\u3002","title":"Kubernetes \u4e2d\u7684\u65e5\u8a8c\u8a18\u9304\u6709\u4f55\u4e0d\u540c"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#kubernetes_1","text":"\u60a8\u53ef\u4ee5\u901a\u904e\u591a\u7a2e\u65b9\u5f0f\u5728 Kubernetes \u4e2d\u6536\u96c6\u65e5\u8a8c\uff1a","title":"Kubernetes \u4e2d\u7684\u65e5\u8a8c\u8a18\u9304\u662f\u5982\u4f55\u5de5\u4f5c\u7684"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#1-stdout-stderr","text":"\u5728\u50b3\u7d71\u7684\u670d\u52d9\u5668\u74b0\u5883\u4e2d\uff0c\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u88ab\u5beb\u5165\u4e00\u500b\u6587\u4ef6\uff0c\u4f8b\u5982 /var/log/app.log \u3002\u9019\u4e9b\u65e5\u8a8c\u53ef\u4ee5\u5728\u6bcf\u53f0\u670d\u52d9\u5668\u4e0a\u67e5\u770b\uff0c\u4e5f\u53ef\u4ee5\u7531\u65e5\u8a8c\u4ee3\u7406\u6536\u96c6\uff0c\u5c07\u5b83\u5011\u63a8\u9001\u5230\u4e2d\u5fc3\u4f4d\u7f6e\u4ee5\u9032\u884c\u65e5\u8a8c\u5206\u6790\u548c\u5b58\u5132\u3002 \u4f46\u662f\uff0c\u5728\u4f7f\u7528 Kubernetes \u6642\uff0c\u60a8\u9700\u8981\u8de8\u96c6\u7fa4\u4e2d\u7684\u591a\u500b\u7bc0\u9ede\u6536\u96c6\u591a\u500b\u81e8\u6642 pod\uff08\u61c9\u7528\u7a0b\u5e8f\uff09\u7684\u65e5\u8a8c\uff0c\u9019\u4f7f\u5f97\u9019\u7a2e\u65e5\u8a8c\u6536\u96c6\u65b9\u6cd5\u4e0d\u662f\u6700\u4f73\u7684\u3002\u8de8\u96c6\u7fa4\u4e2d\u7684\u591a\u500b\u670d\u52d9\u5668\u7ba1\u7406\u591a\u500b\u5bb9\u5668\u7684\u591a\u500b\u65e5\u8a8c\u6587\u4ef6\u9700\u8981\u4e00\u7a2e\u65b0\u7684\u3001\u66f4\u53ef\u9760\u7684\u65b9\u6cd5\u3002 \u76f8\u53cd\uff0c\u9ed8\u8a8d\u7684 Kubernetes \u65e5\u8a8c\u6846\u67b6\u5efa\u8b70\u5c07\u7bc0\u9ede\u4e0a\u6bcf\u500b\u5bb9\u5668\u7684\u6a19\u6e96\u8f38\u51fa (stdout) \u548c\u6a19\u6e96\u932f\u8aa4\u8f38\u51fa (stderr) \u81ea\u52d5\u5730\u6355\u7372\u5230\u7279\u5b9a\u7684\u65e5\u8a8c\u6587\u4ef6\u4e2d\u3002\u8a72\u6587\u4ef6\u7531 Kubernetes \u7ba1\u7406\uff0c\u901a\u5e38\u55ae\u4e00\u65e5\u8a8c\u7684\u5bb9\u91cf\u9650\u5236\u70ba 10MB\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u547d\u4ee4 kubectl logs <container name> \u67e5\u770b\u7279\u5b9a\u5bb9\u5668\u7684\u65e5\u8a8c\u3002 \u9019\u662f\u5728\u5bb9\u5668\u4e2d\u751f\u6210\u7684 Nginx \u65e5\u8a8c\u7684\u793a\u4f8b\u3002 kubectl logs <container name> [ Output ] 100 .116.72.129 - - [ 12 /Feb/2020:13:44:12 +0000 ] \"GET /api/user HTTP/1.1\" 200 84 127 .0.0.1 - - [ 12 /Feb/2020:13:44:17 +0000 ] \"GET /server-status?auto HTTP/1.1\" 200 918 10 .4.51.204 - - [ 12 /Feb/2020:13:44:19 +0000 ] \"GET / HTTP/1.1\" 200 3124 100 .116.72.129 - - [ 12 /Feb/2020:13:44:21 +0000 ] \"GET /api/register HTTP/1.1\" 200 84 100 .105.140.197 - - [ 12 /Feb/2020:13:44:21 +0000 ] \"POST /api/stats HTTP/1.1\" 200 122 \u5982\u679c\u8981\u8a2a\u554f\u5d29\u6f70\u5be6\u4f8b\u7684\u65e5\u8a8c\uff0c\u53ef\u4ee5\u4f7f\u7528 \u2013previous \u3002\u6b64\u65b9\u6cd5\u9069\u7528\u65bc\u5177\u6709\u5c11\u91cf\u5bb9\u5668\u548c\u5be6\u4f8b\u7684\u96c6\u7fa4\u3002\u5426\u5247\uff0c\u7576\u61c9\u7528\u7a0b\u5e8f\u6578\u91cf\u589e\u52a0\u4e26\u4e14\u96c6\u7fa4\u5728\u591a\u53f0\u6a5f\u5668\u4e0a\u904b\u884c\u6642\uff0c\u5f88\u96e3\u7ba1\u7406\u96c6\u7fa4\u65e5\u8a8c\u3002\u60a8\u9700\u8981\u4e00\u500b\u53ef\u64f4\u5c55\u7684\u89e3\u6c7a\u65b9\u6848\u3002","title":"1. \u4f7f\u7528 Stdout \u548c Stderr \u7684\u57fa\u672c\u65e5\u8a8c\u8a18\u9304"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#2","text":"\u5982\u679c\u60a8\u4e0d\u60f3\u4f9d\u8cf4\u96c6\u7fa4\u914d\u7f6e\uff0c\u53ef\u4ee5\u4f7f\u7528\u61c9\u7528\u7a0b\u5e8f\u7d1a\u5225\u7684\u65e5\u8a8c\u8a18\u9304\u914d\u7f6e\u3002\u9019\u610f\u5473\u8457\u6bcf\u500b\u5bb9\u5668\u90fd\u6709\u81ea\u5df1\u7684\u65e5\u8a8c\u8a18\u9304\u914d\u7f6e\uff0c\u9019\u672c\u8eab\u5c31\u4f7f\u5f97\u65e5\u8a8c\u8a18\u9304\u8b8a\u5f97\u56f0\u96e3\u4e26\u4e14\u5bb9\u6613\u51fa\u932f\u3002\u6b64\u5916\uff0c\u914d\u7f6e\u4e2d\u7684\u4efb\u4f55\u66f4\u6539\u90fd\u9700\u8981\u60a8\u518d\u6b21\u90e8\u7f72\u6240\u6709\u8981\u76e3\u63a7\u7684\u5bb9\u5668\u3002","title":"2. \u4f7f\u7528\u61c9\u7528\u7d1a\u65e5\u8a8c\u914d\u7f6e"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#3","text":"\u6700\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Fluentbit \u7b49\u65e5\u8a8c\u4ee3\u7406\u3002 \u65e5\u8a8c\u4ee3\u7406\u662f\u6536\u96c6 Kubernetes \u65e5\u8a8c\u4e26\u5c07\u5176\u767c\u9001\u5230\u4e2d\u5fc3\u4f4d\u7f6e\u7684\u5de5\u5177\u3002\u9019\u4e9b\u4ee3\u7406\u662f\u8f15\u91cf\u7d1a\u5bb9\u5668\uff0c\u53ef\u4ee5\u8a2a\u554f\u4e00\u500b\u76ee\u9304\uff0c\u5176\u4e2d\u5305\u542b\u4f86\u81ea\u7bc0\u9ede\u4e0a\u6240\u6709\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u8a8c\u3002\u9019\u662f\u6700\u7c21\u55ae\u548c\u6700\u597d\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u56e0\u70ba\u5b83\u4e0d\u6703\u5f71\u97ff\u5df2\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u4e26\u4e14\u7121\u8ad6\u60a8\u5411\u96c6\u7fa4\u6dfb\u52a0\u591a\u5c11\u7bc0\u9ede\uff0c\u5b83\u90fd\u662f\u5b8c\u5168\u53ef\u64f4\u5c55\u7684\u3002\u8a2d\u7f6e\u4e5f\u975e\u5e38\u7c21\u55ae\u3002\u53ea\u904b\u884c\u4e00\u500b\u547d\u4ee4\uff0c\u4f60\u5c31\u5b8c\u6210\u4e86\u3002","title":"3. \u4f7f\u7528\u65e5\u8a8c\u4ee3\u7406"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#kubernetes_2","text":"\u5982\u524d\u6240\u8ff0\uff0c\u5728 Kubernetes \u4e2d\u6709\u4e0d\u540c\u5c64\u7d1a\u7684\u65e5\u8a8c\uff0c\u6240\u6709\u5c64\u7d1a\u90fd\u5305\u542b\u4e0d\u540c\u4f46\u6709\u7528\u7684\u4fe1\u606f\uff0c\u5177\u9ad4\u7684\u4f7f\u7528\u53d6\u6c7a\u65bc\u60a8\u7684\u5834\u666f\u3002\u5728 Kubernetes \u7cfb\u7d71\u4e2d\uff0c\u4e3b\u8981\u6709\u4e09\u7a2e\u985e\u578b\u7684\u65e5\u8a8c\uff1a\u5bb9\u5668\u65e5\u8a8c\u3001\u7bc0\u9ede\u65e5\u8a8c\u548c\u96c6\u7fa4\uff08\u6216\u7cfb\u7d71\u7d44\u4ef6\uff09\u65e5\u8a8c\u3002","title":"Kubernetes \u65e5\u8a8c\u7684\u985e\u578b"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_2","text":"\u5bb9\u5668\u65e5\u8a8c\u662f\u7531\u60a8\u7684\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u751f\u6210\u7684\u65e5\u8a8c\u3002\u6355\u7372\u5bb9\u5668\u65e5\u8a8c\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u4f7f\u7528 stdout \u548c stderr \u3002 \u5047\u8a2d\u60a8\u6709\u4e00\u500b\u540d\u70ba app \u7684 Pod\uff0c\u60a8\u5728\u5176\u4e2d\u5c07\u67d0\u4e9b\u5167\u5bb9\u8a18\u9304\u5230\u6a19\u6e96\u8f38\u51fa\u3002 apiVersion : v1 kind : Pod metadata : name : app spec : containers : - name : count image : busybox args : [ /bin/sh , -c , 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done' ] \u901a\u904e\u904b\u884c\u61c9\u7528\u6b64\u914d\u7f6e\u6587\u4ef6\uff1a kubectl apply -f app.yaml \u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u7372\u53d6\u65e5\u8a8c\uff1a kubectl logs app \u60a8\u5c07\u7acb\u5373\u5728\u7d42\u7aef\u7a97\u53e3\u4e2d\u770b\u5230\u8f38\u51fa\u3002 [Output] 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ...","title":"\u5bb9\u5668\u65e5\u8a8c"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_3","text":"\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u5beb\u5165 stdout \u6216 stderr \u7684\u6240\u6709\u5167\u5bb9\u90fd\u7531\u5bb9\u5668\u5f15\u64ce\u6d41\u5f0f\u50b3\u8f38\u5230\u67d0\u500b\u5730\u65b9\u2014\u2014\u5728 Kubernetes \u7684\u74b0\u5883\uff0c\u4f8b\u5982\uff0c\u50b3\u8f38\u5230\u65e5\u8a8c\u9a45\u52d5\u7a0b\u5e8f\u3002\u9019\u4e9b\u65e5\u8a8c\u901a\u5e38\u4f4d\u65bc\u4e3b\u6a5f\u4e0a\u7684 /var/log/pods \u76ee\u9304\u4e2d\u3002 \u5982\u679c\u5bb9\u5668\u91cd\u65b0\u555f\u52d5\uff0ckubelet \u6703\u5728\u7bc0\u9ede\u4e0a\u4fdd\u7559\u65e5\u8a8c\u3002\u70ba\u4e86\u9632\u6b62\u65e5\u8a8c\u586b\u6eff\u7bc0\u9ede\u4e0a\u7684\u6240\u6709\u53ef\u7528\u7a7a\u9593\uff0cKubernetes \u8a2d\u7f6e\u4e86\u65e5\u8a8c\u8f2a\u63db\u7b56\u7565\u3002\u56e0\u6b64\uff0c\u7576\u4e00\u500b pod \u88ab\u9010\u51fa\u7bc0\u9ede\u6642\uff0c\u6240\u6709\u76f8\u61c9\u7684\u5bb9\u5668\u4ee5\u53ca\u5b83\u5011\u7684\u65e5\u8a8c\u4e5f\u6703\u88ab\u9010\u51fa\u3002 \u6839\u64da\u60a8\u7684\u64cd\u4f5c\u7cfb\u7d71\u548c\u670d\u52d9\uff0c\u60a8\u53ef\u4ee5\u6536\u96c6\u5404\u7a2e\u7bc0\u9ede\u7d1a\u5225\u7684\u65e5\u8a8c\uff0c\u4f8b\u5982\u5167\u6838\u65e5\u8a8c\u6216 systemd \u65e5\u8a8c\u3002 \u5728\u5177\u6709 systemd \u7684\u7bc0\u9ede\u4e0a\uff0ckubelet \u548c container runtime \u90fd\u5beb\u5165 journald\u3002\u5982\u679c systemd \u4e0d\u5b58\u5728\uff0c\u5b83\u5011\u6703\u5beb\u5165 /var/log \u76ee\u9304\u4e2d\u7684 .log \u6587\u4ef6\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 journalctl \u547d\u4ee4\u8a2a\u554f systemd \u65e5\u8a8c\u3002\u9019\u5c07\u8f38\u51fa\u65e5\u8a8c\u884c\u5217\u8868\u3002\u5982\u679c\u60a8\u5728\u7bc0\u9ede\u4e0a\u6c92\u6709 systemd\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u50cf\u5728\u50b3\u7d71\u670d\u52d9\u5668\u74b0\u5883\u4e2d\u4e00\u6a23\u7ba1\u7406\u65e5\u8a8c\u3002 $ journalctl [ output ] -- Logs begin at Thu 2020 -01-23 09 :15:28 CET, end at Thu 2020 -01-23 14 :43:00 CET. -- Jan 23 09 :15:28 raha-pc systemd-journald [ 267 ] : Runtime journal ( /run/log/journal/ ) is 8 .0M, max 114 .2M, 106 .2M free. Jan 23 09 :15:28 pc kernel: microcode: microcode updated early to revision 0xd6, date = 2019 -10-03","title":"\u7bc0\u9ede\u65e5\u8a8c"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_4","text":"Kubernetes \u96c6\u7fa4\u65e5\u8a8c\u662f\u6307 Kubernetes \u672c\u8eab\u53ca\u5176\u6240\u6709\u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c\uff0c\u6211\u5011\u53ef\u4ee5\u5340\u5206\u904b\u884c\u5728\u5bb9\u5668\u4e2d\u7684\u7d44\u4ef6\u548c\u4e0d\u904b\u884c\u5728\u5bb9\u5668\u4e2d\u7684\u7d44\u4ef6\u3002\u6bcf\u500b\u90fd\u6709\u81ea\u5df1\u7684\u89d2\u8272\uff0c\u8b93\u60a8\u6df1\u5165\u4e86\u89e3 Kubernetes \u7cfb\u7d71\u7684\u5065\u5eb7\u72c0\u6cc1\u3002\u4f8b\u5982\uff0ckube-scheduler\u3001kube-apiserver\u3001etcd \u548c kube-proxy \u5728\u5bb9\u5668\u5167\u904b\u884c\uff0c\u800c kubelet \u548c\u5bb9\u5668\u904b\u884c\u6642\u904b\u884c\u5728\u64cd\u4f5c\u7cfb\u7d71\u7d1a\u5225\uff0c\u901a\u5e38\u4f5c\u70ba systemd \u670d\u52d9\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5bb9\u5668\u5916\u7684\u7cfb\u7d71\u7d44\u4ef6\u5c07\u6587\u4ef6\u5beb\u5165 journald \uff0c\u800c\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684\u7d44\u4ef6\u5beb\u5165 /var/log \u76ee\u9304\u3002\u4f46\u662f\uff0c\u53ef\u4ee5\u9078\u64c7\u5c07\u5bb9\u5668\u5f15\u64ce\u914d\u7f6e\u70ba\u5c07\u65e5\u8a8c\u6d41\u5f0f\u50b3\u8f38\u5230\u9996\u9078\u4f4d\u7f6e\u3002 Kubernetes \u6c92\u6709\u70ba\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8a18\u9304\u63d0\u4f9b\u539f\u751f\u89e3\u6c7a\u65b9\u6848\u3002\u4f46\u662f\uff0c\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u65b9\u6cd5\uff1a \u4f7f\u7528\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u5728\u61c9\u7528\u7a0b\u5e8f pod \u4e2d\u6dfb\u52a0\u7528\u65bc\u65e5\u8a8c\u8a18\u9304\u7684 sidecar \u5bb9\u5668 \u76f4\u63a5\u5f9e\u61c9\u7528\u7a0b\u5e8f\u516c\u958b\u65e5\u8a8c\u3002 \u9664\u4e86\u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c\uff0c\u60a8\u9084\u53ef\u4ee5\u8a18\u9304 Kubernetes \u4e8b\u4ef6\u548c\u5be9\u8a08\u65e5\u8a8c\u3002","title":"\u96c6\u7fa4\uff08\u6216\u7cfb\u7d71\u7d44\u4ef6\uff09\u65e5\u8a8c"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#kubernetes-events","text":"Kubernetes \u4e8b\u4ef6\u5305\u542b\u6709\u95dc\u8cc7\u6e90\u72c0\u614b\u66f4\u6539\u6216\u932f\u8aa4\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u70ba\u4ec0\u9ebc pod \u88ab\u9a45\u9010\u6216\u8abf\u5ea6\u7a0b\u5e8f\u505a\u51fa\u4e86\u4ec0\u9ebc\u6c7a\u5b9a\uff0c\u4ee5\u53ca\u5176\u4ed6\u4fe1\u606f\u6027\u6d88\u606f\uff0c\u53ef\u63d0\u4f9b\u5c0d\u96c6\u7fa4\u5167\u90e8\u6b63\u5728\u767c\u751f\u7684\u4e8b\u60c5\u7684\u6d1e\u5bdf\u529b\u3002 \u4e8b\u4ef6\u662f\u5b58\u5132\u5728 master \u4e0a\u7684 apiserver \u4e2d\u7684 API \u5c0d\u8c61\u3002\u8207\u7bc0\u9ede\u65e5\u8a8c\u8a18\u9304\u985e\u4f3c\uff0c\u8a2d\u7f6e\u4e86\u522a\u9664\u6a5f\u5236\u4ee5\u907f\u514d\u4f7f\u7528\u6240\u6709\u4e3b\u7bc0\u9ede\u7684\u78c1\u76e4\u7a7a\u9593\u3002\u56e0\u6b64\uff0c Kubernetes \u5728\u6700\u5f8c\u4e00\u6b21\u767c\u751f\u4e00\u5c0f\u6642\u5f8c\u522a\u9664\u4e8b\u4ef6 \u3002\u5982\u679c\u60a8\u60f3\u5728\u66f4\u9577\u7684\u6642\u9593\u5167\u6355\u7372\u4e8b\u4ef6\uff0c\u60a8\u9700\u8981\u5b89\u88dd\u7b2c\u4e09\u65b9\u89e3\u6c7a\u65b9\u6848\uff0c\u5c31\u50cf\u6211\u5011\u5728\u4e0a\u9762\u7684\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u90e8\u5206\u4e2d\u89e3\u91cb\u7684\u90a3\u6a23\u3002 \u60a8\u53ef\u4ee5\u901a\u904e\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u5feb\u901f\u6aa2\u67e5\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u4e8b\u4ef6\uff1a kubectl get events -n <namespace> [Output] LAST SEEN TYPE REASON OBJECT MESSAGE 3m58s Normal NoPods kube-dns No matching pods found 9m31s Normal Killing pod/app Stopping container app 9m32s Normal DELETE pod/app Starting container app ... \u5982\u679c\u60a8\u4e0d\u60f3\u6aa2\u67e5\u6574\u500b\u547d\u540d\u7a7a\u9593\uff0c\u800c\u53ea\u60f3\u6aa2\u67e5\u55ae\u500b Pod\uff0c\u60a8\u4e5f\u53ef\u4ee5\u9019\u6a23\u505a\u3002 kubectl describe pod <pod-name> [ Output ] Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 41m default-scheduler Successfully assigned app to ip-xx-xx-xx-xx Normal Pulled 41m kubelet, ip-xx Container image \"app-image\" already present on machine Normal Created 41m kubelet, ip-xx Created container app Normal Started 41m kubelet, ip-xx Started container app \u7406\u60f3\u60c5\u6cc1\u4e0b\uff0c\u60a8\u6c38\u9060\u4e0d\u9700\u8981\u5728\u7d42\u7aef\u4e2d\u904b\u884c\u9019\u4e9b\u547d\u4ee4\uff0c\u800c\u662f\u4f7f\u7528\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8a18\u9304\u8a2d\u7f6e\u5c07\u9019\u4e9b\u4e8b\u4ef6\u767c\u9001\u5230\u4e00\u500b\u4e2d\u5fc3\u4f4d\u7f6e\uff0c\u60a8\u53ef\u4ee5\u5728\u5176\u4e2d\u67e5\u770b\u5b83\u5011\u4ee5\u53ca\u60a8\u64c1\u6709\u7684\u4efb\u4f55\u65e5\u8a8c\u3002","title":"Kubernetes Events \u65e5\u8a8c"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#kubernetes_3","text":"Kubernetes \u5be9\u8a08\u65e5\u8a8c\u662f\u5c0d kube-apiserver \u7684\u6bcf\u6b21\u8abf\u7528\u7684\u8a73\u7d30\u63cf\u8ff0\u3002\u5b83\u5011\u63d0\u4f9b\u4e86\u6309\u6642\u9593\u9806\u5e8f\u6392\u5217\u7684\u6d3b\u52d5\uff0c\u9019\u4e9b\u6d3b\u52d5\u5c0e\u81f4\u7cfb\u7d71\u5728\u7279\u5b9a\u6642\u523b\u7684\u72c0\u614b\u3002\u5b83\u5011\u5c0d\u65bc\u5b89\u5168\u6027\u548c\u5408\u898f\u6027\u76ee\u7684\u975e\u5e38\u6709\u7528\uff0c\u53ef\u4ee5\u6e96\u78ba\u5730\u544a\u8a34\u60a8\u8ab0\u505a\u4e86\u4ec0\u9ebc\u3001\u4f55\u6642\u4ee5\u53ca\u5982\u4f55\u505a\u7684\u3002","title":"Kubernetes \u5be9\u8a08\u65e5\u8a8c"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#kubernetes-ingress","text":"Kubernetes Ingress \u6b63\u5728\u6210\u70ba\u5c07\u4f86\u81ea\u96c6\u7fa4\u5916\u90e8\u7684 HTTP \u548c HTTPS \u8def\u7531\u66b4\u9732\u7d66\u96c6\u7fa4\u5167\u670d\u52d9\u7684\u4e8b\u5be6\u6a19\u6e96\u3002\u9019\u4f7f\u5f97\u5165\u53e3\u65e5\u8a8c\u5c0d\u65bc\u8ddf\u8e2a\u670d\u52d9\u6027\u80fd\u3001\u554f\u984c\u3001\u932f\u8aa4\u751a\u81f3\u96c6\u7fa4\u7684\u5b89\u5168\u6027\u975e\u5e38\u91cd\u8981\u3002","title":"Kubernetes Ingress \u65e5\u8a8c"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#kubernetes_4","text":"\u60a8\u73fe\u5728\u53ef\u80fd\u5df2\u7d93\u77e5\u9053\uff0c\u65e5\u8a8c\u7cfb\u7d71\u7684\u8a2d\u8a08\u5728 Kubernetes \u7684\u74b0\u5883\u4e0b\u662f\u4e00\u500b\u6311\u6230\u3002\u4f46\u662f\uff0c\u6709\u8db3\u5920\u7684\u95dc\u65bc\u8a72\u4e3b\u984c\u7684\u6587\u737b\u4f86\u7de8\u8b6f\u60a8\u61c9\u8a72\u9075\u5faa\u7684\u6700\u4f73\u5be6\u8e10\u5217\u8868\uff0c\u4ee5\u78ba\u4fdd\u60a8\u6355\u7372\u6240\u9700\u7684\u65e5\u8a8c\u3002","title":"Kubernetes \u65e5\u8a8c\u6700\u4f73\u5be6\u8e10"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_5","text":"\u8a2a\u554f Kubernetes \u65e5\u8a8c\u76f8\u7576\u5bb9\u6613\u3002\u6311\u6230\u5728\u65bc\u5c07\u5b83\u5011\u767c\u9001\u548c\u5b58\u5132\u5230\u54ea\u88e1\uff0c\u4ee5\u4fbf\u5c07\u4f86\u4f7f\u7528\u3002\u7121\u8ad6\u60a8\u7684\u7528\u4f8b\u662f\u4ec0\u9ebc\uff0c\u60a8\u9078\u64c7\u7684\u65e5\u8a8c\u7ba1\u9053\uff08\u7121\u8ad6\u662f\u5167\u90e8\u7684\u9084\u662f\u670d\u52d9\u7684\uff09\u90fd\u9700\u8981\u5c07\u65e5\u8a8c\u767c\u9001\u5230\u4f4d\u65bc\u55ae\u7368\u548c\u9694\u96e2\u74b0\u5883\u4e2d\u7684\u4e2d\u5fc3\u4f4d\u7f6e\u3002","title":"\u8a2d\u7f6e\u65e5\u8a8c\u7cfb\u7d71"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_6","text":"\u7121\u8ad6\u60a8\u9078\u64c7\u5728\u5167\u90e8\u57f7\u884c\u65e5\u8a8c\u8a18\u9304\u9084\u662f\u4f7f\u7528\u7b2c\u4e09\u65b9\u670d\u52d9\uff0c\u65e5\u8a8c\u4ecd\u7136\u6703\u4f54\u7528\u5927\u91cf\u7a7a\u9593\u3002\u56e0\u6b64\uff0c\u8acb\u78ba\u4fdd\u60a8\u6709\u4e00\u500b\u660e\u78ba\u7684\u4fdd\u7559\u7b56\u7565\u4f86\u5b58\u5132\u65e5\u8a8c\u4ee5\u4f9b\u5c07\u4f86\u4f7f\u7528\u3002\u66f4\u9ad8\u7684\u4fdd\u7559\u653f\u7b56\u901a\u5e38\u6210\u672c\u66f4\u9ad8\u3002\u56e0\u6b64\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u6839\u64da\u60a8\u7684 Kubernetes \u74b0\u5883\u4f30\u8a08\u6240\u9700\u7684\u78c1\u76e4\u7a7a\u9593\u3002\u7576\u7136\uff0c\u8a17\u7ba1\u65e5\u8a8c\u670d\u52d9\u5c07\u964d\u4f4e\u8207 Kubernetes \u65e5\u8a8c\u76f8\u95dc\u7684\u57fa\u790e\u8a2d\u65bd\u6210\u672c\uff0c\u4e26\u63d0\u4f9b\u57fa\u65bc\u6578\u91cf\u7684\u6298\u6263\u3002","title":"\u5efa\u7acb\u4fdd\u7559\u6a5f\u5236"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_7","text":"\u5118\u7ba1\u9019\u662f\u9077\u79fb\u5230\u5bb9\u5668\u5316\u74b0\u5883\u6642\u7684\u6a19\u6e96\u505a\u6cd5\uff0c\u4f46\u4e00\u4e9b\u516c\u53f8\u4ecd\u7136\u7de8\u5beb\u8a18\u9304\u5230\u6587\u4ef6\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5c07\u65e5\u8a8c\u91cd\u5b9a\u5411\u5230 stdout \u548c stderr \u5141\u8a31 Kubernetes \u7684\u96c6\u4e2d\u5f0f\u65e5\u8a8c\u6846\u67b6\u767c\u63ee\u4f5c\u7528\uff0c\u4e26\u81ea\u52d5\u5c07\u65e5\u8a8c\u6d41\u5f0f\u50b3\u8f38\u5230\u4efb\u4f55\u6240\u9700\u7684\u4f4d\u7f6e\u3002 \u6b64\u5916\uff0c\u5c07\u932f\u8aa4\u5206\u96e2\u5230\u932f\u8aa4\u6d41\u4e2d\u6709\u52a9\u65bc\u65e5\u8a8c\u6536\u96c6\uff0c\u4e26\u4f7f\u60a8\u66f4\u5bb9\u6613\u904e\u6ffe\u65e5\u8a8c\u3002","title":"\u5c07\u65e5\u8a8c\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\u548c\u6a19\u6e96\u932f\u8aa4"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#_8","text":"\u901a\u904e\u70ba dev \u548c prod \u5275\u5efa\u55ae\u7368\u7684\u96c6\u7fa4\uff0c\u60a8\u53ef\u4ee5\u907f\u514d\u8af8\u5982\u522a\u9664\u751f\u7522\u4e2d\u81f3\u95dc\u91cd\u8981\u7684 pod \u4e4b\u985e\u7684\u4e8b\u6545\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl config use-context \u547d\u4ee4\u5728\u5169\u8005\u4e4b\u9593\u8f15\u9b06\u5207\u63db\u3002\u60a8\u61c9\u8a72\u4f7f\u7528\u76f8\u540c\u7684\u65b9\u6cd5\u5c07 dev \u548c prod \u65e5\u8a8c\u4fdd\u5b58\u5728\u4e0d\u540c\u7684\u4f4d\u7f6e\u3002","title":"\u4f7f\u7528\u55ae\u7368\u7684\u96c6\u7fa4\u9032\u884c\u958b\u767c\u548c\u751f\u7522"},{"location":"kubernetes/02-concepts/11-cluster-adm/kubernetes-logging/#sidecar","text":"Kubernetes \u6700\u4f73\u5be6\u8e10\u6307\u51fa\uff0c\u60a8\u61c9\u8a72\u59cb\u7d42\u5617\u8a66\u6bcf\u500b pod \u64c1\u6709\u4e00\u500b\u5bb9\u5668\u5be6\u4f8b\u3002\u9019\u610f\u5473\u8457\u4e00\u500b pod \u61c9\u8a72\u53ea\u5177\u6709\u7531\u540c\u4e00\u93e1\u50cf\u5b9a\u7fa9\u7684\u540c\u4e00\u5bb9\u5668\u7684\u5be6\u4f8b\u3002\u7136\u5f8c\u53ef\u4ee5\u5728 pod \u4e2d\u5fa9\u5236\u6b64\u5bb9\u5668\uff0c\u4e26\u4e14\u60a8\u6700\u7d42\u53ef\u4ee5\u5728 pod \u4e2d\u64c1\u6709\u591a\u500b\u5bb9\u5668\u3002\u4f46\u662f\uff0c\u5b83\u5011\u4ecd\u7136\u662f\u5f9e\u540c\u4e00\u500b\u5be6\u4f8b\u69cb\u5efa\u7684\u3002 Sidecar \u662f\u540c\u4e00\u500b pod \u4e2d\u7684\u7b2c\u4e8c\u500b\u5bb9\u5668\uff0c\u5b83\u6355\u7372\u5be6\u969b\u61c9\u7528\u6240\u5728\u7684\u7b2c\u4e00\u500b\u5bb9\u5668\u7684\u8f38\u51fa\u3002\u56e0\u6b64\uff0c\u5b83\u5f9e\u6bcf\u500b pod \u7d1a\u5225\u4f54\u7528\u8cc7\u6e90\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u7684\u7bc0\u9ede\u4e0a\u6709 5 \u500b Pod \u904b\u884c\uff0c\u4e26\u4e14\u5e36\u6709 sidecar\uff0c\u90a3\u9ebc\u60a8\u5be6\u969b\u4e0a\u4f7f\u7528\u4e86 10 \u500b\u65e5\u8a8c\u5bb9\u5668\u3002 \u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0csidecar \u5bb9\u5668\u662f\u7121\u6cd5\u907f\u514d\u7684\uff0c\u4f8b\u5982\u7576\u60a8\u7121\u6cd5\u63a7\u5236\u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u5b83\u6703\u5c07\u65e5\u8a8c\u5beb\u5165\u6587\u4ef6\uff0c\u6216\u8005\u60a8\u60f3\u96b1\u85cf Kubernetes \u65e5\u8a8c\u6846\u67b6\u7684\u8f38\u51fa\u3002 \u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u89e3\u6c7a\u65b9\u6848\u662f\u4f7f\u7528\u55ae\u500b\u5bb9\u5668\u5f9e\u6574\u500b\u7bc0\u9ede\u4e00\u6b21\u6536\u96c6\u6240\u6709\u65e5\u8a8c\uff0c\u800c\u4e0d\u662f\u5728\u7bc0\u9ede\u7d1a\u5225\u6536\u96c6\u5b83\u5011\u3002","title":"\u907f\u514d\u4f7f\u7528 Sidecar \u5bb9\u5668\u9032\u884c\u65e5\u8a8c\u8a18\u9304"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/","text":"\u65e5\u8a8c\u67b6\u69cb \u00b6 \u61c9\u7528\u65e5\u8a8c\u53ef\u4ee5\u8b93\u4f60\u4e86\u89e3\u61c9\u7528\u5167\u90e8\u7684\u904b\u884c\u72c0\u6cc1\u3002\u65e5\u8a8c\u5c0d\u8abf\u8a66\u554f\u984c\u548c\u76e3\u63a7\u96c6\u7fa4\u6d3b\u52d5\u975e\u5e38\u6709\u7528\u3002\u5927\u90e8\u5206\u73fe\u4ee3\u5316\u61c9\u7528\u90fd\u6709\u67d0\u7a2e\u65e5\u8a8c\u8a18\u9304\u6a5f\u5236\u3002\u540c\u6a23\u5730\uff0c\u5bb9\u5668\u5f15\u64ce\u4e5f\u88ab\u8a2d\u8a08\u6210\u652f\u6301\u65e5\u8a8c\u8a18\u9304\u3002\u91dd\u5c0d\u5bb9\u5668\u5316\u61c9\u7528\uff0c\u6700\u7c21\u55ae\u4e14\u6700\u5ee3\u6cdb\u63a1\u7528\u7684\u65e5\u8a8c\u8a18\u9304\u65b9\u5f0f\u5c31\u662f\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\u548c\u6a19\u6e96\u932f\u8aa4\u6d41\u3002 \u4f46\u662f\uff0c\u7531\u5bb9\u5668\u5f15\u64ce\u6216\u904b\u884c\u6642\u63d0\u4f9b\u7684\u539f\u751f\u529f\u80fd\u901a\u5e38\u4e0d\u8db3\u4ee5\u69cb\u6210\u5b8c\u6574\u7684\u65e5\u8a8c\u8a18\u9304\u65b9\u6848\u3002\u4f8b\u5982\uff0c\u5982\u679c\u767c\u751f\u5bb9\u5668\u5d29\u6f70\u3001Pod \u88ab\u9010\u51fa\u6216\u7bc0\u9ede\u5b95\u6a5f\u7b49\u60c5\u6cc1\uff0c\u4f60\u53ef\u80fd\u60f3\u8a2a\u554f\u61c9\u7528\u65e5\u8a8c\u3002\u5728\u96c6\u7fa4\u4e2d\uff0c\u65e5\u8a8c\u61c9\u8a72\u5177\u6709\u7368\u7acb\u7684\u5b58\u5132\u548c\u751f\u547d\u9031\u671f\uff0c\u8207\u7bc0\u9ede\u3001Pod \u6216\u5bb9\u5668\u7684\u751f\u547d\u9031\u671f\u76f8\u7368\u7acb\u3002\u9019\u500b\u6982\u5ff5\u53eb \u96c6\u7fa4\u7d1a\u7684\u65e5\u8a8c \u3002 \u96c6\u7fa4\u7d1a\u65e5\u8a8c\u67b6\u69cb\u9700\u8981\u4e00\u500b\u7368\u7acb\u7684\u5f8c\u7aef\u7528\u4f86\u5b58\u5132\u3001\u5206\u6790\u548c\u67e5\u8a62\u65e5\u8a8c\u3002 Kubernetes \u4e26\u4e0d\u70ba\u65e5\u8a8c\u6578\u64da\u63d0\u4f9b\u539f\u751f\u7684\u5b58\u5132\u89e3\u6c7a\u65b9\u6848\u3002\u76f8\u53cd\uff0c\u6709\u5f88\u591a\u73fe\u6210\u7684\u65e5\u8a8c\u65b9\u6848\u53ef\u4ee5\u96c6\u6210\u5230 Kubernetes \u4e2d\u3002\u4e0b\u9762\u5404\u7bc0\u63cf\u8ff0\u5982\u4f55\u5728\u7bc0\u9ede\u4e0a\u8655\u7406\u548c\u5b58\u5132\u65e5\u8a8c\u3002 Kubernetes \u4e2d\u7684\u57fa\u672c\u65e5\u8a8c\u8a18\u9304 \u00b6 \u9019\u88e1\u7684\u793a\u4f8b\u4f7f\u7528\u5305\u542b\u4e00\u500b\u5bb9\u5668\u7684 Pod spec\uff0c\u6bcf\u79d2\u9418\u5411\u6a19\u6e96\u8f38\u51fa(stdout)\u5beb\u5165\u6578\u64da\u3002 debug/counter-pod.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : [ /bin/sh , -c , 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done' ] \u7528\u4e0b\u9762\u7684\u547d\u4ee4\u904b\u884c Pod\uff1a kubectl apply -f https://k8s.io/examples/debug/counter-pod.yaml \u8f38\u51fa\u7d50\u679c\u70ba\uff1a pod/counter created \u50cf\u4e0b\u9762\u9019\u6a23\uff0c\u4f7f\u7528 kubectl logs \u547d\u4ee4\u7372\u53d6\u65e5\u8a8c: kubectl logs counter \u8f38\u51fa\u7d50\u679c\u70ba\uff1a 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ... \u4f60\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4 kubectl logs --previous \u6aa2\u7d22\u4e4b\u524d\u5bb9\u5668\u5be6\u4f8b\u7684\u65e5\u8a8c\u3002\u5982\u679c Pod \u6709\u591a\u500b\u5bb9\u5668\uff0c\u4f60\u61c9\u8a72\u70ba\u8a72\u547d\u4ee4\u9644\u52a0\u5bb9\u5668\u540d\u4ee5\u8a2a\u554f\u5c0d\u61c9\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c \u4f7f\u7528 -c \u6a19\u8a8c\u4f86\u6307\u5b9a\u8981\u8a2a\u554f\u7684\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u5982\u4e0b\u6240\u793a\uff1a kubectl logs counter -c count \u8a73\u898b kubectl logs \u6587\u6a94 \u3002 \u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304 \u00b6 \u5bb9\u5668\u5316\u61c9\u7528\u5beb\u5165 stdout \u548c stderr \u7684\u4efb\u4f55\u6578\u64da\uff0c\u90fd\u6703\u88ab\u5bb9\u5668\u5f15\u64ce\u6355\u7372\u4e26\u88ab\u91cd\u5b9a\u5411\u5230\u67d0\u500b\u4f4d\u7f6e\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u5bb9\u5668\u91cd\u555f\uff0ckubelet \u6703\u4fdd\u7559\u88ab\u7d42\u6b62\u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u5982\u679c Pod \u5728\u5de5\u4f5c\u7bc0\u9ede\u88ab\u9a45\u9010\uff0c\u8a72 Pod \u4e2d\u6240\u6709\u7684\u5bb9\u5668\u4e5f\u6703\u88ab\u9a45\u9010\uff0c\u5305\u62ec\u5bb9\u5668\u65e5\u8a8c\u3002 \u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4e2d\uff0c\u9700\u8981\u91cd\u9ede\u8003\u616e\u5be6\u73fe \u65e5\u8a8c\u7684\u8f2a\u8f49 \uff0c\u4ee5\u6b64\u4f86\u4fdd\u8b49\u65e5\u8a8c\u4e0d\u6703\u6d88\u8017\u7bc0\u9ede\u4e0a\u5168\u90e8\u53ef\u7528\u7a7a\u9593\u3002 Kubernetes \u4e26\u4e0d\u8ca0\u8cac\u8f2a\u8f49\u65e5\u8a8c\uff0c\u800c\u662f\u901a\u904e\u90e8\u7f72\u5de5\u5177\u5efa\u7acb\u4e00\u500b\u89e3\u6c7a\u554f\u984c\u7684\u65b9\u6848\u3002\u4f8b\u5982\uff0c\u5728\u7528 kube-up.sh \u90e8\u7f72\u7684 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u5b58\u5728\u4e00\u500b logrotate \uff0c\u6bcf\u5c0f\u6642\u904b\u884c\u4e00\u6b21\u3002\u4f60\u4e5f\u53ef\u4ee5\u8a2d\u7f6e\u5bb9\u5668\u904b\u884c\u6642\u4f86\u81ea\u52d5\u5730\u8f2a\u8f49\u61c9\u7528\u65e5\u8a8c\u3002 \u7576\u4f7f\u7528\u67d0 CRI \u5bb9\u5668 runtime \u6642\uff0c kubelet \u8981\u8ca0\u8cac\u5c0d\u65e5\u8a8c\u9032\u884c\u8f2a\u63db\uff0c\u4e26\u7ba1\u7406\u65e5\u8a8c\u76ee\u9304\u7684\u7d50\u69cb \u3002 kubelet \u5c07\u6b64\u4fe1\u606f\u767c\u9001\u7d66 CRI \u5bb9\u5668\u904b\u884c\u6642\uff0c\u5f8c\u8005\u5c07\u5bb9\u5668\u65e5\u8a8c\u5beb\u5165\u5230\u6307\u5b9a\u7684\u4f4d\u7f6e\u3002\u5728 kubelet \u914d\u7f6e\u6587\u4ef6 \u4e2d\u7684\u5169\u500b kubelet \u53c3\u6578 containerLogMaxSize \u548c containerLogMaxFiles \u53ef\u4ee5\u7528\u4f86\u914d\u7f6e\u6bcf\u500b\u65e5\u8a8c\u6587\u4ef6\u7684\u6700\u5927\u9577\u5ea6\u548c\u6bcf\u500b\u5bb9\u5668\u53ef\u4ee5\u751f\u6210\u7684\u65e5\u8a8c\u6587\u4ef6\u500b\u6578\u4e0a\u9650\u3002 \u7576\u904b\u884c kubectl logs \u6642\uff0c \u7bc0\u9ede\u4e0a\u7684 kubelet \u8655\u7406\u8a72\u8acb\u6c42\u4e26\u76f4\u63a5\u8b80\u53d6\u65e5\u8a8c\u6587\u4ef6\uff0c\u540c\u6642\u5728\u97ff\u61c9\u4e2d\u8fd4\u56de\u65e5\u8a8c\u6587\u4ef6\u5167\u5bb9\u3002 Info \u8aaa\u660e\uff1a \u5982\u679c\u6709\u5916\u90e8\u7cfb\u7d71\u57f7\u884c\u65e5\u8a8c\u8f2a\u8f49\u6216\u8005\u4f7f\u7528\u4e86 CRI \u5bb9\u5668\u904b\u884c\u6642\uff0c\u90a3\u9ebc kubectl logs \u50c5\u53ef\u67e5\u8a62\u5230\u6700\u65b0\u7684\u65e5\u8a8c\u5167\u5bb9\u3002\u6bd4\u5982\uff0c\u5c0d\u65bc\u4e00\u500b 10MB \u5927\u5c0f\u7684\u6587\u4ef6\uff0c\u901a\u904e logrotate \u57f7\u884c\u8f2a\u8f49\u5f8c\u751f\u6210\u5169\u500b\u6587\u4ef6\uff0c \u4e00\u500b 10MB \u5927\u5c0f\uff0c\u4e00\u500b\u70ba\u7a7a\uff0ckubectl logs \u8fd4\u56de\u6700\u65b0\u7684\u65e5\u8a8c\u6587\u4ef6\uff0c\u800c\u8a72\u65e5\u8a8c\u6587\u4ef6\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\u70ba\u7a7a\u3002 \u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c \u00b6 \u7cfb\u7d71\u7d44\u4ef6\u6709\u5169\u7a2e\u985e\u578b\uff1a\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684\u548c\u4e0d\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684\u3002\u4f8b\u5982\uff1a \u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684 kube-scheduler \u548c kube-proxy\u3002 \u4e0d\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684 kubelet \u548c\u5bb9\u5668 runtime\u3002 \u5728\u4f7f\u7528 systemd \u6a5f\u5236\u7684\u670d\u52d9\u5668\u4e0a\uff0ckubelet \u548c\u5bb9\u5668\u904b\u884c\u6642\u5c07\u65e5\u8a8c\u5beb\u5165\u5230 journald \u4e2d\u3002\u5982\u679c\u6c92\u6709 systemd\uff0c\u5b83\u5011\u5c07\u65e5\u8a8c\u5beb\u5165\u5230 /var/log \u76ee\u9304\u4e0b\u7684 .log \u6587\u4ef6\u4e2d\u3002\u5bb9\u5668\u4e2d\u7684\u7cfb\u7d71\u7d44\u4ef6\u901a\u5e38\u5c07\u65e5\u8a8c\u5beb\u5230 /var/log \u76ee\u9304\uff0c\u7e5e\u904e\u4e86\u9ed8\u8a8d\u7684\u65e5\u8a8c\u6a5f\u5236\u3002\u4ed6\u5011\u4f7f\u7528 klog \u65e5\u8a8c\u5eab\u3002\u4f60\u53ef\u4ee5\u5728 \u65e5\u8a8c\u958b\u767c\u6587\u6a94 \u627e\u5230\u9019\u4e9b\u7d44\u4ef6\u7684\u65e5\u8a8c\u544a\u8b66\u7d1a\u5225\u7d04\u5b9a\u3002 \u548c\u5bb9\u5668\u65e5\u8a8c\u985e\u4f3c\uff0c /var/log \u76ee\u9304\u4e2d\u7684\u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c\u4e5f\u61c9\u8a72\u88ab\u8f2a\u8f49\u3002\u901a\u904e\u8173\u672c kube-up.sh \u555f\u52d5\u7684 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u65e5\u8a8c\u88ab\u5de5\u5177 logrotate \u57f7\u884c\u6bcf\u65e5\u8f2a\u8f49\uff0c\u6216\u8005\u65e5\u8a8c\u5927\u5c0f\u8d85\u904e 100MB \u6642\u89f8\u767c\u8f2a\u8f49\u3002 \u96c6\u7fa4\u7d1a\u65e5\u8a8c\u67b6\u69cb \u00b6 \u96d6\u7136 Kubernetes \u6c92\u6709\u70ba\u96c6\u7fa4\u7d1a\u65e5\u8a8c\u8a18\u9304\u63d0\u4f9b\u539f\u751f\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u4f46\u4f60\u53ef\u4ee5\u8003\u616e\u5e7e\u7a2e\u5e38\u898b\u7684\u65b9\u6cd5\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u9078\u9805\uff1a \u4f7f\u7528\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406\u3002 \u5728\u61c9\u7528\u7a0b\u5e8f\u7684 Pod \u4e2d\uff0c\u5305\u542b\u5c08\u9580\u8a18\u9304\u65e5\u8a8c\u7684\u908a\u8eca\uff08Sidecar\uff09\u5bb9\u5668\u3002 \u5c07\u65e5\u8a8c\u76f4\u63a5\u5f9e\u61c9\u7528\u7a0b\u5e8f\u4e2d\u63a8\u9001\u5230\u65e5\u8a8c\u8a18\u9304\u5f8c\u7aef\u3002 \u4f7f\u7528\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u4ee3\u7406 \u00b6 \u4f60\u53ef\u4ee5\u901a\u904e\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u4f7f\u7528 \u7bc0\u9ede\u7d1a\u7684\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u4f86\u5be6\u73fe\u96c6\u7fa4\u7d1a\u65e5\u8a8c\u8a18\u9304\u3002 \u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u662f\u4e00\u7a2e\u7528\u65bc\u66b4\u9732\u65e5\u8a8c\u6216\u5c07\u65e5\u8a8c\u63a8\u9001\u5230\u5f8c\u7aef\u7684\u5c08\u7528\u5de5\u5177\u3002\u901a\u5e38 \u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u7a0b\u5e8f\u662f\u4e00\u500b\u5bb9\u5668\uff0c\u5b83\u53ef\u4ee5\u8a2a\u554f\u5305\u542b\u8a72\u7bc0\u9ede\u4e0a\u6240\u6709\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u8a8c\u6587\u4ef6\u7684\u76ee\u9304\u3002 \u7531\u65bc \u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u5fc5\u9808\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\uff0c\u901a\u5e38\u53ef\u4ee5\u7528 DaemonSet \u7684\u5f62\u5f0f\u904b\u884c\u8a72\u4ee3\u7406\u3002\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u50c5\u5275\u5efa\u4e00\u500b\u4ee3\u7406\uff0c\u4e0d\u9700\u8981\u5c0d\u7bc0\u9ede\u4e0a\u7684\u61c9\u7528\u505a\u4fee\u6539\u3002 \u5bb9\u5668\u5411\u6a19\u6e96\u8f38\u51fa(stdout)\u548c\u6a19\u6e96\u932f\u8aa4\u8f38\u51fa(stderr)\u5beb\u51fa\u6578\u64da\uff0c\u4f46\u5728\u683c\u5f0f\u4e0a\u4e26\u4e0d\u7d71\u4e00\u3002 \u7bc0\u9ede\u7d1a\u4ee3\u7406 \u6536\u96c6\u9019\u4e9b\u65e5\u8a8c\u4e26\u5c07\u5176\u9032\u884c\u8f49\u767c\u4ee5\u5b8c\u6210\u532f\u7e3d\u3002 \u4f7f\u7528 sidecar \u5bb9\u5668\u904b\u884c\u65e5\u8a8c\u4ee3\u7406 \u00b6 \u4f60\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u4e4b\u4e00\u4f7f\u7528\u908a\u8eca\uff08Sidecar\uff09\u5bb9\u5668\uff1a \u908a\u8eca\u5bb9\u5668\u5c07\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u50b3\u9001\u5230\u81ea\u5df1\u7684\u6a19\u6e96\u8f38\u51fa\u3002 \u908a\u8eca\u5bb9\u5668\u904b\u884c\u4e00\u500b\u65e5\u8a8c\u4ee3\u7406\uff0c\u914d\u7f6e\u8a72\u65e5\u8a8c\u4ee3\u7406\u4ee5\u4fbf\u5f9e\u61c9\u7528\u5bb9\u5668\u6536\u96c6\u65e5\u8a8c\u3002 \u5229\u7528\u908a\u8eca\u5bb9\u5668\u5411\u81ea\u5df1\u7684 stdout \u548c stderr \u50b3\u8f38\u6d41\u7684\u65b9\u5f0f\uff0c \u4f60\u5c31\u53ef\u4ee5\u5229\u7528\u6bcf\u500b\u7bc0\u9ede\u4e0a\u7684 kubelet \u548c\u65e5\u8a8c\u4ee3\u7406\u4f86\u8655\u7406\u65e5\u8a8c\u3002\u908a\u8eca\u5bb9\u5668\u5f9e\u6587\u4ef6\u3001\u5957\u63a5\u5b57\u6216 journald \u8b80\u53d6\u65e5\u8a8c\u3002\u6bcf\u500b\u908a\u8eca\u5bb9\u5668\u5411\u81ea\u5df1\u7684 stdout \u548c stderr \u6d41\u4e2d\u8f38\u51fa\u65e5\u8a8c\u3002 \u9019\u7a2e\u65b9\u6cd5\u5141\u8a31\u4f60\u5c07\u65e5\u8a8c\u6d41\u5f9e\u61c9\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u90e8\u5206\u5206\u96e2\u958b\uff0c\u5176\u4e2d\u4e00\u4e9b\u53ef\u80fd\u7f3a\u4e4f\u5c0d\u5beb\u5165 stdout \u6216 stderr \u7684\u652f\u6301\u3002\u91cd\u5b9a\u5411\u65e5\u8a8c\u80cc\u5f8c\u7684\u908f\u8f2f\u662f\u6700\u5c0f\u7684\uff0c\u56e0\u6b64\u5b83\u7684\u958b\u92b7\u5e7e\u4e4e\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8a08\u3002\u53e6\u5916\uff0c\u56e0\u70ba stdout \u548c stderr \u7531 kubelet \u8655\u7406\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u4f7f\u7528\u5167\u7f6e\u7684\u5de5\u5177 kubectl logs\u3002 \u4f8b\u5982\uff0c\u67d0 Pod \u4e2d\u904b\u884c\u4e00\u500b\u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u5411\u5169\u500b\u6587\u4ef6\u5beb\u4e0d\u540c\u683c\u5f0f\u7684\u65e5\u8a8c\u3002\u4e0b\u9762\u662f\u9019\u500b Pod \u7684\u914d\u7f6e\u6587\u4ef6: admin/logging/two-files-counter-pod.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts : - name : varlog mountPath : /var/log volumes : - name : varlog emptyDir : {} \u4e0d\u5efa\u8b70\u5728\u540c\u4e00\u500b\u65e5\u8a8c\u6d41\u4e2d\u5beb\u5165\u4e0d\u540c\u683c\u5f0f\u7684\u65e5\u8a8c\u689d\u76ee\uff0c\u5373\u4f7f\u4f60\u6210\u529f\u5730\u5c07\u5176\u91cd\u5b9a\u5411\u5230\u5bb9\u5668\u7684 stdout \u6d41\u3002\u76f8\u53cd\uff0c\u4f60\u53ef\u4ee5\u5275\u5efa\u5169\u500b\u908a\u8eca\u5bb9\u5668\u3002\u6bcf\u500b\u908a\u8eca\u5bb9\u5668\u53ef\u4ee5\u5f9e\u5171\u4eab\u5377\u8ddf\u8e2a\u7279\u5b9a\u7684\u65e5\u8a8c\u6587\u4ef6\uff0c \u4e26\u5c07\u6587\u4ef6\u5167\u5bb9\u91cd\u5b9a\u5411\u5230\u5404\u81ea\u7684 stdout \u6d41\u3002 \u4e0b\u9762\u662f\u904b\u884c\u5169\u500b\u908a\u8eca\u5bb9\u5668\u7684 Pod \u7684\u914d\u7f6e\u6587\u4ef6\uff1a admin/logging/two-files-counter-pod-streaming-sidecar.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts : - name : varlog mountPath : /var/log - name : count-log-1 image : busybox:1.28 args : [ /bin/sh , -c , 'tail -n+1 -F /var/log/1.log' ] volumeMounts : - name : varlog mountPath : /var/log - name : count-log-2 image : busybox:1.28 args : [ /bin/sh , -c , 'tail -n+1 -F /var/log/2.log' ] volumeMounts : - name : varlog mountPath : /var/log volumes : - name : varlog emptyDir : {} \u73fe\u5728\u7576\u4f60\u904b\u884c\u9019\u500b Pod \u6642\uff0c\u4f60\u53ef\u4ee5\u904b\u884c\u5982\u4e0b\u547d\u4ee4\u5206\u5225\u8a2a\u554f\u6bcf\u500b\u65e5\u8a8c\u6d41\uff1a kubectl logs counter count-log-1 \u8f38\u51fa\u70ba\uff1a 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ... kubectl logs counter count-log-2 \u8f38\u51fa\u70ba\uff1a Mon Jan 1 00:00:00 UTC 2001 INFO 0 Mon Jan 1 00:00:01 UTC 2001 INFO 1 Mon Jan 1 00:00:02 UTC 2001 INFO 2 ... \u96c6\u7fa4\u4e2d\u5b89\u88dd\u7684\u7bc0\u9ede\u7d1a\u4ee3\u7406\u6703\u81ea\u52d5\u7372\u53d6\u9019\u4e9b\u65e5\u8a8c\u6d41\uff0c\u800c\u7121\u9700\u9032\u4e00\u6b65\u914d\u7f6e\u3002\u5982\u679c\u4f60\u9858\u610f\uff0c\u4f60\u4e5f\u53ef\u4ee5\u914d\u7f6e\u4ee3\u7406\u7a0b\u5e8f\u4f86\u89e3\u6790\u6e90\u5bb9\u5668\u7684\u65e5\u8a8c\u884c\u3002 \u6ce8\u610f\uff0c\u5118\u7ba1 CPU \u548c\u5167\u5b58\u4f7f\u7528\u7387\u90fd\u5f88\u4f4e\uff08\u4ee5\u591a\u500b CPU \u6beb\u6838\u6307\u6a19\u6392\u5e8f\u6216\u8005\u6309\u5167\u5b58\u7684\u5146\u5b57\u7bc0\u6392\u5e8f\uff09\uff0c \u5411\u6587\u4ef6\u5beb\u65e5\u8a8c\u7136\u5f8c\u8f38\u51fa\u5230 stdout \u6d41\u4ecd\u7136\u6703\u6210\u500d\u5730\u589e\u52a0\u78c1\u76e4\u4f7f\u7528\u7387\u3002\u5982\u679c\u4f60\u7684\u61c9\u7528\u5411\u55ae\u4e00\u6587\u4ef6\u5beb\u65e5\u8a8c\uff0c\u901a\u5e38\u6700\u597d\u8a2d\u7f6e /dev/stdout \u4f5c\u70ba\u76ee\u6a19\u8def\u5f91\uff0c \u800c\u4e0d\u662f\u4f7f\u7528\u6d41\u5f0f\u7684\u908a\u8eca\u5bb9\u5668\u65b9\u5f0f\u3002 \u61c9\u7528\u672c\u8eab\u5982\u679c\u4e0d\u5177\u5099\u8f2a\u8f49\u65e5\u8a8c\u6587\u4ef6\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u904e\u908a\u8eca\u5bb9\u5668\u5be6\u73fe\u3002\u8a72\u65b9\u5f0f\u7684\u4e00\u500b\u4f8b\u5b50\u662f\u904b\u884c\u4e00\u500b\u5c0f\u7684\u3001\u5b9a\u671f\u8f2a\u8f49\u65e5\u8a8c\u7684\u5bb9\u5668\u3002\u7136\u800c\uff0c\u9084\u662f\u63a8\u85a6\u76f4\u63a5\u4f7f\u7528 stdout \u548c stderr\uff0c\u5c07\u65e5\u8a8c\u7684\u8f2a\u8f49\u548c\u4fdd\u7559\u7b56\u7565\u4ea4\u7d66 kubelet\u3002 \u5177\u6709\u65e5\u8a8c\u4ee3\u7406\u529f\u80fd\u7684\u908a\u8eca\u5bb9\u5668 \u00b6 \u5982\u679c\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406\u7a0b\u5e8f\u5c0d\u65bc\u4f60\u7684\u5834\u666f\u4f86\u8aaa\u4e0d\u5920\u9748\u6d3b\uff0c \u4f60\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u5e36\u6709\u55ae\u7368\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406\u7684\u908a\u8eca\u5bb9\u5668\uff0c\u5c07\u4ee3\u7406\u7a0b\u5e8f\u5c08\u9580\u914d\u7f6e\u70ba\u8207\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u4e00\u8d77\u904b\u884c\u3002 Info \u8aaa\u660e\uff1a \u5728\u908a\u8eca\u5bb9\u5668\u4e2d\u4f7f\u7528\u65e5\u8a8c\u4ee3\u7406\u6703\u5e36\u4f86\u56b4\u91cd\u7684\u8cc7\u6e90\u640d\u8017\u3002\u6b64\u5916\uff0c\u4f60\u4e0d\u80fd\u4f7f\u7528 kubectl logs \u547d\u4ee4\u8a2a\u554f\u65e5\u8a8c\uff0c\u56e0\u70ba\u65e5\u8a8c\u4e26\u6c92\u6709\u88ab kubelet \u7ba1\u7406\u3002 \u4e0b\u9762\u662f\u5169\u500b\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u7528\u4f86\u5be6\u73fe\u4e00\u500b\u5e36\u65e5\u8a8c\u4ee3\u7406\u7684\u908a\u8eca\u5bb9\u5668\u3002\u7b2c\u4e00\u500b\u6587\u4ef6\u5305\u542b\u7528\u4f86\u914d\u7f6e fluentd \u7684 ConfigMap\u3002 admin/logging/fluentd-sidecar-config.yaml apiVersion : v1 kind : ConfigMap metadata : name : fluentd-config data : fluentd.conf : | <source> type tail format none path /var/log/1.log pos_file /var/log/1.log.pos tag count.format1 </source> <source> type tail format none path /var/log/2.log pos_file /var/log/2.log.pos tag count.format2 </source> <match **> type google_cloud </match> Info \u8aaa\u660e\uff1a \u8981\u9032\u4e00\u6b65\u4e86\u89e3\u5982\u4f55\u914d\u7f6e fluentd\uff0c\u8acb\u53c3\u8003 fluentd \u5b98\u65b9\u6587\u6a94 \u3002 \u7b2c\u4e8c\u500b\u6587\u4ef6\u63cf\u8ff0\u4e86\u904b\u884c fluentd \u908a\u8eca\u5bb9\u5668\u7684 Pod \u3002 flutend \u901a\u904e Pod \u7684\u639b\u8f09\u5377\u7372\u53d6\u5b83\u7684\u914d\u7f6e\u6578\u64da\u3002 admin/logging/two-files-counter-pod-agent-sidecar.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts : - name : varlog mountPath : /var/log - name : count-agent image : k8s.gcr.io/fluentd-gcp:1.30 env : - name : FLUENTD_ARGS value : -c /etc/fluentd-config/fluentd.conf volumeMounts : - name : varlog mountPath : /var/log - name : config-volume mountPath : /etc/fluentd-config volumes : - name : varlog emptyDir : {} - name : config-volume configMap : name : fluentd-config \u5728\u793a\u4f8b\u914d\u7f6e\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5c07 fluentd \u66ff\u63db\u70ba\u4efb\u4f55\u65e5\u8a8c\u4ee3\u7406\uff0c\u5f9e\u61c9\u7528\u5bb9\u5668\u5167\u7684\u4efb\u4f55\u4f86\u6e90\u8b80\u53d6\u6578\u64da\u3002 \u5f9e\u61c9\u7528\u4e2d\u76f4\u63a5\u66b4\u9732\u65e5\u8a8c\u76ee\u9304 \u00b6 \u5f9e\u5404\u500b\u61c9\u7528\u4e2d\u76f4\u63a5\u66b4\u9732\u548c\u63a8\u9001\u65e5\u8a8c\u6578\u64da\u7684\u96c6\u7fa4\u65e5\u8a8c\u6a5f\u5236\u5df2\u8d85\u51fa Kubernetes \u7684\u7bc4\u570d\u3002","title":"\u65e5\u8a8c\u67b6\u69cb"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#_1","text":"\u61c9\u7528\u65e5\u8a8c\u53ef\u4ee5\u8b93\u4f60\u4e86\u89e3\u61c9\u7528\u5167\u90e8\u7684\u904b\u884c\u72c0\u6cc1\u3002\u65e5\u8a8c\u5c0d\u8abf\u8a66\u554f\u984c\u548c\u76e3\u63a7\u96c6\u7fa4\u6d3b\u52d5\u975e\u5e38\u6709\u7528\u3002\u5927\u90e8\u5206\u73fe\u4ee3\u5316\u61c9\u7528\u90fd\u6709\u67d0\u7a2e\u65e5\u8a8c\u8a18\u9304\u6a5f\u5236\u3002\u540c\u6a23\u5730\uff0c\u5bb9\u5668\u5f15\u64ce\u4e5f\u88ab\u8a2d\u8a08\u6210\u652f\u6301\u65e5\u8a8c\u8a18\u9304\u3002\u91dd\u5c0d\u5bb9\u5668\u5316\u61c9\u7528\uff0c\u6700\u7c21\u55ae\u4e14\u6700\u5ee3\u6cdb\u63a1\u7528\u7684\u65e5\u8a8c\u8a18\u9304\u65b9\u5f0f\u5c31\u662f\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\u548c\u6a19\u6e96\u932f\u8aa4\u6d41\u3002 \u4f46\u662f\uff0c\u7531\u5bb9\u5668\u5f15\u64ce\u6216\u904b\u884c\u6642\u63d0\u4f9b\u7684\u539f\u751f\u529f\u80fd\u901a\u5e38\u4e0d\u8db3\u4ee5\u69cb\u6210\u5b8c\u6574\u7684\u65e5\u8a8c\u8a18\u9304\u65b9\u6848\u3002\u4f8b\u5982\uff0c\u5982\u679c\u767c\u751f\u5bb9\u5668\u5d29\u6f70\u3001Pod \u88ab\u9010\u51fa\u6216\u7bc0\u9ede\u5b95\u6a5f\u7b49\u60c5\u6cc1\uff0c\u4f60\u53ef\u80fd\u60f3\u8a2a\u554f\u61c9\u7528\u65e5\u8a8c\u3002\u5728\u96c6\u7fa4\u4e2d\uff0c\u65e5\u8a8c\u61c9\u8a72\u5177\u6709\u7368\u7acb\u7684\u5b58\u5132\u548c\u751f\u547d\u9031\u671f\uff0c\u8207\u7bc0\u9ede\u3001Pod \u6216\u5bb9\u5668\u7684\u751f\u547d\u9031\u671f\u76f8\u7368\u7acb\u3002\u9019\u500b\u6982\u5ff5\u53eb \u96c6\u7fa4\u7d1a\u7684\u65e5\u8a8c \u3002 \u96c6\u7fa4\u7d1a\u65e5\u8a8c\u67b6\u69cb\u9700\u8981\u4e00\u500b\u7368\u7acb\u7684\u5f8c\u7aef\u7528\u4f86\u5b58\u5132\u3001\u5206\u6790\u548c\u67e5\u8a62\u65e5\u8a8c\u3002 Kubernetes \u4e26\u4e0d\u70ba\u65e5\u8a8c\u6578\u64da\u63d0\u4f9b\u539f\u751f\u7684\u5b58\u5132\u89e3\u6c7a\u65b9\u6848\u3002\u76f8\u53cd\uff0c\u6709\u5f88\u591a\u73fe\u6210\u7684\u65e5\u8a8c\u65b9\u6848\u53ef\u4ee5\u96c6\u6210\u5230 Kubernetes \u4e2d\u3002\u4e0b\u9762\u5404\u7bc0\u63cf\u8ff0\u5982\u4f55\u5728\u7bc0\u9ede\u4e0a\u8655\u7406\u548c\u5b58\u5132\u65e5\u8a8c\u3002","title":"\u65e5\u8a8c\u67b6\u69cb"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#kubernetes","text":"\u9019\u88e1\u7684\u793a\u4f8b\u4f7f\u7528\u5305\u542b\u4e00\u500b\u5bb9\u5668\u7684 Pod spec\uff0c\u6bcf\u79d2\u9418\u5411\u6a19\u6e96\u8f38\u51fa(stdout)\u5beb\u5165\u6578\u64da\u3002 debug/counter-pod.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : [ /bin/sh , -c , 'i=0; while true; do echo \"$i: $(date)\"; i=$((i+1)); sleep 1; done' ] \u7528\u4e0b\u9762\u7684\u547d\u4ee4\u904b\u884c Pod\uff1a kubectl apply -f https://k8s.io/examples/debug/counter-pod.yaml \u8f38\u51fa\u7d50\u679c\u70ba\uff1a pod/counter created \u50cf\u4e0b\u9762\u9019\u6a23\uff0c\u4f7f\u7528 kubectl logs \u547d\u4ee4\u7372\u53d6\u65e5\u8a8c: kubectl logs counter \u8f38\u51fa\u7d50\u679c\u70ba\uff1a 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ... \u4f60\u53ef\u4ee5\u4f7f\u7528\u547d\u4ee4 kubectl logs --previous \u6aa2\u7d22\u4e4b\u524d\u5bb9\u5668\u5be6\u4f8b\u7684\u65e5\u8a8c\u3002\u5982\u679c Pod \u6709\u591a\u500b\u5bb9\u5668\uff0c\u4f60\u61c9\u8a72\u70ba\u8a72\u547d\u4ee4\u9644\u52a0\u5bb9\u5668\u540d\u4ee5\u8a2a\u554f\u5c0d\u61c9\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c \u4f7f\u7528 -c \u6a19\u8a8c\u4f86\u6307\u5b9a\u8981\u8a2a\u554f\u7684\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u5982\u4e0b\u6240\u793a\uff1a kubectl logs counter -c count \u8a73\u898b kubectl logs \u6587\u6a94 \u3002","title":"Kubernetes \u4e2d\u7684\u57fa\u672c\u65e5\u8a8c\u8a18\u9304"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#_2","text":"\u5bb9\u5668\u5316\u61c9\u7528\u5beb\u5165 stdout \u548c stderr \u7684\u4efb\u4f55\u6578\u64da\uff0c\u90fd\u6703\u88ab\u5bb9\u5668\u5f15\u64ce\u6355\u7372\u4e26\u88ab\u91cd\u5b9a\u5411\u5230\u67d0\u500b\u4f4d\u7f6e\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u5bb9\u5668\u91cd\u555f\uff0ckubelet \u6703\u4fdd\u7559\u88ab\u7d42\u6b62\u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u5982\u679c Pod \u5728\u5de5\u4f5c\u7bc0\u9ede\u88ab\u9a45\u9010\uff0c\u8a72 Pod \u4e2d\u6240\u6709\u7684\u5bb9\u5668\u4e5f\u6703\u88ab\u9a45\u9010\uff0c\u5305\u62ec\u5bb9\u5668\u65e5\u8a8c\u3002 \u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4e2d\uff0c\u9700\u8981\u91cd\u9ede\u8003\u616e\u5be6\u73fe \u65e5\u8a8c\u7684\u8f2a\u8f49 \uff0c\u4ee5\u6b64\u4f86\u4fdd\u8b49\u65e5\u8a8c\u4e0d\u6703\u6d88\u8017\u7bc0\u9ede\u4e0a\u5168\u90e8\u53ef\u7528\u7a7a\u9593\u3002 Kubernetes \u4e26\u4e0d\u8ca0\u8cac\u8f2a\u8f49\u65e5\u8a8c\uff0c\u800c\u662f\u901a\u904e\u90e8\u7f72\u5de5\u5177\u5efa\u7acb\u4e00\u500b\u89e3\u6c7a\u554f\u984c\u7684\u65b9\u6848\u3002\u4f8b\u5982\uff0c\u5728\u7528 kube-up.sh \u90e8\u7f72\u7684 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u5b58\u5728\u4e00\u500b logrotate \uff0c\u6bcf\u5c0f\u6642\u904b\u884c\u4e00\u6b21\u3002\u4f60\u4e5f\u53ef\u4ee5\u8a2d\u7f6e\u5bb9\u5668\u904b\u884c\u6642\u4f86\u81ea\u52d5\u5730\u8f2a\u8f49\u61c9\u7528\u65e5\u8a8c\u3002 \u7576\u4f7f\u7528\u67d0 CRI \u5bb9\u5668 runtime \u6642\uff0c kubelet \u8981\u8ca0\u8cac\u5c0d\u65e5\u8a8c\u9032\u884c\u8f2a\u63db\uff0c\u4e26\u7ba1\u7406\u65e5\u8a8c\u76ee\u9304\u7684\u7d50\u69cb \u3002 kubelet \u5c07\u6b64\u4fe1\u606f\u767c\u9001\u7d66 CRI \u5bb9\u5668\u904b\u884c\u6642\uff0c\u5f8c\u8005\u5c07\u5bb9\u5668\u65e5\u8a8c\u5beb\u5165\u5230\u6307\u5b9a\u7684\u4f4d\u7f6e\u3002\u5728 kubelet \u914d\u7f6e\u6587\u4ef6 \u4e2d\u7684\u5169\u500b kubelet \u53c3\u6578 containerLogMaxSize \u548c containerLogMaxFiles \u53ef\u4ee5\u7528\u4f86\u914d\u7f6e\u6bcf\u500b\u65e5\u8a8c\u6587\u4ef6\u7684\u6700\u5927\u9577\u5ea6\u548c\u6bcf\u500b\u5bb9\u5668\u53ef\u4ee5\u751f\u6210\u7684\u65e5\u8a8c\u6587\u4ef6\u500b\u6578\u4e0a\u9650\u3002 \u7576\u904b\u884c kubectl logs \u6642\uff0c \u7bc0\u9ede\u4e0a\u7684 kubelet \u8655\u7406\u8a72\u8acb\u6c42\u4e26\u76f4\u63a5\u8b80\u53d6\u65e5\u8a8c\u6587\u4ef6\uff0c\u540c\u6642\u5728\u97ff\u61c9\u4e2d\u8fd4\u56de\u65e5\u8a8c\u6587\u4ef6\u5167\u5bb9\u3002 Info \u8aaa\u660e\uff1a \u5982\u679c\u6709\u5916\u90e8\u7cfb\u7d71\u57f7\u884c\u65e5\u8a8c\u8f2a\u8f49\u6216\u8005\u4f7f\u7528\u4e86 CRI \u5bb9\u5668\u904b\u884c\u6642\uff0c\u90a3\u9ebc kubectl logs \u50c5\u53ef\u67e5\u8a62\u5230\u6700\u65b0\u7684\u65e5\u8a8c\u5167\u5bb9\u3002\u6bd4\u5982\uff0c\u5c0d\u65bc\u4e00\u500b 10MB \u5927\u5c0f\u7684\u6587\u4ef6\uff0c\u901a\u904e logrotate \u57f7\u884c\u8f2a\u8f49\u5f8c\u751f\u6210\u5169\u500b\u6587\u4ef6\uff0c \u4e00\u500b 10MB \u5927\u5c0f\uff0c\u4e00\u500b\u70ba\u7a7a\uff0ckubectl logs \u8fd4\u56de\u6700\u65b0\u7684\u65e5\u8a8c\u6587\u4ef6\uff0c\u800c\u8a72\u65e5\u8a8c\u6587\u4ef6\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\u70ba\u7a7a\u3002","title":"\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#_3","text":"\u7cfb\u7d71\u7d44\u4ef6\u6709\u5169\u7a2e\u985e\u578b\uff1a\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684\u548c\u4e0d\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684\u3002\u4f8b\u5982\uff1a \u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684 kube-scheduler \u548c kube-proxy\u3002 \u4e0d\u5728\u5bb9\u5668\u4e2d\u904b\u884c\u7684 kubelet \u548c\u5bb9\u5668 runtime\u3002 \u5728\u4f7f\u7528 systemd \u6a5f\u5236\u7684\u670d\u52d9\u5668\u4e0a\uff0ckubelet \u548c\u5bb9\u5668\u904b\u884c\u6642\u5c07\u65e5\u8a8c\u5beb\u5165\u5230 journald \u4e2d\u3002\u5982\u679c\u6c92\u6709 systemd\uff0c\u5b83\u5011\u5c07\u65e5\u8a8c\u5beb\u5165\u5230 /var/log \u76ee\u9304\u4e0b\u7684 .log \u6587\u4ef6\u4e2d\u3002\u5bb9\u5668\u4e2d\u7684\u7cfb\u7d71\u7d44\u4ef6\u901a\u5e38\u5c07\u65e5\u8a8c\u5beb\u5230 /var/log \u76ee\u9304\uff0c\u7e5e\u904e\u4e86\u9ed8\u8a8d\u7684\u65e5\u8a8c\u6a5f\u5236\u3002\u4ed6\u5011\u4f7f\u7528 klog \u65e5\u8a8c\u5eab\u3002\u4f60\u53ef\u4ee5\u5728 \u65e5\u8a8c\u958b\u767c\u6587\u6a94 \u627e\u5230\u9019\u4e9b\u7d44\u4ef6\u7684\u65e5\u8a8c\u544a\u8b66\u7d1a\u5225\u7d04\u5b9a\u3002 \u548c\u5bb9\u5668\u65e5\u8a8c\u985e\u4f3c\uff0c /var/log \u76ee\u9304\u4e2d\u7684\u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c\u4e5f\u61c9\u8a72\u88ab\u8f2a\u8f49\u3002\u901a\u904e\u8173\u672c kube-up.sh \u555f\u52d5\u7684 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u65e5\u8a8c\u88ab\u5de5\u5177 logrotate \u57f7\u884c\u6bcf\u65e5\u8f2a\u8f49\uff0c\u6216\u8005\u65e5\u8a8c\u5927\u5c0f\u8d85\u904e 100MB \u6642\u89f8\u767c\u8f2a\u8f49\u3002","title":"\u7cfb\u7d71\u7d44\u4ef6\u65e5\u8a8c"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#_4","text":"\u96d6\u7136 Kubernetes \u6c92\u6709\u70ba\u96c6\u7fa4\u7d1a\u65e5\u8a8c\u8a18\u9304\u63d0\u4f9b\u539f\u751f\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u4f46\u4f60\u53ef\u4ee5\u8003\u616e\u5e7e\u7a2e\u5e38\u898b\u7684\u65b9\u6cd5\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u9078\u9805\uff1a \u4f7f\u7528\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406\u3002 \u5728\u61c9\u7528\u7a0b\u5e8f\u7684 Pod \u4e2d\uff0c\u5305\u542b\u5c08\u9580\u8a18\u9304\u65e5\u8a8c\u7684\u908a\u8eca\uff08Sidecar\uff09\u5bb9\u5668\u3002 \u5c07\u65e5\u8a8c\u76f4\u63a5\u5f9e\u61c9\u7528\u7a0b\u5e8f\u4e2d\u63a8\u9001\u5230\u65e5\u8a8c\u8a18\u9304\u5f8c\u7aef\u3002","title":"\u96c6\u7fa4\u7d1a\u65e5\u8a8c\u67b6\u69cb"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#_5","text":"\u4f60\u53ef\u4ee5\u901a\u904e\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u4f7f\u7528 \u7bc0\u9ede\u7d1a\u7684\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u4f86\u5be6\u73fe\u96c6\u7fa4\u7d1a\u65e5\u8a8c\u8a18\u9304\u3002 \u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u662f\u4e00\u7a2e\u7528\u65bc\u66b4\u9732\u65e5\u8a8c\u6216\u5c07\u65e5\u8a8c\u63a8\u9001\u5230\u5f8c\u7aef\u7684\u5c08\u7528\u5de5\u5177\u3002\u901a\u5e38 \u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u7a0b\u5e8f\u662f\u4e00\u500b\u5bb9\u5668\uff0c\u5b83\u53ef\u4ee5\u8a2a\u554f\u5305\u542b\u8a72\u7bc0\u9ede\u4e0a\u6240\u6709\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u7684\u65e5\u8a8c\u6587\u4ef6\u7684\u76ee\u9304\u3002 \u7531\u65bc \u65e5\u8a8c\u8a18\u9304\u4ee3\u7406 \u5fc5\u9808\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\uff0c\u901a\u5e38\u53ef\u4ee5\u7528 DaemonSet \u7684\u5f62\u5f0f\u904b\u884c\u8a72\u4ee3\u7406\u3002\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u5728\u6bcf\u500b\u7bc0\u9ede\u4e0a\u50c5\u5275\u5efa\u4e00\u500b\u4ee3\u7406\uff0c\u4e0d\u9700\u8981\u5c0d\u7bc0\u9ede\u4e0a\u7684\u61c9\u7528\u505a\u4fee\u6539\u3002 \u5bb9\u5668\u5411\u6a19\u6e96\u8f38\u51fa(stdout)\u548c\u6a19\u6e96\u932f\u8aa4\u8f38\u51fa(stderr)\u5beb\u51fa\u6578\u64da\uff0c\u4f46\u5728\u683c\u5f0f\u4e0a\u4e26\u4e0d\u7d71\u4e00\u3002 \u7bc0\u9ede\u7d1a\u4ee3\u7406 \u6536\u96c6\u9019\u4e9b\u65e5\u8a8c\u4e26\u5c07\u5176\u9032\u884c\u8f49\u767c\u4ee5\u5b8c\u6210\u532f\u7e3d\u3002","title":"\u4f7f\u7528\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u4ee3\u7406"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#sidecar","text":"\u4f60\u53ef\u4ee5\u901a\u904e\u4ee5\u4e0b\u65b9\u5f0f\u4e4b\u4e00\u4f7f\u7528\u908a\u8eca\uff08Sidecar\uff09\u5bb9\u5668\uff1a \u908a\u8eca\u5bb9\u5668\u5c07\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u50b3\u9001\u5230\u81ea\u5df1\u7684\u6a19\u6e96\u8f38\u51fa\u3002 \u908a\u8eca\u5bb9\u5668\u904b\u884c\u4e00\u500b\u65e5\u8a8c\u4ee3\u7406\uff0c\u914d\u7f6e\u8a72\u65e5\u8a8c\u4ee3\u7406\u4ee5\u4fbf\u5f9e\u61c9\u7528\u5bb9\u5668\u6536\u96c6\u65e5\u8a8c\u3002 \u5229\u7528\u908a\u8eca\u5bb9\u5668\u5411\u81ea\u5df1\u7684 stdout \u548c stderr \u50b3\u8f38\u6d41\u7684\u65b9\u5f0f\uff0c \u4f60\u5c31\u53ef\u4ee5\u5229\u7528\u6bcf\u500b\u7bc0\u9ede\u4e0a\u7684 kubelet \u548c\u65e5\u8a8c\u4ee3\u7406\u4f86\u8655\u7406\u65e5\u8a8c\u3002\u908a\u8eca\u5bb9\u5668\u5f9e\u6587\u4ef6\u3001\u5957\u63a5\u5b57\u6216 journald \u8b80\u53d6\u65e5\u8a8c\u3002\u6bcf\u500b\u908a\u8eca\u5bb9\u5668\u5411\u81ea\u5df1\u7684 stdout \u548c stderr \u6d41\u4e2d\u8f38\u51fa\u65e5\u8a8c\u3002 \u9019\u7a2e\u65b9\u6cd5\u5141\u8a31\u4f60\u5c07\u65e5\u8a8c\u6d41\u5f9e\u61c9\u7528\u7a0b\u5e8f\u7684\u4e0d\u540c\u90e8\u5206\u5206\u96e2\u958b\uff0c\u5176\u4e2d\u4e00\u4e9b\u53ef\u80fd\u7f3a\u4e4f\u5c0d\u5beb\u5165 stdout \u6216 stderr \u7684\u652f\u6301\u3002\u91cd\u5b9a\u5411\u65e5\u8a8c\u80cc\u5f8c\u7684\u908f\u8f2f\u662f\u6700\u5c0f\u7684\uff0c\u56e0\u6b64\u5b83\u7684\u958b\u92b7\u5e7e\u4e4e\u53ef\u4ee5\u5ffd\u7565\u4e0d\u8a08\u3002\u53e6\u5916\uff0c\u56e0\u70ba stdout \u548c stderr \u7531 kubelet \u8655\u7406\uff0c\u6240\u4ee5\u4f60\u53ef\u4ee5\u4f7f\u7528\u5167\u7f6e\u7684\u5de5\u5177 kubectl logs\u3002 \u4f8b\u5982\uff0c\u67d0 Pod \u4e2d\u904b\u884c\u4e00\u500b\u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u5411\u5169\u500b\u6587\u4ef6\u5beb\u4e0d\u540c\u683c\u5f0f\u7684\u65e5\u8a8c\u3002\u4e0b\u9762\u662f\u9019\u500b Pod \u7684\u914d\u7f6e\u6587\u4ef6: admin/logging/two-files-counter-pod.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts : - name : varlog mountPath : /var/log volumes : - name : varlog emptyDir : {} \u4e0d\u5efa\u8b70\u5728\u540c\u4e00\u500b\u65e5\u8a8c\u6d41\u4e2d\u5beb\u5165\u4e0d\u540c\u683c\u5f0f\u7684\u65e5\u8a8c\u689d\u76ee\uff0c\u5373\u4f7f\u4f60\u6210\u529f\u5730\u5c07\u5176\u91cd\u5b9a\u5411\u5230\u5bb9\u5668\u7684 stdout \u6d41\u3002\u76f8\u53cd\uff0c\u4f60\u53ef\u4ee5\u5275\u5efa\u5169\u500b\u908a\u8eca\u5bb9\u5668\u3002\u6bcf\u500b\u908a\u8eca\u5bb9\u5668\u53ef\u4ee5\u5f9e\u5171\u4eab\u5377\u8ddf\u8e2a\u7279\u5b9a\u7684\u65e5\u8a8c\u6587\u4ef6\uff0c \u4e26\u5c07\u6587\u4ef6\u5167\u5bb9\u91cd\u5b9a\u5411\u5230\u5404\u81ea\u7684 stdout \u6d41\u3002 \u4e0b\u9762\u662f\u904b\u884c\u5169\u500b\u908a\u8eca\u5bb9\u5668\u7684 Pod \u7684\u914d\u7f6e\u6587\u4ef6\uff1a admin/logging/two-files-counter-pod-streaming-sidecar.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts : - name : varlog mountPath : /var/log - name : count-log-1 image : busybox:1.28 args : [ /bin/sh , -c , 'tail -n+1 -F /var/log/1.log' ] volumeMounts : - name : varlog mountPath : /var/log - name : count-log-2 image : busybox:1.28 args : [ /bin/sh , -c , 'tail -n+1 -F /var/log/2.log' ] volumeMounts : - name : varlog mountPath : /var/log volumes : - name : varlog emptyDir : {} \u73fe\u5728\u7576\u4f60\u904b\u884c\u9019\u500b Pod \u6642\uff0c\u4f60\u53ef\u4ee5\u904b\u884c\u5982\u4e0b\u547d\u4ee4\u5206\u5225\u8a2a\u554f\u6bcf\u500b\u65e5\u8a8c\u6d41\uff1a kubectl logs counter count-log-1 \u8f38\u51fa\u70ba\uff1a 0: Mon Jan 1 00:00:00 UTC 2001 1: Mon Jan 1 00:00:01 UTC 2001 2: Mon Jan 1 00:00:02 UTC 2001 ... kubectl logs counter count-log-2 \u8f38\u51fa\u70ba\uff1a Mon Jan 1 00:00:00 UTC 2001 INFO 0 Mon Jan 1 00:00:01 UTC 2001 INFO 1 Mon Jan 1 00:00:02 UTC 2001 INFO 2 ... \u96c6\u7fa4\u4e2d\u5b89\u88dd\u7684\u7bc0\u9ede\u7d1a\u4ee3\u7406\u6703\u81ea\u52d5\u7372\u53d6\u9019\u4e9b\u65e5\u8a8c\u6d41\uff0c\u800c\u7121\u9700\u9032\u4e00\u6b65\u914d\u7f6e\u3002\u5982\u679c\u4f60\u9858\u610f\uff0c\u4f60\u4e5f\u53ef\u4ee5\u914d\u7f6e\u4ee3\u7406\u7a0b\u5e8f\u4f86\u89e3\u6790\u6e90\u5bb9\u5668\u7684\u65e5\u8a8c\u884c\u3002 \u6ce8\u610f\uff0c\u5118\u7ba1 CPU \u548c\u5167\u5b58\u4f7f\u7528\u7387\u90fd\u5f88\u4f4e\uff08\u4ee5\u591a\u500b CPU \u6beb\u6838\u6307\u6a19\u6392\u5e8f\u6216\u8005\u6309\u5167\u5b58\u7684\u5146\u5b57\u7bc0\u6392\u5e8f\uff09\uff0c \u5411\u6587\u4ef6\u5beb\u65e5\u8a8c\u7136\u5f8c\u8f38\u51fa\u5230 stdout \u6d41\u4ecd\u7136\u6703\u6210\u500d\u5730\u589e\u52a0\u78c1\u76e4\u4f7f\u7528\u7387\u3002\u5982\u679c\u4f60\u7684\u61c9\u7528\u5411\u55ae\u4e00\u6587\u4ef6\u5beb\u65e5\u8a8c\uff0c\u901a\u5e38\u6700\u597d\u8a2d\u7f6e /dev/stdout \u4f5c\u70ba\u76ee\u6a19\u8def\u5f91\uff0c \u800c\u4e0d\u662f\u4f7f\u7528\u6d41\u5f0f\u7684\u908a\u8eca\u5bb9\u5668\u65b9\u5f0f\u3002 \u61c9\u7528\u672c\u8eab\u5982\u679c\u4e0d\u5177\u5099\u8f2a\u8f49\u65e5\u8a8c\u6587\u4ef6\u7684\u529f\u80fd\uff0c\u53ef\u4ee5\u901a\u904e\u908a\u8eca\u5bb9\u5668\u5be6\u73fe\u3002\u8a72\u65b9\u5f0f\u7684\u4e00\u500b\u4f8b\u5b50\u662f\u904b\u884c\u4e00\u500b\u5c0f\u7684\u3001\u5b9a\u671f\u8f2a\u8f49\u65e5\u8a8c\u7684\u5bb9\u5668\u3002\u7136\u800c\uff0c\u9084\u662f\u63a8\u85a6\u76f4\u63a5\u4f7f\u7528 stdout \u548c stderr\uff0c\u5c07\u65e5\u8a8c\u7684\u8f2a\u8f49\u548c\u4fdd\u7559\u7b56\u7565\u4ea4\u7d66 kubelet\u3002","title":"\u4f7f\u7528 sidecar \u5bb9\u5668\u904b\u884c\u65e5\u8a8c\u4ee3\u7406"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#_6","text":"\u5982\u679c\u7bc0\u9ede\u7d1a\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406\u7a0b\u5e8f\u5c0d\u65bc\u4f60\u7684\u5834\u666f\u4f86\u8aaa\u4e0d\u5920\u9748\u6d3b\uff0c \u4f60\u53ef\u4ee5\u5275\u5efa\u4e00\u500b\u5e36\u6709\u55ae\u7368\u65e5\u8a8c\u8a18\u9304\u4ee3\u7406\u7684\u908a\u8eca\u5bb9\u5668\uff0c\u5c07\u4ee3\u7406\u7a0b\u5e8f\u5c08\u9580\u914d\u7f6e\u70ba\u8207\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u4e00\u8d77\u904b\u884c\u3002 Info \u8aaa\u660e\uff1a \u5728\u908a\u8eca\u5bb9\u5668\u4e2d\u4f7f\u7528\u65e5\u8a8c\u4ee3\u7406\u6703\u5e36\u4f86\u56b4\u91cd\u7684\u8cc7\u6e90\u640d\u8017\u3002\u6b64\u5916\uff0c\u4f60\u4e0d\u80fd\u4f7f\u7528 kubectl logs \u547d\u4ee4\u8a2a\u554f\u65e5\u8a8c\uff0c\u56e0\u70ba\u65e5\u8a8c\u4e26\u6c92\u6709\u88ab kubelet \u7ba1\u7406\u3002 \u4e0b\u9762\u662f\u5169\u500b\u914d\u7f6e\u6587\u4ef6\uff0c\u53ef\u4ee5\u7528\u4f86\u5be6\u73fe\u4e00\u500b\u5e36\u65e5\u8a8c\u4ee3\u7406\u7684\u908a\u8eca\u5bb9\u5668\u3002\u7b2c\u4e00\u500b\u6587\u4ef6\u5305\u542b\u7528\u4f86\u914d\u7f6e fluentd \u7684 ConfigMap\u3002 admin/logging/fluentd-sidecar-config.yaml apiVersion : v1 kind : ConfigMap metadata : name : fluentd-config data : fluentd.conf : | <source> type tail format none path /var/log/1.log pos_file /var/log/1.log.pos tag count.format1 </source> <source> type tail format none path /var/log/2.log pos_file /var/log/2.log.pos tag count.format2 </source> <match **> type google_cloud </match> Info \u8aaa\u660e\uff1a \u8981\u9032\u4e00\u6b65\u4e86\u89e3\u5982\u4f55\u914d\u7f6e fluentd\uff0c\u8acb\u53c3\u8003 fluentd \u5b98\u65b9\u6587\u6a94 \u3002 \u7b2c\u4e8c\u500b\u6587\u4ef6\u63cf\u8ff0\u4e86\u904b\u884c fluentd \u908a\u8eca\u5bb9\u5668\u7684 Pod \u3002 flutend \u901a\u904e Pod \u7684\u639b\u8f09\u5377\u7372\u53d6\u5b83\u7684\u914d\u7f6e\u6578\u64da\u3002 admin/logging/two-files-counter-pod-agent-sidecar.yaml apiVersion : v1 kind : Pod metadata : name : counter spec : containers : - name : count image : busybox:1.28 args : - /bin/sh - -c - > i=0; while true; do echo \"$i: $(date)\" >> /var/log/1.log; echo \"$(date) INFO $i\" >> /var/log/2.log; i=$((i+1)); sleep 1; done volumeMounts : - name : varlog mountPath : /var/log - name : count-agent image : k8s.gcr.io/fluentd-gcp:1.30 env : - name : FLUENTD_ARGS value : -c /etc/fluentd-config/fluentd.conf volumeMounts : - name : varlog mountPath : /var/log - name : config-volume mountPath : /etc/fluentd-config volumes : - name : varlog emptyDir : {} - name : config-volume configMap : name : fluentd-config \u5728\u793a\u4f8b\u914d\u7f6e\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5c07 fluentd \u66ff\u63db\u70ba\u4efb\u4f55\u65e5\u8a8c\u4ee3\u7406\uff0c\u5f9e\u61c9\u7528\u5bb9\u5668\u5167\u7684\u4efb\u4f55\u4f86\u6e90\u8b80\u53d6\u6578\u64da\u3002","title":"\u5177\u6709\u65e5\u8a8c\u4ee3\u7406\u529f\u80fd\u7684\u908a\u8eca\u5bb9\u5668"},{"location":"kubernetes/02-concepts/11-cluster-adm/logging/#_7","text":"\u5f9e\u5404\u500b\u61c9\u7528\u4e2d\u76f4\u63a5\u66b4\u9732\u548c\u63a8\u9001\u65e5\u8a8c\u6578\u64da\u7684\u96c6\u7fa4\u65e5\u8a8c\u6a5f\u5236\u5df2\u8d85\u51fa Kubernetes \u7684\u7bc4\u570d\u3002","title":"\u5f9e\u61c9\u7528\u4e2d\u76f4\u63a5\u66b4\u9732\u65e5\u8a8c\u76ee\u9304"},{"location":"kubernetes/03-tasks/debug/debug-application/","text":"\u61c9\u7528\u7a0b\u5e8f\u6545\u969c\u6392\u67e5 \u00b6 \u539f\u6587: https://kubernetes.io/docs/tasks/debug/debug-application/ \u8a72\u6587\u6a94\u5305\u542b\u4e00\u7d44\u7528\u65bc\u89e3\u6c7a\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u554f\u984c\u7684\u8cc7\u6e90\u3002\u5b83\u6db5\u84cb\u4e86\u8af8\u5982 Kubernetes \u8cc7\u6e90\uff08\u5982 Pod\u3001\u670d\u52d9\u6216 StatefulSets\uff09\u7684\u5e38\u898b\u554f\u984c\u3001\u95dc\u65bc\u7406\u89e3\u5bb9\u5668\u7d42\u6b62\u6d88\u606f\u7684\u5efa\u8b70\u4ee5\u53ca\u8abf\u8a66\u6b63\u5728\u904b\u884c\u7684\u5bb9\u5668\u7684\u65b9\u6cd5\u3002","title":"\u7c21\u4ecb"},{"location":"kubernetes/03-tasks/debug/debug-application/#_1","text":"\u539f\u6587: https://kubernetes.io/docs/tasks/debug/debug-application/ \u8a72\u6587\u6a94\u5305\u542b\u4e00\u7d44\u7528\u65bc\u89e3\u6c7a\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u554f\u984c\u7684\u8cc7\u6e90\u3002\u5b83\u6db5\u84cb\u4e86\u8af8\u5982 Kubernetes \u8cc7\u6e90\uff08\u5982 Pod\u3001\u670d\u52d9\u6216 StatefulSets\uff09\u7684\u5e38\u898b\u554f\u984c\u3001\u95dc\u65bc\u7406\u89e3\u5bb9\u5668\u7d42\u6b62\u6d88\u606f\u7684\u5efa\u8b70\u4ee5\u53ca\u8abf\u8a66\u6b63\u5728\u904b\u884c\u7684\u5bb9\u5668\u7684\u65b9\u6cd5\u3002","title":"\u61c9\u7528\u7a0b\u5e8f\u6545\u969c\u6392\u67e5"},{"location":"kubernetes/03-tasks/debug/debug-cluster/","text":"\u96c6\u7fa4\u6545\u969c\u6392\u67e5 \u00b6 \u539f\u6587: https://kubernetes.io/docs/tasks/debug/debug-cluster/ \u672c\u7bc7\u6587\u6a94\u662f\u4ecb\u7d39\u96c6\u7fa4\u6545\u969c\u6392\u67e5\u7684\uff1b\u6211\u5011\u5047\u8a2d\u5c0d\u65bc\u4f60\u78b0\u5230\u7684\u554f\u984c\uff0c\u4f60\u5df2\u7d93\u6392\u9664\u4e86\u662f\u7531\u61c9\u7528\u7a0b\u5e8f\u9020\u6210\u7684\u3002\u5c0d\u65bc\u61c9\u7528\u7684\u8abf\u8a66\uff0c\u8acb\u53c3\u95b1 \u61c9\u7528\u6545\u969c\u6392\u67e5 \u6307\u5357\u3002 \u5217\u8209\u96c6\u7fa4\u7bc0\u9ede \u00b6 \u6392\u67e5\u7684\u7b2c\u4e00\u6b65\u662f\u67e5\u770b\u6240\u6709\u7684\u7bc0\u9ede\u662f\u5426\u90fd\u5df2\u6b63\u78ba\u8a3b\u518a\u3002 \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a kubectl get nodes \u9a57\u8b49\u4f60\u6240\u5e0c\u671b\u770b\u898b\u7684\u6240\u6709\u7bc0\u9ede\u90fd\u80fd\u5920\u986f\u793a\u51fa\u4f86\uff0c\u4e26\u4e14\u90fd\u8655\u65bc Ready \u72c0\u614b\u3002 \u70ba\u4e86\u4e86\u89e3\u4f60\u7684\u96c6\u7fa4\u7684\u7e3d\u9ad4\u5065\u5eb7\u72c0\u6cc1\u8a73\u60c5\uff0c\u4f60\u53ef\u4ee5\u904b\u884c\uff1a kubectl cluster-info dump \u793a\u4f8b\uff1a\u8abf\u8a66\u95dc\u9589/\u7121\u6cd5\u8a2a\u554f\u7684\u7bc0\u9ede \u00b6 \u6709\u6642\u5728\u6392\u67e5\u6642\u67e5\u770b\u7bc0\u9ede\u7684\u72c0\u614b\u5f88\u6709\u7528 \u2014\u2014 \u4f8b\u5982\uff0c\u56e0\u70ba\u4f60\u6ce8\u610f\u5230\u5728\u7bc0\u9ede\u4e0a\u904b\u884c\u7684 Pod \u7684\u5947\u602a\u884c\u70ba\uff0c \u6216\u8005\u627e\u51fa\u70ba\u4ec0\u9ebc Pod \u4e0d\u6703\u8abf\u5ea6\u5230\u7bc0\u9ede\u4e0a\u3002\u8207 Pod \u4e00\u6a23\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl describe node \u548c kubectl get node -o yaml \u4f86\u6aa2\u7d22\u6709\u95dc\u7bc0\u9ede\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7bc0\u9ede\u95dc\u9589\uff08\u8207\u7db2\u7d61\u65b7\u958b\u9023\u63a5\uff0c\u6216\u8005 kubelet \u9032\u7a0b\u639b\u8d77\u4e26\u4e14\u4e0d\u6703\u91cd\u65b0\u555f\u52d5\u7b49\uff09\uff0c \u4f60\u5c07\u770b\u5230\u4ee5\u4e0b\u5167\u5bb9\u3002\u8acb\u6ce8\u610f\u986f\u793a\u7bc0\u9ede\u70ba NotReady \u7684\u4e8b\u4ef6\uff0c\u4e26\u8a3b\u610f Pod \u4e0d\u518d\u904b\u884c\uff08\u5b83\u5011\u5728 NotReady \u72c0\u614b\u4e94\u5206\u9418\u5f8c\u88ab\u9a45\u9010\uff09\u3002 kubectl get nodes \u7d50\u679c\u5982\u4e0b: NAME STATUS ROLES AGE VERSION kube-worker-1 NotReady <none> 1h v1.23.3 kubernetes-node-bols Ready <none> 1h v1.23.3 kubernetes-node-st6x Ready <none> 1h v1.23.3 kubernetes-node-unaj Ready <none> 1h v1.23.3 \u6392\u67e5\u7bc0\u9ede\u7684\u72c0\u614b: kubectl describe node kube-worker-1 \u7d50\u679c\u5982\u4e0b: Name: kube-worker-1 Roles: <none> Labels: beta.kubernetes.io/arch=amd64 beta.kubernetes.io/os=linux kubernetes.io/arch=amd64 kubernetes.io/hostname=kube-worker-1 kubernetes.io/os=linux Annotations: kubeadm.alpha.kubernetes.io/cri-socket: /run/containerd/containerd.sock node.alpha.kubernetes.io/ttl: 0 volumes.kubernetes.io/controller-managed-attach-detach: true CreationTimestamp: Thu, 17 Feb 2022 16:46:30 -0500 Taints: node.kubernetes.io/unreachable:NoExecute node.kubernetes.io/unreachable:NoSchedule Unschedulable: false Lease: HolderIdentity: kube-worker-1 AcquireTime: <unset> RenewTime: Thu, 17 Feb 2022 17:13:09 -0500 Conditions: Type Status LastHeartbeatTime LastTransitionTime Reason Message ---- ------ ----------------- ------------------ ------ ------- NetworkUnavailable False Thu, 17 Feb 2022 17:09:13 -0500 Thu, 17 Feb 2022 17:09:13 -0500 WeaveIsUp Weave pod has set this MemoryPressure Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. DiskPressure Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. PIDPressure Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. Ready Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. Addresses: InternalIP: 192.168.0.113 Hostname: kube-worker-1 Capacity: cpu: 2 ephemeral-storage: 15372232Ki hugepages-2Mi: 0 memory: 2025188Ki pods: 110 Allocatable: cpu: 2 ephemeral-storage: 14167048988 hugepages-2Mi: 0 memory: 1922788Ki pods: 110 System Info: Machine ID: 9384e2927f544209b5d7b67474bbf92b System UUID: aa829ca9-73d7-064d-9019-df07404ad448 Boot ID: 5a295a03-aaca-4340-af20-1327fa5dab5c Kernel Version: 5.13.0-28-generic OS Image: Ubuntu 21.10 Operating System: linux Architecture: amd64 Container Runtime Version: containerd://1.5.9 Kubelet Version: v1.23.3 Kube-Proxy Version: v1.23.3 Non-terminated Pods: (4 in total) Namespace Name CPU Requests CPU Limits Memory Requests Memory Limits Age --------- ---- ------------ ---------- --------------- ------------- --- default nginx-deployment-67d4bdd6f5-cx2nz 500m (25%) 500m (25%) 128Mi (6%) 128Mi (6%) 23m default nginx-deployment-67d4bdd6f5-w6kd7 500m (25%) 500m (25%) 128Mi (6%) 128Mi (6%) 23m kube-system kube-proxy-dnxbz 0 (0%) 0 (0%) 0 (0%) 0 (0%) 28m kube-system weave-net-gjxxp 100m (5%) 0 (0%) 200Mi (10%) 0 (0%) 28m Allocated resources: (Total limits may be over 100 percent, i.e., overcommitted.) Resource Requests Limits -------- -------- ------ cpu 1100m (55%) 1 (50%) memory 456Mi (24%) 256Mi (13%) ephemeral-storage 0 (0%) 0 (0%) hugepages-2Mi 0 (0%) 0 (0%) Events: ... \u5c07\u7bc0\u9ede\u8cc7\u8a0a\u8f49\u63db\u6210 yaml \u683c\u5f0f\u8f38\u51fa: kubectl get node kube-worker-1 -o yaml \u7d50\u679c\u5982\u4e0b: apiVersion : v1 kind : Node metadata : annotations : kubeadm.alpha.kubernetes.io/cri-socket : /run/containerd/containerd.sock node.alpha.kubernetes.io/ttl : \"0\" volumes.kubernetes.io/controller-managed-attach-detach : \"true\" creationTimestamp : \"2022-02-17T21:46:30Z\" labels : beta.kubernetes.io/arch : amd64 beta.kubernetes.io/os : linux kubernetes.io/arch : amd64 kubernetes.io/hostname : kube-worker-1 kubernetes.io/os : linux name : kube-worker-1 resourceVersion : \"4026\" uid : 98efe7cb-2978-4a0b-842a-1a7bf12c05f8 spec : {} status : addresses : - address : 192.168.0.113 type : InternalIP - address : kube-worker-1 type : Hostname allocatable : cpu : \"2\" ephemeral-storage : \"14167048988\" hugepages-2Mi : \"0\" memory : 1922788Ki pods : \"110\" capacity : cpu : \"2\" ephemeral-storage : 15372232Ki hugepages-2Mi : \"0\" memory : 2025188Ki pods : \"110\" conditions : - lastHeartbeatTime : \"2022-02-17T22:20:32Z\" lastTransitionTime : \"2022-02-17T22:20:32Z\" message : Weave pod has set this reason : WeaveIsUp status : \"False\" type : NetworkUnavailable - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:13:25Z\" message : kubelet has sufficient memory available reason : KubeletHasSufficientMemory status : \"False\" type : MemoryPressure - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:13:25Z\" message : kubelet has no disk pressure reason : KubeletHasNoDiskPressure status : \"False\" type : DiskPressure - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:13:25Z\" message : kubelet has sufficient PID available reason : KubeletHasSufficientPID status : \"False\" type : PIDPressure - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:15:15Z\" message : kubelet is posting ready status. AppArmor enabled reason : KubeletReady status : \"True\" type : Ready daemonEndpoints : kubeletEndpoint : Port : 10250 nodeInfo : architecture : amd64 bootID : 22333234-7a6b-44d4-9ce1-67e31dc7e369 containerRuntimeVersion : containerd://1.5.9 kernelVersion : 5.13.0-28-generic kubeProxyVersion : v1.23.3 kubeletVersion : v1.23.3 machineID : 9384e2927f544209b5d7b67474bbf92b operatingSystem : linux osImage : Ubuntu 21.10 systemUUID : aa829ca9-73d7-064d-9019-df07404ad448 \u67e5\u770b\u65e5\u8a8c \u00b6 \u6df1\u5165\u6316\u6398\u96c6\u7fa4\u9700\u8981\u767b\u5165\u5230\u76f8\u95dc\u6a5f\u5668\u3002\u4ee5\u4e0b\u662f\u76f8\u95dc\u65e5\u8a8c\u6587\u4ef6\u7684\u4f4d\u7f6e\u3002\u5728\u57fa\u65bc systemd \u7684\u7cfb\u7d71\u4e0a\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u4f7f\u7528 journalctl \u800c\u4e0d\u662f\u6aa2\u67e5\u65e5\u8a8c\u6587\u4ef6\u3002 \u63a7\u5236\u5e73\u9762\u7bc0\u9ede \u00b6 /var/log/kube-apiserver.log \u2014 API \u670d\u52d9\u5668\uff0c\u8ca0\u8cac\u63d0\u4f9b API \u670d\u52d9 /var/log/kube-scheduler.log \u2014 \u8abf\u5ea6\u5668\uff0c\u8ca0\u8cac\u5236\u5b9a\u8abf\u5ea6\u6c7a\u7b56 /var/log/kube-controller-manager.log \u2014 \u904b\u884c\u5927\u591a\u6578 Kubernetes \u5167\u7f6e\u63a7\u5236\u5668\u7684\u7d44\u4ef6\uff0c\u9664\u4e86\u8abf\u5ea6\uff08kube-scheduler \u8655\u7406\u8abf\u5ea6\uff09\u3002 \u5de5\u4f5c\u7bc0\u9ede \u00b6 /var/log/kubelet.log \u2014 \u4f86\u81ea kubelet \u7684\u65e5\u8a8c\uff0c\u8ca0\u8cac\u5728\u7bc0\u9ede\u904b\u884c\u5bb9\u5668 /var/log/kube-proxy.log \u2014 \u4f86\u81ea kube-proxy \u7684\u65e5\u8a8c\uff0c\u8ca0\u8cac\u5c07\u6d41\u91cf\u8f49\u767c\u5230\u670d\u52d9\u7aef\u9ede \u96c6\u7fa4\u6545\u969c\u6a21\u5f0f \u00b6 \u9019\u662f\u53ef\u80fd\u51fa\u932f\u7684\u4e8b\u60c5\u7684\u4e0d\u5b8c\u6574\u5217\u8868\uff0c\u4ee5\u53ca\u5982\u4f55\u8abf\u6574\u96c6\u7fa4\u8a2d\u7f6e\u4ee5\u7de9\u89e3\u554f\u984c\u3002 \u6545\u969c\u539f\u56e0 \u00b6 \u865b\u64ec\u6a5f\u88ab\u95dc\u9589 \u96c6\u7fa4\u5167\u6216\u96c6\u7fa4\u8207\u7528\u6236\u4e4b\u9593\u7684\u7db2\u7d61\u5206\u5340 Kubernetes \u8edf\u4ef6\u5d29\u6f70 \u6301\u4e45\u5b58\u5132\uff08\u4f8b\u5982 GCE PD \u6216 AWS EBS \u5377\uff09\u7684\u6578\u64da\u4e1f\u5931\u6216\u4e0d\u53ef\u7528 \u64cd\u4f5c\u54e1\u932f\u8aa4\uff0c\u4f8b\u5982\u914d\u7f6e\u932f\u8aa4\u7684 Kubernetes \u8edf\u4ef6\u6216\u61c9\u7528\u7a0b\u5e8f\u8edf\u4ef6 \u5177\u9ad4\u60c5\u6cc1 \u00b6 API \u670d\u52d9\u5668\u6240\u5728\u7684 VM \u95dc\u6a5f\u6216\u8005 API \u670d\u52d9\u5668\u5d29\u6f70 \u73fe\u8c61 \u4e0d\u80fd\u505c\u6b62\u3001\u66f4\u65b0\u6216\u8005\u555f\u52d5\u65b0\u7684 Pod\u3001\u670d\u52d9\u6216\u526f\u672c\u63a7\u5236\u5668 \u73fe\u6709\u7684 Pod \u548c\u670d\u52d9\u5728\u4e0d\u4f9d\u8cf4 Kubernetes API \u7684\u60c5\u6cc1\u4e0b\u61c9\u8a72\u80fd\u7e7c\u7e8c\u6b63\u5e38\u5de5\u4f5c API \u670d\u52d9\u5668\u7684\u5f8c\u7aef\u5b58\u5132\u4e1f\u5931 (ETCD) \u73fe\u8c61 kube-apiserver \u7d44\u4ef6\u672a\u80fd\u6210\u529f\u555f\u52d5\u4e26\u8b8a\u5065\u5eb7 kubelet \u5c07\u4e0d\u80fd\u8a2a\u554f API \u670d\u52d9\u5668\uff0c\u4f46\u662f\u80fd\u5920\u7e7c\u7e8c\u904b\u884c\u4e4b\u524d\u7684 Pod \u548c\u63d0\u4f9b\u76f8\u540c\u7684\u670d\u52d9\u4ee3\u7406 \u5728 API \u670d\u52d9\u5668\u91cd\u555f\u4e4b\u524d\uff0c\u9700\u8981\u624b\u52d5\u6062\u5fa9\u6216\u8005\u91cd\u5efa API \u670d\u52d9\u5668\u7684\u72c0\u614b Kubernetes \u670d\u52d9\u7d44\u4ef6\uff08\u7bc0\u9ede\u63a7\u5236\u5668\u3001\u526f\u672c\u63a7\u5236\u5668\u7ba1\u7406\u5668\u3001\u8abf\u5ea6\u5668\u7b49\uff09\u6240\u5728\u7684 VM \u95dc\u6a5f\u6216\u8005\u5d29\u6f70 \u7576\u524d\uff0c\u9019\u4e9b\u63a7\u5236\u5668\u662f\u548c API \u670d\u52d9\u5668\u5728\u4e00\u8d77\u904b\u884c\u7684\uff0c\u5b83\u5011\u4e0d\u53ef\u7528\u7684\u73fe\u8c61\u662f\u8207 API \u670d\u52d9\u5668\u985e\u4f3c\u7684 \u5c07\u4f86\uff0c\u9019\u4e9b\u63a7\u5236\u5668\u4e5f\u6703\u5fa9\u5236\u70ba\u591a\u4efd\uff0c\u4e26\u4e14\u53ef\u80fd\u4e0d\u5728\u904b\u884c\u65bc\u540c\u4e00\u7bc0\u9ede\u4e0a \u5b83\u5011\u6c92\u6709\u81ea\u5df1\u7684\u6301\u4e45\u72c0\u614b \u55ae\u500b\u7bc0\u9ede\uff08VM \u6216\u8005\u7269\u7406\u6a5f\uff09\u95dc\u6a5f \u73fe\u8c61 \u6b64\u7bc0\u9ede\u4e0a\u7684\u6240\u6709 Pod \u90fd\u505c\u6b62\u904b\u884c \u7db2\u7d61\u5206\u88c2 \u73fe\u8c61 \u5206\u5340 A \u8a8d\u70ba\u5206\u5340 B \u4e2d\u6240\u6709\u7684\u7bc0\u9ede\u90fd\u5df2\u5b95\u6a5f\uff1b\u5206\u5340 B \u8a8d\u70ba API \u670d\u52d9\u5668\u5b95\u6a5f \uff08\u5047\u5b9a\u4e3b\u63a7\u7bc0\u9ede\u6240\u5728\u7684 VM \u4f4d\u65bc\u5206\u5340 A \u5167\uff09\u3002 kubelet \u8edf\u4ef6\u6545\u969c \u73fe\u8c61 \u5d29\u6f70\u7684 kubelet \u5c31\u4e0d\u80fd\u5728\u5176\u6240\u5728\u7684\u7bc0\u9ede\u4e0a\u555f\u52d5\u65b0\u7684 Pod kubelet \u53ef\u80fd\u522a\u6389 Pod \u6216\u8005\u4e0d\u522a \u7bc0\u9ede\u88ab\u6a19\u8b58\u70ba\u975e\u5065\u5eb7\u614b \u526f\u672c\u63a7\u5236\u5668\u6703\u5728\u5176\u5b83\u7684\u7bc0\u9ede\u4e0a\u555f\u52d5\u65b0\u7684 Pod \u96c6\u7fa4\u64cd\u4f5c\u932f\u8aa4 \u73fe\u8c61 \u4e1f\u5931 Pod \u6216\u670d\u52d9\u7b49\u7b49 \u4e1f\u5931 API \u670d\u52d9\u5668\u7684\u5f8c\u7aef\u5b58\u5132 \u7528\u6236\u7121\u6cd5\u8b80\u53d6 API \u7b49\u7b49 \u7de9\u89e3\u63aa\u65bd \u00b6 \u63aa\u65bd\uff1a\u5c0d\u65bc IaaS \u4e0a\u7684 VM\uff0c\u4f7f\u7528 IaaS \u7684\u81ea\u52d5 VM \u91cd\u555f\u529f\u80fd \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668 VM \u95dc\u6a5f\u6216 API \u670d\u52d9\u5668\u5d29\u6f70 \u7de9\u89e3\uff1aKubernetes \u670d\u52d9\u7d44\u4ef6\u6240\u5728\u7684 VM \u95dc\u6a5f\u6216\u5d29\u6f70 \u63aa\u65bd: \u5c0d\u65bc\u904b\u884c API \u670d\u52d9\u5668\u548c etcd \u7684 VM\uff0c\u4f7f\u7528 IaaS \u63d0\u4f9b\u7684\u53ef\u9760\u7684\u5b58\u5132 \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668\u5f8c\u7aef\u5b58\u5132\u7684\u4e1f\u5931 \u63aa\u65bd\uff1a\u4f7f\u7528 \u9ad8\u53ef\u7528\u6027 \u7684\u914d\u7f6e \u7de9\u89e3\uff1a\u4e3b\u63a7\u7bc0\u9ede VM \u95dc\u6a5f\u6216\u8005\u4e3b\u63a7\u7bc0\u9ede\u7d44\u4ef6\uff08\u8abf\u5ea6\u5668\u3001API \u670d\u52d9\u5668\u3001\u63a7\u5236\u5668\u7ba1\u7406\u5668\uff09\u5d29\u6f70 \u5c07\u5bb9\u8a31\u4e00\u500b\u6216\u591a\u500b\u7bc0\u9ede\u6216\u7d44\u4ef6\u540c\u6642\u51fa\u73fe\u6545\u969c \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668\u5f8c\u7aef\u5b58\u5132\uff08\u4f8b\u5982 etcd \u7684\u6578\u64da\u76ee\u9304\uff09\u4e1f\u5931 \u5047\u5b9a\u4f60\u4f7f\u7528\u4e86\u9ad8\u53ef\u7528\u7684 etcd \u914d\u7f6e \u63aa\u65bd\uff1a\u5b9a\u671f\u5c0d API \u670d\u52d9\u5668\u7684 PD \u6216 EBS \u5377\u57f7\u884c\u5feb\u7167\u64cd\u4f5c \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668\u5f8c\u7aef\u5b58\u5132\u4e1f\u5931 \u7de9\u89e3\uff1a\u4e00\u4e9b\u64cd\u4f5c\u932f\u8aa4\u7684\u5834\u666f \u7de9\u89e3\uff1a\u4e00\u4e9b Kubernetes \u8edf\u4ef6\u672c\u8eab\u6545\u969c\u7684\u5834\u666f \u63aa\u65bd\uff1a\u5728 Pod \u7684\u524d\u9762\u4f7f\u7528\u526f\u672c\u63a7\u5236\u5668\u6216\u670d\u52d9 \u7de9\u89e3\uff1a\u7bc0\u9ede\u95dc\u6a5f \u7de9\u89e3\uff1akubelet \u8edf\u4ef6\u6545\u969c \u63aa\u65bd\uff1a\u61c9\u7528\uff08\u5bb9\u5668\uff09\u8a2d\u8a08\u6210\u5bb9\u8a31\u7570\u5e38\u91cd\u555f \u7de9\u89e3\uff1a\u7bc0\u9ede\u95dc\u6a5f \u7de9\u89e3\uff1akubelet \u8edf\u4ef6\u6545\u969c","title":"\u7c21\u4ecb"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_1","text":"\u539f\u6587: https://kubernetes.io/docs/tasks/debug/debug-cluster/ \u672c\u7bc7\u6587\u6a94\u662f\u4ecb\u7d39\u96c6\u7fa4\u6545\u969c\u6392\u67e5\u7684\uff1b\u6211\u5011\u5047\u8a2d\u5c0d\u65bc\u4f60\u78b0\u5230\u7684\u554f\u984c\uff0c\u4f60\u5df2\u7d93\u6392\u9664\u4e86\u662f\u7531\u61c9\u7528\u7a0b\u5e8f\u9020\u6210\u7684\u3002\u5c0d\u65bc\u61c9\u7528\u7684\u8abf\u8a66\uff0c\u8acb\u53c3\u95b1 \u61c9\u7528\u6545\u969c\u6392\u67e5 \u6307\u5357\u3002","title":"\u96c6\u7fa4\u6545\u969c\u6392\u67e5"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_2","text":"\u6392\u67e5\u7684\u7b2c\u4e00\u6b65\u662f\u67e5\u770b\u6240\u6709\u7684\u7bc0\u9ede\u662f\u5426\u90fd\u5df2\u6b63\u78ba\u8a3b\u518a\u3002 \u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a kubectl get nodes \u9a57\u8b49\u4f60\u6240\u5e0c\u671b\u770b\u898b\u7684\u6240\u6709\u7bc0\u9ede\u90fd\u80fd\u5920\u986f\u793a\u51fa\u4f86\uff0c\u4e26\u4e14\u90fd\u8655\u65bc Ready \u72c0\u614b\u3002 \u70ba\u4e86\u4e86\u89e3\u4f60\u7684\u96c6\u7fa4\u7684\u7e3d\u9ad4\u5065\u5eb7\u72c0\u6cc1\u8a73\u60c5\uff0c\u4f60\u53ef\u4ee5\u904b\u884c\uff1a kubectl cluster-info dump","title":"\u5217\u8209\u96c6\u7fa4\u7bc0\u9ede"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_3","text":"\u6709\u6642\u5728\u6392\u67e5\u6642\u67e5\u770b\u7bc0\u9ede\u7684\u72c0\u614b\u5f88\u6709\u7528 \u2014\u2014 \u4f8b\u5982\uff0c\u56e0\u70ba\u4f60\u6ce8\u610f\u5230\u5728\u7bc0\u9ede\u4e0a\u904b\u884c\u7684 Pod \u7684\u5947\u602a\u884c\u70ba\uff0c \u6216\u8005\u627e\u51fa\u70ba\u4ec0\u9ebc Pod \u4e0d\u6703\u8abf\u5ea6\u5230\u7bc0\u9ede\u4e0a\u3002\u8207 Pod \u4e00\u6a23\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl describe node \u548c kubectl get node -o yaml \u4f86\u6aa2\u7d22\u6709\u95dc\u7bc0\u9ede\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7bc0\u9ede\u95dc\u9589\uff08\u8207\u7db2\u7d61\u65b7\u958b\u9023\u63a5\uff0c\u6216\u8005 kubelet \u9032\u7a0b\u639b\u8d77\u4e26\u4e14\u4e0d\u6703\u91cd\u65b0\u555f\u52d5\u7b49\uff09\uff0c \u4f60\u5c07\u770b\u5230\u4ee5\u4e0b\u5167\u5bb9\u3002\u8acb\u6ce8\u610f\u986f\u793a\u7bc0\u9ede\u70ba NotReady \u7684\u4e8b\u4ef6\uff0c\u4e26\u8a3b\u610f Pod \u4e0d\u518d\u904b\u884c\uff08\u5b83\u5011\u5728 NotReady \u72c0\u614b\u4e94\u5206\u9418\u5f8c\u88ab\u9a45\u9010\uff09\u3002 kubectl get nodes \u7d50\u679c\u5982\u4e0b: NAME STATUS ROLES AGE VERSION kube-worker-1 NotReady <none> 1h v1.23.3 kubernetes-node-bols Ready <none> 1h v1.23.3 kubernetes-node-st6x Ready <none> 1h v1.23.3 kubernetes-node-unaj Ready <none> 1h v1.23.3 \u6392\u67e5\u7bc0\u9ede\u7684\u72c0\u614b: kubectl describe node kube-worker-1 \u7d50\u679c\u5982\u4e0b: Name: kube-worker-1 Roles: <none> Labels: beta.kubernetes.io/arch=amd64 beta.kubernetes.io/os=linux kubernetes.io/arch=amd64 kubernetes.io/hostname=kube-worker-1 kubernetes.io/os=linux Annotations: kubeadm.alpha.kubernetes.io/cri-socket: /run/containerd/containerd.sock node.alpha.kubernetes.io/ttl: 0 volumes.kubernetes.io/controller-managed-attach-detach: true CreationTimestamp: Thu, 17 Feb 2022 16:46:30 -0500 Taints: node.kubernetes.io/unreachable:NoExecute node.kubernetes.io/unreachable:NoSchedule Unschedulable: false Lease: HolderIdentity: kube-worker-1 AcquireTime: <unset> RenewTime: Thu, 17 Feb 2022 17:13:09 -0500 Conditions: Type Status LastHeartbeatTime LastTransitionTime Reason Message ---- ------ ----------------- ------------------ ------ ------- NetworkUnavailable False Thu, 17 Feb 2022 17:09:13 -0500 Thu, 17 Feb 2022 17:09:13 -0500 WeaveIsUp Weave pod has set this MemoryPressure Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. DiskPressure Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. PIDPressure Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. Ready Unknown Thu, 17 Feb 2022 17:12:40 -0500 Thu, 17 Feb 2022 17:13:52 -0500 NodeStatusUnknown Kubelet stopped posting node status. Addresses: InternalIP: 192.168.0.113 Hostname: kube-worker-1 Capacity: cpu: 2 ephemeral-storage: 15372232Ki hugepages-2Mi: 0 memory: 2025188Ki pods: 110 Allocatable: cpu: 2 ephemeral-storage: 14167048988 hugepages-2Mi: 0 memory: 1922788Ki pods: 110 System Info: Machine ID: 9384e2927f544209b5d7b67474bbf92b System UUID: aa829ca9-73d7-064d-9019-df07404ad448 Boot ID: 5a295a03-aaca-4340-af20-1327fa5dab5c Kernel Version: 5.13.0-28-generic OS Image: Ubuntu 21.10 Operating System: linux Architecture: amd64 Container Runtime Version: containerd://1.5.9 Kubelet Version: v1.23.3 Kube-Proxy Version: v1.23.3 Non-terminated Pods: (4 in total) Namespace Name CPU Requests CPU Limits Memory Requests Memory Limits Age --------- ---- ------------ ---------- --------------- ------------- --- default nginx-deployment-67d4bdd6f5-cx2nz 500m (25%) 500m (25%) 128Mi (6%) 128Mi (6%) 23m default nginx-deployment-67d4bdd6f5-w6kd7 500m (25%) 500m (25%) 128Mi (6%) 128Mi (6%) 23m kube-system kube-proxy-dnxbz 0 (0%) 0 (0%) 0 (0%) 0 (0%) 28m kube-system weave-net-gjxxp 100m (5%) 0 (0%) 200Mi (10%) 0 (0%) 28m Allocated resources: (Total limits may be over 100 percent, i.e., overcommitted.) Resource Requests Limits -------- -------- ------ cpu 1100m (55%) 1 (50%) memory 456Mi (24%) 256Mi (13%) ephemeral-storage 0 (0%) 0 (0%) hugepages-2Mi 0 (0%) 0 (0%) Events: ... \u5c07\u7bc0\u9ede\u8cc7\u8a0a\u8f49\u63db\u6210 yaml \u683c\u5f0f\u8f38\u51fa: kubectl get node kube-worker-1 -o yaml \u7d50\u679c\u5982\u4e0b: apiVersion : v1 kind : Node metadata : annotations : kubeadm.alpha.kubernetes.io/cri-socket : /run/containerd/containerd.sock node.alpha.kubernetes.io/ttl : \"0\" volumes.kubernetes.io/controller-managed-attach-detach : \"true\" creationTimestamp : \"2022-02-17T21:46:30Z\" labels : beta.kubernetes.io/arch : amd64 beta.kubernetes.io/os : linux kubernetes.io/arch : amd64 kubernetes.io/hostname : kube-worker-1 kubernetes.io/os : linux name : kube-worker-1 resourceVersion : \"4026\" uid : 98efe7cb-2978-4a0b-842a-1a7bf12c05f8 spec : {} status : addresses : - address : 192.168.0.113 type : InternalIP - address : kube-worker-1 type : Hostname allocatable : cpu : \"2\" ephemeral-storage : \"14167048988\" hugepages-2Mi : \"0\" memory : 1922788Ki pods : \"110\" capacity : cpu : \"2\" ephemeral-storage : 15372232Ki hugepages-2Mi : \"0\" memory : 2025188Ki pods : \"110\" conditions : - lastHeartbeatTime : \"2022-02-17T22:20:32Z\" lastTransitionTime : \"2022-02-17T22:20:32Z\" message : Weave pod has set this reason : WeaveIsUp status : \"False\" type : NetworkUnavailable - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:13:25Z\" message : kubelet has sufficient memory available reason : KubeletHasSufficientMemory status : \"False\" type : MemoryPressure - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:13:25Z\" message : kubelet has no disk pressure reason : KubeletHasNoDiskPressure status : \"False\" type : DiskPressure - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:13:25Z\" message : kubelet has sufficient PID available reason : KubeletHasSufficientPID status : \"False\" type : PIDPressure - lastHeartbeatTime : \"2022-02-17T22:20:15Z\" lastTransitionTime : \"2022-02-17T22:15:15Z\" message : kubelet is posting ready status. AppArmor enabled reason : KubeletReady status : \"True\" type : Ready daemonEndpoints : kubeletEndpoint : Port : 10250 nodeInfo : architecture : amd64 bootID : 22333234-7a6b-44d4-9ce1-67e31dc7e369 containerRuntimeVersion : containerd://1.5.9 kernelVersion : 5.13.0-28-generic kubeProxyVersion : v1.23.3 kubeletVersion : v1.23.3 machineID : 9384e2927f544209b5d7b67474bbf92b operatingSystem : linux osImage : Ubuntu 21.10 systemUUID : aa829ca9-73d7-064d-9019-df07404ad448","title":"\u793a\u4f8b\uff1a\u8abf\u8a66\u95dc\u9589/\u7121\u6cd5\u8a2a\u554f\u7684\u7bc0\u9ede"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_4","text":"\u6df1\u5165\u6316\u6398\u96c6\u7fa4\u9700\u8981\u767b\u5165\u5230\u76f8\u95dc\u6a5f\u5668\u3002\u4ee5\u4e0b\u662f\u76f8\u95dc\u65e5\u8a8c\u6587\u4ef6\u7684\u4f4d\u7f6e\u3002\u5728\u57fa\u65bc systemd \u7684\u7cfb\u7d71\u4e0a\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u4f7f\u7528 journalctl \u800c\u4e0d\u662f\u6aa2\u67e5\u65e5\u8a8c\u6587\u4ef6\u3002","title":"\u67e5\u770b\u65e5\u8a8c"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_5","text":"/var/log/kube-apiserver.log \u2014 API \u670d\u52d9\u5668\uff0c\u8ca0\u8cac\u63d0\u4f9b API \u670d\u52d9 /var/log/kube-scheduler.log \u2014 \u8abf\u5ea6\u5668\uff0c\u8ca0\u8cac\u5236\u5b9a\u8abf\u5ea6\u6c7a\u7b56 /var/log/kube-controller-manager.log \u2014 \u904b\u884c\u5927\u591a\u6578 Kubernetes \u5167\u7f6e\u63a7\u5236\u5668\u7684\u7d44\u4ef6\uff0c\u9664\u4e86\u8abf\u5ea6\uff08kube-scheduler \u8655\u7406\u8abf\u5ea6\uff09\u3002","title":"\u63a7\u5236\u5e73\u9762\u7bc0\u9ede"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_6","text":"/var/log/kubelet.log \u2014 \u4f86\u81ea kubelet \u7684\u65e5\u8a8c\uff0c\u8ca0\u8cac\u5728\u7bc0\u9ede\u904b\u884c\u5bb9\u5668 /var/log/kube-proxy.log \u2014 \u4f86\u81ea kube-proxy \u7684\u65e5\u8a8c\uff0c\u8ca0\u8cac\u5c07\u6d41\u91cf\u8f49\u767c\u5230\u670d\u52d9\u7aef\u9ede","title":"\u5de5\u4f5c\u7bc0\u9ede"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_7","text":"\u9019\u662f\u53ef\u80fd\u51fa\u932f\u7684\u4e8b\u60c5\u7684\u4e0d\u5b8c\u6574\u5217\u8868\uff0c\u4ee5\u53ca\u5982\u4f55\u8abf\u6574\u96c6\u7fa4\u8a2d\u7f6e\u4ee5\u7de9\u89e3\u554f\u984c\u3002","title":"\u96c6\u7fa4\u6545\u969c\u6a21\u5f0f"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_8","text":"\u865b\u64ec\u6a5f\u88ab\u95dc\u9589 \u96c6\u7fa4\u5167\u6216\u96c6\u7fa4\u8207\u7528\u6236\u4e4b\u9593\u7684\u7db2\u7d61\u5206\u5340 Kubernetes \u8edf\u4ef6\u5d29\u6f70 \u6301\u4e45\u5b58\u5132\uff08\u4f8b\u5982 GCE PD \u6216 AWS EBS \u5377\uff09\u7684\u6578\u64da\u4e1f\u5931\u6216\u4e0d\u53ef\u7528 \u64cd\u4f5c\u54e1\u932f\u8aa4\uff0c\u4f8b\u5982\u914d\u7f6e\u932f\u8aa4\u7684 Kubernetes \u8edf\u4ef6\u6216\u61c9\u7528\u7a0b\u5e8f\u8edf\u4ef6","title":"\u6545\u969c\u539f\u56e0"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_9","text":"API \u670d\u52d9\u5668\u6240\u5728\u7684 VM \u95dc\u6a5f\u6216\u8005 API \u670d\u52d9\u5668\u5d29\u6f70 \u73fe\u8c61 \u4e0d\u80fd\u505c\u6b62\u3001\u66f4\u65b0\u6216\u8005\u555f\u52d5\u65b0\u7684 Pod\u3001\u670d\u52d9\u6216\u526f\u672c\u63a7\u5236\u5668 \u73fe\u6709\u7684 Pod \u548c\u670d\u52d9\u5728\u4e0d\u4f9d\u8cf4 Kubernetes API \u7684\u60c5\u6cc1\u4e0b\u61c9\u8a72\u80fd\u7e7c\u7e8c\u6b63\u5e38\u5de5\u4f5c API \u670d\u52d9\u5668\u7684\u5f8c\u7aef\u5b58\u5132\u4e1f\u5931 (ETCD) \u73fe\u8c61 kube-apiserver \u7d44\u4ef6\u672a\u80fd\u6210\u529f\u555f\u52d5\u4e26\u8b8a\u5065\u5eb7 kubelet \u5c07\u4e0d\u80fd\u8a2a\u554f API \u670d\u52d9\u5668\uff0c\u4f46\u662f\u80fd\u5920\u7e7c\u7e8c\u904b\u884c\u4e4b\u524d\u7684 Pod \u548c\u63d0\u4f9b\u76f8\u540c\u7684\u670d\u52d9\u4ee3\u7406 \u5728 API \u670d\u52d9\u5668\u91cd\u555f\u4e4b\u524d\uff0c\u9700\u8981\u624b\u52d5\u6062\u5fa9\u6216\u8005\u91cd\u5efa API \u670d\u52d9\u5668\u7684\u72c0\u614b Kubernetes \u670d\u52d9\u7d44\u4ef6\uff08\u7bc0\u9ede\u63a7\u5236\u5668\u3001\u526f\u672c\u63a7\u5236\u5668\u7ba1\u7406\u5668\u3001\u8abf\u5ea6\u5668\u7b49\uff09\u6240\u5728\u7684 VM \u95dc\u6a5f\u6216\u8005\u5d29\u6f70 \u7576\u524d\uff0c\u9019\u4e9b\u63a7\u5236\u5668\u662f\u548c API \u670d\u52d9\u5668\u5728\u4e00\u8d77\u904b\u884c\u7684\uff0c\u5b83\u5011\u4e0d\u53ef\u7528\u7684\u73fe\u8c61\u662f\u8207 API \u670d\u52d9\u5668\u985e\u4f3c\u7684 \u5c07\u4f86\uff0c\u9019\u4e9b\u63a7\u5236\u5668\u4e5f\u6703\u5fa9\u5236\u70ba\u591a\u4efd\uff0c\u4e26\u4e14\u53ef\u80fd\u4e0d\u5728\u904b\u884c\u65bc\u540c\u4e00\u7bc0\u9ede\u4e0a \u5b83\u5011\u6c92\u6709\u81ea\u5df1\u7684\u6301\u4e45\u72c0\u614b \u55ae\u500b\u7bc0\u9ede\uff08VM \u6216\u8005\u7269\u7406\u6a5f\uff09\u95dc\u6a5f \u73fe\u8c61 \u6b64\u7bc0\u9ede\u4e0a\u7684\u6240\u6709 Pod \u90fd\u505c\u6b62\u904b\u884c \u7db2\u7d61\u5206\u88c2 \u73fe\u8c61 \u5206\u5340 A \u8a8d\u70ba\u5206\u5340 B \u4e2d\u6240\u6709\u7684\u7bc0\u9ede\u90fd\u5df2\u5b95\u6a5f\uff1b\u5206\u5340 B \u8a8d\u70ba API \u670d\u52d9\u5668\u5b95\u6a5f \uff08\u5047\u5b9a\u4e3b\u63a7\u7bc0\u9ede\u6240\u5728\u7684 VM \u4f4d\u65bc\u5206\u5340 A \u5167\uff09\u3002 kubelet \u8edf\u4ef6\u6545\u969c \u73fe\u8c61 \u5d29\u6f70\u7684 kubelet \u5c31\u4e0d\u80fd\u5728\u5176\u6240\u5728\u7684\u7bc0\u9ede\u4e0a\u555f\u52d5\u65b0\u7684 Pod kubelet \u53ef\u80fd\u522a\u6389 Pod \u6216\u8005\u4e0d\u522a \u7bc0\u9ede\u88ab\u6a19\u8b58\u70ba\u975e\u5065\u5eb7\u614b \u526f\u672c\u63a7\u5236\u5668\u6703\u5728\u5176\u5b83\u7684\u7bc0\u9ede\u4e0a\u555f\u52d5\u65b0\u7684 Pod \u96c6\u7fa4\u64cd\u4f5c\u932f\u8aa4 \u73fe\u8c61 \u4e1f\u5931 Pod \u6216\u670d\u52d9\u7b49\u7b49 \u4e1f\u5931 API \u670d\u52d9\u5668\u7684\u5f8c\u7aef\u5b58\u5132 \u7528\u6236\u7121\u6cd5\u8b80\u53d6 API \u7b49\u7b49","title":"\u5177\u9ad4\u60c5\u6cc1"},{"location":"kubernetes/03-tasks/debug/debug-cluster/#_10","text":"\u63aa\u65bd\uff1a\u5c0d\u65bc IaaS \u4e0a\u7684 VM\uff0c\u4f7f\u7528 IaaS \u7684\u81ea\u52d5 VM \u91cd\u555f\u529f\u80fd \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668 VM \u95dc\u6a5f\u6216 API \u670d\u52d9\u5668\u5d29\u6f70 \u7de9\u89e3\uff1aKubernetes \u670d\u52d9\u7d44\u4ef6\u6240\u5728\u7684 VM \u95dc\u6a5f\u6216\u5d29\u6f70 \u63aa\u65bd: \u5c0d\u65bc\u904b\u884c API \u670d\u52d9\u5668\u548c etcd \u7684 VM\uff0c\u4f7f\u7528 IaaS \u63d0\u4f9b\u7684\u53ef\u9760\u7684\u5b58\u5132 \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668\u5f8c\u7aef\u5b58\u5132\u7684\u4e1f\u5931 \u63aa\u65bd\uff1a\u4f7f\u7528 \u9ad8\u53ef\u7528\u6027 \u7684\u914d\u7f6e \u7de9\u89e3\uff1a\u4e3b\u63a7\u7bc0\u9ede VM \u95dc\u6a5f\u6216\u8005\u4e3b\u63a7\u7bc0\u9ede\u7d44\u4ef6\uff08\u8abf\u5ea6\u5668\u3001API \u670d\u52d9\u5668\u3001\u63a7\u5236\u5668\u7ba1\u7406\u5668\uff09\u5d29\u6f70 \u5c07\u5bb9\u8a31\u4e00\u500b\u6216\u591a\u500b\u7bc0\u9ede\u6216\u7d44\u4ef6\u540c\u6642\u51fa\u73fe\u6545\u969c \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668\u5f8c\u7aef\u5b58\u5132\uff08\u4f8b\u5982 etcd \u7684\u6578\u64da\u76ee\u9304\uff09\u4e1f\u5931 \u5047\u5b9a\u4f60\u4f7f\u7528\u4e86\u9ad8\u53ef\u7528\u7684 etcd \u914d\u7f6e \u63aa\u65bd\uff1a\u5b9a\u671f\u5c0d API \u670d\u52d9\u5668\u7684 PD \u6216 EBS \u5377\u57f7\u884c\u5feb\u7167\u64cd\u4f5c \u7de9\u89e3\uff1aAPI \u670d\u52d9\u5668\u5f8c\u7aef\u5b58\u5132\u4e1f\u5931 \u7de9\u89e3\uff1a\u4e00\u4e9b\u64cd\u4f5c\u932f\u8aa4\u7684\u5834\u666f \u7de9\u89e3\uff1a\u4e00\u4e9b Kubernetes \u8edf\u4ef6\u672c\u8eab\u6545\u969c\u7684\u5834\u666f \u63aa\u65bd\uff1a\u5728 Pod \u7684\u524d\u9762\u4f7f\u7528\u526f\u672c\u63a7\u5236\u5668\u6216\u670d\u52d9 \u7de9\u89e3\uff1a\u7bc0\u9ede\u95dc\u6a5f \u7de9\u89e3\uff1akubelet \u8edf\u4ef6\u6545\u969c \u63aa\u65bd\uff1a\u61c9\u7528\uff08\u5bb9\u5668\uff09\u8a2d\u8a08\u6210\u5bb9\u8a31\u7570\u5e38\u91cd\u555f \u7de9\u89e3\uff1a\u7bc0\u9ede\u95dc\u6a5f \u7de9\u89e3\uff1akubelet \u8edf\u4ef6\u6545\u969c","title":"\u7de9\u89e3\u63aa\u65bd"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/","text":"\u4f7f\u7528 Kustomize \u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u8072\u660e\u5f0f\u7ba1\u7406 \u00b6 Kustomize \u662f\u4e00\u500b\u7368\u7acb\u7684\u5de5\u5177\uff0c\u7528\u4f86\u901a\u904e kustomization \u6587\u4ef6 \u5b9a\u5236 Kubernetes \u5c0d\u8c61\u3002 \u5f9e 1.14 \u7248\u672c\u958b\u59cb\uff0ckubectl \u4e5f\u958b\u59cb\u652f\u6301\u4f7f\u7528 kustomization \u6587\u4ef6\u4f86\u7ba1\u7406 Kubernetes \u5c0d\u8c61\u3002\u8981\u67e5\u770b\u5305\u542b kustomization \u6587\u4ef6\u7684\u76ee\u9304\u4e2d\u7684\u8cc7\u6e90\uff0c\u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a kubectl kustomize <kustomization_directory> \u8981\u61c9\u7528\u9019\u4e9b\u8cc7\u6e90\uff0c\u4f7f\u7528\u53c3\u6578 --kustomize \u6216 -k \u6a19\u8a8c\u4f86\u57f7\u884c kubectl apply \uff1a kubectl apply -k <kustomization_directory> \u6e96\u5099\u958b\u59cb \u00b6 \u5b89\u88dd kubectl \u4f60\u5fc5\u9808\u64c1\u6709\u4e00\u500b Kubernetes \u7684\u96c6\u7fa4\uff0c\u540c\u6642\u4f60\u7684 Kubernetes \u96c6\u7fa4\u5fc5\u9808\u5e36\u6709 kubectl \u547d\u4ee4\u884c\u5de5\u5177\u3002\u5982\u679c\u4f60\u9084\u6c92\u6709\u96c6\u7fa4\uff0c\u4f60\u53ef\u4ee5\u901a\u904e K3D \u69cb\u5efa\u4e00\u500b\u4f60\u81ea\u5df1\u7684\u96c6\u7fa4\u3002 Kustomize \u6982\u8ff0 \u00b6 Kustomize \u662f\u4e00\u500b\u7528\u4f86\u5b9a\u5236 Kubernetes \u61c9\u7528\u914d\u7f6e\u7684\u5de5\u5177\u3002\u5b83\u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd\u7279\u6027\u4f86\u7ba1\u7406 \u61c9\u7528\u914d\u7f6e\u6587\u4ef6 \uff1a \u5f9e\u5176\u4ed6\u4f86\u6e90\u751f\u6210\u8cc7\u6e90\u7269\u4ef6 \u70ba\u8cc7\u6e90\u7269\u4ef6\u8a2d\u7f6e\u8cab\u7a7f\u6027\uff08Cross-Cutting\uff09\u5b57\u6bb5 \u7d44\u7e54\u548c\u5b9a\u5236\u8cc7\u6e90\u7269\u4ef6\u96c6\u5408 \u751f\u6210\u8d44\u6e90\u5c0d\u8c61 \u00b6 ConfigMap \u548c Secret \u5305\u542b\u5176\u4ed6 Kubernetes \u5c0d\u8c61\uff08\u5982 Pod\uff09\u6240\u9700\u8981\u7684\u914d\u7f6e\u6216\u654f\u611f\u6578\u64da\u3002 ConfigMap \u6216 Secret \u4e2d\u6578\u64da\u7684\u4f86\u6e90\u5f80\u5f80\u662f\u96c6\u7fa4\u5916\u90e8\uff0c\u4f8b\u5982\u67d0\u500b .properties \u6587\u4ef6\u6216\u8005 SSH \u5bc6\u9470\u6587\u4ef6\u3002 Kustomize \u63d0\u4f9b secretGenerator \u548c configMapGenerator \uff0c\u53ef\u4ee5\u57fa\u65bc\u6587\u4ef6\u6216\u5b57\u9762 \u503c\u4f86\u751f\u6210 Secret \u548c ConfigMap\u3002 configMapGenerator \u00b6 \u8981\u57fa\u65bc\u6587\u4ef6\u4f86\u751f\u6210 ConfigMap\uff0c\u53ef\u4ee5\u5728 configMapGenerator \u7684 files \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u4e00\u500b\u6839\u64da .properties \u6587\u4ef6\u4e2d\u7684\u6578\u64da\u689d\u76ee\u4f86\u751f\u6210 ConfigMap \u7684\u793a\u4f8b\uff1a # \u751f\u6210\u4e00\u4e2a application.properties \u6587\u4ef6 cat <<EOF >application.properties FOO=Bar EOF cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-1 files: - application.properties EOF \u6240\u751f\u6210\u7684 ConfigMap \u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u68c0\u67e5\uff1a kubectl kustomize ./ \u6240\u751f\u6210\u7684 ConfigMap \u70ba\uff1a apiVersion : v1 data : application.properties : | FOO=Bar kind : ConfigMap metadata : name : example-configmap-1-8mbdf7882g \u8981\u5f9e env \u6587\u4ef6\u751f\u6210 ConfigMap\uff0c\u8acb\u5728 configMapGenerator \u4e2d\u7684 envs \u5217\u8868\u4e2d\u6dfb\u52a0\u4e00\u500b\u689d\u76ee\u3002\u9019\u4e5f\u53ef\u4ee5\u7528\u65bc\u901a\u904e\u7701\u7565 = \u548c\u503c\u4f86\u8a2d\u7f6e\u672c\u5730\u74b0\u5883\u8b8a\u91cf\u7684\u503c\u3002 \u5efa\u8b70\u8b39\u614e\u4f7f\u7528\u672c\u5730\u74b0\u5883\u8b8a\u91cf\u586b\u5145\u529f\u80fd \u2014\u2014 \u7528\u88dc\u4e01\u8986\u84cb\u901a\u5e38\u66f4\u6613\u65bc\u7dad\u8b77\u3002\u7576\u7121\u6cd5\u8f15\u9b06\u9810\u6e2c\u8b8a\u91cf\u7684\u503c\u6642\uff0c\u5f9e\u74b0\u5883\u4e2d\u8a2d\u7f6e\u503c\u53ef\u80fd\u5f88\u6709\u7528\uff0c\u4f8b\u5982 git SHA\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u7528\u4f86\u81ea .env \u6587\u4ef6\u7684\u6578\u64da\u751f\u6210 ConfigMap \u7684\u4f8b\u5b50\uff1a # \u521b\u5efa\u4e00\u4e2a .env \u6587\u4ef6 # BAZ \u5c06\u4f7f\u7528\u672c\u5730\u73af\u5883\u53d8\u91cf $BAZ \u7684\u53d6\u503c\u586b\u5145 cat <<EOF >.env FOO=Bar BAZ EOF cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-1 envs: - .env EOF \u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u751f\u6210\u7684 ConfigMap\uff1a BAZ = Qux kubectl kustomize ./ \u751f\u6210\u7684 ConfigMap \u70ba\uff1a apiVersion : v1 data : BAZ : Qux FOO : Bar kind : ConfigMap metadata : name : example-configmap-1-892ghb99c8 Info \u8aaa\u660e\uff1a .env \u6587\u4ef6\u4e2d\u7684\u6bcf\u500b\u8b8a\u91cf\u5728\u751f\u6210\u7684 ConfigMap \u4e2d\u6210\u70ba\u4e00\u500b\u55ae\u7368\u7684\u9375\u3002\u9019\u8207\u4e4b\u524d\u7684\u793a\u4f8b\u4e0d\u540c\uff0c\u524d\u4e00\u500b\u793a\u4f8b\u5c07\u4e00\u500b\u540d\u70ba .properties \u7684\u6587\u4ef6\uff08\u53ca\u5176\u6240\u6709\u689d\u76ee\uff09\u5d4c\u5165\u5230\u540c\u4e00\u500b\u9375\u7684\u503c\u4e2d\u3002 ConfigMap \u4e5f\u53ef\u57fa\u65bc\u5b57\u9762\u7684\u9375\u503c\u5c0d\u4f86\u751f\u6210\u3002\u8981\u57fa\u65bc\u9375\u503c\u5c0d\u4f86\u751f\u6210 ConfigMap\uff0c \u5728 configMapGenerator \u7684 literals \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u4e00\u500b\u4f8b\u5b50\uff0c\u5c55\u793a \u5982\u4f55\u4f7f\u7528\u9375\u503c\u5c0d\u4e2d\u7684\u6578\u64da\u689d\u76ee\u4f86\u751f\u6210 ConfigMap \u5c0d\u8c61\uff1a cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-2 literals: - FOO=Bar EOF \u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6aa2\u67e5\u6240\u751f\u6210\u7684 ConfigMap\uff1a kubectl kustomize ./ \u6240\u751f\u6210\u7684 ConfigMap \u70ba\uff1a apiVersion : v1 data : FOO : Bar kind : ConfigMap metadata : name : example-configmap-2-g2hdhfc6tk \u8981\u5728 Deployment \u4e2d\u4f7f\u7528\u751f\u6210\u7684 ConfigMap\uff0c\u4f7f\u7528 configMapGenerator \u7684\u540d\u7a31\u5c0d\u5176\u9032\u884c\u5f15\u7528\u3002 Kustomize \u5c07\u81ea\u52d5\u4f7f\u7528\u751f\u6210\u7684\u540d\u7a31\u66ff\u63db\u8a72\u540d\u7a31\u3002 \u9019\u662f\u4f7f\u7528\u751f\u6210\u7684 ConfigMap \u7684 deployment \u793a\u4f8b\uff1a # \u5275\u5efa\u4e00\u500b application.properties \u6587\u4ef6 cat <<EOF >application.properties FOO=Bar EOF cat <<EOF >deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-app labels: app: my-app spec: selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - name: app image: my-app volumeMounts: - name: config mountPath: /config volumes: - name: config configMap: name: example-configmap-1 EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml configMapGenerator: - name: example-configmap-1 files: - application.properties EOF \u751f\u6210 ConfigMap \u548c Deployment\uff1a kubectl kustomize ./ \u751f\u6210\u7684 Deployment \u5c07\u901a\u904e\u540d\u7a31\u5f15\u7528\u751f\u6210\u7684 ConfigMap\uff1a apiVersion: v1 data: application.properties: | FOO=Bar kind: ConfigMap metadata: name: example-configmap-1-g4hk9g2ff8 --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: my-app name: my-app spec: selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - image: my-app name: app volumeMounts: - mountPath: /config name: config volumes: - configMap: name: example-configmap-1-g4hk9g2ff8 name: config secretGenerator \u00b6 \u4f60\u53ef\u4ee5\u57fa\u65bc\u6587\u4ef6\u6216\u8005\u9375\u503c\u5076\u5c0d\u4f86\u751f\u6210 Secret\u3002\u8981\u4f7f\u7528\u6587\u4ef6\u5167\u5bb9\u4f86\u751f\u6210 Secret\uff0c \u5728 secretGenerator \u4e0b\u9762\u7684 files \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u4e00\u500b\u6839\u64da\u6587\u4ef6\u4e2d\u6578\u64da\u4f86\u751f\u6210 Secret \u5c0d\u8c61\u7684\u793a\u4f8b\uff1a # \u5275\u5efa\u4e00\u500b password.txt \u6587\u4ef6 cat <<EOF >./password.txt username=admin password=secret EOF cat <<EOF >./kustomization.yaml secretGenerator: - name: example-secret-1 files: - password.txt EOF \u6240\u751f\u6210\u7684 Secret \u5982\u4e0b\uff1a apiVersion : v1 data : password.txt : dXNlcm5hbWU9YWRtaW4KcGFzc3dvcmQ9c2VjcmV0Cg== kind : Secret metadata : name : example-secret-1-t2kt65hgtb type : Opaque \u8981\u57fa\u65bc\u9375\u503c\u5076\u5c0d\u5b57\u9762\u503c\u751f\u6210 Secret\uff0c\u5148\u8981\u5728 secretGenerator \u7684 literals \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u57fa\u65bc\u9375\u503c\u5076\u5c0d\u4e2d\u6578\u64da\u689d\u76ee\u4f86\u751f\u6210 Secret \u7684\u793a\u4f8b\uff1a cat <<EOF >./kustomization.yaml secretGenerator: - name: example-secret-2 literals: - username=admin - password=secret EOF \u6240\u751f\u6210\u7684 Secret \u5982\u4e0b\uff1a apiVersion : v1 data : password : c2VjcmV0 username : YWRtaW4= kind : Secret metadata : name : example-secret-2-t52t6g96d8 type : Opaque \u8207 ConfigMaps \u4e00\u6a23\uff0c\u751f\u6210\u7684 Secrets \u53ef\u4ee5\u901a\u904e\u5f15\u7528 secretGenerator \u7684\u540d\u7a31\u5728\u90e8\u7f72\u4e2d\u4f7f\u7528\uff1a # \u5275\u5efa\u4e00\u500b password.txt \u6587\u4ef6 cat <<EOF >./password.txt username=admin password=secret EOF cat <<EOF >deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-app labels: app: my-app spec: selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - name: app image: my-app volumeMounts: - name: password mountPath: /secrets volumes: - name: password secret: secretName: example-secret-1 EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml secretGenerator: - name: example-secret-1 files: - password.txt EOF generatorOptions \u00b6 \u6240\u751f\u6210\u7684 ConfigMap \u548c Secret \u90fd\u6703\u5305\u542b\u5167\u5bb9\u54c8\u5e0c\u503c\u5f8c\u7db4\u3002\u9019\u662f\u70ba\u4e86\u78ba\u4fdd\u5167\u5bb9\u9aee\u751f\u8b8a\u5316\u6642\uff0c\u6240\u751f\u6210\u7684\u662f\u65b0\u7684 ConfigMap \u6216 Secret\u3002\u8981\u7981\u6b62\u81ea\u52d5\u6dfb\u52a0\u5f8c\u7db4\u7684\u884c\u70ba\uff0c\u7528\u6236\u53ef\u4ee5\u4f7f\u7528 generatorOptions \u3002\u9664\u6b64\u4ee5\u5916\uff0c\u70ba\u751f\u6210\u7684 ConfigMap \u548c Secret \u6307\u5b9a\u8cab\u7a7f\u6027\u9078\u9805\u4e5f\u662f\u53ef\u4ee5\u7684\u3002 cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-3 literals: - FOO=Bar generatorOptions: disableNameSuffixHash: true labels: type: generated annotations: note: generated EOF \u904b\u884c kubectl kustomize ./ \u4f86\u67e5\u770b\u6240\u751f\u6210\u7684 ConfigMap\uff1a apiVersion: v1 data: FOO: Bar kind: ConfigMap metadata: annotations: note: generated labels: type: generated name: example-configmap-3 \u8a2d\u7f6e\u8cab\u7a7f\u6027\u5b57\u6bb5 \u00b6 \u5728\u9805\u76ee\u4e2d\u70ba\u6240\u6709 Kubernetes \u5c0d\u8c61\u8a2d\u7f6e\u8cab\u7a7f\u6027\u5b57\u6bb5\u662f\u4e00\u7a2e\u5e38\u898b\u64cd\u4f5c\u3002\u8cab\u7a7f\u6027\u5b57\u6bb5\u7684\u4e00\u4e9b\u4f7f\u7528\u5834\u666f\u5982\u4e0b\uff1a \u70ba\u6240\u6709\u8cc7\u6e90\u8a2d\u7f6e\u76f8\u540c\u7684\u540d\u5b57\u7a7a\u9593 \u70ba\u6240\u6709\u5c0d\u8c61\u6dfb\u52a0\u76f8\u540c\u7684\u524d\u7db4\u6216\u5f8c\u7db4 \u70ba\u5c0d\u8c61\u6dfb\u52a0\u76f8\u540c\u7684\u6a19\u7c64\u96c6\u5408 \u70ba\u5c0d\u8c61\u6dfb\u52a0\u76f8\u540c\u7684\u8a3b\u89e3\u96c6\u5408 \u4e0b\u9762\u662f\u4e00\u500b\u4f8b\u5b50\uff1a # \u5275\u5efa\u4e00\u500b deployment.yaml cat <<EOF >./deployment.yaml apiVersion : apps/v1 kind : Deployment metadata : name : nginx-deployment labels : app : nginx spec : selector : matchLabels : app : nginx template : metadata : labels : app : nginx spec : containers : - name : nginx image : nginx EOF cat <<EOF >./kustomization.yaml namespace : my-namespace namePrefix : dev- nameSuffix : \"-001\" commonLabels : app : bingo commonAnnotations : oncallPager : 800-555-1212 resources : - deployment.yaml EOF \u57f7\u884c kubectl kustomize ./ \u67e5\u770b\u9019\u4e9b\u5b57\u6bb5\u90fd\u88ab\u8a2d\u7f6e\u5230 Deployment \u8cc7\u6e90\u4e0a\uff1a apiVersion : apps/v1 kind : Deployment metadata : annotations : oncallPager : 800-555-1212 labels : app : bingo name : dev-nginx-deployment-001 namespace : my-namespace spec : selector : matchLabels : app : bingo template : metadata : annotations : oncallPager : 800-555-1212 labels : app : bingo spec : containers : - image : nginx name : nginx \u7d44\u7e54\u548c\u5b9a\u5236\u8cc7\u6e90 \u00b6 \u4e00\u7a2e\u5e38\u898b\u7684\u505a\u6cd5\u662f\u5728\u9805\u76ee\u4e2d\u69cb\u9020\u8cc7\u6e90\u96c6\u5408\u4f75\u5c07\u5176\u653e\u5230\u540c\u4e00\u500b\u6587\u4ef6\u6216\u76ee\u9304\u4e2d\u7ba1\u7406\u3002 Kustomize \u63d0\u4f9b\u57fa\u65bc\u4e0d\u540c\u6587\u4ef6\u4f86\u7d44\u7e54\u8cc7\u6e90\u4e26\u5411\u5176\u61c9\u7528\u88dc\u4e01\u6216\u8005\u5176\u4ed6\u5b9a\u5236\u7684\u80fd\u529b\u3002 \u7d44\u7e54 \u00b6 Kustomize \u652f\u6301\u7d44\u5408\u4e0d\u540c\u7684\u8cc7\u6e90\u3002 kustomization.yaml \u6587\u4ef6\u7684 resources \u5b57\u6bb5 \u5b9a\u7fa9\u914d\u7f6e\u4e2d\u8981\u5305\u542b\u7684\u8cc7\u6e90\u5217\u8868\u3002\u4f60\u53ef\u4ee5\u5c07 resources \u5217\u8868\u4e2d\u7684\u8def\u5f91\u8a2d\u7f6e\u70ba\u8cc7\u6e90\u914d\u7f6e\u6587\u4ef6 \u7684\u8def\u5f91\u3002\u4e0b\u9762\u662f\u7531 Deployment \u548c Service \u69cb\u6210\u7684 NGINX \u61c9\u7528\u7684\u793a\u4f8b\uff1a # \u5275\u5efa deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u5275\u5efa service.yaml \u6587\u4ef6 cat <<EOF > service.yaml apiVersion: v1 kind: Service metadata: name: my-nginx labels: run: my-nginx spec: ports: - port: 80 protocol: TCP selector: run: my-nginx EOF # \u5275\u5efa kustomization.yaml \u4f86\u7d44\u7e54\u4ee5\u4e0a\u5169\u500b\u8cc7\u6e90 cat <<EOF >./kustomization.yaml resources: - deployment.yaml - service.yaml EOF kubectl kustomize ./ \u6240\u5f97\u5230\u7684\u8cc7\u6e90\u4e2d\u65e2\u5305\u542b Deployment \u4e5f\u5305\u542b Service \u5c0d\u8c61\u3002 \u5b9a\u5236 \u00b6 \u88dc\u4e01\u6587\u4ef6\uff08Patches\uff09\u53ef\u4ee5\u7528\u4f86\u5c0d\u8cc7\u6e90\u57f7\u884c\u4e0d\u540c\u7684\u5b9a\u5236\u3002 Kustomize \u901a\u904e patchesStrategicMerge \u548c patchesJson6902 \u652f\u6301\u4e0d\u540c\u7684\u6253\u88dc\u4e01 \u6a5f\u5236\u3002 patchesStrategicMerge \u7684\u5167\u5bb9\u662f\u4e00\u500b\u6587\u4ef6\u8def\u5f91\u7684\u5217\u8868\uff0c\u5176\u4e2d\u6bcf\u500b\u6587\u4ef6\u90fd\u61c9\u53ef\u89e3\u6790\u70ba \u7b56\u7565\u6027\u5408\u4f75\u88dc\u4e01\uff08Strategic Merge Patch\uff09 \u3002\u88dc\u4e01\u6587\u4ef6\u4e2d\u7684\u540d\u7a31\u5fc5\u9808\u8207\u5df2\u7d93\u52a0\u8f09\u7684\u8cc7\u6e90\u7684\u540d\u7a31\u5339\u914d\u3002\u5efa\u8b70\u69cb\u9020\u898f\u6a21\u8f03\u5c0f\u7684\u3001\u50c5\u505a\u4e00\u4ef6\u4e8b\u60c5\u7684\u88dc\u4e01\u3002\u4f8b\u5982\uff0c\u69cb\u9020\u4e00\u500b\u88dc\u4e01\u4f86\u589e\u52a0 Deployment \u7684\u526f\u672c\u500b\u6578\uff1b\u69cb\u9020\u53e6\u5916\u4e00\u500b\u88dc\u4e01\u4f86\u8a2d\u7f6e\u5167\u5b58\u9650\u5236\u3002 # \u5275\u5efa deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u751f\u6210\u4e00\u500b\u88dc\u4e01 increase_replicas.yaml cat <<EOF > increase_replicas.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: replicas: 3 EOF # \u751f\u6210\u53e6\u4e00\u500b\u88dc\u4e01 set_memory.yaml cat <<EOF > set_memory.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: template: spec: containers: - name: my-nginx resources: limits: memory: 512Mi EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml patchesStrategicMerge: - increase_replicas.yaml - set_memory.yaml EOF \u57f7\u884c kubectl kustomize ./ \u4f86\u67e5\u770b Deployment\uff1a apiVersion : apps/v1 kind : Deployment metadata : name : my-nginx spec : replicas : 3 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - image : nginx name : my-nginx ports : - containerPort : 80 resources : limits : memory : 512Mi \u4e26\u975e\u6240\u6709\u8cc7\u6e90\u6216\u8005\u5b57\u6bb5\u90fd\u652f\u6301\u7b56\u7565\u6027\u5408\u4f75\u88dc\u4e01\u3002\u70ba\u4e86\u652f\u6301\u5c0d\u4efb\u4f55\u8cc7\u6e90\u7684\u4efb\u4f55\u5b57\u6bb5\u9032\u884c\u4fee\u6539\uff0c Kustomize \u63d0\u4f9b\u901a\u904e patchesJson6902 \u4f86\u61c9\u7528 JSON \u88dc\u4e01 \u7684\u80fd\u529b\u3002\u70ba\u4e86\u7d66 JSON \u88dc\u4e01\u627e\u5230\u6b63\u78ba\u7684\u8cc7\u6e90\uff0c\u9700\u8981\u5728 kustomization.yaml \u6587\u4ef6\u4e2d\u6307\u5b9a\u8cc7\u6e90\u7684 \u7d44\uff08group\uff09\u3001\u7248\u672c\uff08version\uff09\u3001\u985e\u5225\uff08kind\uff09\u548c\u540d\u7a31\uff08name\uff09\u3002\u4f8b\u5982\uff0c\u70ba\u67d0 Deployment \u5c0d\u8c61\u589e\u52a0\u526f\u672c\u500b\u6578\u7684\u64cd\u4f5c\u4e5f\u53ef\u4ee5\u901a\u904e patchesJson6902 \u4f86\u5b8c\u6210\uff1a # \u5275\u5efa\u4e00\u500b deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u5275\u5efa\u4e00\u500b JSON \u88dc\u4e01\u6587\u4ef6 cat <<EOF > patch.yaml - op: replace path: /spec/replicas value: 3 EOF # \u5275\u5efa\u4e00\u500b kustomization.yaml cat <<EOF >./kustomization.yaml resources: - deployment.yaml patchesJson6902: - target: group: apps version: v1 kind: Deployment name: my-nginx path: patch.yaml EOF \u57f7\u884c kubectl kustomize ./ \u4ee5\u67e5\u770b replicas \u5b57\u6bb5\u88ab\u66f4\u65b0\uff1a apiVersion : apps/v1 kind : Deployment metadata : name : my-nginx spec : replicas : 3 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - image : nginx name : my-nginx ports : - containerPort : 80 \u9664\u4e86\u88dc\u4e01\u4e4b\u5916\uff0cKustomize \u9084\u63d0\u4f9b\u5b9a\u5236\u5bb9\u5668\u93e1\u50cf\u6216\u8005\u5c07\u5176\u4ed6\u5c0d\u8c61\u7684\u5b57\u6bb5\u503c\u6ce8\u5165\u5230\u5bb9\u5668 \u4e2d\u7684\u80fd\u529b\uff0c\u4e26\u4e14\u4e0d\u9700\u8981\u5275\u5efa\u88dc\u4e01\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u901a\u904e\u5728 kustomization.yaml \u6587\u4ef6\u7684 images \u5b57\u6bb5\u8a2d\u7f6e\u65b0\u7684\u93e1\u50cf\u4f86 \u66f4\u6539\u5bb9\u5668\u4e2d\u4f7f\u7528\u7684\u93e1\u50cf\u3002 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml images: - name: nginx newName: my.image.registry/nginx newTag: 1.4.0 EOF \u57f7\u884c kubectl kustomize ./ \u4ee5\u67e5\u770b\u6240\u4f7f\u7528\u7684\u93e1\u50cf\u5df2\u88ab\u66f4\u65b0\uff1a apiVersion : apps/v1 kind : Deployment metadata : name : my-nginx spec : replicas : 2 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - image : my.image.registry/nginx:1.4.0 name : my-nginx ports : - containerPort : 80 \u6709\u4e9b\u6642\u5019\uff0cPod \u4e2d\u904b\u884c\u7684\u61c9\u7528\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u4f86\u81ea\u5176\u4ed6\u5c0d\u8c61\u7684\u914d\u7f6e\u503c\u3002\u4f8b\u5982\uff0c\u67d0 Deployment \u5c0d\u8c61\u7684 Pod \u9700\u8981\u5f9e\u74b0\u5883\u8b8a\u91cf\u6216\u547d\u4ee4\u884c\u53c3\u6578\u4e2d\u8b80\u53d6\u8b80\u53d6 Service \u7684\u540d\u7a31\u3002\u7531\u65bc\u5728 kustomization.yaml \u6587\u4ef6\u4e2d\u6dfb\u52a0 namePrefix \u6216 nameSuffix \u6642 Service \u540d\u7a31\u53ef\u80fd\u767c\u751f\u8b8a\u5316\uff0c\u5efa\u8b70\u4e0d\u8981\u5728\u547d\u4ee4\u53c3\u6578\u4e2d\u786c\u7de8\u78bc Service \u540d\u7a31\u3002\u5c0d\u65bc\u9019\u7a2e\u4f7f\u7528\u5834\u666f\uff0cKustomize \u53ef\u4ee5\u901a\u904e vars \u5c07 Service \u540d\u7a31\u6ce8\u5165\u5230\u5bb9\u5668\u4e2d\u3002 # \u5275\u5efa\u4e00\u500b deployment.yaml \u6587\u4ef6\uff08\u5f15\u7528\u6b64\u8655\u7684\u6587\u6a94\u5206\u9694\u7b26\uff09 cat <<'EOF' > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx command: [\"start\", \"--host\", \"$(MY_SERVICE_NAME)\"] EOF # \u5275\u5efa\u4e00\u500b service.yaml \u6587\u4ef6 cat <<EOF > service.yaml apiVersion: v1 kind: Service metadata: name: my-nginx labels: run: my-nginx spec: ports: - port: 80 protocol: TCP selector: run: my-nginx EOF cat <<EOF >./kustomization.yaml namePrefix: dev- nameSuffix: \"-001\" resources: - deployment.yaml - service.yaml vars: - name: MY_SERVICE_NAME objref: kind: Service name: my-nginx apiVersion: v1 EOF \u57f7\u884c kubectl kustomize ./ \u4ee5\u67e5\u770b\u6ce8\u5165\u5230\u5bb9\u5668\u4e2d\u7684 Service \u540d\u7a31\u662f dev-my-nginx-001 \uff1a apiVersion : apps/v1 kind : Deployment metadata : name : dev-my-nginx-001 spec : replicas : 2 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - command : - start - --host - dev-my-nginx-001 image : nginx name : my-nginx \u57fa\u6e96 (Bases) \u8207\u8986\u84cb (Overlays) \u00b6 Kustomize \u4e2d\u6709 \u57fa\u6e96\uff08bases\uff09 \u548c \u8986\u84cb\uff08overlays\uff09 \u7684\u6982\u5ff5\u5340\u5206\u3002\u57fa\u6e96 \u662f\u5305\u542b kustomization.yaml \u6587\u4ef6\u7684\u4e00\u500b\u76ee\u9304\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u7d44\u8cc7\u6e90\u53ca\u5176\u76f8\u95dc\u7684\u5b9a\u5236\u3002\u57fa\u6e96\u53ef\u4ee5\u662f\u672c\u5730\u76ee\u9304\u6216\u8005\u4f86\u81ea\u9060\u7a0b\u5009\u5eab\u7684\u76ee\u9304\uff0c\u53ea\u8981\u5176\u4e2d\u5b58\u5728 kustomization.yaml \u6587\u4ef6\u5373\u53ef\u3002 \u8986\u84cb \u4e5f\u662f\u4e00\u500b\u76ee\u9304\uff0c\u5176\u4e2d\u5305\u542b\u5c07\u5176\u4ed6 kustomization \u76ee\u9304\u7576\u505a bases \u4f86\u5f15\u7528\u7684 kustomization.yaml \u6587\u4ef6\u3002\u57fa\u6e96\u4e0d\u4e86\u89e3\u8986\u84cb\u7684\u5b58\u5728\uff0c\u4e14\u53ef\u88ab\u591a\u500b\u8986\u84cb\u6240\u4f7f\u7528\u3002\u8986\u84cb\u5247\u53ef\u4ee5\u6709\u591a\u500b\u57fa\u6e96\uff0c\u4e14\u53ef\u91dd\u5c0d\u6240\u6709\u57fa\u6e96\u4e2d\u7684\u8cc7\u6e90\u57f7\u884c\u7d44\u7e54\u64cd\u4f5c\uff0c\u9084\u53ef\u4ee5\u5728\u5176\u4e0a\u57f7\u884c\u5b9a\u5236\u3002 # \u5275\u5efa\u4e00\u500b\u5305\u542b\u57fa\u6e96\u7684\u76ee\u9304 mkdir base # \u5275\u5efa base/deployment.yaml cat <<EOF > base/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx EOF # \u5275\u5efa base/service.yaml \u6587\u4ef6 cat <<EOF > base/service.yaml apiVersion: v1 kind: Service metadata: name: my-nginx labels: run: my-nginx spec: ports: - port: 80 protocol: TCP selector: run: my-nginx EOF # \u5275\u5efa base/kustomization.yaml cat <<EOF > base/kustomization.yaml resources: - deployment.yaml - service.yaml EOF \u6b64\u57fa\u6e96\u53ef\u5728\u591a\u500b\u8986\u84cb\u4e2d\u4f7f\u7528\u3002\u4f60\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u8986\u84cb\u4e2d\u6dfb\u52a0\u4e0d\u540c\u7684 namePrefix \u6216 \u5176\u4ed6\u8cab\u7a7f\u6027\u5b57\u6bb5\u3002\u4e0b\u9762\u662f\u5169\u500b\u4f7f\u7528\u540c\u4e00\u57fa\u6e96\u7684\u8986\u84cb\uff1a mkdir dev cat <<EOF > dev/kustomization.yaml bases: - ../base namePrefix: dev- EOF mkdir prod cat <<EOF > prod/kustomization.yaml bases: - ../base namePrefix: prod- EOF \u5982\u4f55\u4f7f\u7528 Kustomize \u6765\u5e94\u7528\u3001\u67e5\u770b\u548c\u5220\u9664\u5bf9\u8c61 \u00b6 \u5728 kubectl \u547d\u4ee4\u4e2d\u4f7f\u7528 --kustomize \u6216 -k \u53c3\u6578\u4f86\u8b58\u5225\u88ab kustomization.yaml \u6240\u7ba1\u7406\u7684\u8cc7\u6e90\u3002\u6ce8\u610f -k \u8981\u6307\u5411\u4e00\u500b kustomization \u76ee\u9304\u3002\u4f8b\u5982\uff1a kubectl apply -k <kustomization \u76ee\u9304>/ \u5047\u5b9a\u4f7f\u7528\u4e0b\u9762\u7684 kustomization.yaml \uff0c # \u5275\u5efa deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u5275\u5efa kustomization.yaml cat <<EOF >./kustomization.yaml namePrefix: dev- commonLabels: app: my-nginx resources: - deployment.yaml EOF \u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4f86\u61c9\u7528 Deployment \u5c0d\u8c61 dev-my-nginx\uff1a kubectl apply -k ./ \u547d\u4ee4\u57f7\u884c\u7d50\u679c: deployment.apps/dev-my-nginx created \u904b\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4e4b\u4e00\u4f86\u67e5\u770b Deployment \u5c0d\u8c61 dev-my-nginx\uff1a kubectl get -k ./ \u547d\u4ee4\u57f7\u884c\u7d50\u679c: NAME READY UP-TO-DATE AVAILABLE AGE dev-my-nginx 2/2 2 2 75s kubectl describe -k ./ \u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4f86\u6bd4\u8f03 Deployment \u5c0d\u8c61 dev-my-nginx \u8207\u6e05\u55ae\u88ab\u61c9\u7528\u4e4b\u5f8c \u96c6\u7fa4\u5c07\u8655\u65bc\u7684\u72c0\u614b\uff1a kubectl diff -k ./ \u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u522a\u9664 Deployment \u5c0d\u8c61 dev-my-nginx\uff1a kubectl delete -k ./ \u547d\u4ee4\u57f7\u884c\u7d50\u679c: deployment.apps \"dev-my-nginx\" deleted Kustomize \u529f\u80fd\u7279\u6027\u5217\u8868 \u00b6 \u5b57\u6bb5 \u985e\u578b \u89e3\u91cb namespace string \u70ba\u6240\u6709\u8cc7\u6e90\u6dfb\u52a0\u540d\u5b57\u7a7a\u9593 namePrefix string \u6b64\u5b57\u6bb5\u7684\u503c\u5c07\u88ab\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u540d\u7a31\u524d\u9762 nameSuffix string \u6b64\u5b57\u6bb5\u7684\u503c\u5c07\u88ab\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u540d\u7a31\u5f8c\u9762 commonLabels map[string]string \u8981\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u548c\u9078\u64c7\u7b97\u7b26\u7684\u6a19\u7c64 commonAnnotations map[string]string \u8981\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u7684\u8a3b\u89e3 resources []string \u5217\u8868\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u90fd\u5fc5\u9808\u80fd\u5920\u89e3\u6790\u70ba\u73fe\u6709\u7684\u8cc7\u6e90\u914d\u7f6e\u6587\u4ef6 configMapGenerator []ConfigMapArgs \u5217\u8868\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u90fd\u6703\u751f\u6210\u4e00\u500b ConfigMap secretGenerator []SecretArgs \u5217\u8868\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u90fd\u6703\u751f\u6210\u4e00\u500b Secret generatorOptions GeneratorOptions \u66f4\u6539\u6240\u6709 ConfigMap \u548c Secret \u751f\u6210\u5668\u7684\u884c\u70ba bases []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u61c9\u80fd\u89e3\u6790\u70ba\u4e00\u500b\u5305\u542b kustomization.yaml \u6587\u4ef6\u7684\u76ee\u9304 patchesStrategicMerge []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u80fd\u89e3\u6790\u70ba\u67d0 Kubernetes \u5c0d\u8c61\u7684\u7b56\u7565\u6027\u5408\u4f75\u88dc\u4e01 patchesJson6902 []Patch \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u80fd\u89e3\u6790\u70ba\u4e00\u500b Kubernetes \u5c0d\u8c61\u548c\u4e00\u500b JSON \u88dc\u4e01 vars []Var \u6bcf\u500b\u689d\u76ee\u7528\u4f86\u5f9e\u67d0\u8cc7\u6e90\u7684\u5b57\u6bb5\u4f86\u6790\u53d6\u6587\u5b57 images []Image \u6bcf\u500b\u689d\u76ee\u90fd\u7528\u4f86\u66f4\u6539\u93e1\u50cf\u7684\u540d\u7a31\u3001\u6a19\u8a18\u8207/\u6216\u6458\u8981\uff0c\u4e0d\u5fc5\u751f\u6210\u88dc\u4e01 configurations []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u61c9\u80fd\u89e3\u6790\u70ba\u4e00\u500b\u5305\u542b Kustomize \u8f49\u63db\u5668\u914d\u7f6e \u7684\u6587\u4ef6 crds []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u61c9\u80fd\u5920\u89e3\u6790\u70ba Kubernetes \u985e\u5225\u7684 OpenAPI \u5b9a\u7fa9\u6587\u4ef6","title":"\u4f7f\u7528 Kustomize \u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u8072\u660e\u5f0f\u7ba1\u7406"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#kustomize-kubernetes","text":"Kustomize \u662f\u4e00\u500b\u7368\u7acb\u7684\u5de5\u5177\uff0c\u7528\u4f86\u901a\u904e kustomization \u6587\u4ef6 \u5b9a\u5236 Kubernetes \u5c0d\u8c61\u3002 \u5f9e 1.14 \u7248\u672c\u958b\u59cb\uff0ckubectl \u4e5f\u958b\u59cb\u652f\u6301\u4f7f\u7528 kustomization \u6587\u4ef6\u4f86\u7ba1\u7406 Kubernetes \u5c0d\u8c61\u3002\u8981\u67e5\u770b\u5305\u542b kustomization \u6587\u4ef6\u7684\u76ee\u9304\u4e2d\u7684\u8cc7\u6e90\uff0c\u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\uff1a kubectl kustomize <kustomization_directory> \u8981\u61c9\u7528\u9019\u4e9b\u8cc7\u6e90\uff0c\u4f7f\u7528\u53c3\u6578 --kustomize \u6216 -k \u6a19\u8a8c\u4f86\u57f7\u884c kubectl apply \uff1a kubectl apply -k <kustomization_directory>","title":"\u4f7f\u7528 Kustomize \u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u8072\u660e\u5f0f\u7ba1\u7406"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#_1","text":"\u5b89\u88dd kubectl \u4f60\u5fc5\u9808\u64c1\u6709\u4e00\u500b Kubernetes \u7684\u96c6\u7fa4\uff0c\u540c\u6642\u4f60\u7684 Kubernetes \u96c6\u7fa4\u5fc5\u9808\u5e36\u6709 kubectl \u547d\u4ee4\u884c\u5de5\u5177\u3002\u5982\u679c\u4f60\u9084\u6c92\u6709\u96c6\u7fa4\uff0c\u4f60\u53ef\u4ee5\u901a\u904e K3D \u69cb\u5efa\u4e00\u500b\u4f60\u81ea\u5df1\u7684\u96c6\u7fa4\u3002","title":"\u6e96\u5099\u958b\u59cb"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#kustomize","text":"Kustomize \u662f\u4e00\u500b\u7528\u4f86\u5b9a\u5236 Kubernetes \u61c9\u7528\u914d\u7f6e\u7684\u5de5\u5177\u3002\u5b83\u63d0\u4f9b\u4ee5\u4e0b\u529f\u80fd\u7279\u6027\u4f86\u7ba1\u7406 \u61c9\u7528\u914d\u7f6e\u6587\u4ef6 \uff1a \u5f9e\u5176\u4ed6\u4f86\u6e90\u751f\u6210\u8cc7\u6e90\u7269\u4ef6 \u70ba\u8cc7\u6e90\u7269\u4ef6\u8a2d\u7f6e\u8cab\u7a7f\u6027\uff08Cross-Cutting\uff09\u5b57\u6bb5 \u7d44\u7e54\u548c\u5b9a\u5236\u8cc7\u6e90\u7269\u4ef6\u96c6\u5408","title":"Kustomize \u6982\u8ff0"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#_2","text":"ConfigMap \u548c Secret \u5305\u542b\u5176\u4ed6 Kubernetes \u5c0d\u8c61\uff08\u5982 Pod\uff09\u6240\u9700\u8981\u7684\u914d\u7f6e\u6216\u654f\u611f\u6578\u64da\u3002 ConfigMap \u6216 Secret \u4e2d\u6578\u64da\u7684\u4f86\u6e90\u5f80\u5f80\u662f\u96c6\u7fa4\u5916\u90e8\uff0c\u4f8b\u5982\u67d0\u500b .properties \u6587\u4ef6\u6216\u8005 SSH \u5bc6\u9470\u6587\u4ef6\u3002 Kustomize \u63d0\u4f9b secretGenerator \u548c configMapGenerator \uff0c\u53ef\u4ee5\u57fa\u65bc\u6587\u4ef6\u6216\u5b57\u9762 \u503c\u4f86\u751f\u6210 Secret \u548c ConfigMap\u3002","title":"\u751f\u6210\u8d44\u6e90\u5c0d\u8c61"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#configmapgenerator","text":"\u8981\u57fa\u65bc\u6587\u4ef6\u4f86\u751f\u6210 ConfigMap\uff0c\u53ef\u4ee5\u5728 configMapGenerator \u7684 files \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u4e00\u500b\u6839\u64da .properties \u6587\u4ef6\u4e2d\u7684\u6578\u64da\u689d\u76ee\u4f86\u751f\u6210 ConfigMap \u7684\u793a\u4f8b\uff1a # \u751f\u6210\u4e00\u4e2a application.properties \u6587\u4ef6 cat <<EOF >application.properties FOO=Bar EOF cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-1 files: - application.properties EOF \u6240\u751f\u6210\u7684 ConfigMap \u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6765\u68c0\u67e5\uff1a kubectl kustomize ./ \u6240\u751f\u6210\u7684 ConfigMap \u70ba\uff1a apiVersion : v1 data : application.properties : | FOO=Bar kind : ConfigMap metadata : name : example-configmap-1-8mbdf7882g \u8981\u5f9e env \u6587\u4ef6\u751f\u6210 ConfigMap\uff0c\u8acb\u5728 configMapGenerator \u4e2d\u7684 envs \u5217\u8868\u4e2d\u6dfb\u52a0\u4e00\u500b\u689d\u76ee\u3002\u9019\u4e5f\u53ef\u4ee5\u7528\u65bc\u901a\u904e\u7701\u7565 = \u548c\u503c\u4f86\u8a2d\u7f6e\u672c\u5730\u74b0\u5883\u8b8a\u91cf\u7684\u503c\u3002 \u5efa\u8b70\u8b39\u614e\u4f7f\u7528\u672c\u5730\u74b0\u5883\u8b8a\u91cf\u586b\u5145\u529f\u80fd \u2014\u2014 \u7528\u88dc\u4e01\u8986\u84cb\u901a\u5e38\u66f4\u6613\u65bc\u7dad\u8b77\u3002\u7576\u7121\u6cd5\u8f15\u9b06\u9810\u6e2c\u8b8a\u91cf\u7684\u503c\u6642\uff0c\u5f9e\u74b0\u5883\u4e2d\u8a2d\u7f6e\u503c\u53ef\u80fd\u5f88\u6709\u7528\uff0c\u4f8b\u5982 git SHA\u3002 \u4e0b\u9762\u662f\u4e00\u500b\u7528\u4f86\u81ea .env \u6587\u4ef6\u7684\u6578\u64da\u751f\u6210 ConfigMap \u7684\u4f8b\u5b50\uff1a # \u521b\u5efa\u4e00\u4e2a .env \u6587\u4ef6 # BAZ \u5c06\u4f7f\u7528\u672c\u5730\u73af\u5883\u53d8\u91cf $BAZ \u7684\u53d6\u503c\u586b\u5145 cat <<EOF >.env FOO=Bar BAZ EOF cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-1 envs: - .env EOF \u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u751f\u6210\u7684 ConfigMap\uff1a BAZ = Qux kubectl kustomize ./ \u751f\u6210\u7684 ConfigMap \u70ba\uff1a apiVersion : v1 data : BAZ : Qux FOO : Bar kind : ConfigMap metadata : name : example-configmap-1-892ghb99c8 Info \u8aaa\u660e\uff1a .env \u6587\u4ef6\u4e2d\u7684\u6bcf\u500b\u8b8a\u91cf\u5728\u751f\u6210\u7684 ConfigMap \u4e2d\u6210\u70ba\u4e00\u500b\u55ae\u7368\u7684\u9375\u3002\u9019\u8207\u4e4b\u524d\u7684\u793a\u4f8b\u4e0d\u540c\uff0c\u524d\u4e00\u500b\u793a\u4f8b\u5c07\u4e00\u500b\u540d\u70ba .properties \u7684\u6587\u4ef6\uff08\u53ca\u5176\u6240\u6709\u689d\u76ee\uff09\u5d4c\u5165\u5230\u540c\u4e00\u500b\u9375\u7684\u503c\u4e2d\u3002 ConfigMap \u4e5f\u53ef\u57fa\u65bc\u5b57\u9762\u7684\u9375\u503c\u5c0d\u4f86\u751f\u6210\u3002\u8981\u57fa\u65bc\u9375\u503c\u5c0d\u4f86\u751f\u6210 ConfigMap\uff0c \u5728 configMapGenerator \u7684 literals \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u4e00\u500b\u4f8b\u5b50\uff0c\u5c55\u793a \u5982\u4f55\u4f7f\u7528\u9375\u503c\u5c0d\u4e2d\u7684\u6578\u64da\u689d\u76ee\u4f86\u751f\u6210 ConfigMap \u5c0d\u8c61\uff1a cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-2 literals: - FOO=Bar EOF \u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u6aa2\u67e5\u6240\u751f\u6210\u7684 ConfigMap\uff1a kubectl kustomize ./ \u6240\u751f\u6210\u7684 ConfigMap \u70ba\uff1a apiVersion : v1 data : FOO : Bar kind : ConfigMap metadata : name : example-configmap-2-g2hdhfc6tk \u8981\u5728 Deployment \u4e2d\u4f7f\u7528\u751f\u6210\u7684 ConfigMap\uff0c\u4f7f\u7528 configMapGenerator \u7684\u540d\u7a31\u5c0d\u5176\u9032\u884c\u5f15\u7528\u3002 Kustomize \u5c07\u81ea\u52d5\u4f7f\u7528\u751f\u6210\u7684\u540d\u7a31\u66ff\u63db\u8a72\u540d\u7a31\u3002 \u9019\u662f\u4f7f\u7528\u751f\u6210\u7684 ConfigMap \u7684 deployment \u793a\u4f8b\uff1a # \u5275\u5efa\u4e00\u500b application.properties \u6587\u4ef6 cat <<EOF >application.properties FOO=Bar EOF cat <<EOF >deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-app labels: app: my-app spec: selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - name: app image: my-app volumeMounts: - name: config mountPath: /config volumes: - name: config configMap: name: example-configmap-1 EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml configMapGenerator: - name: example-configmap-1 files: - application.properties EOF \u751f\u6210 ConfigMap \u548c Deployment\uff1a kubectl kustomize ./ \u751f\u6210\u7684 Deployment \u5c07\u901a\u904e\u540d\u7a31\u5f15\u7528\u751f\u6210\u7684 ConfigMap\uff1a apiVersion: v1 data: application.properties: | FOO=Bar kind: ConfigMap metadata: name: example-configmap-1-g4hk9g2ff8 --- apiVersion: apps/v1 kind: Deployment metadata: labels: app: my-app name: my-app spec: selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - image: my-app name: app volumeMounts: - mountPath: /config name: config volumes: - configMap: name: example-configmap-1-g4hk9g2ff8 name: config","title":"configMapGenerator"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#secretgenerator","text":"\u4f60\u53ef\u4ee5\u57fa\u65bc\u6587\u4ef6\u6216\u8005\u9375\u503c\u5076\u5c0d\u4f86\u751f\u6210 Secret\u3002\u8981\u4f7f\u7528\u6587\u4ef6\u5167\u5bb9\u4f86\u751f\u6210 Secret\uff0c \u5728 secretGenerator \u4e0b\u9762\u7684 files \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u4e00\u500b\u6839\u64da\u6587\u4ef6\u4e2d\u6578\u64da\u4f86\u751f\u6210 Secret \u5c0d\u8c61\u7684\u793a\u4f8b\uff1a # \u5275\u5efa\u4e00\u500b password.txt \u6587\u4ef6 cat <<EOF >./password.txt username=admin password=secret EOF cat <<EOF >./kustomization.yaml secretGenerator: - name: example-secret-1 files: - password.txt EOF \u6240\u751f\u6210\u7684 Secret \u5982\u4e0b\uff1a apiVersion : v1 data : password.txt : dXNlcm5hbWU9YWRtaW4KcGFzc3dvcmQ9c2VjcmV0Cg== kind : Secret metadata : name : example-secret-1-t2kt65hgtb type : Opaque \u8981\u57fa\u65bc\u9375\u503c\u5076\u5c0d\u5b57\u9762\u503c\u751f\u6210 Secret\uff0c\u5148\u8981\u5728 secretGenerator \u7684 literals \u5217\u8868\u4e2d\u6dfb\u52a0\u8868\u9805\u3002\u4e0b\u9762\u662f\u57fa\u65bc\u9375\u503c\u5076\u5c0d\u4e2d\u6578\u64da\u689d\u76ee\u4f86\u751f\u6210 Secret \u7684\u793a\u4f8b\uff1a cat <<EOF >./kustomization.yaml secretGenerator: - name: example-secret-2 literals: - username=admin - password=secret EOF \u6240\u751f\u6210\u7684 Secret \u5982\u4e0b\uff1a apiVersion : v1 data : password : c2VjcmV0 username : YWRtaW4= kind : Secret metadata : name : example-secret-2-t52t6g96d8 type : Opaque \u8207 ConfigMaps \u4e00\u6a23\uff0c\u751f\u6210\u7684 Secrets \u53ef\u4ee5\u901a\u904e\u5f15\u7528 secretGenerator \u7684\u540d\u7a31\u5728\u90e8\u7f72\u4e2d\u4f7f\u7528\uff1a # \u5275\u5efa\u4e00\u500b password.txt \u6587\u4ef6 cat <<EOF >./password.txt username=admin password=secret EOF cat <<EOF >deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-app labels: app: my-app spec: selector: matchLabels: app: my-app template: metadata: labels: app: my-app spec: containers: - name: app image: my-app volumeMounts: - name: password mountPath: /secrets volumes: - name: password secret: secretName: example-secret-1 EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml secretGenerator: - name: example-secret-1 files: - password.txt EOF","title":"secretGenerator"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#generatoroptions","text":"\u6240\u751f\u6210\u7684 ConfigMap \u548c Secret \u90fd\u6703\u5305\u542b\u5167\u5bb9\u54c8\u5e0c\u503c\u5f8c\u7db4\u3002\u9019\u662f\u70ba\u4e86\u78ba\u4fdd\u5167\u5bb9\u9aee\u751f\u8b8a\u5316\u6642\uff0c\u6240\u751f\u6210\u7684\u662f\u65b0\u7684 ConfigMap \u6216 Secret\u3002\u8981\u7981\u6b62\u81ea\u52d5\u6dfb\u52a0\u5f8c\u7db4\u7684\u884c\u70ba\uff0c\u7528\u6236\u53ef\u4ee5\u4f7f\u7528 generatorOptions \u3002\u9664\u6b64\u4ee5\u5916\uff0c\u70ba\u751f\u6210\u7684 ConfigMap \u548c Secret \u6307\u5b9a\u8cab\u7a7f\u6027\u9078\u9805\u4e5f\u662f\u53ef\u4ee5\u7684\u3002 cat <<EOF >./kustomization.yaml configMapGenerator: - name: example-configmap-3 literals: - FOO=Bar generatorOptions: disableNameSuffixHash: true labels: type: generated annotations: note: generated EOF \u904b\u884c kubectl kustomize ./ \u4f86\u67e5\u770b\u6240\u751f\u6210\u7684 ConfigMap\uff1a apiVersion: v1 data: FOO: Bar kind: ConfigMap metadata: annotations: note: generated labels: type: generated name: example-configmap-3","title":"generatorOptions"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#_3","text":"\u5728\u9805\u76ee\u4e2d\u70ba\u6240\u6709 Kubernetes \u5c0d\u8c61\u8a2d\u7f6e\u8cab\u7a7f\u6027\u5b57\u6bb5\u662f\u4e00\u7a2e\u5e38\u898b\u64cd\u4f5c\u3002\u8cab\u7a7f\u6027\u5b57\u6bb5\u7684\u4e00\u4e9b\u4f7f\u7528\u5834\u666f\u5982\u4e0b\uff1a \u70ba\u6240\u6709\u8cc7\u6e90\u8a2d\u7f6e\u76f8\u540c\u7684\u540d\u5b57\u7a7a\u9593 \u70ba\u6240\u6709\u5c0d\u8c61\u6dfb\u52a0\u76f8\u540c\u7684\u524d\u7db4\u6216\u5f8c\u7db4 \u70ba\u5c0d\u8c61\u6dfb\u52a0\u76f8\u540c\u7684\u6a19\u7c64\u96c6\u5408 \u70ba\u5c0d\u8c61\u6dfb\u52a0\u76f8\u540c\u7684\u8a3b\u89e3\u96c6\u5408 \u4e0b\u9762\u662f\u4e00\u500b\u4f8b\u5b50\uff1a # \u5275\u5efa\u4e00\u500b deployment.yaml cat <<EOF >./deployment.yaml apiVersion : apps/v1 kind : Deployment metadata : name : nginx-deployment labels : app : nginx spec : selector : matchLabels : app : nginx template : metadata : labels : app : nginx spec : containers : - name : nginx image : nginx EOF cat <<EOF >./kustomization.yaml namespace : my-namespace namePrefix : dev- nameSuffix : \"-001\" commonLabels : app : bingo commonAnnotations : oncallPager : 800-555-1212 resources : - deployment.yaml EOF \u57f7\u884c kubectl kustomize ./ \u67e5\u770b\u9019\u4e9b\u5b57\u6bb5\u90fd\u88ab\u8a2d\u7f6e\u5230 Deployment \u8cc7\u6e90\u4e0a\uff1a apiVersion : apps/v1 kind : Deployment metadata : annotations : oncallPager : 800-555-1212 labels : app : bingo name : dev-nginx-deployment-001 namespace : my-namespace spec : selector : matchLabels : app : bingo template : metadata : annotations : oncallPager : 800-555-1212 labels : app : bingo spec : containers : - image : nginx name : nginx","title":"\u8a2d\u7f6e\u8cab\u7a7f\u6027\u5b57\u6bb5"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#_4","text":"\u4e00\u7a2e\u5e38\u898b\u7684\u505a\u6cd5\u662f\u5728\u9805\u76ee\u4e2d\u69cb\u9020\u8cc7\u6e90\u96c6\u5408\u4f75\u5c07\u5176\u653e\u5230\u540c\u4e00\u500b\u6587\u4ef6\u6216\u76ee\u9304\u4e2d\u7ba1\u7406\u3002 Kustomize \u63d0\u4f9b\u57fa\u65bc\u4e0d\u540c\u6587\u4ef6\u4f86\u7d44\u7e54\u8cc7\u6e90\u4e26\u5411\u5176\u61c9\u7528\u88dc\u4e01\u6216\u8005\u5176\u4ed6\u5b9a\u5236\u7684\u80fd\u529b\u3002","title":"\u7d44\u7e54\u548c\u5b9a\u5236\u8cc7\u6e90"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#_5","text":"Kustomize \u652f\u6301\u7d44\u5408\u4e0d\u540c\u7684\u8cc7\u6e90\u3002 kustomization.yaml \u6587\u4ef6\u7684 resources \u5b57\u6bb5 \u5b9a\u7fa9\u914d\u7f6e\u4e2d\u8981\u5305\u542b\u7684\u8cc7\u6e90\u5217\u8868\u3002\u4f60\u53ef\u4ee5\u5c07 resources \u5217\u8868\u4e2d\u7684\u8def\u5f91\u8a2d\u7f6e\u70ba\u8cc7\u6e90\u914d\u7f6e\u6587\u4ef6 \u7684\u8def\u5f91\u3002\u4e0b\u9762\u662f\u7531 Deployment \u548c Service \u69cb\u6210\u7684 NGINX \u61c9\u7528\u7684\u793a\u4f8b\uff1a # \u5275\u5efa deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u5275\u5efa service.yaml \u6587\u4ef6 cat <<EOF > service.yaml apiVersion: v1 kind: Service metadata: name: my-nginx labels: run: my-nginx spec: ports: - port: 80 protocol: TCP selector: run: my-nginx EOF # \u5275\u5efa kustomization.yaml \u4f86\u7d44\u7e54\u4ee5\u4e0a\u5169\u500b\u8cc7\u6e90 cat <<EOF >./kustomization.yaml resources: - deployment.yaml - service.yaml EOF kubectl kustomize ./ \u6240\u5f97\u5230\u7684\u8cc7\u6e90\u4e2d\u65e2\u5305\u542b Deployment \u4e5f\u5305\u542b Service \u5c0d\u8c61\u3002","title":"\u7d44\u7e54"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#_6","text":"\u88dc\u4e01\u6587\u4ef6\uff08Patches\uff09\u53ef\u4ee5\u7528\u4f86\u5c0d\u8cc7\u6e90\u57f7\u884c\u4e0d\u540c\u7684\u5b9a\u5236\u3002 Kustomize \u901a\u904e patchesStrategicMerge \u548c patchesJson6902 \u652f\u6301\u4e0d\u540c\u7684\u6253\u88dc\u4e01 \u6a5f\u5236\u3002 patchesStrategicMerge \u7684\u5167\u5bb9\u662f\u4e00\u500b\u6587\u4ef6\u8def\u5f91\u7684\u5217\u8868\uff0c\u5176\u4e2d\u6bcf\u500b\u6587\u4ef6\u90fd\u61c9\u53ef\u89e3\u6790\u70ba \u7b56\u7565\u6027\u5408\u4f75\u88dc\u4e01\uff08Strategic Merge Patch\uff09 \u3002\u88dc\u4e01\u6587\u4ef6\u4e2d\u7684\u540d\u7a31\u5fc5\u9808\u8207\u5df2\u7d93\u52a0\u8f09\u7684\u8cc7\u6e90\u7684\u540d\u7a31\u5339\u914d\u3002\u5efa\u8b70\u69cb\u9020\u898f\u6a21\u8f03\u5c0f\u7684\u3001\u50c5\u505a\u4e00\u4ef6\u4e8b\u60c5\u7684\u88dc\u4e01\u3002\u4f8b\u5982\uff0c\u69cb\u9020\u4e00\u500b\u88dc\u4e01\u4f86\u589e\u52a0 Deployment \u7684\u526f\u672c\u500b\u6578\uff1b\u69cb\u9020\u53e6\u5916\u4e00\u500b\u88dc\u4e01\u4f86\u8a2d\u7f6e\u5167\u5b58\u9650\u5236\u3002 # \u5275\u5efa deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u751f\u6210\u4e00\u500b\u88dc\u4e01 increase_replicas.yaml cat <<EOF > increase_replicas.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: replicas: 3 EOF # \u751f\u6210\u53e6\u4e00\u500b\u88dc\u4e01 set_memory.yaml cat <<EOF > set_memory.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: template: spec: containers: - name: my-nginx resources: limits: memory: 512Mi EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml patchesStrategicMerge: - increase_replicas.yaml - set_memory.yaml EOF \u57f7\u884c kubectl kustomize ./ \u4f86\u67e5\u770b Deployment\uff1a apiVersion : apps/v1 kind : Deployment metadata : name : my-nginx spec : replicas : 3 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - image : nginx name : my-nginx ports : - containerPort : 80 resources : limits : memory : 512Mi \u4e26\u975e\u6240\u6709\u8cc7\u6e90\u6216\u8005\u5b57\u6bb5\u90fd\u652f\u6301\u7b56\u7565\u6027\u5408\u4f75\u88dc\u4e01\u3002\u70ba\u4e86\u652f\u6301\u5c0d\u4efb\u4f55\u8cc7\u6e90\u7684\u4efb\u4f55\u5b57\u6bb5\u9032\u884c\u4fee\u6539\uff0c Kustomize \u63d0\u4f9b\u901a\u904e patchesJson6902 \u4f86\u61c9\u7528 JSON \u88dc\u4e01 \u7684\u80fd\u529b\u3002\u70ba\u4e86\u7d66 JSON \u88dc\u4e01\u627e\u5230\u6b63\u78ba\u7684\u8cc7\u6e90\uff0c\u9700\u8981\u5728 kustomization.yaml \u6587\u4ef6\u4e2d\u6307\u5b9a\u8cc7\u6e90\u7684 \u7d44\uff08group\uff09\u3001\u7248\u672c\uff08version\uff09\u3001\u985e\u5225\uff08kind\uff09\u548c\u540d\u7a31\uff08name\uff09\u3002\u4f8b\u5982\uff0c\u70ba\u67d0 Deployment \u5c0d\u8c61\u589e\u52a0\u526f\u672c\u500b\u6578\u7684\u64cd\u4f5c\u4e5f\u53ef\u4ee5\u901a\u904e patchesJson6902 \u4f86\u5b8c\u6210\uff1a # \u5275\u5efa\u4e00\u500b deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u5275\u5efa\u4e00\u500b JSON \u88dc\u4e01\u6587\u4ef6 cat <<EOF > patch.yaml - op: replace path: /spec/replicas value: 3 EOF # \u5275\u5efa\u4e00\u500b kustomization.yaml cat <<EOF >./kustomization.yaml resources: - deployment.yaml patchesJson6902: - target: group: apps version: v1 kind: Deployment name: my-nginx path: patch.yaml EOF \u57f7\u884c kubectl kustomize ./ \u4ee5\u67e5\u770b replicas \u5b57\u6bb5\u88ab\u66f4\u65b0\uff1a apiVersion : apps/v1 kind : Deployment metadata : name : my-nginx spec : replicas : 3 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - image : nginx name : my-nginx ports : - containerPort : 80 \u9664\u4e86\u88dc\u4e01\u4e4b\u5916\uff0cKustomize \u9084\u63d0\u4f9b\u5b9a\u5236\u5bb9\u5668\u93e1\u50cf\u6216\u8005\u5c07\u5176\u4ed6\u5c0d\u8c61\u7684\u5b57\u6bb5\u503c\u6ce8\u5165\u5230\u5bb9\u5668 \u4e2d\u7684\u80fd\u529b\uff0c\u4e26\u4e14\u4e0d\u9700\u8981\u5275\u5efa\u88dc\u4e01\u3002\u4f8b\u5982\uff0c\u4f60\u53ef\u4ee5\u901a\u904e\u5728 kustomization.yaml \u6587\u4ef6\u7684 images \u5b57\u6bb5\u8a2d\u7f6e\u65b0\u7684\u93e1\u50cf\u4f86 \u66f4\u6539\u5bb9\u5668\u4e2d\u4f7f\u7528\u7684\u93e1\u50cf\u3002 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF cat <<EOF >./kustomization.yaml resources: - deployment.yaml images: - name: nginx newName: my.image.registry/nginx newTag: 1.4.0 EOF \u57f7\u884c kubectl kustomize ./ \u4ee5\u67e5\u770b\u6240\u4f7f\u7528\u7684\u93e1\u50cf\u5df2\u88ab\u66f4\u65b0\uff1a apiVersion : apps/v1 kind : Deployment metadata : name : my-nginx spec : replicas : 2 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - image : my.image.registry/nginx:1.4.0 name : my-nginx ports : - containerPort : 80 \u6709\u4e9b\u6642\u5019\uff0cPod \u4e2d\u904b\u884c\u7684\u61c9\u7528\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u4f86\u81ea\u5176\u4ed6\u5c0d\u8c61\u7684\u914d\u7f6e\u503c\u3002\u4f8b\u5982\uff0c\u67d0 Deployment \u5c0d\u8c61\u7684 Pod \u9700\u8981\u5f9e\u74b0\u5883\u8b8a\u91cf\u6216\u547d\u4ee4\u884c\u53c3\u6578\u4e2d\u8b80\u53d6\u8b80\u53d6 Service \u7684\u540d\u7a31\u3002\u7531\u65bc\u5728 kustomization.yaml \u6587\u4ef6\u4e2d\u6dfb\u52a0 namePrefix \u6216 nameSuffix \u6642 Service \u540d\u7a31\u53ef\u80fd\u767c\u751f\u8b8a\u5316\uff0c\u5efa\u8b70\u4e0d\u8981\u5728\u547d\u4ee4\u53c3\u6578\u4e2d\u786c\u7de8\u78bc Service \u540d\u7a31\u3002\u5c0d\u65bc\u9019\u7a2e\u4f7f\u7528\u5834\u666f\uff0cKustomize \u53ef\u4ee5\u901a\u904e vars \u5c07 Service \u540d\u7a31\u6ce8\u5165\u5230\u5bb9\u5668\u4e2d\u3002 # \u5275\u5efa\u4e00\u500b deployment.yaml \u6587\u4ef6\uff08\u5f15\u7528\u6b64\u8655\u7684\u6587\u6a94\u5206\u9694\u7b26\uff09 cat <<'EOF' > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx command: [\"start\", \"--host\", \"$(MY_SERVICE_NAME)\"] EOF # \u5275\u5efa\u4e00\u500b service.yaml \u6587\u4ef6 cat <<EOF > service.yaml apiVersion: v1 kind: Service metadata: name: my-nginx labels: run: my-nginx spec: ports: - port: 80 protocol: TCP selector: run: my-nginx EOF cat <<EOF >./kustomization.yaml namePrefix: dev- nameSuffix: \"-001\" resources: - deployment.yaml - service.yaml vars: - name: MY_SERVICE_NAME objref: kind: Service name: my-nginx apiVersion: v1 EOF \u57f7\u884c kubectl kustomize ./ \u4ee5\u67e5\u770b\u6ce8\u5165\u5230\u5bb9\u5668\u4e2d\u7684 Service \u540d\u7a31\u662f dev-my-nginx-001 \uff1a apiVersion : apps/v1 kind : Deployment metadata : name : dev-my-nginx-001 spec : replicas : 2 selector : matchLabels : run : my-nginx template : metadata : labels : run : my-nginx spec : containers : - command : - start - --host - dev-my-nginx-001 image : nginx name : my-nginx","title":"\u5b9a\u5236"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#bases-overlays","text":"Kustomize \u4e2d\u6709 \u57fa\u6e96\uff08bases\uff09 \u548c \u8986\u84cb\uff08overlays\uff09 \u7684\u6982\u5ff5\u5340\u5206\u3002\u57fa\u6e96 \u662f\u5305\u542b kustomization.yaml \u6587\u4ef6\u7684\u4e00\u500b\u76ee\u9304\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u7d44\u8cc7\u6e90\u53ca\u5176\u76f8\u95dc\u7684\u5b9a\u5236\u3002\u57fa\u6e96\u53ef\u4ee5\u662f\u672c\u5730\u76ee\u9304\u6216\u8005\u4f86\u81ea\u9060\u7a0b\u5009\u5eab\u7684\u76ee\u9304\uff0c\u53ea\u8981\u5176\u4e2d\u5b58\u5728 kustomization.yaml \u6587\u4ef6\u5373\u53ef\u3002 \u8986\u84cb \u4e5f\u662f\u4e00\u500b\u76ee\u9304\uff0c\u5176\u4e2d\u5305\u542b\u5c07\u5176\u4ed6 kustomization \u76ee\u9304\u7576\u505a bases \u4f86\u5f15\u7528\u7684 kustomization.yaml \u6587\u4ef6\u3002\u57fa\u6e96\u4e0d\u4e86\u89e3\u8986\u84cb\u7684\u5b58\u5728\uff0c\u4e14\u53ef\u88ab\u591a\u500b\u8986\u84cb\u6240\u4f7f\u7528\u3002\u8986\u84cb\u5247\u53ef\u4ee5\u6709\u591a\u500b\u57fa\u6e96\uff0c\u4e14\u53ef\u91dd\u5c0d\u6240\u6709\u57fa\u6e96\u4e2d\u7684\u8cc7\u6e90\u57f7\u884c\u7d44\u7e54\u64cd\u4f5c\uff0c\u9084\u53ef\u4ee5\u5728\u5176\u4e0a\u57f7\u884c\u5b9a\u5236\u3002 # \u5275\u5efa\u4e00\u500b\u5305\u542b\u57fa\u6e96\u7684\u76ee\u9304 mkdir base # \u5275\u5efa base/deployment.yaml cat <<EOF > base/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx EOF # \u5275\u5efa base/service.yaml \u6587\u4ef6 cat <<EOF > base/service.yaml apiVersion: v1 kind: Service metadata: name: my-nginx labels: run: my-nginx spec: ports: - port: 80 protocol: TCP selector: run: my-nginx EOF # \u5275\u5efa base/kustomization.yaml cat <<EOF > base/kustomization.yaml resources: - deployment.yaml - service.yaml EOF \u6b64\u57fa\u6e96\u53ef\u5728\u591a\u500b\u8986\u84cb\u4e2d\u4f7f\u7528\u3002\u4f60\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u8986\u84cb\u4e2d\u6dfb\u52a0\u4e0d\u540c\u7684 namePrefix \u6216 \u5176\u4ed6\u8cab\u7a7f\u6027\u5b57\u6bb5\u3002\u4e0b\u9762\u662f\u5169\u500b\u4f7f\u7528\u540c\u4e00\u57fa\u6e96\u7684\u8986\u84cb\uff1a mkdir dev cat <<EOF > dev/kustomization.yaml bases: - ../base namePrefix: dev- EOF mkdir prod cat <<EOF > prod/kustomization.yaml bases: - ../base namePrefix: prod- EOF","title":"\u57fa\u6e96 (Bases) \u8207\u8986\u84cb (Overlays)"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#kustomize_1","text":"\u5728 kubectl \u547d\u4ee4\u4e2d\u4f7f\u7528 --kustomize \u6216 -k \u53c3\u6578\u4f86\u8b58\u5225\u88ab kustomization.yaml \u6240\u7ba1\u7406\u7684\u8cc7\u6e90\u3002\u6ce8\u610f -k \u8981\u6307\u5411\u4e00\u500b kustomization \u76ee\u9304\u3002\u4f8b\u5982\uff1a kubectl apply -k <kustomization \u76ee\u9304>/ \u5047\u5b9a\u4f7f\u7528\u4e0b\u9762\u7684 kustomization.yaml \uff0c # \u5275\u5efa deployment.yaml \u6587\u4ef6 cat <<EOF > deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 2 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80 EOF # \u5275\u5efa kustomization.yaml cat <<EOF >./kustomization.yaml namePrefix: dev- commonLabels: app: my-nginx resources: - deployment.yaml EOF \u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4f86\u61c9\u7528 Deployment \u5c0d\u8c61 dev-my-nginx\uff1a kubectl apply -k ./ \u547d\u4ee4\u57f7\u884c\u7d50\u679c: deployment.apps/dev-my-nginx created \u904b\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4e4b\u4e00\u4f86\u67e5\u770b Deployment \u5c0d\u8c61 dev-my-nginx\uff1a kubectl get -k ./ \u547d\u4ee4\u57f7\u884c\u7d50\u679c: NAME READY UP-TO-DATE AVAILABLE AGE dev-my-nginx 2/2 2 2 75s kubectl describe -k ./ \u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u4f86\u6bd4\u8f03 Deployment \u5c0d\u8c61 dev-my-nginx \u8207\u6e05\u55ae\u88ab\u61c9\u7528\u4e4b\u5f8c \u96c6\u7fa4\u5c07\u8655\u65bc\u7684\u72c0\u614b\uff1a kubectl diff -k ./ \u57f7\u884c\u4e0b\u9762\u7684\u547d\u4ee4\u522a\u9664 Deployment \u5c0d\u8c61 dev-my-nginx\uff1a kubectl delete -k ./ \u547d\u4ee4\u57f7\u884c\u7d50\u679c: deployment.apps \"dev-my-nginx\" deleted","title":"\u5982\u4f55\u4f7f\u7528 Kustomize \u6765\u5e94\u7528\u3001\u67e5\u770b\u548c\u5220\u9664\u5bf9\u8c61"},{"location":"kubernetes/03-tasks/manage-kubernetes-objects/kustomization/#kustomize_2","text":"\u5b57\u6bb5 \u985e\u578b \u89e3\u91cb namespace string \u70ba\u6240\u6709\u8cc7\u6e90\u6dfb\u52a0\u540d\u5b57\u7a7a\u9593 namePrefix string \u6b64\u5b57\u6bb5\u7684\u503c\u5c07\u88ab\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u540d\u7a31\u524d\u9762 nameSuffix string \u6b64\u5b57\u6bb5\u7684\u503c\u5c07\u88ab\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u540d\u7a31\u5f8c\u9762 commonLabels map[string]string \u8981\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u548c\u9078\u64c7\u7b97\u7b26\u7684\u6a19\u7c64 commonAnnotations map[string]string \u8981\u6dfb\u52a0\u5230\u6240\u6709\u8cc7\u6e90\u7684\u8a3b\u89e3 resources []string \u5217\u8868\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u90fd\u5fc5\u9808\u80fd\u5920\u89e3\u6790\u70ba\u73fe\u6709\u7684\u8cc7\u6e90\u914d\u7f6e\u6587\u4ef6 configMapGenerator []ConfigMapArgs \u5217\u8868\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u90fd\u6703\u751f\u6210\u4e00\u500b ConfigMap secretGenerator []SecretArgs \u5217\u8868\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u90fd\u6703\u751f\u6210\u4e00\u500b Secret generatorOptions GeneratorOptions \u66f4\u6539\u6240\u6709 ConfigMap \u548c Secret \u751f\u6210\u5668\u7684\u884c\u70ba bases []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u61c9\u80fd\u89e3\u6790\u70ba\u4e00\u500b\u5305\u542b kustomization.yaml \u6587\u4ef6\u7684\u76ee\u9304 patchesStrategicMerge []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u80fd\u89e3\u6790\u70ba\u67d0 Kubernetes \u5c0d\u8c61\u7684\u7b56\u7565\u6027\u5408\u4f75\u88dc\u4e01 patchesJson6902 []Patch \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u80fd\u89e3\u6790\u70ba\u4e00\u500b Kubernetes \u5c0d\u8c61\u548c\u4e00\u500b JSON \u88dc\u4e01 vars []Var \u6bcf\u500b\u689d\u76ee\u7528\u4f86\u5f9e\u67d0\u8cc7\u6e90\u7684\u5b57\u6bb5\u4f86\u6790\u53d6\u6587\u5b57 images []Image \u6bcf\u500b\u689d\u76ee\u90fd\u7528\u4f86\u66f4\u6539\u93e1\u50cf\u7684\u540d\u7a31\u3001\u6a19\u8a18\u8207/\u6216\u6458\u8981\uff0c\u4e0d\u5fc5\u751f\u6210\u88dc\u4e01 configurations []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u61c9\u80fd\u89e3\u6790\u70ba\u4e00\u500b\u5305\u542b Kustomize \u8f49\u63db\u5668\u914d\u7f6e \u7684\u6587\u4ef6 crds []string \u5217\u8868\u4e2d\u6bcf\u500b\u689d\u76ee\u90fd\u61c9\u80fd\u5920\u89e3\u6790\u70ba Kubernetes \u985e\u5225\u7684 OpenAPI \u5b9a\u7fa9\u6587\u4ef6","title":"Kustomize \u529f\u80fd\u7279\u6027\u5217\u8868"},{"location":"kubernetes/04-tutorials/hello-k3d/","text":"\u4f60\u597d\uff0cK3D \u00b6 \u539f\u6587: Hello Minikube \u672c\u6559\u7a0b\u5411\u4f60\u5c55\u793a\u5982\u4f55\u4f7f\u7528 K3D \u5728 Kubernetes \u4e0a\u904b\u884c\u4e00\u500b\u61c9\u7528\u793a\u4f8b\u3002 Info \u8aaa\u660e\uff1a \u5982\u679c\u4f60\u5df2\u5728\u672c\u5730\u5b89\u88dd K3D\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167\u672c\u6559\u7a0b\u64cd\u4f5c\u3002\u5b89\u88dd\u6307\u5357\u53c3\u95b1 \u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u3002 \u6559\u7a0b\u76ee\u6a19 \u00b6 \u5c07\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u90e8\u7f72\u5230 K3D \u904b\u884c\u61c9\u7528\u7a0b\u5e8f \u67e5\u770b\u61c9\u7528\u65e5\u8a8c \u6e96\u5099\u958b\u59cb \u00b6 \u672c\u6559\u7a0b\u63d0\u4f9b\u4e86\u5bb9\u5668\u93e1\u50cf\uff0c\u4f7f\u7528 NGINX \u4f86\u5c0d\u6240\u6709\u8acb\u6c42\u505a\u51fa\u56de\u61c9\uff1a \u5275\u5efa K3D \u96c6\u7fa4 \u00b6 K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer Info \u7aef\u53e3\u6620\u5c04\u7d50\u69cb 8081:80 @loadbalancer \u7684\u610f\u601d\u662f\uff1a\u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u5230\u8207 nodefilter \u8ca0\u8f09\u5e73\u8861\u5668\u5339\u914d\u7684\u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3\u201d \u5275\u5efa Deployment \u00b6 Kubernetes Pod \u662f\u7531\u4e00\u500b\u6216\u591a\u500b \u70ba\u4e86\u7ba1\u7406\u548c\u806f\u7db2\u800c\u7d81\u5b9a\u5728\u4e00\u8d77\u7684\u5bb9\u5668\u69cb\u6210\u7684\u5bb9\u5668\u7d44 \u3002\u672c\u6559\u7a0b\u4e2d\u7684 Pod \u53ea\u6709\u4e00\u500b\u5bb9\u5668\u3002 Kubernetes Deployment \u6aa2\u67e5 Pod \u7684\u5065\u5eb7\u72c0\u6cc1\uff0c\u4e26\u5728 Pod \u4e2d\u7684\u5bb9\u5668\u7d42\u6b62\u7684\u60c5\u6cc1\u4e0b\u91cd\u65b0\u555f\u52d5\u65b0\u7684\u5bb9\u5668\u3002 Deployment \u662f\u7ba1\u7406 Pod \u5275\u5efa\u548c\u64f4\u5c55\u7684\u63a8\u85a6\u65b9\u6cd5\u3002 1.\u4f7f\u7528 kubectl create \u547d\u4ee4\u5275\u5efa\u7ba1\u7406 Pod \u7684 Deployment\u3002\u8a72 Pod \u6839\u64da\u63d0\u4f9b\u7684 Docker \u93e1\u50cf\u904b\u884c Container\u3002 kubectl create deployment hello-node --image = k8s.gcr.io/echoserver:1.4 2.\u67e5\u770b Deployment\uff1a kubectl get deployments \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY UP-TO-DATE AVAILABLE AGE hello-node 1/1 1 1 61s 3.\u67e5\u770b Pod\uff1a kubectl get pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY STATUS RESTARTS AGE hello-node-7567d9fdc9-zstdl 1/1 Running 0 2m22s 4.\u67e5\u770b\u96c6\u7fa4\u4e8b\u4ef6\uff1a kubectl get events \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a LAST SEEN TYPE REASON OBJECT MESSAGE ... ... 3m11s Normal ScalingReplicaSet deployment/hello-node Scaled up replica set hello-node-7567d9fdc9 to 1 3m11s Normal Scheduled pod/hello-node-7567d9fdc9-zstdl Successfully assigned default/hello-node-7567d9fdc9-zstdl to k3d-k3s-default-server-0 3m11s Normal SuccessfulCreate replicaset/hello-node-7567d9fdc9 Created pod: hello-node-7567d9fdc9-zstdl 2m52s Normal Pulling pod/hello-node-7567d9fdc9-zstdl Pulling image \"k8s.gcr.io/echoserver:1.4\" 2m30s Normal Pulled pod/hello-node-7567d9fdc9-zstdl Successfully pulled image \"k8s.gcr.io/echoserver:1.4\" in 22.087240618s 2m26s Normal Created pod/hello-node-7567d9fdc9-zstdl Created container echoserver 2m25s Normal Started pod/hello-node-7567d9fdc9-zstdl Started container echoserver ... ... 5.\u67e5\u770b kubectl \u914d\u7f6e\uff1a kubectl config view \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority-data: DATA+OMITTED server: https://0.0.0.0:46637 name: k3d-k3s-default contexts: - context: cluster: k3d-k3s-default user: admin@k3d-k3s-default name: k3d-k3s-default current-context: k3d-k3s-default kind: Config preferences: {} users: - name: admin@k3d-k3s-default user: client-certificate-data: REDACTED client-key-data: REDACTED Info \u8aaa\u660e\uff1a \u6709\u95dc kubectl \u547d\u4ee4\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 kubectl \u6982\u8ff0 \u3002 \u5275\u5efa Service \u00b6 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPod \u53ea\u80fd\u901a\u904e Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5167\u90e8 IP \u5730\u5740\u8a2a\u554f\u3002\u8981\u4f7f\u5f97 hello-node \u5bb9\u5668\u53ef\u4ee5\u5f9e Kubernetes \u865b\u64ec\u7db2\u7d61\u7684\u5916\u90e8\u8a2a\u554f\uff0c\u4f60\u5fc5\u9808\u5c07 Pod \u66b4\u9732\u70ba Kubernetes Service \u3002 1. \u4f7f\u7528 kubectl expose \u547d\u4ee4\u5c07 Pod \u66b4\u9732\u6210ClusterIP\uff1a kubectl expose deployment hello-node --port = 8080 \u9019\u88e1\u7684 --type=LoadBalancer \u53c3\u6578\u8868\u660e\u4f60\u5e0c\u671b\u5c07\u4f60\u7684 Service \u66b4\u9732\u5230\u96c6\u7fa4\u5916\u90e8\u3002 \u93e1\u50cf k8s.gcr.io/echoserver \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u50c5\u76e3\u807d TCP 8080 \u7aef\u53e3\u3002\u5982\u679c\u4f60\u7528 kubectl expose \u66b4\u9732\u4e86\u5176\u5b83\u7684\u7aef\u53e3\uff0c\u5ba2\u6236\u7aef\u5c07\u4e0d\u80fd\u8a2a\u554f\u5230\u670d\u52d9\u3002 2. \u67e5\u770b\u4f60\u5275\u5efa\u7684 Service\uff1a kubectl get services \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 35m hello-node ClusterIP 10.43.228.243 <none> 8080/TCP 4s 3. \u4f7f\u7528\u7aef\u53e3\u8f49\u767c\u4f86\u8a2a\u554f\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528 \u4f7f\u7528 kubectl \u7528 port-forward \u4f86\u9078\u64c7\u548c\u5206\u914d\u672c\u5730\u7aef\u53e3\u4e26\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\uff1a \u683c\u5f0f: kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0' \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\uff1a kubectl port-forward service/hello-node :8080 --address = '0.0.0.0' kubectl \u5de5\u5177\u6703\u627e\u5230\u4e00\u500b\u672a\u88ab\u4f7f\u7528\u7684\u672c\u5730\u7aef\u53e3\u865f\u3002\u8f38\u51fa\u985e\u4f3c\u65bc\uff1a Forwarding from 0.0.0.0:35729 -> 8080 Tip \u8acb\u6ce8\u610f\u5728 port-forward \u8f38\u51fa\u4e2d\u8207 8080 \u5c0d\u61c9\u7684\u9577\u5ea6\u70ba 5 \u4f4d\u7684\u7aef\u53e3\u865f\u3002\u6b64\u7aef\u53e3\u865f\u662f\u96a8\u6a5f\u751f\u6210\u7684\uff0c\u53ef\u80fd\u8207\u4f60\u7684\u4e0d\u540c\u3002\u5c0d\u61c9\u65bc\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u96c6\u7fa4\u61c9\u7528\u88ab\u66b4\u9732\u51fa\u7684\u672c\u5730\u7aef\u53e3\u865f\u662f 35729\u3002 4. \u8a2a\u554f\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528 \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u8a2a\u554f\u66b4\u9732\u51fa\u4f86\u7684\u61c9\u7528\uff1a curl localhost:35729 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a CLIENT VALUES: client_address=127.0.0.1 command=GET real path=/ query=nil request_version=1.1 request_uri=http://localhost:8080/ SERVER VALUES: server_version=nginx: 1.10.0 - lua: 10001 HEADERS RECEIVED: accept=*/* host=localhost:35729 user-agent=curl/7.74.0 BODY: -no body in request- \u6e05\u7406 \u00b6 \u73fe\u5728\u53ef\u4ee5\u6e05\u7406\u4f60\u5728\u96c6\u7fa4\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff1a kubectl delete service hello-node kubectl delete deployment hello-node \u53ef\u9078\u5730\uff0c\u505c\u6b62 K3D \u6240\u5275\u5efa\u7684\u96c6\u7fa4\uff08Docker\uff09\uff1a k3d cluster stop \u53ef\u9078\u5730\uff0c\u522a\u9664 K3D \u6240\u5275\u5efa\u7684\u96c6\u7fa4\uff08Docker\uff09\uff1a k3d cluster delete","title":"\u4f60\u597d, K3D"},{"location":"kubernetes/04-tutorials/hello-k3d/#k3d","text":"\u539f\u6587: Hello Minikube \u672c\u6559\u7a0b\u5411\u4f60\u5c55\u793a\u5982\u4f55\u4f7f\u7528 K3D \u5728 Kubernetes \u4e0a\u904b\u884c\u4e00\u500b\u61c9\u7528\u793a\u4f8b\u3002 Info \u8aaa\u660e\uff1a \u5982\u679c\u4f60\u5df2\u5728\u672c\u5730\u5b89\u88dd K3D\uff0c\u4e5f\u53ef\u4ee5\u6309\u7167\u672c\u6559\u7a0b\u64cd\u4f5c\u3002\u5b89\u88dd\u6307\u5357\u53c3\u95b1 \u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u3002","title":"\u4f60\u597d\uff0cK3D"},{"location":"kubernetes/04-tutorials/hello-k3d/#_1","text":"\u5c07\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u90e8\u7f72\u5230 K3D \u904b\u884c\u61c9\u7528\u7a0b\u5e8f \u67e5\u770b\u61c9\u7528\u65e5\u8a8c","title":"\u6559\u7a0b\u76ee\u6a19"},{"location":"kubernetes/04-tutorials/hello-k3d/#_2","text":"\u672c\u6559\u7a0b\u63d0\u4f9b\u4e86\u5bb9\u5668\u93e1\u50cf\uff0c\u4f7f\u7528 NGINX \u4f86\u5c0d\u6240\u6709\u8acb\u6c42\u505a\u51fa\u56de\u61c9\uff1a","title":"\u6e96\u5099\u958b\u59cb"},{"location":"kubernetes/04-tutorials/hello-k3d/#k3d_1","text":"K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer Info \u7aef\u53e3\u6620\u5c04\u7d50\u69cb 8081:80 @loadbalancer \u7684\u610f\u601d\u662f\uff1a\u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u5230\u8207 nodefilter \u8ca0\u8f09\u5e73\u8861\u5668\u5339\u914d\u7684\u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3\u201d","title":"\u5275\u5efa K3D \u96c6\u7fa4"},{"location":"kubernetes/04-tutorials/hello-k3d/#deployment","text":"Kubernetes Pod \u662f\u7531\u4e00\u500b\u6216\u591a\u500b \u70ba\u4e86\u7ba1\u7406\u548c\u806f\u7db2\u800c\u7d81\u5b9a\u5728\u4e00\u8d77\u7684\u5bb9\u5668\u69cb\u6210\u7684\u5bb9\u5668\u7d44 \u3002\u672c\u6559\u7a0b\u4e2d\u7684 Pod \u53ea\u6709\u4e00\u500b\u5bb9\u5668\u3002 Kubernetes Deployment \u6aa2\u67e5 Pod \u7684\u5065\u5eb7\u72c0\u6cc1\uff0c\u4e26\u5728 Pod \u4e2d\u7684\u5bb9\u5668\u7d42\u6b62\u7684\u60c5\u6cc1\u4e0b\u91cd\u65b0\u555f\u52d5\u65b0\u7684\u5bb9\u5668\u3002 Deployment \u662f\u7ba1\u7406 Pod \u5275\u5efa\u548c\u64f4\u5c55\u7684\u63a8\u85a6\u65b9\u6cd5\u3002 1.\u4f7f\u7528 kubectl create \u547d\u4ee4\u5275\u5efa\u7ba1\u7406 Pod \u7684 Deployment\u3002\u8a72 Pod \u6839\u64da\u63d0\u4f9b\u7684 Docker \u93e1\u50cf\u904b\u884c Container\u3002 kubectl create deployment hello-node --image = k8s.gcr.io/echoserver:1.4 2.\u67e5\u770b Deployment\uff1a kubectl get deployments \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY UP-TO-DATE AVAILABLE AGE hello-node 1/1 1 1 61s 3.\u67e5\u770b Pod\uff1a kubectl get pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY STATUS RESTARTS AGE hello-node-7567d9fdc9-zstdl 1/1 Running 0 2m22s 4.\u67e5\u770b\u96c6\u7fa4\u4e8b\u4ef6\uff1a kubectl get events \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a LAST SEEN TYPE REASON OBJECT MESSAGE ... ... 3m11s Normal ScalingReplicaSet deployment/hello-node Scaled up replica set hello-node-7567d9fdc9 to 1 3m11s Normal Scheduled pod/hello-node-7567d9fdc9-zstdl Successfully assigned default/hello-node-7567d9fdc9-zstdl to k3d-k3s-default-server-0 3m11s Normal SuccessfulCreate replicaset/hello-node-7567d9fdc9 Created pod: hello-node-7567d9fdc9-zstdl 2m52s Normal Pulling pod/hello-node-7567d9fdc9-zstdl Pulling image \"k8s.gcr.io/echoserver:1.4\" 2m30s Normal Pulled pod/hello-node-7567d9fdc9-zstdl Successfully pulled image \"k8s.gcr.io/echoserver:1.4\" in 22.087240618s 2m26s Normal Created pod/hello-node-7567d9fdc9-zstdl Created container echoserver 2m25s Normal Started pod/hello-node-7567d9fdc9-zstdl Started container echoserver ... ... 5.\u67e5\u770b kubectl \u914d\u7f6e\uff1a kubectl config view \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority-data: DATA+OMITTED server: https://0.0.0.0:46637 name: k3d-k3s-default contexts: - context: cluster: k3d-k3s-default user: admin@k3d-k3s-default name: k3d-k3s-default current-context: k3d-k3s-default kind: Config preferences: {} users: - name: admin@k3d-k3s-default user: client-certificate-data: REDACTED client-key-data: REDACTED Info \u8aaa\u660e\uff1a \u6709\u95dc kubectl \u547d\u4ee4\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 kubectl \u6982\u8ff0 \u3002","title":"\u5275\u5efa Deployment"},{"location":"kubernetes/04-tutorials/hello-k3d/#service","text":"\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPod \u53ea\u80fd\u901a\u904e Kubernetes \u96c6\u7fa4\u4e2d\u7684\u5167\u90e8 IP \u5730\u5740\u8a2a\u554f\u3002\u8981\u4f7f\u5f97 hello-node \u5bb9\u5668\u53ef\u4ee5\u5f9e Kubernetes \u865b\u64ec\u7db2\u7d61\u7684\u5916\u90e8\u8a2a\u554f\uff0c\u4f60\u5fc5\u9808\u5c07 Pod \u66b4\u9732\u70ba Kubernetes Service \u3002 1. \u4f7f\u7528 kubectl expose \u547d\u4ee4\u5c07 Pod \u66b4\u9732\u6210ClusterIP\uff1a kubectl expose deployment hello-node --port = 8080 \u9019\u88e1\u7684 --type=LoadBalancer \u53c3\u6578\u8868\u660e\u4f60\u5e0c\u671b\u5c07\u4f60\u7684 Service \u66b4\u9732\u5230\u96c6\u7fa4\u5916\u90e8\u3002 \u93e1\u50cf k8s.gcr.io/echoserver \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u50c5\u76e3\u807d TCP 8080 \u7aef\u53e3\u3002\u5982\u679c\u4f60\u7528 kubectl expose \u66b4\u9732\u4e86\u5176\u5b83\u7684\u7aef\u53e3\uff0c\u5ba2\u6236\u7aef\u5c07\u4e0d\u80fd\u8a2a\u554f\u5230\u670d\u52d9\u3002 2. \u67e5\u770b\u4f60\u5275\u5efa\u7684 Service\uff1a kubectl get services \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 35m hello-node ClusterIP 10.43.228.243 <none> 8080/TCP 4s 3. \u4f7f\u7528\u7aef\u53e3\u8f49\u767c\u4f86\u8a2a\u554f\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528 \u4f7f\u7528 kubectl \u7528 port-forward \u4f86\u9078\u64c7\u548c\u5206\u914d\u672c\u5730\u7aef\u53e3\u4e26\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\uff1a \u683c\u5f0f: kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0' \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\uff1a kubectl port-forward service/hello-node :8080 --address = '0.0.0.0' kubectl \u5de5\u5177\u6703\u627e\u5230\u4e00\u500b\u672a\u88ab\u4f7f\u7528\u7684\u672c\u5730\u7aef\u53e3\u865f\u3002\u8f38\u51fa\u985e\u4f3c\u65bc\uff1a Forwarding from 0.0.0.0:35729 -> 8080 Tip \u8acb\u6ce8\u610f\u5728 port-forward \u8f38\u51fa\u4e2d\u8207 8080 \u5c0d\u61c9\u7684\u9577\u5ea6\u70ba 5 \u4f4d\u7684\u7aef\u53e3\u865f\u3002\u6b64\u7aef\u53e3\u865f\u662f\u96a8\u6a5f\u751f\u6210\u7684\uff0c\u53ef\u80fd\u8207\u4f60\u7684\u4e0d\u540c\u3002\u5c0d\u61c9\u65bc\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u96c6\u7fa4\u61c9\u7528\u88ab\u66b4\u9732\u51fa\u7684\u672c\u5730\u7aef\u53e3\u865f\u662f 35729\u3002 4. \u8a2a\u554f\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528 \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u8a2a\u554f\u66b4\u9732\u51fa\u4f86\u7684\u61c9\u7528\uff1a curl localhost:35729 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a CLIENT VALUES: client_address=127.0.0.1 command=GET real path=/ query=nil request_version=1.1 request_uri=http://localhost:8080/ SERVER VALUES: server_version=nginx: 1.10.0 - lua: 10001 HEADERS RECEIVED: accept=*/* host=localhost:35729 user-agent=curl/7.74.0 BODY: -no body in request-","title":"\u5275\u5efa Service"},{"location":"kubernetes/04-tutorials/hello-k3d/#_3","text":"\u73fe\u5728\u53ef\u4ee5\u6e05\u7406\u4f60\u5728\u96c6\u7fa4\u4e2d\u5275\u5efa\u7684\u8cc7\u6e90\uff1a kubectl delete service hello-node kubectl delete deployment hello-node \u53ef\u9078\u5730\uff0c\u505c\u6b62 K3D \u6240\u5275\u5efa\u7684\u96c6\u7fa4\uff08Docker\uff09\uff1a k3d cluster stop \u53ef\u9078\u5730\uff0c\u522a\u9664 K3D \u6240\u5275\u5efa\u7684\u96c6\u7fa4\uff08Docker\uff09\uff1a k3d cluster delete","title":"\u6e05\u7406"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/","text":"ConfigMap \u8207 Secret \u00b6 \u539f\u6587: k8s\u5165\u95e8\u6559\u7a0b\u5341\u4e00:ConfigMap\u4e0esecrets ConfigMap \u00b6 ConfigMap \u5141\u8a31\u60a8\u5c07\u914d\u7f6e\u6587\u4ef6\u8207\u5bb9\u5668\u93e1\u50cf\u5206\u96e2\uff0c\u4ee5\u4f7f\u5bb9\u5668\u5316\u7684\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u53ef\u79fb\u690d\u6027\u3002\u672c\u6559\u7a0b\u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u4f7f\u7528\u793a\u4f8b\uff0c\u9019\u4e9b\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u4f7f\u7528\u5b58\u5132\u5728 ConfigMap \u4e2d\u7684\u6578\u64da\u5275\u5efa\u548c\u914d\u7f6e Pod\u3002 ConfigMap API\u7d66\u6211\u5011\u63d0\u4f9b\u4e86\u5411\u5bb9\u5668\u4e2d\u8a3b\u5165\u914d\u7f6e\u4fe1\u606f\u7684\u6a5f\u5236\uff0cConfigMap \u53ef\u4ee5\u88ab\u7528\u4f86\u4fdd\u5b58\u55ae\u500b\u5c6c\u6027\uff0c\u4e5f\u53ef\u4ee5\u7528\u4f86\u4fdd\u5b58\u6574\u500b\u914d\u7f6e\u6587\u4ef6\u6216\u8005 JSON \u4e8c\u9032\u5236\u5c0d\u8c61\u3002 \u914d\u7f6e\u6578\u64da\u53ef\u4ee5\u901a\u904e\u5f88\u591a\u7a2e\u65b9\u5f0f\u5728 Pods \u88e1\u88ab\u4f7f\u7528\u3002 ConfigMaps \u53ef\u4ee5\u88ab\u7528\u4f86\uff1a \u751f\u6210\u70ba\u5bb9\u5668\u5167\u7684\u74b0\u5883\u8b8a\u91cf \u8a2d\u7f6e\u5bb9\u5668\u555f\u52d5\u547d\u4ee4\u7684\u53c3\u6578 \u639b\u8f09\u70ba\u5bb9\u5668\u5167\u90e8\u7684\u6587\u4ef6\u6216\u76ee\u9304 \u5411\u5bb9\u5668\u50b3\u905e\u53c3\u6578 : \u5982\u679c\u9700\u8981\u5411\u5bb9\u5668\u50b3\u905e \u53c3\u6578 \uff0c\u53ef\u4ee5\u5728 Yaml \u6587\u4ef6\u4e2d\u901a\u904e command \u548c args \u6216\u8005 \u74b0\u5883\u8b8a\u91cf \u7684\u65b9\u5f0f\u5be6\u73fe\u3002 kind : Pod spec : containers : - image : docker.io/nginx command : [ \"/bin/command\" ] args : [ \"arg1\" , \"arg2\" , \"arg3\" ] env : - name : INTERVAL value : \"30\" - name : FIRST_VAR value : \"foo\" - name : SECOND_VAR value : \"$(FIRST_VAR)bar\" \u53ef\u4ee5\u770b\u5230\uff0c\u6211\u5011\u53ef\u4ee5\u5229\u7528 env \u6a19\u7c64\u5411\u5bb9\u5668\u4e2d\u50b3\u905e\u74b0\u5883\u8b8a\u91cf\uff0c\u74b0\u5883\u8b8a\u91cf\u9084\u53ef\u4ee5\u76f8\u4e92\u5f15\u7528\u3002\u9019\u7a2e\u65b9\u5f0f\u7684\u554f\u984c\u5728\u65bc\u914d\u7f6e\u6587\u4ef6\u548c\u90e8\u7f72\u662f\u7d81\u5b9a\u7684\uff0c\u90a3\u9ebc\u5c0d\u65bc\u540c\u6a23\u7684\u61c9\u7528\uff0c\u6e2c\u8a66\u74b0\u5883\u7684\u53c3\u6578\u548c\u751f\u7522\u74b0\u5883\u662f\u4e0d\u4e00\u6a23\u7684\uff0c\u9019\u6a23\u5c31\u8981\u6c42\u5beb\u5169\u500b\u90e8\u7f72\u6587\u4ef6\uff0c\u7ba1\u7406\u8d77\u4f86\u4e0d\u662f\u5f88\u65b9\u4fbf\u3002 \u4e0a\u9762\u63d0\u5230\u7684\u4f8b\u5b50\uff0c\u5229\u7528 ConfigMap\u53ef \u4ee5\u89e3\u8026\u90e8\u7f72\u8207\u914d\u7f6e\u7684\u95dc\u4fc2\uff0c\u5c0d\u65bc\u540c\u4e00\u500b\u61c9\u7528\u90e8\u7f72\u6587\u4ef6\uff0c\u53ef\u4ee5\u5229\u7528valueFrom\u5b57\u6bb5\u5f15\u7528\u4e00\u500b\u5728\u6e2c\u8a66\u74b0\u5883\u548c\u751f\u7522\u74b0\u5883\u90fd\u6709\u7684ConfigMap\uff08\u7576\u7136\u914d\u7f6e\u5167\u5bb9\u4e0d\u76f8\u540c\uff0c\u53ea\u662f\u540d\u5b57\u76f8\u540c\uff09\uff0c\u5c31\u53ef\u4ee5\u964d\u4f4e\u74b0\u5883\u7ba1\u7406\u548c\u90e8\u7f72\u7684\u8907\u96dc\u5ea6\u3002 \u639b\u8f09\u70ba\u5bb9\u5668\u5167\u90e8\u7684\u6587\u4ef6\u6216\u76ee\u9304 : apiVersion : v1 kind : Pod metadata : name : nginx-test spec : containers : - image : nginx name : web-server volumeMounts : - name : config mountPath : /etc/someconfig.conf subPath : myconfig.conf volumes : - name : config configMap : name : <map-name> ConfigMap\u7684\u6ce8\u610f\u4e8b\u9805 : ConfigMap \u5fc5\u9808\u5728 Pod \u4e4b\u524d\u5275\u5efa ConfigMap \u5c6c\u65bc\u67d0\u500b NameSpace\uff0c\u53ea\u6709\u8655\u65bc\u76f8\u540c NameSpace \u7684 Pod \u624d\u53ef\u4ee5\u61c9\u7528\u5b83 ConfigMap \u4e2d\u7684 size \u4e0d\u80fd\u8d85\u904e 1 MiB \u5982\u679c\u662f volume \u7684\u5f62\u5f0f\u639b\u8f09\u5230\u5bb9\u5668\u5167\u90e8\uff0c\u7576\u8a2d\u5b9a\u639b\u8f09\u5230\u67d0\u500b\u76ee\u9304\u4e0b\u6642\uff0c\u8a72\u76ee\u9304\u4e0b\u539f\u6709\u7684\u6587\u4ef6\u6703\u88ab\u8986\u84cb\u6389(\u53ef\u642d\u914d\u4f7f\u7528 subPath \u4f86\u89e3\u6c7a) \u5275\u5efa \u00b6 ConfigMap \u7684\u5275\u5efa\u624b\u6cd5\u6709\u5f88\u591a\u7a2e: # \u4f7f\u7528 yaml \u7684\u8072\u660e\u65b9\u5f0f $ kubectl apply -f <configmap-file.yaml> # \u4f7f\u7528\u547d\u4ee4\u5275\u5efa $ kubectl create configmap <map-name> --from-literal = <parameter-name> = <parameter-value> $ kubectl create configmap <map-name> --from-literal = <parameter1> = <parameter1-value> --from-literal = <parameter2> = <parameter2-value> --from-literal = <parameter3> = <parameter3-value> # \u4f7f\u7528\u6587\u4ef6\u5275\u5efa configmap $ kubectl create configmap <map-name> --from-file = <file-path> # \u9084\u53ef\u4ee5\u5f9e\u4e00\u500b\u6587\u4ef6\u593e\u5275\u5efa configmap $ kubectl create configmap <map-name> --from-file = /path/to/dir 1. \u4f7f\u7528 yaml \u7684\u8072\u660e\u65b9\u5f0f \u00b6 \u53ef\u628a\u76f8\u95dc\u7684\u8a2d\u5b9a\u6a94\u6848\u5167\u5bb9\u76f4\u63a5\u4f7f\u7528 yaml \u4f86\u9032\u884c\u5ba3\u544a: cfmap-test00.yaml apiVersion : v1 data : my-nginx-config.conf : | server { listen 80; server_name www.kubia-example.com; gzip on; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } sleep-interval : | 25 kind : ConfigMap metadata : name : my-nginx-config \u4f7f\u7528 kubectl \u4f86\u5275\u5efa configmap: kubectl apply -f cfmap-test00.yaml \u8b93\u6211\u5011\u4f86\u6aa2\u67e5\u4e00\u4e0b\u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl describe cm/my-nginx-config Name: my-nginx-config Namespace: default Labels: <none> Annotations: <none> Data ==== my-nginx-config.conf: ---- server { listen 80 ; server_name www.kubia-example.com ; gzip on ; gzip_types text/plain application/xml ; location / { root /usr/share/nginx/html ; index index.html index.htm ; } } sleep-interval: ---- 25 BinaryData ==== Events: <none> 2. \u4f7f\u7528\u76ee\u9304\u6216\u6587\u4ef6\u5275\u5efa \u00b6 \u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl create configmap name --from-file= \u5f9e\u540c\u4e00\u76ee\u9304\u4e2d\u7684\u591a\u500b\u6587\u4ef6\u5275\u5efa ConfigMap\u3002 # \u5275\u5efa\u672c\u5730\u76ee\u9304 mkdir -p configure-pod-container/configmap/ cd configure-pod-container/configmap/ \u5c07\u6a23\u672c\u6587\u4ef6\u4e0b\u8f09\u5230 configure-pod-container/configmap/ \u76ee\u9304: wget https://kubernetes.io/examples/configmap/game.properties wget https://kubernetes.io/examples/configmap/ui.properties \u8b93\u6211\u5011\u770b\u4e00\u4e0b\u9019\u5169\u500b\u6a23\u672c\u8a2d\u5b9a\u6a94\u6587\u4ef6\u7684\u5167\u5bb9: game.properties enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 ui.properties color.good = purple color.bad = yellow allow.textmode = true how.nice.to.look = fairlyNice \u4f7f\u7528 kubectl create configmap <map-name> <data-source> \u547d\u4ee4\u4f86\u5275\u5efa configmap: # --from-file\u53ef\u4ee5\u63a5\u55ae\u500b\u6587\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u63a5\u55ae\u500b\u76ee\u9304 kubectl create cm game-config --from-file = ./ kubectl create cm game-config-2 --from-file = game.properties --from-file = ui.properties \u6aa2\u67e5\u904b\u884c\u7d50\u679c: $ kubectl get cm NAME DATA AGE game-config 2 8m18s game-config-2 2 39s \u6aa2\u8996 configmap: $ kubectl describe cm/game-config Name: game-config Namespace: default Labels: <none> Annotations: <none> Data ==== game.properties: ---- enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 ui.properties: ---- color.good = purple color.bad = yellow allow.textmode = true how.nice.to.look = fairlyNice BinaryData ==== Events: <none> \u4e5f\u53ef\u628a configmap \u7528 yaml \u7684\u683c\u5f0f\u4f86\u5c55\u73fe: $ kubectl get cm/game-config -o yaml apiVersion: v1 data: game.properties: | - enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 ui.properties: | color.good = purple color.bad = yellow allow.textmode = true how.nice.to.look = fairlyNice kind: ConfigMap metadata: creationTimestamp: \"2022-08-11T12:31:16Z\" name: game-config namespace: default resourceVersion: \"6231\" uid: 0de5e556-6809-482c-afab-1a696d27873a 3. \u5f9e env \u6587\u4ef6\u5275\u5efa \u00b6 \u7576\u4f7f\u7528\u591a\u500b --from-env-file \u4f86\u5f9e\u591a\u500b\u6578\u64da\u6e90\u5275\u5efa ConfigMap \u6642\uff0c\u50c5\u50c5\u6700\u5f8c\u4e00\u500b env \u6587\u4ef6\u6709\u6548: # \u74b0\u5883\u6587\u4ef6\u5305\u542b\u74b0\u5883\u8b8a\u91cf\u5217\u8868\u3002 # \u8a9e\u6cd5\u898f\u5247: # env \u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u884c\u5fc5\u9808\u70ba VAR = VAL \u683c\u5f0f\u3002 # \u4ee5\uff03\u958b\u982d\u7684\u884c(\u5373\u8a3b\u91cb)\u5c07\u88ab\u5ffd\u7565\u3002 # \u7a7a\u884c\u5c07\u88ab\u5ffd\u7565\u3002 # \u5f15\u865f\u6c92\u6709\u7279\u6b8a\u8655\u7406(\u5373\u5b83\u5011\u5c07\u6210\u70ba ConfigMap \u503c\u7684\u4e00\u90e8\u5206)\u3002 # \u5c07\u6a23\u672c\u6587\u4ef6\u4e0b\u8f09\u5230 `configure-pod-container/configmap/` \u76ee\u9304 wget https://kubernetes.io/examples/configmap/game-env-file.properties game-env-file.properties enemies = aliens lives = 3 allowed = \"true\" # This comment and the empty line above it are ignored \u4f7f\u7528 kubectl create configmap name --from-env-file= \u5f9e\u6587\u4ef6\u6a94\u4f86\u5275\u5efa ConfigMap\u3002 $ kubectl create configmap game-config-env-file --from-env-file = game-env-file.properties \u6aa2\u8996 configmap \u5167\u5bb9: $ kubectl get cm game-config-env-file -o yaml apiVersion: v1 data: allowed: '\"true\"' enemies: aliens lives: \"3\" kind: ConfigMap metadata: creationTimestamp: \"2020-02-09T02:38:37Z\" name: game-config-env-file namespace: default resourceVersion: \"1690565\" selfLink: /api/v1/namespaces/default/configmaps/game-config-env-file uid: 9594fa13-5b2c-4848-a88a-77e3d0fd0646 4. \u4f7f\u7528\u547d\u4ee4\u5275\u5efa \u00b6 \u53ef\u4ee5\u5c07 kubectl create configmap \u8207 --from-literal \u53c3\u6578\u4e00\u8d77\u4f7f\u7528\uff0c\u5f9e\u547d\u4ee4\u884c\u5b9a\u7fa9\u6587\u5b57\u503c: $ kubectl create configmap special-config --from-literal = special.how = very --from-literal = special.type = charm configmap/special-config created \u6aa2\u8996 configmap \u5167\u5bb9: $ kubectl get configmaps special-config -o yaml apiVersion: v1 data: special.how: very special.type: charm kind: ConfigMap metadata: creationTimestamp: \"2022-08-11T13:01:09Z\" name: special-config namespace: default resourceVersion: \"6596\" uid: fdc77599-685f-4caa-8fd8-3a3f8026b5c9 5. \u4f7f\u7528\u751f\u6210\u5668\u5275\u5efa \u00b6 \u4f7f\u7528 kustomize \u7684 configMapGenerator \u751f\u6210\u5668\u4f86\u5275\u5efa ConfigMap \u5c0d\u8c61\u3002 \u5275\u5efa kustomization.yaml \u8a2d\u5b9a\u6a94: cat <<EOF >./kustomization.yaml configMapGenerator: - name: game-config-4 files: - game.properties EOF \u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u4f86\u6aa2\u8996 kustomize \u751f\u6210\u7684 configmap: $ kustomize build ./ apiVersion: v1 data: game.properties: | - enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 kind: ConfigMap metadata: name: game-config-4-tbg7c4gc77 \u76f4\u63a5\u751f\u6210 configmap: $ kubectl create -k ./ configmap/game-config-4-tbg7c4gc77 created \u6216\u8005\u4e5f\u53ef\u4ee5\u4f7f\u7528\u751f\u6210\u5668\u4f86\u5be6\u73fe\u3002 cat <<EOF >./kustomization.yaml configMapGenerator: - name: special-config-2 literals: - special.how=very - special.type=charm EOF Tip \u53c3\u8003\uff1a \u4f7f\u7528 Kustomize \u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u8072\u660e\u5f0f\u7ba1\u7406 \u4f86\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 kubectl \u8207 kustomize \u4f86\u751f\u6210\u76f8\u95dc\u7684 kubernetes object \u5c0d\u8c61\u3002 \u4f7f\u7528 \u00b6 ConfigMap\u6709\u4e09\u7a2e\u7528\u6cd5\uff1a \u751f\u6210\u70ba\u5bb9\u5668\u5167\u7684\u74b0\u5883\u8b8a\u91cf \u8a2d\u7f6e\u5bb9\u5668\u555f\u52d5\u547d\u4ee4\u7684\u53c3\u6578 \u639b\u8f09\u70ba\u5bb9\u5668\u5167\u90e8\u7684\u6587\u4ef6\u6216\u76ee\u9304 1. \u66dd\u9732\u6210\u74b0\u5883\u8b8a\u91cf \u00b6 \u4f7f\u7528 configMapKeyRef \u6307\u5b9a\u8981\u5f9e\u67d0\u4e00\u500b configmap \u4e2d\u66dd\u9732\u90a3\u4e00\u500b\u7279\u5b9a\u7684\u9375\u503c\u6210\u74b0\u5883\u8b8a\u91cf\uff1a \u5275\u5efa cfmap-env-test01.yaml \u6a94\u6848: cfmap-env-test01.yaml apiVersion : v1 data : special.how : very special.type : charm kind : ConfigMap metadata : name : special-config --- apiVersion : v1 kind : Pod metadata : name : dapi-test-pod spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"env\" ] env : # Define the environment variable - name : SPECIAL_LEVEL_KEY valueFrom : configMapKeyRef : # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY name : special-config # Specify the key associated with the value key : special.how restartPolicy : Never \u4e0a\u8ff0 yaml \u8868\u793a\uff0c\u65b0\u5efa\u4e00\u500b\u540d\u70ba SPECIAL_LEVEL_KEY \u7684\u74b0\u5883\u8b8a\u91cf\uff0c\u5176\u503c\u6e90\u65bc configMap \u88e1\u9762\u7684 special.how \u3002 kubectl apply -f cfmap-env-test01.yaml \u8b93\u6211\u5011\u4f86\u6aa2\u67e5\u4e00\u4e0b Pod \u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl logs pods/dapi-test-pod KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.43.0.1:443 HOSTNAME = dapi-test-pod SHLVL = 1 HOME = /root KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp SPECIAL_LEVEL_KEY = very KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 PWD = / \u4e0a\u4e00\u500b\u4f8b\u5b50\u662f\u6709\u6307\u5b9a\u4e00\u500b\u5177\u9ad4\u7684KEY\uff0c\u5982\u679c\u6c92\u6709\u6307\u5b9a\u5462\uff1f cfmap-env-test02.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod2 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"env\" ] envFrom : - configMapRef : name : special-config restartPolicy : Never kubectl apply -f cfmap-env-test02.yaml \u8b93\u6211\u5011\u4f86\u6aa2\u67e5\u4e00\u4e0b Pod \u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl logs pods/dapi-test-pod2 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.43.0.1:443 HOSTNAME = dapi-test-pod2 SHLVL = 1 HOME = /root KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp special.type = charm KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 special.how = very KUBERNETES_SERVICE_HOST = 10 .43.0.1 PWD = / \u6ce8\u610f\u770b KEY \u8207 VALUE \u7684\u95dc\u4fc2\u3002 2. \u639b\u8f09\u6587\u4ef6\u76ee\u9304\u6cd5 \u00b6 \u53ef\u4ee5\u4f7f\u7528 volumeMounts \u65b9\u6cd5\u9032\u884c\u639b\u8f09\u3002 \u8b93\u6211\u5011\u5148\u770b\u4e00\u4e0b special-config \u9019\u500b configmap \u7684\u5167\u5bb9: $ kubectl get configmaps special-config -o yaml apiVersion: v1 data: special.how: very special.type: charm kind: ConfigMap metadata: creationTimestamp: \"2022-08-11T13:01:09Z\" name: special-config namespace: default resourceVersion: \"6596\" uid: fdc77599-685f-4caa-8fd8-3a3f8026b5c9 \u628a special-config \u639b\u8f09\u81f3 /etc/config \u76ee\u9304\u4e0b\u3002 pod-configmap-volume.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"ls /etc/config/;cat /etc/config/special.how;cat /etc/config/special.type\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume configMap : # Provide the name of the ConfigMap containing the files you want # to add to the container name : special-config restartPolicy : Never \u57f7\u884c\u547d\u4ee4\u8207\u6aa2\u67e5\u6210\u679c: # \u5275\u5efa pod $ kubectl create -f pod-configmap-volume.yaml pod/dapi-test-pod created # \u6aa2\u67e5 pod \u72c0\u614b $ kubectl get pod/dapi-test-pod NAME READY STATUS RESTARTS AGE dapi-test-pod 0 /1 Completed 0 119s # \u6aa2\u8996 configmap \u5167\u5bb9 $ kubectl describe cm special-config Name: special-config Namespace: default Labels: <none> Annotations: <none> Data ==== special.how: ---- very special.type: ---- charm BinaryData ==== Events: <none> # \u6aa2\u67e5 Pod \u57f7\u884c\u5b8c\u6210\u5f8c\u7684\u65e5\u8a8c $ kubectl logs pod/dapi-test-pod special.how special.type verycharm \u53ef\u4ee5\u770b\u5230\uff0c\u5176\u6bcf\u4e00\u500b KEY \u90fd\u662f\u6703\u751f\u6210\u4e00\u500b\u6587\u4ef6\uff0c\u6587\u4ef6\u7684\u5167\u5bb9\u70ba value \u7684\u503c\u3002 \u4e5f\u53ef\u4ee5\u639b\u8f09 configmap \u88e1\u982d\u55ae\u7368\u7684 KEY\uff1a pod-configmap-volume-specific-key.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod2 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"cat /etc/config/keys;sleep 600\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume configMap : name : special-config items : - key : special.how path : keys restartPolicy : Never \u5c07 KEY special.how \u639b\u8f09\u5230 /etc/config \u76ee\u9304\u4e0b\uff0c\u5176\u6587\u4ef6\u540d\u4f7f\u7528 path \u8b8a\u6210\u4e86 keys : $ kubectl apply -f pod-configmap-volume-specific-key.yaml pod/dapi-test-pod2 created $ kubectl exec -it pod/dapi-test-pod2 -- /bin/sh / # cat /etc/config/keys very/ # exit \u71b1\u66f4\u65b0\u7684\u554f\u984c \u00b6 confgimap \u66f4\u65b0\u5f8c\uff0c\u5982\u679c\u662f\u4ee5 \u6587\u4ef6\u593e \u65b9\u5f0f\u639b\u8f09\u7684\uff0c\u6703\u81ea\u52d5\u5c07\u639b\u8f09\u7684 Volume \u66f4\u65b0\u3002\u5982\u679c\u662f\u4ee5 \u6587\u4ef6\u5f62\u5f0f \u639b\u8f09\u7684\uff0c\u5247\u4e0d\u6703\u81ea\u52d5\u66f4\u65b0\u3002 \u4f46\u662f\u5c0d\u591a\u6578\u60c5\u6cc1\u7684\u61c9\u7528\u4f86\u8aaa\uff0c \u914d\u7f6e\u6587\u4ef6\u66f4\u65b0\u5f8c\uff0c\u6700\u7c21\u55ae\u7684\u8fa6\u6cd5\u5c31\u662f\u91cd\u555fPod\uff08\u6bba\u6389\u518d\u91cd\u65b0\u62c9\u8d77\uff09 \u3002 \u5982\u679c\u662f\u4ee5\u6587\u4ef6\u593e\u5f62\u5f0f\u639b\u8f09\u7684\uff0c\u53ef\u4ee5\u901a\u904e\u5728\u5bb9\u5668\u5167\u91cd\u555f\u61c9\u7528\u7684\u65b9\u5f0f\u5be6\u73fe\u914d\u7f6e\u6587\u4ef6\u66f4\u65b0\u751f\u6548\u3002\u5373\u4fbf\u662f\u91cd\u555f\u5bb9\u5668\u5167\u7684\u61c9\u7528\uff0c\u4e5f\u8981\u6ce8\u610f configmap \u7684\u66f4\u65b0\u548c\u5bb9\u5668\u5167\u639b\u8f09\u6587\u4ef6\u7684\u66f4\u65b0\u4e0d\u662f\u540c\u6b65\u7684\uff0c\u53ef\u80fd\u6703\u6709\u5ef6\u6642\uff0c\u56e0\u6b64\u4e00\u5b9a\u8981\u78ba\u4fdd\u5bb9\u5668\u5167\u7684\u914d\u7f6e\u4e5f\u5df2\u7d93\u66f4\u65b0\u70ba\u6700\u65b0\u7248\u672c\u5f8c\u518d\u91cd\u65b0\u52a0\u8f09\u61c9\u7528\u3002 \u4f7f\u7528 volumes \u639b\u8f09\u7684\u65b9\u5f0f\u662f\u53ef\u4ee5\u66f4\u65b0 configMap \u7684\uff0c\u4f46\u662f\u4f7f\u7528 env\u65b9 \u5f0f\u5c0e\u7d66 POD \u662f\u66f4\u65b0\u4e0d\u4e86\u7684\u3002 Secret \u00b6 Secret \u89e3\u6c7a\u4e86\u66f4\u65b0\u5bc6\u78bc\u3001\u4ee4\u724c\u3001\u5bc6\u9470\u7b49\u654f\u611f\u6578\u64da\u7684\u914d\u7f6e\u554f\u984c\uff0c\u800c\u4e0d\u662f\u9700\u8981\u5c07\u9019\u4e9b\u654f\u611f\u6578\u64da\u6d29\u9732\u5230\u6216 Pod Spec \u4e2d\u3002Secret \u53ef\u4ee5\u4ee5 Volume \u6216\u74b0\u5883\u8b8a\u91cf\u4f7f\u7528\u3002 Kubernetes \u70ba\u4e00\u4e9b\u5e38\u898b\u7684\u4f7f\u7528\u5834\u666f\u63d0\u4f9b\u4e86\u5e7e\u7a2e\u5167\u7f6e Secret \u985e\u578b\u3002\u9019\u4e9b\u985e\u578b\u5728\u57f7\u884c\u7684\u9a57\u8b49\u548c Kubernetes \u5c0d\u5b83\u5011\u65bd\u52a0\u7684\u7d04\u675f\u65b9\u9762\u6709\u6240\u4e0d\u540c\u3002 Secret \u7684\u985e\u578b\uff1a \u985e\u578b \u7528\u4f8b Opaque \u9810\u8a2d\u7684\u7684\u985e\u578b\u3002Base64 \u7de8\u78bc\u683c\u5f0f\u7684 Secret\uff0c\u7528\u4f86\u5b58\u5132\u5bc6\u78bc\u3001\u5bc6\u9470\u7b49\uff1b\u6578\u64da\u53ef\u901a\u904e base64 \u2013decode \u89e3\u78bc\u5f97\u5230\u539f\u59cb\u6578\u64da\uff0c\u6240\u4ee5\u52a0\u5bc6\u6027\u5f88\u5f31\u3002 kubernetes.io/service-account-token \u7528\u65bc\u88ab serviceaccount \u5f15\u7528\u3002 serviceaccout \u5275\u5efa\u6642 Kubernetes \u6703\u9ed8\u8a8d\u5275\u5efa\u5c0d\u61c9\u7684 secret\u3002 Pod \u5982\u679c\u4f7f\u7528\u4e86serviceaccount\uff0c\u5c0d\u61c9\u7684 secret \u6703\u81ea\u52d5\u639b\u8f09\u5230 Pod \u76ee\u9304 /run/secrets/kubernetes.io/serviceaccount \u4e2d\u3002 kubernetes.io/dockercfg ~/.dockercfg \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/dockerconfigjson ~/.docker/config.json \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/basic-auth \u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49 (Basic Auth)\u7684\u6191\u64da kubernetes.io/ssh-auth \u7528\u65bc SSH \u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da kubernetes.io/tls \u7528\u65bc TLS \u5ba2\u6236\u7aef\u6216\u8005\u670d\u52d9\u5668\u7aef\u7684\u6578\u64da bootstrap.kubernetes.io/token K8s \u7bc0\u9ede bootstrap \u4ee4\u724c\u6578\u64da Opaque \u985e\u578b \u00b6 Opaque \u985e\u578b\u7684\u6578\u64da\u662f\u4e00\u500b map \u985e\u578b\uff0c\u8981\u6c42 value \u662f base64 \u7de8\u78bc\u683c\u5f0f\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u7684\u5bc6\u78bc\u5177\u6709\u7279\u6b8a\u5b57\u7b26\uff0c\u5247\u9700\u8981\u4f7f\u7528 \\\\ \u5b57\u7b26\u5c0d\u5176\u9032\u884c\u8f49\u7fa9\u3002 \u6587\u4ef6\u5275\u5efa \u00b6 \u8b93\u6211\u5011\u67e5\u627e\u4e00\u4e0b\u4f7f\u7528 kubectl create secret \u7684\u76f8\u95dc\u547d\u4ee4: $ kubectl create secret generic --help Create a secret based on a file, directory, or specified literal value. A single secret may package one or more key/value pairs. When creating a secret based on a file, the key will default to the basename of the file, and the value will default to the file content. If the basename is an invalid key or you wish to chose your own, you may specify an alternate key. When creating a secret based on a directory, each file whose basename is a valid key in the directory will be packaged into the secret. Any directory entries except regular files are ignored ( e.g. subdirectories, symlinks, devices, pipes, etc ) . Examples: # Create a new secret named my-secret with keys for each file in folder bar kubectl create secret generic my-secret --from-file = path/to/bar # Create a new secret named my-secret with specified keys instead of names on disk kubectl create secret generic my-secret --from-file = ssh-privatekey = path/to/id_rsa --from-file = ssh-publickey = path/to/id_rsa.pub # Create a new secret named my-secret with key1=supersecret and key2=topsecret kubectl create secret generic my-secret --from-literal = key1 = supersecret --from-literal = key2 = topsecret # Create a new secret named my-secret using a combination of a file and a literal kubectl create secret generic my-secret --from-file = ssh-privatekey = path/to/id_rsa --from-literal = passphrase = topsecret # Create a new secret named my-secret from env files kubectl create secret generic my-secret --from-env-file = path/to/foo.env --from-env-file = path/to/bar.env \u5275\u5efa\u7bc4\u4f8b\u7684\u5e33\u5bc6\u6a94\u6848: $ echo -n 'admin' > ./username $ echo -n '12345' > ./password \u4f7f\u7528 kubectl create secret generic--from-file \u547d\u4ee4\u4f86\u5275\u5efa secret \u5c0d\u8c61: $ kubectl create secret generic db-user-pass --from-file = username --from-file = password secret/db-user-pass created \u6aa2\u8996 secret \u5c0d\u8c61: # \u6aa2\u7d22 secret $ kubectl get secret NAME TYPE DATA AGE default-token-dz4cv kubernetes.io/service-account-token 3 5h27m db-user-pass Opaque 2 71s # \u6aa2\u8996 secret \u5c0d\u8c61 $ kubectl get secret/db-user-pass -o yaml apiVersion: v1 data: password: MTIzNDU = username: YWRtaW4 = kind: Secret metadata: creationTimestamp: \"2022-08-12T07:54:19Z\" name: db-user-pass namespace: default resourceVersion: \"4763\" uid: edc0ca3d-4462-4419-93c3-1c6951b6b70b type: Opaque \u4f7f\u7528 kubectl create secret generic--from-literal \u547d\u4ee4\u4f86\u5275\u5efa secret \u5c0d\u8c61: $ kubectl create secret generic db-user-pass --from-literal=username=admin --from-literal=password=12345 secret/db-user-pass created \u6aa2\u8996 secret \u5c0d\u8c61: # \u6aa2\u7d22 secret $ kubectl get secret NAME TYPE DATA AGE default-token-dz4cv kubernetes.io/service-account-token 3 5h27m db-user-pass Opaque 2 71s # \u6aa2\u8996 secret \u5c0d\u8c61 $ kubectl get secret/db-user-pass -o yaml apiVersion: v1 data: password: MTIzNDU = username: YWRtaW4 = kind: Secret metadata: creationTimestamp: \"2022-08-12T07:54:19Z\" name: db-user-pass namespace: default resourceVersion: \"4763\" uid: edc0ca3d-4462-4419-93c3-1c6951b6b70b type: Opaque \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0ckubectl get \u548c kubectl describe \u662f\u4e0d\u6703\u986f\u793a\u5bc6\u78bc\u7684\u5167\u5bb9\u3002\u9019\u662f\u70ba\u4e86\u9632\u6b62\u6a5f\u5bc6\u88ab\u610f\u5916\u5730\u66b4\u9732\u7d66\u65c1\u89c0\u8005\u6216\u5b58\u5132\u5728\u7d42\u7aef\u65e5\u8a8c\u4e2d\u3002 \u624b\u5de5\u5275\u5efa \u00b6 Secret \u5c0d\u8c61\u4e5f\u53ef\u4ee5\u4f7f\u7528\u624b\u5de5\u4f86\u5275\u5efa\uff0c\u5982\u4e0b\uff1a $ echo -n 'admin' | base64 YWRtaW4 = $ echo -n '12345' | base64 MTIzNDU = \u73fe\u5728\u53ef\u4ee5\u50cf\u9019\u6a23\u5beb\u4e00\u500b secret \u5c0d\u8c61\uff1a apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : username : YWRtaW4= password : MTIzNDU= docker-registry secret \u00b6 Kubernetes \u5f9e\u79c1\u6709\u5bb9\u5668\u93e1\u8c61\u5009\u5eab\u62c9\u53d6\u93e1\u8c61\u7684\u6642\u5019\u9700\u8981\u76f8\u95dc\u7684\u914d\u7f6e\u76f8\u95dc\u7684\u5e33\u5bc6\u914d\u7f6e\u3002 \u53ef\u4ee5\u76f4\u63a5\u7528 kubectl \u547d\u4ee4\u4f86\u5275\u5efa\u7528\u65bc docker registry \u8a8d\u8b49\u7684 secret\uff1a $ kubectl create secret docker-registry myregistrykey --docker-server = DOCKER_REGISTRY_SERVER --docker-username = '*******' --docker-password = '*******' --docker-email = DOCKER_EMAIL ```` - docker-server \u79c1\u6709\u5bb9\u5668\u93e1\u8c61\u5009\u5eab\u5b8c\u5168\u9650\u5b9a\u57df\u540d\uff08FQDN\uff09 - docker-username \u8cec\u865f\u7528\u6236\u540d\uff0c\u9700\u8981\u7528\u55ae\u5f15\u865f\u62ec\u8d77\u4f86\u3002 - docker-password \u8cec\u865f token \u6216\u5bc6\u78bc\uff0c\u9700\u8981\u7528\u55ae\u5f15\u865f\u62ec\u8d77\u4f86\u3002 - docker-email \u7528\u6236\u96fb\u90f5 ( not required ) \u3002 \u4f8b\u5982: ``` bash $ kubectl create secret docker-registry loginharbor \\ --docker-email = tiger@acme.example \\ #\u53ef\u4ee5\u4e0d\u586b\u5199 --docker-username = admin \\ --docker-password = Harbor12345 \\ --docker-server = harbor.demo.com:5667 #harbor\u7684\u5730\u5740\u8981\u52a0\u7aef\u53e3 service-account-token \u00b6 \u7528\u65bc\u88ab serviceaccount \u5f15\u7528\u3002 serviceaccout \u5275\u5efa\u6642 Kubernetes \u6703\u9ed8\u8a8d\u5275\u5efa\u5c0d\u61c9\u7684 secret\u3002 Pod \u5982\u679c\u4f7f\u7528\u4e86 serviceaccount\uff0c\u5c0d\u61c9\u7684 secret \u6703\u81ea\u52d5\u639b\u8f09\u5230 Pod \u76ee\u9304 /run/secrets/kubernetes.io/serviceaccount \u4e2d\u3002 Secret \u662f\u4e00\u7a2e\u5305\u542b\u5c11\u91cf\u654f\u611f\u4fe1\u606f\u4f8b\u5982\u5bc6\u78bc\u3001token \u6216 key \u7684\u5c0d\u8c61\u3002\u9019\u6a23\u7684\u4fe1\u606f\u53ef\u80fd\u6703\u88ab\u653e\u5728 Pod spec \u4e2d\u6216\u8005\u93e1\u50cf\u4e2d\uff1b\u5c07\u5176\u653e\u5728\u4e00\u500b secret \u5c0d\u8c61\u4e2d\u53ef\u4ee5\u66f4\u597d\u5730\u63a7\u5236\u5b83\u7684\u7528\u9014\uff0c\u4e26\u964d\u4f4e\u610f\u5916\u66b4\u9732\u7684\u98a8\u96aa\u3002 \u5728 Kubernetes \u4e2d\u7684\u6bcf\u4e00\u500b Pod \u90fd\u6703\u6b78\u5c6c\u65bc\u67d0\u4e00\u500b SA\uff0c\u6bd4\u5982\uff1a $ kubectl get sa -n default -o yaml apiVersion: v1 items: - apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-08-12T02:27:55Z\" name: default namespace: default resourceVersion: \"435\" uid: fe177ee4-6af5-44de-a5c2-96baea7c83f6 secrets: - name: default-token-dz4cv kind: List metadata: resourceVersion: \"\" \u67e5\u770b Service account \u7684 secret: $ kubectl get secret default-token-dz4cv -o yaml apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyTmpBeU56RXlOVGd3SGhjTk1qSXdPREV5TURJeU56TTRXaGNOTXpJd09EQTVNREl5TnpNNApXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyTmpBeU56RXlOVGd3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFTbFd1Q0RHcEt5N09ya0JuUUFHK21ZcUtVTU9TeVJqZGlnUGxoRWZnZGEKYS9CT05BUW1SZjFjczJ1MUtUWDI4Q2JGc1VtSmlmRityS2xWS1pYVERpbVRvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVUpUT1Bxd1FTSUh4eWpoUWpJWnpECjJzbTlrMHd3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQUlWTVlCanpJZ2hGYjVqSjVZUGlVVW5NR2pNelhSSlgKLzdNbjFqUGRDU2xPQWlBWEt0S3VNYXcvSUZ6TFhFYXVlbnJLTWJlZDhPNFluV3ZkbGRRTzN0WE5tQT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K namespace: ZGVmYXVsdA == token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltazBhR0owUWtndFZUUlhURmx2V2tOdGNYUXdNbHBoVUhaZlZrVTBMVzlsY0hNd2JGOHhSWEZtU1djaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dFpIbzBZM1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbVpsTVRjM1pXVTBMVFpoWmpVdE5EUmtaUzFoTldNeUxUazJZbUZsWVRkak9ETm1OaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEudXJOR1ZvX2lzQnJSd3I2WTlnYkoxaGpqM29kTFpBbm9ZRVBtVG41eWRJSnZpWDNIYmxZSU9OazgzYTl3WjFZbjdzb1JlSHdrN3VSbzBrel90YkVua0tudGlzVHNheHZsOU1rMjVsTDk3bVpLTWF1dlFXZTBZWTU2NVhLb3FDSnFtVVRaVmRMTTNMNkxOMkFQRURhMEtZNW96djVfanFVZkdvTWlzdTVFRVloQ0JGMXBJbUtla1RUS3cwN3hhTmpzQ3dER3BlZXJPV1d5cmd1elFZdjU1OFM2WWw4dHozLVdYVHVMcFBIQ1R1S1E1OUtZUHltSkFXLVhZOHpCQmo2cV9kT3NYWEtrQjVLNk5GLUlJMWZRZUl4UXpyeGxhZjdYazk5OW1BSi0yQmE1eFAxaWp6SXJmTTMxb21qWldIcnBkNFIzSlhTQVdCUVJRV3lQSDNfTWJ3 kind: Secret metadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: fe177ee4-6af5-44de-a5c2-96baea7c83f6 creationTimestamp: \"2022-08-12T02:27:55Z\" name: default-token-dz4cv namespace: default resourceVersion: \"433\" uid: 0900cbfe-e27c-4d19-b6aa-3a368415f16f type: kubernetes.io/service-account-token \u4f7f\u7528 \u00b6 Secret \u53ef\u4ee5\u4f5c\u70ba\u6578\u64da\u5377\u88ab\u639b\u8f09\uff0c\u6216\u4f5c\u70ba\u74b0\u5883\u8b8a\u91cf\u66b4\u9732\u51fa\u4f86\u4ee5\u4f9b pod \u4e2d\u7684\u5bb9\u5668\u4f7f\u7528\u3002\u5b83\u5011\u4e5f\u53ef\u4ee5\u88ab\u7cfb\u7d71\u7684\u5176\u4ed6\u90e8\u5206\u4f7f\u7528\uff0c\u800c\u4e0d\u76f4\u63a5\u66b4\u9732\u5728 pod \u5167\u3002\u4f8b\u5982\uff0c\u5b83\u5011\u53ef\u4ee5\u4fdd\u5b58\u6191\u64da\uff0c\u7cfb\u7d71\u7684\u5176\u4ed6\u90e8\u5206\u61c9\u8a72\u7528\u5b83\u4f86\u4ee3\u8868\u60a8\u8207\u5916\u90e8\u7cfb\u7d71\u9032\u884c\u4ea4\u4e92\u3002 1. \u66dd\u9732\u6210\u74b0\u5883\u8b8a\u91cf \u00b6 \u4f7f\u7528 secretKeyRef \u6307\u5b9a\u8981\u5f9e\u67d0\u4e00\u500b secret \u4e2d\u66dd\u9732\u90a3\u4e00\u500b\u7279\u5b9a\u7684\u9375\u503c\u6210\u74b0\u5883\u8b8a\u91cf\uff1a \u5148\u6aa2\u8996 secret \u5c0d\u8c61: # \u6aa2\u8996 secret \u5c0d\u8c61 $ kubectl get secret/db-user-pass -o yaml apiVersion: v1 data: password: MTIzNDU = username: YWRtaW4 = kind: Secret metadata: creationTimestamp: \"2022-08-12T07:54:19Z\" name: db-user-pass namespace: default resourceVersion: \"4763\" uid: edc0ca3d-4462-4419-93c3-1c6951b6b70b type: Opaque \u5275\u5efa pod-env-secrets.yaml \u6a94\u6848: pod-env-secrets.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod3 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"env;echo ${SECRET_USERNAME} ${SECRET_PASSWORD}\" ] env : - name : SECRET_USERNAME valueFrom : secretKeyRef : name : db-user-pass key : username - name : SECRET_PASSWORD valueFrom : secretKeyRef : name : db-user-pass key : password restartPolicy : Never \u57f7\u884c\u547d\u4ee4: $ kubectl apply -f pod-env-secrets.yaml pod/dapi-test-pod3 created \u6aa2\u67e5\u7d50\u679c: $ kubectl get pod dapi-test-pod3 NAME READY STATUS RESTARTS AGE dapi-test-pod3 0 /1 Completed 0 21s $ kubectl logs dapi-test-pod3 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.43.0.1:443 HOSTNAME = dapi-test-pod3 SHLVL = 1 HOME = /root SECRET_PASSWORD = 12345 KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp SECRET_USERNAME = admin KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 PWD = / admin 12345 2. \u639b\u8f09\u6587\u4ef6\u76ee\u9304\u6cd5 \u00b6 \u53ef\u4ee5\u4f7f\u7528 volumeMounts \u65b9\u6cd5\u9032\u884c\u639b\u8f09\u3002 pod-volume-secrets.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod4 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"ls /etc/config;sleep 600\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume secret : secretName : db-user-pass restartPolicy : Never \u57f7\u884c\u547d\u4ee4\u8207\u6aa2\u67e5\u6210\u679c: # \u5275\u5efa pod $ kubectl create -f pod-volume-secrets.yaml pod/dapi-test-pod4 created # \u6aa2\u67e5 pod \u72c0\u614b $ kubectl get pod/dapi-test-pod4 NAME READY STATUS RESTARTS AGE dapi-test-pod4 1 /1 Running 0 7s # \u6aa2\u67e5 Pod \u7684\u65e5\u8a8c $ kubectl logs pod/dapi-test-pod4 password username # \u9032\u5230 Pod \u4e2d\u53bb\u6aa2\u67e5 $ kubectl exec -it dapi-test-pod4 -- /bin/sh \u4e5f\u53ef\u4ee5\u639b\u8f09 secret \u88e1\u982d\u55ae\u7368\u7684 KEY \u5230\u6307\u5b9a\u7684\u76ee\u9304\u4e0b\u3002 pod-volume-secrets2.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod5 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"ls /etc/config;sleep 600\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume secret : secretName : db-user-pass items : - key : username path : my-group/my-username restartPolicy : Never \u57f7\u884c\u547d\u4ee4\u8207\u6aa2\u67e5\u6210\u679c: # \u5275\u5efa pod $ kubectl apply -f pod-volume-secrets2.yaml pod/dapi-test-pod5 created # \u6aa2\u67e5 pod \u72c0\u614b $ kubectl get pod/dapi-test-pod5 NAME READY STATUS RESTARTS AGE dapi-test-pod5 1 /1 Running 0 7s # \u6aa2\u67e5 Pod \u7684\u65e5\u8a8c $ kubectl logs pod/dapi-test-pod5 my-group # \u9032\u5230 Pod \u4e2d\u53bb\u6aa2\u67e5 $ kubectl exec -it dapi-test-pod5 -- /bin/sh Tip Secrets \u7684\u7528\u6cd5\u662f\u8ddf ConfigMap \u57fa\u672c\u4e0a\u662f\u4e00\u81f4\uff0c\u5340\u5225\u4e0d\u540c\u662f ConfigMap \u662f\u660e\u6587\uff0c\u800c Secrets \u662f\u7d93\u904e base64 \u7de8\u78bc\u904e\u7684\u3002","title":"ConfigMap \u8207 Secret"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#configmap-secret","text":"\u539f\u6587: k8s\u5165\u95e8\u6559\u7a0b\u5341\u4e00:ConfigMap\u4e0esecrets","title":"ConfigMap \u8207 Secret"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#configmap","text":"ConfigMap \u5141\u8a31\u60a8\u5c07\u914d\u7f6e\u6587\u4ef6\u8207\u5bb9\u5668\u93e1\u50cf\u5206\u96e2\uff0c\u4ee5\u4f7f\u5bb9\u5668\u5316\u7684\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u53ef\u79fb\u690d\u6027\u3002\u672c\u6559\u7a0b\u63d0\u4f9b\u4e86\u4e00\u7cfb\u5217\u4f7f\u7528\u793a\u4f8b\uff0c\u9019\u4e9b\u793a\u4f8b\u6f14\u793a\u5982\u4f55\u4f7f\u7528\u5b58\u5132\u5728 ConfigMap \u4e2d\u7684\u6578\u64da\u5275\u5efa\u548c\u914d\u7f6e Pod\u3002 ConfigMap API\u7d66\u6211\u5011\u63d0\u4f9b\u4e86\u5411\u5bb9\u5668\u4e2d\u8a3b\u5165\u914d\u7f6e\u4fe1\u606f\u7684\u6a5f\u5236\uff0cConfigMap \u53ef\u4ee5\u88ab\u7528\u4f86\u4fdd\u5b58\u55ae\u500b\u5c6c\u6027\uff0c\u4e5f\u53ef\u4ee5\u7528\u4f86\u4fdd\u5b58\u6574\u500b\u914d\u7f6e\u6587\u4ef6\u6216\u8005 JSON \u4e8c\u9032\u5236\u5c0d\u8c61\u3002 \u914d\u7f6e\u6578\u64da\u53ef\u4ee5\u901a\u904e\u5f88\u591a\u7a2e\u65b9\u5f0f\u5728 Pods \u88e1\u88ab\u4f7f\u7528\u3002 ConfigMaps \u53ef\u4ee5\u88ab\u7528\u4f86\uff1a \u751f\u6210\u70ba\u5bb9\u5668\u5167\u7684\u74b0\u5883\u8b8a\u91cf \u8a2d\u7f6e\u5bb9\u5668\u555f\u52d5\u547d\u4ee4\u7684\u53c3\u6578 \u639b\u8f09\u70ba\u5bb9\u5668\u5167\u90e8\u7684\u6587\u4ef6\u6216\u76ee\u9304 \u5411\u5bb9\u5668\u50b3\u905e\u53c3\u6578 : \u5982\u679c\u9700\u8981\u5411\u5bb9\u5668\u50b3\u905e \u53c3\u6578 \uff0c\u53ef\u4ee5\u5728 Yaml \u6587\u4ef6\u4e2d\u901a\u904e command \u548c args \u6216\u8005 \u74b0\u5883\u8b8a\u91cf \u7684\u65b9\u5f0f\u5be6\u73fe\u3002 kind : Pod spec : containers : - image : docker.io/nginx command : [ \"/bin/command\" ] args : [ \"arg1\" , \"arg2\" , \"arg3\" ] env : - name : INTERVAL value : \"30\" - name : FIRST_VAR value : \"foo\" - name : SECOND_VAR value : \"$(FIRST_VAR)bar\" \u53ef\u4ee5\u770b\u5230\uff0c\u6211\u5011\u53ef\u4ee5\u5229\u7528 env \u6a19\u7c64\u5411\u5bb9\u5668\u4e2d\u50b3\u905e\u74b0\u5883\u8b8a\u91cf\uff0c\u74b0\u5883\u8b8a\u91cf\u9084\u53ef\u4ee5\u76f8\u4e92\u5f15\u7528\u3002\u9019\u7a2e\u65b9\u5f0f\u7684\u554f\u984c\u5728\u65bc\u914d\u7f6e\u6587\u4ef6\u548c\u90e8\u7f72\u662f\u7d81\u5b9a\u7684\uff0c\u90a3\u9ebc\u5c0d\u65bc\u540c\u6a23\u7684\u61c9\u7528\uff0c\u6e2c\u8a66\u74b0\u5883\u7684\u53c3\u6578\u548c\u751f\u7522\u74b0\u5883\u662f\u4e0d\u4e00\u6a23\u7684\uff0c\u9019\u6a23\u5c31\u8981\u6c42\u5beb\u5169\u500b\u90e8\u7f72\u6587\u4ef6\uff0c\u7ba1\u7406\u8d77\u4f86\u4e0d\u662f\u5f88\u65b9\u4fbf\u3002 \u4e0a\u9762\u63d0\u5230\u7684\u4f8b\u5b50\uff0c\u5229\u7528 ConfigMap\u53ef \u4ee5\u89e3\u8026\u90e8\u7f72\u8207\u914d\u7f6e\u7684\u95dc\u4fc2\uff0c\u5c0d\u65bc\u540c\u4e00\u500b\u61c9\u7528\u90e8\u7f72\u6587\u4ef6\uff0c\u53ef\u4ee5\u5229\u7528valueFrom\u5b57\u6bb5\u5f15\u7528\u4e00\u500b\u5728\u6e2c\u8a66\u74b0\u5883\u548c\u751f\u7522\u74b0\u5883\u90fd\u6709\u7684ConfigMap\uff08\u7576\u7136\u914d\u7f6e\u5167\u5bb9\u4e0d\u76f8\u540c\uff0c\u53ea\u662f\u540d\u5b57\u76f8\u540c\uff09\uff0c\u5c31\u53ef\u4ee5\u964d\u4f4e\u74b0\u5883\u7ba1\u7406\u548c\u90e8\u7f72\u7684\u8907\u96dc\u5ea6\u3002 \u639b\u8f09\u70ba\u5bb9\u5668\u5167\u90e8\u7684\u6587\u4ef6\u6216\u76ee\u9304 : apiVersion : v1 kind : Pod metadata : name : nginx-test spec : containers : - image : nginx name : web-server volumeMounts : - name : config mountPath : /etc/someconfig.conf subPath : myconfig.conf volumes : - name : config configMap : name : <map-name> ConfigMap\u7684\u6ce8\u610f\u4e8b\u9805 : ConfigMap \u5fc5\u9808\u5728 Pod \u4e4b\u524d\u5275\u5efa ConfigMap \u5c6c\u65bc\u67d0\u500b NameSpace\uff0c\u53ea\u6709\u8655\u65bc\u76f8\u540c NameSpace \u7684 Pod \u624d\u53ef\u4ee5\u61c9\u7528\u5b83 ConfigMap \u4e2d\u7684 size \u4e0d\u80fd\u8d85\u904e 1 MiB \u5982\u679c\u662f volume \u7684\u5f62\u5f0f\u639b\u8f09\u5230\u5bb9\u5668\u5167\u90e8\uff0c\u7576\u8a2d\u5b9a\u639b\u8f09\u5230\u67d0\u500b\u76ee\u9304\u4e0b\u6642\uff0c\u8a72\u76ee\u9304\u4e0b\u539f\u6709\u7684\u6587\u4ef6\u6703\u88ab\u8986\u84cb\u6389(\u53ef\u642d\u914d\u4f7f\u7528 subPath \u4f86\u89e3\u6c7a)","title":"ConfigMap"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#_1","text":"ConfigMap \u7684\u5275\u5efa\u624b\u6cd5\u6709\u5f88\u591a\u7a2e: # \u4f7f\u7528 yaml \u7684\u8072\u660e\u65b9\u5f0f $ kubectl apply -f <configmap-file.yaml> # \u4f7f\u7528\u547d\u4ee4\u5275\u5efa $ kubectl create configmap <map-name> --from-literal = <parameter-name> = <parameter-value> $ kubectl create configmap <map-name> --from-literal = <parameter1> = <parameter1-value> --from-literal = <parameter2> = <parameter2-value> --from-literal = <parameter3> = <parameter3-value> # \u4f7f\u7528\u6587\u4ef6\u5275\u5efa configmap $ kubectl create configmap <map-name> --from-file = <file-path> # \u9084\u53ef\u4ee5\u5f9e\u4e00\u500b\u6587\u4ef6\u593e\u5275\u5efa configmap $ kubectl create configmap <map-name> --from-file = /path/to/dir","title":"\u5275\u5efa"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#1-yaml","text":"\u53ef\u628a\u76f8\u95dc\u7684\u8a2d\u5b9a\u6a94\u6848\u5167\u5bb9\u76f4\u63a5\u4f7f\u7528 yaml \u4f86\u9032\u884c\u5ba3\u544a: cfmap-test00.yaml apiVersion : v1 data : my-nginx-config.conf : | server { listen 80; server_name www.kubia-example.com; gzip on; gzip_types text/plain application/xml; location / { root /usr/share/nginx/html; index index.html index.htm; } } sleep-interval : | 25 kind : ConfigMap metadata : name : my-nginx-config \u4f7f\u7528 kubectl \u4f86\u5275\u5efa configmap: kubectl apply -f cfmap-test00.yaml \u8b93\u6211\u5011\u4f86\u6aa2\u67e5\u4e00\u4e0b\u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl describe cm/my-nginx-config Name: my-nginx-config Namespace: default Labels: <none> Annotations: <none> Data ==== my-nginx-config.conf: ---- server { listen 80 ; server_name www.kubia-example.com ; gzip on ; gzip_types text/plain application/xml ; location / { root /usr/share/nginx/html ; index index.html index.htm ; } } sleep-interval: ---- 25 BinaryData ==== Events: <none>","title":"1. \u4f7f\u7528 yaml \u7684\u8072\u660e\u65b9\u5f0f"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#2","text":"\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl create configmap name --from-file= \u5f9e\u540c\u4e00\u76ee\u9304\u4e2d\u7684\u591a\u500b\u6587\u4ef6\u5275\u5efa ConfigMap\u3002 # \u5275\u5efa\u672c\u5730\u76ee\u9304 mkdir -p configure-pod-container/configmap/ cd configure-pod-container/configmap/ \u5c07\u6a23\u672c\u6587\u4ef6\u4e0b\u8f09\u5230 configure-pod-container/configmap/ \u76ee\u9304: wget https://kubernetes.io/examples/configmap/game.properties wget https://kubernetes.io/examples/configmap/ui.properties \u8b93\u6211\u5011\u770b\u4e00\u4e0b\u9019\u5169\u500b\u6a23\u672c\u8a2d\u5b9a\u6a94\u6587\u4ef6\u7684\u5167\u5bb9: game.properties enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 ui.properties color.good = purple color.bad = yellow allow.textmode = true how.nice.to.look = fairlyNice \u4f7f\u7528 kubectl create configmap <map-name> <data-source> \u547d\u4ee4\u4f86\u5275\u5efa configmap: # --from-file\u53ef\u4ee5\u63a5\u55ae\u500b\u6587\u4ef6\uff0c\u4e5f\u53ef\u4ee5\u63a5\u55ae\u500b\u76ee\u9304 kubectl create cm game-config --from-file = ./ kubectl create cm game-config-2 --from-file = game.properties --from-file = ui.properties \u6aa2\u67e5\u904b\u884c\u7d50\u679c: $ kubectl get cm NAME DATA AGE game-config 2 8m18s game-config-2 2 39s \u6aa2\u8996 configmap: $ kubectl describe cm/game-config Name: game-config Namespace: default Labels: <none> Annotations: <none> Data ==== game.properties: ---- enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 ui.properties: ---- color.good = purple color.bad = yellow allow.textmode = true how.nice.to.look = fairlyNice BinaryData ==== Events: <none> \u4e5f\u53ef\u628a configmap \u7528 yaml \u7684\u683c\u5f0f\u4f86\u5c55\u73fe: $ kubectl get cm/game-config -o yaml apiVersion: v1 data: game.properties: | - enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 ui.properties: | color.good = purple color.bad = yellow allow.textmode = true how.nice.to.look = fairlyNice kind: ConfigMap metadata: creationTimestamp: \"2022-08-11T12:31:16Z\" name: game-config namespace: default resourceVersion: \"6231\" uid: 0de5e556-6809-482c-afab-1a696d27873a","title":"2. \u4f7f\u7528\u76ee\u9304\u6216\u6587\u4ef6\u5275\u5efa"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#3-env","text":"\u7576\u4f7f\u7528\u591a\u500b --from-env-file \u4f86\u5f9e\u591a\u500b\u6578\u64da\u6e90\u5275\u5efa ConfigMap \u6642\uff0c\u50c5\u50c5\u6700\u5f8c\u4e00\u500b env \u6587\u4ef6\u6709\u6548: # \u74b0\u5883\u6587\u4ef6\u5305\u542b\u74b0\u5883\u8b8a\u91cf\u5217\u8868\u3002 # \u8a9e\u6cd5\u898f\u5247: # env \u6587\u4ef6\u4e2d\u7684\u6bcf\u4e00\u884c\u5fc5\u9808\u70ba VAR = VAL \u683c\u5f0f\u3002 # \u4ee5\uff03\u958b\u982d\u7684\u884c(\u5373\u8a3b\u91cb)\u5c07\u88ab\u5ffd\u7565\u3002 # \u7a7a\u884c\u5c07\u88ab\u5ffd\u7565\u3002 # \u5f15\u865f\u6c92\u6709\u7279\u6b8a\u8655\u7406(\u5373\u5b83\u5011\u5c07\u6210\u70ba ConfigMap \u503c\u7684\u4e00\u90e8\u5206)\u3002 # \u5c07\u6a23\u672c\u6587\u4ef6\u4e0b\u8f09\u5230 `configure-pod-container/configmap/` \u76ee\u9304 wget https://kubernetes.io/examples/configmap/game-env-file.properties game-env-file.properties enemies = aliens lives = 3 allowed = \"true\" # This comment and the empty line above it are ignored \u4f7f\u7528 kubectl create configmap name --from-env-file= \u5f9e\u6587\u4ef6\u6a94\u4f86\u5275\u5efa ConfigMap\u3002 $ kubectl create configmap game-config-env-file --from-env-file = game-env-file.properties \u6aa2\u8996 configmap \u5167\u5bb9: $ kubectl get cm game-config-env-file -o yaml apiVersion: v1 data: allowed: '\"true\"' enemies: aliens lives: \"3\" kind: ConfigMap metadata: creationTimestamp: \"2020-02-09T02:38:37Z\" name: game-config-env-file namespace: default resourceVersion: \"1690565\" selfLink: /api/v1/namespaces/default/configmaps/game-config-env-file uid: 9594fa13-5b2c-4848-a88a-77e3d0fd0646","title":"3. \u5f9e env \u6587\u4ef6\u5275\u5efa"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#4","text":"\u53ef\u4ee5\u5c07 kubectl create configmap \u8207 --from-literal \u53c3\u6578\u4e00\u8d77\u4f7f\u7528\uff0c\u5f9e\u547d\u4ee4\u884c\u5b9a\u7fa9\u6587\u5b57\u503c: $ kubectl create configmap special-config --from-literal = special.how = very --from-literal = special.type = charm configmap/special-config created \u6aa2\u8996 configmap \u5167\u5bb9: $ kubectl get configmaps special-config -o yaml apiVersion: v1 data: special.how: very special.type: charm kind: ConfigMap metadata: creationTimestamp: \"2022-08-11T13:01:09Z\" name: special-config namespace: default resourceVersion: \"6596\" uid: fdc77599-685f-4caa-8fd8-3a3f8026b5c9","title":"4. \u4f7f\u7528\u547d\u4ee4\u5275\u5efa"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#5","text":"\u4f7f\u7528 kustomize \u7684 configMapGenerator \u751f\u6210\u5668\u4f86\u5275\u5efa ConfigMap \u5c0d\u8c61\u3002 \u5275\u5efa kustomization.yaml \u8a2d\u5b9a\u6a94: cat <<EOF >./kustomization.yaml configMapGenerator: - name: game-config-4 files: - game.properties EOF \u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u4f86\u6aa2\u8996 kustomize \u751f\u6210\u7684 configmap: $ kustomize build ./ apiVersion: v1 data: game.properties: | - enemies = aliens lives = 3 enemies.cheat = true enemies.cheat.level = noGoodRotten secret.code.passphrase = UUDDLRLRBABAS secret.code.allowed = true secret.code.lives = 30 kind: ConfigMap metadata: name: game-config-4-tbg7c4gc77 \u76f4\u63a5\u751f\u6210 configmap: $ kubectl create -k ./ configmap/game-config-4-tbg7c4gc77 created \u6216\u8005\u4e5f\u53ef\u4ee5\u4f7f\u7528\u751f\u6210\u5668\u4f86\u5be6\u73fe\u3002 cat <<EOF >./kustomization.yaml configMapGenerator: - name: special-config-2 literals: - special.how=very - special.type=charm EOF Tip \u53c3\u8003\uff1a \u4f7f\u7528 Kustomize \u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u8072\u660e\u5f0f\u7ba1\u7406 \u4f86\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 kubectl \u8207 kustomize \u4f86\u751f\u6210\u76f8\u95dc\u7684 kubernetes object \u5c0d\u8c61\u3002","title":"5. \u4f7f\u7528\u751f\u6210\u5668\u5275\u5efa"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#_2","text":"ConfigMap\u6709\u4e09\u7a2e\u7528\u6cd5\uff1a \u751f\u6210\u70ba\u5bb9\u5668\u5167\u7684\u74b0\u5883\u8b8a\u91cf \u8a2d\u7f6e\u5bb9\u5668\u555f\u52d5\u547d\u4ee4\u7684\u53c3\u6578 \u639b\u8f09\u70ba\u5bb9\u5668\u5167\u90e8\u7684\u6587\u4ef6\u6216\u76ee\u9304","title":"\u4f7f\u7528"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#1","text":"\u4f7f\u7528 configMapKeyRef \u6307\u5b9a\u8981\u5f9e\u67d0\u4e00\u500b configmap \u4e2d\u66dd\u9732\u90a3\u4e00\u500b\u7279\u5b9a\u7684\u9375\u503c\u6210\u74b0\u5883\u8b8a\u91cf\uff1a \u5275\u5efa cfmap-env-test01.yaml \u6a94\u6848: cfmap-env-test01.yaml apiVersion : v1 data : special.how : very special.type : charm kind : ConfigMap metadata : name : special-config --- apiVersion : v1 kind : Pod metadata : name : dapi-test-pod spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"env\" ] env : # Define the environment variable - name : SPECIAL_LEVEL_KEY valueFrom : configMapKeyRef : # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY name : special-config # Specify the key associated with the value key : special.how restartPolicy : Never \u4e0a\u8ff0 yaml \u8868\u793a\uff0c\u65b0\u5efa\u4e00\u500b\u540d\u70ba SPECIAL_LEVEL_KEY \u7684\u74b0\u5883\u8b8a\u91cf\uff0c\u5176\u503c\u6e90\u65bc configMap \u88e1\u9762\u7684 special.how \u3002 kubectl apply -f cfmap-env-test01.yaml \u8b93\u6211\u5011\u4f86\u6aa2\u67e5\u4e00\u4e0b Pod \u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl logs pods/dapi-test-pod KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.43.0.1:443 HOSTNAME = dapi-test-pod SHLVL = 1 HOME = /root KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp SPECIAL_LEVEL_KEY = very KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 PWD = / \u4e0a\u4e00\u500b\u4f8b\u5b50\u662f\u6709\u6307\u5b9a\u4e00\u500b\u5177\u9ad4\u7684KEY\uff0c\u5982\u679c\u6c92\u6709\u6307\u5b9a\u5462\uff1f cfmap-env-test02.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod2 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"env\" ] envFrom : - configMapRef : name : special-config restartPolicy : Never kubectl apply -f cfmap-env-test02.yaml \u8b93\u6211\u5011\u4f86\u6aa2\u67e5\u4e00\u4e0b Pod \u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl logs pods/dapi-test-pod2 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.43.0.1:443 HOSTNAME = dapi-test-pod2 SHLVL = 1 HOME = /root KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp special.type = charm KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 special.how = very KUBERNETES_SERVICE_HOST = 10 .43.0.1 PWD = / \u6ce8\u610f\u770b KEY \u8207 VALUE \u7684\u95dc\u4fc2\u3002","title":"1. \u66dd\u9732\u6210\u74b0\u5883\u8b8a\u91cf"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#2_1","text":"\u53ef\u4ee5\u4f7f\u7528 volumeMounts \u65b9\u6cd5\u9032\u884c\u639b\u8f09\u3002 \u8b93\u6211\u5011\u5148\u770b\u4e00\u4e0b special-config \u9019\u500b configmap \u7684\u5167\u5bb9: $ kubectl get configmaps special-config -o yaml apiVersion: v1 data: special.how: very special.type: charm kind: ConfigMap metadata: creationTimestamp: \"2022-08-11T13:01:09Z\" name: special-config namespace: default resourceVersion: \"6596\" uid: fdc77599-685f-4caa-8fd8-3a3f8026b5c9 \u628a special-config \u639b\u8f09\u81f3 /etc/config \u76ee\u9304\u4e0b\u3002 pod-configmap-volume.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"ls /etc/config/;cat /etc/config/special.how;cat /etc/config/special.type\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume configMap : # Provide the name of the ConfigMap containing the files you want # to add to the container name : special-config restartPolicy : Never \u57f7\u884c\u547d\u4ee4\u8207\u6aa2\u67e5\u6210\u679c: # \u5275\u5efa pod $ kubectl create -f pod-configmap-volume.yaml pod/dapi-test-pod created # \u6aa2\u67e5 pod \u72c0\u614b $ kubectl get pod/dapi-test-pod NAME READY STATUS RESTARTS AGE dapi-test-pod 0 /1 Completed 0 119s # \u6aa2\u8996 configmap \u5167\u5bb9 $ kubectl describe cm special-config Name: special-config Namespace: default Labels: <none> Annotations: <none> Data ==== special.how: ---- very special.type: ---- charm BinaryData ==== Events: <none> # \u6aa2\u67e5 Pod \u57f7\u884c\u5b8c\u6210\u5f8c\u7684\u65e5\u8a8c $ kubectl logs pod/dapi-test-pod special.how special.type verycharm \u53ef\u4ee5\u770b\u5230\uff0c\u5176\u6bcf\u4e00\u500b KEY \u90fd\u662f\u6703\u751f\u6210\u4e00\u500b\u6587\u4ef6\uff0c\u6587\u4ef6\u7684\u5167\u5bb9\u70ba value \u7684\u503c\u3002 \u4e5f\u53ef\u4ee5\u639b\u8f09 configmap \u88e1\u982d\u55ae\u7368\u7684 KEY\uff1a pod-configmap-volume-specific-key.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod2 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"cat /etc/config/keys;sleep 600\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume configMap : name : special-config items : - key : special.how path : keys restartPolicy : Never \u5c07 KEY special.how \u639b\u8f09\u5230 /etc/config \u76ee\u9304\u4e0b\uff0c\u5176\u6587\u4ef6\u540d\u4f7f\u7528 path \u8b8a\u6210\u4e86 keys : $ kubectl apply -f pod-configmap-volume-specific-key.yaml pod/dapi-test-pod2 created $ kubectl exec -it pod/dapi-test-pod2 -- /bin/sh / # cat /etc/config/keys very/ # exit","title":"2. \u639b\u8f09\u6587\u4ef6\u76ee\u9304\u6cd5"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#_3","text":"confgimap \u66f4\u65b0\u5f8c\uff0c\u5982\u679c\u662f\u4ee5 \u6587\u4ef6\u593e \u65b9\u5f0f\u639b\u8f09\u7684\uff0c\u6703\u81ea\u52d5\u5c07\u639b\u8f09\u7684 Volume \u66f4\u65b0\u3002\u5982\u679c\u662f\u4ee5 \u6587\u4ef6\u5f62\u5f0f \u639b\u8f09\u7684\uff0c\u5247\u4e0d\u6703\u81ea\u52d5\u66f4\u65b0\u3002 \u4f46\u662f\u5c0d\u591a\u6578\u60c5\u6cc1\u7684\u61c9\u7528\u4f86\u8aaa\uff0c \u914d\u7f6e\u6587\u4ef6\u66f4\u65b0\u5f8c\uff0c\u6700\u7c21\u55ae\u7684\u8fa6\u6cd5\u5c31\u662f\u91cd\u555fPod\uff08\u6bba\u6389\u518d\u91cd\u65b0\u62c9\u8d77\uff09 \u3002 \u5982\u679c\u662f\u4ee5\u6587\u4ef6\u593e\u5f62\u5f0f\u639b\u8f09\u7684\uff0c\u53ef\u4ee5\u901a\u904e\u5728\u5bb9\u5668\u5167\u91cd\u555f\u61c9\u7528\u7684\u65b9\u5f0f\u5be6\u73fe\u914d\u7f6e\u6587\u4ef6\u66f4\u65b0\u751f\u6548\u3002\u5373\u4fbf\u662f\u91cd\u555f\u5bb9\u5668\u5167\u7684\u61c9\u7528\uff0c\u4e5f\u8981\u6ce8\u610f configmap \u7684\u66f4\u65b0\u548c\u5bb9\u5668\u5167\u639b\u8f09\u6587\u4ef6\u7684\u66f4\u65b0\u4e0d\u662f\u540c\u6b65\u7684\uff0c\u53ef\u80fd\u6703\u6709\u5ef6\u6642\uff0c\u56e0\u6b64\u4e00\u5b9a\u8981\u78ba\u4fdd\u5bb9\u5668\u5167\u7684\u914d\u7f6e\u4e5f\u5df2\u7d93\u66f4\u65b0\u70ba\u6700\u65b0\u7248\u672c\u5f8c\u518d\u91cd\u65b0\u52a0\u8f09\u61c9\u7528\u3002 \u4f7f\u7528 volumes \u639b\u8f09\u7684\u65b9\u5f0f\u662f\u53ef\u4ee5\u66f4\u65b0 configMap \u7684\uff0c\u4f46\u662f\u4f7f\u7528 env\u65b9 \u5f0f\u5c0e\u7d66 POD \u662f\u66f4\u65b0\u4e0d\u4e86\u7684\u3002","title":"\u71b1\u66f4\u65b0\u7684\u554f\u984c"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#secret","text":"Secret \u89e3\u6c7a\u4e86\u66f4\u65b0\u5bc6\u78bc\u3001\u4ee4\u724c\u3001\u5bc6\u9470\u7b49\u654f\u611f\u6578\u64da\u7684\u914d\u7f6e\u554f\u984c\uff0c\u800c\u4e0d\u662f\u9700\u8981\u5c07\u9019\u4e9b\u654f\u611f\u6578\u64da\u6d29\u9732\u5230\u6216 Pod Spec \u4e2d\u3002Secret \u53ef\u4ee5\u4ee5 Volume \u6216\u74b0\u5883\u8b8a\u91cf\u4f7f\u7528\u3002 Kubernetes \u70ba\u4e00\u4e9b\u5e38\u898b\u7684\u4f7f\u7528\u5834\u666f\u63d0\u4f9b\u4e86\u5e7e\u7a2e\u5167\u7f6e Secret \u985e\u578b\u3002\u9019\u4e9b\u985e\u578b\u5728\u57f7\u884c\u7684\u9a57\u8b49\u548c Kubernetes \u5c0d\u5b83\u5011\u65bd\u52a0\u7684\u7d04\u675f\u65b9\u9762\u6709\u6240\u4e0d\u540c\u3002 Secret \u7684\u985e\u578b\uff1a \u985e\u578b \u7528\u4f8b Opaque \u9810\u8a2d\u7684\u7684\u985e\u578b\u3002Base64 \u7de8\u78bc\u683c\u5f0f\u7684 Secret\uff0c\u7528\u4f86\u5b58\u5132\u5bc6\u78bc\u3001\u5bc6\u9470\u7b49\uff1b\u6578\u64da\u53ef\u901a\u904e base64 \u2013decode \u89e3\u78bc\u5f97\u5230\u539f\u59cb\u6578\u64da\uff0c\u6240\u4ee5\u52a0\u5bc6\u6027\u5f88\u5f31\u3002 kubernetes.io/service-account-token \u7528\u65bc\u88ab serviceaccount \u5f15\u7528\u3002 serviceaccout \u5275\u5efa\u6642 Kubernetes \u6703\u9ed8\u8a8d\u5275\u5efa\u5c0d\u61c9\u7684 secret\u3002 Pod \u5982\u679c\u4f7f\u7528\u4e86serviceaccount\uff0c\u5c0d\u61c9\u7684 secret \u6703\u81ea\u52d5\u639b\u8f09\u5230 Pod \u76ee\u9304 /run/secrets/kubernetes.io/serviceaccount \u4e2d\u3002 kubernetes.io/dockercfg ~/.dockercfg \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/dockerconfigjson ~/.docker/config.json \u6587\u4ef6\u7684\u5e8f\u5217\u5316\u5f62\u5f0f\uff0c\u7528\u4f86\u5b58\u5132\u79c1\u6709 docker registry \u7684\u8a8d\u8b49\u4fe1\u606f kubernetes.io/basic-auth \u7528\u65bc\u57fa\u672c\u8eab\u4efd\u8a8d\u8b49 (Basic Auth)\u7684\u6191\u64da kubernetes.io/ssh-auth \u7528\u65bc SSH \u8eab\u4efd\u8a8d\u8b49\u7684\u6191\u64da kubernetes.io/tls \u7528\u65bc TLS \u5ba2\u6236\u7aef\u6216\u8005\u670d\u52d9\u5668\u7aef\u7684\u6578\u64da bootstrap.kubernetes.io/token K8s \u7bc0\u9ede bootstrap \u4ee4\u724c\u6578\u64da","title":"Secret"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#opaque","text":"Opaque \u985e\u578b\u7684\u6578\u64da\u662f\u4e00\u500b map \u985e\u578b\uff0c\u8981\u6c42 value \u662f base64 \u7de8\u78bc\u683c\u5f0f\uff0c\u5982\u679c\u60a8\u4f7f\u7528\u7684\u5bc6\u78bc\u5177\u6709\u7279\u6b8a\u5b57\u7b26\uff0c\u5247\u9700\u8981\u4f7f\u7528 \\\\ \u5b57\u7b26\u5c0d\u5176\u9032\u884c\u8f49\u7fa9\u3002","title":"Opaque \u985e\u578b"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#_4","text":"\u8b93\u6211\u5011\u67e5\u627e\u4e00\u4e0b\u4f7f\u7528 kubectl create secret \u7684\u76f8\u95dc\u547d\u4ee4: $ kubectl create secret generic --help Create a secret based on a file, directory, or specified literal value. A single secret may package one or more key/value pairs. When creating a secret based on a file, the key will default to the basename of the file, and the value will default to the file content. If the basename is an invalid key or you wish to chose your own, you may specify an alternate key. When creating a secret based on a directory, each file whose basename is a valid key in the directory will be packaged into the secret. Any directory entries except regular files are ignored ( e.g. subdirectories, symlinks, devices, pipes, etc ) . Examples: # Create a new secret named my-secret with keys for each file in folder bar kubectl create secret generic my-secret --from-file = path/to/bar # Create a new secret named my-secret with specified keys instead of names on disk kubectl create secret generic my-secret --from-file = ssh-privatekey = path/to/id_rsa --from-file = ssh-publickey = path/to/id_rsa.pub # Create a new secret named my-secret with key1=supersecret and key2=topsecret kubectl create secret generic my-secret --from-literal = key1 = supersecret --from-literal = key2 = topsecret # Create a new secret named my-secret using a combination of a file and a literal kubectl create secret generic my-secret --from-file = ssh-privatekey = path/to/id_rsa --from-literal = passphrase = topsecret # Create a new secret named my-secret from env files kubectl create secret generic my-secret --from-env-file = path/to/foo.env --from-env-file = path/to/bar.env \u5275\u5efa\u7bc4\u4f8b\u7684\u5e33\u5bc6\u6a94\u6848: $ echo -n 'admin' > ./username $ echo -n '12345' > ./password \u4f7f\u7528 kubectl create secret generic--from-file \u547d\u4ee4\u4f86\u5275\u5efa secret \u5c0d\u8c61: $ kubectl create secret generic db-user-pass --from-file = username --from-file = password secret/db-user-pass created \u6aa2\u8996 secret \u5c0d\u8c61: # \u6aa2\u7d22 secret $ kubectl get secret NAME TYPE DATA AGE default-token-dz4cv kubernetes.io/service-account-token 3 5h27m db-user-pass Opaque 2 71s # \u6aa2\u8996 secret \u5c0d\u8c61 $ kubectl get secret/db-user-pass -o yaml apiVersion: v1 data: password: MTIzNDU = username: YWRtaW4 = kind: Secret metadata: creationTimestamp: \"2022-08-12T07:54:19Z\" name: db-user-pass namespace: default resourceVersion: \"4763\" uid: edc0ca3d-4462-4419-93c3-1c6951b6b70b type: Opaque \u4f7f\u7528 kubectl create secret generic--from-literal \u547d\u4ee4\u4f86\u5275\u5efa secret \u5c0d\u8c61: $ kubectl create secret generic db-user-pass --from-literal=username=admin --from-literal=password=12345 secret/db-user-pass created \u6aa2\u8996 secret \u5c0d\u8c61: # \u6aa2\u7d22 secret $ kubectl get secret NAME TYPE DATA AGE default-token-dz4cv kubernetes.io/service-account-token 3 5h27m db-user-pass Opaque 2 71s # \u6aa2\u8996 secret \u5c0d\u8c61 $ kubectl get secret/db-user-pass -o yaml apiVersion: v1 data: password: MTIzNDU = username: YWRtaW4 = kind: Secret metadata: creationTimestamp: \"2022-08-12T07:54:19Z\" name: db-user-pass namespace: default resourceVersion: \"4763\" uid: edc0ca3d-4462-4419-93c3-1c6951b6b70b type: Opaque \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0ckubectl get \u548c kubectl describe \u662f\u4e0d\u6703\u986f\u793a\u5bc6\u78bc\u7684\u5167\u5bb9\u3002\u9019\u662f\u70ba\u4e86\u9632\u6b62\u6a5f\u5bc6\u88ab\u610f\u5916\u5730\u66b4\u9732\u7d66\u65c1\u89c0\u8005\u6216\u5b58\u5132\u5728\u7d42\u7aef\u65e5\u8a8c\u4e2d\u3002","title":"\u6587\u4ef6\u5275\u5efa"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#_5","text":"Secret \u5c0d\u8c61\u4e5f\u53ef\u4ee5\u4f7f\u7528\u624b\u5de5\u4f86\u5275\u5efa\uff0c\u5982\u4e0b\uff1a $ echo -n 'admin' | base64 YWRtaW4 = $ echo -n '12345' | base64 MTIzNDU = \u73fe\u5728\u53ef\u4ee5\u50cf\u9019\u6a23\u5beb\u4e00\u500b secret \u5c0d\u8c61\uff1a apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : username : YWRtaW4= password : MTIzNDU=","title":"\u624b\u5de5\u5275\u5efa"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#docker-registry-secret","text":"Kubernetes \u5f9e\u79c1\u6709\u5bb9\u5668\u93e1\u8c61\u5009\u5eab\u62c9\u53d6\u93e1\u8c61\u7684\u6642\u5019\u9700\u8981\u76f8\u95dc\u7684\u914d\u7f6e\u76f8\u95dc\u7684\u5e33\u5bc6\u914d\u7f6e\u3002 \u53ef\u4ee5\u76f4\u63a5\u7528 kubectl \u547d\u4ee4\u4f86\u5275\u5efa\u7528\u65bc docker registry \u8a8d\u8b49\u7684 secret\uff1a $ kubectl create secret docker-registry myregistrykey --docker-server = DOCKER_REGISTRY_SERVER --docker-username = '*******' --docker-password = '*******' --docker-email = DOCKER_EMAIL ```` - docker-server \u79c1\u6709\u5bb9\u5668\u93e1\u8c61\u5009\u5eab\u5b8c\u5168\u9650\u5b9a\u57df\u540d\uff08FQDN\uff09 - docker-username \u8cec\u865f\u7528\u6236\u540d\uff0c\u9700\u8981\u7528\u55ae\u5f15\u865f\u62ec\u8d77\u4f86\u3002 - docker-password \u8cec\u865f token \u6216\u5bc6\u78bc\uff0c\u9700\u8981\u7528\u55ae\u5f15\u865f\u62ec\u8d77\u4f86\u3002 - docker-email \u7528\u6236\u96fb\u90f5 ( not required ) \u3002 \u4f8b\u5982: ``` bash $ kubectl create secret docker-registry loginharbor \\ --docker-email = tiger@acme.example \\ #\u53ef\u4ee5\u4e0d\u586b\u5199 --docker-username = admin \\ --docker-password = Harbor12345 \\ --docker-server = harbor.demo.com:5667 #harbor\u7684\u5730\u5740\u8981\u52a0\u7aef\u53e3","title":"docker-registry secret"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#service-account-token","text":"\u7528\u65bc\u88ab serviceaccount \u5f15\u7528\u3002 serviceaccout \u5275\u5efa\u6642 Kubernetes \u6703\u9ed8\u8a8d\u5275\u5efa\u5c0d\u61c9\u7684 secret\u3002 Pod \u5982\u679c\u4f7f\u7528\u4e86 serviceaccount\uff0c\u5c0d\u61c9\u7684 secret \u6703\u81ea\u52d5\u639b\u8f09\u5230 Pod \u76ee\u9304 /run/secrets/kubernetes.io/serviceaccount \u4e2d\u3002 Secret \u662f\u4e00\u7a2e\u5305\u542b\u5c11\u91cf\u654f\u611f\u4fe1\u606f\u4f8b\u5982\u5bc6\u78bc\u3001token \u6216 key \u7684\u5c0d\u8c61\u3002\u9019\u6a23\u7684\u4fe1\u606f\u53ef\u80fd\u6703\u88ab\u653e\u5728 Pod spec \u4e2d\u6216\u8005\u93e1\u50cf\u4e2d\uff1b\u5c07\u5176\u653e\u5728\u4e00\u500b secret \u5c0d\u8c61\u4e2d\u53ef\u4ee5\u66f4\u597d\u5730\u63a7\u5236\u5b83\u7684\u7528\u9014\uff0c\u4e26\u964d\u4f4e\u610f\u5916\u66b4\u9732\u7684\u98a8\u96aa\u3002 \u5728 Kubernetes \u4e2d\u7684\u6bcf\u4e00\u500b Pod \u90fd\u6703\u6b78\u5c6c\u65bc\u67d0\u4e00\u500b SA\uff0c\u6bd4\u5982\uff1a $ kubectl get sa -n default -o yaml apiVersion: v1 items: - apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-08-12T02:27:55Z\" name: default namespace: default resourceVersion: \"435\" uid: fe177ee4-6af5-44de-a5c2-96baea7c83f6 secrets: - name: default-token-dz4cv kind: List metadata: resourceVersion: \"\" \u67e5\u770b Service account \u7684 secret: $ kubectl get secret default-token-dz4cv -o yaml apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyTmpBeU56RXlOVGd3SGhjTk1qSXdPREV5TURJeU56TTRXaGNOTXpJd09EQTVNREl5TnpNNApXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyTmpBeU56RXlOVGd3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFTbFd1Q0RHcEt5N09ya0JuUUFHK21ZcUtVTU9TeVJqZGlnUGxoRWZnZGEKYS9CT05BUW1SZjFjczJ1MUtUWDI4Q2JGc1VtSmlmRityS2xWS1pYVERpbVRvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVUpUT1Bxd1FTSUh4eWpoUWpJWnpECjJzbTlrMHd3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQUlWTVlCanpJZ2hGYjVqSjVZUGlVVW5NR2pNelhSSlgKLzdNbjFqUGRDU2xPQWlBWEt0S3VNYXcvSUZ6TFhFYXVlbnJLTWJlZDhPNFluV3ZkbGRRTzN0WE5tQT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K namespace: ZGVmYXVsdA == token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltazBhR0owUWtndFZUUlhURmx2V2tOdGNYUXdNbHBoVUhaZlZrVTBMVzlsY0hNd2JGOHhSWEZtU1djaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dFpIbzBZM1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbVpsTVRjM1pXVTBMVFpoWmpVdE5EUmtaUzFoTldNeUxUazJZbUZsWVRkak9ETm1OaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEudXJOR1ZvX2lzQnJSd3I2WTlnYkoxaGpqM29kTFpBbm9ZRVBtVG41eWRJSnZpWDNIYmxZSU9OazgzYTl3WjFZbjdzb1JlSHdrN3VSbzBrel90YkVua0tudGlzVHNheHZsOU1rMjVsTDk3bVpLTWF1dlFXZTBZWTU2NVhLb3FDSnFtVVRaVmRMTTNMNkxOMkFQRURhMEtZNW96djVfanFVZkdvTWlzdTVFRVloQ0JGMXBJbUtla1RUS3cwN3hhTmpzQ3dER3BlZXJPV1d5cmd1elFZdjU1OFM2WWw4dHozLVdYVHVMcFBIQ1R1S1E1OUtZUHltSkFXLVhZOHpCQmo2cV9kT3NYWEtrQjVLNk5GLUlJMWZRZUl4UXpyeGxhZjdYazk5OW1BSi0yQmE1eFAxaWp6SXJmTTMxb21qWldIcnBkNFIzSlhTQVdCUVJRV3lQSDNfTWJ3 kind: Secret metadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: fe177ee4-6af5-44de-a5c2-96baea7c83f6 creationTimestamp: \"2022-08-12T02:27:55Z\" name: default-token-dz4cv namespace: default resourceVersion: \"433\" uid: 0900cbfe-e27c-4d19-b6aa-3a368415f16f type: kubernetes.io/service-account-token","title":"service-account-token"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#_6","text":"Secret \u53ef\u4ee5\u4f5c\u70ba\u6578\u64da\u5377\u88ab\u639b\u8f09\uff0c\u6216\u4f5c\u70ba\u74b0\u5883\u8b8a\u91cf\u66b4\u9732\u51fa\u4f86\u4ee5\u4f9b pod \u4e2d\u7684\u5bb9\u5668\u4f7f\u7528\u3002\u5b83\u5011\u4e5f\u53ef\u4ee5\u88ab\u7cfb\u7d71\u7684\u5176\u4ed6\u90e8\u5206\u4f7f\u7528\uff0c\u800c\u4e0d\u76f4\u63a5\u66b4\u9732\u5728 pod \u5167\u3002\u4f8b\u5982\uff0c\u5b83\u5011\u53ef\u4ee5\u4fdd\u5b58\u6191\u64da\uff0c\u7cfb\u7d71\u7684\u5176\u4ed6\u90e8\u5206\u61c9\u8a72\u7528\u5b83\u4f86\u4ee3\u8868\u60a8\u8207\u5916\u90e8\u7cfb\u7d71\u9032\u884c\u4ea4\u4e92\u3002","title":"\u4f7f\u7528"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#1_1","text":"\u4f7f\u7528 secretKeyRef \u6307\u5b9a\u8981\u5f9e\u67d0\u4e00\u500b secret \u4e2d\u66dd\u9732\u90a3\u4e00\u500b\u7279\u5b9a\u7684\u9375\u503c\u6210\u74b0\u5883\u8b8a\u91cf\uff1a \u5148\u6aa2\u8996 secret \u5c0d\u8c61: # \u6aa2\u8996 secret \u5c0d\u8c61 $ kubectl get secret/db-user-pass -o yaml apiVersion: v1 data: password: MTIzNDU = username: YWRtaW4 = kind: Secret metadata: creationTimestamp: \"2022-08-12T07:54:19Z\" name: db-user-pass namespace: default resourceVersion: \"4763\" uid: edc0ca3d-4462-4419-93c3-1c6951b6b70b type: Opaque \u5275\u5efa pod-env-secrets.yaml \u6a94\u6848: pod-env-secrets.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod3 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"env;echo ${SECRET_USERNAME} ${SECRET_PASSWORD}\" ] env : - name : SECRET_USERNAME valueFrom : secretKeyRef : name : db-user-pass key : username - name : SECRET_PASSWORD valueFrom : secretKeyRef : name : db-user-pass key : password restartPolicy : Never \u57f7\u884c\u547d\u4ee4: $ kubectl apply -f pod-env-secrets.yaml pod/dapi-test-pod3 created \u6aa2\u67e5\u7d50\u679c: $ kubectl get pod dapi-test-pod3 NAME READY STATUS RESTARTS AGE dapi-test-pod3 0 /1 Completed 0 21s $ kubectl logs dapi-test-pod3 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.43.0.1:443 HOSTNAME = dapi-test-pod3 SHLVL = 1 HOME = /root SECRET_PASSWORD = 12345 KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp SECRET_USERNAME = admin KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 PWD = / admin 12345","title":"1. \u66dd\u9732\u6210\u74b0\u5883\u8b8a\u91cf"},{"location":"kubernetes/04-tutorials/configuration/configmap-secrets/#2_2","text":"\u53ef\u4ee5\u4f7f\u7528 volumeMounts \u65b9\u6cd5\u9032\u884c\u639b\u8f09\u3002 pod-volume-secrets.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod4 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"ls /etc/config;sleep 600\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume secret : secretName : db-user-pass restartPolicy : Never \u57f7\u884c\u547d\u4ee4\u8207\u6aa2\u67e5\u6210\u679c: # \u5275\u5efa pod $ kubectl create -f pod-volume-secrets.yaml pod/dapi-test-pod4 created # \u6aa2\u67e5 pod \u72c0\u614b $ kubectl get pod/dapi-test-pod4 NAME READY STATUS RESTARTS AGE dapi-test-pod4 1 /1 Running 0 7s # \u6aa2\u67e5 Pod \u7684\u65e5\u8a8c $ kubectl logs pod/dapi-test-pod4 password username # \u9032\u5230 Pod \u4e2d\u53bb\u6aa2\u67e5 $ kubectl exec -it dapi-test-pod4 -- /bin/sh \u4e5f\u53ef\u4ee5\u639b\u8f09 secret \u88e1\u982d\u55ae\u7368\u7684 KEY \u5230\u6307\u5b9a\u7684\u76ee\u9304\u4e0b\u3002 pod-volume-secrets2.yaml apiVersion : v1 kind : Pod metadata : name : dapi-test-pod5 spec : containers : - name : test-container image : busybox command : [ \"/bin/sh\" , \"-c\" , \"ls /etc/config;sleep 600\" ] volumeMounts : - name : config-volume mountPath : /etc/config volumes : - name : config-volume secret : secretName : db-user-pass items : - key : username path : my-group/my-username restartPolicy : Never \u57f7\u884c\u547d\u4ee4\u8207\u6aa2\u67e5\u6210\u679c: # \u5275\u5efa pod $ kubectl apply -f pod-volume-secrets2.yaml pod/dapi-test-pod5 created # \u6aa2\u67e5 pod \u72c0\u614b $ kubectl get pod/dapi-test-pod5 NAME READY STATUS RESTARTS AGE dapi-test-pod5 1 /1 Running 0 7s # \u6aa2\u67e5 Pod \u7684\u65e5\u8a8c $ kubectl logs pod/dapi-test-pod5 my-group # \u9032\u5230 Pod \u4e2d\u53bb\u6aa2\u67e5 $ kubectl exec -it dapi-test-pod5 -- /bin/sh Tip Secrets \u7684\u7528\u6cd5\u662f\u8ddf ConfigMap \u57fa\u672c\u4e0a\u662f\u4e00\u81f4\uff0c\u5340\u5225\u4e0d\u540c\u662f ConfigMap \u662f\u660e\u6587\uff0c\u800c Secrets \u662f\u7d93\u904e base64 \u7de8\u78bc\u904e\u7684\u3002","title":"2. \u639b\u8f09\u6587\u4ef6\u76ee\u9304\u6cd5"},{"location":"kubernetes/04-tutorials/kubernetes-basics/","text":"\u5b78\u7fd2 Kubernetes \u57fa\u790e\u77e5\u8b58 \u00b6 \u539f\u6587: Learn Kubernetes Basics Kubernetes \u57fa\u790e \u00b6 \u672c\u6559\u7a0b\u4ecb\u7d39\u4e86 Kubernetes \u96c6\u7fa4\u7de8\u6392\u7cfb\u7d71\u7684\u57fa\u790e\u77e5\u8b58\u3002\u6bcf\u500b\u6a21\u584a\u5305\u542b\u95dc\u65bc Kubernetes \u4e3b\u8981\u7279\u6027\u548c\u6982\u5ff5\u7684\u4e00\u4e9b\u80cc\u666f\u4fe1\u606f\uff0c\u4e26\u4f7f\u7528 K3D \u4f86\u5275\u5efa\u4e00\u500b Kubernetes \u96c6\u7fa4\u4f86\u8b93\u4f60\u53ef\u4ee5\u81ea\u5df1\u7ba1\u7406\u4e00\u500b\u7c21\u55ae\u7684\u96c6\u7fa4\u53ca\u5176\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u3002 \u672c\u6559\u7a0b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5b78\u7fd2\uff1a \u5728\u96c6\u7fa4\u4e0a\u90e8\u7f72\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f \u5f48\u6027\u90e8\u7f72 \u4f7f\u7528\u65b0\u7684\u8edf\u4ef6\u7248\u672c\uff0c\u66f4\u65b0\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f \u8abf\u8a66\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f Kubernetes \u53ef\u4ee5\u70ba\u4f60\u505a\u4e9b\u4ec0\u9ebc? \u00b6 \u901a\u904e\u73fe\u4ee3\u7684 Web \u670d\u52d9\uff0c\u7528\u6236\u5e0c\u671b\u61c9\u7528\u7a0b\u5e8f\u80fd\u5920 24/7 \u5168\u5929\u5019\u4f7f\u7528\uff0c\u958b\u767c\u4eba\u54e1\u5e0c\u671b\u6bcf\u5929\u53ef\u4ee5\u591a\u6b21\u767c\u5e03\u90e8\u7f72\u65b0\u7248\u672c\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5bb9\u5668\u5316\u53ef\u4ee5\u5e6b\u52a9\u8edf\u4ef6\u5305\u9054\u6210\u9019\u4e9b\u76ee\u6a19\uff0c\u4f7f\u61c9\u7528\u7a0b\u5e8f\u80fd\u5920\u4ee5\u7c21\u55ae\u5feb\u901f\u7684\u65b9\u5f0f\u767c\u5e03\u548c\u66f4\u65b0\uff0c\u800c\u7121\u9700\u505c\u6a5f\u3002 Kubernetes \u5e6b\u52a9\u4f60\u78ba\u4fdd\u9019\u4e9b\u5bb9\u5668\u5316\u7684\u61c9\u7528\u7a0b\u5e8f\u5728\u4f60\u60f3\u8981\u7684\u6642\u9593\u548c\u5730\u9ede\u904b\u884c\uff0c\u4e26\u5e6b\u52a9\u61c9\u7528\u7a0b\u5e8f\u627e\u5230\u5b83\u5011\u9700\u8981\u7684\u8cc7\u6e90\u548c\u5de5\u5177\u3002 Kubernetes \u662f\u4e00\u500b\u53ef\u7528\u65bc\u751f\u7522\u7684\u958b\u6e90\u5e73\u53f0\uff0c\u6839\u64da Google \u5bb9\u5668\u96c6\u7fa4\u65b9\u9762\u7a4d\u7d2f\u7684\u7d93\u9a57\uff0c\u4ee5\u53ca\u4f86\u81ea\u793e\u5340\u7684\u6700\u4f73\u5be6\u8e10\u800c\u8a2d\u8a08\u3002 Kubernetes \u57fa\u790e\u6a21\u584a \u00b6 1. \u5275\u5efa\u4e00\u500b Kubernetes \u96c6\u7fa4 2. \u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f 3. \u61c9\u7528\u7a0b\u5e8f\u63a2\u7d22 4. \u61c9\u7528\u5916\u90e8\u53ef\u898b 5. \u61c9\u7528\u53ef\u64f4\u5c55 6. \u61c9\u7528\u66f4\u65b0","title":"\u7c21\u4ecb"},{"location":"kubernetes/04-tutorials/kubernetes-basics/#kubernetes","text":"\u539f\u6587: Learn Kubernetes Basics","title":"\u5b78\u7fd2 Kubernetes \u57fa\u790e\u77e5\u8b58"},{"location":"kubernetes/04-tutorials/kubernetes-basics/#kubernetes_1","text":"\u672c\u6559\u7a0b\u4ecb\u7d39\u4e86 Kubernetes \u96c6\u7fa4\u7de8\u6392\u7cfb\u7d71\u7684\u57fa\u790e\u77e5\u8b58\u3002\u6bcf\u500b\u6a21\u584a\u5305\u542b\u95dc\u65bc Kubernetes \u4e3b\u8981\u7279\u6027\u548c\u6982\u5ff5\u7684\u4e00\u4e9b\u80cc\u666f\u4fe1\u606f\uff0c\u4e26\u4f7f\u7528 K3D \u4f86\u5275\u5efa\u4e00\u500b Kubernetes \u96c6\u7fa4\u4f86\u8b93\u4f60\u53ef\u4ee5\u81ea\u5df1\u7ba1\u7406\u4e00\u500b\u7c21\u55ae\u7684\u96c6\u7fa4\u53ca\u5176\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u3002 \u672c\u6559\u7a0b\u4e2d\uff0c\u4f60\u53ef\u4ee5\u5b78\u7fd2\uff1a \u5728\u96c6\u7fa4\u4e0a\u90e8\u7f72\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f \u5f48\u6027\u90e8\u7f72 \u4f7f\u7528\u65b0\u7684\u8edf\u4ef6\u7248\u672c\uff0c\u66f4\u65b0\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f \u8abf\u8a66\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f","title":"Kubernetes \u57fa\u790e"},{"location":"kubernetes/04-tutorials/kubernetes-basics/#kubernetes_2","text":"\u901a\u904e\u73fe\u4ee3\u7684 Web \u670d\u52d9\uff0c\u7528\u6236\u5e0c\u671b\u61c9\u7528\u7a0b\u5e8f\u80fd\u5920 24/7 \u5168\u5929\u5019\u4f7f\u7528\uff0c\u958b\u767c\u4eba\u54e1\u5e0c\u671b\u6bcf\u5929\u53ef\u4ee5\u591a\u6b21\u767c\u5e03\u90e8\u7f72\u65b0\u7248\u672c\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5bb9\u5668\u5316\u53ef\u4ee5\u5e6b\u52a9\u8edf\u4ef6\u5305\u9054\u6210\u9019\u4e9b\u76ee\u6a19\uff0c\u4f7f\u61c9\u7528\u7a0b\u5e8f\u80fd\u5920\u4ee5\u7c21\u55ae\u5feb\u901f\u7684\u65b9\u5f0f\u767c\u5e03\u548c\u66f4\u65b0\uff0c\u800c\u7121\u9700\u505c\u6a5f\u3002 Kubernetes \u5e6b\u52a9\u4f60\u78ba\u4fdd\u9019\u4e9b\u5bb9\u5668\u5316\u7684\u61c9\u7528\u7a0b\u5e8f\u5728\u4f60\u60f3\u8981\u7684\u6642\u9593\u548c\u5730\u9ede\u904b\u884c\uff0c\u4e26\u5e6b\u52a9\u61c9\u7528\u7a0b\u5e8f\u627e\u5230\u5b83\u5011\u9700\u8981\u7684\u8cc7\u6e90\u548c\u5de5\u5177\u3002 Kubernetes \u662f\u4e00\u500b\u53ef\u7528\u65bc\u751f\u7522\u7684\u958b\u6e90\u5e73\u53f0\uff0c\u6839\u64da Google \u5bb9\u5668\u96c6\u7fa4\u65b9\u9762\u7a4d\u7d2f\u7684\u7d93\u9a57\uff0c\u4ee5\u53ca\u4f86\u81ea\u793e\u5340\u7684\u6700\u4f73\u5be6\u8e10\u800c\u8a2d\u8a08\u3002","title":"Kubernetes \u53ef\u4ee5\u70ba\u4f60\u505a\u4e9b\u4ec0\u9ebc?"},{"location":"kubernetes/04-tutorials/kubernetes-basics/#kubernetes_3","text":"1. \u5275\u5efa\u4e00\u500b Kubernetes \u96c6\u7fa4 2. \u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f 3. \u61c9\u7528\u7a0b\u5e8f\u63a2\u7d22 4. \u61c9\u7528\u5916\u90e8\u53ef\u898b 5. \u61c9\u7528\u53ef\u64f4\u5c55 6. \u61c9\u7528\u66f4\u65b0","title":"Kubernetes \u57fa\u790e\u6a21\u584a"},{"location":"kubernetes/04-tutorials/kubernetes-basics/create-cluster/","text":"\u5275\u5efa\u96c6\u7fa4 \u00b6 \u4f7f\u7528 K3D \u5275\u5efa\u96c6\u7fa4 \u00b6 \u76ee\u6a19: \u4e86\u89e3 Kubernetes \u96c6\u7fa4\u3002 \u4e86\u89e3 K3D \u3002 \u4f7f\u7528 K3D \u958b\u555f\u4e00\u500b Kubernetes \u96c6\u7fa4\u3002 Kubernetes \u96c6\u7fa4 \u00b6 Kubernetes \u5354\u8abf\u4e00\u500b\u9ad8\u53ef\u7528\u8a08\u7b97\u6a5f\u96c6\u7fa4\uff0c\u6bcf\u500b\u8a08\u7b97\u6a5f\u4f5c\u70ba\u7368\u7acb\u55ae\u5143\u4e92\u76f8\u9023\u63a5\u5de5\u4f5c \u3002 Kubernetes \u4e2d\u7684\u62bd\u8c61\u5141\u8a31\u4f60\u5c07\u5bb9\u5668\u5316\u7684\u61c9\u7528\u90e8\u7f72\u5230\u96c6\u7fa4\uff0c\u800c\u7121\u9700\u5c07\u5b83\u5011\u7d81\u5b9a\u5230\u67d0\u500b\u7279\u5b9a\u7684\u7368\u7acb\u8a08\u7b97\u6a5f\u3002\u70ba\u4e86\u4f7f\u7528\u9019\u7a2e\u65b0\u7684\u90e8\u7f72\u6a21\u578b\uff0c\u61c9\u7528\u9700\u8981\u4ee5\u5c07\u61c9\u7528\u8207\u55ae\u500b\u4e3b\u6a5f\u5206\u96e2\u7684\u65b9\u5f0f\u6253\u5305\uff1a\u5b83\u5011\u9700\u8981 \u88ab\u5bb9\u5668\u5316 \u3002\u8207\u904e\u53bb\u7684\u90a3\u7a2e\u61c9\u7528\u76f4\u63a5\u4ee5\u5305\u7684\u65b9\u5f0f\u6df1\u5ea6\u8207\u4e3b\u6a5f\u96c6\u6210\u7684\u90e8\u7f72\u6a21\u578b\u76f8\u6bd4\uff0c\u5bb9\u5668\u5316\u61c9\u7528\u66f4\u9748\u6d3b\u3001\u66f4\u53ef\u7528\u3002 Kubernetes \u4ee5\u66f4\u9ad8\u6548\u7684\u65b9\u5f0f\u8de8\u96c6\u7fa4\u81ea\u52d5\u5206\u767c\u548c\u8abf\u5ea6\u61c9\u7528\u5bb9\u5668 \u3002 Kubernetes \u662f\u4e00\u500b\u958b\u6e90\u5e73\u53f0\uff0c\u4e26\u4e14\u53ef\u61c9\u7528\u65bc\u751f\u7522\u74b0\u5883\u3002 \u4e00\u500b Kubernetes \u96c6\u7fa4\u5305\u542b\u5169\u7a2e\u985e\u578b\u7684\u8cc7\u6e90: Master \u8abf\u5ea6\u6574\u500b\u96c6\u7fa4 Nodes \u8ca0\u8cac\u904b\u884c\u61c9\u7528 Master \u8ca0\u8cac\u7ba1\u7406\u6574\u500b\u96c6\u7fa4 \u3002 Master \u5354\u8abf\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u6d3b\u52d5\uff0c\u4f8b\u5982\u8abf\u5ea6\u61c9\u7528\u3001\u7dad\u8b77\u61c9\u7528\u7684\u6240\u9700\u72c0\u614b\u3001\u61c9\u7528\u64f4\u5bb9\u4ee5\u53ca\u63a8\u51fa\u65b0\u7684\u66f4\u65b0\u3002 Node \u662f\u4e00\u500b\u865b\u64ec\u6a5f\u6216\u8005\u7269\u7406\u6a5f\uff0c\u5b83\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5145\u7576\u5de5\u4f5c\u6a5f\u5668\u7684\u89d2\u8272 \u6bcf\u500bNode\u90fd\u6709 Kubelet , \u5b83\u7ba1\u7406 Node \u800c\u4e14\u662f Node \u8207 Master \u901a\u4fe1\u7684\u4ee3\u7406\u3002 Node \u9084\u61c9\u8a72\u5177\u6709\u7528\u65bc\u200b\u200b\u8655\u7406\u5bb9\u5668\u64cd\u4f5c\u7684\u5de5\u5177\uff0c\u4f8b\u5982 Docker \u6216 rkt \u3002\u8655\u7406\u751f\u7522\u7d1a\u6d41\u91cf\u7684 Kubernetes \u96c6\u7fa4\u81f3\u5c11\u61c9\u5177\u6709\u4e09\u500b Node\uff0c\u56e0\u70ba\u5982\u679c\u4e00\u500b Node \u51fa\u73fe\u6545\u969c\u5176\u5c0d\u61c9\u7684 etcd \u6210\u54e1\u548c\u63a7\u5236\u5e73\u9762\u5be6\u4f8b\u90fd\u6703\u4e1f\u5931\uff0c\u4e26\u4e14\u5197\u9918\u6703\u53d7\u5230\u5f71\u97ff\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u6dfb\u52a0\u66f4\u591a\u63a7\u5236\u5e73\u9762\u7bc0\u9ede\u4f86\u964d\u4f4e\u9019\u7a2e\u98a8\u96aa \u3002 \u5728 Kubernetes \u4e0a\u90e8\u7f72\u61c9\u7528\u6642\uff0c\u4f60\u544a\u8a34 Master \u555f\u52d5\u61c9\u7528\u5bb9\u5668\u3002 Master \u5c31\u7de8\u6392\u5bb9\u5668\u5728\u96c6\u7fa4\u7684 Node \u4e0a\u904b\u884c\u3002 Node \u4f7f\u7528 Master \u66b4\u9732\u7684 Kubernetes API \u8207 Master \u901a\u4fe1 \u3002\u7d42\u7aef\u7528\u6236\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes API \u8207\u96c6\u7fa4\u4ea4\u4e92\u3002 Kubernetes \u65e2\u53ef\u4ee5\u90e8\u7f72\u5728\u7269\u7406\u6a5f\u4e0a\u4e5f\u53ef\u4ee5\u90e8\u7f72\u5728\u865b\u64ec\u6a5f\u4e0a\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 K3D \u958b\u59cb\u90e8\u7f72 Kubernetes \u96c6\u7fa4\u3002 K3D \u662f\u4e00\u7a2e\u8f15\u91cf\u7d1a\u7684 Kubernetes \u5be6\u73fe\uff0c\u53ef\u5728\u672c\u5730\u8a08\u7b97\u6a5f\u4e0a\u5275\u5efa dokcer \u4e26\u90e8\u7f72\u50c5\u5305\u542b\u4e00\u500b\u7bc0\u9ede\u7684\u7c21\u55ae\u96c6\u7fa4\u3002 K3D \u53ef\u7528\u65bc Linux \uff0c macOS \u548c Windows \u7cfb\u7d71\u3002 K3D CLI \u63d0\u4f9b\u4e86\u7528\u65bc\u5f15\u5c0e\u96c6\u7fa4\u5de5\u4f5c\u7684\u591a\u7a2e\u64cd\u4f5c\uff0c\u5305\u62ec\u555f\u52d5\u3001\u505c\u6b62\u3001\u67e5\u770b\u72c0\u614b\u548c\u522a\u9664\u3002 \u65e2\u7136\u4f60\u5df2\u7d93\u77e5\u9053 Kubernetes \u662f\u4ec0\u9ebc\uff0c\u8b93\u6211\u5011\u555f\u52d5\u6211\u5011\u7684\u7b2c\u4e00\u500b Kubernetes \u96c6\u7fa4\uff01 \u5275\u5efa K3D \u96c6\u7fa4 \u00b6 K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer -p 30000 -30010:30000-30010@server:0 Info \u7aef\u53e3\u6620\u5c04\u7d50\u69cb 8081:80 @loadbalancer \u7684\u610f\u601d\u662f\uff1a\u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u5230\u8207 nodefilter \u8ca0\u8f09\u5e73\u8861\u5668\u5339\u914d\u7684\u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3\u201d \u6aa2\u67e5\u96c6\u7fa4\u8cc7\u8a0a\uff1a kubectl cluster-info \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Kubernetes control plane is running at https://0.0.0.0:43893 CoreDNS is running at https://0.0.0.0:43893/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy Metrics-server is running at https://0.0.0.0:43893/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'. \u6aa2\u67e5\u96c6\u7fa4\u7bc0\u9ede\u8cc7\u8a0a\uff1a kubectl get nodes \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME STATUS ROLES AGE VERSION k3d-k3s-default-server-0 Ready control-plane,master 86s v1.22.7+k3s1 \u6b64\u547d\u4ee4\u986f\u793a\u53ef\u7528\u65bc\u8a17\u7ba1\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u6240\u6709\u7bc0\u9ede\u3002\u73fe\u5728\u6211\u5011\u53ea\u6709\u4e00\u500b\u7bc0\u9ede\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u5b83\u7684\u72c0\u614b\u662f\u6e96\u5099\u5c31\u7dd2\uff08\u5b83\u6e96\u5099\u597d\u63a5\u53d7\u61c9\u7528\u7a0b\u5e8f\u9032\u884c\u90e8\u7f72\uff09\u3002","title":"\u5275\u5efa\u96c6\u7fa4"},{"location":"kubernetes/04-tutorials/kubernetes-basics/create-cluster/#_1","text":"","title":"\u5275\u5efa\u96c6\u7fa4"},{"location":"kubernetes/04-tutorials/kubernetes-basics/create-cluster/#k3d","text":"\u76ee\u6a19: \u4e86\u89e3 Kubernetes \u96c6\u7fa4\u3002 \u4e86\u89e3 K3D \u3002 \u4f7f\u7528 K3D \u958b\u555f\u4e00\u500b Kubernetes \u96c6\u7fa4\u3002","title":"\u4f7f\u7528 K3D \u5275\u5efa\u96c6\u7fa4"},{"location":"kubernetes/04-tutorials/kubernetes-basics/create-cluster/#kubernetes","text":"Kubernetes \u5354\u8abf\u4e00\u500b\u9ad8\u53ef\u7528\u8a08\u7b97\u6a5f\u96c6\u7fa4\uff0c\u6bcf\u500b\u8a08\u7b97\u6a5f\u4f5c\u70ba\u7368\u7acb\u55ae\u5143\u4e92\u76f8\u9023\u63a5\u5de5\u4f5c \u3002 Kubernetes \u4e2d\u7684\u62bd\u8c61\u5141\u8a31\u4f60\u5c07\u5bb9\u5668\u5316\u7684\u61c9\u7528\u90e8\u7f72\u5230\u96c6\u7fa4\uff0c\u800c\u7121\u9700\u5c07\u5b83\u5011\u7d81\u5b9a\u5230\u67d0\u500b\u7279\u5b9a\u7684\u7368\u7acb\u8a08\u7b97\u6a5f\u3002\u70ba\u4e86\u4f7f\u7528\u9019\u7a2e\u65b0\u7684\u90e8\u7f72\u6a21\u578b\uff0c\u61c9\u7528\u9700\u8981\u4ee5\u5c07\u61c9\u7528\u8207\u55ae\u500b\u4e3b\u6a5f\u5206\u96e2\u7684\u65b9\u5f0f\u6253\u5305\uff1a\u5b83\u5011\u9700\u8981 \u88ab\u5bb9\u5668\u5316 \u3002\u8207\u904e\u53bb\u7684\u90a3\u7a2e\u61c9\u7528\u76f4\u63a5\u4ee5\u5305\u7684\u65b9\u5f0f\u6df1\u5ea6\u8207\u4e3b\u6a5f\u96c6\u6210\u7684\u90e8\u7f72\u6a21\u578b\u76f8\u6bd4\uff0c\u5bb9\u5668\u5316\u61c9\u7528\u66f4\u9748\u6d3b\u3001\u66f4\u53ef\u7528\u3002 Kubernetes \u4ee5\u66f4\u9ad8\u6548\u7684\u65b9\u5f0f\u8de8\u96c6\u7fa4\u81ea\u52d5\u5206\u767c\u548c\u8abf\u5ea6\u61c9\u7528\u5bb9\u5668 \u3002 Kubernetes \u662f\u4e00\u500b\u958b\u6e90\u5e73\u53f0\uff0c\u4e26\u4e14\u53ef\u61c9\u7528\u65bc\u751f\u7522\u74b0\u5883\u3002 \u4e00\u500b Kubernetes \u96c6\u7fa4\u5305\u542b\u5169\u7a2e\u985e\u578b\u7684\u8cc7\u6e90: Master \u8abf\u5ea6\u6574\u500b\u96c6\u7fa4 Nodes \u8ca0\u8cac\u904b\u884c\u61c9\u7528 Master \u8ca0\u8cac\u7ba1\u7406\u6574\u500b\u96c6\u7fa4 \u3002 Master \u5354\u8abf\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u6d3b\u52d5\uff0c\u4f8b\u5982\u8abf\u5ea6\u61c9\u7528\u3001\u7dad\u8b77\u61c9\u7528\u7684\u6240\u9700\u72c0\u614b\u3001\u61c9\u7528\u64f4\u5bb9\u4ee5\u53ca\u63a8\u51fa\u65b0\u7684\u66f4\u65b0\u3002 Node \u662f\u4e00\u500b\u865b\u64ec\u6a5f\u6216\u8005\u7269\u7406\u6a5f\uff0c\u5b83\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5145\u7576\u5de5\u4f5c\u6a5f\u5668\u7684\u89d2\u8272 \u6bcf\u500bNode\u90fd\u6709 Kubelet , \u5b83\u7ba1\u7406 Node \u800c\u4e14\u662f Node \u8207 Master \u901a\u4fe1\u7684\u4ee3\u7406\u3002 Node \u9084\u61c9\u8a72\u5177\u6709\u7528\u65bc\u200b\u200b\u8655\u7406\u5bb9\u5668\u64cd\u4f5c\u7684\u5de5\u5177\uff0c\u4f8b\u5982 Docker \u6216 rkt \u3002\u8655\u7406\u751f\u7522\u7d1a\u6d41\u91cf\u7684 Kubernetes \u96c6\u7fa4\u81f3\u5c11\u61c9\u5177\u6709\u4e09\u500b Node\uff0c\u56e0\u70ba\u5982\u679c\u4e00\u500b Node \u51fa\u73fe\u6545\u969c\u5176\u5c0d\u61c9\u7684 etcd \u6210\u54e1\u548c\u63a7\u5236\u5e73\u9762\u5be6\u4f8b\u90fd\u6703\u4e1f\u5931\uff0c\u4e26\u4e14\u5197\u9918\u6703\u53d7\u5230\u5f71\u97ff\u3002\u4f60\u53ef\u4ee5\u901a\u904e\u6dfb\u52a0\u66f4\u591a\u63a7\u5236\u5e73\u9762\u7bc0\u9ede\u4f86\u964d\u4f4e\u9019\u7a2e\u98a8\u96aa \u3002 \u5728 Kubernetes \u4e0a\u90e8\u7f72\u61c9\u7528\u6642\uff0c\u4f60\u544a\u8a34 Master \u555f\u52d5\u61c9\u7528\u5bb9\u5668\u3002 Master \u5c31\u7de8\u6392\u5bb9\u5668\u5728\u96c6\u7fa4\u7684 Node \u4e0a\u904b\u884c\u3002 Node \u4f7f\u7528 Master \u66b4\u9732\u7684 Kubernetes API \u8207 Master \u901a\u4fe1 \u3002\u7d42\u7aef\u7528\u6236\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes API \u8207\u96c6\u7fa4\u4ea4\u4e92\u3002 Kubernetes \u65e2\u53ef\u4ee5\u90e8\u7f72\u5728\u7269\u7406\u6a5f\u4e0a\u4e5f\u53ef\u4ee5\u90e8\u7f72\u5728\u865b\u64ec\u6a5f\u4e0a\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 K3D \u958b\u59cb\u90e8\u7f72 Kubernetes \u96c6\u7fa4\u3002 K3D \u662f\u4e00\u7a2e\u8f15\u91cf\u7d1a\u7684 Kubernetes \u5be6\u73fe\uff0c\u53ef\u5728\u672c\u5730\u8a08\u7b97\u6a5f\u4e0a\u5275\u5efa dokcer \u4e26\u90e8\u7f72\u50c5\u5305\u542b\u4e00\u500b\u7bc0\u9ede\u7684\u7c21\u55ae\u96c6\u7fa4\u3002 K3D \u53ef\u7528\u65bc Linux \uff0c macOS \u548c Windows \u7cfb\u7d71\u3002 K3D CLI \u63d0\u4f9b\u4e86\u7528\u65bc\u5f15\u5c0e\u96c6\u7fa4\u5de5\u4f5c\u7684\u591a\u7a2e\u64cd\u4f5c\uff0c\u5305\u62ec\u555f\u52d5\u3001\u505c\u6b62\u3001\u67e5\u770b\u72c0\u614b\u548c\u522a\u9664\u3002 \u65e2\u7136\u4f60\u5df2\u7d93\u77e5\u9053 Kubernetes \u662f\u4ec0\u9ebc\uff0c\u8b93\u6211\u5011\u555f\u52d5\u6211\u5011\u7684\u7b2c\u4e00\u500b Kubernetes \u96c6\u7fa4\uff01","title":"Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/04-tutorials/kubernetes-basics/create-cluster/#k3d_1","text":"K3D \u9ed8\u8a8d\u4f7f\u7528 traefik\uff0c\u6211\u5011\u5c07\u901a\u904e traefik \u66b4\u9732\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5982\u679c\u60a8\u5728\u9060\u7a0b\u670d\u52d9\u5668\u4e0a\u5b89\u88dd\u4e86 K3D\uff0c\u5247\u9700\u8981\u6253\u958b\u5916\u90e8\u7aef\u53e3\u9032\u884c\u8a2a\u554f\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6253\u958b\u8ca0\u8f09\u5747\u8861\u5668\u3002 $ k3d cluster create -p 8081 :80@loadbalancer -p 30000 -30010:30000-30010@server:0 Info \u7aef\u53e3\u6620\u5c04\u7d50\u69cb 8081:80 @loadbalancer \u7684\u610f\u601d\u662f\uff1a\u201c\u5c07\u4e3b\u6a5f\u7684 8081 \u7aef\u53e3\u6620\u5c04\u5230\u8207 nodefilter \u8ca0\u8f09\u5e73\u8861\u5668\u5339\u914d\u7684\u5bb9\u5668\u4e0a\u7684 80 \u7aef\u53e3\u201d \u6aa2\u67e5\u96c6\u7fa4\u8cc7\u8a0a\uff1a kubectl cluster-info \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Kubernetes control plane is running at https://0.0.0.0:43893 CoreDNS is running at https://0.0.0.0:43893/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy Metrics-server is running at https://0.0.0.0:43893/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'. \u6aa2\u67e5\u96c6\u7fa4\u7bc0\u9ede\u8cc7\u8a0a\uff1a kubectl get nodes \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME STATUS ROLES AGE VERSION k3d-k3s-default-server-0 Ready control-plane,master 86s v1.22.7+k3s1 \u6b64\u547d\u4ee4\u986f\u793a\u53ef\u7528\u65bc\u8a17\u7ba1\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u6240\u6709\u7bc0\u9ede\u3002\u73fe\u5728\u6211\u5011\u53ea\u6709\u4e00\u500b\u7bc0\u9ede\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u5b83\u7684\u72c0\u614b\u662f\u6e96\u5099\u5c31\u7dd2\uff08\u5b83\u6e96\u5099\u597d\u63a5\u53d7\u61c9\u7528\u7a0b\u5e8f\u9032\u884c\u90e8\u7f72\uff09\u3002","title":"\u5275\u5efa K3D \u96c6\u7fa4"},{"location":"kubernetes/04-tutorials/kubernetes-basics/deploy-app/","text":"\u90e8\u7f72\u61c9\u7528 \u00b6 \u4f7f\u7528 kubectl \u5275\u5efa\u90e8\u7f72 \u00b6 \u76ee\u6a19: \u5b78\u7fd2\u4e86\u89e3\u61c9\u7528\u7684\u90e8\u7f72 \u4f7f\u7528 kubectl \u5728 Kubernetes \u4e0a\u90e8\u7f72\u7b2c\u4e00\u500b\u61c9\u7528 Kubernetes \u90e8\u7f72 \u00b6 \u4e00\u65e6\u904b\u884c\u4e86 Kubernetes \u96c6\u7fa4\uff0c\u5c31\u53ef\u4ee5\u5728\u5176\u4e0a\u90e8\u7f72\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u4f60\u9700\u8981\u5275\u5efa Kubernetes Deployment \u914d\u7f6e\u3002 Deployment \u6307\u63ee Kubernetes \u5982\u4f55\u5275\u5efa\u548c\u66f4\u65b0\u61c9\u7528\u7a0b\u5e8f\u7684\u5be6\u4f8b\u3002\u5275\u5efa Deployment \u5f8c\uff0cKubernetes master \u5c07\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u8abf\u5ea6\u5230\u96c6\u7fa4\u4e2d\u7684\u5404\u500b\u7bc0\u9ede\u4e0a\u3002 \u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u5f8c\uff0cKubernetes Deployment \u63a7\u5236\u5668\u6703\u6301\u7e8c\u76e3\u8996\u9019\u4e9b\u5be6\u4f8b\u3002\u5982\u679c\u8a17\u7ba1\u5be6\u4f8b\u7684\u7bc0\u9ede\u95dc\u9589\u6216\u88ab\u522a\u9664\uff0c\u5247 Deployment \u63a7\u5236\u5668\u6703\u5c07\u8a72\u5be6\u4f8b\u66ff\u63db\u70ba\u96c6\u7fa4\u4e2d\u53e6\u4e00\u500b\u7bc0\u9ede\u4e0a\u7684\u5be6\u4f8b\u3002 \u9019\u63d0\u4f9b\u4e86\u4e00\u7a2e\u81ea\u6211\u4fee\u5fa9\u6a5f\u5236\u4f86\u89e3\u6c7a\u6a5f\u5668\u6545\u969c\u7dad\u8b77\u554f\u984c \u3002 \u5728\u6c92\u6709 Kubernetes \u9019\u7a2e\u7de8\u6392\u7cfb\u7d71\u4e4b\u524d\uff0c\u5b89\u88dd\u8173\u672c\u901a\u5e38\u7528\u65bc\u555f\u52d5\u61c9\u7528\u7a0b\u5e8f\uff0c\u4f46\u5b83\u5011\u4e0d\u5141\u8a31\u5f9e\u6a5f\u5668\u6545\u969c\u4e2d\u6062\u5fa9\u3002\u901a\u904e\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u4e26\u4f7f\u5b83\u5011\u5728\u7bc0\u9ede\u4e4b\u9593\u904b\u884c\uff0c Kubernetes Deployments \u63d0\u4f9b\u4e86\u4e00\u7a2e\u8207\u773e\u4e0d\u540c\u7684\u61c9\u7528\u7a0b\u5e8f\u7ba1\u7406\u65b9\u6cd5\u3002 \u90e8\u7f72\u4f60\u5728 Kubernetes \u4e0a\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f \u00b6 \u4f60\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u547d\u4ee4\u884c\u754c\u9762 Kubectl \u5275\u5efa\u548c\u7ba1\u7406 Deployment\u3002 Kubectl \u4f7f\u7528 Kubernetes API \u8207\u96c6\u7fa4\u9032\u884c\u4ea4\u4e92\u3002\u5728\u672c\u55ae\u5143\u4e2d\uff0c\u4f60\u5c07\u5b78\u7fd2\u5275\u5efa\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684 Deployment \u6240\u9700\u7684\u6700\u5e38\u898b\u7684 Kubectl \u547d\u4ee4\u3002 \u5275\u5efa Deployment \u6642\uff0c\u4f60\u9700\u8981\u6307\u5b9a\u61c9\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u93e1\u50cf\u4ee5\u53ca\u8981\u904b\u884c\u7684\u526f\u672c\u6578\u3002\u4f60\u53ef\u4ee5\u7a0d\u5f8c\u901a\u904e\u66f4\u65b0 Deployment \u4f86\u66f4\u6539\u8a72\u4fe1\u606f; \u6a21\u584a 5 \u548c 6 \u8a0e\u8ad6\u77ad\u5982\u4f55\u64f4\u5c55\u548c\u66f4\u65b0 Deployments\u3002 \u5c0d\u65bc\u6211\u5011\u7684\u7b2c\u4e00\u6b21\u90e8\u7f72\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u6253\u5305\u5728 Docker \u5bb9\u5668\u4e2d\u7684 Node.js \u61c9\u7528\u7a0b\u5e8f\u3002\u8981\u5275\u5efa Node.js \u61c9\u7528\u7a0b\u5e8f\u4e26\u90e8\u7f72 Docker \u5bb9\u5668\uff0c\u8acb\u53c3\u8003 \u4f60\u597d K3D \u6559\u7a0b . \u73fe\u5728\u4f60\u5df2\u7d93\u4e86\u89e3\u4e86 Deployment \u7684\u5167\u5bb9\uff0c\u8b93\u6211\u5011\u958b\u59cb\u90e8\u7f72\u6211\u5011\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff01 Declarative method Imperative method \u9996\u5148\u69cb\u5efa Deployment \u7684\u914d\u7f6e\u6a94 k8s-bootcamp-deployment.yaml : k8s-bootcamp-deployment.yaml cat > k8s-bootcamp-deployment.yaml <<EOF apiVersion: apps/v1 kind: Deployment metadata: labels: app: kubernetes-bootcamp name: kubernetes-bootcamp spec: replicas: 1 selector: matchLabels: app: kubernetes-bootcamp template: metadata: labels: app: kubernetes-bootcamp spec: containers: - image: gcr.io/google-samples/kubernetes-bootcamp:v1 name: kubernetes-bootcamp EOF \u5957\u7528 Deployment \u7684\u8a2d\u7f6e\u5230 Kubernetes \u96c6\u7fa4: kubectl apply -f k8s-bootcamp-deployment.yaml kubectl create deployment kubernetes-bootcamp --image = gcr.io/google-samples/kubernetes-bootcamp:v1 \u592a\u597d\u4e86\uff01\u60a8\u525b\u525b\u901a\u904e\u5275\u5efa deployment \u7269\u4ef6\u4f86\u90e8\u7f72\u4e86\u60a8\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u3002\u5728\u9019\u500b\u904e\u7a0b Kubernetes \u70ba\u60a8\u505a\u4e86\u4e00\u4e9b\u4e8b\u60c5\uff1a \u641c\u7d22\u53ef\u4ee5\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u7684\u5408\u9069\u7bc0\u9ede\uff08\u6211\u5011\u53ea\u6709 1 \u500b\u53ef\u7528\u7bc0\u9ede\uff09 \u5b89\u6392\u61c9\u7528\u7a0b\u5e8f\u5728\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c \u5c07\u96c6\u7fa4\u914d\u7f6e\u70ba\u5728\u9700\u8981\u6642\u5728\u65b0\u7bc0\u9ede\u4e0a\u91cd\u65b0\u8abf\u5ea6\u5be6\u4f8b \u8981\u5217\u51fa\u60a8\u7684\u90e8\u7f72\uff0c\u8acb\u4f7f\u7528 get deployments \u547d\u4ee4\uff1a kubectl get deployments \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 1/1 1 1 70s \u67e5\u770b\u525b\u4f48\u7f72\u7684\u61c9\u7528 \u00b6 \u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Pod \u904b\u884c\u5728\u4e00\u500b\u79c1\u6709\u3001\u9694\u96e2\u7684\u7db2\u7d61\u4e0a\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5011\u5c0d\u540c\u4e00 kubernetes \u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6 pod \u548c\u670d\u52d9\u53ef\u898b\uff0c\u4f46\u5728\u8a72\u7db2\u7d61\u4e4b\u5916\u4e0d\u53ef\u898b\u3002\u7576\u6211\u5011\u4f7f\u7528 kubectl \u6642\uff0c\u6211\u5011\u901a\u904e API \u7aef\u9ede\u9032\u884c\u4ea4\u4e92\u4ee5\u8207\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u9032\u884c\u901a\u4fe1\u3002\u6211\u5011\u5c07\u5728\u6a21\u584a 4 \u4e2d\u4ecb\u7d39\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e4b\u5916\u516c\u958b\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u5176\u4ed6\u9078\u9805\u3002 \u66ab\u6642\u6211\u5011\u5148\u4f7f\u7528 kubectl port-forward \u547d\u4ee4\u4f86\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\uff1a kubectl port-forward deployment.apps/kubernetes-bootcamp :8080 --address = '0.0.0.0' kubectl \u5de5\u5177\u6703\u627e\u5230\u4e00\u500b\u672a\u88ab\u4f7f\u7528\u7684\u672c\u5730\u7aef\u53e3\u865f\u3002\u8f38\u51fa\u985e\u4f3c\u65bc\uff1a Forwarding from 0.0.0.0:35729 -> 8080 Tip \u8acb\u6ce8\u610f\u5728 port-forward \u8f38\u51fa\u4e2d\u8207 8080 \u5c0d\u61c9\u7684\u9577\u5ea6\u70ba 5 \u4f4d\u7684\u7aef\u53e3\u865f\u3002\u6b64\u7aef\u53e3\u865f\u662f\u96a8\u6a5f\u751f\u6210\u7684\uff0c\u53ef\u80fd\u8207\u4f60\u7684\u4e0d\u540c\u3002\u5c0d\u61c9\u65bc\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u96c6\u7fa4\u61c9\u7528\u88ab\u66b4\u9732\u51fa\u7684\u672c\u5730\u7aef\u53e3\u865f\u662f 35729\u3002 \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u53d6\u5f97\u670d\u52d9\u7684\u7db2\u9801: curl localhost:35729 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-kmvpk | v=1","title":"\u90e8\u7f72\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/deploy-app/#_1","text":"","title":"\u90e8\u7f72\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/deploy-app/#kubectl","text":"\u76ee\u6a19: \u5b78\u7fd2\u4e86\u89e3\u61c9\u7528\u7684\u90e8\u7f72 \u4f7f\u7528 kubectl \u5728 Kubernetes \u4e0a\u90e8\u7f72\u7b2c\u4e00\u500b\u61c9\u7528","title":"\u4f7f\u7528 kubectl \u5275\u5efa\u90e8\u7f72"},{"location":"kubernetes/04-tutorials/kubernetes-basics/deploy-app/#kubernetes","text":"\u4e00\u65e6\u904b\u884c\u4e86 Kubernetes \u96c6\u7fa4\uff0c\u5c31\u53ef\u4ee5\u5728\u5176\u4e0a\u90e8\u7f72\u5bb9\u5668\u5316\u61c9\u7528\u7a0b\u5e8f\u3002\u70ba\u6b64\uff0c\u4f60\u9700\u8981\u5275\u5efa Kubernetes Deployment \u914d\u7f6e\u3002 Deployment \u6307\u63ee Kubernetes \u5982\u4f55\u5275\u5efa\u548c\u66f4\u65b0\u61c9\u7528\u7a0b\u5e8f\u7684\u5be6\u4f8b\u3002\u5275\u5efa Deployment \u5f8c\uff0cKubernetes master \u5c07\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u8abf\u5ea6\u5230\u96c6\u7fa4\u4e2d\u7684\u5404\u500b\u7bc0\u9ede\u4e0a\u3002 \u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u5f8c\uff0cKubernetes Deployment \u63a7\u5236\u5668\u6703\u6301\u7e8c\u76e3\u8996\u9019\u4e9b\u5be6\u4f8b\u3002\u5982\u679c\u8a17\u7ba1\u5be6\u4f8b\u7684\u7bc0\u9ede\u95dc\u9589\u6216\u88ab\u522a\u9664\uff0c\u5247 Deployment \u63a7\u5236\u5668\u6703\u5c07\u8a72\u5be6\u4f8b\u66ff\u63db\u70ba\u96c6\u7fa4\u4e2d\u53e6\u4e00\u500b\u7bc0\u9ede\u4e0a\u7684\u5be6\u4f8b\u3002 \u9019\u63d0\u4f9b\u4e86\u4e00\u7a2e\u81ea\u6211\u4fee\u5fa9\u6a5f\u5236\u4f86\u89e3\u6c7a\u6a5f\u5668\u6545\u969c\u7dad\u8b77\u554f\u984c \u3002 \u5728\u6c92\u6709 Kubernetes \u9019\u7a2e\u7de8\u6392\u7cfb\u7d71\u4e4b\u524d\uff0c\u5b89\u88dd\u8173\u672c\u901a\u5e38\u7528\u65bc\u555f\u52d5\u61c9\u7528\u7a0b\u5e8f\uff0c\u4f46\u5b83\u5011\u4e0d\u5141\u8a31\u5f9e\u6a5f\u5668\u6545\u969c\u4e2d\u6062\u5fa9\u3002\u901a\u904e\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u4e26\u4f7f\u5b83\u5011\u5728\u7bc0\u9ede\u4e4b\u9593\u904b\u884c\uff0c Kubernetes Deployments \u63d0\u4f9b\u4e86\u4e00\u7a2e\u8207\u773e\u4e0d\u540c\u7684\u61c9\u7528\u7a0b\u5e8f\u7ba1\u7406\u65b9\u6cd5\u3002","title":"Kubernetes \u90e8\u7f72"},{"location":"kubernetes/04-tutorials/kubernetes-basics/deploy-app/#kubernetes_1","text":"\u4f60\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u547d\u4ee4\u884c\u754c\u9762 Kubectl \u5275\u5efa\u548c\u7ba1\u7406 Deployment\u3002 Kubectl \u4f7f\u7528 Kubernetes API \u8207\u96c6\u7fa4\u9032\u884c\u4ea4\u4e92\u3002\u5728\u672c\u55ae\u5143\u4e2d\uff0c\u4f60\u5c07\u5b78\u7fd2\u5275\u5efa\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684 Deployment \u6240\u9700\u7684\u6700\u5e38\u898b\u7684 Kubectl \u547d\u4ee4\u3002 \u5275\u5efa Deployment \u6642\uff0c\u4f60\u9700\u8981\u6307\u5b9a\u61c9\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u93e1\u50cf\u4ee5\u53ca\u8981\u904b\u884c\u7684\u526f\u672c\u6578\u3002\u4f60\u53ef\u4ee5\u7a0d\u5f8c\u901a\u904e\u66f4\u65b0 Deployment \u4f86\u66f4\u6539\u8a72\u4fe1\u606f; \u6a21\u584a 5 \u548c 6 \u8a0e\u8ad6\u77ad\u5982\u4f55\u64f4\u5c55\u548c\u66f4\u65b0 Deployments\u3002 \u5c0d\u65bc\u6211\u5011\u7684\u7b2c\u4e00\u6b21\u90e8\u7f72\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u6253\u5305\u5728 Docker \u5bb9\u5668\u4e2d\u7684 Node.js \u61c9\u7528\u7a0b\u5e8f\u3002\u8981\u5275\u5efa Node.js \u61c9\u7528\u7a0b\u5e8f\u4e26\u90e8\u7f72 Docker \u5bb9\u5668\uff0c\u8acb\u53c3\u8003 \u4f60\u597d K3D \u6559\u7a0b . \u73fe\u5728\u4f60\u5df2\u7d93\u4e86\u89e3\u4e86 Deployment \u7684\u5167\u5bb9\uff0c\u8b93\u6211\u5011\u958b\u59cb\u90e8\u7f72\u6211\u5011\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff01 Declarative method Imperative method \u9996\u5148\u69cb\u5efa Deployment \u7684\u914d\u7f6e\u6a94 k8s-bootcamp-deployment.yaml : k8s-bootcamp-deployment.yaml cat > k8s-bootcamp-deployment.yaml <<EOF apiVersion: apps/v1 kind: Deployment metadata: labels: app: kubernetes-bootcamp name: kubernetes-bootcamp spec: replicas: 1 selector: matchLabels: app: kubernetes-bootcamp template: metadata: labels: app: kubernetes-bootcamp spec: containers: - image: gcr.io/google-samples/kubernetes-bootcamp:v1 name: kubernetes-bootcamp EOF \u5957\u7528 Deployment \u7684\u8a2d\u7f6e\u5230 Kubernetes \u96c6\u7fa4: kubectl apply -f k8s-bootcamp-deployment.yaml kubectl create deployment kubernetes-bootcamp --image = gcr.io/google-samples/kubernetes-bootcamp:v1 \u592a\u597d\u4e86\uff01\u60a8\u525b\u525b\u901a\u904e\u5275\u5efa deployment \u7269\u4ef6\u4f86\u90e8\u7f72\u4e86\u60a8\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u3002\u5728\u9019\u500b\u904e\u7a0b Kubernetes \u70ba\u60a8\u505a\u4e86\u4e00\u4e9b\u4e8b\u60c5\uff1a \u641c\u7d22\u53ef\u4ee5\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u7684\u5408\u9069\u7bc0\u9ede\uff08\u6211\u5011\u53ea\u6709 1 \u500b\u53ef\u7528\u7bc0\u9ede\uff09 \u5b89\u6392\u61c9\u7528\u7a0b\u5e8f\u5728\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c \u5c07\u96c6\u7fa4\u914d\u7f6e\u70ba\u5728\u9700\u8981\u6642\u5728\u65b0\u7bc0\u9ede\u4e0a\u91cd\u65b0\u8abf\u5ea6\u5be6\u4f8b \u8981\u5217\u51fa\u60a8\u7684\u90e8\u7f72\uff0c\u8acb\u4f7f\u7528 get deployments \u547d\u4ee4\uff1a kubectl get deployments \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 1/1 1 1 70s","title":"\u90e8\u7f72\u4f60\u5728 Kubernetes \u4e0a\u7684\u7b2c\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/04-tutorials/kubernetes-basics/deploy-app/#_2","text":"\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Pod \u904b\u884c\u5728\u4e00\u500b\u79c1\u6709\u3001\u9694\u96e2\u7684\u7db2\u7d61\u4e0a\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5011\u5c0d\u540c\u4e00 kubernetes \u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6 pod \u548c\u670d\u52d9\u53ef\u898b\uff0c\u4f46\u5728\u8a72\u7db2\u7d61\u4e4b\u5916\u4e0d\u53ef\u898b\u3002\u7576\u6211\u5011\u4f7f\u7528 kubectl \u6642\uff0c\u6211\u5011\u901a\u904e API \u7aef\u9ede\u9032\u884c\u4ea4\u4e92\u4ee5\u8207\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u9032\u884c\u901a\u4fe1\u3002\u6211\u5011\u5c07\u5728\u6a21\u584a 4 \u4e2d\u4ecb\u7d39\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e4b\u5916\u516c\u958b\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u5176\u4ed6\u9078\u9805\u3002 \u66ab\u6642\u6211\u5011\u5148\u4f7f\u7528 kubectl port-forward \u547d\u4ee4\u4f86\u66b4\u9732\u51fa\u96c6\u7fa4\u4e2d\u7684\u61c9\u7528\uff1a kubectl port-forward deployment.apps/kubernetes-bootcamp :8080 --address = '0.0.0.0' kubectl \u5de5\u5177\u6703\u627e\u5230\u4e00\u500b\u672a\u88ab\u4f7f\u7528\u7684\u672c\u5730\u7aef\u53e3\u865f\u3002\u8f38\u51fa\u985e\u4f3c\u65bc\uff1a Forwarding from 0.0.0.0:35729 -> 8080 Tip \u8acb\u6ce8\u610f\u5728 port-forward \u8f38\u51fa\u4e2d\u8207 8080 \u5c0d\u61c9\u7684\u9577\u5ea6\u70ba 5 \u4f4d\u7684\u7aef\u53e3\u865f\u3002\u6b64\u7aef\u53e3\u865f\u662f\u96a8\u6a5f\u751f\u6210\u7684\uff0c\u53ef\u80fd\u8207\u4f60\u7684\u4e0d\u540c\u3002\u5c0d\u61c9\u65bc\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u96c6\u7fa4\u61c9\u7528\u88ab\u66b4\u9732\u51fa\u7684\u672c\u5730\u7aef\u53e3\u865f\u662f 35729\u3002 \u57f7\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u53d6\u5f97\u670d\u52d9\u7684\u7db2\u9801: curl localhost:35729 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-kmvpk | v=1","title":"\u67e5\u770b\u525b\u4f48\u7f72\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/","text":"\u4e86\u89e3\u4f60\u7684\u61c9\u7528 \u00b6 \u67e5\u770b pod \u548c\u5de5\u4f5c\u7bc0\u9ede \u00b6 \u76ee\u6a19: \u4e86\u89e3 Kubernetes Pod\u3002 \u4e86\u89e3 Kubernetes \u5de5\u4f5c\u7bc0\u9ede\u3002 \u5c0d\u5df2\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u6545\u969c\u6392\u9664\u3002 Kubernetes Pods \u00b6 \u6a21\u584a 2 \u6642\uff0cKubernetes \u6dfb\u52a0\u4e86\u4e00\u500b Pod \u5728\u9019\u4e9b\u5bb9\u5668\u4e2d\u4f86\u5275\u5efa\u9019\u4e9b\u90e8\u7f72\u7684\u61c9\u7528\u5be6\u4f8b\u3002\u662f Kubernetes \u90e8\u7f72\u7684\uff0c\u8868\u793a\u4e00\u500b\u6216\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\uff09\uff0c\u4ee5\u53ca\u5bb9\u5668\u7684\u4e00\u4e9b\u5171\u4eab\u8cc7\u6e90\u3002\u8cc7\u6e90\u5305\u62ec\uff1a \u5728 \u6a21\u584a 2 \u5275\u5efa Deployment \u6642, Kubernetes \u6dfb\u52a0\u4e86\u4e00\u500b Pod \u4f86\u8a17\u7ba1\u4f60\u7684\u61c9\u7528\u5be6\u4f8b\u3002 Pod \u662f Kubernetes \u62bd\u8c61\u51fa\u4f86\u7684\uff0c\u8868\u793a\u4e00\u7d44\u4e00\u500b\u6216\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\uff08\u5982 Docker\uff09\uff0c\u4ee5\u53ca\u9019\u4e9b\u5bb9\u5668\u7684\u4e00\u4e9b\u5171\u4eab\u8cc7\u6e90\u3002\u9019\u4e9b\u8cc7\u6e90\u5305\u62ec: \u5171\u4eab\u5b58\u5132 Volume \u7db2\u7d61\uff0c\u4f5c\u70ba\u552f\u4e00\u7684\u96c6\u7fa4 IP \u5730\u5740 \u6709\u95dc\u6bcf\u500b\u5bb9\u5668\u5982\u4f55\u904b\u884c\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u5bb9\u5668\u93e1\u50cf\u7248\u672c\u6216\u8981\u4f7f\u7528\u7684\u7279\u5b9a\u7aef\u53e3\u3002 Pod \u70ba\u7279\u5b9a\u65bc\u61c9\u7528\u7a0b\u5e8f\u7684\u201c\u908f\u8f2f\u4e3b\u6a5f\u201d\u5efa\u6a21\uff0c\u4e26\u4e14\u53ef\u4ee5\u5305\u542b\u76f8\u5c0d\u7dca\u8026\u5408\u7684\u4e0d\u540c\u61c9\u7528\u5bb9\u5668\u3002\u4f8b\u5982\uff0cPod \u53ef\u80fd\u65e2\u5305\u542b\u5e36\u6709 Node.js \u61c9\u7528\u7684\u5bb9\u5668\uff0c\u4e5f\u5305\u542b\u53e6\u4e00\u500b\u4e0d\u540c\u7684\u5bb9\u5668\uff0c\u7528\u65bc\u63d0\u4f9b Node.js \u7db2\u7d61\u670d\u52d9\u5668\u8981\u767c\u5e03\u7684\u6578\u64da\u3002 Pod \u4e2d\u7684\u5bb9\u5668\u5171\u4eab IP \u5730\u5740\u548c\u7aef\u53e3\uff0c\u59cb\u7d42\u4f4d\u65bc\u540c\u4e00\u4f4d\u7f6e\u4e26\u4e14\u5171\u540c\u8abf\u5ea6\uff0c\u4e26\u5728\u540c\u4e00\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u7684\u5171\u4eab\u4e0a\u4e0b\u6587\u4e2d\u904b\u884c\u3002 Pod\u662f Kubernetes \u5e73\u53f0\u4e0a\u7684\u539f\u5b50\u55ae\u5143\u3002\u7576\u6211\u5011\u5728 Kubernetes \u4e0a\u5275\u5efa Deployment \u6642\uff0c\u8a72 Deployment \u6703\u5728\u5176\u4e2d\u5275\u5efa\u5305\u542b\u5bb9\u5668\u7684 Pod \uff08\u800c\u4e0d\u662f\u76f4\u63a5\u5275\u5efa\u5bb9\u5668\uff09\u3002\u6bcf\u500b Pod \u90fd\u8207\u8abf\u5ea6\u5b83\u7684\u5de5\u4f5c\u7bc0\u9ede\u7d81\u5b9a\uff0c\u4e26\u4fdd\u6301\u5728\u90a3\u88e1\u76f4\u5230\u7d42\u6b62\uff08\u6839\u64da\u91cd\u555f\u7b56\u7565\uff09\u6216\u522a\u9664\u3002\u5982\u679c\u5de5\u4f5c\u7bc0\u9ede\u767c\u751f\u6545\u969c\uff0c\u5247\u6703\u5728\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u53ef\u7528\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u8abf\u5ea6\u76f8\u540c\u7684 Pod\u3002 Pod \u6982\u89bd \u5de5\u4f5c\u7bc0\u9ede \u00b6 \u4e00\u500b pod \u7e3d\u662f\u904b\u884c\u5728 \u5de5\u4f5c\u7bc0\u9ede \u3002\u5de5\u4f5c\u7bc0\u9ede\u662f Kubernetes \u4e2d\u7684\u53c3\u8207\u8a08\u7b97\u7684\u6a5f\u5668\uff0c\u53ef\u4ee5\u662f\u865b\u64ec\u6a5f\u6216\u7269\u7406\u8a08\u7b97\u6a5f\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u96c6\u7fa4\u3002\u6bcf\u500b\u5de5\u4f5c\u7bc0\u9ede\u7531\u4e3b\u7bc0\u9ede\u7ba1\u7406\u3002\u5de5\u4f5c\u7bc0\u9ede\u53ef\u4ee5\u6709\u591a\u500b pod \uff0cKubernetes \u4e3b\u7bc0\u9ede\u6703\u81ea\u52d5\u8655\u7406\u5728\u96c6\u7fa4\u4e2d\u7684\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u8abf\u5ea6 pod \u3002\u4e3b\u7bc0\u9ede\u7684\u81ea\u52d5\u8abf\u5ea6\u8003\u91cf\u4e86\u6bcf\u500b\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u7684\u53ef\u7528\u8cc7\u6e90\u3002 \u6bcf\u500b Kubernetes \u5de5\u4f5c\u7bc0\u9ede\u81f3\u5c11\u904b\u884c: Kubelet\uff0c\u8ca0\u8cac Kubernetes \u4e3b\u7bc0\u9ede\u548c\u5de5\u4f5c\u7bc0\u9ede\u4e4b\u9593\u901a\u4fe1\u7684\u904e\u7a0b; \u5b83\u7ba1\u7406 Pod \u548c\u6a5f\u5668\u4e0a\u904b\u884c\u7684\u5bb9\u5668\u3002 \u5bb9\u5668\u904b\u884c runtime\uff08\u5982 Docker\uff09\u8ca0\u8cac\u5f9e\u5009\u5eab\u4e2d\u63d0\u53d6\u5bb9\u5668\u93e1\u50cf\uff0c\u89e3\u58d3\u7e2e\u5bb9\u5668\u4ee5\u53ca\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u3002 \u5de5\u4f5c\u7bc0\u9ede\u6982\u89bd \u4f7f\u7528 kubectl \u9032\u884c\u6545\u969c\u6392\u9664 \u00b6 \u5728\u6a21\u584a 2,\u4f60\u4f7f\u7528\u4e86 Kubectl \u547d\u4ee4\u884c\u754c\u9762\u3002\u4f60\u5c07\u7e7c\u7e8c\u5728\u7b2c3\u55ae\u5143\u4e2d\u4f7f\u7528\u5b83\u4f86\u7372\u53d6\u6709\u95dc\u5df2\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u53ca\u5176\u74b0\u5883\u7684\u4fe1\u606f\u3002\u6700\u5e38\u898b\u7684\u64cd\u4f5c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u5b8c\u6210\uff1a kubectl get - \u5217\u51fa\u8cc7\u6e90 kubectl describe - \u986f\u793a\u6709\u95dc\u8cc7\u6e90\u7684\u8a73\u7d30\u4fe1\u606f kubectl logs - \u6253\u5370 pod \u548c\u5176\u4e2d\u5bb9\u5668\u7684\u65e5\u8a8c kubectl exec - \u5728 pod \u4e2d\u7684\u5bb9\u5668\u4e0a\u57f7\u884c\u547d\u4ee4 \u4f60\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u547d\u4ee4\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u6642\u9593\uff0c\u7576\u524d\u72c0\u614b\uff0c\u904b\u884c\u4f4d\u7f6e\u4ee5\u53ca\u914d\u7f6e\u3002 \u73fe\u5728\u6211\u5011\u4e86\u89e3\u4e86\u6709\u95dc\u96c6\u7fa4\u7d44\u4ef6\u548c\u547d\u4ee4\u884c\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8b93\u6211\u5011\u4f86\u63a2\u7d22\u4e00\u4e0b\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 \u6aa2\u67e5\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e \u00b6 \u8b93\u6211\u5011\u9a57\u8b49\u6211\u5011\u5728\u524d\u9762\u5834\u666f\u4e2d\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002\u6211\u5011\u5c07\u4f7f\u7528 kubectl get \u547d\u4ee4\u4e26\u67e5\u627e\u73fe\u6709\u7684 Pod\uff1a kubectl get pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-57978f5f5d-jsdct 1/1 Running 0 42m \u63a5\u4e0b\u4f86\uff0c\u8981\u67e5\u770b\u8a72 Pod \u5167\u7684\u5bb9\u5668\u4ee5\u53ca\u7528\u65bc\u69cb\u5efa\u9019\u4e9b\u5bb9\u5668\u7684\u93e1\u50cf\uff0c\u6211\u5011\u904b\u884c describe pods \u547d\u4ee4\uff1a kubectl describe pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Name: kubernetes-bootcamp-57978f5f5d-jsdct Namespace: default Priority: 0 Node: k3d-k3s-default-server-0/172.22.0.2 Start Time: Tue, 02 Aug 2022 15:29:45 +0800 Labels: app=kubernetes-bootcamp pod-template-hash=57978f5f5d Annotations: <none> Status: Running IP: 10.42.0.9 IPs: IP: 10.42.0.9 Controlled By: ReplicaSet/kubernetes-bootcamp-57978f5f5d Containers: kubernetes-bootcamp: Container ID: containerd://83aa4f85a8bbbc41a77169f003d3caaf7c7481fd2f479dc8d033ee491b786cbf Image: gcr.io/google-samples/kubernetes-bootcamp:v1 Image ID: gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af Port: <none> Host Port: <none> State: Running Started: Tue, 02 Aug 2022 15:30:21 +0800 Ready: True Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zmfmz (ro) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: kube-api-access-zmfmz: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 44m default-scheduler Successfully assigned default/kubernetes-bootcamp-57978f5f5d-jsdct to k3d-k3s-default-server-0 Normal Pulling 44m kubelet Pulling image \"gcr.io/google-samples/kubernetes-bootcamp:v1\" Normal Pulled 43m kubelet Successfully pulled image \"gcr.io/google-samples/kubernetes-bootcamp:v1\" in 34.864007947s Normal Created 43m kubelet Created container kubernetes-bootcamp Normal Started 43m kubelet Started container kubernetes-bootcamp \u6211\u5011\u5728\u9019\u88e1\u770b\u5230\u6709\u95dc Pod \u5bb9\u5668\u7684\u8a73\u7d30\u4fe1\u606f\uff1aIP \u5730\u5740\u3001\u4f7f\u7528\u7684\u7aef\u53e3\u4ee5\u53ca\u8207 Pod \u751f\u547d\u9031\u671f\u76f8\u95dc\u7684\u4e8b\u4ef6\u5217\u8868\u3002 describe \u547d\u4ee4\u7684\u8f38\u51fa\u5167\u5bb9\u5f88\u8c50\u5bcc\uff0c\u6db5\u84cb\u4e86\u4e00\u4e9b\u6211\u5011\u5c1a\u672a\u89e3\u91cb\u7684\u6982\u5ff5\uff0c\u4f46\u4e0d\u7528\u64d4\u5fc3\uff0c\u5728\u672c\u8a13\u7df4\u71df\u7d50\u675f\u6642\u5b83\u5011\u6703\u8b8a\u5f97\u719f\u6089\u3002 \u67e5\u770b\u5bb9\u5668\u65e5\u8a8c \u00b6 \u61c9\u7528\u7a0b\u5e8f\u767c\u9001\u5230 STDOUT \u7684\u4efb\u4f55\u5167\u5bb9\u90fd\u6703\u6210\u70ba Pod \u4e2d\u5bb9\u5668\u7684 \u65e5\u8a8c \u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u547d\u4ee4\u6aa2\u7d22\u9019\u4e9b\u65e5\u8a8c\uff1a kubectl logs pod/kubernetes-bootcamp-57978f5f5d-jsdct Tip \u6bcf\u500b Deployment \u6240\u5efa\u69cb\u7684 Pod \u7684\u540d\u7a31\u7684\u5f8c\u7db4\u662f\u7531 Kubernetes \u81ea\u52d5\u7d66\u865f\u7d44\u5408\u800c\u6210\u3002 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Kubernetes Bootcamp App Started At: 2022-08-02T07:30:21.472Z | Running On: kubernetes-bootcamp-57978f5f5d-jsdct Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 1 | App Uptime: 446.976 seconds | Log Time: 2022-08-02T07:37:48.448Z Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 2 | App Uptime: 447.093 seconds | Log Time: 2022-08-02T07:37:48.565Z Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 3 | App Uptime: 569.043 seconds | Log Time: 2022-08-02T07:39:50.515Z Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 4 | App Uptime: 569.151 seconds | Log Time: 2022-08-02T07:39:50.623Z \u5728\u5bb9\u5668\u4e0a\u57f7\u884c\u547d\u4ee4 \u00b6 \u4e00\u65e6 Pod \u555f\u52d5\u4e26\u904b\u884c\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u76f4\u63a5\u5728\u5bb9\u5668\u4e0a\u57f7\u884c\u547d\u4ee4\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528 exec \u547d\u4ee4\u4e26\u4f7f\u7528 Pod \u7684\u540d\u7a31\u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u5217\u51fa\u74b0\u5883\u8b8a\u91cf\uff1a kubectl exec pod/kubernetes-bootcamp-57978f5f5d-jsdct -- env \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a ATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin HOSTNAME=kubernetes-bootcamp-57978f5f5d-jsdct NPM_CONFIG_LOGLEVEL=info NODE_VERSION=6.3.1 KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_ADDR=10.43.0.1 KUBERNETES_SERVICE_HOST=10.43.0.1 KUBERNETES_SERVICE_PORT=443 KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT=tcp://10.43.0.1:443 KUBERNETES_PORT_443_TCP=tcp://10.43.0.1:443 KUBERNETES_PORT_443_TCP_PROTO=tcp HOME=/root \u540c\u6a23\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u5bb9\u5668\u672c\u8eab\u7684\u540d\u7a31\u53ef\u4ee5\u7701\u7565\uff0c\u56e0\u70ba\u6211\u5011\u5728 Pod \u4e2d\u53ea\u6709\u4e00\u500b\u5bb9\u5668\u3002 \u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u5728 Pod \u7684\u5bb9\u5668\u4e2d\u555f\u52d5\u4e00\u500b bash \u6703\u8a71\uff1a kubectl exec -it kubernetes-bootcamp-57978f5f5d-jsdct -- bash \u6211\u5011\u73fe\u5728\u5728\u904b\u884c NodeJS \u61c9\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u4e0a\u6709\u4e00\u500b\u958b\u653e\u7684\u63a7\u5236\u53f0\u3002\u8a72\u61c9\u7528\u7a0b\u5e8f\u7684\u6e90\u4ee3\u78bc\u5728 server.js \u6587\u4ef6\u4e2d\uff1a root@kubernetes-bootcamp-57978f5f5d-jsdct:/# cat server.js \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a root@kubernetes-bootcamp-57978f5f5d-jsdct:/# cat server.js var http = require('http'); var requests=0; var podname= process.env.HOSTNAME; var startTime; var host; var handleRequest = function(request, response) { response.setHeader('Content-Type', 'text/plain'); response.writeHead(200); response.write(\"Hello Kubernetes bootcamp! | Running on: \"); response.write(host); response.end(\" | v=1\\n\"); console.log(\"Running On:\" ,host, \"| Total Requests:\", ++requests,\"| App Uptime:\", (new Date() - startTime)/1000 , \"seconds\", \"| Log Time:\",new Date()); } var www = http.createServer(handleRequest); www.listen(8080,function () { startTime = new Date();; host = process.env.HOSTNAME; console.log (\"Kubernetes Bootcamp App Started At:\",startTime, \"| Running On: \" ,host, \"\\n\" ); }); \u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u8df3\u96e2Pod \u7684\u5bb9\u5668\u7684 bash \u6703\u8a71: exit","title":"\u4e86\u89e3\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#_1","text":"","title":"\u4e86\u89e3\u4f60\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#pod","text":"\u76ee\u6a19: \u4e86\u89e3 Kubernetes Pod\u3002 \u4e86\u89e3 Kubernetes \u5de5\u4f5c\u7bc0\u9ede\u3002 \u5c0d\u5df2\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u6545\u969c\u6392\u9664\u3002","title":"\u67e5\u770b pod \u548c\u5de5\u4f5c\u7bc0\u9ede"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#kubernetes-pods","text":"\u6a21\u584a 2 \u6642\uff0cKubernetes \u6dfb\u52a0\u4e86\u4e00\u500b Pod \u5728\u9019\u4e9b\u5bb9\u5668\u4e2d\u4f86\u5275\u5efa\u9019\u4e9b\u90e8\u7f72\u7684\u61c9\u7528\u5be6\u4f8b\u3002\u662f Kubernetes \u90e8\u7f72\u7684\uff0c\u8868\u793a\u4e00\u500b\u6216\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\uff09\uff0c\u4ee5\u53ca\u5bb9\u5668\u7684\u4e00\u4e9b\u5171\u4eab\u8cc7\u6e90\u3002\u8cc7\u6e90\u5305\u62ec\uff1a \u5728 \u6a21\u584a 2 \u5275\u5efa Deployment \u6642, Kubernetes \u6dfb\u52a0\u4e86\u4e00\u500b Pod \u4f86\u8a17\u7ba1\u4f60\u7684\u61c9\u7528\u5be6\u4f8b\u3002 Pod \u662f Kubernetes \u62bd\u8c61\u51fa\u4f86\u7684\uff0c\u8868\u793a\u4e00\u7d44\u4e00\u500b\u6216\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\uff08\u5982 Docker\uff09\uff0c\u4ee5\u53ca\u9019\u4e9b\u5bb9\u5668\u7684\u4e00\u4e9b\u5171\u4eab\u8cc7\u6e90\u3002\u9019\u4e9b\u8cc7\u6e90\u5305\u62ec: \u5171\u4eab\u5b58\u5132 Volume \u7db2\u7d61\uff0c\u4f5c\u70ba\u552f\u4e00\u7684\u96c6\u7fa4 IP \u5730\u5740 \u6709\u95dc\u6bcf\u500b\u5bb9\u5668\u5982\u4f55\u904b\u884c\u7684\u4fe1\u606f\uff0c\u4f8b\u5982\u5bb9\u5668\u93e1\u50cf\u7248\u672c\u6216\u8981\u4f7f\u7528\u7684\u7279\u5b9a\u7aef\u53e3\u3002 Pod \u70ba\u7279\u5b9a\u65bc\u61c9\u7528\u7a0b\u5e8f\u7684\u201c\u908f\u8f2f\u4e3b\u6a5f\u201d\u5efa\u6a21\uff0c\u4e26\u4e14\u53ef\u4ee5\u5305\u542b\u76f8\u5c0d\u7dca\u8026\u5408\u7684\u4e0d\u540c\u61c9\u7528\u5bb9\u5668\u3002\u4f8b\u5982\uff0cPod \u53ef\u80fd\u65e2\u5305\u542b\u5e36\u6709 Node.js \u61c9\u7528\u7684\u5bb9\u5668\uff0c\u4e5f\u5305\u542b\u53e6\u4e00\u500b\u4e0d\u540c\u7684\u5bb9\u5668\uff0c\u7528\u65bc\u63d0\u4f9b Node.js \u7db2\u7d61\u670d\u52d9\u5668\u8981\u767c\u5e03\u7684\u6578\u64da\u3002 Pod \u4e2d\u7684\u5bb9\u5668\u5171\u4eab IP \u5730\u5740\u548c\u7aef\u53e3\uff0c\u59cb\u7d42\u4f4d\u65bc\u540c\u4e00\u4f4d\u7f6e\u4e26\u4e14\u5171\u540c\u8abf\u5ea6\uff0c\u4e26\u5728\u540c\u4e00\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u7684\u5171\u4eab\u4e0a\u4e0b\u6587\u4e2d\u904b\u884c\u3002 Pod\u662f Kubernetes \u5e73\u53f0\u4e0a\u7684\u539f\u5b50\u55ae\u5143\u3002\u7576\u6211\u5011\u5728 Kubernetes \u4e0a\u5275\u5efa Deployment \u6642\uff0c\u8a72 Deployment \u6703\u5728\u5176\u4e2d\u5275\u5efa\u5305\u542b\u5bb9\u5668\u7684 Pod \uff08\u800c\u4e0d\u662f\u76f4\u63a5\u5275\u5efa\u5bb9\u5668\uff09\u3002\u6bcf\u500b Pod \u90fd\u8207\u8abf\u5ea6\u5b83\u7684\u5de5\u4f5c\u7bc0\u9ede\u7d81\u5b9a\uff0c\u4e26\u4fdd\u6301\u5728\u90a3\u88e1\u76f4\u5230\u7d42\u6b62\uff08\u6839\u64da\u91cd\u555f\u7b56\u7565\uff09\u6216\u522a\u9664\u3002\u5982\u679c\u5de5\u4f5c\u7bc0\u9ede\u767c\u751f\u6545\u969c\uff0c\u5247\u6703\u5728\u96c6\u7fa4\u4e2d\u7684\u5176\u4ed6\u53ef\u7528\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u8abf\u5ea6\u76f8\u540c\u7684 Pod\u3002 Pod \u6982\u89bd","title":"Kubernetes Pods"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#_2","text":"\u4e00\u500b pod \u7e3d\u662f\u904b\u884c\u5728 \u5de5\u4f5c\u7bc0\u9ede \u3002\u5de5\u4f5c\u7bc0\u9ede\u662f Kubernetes \u4e2d\u7684\u53c3\u8207\u8a08\u7b97\u7684\u6a5f\u5668\uff0c\u53ef\u4ee5\u662f\u865b\u64ec\u6a5f\u6216\u7269\u7406\u8a08\u7b97\u6a5f\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u96c6\u7fa4\u3002\u6bcf\u500b\u5de5\u4f5c\u7bc0\u9ede\u7531\u4e3b\u7bc0\u9ede\u7ba1\u7406\u3002\u5de5\u4f5c\u7bc0\u9ede\u53ef\u4ee5\u6709\u591a\u500b pod \uff0cKubernetes \u4e3b\u7bc0\u9ede\u6703\u81ea\u52d5\u8655\u7406\u5728\u96c6\u7fa4\u4e2d\u7684\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u8abf\u5ea6 pod \u3002\u4e3b\u7bc0\u9ede\u7684\u81ea\u52d5\u8abf\u5ea6\u8003\u91cf\u4e86\u6bcf\u500b\u5de5\u4f5c\u7bc0\u9ede\u4e0a\u7684\u53ef\u7528\u8cc7\u6e90\u3002 \u6bcf\u500b Kubernetes \u5de5\u4f5c\u7bc0\u9ede\u81f3\u5c11\u904b\u884c: Kubelet\uff0c\u8ca0\u8cac Kubernetes \u4e3b\u7bc0\u9ede\u548c\u5de5\u4f5c\u7bc0\u9ede\u4e4b\u9593\u901a\u4fe1\u7684\u904e\u7a0b; \u5b83\u7ba1\u7406 Pod \u548c\u6a5f\u5668\u4e0a\u904b\u884c\u7684\u5bb9\u5668\u3002 \u5bb9\u5668\u904b\u884c runtime\uff08\u5982 Docker\uff09\u8ca0\u8cac\u5f9e\u5009\u5eab\u4e2d\u63d0\u53d6\u5bb9\u5668\u93e1\u50cf\uff0c\u89e3\u58d3\u7e2e\u5bb9\u5668\u4ee5\u53ca\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u3002 \u5de5\u4f5c\u7bc0\u9ede\u6982\u89bd","title":"\u5de5\u4f5c\u7bc0\u9ede"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#kubectl","text":"\u5728\u6a21\u584a 2,\u4f60\u4f7f\u7528\u4e86 Kubectl \u547d\u4ee4\u884c\u754c\u9762\u3002\u4f60\u5c07\u7e7c\u7e8c\u5728\u7b2c3\u55ae\u5143\u4e2d\u4f7f\u7528\u5b83\u4f86\u7372\u53d6\u6709\u95dc\u5df2\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u53ca\u5176\u74b0\u5883\u7684\u4fe1\u606f\u3002\u6700\u5e38\u898b\u7684\u64cd\u4f5c\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u5b8c\u6210\uff1a kubectl get - \u5217\u51fa\u8cc7\u6e90 kubectl describe - \u986f\u793a\u6709\u95dc\u8cc7\u6e90\u7684\u8a73\u7d30\u4fe1\u606f kubectl logs - \u6253\u5370 pod \u548c\u5176\u4e2d\u5bb9\u5668\u7684\u65e5\u8a8c kubectl exec - \u5728 pod \u4e2d\u7684\u5bb9\u5668\u4e0a\u57f7\u884c\u547d\u4ee4 \u4f60\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u547d\u4ee4\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u6642\u9593\uff0c\u7576\u524d\u72c0\u614b\uff0c\u904b\u884c\u4f4d\u7f6e\u4ee5\u53ca\u914d\u7f6e\u3002 \u73fe\u5728\u6211\u5011\u4e86\u89e3\u4e86\u6709\u95dc\u96c6\u7fa4\u7d44\u4ef6\u548c\u547d\u4ee4\u884c\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8b93\u6211\u5011\u4f86\u63a2\u7d22\u4e00\u4e0b\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u3002","title":"\u4f7f\u7528 kubectl \u9032\u884c\u6545\u969c\u6392\u9664"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#_3","text":"\u8b93\u6211\u5011\u9a57\u8b49\u6211\u5011\u5728\u524d\u9762\u5834\u666f\u4e2d\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002\u6211\u5011\u5c07\u4f7f\u7528 kubectl get \u547d\u4ee4\u4e26\u67e5\u627e\u73fe\u6709\u7684 Pod\uff1a kubectl get pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-57978f5f5d-jsdct 1/1 Running 0 42m \u63a5\u4e0b\u4f86\uff0c\u8981\u67e5\u770b\u8a72 Pod \u5167\u7684\u5bb9\u5668\u4ee5\u53ca\u7528\u65bc\u69cb\u5efa\u9019\u4e9b\u5bb9\u5668\u7684\u93e1\u50cf\uff0c\u6211\u5011\u904b\u884c describe pods \u547d\u4ee4\uff1a kubectl describe pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Name: kubernetes-bootcamp-57978f5f5d-jsdct Namespace: default Priority: 0 Node: k3d-k3s-default-server-0/172.22.0.2 Start Time: Tue, 02 Aug 2022 15:29:45 +0800 Labels: app=kubernetes-bootcamp pod-template-hash=57978f5f5d Annotations: <none> Status: Running IP: 10.42.0.9 IPs: IP: 10.42.0.9 Controlled By: ReplicaSet/kubernetes-bootcamp-57978f5f5d Containers: kubernetes-bootcamp: Container ID: containerd://83aa4f85a8bbbc41a77169f003d3caaf7c7481fd2f479dc8d033ee491b786cbf Image: gcr.io/google-samples/kubernetes-bootcamp:v1 Image ID: gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af Port: <none> Host Port: <none> State: Running Started: Tue, 02 Aug 2022 15:30:21 +0800 Ready: True Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-zmfmz (ro) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: kube-api-access-zmfmz: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 44m default-scheduler Successfully assigned default/kubernetes-bootcamp-57978f5f5d-jsdct to k3d-k3s-default-server-0 Normal Pulling 44m kubelet Pulling image \"gcr.io/google-samples/kubernetes-bootcamp:v1\" Normal Pulled 43m kubelet Successfully pulled image \"gcr.io/google-samples/kubernetes-bootcamp:v1\" in 34.864007947s Normal Created 43m kubelet Created container kubernetes-bootcamp Normal Started 43m kubelet Started container kubernetes-bootcamp \u6211\u5011\u5728\u9019\u88e1\u770b\u5230\u6709\u95dc Pod \u5bb9\u5668\u7684\u8a73\u7d30\u4fe1\u606f\uff1aIP \u5730\u5740\u3001\u4f7f\u7528\u7684\u7aef\u53e3\u4ee5\u53ca\u8207 Pod \u751f\u547d\u9031\u671f\u76f8\u95dc\u7684\u4e8b\u4ef6\u5217\u8868\u3002 describe \u547d\u4ee4\u7684\u8f38\u51fa\u5167\u5bb9\u5f88\u8c50\u5bcc\uff0c\u6db5\u84cb\u4e86\u4e00\u4e9b\u6211\u5011\u5c1a\u672a\u89e3\u91cb\u7684\u6982\u5ff5\uff0c\u4f46\u4e0d\u7528\u64d4\u5fc3\uff0c\u5728\u672c\u8a13\u7df4\u71df\u7d50\u675f\u6642\u5b83\u5011\u6703\u8b8a\u5f97\u719f\u6089\u3002","title":"\u6aa2\u67e5\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#_4","text":"\u61c9\u7528\u7a0b\u5e8f\u767c\u9001\u5230 STDOUT \u7684\u4efb\u4f55\u5167\u5bb9\u90fd\u6703\u6210\u70ba Pod \u4e2d\u5bb9\u5668\u7684 \u65e5\u8a8c \u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl logs \u547d\u4ee4\u6aa2\u7d22\u9019\u4e9b\u65e5\u8a8c\uff1a kubectl logs pod/kubernetes-bootcamp-57978f5f5d-jsdct Tip \u6bcf\u500b Deployment \u6240\u5efa\u69cb\u7684 Pod \u7684\u540d\u7a31\u7684\u5f8c\u7db4\u662f\u7531 Kubernetes \u81ea\u52d5\u7d66\u865f\u7d44\u5408\u800c\u6210\u3002 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Kubernetes Bootcamp App Started At: 2022-08-02T07:30:21.472Z | Running On: kubernetes-bootcamp-57978f5f5d-jsdct Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 1 | App Uptime: 446.976 seconds | Log Time: 2022-08-02T07:37:48.448Z Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 2 | App Uptime: 447.093 seconds | Log Time: 2022-08-02T07:37:48.565Z Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 3 | App Uptime: 569.043 seconds | Log Time: 2022-08-02T07:39:50.515Z Running On: kubernetes-bootcamp-57978f5f5d-jsdct | Total Requests: 4 | App Uptime: 569.151 seconds | Log Time: 2022-08-02T07:39:50.623Z","title":"\u67e5\u770b\u5bb9\u5668\u65e5\u8a8c"},{"location":"kubernetes/04-tutorials/kubernetes-basics/explore/#_5","text":"\u4e00\u65e6 Pod \u555f\u52d5\u4e26\u904b\u884c\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u76f4\u63a5\u5728\u5bb9\u5668\u4e0a\u57f7\u884c\u547d\u4ee4\u3002\u70ba\u6b64\uff0c\u6211\u5011\u4f7f\u7528 exec \u547d\u4ee4\u4e26\u4f7f\u7528 Pod \u7684\u540d\u7a31\u4f5c\u70ba\u53c3\u6578\u3002\u8b93\u6211\u5011\u5217\u51fa\u74b0\u5883\u8b8a\u91cf\uff1a kubectl exec pod/kubernetes-bootcamp-57978f5f5d-jsdct -- env \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a ATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin HOSTNAME=kubernetes-bootcamp-57978f5f5d-jsdct NPM_CONFIG_LOGLEVEL=info NODE_VERSION=6.3.1 KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_ADDR=10.43.0.1 KUBERNETES_SERVICE_HOST=10.43.0.1 KUBERNETES_SERVICE_PORT=443 KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT=tcp://10.43.0.1:443 KUBERNETES_PORT_443_TCP=tcp://10.43.0.1:443 KUBERNETES_PORT_443_TCP_PROTO=tcp HOME=/root \u540c\u6a23\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0c\u5bb9\u5668\u672c\u8eab\u7684\u540d\u7a31\u53ef\u4ee5\u7701\u7565\uff0c\u56e0\u70ba\u6211\u5011\u5728 Pod \u4e2d\u53ea\u6709\u4e00\u500b\u5bb9\u5668\u3002 \u63a5\u4e0b\u4f86\u8b93\u6211\u5011\u5728 Pod \u7684\u5bb9\u5668\u4e2d\u555f\u52d5\u4e00\u500b bash \u6703\u8a71\uff1a kubectl exec -it kubernetes-bootcamp-57978f5f5d-jsdct -- bash \u6211\u5011\u73fe\u5728\u5728\u904b\u884c NodeJS \u61c9\u7528\u7a0b\u5e8f\u7684\u5bb9\u5668\u4e0a\u6709\u4e00\u500b\u958b\u653e\u7684\u63a7\u5236\u53f0\u3002\u8a72\u61c9\u7528\u7a0b\u5e8f\u7684\u6e90\u4ee3\u78bc\u5728 server.js \u6587\u4ef6\u4e2d\uff1a root@kubernetes-bootcamp-57978f5f5d-jsdct:/# cat server.js \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a root@kubernetes-bootcamp-57978f5f5d-jsdct:/# cat server.js var http = require('http'); var requests=0; var podname= process.env.HOSTNAME; var startTime; var host; var handleRequest = function(request, response) { response.setHeader('Content-Type', 'text/plain'); response.writeHead(200); response.write(\"Hello Kubernetes bootcamp! | Running on: \"); response.write(host); response.end(\" | v=1\\n\"); console.log(\"Running On:\" ,host, \"| Total Requests:\", ++requests,\"| App Uptime:\", (new Date() - startTime)/1000 , \"seconds\", \"| Log Time:\",new Date()); } var www = http.createServer(handleRequest); www.listen(8080,function () { startTime = new Date();; host = process.env.HOSTNAME; console.log (\"Kubernetes Bootcamp App Started At:\",startTime, \"| Running On: \" ,host, \"\\n\" ); }); \u4f7f\u7528\u4e0b\u5217\u547d\u4ee4\u8df3\u96e2Pod \u7684\u5bb9\u5668\u7684 bash \u6703\u8a71: exit","title":"\u5728\u5bb9\u5668\u4e0a\u57f7\u884c\u547d\u4ee4"},{"location":"kubernetes/04-tutorials/kubernetes-basics/expose/","text":"\u516c\u958b\u66dd\u9732\u4f60\u7684\u61c9\u7528 \u00b6 \u4f7f\u7528 Service \u66dd\u9732\u4f60\u7684\u61c9\u7528 \u00b6 \u76ee\u6a19: \u4e86\u89e3 Kubernetes \u4e2d\u7684 Service \u4e86\u89e3 \u6a19\u7c64(Label) \u548c \u6a19\u7c64\u9078\u64c7\u5668(Label Selector) \u5c0d\u50cf\u5982\u4f55\u8207 Service \u95dc\u806f \u5728 Kubernetes \u96c6\u7fa4\u5916\u7528 Service \u66b4\u9732\u61c9\u7528 Kubernetes Service \u7e3d\u89bd \u00b6 Kubernetes Pod \u662f\u8f49\u77ac\u5373\u901d\u7684\u3002 Pod \u5be6\u969b\u4e0a\u64c1\u6709 \u751f\u547d\u9031\u671f \u3002 \u7576\u4e00\u500b\u5de5\u4f5c Node \u639b\u6389\u5f8c, \u5728 Node \u4e0a\u904b\u884c\u7684 Pod \u4e5f\u6703\u6d88\u4ea1\u3002 ReplicaSet \u6703\u81ea\u52d5\u5730\u901a\u904e\u5275\u5efa\u65b0\u7684 Pod \u9a45\u52d5\u96c6\u7fa4\u56de\u5230\u76ee\u6a19\u72c0\u614b\uff0c\u4ee5\u4fdd\u8b49\u61c9\u7528\u7a0b\u5e8f\u6b63\u5e38\u904b\u884c\u3002 \u63db\u4e00\u500b\u4f8b\u5b50\uff0c\u8003\u616e\u4e00\u500b\u5177\u67093\u500b\u526f\u672c\u6578\u7684\u7528\u4f5c\u5716\u50cf\u8655\u7406\u7684\u5f8c\u7aef\u7a0b\u5e8f\u3002\u9019\u4e9b\u526f\u672c\u662f\u53ef\u66ff\u63db\u7684; \u524d\u7aef\u7cfb\u7d71\u4e0d\u61c9\u8a72\u95dc\u5fc3\u5f8c\u7aef\u526f\u672c\uff0c\u5373\u4f7f Pod \u4e1f\u5931\u6216\u91cd\u65b0\u5275\u5efa\u3002 \u4e5f\u5c31\u662f\u8aaa\uff0cKubernetes \u96c6\u7fa4\u4e2d\u7684\u6bcf\u500b Pod (\u5373\u4f7f\u662f\u5728\u540c\u4e00\u500b Node \u4e0a\u7684 Pod )\u90fd\u6709\u4e00\u500b\u552f\u4e00\u7684 IP \u5730\u5740\uff0c\u56e0\u6b64\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u81ea\u52d5\u5354\u8abf Pod \u4e4b\u9593\u7684\u8b8a\u66f4\uff0c\u4ee5\u4fbf\u61c9\u7528\u7a0b\u5e8f\u4fdd\u6301\u904b\u884c\u3002 Kubernetes \u4e2d\u7684\u670d\u52d9(Service)\u662f\u4e00\u7a2e\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u5b9a\u7fa9\u4e86 Pod \u7684\u908f\u8f2f\u96c6\u548c\u8a2a\u554f Pod \u7684\u5354\u8b70\u3002 Service \u4f7f\u5f9e\u5c6c Pod \u4e4b\u9593\u7684\u677e\u8026\u5408\u6210\u70ba\u53ef\u80fd\u3002\u548c\u5176\u4ed6 Kubernetes \u5c0d\u50cf\u4e00\u6a23, Service \u7528 YAML (\u66f4\u63a8\u85a6) \u6216\u8005 JSON \u4f86\u5b9a\u7fa9. Service \u4e0b\u7684\u4e00\u7d44 Pod \u901a\u5e38\u7531 LabelSelector (\u8acb\u53c3\u95b1\u4e0b\u9762\u7684\u8aaa\u660e\u70ba\u4ec0\u9ebc\u4f60\u53ef\u80fd\u60f3\u8981\u4e00\u500b spec \u4e2d\u4e0d\u5305\u542b selector \u7684\u670d\u52d9)\u4f86\u6a19\u8a18\u3002 \u5118\u7ba1\u6bcf\u500b Pod \u90fd\u6709\u4e00\u500b\u552f\u4e00\u7684 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c\u6c92\u6709 Service \uff0c\u9019\u4e9b IP \u4e0d\u6703\u66b4\u9732\u5728\u96c6\u7fa4\u5916\u90e8\u3002 Service \u5141\u8a31\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u63a5\u6536\u6d41\u91cf\u3002 Service \u4e5f\u4ee5\u7528 ServiceSpec \u6a19\u8a18 type \u7684\u65b9\u5f0f\u4f86\u9078\u64a2\u66b4\u9732\u7684\u578b\u5f0f: ClusterIP (\u9ed8\u8a8d) - \u5728\u96c6\u7fa4\u7684\u5167\u90e8 IP \u4e0a\u516c\u958b Service \u3002\u9019\u7a2e\u985e\u578b\u4f7f\u5f97 Service \u53ea\u80fd\u5f9e\u96c6\u7fa4\u5167\u8a2a\u554f\u3002 NodePort - \u4f7f\u7528 NAT \u5728\u96c6\u7fa4\u4e2d\u6bcf\u500b\u9078\u5b9a Node \u7684\u76f8\u540c\u7aef\u53e3\u4e0a\u516c\u958b Service \u3002\u4f7f\u7528 : \u5f9e\u96c6\u7fa4\u5916\u90e8\u8a2a\u554f Service\u3002\u662f ClusterIP \u7684\u8d85\u96c6\u3002 LoadBalancer - \u5728\u7576\u524d\u96f2\u4e2d\u5275\u5efa\u4e00\u500b\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668(\u5982\u679c\u652f\u6301\u7684\u8a71)\uff0c\u4e26\u70ba Service \u5206\u914d\u4e00\u500b\u56fa\u5b9a\u7684\u5916\u90e8IP\u3002\u662f NodePort \u7684\u8d85\u96c6\u3002 ExternalName - \u901a\u904e\u8fd4\u56de\u5e36\u6709\u8a72\u540d\u7a31\u7684 CNAME \u8a18\u9304\uff0c\u4f7f\u7528\u4efb\u610f\u540d\u7a31(\u7531 spec \u4e2d\u7684externalName\u6307\u5b9a)\u516c\u958b Service\u3002\u4e0d\u4f7f\u7528\u4ee3\u7406\u3002\u9019\u7a2e\u985e\u578b\u9700\u8981kube-dns\u7684v1.7\u6216\u66f4\u9ad8\u7248\u672c\u3002 \u66f4\u591a\u95dc\u65bc\u4e0d\u540c Service \u985e\u578b\u7684\u4fe1\u606f\u53ef\u4ee5\u5728\u4f7f\u7528 Source IP \u6559\u7a0b \u3002\u4e5f\u8acb\u53c3\u95b1 \u9023\u63a5\u61c9\u7528\u7a0b\u5e8f\u548c Service \u3002 \u53e6\u5916\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u6709\u4e00\u4e9b Service \u7684\u7528\u4f8b\u6c92\u6709\u5728 spec \u4e2d\u5b9a\u7fa9 selector \u3002 \u4e00\u500b\u6c92\u6709 selector \u5275\u5efa\u7684 Service \u4e5f\u4e0d\u6703\u5275\u5efa\u76f8\u61c9\u7684\u7aef\u9ede\u5c0d\u8c61 \u3002\u9019\u5141\u8a31\u7528\u6236\u624b\u52d5\u5c07\u670d\u52d9\u6620\u5c04\u5230\u7279\u5b9a\u7684\u7aef\u9ede\u3002\u6c92\u6709 selector \u7684\u53e6\u4e00\u7a2e\u53ef\u80fd\u662f\u4f60\u56b4\u683c\u4f7f\u7528type: ExternalName \u4f86\u6a19\u8a18\u3002 Service \u548c Label \u00b6 Service \u901a\u904e\u4e00\u7d44 Pod \u8def\u7531\u901a\u4fe1\u3002 Service \u662f\u4e00\u7a2e\u62bd\u8c61\uff0c\u5b83\u5141\u8a31 Pod \u6b7b\u4ea1\u4e26\u5728 Kubernetes \u4e2d\u5fa9\u5236\uff0c\u800c\u4e0d\u6703\u5f71\u97ff\u61c9\u7528\u7a0b\u5e8f\u3002\u5728\u4f9d\u8cf4\u7684 Pod (\u5982\u61c9\u7528\u7a0b\u5e8f\u4e2d\u7684\u524d\u7aef\u548c\u5f8c\u7aef\u7d44\u4ef6)\u4e4b\u9593\u9032\u884c\u767c\u73fe\u548c\u8def\u7531\u662f\u7531 Kubernetes Service \u8655\u7406\u7684\u3002 Service \u5339\u914d\u4e00\u7d44 Pod \u662f\u4f7f\u7528 \u6a19\u7c64(Label)\u548c\u9078\u64c7\u5668(Selector) , \u5b83\u5011\u662f\u5141\u8a31\u5c0d Kubernetes \u4e2d\u7684\u5c0d\u8c61\u9032\u884c\u908f\u8f2f\u64cd\u4f5c\u7684\u4e00\u7a2e\u5206\u7d44\u539f\u8a9e\u3002\u6a19\u7c64(Label)\u662f\u9644\u52a0\u5728\u5c0d\u50cf\u4e0a\u7684\u9375/\u503c\u5c0d\uff0c\u53ef\u4ee5\u4ee5\u591a\u7a2e\u65b9\u5f0f\u4f7f\u7528: \u6307\u5b9a\u7528\u65bc\u958b\u767c\uff0c\u6e2c\u8a66\u548c\u751f\u7522\u7684\u5c0d\u8c61 \u5d4c\u5165\u7248\u672c\u6a19\u7c64 \u4f7f\u7528 Label \u5c07\u5c0d\u8c61\u9032\u884c\u5206\u985e \u6a19\u7c64(Label)\u53ef\u4ee5\u5728\u5275\u5efa\u6642\u6216\u4e4b\u5f8c\u9644\u52a0\u5230\u5c0d\u8c61\u4e0a\u3002\u4ed6\u5011\u53ef\u4ee5\u96a8\u6642\u88ab\u4fee\u6539\u3002\u73fe\u5728\u4f7f\u7528 Service \u767c\u5e03\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u4e26\u6dfb\u52a0\u4e00\u4e9b Label \u3002 \u5275\u5efa\u65b0\u670d\u52d9 \u00b6 \u8b93\u6211\u5011\u9a57\u8b49\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002\u6211\u5011\u5c07\u4f7f\u7528 kubectl get \u547d\u4ee4\u4e26\u67e5\u627e\u73fe\u6709\u7684 Pod\uff1a kubectl get pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-57978f5f5d-jsdct 1/1 Running 0 124m \u63a5\u4e0b\u4f86\uff0c\u8b93\u6211\u5011\u5217\u51fa\u96c6\u7fa4\u4e2d\u7684\u7576\u524d\u670d\u52d9\uff1a kubectl get services \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 3h54m \u6211\u5011\u6709\u4e00\u500b\u540d\u70ba kubernetes \u7684\u670d\u52d9\uff0c\u5b83\u5728 K3D \u555f\u52d5\u96c6\u7fa4\u6642\u9ed8\u8a8d\u5275\u5efa\u3002\u8981\u5275\u5efa\u65b0\u670d\u52d9\u4e26\u5c07\u5176\u516c\u958b\u7d66\u5916\u90e8\u6d41\u91cf\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u5e36\u6709 NodePort \u4f5c\u70ba\u53c3\u6578\u7684\u516c\u958b\u547d\u4ee4\u3002 k8s-bootcamp-service-nodeport.yaml cat > k8s-bootcamp-service-nodeport.yaml <<EOF apiVersion: v1 kind: Service metadata: labels: app: kubernetes-bootcamp name: kubernetes-bootcamp spec: ports: - port: 8080 nodePort: 30000 # assign specific host port protocol: TCP targetPort: 8080 selector: app: kubernetes-bootcamp type: NodePort EOF \u5957\u7528 Service \u7684\u8a2d\u7f6e\u5230 Kubernetes \u96c6\u7fa4: kubectl apply -f k8s-bootcamp-service-nodeport.yaml \u8b93\u6211\u5011\u518d\u6b21\u904b\u884c get services \u547d\u4ee4\uff1a kubectl get services \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 32m kubernetes-bootcamp NodePort 10.43.10.162 <none> 8080:30000/TCP 4m18s \u6211\u5011\u73fe\u5728\u6709\u4e00\u500b\u540d\u70ba kubernetes-bootcamp \u7684\u6b63\u5728\u904b\u884c\u7684\u670d\u52d9\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u770b\u5230\u670d\u52d9\u6536\u5230\u4e86\u4e00\u500b\u552f\u4e00\u7684\u96c6\u7fa4 IP\u3001\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u548c\u4e00\u500b\u5916\u90e8 IP\uff08\u7bc0\u9ede\u7684 IP\uff09\u3002 \u8981\u627e\u51fa\u5916\u90e8\u6253\u958b\u7684\u7aef\u53e3\uff08\u901a\u904e NodePort \u9078\u9805\uff09\uff0c\u6211\u5011\u5c07\u904b\u884c describe service \u547d\u4ee4\uff1a kubectl describe services/kubernetes-bootcamp \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Name: kubernetes-bootcamp Namespace: default Labels: app=kubernetes-bootcamp Annotations: <none> Selector: app=kubernetes-bootcamp Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.10.162 IPs: 10.43.10.162 Port: <unset> 8080/TCP TargetPort: 8080/TCP NodePort: <unset> 30000/TCP Endpoints: 10.42.0.7:8080 Session Affinity: None External Traffic Policy: Cluster Events: <none> \u73fe\u5728\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 curl \u4f86\u6e2c\u8a66\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u66b4\u9732\u5728\u96c6\u7fa4\u4e4b\u5916\uff1a curl localhost:30000 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-cmbm4 | v=1","title":"\u516c\u958b\u66dd\u9732\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/expose/#_1","text":"","title":"\u516c\u958b\u66dd\u9732\u4f60\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/expose/#service","text":"\u76ee\u6a19: \u4e86\u89e3 Kubernetes \u4e2d\u7684 Service \u4e86\u89e3 \u6a19\u7c64(Label) \u548c \u6a19\u7c64\u9078\u64c7\u5668(Label Selector) \u5c0d\u50cf\u5982\u4f55\u8207 Service \u95dc\u806f \u5728 Kubernetes \u96c6\u7fa4\u5916\u7528 Service \u66b4\u9732\u61c9\u7528","title":"\u4f7f\u7528 Service \u66dd\u9732\u4f60\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/expose/#kubernetes-service","text":"Kubernetes Pod \u662f\u8f49\u77ac\u5373\u901d\u7684\u3002 Pod \u5be6\u969b\u4e0a\u64c1\u6709 \u751f\u547d\u9031\u671f \u3002 \u7576\u4e00\u500b\u5de5\u4f5c Node \u639b\u6389\u5f8c, \u5728 Node \u4e0a\u904b\u884c\u7684 Pod \u4e5f\u6703\u6d88\u4ea1\u3002 ReplicaSet \u6703\u81ea\u52d5\u5730\u901a\u904e\u5275\u5efa\u65b0\u7684 Pod \u9a45\u52d5\u96c6\u7fa4\u56de\u5230\u76ee\u6a19\u72c0\u614b\uff0c\u4ee5\u4fdd\u8b49\u61c9\u7528\u7a0b\u5e8f\u6b63\u5e38\u904b\u884c\u3002 \u63db\u4e00\u500b\u4f8b\u5b50\uff0c\u8003\u616e\u4e00\u500b\u5177\u67093\u500b\u526f\u672c\u6578\u7684\u7528\u4f5c\u5716\u50cf\u8655\u7406\u7684\u5f8c\u7aef\u7a0b\u5e8f\u3002\u9019\u4e9b\u526f\u672c\u662f\u53ef\u66ff\u63db\u7684; \u524d\u7aef\u7cfb\u7d71\u4e0d\u61c9\u8a72\u95dc\u5fc3\u5f8c\u7aef\u526f\u672c\uff0c\u5373\u4f7f Pod \u4e1f\u5931\u6216\u91cd\u65b0\u5275\u5efa\u3002 \u4e5f\u5c31\u662f\u8aaa\uff0cKubernetes \u96c6\u7fa4\u4e2d\u7684\u6bcf\u500b Pod (\u5373\u4f7f\u662f\u5728\u540c\u4e00\u500b Node \u4e0a\u7684 Pod )\u90fd\u6709\u4e00\u500b\u552f\u4e00\u7684 IP \u5730\u5740\uff0c\u56e0\u6b64\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u81ea\u52d5\u5354\u8abf Pod \u4e4b\u9593\u7684\u8b8a\u66f4\uff0c\u4ee5\u4fbf\u61c9\u7528\u7a0b\u5e8f\u4fdd\u6301\u904b\u884c\u3002 Kubernetes \u4e2d\u7684\u670d\u52d9(Service)\u662f\u4e00\u7a2e\u62bd\u8c61\u6982\u5ff5\uff0c\u5b83\u5b9a\u7fa9\u4e86 Pod \u7684\u908f\u8f2f\u96c6\u548c\u8a2a\u554f Pod \u7684\u5354\u8b70\u3002 Service \u4f7f\u5f9e\u5c6c Pod \u4e4b\u9593\u7684\u677e\u8026\u5408\u6210\u70ba\u53ef\u80fd\u3002\u548c\u5176\u4ed6 Kubernetes \u5c0d\u50cf\u4e00\u6a23, Service \u7528 YAML (\u66f4\u63a8\u85a6) \u6216\u8005 JSON \u4f86\u5b9a\u7fa9. Service \u4e0b\u7684\u4e00\u7d44 Pod \u901a\u5e38\u7531 LabelSelector (\u8acb\u53c3\u95b1\u4e0b\u9762\u7684\u8aaa\u660e\u70ba\u4ec0\u9ebc\u4f60\u53ef\u80fd\u60f3\u8981\u4e00\u500b spec \u4e2d\u4e0d\u5305\u542b selector \u7684\u670d\u52d9)\u4f86\u6a19\u8a18\u3002 \u5118\u7ba1\u6bcf\u500b Pod \u90fd\u6709\u4e00\u500b\u552f\u4e00\u7684 IP \u5730\u5740\uff0c\u4f46\u662f\u5982\u679c\u6c92\u6709 Service \uff0c\u9019\u4e9b IP \u4e0d\u6703\u66b4\u9732\u5728\u96c6\u7fa4\u5916\u90e8\u3002 Service \u5141\u8a31\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u63a5\u6536\u6d41\u91cf\u3002 Service \u4e5f\u4ee5\u7528 ServiceSpec \u6a19\u8a18 type \u7684\u65b9\u5f0f\u4f86\u9078\u64a2\u66b4\u9732\u7684\u578b\u5f0f: ClusterIP (\u9ed8\u8a8d) - \u5728\u96c6\u7fa4\u7684\u5167\u90e8 IP \u4e0a\u516c\u958b Service \u3002\u9019\u7a2e\u985e\u578b\u4f7f\u5f97 Service \u53ea\u80fd\u5f9e\u96c6\u7fa4\u5167\u8a2a\u554f\u3002 NodePort - \u4f7f\u7528 NAT \u5728\u96c6\u7fa4\u4e2d\u6bcf\u500b\u9078\u5b9a Node \u7684\u76f8\u540c\u7aef\u53e3\u4e0a\u516c\u958b Service \u3002\u4f7f\u7528 : \u5f9e\u96c6\u7fa4\u5916\u90e8\u8a2a\u554f Service\u3002\u662f ClusterIP \u7684\u8d85\u96c6\u3002 LoadBalancer - \u5728\u7576\u524d\u96f2\u4e2d\u5275\u5efa\u4e00\u500b\u5916\u90e8\u8ca0\u8f09\u5747\u8861\u5668(\u5982\u679c\u652f\u6301\u7684\u8a71)\uff0c\u4e26\u70ba Service \u5206\u914d\u4e00\u500b\u56fa\u5b9a\u7684\u5916\u90e8IP\u3002\u662f NodePort \u7684\u8d85\u96c6\u3002 ExternalName - \u901a\u904e\u8fd4\u56de\u5e36\u6709\u8a72\u540d\u7a31\u7684 CNAME \u8a18\u9304\uff0c\u4f7f\u7528\u4efb\u610f\u540d\u7a31(\u7531 spec \u4e2d\u7684externalName\u6307\u5b9a)\u516c\u958b Service\u3002\u4e0d\u4f7f\u7528\u4ee3\u7406\u3002\u9019\u7a2e\u985e\u578b\u9700\u8981kube-dns\u7684v1.7\u6216\u66f4\u9ad8\u7248\u672c\u3002 \u66f4\u591a\u95dc\u65bc\u4e0d\u540c Service \u985e\u578b\u7684\u4fe1\u606f\u53ef\u4ee5\u5728\u4f7f\u7528 Source IP \u6559\u7a0b \u3002\u4e5f\u8acb\u53c3\u95b1 \u9023\u63a5\u61c9\u7528\u7a0b\u5e8f\u548c Service \u3002 \u53e6\u5916\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u6709\u4e00\u4e9b Service \u7684\u7528\u4f8b\u6c92\u6709\u5728 spec \u4e2d\u5b9a\u7fa9 selector \u3002 \u4e00\u500b\u6c92\u6709 selector \u5275\u5efa\u7684 Service \u4e5f\u4e0d\u6703\u5275\u5efa\u76f8\u61c9\u7684\u7aef\u9ede\u5c0d\u8c61 \u3002\u9019\u5141\u8a31\u7528\u6236\u624b\u52d5\u5c07\u670d\u52d9\u6620\u5c04\u5230\u7279\u5b9a\u7684\u7aef\u9ede\u3002\u6c92\u6709 selector \u7684\u53e6\u4e00\u7a2e\u53ef\u80fd\u662f\u4f60\u56b4\u683c\u4f7f\u7528type: ExternalName \u4f86\u6a19\u8a18\u3002","title":"Kubernetes Service \u7e3d\u89bd"},{"location":"kubernetes/04-tutorials/kubernetes-basics/expose/#service-label","text":"Service \u901a\u904e\u4e00\u7d44 Pod \u8def\u7531\u901a\u4fe1\u3002 Service \u662f\u4e00\u7a2e\u62bd\u8c61\uff0c\u5b83\u5141\u8a31 Pod \u6b7b\u4ea1\u4e26\u5728 Kubernetes \u4e2d\u5fa9\u5236\uff0c\u800c\u4e0d\u6703\u5f71\u97ff\u61c9\u7528\u7a0b\u5e8f\u3002\u5728\u4f9d\u8cf4\u7684 Pod (\u5982\u61c9\u7528\u7a0b\u5e8f\u4e2d\u7684\u524d\u7aef\u548c\u5f8c\u7aef\u7d44\u4ef6)\u4e4b\u9593\u9032\u884c\u767c\u73fe\u548c\u8def\u7531\u662f\u7531 Kubernetes Service \u8655\u7406\u7684\u3002 Service \u5339\u914d\u4e00\u7d44 Pod \u662f\u4f7f\u7528 \u6a19\u7c64(Label)\u548c\u9078\u64c7\u5668(Selector) , \u5b83\u5011\u662f\u5141\u8a31\u5c0d Kubernetes \u4e2d\u7684\u5c0d\u8c61\u9032\u884c\u908f\u8f2f\u64cd\u4f5c\u7684\u4e00\u7a2e\u5206\u7d44\u539f\u8a9e\u3002\u6a19\u7c64(Label)\u662f\u9644\u52a0\u5728\u5c0d\u50cf\u4e0a\u7684\u9375/\u503c\u5c0d\uff0c\u53ef\u4ee5\u4ee5\u591a\u7a2e\u65b9\u5f0f\u4f7f\u7528: \u6307\u5b9a\u7528\u65bc\u958b\u767c\uff0c\u6e2c\u8a66\u548c\u751f\u7522\u7684\u5c0d\u8c61 \u5d4c\u5165\u7248\u672c\u6a19\u7c64 \u4f7f\u7528 Label \u5c07\u5c0d\u8c61\u9032\u884c\u5206\u985e \u6a19\u7c64(Label)\u53ef\u4ee5\u5728\u5275\u5efa\u6642\u6216\u4e4b\u5f8c\u9644\u52a0\u5230\u5c0d\u8c61\u4e0a\u3002\u4ed6\u5011\u53ef\u4ee5\u96a8\u6642\u88ab\u4fee\u6539\u3002\u73fe\u5728\u4f7f\u7528 Service \u767c\u5e03\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u4e26\u6dfb\u52a0\u4e00\u4e9b Label \u3002","title":"Service \u548c Label"},{"location":"kubernetes/04-tutorials/kubernetes-basics/expose/#_2","text":"\u8b93\u6211\u5011\u9a57\u8b49\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002\u6211\u5011\u5c07\u4f7f\u7528 kubectl get \u547d\u4ee4\u4e26\u67e5\u627e\u73fe\u6709\u7684 Pod\uff1a kubectl get pods \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-57978f5f5d-jsdct 1/1 Running 0 124m \u63a5\u4e0b\u4f86\uff0c\u8b93\u6211\u5011\u5217\u51fa\u96c6\u7fa4\u4e2d\u7684\u7576\u524d\u670d\u52d9\uff1a kubectl get services \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 3h54m \u6211\u5011\u6709\u4e00\u500b\u540d\u70ba kubernetes \u7684\u670d\u52d9\uff0c\u5b83\u5728 K3D \u555f\u52d5\u96c6\u7fa4\u6642\u9ed8\u8a8d\u5275\u5efa\u3002\u8981\u5275\u5efa\u65b0\u670d\u52d9\u4e26\u5c07\u5176\u516c\u958b\u7d66\u5916\u90e8\u6d41\u91cf\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u5e36\u6709 NodePort \u4f5c\u70ba\u53c3\u6578\u7684\u516c\u958b\u547d\u4ee4\u3002 k8s-bootcamp-service-nodeport.yaml cat > k8s-bootcamp-service-nodeport.yaml <<EOF apiVersion: v1 kind: Service metadata: labels: app: kubernetes-bootcamp name: kubernetes-bootcamp spec: ports: - port: 8080 nodePort: 30000 # assign specific host port protocol: TCP targetPort: 8080 selector: app: kubernetes-bootcamp type: NodePort EOF \u5957\u7528 Service \u7684\u8a2d\u7f6e\u5230 Kubernetes \u96c6\u7fa4: kubectl apply -f k8s-bootcamp-service-nodeport.yaml \u8b93\u6211\u5011\u518d\u6b21\u904b\u884c get services \u547d\u4ee4\uff1a kubectl get services \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 32m kubernetes-bootcamp NodePort 10.43.10.162 <none> 8080:30000/TCP 4m18s \u6211\u5011\u73fe\u5728\u6709\u4e00\u500b\u540d\u70ba kubernetes-bootcamp \u7684\u6b63\u5728\u904b\u884c\u7684\u670d\u52d9\u3002\u5728\u9019\u88e1\uff0c\u6211\u5011\u770b\u5230\u670d\u52d9\u6536\u5230\u4e86\u4e00\u500b\u552f\u4e00\u7684\u96c6\u7fa4 IP\u3001\u4e00\u500b\u5167\u90e8\u7aef\u53e3\u548c\u4e00\u500b\u5916\u90e8 IP\uff08\u7bc0\u9ede\u7684 IP\uff09\u3002 \u8981\u627e\u51fa\u5916\u90e8\u6253\u958b\u7684\u7aef\u53e3\uff08\u901a\u904e NodePort \u9078\u9805\uff09\uff0c\u6211\u5011\u5c07\u904b\u884c describe service \u547d\u4ee4\uff1a kubectl describe services/kubernetes-bootcamp \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Name: kubernetes-bootcamp Namespace: default Labels: app=kubernetes-bootcamp Annotations: <none> Selector: app=kubernetes-bootcamp Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.10.162 IPs: 10.43.10.162 Port: <unset> 8080/TCP TargetPort: 8080/TCP NodePort: <unset> 30000/TCP Endpoints: 10.42.0.7:8080 Session Affinity: None External Traffic Policy: Cluster Events: <none> \u73fe\u5728\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 curl \u4f86\u6e2c\u8a66\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u66b4\u9732\u5728\u96c6\u7fa4\u4e4b\u5916\uff1a curl localhost:30000 \u8f38\u51fa\u7d50\u679c\u985e\u4f3c\u65bc\u9019\u6a23\uff1a Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-cmbm4 | v=1","title":"\u5275\u5efa\u65b0\u670d\u52d9"},{"location":"kubernetes/04-tutorials/kubernetes-basics/scale/","text":"\u7e2e\u653e\u4f60\u7684\u61c9\u7528 \u00b6 \u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u591a\u500b\u5be6\u4f8b \u00b6 \u76ee\u6a19: \u7528 kubectl \u64f4\u7e2e\u61c9\u7528\u7a0b\u5e8f \u64f4\u7e2e\u61c9\u7528\u7a0b\u5e8f \u00b6 \u5728\u4e4b\u524d\u7684\u6a21\u584a\u4e2d\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b Deployment\uff0c\u7136\u5f8c\u901a\u904e Service \u8b93\u5176\u53ef\u4ee5\u88ab\u8a2a\u554f\u3002 Deployment \u50c5\u70ba\u8dd1\u9019\u500b\u61c9\u7528\u7a0b\u5e8f\u5275\u5efa\u4e86\u4e00\u500b Pod\u3002\u7576\u6d41\u91cf\u589e\u52a0\u6642\uff0c\u6211\u5011\u9700\u8981\u64f4\u5bb9\u61c9\u7528\u7a0b\u5e8f\u6eff\u8db3\u7528\u6236\u9700\u6c42\u3002 \u6c34\u5e73\u64f4\u5145 \u662f\u901a\u904e\u6539\u8b8a Deployment \u4e2d\u7684 --replicas \u53c3\u6578\u4f86\u5be6\u73fe\u7684\u3002 \u64f4\u5c55(scale out)\uff0cDeployment \u5c07\u5275\u5efa\u65b0\u7684 Pods\uff0c\u4e26\u5c07\u8cc7\u6e90\u8abf\u5ea6\u8acb\u6c42\u5206\u914d\u5230\u6709\u53ef\u7528\u8cc7\u6e90\u7684\u7bc0\u9ede\u4e0a\uff0c\u6536\u7e2e(scale in) \u6703\u5c07 Pods \u6578\u91cf\u6e1b\u5c11\u81f3\u6240\u9700\u7684\u72c0\u614b\u3002 Kubernetes \u9084\u652f\u6301 Pods \u7684\u81ea\u52d5\u7e2e\u653e\uff0c\u4f46\u9019\u4e26\u4e0d\u5728\u672c\u6559\u7a0b\u7684\u8a0e\u8ad6\u7bc4\u570d\u5167\u3002\u5c07 Pods \u6578\u91cf\u6536\u7e2e\u5230 0 \u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u9019\u6703\u7d42\u6b62 Deployment \u4e0a\u6240\u6709\u5df2\u7d93\u90e8\u7f72\u7684 Pods\u3002 \u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u591a\u500b\u5be6\u4f8b\u9700\u8981\u5728\u5b83\u5011\u4e4b\u9593\u5206\u914d\u6d41\u91cf\u3002\u670d\u52d9 (Service)\u6709\u4e00\u7a2e\u8ca0\u8f09\u5747\u8861\u5668\u985e\u578b\uff0c\u53ef\u4ee5\u5c07\u7db2\u7d61\u6d41\u91cf\u5747\u8861\u5206\u914d\u5230\u5916\u90e8\u53ef\u8a2a\u554f\u7684 Pods \u4e0a\u3002\u670d\u52d9\u5c07\u6703\u4e00\u76f4\u901a\u904e\u7aef\u9ede\u4f86\u76e3\u8996 Pods \u7684\u904b\u884c\uff0c\u4fdd\u8b49\u6d41\u91cf\u53ea\u5206\u914d\u5230\u53ef\u7528\u7684 Pods \u4e0a\u3002 \u4e00\u65e6\u6709\u4e86\u591a\u500b\u61c9\u7528\u5be6\u4f8b\uff0c\u5c31\u53ef\u4ee5\u6c92\u6709\u5b95\u6a5f\u5730\u6efe\u52d5\u66f4\u65b0\u3002\u6211\u5011\u5c07\u6703\u5728\u4e0b\u9762\u7684\u6a21\u584a\u4e2d\u4ecb\u7d39\u9019\u4e9b\u3002\u73fe\u5728\u8b93\u6211\u5011\u9ad4\u9a57\u4e00\u4e0b\u61c9\u7528\u7a0b\u5e8f\u7684\u64f4\u7e2e\u904e\u7a0b\u3002 \u64f4\u5c55\u90e8\u7f72 \u00b6 \u8981\u5217\u51fa\u60a8\u7684\u90e8\u7f72\uff0c\u8acb\u4f7f\u7528 kubectl get deployments \u547d\u4ee4: kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 1/1 1 1 11m \u6211\u5011\u61c9\u8a72\u6709 1 \u500b Pod\u3002\u7531\u6b64\u53ef\u898b\uff1a NAME \u5217\u51fa\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684\u540d\u7a31\u3002 READY \u986f\u793a CURRENT/DESIRED \u526f\u672c\u7684\u6bd4\u7387 UP-TO-DATE \u986f\u793a\u5df2\u66f4\u65b0\u4ee5\u9054\u5230\u6240\u9700\u72c0\u614b\u7684\u526f\u672c\u6578\u3002 AVAILABLE \u986f\u793a\u6709\u591a\u5c11\u61c9\u7528\u7a0b\u5e8f\u526f\u672c\u53ef\u4f9b\u7528\u6236\u4f7f\u7528\u3002 AGE \u986f\u793a\u61c9\u7528\u7a0b\u5e8f\u904b\u884c\u7684\u6642\u9593\u91cf\u3002 \u8981\u67e5\u770b Deployment \u5275\u5efa\u7684 ReplicaSet\uff0c\u8acb\u904b\u884c kubectl get rs : kubectl get rs \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME DESIRED CURRENT READY AGE kubernetes-bootcamp-57978f5f5d 1 1 1 11m \u8acb\u6ce8\u610f\uff0cReplicaSet \u7684\u540d\u7a31\u59cb\u7d42\u683c\u5f0f\u5316\u70ba [DEPLOYMENT-NAME]-[RANDOM-STRING]\u3002\u96a8\u6a5f\u5b57\u7b26\u4e32\u662f\u96a8\u6a5f\u751f\u6210\u7684\uff0c\u4e26\u4f7f\u7528 pod-template-hash \u4f5c\u70ba\u7a2e\u5b50\u3002 \u6b64\u547d\u4ee4\u7d50\u679c\u6703\u5c55\u793a\u51fa\u5169\u500b\u91cd\u8981\u8cc7\u8a0a\u5217\uff1a DESIRED \u986f\u793a\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u526f\u672c\u6578\uff0c\u60a8\u5728\u5275\u5efa\u90e8\u7f72\u6642\u5b9a\u7fa9\u3002\u9019\u662f\u671f\u671b\u7684\u72c0\u614b\u3002 CURRENT \u986f\u793a\u7576\u524d\u6b63\u5728\u904b\u884c\u7684\u526f\u672c\u6578\u3002 \u63a5\u4e0b\u4f86\uff0c\u8b93\u6211\u5011\u5c07 Deployment \u64f4\u5c55\u5230 4 \u500b\u526f\u672c\u3002\u6211\u5011\u5c07\u4f7f\u7528 kubectl scale \u547d\u4ee4\uff0c\u5f8c\u8ddf\u90e8\u7f72\u985e\u578b\u3001\u540d\u7a31\u548c\u6240\u9700\u7684\u5be6\u4f8b\u6578\u91cf\uff1a kubectl scale deployments/kubernetes-bootcamp --replicas = 4 \u8981\u51fa\u90e8\u7f72: kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 4/4 4 4 10m \u66f4\u6539\u5df2\u61c9\u7528\uff0c\u6211\u5011\u6709 4 \u500b\u53ef\u7528\u7684\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u3002\u63a5\u4e0b\u4f86\uff0c\u8b93\u6211\u5011\u6aa2\u67e5 Pod \u7684\u6578\u91cf\u662f\u5426\u767c\u751f\u4e86\u8b8a\u5316\uff1a kubectl get pods -o wide \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES kubernetes-bootcamp-57978f5f5d-844f2 1/1 Running 0 16s 10.42.0.15 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-csrqd 1/1 Running 0 16s 10.42.0.14 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-lz4l7 1/1 Running 0 16s 10.42.0.16 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-n2lb8 1/1 Running 0 16s 10.42.0.13 k3d-k3s-default-server-0 <none> <none> \u73fe\u5728\u6709 4 \u500b Pod\uff0c\u5177\u6709\u4e0d\u540c\u7684 IP \u5730\u5740\u3002\u66f4\u6539\u5df2\u5728\u90e8\u7f72\u4e8b\u4ef6\u65e5\u8a8c\u4e2d\u8a3b\u518a\u3002\u8981\u6aa2\u67e5\u9019\u4e00\u9ede\uff0c\u8acb\u4f7f\u7528 describe \u547d\u4ee4\uff1a kubectl describe deployments/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp Namespace: default CreationTimestamp: Tue, 02 Aug 2022 18:04:17 +0800 Labels: app=kubernetes-bootcamp Annotations: deployment.kubernetes.io/revision: 1 Selector: app=kubernetes-bootcamp Replicas: 4 desired | 4 updated | 4 total | 4 available | 0 unavailable StrategyType: RollingUpdate MinReadySeconds: 0 RollingUpdateStrategy: 25% max unavailable, 25% max surge Pod Template: Labels: app=kubernetes-bootcamp Containers: kubernetes-bootcamp: Image: gcr.io/google-samples/kubernetes-bootcamp:v1 Port: <none> Host Port: <none> Environment: <none> Mounts: <none> Volumes: <none> Conditions: Type Status Reason ---- ------ ------ Progressing True NewReplicaSetAvailable Available True MinimumReplicasAvailable OldReplicaSets: <none> NewReplicaSet: kubernetes-bootcamp-57978f5f5d (4/4 replicas created) Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 2m1s (x2 over 4m47s) deployment-controller Scaled up replica set kubernetes-bootcamp-57978f5f5d to 4 \u8ca0\u8f09\u5747\u8861 \u00b6 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b Service \u662f\u5426\u6b63\u5728\u5c0d\u6d41\u91cf\u9032\u884c\u8ca0\u8f09\u5e73\u8861\u3002\u8981\u627e\u51fa\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u6211\u5011\u5728\u4e0a\u4e00\u500b\u6a21\u584a\u4e2d\u5b78\u7fd2\u7684\u63cf\u8ff0\u670d\u52d9\uff1a kubectl describe services/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp Namespace: default Labels: app=kubernetes-bootcamp Annotations: <none> Selector: app=kubernetes-bootcamp Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.10.162 IPs: 10.43.10.162 Port: <unset> 8080/TCP TargetPort: 8080/TCP NodePort: <unset> 30000/TCP Endpoints: 10.42.0.13:8080,10.42.0.14:8080,10.42.0.15:8080 + 1 more... Session Affinity: None External Traffic Policy: Cluster Events: <none> \u5275\u5efa\u4e00\u500b\u540d\u70ba NODE_PORT \u7684\u74b0\u5883\u8b8a\u91cf\uff0c\u5176\u503c\u70ba Node \u7aef\u53e3\uff1a export NODE_PORT = $( kubectl get services/kubernetes-bootcamp -o go-template = '{{(index .spec.ports 0).nodePort}}' ) echo NODE_PORT = $NODE_PORT \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u5c0d\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\u9032\u884c curl\u3002\u591a\u6b21\u57f7\u884c\u547d\u4ee4\uff1a $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-lz4l7 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-lz4l7 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-n2lb8 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-lz4l7 | v = 1 \u6211\u5011\u91dd\u5c0d\u6bcf\u500b\u8acb\u6c42\u8a2a\u554f\u4e0d\u540c\u7684 Pod\u3002\u9019\u8868\u660e\u8ca0\u8f09\u5e73\u8861\u6b63\u5728\u5de5\u4f5c\u3002 \u7e2e\u5c0f Scale down \u00b6 \u8981\u5c07\u670d\u52d9\u7e2e\u6e1b\u70ba 2 \u500b\u526f\u672c\uff0c\u8acb\u518d\u6b21\u904b\u884c scale \u547d\u4ee4\uff1a kubectl scale deployments/kubernetes-bootcamp --replicas = 2 \u5217\u51fa\u90e8\u7f72\u4ee5\u6aa2\u67e5\u662f\u5426\u4f7f\u7528 get deployments \u547d\u4ee4\u61c9\u7528\u4e86\u66f4\u6539\uff1a kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 2/2 2 2 43h \u526f\u672c\u6578\u6e1b\u5c11\u5230 2\u3002\u5217\u51fa Pod \u7684\u6578\u91cf\uff0c\u7528 get pods \uff1a kubectl get pods -o wide \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES kubernetes-bootcamp-57978f5f5d-844f2 1/1 Running 0 99m 10.42.0.15 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-csrqd 1/1 Running 0 99m 10.42.0.14 k3d-k3s-default-server-0 <none> <none> \u9019\u8b49\u5be6\u4e86 2 \u500b Pod \u88ab\u7d42\u6b62\u3002","title":"\u7e2e\u653e\u4f60\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/scale/#_1","text":"","title":"\u7e2e\u653e\u4f60\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/scale/#_2","text":"\u76ee\u6a19: \u7528 kubectl \u64f4\u7e2e\u61c9\u7528\u7a0b\u5e8f","title":"\u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u591a\u500b\u5be6\u4f8b"},{"location":"kubernetes/04-tutorials/kubernetes-basics/scale/#_3","text":"\u5728\u4e4b\u524d\u7684\u6a21\u584a\u4e2d\uff0c\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b Deployment\uff0c\u7136\u5f8c\u901a\u904e Service \u8b93\u5176\u53ef\u4ee5\u88ab\u8a2a\u554f\u3002 Deployment \u50c5\u70ba\u8dd1\u9019\u500b\u61c9\u7528\u7a0b\u5e8f\u5275\u5efa\u4e86\u4e00\u500b Pod\u3002\u7576\u6d41\u91cf\u589e\u52a0\u6642\uff0c\u6211\u5011\u9700\u8981\u64f4\u5bb9\u61c9\u7528\u7a0b\u5e8f\u6eff\u8db3\u7528\u6236\u9700\u6c42\u3002 \u6c34\u5e73\u64f4\u5145 \u662f\u901a\u904e\u6539\u8b8a Deployment \u4e2d\u7684 --replicas \u53c3\u6578\u4f86\u5be6\u73fe\u7684\u3002 \u64f4\u5c55(scale out)\uff0cDeployment \u5c07\u5275\u5efa\u65b0\u7684 Pods\uff0c\u4e26\u5c07\u8cc7\u6e90\u8abf\u5ea6\u8acb\u6c42\u5206\u914d\u5230\u6709\u53ef\u7528\u8cc7\u6e90\u7684\u7bc0\u9ede\u4e0a\uff0c\u6536\u7e2e(scale in) \u6703\u5c07 Pods \u6578\u91cf\u6e1b\u5c11\u81f3\u6240\u9700\u7684\u72c0\u614b\u3002 Kubernetes \u9084\u652f\u6301 Pods \u7684\u81ea\u52d5\u7e2e\u653e\uff0c\u4f46\u9019\u4e26\u4e0d\u5728\u672c\u6559\u7a0b\u7684\u8a0e\u8ad6\u7bc4\u570d\u5167\u3002\u5c07 Pods \u6578\u91cf\u6536\u7e2e\u5230 0 \u4e5f\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u9019\u6703\u7d42\u6b62 Deployment \u4e0a\u6240\u6709\u5df2\u7d93\u90e8\u7f72\u7684 Pods\u3002 \u904b\u884c\u61c9\u7528\u7a0b\u5e8f\u7684\u591a\u500b\u5be6\u4f8b\u9700\u8981\u5728\u5b83\u5011\u4e4b\u9593\u5206\u914d\u6d41\u91cf\u3002\u670d\u52d9 (Service)\u6709\u4e00\u7a2e\u8ca0\u8f09\u5747\u8861\u5668\u985e\u578b\uff0c\u53ef\u4ee5\u5c07\u7db2\u7d61\u6d41\u91cf\u5747\u8861\u5206\u914d\u5230\u5916\u90e8\u53ef\u8a2a\u554f\u7684 Pods \u4e0a\u3002\u670d\u52d9\u5c07\u6703\u4e00\u76f4\u901a\u904e\u7aef\u9ede\u4f86\u76e3\u8996 Pods \u7684\u904b\u884c\uff0c\u4fdd\u8b49\u6d41\u91cf\u53ea\u5206\u914d\u5230\u53ef\u7528\u7684 Pods \u4e0a\u3002 \u4e00\u65e6\u6709\u4e86\u591a\u500b\u61c9\u7528\u5be6\u4f8b\uff0c\u5c31\u53ef\u4ee5\u6c92\u6709\u5b95\u6a5f\u5730\u6efe\u52d5\u66f4\u65b0\u3002\u6211\u5011\u5c07\u6703\u5728\u4e0b\u9762\u7684\u6a21\u584a\u4e2d\u4ecb\u7d39\u9019\u4e9b\u3002\u73fe\u5728\u8b93\u6211\u5011\u9ad4\u9a57\u4e00\u4e0b\u61c9\u7528\u7a0b\u5e8f\u7684\u64f4\u7e2e\u904e\u7a0b\u3002","title":"\u64f4\u7e2e\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/04-tutorials/kubernetes-basics/scale/#_4","text":"\u8981\u5217\u51fa\u60a8\u7684\u90e8\u7f72\uff0c\u8acb\u4f7f\u7528 kubectl get deployments \u547d\u4ee4: kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 1/1 1 1 11m \u6211\u5011\u61c9\u8a72\u6709 1 \u500b Pod\u3002\u7531\u6b64\u53ef\u898b\uff1a NAME \u5217\u51fa\u96c6\u7fa4\u4e2d\u90e8\u7f72\u7684\u540d\u7a31\u3002 READY \u986f\u793a CURRENT/DESIRED \u526f\u672c\u7684\u6bd4\u7387 UP-TO-DATE \u986f\u793a\u5df2\u66f4\u65b0\u4ee5\u9054\u5230\u6240\u9700\u72c0\u614b\u7684\u526f\u672c\u6578\u3002 AVAILABLE \u986f\u793a\u6709\u591a\u5c11\u61c9\u7528\u7a0b\u5e8f\u526f\u672c\u53ef\u4f9b\u7528\u6236\u4f7f\u7528\u3002 AGE \u986f\u793a\u61c9\u7528\u7a0b\u5e8f\u904b\u884c\u7684\u6642\u9593\u91cf\u3002 \u8981\u67e5\u770b Deployment \u5275\u5efa\u7684 ReplicaSet\uff0c\u8acb\u904b\u884c kubectl get rs : kubectl get rs \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME DESIRED CURRENT READY AGE kubernetes-bootcamp-57978f5f5d 1 1 1 11m \u8acb\u6ce8\u610f\uff0cReplicaSet \u7684\u540d\u7a31\u59cb\u7d42\u683c\u5f0f\u5316\u70ba [DEPLOYMENT-NAME]-[RANDOM-STRING]\u3002\u96a8\u6a5f\u5b57\u7b26\u4e32\u662f\u96a8\u6a5f\u751f\u6210\u7684\uff0c\u4e26\u4f7f\u7528 pod-template-hash \u4f5c\u70ba\u7a2e\u5b50\u3002 \u6b64\u547d\u4ee4\u7d50\u679c\u6703\u5c55\u793a\u51fa\u5169\u500b\u91cd\u8981\u8cc7\u8a0a\u5217\uff1a DESIRED \u986f\u793a\u6240\u9700\u7684\u61c9\u7528\u7a0b\u5e8f\u526f\u672c\u6578\uff0c\u60a8\u5728\u5275\u5efa\u90e8\u7f72\u6642\u5b9a\u7fa9\u3002\u9019\u662f\u671f\u671b\u7684\u72c0\u614b\u3002 CURRENT \u986f\u793a\u7576\u524d\u6b63\u5728\u904b\u884c\u7684\u526f\u672c\u6578\u3002 \u63a5\u4e0b\u4f86\uff0c\u8b93\u6211\u5011\u5c07 Deployment \u64f4\u5c55\u5230 4 \u500b\u526f\u672c\u3002\u6211\u5011\u5c07\u4f7f\u7528 kubectl scale \u547d\u4ee4\uff0c\u5f8c\u8ddf\u90e8\u7f72\u985e\u578b\u3001\u540d\u7a31\u548c\u6240\u9700\u7684\u5be6\u4f8b\u6578\u91cf\uff1a kubectl scale deployments/kubernetes-bootcamp --replicas = 4 \u8981\u51fa\u90e8\u7f72: kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 4/4 4 4 10m \u66f4\u6539\u5df2\u61c9\u7528\uff0c\u6211\u5011\u6709 4 \u500b\u53ef\u7528\u7684\u61c9\u7528\u7a0b\u5e8f\u5be6\u4f8b\u3002\u63a5\u4e0b\u4f86\uff0c\u8b93\u6211\u5011\u6aa2\u67e5 Pod \u7684\u6578\u91cf\u662f\u5426\u767c\u751f\u4e86\u8b8a\u5316\uff1a kubectl get pods -o wide \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES kubernetes-bootcamp-57978f5f5d-844f2 1/1 Running 0 16s 10.42.0.15 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-csrqd 1/1 Running 0 16s 10.42.0.14 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-lz4l7 1/1 Running 0 16s 10.42.0.16 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-n2lb8 1/1 Running 0 16s 10.42.0.13 k3d-k3s-default-server-0 <none> <none> \u73fe\u5728\u6709 4 \u500b Pod\uff0c\u5177\u6709\u4e0d\u540c\u7684 IP \u5730\u5740\u3002\u66f4\u6539\u5df2\u5728\u90e8\u7f72\u4e8b\u4ef6\u65e5\u8a8c\u4e2d\u8a3b\u518a\u3002\u8981\u6aa2\u67e5\u9019\u4e00\u9ede\uff0c\u8acb\u4f7f\u7528 describe \u547d\u4ee4\uff1a kubectl describe deployments/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp Namespace: default CreationTimestamp: Tue, 02 Aug 2022 18:04:17 +0800 Labels: app=kubernetes-bootcamp Annotations: deployment.kubernetes.io/revision: 1 Selector: app=kubernetes-bootcamp Replicas: 4 desired | 4 updated | 4 total | 4 available | 0 unavailable StrategyType: RollingUpdate MinReadySeconds: 0 RollingUpdateStrategy: 25% max unavailable, 25% max surge Pod Template: Labels: app=kubernetes-bootcamp Containers: kubernetes-bootcamp: Image: gcr.io/google-samples/kubernetes-bootcamp:v1 Port: <none> Host Port: <none> Environment: <none> Mounts: <none> Volumes: <none> Conditions: Type Status Reason ---- ------ ------ Progressing True NewReplicaSetAvailable Available True MinimumReplicasAvailable OldReplicaSets: <none> NewReplicaSet: kubernetes-bootcamp-57978f5f5d (4/4 replicas created) Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal ScalingReplicaSet 2m1s (x2 over 4m47s) deployment-controller Scaled up replica set kubernetes-bootcamp-57978f5f5d to 4","title":"\u64f4\u5c55\u90e8\u7f72"},{"location":"kubernetes/04-tutorials/kubernetes-basics/scale/#_5","text":"\u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b Service \u662f\u5426\u6b63\u5728\u5c0d\u6d41\u91cf\u9032\u884c\u8ca0\u8f09\u5e73\u8861\u3002\u8981\u627e\u51fa\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u6211\u5011\u5728\u4e0a\u4e00\u500b\u6a21\u584a\u4e2d\u5b78\u7fd2\u7684\u63cf\u8ff0\u670d\u52d9\uff1a kubectl describe services/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp Namespace: default Labels: app=kubernetes-bootcamp Annotations: <none> Selector: app=kubernetes-bootcamp Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.10.162 IPs: 10.43.10.162 Port: <unset> 8080/TCP TargetPort: 8080/TCP NodePort: <unset> 30000/TCP Endpoints: 10.42.0.13:8080,10.42.0.14:8080,10.42.0.15:8080 + 1 more... Session Affinity: None External Traffic Policy: Cluster Events: <none> \u5275\u5efa\u4e00\u500b\u540d\u70ba NODE_PORT \u7684\u74b0\u5883\u8b8a\u91cf\uff0c\u5176\u503c\u70ba Node \u7aef\u53e3\uff1a export NODE_PORT = $( kubectl get services/kubernetes-bootcamp -o go-template = '{{(index .spec.ports 0).nodePort}}' ) echo NODE_PORT = $NODE_PORT \u63a5\u4e0b\u4f86\uff0c\u6211\u5011\u5c07\u5c0d\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\u9032\u884c curl\u3002\u591a\u6b21\u57f7\u884c\u547d\u4ee4\uff1a $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-lz4l7 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-lz4l7 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-844f2 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-n2lb8 | v = 1 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-57978f5f5d-lz4l7 | v = 1 \u6211\u5011\u91dd\u5c0d\u6bcf\u500b\u8acb\u6c42\u8a2a\u554f\u4e0d\u540c\u7684 Pod\u3002\u9019\u8868\u660e\u8ca0\u8f09\u5e73\u8861\u6b63\u5728\u5de5\u4f5c\u3002","title":"\u8ca0\u8f09\u5747\u8861"},{"location":"kubernetes/04-tutorials/kubernetes-basics/scale/#scale-down","text":"\u8981\u5c07\u670d\u52d9\u7e2e\u6e1b\u70ba 2 \u500b\u526f\u672c\uff0c\u8acb\u518d\u6b21\u904b\u884c scale \u547d\u4ee4\uff1a kubectl scale deployments/kubernetes-bootcamp --replicas = 2 \u5217\u51fa\u90e8\u7f72\u4ee5\u6aa2\u67e5\u662f\u5426\u4f7f\u7528 get deployments \u547d\u4ee4\u61c9\u7528\u4e86\u66f4\u6539\uff1a kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 2/2 2 2 43h \u526f\u672c\u6578\u6e1b\u5c11\u5230 2\u3002\u5217\u51fa Pod \u7684\u6578\u91cf\uff0c\u7528 get pods \uff1a kubectl get pods -o wide \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE READINESS GATES kubernetes-bootcamp-57978f5f5d-844f2 1/1 Running 0 99m 10.42.0.15 k3d-k3s-default-server-0 <none> <none> kubernetes-bootcamp-57978f5f5d-csrqd 1/1 Running 0 99m 10.42.0.14 k3d-k3s-default-server-0 <none> <none> \u9019\u8b49\u5be6\u4e86 2 \u500b Pod \u88ab\u7d42\u6b62\u3002","title":"\u7e2e\u5c0f Scale down"},{"location":"kubernetes/04-tutorials/kubernetes-basics/update/","text":"\u66f4\u65b0\u4f60\u7684\u61c9\u7528 \u00b6 \u57f7\u884c\u6efe\u52d5\u66f4\u65b0 \u00b6 \u76ee\u6a19: \u4f7f\u7528 kubectl \u9032\u884c\u61c9\u7528\u7248\u672c\u6efe\u52d5\u66f4\u65b0\u3002 \u66f4\u65b0\u61c9\u7528\u7a0b\u5e8f \u00b6 \u7528\u6236\u5e0c\u671b\u61c9\u7528\u7a0b\u5e8f\u59cb\u7d42\u53ef\u7528\uff0c\u800c\u958b\u767c\u4eba\u54e1\u5247\u9700\u8981\u6bcf\u5929\u591a\u6b21\u90e8\u7f72\u5b83\u5011\u7684\u65b0\u7248\u672c\u3002\u5728 Kubernetes \u4e2d\uff0c\u9019\u4e9b\u662f\u901a\u904e\u6efe\u52d5\u66f4\u65b0\uff08Rolling Updates\uff09\u5b8c\u6210\u7684\u3002 \u6efe\u52d5\u66f4\u65b0 \u5141\u8a31\u901a\u904e\u4f7f\u7528\u65b0\u7684\u5be6\u4f8b\u9010\u6b65\u66f4\u65b0 Pod \u5be6\u4f8b\uff0c\u96f6\u505c\u6a5f\u9032\u884c Deployment \u66f4\u65b0\u3002\u65b0\u7684 Pod \u5c07\u5728\u5177\u6709\u53ef\u7528\u8cc7\u6e90\u7684\u7bc0\u9ede\u4e0a\u9032\u884c\u8abf\u5ea6\u3002 \u5728\u524d\u9762\u7684\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u61c9\u7528\u7a0b\u5e8f\u64f4\u5c55\u70ba\u904b\u884c\u591a\u500b\u5be6\u4f8b\u3002\u9019\u662f\u5728\u4e0d\u5f71\u97ff\u61c9\u7528\u7a0b\u5e8f\u53ef\u7528\u6027\u7684\u60c5\u6cc1\u4e0b\u57f7\u884c\u66f4\u65b0\u7684\u8981\u6c42\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u66f4\u65b0\u671f\u9593\u4e0d\u53ef\u7528\u7684 pod \u7684\u6700\u5927\u503c\u548c\u53ef\u4ee5\u5275\u5efa\u7684\u65b0 pod \u6578\u90fd\u662f 1\u3002\u9019\u5169\u500b\u9078\u9805\u90fd\u53ef\u4ee5\u914d\u7f6e\u70ba\uff08pod\uff09\u6578\u5b57\u6216\u767e\u5206\u6bd4\u3002\u5728 Kubernetes \u4e2d\uff0c\u66f4\u65b0\u662f\u7d93\u904e\u7248\u672c\u63a7\u5236\u7684\uff0c\u4efb\u4f55 Deployment \u66f4\u65b0\u90fd\u53ef\u4ee5\u6062\u5fa9\u5230\u4ee5\u524d\u7684\uff08\u7a69\u5b9a\uff09\u7248\u672c\u3002 \u8207\u61c9\u7528\u7a0b\u5e8f\u64f4\u5c55\u985e\u4f3c\uff0c\u5982\u679c\u516c\u958b\u4e86 Deployment\uff0c\u670d\u52d9\u5c07\u5728\u66f4\u65b0\u671f\u9593\u50c5\u5c0d\u53ef\u7528\u7684 pod \u9032\u884c\u8ca0\u8f09\u5747\u8861\u3002\u53ef\u7528 Pod \u662f\u61c9\u7528\u7a0b\u5e8f\u7528\u6236\u53ef\u7528\u7684\u5be6\u4f8b\u3002 \u6efe\u52d5\u66f4\u65b0\u5141\u8a31\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5c07\u61c9\u7528\u7a0b\u5e8f\u5f9e\u4e00\u500b\u74b0\u5883\u63d0\u5347\u5230\u53e6\u4e00\u500b\u74b0\u5883\uff08\u901a\u904e\u5bb9\u5668\u93e1\u50cf\u66f4\u65b0\uff09 \u56de\u6efe\u5230\u4ee5\u524d\u7684\u7248\u672c \u6301\u7e8c\u96c6\u6210\u548c\u6301\u7e8c\u4ea4\u4ed8\u61c9\u7528\u7a0b\u5e8f\uff0c\u7121\u9700\u505c\u6a5f \u5728\u4e0b\u9762\u7684\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u61c9\u7528\u7a0b\u5e8f\u66f4\u65b0\u70ba\u65b0\u7248\u672c\uff0c\u4e26\u57f7\u884c\u56de\u6efe\u3002 \u66f4\u65b0\u61c9\u7528\u7a0b\u5e8f\u7684\u7248\u672c \u00b6 \u8981\u5217\u51fa\u60a8\u7684\u90e8\u7f72\uff0c\u8acb\u904b\u884c get deployments \u547d\u4ee4\uff1a kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 2/2 2 2 45h \u8981\u5217\u51fa\u6b63\u5728\u904b\u884c\u7684 Pod\uff0c\u8acb\u904b\u884c get pods \u547d\u4ee4\uff1a kubectl get pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-57978f5f5d-844f2 1/1 Running 0 111m kubernetes-bootcamp-57978f5f5d-csrqd 1/1 Running 0 111m \u8981\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u7684\u7576\u524d\u6620\u50cf\u7248\u672c\uff0c\u8acb\u904b\u884c describe pods \u547d\u4ee4\u4e26\u67e5\u627e Image \u5b57\u6bb5\uff1a kubectl describe pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp-57978f5f5d-844f2 Namespace: default Priority: 0 Node: k3d-k3s-default-server-0/172.24.0.2 Start Time: Thu, 04 Aug 2022 13:46:51 +0800 Labels: app=kubernetes-bootcamp pod-template-hash=57978f5f5d Annotations: <none> Status: Running IP: 10.42.0.15 IPs: IP: 10.42.0.15 Controlled By: ReplicaSet/kubernetes-bootcamp-57978f5f5d Containers: kubernetes-bootcamp: Container ID: containerd://152fce57df6ffd1e0be621be0b6852bde44d36e0a4f5e1574e342749638bccee Image: gcr.io/google-samples/kubernetes-bootcamp:v1 Image ID: gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af Port: <none> Host Port: <none> State: Running Started: Thu, 04 Aug 2022 13:46:52 +0800 Ready: True Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gk5rc (ro) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: kube-api-access-gk5rc: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: <none> \u8981\u5c07\u61c9\u7528\u7a0b\u5e8f\u7684\u6620\u50cf\u66f4\u65b0\u5230 \u7248\u672c 2 \uff0c\u8acb\u4f7f\u7528 set image \u547d\u4ee4\uff0c\u5f8c\u8ddf\u90e8\u7f72\u540d\u7a31\u548c\u65b0\u7684\u6620\u50cf\u7248\u672c\uff1a kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp = jocatalin/kubernetes-bootcamp:v2 \u8a72\u547d\u4ee4\u901a\u77e5\u90e8\u7f72\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u4e0d\u540c\u7684\u6620\u50cf\u4e26\u555f\u52d5\u6efe\u52d5\u66f4\u65b0\u3002\u6aa2\u67e5\u65b0 Pod \u7684\u72c0\u614b\uff0c\u4e26\u4f7f\u7528 get pods \u547d\u4ee4\u67e5\u770b\u820a Pod \u7d42\u6b62\uff1a kubectl get pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-769746fd4-mjdkd 1/1 Running 0 82s kubernetes-bootcamp-769746fd4-r5rwb 1/1 Running 0 70s \u9a57\u8b49\u66f4\u65b0 \u00b6 \u9996\u5148\uff0c\u6aa2\u67e5\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002\u8981\u67e5\u627e\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\uff0c\u8acb\u904b\u884c describe service \u547d\u4ee4\uff1a kubectl describe services/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp Namespace: default Labels: app=kubernetes-bootcamp Annotations: <none> Selector: app=kubernetes-bootcamp Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.10.162 IPs: 10.43.10.162 Port: <unset> 8080/TCP TargetPort: 8080/TCP NodePort: <unset> 30000/TCP Endpoints: 10.42.0.17:8080,10.42.0.18:8080 Session Affinity: None External Traffic Policy: Cluster Events: <none> \u5275\u5efa\u4e00\u500b\u540d\u70ba NODE_PORT \u7684\u74b0\u5883\u8b8a\u91cf\uff0c\u8a72\u8b8a\u91cf\u5177\u6709\u5206\u914d\u7684\u7bc0\u9ede\u7aef\u53e3\u7684\u503c\uff1a export NODE_PORT = $( kubectl get services/kubernetes-bootcamp -o go-template = '{{(index .spec.ports 0).nodePort}}' ) echo NODE_PORT = $NODE_PORT \u63a5\u4e0b\u4f86\uff0c\u5c0d\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\u9032\u884c curl\uff1a $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-mjdkd | v = 2 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-r5rwb | v = 2 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-mjdkd | v = 2 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-r5rwb | v = 2 \u6bcf\u6b21\u904b\u884c curl \u547d\u4ee4\u6642\uff0c\u90fd\u6703\u9047\u5230\u4e0d\u540c\u7684 Pod\u3002\u8acb\u6ce8\u610f\uff0c\u6240\u6709 Pod \u90fd\u5728\u904b\u884c\u6700\u65b0\u7248\u672c (v2)\u3002 \u60a8\u9084\u53ef\u4ee5\u901a\u904e\u904b\u884c rollout status \u547d\u4ee4\u4f86\u78ba\u8a8d\u66f4\u65b0\uff1a kubectl rollout status deployments/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a deployment \"kubernetes-bootcamp\" successfully rolled out \u8981\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u7684\u7576\u524d\u6620\u50cf\u7248\u672c\uff0c\u8acb\u904b\u884c describe pods \u547d\u4ee4\uff1a kubectl describe pods \u5728\u8f38\u51fa\u7684 Image \u5b57\u6bb5\u4e2d\uff0c\u78ba\u8a8d\u60a8\u6b63\u5728\u904b\u884c\u6700\u65b0\u7684\u6620\u50cf\u7248\u672c (v2)\u3002 \u56de\u6efe\u66f4\u65b0 \u00b6 \u8b93\u6211\u5011\u57f7\u884c\u53e6\u4e00\u500b\u66f4\u65b0\uff0c\u4e26\u90e8\u7f72\u4e00\u500b\u5e36\u6709 v10 \u6a19\u8a18\u7684\u6620\u50cf\uff1a kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp = gcr.io/google-samples/kubernetes-bootcamp:v10 \u4f7f\u7528 get deployments \u67e5\u770b\u90e8\u7f72\u72c0\u614b\uff1a kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 2/2 1 2 45h \u8acb\u6ce8\u610f\uff0c\u8f38\u51fa\u6c92\u6709\u5217\u51fa\u6240\u9700\u7684\u53ef\u7528 Pod \u6578\u91cf\u3002\u904b\u884c get pods \u547d\u4ee4\u5217\u51fa\u6240\u6709 Pod\uff1a kubectl get pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-769746fd4-mjdkd 1/1 Running 0 11m kubernetes-bootcamp-769746fd4-r5rwb 1/1 Running 0 11m kubernetes-bootcamp-597654dbd-nwv76 0/1 ImagePullBackOff 0 2m20s \u8acb\u6ce8\u610f\uff0c\u4e00\u4e9b Pod \u7684\u72c0\u614b\u70ba ImagePullBackOff \u3002 \u8981\u66f4\u6df1\u5165\u5730\u4e86\u89e3\u554f\u984c\uff0c\u8acb\u904b\u884c describe pods \u547d\u4ee4\uff1a kubectl describe pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp-597654dbd-nwv76 Namespace: default Priority: 0 Node: k3d-k3s-default-server-0/172.24.0.2 Start Time: Thu, 04 Aug 2022 15:52:13 +0800 Labels: app=kubernetes-bootcamp pod-template-hash=597654dbd Annotations: <none> Status: Pending IP: 10.42.0.19 IPs: IP: 10.42.0.19 Controlled By: ReplicaSet/kubernetes-bootcamp-597654dbd Containers: kubernetes-bootcamp: Container ID: Image: gcr.io/google-samples/kubernetes-bootcamp:v10 Image ID: Port: <none> Host Port: <none> State: Waiting Reason: ImagePullBackOff Ready: False Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-cqlzt (ro) Conditions: Type Status Initialized True Ready False ContainersReady False PodScheduled True Volumes: kube-api-access-cqlzt: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 5m4s default-scheduler Successfully assigned default/kubernetes-bootcamp-597654dbd-nwv76 to k3d-k3s-default-server-0 Normal Pulling 3m36s (x4 over 5m4s) kubelet Pulling image \"gcr.io/google-samples/kubernetes-bootcamp:v10\" Warning Failed 3m36s (x4 over 5m3s) kubelet Failed to pull image \"gcr.io/google-samples/kubernetes-bootcamp:v10\": rpc error: code = NotFound desc = failed to pull and unpack image \"gcr.io/google-samples/kubernetes-bootcamp:v10\": failed to resolve reference \"gcr.io/google-samples/kubernetes-bootcamp:v10\": gcr.io/google-samples/kubernetes-bootcamp:v10: not found Warning Failed 3m36s (x4 over 5m3s) kubelet Error: ErrImagePull Warning Failed 3m20s (x6 over 5m2s) kubelet Error: ImagePullBackOff Normal BackOff 3m9s (x7 over 5m2s) kubelet Back-off pulling image \"gcr.io/google-samples/kubernetes-bootcamp:v10\" \u5728\u53d7\u5f71\u97ff Pod \u7684\u8f38\u51fa\u7684\u4e8b\u4ef6\u90e8\u5206\u4e2d\uff0c\u8acb\u6ce8\u610f\u5b58\u5132\u5eab\u4e2d\u4e0d\u5b58\u5728 v10 \u6620\u50cf\u7248\u672c\u3002 \u8981\u5c07\u90e8\u7f72\u56de\u6efe\u5230\u4e0a\u4e00\u500b\u5de5\u4f5c\u7248\u672c\uff0c\u8acb\u4f7f\u7528 rollout undo \u547d\u4ee4\uff1a kubectl rollout undo deployments/kubernetes-bootcamp rollout undo \u547d\u4ee4\u5c07\u90e8\u7f72\u6062\u5fa9\u5230\u4ee5\u524d\u7684\u5df2\u77e5\u72c0\u614b\uff08\u6620\u50cf\u7684 v2\uff09\u3002\u66f4\u65b0\u662f\u7248\u672c\u5316\u7684\uff0c\u60a8\u53ef\u4ee5\u6062\u5fa9\u5230\u4efb\u4f55\u4ee5\u524d\u5df2\u77e5\u7684\u90e8\u7f72\u72c0\u614b\u3002 \u4f7f\u7528 get pods \u547d\u4ee4\u518d\u6b21\u5217\u51fa Pod\uff1a kubectl get pods \u56db\u500b Pod \u6b63\u5728\u904b\u884c\u3002\u8981\u6aa2\u67e5\u90e8\u7f72\u5728\u9019\u4e9b Pod \u4e0a\u7684\u6620\u50cf\uff0c\u8acb\u4f7f\u7528 describe pods \u547d\u4ee4\uff1a kubectl describe pods \u90e8\u7f72\u518d\u6b21\u4f7f\u7528\u61c9\u7528\u7a0b\u5e8f\u7684\u7a69\u5b9a\u7248\u672c (v2)\u3002\u56de\u6efe\u6210\u529f\u3002","title":"\u66f4\u65b0\u4f60\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/update/#_1","text":"","title":"\u66f4\u65b0\u4f60\u7684\u61c9\u7528"},{"location":"kubernetes/04-tutorials/kubernetes-basics/update/#_2","text":"\u76ee\u6a19: \u4f7f\u7528 kubectl \u9032\u884c\u61c9\u7528\u7248\u672c\u6efe\u52d5\u66f4\u65b0\u3002","title":"\u57f7\u884c\u6efe\u52d5\u66f4\u65b0"},{"location":"kubernetes/04-tutorials/kubernetes-basics/update/#_3","text":"\u7528\u6236\u5e0c\u671b\u61c9\u7528\u7a0b\u5e8f\u59cb\u7d42\u53ef\u7528\uff0c\u800c\u958b\u767c\u4eba\u54e1\u5247\u9700\u8981\u6bcf\u5929\u591a\u6b21\u90e8\u7f72\u5b83\u5011\u7684\u65b0\u7248\u672c\u3002\u5728 Kubernetes \u4e2d\uff0c\u9019\u4e9b\u662f\u901a\u904e\u6efe\u52d5\u66f4\u65b0\uff08Rolling Updates\uff09\u5b8c\u6210\u7684\u3002 \u6efe\u52d5\u66f4\u65b0 \u5141\u8a31\u901a\u904e\u4f7f\u7528\u65b0\u7684\u5be6\u4f8b\u9010\u6b65\u66f4\u65b0 Pod \u5be6\u4f8b\uff0c\u96f6\u505c\u6a5f\u9032\u884c Deployment \u66f4\u65b0\u3002\u65b0\u7684 Pod \u5c07\u5728\u5177\u6709\u53ef\u7528\u8cc7\u6e90\u7684\u7bc0\u9ede\u4e0a\u9032\u884c\u8abf\u5ea6\u3002 \u5728\u524d\u9762\u7684\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u61c9\u7528\u7a0b\u5e8f\u64f4\u5c55\u70ba\u904b\u884c\u591a\u500b\u5be6\u4f8b\u3002\u9019\u662f\u5728\u4e0d\u5f71\u97ff\u61c9\u7528\u7a0b\u5e8f\u53ef\u7528\u6027\u7684\u60c5\u6cc1\u4e0b\u57f7\u884c\u66f4\u65b0\u7684\u8981\u6c42\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u66f4\u65b0\u671f\u9593\u4e0d\u53ef\u7528\u7684 pod \u7684\u6700\u5927\u503c\u548c\u53ef\u4ee5\u5275\u5efa\u7684\u65b0 pod \u6578\u90fd\u662f 1\u3002\u9019\u5169\u500b\u9078\u9805\u90fd\u53ef\u4ee5\u914d\u7f6e\u70ba\uff08pod\uff09\u6578\u5b57\u6216\u767e\u5206\u6bd4\u3002\u5728 Kubernetes \u4e2d\uff0c\u66f4\u65b0\u662f\u7d93\u904e\u7248\u672c\u63a7\u5236\u7684\uff0c\u4efb\u4f55 Deployment \u66f4\u65b0\u90fd\u53ef\u4ee5\u6062\u5fa9\u5230\u4ee5\u524d\u7684\uff08\u7a69\u5b9a\uff09\u7248\u672c\u3002 \u8207\u61c9\u7528\u7a0b\u5e8f\u64f4\u5c55\u985e\u4f3c\uff0c\u5982\u679c\u516c\u958b\u4e86 Deployment\uff0c\u670d\u52d9\u5c07\u5728\u66f4\u65b0\u671f\u9593\u50c5\u5c0d\u53ef\u7528\u7684 pod \u9032\u884c\u8ca0\u8f09\u5747\u8861\u3002\u53ef\u7528 Pod \u662f\u61c9\u7528\u7a0b\u5e8f\u7528\u6236\u53ef\u7528\u7684\u5be6\u4f8b\u3002 \u6efe\u52d5\u66f4\u65b0\u5141\u8a31\u4ee5\u4e0b\u64cd\u4f5c\uff1a \u5c07\u61c9\u7528\u7a0b\u5e8f\u5f9e\u4e00\u500b\u74b0\u5883\u63d0\u5347\u5230\u53e6\u4e00\u500b\u74b0\u5883\uff08\u901a\u904e\u5bb9\u5668\u93e1\u50cf\u66f4\u65b0\uff09 \u56de\u6efe\u5230\u4ee5\u524d\u7684\u7248\u672c \u6301\u7e8c\u96c6\u6210\u548c\u6301\u7e8c\u4ea4\u4ed8\u61c9\u7528\u7a0b\u5e8f\uff0c\u7121\u9700\u505c\u6a5f \u5728\u4e0b\u9762\u7684\u6559\u7a0b\u4e2d\uff0c\u6211\u5011\u5c07\u61c9\u7528\u7a0b\u5e8f\u66f4\u65b0\u70ba\u65b0\u7248\u672c\uff0c\u4e26\u57f7\u884c\u56de\u6efe\u3002","title":"\u66f4\u65b0\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/04-tutorials/kubernetes-basics/update/#_4","text":"\u8981\u5217\u51fa\u60a8\u7684\u90e8\u7f72\uff0c\u8acb\u904b\u884c get deployments \u547d\u4ee4\uff1a kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 2/2 2 2 45h \u8981\u5217\u51fa\u6b63\u5728\u904b\u884c\u7684 Pod\uff0c\u8acb\u904b\u884c get pods \u547d\u4ee4\uff1a kubectl get pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-57978f5f5d-844f2 1/1 Running 0 111m kubernetes-bootcamp-57978f5f5d-csrqd 1/1 Running 0 111m \u8981\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u7684\u7576\u524d\u6620\u50cf\u7248\u672c\uff0c\u8acb\u904b\u884c describe pods \u547d\u4ee4\u4e26\u67e5\u627e Image \u5b57\u6bb5\uff1a kubectl describe pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp-57978f5f5d-844f2 Namespace: default Priority: 0 Node: k3d-k3s-default-server-0/172.24.0.2 Start Time: Thu, 04 Aug 2022 13:46:51 +0800 Labels: app=kubernetes-bootcamp pod-template-hash=57978f5f5d Annotations: <none> Status: Running IP: 10.42.0.15 IPs: IP: 10.42.0.15 Controlled By: ReplicaSet/kubernetes-bootcamp-57978f5f5d Containers: kubernetes-bootcamp: Container ID: containerd://152fce57df6ffd1e0be621be0b6852bde44d36e0a4f5e1574e342749638bccee Image: gcr.io/google-samples/kubernetes-bootcamp:v1 Image ID: gcr.io/google-samples/kubernetes-bootcamp@sha256:0d6b8ee63bb57c5f5b6156f446b3bc3b3c143d233037f3a2f00e279c8fcc64af Port: <none> Host Port: <none> State: Running Started: Thu, 04 Aug 2022 13:46:52 +0800 Ready: True Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-gk5rc (ro) Conditions: Type Status Initialized True Ready True ContainersReady True PodScheduled True Volumes: kube-api-access-gk5rc: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: <none> \u8981\u5c07\u61c9\u7528\u7a0b\u5e8f\u7684\u6620\u50cf\u66f4\u65b0\u5230 \u7248\u672c 2 \uff0c\u8acb\u4f7f\u7528 set image \u547d\u4ee4\uff0c\u5f8c\u8ddf\u90e8\u7f72\u540d\u7a31\u548c\u65b0\u7684\u6620\u50cf\u7248\u672c\uff1a kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp = jocatalin/kubernetes-bootcamp:v2 \u8a72\u547d\u4ee4\u901a\u77e5\u90e8\u7f72\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u4e0d\u540c\u7684\u6620\u50cf\u4e26\u555f\u52d5\u6efe\u52d5\u66f4\u65b0\u3002\u6aa2\u67e5\u65b0 Pod \u7684\u72c0\u614b\uff0c\u4e26\u4f7f\u7528 get pods \u547d\u4ee4\u67e5\u770b\u820a Pod \u7d42\u6b62\uff1a kubectl get pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-769746fd4-mjdkd 1/1 Running 0 82s kubernetes-bootcamp-769746fd4-r5rwb 1/1 Running 0 70s","title":"\u66f4\u65b0\u61c9\u7528\u7a0b\u5e8f\u7684\u7248\u672c"},{"location":"kubernetes/04-tutorials/kubernetes-basics/update/#_5","text":"\u9996\u5148\uff0c\u6aa2\u67e5\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002\u8981\u67e5\u627e\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\uff0c\u8acb\u904b\u884c describe service \u547d\u4ee4\uff1a kubectl describe services/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp Namespace: default Labels: app=kubernetes-bootcamp Annotations: <none> Selector: app=kubernetes-bootcamp Type: NodePort IP Family Policy: SingleStack IP Families: IPv4 IP: 10.43.10.162 IPs: 10.43.10.162 Port: <unset> 8080/TCP TargetPort: 8080/TCP NodePort: <unset> 30000/TCP Endpoints: 10.42.0.17:8080,10.42.0.18:8080 Session Affinity: None External Traffic Policy: Cluster Events: <none> \u5275\u5efa\u4e00\u500b\u540d\u70ba NODE_PORT \u7684\u74b0\u5883\u8b8a\u91cf\uff0c\u8a72\u8b8a\u91cf\u5177\u6709\u5206\u914d\u7684\u7bc0\u9ede\u7aef\u53e3\u7684\u503c\uff1a export NODE_PORT = $( kubectl get services/kubernetes-bootcamp -o go-template = '{{(index .spec.ports 0).nodePort}}' ) echo NODE_PORT = $NODE_PORT \u63a5\u4e0b\u4f86\uff0c\u5c0d\u66b4\u9732\u7684 IP \u548c\u7aef\u53e3\u9032\u884c curl\uff1a $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-mjdkd | v = 2 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-r5rwb | v = 2 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-mjdkd | v = 2 $ curl localhost: $NODE_PORT Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-769746fd4-r5rwb | v = 2 \u6bcf\u6b21\u904b\u884c curl \u547d\u4ee4\u6642\uff0c\u90fd\u6703\u9047\u5230\u4e0d\u540c\u7684 Pod\u3002\u8acb\u6ce8\u610f\uff0c\u6240\u6709 Pod \u90fd\u5728\u904b\u884c\u6700\u65b0\u7248\u672c (v2)\u3002 \u60a8\u9084\u53ef\u4ee5\u901a\u904e\u904b\u884c rollout status \u547d\u4ee4\u4f86\u78ba\u8a8d\u66f4\u65b0\uff1a kubectl rollout status deployments/kubernetes-bootcamp \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a deployment \"kubernetes-bootcamp\" successfully rolled out \u8981\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u7684\u7576\u524d\u6620\u50cf\u7248\u672c\uff0c\u8acb\u904b\u884c describe pods \u547d\u4ee4\uff1a kubectl describe pods \u5728\u8f38\u51fa\u7684 Image \u5b57\u6bb5\u4e2d\uff0c\u78ba\u8a8d\u60a8\u6b63\u5728\u904b\u884c\u6700\u65b0\u7684\u6620\u50cf\u7248\u672c (v2)\u3002","title":"\u9a57\u8b49\u66f4\u65b0"},{"location":"kubernetes/04-tutorials/kubernetes-basics/update/#_6","text":"\u8b93\u6211\u5011\u57f7\u884c\u53e6\u4e00\u500b\u66f4\u65b0\uff0c\u4e26\u90e8\u7f72\u4e00\u500b\u5e36\u6709 v10 \u6a19\u8a18\u7684\u6620\u50cf\uff1a kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp = gcr.io/google-samples/kubernetes-bootcamp:v10 \u4f7f\u7528 get deployments \u67e5\u770b\u90e8\u7f72\u72c0\u614b\uff1a kubectl get deployments \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY UP-TO-DATE AVAILABLE AGE kubernetes-bootcamp 2/2 1 2 45h \u8acb\u6ce8\u610f\uff0c\u8f38\u51fa\u6c92\u6709\u5217\u51fa\u6240\u9700\u7684\u53ef\u7528 Pod \u6578\u91cf\u3002\u904b\u884c get pods \u547d\u4ee4\u5217\u51fa\u6240\u6709 Pod\uff1a kubectl get pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a NAME READY STATUS RESTARTS AGE kubernetes-bootcamp-769746fd4-mjdkd 1/1 Running 0 11m kubernetes-bootcamp-769746fd4-r5rwb 1/1 Running 0 11m kubernetes-bootcamp-597654dbd-nwv76 0/1 ImagePullBackOff 0 2m20s \u8acb\u6ce8\u610f\uff0c\u4e00\u4e9b Pod \u7684\u72c0\u614b\u70ba ImagePullBackOff \u3002 \u8981\u66f4\u6df1\u5165\u5730\u4e86\u89e3\u554f\u984c\uff0c\u8acb\u904b\u884c describe pods \u547d\u4ee4\uff1a kubectl describe pods \u8f38\u51fa\u61c9\u985e\u4f3c\u65bc\uff1a Name: kubernetes-bootcamp-597654dbd-nwv76 Namespace: default Priority: 0 Node: k3d-k3s-default-server-0/172.24.0.2 Start Time: Thu, 04 Aug 2022 15:52:13 +0800 Labels: app=kubernetes-bootcamp pod-template-hash=597654dbd Annotations: <none> Status: Pending IP: 10.42.0.19 IPs: IP: 10.42.0.19 Controlled By: ReplicaSet/kubernetes-bootcamp-597654dbd Containers: kubernetes-bootcamp: Container ID: Image: gcr.io/google-samples/kubernetes-bootcamp:v10 Image ID: Port: <none> Host Port: <none> State: Waiting Reason: ImagePullBackOff Ready: False Restart Count: 0 Environment: <none> Mounts: /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-cqlzt (ro) Conditions: Type Status Initialized True Ready False ContainersReady False PodScheduled True Volumes: kube-api-access-cqlzt: Type: Projected (a volume that contains injected data from multiple sources) TokenExpirationSeconds: 3607 ConfigMapName: kube-root-ca.crt ConfigMapOptional: <nil> DownwardAPI: true QoS Class: BestEffort Node-Selectors: <none> Tolerations: node.kubernetes.io/not-ready:NoExecute op=Exists for 300s node.kubernetes.io/unreachable:NoExecute op=Exists for 300s Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Scheduled 5m4s default-scheduler Successfully assigned default/kubernetes-bootcamp-597654dbd-nwv76 to k3d-k3s-default-server-0 Normal Pulling 3m36s (x4 over 5m4s) kubelet Pulling image \"gcr.io/google-samples/kubernetes-bootcamp:v10\" Warning Failed 3m36s (x4 over 5m3s) kubelet Failed to pull image \"gcr.io/google-samples/kubernetes-bootcamp:v10\": rpc error: code = NotFound desc = failed to pull and unpack image \"gcr.io/google-samples/kubernetes-bootcamp:v10\": failed to resolve reference \"gcr.io/google-samples/kubernetes-bootcamp:v10\": gcr.io/google-samples/kubernetes-bootcamp:v10: not found Warning Failed 3m36s (x4 over 5m3s) kubelet Error: ErrImagePull Warning Failed 3m20s (x6 over 5m2s) kubelet Error: ImagePullBackOff Normal BackOff 3m9s (x7 over 5m2s) kubelet Back-off pulling image \"gcr.io/google-samples/kubernetes-bootcamp:v10\" \u5728\u53d7\u5f71\u97ff Pod \u7684\u8f38\u51fa\u7684\u4e8b\u4ef6\u90e8\u5206\u4e2d\uff0c\u8acb\u6ce8\u610f\u5b58\u5132\u5eab\u4e2d\u4e0d\u5b58\u5728 v10 \u6620\u50cf\u7248\u672c\u3002 \u8981\u5c07\u90e8\u7f72\u56de\u6efe\u5230\u4e0a\u4e00\u500b\u5de5\u4f5c\u7248\u672c\uff0c\u8acb\u4f7f\u7528 rollout undo \u547d\u4ee4\uff1a kubectl rollout undo deployments/kubernetes-bootcamp rollout undo \u547d\u4ee4\u5c07\u90e8\u7f72\u6062\u5fa9\u5230\u4ee5\u524d\u7684\u5df2\u77e5\u72c0\u614b\uff08\u6620\u50cf\u7684 v2\uff09\u3002\u66f4\u65b0\u662f\u7248\u672c\u5316\u7684\uff0c\u60a8\u53ef\u4ee5\u6062\u5fa9\u5230\u4efb\u4f55\u4ee5\u524d\u5df2\u77e5\u7684\u90e8\u7f72\u72c0\u614b\u3002 \u4f7f\u7528 get pods \u547d\u4ee4\u518d\u6b21\u5217\u51fa Pod\uff1a kubectl get pods \u56db\u500b Pod \u6b63\u5728\u904b\u884c\u3002\u8981\u6aa2\u67e5\u90e8\u7f72\u5728\u9019\u4e9b Pod \u4e0a\u7684\u6620\u50cf\uff0c\u8acb\u4f7f\u7528 describe pods \u547d\u4ee4\uff1a kubectl describe pods \u90e8\u7f72\u518d\u6b21\u4f7f\u7528\u61c9\u7528\u7a0b\u5e8f\u7684\u7a69\u5b9a\u7248\u672c (v2)\u3002\u56de\u6efe\u6210\u529f\u3002","title":"\u56de\u6efe\u66f4\u65b0"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/","text":"\u5b58\u5132\u7ba1\u7406 volume\u3001PV/PVC \u00b6 \u539f\u6587: k8s\u5165\u95e8\u6559\u7a0b\u5341\u4e8c:\u5b58\u50a8\u7ba1\u7406volume\u3001PV/PVC Kubernetes \u5b58\u5132\u7ba1\u7406\u6309\u7167\u767c\u5c55\u7684\u6b77\u7a0b\uff0c\u6d89\u53ca\u5230\u6709 Volume \uff0c PV (Persistent Volume) \u548c PVC (PersistentVolumeClaims),\u548c StorageClass \u3002 Volume \u662f K8S \u6700\u65e9\u63d0\u51fa\u7684\u5b58\u5132\u5377\u7684\u7d50\u69cb\uff0c\u4e3b\u8981\u89e3\u6c7a\u5bb9\u5668\u548c\u6578\u64da\u5b58\u5132\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u62bd\u8c61\u5e95\u5c64\u9a45\u52d5\u4ee5\u652f\u6301\u4e0d\u540c\u7684\u5b58\u5132\u985e\u578b\uff1b\u4f7f\u7528 Volume \u9700\u8981\u4e86\u89e3\u5e95\u5c64\u5b58\u5132\u7d30\u7bc0\uff0c\u56e0\u6b64\u63d0\u51fa\u4e86 PV \uff0c Persistent Volume \u662f\u7531 K8S \u7ba1\u7406\u54e1\u5b9a\u7fa9\u7684\u5b58\u5132\u55ae\u5143\uff0c\u61c9\u7528\u7aef\u4f7f\u7528 PersistentVolumeClaims \u8072\u660e\u53bb\u8abf\u7528 PV \u5b58\u5132\uff0c\u9032\u4e00\u6b65\u62bd\u8c61\u4e86\u5e95\u5c64\u5b58\u5132\uff1b\u96a8\u8457 PV \u6578\u91cf\u7684\u589e\u52a0\uff0c\u7ba1\u7406\u54e1\u9700\u8981\u4e0d\u505c\u7684\u5b9a\u7fa9 PV \u7684\u6578\u91cf\uff0c\u884d\u751f\u4e86\u901a\u904e StorageClass \u52d5\u614b\u751f\u6210 PV \uff0c StorageClass \u901a\u904e PVC \u4e2d\u8072\u660e\u5b58\u5132\u7684\u5bb9\u91cf\uff0c\u6703\u8abf\u7528\u5e95\u5c64\u7684\u63d0\u4f9b\u5546\u751f\u6210 PV \u3002 \u672c\u6559\u7a0b\u5148\u4ecb\u7d39 Volume \u7684\u4f7f\u7528\uff0c\u63a5\u8457\u518d\u4ecb\u7d39 PV\uff0cPVC \u548c StorageClass\u3002 Volume \u5b58\u5132\u5377\uff0c\u7368\u7acb\u65bc\u5bb9\u5668\uff0c\u5f8c\u7aef\u548c\u4e0d\u540c\u7684\u5b58\u5132\u9a45\u52d5\u5c0d\u63a5 PV Persistent Volume \u6301\u4e45\u5316\u5b58\u5132\u5377\uff0c\u548c node \u985e\u4f3c\uff0c\u662f\u4e00\u7a2e\u96c6\u7fa4\u8cc7\u6e90\uff0c\u7531\u7ba1\u7406\u54e1\u5b9a\u7fa9\uff0c\u5c0d\u63a5\u4e0d\u540c\u7684\u5b58\u5132 PVC PersistentVolumeClaims \u6301\u4e45\u5316\u5b58\u5132\u8072\u660e\uff0c\u548c pod \u985e\u4f3c\uff0c\u4f5c\u70ba PV \u7684\u4f7f\u7528\u8005 StorageClass \u52d5\u614b\u5b58\u5132\u985e\u578b\uff0c\u5206\u70ba\u975c\u614b\u548c\u52d5\u614b\u5169\u7a2e\u985e\u578b\uff0c\u901a\u904e\u5728 PVC \u4e2d\u5b9a\u7fa9\u5b58\u5132\u985e\u578b\uff0c\u81ea\u52d5\u5275\u5efa\u6240\u9700 PV \u5b58\u5132\u6982\u8ff0 \u00b6 kubernetes \u5bb9\u5668\u4e2d\u7684\u6578\u64da\u662f \u81e8\u6642\u7684 \uff0c\u5373\u7576\u91cd\u555f\u91cd\u555f\u6216 crash \u5f8c\u5bb9\u5668\u7684\u6578\u64da\u5c07\u6703\u4e1f\u5931\uff0c\u6b64\u5916\u5bb9\u5668\u4e4b\u9593\u6709\u5171\u4eab\u5b58\u5132\u7684\u9700\u6c42\uff0c\u6240\u4ee5 kubernetes \u63d0\u4f9b\u4e86 volume \u5b58\u5132\u7684\u62bd\u8c61\uff0cvolume \u5f8c\u7aef\u80fd\u5920\u652f\u6301\u591a\u7a2e\u4e0d\u540c\u7684 plugin \u9a45\u52d5\uff0c\u901a\u904e .spec.volumes \u4e2d\u5b9a\u7fa9\u4e00\u500b\u5b58\u5132\uff0c\u7136\u5f8c\u5728\u5bb9\u5668\u4e2d .spec.containers.volumeMounts \u8abf\u7528\uff0c\u6700\u7d42\u5728\u5bb9\u5668\u5167\u90e8\u4ee5\u76ee\u9304\u7684\u5f62\u5f0f\u5448\u73fe\u3002 kubernetes \u5167\u7f6e\u80fd\u652f\u6301\u591a\u7a2e\u4e0d\u540c\u7684\u9a45\u52d5\u985e\u578b\uff0c\u5927\u9ad4\u4e0a\u53ef\u4ee5\u5206\u70ba\u56db\u7a2e\u985e\u578b\uff1a kubernetes\u5c0d\u8c61 API \u9a45\u52d5\u63a5\u53e3\uff0c\u5be6\u73fe\u5176\u4ed6\u5c0d\u8c61\u8abf\u7528\uff0c\u5982configmap, secret\uff0c\u6bcf\u7a2e\u5b58\u5132\u652f\u6301\u4e0d\u540c\u7684\u9a45\u52d5 \u672c\u5730\u81e8\u6642\u5b58\u5132\uff0c\u5982 hostPath, emptyDir \u7b49 \u958b\u6e90\u5b58\u5132\u9a45\u52d5\u63a5\u53e3\uff0c\u5982 lonhorn, rook \u7b49 \u516c/\u79c1\u6709\u96f2\u9a45\u52d5\u63a5\u53e3\uff0c\u5982 awsElasticBlockStore \u5be6\u73fe\u8207 aws EBS \u96c6\u6210 \u672c\u5730\u81e8\u6642\u5b58\u5132 \u00b6 \u672c\u5730\u81e8\u6642\u5b58\u5132\u5305\u62ec hostPath\u3001emptyDir \u7b49\u3002 emptyDir \u81e8\u6642\u5b58\u5132 \u00b6 emptyDir \u662f\u4e00\u7a2e\u81e8\u6642\u5b58\u5132\uff0cpod \u5275\u5efa\u7684\u6642\u5019\u6703\u5728 node \u7bc0\u9ede\u4e0a\u70ba\u5bb9\u5668\u7533\u8acb\u4e00\u500b\u81e8\u6642\u7684\u76ee\u9304\uff0c\u8ddf\u96a8\u5bb9\u5668\u7684\u751f\u547d\u9031\u671f\uff0c\u5982\u5bb9\u5668\u522a\u9664\uff0cemptyDir \u5b9a\u7fa9\u7684\u81e8\u6642\u5b58\u5132\u7a7a\u9593\u4e5f\u6703\u96a8\u4e4b\u522a\u9664\uff0c\u5bb9\u5668\u767c\u751f\u610f\u5916 crash \u5247\u4e0d\u53d7\u5f71\u97ff\uff0c\u540c\u6642\u5982\u679c\u5bb9\u5668\u767c\u751f\u4e86\u9077\u79fb\uff0c\u5176\u4e0a\u7684\u6578\u64da\u4e5f\u6703\u4e1f\u5931\uff0cemptyDir \u4e00\u822c\u7528\u65bc\u6e2c\u8a66\uff0c\u6216\u8005\u7de9\u5b58\u5834\u666f\u3002 Info \u6ce8\u610f\uff1a\u4e00\u500b\u5bb9\u5668\u5d29\u6f70\u4e86\u4e0d\u6703\u5c0e\u81f4\u6578\u64da\u7684\u4e1f\u5931\uff0c\u56e0\u70ba\u5bb9\u5668\u7684\u5d29\u6f70\u4e26\u4e0d\u79fb\u9664 pod. emptyDir \u7684\u4e00\u4e9b\u7528\u9014\uff1a \u7de9\u5b58\u7a7a\u9593\uff0c\u4f8b\u5982\u57fa\u65bc\u78c1\u76e4\u7684\u6b78\u4f75\u6392\u5e8f\u3002 \u70ba\u8017\u6642\u8f03\u9577\u7684\u8a08\u7b97\u4efb\u52d9\u63d0\u4f9b\u6aa2\u67e5\u9ede\uff0c\u4ee5\uf965\u4efb\u52d9\u80fd\u65b9\uf965\u5730\u5f9e\u5d29\u6f70\u524d\u72c0\u614b\u6062\u5fa9\u57f7\ufa08\u3002 \u5728 Web \u670d\u52d9\u5668\u5bb9\u5668\u670d\u52d9\u6578\u64da\u6642\uff0c\u4fdd\u5b58\u5167\u5bb9\u7ba1\u7406\u5668\u5bb9\u5668\u7372\u53d6\u7684\u6587\u4ef6\u3002 volume-emptydir.yaml apiVersion : v1 kind : Pod metadata : name : test-pod spec : containers : - image : busybox:1.35 name : test-container command : [ \"/bin/sh\" , \"-c\" , \"sleep 3600\" ] volumeMounts : - mountPath : /cache name : cache-volume volumes : - name : cache-volume emptyDir : {} \u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u5275\u5efa Pod: $ kubectl apply -f volume-emptydir.yaml pod/test-pd created \u8b93\u6211\u5011\u9032\u5165\u5230Pod\u4e4b\u4e2d\u4f86\u6aa2\u67e5\u4e00\u4e0b\u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl get pods NAME READY STATUS RESTARTS AGE test-pod 1 /1 Running 0 24m $ kubectl exec -it pod/test-pod -- /sh / # ls -la total 48 drwxr-xr-x 1 root root 4096 Aug 12 23 :21 . drwxr-xr-x 1 root root 4096 Aug 12 23 :21 .. drwxr-xr-x 2 root root 12288 Jul 29 01 :38 bin drwxrwxrwx 2 root root 4096 Aug 12 23 :21 cache drwxr-xr-x 5 root root 360 Aug 12 23 :21 dev drwxr-xr-x 1 root root 4096 Aug 12 23 :21 etc drwxr-xr-x 2 nobody nobody 4096 Jul 29 01 :38 home dr-xr-xr-x 483 root root 0 Aug 12 23 :21 proc drwx------ 1 root root 4096 Aug 12 23 :47 root dr-xr-xr-x 13 root root 0 Aug 12 23 :21 sys drwxrwxrwt 2 root root 4096 Jul 29 01 :38 tmp drwxr-xr-x 3 root root 4096 Jul 29 01 :38 usr drwxr-xr-x 1 root root 4096 Aug 12 23 :21 var / # cd cache/ /cache # echo 000 > a.txt /cache # cat a.txt 000 /cache # exit \u7576\u9019\u500b pod \u88ab\u522a\u9664\u6642\uff0c\u9019\u500b\u6240\u6709\u7f6e\u653e\u5728 emptyDir \u88e1\u7684\u6587\u4ef6\u4e5f\u662f\u6703\u81ea\u52d5\u522a\u9664\u7684\u3002 hostPath \u4e3b\u6a5f\u5b58\u5132 \u00b6 Warning \u8b66\u544a\uff1a HostPath \u5377\u5b58\u5728\u8a31\u591a\u5b89\u5168\u98a8\u96aa\uff0c\u6700\u4f73\u505a\u6cd5\u662f\u76e1\u53ef\u80fd\u907f\u514d\u4f7f\u7528 HostPath\u3002\u7576\u5fc5\u9808\u4f7f\u7528 HostPath \u5377\u6642\uff0c\u5b83\u7684\u7bc4\u570d\u61c9\u50c5\u9650\u65bc\u6240\u9700\u7684\u6587\u4ef6\u6216\u76ee\u9304\uff0c\u4e26\u4ee5\u53ea\u8b80\u65b9\u5f0f\u639b\u8f09\u3002 \u5982\u679c\u901a\u904e AdmissionPolicy \u9650\u5236 HostPath \u5c0d\u7279\u5b9a\u76ee\u9304\u7684\u8a2a\u554f\uff0c\u5247\u5fc5\u9808\u8981\u6c42 volumeMounts \u4f7f\u7528 readOnly \u639b\u8f09\u4ee5\u4f7f\u7b56\u7565\u751f\u6548\u3002 hostPath \u5377\u80fd\u5c07 node \u5bbf\u4e3b\u6a5f\u7bc0\u9ede\u6587\u4ef6\u7cfb\u7d71\u4e0a\u7684\u6587\u4ef6\u6216\u76ee\u9304\u639b\u8f09\u5230\u60a8\u7684 Pod \u4e2d\u3002\u4f8b\u5982\uff0chostPath \u7684\u4e00\u4e9b\u7528\u6cd5\u6709\uff1a \u904b\u884c\u4e00\u500b\u9700\u8981\u8a2a\u554f Docker \u5f15\u64ce\u5167\u90e8\u6a5f\u5236\u7684\u5bb9\u5668\uff1b\u8acb\u4f7f\u7528 hostPath \u639b\u8f09 /var/lib/docker \u8def\u5f91\u3002 \u5728\u5bb9\u5668\u4e2d\u904b\u884c cAdvisor \u6642\uff0c\u4ee5 hostPath \u65b9\u5f0f\u639b\u8f09 /sys\u3002 \u5141\u8a31 Pod \u6307\u5b9a\u7d66\u5b9a\u7684 hostPath \u5728\u904b\u884c Pod \u4e4b\u524d\u662f\u5426\u61c9\u8a72\u5b58\u5728\uff0c\u662f\u5426\u61c9\u8a72\u5275\u5efa\u4ee5\u53ca\u61c9\u8a72\u4ee5\uf9fd\u9ebc\u65b9\u5f0f\u5b58\u5728\u3002 \u9664\u4e86\u5fc5\u9700\u7684 path \u5c6c\u6027\u4e4b\u5916\uff0c\u7528\u6236\u53ef\u4ee5\u9078\u64c7\u6027\u5730\u70ba hostPath \u5377\u6307\u5b9a type \u3002\u652f\u6301\u7684 type \u503c\u5982\u4e0b\uff1a hostPath Type \u503c \u884c\u70ba \u7a7a\u5b57\u7b26\u4e32\uff08\u9ed8\u8a8d\uff09 \u7528\u65bc\u5411\u5f8c\u517c\u5bb9\uff0c\u9019\u610f\u5473\u8457\u5728\u5b89\u88dd hostPath \u5377\u4e4b\u524d\u4e0d\u6703\u57f7\u884c\u4efb\u4f55\u6aa2\u67e5\u3002 DirectoryOrCreate \u5982\u679c\u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u4ec0\u9ebc\u90fd\u4e0d\u5b58\u5728\uff0c\u90a3\u9ebc\u5c07\u6839\u64da\u9700\u8981\u5275\u5efa\u7a7a\u76ee\u9304\uff0c\u6b0a\u9650\u8a2d\u7f6e\u70ba 0755\uff0c\u5177\u6709\u8207 Kubelet \u76f8\u540c\u7684\u7d44\u548c\u6240\u6709\u6b0a\u3002 Directory \u5728\u7d66\u5b9a\uf937\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u76ee\u9304\u3002 FileOrCreate \u5982\u679c\u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u4ec0\u9ebc\u90fd\u4e0d\u5b58\u5728\uff0c\u90a3\u9ebc\u5c07\u5728\u90a3\u88e1\u6839\u64da\u9700\u8981\u5275\u5efa\u7a7a\u6587\u4ef6\uff0c\u6b0a\u9650\u8a2d\u7f6e\u70ba 0644\uff0c\u5177\u6709\u8207 Kubelet \u76f8\u540c\u7684\u7d44\u548c\u6240\u6709\u6b0a\u3002 File \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u6587\u4ef6\u3002 Socket \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684 UNIX \u5957\u63a5\u5b57\u3002 CharDevice \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u5b57\u7b26\u8a2d\u5099\u3002 BlockDevice \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u584a\u8a2d\u5099\u3002 \u7576\u4f7f\u7528\u9019\u7a2e\u985e\u578b\u7684\u5377\u6642\u8981\u5c0f\u5fc3\uff0c\u56e0\u70ba\uff1a \u5177\u6709\u76f8\u540c\u914d\u7f6e\uff08\u4f8b\u5982\u5f9e podTemplate \u5275\u5efa\uff09\u7684\u591a\u500b Pod \u6703\u7531\u65bc\u7bc0\u9ede\u4e0a\u6587\u4ef6\u7684\uf967\u540c\u800c\u5728\uf967\u540c\u7bc0\u9ede\u4e0a\u6709\uf967\u540c\u7684\ufa08\u70ba\u3002 \u7576 Kubernetes \u6309\u7167\u8a08\u5283\u6dfb\u52a0\u8cc7\u6e90\u611f\u77e5\u7684\u8abf\u5ea6\u6642\uff0c\u9019\u985e\u8abf\u5ea6\u6a5f\u5236\u5c07\u7121\u6cd5\u8003\u616e\u7531 hostPath \u4f7f\u7528\u7684\u8cc7\u6e90\u3002 \u57fa\u790e\u4e3b\u6a5f\u4e0a\u5275\u5efa\u7684\u6587\u4ef6\u6216\u76ee\u9304\u53ea\u80fd\u7531 root \u7528\u6236\u5beb\u5165\u3002\u60a8\u9700\u8981\u5728\u7279\u6b0a\u5bb9\u5668\u4e2d\u4ee5 root \u8eab\u4efd\u904b\u884c\u9032\u7a0b\uff0c\u6216\u8005\u4fee\u6539\u4e3b\u6a5f\u4e0a\u7684\u6587\u4ef6\u6b0a\u9650\u4ee5\uf965\u5bb9\ufa38\u80fd\u5920\u5beb\u5165 hostPath \u5377\u3002 \u7531\u65bc\u672c\u6559\u7a0b\u4f7f\u7528 K3D \u4f5c\u70ba K8S \u5b78\u7fd2\u74b0\u5883\uff0c\u4e0b\u5217\u7684\u7df4\u7fd2\u6b65\u9a5f\u9700\u8981\u642d\u914d K3D \u6240\u69cb\u5efa\u7684\u74b0\u5883\u3002 1.\u5728\u6211\u5011\u5c07\u4fdd\u5b58\u6578\u64da\u7684\u4e3b\u6a5f\u4e0a\u5275\u5efa\u76ee\u9304\uff1a $ mkdir -p /tmp/k3dvol 2.\u5275\u5efa\u96c6\u7fa4\u4e26\u8a2d\u5b9a\u67d0\u500b Node path \u639b\u8f09\u9032 K8S \u4e2d\uff1a $ k3d cluster create --volume /tmp/k3dvol:/tmp/k3dvol@server:0 3.\u5275\u5efa test-pod2 \u7684\u5ba3\u544a\u6a94 volume-hostpath.yaml : volume-hostpath.yaml apiVersion : v1 kind : Pod metadata : name : test-pod2 spec : containers : - image : nginx:1.7.9 name : test-container volumeMounts : - mountPath : /test-hostpath name : test-volume volumes : - name : test-volume hostPath : path : /tmp/k3dvol type : Directory 4.\u57f7\u884c\u547d\u4ee4\u4e26\u9a57\u8b49: # \u5275\u5efa Pod $ kubectl create -f volume-hostpath.yaml pod/test-pod2 created # \u6aa2\u67e5 Pod \u72c0\u614b $ kubectl get pod/test-pod2 NAME READY STATUS RESTARTS AGE test-pod2 1 /1 Running 0 30s # \u9032\u5165\u5230\u5bb9\u5668\u88e1\u982d\u4f86\u63a2\u67e5 $ kubectl exec -it pod/test-pod2 -- /bin/sh # \u6253\u5370\u5bb9\u5668\u7684\u76ee\u9304 $ ls -la total 80 drwxr-xr-x 1 root root 4096 Aug 13 00 :59 . drwxr-xr-x 1 root root 4096 Aug 13 00 :59 .. drwxr-xr-x 2 root root 4096 Jan 27 2015 bin drwxr-xr-x 2 root root 4096 Dec 24 2014 boot drwxr-xr-x 5 root root 360 Aug 13 00 :59 dev drwxr-xr-x 1 root root 4096 Aug 13 00 :59 etc drwxr-xr-x 2 root root 4096 Dec 24 2014 home drwxr-xr-x 1 root root 4096 Jan 27 2015 lib drwxr-xr-x 2 root root 4096 Jan 27 2015 lib64 drwxr-xr-x 2 root root 4096 Jan 27 2015 media drwxr-xr-x 2 root root 4096 Dec 24 2014 mnt drwxr-xr-x 2 root root 4096 Jan 27 2015 opt dr-xr-xr-x 506 root root 0 Aug 13 00 :59 proc drwx------ 2 root root 4096 Jan 27 2015 root drwxr-xr-x 1 root root 4096 Aug 13 00 :59 run drwxr-xr-x 2 root root 4096 Jan 27 2015 sbin drwxr-xr-x 2 root root 4096 Jun 10 2012 selinux drwxr-xr-x 2 root root 4096 Jan 27 2015 srv dr-xr-xr-x 13 root root 0 Aug 13 00 :59 sys drwxrwxr-x 2 1000 1000 4096 Aug 13 00 :53 test-hostpath drwxrwxrwt 1 root root 4096 Jan 27 2015 tmp drwxr-xr-x 1 root root 4096 Jan 27 2015 usr drwxr-xr-x 1 root root 4096 Jan 27 2015 var # \u5275\u5efa\u4e00\u500b\u6a94\u6848\u4e26\u5beb\u5165\u8cc7\u6599 $ echo $( hostname ) $ echo $( hostname ) > /test-hostpath/hostname.txt $ exit \u9000\u51fa pod \u4e26\u5f9e\u5bbf\u4e3b\u6a5f\u4e0a\u7684\u76ee\u9304\u8b80\u53d6\u5167\u5bb9\uff1a $ cat /tmp/k3dvol/hostname.txt test-pod2 \u522a\u9664\u9019\u500b\u6587\u4ef6\u4e0d\u6703\u522a\u9664\u6389\u5728 hostPath \u7684\u6a94\u6848\u593e\u88e1\u7684\u6578\u64da\u8207\u6a94\u6848\u3002 PV \u8207 PVC \u00b6 PV \u7684\u5168\u7a31\u662f\uff1aPersistentVolume\uff08\u6301\u4e45\u5316\u5377\uff09\uff0c\u662f\u5c0d\u5e95\u5c64\u7684\u5171\u4eab\u5b58\u5132\u7684\u4e00\u7a2e\u62bd\u8c61\uff0cPV \u7531\u7ba1\u7406\u54e1\u9032\u884c\u5275\u5efa\u548c\u914d\u7f6e\uff0c\u5b83\u548c\u5177\u9ad4\u7684\u5e95\u5c64\u7684\u5171\u4eab\u5b58\u5132\u6280\u8853\u7684\u5be6\u73fe\u65b9\u5f0f\u6709\u95dc\uff0c\u6bd4\u5982 Ceph\u3001GlusterFS\u3001NFS \u7b49\uff0c\u90fd\u662f\u901a\u904e\u63d2\u4ef6\u6a5f\u88fd\u5b8c\u6210\u8207\u5171\u4eab\u5b58\u5132\u7684\u5c0d\u63a5\u3002 PVC \u7684\u5168\u7a31\u662f\uff1aPersistentVolumeClaim\uff08\u6301\u4e45\u5316\u5377\u8072\u660e\uff09\uff0cPVC \u662f\u7528\u6236\u5b58\u5132\u7684\u4e00\u7a2e\u8072\u660e\uff0cPVC \u548c Pod \u6bd4\u8f03\u985e\u4f3c\uff0cPod \u6d88\u8017\u7684\u662f\u7bc0\u9ede\u4e0a\u7684\u8cc7\u6e90\uff0cPVC \u6d88\u8017\u7684\u662f PV \u8cc7\u6e90\uff0cPod \u53ef\u4ee5\u8acb\u6c42 CPU \u548c\u5167\u5b58\uff0c\u800c PVC \u53ef\u4ee5\u8acb\u6c42\u7279\u5b9a\u7684\u5b58\u5132\u7a7a\u9593\u548c\u8a2a\u554f\u6a21\u5f0f\u3002\u5c0d\u65bc\u771f\u6b63\u4f7f\u7528\u5b58\u5132\u7684\u7528\u6236\u4e0d\u9700\u8981\u95dc\u5fc3\u5e95\u5c64\u7684\u5b58\u5132\u5be6\u73fe\u7d30\u7bc0\uff0c\u53ea\u9700\u8981\u76f4\u63a5\u4f7f\u7528 PVC \u5373\u53ef\u3002 \u751f\u547d\u9031\u671f \u00b6 PV \u662f\u96c6\u7fa4\u4e2d\u7684\u8cc7\u6e90\u3002 PVC \u662f\u5c0d\u9019\u4e9b\u8cc7\u6e90\u7684\u8acb\u6c42\u3002 PV \u548c PVC \u4e4b\u9593\u7684\u76f8\u4e92\u4f5c\u7528\u9075\u5faa\u9019\u500b\u751f\u547d\u9031\u671f: Provisioning -> Binding -> Using -> Releasing -> Recycling Provisioning \u00b6 \u9019\u88e1\u6709\u5169\u7a2ePV\u7684\u63d0\u4f9b\u65b9\u5f0f:\u975c\u614b\u6216\u8005\u52d5\u614b\u3002 Static\uff1a\u96c6\u7fa4\u7ba1\u7406\u54e1\u5275\u5efa\u591a\u500b PV\u3002\u5b83\u5011\u651c\u5e36\u53ef\u4f9b\u96c6\u7fa4\u7528\u6236\u4f7f\u7528\u7684\u771f\u5be6\u5b58\u5132\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u5b83\u5011\u5b58\u5728\u65bc Kubernetes API \u4e2d\uff0c\u53ef\u7528\u65bc\u6d88\u8cbb\u3002 Dynamic\uff1a\u7576\u7ba1\u7406\u54e1\u5275\u5efa\u7684\u975c\u614b PV \u90fd\u4e0d\u5339\u914d\u7528\u6236\u7684 PersistentVolumeClaim \u6642\uff0c\u96c6\u7fa4\u53ef\u80fd\u6703\u5617\u8a66\u70ba PVC \u52d5\u614b\u914d\u7f6e\u5377\u3002\u6b64\u914d\u7f6e\u57fa\u65bc StorageClasses\uff1aPVC \u5fc5\u9808\u8acb\u6c42\u4e00\u500b\u985e\uff0c\u4e26\u4e14\u7ba1\u7406\u54e1\u5fc5\u9808\u5df2\u5275\u5efa\u4e26\u914d\u7f6e\u8a72\u985e\u624d\u80fd\u9032\u884c\u52d5\u614b\u914d\u7f6e\u3002 Binding \u7d81\u5b9a \u00b6 \u5728\u52d5\u614b\u914d\u7f6e\u7684\u60c5\u6cc1\u4e0b\uff0c\u7528\u6236\u5275\u5efa\u6216\u5df2\u7d93\u5275\u5efa\u4e86\u5177\u6709\u7279\u5b9a\u6578\u91cf\u7684\u5b58\u5132\u8acb\u6c42\u548c\u7279\u5b9a\u8a2a\u554f\u6a21\u5f0f\u7684 PersistentVolumeClaim\u3002\u4e3b\u6a5f\u4e2d\u7684\u63a7\u5236\u8ff4\u8def\u76e3\u8996\u65b0\u7684 PVC\uff0c\u627e\u5230\u5339\u914d\u7684 PV\uff08\u5982\u679c\u53ef\u80fd\uff09\uff0c\u4e26\u5c07\u5b83\u5011\u7d81\u5b9a\u5728\u4e00\u8d77\u3002 \u5982\u679c\u70ba\u65b0\u7684 PVC \u52d5\u614b\u914d\u7f6e PV\uff0c\u5247\u5faa\u74b0\u5c07\u59cb\u7d42\u5c07\u8a72 PV \u7d81\u5b9a\u5230 PVC\u3002\u5426\u5247\uff0c\u7528\u6236\u7e3d\u662f\u81f3\u5c11\u5f97\u5230\u4ed6\u5011\u8981\u6c42\u7684\u5167\u5bb9\uff0c\u4f46\u662f\u5377\u53ef\u80fd\u8d85\u51fa\u4e86\u8981\u6c42\u3002\u4e00\u65e6\u7d81\u5b9a\uff0cPersistentVolumeClaim \u7d81\u5b9a\u662f\u6392\u4ed6\u7684\uff0c\u4e0d\u8ad6\u662f\u7528\u65bc\u90a3\u7a2e\u7d81\u5b9a\u6a21\u5f0f\u3002 \u5982\u679c\u5339\u914d\u7684\u6372\u4e0d\u5b58\u5728\uff0cPVC\u5c07\u4fdd\u6301\u7121\u9650\u671f\u5faa\u74b0\u6aa2\u67e5\u3002\u7576\u96a8\u8457\u5339\u914d\u5377\u8b8a\u5f97\u53ef\u7528\uff0cPVC\u5c07\u88ab\u7d81\u5b9a\u3002\u4f8b\u5982\uff0c\u63d0\u4f9b\u8a31\u591a50Gi PV\u7684\u96c6\u7fa4\u5c07\u4e0d\u5339\u914d\u8981\u6c42 100Gi \u7684 PVC\u3002\u7576\u96c6\u7fa4\u4e2d\u6dfb\u52a0 100Gi PV \u6642\uff0c\u53ef\u4ee5\u7d81\u5b9aPVC\u3002 PVC \u4fdd\u8b77\u7684\u76ee\u7684\u662f\u78ba\u4fdd\u7531 pod \u6b63\u5728\u4f7f\u7528\u7684 PVC \u4e0d\u6703\u5f9e\u7cfb\u7d71\u4e2d\u79fb\u9664\uff0c\u56e0\u70ba\u5982\u679c\u88ab\u79fb\u9664\u7684\u8a71\u53ef\u80fd\u6703\u5c0e\u81f4\u6578\u64da\u4e1f\u5931 \u7576\u555f\u7528 PVC \u4fdd\u8b77\u529f\u80fd\u6642\uff0c\u5982\u679c\u7528\u6236\u522a\u9664\u4e86\u4e00\u500b pod \u6b63\u5728\u4f7f\u7528\u7684 PVC\uff0c\u5247\u8a72 PVC \u4e0d\u6703\u88ab\u7acb\u5373\u522a\u9664\u3002 PVC \u7684 \u522a\u9664\u5c07\u88ab\u63a8\u9072\uff0c\u76f4\u5230 PVC \u4e0d\u518d\u88ab\u4efb\u4f55 pod \u4f7f\u7528\u3002 PV \u8a2a\u554f\u6a21\u5f0f \u00b6 PersistentVolume \u5377\u53ef\u4ee5\u7528\u8cc7\u6e90\u63d0\u4f9b\u8005\u6240\u652f\u6301\u7684\u4efb\u4f55\u65b9\u5f0f\u639b\u8f09\u5230\u5bbf\u4e3b\u7cfb\u7d71\u4e0a\u3002\u5982\u4e0b\u8868\u6240\u793a\uff0c\u63d0\u4f9b\u8005\uff08\u9a45\u52d5\uff09\u7684\u80fd\u529b\u4e0d\u540c\uff0c\u6bcf\u500b PV \u5377\u7684\u8a2a\u554f\u6a21\u5f0f\u90fd\u6703\u8a2d\u7f6e\u70ba\u5c0d\u61c9\u5377\u6240\u652f\u6301\u7684\u6a21\u5f0f\u503c\u3002\u4f8b\u5982\uff0cNFS \u53ef\u4ee5\u652f\u6301\u591a\u500b\u8b80\u5beb\u5ba2\u6236\uff0c\u4f46\u662f\u67d0\u500b\u7279\u5b9a\u7684 NFS PV \u5377\u53ef\u80fd\u5728\u670d\u52d9\u5668\u4e0a\u4ee5\u53ea\u8b80\u7684\u65b9\u5f0f\u5c0e\u51fa\u3002\u6bcf\u500b PV \u5377\u90fd\u6703\u7372\u5f97\u81ea\u8eab\u7684\u8a2a\u554f\u6a21\u5f0f\u96c6\u5408\uff0c\u63cf\u8ff0\u7684\u662f\u7279\u5b9a PV \u5377\u7684\u80fd\u529b\u3002 \u8a2a\u554f\u6a21\u5f0f\u6709\u4e0b\u5217\u56db\u7a2e\uff1a \u8a2a\u554f\u6a21\u5f0f \u8aaa\u660e ReadWriteOnce \u5377\u53ef\u4ee5\u88ab\u4e00\u500b\u7bc0\u9ede\u4ee5\u8b80\u5beb\u65b9\u5f0f\u639b\u8f09\u3002 ReadWriteOnce \u8a2a\u554f\u6a21\u5f0f\u4e5f\u5141\u8a31\u904b\u884c\u5728\u540c\u4e00\u7bc0\u9ede\u4e0a\u7684\u591a\u500b Pod \u8a2a\u554f\u5377\u3002 ReadOnlyMany \u5377\u53ef\u4ee5\u88ab\u591a\u500b\u7bc0\u9ede\u4ee5\u53ea\u8b80\u65b9\u5f0f\u639b\u8f09\u3002 ReadWriteMany \u5377\u53ef\u4ee5\u88ab\u591a\u500b\u7bc0\u9ede\u4ee5\u8b80\u5beb\u65b9\u5f0f\u639b\u8f09\u3002 ReadWriteOncePod \u5377\u53ef\u4ee5\u88ab\u55ae\u500b Pod \u4ee5\u8b80\u5beb\u65b9\u5f0f\u639b\u8f09\u3002\u5982\u679c\u4f60\u60f3\u78ba\u4fdd\u6574\u500b\u96c6\u7fa4\u4e2d\u53ea\u6709\u4e00\u500b Pod \u53ef\u4ee5\u8b80\u53d6\u6216\u5beb\u5165\u8a72 PVC\uff0c \u8acb\u4f7f\u7528 ReadWriteOncePod \u8a2a\u554f\u6a21\u5f0f\u3002\u9019\u53ea\u652f\u6301 CSI \u5377\u4ee5\u53ca\u9700\u8981 Kubernetes 1.22 \u4ee5\u4e0a\u7248\u672c\u3002 \u5728\u547d\u4ee4\u884c\u63a5\u53e3\uff08CLI\uff09\u4e2d\uff0c\u8a2a\u554f\u6a21\u5f0f\u4e5f\u4f7f\u7528\u4ee5\u4e0b\u7e2e\u5beb\u5f62\u5f0f\uff1a RWO - ReadWriteOnce ROX - ReadOnlyMany RWX - ReadWriteMany RWOP - ReadWriteOncePod \u4e0b\u8868\u662f\u4e00\u4e9b\u5e38\u7528\u7684 Volume \u63d2\u4ef6\u652f\u6301\u7684\u8a2a\u554f\u6a21\u5f0f\uff1a Volume \u63d2\u4ef6 ReadWriteOnce ReadOnlyMany ReadWriteMany ReadWriteOncePod AWSElasticBlockStore \u2713 - - - AzureFile \u2713 \u2713 \u2713 - AzureDisk \u2713 - - - CephFS \u2713 \u2713 \u2713 - Cinder \u2713 - (if multi-attach volumes are available) - CSI depends on the driver depends on the driver depends on the driver depends on the driver FC \u2713 \u2713 - - FlexVolume \u2713 \u2713 depends on the driver - Flocker \u2713 - - - GCEPersistentDisk \u2713 \u2713 - - Glusterfs \u2713 \u2713 \u2713 - HostPath \u2713 - - - iSCSI \u2713 \u2713 - - Quobyte \u2713 \u2713 \u2713 - NFS \u2713 \u2713 \u2713 - RBD \u2713 \u2713 - - VsphereVolume \u2713 - - (works when Pods are collocated) - PortworxVolume \u2713 - \u2713 - StorageOS \u2713 - - - \u56de\u6536\u7b56\u7565 Reclaiming \u00b6 \u76ee\u524d\u7684\u56de\u6536\u7b56\u7565\u6709\uff1a Retain -- \u624b\u52d5\u56de\u6536 Recycle -- \u57fa\u672c\u64e6\u9664 (rm -rf /thevolume/*) Delete -- \u8af8\u5982 AWS EBS\u3001GCE PD\u3001Azure Disk \u6216 OpenStack Cinder \u5377\u9019\u985e\u95dc\u806f\u5b58\u5132\u8cc7\u7522\u4e5f\u88ab\u522a\u9664 \u76ee\u524d\uff0c\u50c5 NFS \u548c HostPath \u652f\u6301\u56de\u6536\uff08Recycle\uff09\u3002 AWS EBS\u3001GCE PD\u3001Azure Disk \u548c Cinder \u5377\u90fd\u652f\u6301\u522a\u9664\uff08Delete\uff09\u3002 \u72c0\u614b \u00b6 \u5377\u53ef\u4ee5\u8655\u65bc\u4ee5\u4e0b\u7684\u67d0\u7a2e\u72c0\u614b\uff1a Available \uff08\u53ef\u7528\uff09\uff1a\u4e00\u584a\u7a7a\u9592\u8cc7\u6e90\u9084\u6c92\u6709\u88ab\u4efb\u4f55\u8072\u660e\u7d81\u5b9a Bound \uff08\u5df2\u7d81\u5b9a\uff09\uff1a\u5377\u5df2\u7d93\u88ab\u8072\u660e\u7d81\u5b9a Released \uff08\u5df2\u91cb\u653e\uff09\uff1a\u8072\u660e\u88ab\u522a\u9664\uff0c\u4f46\u662f\u8cc7\u6e90\u9084\u672a\u88ab\u96c6\u7fa4\u91cd\u65b0\u8072\u660e Failed \uff08\u5931\u6557\uff09\uff1a\u8a72\u5377\u7684\u81ea\u52d5\u56de\u6536\u5931\u6557 \u547d\u4ee4\u884c\u6703\u986f\u793a\u7d81\u5b9a\u5230 PV \u7684 PVC \u7684\u540d\u7a31 \u5be6\u4f8b\u6f14\u793a \u00b6 kubernetes \u63d0\u4f9b\u7684 hostPath \u7d66\u6301\u4e45\u5316\u63d0\u4f9b\u4e86\u76f8\u7576\u5927\u7684\u4fbf\u5229, \u4f46\u6709\u4e00\u500b\u554f\u984c\u662f, \u6bcf\u6b21\u90fd\u9700\u8981\u624b\u52d5\u63d0\u524d\u5728\u6a5f\u5668\u4e0a\u5275\u5efa\u76f8\u61c9\u7684\u76ee\u9304\u4f86\u505a\u70ba\u88ab\u8abf\u5ea6\u61c9\u7528\u7684\u6301\u4e45\u5316\u76ee\u9304, \u4e0d\u662f\u5f88\u65b9\u4fbf, \u6709\u6c92\u6709\u8fa6\u6cd5\u53ef\u4ee5\u81ea\u52d5\u5275\u5efa\u5462? \u5c0d\u65bc K3D\uff0crancher \u4e5f\u63d0\u4f9b\u4e86\u76f8\u61c9\u7684\u5de5\u5177 local-path-provisioner \u3002\u5728\u5176\u5b83\u4e0d\u540c\u7684 K8S \u74b0\u5883\u4e2d, \u6703\u56e0\u61c9\u4e0d\u540c\u7684 Volume Driver \u7684\u8a2d\u7f6e\u800c\u6703\u6709\u4e0d\u540c\u7684 Storage Class \u7684\u914d\u7f6e\u3002 \u6aa2\u67e5\u96c6\u7fa4\u7684Storage Class\u5c0d\u8c61: $ kubectl get storageclass NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE local-path ( default ) rancher.io/local-path Delete WaitForFirstConsumer false 3h22m 1. \u5275\u5efa PVC \u00b6 volume-pvc.yaml apiVersion : v1 kind : PersistentVolumeClaim metadata : name : local-path-pvc spec : accessModes : - ReadWriteOnce storageClassName : local-path resources : requests : storage : 128Mi \u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u57f7\u884c\u8207\u6aa2\u8996\u7d50\u679c: $ kubectl apply -f volume-pvc.yaml persistentvolumeclaim/local-path-pvc created $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Pending local-path 13s \u6b64\u6642 PVC \u7684\u72c0\u614b\u662f: Pending 2. \u5275\u5efa Pod \u4f86\u639b\u8f09 PVC \u00b6 volume-pod-pvc.yaml apiVersion : v1 kind : Pod metadata : name : test-pod3 spec : containers : - name : volume-test image : nginx:stable-alpine imagePullPolicy : IfNotPresent volumeMounts : - name : volv mountPath : /data ports : - containerPort : 80 volumes : - name : volv persistentVolumeClaim : claimName : local-path-pvc \u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u57f7\u884c\u8207\u6aa2\u8996\u7d50\u679c: $ kubectl apply -f volume-pod-pvc.yaml pod/test-pod3 created $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Bound pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO local-path 3m57s $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO Delete Bound default/local-path-pvc local-path 40s $ kubectl get pod/test-pod3 NAME READY STATUS RESTARTS AGE test-pod3 1 /1 Running 0 90s 3. \u5728 pod \u4e2d\u5beb\u4e00\u4e9b\u6771\u897f\u5230\u639b\u8f09PVC\u7684\u76ee\u9304 /data/test \u00b6 $ kubectl exec pod/test-pod3 -- sh -c \"echo local-path-test > /data/test\" 4. \u522a\u9664 pod \u00b6 $ kubectl delete pod/test-pod3 pod \"test-pod3\" deleted 5. \u78ba\u8a8d pod \u6d88\u5931\u5f8c\uff0c\u91cd\u65b0\u5275\u5efa pod \u00b6 $ kubectl apply -f volume-pod-pvc.yaml pod/test-pod3 created 6. \u6aa2\u67e5\u5377\u5167\u5bb9 \u00b6 $ kubectl exec pod/test-pod3 -- sh -c \"cat /data/test\" local-path-test 7. \u522a\u9664 pod \u548c pvc \u00b6 $ kubectl delete -f volume-pod-pvc.yaml pod \"test-pod3\" deleted $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO Delete Bound default/local-path-pvc local-path 10m $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Bound pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO local-path 14m $ kubectl delete -f volume-pvc.yaml persistentvolumeclaim \"local-path-pvc\" deleted","title":"\u5b58\u5132\u7ba1\u7406 volume\u3001PV/PVC"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#volumepvpvc","text":"\u539f\u6587: k8s\u5165\u95e8\u6559\u7a0b\u5341\u4e8c:\u5b58\u50a8\u7ba1\u7406volume\u3001PV/PVC Kubernetes \u5b58\u5132\u7ba1\u7406\u6309\u7167\u767c\u5c55\u7684\u6b77\u7a0b\uff0c\u6d89\u53ca\u5230\u6709 Volume \uff0c PV (Persistent Volume) \u548c PVC (PersistentVolumeClaims),\u548c StorageClass \u3002 Volume \u662f K8S \u6700\u65e9\u63d0\u51fa\u7684\u5b58\u5132\u5377\u7684\u7d50\u69cb\uff0c\u4e3b\u8981\u89e3\u6c7a\u5bb9\u5668\u548c\u6578\u64da\u5b58\u5132\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u62bd\u8c61\u5e95\u5c64\u9a45\u52d5\u4ee5\u652f\u6301\u4e0d\u540c\u7684\u5b58\u5132\u985e\u578b\uff1b\u4f7f\u7528 Volume \u9700\u8981\u4e86\u89e3\u5e95\u5c64\u5b58\u5132\u7d30\u7bc0\uff0c\u56e0\u6b64\u63d0\u51fa\u4e86 PV \uff0c Persistent Volume \u662f\u7531 K8S \u7ba1\u7406\u54e1\u5b9a\u7fa9\u7684\u5b58\u5132\u55ae\u5143\uff0c\u61c9\u7528\u7aef\u4f7f\u7528 PersistentVolumeClaims \u8072\u660e\u53bb\u8abf\u7528 PV \u5b58\u5132\uff0c\u9032\u4e00\u6b65\u62bd\u8c61\u4e86\u5e95\u5c64\u5b58\u5132\uff1b\u96a8\u8457 PV \u6578\u91cf\u7684\u589e\u52a0\uff0c\u7ba1\u7406\u54e1\u9700\u8981\u4e0d\u505c\u7684\u5b9a\u7fa9 PV \u7684\u6578\u91cf\uff0c\u884d\u751f\u4e86\u901a\u904e StorageClass \u52d5\u614b\u751f\u6210 PV \uff0c StorageClass \u901a\u904e PVC \u4e2d\u8072\u660e\u5b58\u5132\u7684\u5bb9\u91cf\uff0c\u6703\u8abf\u7528\u5e95\u5c64\u7684\u63d0\u4f9b\u5546\u751f\u6210 PV \u3002 \u672c\u6559\u7a0b\u5148\u4ecb\u7d39 Volume \u7684\u4f7f\u7528\uff0c\u63a5\u8457\u518d\u4ecb\u7d39 PV\uff0cPVC \u548c StorageClass\u3002 Volume \u5b58\u5132\u5377\uff0c\u7368\u7acb\u65bc\u5bb9\u5668\uff0c\u5f8c\u7aef\u548c\u4e0d\u540c\u7684\u5b58\u5132\u9a45\u52d5\u5c0d\u63a5 PV Persistent Volume \u6301\u4e45\u5316\u5b58\u5132\u5377\uff0c\u548c node \u985e\u4f3c\uff0c\u662f\u4e00\u7a2e\u96c6\u7fa4\u8cc7\u6e90\uff0c\u7531\u7ba1\u7406\u54e1\u5b9a\u7fa9\uff0c\u5c0d\u63a5\u4e0d\u540c\u7684\u5b58\u5132 PVC PersistentVolumeClaims \u6301\u4e45\u5316\u5b58\u5132\u8072\u660e\uff0c\u548c pod \u985e\u4f3c\uff0c\u4f5c\u70ba PV \u7684\u4f7f\u7528\u8005 StorageClass \u52d5\u614b\u5b58\u5132\u985e\u578b\uff0c\u5206\u70ba\u975c\u614b\u548c\u52d5\u614b\u5169\u7a2e\u985e\u578b\uff0c\u901a\u904e\u5728 PVC \u4e2d\u5b9a\u7fa9\u5b58\u5132\u985e\u578b\uff0c\u81ea\u52d5\u5275\u5efa\u6240\u9700 PV","title":"\u5b58\u5132\u7ba1\u7406 volume\u3001PV/PVC"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#_1","text":"kubernetes \u5bb9\u5668\u4e2d\u7684\u6578\u64da\u662f \u81e8\u6642\u7684 \uff0c\u5373\u7576\u91cd\u555f\u91cd\u555f\u6216 crash \u5f8c\u5bb9\u5668\u7684\u6578\u64da\u5c07\u6703\u4e1f\u5931\uff0c\u6b64\u5916\u5bb9\u5668\u4e4b\u9593\u6709\u5171\u4eab\u5b58\u5132\u7684\u9700\u6c42\uff0c\u6240\u4ee5 kubernetes \u63d0\u4f9b\u4e86 volume \u5b58\u5132\u7684\u62bd\u8c61\uff0cvolume \u5f8c\u7aef\u80fd\u5920\u652f\u6301\u591a\u7a2e\u4e0d\u540c\u7684 plugin \u9a45\u52d5\uff0c\u901a\u904e .spec.volumes \u4e2d\u5b9a\u7fa9\u4e00\u500b\u5b58\u5132\uff0c\u7136\u5f8c\u5728\u5bb9\u5668\u4e2d .spec.containers.volumeMounts \u8abf\u7528\uff0c\u6700\u7d42\u5728\u5bb9\u5668\u5167\u90e8\u4ee5\u76ee\u9304\u7684\u5f62\u5f0f\u5448\u73fe\u3002 kubernetes \u5167\u7f6e\u80fd\u652f\u6301\u591a\u7a2e\u4e0d\u540c\u7684\u9a45\u52d5\u985e\u578b\uff0c\u5927\u9ad4\u4e0a\u53ef\u4ee5\u5206\u70ba\u56db\u7a2e\u985e\u578b\uff1a kubernetes\u5c0d\u8c61 API \u9a45\u52d5\u63a5\u53e3\uff0c\u5be6\u73fe\u5176\u4ed6\u5c0d\u8c61\u8abf\u7528\uff0c\u5982configmap, secret\uff0c\u6bcf\u7a2e\u5b58\u5132\u652f\u6301\u4e0d\u540c\u7684\u9a45\u52d5 \u672c\u5730\u81e8\u6642\u5b58\u5132\uff0c\u5982 hostPath, emptyDir \u7b49 \u958b\u6e90\u5b58\u5132\u9a45\u52d5\u63a5\u53e3\uff0c\u5982 lonhorn, rook \u7b49 \u516c/\u79c1\u6709\u96f2\u9a45\u52d5\u63a5\u53e3\uff0c\u5982 awsElasticBlockStore \u5be6\u73fe\u8207 aws EBS \u96c6\u6210","title":"\u5b58\u5132\u6982\u8ff0"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#_2","text":"\u672c\u5730\u81e8\u6642\u5b58\u5132\u5305\u62ec hostPath\u3001emptyDir \u7b49\u3002","title":"\u672c\u5730\u81e8\u6642\u5b58\u5132"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#emptydir","text":"emptyDir \u662f\u4e00\u7a2e\u81e8\u6642\u5b58\u5132\uff0cpod \u5275\u5efa\u7684\u6642\u5019\u6703\u5728 node \u7bc0\u9ede\u4e0a\u70ba\u5bb9\u5668\u7533\u8acb\u4e00\u500b\u81e8\u6642\u7684\u76ee\u9304\uff0c\u8ddf\u96a8\u5bb9\u5668\u7684\u751f\u547d\u9031\u671f\uff0c\u5982\u5bb9\u5668\u522a\u9664\uff0cemptyDir \u5b9a\u7fa9\u7684\u81e8\u6642\u5b58\u5132\u7a7a\u9593\u4e5f\u6703\u96a8\u4e4b\u522a\u9664\uff0c\u5bb9\u5668\u767c\u751f\u610f\u5916 crash \u5247\u4e0d\u53d7\u5f71\u97ff\uff0c\u540c\u6642\u5982\u679c\u5bb9\u5668\u767c\u751f\u4e86\u9077\u79fb\uff0c\u5176\u4e0a\u7684\u6578\u64da\u4e5f\u6703\u4e1f\u5931\uff0cemptyDir \u4e00\u822c\u7528\u65bc\u6e2c\u8a66\uff0c\u6216\u8005\u7de9\u5b58\u5834\u666f\u3002 Info \u6ce8\u610f\uff1a\u4e00\u500b\u5bb9\u5668\u5d29\u6f70\u4e86\u4e0d\u6703\u5c0e\u81f4\u6578\u64da\u7684\u4e1f\u5931\uff0c\u56e0\u70ba\u5bb9\u5668\u7684\u5d29\u6f70\u4e26\u4e0d\u79fb\u9664 pod. emptyDir \u7684\u4e00\u4e9b\u7528\u9014\uff1a \u7de9\u5b58\u7a7a\u9593\uff0c\u4f8b\u5982\u57fa\u65bc\u78c1\u76e4\u7684\u6b78\u4f75\u6392\u5e8f\u3002 \u70ba\u8017\u6642\u8f03\u9577\u7684\u8a08\u7b97\u4efb\u52d9\u63d0\u4f9b\u6aa2\u67e5\u9ede\uff0c\u4ee5\uf965\u4efb\u52d9\u80fd\u65b9\uf965\u5730\u5f9e\u5d29\u6f70\u524d\u72c0\u614b\u6062\u5fa9\u57f7\ufa08\u3002 \u5728 Web \u670d\u52d9\u5668\u5bb9\u5668\u670d\u52d9\u6578\u64da\u6642\uff0c\u4fdd\u5b58\u5167\u5bb9\u7ba1\u7406\u5668\u5bb9\u5668\u7372\u53d6\u7684\u6587\u4ef6\u3002 volume-emptydir.yaml apiVersion : v1 kind : Pod metadata : name : test-pod spec : containers : - image : busybox:1.35 name : test-container command : [ \"/bin/sh\" , \"-c\" , \"sleep 3600\" ] volumeMounts : - mountPath : /cache name : cache-volume volumes : - name : cache-volume emptyDir : {} \u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u5275\u5efa Pod: $ kubectl apply -f volume-emptydir.yaml pod/test-pd created \u8b93\u6211\u5011\u9032\u5165\u5230Pod\u4e4b\u4e2d\u4f86\u6aa2\u67e5\u4e00\u4e0b\u57f7\u884c\u5f8c\u7684\u7d50\u679c: $ kubectl get pods NAME READY STATUS RESTARTS AGE test-pod 1 /1 Running 0 24m $ kubectl exec -it pod/test-pod -- /sh / # ls -la total 48 drwxr-xr-x 1 root root 4096 Aug 12 23 :21 . drwxr-xr-x 1 root root 4096 Aug 12 23 :21 .. drwxr-xr-x 2 root root 12288 Jul 29 01 :38 bin drwxrwxrwx 2 root root 4096 Aug 12 23 :21 cache drwxr-xr-x 5 root root 360 Aug 12 23 :21 dev drwxr-xr-x 1 root root 4096 Aug 12 23 :21 etc drwxr-xr-x 2 nobody nobody 4096 Jul 29 01 :38 home dr-xr-xr-x 483 root root 0 Aug 12 23 :21 proc drwx------ 1 root root 4096 Aug 12 23 :47 root dr-xr-xr-x 13 root root 0 Aug 12 23 :21 sys drwxrwxrwt 2 root root 4096 Jul 29 01 :38 tmp drwxr-xr-x 3 root root 4096 Jul 29 01 :38 usr drwxr-xr-x 1 root root 4096 Aug 12 23 :21 var / # cd cache/ /cache # echo 000 > a.txt /cache # cat a.txt 000 /cache # exit \u7576\u9019\u500b pod \u88ab\u522a\u9664\u6642\uff0c\u9019\u500b\u6240\u6709\u7f6e\u653e\u5728 emptyDir \u88e1\u7684\u6587\u4ef6\u4e5f\u662f\u6703\u81ea\u52d5\u522a\u9664\u7684\u3002","title":"emptyDir \u81e8\u6642\u5b58\u5132"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#hostpath","text":"Warning \u8b66\u544a\uff1a HostPath \u5377\u5b58\u5728\u8a31\u591a\u5b89\u5168\u98a8\u96aa\uff0c\u6700\u4f73\u505a\u6cd5\u662f\u76e1\u53ef\u80fd\u907f\u514d\u4f7f\u7528 HostPath\u3002\u7576\u5fc5\u9808\u4f7f\u7528 HostPath \u5377\u6642\uff0c\u5b83\u7684\u7bc4\u570d\u61c9\u50c5\u9650\u65bc\u6240\u9700\u7684\u6587\u4ef6\u6216\u76ee\u9304\uff0c\u4e26\u4ee5\u53ea\u8b80\u65b9\u5f0f\u639b\u8f09\u3002 \u5982\u679c\u901a\u904e AdmissionPolicy \u9650\u5236 HostPath \u5c0d\u7279\u5b9a\u76ee\u9304\u7684\u8a2a\u554f\uff0c\u5247\u5fc5\u9808\u8981\u6c42 volumeMounts \u4f7f\u7528 readOnly \u639b\u8f09\u4ee5\u4f7f\u7b56\u7565\u751f\u6548\u3002 hostPath \u5377\u80fd\u5c07 node \u5bbf\u4e3b\u6a5f\u7bc0\u9ede\u6587\u4ef6\u7cfb\u7d71\u4e0a\u7684\u6587\u4ef6\u6216\u76ee\u9304\u639b\u8f09\u5230\u60a8\u7684 Pod \u4e2d\u3002\u4f8b\u5982\uff0chostPath \u7684\u4e00\u4e9b\u7528\u6cd5\u6709\uff1a \u904b\u884c\u4e00\u500b\u9700\u8981\u8a2a\u554f Docker \u5f15\u64ce\u5167\u90e8\u6a5f\u5236\u7684\u5bb9\u5668\uff1b\u8acb\u4f7f\u7528 hostPath \u639b\u8f09 /var/lib/docker \u8def\u5f91\u3002 \u5728\u5bb9\u5668\u4e2d\u904b\u884c cAdvisor \u6642\uff0c\u4ee5 hostPath \u65b9\u5f0f\u639b\u8f09 /sys\u3002 \u5141\u8a31 Pod \u6307\u5b9a\u7d66\u5b9a\u7684 hostPath \u5728\u904b\u884c Pod \u4e4b\u524d\u662f\u5426\u61c9\u8a72\u5b58\u5728\uff0c\u662f\u5426\u61c9\u8a72\u5275\u5efa\u4ee5\u53ca\u61c9\u8a72\u4ee5\uf9fd\u9ebc\u65b9\u5f0f\u5b58\u5728\u3002 \u9664\u4e86\u5fc5\u9700\u7684 path \u5c6c\u6027\u4e4b\u5916\uff0c\u7528\u6236\u53ef\u4ee5\u9078\u64c7\u6027\u5730\u70ba hostPath \u5377\u6307\u5b9a type \u3002\u652f\u6301\u7684 type \u503c\u5982\u4e0b\uff1a hostPath Type \u503c \u884c\u70ba \u7a7a\u5b57\u7b26\u4e32\uff08\u9ed8\u8a8d\uff09 \u7528\u65bc\u5411\u5f8c\u517c\u5bb9\uff0c\u9019\u610f\u5473\u8457\u5728\u5b89\u88dd hostPath \u5377\u4e4b\u524d\u4e0d\u6703\u57f7\u884c\u4efb\u4f55\u6aa2\u67e5\u3002 DirectoryOrCreate \u5982\u679c\u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u4ec0\u9ebc\u90fd\u4e0d\u5b58\u5728\uff0c\u90a3\u9ebc\u5c07\u6839\u64da\u9700\u8981\u5275\u5efa\u7a7a\u76ee\u9304\uff0c\u6b0a\u9650\u8a2d\u7f6e\u70ba 0755\uff0c\u5177\u6709\u8207 Kubelet \u76f8\u540c\u7684\u7d44\u548c\u6240\u6709\u6b0a\u3002 Directory \u5728\u7d66\u5b9a\uf937\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u76ee\u9304\u3002 FileOrCreate \u5982\u679c\u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u4ec0\u9ebc\u90fd\u4e0d\u5b58\u5728\uff0c\u90a3\u9ebc\u5c07\u5728\u90a3\u88e1\u6839\u64da\u9700\u8981\u5275\u5efa\u7a7a\u6587\u4ef6\uff0c\u6b0a\u9650\u8a2d\u7f6e\u70ba 0644\uff0c\u5177\u6709\u8207 Kubelet \u76f8\u540c\u7684\u7d44\u548c\u6240\u6709\u6b0a\u3002 File \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u6587\u4ef6\u3002 Socket \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684 UNIX \u5957\u63a5\u5b57\u3002 CharDevice \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u5b57\u7b26\u8a2d\u5099\u3002 BlockDevice \u5728\u7d66\u5b9a\u8def\u5f91\u4e0a\u5fc5\u9808\u5b58\u5728\u7684\u584a\u8a2d\u5099\u3002 \u7576\u4f7f\u7528\u9019\u7a2e\u985e\u578b\u7684\u5377\u6642\u8981\u5c0f\u5fc3\uff0c\u56e0\u70ba\uff1a \u5177\u6709\u76f8\u540c\u914d\u7f6e\uff08\u4f8b\u5982\u5f9e podTemplate \u5275\u5efa\uff09\u7684\u591a\u500b Pod \u6703\u7531\u65bc\u7bc0\u9ede\u4e0a\u6587\u4ef6\u7684\uf967\u540c\u800c\u5728\uf967\u540c\u7bc0\u9ede\u4e0a\u6709\uf967\u540c\u7684\ufa08\u70ba\u3002 \u7576 Kubernetes \u6309\u7167\u8a08\u5283\u6dfb\u52a0\u8cc7\u6e90\u611f\u77e5\u7684\u8abf\u5ea6\u6642\uff0c\u9019\u985e\u8abf\u5ea6\u6a5f\u5236\u5c07\u7121\u6cd5\u8003\u616e\u7531 hostPath \u4f7f\u7528\u7684\u8cc7\u6e90\u3002 \u57fa\u790e\u4e3b\u6a5f\u4e0a\u5275\u5efa\u7684\u6587\u4ef6\u6216\u76ee\u9304\u53ea\u80fd\u7531 root \u7528\u6236\u5beb\u5165\u3002\u60a8\u9700\u8981\u5728\u7279\u6b0a\u5bb9\u5668\u4e2d\u4ee5 root \u8eab\u4efd\u904b\u884c\u9032\u7a0b\uff0c\u6216\u8005\u4fee\u6539\u4e3b\u6a5f\u4e0a\u7684\u6587\u4ef6\u6b0a\u9650\u4ee5\uf965\u5bb9\ufa38\u80fd\u5920\u5beb\u5165 hostPath \u5377\u3002 \u7531\u65bc\u672c\u6559\u7a0b\u4f7f\u7528 K3D \u4f5c\u70ba K8S \u5b78\u7fd2\u74b0\u5883\uff0c\u4e0b\u5217\u7684\u7df4\u7fd2\u6b65\u9a5f\u9700\u8981\u642d\u914d K3D \u6240\u69cb\u5efa\u7684\u74b0\u5883\u3002 1.\u5728\u6211\u5011\u5c07\u4fdd\u5b58\u6578\u64da\u7684\u4e3b\u6a5f\u4e0a\u5275\u5efa\u76ee\u9304\uff1a $ mkdir -p /tmp/k3dvol 2.\u5275\u5efa\u96c6\u7fa4\u4e26\u8a2d\u5b9a\u67d0\u500b Node path \u639b\u8f09\u9032 K8S \u4e2d\uff1a $ k3d cluster create --volume /tmp/k3dvol:/tmp/k3dvol@server:0 3.\u5275\u5efa test-pod2 \u7684\u5ba3\u544a\u6a94 volume-hostpath.yaml : volume-hostpath.yaml apiVersion : v1 kind : Pod metadata : name : test-pod2 spec : containers : - image : nginx:1.7.9 name : test-container volumeMounts : - mountPath : /test-hostpath name : test-volume volumes : - name : test-volume hostPath : path : /tmp/k3dvol type : Directory 4.\u57f7\u884c\u547d\u4ee4\u4e26\u9a57\u8b49: # \u5275\u5efa Pod $ kubectl create -f volume-hostpath.yaml pod/test-pod2 created # \u6aa2\u67e5 Pod \u72c0\u614b $ kubectl get pod/test-pod2 NAME READY STATUS RESTARTS AGE test-pod2 1 /1 Running 0 30s # \u9032\u5165\u5230\u5bb9\u5668\u88e1\u982d\u4f86\u63a2\u67e5 $ kubectl exec -it pod/test-pod2 -- /bin/sh # \u6253\u5370\u5bb9\u5668\u7684\u76ee\u9304 $ ls -la total 80 drwxr-xr-x 1 root root 4096 Aug 13 00 :59 . drwxr-xr-x 1 root root 4096 Aug 13 00 :59 .. drwxr-xr-x 2 root root 4096 Jan 27 2015 bin drwxr-xr-x 2 root root 4096 Dec 24 2014 boot drwxr-xr-x 5 root root 360 Aug 13 00 :59 dev drwxr-xr-x 1 root root 4096 Aug 13 00 :59 etc drwxr-xr-x 2 root root 4096 Dec 24 2014 home drwxr-xr-x 1 root root 4096 Jan 27 2015 lib drwxr-xr-x 2 root root 4096 Jan 27 2015 lib64 drwxr-xr-x 2 root root 4096 Jan 27 2015 media drwxr-xr-x 2 root root 4096 Dec 24 2014 mnt drwxr-xr-x 2 root root 4096 Jan 27 2015 opt dr-xr-xr-x 506 root root 0 Aug 13 00 :59 proc drwx------ 2 root root 4096 Jan 27 2015 root drwxr-xr-x 1 root root 4096 Aug 13 00 :59 run drwxr-xr-x 2 root root 4096 Jan 27 2015 sbin drwxr-xr-x 2 root root 4096 Jun 10 2012 selinux drwxr-xr-x 2 root root 4096 Jan 27 2015 srv dr-xr-xr-x 13 root root 0 Aug 13 00 :59 sys drwxrwxr-x 2 1000 1000 4096 Aug 13 00 :53 test-hostpath drwxrwxrwt 1 root root 4096 Jan 27 2015 tmp drwxr-xr-x 1 root root 4096 Jan 27 2015 usr drwxr-xr-x 1 root root 4096 Jan 27 2015 var # \u5275\u5efa\u4e00\u500b\u6a94\u6848\u4e26\u5beb\u5165\u8cc7\u6599 $ echo $( hostname ) $ echo $( hostname ) > /test-hostpath/hostname.txt $ exit \u9000\u51fa pod \u4e26\u5f9e\u5bbf\u4e3b\u6a5f\u4e0a\u7684\u76ee\u9304\u8b80\u53d6\u5167\u5bb9\uff1a $ cat /tmp/k3dvol/hostname.txt test-pod2 \u522a\u9664\u9019\u500b\u6587\u4ef6\u4e0d\u6703\u522a\u9664\u6389\u5728 hostPath \u7684\u6a94\u6848\u593e\u88e1\u7684\u6578\u64da\u8207\u6a94\u6848\u3002","title":"hostPath \u4e3b\u6a5f\u5b58\u5132"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#pv-pvc","text":"PV \u7684\u5168\u7a31\u662f\uff1aPersistentVolume\uff08\u6301\u4e45\u5316\u5377\uff09\uff0c\u662f\u5c0d\u5e95\u5c64\u7684\u5171\u4eab\u5b58\u5132\u7684\u4e00\u7a2e\u62bd\u8c61\uff0cPV \u7531\u7ba1\u7406\u54e1\u9032\u884c\u5275\u5efa\u548c\u914d\u7f6e\uff0c\u5b83\u548c\u5177\u9ad4\u7684\u5e95\u5c64\u7684\u5171\u4eab\u5b58\u5132\u6280\u8853\u7684\u5be6\u73fe\u65b9\u5f0f\u6709\u95dc\uff0c\u6bd4\u5982 Ceph\u3001GlusterFS\u3001NFS \u7b49\uff0c\u90fd\u662f\u901a\u904e\u63d2\u4ef6\u6a5f\u88fd\u5b8c\u6210\u8207\u5171\u4eab\u5b58\u5132\u7684\u5c0d\u63a5\u3002 PVC \u7684\u5168\u7a31\u662f\uff1aPersistentVolumeClaim\uff08\u6301\u4e45\u5316\u5377\u8072\u660e\uff09\uff0cPVC \u662f\u7528\u6236\u5b58\u5132\u7684\u4e00\u7a2e\u8072\u660e\uff0cPVC \u548c Pod \u6bd4\u8f03\u985e\u4f3c\uff0cPod \u6d88\u8017\u7684\u662f\u7bc0\u9ede\u4e0a\u7684\u8cc7\u6e90\uff0cPVC \u6d88\u8017\u7684\u662f PV \u8cc7\u6e90\uff0cPod \u53ef\u4ee5\u8acb\u6c42 CPU \u548c\u5167\u5b58\uff0c\u800c PVC \u53ef\u4ee5\u8acb\u6c42\u7279\u5b9a\u7684\u5b58\u5132\u7a7a\u9593\u548c\u8a2a\u554f\u6a21\u5f0f\u3002\u5c0d\u65bc\u771f\u6b63\u4f7f\u7528\u5b58\u5132\u7684\u7528\u6236\u4e0d\u9700\u8981\u95dc\u5fc3\u5e95\u5c64\u7684\u5b58\u5132\u5be6\u73fe\u7d30\u7bc0\uff0c\u53ea\u9700\u8981\u76f4\u63a5\u4f7f\u7528 PVC \u5373\u53ef\u3002","title":"PV \u8207 PVC"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#_3","text":"PV \u662f\u96c6\u7fa4\u4e2d\u7684\u8cc7\u6e90\u3002 PVC \u662f\u5c0d\u9019\u4e9b\u8cc7\u6e90\u7684\u8acb\u6c42\u3002 PV \u548c PVC \u4e4b\u9593\u7684\u76f8\u4e92\u4f5c\u7528\u9075\u5faa\u9019\u500b\u751f\u547d\u9031\u671f: Provisioning -> Binding -> Using -> Releasing -> Recycling","title":"\u751f\u547d\u9031\u671f"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#provisioning","text":"\u9019\u88e1\u6709\u5169\u7a2ePV\u7684\u63d0\u4f9b\u65b9\u5f0f:\u975c\u614b\u6216\u8005\u52d5\u614b\u3002 Static\uff1a\u96c6\u7fa4\u7ba1\u7406\u54e1\u5275\u5efa\u591a\u500b PV\u3002\u5b83\u5011\u651c\u5e36\u53ef\u4f9b\u96c6\u7fa4\u7528\u6236\u4f7f\u7528\u7684\u771f\u5be6\u5b58\u5132\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u5b83\u5011\u5b58\u5728\u65bc Kubernetes API \u4e2d\uff0c\u53ef\u7528\u65bc\u6d88\u8cbb\u3002 Dynamic\uff1a\u7576\u7ba1\u7406\u54e1\u5275\u5efa\u7684\u975c\u614b PV \u90fd\u4e0d\u5339\u914d\u7528\u6236\u7684 PersistentVolumeClaim \u6642\uff0c\u96c6\u7fa4\u53ef\u80fd\u6703\u5617\u8a66\u70ba PVC \u52d5\u614b\u914d\u7f6e\u5377\u3002\u6b64\u914d\u7f6e\u57fa\u65bc StorageClasses\uff1aPVC \u5fc5\u9808\u8acb\u6c42\u4e00\u500b\u985e\uff0c\u4e26\u4e14\u7ba1\u7406\u54e1\u5fc5\u9808\u5df2\u5275\u5efa\u4e26\u914d\u7f6e\u8a72\u985e\u624d\u80fd\u9032\u884c\u52d5\u614b\u914d\u7f6e\u3002","title":"Provisioning"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#binding","text":"\u5728\u52d5\u614b\u914d\u7f6e\u7684\u60c5\u6cc1\u4e0b\uff0c\u7528\u6236\u5275\u5efa\u6216\u5df2\u7d93\u5275\u5efa\u4e86\u5177\u6709\u7279\u5b9a\u6578\u91cf\u7684\u5b58\u5132\u8acb\u6c42\u548c\u7279\u5b9a\u8a2a\u554f\u6a21\u5f0f\u7684 PersistentVolumeClaim\u3002\u4e3b\u6a5f\u4e2d\u7684\u63a7\u5236\u8ff4\u8def\u76e3\u8996\u65b0\u7684 PVC\uff0c\u627e\u5230\u5339\u914d\u7684 PV\uff08\u5982\u679c\u53ef\u80fd\uff09\uff0c\u4e26\u5c07\u5b83\u5011\u7d81\u5b9a\u5728\u4e00\u8d77\u3002 \u5982\u679c\u70ba\u65b0\u7684 PVC \u52d5\u614b\u914d\u7f6e PV\uff0c\u5247\u5faa\u74b0\u5c07\u59cb\u7d42\u5c07\u8a72 PV \u7d81\u5b9a\u5230 PVC\u3002\u5426\u5247\uff0c\u7528\u6236\u7e3d\u662f\u81f3\u5c11\u5f97\u5230\u4ed6\u5011\u8981\u6c42\u7684\u5167\u5bb9\uff0c\u4f46\u662f\u5377\u53ef\u80fd\u8d85\u51fa\u4e86\u8981\u6c42\u3002\u4e00\u65e6\u7d81\u5b9a\uff0cPersistentVolumeClaim \u7d81\u5b9a\u662f\u6392\u4ed6\u7684\uff0c\u4e0d\u8ad6\u662f\u7528\u65bc\u90a3\u7a2e\u7d81\u5b9a\u6a21\u5f0f\u3002 \u5982\u679c\u5339\u914d\u7684\u6372\u4e0d\u5b58\u5728\uff0cPVC\u5c07\u4fdd\u6301\u7121\u9650\u671f\u5faa\u74b0\u6aa2\u67e5\u3002\u7576\u96a8\u8457\u5339\u914d\u5377\u8b8a\u5f97\u53ef\u7528\uff0cPVC\u5c07\u88ab\u7d81\u5b9a\u3002\u4f8b\u5982\uff0c\u63d0\u4f9b\u8a31\u591a50Gi PV\u7684\u96c6\u7fa4\u5c07\u4e0d\u5339\u914d\u8981\u6c42 100Gi \u7684 PVC\u3002\u7576\u96c6\u7fa4\u4e2d\u6dfb\u52a0 100Gi PV \u6642\uff0c\u53ef\u4ee5\u7d81\u5b9aPVC\u3002 PVC \u4fdd\u8b77\u7684\u76ee\u7684\u662f\u78ba\u4fdd\u7531 pod \u6b63\u5728\u4f7f\u7528\u7684 PVC \u4e0d\u6703\u5f9e\u7cfb\u7d71\u4e2d\u79fb\u9664\uff0c\u56e0\u70ba\u5982\u679c\u88ab\u79fb\u9664\u7684\u8a71\u53ef\u80fd\u6703\u5c0e\u81f4\u6578\u64da\u4e1f\u5931 \u7576\u555f\u7528 PVC \u4fdd\u8b77\u529f\u80fd\u6642\uff0c\u5982\u679c\u7528\u6236\u522a\u9664\u4e86\u4e00\u500b pod \u6b63\u5728\u4f7f\u7528\u7684 PVC\uff0c\u5247\u8a72 PVC \u4e0d\u6703\u88ab\u7acb\u5373\u522a\u9664\u3002 PVC \u7684 \u522a\u9664\u5c07\u88ab\u63a8\u9072\uff0c\u76f4\u5230 PVC \u4e0d\u518d\u88ab\u4efb\u4f55 pod \u4f7f\u7528\u3002","title":"Binding \u7d81\u5b9a"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#pv","text":"PersistentVolume \u5377\u53ef\u4ee5\u7528\u8cc7\u6e90\u63d0\u4f9b\u8005\u6240\u652f\u6301\u7684\u4efb\u4f55\u65b9\u5f0f\u639b\u8f09\u5230\u5bbf\u4e3b\u7cfb\u7d71\u4e0a\u3002\u5982\u4e0b\u8868\u6240\u793a\uff0c\u63d0\u4f9b\u8005\uff08\u9a45\u52d5\uff09\u7684\u80fd\u529b\u4e0d\u540c\uff0c\u6bcf\u500b PV \u5377\u7684\u8a2a\u554f\u6a21\u5f0f\u90fd\u6703\u8a2d\u7f6e\u70ba\u5c0d\u61c9\u5377\u6240\u652f\u6301\u7684\u6a21\u5f0f\u503c\u3002\u4f8b\u5982\uff0cNFS \u53ef\u4ee5\u652f\u6301\u591a\u500b\u8b80\u5beb\u5ba2\u6236\uff0c\u4f46\u662f\u67d0\u500b\u7279\u5b9a\u7684 NFS PV \u5377\u53ef\u80fd\u5728\u670d\u52d9\u5668\u4e0a\u4ee5\u53ea\u8b80\u7684\u65b9\u5f0f\u5c0e\u51fa\u3002\u6bcf\u500b PV \u5377\u90fd\u6703\u7372\u5f97\u81ea\u8eab\u7684\u8a2a\u554f\u6a21\u5f0f\u96c6\u5408\uff0c\u63cf\u8ff0\u7684\u662f\u7279\u5b9a PV \u5377\u7684\u80fd\u529b\u3002 \u8a2a\u554f\u6a21\u5f0f\u6709\u4e0b\u5217\u56db\u7a2e\uff1a \u8a2a\u554f\u6a21\u5f0f \u8aaa\u660e ReadWriteOnce \u5377\u53ef\u4ee5\u88ab\u4e00\u500b\u7bc0\u9ede\u4ee5\u8b80\u5beb\u65b9\u5f0f\u639b\u8f09\u3002 ReadWriteOnce \u8a2a\u554f\u6a21\u5f0f\u4e5f\u5141\u8a31\u904b\u884c\u5728\u540c\u4e00\u7bc0\u9ede\u4e0a\u7684\u591a\u500b Pod \u8a2a\u554f\u5377\u3002 ReadOnlyMany \u5377\u53ef\u4ee5\u88ab\u591a\u500b\u7bc0\u9ede\u4ee5\u53ea\u8b80\u65b9\u5f0f\u639b\u8f09\u3002 ReadWriteMany \u5377\u53ef\u4ee5\u88ab\u591a\u500b\u7bc0\u9ede\u4ee5\u8b80\u5beb\u65b9\u5f0f\u639b\u8f09\u3002 ReadWriteOncePod \u5377\u53ef\u4ee5\u88ab\u55ae\u500b Pod \u4ee5\u8b80\u5beb\u65b9\u5f0f\u639b\u8f09\u3002\u5982\u679c\u4f60\u60f3\u78ba\u4fdd\u6574\u500b\u96c6\u7fa4\u4e2d\u53ea\u6709\u4e00\u500b Pod \u53ef\u4ee5\u8b80\u53d6\u6216\u5beb\u5165\u8a72 PVC\uff0c \u8acb\u4f7f\u7528 ReadWriteOncePod \u8a2a\u554f\u6a21\u5f0f\u3002\u9019\u53ea\u652f\u6301 CSI \u5377\u4ee5\u53ca\u9700\u8981 Kubernetes 1.22 \u4ee5\u4e0a\u7248\u672c\u3002 \u5728\u547d\u4ee4\u884c\u63a5\u53e3\uff08CLI\uff09\u4e2d\uff0c\u8a2a\u554f\u6a21\u5f0f\u4e5f\u4f7f\u7528\u4ee5\u4e0b\u7e2e\u5beb\u5f62\u5f0f\uff1a RWO - ReadWriteOnce ROX - ReadOnlyMany RWX - ReadWriteMany RWOP - ReadWriteOncePod \u4e0b\u8868\u662f\u4e00\u4e9b\u5e38\u7528\u7684 Volume \u63d2\u4ef6\u652f\u6301\u7684\u8a2a\u554f\u6a21\u5f0f\uff1a Volume \u63d2\u4ef6 ReadWriteOnce ReadOnlyMany ReadWriteMany ReadWriteOncePod AWSElasticBlockStore \u2713 - - - AzureFile \u2713 \u2713 \u2713 - AzureDisk \u2713 - - - CephFS \u2713 \u2713 \u2713 - Cinder \u2713 - (if multi-attach volumes are available) - CSI depends on the driver depends on the driver depends on the driver depends on the driver FC \u2713 \u2713 - - FlexVolume \u2713 \u2713 depends on the driver - Flocker \u2713 - - - GCEPersistentDisk \u2713 \u2713 - - Glusterfs \u2713 \u2713 \u2713 - HostPath \u2713 - - - iSCSI \u2713 \u2713 - - Quobyte \u2713 \u2713 \u2713 - NFS \u2713 \u2713 \u2713 - RBD \u2713 \u2713 - - VsphereVolume \u2713 - - (works when Pods are collocated) - PortworxVolume \u2713 - \u2713 - StorageOS \u2713 - - -","title":"PV \u8a2a\u554f\u6a21\u5f0f"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#reclaiming","text":"\u76ee\u524d\u7684\u56de\u6536\u7b56\u7565\u6709\uff1a Retain -- \u624b\u52d5\u56de\u6536 Recycle -- \u57fa\u672c\u64e6\u9664 (rm -rf /thevolume/*) Delete -- \u8af8\u5982 AWS EBS\u3001GCE PD\u3001Azure Disk \u6216 OpenStack Cinder \u5377\u9019\u985e\u95dc\u806f\u5b58\u5132\u8cc7\u7522\u4e5f\u88ab\u522a\u9664 \u76ee\u524d\uff0c\u50c5 NFS \u548c HostPath \u652f\u6301\u56de\u6536\uff08Recycle\uff09\u3002 AWS EBS\u3001GCE PD\u3001Azure Disk \u548c Cinder \u5377\u90fd\u652f\u6301\u522a\u9664\uff08Delete\uff09\u3002","title":"\u56de\u6536\u7b56\u7565 Reclaiming"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#_4","text":"\u5377\u53ef\u4ee5\u8655\u65bc\u4ee5\u4e0b\u7684\u67d0\u7a2e\u72c0\u614b\uff1a Available \uff08\u53ef\u7528\uff09\uff1a\u4e00\u584a\u7a7a\u9592\u8cc7\u6e90\u9084\u6c92\u6709\u88ab\u4efb\u4f55\u8072\u660e\u7d81\u5b9a Bound \uff08\u5df2\u7d81\u5b9a\uff09\uff1a\u5377\u5df2\u7d93\u88ab\u8072\u660e\u7d81\u5b9a Released \uff08\u5df2\u91cb\u653e\uff09\uff1a\u8072\u660e\u88ab\u522a\u9664\uff0c\u4f46\u662f\u8cc7\u6e90\u9084\u672a\u88ab\u96c6\u7fa4\u91cd\u65b0\u8072\u660e Failed \uff08\u5931\u6557\uff09\uff1a\u8a72\u5377\u7684\u81ea\u52d5\u56de\u6536\u5931\u6557 \u547d\u4ee4\u884c\u6703\u986f\u793a\u7d81\u5b9a\u5230 PV \u7684 PVC \u7684\u540d\u7a31","title":"\u72c0\u614b"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#_5","text":"kubernetes \u63d0\u4f9b\u7684 hostPath \u7d66\u6301\u4e45\u5316\u63d0\u4f9b\u4e86\u76f8\u7576\u5927\u7684\u4fbf\u5229, \u4f46\u6709\u4e00\u500b\u554f\u984c\u662f, \u6bcf\u6b21\u90fd\u9700\u8981\u624b\u52d5\u63d0\u524d\u5728\u6a5f\u5668\u4e0a\u5275\u5efa\u76f8\u61c9\u7684\u76ee\u9304\u4f86\u505a\u70ba\u88ab\u8abf\u5ea6\u61c9\u7528\u7684\u6301\u4e45\u5316\u76ee\u9304, \u4e0d\u662f\u5f88\u65b9\u4fbf, \u6709\u6c92\u6709\u8fa6\u6cd5\u53ef\u4ee5\u81ea\u52d5\u5275\u5efa\u5462? \u5c0d\u65bc K3D\uff0crancher \u4e5f\u63d0\u4f9b\u4e86\u76f8\u61c9\u7684\u5de5\u5177 local-path-provisioner \u3002\u5728\u5176\u5b83\u4e0d\u540c\u7684 K8S \u74b0\u5883\u4e2d, \u6703\u56e0\u61c9\u4e0d\u540c\u7684 Volume Driver \u7684\u8a2d\u7f6e\u800c\u6703\u6709\u4e0d\u540c\u7684 Storage Class \u7684\u914d\u7f6e\u3002 \u6aa2\u67e5\u96c6\u7fa4\u7684Storage Class\u5c0d\u8c61: $ kubectl get storageclass NAME PROVISIONER RECLAIMPOLICY VOLUMEBINDINGMODE ALLOWVOLUMEEXPANSION AGE local-path ( default ) rancher.io/local-path Delete WaitForFirstConsumer false 3h22m","title":"\u5be6\u4f8b\u6f14\u793a"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#1-pvc","text":"volume-pvc.yaml apiVersion : v1 kind : PersistentVolumeClaim metadata : name : local-path-pvc spec : accessModes : - ReadWriteOnce storageClassName : local-path resources : requests : storage : 128Mi \u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u57f7\u884c\u8207\u6aa2\u8996\u7d50\u679c: $ kubectl apply -f volume-pvc.yaml persistentvolumeclaim/local-path-pvc created $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Pending local-path 13s \u6b64\u6642 PVC \u7684\u72c0\u614b\u662f: Pending","title":"1. \u5275\u5efa PVC"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#2-pod-pvc","text":"volume-pod-pvc.yaml apiVersion : v1 kind : Pod metadata : name : test-pod3 spec : containers : - name : volume-test image : nginx:stable-alpine imagePullPolicy : IfNotPresent volumeMounts : - name : volv mountPath : /data ports : - containerPort : 80 volumes : - name : volv persistentVolumeClaim : claimName : local-path-pvc \u4f7f\u7528 kubectl \u547d\u4ee4\u4f86\u57f7\u884c\u8207\u6aa2\u8996\u7d50\u679c: $ kubectl apply -f volume-pod-pvc.yaml pod/test-pod3 created $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Bound pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO local-path 3m57s $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO Delete Bound default/local-path-pvc local-path 40s $ kubectl get pod/test-pod3 NAME READY STATUS RESTARTS AGE test-pod3 1 /1 Running 0 90s","title":"2. \u5275\u5efa Pod \u4f86\u639b\u8f09 PVC"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#3-pod-pvc-datatest","text":"$ kubectl exec pod/test-pod3 -- sh -c \"echo local-path-test > /data/test\"","title":"3. \u5728 pod \u4e2d\u5beb\u4e00\u4e9b\u6771\u897f\u5230\u639b\u8f09PVC\u7684\u76ee\u9304 /data/test"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#4-pod","text":"$ kubectl delete pod/test-pod3 pod \"test-pod3\" deleted","title":"4. \u522a\u9664 pod"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#5-pod-pod","text":"$ kubectl apply -f volume-pod-pvc.yaml pod/test-pod3 created","title":"5. \u78ba\u8a8d pod \u6d88\u5931\u5f8c\uff0c\u91cd\u65b0\u5275\u5efa pod"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#6","text":"$ kubectl exec pod/test-pod3 -- sh -c \"cat /data/test\" local-path-test","title":"6. \u6aa2\u67e5\u5377\u5167\u5bb9"},{"location":"kubernetes/04-tutorials/volume/volume-pv-pvc/#7-pod-pvc","text":"$ kubectl delete -f volume-pod-pvc.yaml pod \"test-pod3\" deleted $ kubectl get pv NAME CAPACITY ACCESS MODES RECLAIM POLICY STATUS CLAIM STORAGECLASS REASON AGE pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO Delete Bound default/local-path-pvc local-path 10m $ kubectl get pvc NAME STATUS VOLUME CAPACITY ACCESS MODES STORAGECLASS AGE local-path-pvc Bound pvc-b2b26c21-1818-4d5d-a646-b32f8439652a 128Mi RWO local-path 14m $ kubectl delete -f volume-pvc.yaml persistentvolumeclaim \"local-path-pvc\" deleted","title":"7. \u522a\u9664 pod \u548c pvc"},{"location":"kubernetes/05-reference/access-authn-authz/k82-api-call-inside-the-cluster/","text":"The Kubernetes API call inside the cluster \u00b6 \u539f\u6587: https://medium.com/@pczarkowski/the-kubernetes-api-call-is-coming-from-inside-the-cluster-f1a115bd2066 \u6709\u6642\u5f9e Pod \u5167\u90e8\u8a2a\u554f Kubernetes API \u5f88\u6709\u7528\u3002 Kubernetes \u8a66\u5716\u901a\u904e\u70ba\u6bcf\u500b pod \u639b\u8f09\u4e00\u500b serviceaccount secret \u4f86\u7c21\u5316\u6b64\u64cd\u4f5c\u3002 \u70ba\u4e86\u63a2\u7d22\u9019\u4e00\u9ede\uff0c\u6211\u4f7f\u7528 minikube \u5275\u5efa\u4e86\u4e00\u500b Kubernetes \u96c6\u7fa4\u4e26\u555f\u52d5\u4e86\u4e00\u500b\u4ea4\u4e92\u5f0f alpine Linux pod\uff1a $ minikube start $ kubectl run -i --tty alpine --image = alpine --restart = Never -- sh / # \u60a8\u6703\u5728\u8def\u5f91\u4e2d\u627e\u5230\u5e7e\u500b\u6587\u4ef6 /var/run/secrets/kubernetes.io/serviceaccount \u53ef\u7528\u65bc\u5c0d Kubernetes API \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff08\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3001ca \u8b49\u66f8\u548c\u547d\u540d\u7a7a\u9593\uff09\uff1a $ ls /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token $ cat /var/run/secrets/kubernetes.io/serviceaccount/token eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZ... ... l25cDJo2xgnz02W-FVznBJ46A/ \u7136\u800c\uff0c\u9019\u4e9b\u6587\u4ef6\u90fd\u6c92\u6709\u63d0\u4f9b Kubernetes API \u7684 URL\uff0c\u5e78\u597d\u9019\u53ef\u4ee5\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u7372\u5f97\uff1a $ env | grep KUBE KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 \u7d50\u5408\u4f7f\u7528\u9019\u4e9b\uff0c\u60a8\u5c07\u80fd\u5920\u9a57\u8b49\u548c\u8a2a\u554f Kubernetes API\u3002\u4e0d\u5e78\u7684\u662f\uff0calpine \u9644\u5e36\u7684 wget \u7121\u6cd5\u8a2a\u554f TLS \u7aef\u9ede\uff0c\u56e0\u6b64\u60a8\u9700\u8981\u5148\u5b89\u88dd curl \u6216\u985e\u4f3c\u7684\u6771\u897f\u624d\u80fd\u8a2a\u554f\u5b83\uff1a $ apk update fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz v3.16.0-242-ge8a8292729 [ https://dl-cdn.alpinelinux.org/alpine/v3.16/main ] v3.16.0-240-g6e6a2bc8ec [ https://dl-cdn.alpinelinux.org/alpine/v3.16/community ] OK: 17029 distinct packages available $ apk add curl ( 1 /5 ) Installing ca-certificates ( 20211220 -r0 ) ( 2 /5 ) Installing brotli-libs ( 1 .0.9-r6 ) ( 3 /5 ) Installing nghttp2-libs ( 1 .47.0-r0 ) ( 4 /5 ) Installing libcurl ( 7 .83.1-r2 ) ( 5 /5 ) Installing curl ( 7 .83.1-r2 ) Executing busybox-1.35.0-r13.trigger Executing ca-certificates-20211220-r0.trigger OK: 8 MiB in 19 packages \u5c07 curl \u5b89\u88dd\u5230\u6211\u5011\u7684 alpine \u5bb9\u5668\u4e2d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u57f7\u884c\u4e00\u4e9b\u975e\u5e38\u57fa\u672c\u7684 API \u64cd\u4f5c\u4f86\u67e5\u627e\u4fe1\u606f\u3002 $ K8S = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) $ CACERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt $ NAMESPACE = $( cat /var/run/secrets/kubernetes.io/serviceaccount/namespace ) $ curl -H \"Authorization: Bearer $TOKEN \" --cacert $CACERT $K8S /healthz kubectl get rolebinding,clusterrolebinding --all-namespaces -o jsonpath='{range .items[?(@.subjects[0].name==\"default\")]}[{.roleRef.kind},{.roleRef.name}]{end}'","title":"The Kubernetes API call inside the cluster"},{"location":"kubernetes/05-reference/access-authn-authz/k82-api-call-inside-the-cluster/#the-kubernetes-api-call-inside-the-cluster","text":"\u539f\u6587: https://medium.com/@pczarkowski/the-kubernetes-api-call-is-coming-from-inside-the-cluster-f1a115bd2066 \u6709\u6642\u5f9e Pod \u5167\u90e8\u8a2a\u554f Kubernetes API \u5f88\u6709\u7528\u3002 Kubernetes \u8a66\u5716\u901a\u904e\u70ba\u6bcf\u500b pod \u639b\u8f09\u4e00\u500b serviceaccount secret \u4f86\u7c21\u5316\u6b64\u64cd\u4f5c\u3002 \u70ba\u4e86\u63a2\u7d22\u9019\u4e00\u9ede\uff0c\u6211\u4f7f\u7528 minikube \u5275\u5efa\u4e86\u4e00\u500b Kubernetes \u96c6\u7fa4\u4e26\u555f\u52d5\u4e86\u4e00\u500b\u4ea4\u4e92\u5f0f alpine Linux pod\uff1a $ minikube start $ kubectl run -i --tty alpine --image = alpine --restart = Never -- sh / # \u60a8\u6703\u5728\u8def\u5f91\u4e2d\u627e\u5230\u5e7e\u500b\u6587\u4ef6 /var/run/secrets/kubernetes.io/serviceaccount \u53ef\u7528\u65bc\u5c0d Kubernetes API \u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff08\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3001ca \u8b49\u66f8\u548c\u547d\u540d\u7a7a\u9593\uff09\uff1a $ ls /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token $ cat /var/run/secrets/kubernetes.io/serviceaccount/token eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZ... ... l25cDJo2xgnz02W-FVznBJ46A/ \u7136\u800c\uff0c\u9019\u4e9b\u6587\u4ef6\u90fd\u6c92\u6709\u63d0\u4f9b Kubernetes API \u7684 URL\uff0c\u5e78\u597d\u9019\u53ef\u4ee5\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u7372\u5f97\uff1a $ env | grep KUBE KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 \u7d50\u5408\u4f7f\u7528\u9019\u4e9b\uff0c\u60a8\u5c07\u80fd\u5920\u9a57\u8b49\u548c\u8a2a\u554f Kubernetes API\u3002\u4e0d\u5e78\u7684\u662f\uff0calpine \u9644\u5e36\u7684 wget \u7121\u6cd5\u8a2a\u554f TLS \u7aef\u9ede\uff0c\u56e0\u6b64\u60a8\u9700\u8981\u5148\u5b89\u88dd curl \u6216\u985e\u4f3c\u7684\u6771\u897f\u624d\u80fd\u8a2a\u554f\u5b83\uff1a $ apk update fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/main/x86_64/APKINDEX.tar.gz fetch https://dl-cdn.alpinelinux.org/alpine/v3.16/community/x86_64/APKINDEX.tar.gz v3.16.0-242-ge8a8292729 [ https://dl-cdn.alpinelinux.org/alpine/v3.16/main ] v3.16.0-240-g6e6a2bc8ec [ https://dl-cdn.alpinelinux.org/alpine/v3.16/community ] OK: 17029 distinct packages available $ apk add curl ( 1 /5 ) Installing ca-certificates ( 20211220 -r0 ) ( 2 /5 ) Installing brotli-libs ( 1 .0.9-r6 ) ( 3 /5 ) Installing nghttp2-libs ( 1 .47.0-r0 ) ( 4 /5 ) Installing libcurl ( 7 .83.1-r2 ) ( 5 /5 ) Installing curl ( 7 .83.1-r2 ) Executing busybox-1.35.0-r13.trigger Executing ca-certificates-20211220-r0.trigger OK: 8 MiB in 19 packages \u5c07 curl \u5b89\u88dd\u5230\u6211\u5011\u7684 alpine \u5bb9\u5668\u4e2d\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u57f7\u884c\u4e00\u4e9b\u975e\u5e38\u57fa\u672c\u7684 API \u64cd\u4f5c\u4f86\u67e5\u627e\u4fe1\u606f\u3002 $ K8S = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) $ CACERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt $ NAMESPACE = $( cat /var/run/secrets/kubernetes.io/serviceaccount/namespace ) $ curl -H \"Authorization: Bearer $TOKEN \" --cacert $CACERT $K8S /healthz kubectl get rolebinding,clusterrolebinding --all-namespaces -o jsonpath='{range .items[?(@.subjects[0].name==\"default\")]}[{.roleRef.kind},{.roleRef.name}]{end}'","title":"The Kubernetes API call inside the cluster"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/","text":"\u5728 kubernetes \u4e2d\u4f7f\u7528 rbac \u8a2d\u7f6e\u670d\u52d9\u5e33\u6236\u6b0a\u9650 \u00b6 \u539f\u6587: https://blog.dudaji.com/kubernetes/2019/05/01/k8s-authorization-of-sa-with-rbac.html \u60f3\u50cf\u4e00\u4e0b\uff0c\u60a8\u7684\u7d44\u7e54\u6b63\u5728\u904b\u884c\u7531\u591a\u500b\u5de5\u7a0b\u5718\u968a\u4f7f\u7528\u7684\u55ae\u500b Kubernetes \u96c6\u7fa4\u3002\u9019\u4e9b\u5718\u968a\u4e2d\u7684\u6bcf\u4e00\u500b\u90fd\u7368\u7acb\u90e8\u7f72\u4e86\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5e8f\u4f86\u958b\u767c\u548c\u6e2c\u8a66\u5b83\u3002\u60a8\u5e0c\u671b\u6bcf\u500b\u5718\u968a\u53ea\u8655\u7406\u4ed6\u5011\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u5957\u4ef6\u5be6\u4f8b\u2014\u2014\u6bcf\u500b\u5718\u968a\u53ea\u60f3\u770b\u5230\u4ed6\u5011\u5275\u5efa\u7684\u5c0d\u8c61\uff0c\u800c\u4e0d\u662f\u5176\u4ed6\u5718\u968a\u5275\u5efa\u7684\u5c0d\u8c61\u3002\u5728\u55ae\u4e00\u500b Kubernetes \u7684\u96c6\u7fa4\u88e1\u53ef\u4f7f\u7528\u547d\u540d\u7a7a\u9593( namespace )\u4f86\u5be6\u73fe\u3002 \u4f7f\u7528\u591a\u500b namespace \u5141\u8a31\u60a8\u5c07\u5177\u6709\u5927\u91cf\u7d44\u4ef6\u7684\u8907\u96dc\u7cfb\u7d71\u5283\u5206\u70ba\u7531\u4e0d\u540c\u5718\u968a\u7ba1\u7406\u7684\u5340\u57df\u3002\u5b83\u5011\u9084\u53ef\u7528\u65bc\u5728 mult-tenant environment \u7684\u60c5\u5883\u4e2d\u4f86\u9032\u884c\u5718\u968a\u7684\u9694\u96e2\u3002 \u5927\u591a\u6578 Kubernetes API \u7269\u4ef6\u985e\u578b\u90fd\u6709\u547d\u540d\u7a7a\u9593\uff0c\u4f46\u4e5f\u6709\u5c11\u6578\u6c92\u6709\u3002 Pod \u3001 ConfigMaps \u3001 Secrets \u3001 PersistentVolumeClaims \u548c Events \u90fd\u662f\u547d\u540d\u7a7a\u9593\u3002 Nodes , PersistentVolumes , StorageClasses , \u548c Namespaces \u672c\u8eab\u5247\u4e0d\u662f\u3002 \u8981\u67e5\u770b \u8cc7\u6e90 \u662f \u547d\u540d\u7a7a\u9593\u9084 \u662f \u96c6\u7fa4\u7bc4\u570d \uff0c\u8acb\u5728\u904b\u884c kubectl api-resources \u6642\u6aa2\u67e5 NAMESPACED \u5217\u3002 $ kubectl api-resources \u5834\u666f \u00b6 admin \uff1a\u64c1\u6709\u6240\u6709\u6b0a\u9650 department-leader \uff1a\u5c0d\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u64c1\u6709\u6b0a\u9650 team-a-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650\uff0c\u800c\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650 team-b-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650\uff0c\u5c0d\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650 \u5982\u4f55\u4f7f\u7528 Kubernetes \u9032\u884c\u8eab\u4efd\u9a57\u8b49 \u00b6 Kubernetes\u4e2d\u6709\u591a\u7a2e\u8a8d\u8b49\u65b9\u5f0f\uff0c\u5982token\u3001proxy\u3001webhook\u3001ID/PW\u3001OAuth2\u7b49\u3002\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\u53ef\u5728\u6b64\u8655\u7372\u5f97\u3002\u9664\u4e86\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u8eab\u4efd\u9a57\u8b49\u4e4b\u5916\uff0cKubernetes \u5efa\u8b70\u4f7f\u7528\u4e00\u7a2e\u6216\u591a\u7a2e\u7528\u6236\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u901a\u904e\u670d\u52d9\u5e33\u6236\uff08 Service account \uff09\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f86\u6e2c\u8a66 kubernetes api \u8abf\u7528\u3002 \u5275\u5efa\u547d\u540d\u7a7a\u9593 \u00b6 ns-team-a-create.yaml # ns-team-a-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-a ns-team-b-create.yaml # ns-team-b-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-b \u5275\u5efa namespace: $ kubectl create -f ns-team-a-create.yaml $ kubectl create -f ns-team-b-create.yaml \u6aa2\u67e5 namespace: $ kubectl get ns NAME STATUS AGE default Active 6m14s kube-node-lease Active 6m16s kube-public Active 6m16s kube-system Active 6m16s team-a Active 8s team-b Active 4s \u5275\u5efa\u670d\u52d9\u5e33\u6236 \u00b6 sa-team-a-create.yaml # sa-team-a-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-a namespace : team-a sa-team-b-create.yaml # sa-team-b-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-b namespace : team-b \u5275\u5efa service account: $ kubectl create -f sa-team-a-create.yaml $ kubectl create -f sa-team-b-create.yaml \u6aa2\u67e5\u5728\u4e0d\u540c namespace \u88e1\u7684 service account: $ kubectl get sa -n team-a NAME SECRETS AGE default 1 5m47s sa-team-a 1 22s $ kubectl get sa -n team-b NAME SECRETS AGE default 1 5m46s sa-team-b 1 17s \u89d2\u8272\u548c\u89d2\u8272\u7d81\u5b9a \u00b6 \u89d2\u8272\u5b9a\u7fa9\u4e86\u6709\u95dc\u6b0a\u9650\u7684\u4e8b\u60c5\u3002\u5b83\u5b9a\u7fa9\u4e86\u53ef\u4ee5\u8a2a\u554f\u7684\u4f4d\u7f6e\u4ee5\u53ca\u53ef\u4ee5\u5c0d\u54ea\u4e9b\u8cc7\u6e90\u9032\u884c\u54ea\u4e9b\u64cd\u4f5c\u3002 RoleBinding \u662f\u9023\u63a5 Role \u548c User \u7684\u6a4b\u6a11\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u7528\u6236\u88ab\u6388\u4e88\u6b0a\u9650\uff0c\u4f46\u662f\u95dc\u65bc\u6b0a\u9650\u7684\u4fe1\u606f\u662f\u7531**\u89d2\u8272**\u6c7a\u5b9a\u7684\u3002 \u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u89d2\u8272\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u9810\u5b9a\u7fa9\u7684\u89d2\u8272\u4f86\u7d66\u4e88\u6b0a\u9650\u3002 ClusterRole \u4e2d\u9810\u5b9a\u7fa9\u7684\u6b0a\u9650\u662f cluster-admin \u3001 admin \u3001 edit \u548c view \uff0c\u6839\u64da\u7d81\u5b9a\u7684\u985e\u578b\uff08 Rolebinding \u3001 ClusterRolebinding \uff09\u4f86\u78ba\u5b9a\u6b0a\u9650\u8a2a\u554f\u7bc4\u570d\u662f\u547d\u540d\u7a7a\u9593\u9084\u662f\u6574\u500b\u96c6\u7fa4\u3002 \u4f86\u6e90\uff1ahttps ://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles \u8b93\u6211\u5011\u4f86\u5275\u5efa\u4e00\u500b\u5ba2\u5236\u7684\u89d2\u8272: custom-role-binding.yaml kind : Role apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-role namespace : team-a rules : - apiGroups : [ \"\" ] # \"\" indicates the core API group resources : [ \"pods\" ] verbs : [ \"get\" , \"watch\" , \"list\" ] --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-rolebinding namespace : team-a subjects : - kind : ServiceAccount name : sa-team-a namespace : team-a roleRef : kind : Role name : custom-role apiGroup : rbac.authorization.k8s.io \u69cb\u5efa\u89d2\u8272\u8207\u6b0a\u9650\u4e26\u4e14\u9032\u884c\u7d81\u5b9a: $ kubectl create -f custom-role-binding.yaml role.rbac.authorization.k8s.io/custom-role created rolebinding.rbac.authorization.k8s.io/custom-rolebinding created \u4f7f\u7528\u5167\u5efa\u7684\u89d2\u8272\uff1a default-role-binding.yaml # default-role-binding.yaml kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : default-rolebinding namespace : team-b subjects : - kind : ServiceAccount name : sa-team-b namespace : team-b roleRef : kind : ClusterRole name : view apiGroup : rbac.authorization.k8s.io \u5c07\u6e05\u55ae\u61c9\u7528\u65bc Kubernetes $ kubectl create -f default-role-binding.yaml rolebinding.rbac.authorization.k8s.io/default-rolebinding created \u5275\u5efa\u4e00\u500b Pod \u00b6 pod-team-a-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-a namespace : team-a spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 pod-team-b-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-b namespace : team-b spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 \u5206\u5225\u5728\u5169\u500b namespace \u5404\u5275\u5efa\u4e00\u500b pod: $ kubectl create -f pod-team-a-create.yaml pod/pod-team-a created $ kubectl create -f pod-team-b-create.yaml pod/pod-team-b created API \u6e2c\u8a66 \u00b6 api\u670d\u52d9\u5668ip\u6aa2\u67e5 $ kubectl config view | grep server | cut -f 2 - -d \":\" | tr -d \" \" # display list of your api server https://192.168.49.2:8443 \u4e5f\u53ef\u7528: $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 ... \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578: APISERVER = <your-k8s-api-server> APISERVER = https://192.168.49.2:8443 \u6aa2\u67e5 sa-team-a \u7684\u4ee4\u724c: NAMESPACE = team-a SA = sa-team-a TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u6aa2\u67e5 sa-team-b \u7684\u4ee4\u724c: NAMESPACE = team-b SA = sa-team-b TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u5982\u679c system account \u60f3\u8981\u53bb\u8a2a\u554f\u6c92\u6709\u6b0a\u9650\u7684\u7684 namespace , \u8209\u4f8b: sa-team-b \u8a2a\u554f team-a \u3002 $ SA = sa-team-b $ NAMESPACE = team-b $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:team-b:sa-team-b\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"team-a\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 } department-leader \u548c admin \u00b6 \u5275\u5efa department-leader \u00b6 department-leader \u6709\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u7684\u6b0a\u9650\uff0c\u800c\u5c0d\u65bc admin \uff0c\u5247\u64c1\u6709\u6240\u6709\u5340\u57df\u7684\u6b0a\u9650\u3002 sa-leader.yaml # sa-leader.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-leader --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-a namespace : team-b subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-b namespace : team-a subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f sa-leader.yaml serviceaccount/sa-leader created rolebinding.rbac.authorization.k8s.io/department-leader-team-a created rolebinding.rbac.authorization.k8s.io/department-leader-team-b created $ SA = sa-leader $ NAMESPACE = default $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure $ NAMESPACE = team-b $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u5275\u5efa admin \u00b6 sa-admin-create.yaml # sa-admin-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-admin --- kind : ClusterRoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : admin-all-cluster subjects : - kind : ServiceAccount name : sa-admin namespace : default roleRef : kind : ClusterRole name : cluster-admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f a-admin-create.yaml serviceaccount/sa-admin created clusterrolebinding.rbac.authorization.k8s.io/admin-all-cluster created","title":"\u4f7f\u7528 RBAC \u8a2d\u7f6e\u670d\u52d9\u5e33\u6236\u6b0a\u9650"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#kubernetes-rbac","text":"\u539f\u6587: https://blog.dudaji.com/kubernetes/2019/05/01/k8s-authorization-of-sa-with-rbac.html \u60f3\u50cf\u4e00\u4e0b\uff0c\u60a8\u7684\u7d44\u7e54\u6b63\u5728\u904b\u884c\u7531\u591a\u500b\u5de5\u7a0b\u5718\u968a\u4f7f\u7528\u7684\u55ae\u500b Kubernetes \u96c6\u7fa4\u3002\u9019\u4e9b\u5718\u968a\u4e2d\u7684\u6bcf\u4e00\u500b\u90fd\u7368\u7acb\u90e8\u7f72\u4e86\u76f8\u95dc\u7684\u61c9\u7528\u7a0b\u5e8f\u4f86\u958b\u767c\u548c\u6e2c\u8a66\u5b83\u3002\u60a8\u5e0c\u671b\u6bcf\u500b\u5718\u968a\u53ea\u8655\u7406\u4ed6\u5011\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u5957\u4ef6\u5be6\u4f8b\u2014\u2014\u6bcf\u500b\u5718\u968a\u53ea\u60f3\u770b\u5230\u4ed6\u5011\u5275\u5efa\u7684\u5c0d\u8c61\uff0c\u800c\u4e0d\u662f\u5176\u4ed6\u5718\u968a\u5275\u5efa\u7684\u5c0d\u8c61\u3002\u5728\u55ae\u4e00\u500b Kubernetes \u7684\u96c6\u7fa4\u88e1\u53ef\u4f7f\u7528\u547d\u540d\u7a7a\u9593( namespace )\u4f86\u5be6\u73fe\u3002 \u4f7f\u7528\u591a\u500b namespace \u5141\u8a31\u60a8\u5c07\u5177\u6709\u5927\u91cf\u7d44\u4ef6\u7684\u8907\u96dc\u7cfb\u7d71\u5283\u5206\u70ba\u7531\u4e0d\u540c\u5718\u968a\u7ba1\u7406\u7684\u5340\u57df\u3002\u5b83\u5011\u9084\u53ef\u7528\u65bc\u5728 mult-tenant environment \u7684\u60c5\u5883\u4e2d\u4f86\u9032\u884c\u5718\u968a\u7684\u9694\u96e2\u3002 \u5927\u591a\u6578 Kubernetes API \u7269\u4ef6\u985e\u578b\u90fd\u6709\u547d\u540d\u7a7a\u9593\uff0c\u4f46\u4e5f\u6709\u5c11\u6578\u6c92\u6709\u3002 Pod \u3001 ConfigMaps \u3001 Secrets \u3001 PersistentVolumeClaims \u548c Events \u90fd\u662f\u547d\u540d\u7a7a\u9593\u3002 Nodes , PersistentVolumes , StorageClasses , \u548c Namespaces \u672c\u8eab\u5247\u4e0d\u662f\u3002 \u8981\u67e5\u770b \u8cc7\u6e90 \u662f \u547d\u540d\u7a7a\u9593\u9084 \u662f \u96c6\u7fa4\u7bc4\u570d \uff0c\u8acb\u5728\u904b\u884c kubectl api-resources \u6642\u6aa2\u67e5 NAMESPACED \u5217\u3002 $ kubectl api-resources","title":"\u5728 kubernetes \u4e2d\u4f7f\u7528 rbac \u8a2d\u7f6e\u670d\u52d9\u5e33\u6236\u6b0a\u9650"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#_1","text":"admin \uff1a\u64c1\u6709\u6240\u6709\u6b0a\u9650 department-leader \uff1a\u5c0d\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u64c1\u6709\u6b0a\u9650 team-a-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650\uff0c\u800c\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650 team-b-user : \u64c1\u6709\u547d\u540d\u7a7a\u9593 team-b \u7684\u6b0a\u9650\uff0c\u5c0d\u6c92\u6709\u547d\u540d\u7a7a\u9593 team-a \u7684\u6b0a\u9650","title":"\u5834\u666f"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#kubernetes","text":"Kubernetes\u4e2d\u6709\u591a\u7a2e\u8a8d\u8b49\u65b9\u5f0f\uff0c\u5982token\u3001proxy\u3001webhook\u3001ID/PW\u3001OAuth2\u7b49\u3002\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\u53ef\u5728\u6b64\u8655\u7372\u5f97\u3002\u9664\u4e86\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u8eab\u4efd\u9a57\u8b49\u4e4b\u5916\uff0cKubernetes \u5efa\u8b70\u4f7f\u7528\u4e00\u7a2e\u6216\u591a\u7a2e\u7528\u6236\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u901a\u904e\u670d\u52d9\u5e33\u6236\uff08 Service account \uff09\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f86\u6e2c\u8a66 kubernetes api \u8abf\u7528\u3002","title":"\u5982\u4f55\u4f7f\u7528 Kubernetes \u9032\u884c\u8eab\u4efd\u9a57\u8b49"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#_2","text":"ns-team-a-create.yaml # ns-team-a-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-a ns-team-b-create.yaml # ns-team-b-create.yaml apiVersion : v1 kind : Namespace metadata : name : team-b \u5275\u5efa namespace: $ kubectl create -f ns-team-a-create.yaml $ kubectl create -f ns-team-b-create.yaml \u6aa2\u67e5 namespace: $ kubectl get ns NAME STATUS AGE default Active 6m14s kube-node-lease Active 6m16s kube-public Active 6m16s kube-system Active 6m16s team-a Active 8s team-b Active 4s","title":"\u5275\u5efa\u547d\u540d\u7a7a\u9593"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#_3","text":"sa-team-a-create.yaml # sa-team-a-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-a namespace : team-a sa-team-b-create.yaml # sa-team-b-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-team-b namespace : team-b \u5275\u5efa service account: $ kubectl create -f sa-team-a-create.yaml $ kubectl create -f sa-team-b-create.yaml \u6aa2\u67e5\u5728\u4e0d\u540c namespace \u88e1\u7684 service account: $ kubectl get sa -n team-a NAME SECRETS AGE default 1 5m47s sa-team-a 1 22s $ kubectl get sa -n team-b NAME SECRETS AGE default 1 5m46s sa-team-b 1 17s","title":"\u5275\u5efa\u670d\u52d9\u5e33\u6236"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#_4","text":"\u89d2\u8272\u5b9a\u7fa9\u4e86\u6709\u95dc\u6b0a\u9650\u7684\u4e8b\u60c5\u3002\u5b83\u5b9a\u7fa9\u4e86\u53ef\u4ee5\u8a2a\u554f\u7684\u4f4d\u7f6e\u4ee5\u53ca\u53ef\u4ee5\u5c0d\u54ea\u4e9b\u8cc7\u6e90\u9032\u884c\u54ea\u4e9b\u64cd\u4f5c\u3002 RoleBinding \u662f\u9023\u63a5 Role \u548c User \u7684\u6a4b\u6a11\u3002\u63db\u53e5\u8a71\u8aaa\uff0c\u7528\u6236\u88ab\u6388\u4e88\u6b0a\u9650\uff0c\u4f46\u662f\u95dc\u65bc\u6b0a\u9650\u7684\u4fe1\u606f\u662f\u7531**\u89d2\u8272**\u6c7a\u5b9a\u7684\u3002 \u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684\u89d2\u8272\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u9810\u5b9a\u7fa9\u7684\u89d2\u8272\u4f86\u7d66\u4e88\u6b0a\u9650\u3002 ClusterRole \u4e2d\u9810\u5b9a\u7fa9\u7684\u6b0a\u9650\u662f cluster-admin \u3001 admin \u3001 edit \u548c view \uff0c\u6839\u64da\u7d81\u5b9a\u7684\u985e\u578b\uff08 Rolebinding \u3001 ClusterRolebinding \uff09\u4f86\u78ba\u5b9a\u6b0a\u9650\u8a2a\u554f\u7bc4\u570d\u662f\u547d\u540d\u7a7a\u9593\u9084\u662f\u6574\u500b\u96c6\u7fa4\u3002 \u4f86\u6e90\uff1ahttps ://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles \u8b93\u6211\u5011\u4f86\u5275\u5efa\u4e00\u500b\u5ba2\u5236\u7684\u89d2\u8272: custom-role-binding.yaml kind : Role apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-role namespace : team-a rules : - apiGroups : [ \"\" ] # \"\" indicates the core API group resources : [ \"pods\" ] verbs : [ \"get\" , \"watch\" , \"list\" ] --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : custom-rolebinding namespace : team-a subjects : - kind : ServiceAccount name : sa-team-a namespace : team-a roleRef : kind : Role name : custom-role apiGroup : rbac.authorization.k8s.io \u69cb\u5efa\u89d2\u8272\u8207\u6b0a\u9650\u4e26\u4e14\u9032\u884c\u7d81\u5b9a: $ kubectl create -f custom-role-binding.yaml role.rbac.authorization.k8s.io/custom-role created rolebinding.rbac.authorization.k8s.io/custom-rolebinding created \u4f7f\u7528\u5167\u5efa\u7684\u89d2\u8272\uff1a default-role-binding.yaml # default-role-binding.yaml kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : default-rolebinding namespace : team-b subjects : - kind : ServiceAccount name : sa-team-b namespace : team-b roleRef : kind : ClusterRole name : view apiGroup : rbac.authorization.k8s.io \u5c07\u6e05\u55ae\u61c9\u7528\u65bc Kubernetes $ kubectl create -f default-role-binding.yaml rolebinding.rbac.authorization.k8s.io/default-rolebinding created","title":"\u89d2\u8272\u548c\u89d2\u8272\u7d81\u5b9a"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#pod","text":"pod-team-a-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-a namespace : team-a spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 pod-team-b-create.yaml apiVersion : v1 kind : Pod metadata : name : pod-team-b namespace : team-b spec : containers : - name : nginx image : nginx:1.7.9 ports : - containerPort : 8080 \u5206\u5225\u5728\u5169\u500b namespace \u5404\u5275\u5efa\u4e00\u500b pod: $ kubectl create -f pod-team-a-create.yaml pod/pod-team-a created $ kubectl create -f pod-team-b-create.yaml pod/pod-team-b created","title":"\u5275\u5efa\u4e00\u500b Pod"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#api","text":"api\u670d\u52d9\u5668ip\u6aa2\u67e5 $ kubectl config view | grep server | cut -f 2 - -d \":\" | tr -d \" \" # display list of your api server https://192.168.49.2:8443 \u4e5f\u53ef\u7528: $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 ... \u8a2d\u5b9a\u74b0\u5883\u8b8a\u6578: APISERVER = <your-k8s-api-server> APISERVER = https://192.168.49.2:8443 \u6aa2\u67e5 sa-team-a \u7684\u4ee4\u724c: NAMESPACE = team-a SA = sa-team-a TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u6aa2\u67e5 sa-team-b \u7684\u4ee4\u724c: NAMESPACE = team-b SA = sa-team-b TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) \u547c\u53eb Kubernetes API: $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure \u5982\u679c system account \u60f3\u8981\u53bb\u8a2a\u554f\u6c92\u6709\u6b0a\u9650\u7684\u7684 namespace , \u8209\u4f8b: sa-team-b \u8a2a\u554f team-a \u3002 $ SA = sa-team-b $ NAMESPACE = team-b $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:team-b:sa-team-b\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"team-a\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 }","title":"API \u6e2c\u8a66"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#department-leader-admin","text":"","title":"department-leader \u548c admin"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#department-leader","text":"department-leader \u6709\u547d\u540d\u7a7a\u9593 team-a \u548c team-b \u7684\u6b0a\u9650\uff0c\u800c\u5c0d\u65bc admin \uff0c\u5247\u64c1\u6709\u6240\u6709\u5340\u57df\u7684\u6b0a\u9650\u3002 sa-leader.yaml # sa-leader.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-leader --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-a namespace : team-b subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io --- kind : RoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : department-leader-team-b namespace : team-a subjects : - kind : ServiceAccount name : sa-leader namespace : default roleRef : kind : ClusterRole name : admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f sa-leader.yaml serviceaccount/sa-leader created rolebinding.rbac.authorization.k8s.io/department-leader-team-a created rolebinding.rbac.authorization.k8s.io/department-leader-team-b created $ SA = sa-leader $ NAMESPACE = default $ TOKEN = $( kubectl -n $NAMESPACE describe secret $( kubectl get -n $NAMESPACE secrets | grep $SA | cut -f1 -d ' ' ) | grep -E '^token' | cut -f2 -d ':' | tr -d ' ' ) $ NAMESPACE = team-a $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure $ NAMESPACE = team-b $ curl -X GET $APISERVER /api/v1/namespaces/ $NAMESPACE /pods/ \\ -H \"Authorization: Bearer $TOKEN \" --insecure","title":"\u5275\u5efa department-leader"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-authorization-of-sa-with-rbac/#admin","text":"sa-admin-create.yaml # sa-admin-create.yaml apiVersion : v1 kind : ServiceAccount metadata : name : sa-admin --- kind : ClusterRoleBinding apiVersion : rbac.authorization.k8s.io/v1 metadata : name : admin-all-cluster subjects : - kind : ServiceAccount name : sa-admin namespace : default roleRef : kind : ClusterRole name : cluster-admin apiGroup : rbac.authorization.k8s.io $ kubectl create -f a-admin-create.yaml serviceaccount/sa-admin created clusterrolebinding.rbac.authorization.k8s.io/admin-all-cluster created","title":"\u5275\u5efa admin"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-sa-jwt-rbac/","text":"ServiceAccounts\u3001JWT-tokens\u3001\u8eab\u4efd\u9a57\u8b49\u548c RBAC \u6388\u6b0a \u00b6 \u539f\u6587: https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/ \u5c0d\u65bc\u8a8d\u8b49\u548c\u6388\u6b0a\uff0cKubernetes \u6709 User Accounts \u548c Service Accounts \u7b49\u6982\u5ff5\u3002 User Accounts \u7528\u65bc\u5f9e\u5916\u90e8\u8a2a\u554f\u96c6\u7fa4\u7684\u5e38\u7528\u7528\u6236\u914d\u7f6e\u6587\u4ef6\uff0c\u800c Service Accounts \u7528\u65bc\u5f9e\u96c6\u7fa4\u5167\u90e8\u6388\u4e88\u8a2a\u554f\u6b0a\u9650\u3002 ServiceAccounts \u65e8\u5728\u70ba Kubernetes Pod \u63d0\u4f9b\u4e00\u500b\u8eab\u4efd\uff0c\u4ee5\u4f9b\u5176\u5bb9\u5668\u5728\u5411 Kubernetes API \u670d\u52d9\u5668\u57f7\u884c API \u8acb\u6c42\u6642\u5c0d\u5176\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u3002 \u9810\u8a2d\u7684 ServiceAccount \u00b6 \u6bcf\u500b Kubernetes \u547d\u540d\u7a7a\u9593\u90fd\u6709\u81ea\u5df1\u7684\u9ed8\u8a8d ServiceAccount (SA)\uff0c\u5b83\u662f\u5728\u5275\u5efa\u547d\u540d\u7a7a\u9593\u6642\u5275\u5efa\u7684\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u547d\u540d\u7a7a\u9593\uff1a @ kubectl --namespace default get serviceaccount NAME SECRETS AGE default 1 44h \u5c0d\u65bc\u6bcf\u500b ServiceAccount\uff0c\u90fd\u6703\u751f\u6210\u4e00\u500b token \u4e26\u5c07\u5176\u5b58\u5132\u70ba Kubernetes Secret\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u7684\u9019\u500b ServiceAccount\uff1a $ kubectl --namespace default get serviceaccount default -o yaml apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-07-14T04:56:34Z\" name: default namespace: default resourceVersion: \"476\" uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 secrets: - name: default-token-tvflf \u5728\u672c\u7bc4\u4f8b\u4e2d SA \u7684\u4ee4\u724c\u5132\u653e\u5728 default-token-tvflf \u7684 Secret \u4e2d\uff1a Warning \u5728 Kubernetes 1.24+ \u4e4b\u5f8c\u7684\u7248\u672c\uff0cK8s \u4e0d\u6703\u518d\u70ba ServiceAccounts \u81ea\u52d5\u751f\u6210 Secret\u3002\u898b BIG change in K8s 1.24 about ServiceAccounts and their Secrets \u9810\u8a2d\u7684 token \u00b6 \u73fe\u5728\uff0c\u6aa2\u67e5 Secret \u7684\u5167\u5bb9\uff1a $ kubectl get secret default-token-tvflf -o yaml apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyTlRjM056UTFOell3SGhjTk1qSXdOekUwTURRMU5qRTJXaGNOTXpJd056RXhNRFExTmpFMgpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyTlRjM056UTFOell3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSUkFMTldkL2ZwVGxwWGY1c1BndjVDaTZGUm5hcFBwYWZSb2V2ZTJ3dGYKdjFQYVRueGNERUVUM0FKbDVUdDd4RG9DRlRtMVRyWXRTN2MyTmFLOFd3bk5vMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVWh4OUhPeGJWQ0dRU2NZMC9ZaGxjCnlyQ25YcmN3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQU5DQVRNOElScHNHaWs4R1FuWThGL1BEMFcrQXB6NW8KYzNqRnNXblZSc1B3QWlCdi9UWFQwSGtoZVpCZHJING0rZlUzeDNpU0UvVThqcGFGVEJ1ZUJqWUU0dz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K namespace: ZGVmYXVsdA == token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn kind: Secret metadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 creationTimestamp: \"2022-07-14T04:56:34Z\" name: default-token-tvflf namespace: default resourceVersion: \"474\" uid: 5cf55c44-2c6a-46a9-90ba-137cea5f27b9 type: kubernetes.io/service-account-token type - \u6a19\u793a\u4e86\u9019\u500b Secret \u7684\u985e\u578b\u662f kubernetes.io/service-account-token \u3002 data - \u4fdd\u5b58\u4e86 ca.ert \u8207 token \u7684\u8cc7\u8a0a (base64 encoded) ca.crt \u7531 K8S \u96c6\u7fa4\u7684\u4e3b\u5bc6\u9470\u7c3d\u540d\uff0c\u56e0\u6b64\u96c6\u7fa4\u626e\u6f14\u8457\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7684\u89d2\u8272\uff0c\u4e26\u5141\u8a31 pod \u6216\u61c9\u7528\u7a0b\u5e8f\u9a57\u8b49 API-server\u3002 \u73fe\u5728\uff0c\u8b93\u6211\u5011\u53bb\u7814\u7a76 token \u7684\u90e8\u5206\u3002 JWT token \u5167\u5bb9 \u00b6 \u70ba\u4e86\u66f4\u5bb9\u6613\u5f9e termainal \u5de5\u4f5c - \u5c07 data.token \u503c\u4fdd\u5b58\u5230\u8b8a\u91cf\u4e2d\uff1a $ token = \"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn\" \u4f7f\u7528 base64 \u7372\u53d6\u5176\u5167\u5bb9\uff1a $ echo $token | base64 -d eyJhbGciOiJSUzI1NiIsImtpZCI6Inl3NVZwakRjMEZYU29GQUN2ZERfUmlncERlSlRQclA5OVVpbGxYR090b28ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tdHZmbGYiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNiODFmYjJhLWExNDgtNGEyYS1iNzlmLTg5YzEwMWNlN2MxMiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.ggbx38gAGQR6VsUI2dbGHXqyW2-Pb6V63IEBmQtkh2g-i_qNcx40yF9UY23cltm9recFpMuDE1eRT9LsapVnDtOpgOym2Z8jK9F5vKR6k_F25RojtSuQb8o_oktD2eMIpzcv96n_XCz7LpWVRtP2m0QbVLM7HdhShNdt_q1wWxHj-PbBH9nmyxazgFxa8nHKs7vcRgLPj9TJDM7BH7SEZ9yY8n5KVpnkwv3RPElvSZGKZr-1WCQq444ebqVVqQiLN0clu57a6Oy7kNNtjGlzIXOoJMXZZCIYdDAmAnJCVkxKE_hGLL0OgofG1wYQuLZ9mqTAjW9DCPx71N_U6aKLEg JWT \u7684 token \u5305\u542b\u4e86\u4e09\u90e8\u4efd\u7684\u8cc7\u8a0a: \u6a19\u982d header - \u63cf\u8ff0\u4ee4\u724c\u7684\u7c3d\u540d\u65b9\u5f0f \u6709\u6548\u8ca0\u8f09 payload - \u4ee4\u724c\u7684\u5be6\u969b\u6578\u64da\uff0c\u4f8b\u5982\u5230\u671f\u65e5\u671f\u3001\u9812\u767c\u8005\u7b49\uff0c\u8acb\u53c3\u95b1 RFC-7519 \u7c3d\u540d signature - \u7528\u65bc\u9a57\u8b49\u4ee4\u724c\u6c92\u6709\u88ab\u4fee\u6539\uff0c\u4e26\u53ef\u7528\u65bc\u9a57\u8b49\u767c\u4ef6\u4eba \u8981\u6aa2\u67e5\u4ee4\u724c\u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 jwtutility \u6216\u5728 jwt.io \u7db2\u7ad9\u3002 \u6709\u6548\u8ca0\u8f09 payload \u90e8\u5206\u6709\u4ee5\u4e0b\u8cc7\u8a0a\uff1a { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-tvflf\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"cb81fb2a-a148-4a2a-b79f-89c101ce7c12\" , \"sub\" : \"system:serviceaccount:default:default\" } iss - \u4ee4\u724c\u7684\u7c3d\u767c\u8005 issuer kubernetes.io/serviceaccount/namespace - \u6a19\u793a\u4e86\u4ee4\u724c\u6b78\u5c6c\u65bc\u90a3\u500b\u547d\u540d\u7a7a\u9593 kubernetes.io/serviceaccount/secret.name - \u6a19\u793a\u4ee4\u724c\u4ee3\u8868\u8005\u90a3\u4e00\u500b\u670d\u52d9\u5e33\u6236 kubernetes.io/serviceaccount/service-account.uid - \u670d\u52d9\u5e33\u6236\u7684\u5167\u90e8 id sub - \u6a19\u793a\u4e86\u4e00\u500b unique \u7684\u5b8c\u6574\u670d\u52d9\u5e33\u6236\u7684\u540d\u7a31 ServiceAccount \u548c RBAC \u00b6 \u5c0d\u65bc\u6c92\u6709\u6307\u5b9a ServiceAccount \u7684\u6bcf\u500b Pod\uff0cKubernetes \u90fd\u6703\u81ea\u52d5\u6307\u6d3e\u4f7f\u7528 default \u9019\u500b ServiceAccount \u4e26\u639b\u8f09\u4e86\u5b83\u7684 JWT \u4ee4\u724c\u3002 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5728 pod \u5167\u90e8\u6aa2\u67e5 /var/run/secrets/kubernetes.io/serviceaccount \u76ee\u9304\u5167\u5bb9\uff1a [ root@ca-test-pod:/ ] $ ls -1 /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token \u5728 pod \u5167\u90e8\u6aa2\u67e5\u74b0\u5883\u8b8a\u6578\uff1a [ root@ca-test-pod:/ ] $ env | grep KUBERNETES KUBERNETES_PORT = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 \u5617\u8a66\u5728\u6c92\u6709\u8eab\u4efd\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\u5411 API-server \u57f7\u884c\u8acb\u6c42 - \u4f7f\u7528\u7279\u6b8a\u7684 Service kubernetes \uff0c\u5c07 -k \u6216 --insecure \u6dfb\u52a0\u5230 curl \u4ee5\u8df3\u904e\u670d\u52d9\u5668\u7684\u8b49\u66f8\u9a57\u8b49 [ root@ca-test-pod:/ ] $ curl -k https://kubernetes { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"Unauthorized\" , \"reason\" : \"Unauthorized\" , \"code\" : 401 } \u6211\u5011\u5f97\u5230 401 Unauthorized\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5728\u547c\u53eb\u8a2d\u5b9a\u4e0a\u6dfb\u52a0\u5169\u500b\u8b8a\u91cf ca.crt \u548c token \uff1a [ root@ca-test-pod:/ ] $ CERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt [ root@ca-test-pod:/ ] $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \u518d\u6b21\u904b\u884c curl, \u8b93\u6211\u5011\u5617\u8a66\u7372\u53d6\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u5217\u8868\uff0c\u9019\u6b21\u4e0d\u4f7f\u7528 --insecure \u4e26\u4f7f\u7528 Authorization \u6a19\u982d\u9032\u884c\u6388\u6b0a\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 } \u9019\u6b21\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u7684\u7528\u6236 system:serviceaccount:default:default \u6c92\u6709\u6b0a\u9650\u4f86\u547c\u53eb\u672c\u6b64\u7684API\u3002 ServiceAccount \u8207 RoleBindig \u00b6 \u70ba\u4e86\u7d66\u6211\u5011\u7684 SericeAccount \u6b0a\u9650\uff0c\u6211\u5011\u9700\u8981\u50cf\u666e\u901a\u7528\u6236\u4e00\u6a23\u5275\u5efa RoleBinding \u6216 ClusterRoleBinding \u3002 \u5275\u5efa\u5230\u9ed8\u8a8d ClusterRole \u8996\u5716\u7684 RoleBinding \u6620\u5c04\uff0c\u8acb\u53c3\u95b1 User-facing roles \uff1a $ kubectl create rolebinding ca-test-view --clusterrole = view --serviceaccount = default:default rolebinding.rbac.authorization.k8s.io/ca-test-view created \u4e26\u518d\u6b21\u904b\u884c curl\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" \u7d50\u679c: { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { }, \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" }, \"code\" : 403 }[ roo t @ca - test - pod : / ] $ curl -- cacer t $CERT - H \"Authorization: Bearer $TOKEN\" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"PodList\" , \"apiVersion\" : \"v1\" , \"metadata\" : { \"resourceVersion\" : \"14260\" }, \"items\" : [ { \"metadata\" : { \"name\" : \"ca-test-pod\" , \"namespace\" : \"default\" , \"uid\" : \"db7b286c-a31d-4697-bed6-7e75cb7865e9\" , \"resourceVersion\" : \"13958\" , \"creationTimestamp\" : \"2022-07-16T01:50:29Z\" , \"labels\" : { \"run\" : \"ca-test-pod\" }, \"managedFields\" : [ { \"manager\" : \"kubectl-run\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:29Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:metadata\" :{ \"f:labels\" :{ \".\" :{}, \"f:run\" :{}}}, \"f:spec\" :{ \"f:containers\" :{ \"k:{\\\"name\\\":\\\"ca-test-pod\\\"}\" :{ \".\" :{}, \"f:image\" :{}, \"f:imagePullPolicy\" :{}, \"f:name\" :{}, \"f:resources\" :{}, \"f:stdin\" :{}, \"f:stdinOnce\" :{}, \"f:terminationMessagePath\" :{}, \"f:terminationMessagePolicy\" :{}, \"f:tty\" :{}}}, \"f:dnsPolicy\" :{}, \"f:enableServiceLinks\" :{}, \"f:restartPolicy\" :{}, \"f:schedulerName\" :{}, \"f:securityContext\" :{}, \"f:terminationGracePeriodSeconds\" :{}}} }, { \"manager\" : \"k3s\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:38Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:status\" :{ \"f:conditions\" :{ \"k:{\\\"type\\\":\\\"ContainersReady\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Initialized\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Ready\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}}, \"f:containerStatuses\" :{}, \"f:hostIP\" :{}, \"f:phase\" :{}, \"f:podIP\" :{}, \"f:podIPs\" :{ \".\" :{}, \"k:{\\\"ip\\\":\\\"10.42.0.11\\\"}\" :{ \".\" :{}, \"f:ip\" :{}}}, \"f:startTime\" :{}}}, \"subresource\" : \"status\" } ] }, \"spec\" : { \"volumes\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"projected\" : { \"sources\" : [ { \"serviceAccountToken\" : { \"expirationSeconds\" : 3607 , \"path\" : \"token\" } }, { \"configMap\" : { \"name\" : \"kube-root-ca.crt\" , \"items\" : [ { \"key\" : \"ca.crt\" , \"path\" : \"ca.crt\" } ] } }, { \"downwardAPI\" : { \"items\" : [ { \"path\" : \"namespace\" , \"fieldRef\" : { \"apiVersion\" : \"v1\" , \"fieldPath\" : \"metadata.namespace\" } } ] } } ], \"defaultMode\" : 420 } } ], \"containers\" : [ { \"name\" : \"ca-test-pod\" , \"image\" : \"radial/busyboxplus:curl\" , \"resources\" : { }, \"volumeMounts\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"readOnly\" : true , \"mountPath\" : \"/var/run/secrets/kubernetes.io/serviceaccount\" } ], \"terminationMessagePath\" : \"/dev/termination-log\" , \"terminationMessagePolicy\" : \"File\" , \"imagePullPolicy\" : \"IfNotPresent\" , \"stdin\" : true , \"stdinOnce\" : true , \"tty\" : true } ], \"restartPolicy\" : \"Always\" , \"terminationGracePeriodSeconds\" : 30 , \"dnsPolicy\" : \"ClusterFirst\" , \"serviceAccountName\" : \"default\" , \"serviceAccount\" : \"default\" , \"nodeName\" : \"k3d-k3s-default-server-0\" , \"securityContext\" : { }, \"schedulerName\" : \"default-scheduler\" , \"tolerations\" : [ { \"key\" : \"node.kubernetes.io/not-ready\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 }, { \"key\" : \"node.kubernetes.io/unreachable\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 } ], \"priority\" : 0 , \"enableServiceLinks\" : true , \"preemptionPolicy\" : \"PreemptLowerPriority\" }, \"status\" : { \"phase\" : \"Running\" , \"conditions\" : [ { \"type\" : \"Initialized\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" }, { \"type\" : \"Ready\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"ContainersReady\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"PodScheduled\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" } ], \"hostIP\" : \"172.24.0.2\" , \"podIP\" : \"10.42.0.11\" , \"podIPs\" : [ { \"ip\" : \"10.42.0.11\" } ], \"startTime\" : \"2022-07-16T01:50:29Z\" , \"containerStatuses\" : [ { \"name\" : \"ca-test-pod\" , \"state\" : { \"running\" : { \"startedAt\" : \"2022-07-16T01:50:37Z\" } }, \"lastState\" : { }, \"ready\" : true , \"restartCount\" : 0 , \"image\" : \"docker.io/radial/busyboxplus:curl\" , \"imageID\" : \"sha256:4776f1f7d1f625c8c5173a969fdc9ae6b62655a2746aba989784bb2b7edbfe9b\" , \"containerID\" : \"containerd://c3e6ffab06622a2506ed6cf18ec8acd61fbb2a45721a2d65617b5bbce2a91159\" , \"started\" : true } ], \"qosClass\" : \"BestEffort\" } } ] }","title":"ServiceAccounts\u3001JWT-tokens\u3001\u8eab\u4efd\u9a57\u8b49\u548c RBAC \u6388\u6b0a"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-sa-jwt-rbac/#serviceaccountsjwt-tokens-rbac","text":"\u539f\u6587: https://rtfm.co.ua/en/kubernetes-serviceaccounts-jwt-tokens-authentication-and-rbac-authorization/ \u5c0d\u65bc\u8a8d\u8b49\u548c\u6388\u6b0a\uff0cKubernetes \u6709 User Accounts \u548c Service Accounts \u7b49\u6982\u5ff5\u3002 User Accounts \u7528\u65bc\u5f9e\u5916\u90e8\u8a2a\u554f\u96c6\u7fa4\u7684\u5e38\u7528\u7528\u6236\u914d\u7f6e\u6587\u4ef6\uff0c\u800c Service Accounts \u7528\u65bc\u5f9e\u96c6\u7fa4\u5167\u90e8\u6388\u4e88\u8a2a\u554f\u6b0a\u9650\u3002 ServiceAccounts \u65e8\u5728\u70ba Kubernetes Pod \u63d0\u4f9b\u4e00\u500b\u8eab\u4efd\uff0c\u4ee5\u4f9b\u5176\u5bb9\u5668\u5728\u5411 Kubernetes API \u670d\u52d9\u5668\u57f7\u884c API \u8acb\u6c42\u6642\u5c0d\u5176\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u3002","title":"ServiceAccounts\u3001JWT-tokens\u3001\u8eab\u4efd\u9a57\u8b49\u548c RBAC \u6388\u6b0a"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-sa-jwt-rbac/#serviceaccount","text":"\u6bcf\u500b Kubernetes \u547d\u540d\u7a7a\u9593\u90fd\u6709\u81ea\u5df1\u7684\u9ed8\u8a8d ServiceAccount (SA)\uff0c\u5b83\u662f\u5728\u5275\u5efa\u547d\u540d\u7a7a\u9593\u6642\u5275\u5efa\u7684\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u547d\u540d\u7a7a\u9593\uff1a @ kubectl --namespace default get serviceaccount NAME SECRETS AGE default 1 44h \u5c0d\u65bc\u6bcf\u500b ServiceAccount\uff0c\u90fd\u6703\u751f\u6210\u4e00\u500b token \u4e26\u5c07\u5176\u5b58\u5132\u70ba Kubernetes Secret\u3002 \u8b93\u6211\u5011\u6aa2\u67e5\u4e00\u4e0b default \u7684\u9019\u500b ServiceAccount\uff1a $ kubectl --namespace default get serviceaccount default -o yaml apiVersion: v1 kind: ServiceAccount metadata: creationTimestamp: \"2022-07-14T04:56:34Z\" name: default namespace: default resourceVersion: \"476\" uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 secrets: - name: default-token-tvflf \u5728\u672c\u7bc4\u4f8b\u4e2d SA \u7684\u4ee4\u724c\u5132\u653e\u5728 default-token-tvflf \u7684 Secret \u4e2d\uff1a Warning \u5728 Kubernetes 1.24+ \u4e4b\u5f8c\u7684\u7248\u672c\uff0cK8s \u4e0d\u6703\u518d\u70ba ServiceAccounts \u81ea\u52d5\u751f\u6210 Secret\u3002\u898b BIG change in K8s 1.24 about ServiceAccounts and their Secrets","title":"\u9810\u8a2d\u7684 ServiceAccount"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-sa-jwt-rbac/#token","text":"\u73fe\u5728\uff0c\u6aa2\u67e5 Secret \u7684\u5167\u5bb9\uff1a $ kubectl get secret default-token-tvflf -o yaml apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyTlRjM056UTFOell3SGhjTk1qSXdOekUwTURRMU5qRTJXaGNOTXpJd056RXhNRFExTmpFMgpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyTlRjM056UTFOell3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSUkFMTldkL2ZwVGxwWGY1c1BndjVDaTZGUm5hcFBwYWZSb2V2ZTJ3dGYKdjFQYVRueGNERUVUM0FKbDVUdDd4RG9DRlRtMVRyWXRTN2MyTmFLOFd3bk5vMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVWh4OUhPeGJWQ0dRU2NZMC9ZaGxjCnlyQ25YcmN3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQU5DQVRNOElScHNHaWs4R1FuWThGL1BEMFcrQXB6NW8KYzNqRnNXblZSc1B3QWlCdi9UWFQwSGtoZVpCZHJING0rZlUzeDNpU0UvVThqcGFGVEJ1ZUJqWUU0dz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K namespace: ZGVmYXVsdA == token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn kind: Secret metadata: annotations: kubernetes.io/service-account.name: default kubernetes.io/service-account.uid: cb81fb2a-a148-4a2a-b79f-89c101ce7c12 creationTimestamp: \"2022-07-14T04:56:34Z\" name: default-token-tvflf namespace: default resourceVersion: \"474\" uid: 5cf55c44-2c6a-46a9-90ba-137cea5f27b9 type: kubernetes.io/service-account-token type - \u6a19\u793a\u4e86\u9019\u500b Secret \u7684\u985e\u578b\u662f kubernetes.io/service-account-token \u3002 data - \u4fdd\u5b58\u4e86 ca.ert \u8207 token \u7684\u8cc7\u8a0a (base64 encoded) ca.crt \u7531 K8S \u96c6\u7fa4\u7684\u4e3b\u5bc6\u9470\u7c3d\u540d\uff0c\u56e0\u6b64\u96c6\u7fa4\u626e\u6f14\u8457\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7684\u89d2\u8272\uff0c\u4e26\u5141\u8a31 pod \u6216\u61c9\u7528\u7a0b\u5e8f\u9a57\u8b49 API-server\u3002 \u73fe\u5728\uff0c\u8b93\u6211\u5011\u53bb\u7814\u7a76 token \u7684\u90e8\u5206\u3002","title":"\u9810\u8a2d\u7684 token"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-sa-jwt-rbac/#jwt-token","text":"\u70ba\u4e86\u66f4\u5bb9\u6613\u5f9e termainal \u5de5\u4f5c - \u5c07 data.token \u503c\u4fdd\u5b58\u5230\u8b8a\u91cf\u4e2d\uff1a $ token = \"ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNklubDNOVlp3YWtSak1FWllVMjlHUVVOMlpFUmZVbWxuY0VSbFNsUlFjbEE1T1ZWcGJHeFlSMDkwYjI4aWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbVJsWm1GMWJIUXRkRzlyWlc0dGRIWm1iR1lpTENKcmRXSmxjbTVsZEdWekxtbHZMM05sY25acFkyVmhZMk52ZFc1MEwzTmxjblpwWTJVdFlXTmpiM1Z1ZEM1dVlXMWxJam9pWkdWbVlYVnNkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG5WcFpDSTZJbU5pT0RGbVlqSmhMV0V4TkRndE5HRXlZUzFpTnpsbUxUZzVZekV3TVdObE4yTXhNaUlzSW5OMVlpSTZJbk41YzNSbGJUcHpaWEoyYVdObFlXTmpiM1Z1ZERwa1pXWmhkV3gwT21SbFptRjFiSFFpZlEuZ2dieDM4Z0FHUVI2VnNVSTJkYkdIWHF5VzItUGI2VjYzSUVCbVF0a2gyZy1pX3FOY3g0MHlGOVVZMjNjbHRtOXJlY0ZwTXVERTFlUlQ5THNhcFZuRHRPcGdPeW0yWjhqSzlGNXZLUjZrX0YyNVJvanRTdVFiOG9fb2t0RDJlTUlwemN2OTZuX1hDejdMcFdWUnRQMm0wUWJWTE03SGRoU2hOZHRfcTF3V3hIai1QYkJIOW5teXhhemdGeGE4bkhLczd2Y1JnTFBqOVRKRE03Qkg3U0VaOXlZOG41S1Zwbmt3djNSUEVsdlNaR0taci0xV0NRcTQ0NGVicVZWcVFpTE4wY2x1NTdhNk95N2tOTnRqR2x6SVhPb0pNWFpaQ0lZZERBbUFuSkNWa3hLRV9oR0xMME9nb2ZHMXdZUXVMWjltcVRBalc5RENQeDcxTl9VNmFLTEVn\" \u4f7f\u7528 base64 \u7372\u53d6\u5176\u5167\u5bb9\uff1a $ echo $token | base64 -d eyJhbGciOiJSUzI1NiIsImtpZCI6Inl3NVZwakRjMEZYU29GQUN2ZERfUmlncERlSlRQclA5OVVpbGxYR090b28ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tdHZmbGYiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNiODFmYjJhLWExNDgtNGEyYS1iNzlmLTg5YzEwMWNlN2MxMiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.ggbx38gAGQR6VsUI2dbGHXqyW2-Pb6V63IEBmQtkh2g-i_qNcx40yF9UY23cltm9recFpMuDE1eRT9LsapVnDtOpgOym2Z8jK9F5vKR6k_F25RojtSuQb8o_oktD2eMIpzcv96n_XCz7LpWVRtP2m0QbVLM7HdhShNdt_q1wWxHj-PbBH9nmyxazgFxa8nHKs7vcRgLPj9TJDM7BH7SEZ9yY8n5KVpnkwv3RPElvSZGKZr-1WCQq444ebqVVqQiLN0clu57a6Oy7kNNtjGlzIXOoJMXZZCIYdDAmAnJCVkxKE_hGLL0OgofG1wYQuLZ9mqTAjW9DCPx71N_U6aKLEg JWT \u7684 token \u5305\u542b\u4e86\u4e09\u90e8\u4efd\u7684\u8cc7\u8a0a: \u6a19\u982d header - \u63cf\u8ff0\u4ee4\u724c\u7684\u7c3d\u540d\u65b9\u5f0f \u6709\u6548\u8ca0\u8f09 payload - \u4ee4\u724c\u7684\u5be6\u969b\u6578\u64da\uff0c\u4f8b\u5982\u5230\u671f\u65e5\u671f\u3001\u9812\u767c\u8005\u7b49\uff0c\u8acb\u53c3\u95b1 RFC-7519 \u7c3d\u540d signature - \u7528\u65bc\u9a57\u8b49\u4ee4\u724c\u6c92\u6709\u88ab\u4fee\u6539\uff0c\u4e26\u53ef\u7528\u65bc\u9a57\u8b49\u767c\u4ef6\u4eba \u8981\u6aa2\u67e5\u4ee4\u724c\u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 jwtutility \u6216\u5728 jwt.io \u7db2\u7ad9\u3002 \u6709\u6548\u8ca0\u8f09 payload \u90e8\u5206\u6709\u4ee5\u4e0b\u8cc7\u8a0a\uff1a { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-tvflf\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"cb81fb2a-a148-4a2a-b79f-89c101ce7c12\" , \"sub\" : \"system:serviceaccount:default:default\" } iss - \u4ee4\u724c\u7684\u7c3d\u767c\u8005 issuer kubernetes.io/serviceaccount/namespace - \u6a19\u793a\u4e86\u4ee4\u724c\u6b78\u5c6c\u65bc\u90a3\u500b\u547d\u540d\u7a7a\u9593 kubernetes.io/serviceaccount/secret.name - \u6a19\u793a\u4ee4\u724c\u4ee3\u8868\u8005\u90a3\u4e00\u500b\u670d\u52d9\u5e33\u6236 kubernetes.io/serviceaccount/service-account.uid - \u670d\u52d9\u5e33\u6236\u7684\u5167\u90e8 id sub - \u6a19\u793a\u4e86\u4e00\u500b unique \u7684\u5b8c\u6574\u670d\u52d9\u5e33\u6236\u7684\u540d\u7a31","title":"JWT token \u5167\u5bb9"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-sa-jwt-rbac/#serviceaccount-rbac","text":"\u5c0d\u65bc\u6c92\u6709\u6307\u5b9a ServiceAccount \u7684\u6bcf\u500b Pod\uff0cKubernetes \u90fd\u6703\u81ea\u52d5\u6307\u6d3e\u4f7f\u7528 default \u9019\u500b ServiceAccount \u4e26\u639b\u8f09\u4e86\u5b83\u7684 JWT \u4ee4\u724c\u3002 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5728 pod \u5167\u90e8\u6aa2\u67e5 /var/run/secrets/kubernetes.io/serviceaccount \u76ee\u9304\u5167\u5bb9\uff1a [ root@ca-test-pod:/ ] $ ls -1 /var/run/secrets/kubernetes.io/serviceaccount ca.crt namespace token \u5728 pod \u5167\u90e8\u6aa2\u67e5\u74b0\u5883\u8b8a\u6578\uff1a [ root@ca-test-pod:/ ] $ env | grep KUBERNETES KUBERNETES_PORT = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT_443_TCP_ADDR = 10 .43.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.43.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .43.0.1 \u5617\u8a66\u5728\u6c92\u6709\u8eab\u4efd\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\u5411 API-server \u57f7\u884c\u8acb\u6c42 - \u4f7f\u7528\u7279\u6b8a\u7684 Service kubernetes \uff0c\u5c07 -k \u6216 --insecure \u6dfb\u52a0\u5230 curl \u4ee5\u8df3\u904e\u670d\u52d9\u5668\u7684\u8b49\u66f8\u9a57\u8b49 [ root@ca-test-pod:/ ] $ curl -k https://kubernetes { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"Unauthorized\" , \"reason\" : \"Unauthorized\" , \"code\" : 401 } \u6211\u5011\u5f97\u5230 401 Unauthorized\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5728\u547c\u53eb\u8a2d\u5b9a\u4e0a\u6dfb\u52a0\u5169\u500b\u8b8a\u91cf ca.crt \u548c token \uff1a [ root@ca-test-pod:/ ] $ CERT = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt [ root@ca-test-pod:/ ] $ TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \u518d\u6b21\u904b\u884c curl, \u8b93\u6211\u5011\u5617\u8a66\u7372\u53d6\u547d\u540d\u7a7a\u9593\u4e2d\u7684 pod \u5217\u8868\uff0c\u9019\u6b21\u4e0d\u4f7f\u7528 --insecure \u4e26\u4f7f\u7528 Authorization \u6a19\u982d\u9032\u884c\u6388\u6b0a\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { } , \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" } , \"code\" : 403 } \u9019\u6b21\u6211\u5011\u53ef\u4ee5\u770b\u5230\u6211\u5011\u7684\u7528\u6236 system:serviceaccount:default:default \u6c92\u6709\u6b0a\u9650\u4f86\u547c\u53eb\u672c\u6b64\u7684API\u3002","title":"ServiceAccount \u548c RBAC"},{"location":"kubernetes/05-reference/access-authn-authz/k8s-sa-jwt-rbac/#serviceaccount-rolebindig","text":"\u70ba\u4e86\u7d66\u6211\u5011\u7684 SericeAccount \u6b0a\u9650\uff0c\u6211\u5011\u9700\u8981\u50cf\u666e\u901a\u7528\u6236\u4e00\u6a23\u5275\u5efa RoleBinding \u6216 ClusterRoleBinding \u3002 \u5275\u5efa\u5230\u9ed8\u8a8d ClusterRole \u8996\u5716\u7684 RoleBinding \u6620\u5c04\uff0c\u8acb\u53c3\u95b1 User-facing roles \uff1a $ kubectl create rolebinding ca-test-view --clusterrole = view --serviceaccount = default:default rolebinding.rbac.authorization.k8s.io/ca-test-view created \u4e26\u518d\u6b21\u904b\u884c curl\uff1a [ root@ca-test-pod:/ ] $ curl --cacert $CERT -H \"Authorization: Bearer $TOKEN \" \"https://kubernetes/api/v1/namespaces/default/pods/\" \u7d50\u679c: { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : { }, \"status\" : \"Failure\" , \"message\" : \"pods is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"pods\\\" in API group \\\"\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"kind\" : \"pods\" }, \"code\" : 403 }[ roo t @ca - test - pod : / ] $ curl -- cacer t $CERT - H \"Authorization: Bearer $TOKEN\" \"https://kubernetes/api/v1/namespaces/default/pods/\" { \"kind\" : \"PodList\" , \"apiVersion\" : \"v1\" , \"metadata\" : { \"resourceVersion\" : \"14260\" }, \"items\" : [ { \"metadata\" : { \"name\" : \"ca-test-pod\" , \"namespace\" : \"default\" , \"uid\" : \"db7b286c-a31d-4697-bed6-7e75cb7865e9\" , \"resourceVersion\" : \"13958\" , \"creationTimestamp\" : \"2022-07-16T01:50:29Z\" , \"labels\" : { \"run\" : \"ca-test-pod\" }, \"managedFields\" : [ { \"manager\" : \"kubectl-run\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:29Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:metadata\" :{ \"f:labels\" :{ \".\" :{}, \"f:run\" :{}}}, \"f:spec\" :{ \"f:containers\" :{ \"k:{\\\"name\\\":\\\"ca-test-pod\\\"}\" :{ \".\" :{}, \"f:image\" :{}, \"f:imagePullPolicy\" :{}, \"f:name\" :{}, \"f:resources\" :{}, \"f:stdin\" :{}, \"f:stdinOnce\" :{}, \"f:terminationMessagePath\" :{}, \"f:terminationMessagePolicy\" :{}, \"f:tty\" :{}}}, \"f:dnsPolicy\" :{}, \"f:enableServiceLinks\" :{}, \"f:restartPolicy\" :{}, \"f:schedulerName\" :{}, \"f:securityContext\" :{}, \"f:terminationGracePeriodSeconds\" :{}}} }, { \"manager\" : \"k3s\" , \"operation\" : \"Update\" , \"apiVersion\" : \"v1\" , \"time\" : \"2022-07-16T01:50:38Z\" , \"fieldsType\" : \"FieldsV1\" , \"fieldsV1\" : { \"f:status\" :{ \"f:conditions\" :{ \"k:{\\\"type\\\":\\\"ContainersReady\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Initialized\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}, \"k:{\\\"type\\\":\\\"Ready\\\"}\" :{ \".\" :{}, \"f:lastProbeTime\" :{}, \"f:lastTransitionTime\" :{}, \"f:status\" :{}, \"f:type\" :{}}}, \"f:containerStatuses\" :{}, \"f:hostIP\" :{}, \"f:phase\" :{}, \"f:podIP\" :{}, \"f:podIPs\" :{ \".\" :{}, \"k:{\\\"ip\\\":\\\"10.42.0.11\\\"}\" :{ \".\" :{}, \"f:ip\" :{}}}, \"f:startTime\" :{}}}, \"subresource\" : \"status\" } ] }, \"spec\" : { \"volumes\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"projected\" : { \"sources\" : [ { \"serviceAccountToken\" : { \"expirationSeconds\" : 3607 , \"path\" : \"token\" } }, { \"configMap\" : { \"name\" : \"kube-root-ca.crt\" , \"items\" : [ { \"key\" : \"ca.crt\" , \"path\" : \"ca.crt\" } ] } }, { \"downwardAPI\" : { \"items\" : [ { \"path\" : \"namespace\" , \"fieldRef\" : { \"apiVersion\" : \"v1\" , \"fieldPath\" : \"metadata.namespace\" } } ] } } ], \"defaultMode\" : 420 } } ], \"containers\" : [ { \"name\" : \"ca-test-pod\" , \"image\" : \"radial/busyboxplus:curl\" , \"resources\" : { }, \"volumeMounts\" : [ { \"name\" : \"kube-api-access-cngn5\" , \"readOnly\" : true , \"mountPath\" : \"/var/run/secrets/kubernetes.io/serviceaccount\" } ], \"terminationMessagePath\" : \"/dev/termination-log\" , \"terminationMessagePolicy\" : \"File\" , \"imagePullPolicy\" : \"IfNotPresent\" , \"stdin\" : true , \"stdinOnce\" : true , \"tty\" : true } ], \"restartPolicy\" : \"Always\" , \"terminationGracePeriodSeconds\" : 30 , \"dnsPolicy\" : \"ClusterFirst\" , \"serviceAccountName\" : \"default\" , \"serviceAccount\" : \"default\" , \"nodeName\" : \"k3d-k3s-default-server-0\" , \"securityContext\" : { }, \"schedulerName\" : \"default-scheduler\" , \"tolerations\" : [ { \"key\" : \"node.kubernetes.io/not-ready\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 }, { \"key\" : \"node.kubernetes.io/unreachable\" , \"operator\" : \"Exists\" , \"effect\" : \"NoExecute\" , \"tolerationSeconds\" : 300 } ], \"priority\" : 0 , \"enableServiceLinks\" : true , \"preemptionPolicy\" : \"PreemptLowerPriority\" }, \"status\" : { \"phase\" : \"Running\" , \"conditions\" : [ { \"type\" : \"Initialized\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" }, { \"type\" : \"Ready\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"ContainersReady\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:38Z\" }, { \"type\" : \"PodScheduled\" , \"status\" : \"True\" , \"lastProbeTime\" : null , \"lastTransitionTime\" : \"2022-07-16T01:50:29Z\" } ], \"hostIP\" : \"172.24.0.2\" , \"podIP\" : \"10.42.0.11\" , \"podIPs\" : [ { \"ip\" : \"10.42.0.11\" } ], \"startTime\" : \"2022-07-16T01:50:29Z\" , \"containerStatuses\" : [ { \"name\" : \"ca-test-pod\" , \"state\" : { \"running\" : { \"startedAt\" : \"2022-07-16T01:50:37Z\" } }, \"lastState\" : { }, \"ready\" : true , \"restartCount\" : 0 , \"image\" : \"docker.io/radial/busyboxplus:curl\" , \"imageID\" : \"sha256:4776f1f7d1f625c8c5173a969fdc9ae6b62655a2746aba989784bb2b7edbfe9b\" , \"containerID\" : \"containerd://c3e6ffab06622a2506ed6cf18ec8acd61fbb2a45721a2d65617b5bbce2a91159\" , \"started\" : true } ], \"qosClass\" : \"BestEffort\" } } ] }","title":"ServiceAccount \u8207 RoleBindig"},{"location":"kubernetes/05-reference/access-authn-authz/rbac-intro/","text":"Kubernetes RBAC (Role Base Access Control) \u00b6 k8s \u5728 1.8 \u7248\u4e4b\u5f8c\uff0c\u5f15\u7528\u4e86 Role-Base Access Control (RBAC\uff0c\u57fa\u65bc\u89d2\u8272\u7684\u8a2a\u554f\u63a7\u5236) \u505a\u70ba\u6388\u6b0a (Authorization) \u7684\u57fa\u790e\uff0c\u4e5f\u5c31\u662f\u4e00\u7a2e\u7ba1\u5236\u8a2a\u554f k8s API \u7684\u6a5f\u5236\u3002\u7ba1\u7406\u8005\u53ef\u4ee5\u900f\u904e rbac.authorization.k8s.io \u9019\u500b API \u7fa4\u7d44\u4f86\u9032\u884c\u52d5\u614b\u7684\u7ba1\u7406\u914d\u7f6e\u3002 \u900f\u904e\u9069\u7576\u7684\u89d2\u8272\u914d\u7f6e\u8207\u6388\u6b0a\u5206\u914d\uff0c\u7ba1\u7406\u8005\u53ef\u4ee5\u6c7a\u5b9a\u4f7f\u7528\u8005\u80fd\u5920\u4f7f\u7528\u54ea\u4e9b\u529f\u80fd\u3002\u4f8b\u5982\u5141\u8a31\u67d0\u500b\u89d2\u8272\u80fd\u65b0\u589e Pod \u6216\u53ea\u80fd\u5920\u5bdf\u770b\u4f46\u662f\u4e0d\u80fd\u65b0\u589e\u7b49\u7b49\u3002 \u53e6\u5916\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c\u5728 RBAC \u4e0b\u7684 \u89d2\u8272 \u6703\u88ab\u8ce6\u4e88\u4e0d\u540c\u7684\u7684\u6b0a\u9650 (permission)\uff0c\u800c\u9019\u4e9b\u6b0a\u9650\u662f\u63a1\u53d6\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\uff0c\u610f\u601d\u662f\u53ea\u6703\u6709\u89d2\u8272\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u800c\u4e0d\u6703\u6709\u89d2\u8272\u4e0d\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u3002 \u56e0\u6b64\uff0c\u4f5c\u70ba\u4e00\u500b\u512a\u79c0\u7684\u7ba1\u7406\u8005\uff0c\u4f60\u61c9\u8a72\u9069\u5ea6\u7684\u914d\u7f6e\u89d2\u8272\u4e26\u6c7a\u5b9a\u4e0d\u540c\u89d2\u8272\u53ef\u4ee5\u5141\u8a31\u64cd\u4f5c\u4ec0\u9ebc\u9805\u76ee\u3002 Role vs ClusterRole \u00b6 Role \u662f\u7528\u4f86\u5b9a\u7fa9\u5728\u67d0\u500b \u547d\u540d\u7a7a\u9593 \u5e95\u4e0b\u7684 \u89d2\u8272 \uff0c\u800c ClusterRole \u5247\u662f\u5c6c\u65bc \u53e2\u96c6\u901a\u7528\u7684\u89d2\u8272 \u3002\u53e6\u5916 ClusterRole \u9664\u4e86\u53ef\u4ee5\u914d\u7f6e Role \u7684\u6b0a\u9650\u5167\u5bb9\u5916\uff0c\u7531\u65bc\u662f Cluster \u7bc4\u570d\u7684\u89d2\u8272\uff0c\u56e0\u6b64\u9084\u80fd\u5920\u914d\u7f6e: \u53e2\u96c6\u7bc4\u570d\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 Nodes \u975e\u8cc7\u6e90\u985e\u578b\u7684 endpoints\uff0c\u4f8b\u5982 /healthz \u8de8\u547d\u540d\u7a7a\u9593\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 kubectl get pods --all-namespace \u770b\u500b\u4f8b\u5b50\uff1a role.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : Role metadata : namespace : default <=== \u5b9a\u7fa9\u5728 default \u547d\u540d\u7a7a\u9593\u4e2d name : configmap-editor <=== Role \u7684\u540d\u7a31 rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"configmap\" ] verbs : [ \"get\" , \"list\" , \"watch\" , \"create\" , \"update\" , \"patch\" , \"delete\" ] role.yaml \u6307\u5b9a\u4e86\u4e00\u500b default \u547d\u540d\u7a7a\u9593\u5167\u7684 Role \u7269\u4ef6\uff0c\u4e26\u5141\u8a31\u9019\u500b Role \u80fd\u5920\u5c0d ConfigMap \u9032\u884c\u64cd\u4f5c\u3002\u9019\u908a\u53ef\u4ee5\u77e5\u9053\u5728\u5b9a\u7fa9 Role \u7684\u6642\u5019\u5fc5\u9808: \u6307\u5b9a apiGroup \uff1a\u56e0\u70ba ConfigMap \u662f\u5c6c\u65bc apiVersion:v1 \u5e95\u4e0b\u7684\u7269\u4ef6\uff0c\"\" \u4ee3\u8868\u7684\u610f\u601d\u5c31\u662f apiVersion:v1 \u6307\u5b9a\u8981\u64cd\u4f5c\u7684\u8cc7\u6e90 resource \uff1a\u9019\u908a\u7684\u7bc4\u4f8b\u662f ConfigMap \u6388\u6b0a\u52d5\u4f5c verbs \uff1a\u8a18\u5f97\u662f\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\u8a72\u89d2\u8272\u80fd\u5728\u6307\u5b9a\u8cc7\u6e90\u505a\u4ec0\u9ebc\u64cd\u4f5c\uff0c\u4e0a\u9762\u4f8b\u5b50\u5305\u542b get , list , watch , create , update , patch \u548c delete \u3002 \u5982\u679c\u662f ClusterRole \uff1a clusterrole.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRole metadata : name : secret-reader rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"secrets\" ] verbs : [ \"get\" , \"list\" , \"watch\" ] <=== \u5141\u8a31\u8b80\u53d6 Secret \u4e0a\u9762\u7684\u7bc4\u4f8b\uff0c\u6211\u5011\u5efa\u7acb\u4e86\u4e00\u500b\u53ef\u4ee5\u8b80\u53d6 Secret \u7684 ClusterRole \u3002\u5176\u5be6\u8ddf Role \u5f88\u985e\u4f3c\uff0c\u5dee\u5225\u5728\u65bc ClusterRole \u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u7a7a\u9593\u3002 RoleBinding vs ClusterRoleBinding \u00b6 \u6709\u4e86 Role \u6216 ClusterRole \u4e4b\u5f8c\uff0c\u8868\u793a\u67d0\u500b\u547d\u540d\u7a7a\u9593\u5167\u6216\u662f\u53e2\u96c6\u5167\u6709\u88ab\u8ce6\u4e88\u6b0a\u9650\u7684\u89d2\u8272\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u9700\u8981\u900f\u904e RoleBinding \u6216 ClusterRoleBinding \u7684\u65b9\u5f0f\u4f86\u7d81\u5b9a\u3002 \u5982\u679c\u53ea\u6709\u5ba3\u544a Role \u6216 ClusterRole \u4f46\u672a\u7d81\u5b9a\uff0c\u5247\u6beb\u7121\u7528\u8655 \u7d81\u5b9a\u7684\u5c0d\u8c61\u53ef\u4ee5\u662f User , Group , \u6216\u8005\u662f Service Account \uff0c\u4f8b\u5982: User: subjects : - kind : User <=== \u6307\u5b9a\u5c0d\u8c61\u70ba User name : \"james@example.com\" <=== User \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Group: subjects : - kind : Group <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Group name : \"frontend-admins\" <=== Group \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Service Account\uff1a subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Service Account name : default <=== Service Account \u540d\u7a31 namespace : kube-system <=== \u547d\u540d\u7a7a\u9593 \u9019\u908a\u7279\u5225\u8aaa\u660e\u4e00\u4e0b Service Account \u3002\u5982\u679c\u5728 k8s \u90e8\u7f72\u50cf Jenkins \u9019\u985e\u7684 CI/CD \u5de5\u5177\u6642\uff0c\u4e00\u822c\u90fd\u6703\u5efa\u7acb\u81ea\u5df1\u7684 \u547d\u540d\u7a7a\u9593 \u3002\u800c\u7576\u7522\u751f\u4e00\u500b\u65b0\u7684 \u547d\u540d\u7a7a\u9593 \u6642\uff0c\u9810\u8a2d\u5c31\u6703\u6709\u4e00\u500b default \u7684 Service Account \u3002\u4f8b\u5982\uff1a $ kubectl create namespace jenkins namespace \"jenkins\" created $ kubectl get serviceaccount --namespace = jenkins NAME SECRETS AGE default 1 4m < === \u6703\u6709\u4e00\u500b\u9810\u8a2d\u7684 Service Account \u800c Jenkins \u6703\u53c3\u8003\u9019\u500b default \u4f86\u53d6\u5f97\u64cd\u4f5c k8s \u7684\u6b0a\u9650\uff0c\u4f46\u662f\u5728\u9810\u8a2d\u7684\u60c5\u6cc1\u4e0b\uff0c default \u4e0d\u6703\u64c1\u6709\u4efb\u4f55\u7684\u6b0a\u9650\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8981\u8a2d\u5b9a default \u7684\u6b0a\u9650\uff0c\u5373\u642d\u914d\u4e0a\u9762\u7684 RoleBinding \u6216 ClusterRoleBinding \u624d\u80fd\u5920\u63a7\u5236\u9019\u500b default \u80fd\u5920\u64cd\u4f5c\u7684\u6b0a\u9650\u3002 \u5e95\u4e0b\u662f\u4e00\u500b\u7d81\u5b9a\u4e0a\u9762 jenkins \u547d\u540d\u7a7a\u9593\u7684 Service Account \u4f8b\u5b50 clusterrolebinding.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : secret-reader subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u70ba jenkins \u5e95\u4e0b\u7684 default name : default namespace : jenkins roleRef : kind : ClusterRole <=== \u7d81\u5b9a ClusterRole name : secret-reader apiGroup : rbac.authorization.k8s.io \u53e6\u5916\uff0c\u4f60\u4e5f\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u4f86\u7d81\u5b9a\uff0c\u4f8b\u5982\u5982\u679c\u60f3\u8981\u5141\u8a31\u4e0a\u9762\u7684 default \u9019\u500b Service Account \u80fd\u5920\u64c1\u6709\u6574\u500b\u53e2\u96c6\u7684\u7ba1\u7406\u6b0a\u9650\uff0c\u6211\u5011\u53ef\u4ee5\u5efa\u7acb\u4e00\u500b ClusterRoleBinding \uff1a $ kubectl create clusterrolebinding jenkins-admin \\ --clusterrole = admin \\ --serviceaccount = jenkins:default clusterrolebinding jenkins-admin \uff1a\u5efa\u7acb\u4e00\u500b ClusterRoleBinding --clusterrole=admin \uff1a\u6307\u5b9a\u6b0a\u9650\u70ba admin --serviceaccount=jenkins:default \uff1a\u7d81\u5b9a jenkins \u7684\u4e0b\u7684 default","title":"Kubernetes RBAC \u4ecb\u8a54"},{"location":"kubernetes/05-reference/access-authn-authz/rbac-intro/#kubernetes-rbac-role-base-access-control","text":"k8s \u5728 1.8 \u7248\u4e4b\u5f8c\uff0c\u5f15\u7528\u4e86 Role-Base Access Control (RBAC\uff0c\u57fa\u65bc\u89d2\u8272\u7684\u8a2a\u554f\u63a7\u5236) \u505a\u70ba\u6388\u6b0a (Authorization) \u7684\u57fa\u790e\uff0c\u4e5f\u5c31\u662f\u4e00\u7a2e\u7ba1\u5236\u8a2a\u554f k8s API \u7684\u6a5f\u5236\u3002\u7ba1\u7406\u8005\u53ef\u4ee5\u900f\u904e rbac.authorization.k8s.io \u9019\u500b API \u7fa4\u7d44\u4f86\u9032\u884c\u52d5\u614b\u7684\u7ba1\u7406\u914d\u7f6e\u3002 \u900f\u904e\u9069\u7576\u7684\u89d2\u8272\u914d\u7f6e\u8207\u6388\u6b0a\u5206\u914d\uff0c\u7ba1\u7406\u8005\u53ef\u4ee5\u6c7a\u5b9a\u4f7f\u7528\u8005\u80fd\u5920\u4f7f\u7528\u54ea\u4e9b\u529f\u80fd\u3002\u4f8b\u5982\u5141\u8a31\u67d0\u500b\u89d2\u8272\u80fd\u65b0\u589e Pod \u6216\u53ea\u80fd\u5920\u5bdf\u770b\u4f46\u662f\u4e0d\u80fd\u65b0\u589e\u7b49\u7b49\u3002 \u53e6\u5916\u8981\u7279\u5225\u6ce8\u610f\u7684\u662f\uff0c\u5728 RBAC \u4e0b\u7684 \u89d2\u8272 \u6703\u88ab\u8ce6\u4e88\u4e0d\u540c\u7684\u7684\u6b0a\u9650 (permission)\uff0c\u800c\u9019\u4e9b\u6b0a\u9650\u662f\u63a1\u53d6\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\uff0c\u610f\u601d\u662f\u53ea\u6703\u6709\u89d2\u8272\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u800c\u4e0d\u6703\u6709\u89d2\u8272\u4e0d\u80fd\u5b58\u53d6\u67d0\u500b\u52d5\u4f5c\u3002 \u56e0\u6b64\uff0c\u4f5c\u70ba\u4e00\u500b\u512a\u79c0\u7684\u7ba1\u7406\u8005\uff0c\u4f60\u61c9\u8a72\u9069\u5ea6\u7684\u914d\u7f6e\u89d2\u8272\u4e26\u6c7a\u5b9a\u4e0d\u540c\u89d2\u8272\u53ef\u4ee5\u5141\u8a31\u64cd\u4f5c\u4ec0\u9ebc\u9805\u76ee\u3002","title":"Kubernetes RBAC (Role Base Access Control)"},{"location":"kubernetes/05-reference/access-authn-authz/rbac-intro/#role-vs-clusterrole","text":"Role \u662f\u7528\u4f86\u5b9a\u7fa9\u5728\u67d0\u500b \u547d\u540d\u7a7a\u9593 \u5e95\u4e0b\u7684 \u89d2\u8272 \uff0c\u800c ClusterRole \u5247\u662f\u5c6c\u65bc \u53e2\u96c6\u901a\u7528\u7684\u89d2\u8272 \u3002\u53e6\u5916 ClusterRole \u9664\u4e86\u53ef\u4ee5\u914d\u7f6e Role \u7684\u6b0a\u9650\u5167\u5bb9\u5916\uff0c\u7531\u65bc\u662f Cluster \u7bc4\u570d\u7684\u89d2\u8272\uff0c\u56e0\u6b64\u9084\u80fd\u5920\u914d\u7f6e: \u53e2\u96c6\u7bc4\u570d\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 Nodes \u975e\u8cc7\u6e90\u985e\u578b\u7684 endpoints\uff0c\u4f8b\u5982 /healthz \u8de8\u547d\u540d\u7a7a\u9593\u7684\u8cc7\u6e90\uff0c\u4f8b\u5982 kubectl get pods --all-namespace \u770b\u500b\u4f8b\u5b50\uff1a role.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : Role metadata : namespace : default <=== \u5b9a\u7fa9\u5728 default \u547d\u540d\u7a7a\u9593\u4e2d name : configmap-editor <=== Role \u7684\u540d\u7a31 rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"configmap\" ] verbs : [ \"get\" , \"list\" , \"watch\" , \"create\" , \"update\" , \"patch\" , \"delete\" ] role.yaml \u6307\u5b9a\u4e86\u4e00\u500b default \u547d\u540d\u7a7a\u9593\u5167\u7684 Role \u7269\u4ef6\uff0c\u4e26\u5141\u8a31\u9019\u500b Role \u80fd\u5920\u5c0d ConfigMap \u9032\u884c\u64cd\u4f5c\u3002\u9019\u908a\u53ef\u4ee5\u77e5\u9053\u5728\u5b9a\u7fa9 Role \u7684\u6642\u5019\u5fc5\u9808: \u6307\u5b9a apiGroup \uff1a\u56e0\u70ba ConfigMap \u662f\u5c6c\u65bc apiVersion:v1 \u5e95\u4e0b\u7684\u7269\u4ef6\uff0c\"\" \u4ee3\u8868\u7684\u610f\u601d\u5c31\u662f apiVersion:v1 \u6307\u5b9a\u8981\u64cd\u4f5c\u7684\u8cc7\u6e90 resource \uff1a\u9019\u908a\u7684\u7bc4\u4f8b\u662f ConfigMap \u6388\u6b0a\u52d5\u4f5c verbs \uff1a\u8a18\u5f97\u662f\u6dfb\u52a0\u7684\u65b9\u5f0f\u6307\u5b9a\u8a72\u89d2\u8272\u80fd\u5728\u6307\u5b9a\u8cc7\u6e90\u505a\u4ec0\u9ebc\u64cd\u4f5c\uff0c\u4e0a\u9762\u4f8b\u5b50\u5305\u542b get , list , watch , create , update , patch \u548c delete \u3002 \u5982\u679c\u662f ClusterRole \uff1a clusterrole.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRole metadata : name : secret-reader rules : - apiGroups : [ \"\" ] <=== \"\" \u8868\u793a /api/vi \u5373 apiVersion:v1 resources : [ \"secrets\" ] verbs : [ \"get\" , \"list\" , \"watch\" ] <=== \u5141\u8a31\u8b80\u53d6 Secret \u4e0a\u9762\u7684\u7bc4\u4f8b\uff0c\u6211\u5011\u5efa\u7acb\u4e86\u4e00\u500b\u53ef\u4ee5\u8b80\u53d6 Secret \u7684 ClusterRole \u3002\u5176\u5be6\u8ddf Role \u5f88\u985e\u4f3c\uff0c\u5dee\u5225\u5728\u65bc ClusterRole \u4e0d\u9700\u8981\u6307\u5b9a\u547d\u540d\u7a7a\u9593\u3002","title":"Role vs ClusterRole"},{"location":"kubernetes/05-reference/access-authn-authz/rbac-intro/#rolebinding-vs-clusterrolebinding","text":"\u6709\u4e86 Role \u6216 ClusterRole \u4e4b\u5f8c\uff0c\u8868\u793a\u67d0\u500b\u547d\u540d\u7a7a\u9593\u5167\u6216\u662f\u53e2\u96c6\u5167\u6709\u88ab\u8ce6\u4e88\u6b0a\u9650\u7684\u89d2\u8272\uff0c\u63a5\u4e0b\u4f86\u6211\u5011\u9700\u8981\u900f\u904e RoleBinding \u6216 ClusterRoleBinding \u7684\u65b9\u5f0f\u4f86\u7d81\u5b9a\u3002 \u5982\u679c\u53ea\u6709\u5ba3\u544a Role \u6216 ClusterRole \u4f46\u672a\u7d81\u5b9a\uff0c\u5247\u6beb\u7121\u7528\u8655 \u7d81\u5b9a\u7684\u5c0d\u8c61\u53ef\u4ee5\u662f User , Group , \u6216\u8005\u662f Service Account \uff0c\u4f8b\u5982: User: subjects : - kind : User <=== \u6307\u5b9a\u5c0d\u8c61\u70ba User name : \"james@example.com\" <=== User \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Group: subjects : - kind : Group <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Group name : \"frontend-admins\" <=== Group \u540d\u7a31 apiGroup : rbac.authorization.k8s.io Service Account\uff1a subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u5c0d\u8c61\u70ba Service Account name : default <=== Service Account \u540d\u7a31 namespace : kube-system <=== \u547d\u540d\u7a7a\u9593 \u9019\u908a\u7279\u5225\u8aaa\u660e\u4e00\u4e0b Service Account \u3002\u5982\u679c\u5728 k8s \u90e8\u7f72\u50cf Jenkins \u9019\u985e\u7684 CI/CD \u5de5\u5177\u6642\uff0c\u4e00\u822c\u90fd\u6703\u5efa\u7acb\u81ea\u5df1\u7684 \u547d\u540d\u7a7a\u9593 \u3002\u800c\u7576\u7522\u751f\u4e00\u500b\u65b0\u7684 \u547d\u540d\u7a7a\u9593 \u6642\uff0c\u9810\u8a2d\u5c31\u6703\u6709\u4e00\u500b default \u7684 Service Account \u3002\u4f8b\u5982\uff1a $ kubectl create namespace jenkins namespace \"jenkins\" created $ kubectl get serviceaccount --namespace = jenkins NAME SECRETS AGE default 1 4m < === \u6703\u6709\u4e00\u500b\u9810\u8a2d\u7684 Service Account \u800c Jenkins \u6703\u53c3\u8003\u9019\u500b default \u4f86\u53d6\u5f97\u64cd\u4f5c k8s \u7684\u6b0a\u9650\uff0c\u4f46\u662f\u5728\u9810\u8a2d\u7684\u60c5\u6cc1\u4e0b\uff0c default \u4e0d\u6703\u64c1\u6709\u4efb\u4f55\u7684\u6b0a\u9650\uff0c\u56e0\u6b64\u6211\u5011\u5fc5\u9808\u8981\u8a2d\u5b9a default \u7684\u6b0a\u9650\uff0c\u5373\u642d\u914d\u4e0a\u9762\u7684 RoleBinding \u6216 ClusterRoleBinding \u624d\u80fd\u5920\u63a7\u5236\u9019\u500b default \u80fd\u5920\u64cd\u4f5c\u7684\u6b0a\u9650\u3002 \u5e95\u4e0b\u662f\u4e00\u500b\u7d81\u5b9a\u4e0a\u9762 jenkins \u547d\u540d\u7a7a\u9593\u7684 Service Account \u4f8b\u5b50 clusterrolebinding.yaml --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : secret-reader subjects : - kind : ServiceAccount <=== \u6307\u5b9a\u70ba jenkins \u5e95\u4e0b\u7684 default name : default namespace : jenkins roleRef : kind : ClusterRole <=== \u7d81\u5b9a ClusterRole name : secret-reader apiGroup : rbac.authorization.k8s.io \u53e6\u5916\uff0c\u4f60\u4e5f\u53ef\u4ee5\u900f\u904e\u6307\u4ee4\u4f86\u7d81\u5b9a\uff0c\u4f8b\u5982\u5982\u679c\u60f3\u8981\u5141\u8a31\u4e0a\u9762\u7684 default \u9019\u500b Service Account \u80fd\u5920\u64c1\u6709\u6574\u500b\u53e2\u96c6\u7684\u7ba1\u7406\u6b0a\u9650\uff0c\u6211\u5011\u53ef\u4ee5\u5efa\u7acb\u4e00\u500b ClusterRoleBinding \uff1a $ kubectl create clusterrolebinding jenkins-admin \\ --clusterrole = admin \\ --serviceaccount = jenkins:default clusterrolebinding jenkins-admin \uff1a\u5efa\u7acb\u4e00\u500b ClusterRoleBinding --clusterrole=admin \uff1a\u6307\u5b9a\u6b0a\u9650\u70ba admin --serviceaccount=jenkins:default \uff1a\u7d81\u5b9a jenkins \u7684\u4e0b\u7684 default","title":"RoleBinding vs ClusterRoleBinding"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/","text":"\u7528 HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API \u00b6 \u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-call-simple-http-client/ \u4f7f\u7528 CLI\uff08\u5982 curl\uff09\u6216 GUI\uff08\u5982 postman\uff09HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API \u6709\u5f88\u591a\u4f7f\u7528\u60c5\u5883\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u6bd4 kubectl \u63d0\u4f9b\u7684\u66f4\u7d30\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u6216\u8005\u53ea\u662f\u60f3\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u8a2a\u554f API \u4e4b\u524d\u63a2\u7d22\u5b83\u3002 \u672c\u6587\u4e0d\u50c5\u50c5\u662f\u4e00\u500b\u65b9\u4fbf\u7684\u547d\u4ee4\u5217\u8868\uff0c\u800c\u662f\u4e00\u500b\u6df1\u601d\u719f\u616e\u7684\u6f14\u7df4\uff0c\u63ed\u793a\u4e86\u4e00\u4e9b\u60a8\u5728\u5f9e\u547d\u4ee4\u884c\u8abf\u7528 Kubernetes API \u6642\u53ef\u80fd\u6703\u5076\u7136\u767c\u73fe\u7684\u6709\u8da3\u554f\u984c\u3002\u5b83\u6db5\u84cb\u4ee5\u4e0b\u4e3b\u984c\uff1a \u5982\u4f55\u7372\u53d6 Kubernetes API \u670d\u52d9\u5668\u5730\u5740 \u5982\u4f55\u5411\u5ba2\u6236\u7aef\u9a57\u8b49 API \u670d\u52d9\u5668 \u5982\u4f55\u4f7f\u7528\u8b49\u66f8 (certificate) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u4f7f\u7528\u4ee4\u724c (token) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u5f9e Pod \u5167\u90e8\u8abf\u7528 Kubernetes API \u5982\u4f55\u4f7f\u7528 curl \u5c0d Kubernetes \u5c0d\u8c61\u57f7\u884c\u57fa\u672c\u7684 CRUD \u64cd\u4f5c \u5982\u4f55\u4f7f\u7528 kubectl \u7684 raw \u6a21\u5f0f\u76f4\u63a5\u8a2a\u554f Kubernetes API \u5982\u4f55\u67e5\u770b\u54ea\u4e9b API \u8acb\u6c42 kubectl \u547d\u4ee4\uff08\u5982 apply \u767c\u9001\uff09 Setting up Kubernetes playground \u00b6 \u5982\u679c\u4f60\u6c92\u6709 Kubernetes \u96c6\u7fa4\u53ef\u4ee5\u73a9\uff0c\u9019\u88e1\u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 arkade \u5feb\u901f\u5275\u5efa\u672c\u5730\u904a\u6a02\u5834\u7684\u65b9\u6cd5\uff1a $ curl -sLS https://get.arkade.dev | sudo sh $ arkade get minikube kubectl $ minikube start --profile cluster1 How to get Kubernetes API host and port \u00b6 \u8981\u8abf\u7528\u4efb\u4f55 API\uff0c\u60a8\u9996\u5148\u9700\u8981\u77e5\u9053\u5176\u670d\u52d9\u5668\u5730\u5740\u3002\u5c0d\u65bc Kubernetes\uff0c\u6bcf\u500b\u96c6\u7fa4\u90fd\u6709\u4e00\u500b API \u670d\u52d9\u5668\u3002\u56e0\u6b64\uff0c\u67e5\u627e API \u4e3b\u6a5f\u548c\u7aef\u53e3\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u67e5\u770b kubectl cluster-info \u8f38\u51fa\u3002\u4f8b\u5982\uff0c\u5728\u6211\u7684 Vagrant \u76d2\u5b50\u4e0a\uff0c\u5b83\u6703\u7522\u751f\u4ee5\u4e0b\u8a0a\u606f\uff1a $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy ... cluster-info \u547d\u4ee4\u986f\u793a\u5728 \u7576\u524d\u4e0a\u4e0b\u6587 \u4e2d\u9078\u64c7\u7684\u96c6\u7fa4\u7684 API \u5730\u5740\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u6709\u591a\u500b\u96c6\u7fa4\u600e\u9ebc\u8fa6\uff1f $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority: /home/dxlab/.minikube/ca.crt extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: cluster_info server: https://192.168.49.2:8443 name: minikube contexts: - context: cluster: minikube extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: context_info namespace: default user: minikube name: minikube current-context: minikube kind: Config preferences: {} users: - name: minikube user: client-certificate: /home/dxlab/.minikube/profiles/minikube/client.crt client-key: /home/dxlab/.minikube/profiles/minikube/client.key Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c kubectl \u5728 $HOME/.kube \u76ee\u9304\u4e2d\u67e5\u627e\u540d\u70ba config \u7684\u6587\u4ef6\u3002\u90a3\u9ebc\uff0c\u70ba\u4ec0\u9ebc\u4e0d\u76f4\u63a5\u5f9e\u9019\u500b\u6587\u4ef6\u4e2d\u7372\u53d6 API \u5730\u5740\u5462\uff1f \u539f\u56e0\u662f\u6f5b\u5728\u7684\u914d\u7f6e\u5408\u4f75\u3002\u901a\u904e\u5c07 KUBECONFIG env var \u8a2d\u7f6e\u70ba\u4ee5\u5192\u865f\u5206\u9694\u7684\u4f4d\u7f6e\u5217\u8868\uff0c\u53ef\u4ee5\u6307\u5b9a\u591a\u500b kubeconfig \u6587\u4ef6\u3002\u5728\u8a2a\u554f\u96c6\u7fa4\u4e4b\u524d\uff0c kubectl \u6703\u5617\u8a66\u5c07\u6240\u6709 kubeconfig \u6587\u4ef6\u7684\u5167\u5bb9\u5408\u4f75\u5230\u4e00\u500b\u914d\u7f6e\u4e2d\u3002 \u56e0\u6b64\uff0c\u5f9e\u4e0a\u9762\u7684\u5217\u8868\u4e2d\u9078\u64c7\u6b63\u78ba\u7684\u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u5617\u8a66\u5411\u5176 API \u670d\u52d9\u5668\u767c\u9001\u8acb\u6c42\uff1a $ KUBE_API = $( kubectl config view -o jsonpath = '{.clusters[0].cluster.server}' ) How to call Kubernetes API using curl \u00b6 \u5be6\u969b\u4e0a\uff0c\u4efb\u4f55 HTTP \u5ba2\u6236\u7aef\uff08curl\u3001httpie\u3001wget \u751a\u81f3 postman\uff09\u90fd\u53ef\u4ee5\uff0c\u4f46\u6211\u5c07\u5728\u672c\u7bc0\u4e2d\u4f7f\u7528 curl \u3002 Authenticating API server to client \u00b6 \u8b93\u6211\u5011\u5f9e\u67e5\u8a62 API \u7684 /version \u7aef\u9ede\u958b\u59cb\uff1a $ curl $KUBE_API /version curl: ( 60 ) SSL certificate problem: unable to get local issuer certificate More details here: https://curl.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. \u5f88\u986f\u7136\u2026\u2026\u6211\u5011\u9023\u63a5\u5931\u6557\u4e86\uff01 \ud83d\ude48 \u7576\u6211\u7b2c\u4e00\u6b21\u5076\u7136\u767c\u73fe\u985e\u4f3c\u7684\u932f\u8aa4\u6642\uff0c\u6211\u771f\u7684\u5f88\u56f0\u60d1\u3002\u4f46\u4ed4\u7d30\u60f3\u60f3\uff0c\u4e0a\u8ff0\u932f\u8aa4\u5be6\u969b\u4e0a\u662f\u6709\u9053\u7406\u7684\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cKubernetes \u901a\u904e HTTPS \u516c\u958b\u5176 API\uff0c\u7279\u5225\u662f\u70ba\u4e86\u5411\u5ba2\u6236\u7aef\u4fdd\u8b49 API \u670d\u52d9\u5668\u7684\u5f37\u8eab\u4efd\u3002\u4f46\u662f\uff0cminikube \u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\u4f86\u8a2d\u5b9a\u672c\u5730\u96c6\u7fa4\u3002\u56e0\u6b64\uff0cKubernetes API \u670d\u52d9\u5668\u7684 TLS \u8b49\u66f8\u539f\u4f86\u662f\u7531\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u7c3d\u7f72\u7684(self-signed)\uff0c\u8a72\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u5c0d curl \u662f\u672a\u77e5\u7684 \u3002curl \u7121\u6cd5\u4fe1\u4efb\u5b83\uff0c\u56e0\u6b64\u8acb\u6c42\u5931\u6557\u3002 Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0ccurl \u4fe1\u4efb\u5e95\u5c64\u64cd\u4f5c\u7cfb\u7d71\u6240\u4fe1\u4efb\u7684\u540c\u4e00\u7d44 CA\u3002\u4f8b\u5982\uff0c\u5728 Ubuntu \u6216 Debian \u4e0a\uff0c\u53ef\u4ee5\u5728 /etc/ssl/certs/ca-certificates.crt \u4e2d\u627e\u5230\u53d7\u4fe1\u4efb\u7684 CA \u5217\u8868\u3002\u986f\u7136\uff0cminikube \u4e0d\u6703\u5c07\u5176\u8b49\u66f8\u6dfb\u52a0\u5230\u6b64\u6587\u4ef6\u4e2d\u3002 \u5e78\u904b\u7684\u662f\uff0cminikube \u5c07 CA \u8b49\u66f8\u4fdd\u5b58\u5230 ~/.minikube/ca.crt \uff1a $ cat ~/.minikube/ca.crt | openssl x509 -text \u7d50\u679c: Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 1 ( 0x1 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 12 06 :14:14 2022 GMT Not After : Jun 10 06 :14:14 2032 GMT Subject: CN = minikubeCA Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :c2:ee:45:b9:c6:63:1f:15:d5:e7:22:5a:92:48: 86 :23:db:0c:a2:0c:e5:e9:b4:9b:29:75:04:c0:e2: 2b:f2:8e:2a:8a:47:06:6e:81:d0:13:90:0a:08:71: 99 :23:01:57:47:9b:1d:00:8f:95:50:20:97:13:6c: 32 :42:b5:04:c8:3a:0b:5d:30:9c:55:bd:28:53:1b: 87 :de:04:a7:04:18:e9:16:38:47:38:aa:a7:08:35: 1c:62:c3:e5:2d:89:ae:0b:e3:3b:9d:be:a2:b8:3b: e6:81:ac:75:12:fe:f7:9b:a1:1b:a8:46:f7:9d:b8: ce:41:2b:95:de:98:1b:52:a6:59:b9:54:ce:60:d6: f3:2b:a5:b8:43:e1:ca:87:5c:8c:61:f8:59:4b:47: 1c:73:20:ad:3d:8e:fa:0e:a2:c5:b7:2d:8b:9a:85: 3f:6c:39:46:16:e8:4f:a9:91:e2:86:02:f3:2d:66: 7d:6c:74:66:23:7a:34:24:85:d9:f6:20:b0:39:7d: 68 :86:d0:67:f1:90:df:ab:bd:52:85:5c:bb:99:a0: ab:b9:a5:bd:1e:08:69:8e:7e:e2:e0:d5:f2:a5:40: 76 :e7:03:de:aa:e3:f9:16:11:c9:ed:a3:8f:9a:c3: 48 :44:20:5e:4c:8d:13:fa:a0:f7:68:86:f5:8f:5f: 97 :3f Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment, Certificate Sign X509v3 Extended Key Usage: TLS Web Client Authentication, TLS Web Server Authentication X509v3 Basic Constraints: critical CA:TRUE X509v3 Subject Key Identifier: 70 :53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption 56 :3c:de:59:09:ce:7b:bf:92:b0:fd:44:ca:e7:83:48:a2:f8: a7:3d:01:b2:62:50:62:cb:c0:7c:33:5d:25:a2:f4:46:af:88: b0:02:db:84:e6:4c:cb:a3:74:46:ed:ef:96:48:15:f9:cb:d7: 07 :42:0e:b0:3f:bf:bd:2b:e6:02:66:9c:a6:b4:5c:de:f9:0a: 5b:68:cc:7a:0f:ea:1a:b5:4e:ff:ff:95:f7:b9:c4:a1:1f:e5: 76 :62:f4:c7:82:2d:9d:a6:79:99:95:f2:f7:77:58:11:87:0a: 76 :88:e3:32:fe:4a:18:99:fd:a2:b8:50:29:fb:4a:f5:74:4c: b2:0c:b5:42:75:93:6c:b9:80:db:10:8b:3e:49:c2:f2:15:84: e4:0f:fd:9b:21:05:ed:0e:66:85:04:58:ff:d8:c3:e9:e4:44: c4:30:28:fa:7f:b8:79:3c:8e:c3:28:64:cd:6c:ea:db:57:a2: e9:b3:26:2a:d2:18:4e:f5:b9:1d:23:48:cf:be:f7:85:6c:7e: dd:c8:85:78:ae:92:a7:1e:2c:0e:2a:c6:5f:3a:9c:84:8f:2d: cd:20:ac:30:a6:79:f3:4d:08:8e:e3:93:32:81:01:dc:c5:7b: 0d:a8:d8:e3:13:0b:d6:68:1f:3e:69:10:16:4a:9e:77:4a:61: 8f:94:e5:3c -----BEGIN CERTIFICATE----- MIIDBjCCAe6gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYxMjA2MTQxNFoXDTMyMDYxMDA2MTQxNFowFTETMBEGA1UE AxMKbWluaWt1YmVDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMLu RbnGYx8V1eciWpJIhiPbDKIM5em0myl1BMDiK/KOKopHBm6B0BOQCghxmSMBV0eb HQCPlVAglxNsMkK1BMg6C10wnFW9KFMbh94EpwQY6RY4Rziqpwg1HGLD5S2Jrgvj O52+org75oGsdRL+95uhG6hG9524zkErld6YG1KmWblUzmDW8yuluEPhyodcjGH4 WUtHHHMgrT2O+g6ixbcti5qFP2w5RhboT6mR4oYC8y1mfWx0ZiN6NCSF2fYgsDl9 aIbQZ/GQ36u9UoVcu5mgq7mlvR4IaY5+4uDV8qVAducD3qrj+RYRye2jj5rDSEQg XkyNE/qg92iG9Y9flz8CAwEAAaNhMF8wDgYDVR0PAQH/BAQDAgKkMB0GA1UdJQQW MBQGCCsGAQUFBwMCBggrBgEFBQcDATAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQW BBRwU4aOAa7jT1ePsDDDMbBeMdt/ljANBgkqhkiG9w0BAQsFAAOCAQEAVjzeWQnO e7+SsP1EyueDSKL4pz0BsmJQYsvAfDNdJaL0Rq+IsALbhOZMy6N0Ru3vlkgV+cvX B0IOsD+/vSvmAmacprRc3vkKW2jMeg/qGrVO//+V97nEoR/ldmL0x4ItnaZ5mZXy 93dYEYcKdojjMv5KGJn9orhQKftK9XRMsgy1QnWTbLmA2xCLPknC8hWE5A/9myEF 7Q5mhQRY/9jD6eRExDAo+n+4eTyOwyhkzWzq21ei6bMmKtIYTvW5HSNIz773hWx+ 3ciFeK6Spx4sDirGXzqchI8tzSCsMKZ5800IjuOTMoEB3MV7DajY4xML1mgfPmkQ Fkqed0phj5TlPA == -----END CERTIFICATE----- \u56e0\u6b64\uff0c\u8981\u4fee\u5fa9 GET /version \u8acb\u6c42\u7684\u554f\u984c\uff0c\u6211\u53ea\u9700\u8981\u901a\u904e\u624b\u52d5\u5c07\u5176\u6307\u5411 minikubeCA \u8b49\u66f8\u4f86\u4f7f curl \u4fe1\u4efb API \u670d\u52d9\u5668\u8b49\u66f8\u7684\u9812\u767c\u8005\uff1a $ curl --cacert ~/.minikube/ca.crt $KUBE_API /version { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } Info \u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5728\u3000 curl \u547d\u4ee4\u4e2d\u4f7f\u7528 --insecure \u6a19\u8a8c\u6216\u5176\u77ed\u5225\u540d -k \u3002\u5728\u5b89\u5168\u7684\u74b0\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b61 insecure mode\uff0c\u5b83\u6bd4\u8a66\u5716\u627e\u5230\u9812\u767c\u8005\u8b49\u66f8\u66f4\u7c21\u55ae\u3002 Authenticating using Certificates \u00b6 \u597d\u7684\uff0c\u8b93\u6211\u5011\u5617\u8a66\u4e00\u4e9b\u66f4\u8907\u96dc\u7684\u6771\u897f\u3002\u5217\u51fa\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u90e8\u7f72\u600e\u9ebc\u6a23\uff1f $ curl --cacert ~/.minikube/ca.crt $KUBE_API /apis/apps/v1/deployments { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:anonymous\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" at the cluster scope\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u8207\u660e\u986f\u4e0d\u53d7\u4fdd\u8b77\u7684 /version \u7aef\u9ede\u4e0d\u540c\uff0cKubernetes \u901a\u5e38\u6703\u9650\u5236\u5c0d\u5176 API \u7aef\u9ede\u7684\u8a2a\u554f\u3002 \u5f9e\u932f\u8aa4\u6d88\u606f\u4e2d\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u51fa\uff0c\u8a72\u8acb\u6c42\u88ab\u9a57\u8b49\u70ba\u7528\u6236 system:anonymous \uff0c\u986f\u7136\uff0c\u8a72\u7528\u6236\u672a\u6388\u6b0a\u53ef\u547c\u53eb\u5217\u51fa\u90e8\u7f72\u8cc7\u6e90\u7684 API \u6b0a\u9650\u3002 \u9019\u500b\u5931\u6557\u7684\u8acb\u6c42\u5c0e\u56e0\u65bc\u6211\u5011\u4e26\u672a\u6aa2\u9644\u4efb\u4f55\u8eab\u4efd\u9a57\u8b49\u8cc7\u8a0a\uff08\u5118\u7ba1\u5982\u6b64\uff0c\u5b83\u5df2\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\uff0c\u4f46\u4f5c\u70ba\u533f\u540d\u7528\u6236\uff09\uff0c\u6240\u4ee5\u6211\u9700\u8981\u63d0\u4f9b\u4e00\u4e9b\u984d\u5916\u7684\u4fe1\u606f\u4f86\u7372\u5f97\u6240\u9700\u7684\u8a2a\u554f\u7d1a\u5225\u3002 Kubernetes \u652f\u6301\u591a\u7a2e \u8eab\u4efd\u9a57\u8b49\u6a5f\u5236 \uff0c\u6211\u5c07\u5f9e\u4f7f\u7528\u5ba2\u6236\u7aef\u8b49\u66f8(client certificate)\u5c0d\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u958b\u59cb\u3002 \u4f46\u662f\u7b49\u4e00\u4e0b\uff01\u4ec0\u9ebc\u662f\u5ba2\u6236\u8b49\u66f8(client certificate)\uff1f \u7576 minikube \u8a2d\u5b9a\u96c6\u7fa4\u6642\uff0c\u5b83\u9084\u5275\u5efa\u4e86\u4e00\u500b \u7528\u6236 \u3002\u8a72 \u7528\u6236 \u7372\u5f97\u4e86\u7531\u540c\u4e00\u500b minikubeCA \u9812\u767c\u6a5f\u69cb\u7c3d\u7f72\u7684\u8b49\u66f8\u3002\u7531\u65bc Kubernetes API \u670d\u52d9\u5668\u4fe1\u4efb\u6b64 CA\uff0c\u56e0\u6b64\u5728\u8acb\u6c42\u4e2d\u63d0\u4f9b\u6b64\u8b49\u66f8\u5c07\u4f7f\u5176\u4f5c\u70ba\u6240\u8ff0\u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 Info Kubernetes \u6c92\u6709\u4ee3\u8868 \u7528\u6236 \u7684\u5c0d\u8c61\u3002\u5373\u4e0d\u80fd\u901a\u904e API \u8abf\u7528\u5c07\u7528\u6236\u6dfb\u52a0\u5230\u96c6\u7fa4\u4e2d\u3002\u4f46\u662f\uff0c\u4efb\u4f55\u63d0\u4f9b\u7531\u96c6\u7fa4\u7684\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7c3d\u540d\u7684\u6709\u6548\u8b49\u66f8\u7684\u7528\u6236\u90fd\u88ab\u8996\u70ba\u5df2\u901a\u904e\u8eab\u4efd\u9a57\u8b49\u3002 Kubernetes \u5f9e\u8b49\u66f8\u4e3b\u984c\u4e2d\u7684\u901a\u7528\u540d\u7a31\u5b57\u6bb5\u4e2d\u7372\u53d6\u7528\u6236\u540d\uff08\u4f8b\u5982\uff0cCN = minikube-user\uff09\u3002\u7136\u5f8c\uff0cKubernetes RBAC \u5b50\u7cfb\u7d71\u5224\u65b7\u7528\u6236\u662f\u5426\u6709\u6b0a\u5c0d\u8cc7\u6e90\u57f7\u884c\u7279\u5b9a\u64cd\u4f5c\u3002 \u7528\u6236\u8b49\u66f8\u901a\u5e38\u53ef\u4ee5\u5728\u6211\u5011\u5df2\u7d93\u719f\u6089\u7684 kubectl \u914d\u7f6e\u8996\u5716\u8f38\u51fa\u4e2d\u627e\u5230\uff1a $ kubectl config view -o jsonpath = '{.users[0]}' | jq { \"name\" : \"minikube\" , \"user\" : { \"client-certificate\" : \"/home/dxlab/.minikube/profiles/minikube/client.crt\" , \"client-key\" : \"/home/dxlab/.minikube/profiles/minikube/client.key\" } } \u8b93\u6211\u5011\u5feb\u901f\u6aa2\u67e5\u8b49\u66f8\u5167\u5bb9\u4ee5\u78ba\u4fdd\u5b83\u662f\u7531\u540c\u4e00\u500b CA \u7c3d\u540d\u7684\uff1a $ cat ~/.minikube/profiles/cluster1/client.crt | openssl x509 -text Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 2 ( 0x2 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 26 21 :54:59 2022 GMT Not After : Jun 26 21 :54:59 2025 GMT Subject: O = system:masters, CN = minikube-user Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :a6:eb:74:10:82:be:42:94:2b:db:72:a6:17:7d: a5:9e:b4:d1:1b:34:c5:a4:71:ff:03:68:1b:1e:cb: 77 :57:bb:6f:fd:0e:d7:b5:62:8f:c8:66:22:36:7d: 01 :d3:f3:4b:3d:84:6a:03:0b:6f:e4:8e:3d:50:24: a4:ad:e0:89:1a:3f:05:af:d8:67:63:9d:44:92:73: 93 :ef:65:08:7e:05:76:45:69:6e:e7:b8:50:81:b6: 8b:82:a7:85:9b:9d:84:2d:db:d5:f5:73:a9:eb:08: a5:0b:f2:61:b8:66:a5:f9:84:09:68:8d:9f:56:8e: 1f:a7:71:f6:4f:67:31:03:8d:a2:17:2a:42:f4:de: 96 :11:2e:22:da:fa:f6:26:f2:de:7b:99:bb:66:b3: d0:3e:4a:f6:c3:7e:6d:0f:d5:ef:44:54:fd:7f:c1: c9:65:f7:7f:d4:50:73:2b:2a:ce:84:19:b0:a7:8a: 66 :cb:ed:f8:60:3a:4a:ac:36:e6:5a:8f:21:eb:4f: f8:fd:db:d3:55:d8:41:a9:34:00:20:9f:eb:9c:58: fd:32:0c:d5:a8:3d:13:82:5c:ef:5c:e6:a5:ac:a8: fb:71:ec:1a:d1:db:ad:f9:2c:40:3b:ee:59:0f:70: 36 :b1:8a:ab:95:1e:e6:0b:1e:01:c4:ab:a7:5c:c6: 10 :43 Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment X509v3 Extended Key Usage: TLS Web Server Authentication, TLS Web Client Authentication X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:70:53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption a3:4e:82:61:63:b9:bc:5c:3f:ba:4d:00:ae:b4:f0:a7:a3:9f: 39 :5b:2b:82:0c:4f:d8:a6:ef:07:45:de:b1:0f:85:70:50:8c: b3:9f:1f:a6:31:34:20:ee:59:89:3b:c5:03:5f:f0:8a:1c:b5: c4:44:c6:45:c4:f4:51:1c:28:4b:b0:0b:52:41:55:4a:04:06: 38 :0d:ab:65:e7:7a:6f:0b:eb:3c:7e:92:7f:f8:30:b8:73:dd: 62 :1c:19:f4:66:ff:88:57:f8:10:23:1b:c1:42:04:41:a1:94: 13 :d3:51:bb:8f:52:bf:f3:ff:50:66:cf:9e:e0:d4:1e:0b:44: 7f:e3:8e:2a:b9:07:62:a3:98:e1:50:c6:82:71:de:da:c8:83: 4a:6d:8f:78:f7:aa:53:5c:ed:68:db:b5:09:b2:1b:94:80:50: 71 :12:cb:92:c2:a3:5f:f1:9d:12:4f:b0:0a:08:39:25:d9:19: b3:ca:15:51:d6:01:b6:7d:58:81:cc:b5:85:47:b0:ff:d4:b3: 63 :ce:2e:b9:12:eb:c6:0e:c3:5f:88:62:7c:39:5f:2d:c5:d1: 56 :a6:68:7b:c1:29:5c:69:dc:ee:cf:af:92:6b:ad:3c:e8:bd: 6c:b9:1e:9d:35:3a:93:c1:4a:f2:64:d2:1b:bb:79:48:bc:89: 51 :81:0d:da -----BEGIN CERTIFICATE----- MIIDITCCAgmgAwIBAgIBAjANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYyNjIxNTQ1OVoXDTI1MDYyNjIxNTQ1OVowMTEXMBUGA1UE ChMOc3lzdGVtOm1hc3RlcnMxFjAUBgNVBAMTDW1pbmlrdWJlLXVzZXIwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCm63QQgr5ClCvbcqYXfaWetNEbNMWk cf8DaBsey3dXu2/9Dte1Yo/IZiI2fQHT80s9hGoDC2/kjj1QJKSt4IkaPwWv2Gdj nUSSc5PvZQh+BXZFaW7nuFCBtouCp4WbnYQt29X1c6nrCKUL8mG4ZqX5hAlojZ9W jh+ncfZPZzEDjaIXKkL03pYRLiLa+vYm8t57mbtms9A+SvbDfm0P1e9EVP1/wcll 93 /UUHMrKs6EGbCnimbL7fhgOkqsNuZajyHrT/j929NV2EGpNAAgn+ucWP0yDNWo PROCXO9c5qWsqPtx7BrR2635LEA77lkPcDaxiquVHuYLHgHEq6dcxhBDAgMBAAGj YDBeMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUH AwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBRwU4aOAa7jT1ePsDDDMbBeMdt/ ljANBgkqhkiG9w0BAQsFAAOCAQEAo06CYWO5vFw/uk0ArrTwp6OfOVsrggxP2Kbv B0XesQ+FcFCMs58fpjE0IO5ZiTvFA1/wihy1xETGRcT0URwoS7ALUkFVSgQGOA2r Zed6bwvrPH6Sf/gwuHPdYhwZ9Gb/iFf4ECMbwUIEQaGUE9NRu49Sv/P/UGbPnuDU HgtEf+OOKrkHYqOY4VDGgnHe2siDSm2PePeqU1ztaNu1CbIblIBQcRLLksKjX/Gd Ek+wCgg5JdkZs8oVUdYBtn1Ygcy1hUew/9SzY84uuRLrxg7DX4hifDlfLcXRVqZo e8EpXGnc7s+vkmutPOi9bLkenTU6k8FK8mTSG7t5SLyJUYEN2g == -----END CERTIFICATE----- \u4e0b\u9762\u662f\u5982\u4f55\u4f7f\u7528 curl \u5411 Kubernetes API \u670d\u52d9\u5668\u767c\u9001\u7531\u8a72\u8b49\u66f8\u8a8d\u8b49\u7684\u8acb\u6c42\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"654514\" } , \"items\" : [ ... ] - \"iss\" ( Issuer ) Claim - The \"iss\" ( issuer ) claim identifies the principal that issued the JWT. - \"sub\" ( Subject ) Claim -The \"sub\" ( subject ) claim identifies the principal that is the subject of the JWT. } Authenticating using Service Account Tokens \u00b6 \u53e6\u4e00\u7a2e\u9a57\u8b49 API \u8acb\u6c42\u7684\u65b9\u6cd5\u662f\u4f7f\u7528 \u670d\u52d9\u5e33\u6236 \u7684 JWT \u4ee4\u724c\u3002\u8207\u7528\u6236\u975e\u5e38\u76f8\u4f3c\uff0c\u4e0d\u540c\u7684 \u670d\u52d9\u5e33\u6236 \u5177\u6709\u4e0d\u540c\u7d1a\u5225\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u8b93\u6211\u5011\u770b\u770b\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u9ed8\u8a8d\u670d\u52d9\u5e33\u6236\u53ef\u4ee5\u5be6\u73fe\u4ec0\u9ebc\uff1a $ JWT_TOKEN_DEFAULT_DEFAULT = $( kubectl get secrets \\ $( kubectl get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_DEFAULT_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tNng1ZHEiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRiZjA0ZDczLWZlOTctNDMzMi04NDM2LWVjNDdlMDZkYzE2MSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.pkJ-AZufRuGcMGXwtL7jQu0BOa6DGgylzTjGcKQcOESjXeTsZfw8pnwHMOJsiV760QMLY33GtpzLy0om5l4gfU1O-CJZXKTaYCHzjyEb6ZVLK0xLeLwsW--LI_Weo0X9KiAjNBqDSUmj8NYHn2-c-wygN6IYWqbT8MmXL-YC8dejeqUlLzAQUw8hZasdWN6KLnmNxhI0-cntp0C8O2I5SPumOxq7IEX8s2Erir2cU2xGI-LPaMm8ccAk5wrKS9rqk23G24vXFgi9u1SwtujC_hZrki_rm8yrMUWvOa5SPZqAag_dkjLXR5YSxF_nJO69XGJ1fId3hr2ruHBTivbfEQ \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-6x5dq\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"dbf04d73-fe97-4332-8436-ec47e06dc161\" , \"sub\" : \"system:serviceaccount:default:default\" } \u5f9e\u4e00\u500b\u7c21\u55ae\u7684\u4efb\u52d9\u958b\u59cb - \u5728 apps/v1 \u4e2d\u5217\u51fa\u5df2\u77e5\u7684 API \u8cc7\u6e90\u985e\u578b\uff1a $ curl $KUBE_API /apis/apps/v1/ \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"APIResourceList\" , \"apiVersion\" : \"v1\" , \"groupVersion\" : \"apps/v1\" , \"resources\" : [ ... ] } \u63a5\u8457\u8b93\u6211\u5011\u5617\u8a66\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa\u5be6\u969b\u7684\u90e8\u7f72\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u986f\u7136\uff0c\u7528\u6236 system:serviceaccount:default:default \u751a\u81f3\u4e0d\u8db3\u4ee5\u5728\u5176\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa Kubernetes \u5c0d\u8c61\u3002 \u8b93\u6211\u5011\u5617\u8a66\u4e00\u500b\u5f37\u5927\u7684 kube-system \u670d\u52d9\u5e33\u6236\uff1a $ JWT_TOKEN_KUBESYSTEM_DEFAULT = $( kubectl -n kube-system get secrets \\ $( kubectl -n kube-system get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_KUBESYSTEM_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZWZhdWx0LXRva2VuLW16bWo3Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRlZmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhN2E4YTc1Mi1jNjQ5LTRkOGYtOTQzMi03MDgxYjE4YzBiNTIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06ZGVmYXVsdCJ9.talXOCcsaH5VaZEOJo-VilVZUhM6YWrChmKScXHcTwDfVBmX6XlrelomnYMUtwahnF1aGe_vJpLzk-SJhvdLvFSAvw0pIWxsabes7ITfCdOfAMliPhiCIOC4XwawKWmbVJYcvhHppNA41qzNAbtav_e9qB6z84fmAQHQJLITMmMfe-ZC38I3sWh5ezoo-1uiV3iY6SHxd4WGXmuRBqkvWxJM7JiC2TmUU9Z6K4gfrRtfBrB2-A3Ti6v7Jcqwxakqq092X7VpstmJTHgh6KExm-0laIUSOKwUFlFvs4-MYKwmbYdz4IYDxJejZjcfC8XkTM6nQPaXdaTA6olKBzKHKg \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"kube-system\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-mzmj7\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"a7a8a752-c649-4d8f-9432-7081b18c0b52\" , \"sub\" : \"system:serviceaccount:kube-system:default\" } \u5f37\u5927\u7684\u5e33\u6236\u503c\u5f97\u4e00\u9805\u5177\u6709\u6311\u6230\u6027\u7684\u4efb\u52d9 - \u5217\u51fa\u96c6\u7fa4\u7d1a\u8cc7\u6e90\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_KUBESYSTEM_DEFAULT \" { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"656580\" } , \"items\" : [ ... ] } \u662f\u7684\uff0c\u7b26\u5408\u6211\u5011\u7684\u671f\u5f85\u5730\u5b8c\u6210\u5de5\u4f5c\ud83d\udc4c Call Kubernetes API inside a Pod \u00b6 \u8207\u4efb\u4f55\u5176\u4ed6 Kubernetes \u670d\u52d9\u975e\u5e38\u76f8\u4f3c\uff0cKubernetes API \u670d\u52d9\u5730\u5740\u53ef\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u63d0\u4f9b\u7d66 Pod\uff1a $ kubectl run -it --image curlimages/curl --restart = Never mypod -- sh $ env | grep KUBERNETES KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 Pod \u901a\u5e38\u9084\u6703\u5728 /var/run/secrets/kubernetes.io/serviceaccount/ \u4e0a\u5b89\u88dd Kubernetes CA \u8b49\u66f8\u548c \u670d\u52d9\u5e33\u6236 credentials\u3002\u56e0\u6b64\uff0c\u61c9\u7528\u4ee5\u4e0a\u90e8\u5206\u7684\u77e5\u8b58\uff0c\u5f9e Pod \u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u7684 curl \u547d\u4ee4\u53ef\u4ee5\u5982\u4e0b\u6240\u793a\uff1a $ curl https:// ${ KUBERNETES_SERVICE_HOST } : ${ KUBERNETES_SERVICE_PORT } /apis/apps/v1 \\ --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \\ --header \"Authorization: Bearer $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \" Creat, Read, Watch, Update, Patch, and Delete objects \u00b6 Kubernetes API \u652f\u6301\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u4ee5\u4e0b \u64cd\u4f5c \uff1a GET /<resourcePlural> - Retrieve a list of type . POST /<resourcePlural> - Create a new resource from the JSON object provided by the client. GET /<resourcePlural>/<name> - Retrieves a single resource with the given name. DELETE /<resourcePlural>/<name> - Delete the single resource with the given name. DELETE /<resourcePlural> - Deletes a list of type . PUT /<resourcePlural>/<name> - Update or create the resource with the given name with the JSON object provided by client. PATCH /<resourcePlural>/<name> - Selectively modify the specified fields of the resource. GET /<resourcePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. API \u662f RESTful \u7684\u578b\u5f0f\uff0c\u56e0\u6b64\u4e0a\u8ff0 HTTP \u65b9\u6cd5\u5728\u8cc7\u6e90\u64cd\u4f5c\u4e0a\u7684\u6620\u5c04\u61c9\u8a72\u770b\u8d77\u4f86\u5f88\u719f\u6089\u3002 Info \u5373\u4f7f\u6587\u6a94\u50c5\u63d0\u53ca JSON \u5c0d\u8c61\uff0c\u5982\u679c Content-Type \u6a19\u982d\u8a2d\u7f6e\u70ba application/yaml \uff0c\u5247\u652f\u6301\u63d0\u4ea4 YAML \u6709\u6548\u8ca0\u8f09\u3002 CREATE \u4ee5\u4e0b\u662f\u4f7f\u7528 curl \u548c YAML \u6e05\u55ae\u5275\u5efa\u65b0\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X POST \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"365d\"] ' READ \u4ee5\u4e0b\u662f\u5982\u4f55\u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4ee5\u53ca\u5982\u4f55\u901a\u904e\u540d\u7a31\u548c\u547d\u540d\u7a7a\u9593\u7372\u53d6\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4e00\u7a2e\u66f4\u9ad8\u7d1a\u7684\u6aa2\u7d22 Kubernetes \u8cc7\u6e90\u7684\u65b9\u6cd5\u662f\u6301\u7e8c\u89c0\u5bdf\u5b83\u5011\u7684\u8b8a\u5316\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments?watch = true \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key Info \u8acb\u6ce8\u610f\uff0c\u53ea\u80fd\u76e3\u8996\u4e00\u7d44\u8cc7\u6e90\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u63d0\u4f9b\u6a19\u7c64\u6216\u5b57\u6bb5\u9078\u64c7\u5668\u5c07\u7d50\u679c\u96c6\u7e2e\u5c0f\u5230\u55ae\u500b\u8cc7\u6e90\u3002 UPDATE \u4ee5\u4e0b\u662f\u66f4\u65b0\u73fe\u6709\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PUT \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"730d\"] # <-- Making it sleep twice longer ' \u4ee5\u4e0b\u662f\u5982\u4f55\u4fee\u88dc\u73fe\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PATCH \\ -H 'Content-Type: application/merge-patch+json' \\ -d '{ \"spec\": { \"template\": { \"spec\": { \"containers\": [ { \"name\": \"sleep\", \"image\": \"curlimages/curl\", \"command\": [\"/bin/sleep\", \"1d\"] } ] } } } }' Info \u8acb\u6ce8\u610f UPDATE \u548c PATCH \u662f\u76f8\u7576\u68d8\u624b\u7684\u64cd\u4f5c\u3002\u7b2c\u4e00\u500b\u53d7\u5230\u5404\u7a2e\u7248\u672c\u885d\u7a81\u7684\u5f71\u97ff\uff0c\u7b2c\u4e8c\u500b\u7684\u884c\u70ba\u56e0\u4f7f\u7528\u7684\u88dc\u4e01\u7b56\u7565\u800c\u7570\u3002 DELETE \u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f - \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u5c0d\u8c61\u96c6\u5408\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u55ae\u500b\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE How to call Kubernetes API using kubectl \u00b6 \u4e0a\u9762\u4f7f\u7528\u8b49\u66f8\u548c\u4ee4\u724c\u4f86\u547c\u53eb Kubernetes API \u5f88\u6709\u8da3\u3002\u81f3\u5c11\u7d93\u6b77\u4e00\u6b21\u662f\u4e00\u500b\u5f88\u597d\u7684\u7df4\u7fd2\uff0c\u53ef\u4ee5\u978f\u56fa\u5c0d\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u79fb\u52d5\u90e8\u4ef6\u7684\u7406\u89e3\u3002\u4f46\u662f\uff0c\u7576\u4f60\u6709\u4e00\u500b\u53ef\u4ee5\u4f7f\u7528\u7684 kubectl \u6642\uff0c\u6bcf\u5929\u90fd\u9019\u6a23\u505a\u53ef\u80fd\u6703\u6709\u9ede\u77ef\u6789\u904e\u6b63\u3002 Calling Kubernetes API using kubectl proxy \u00b6 \u4f7f\u7528\u6b63\u78ba\u914d\u7f6e\u7684 kubectl \u5de5\u5177\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl proxy \u547d\u4ee4\u5927\u5927\u7c21\u5316 API \u8a2a\u554f\u3002 kubectl proxy \u547d\u4ee4\u5728\u60a8\u7684 localhost \u548c Kubernetes API \u670d\u52d9\u5668 \u4e4b\u9593\u5275\u5efa\u4e00\u500b\u4ee3\u7406\u670d\u52d9\u5668\uff08\u6216\u61c9\u7528\u7a0b\u5e8f\u7d1a\u7db2\u95dc\uff09\u3002\u4f46\u5b83\u5fc5\u9808\u4e0d\u6b62\u65bc\u6b64\u3002\u4e0d\u7136\u600e\u9ebc\u6703\u9019\u9ebc\u65b9\u4fbf\uff1f \u4ee3\u7406 kubectl \u5f9e\u8abf\u7528\u8005\u90a3\u88e1\u5378\u8f09\u4e86\u76f8\u4e92\u7684\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u8cac\u4efb\u3002\u7531\u65bc\u8abf\u7528\u8005\u548c\u4ee3\u7406\u4e4b\u9593\u7684\u901a\u4fe1\u767c\u751f\u5728\u672c\u5730\u4e3b\u6a5f\u4e0a\uff0c\u56e0\u6b64\u5b83\u88ab\u8a8d\u70ba\u662f\u5b89\u5168\u7684\u3002\u4e26\u4e14\u4ee3\u7406\u672c\u8eab\u4f7f\u7528 kubeconfig \u6587\u4ef6\u4e2d\u9078\u64c7\u7684\u7576\u524d\u4e0a\u4e0b\u6587\u4e2d\u7684\u4fe1\u606f\u4f86\u8655\u7406\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u3002 $ kubectl config current-context minikube $ kubectl proxy --port = 8080 & \u555f\u52d5\u4ee3\u7406\u670d\u52d9\u5668\u5f8c\uff0c\u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u5c31\u8b8a\u5f97\u7c21\u55ae\u591a\u4e86\uff1a $ curl localhost:8080/apis/apps/v1/deployments { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"660883\" } , \"items\" : [ ... ] } Calling Kubernetes API using kubectl raw mode \u00b6 \u6211\u6700\u8fd1\u5b78\u5230\u7684\u53e6\u4e00\u500b\u5f88\u9177\u7684\u6280\u5de7\u662f\u4e00\u4e9b kubectl \u547d\u4ee4\u652f\u6301\u7684\u539f\u59cb\u6a21\u5f0f\uff1a # Sends HTTP GET request $ kubectl get --raw /api/v1/namespaces/default/pods # Sends HTTP POST request $ kubectl create --raw /api/v1/namespaces/default/pods -f file.yaml # Sends HTTP PUT request $ kubectl replace --raw /api/v1/namespaces/default/pods/mypod -f file.json # Sends HTTP DELETE request $ kubectl delete --raw /api/v1/namespaces/default/pods kubectl \u662f\u4e00\u500b\u975e\u5e38\u5148\u9032\u7684\u5de5\u5177\uff0c\u5373\u4f7f\u662f\u50cf kubectl \u9019\u6a23\u7684\u7c21\u55ae\u547d\u4ee4\u4e5f\u6709\u5927\u91cf\u4ee3\u78bc\u3002\u4f46\u662f\uff0c\u7576\u4f7f\u7528 --raw \u6a19\u8a8c\u6642\uff0c\u5be6\u73fe\u6b78\u7d50\u70ba\u5c07\u552f\u4e00\u7684\u53c3\u6578\u8f49\u63db\u70ba API \u7aef\u9ede URL \u4e26\u8abf\u7528\u539f\u59cb REST API \u5ba2\u6236\u7aef\u3002 Wrapping up \u00b6 \u7b2c\u4e00\u6b21\u8a2a\u554f Kubernetes API \u7684\u9700\u6c42\u53ef\u80fd\u5f88\u53ef\u6015 - \u6709\u5f88\u591a\u65b0\u6982\u5ff5\uff0c\u5982\u8cc7\u6e90\u3001API \u7d44\u3001\u7a2e\u985e\u3001\u5c0d\u8c61\u3001\u96c6\u7fa4\u3001\u4e0a\u4e0b\u6587\u3001\u8b49\u66f8\uff0c\u54e6\uff0c\u5929\u54ea\uff01\u4f46\u662f\u4e00\u65e6\u4f60\u5728\u69cb\u5efa\u584a\u4e0a\u5206\u89e3\u5b83\u4e26\u901a\u904e\u57f7\u884c\u4e00\u4e9b\u7463\u788e\u7684\u4efb\u52d9\uff08\u6bd4\u5982\u627e\u51fa API \u670d\u52d9\u5668\u5730\u5740\u6216\u4f7f\u7528 curl \u8abf\u7528\u4e00\u5806\u7aef\u9ede\uff09\u7372\u5f97\u4e00\u4e9b\u5be6\u8e10\u7d93\u9a57\uff0c\u4f60\u5f88\u5feb\u5c31\u6703\u610f\u8b58\u5230\u9019\u500b\u60f3\u6cd5\u52d5\u7269\u5712\u4e26\u4e0d\u662f\u771f\u7684\u4e00\u4e9b\u65b0\u7684\u6771\u897f\u2014\u2014\u5b83\u53ea\u662f\u591a\u5e74\u4f86\u70ba\u6211\u5011\u670d\u52d9\u7684\u773e\u6240\u5468\u77e5\u7684\u6a5f\u5236\u7684\u7d44\u5408 \u2014 REST \u67b6\u69cb\u98a8\u683c\u3001TLS \u8b49\u66f8\u3001JWT \u4ee4\u724c\u3001\u5c0d\u8c61\u65b9\u6848\u7b49\u3002 \u6240\u4ee5\uff0c\u4e0d\u8981\u5bb3\u6015\u4e26\u904b\u884c\u4e00\u4e9b\u67e5\u8a62\uff01 Info \u8feb\u4e0d\u53ca\u5f85\u60f3\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8abf\u7528 API\uff1f\u5728 GitHub \u4e0a\u67e5\u770b\u6211\u6536\u96c6\u7684 Kubernetes \u5ba2\u6236\u7aef\u793a\u4f8b \ud83d\ude09 Resources \u00b6 Kubernetes Documentation - Access Clusters Using the Kubernetes API Kubernetes Documentation - Configure Access to Multiple Clusters Kubernetes Documentation - Authenticating Kubernetes Documentation - Controlling Access to the Kubernetes API Kubernetes Documentation - Configure Service Accounts for Pods Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"\u7528 HTTP \u5ba2\u6236\u7aef\u8abf\u7528 K8S API"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#http-kubernetes-api","text":"\u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-call-simple-http-client/ \u4f7f\u7528 CLI\uff08\u5982 curl\uff09\u6216 GUI\uff08\u5982 postman\uff09HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API \u6709\u5f88\u591a\u4f7f\u7528\u60c5\u5883\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u6bd4 kubectl \u63d0\u4f9b\u7684\u66f4\u7d30\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u6216\u8005\u53ea\u662f\u60f3\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u8a2a\u554f API \u4e4b\u524d\u63a2\u7d22\u5b83\u3002 \u672c\u6587\u4e0d\u50c5\u50c5\u662f\u4e00\u500b\u65b9\u4fbf\u7684\u547d\u4ee4\u5217\u8868\uff0c\u800c\u662f\u4e00\u500b\u6df1\u601d\u719f\u616e\u7684\u6f14\u7df4\uff0c\u63ed\u793a\u4e86\u4e00\u4e9b\u60a8\u5728\u5f9e\u547d\u4ee4\u884c\u8abf\u7528 Kubernetes API \u6642\u53ef\u80fd\u6703\u5076\u7136\u767c\u73fe\u7684\u6709\u8da3\u554f\u984c\u3002\u5b83\u6db5\u84cb\u4ee5\u4e0b\u4e3b\u984c\uff1a \u5982\u4f55\u7372\u53d6 Kubernetes API \u670d\u52d9\u5668\u5730\u5740 \u5982\u4f55\u5411\u5ba2\u6236\u7aef\u9a57\u8b49 API \u670d\u52d9\u5668 \u5982\u4f55\u4f7f\u7528\u8b49\u66f8 (certificate) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u4f7f\u7528\u4ee4\u724c (token) \u5411 API \u670d\u52d9\u5668\u9a57\u8b49\u5ba2\u6236\u7aef \u5982\u4f55\u5f9e Pod \u5167\u90e8\u8abf\u7528 Kubernetes API \u5982\u4f55\u4f7f\u7528 curl \u5c0d Kubernetes \u5c0d\u8c61\u57f7\u884c\u57fa\u672c\u7684 CRUD \u64cd\u4f5c \u5982\u4f55\u4f7f\u7528 kubectl \u7684 raw \u6a21\u5f0f\u76f4\u63a5\u8a2a\u554f Kubernetes API \u5982\u4f55\u67e5\u770b\u54ea\u4e9b API \u8acb\u6c42 kubectl \u547d\u4ee4\uff08\u5982 apply \u767c\u9001\uff09","title":"\u7528 HTTP \u5ba2\u6236\u7aef\u8abf\u7528 Kubernetes API"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#setting-up-kubernetes-playground","text":"\u5982\u679c\u4f60\u6c92\u6709 Kubernetes \u96c6\u7fa4\u53ef\u4ee5\u73a9\uff0c\u9019\u88e1\u662f\u4f60\u53ef\u4ee5\u4f7f\u7528 arkade \u5feb\u901f\u5275\u5efa\u672c\u5730\u904a\u6a02\u5834\u7684\u65b9\u6cd5\uff1a $ curl -sLS https://get.arkade.dev | sudo sh $ arkade get minikube kubectl $ minikube start --profile cluster1","title":"Setting up Kubernetes playground"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#how-to-get-kubernetes-api-host-and-port","text":"\u8981\u8abf\u7528\u4efb\u4f55 API\uff0c\u60a8\u9996\u5148\u9700\u8981\u77e5\u9053\u5176\u670d\u52d9\u5668\u5730\u5740\u3002\u5c0d\u65bc Kubernetes\uff0c\u6bcf\u500b\u96c6\u7fa4\u90fd\u6709\u4e00\u500b API \u670d\u52d9\u5668\u3002\u56e0\u6b64\uff0c\u67e5\u627e API \u4e3b\u6a5f\u548c\u7aef\u53e3\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u67e5\u770b kubectl cluster-info \u8f38\u51fa\u3002\u4f8b\u5982\uff0c\u5728\u6211\u7684 Vagrant \u76d2\u5b50\u4e0a\uff0c\u5b83\u6703\u7522\u751f\u4ee5\u4e0b\u8a0a\u606f\uff1a $ kubectl cluster-info Kubernetes control plane is running at https://192.168.49.2:8443 CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy ... cluster-info \u547d\u4ee4\u986f\u793a\u5728 \u7576\u524d\u4e0a\u4e0b\u6587 \u4e2d\u9078\u64c7\u7684\u96c6\u7fa4\u7684 API \u5730\u5740\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u6709\u591a\u500b\u96c6\u7fa4\u600e\u9ebc\u8fa6\uff1f $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority: /home/dxlab/.minikube/ca.crt extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: cluster_info server: https://192.168.49.2:8443 name: minikube contexts: - context: cluster: minikube extensions: - extension: last-update: Tue, 28 Jun 2022 05 :55:10 CST provider: minikube.sigs.k8s.io version: v1.25.2 name: context_info namespace: default user: minikube name: minikube current-context: minikube kind: Config preferences: {} users: - name: minikube user: client-certificate: /home/dxlab/.minikube/profiles/minikube/client.crt client-key: /home/dxlab/.minikube/profiles/minikube/client.key Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c kubectl \u5728 $HOME/.kube \u76ee\u9304\u4e2d\u67e5\u627e\u540d\u70ba config \u7684\u6587\u4ef6\u3002\u90a3\u9ebc\uff0c\u70ba\u4ec0\u9ebc\u4e0d\u76f4\u63a5\u5f9e\u9019\u500b\u6587\u4ef6\u4e2d\u7372\u53d6 API \u5730\u5740\u5462\uff1f \u539f\u56e0\u662f\u6f5b\u5728\u7684\u914d\u7f6e\u5408\u4f75\u3002\u901a\u904e\u5c07 KUBECONFIG env var \u8a2d\u7f6e\u70ba\u4ee5\u5192\u865f\u5206\u9694\u7684\u4f4d\u7f6e\u5217\u8868\uff0c\u53ef\u4ee5\u6307\u5b9a\u591a\u500b kubeconfig \u6587\u4ef6\u3002\u5728\u8a2a\u554f\u96c6\u7fa4\u4e4b\u524d\uff0c kubectl \u6703\u5617\u8a66\u5c07\u6240\u6709 kubeconfig \u6587\u4ef6\u7684\u5167\u5bb9\u5408\u4f75\u5230\u4e00\u500b\u914d\u7f6e\u4e2d\u3002 \u56e0\u6b64\uff0c\u5f9e\u4e0a\u9762\u7684\u5217\u8868\u4e2d\u9078\u64c7\u6b63\u78ba\u7684\u96c6\u7fa4\uff0c\u8b93\u6211\u5011\u5617\u8a66\u5411\u5176 API \u670d\u52d9\u5668\u767c\u9001\u8acb\u6c42\uff1a $ KUBE_API = $( kubectl config view -o jsonpath = '{.clusters[0].cluster.server}' )","title":"How to get Kubernetes API host and port"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#how-to-call-kubernetes-api-using-curl","text":"\u5be6\u969b\u4e0a\uff0c\u4efb\u4f55 HTTP \u5ba2\u6236\u7aef\uff08curl\u3001httpie\u3001wget \u751a\u81f3 postman\uff09\u90fd\u53ef\u4ee5\uff0c\u4f46\u6211\u5c07\u5728\u672c\u7bc0\u4e2d\u4f7f\u7528 curl \u3002","title":"How to call Kubernetes API using curl"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#authenticating-api-server-to-client","text":"\u8b93\u6211\u5011\u5f9e\u67e5\u8a62 API \u7684 /version \u7aef\u9ede\u958b\u59cb\uff1a $ curl $KUBE_API /version curl: ( 60 ) SSL certificate problem: unable to get local issuer certificate More details here: https://curl.se/docs/sslcerts.html curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it. To learn more about this situation and how to fix it, please visit the web page mentioned above. \u5f88\u986f\u7136\u2026\u2026\u6211\u5011\u9023\u63a5\u5931\u6557\u4e86\uff01 \ud83d\ude48 \u7576\u6211\u7b2c\u4e00\u6b21\u5076\u7136\u767c\u73fe\u985e\u4f3c\u7684\u932f\u8aa4\u6642\uff0c\u6211\u771f\u7684\u5f88\u56f0\u60d1\u3002\u4f46\u4ed4\u7d30\u60f3\u60f3\uff0c\u4e0a\u8ff0\u932f\u8aa4\u5be6\u969b\u4e0a\u662f\u6709\u9053\u7406\u7684\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cKubernetes \u901a\u904e HTTPS \u516c\u958b\u5176 API\uff0c\u7279\u5225\u662f\u70ba\u4e86\u5411\u5ba2\u6236\u7aef\u4fdd\u8b49 API \u670d\u52d9\u5668\u7684\u5f37\u8eab\u4efd\u3002\u4f46\u662f\uff0cminikube \u4f7f\u7528\u81ea\u7c3d\u540d\u8b49\u66f8\u4f86\u8a2d\u5b9a\u672c\u5730\u96c6\u7fa4\u3002\u56e0\u6b64\uff0cKubernetes API \u670d\u52d9\u5668\u7684 TLS \u8b49\u66f8\u539f\u4f86\u662f\u7531\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u7c3d\u7f72\u7684(self-signed)\uff0c\u8a72\u8b49\u66f8\u9812\u767c\u6a5f\u69cb (CA) minikubeCA \u5c0d curl \u662f\u672a\u77e5\u7684 \u3002curl \u7121\u6cd5\u4fe1\u4efb\u5b83\uff0c\u56e0\u6b64\u8acb\u6c42\u5931\u6557\u3002 Info \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0ccurl \u4fe1\u4efb\u5e95\u5c64\u64cd\u4f5c\u7cfb\u7d71\u6240\u4fe1\u4efb\u7684\u540c\u4e00\u7d44 CA\u3002\u4f8b\u5982\uff0c\u5728 Ubuntu \u6216 Debian \u4e0a\uff0c\u53ef\u4ee5\u5728 /etc/ssl/certs/ca-certificates.crt \u4e2d\u627e\u5230\u53d7\u4fe1\u4efb\u7684 CA \u5217\u8868\u3002\u986f\u7136\uff0cminikube \u4e0d\u6703\u5c07\u5176\u8b49\u66f8\u6dfb\u52a0\u5230\u6b64\u6587\u4ef6\u4e2d\u3002 \u5e78\u904b\u7684\u662f\uff0cminikube \u5c07 CA \u8b49\u66f8\u4fdd\u5b58\u5230 ~/.minikube/ca.crt \uff1a $ cat ~/.minikube/ca.crt | openssl x509 -text \u7d50\u679c: Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 1 ( 0x1 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 12 06 :14:14 2022 GMT Not After : Jun 10 06 :14:14 2032 GMT Subject: CN = minikubeCA Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :c2:ee:45:b9:c6:63:1f:15:d5:e7:22:5a:92:48: 86 :23:db:0c:a2:0c:e5:e9:b4:9b:29:75:04:c0:e2: 2b:f2:8e:2a:8a:47:06:6e:81:d0:13:90:0a:08:71: 99 :23:01:57:47:9b:1d:00:8f:95:50:20:97:13:6c: 32 :42:b5:04:c8:3a:0b:5d:30:9c:55:bd:28:53:1b: 87 :de:04:a7:04:18:e9:16:38:47:38:aa:a7:08:35: 1c:62:c3:e5:2d:89:ae:0b:e3:3b:9d:be:a2:b8:3b: e6:81:ac:75:12:fe:f7:9b:a1:1b:a8:46:f7:9d:b8: ce:41:2b:95:de:98:1b:52:a6:59:b9:54:ce:60:d6: f3:2b:a5:b8:43:e1:ca:87:5c:8c:61:f8:59:4b:47: 1c:73:20:ad:3d:8e:fa:0e:a2:c5:b7:2d:8b:9a:85: 3f:6c:39:46:16:e8:4f:a9:91:e2:86:02:f3:2d:66: 7d:6c:74:66:23:7a:34:24:85:d9:f6:20:b0:39:7d: 68 :86:d0:67:f1:90:df:ab:bd:52:85:5c:bb:99:a0: ab:b9:a5:bd:1e:08:69:8e:7e:e2:e0:d5:f2:a5:40: 76 :e7:03:de:aa:e3:f9:16:11:c9:ed:a3:8f:9a:c3: 48 :44:20:5e:4c:8d:13:fa:a0:f7:68:86:f5:8f:5f: 97 :3f Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment, Certificate Sign X509v3 Extended Key Usage: TLS Web Client Authentication, TLS Web Server Authentication X509v3 Basic Constraints: critical CA:TRUE X509v3 Subject Key Identifier: 70 :53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption 56 :3c:de:59:09:ce:7b:bf:92:b0:fd:44:ca:e7:83:48:a2:f8: a7:3d:01:b2:62:50:62:cb:c0:7c:33:5d:25:a2:f4:46:af:88: b0:02:db:84:e6:4c:cb:a3:74:46:ed:ef:96:48:15:f9:cb:d7: 07 :42:0e:b0:3f:bf:bd:2b:e6:02:66:9c:a6:b4:5c:de:f9:0a: 5b:68:cc:7a:0f:ea:1a:b5:4e:ff:ff:95:f7:b9:c4:a1:1f:e5: 76 :62:f4:c7:82:2d:9d:a6:79:99:95:f2:f7:77:58:11:87:0a: 76 :88:e3:32:fe:4a:18:99:fd:a2:b8:50:29:fb:4a:f5:74:4c: b2:0c:b5:42:75:93:6c:b9:80:db:10:8b:3e:49:c2:f2:15:84: e4:0f:fd:9b:21:05:ed:0e:66:85:04:58:ff:d8:c3:e9:e4:44: c4:30:28:fa:7f:b8:79:3c:8e:c3:28:64:cd:6c:ea:db:57:a2: e9:b3:26:2a:d2:18:4e:f5:b9:1d:23:48:cf:be:f7:85:6c:7e: dd:c8:85:78:ae:92:a7:1e:2c:0e:2a:c6:5f:3a:9c:84:8f:2d: cd:20:ac:30:a6:79:f3:4d:08:8e:e3:93:32:81:01:dc:c5:7b: 0d:a8:d8:e3:13:0b:d6:68:1f:3e:69:10:16:4a:9e:77:4a:61: 8f:94:e5:3c -----BEGIN CERTIFICATE----- MIIDBjCCAe6gAwIBAgIBATANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYxMjA2MTQxNFoXDTMyMDYxMDA2MTQxNFowFTETMBEGA1UE AxMKbWluaWt1YmVDQTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAMLu RbnGYx8V1eciWpJIhiPbDKIM5em0myl1BMDiK/KOKopHBm6B0BOQCghxmSMBV0eb HQCPlVAglxNsMkK1BMg6C10wnFW9KFMbh94EpwQY6RY4Rziqpwg1HGLD5S2Jrgvj O52+org75oGsdRL+95uhG6hG9524zkErld6YG1KmWblUzmDW8yuluEPhyodcjGH4 WUtHHHMgrT2O+g6ixbcti5qFP2w5RhboT6mR4oYC8y1mfWx0ZiN6NCSF2fYgsDl9 aIbQZ/GQ36u9UoVcu5mgq7mlvR4IaY5+4uDV8qVAducD3qrj+RYRye2jj5rDSEQg XkyNE/qg92iG9Y9flz8CAwEAAaNhMF8wDgYDVR0PAQH/BAQDAgKkMB0GA1UdJQQW MBQGCCsGAQUFBwMCBggrBgEFBQcDATAPBgNVHRMBAf8EBTADAQH/MB0GA1UdDgQW BBRwU4aOAa7jT1ePsDDDMbBeMdt/ljANBgkqhkiG9w0BAQsFAAOCAQEAVjzeWQnO e7+SsP1EyueDSKL4pz0BsmJQYsvAfDNdJaL0Rq+IsALbhOZMy6N0Ru3vlkgV+cvX B0IOsD+/vSvmAmacprRc3vkKW2jMeg/qGrVO//+V97nEoR/ldmL0x4ItnaZ5mZXy 93dYEYcKdojjMv5KGJn9orhQKftK9XRMsgy1QnWTbLmA2xCLPknC8hWE5A/9myEF 7Q5mhQRY/9jD6eRExDAo+n+4eTyOwyhkzWzq21ei6bMmKtIYTvW5HSNIz773hWx+ 3ciFeK6Spx4sDirGXzqchI8tzSCsMKZ5800IjuOTMoEB3MV7DajY4xML1mgfPmkQ Fkqed0phj5TlPA == -----END CERTIFICATE----- \u56e0\u6b64\uff0c\u8981\u4fee\u5fa9 GET /version \u8acb\u6c42\u7684\u554f\u984c\uff0c\u6211\u53ea\u9700\u8981\u901a\u904e\u624b\u52d5\u5c07\u5176\u6307\u5411 minikubeCA \u8b49\u66f8\u4f86\u4f7f curl \u4fe1\u4efb API \u670d\u52d9\u5668\u8b49\u66f8\u7684\u9812\u767c\u8005\uff1a $ curl --cacert ~/.minikube/ca.crt $KUBE_API /version { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } Info \u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5728\u3000 curl \u547d\u4ee4\u4e2d\u4f7f\u7528 --insecure \u6a19\u8a8c\u6216\u5176\u77ed\u5225\u540d -k \u3002\u5728\u5b89\u5168\u7684\u74b0\u5883\u4e2d\uff0c\u6211\u66f4\u559c\u6b61 insecure mode\uff0c\u5b83\u6bd4\u8a66\u5716\u627e\u5230\u9812\u767c\u8005\u8b49\u66f8\u66f4\u7c21\u55ae\u3002","title":"Authenticating API server to client"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#authenticating-using-certificates","text":"\u597d\u7684\uff0c\u8b93\u6211\u5011\u5617\u8a66\u4e00\u4e9b\u66f4\u8907\u96dc\u7684\u6771\u897f\u3002\u5217\u51fa\u96c6\u7fa4\u4e2d\u7684\u6240\u6709\u90e8\u7f72\u600e\u9ebc\u6a23\uff1f $ curl --cacert ~/.minikube/ca.crt $KUBE_API /apis/apps/v1/deployments { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:anonymous\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" at the cluster scope\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u8207\u660e\u986f\u4e0d\u53d7\u4fdd\u8b77\u7684 /version \u7aef\u9ede\u4e0d\u540c\uff0cKubernetes \u901a\u5e38\u6703\u9650\u5236\u5c0d\u5176 API \u7aef\u9ede\u7684\u8a2a\u554f\u3002 \u5f9e\u932f\u8aa4\u6d88\u606f\u4e2d\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u51fa\uff0c\u8a72\u8acb\u6c42\u88ab\u9a57\u8b49\u70ba\u7528\u6236 system:anonymous \uff0c\u986f\u7136\uff0c\u8a72\u7528\u6236\u672a\u6388\u6b0a\u53ef\u547c\u53eb\u5217\u51fa\u90e8\u7f72\u8cc7\u6e90\u7684 API \u6b0a\u9650\u3002 \u9019\u500b\u5931\u6557\u7684\u8acb\u6c42\u5c0e\u56e0\u65bc\u6211\u5011\u4e26\u672a\u6aa2\u9644\u4efb\u4f55\u8eab\u4efd\u9a57\u8b49\u8cc7\u8a0a\uff08\u5118\u7ba1\u5982\u6b64\uff0c\u5b83\u5df2\u7d93\u904e\u8eab\u4efd\u9a57\u8b49\uff0c\u4f46\u4f5c\u70ba\u533f\u540d\u7528\u6236\uff09\uff0c\u6240\u4ee5\u6211\u9700\u8981\u63d0\u4f9b\u4e00\u4e9b\u984d\u5916\u7684\u4fe1\u606f\u4f86\u7372\u5f97\u6240\u9700\u7684\u8a2a\u554f\u7d1a\u5225\u3002 Kubernetes \u652f\u6301\u591a\u7a2e \u8eab\u4efd\u9a57\u8b49\u6a5f\u5236 \uff0c\u6211\u5c07\u5f9e\u4f7f\u7528\u5ba2\u6236\u7aef\u8b49\u66f8(client certificate)\u5c0d\u8acb\u6c42\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u958b\u59cb\u3002 \u4f46\u662f\u7b49\u4e00\u4e0b\uff01\u4ec0\u9ebc\u662f\u5ba2\u6236\u8b49\u66f8(client certificate)\uff1f \u7576 minikube \u8a2d\u5b9a\u96c6\u7fa4\u6642\uff0c\u5b83\u9084\u5275\u5efa\u4e86\u4e00\u500b \u7528\u6236 \u3002\u8a72 \u7528\u6236 \u7372\u5f97\u4e86\u7531\u540c\u4e00\u500b minikubeCA \u9812\u767c\u6a5f\u69cb\u7c3d\u7f72\u7684\u8b49\u66f8\u3002\u7531\u65bc Kubernetes API \u670d\u52d9\u5668\u4fe1\u4efb\u6b64 CA\uff0c\u56e0\u6b64\u5728\u8acb\u6c42\u4e2d\u63d0\u4f9b\u6b64\u8b49\u66f8\u5c07\u4f7f\u5176\u4f5c\u70ba\u6240\u8ff0\u7528\u6236\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 Info Kubernetes \u6c92\u6709\u4ee3\u8868 \u7528\u6236 \u7684\u5c0d\u8c61\u3002\u5373\u4e0d\u80fd\u901a\u904e API \u8abf\u7528\u5c07\u7528\u6236\u6dfb\u52a0\u5230\u96c6\u7fa4\u4e2d\u3002\u4f46\u662f\uff0c\u4efb\u4f55\u63d0\u4f9b\u7531\u96c6\u7fa4\u7684\u8b49\u66f8\u9812\u767c\u6a5f\u69cb\u7c3d\u540d\u7684\u6709\u6548\u8b49\u66f8\u7684\u7528\u6236\u90fd\u88ab\u8996\u70ba\u5df2\u901a\u904e\u8eab\u4efd\u9a57\u8b49\u3002 Kubernetes \u5f9e\u8b49\u66f8\u4e3b\u984c\u4e2d\u7684\u901a\u7528\u540d\u7a31\u5b57\u6bb5\u4e2d\u7372\u53d6\u7528\u6236\u540d\uff08\u4f8b\u5982\uff0cCN = minikube-user\uff09\u3002\u7136\u5f8c\uff0cKubernetes RBAC \u5b50\u7cfb\u7d71\u5224\u65b7\u7528\u6236\u662f\u5426\u6709\u6b0a\u5c0d\u8cc7\u6e90\u57f7\u884c\u7279\u5b9a\u64cd\u4f5c\u3002 \u7528\u6236\u8b49\u66f8\u901a\u5e38\u53ef\u4ee5\u5728\u6211\u5011\u5df2\u7d93\u719f\u6089\u7684 kubectl \u914d\u7f6e\u8996\u5716\u8f38\u51fa\u4e2d\u627e\u5230\uff1a $ kubectl config view -o jsonpath = '{.users[0]}' | jq { \"name\" : \"minikube\" , \"user\" : { \"client-certificate\" : \"/home/dxlab/.minikube/profiles/minikube/client.crt\" , \"client-key\" : \"/home/dxlab/.minikube/profiles/minikube/client.key\" } } \u8b93\u6211\u5011\u5feb\u901f\u6aa2\u67e5\u8b49\u66f8\u5167\u5bb9\u4ee5\u78ba\u4fdd\u5b83\u662f\u7531\u540c\u4e00\u500b CA \u7c3d\u540d\u7684\uff1a $ cat ~/.minikube/profiles/cluster1/client.crt | openssl x509 -text Certificate: Data: Version: 3 ( 0x2 ) Serial Number: 2 ( 0x2 ) Signature Algorithm: sha256WithRSAEncryption Issuer: CN = minikubeCA Validity Not Before: Jun 26 21 :54:59 2022 GMT Not After : Jun 26 21 :54:59 2025 GMT Subject: O = system:masters, CN = minikube-user Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: ( 2048 bit ) Modulus: 00 :a6:eb:74:10:82:be:42:94:2b:db:72:a6:17:7d: a5:9e:b4:d1:1b:34:c5:a4:71:ff:03:68:1b:1e:cb: 77 :57:bb:6f:fd:0e:d7:b5:62:8f:c8:66:22:36:7d: 01 :d3:f3:4b:3d:84:6a:03:0b:6f:e4:8e:3d:50:24: a4:ad:e0:89:1a:3f:05:af:d8:67:63:9d:44:92:73: 93 :ef:65:08:7e:05:76:45:69:6e:e7:b8:50:81:b6: 8b:82:a7:85:9b:9d:84:2d:db:d5:f5:73:a9:eb:08: a5:0b:f2:61:b8:66:a5:f9:84:09:68:8d:9f:56:8e: 1f:a7:71:f6:4f:67:31:03:8d:a2:17:2a:42:f4:de: 96 :11:2e:22:da:fa:f6:26:f2:de:7b:99:bb:66:b3: d0:3e:4a:f6:c3:7e:6d:0f:d5:ef:44:54:fd:7f:c1: c9:65:f7:7f:d4:50:73:2b:2a:ce:84:19:b0:a7:8a: 66 :cb:ed:f8:60:3a:4a:ac:36:e6:5a:8f:21:eb:4f: f8:fd:db:d3:55:d8:41:a9:34:00:20:9f:eb:9c:58: fd:32:0c:d5:a8:3d:13:82:5c:ef:5c:e6:a5:ac:a8: fb:71:ec:1a:d1:db:ad:f9:2c:40:3b:ee:59:0f:70: 36 :b1:8a:ab:95:1e:e6:0b:1e:01:c4:ab:a7:5c:c6: 10 :43 Exponent: 65537 ( 0x10001 ) X509v3 extensions: X509v3 Key Usage: critical Digital Signature, Key Encipherment X509v3 Extended Key Usage: TLS Web Server Authentication, TLS Web Client Authentication X509v3 Basic Constraints: critical CA:FALSE X509v3 Authority Key Identifier: keyid:70:53:86:8E:01:AE:E3:4F:57:8F:B0:30:C3:31:B0:5E:31:DB:7F:96 Signature Algorithm: sha256WithRSAEncryption a3:4e:82:61:63:b9:bc:5c:3f:ba:4d:00:ae:b4:f0:a7:a3:9f: 39 :5b:2b:82:0c:4f:d8:a6:ef:07:45:de:b1:0f:85:70:50:8c: b3:9f:1f:a6:31:34:20:ee:59:89:3b:c5:03:5f:f0:8a:1c:b5: c4:44:c6:45:c4:f4:51:1c:28:4b:b0:0b:52:41:55:4a:04:06: 38 :0d:ab:65:e7:7a:6f:0b:eb:3c:7e:92:7f:f8:30:b8:73:dd: 62 :1c:19:f4:66:ff:88:57:f8:10:23:1b:c1:42:04:41:a1:94: 13 :d3:51:bb:8f:52:bf:f3:ff:50:66:cf:9e:e0:d4:1e:0b:44: 7f:e3:8e:2a:b9:07:62:a3:98:e1:50:c6:82:71:de:da:c8:83: 4a:6d:8f:78:f7:aa:53:5c:ed:68:db:b5:09:b2:1b:94:80:50: 71 :12:cb:92:c2:a3:5f:f1:9d:12:4f:b0:0a:08:39:25:d9:19: b3:ca:15:51:d6:01:b6:7d:58:81:cc:b5:85:47:b0:ff:d4:b3: 63 :ce:2e:b9:12:eb:c6:0e:c3:5f:88:62:7c:39:5f:2d:c5:d1: 56 :a6:68:7b:c1:29:5c:69:dc:ee:cf:af:92:6b:ad:3c:e8:bd: 6c:b9:1e:9d:35:3a:93:c1:4a:f2:64:d2:1b:bb:79:48:bc:89: 51 :81:0d:da -----BEGIN CERTIFICATE----- MIIDITCCAgmgAwIBAgIBAjANBgkqhkiG9w0BAQsFADAVMRMwEQYDVQQDEwptaW5p a3ViZUNBMB4XDTIyMDYyNjIxNTQ1OVoXDTI1MDYyNjIxNTQ1OVowMTEXMBUGA1UE ChMOc3lzdGVtOm1hc3RlcnMxFjAUBgNVBAMTDW1pbmlrdWJlLXVzZXIwggEiMA0G CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCm63QQgr5ClCvbcqYXfaWetNEbNMWk cf8DaBsey3dXu2/9Dte1Yo/IZiI2fQHT80s9hGoDC2/kjj1QJKSt4IkaPwWv2Gdj nUSSc5PvZQh+BXZFaW7nuFCBtouCp4WbnYQt29X1c6nrCKUL8mG4ZqX5hAlojZ9W jh+ncfZPZzEDjaIXKkL03pYRLiLa+vYm8t57mbtms9A+SvbDfm0P1e9EVP1/wcll 93 /UUHMrKs6EGbCnimbL7fhgOkqsNuZajyHrT/j929NV2EGpNAAgn+ucWP0yDNWo PROCXO9c5qWsqPtx7BrR2635LEA77lkPcDaxiquVHuYLHgHEq6dcxhBDAgMBAAGj YDBeMA4GA1UdDwEB/wQEAwIFoDAdBgNVHSUEFjAUBggrBgEFBQcDAQYIKwYBBQUH AwIwDAYDVR0TAQH/BAIwADAfBgNVHSMEGDAWgBRwU4aOAa7jT1ePsDDDMbBeMdt/ ljANBgkqhkiG9w0BAQsFAAOCAQEAo06CYWO5vFw/uk0ArrTwp6OfOVsrggxP2Kbv B0XesQ+FcFCMs58fpjE0IO5ZiTvFA1/wihy1xETGRcT0URwoS7ALUkFVSgQGOA2r Zed6bwvrPH6Sf/gwuHPdYhwZ9Gb/iFf4ECMbwUIEQaGUE9NRu49Sv/P/UGbPnuDU HgtEf+OOKrkHYqOY4VDGgnHe2siDSm2PePeqU1ztaNu1CbIblIBQcRLLksKjX/Gd Ek+wCgg5JdkZs8oVUdYBtn1Ygcy1hUew/9SzY84uuRLrxg7DX4hifDlfLcXRVqZo e8EpXGnc7s+vkmutPOi9bLkenTU6k8FK8mTSG7t5SLyJUYEN2g == -----END CERTIFICATE----- \u4e0b\u9762\u662f\u5982\u4f55\u4f7f\u7528 curl \u5411 Kubernetes API \u670d\u52d9\u5668\u767c\u9001\u7531\u8a72\u8b49\u66f8\u8a8d\u8b49\u7684\u8acb\u6c42\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"654514\" } , \"items\" : [ ... ] - \"iss\" ( Issuer ) Claim - The \"iss\" ( issuer ) claim identifies the principal that issued the JWT. - \"sub\" ( Subject ) Claim -The \"sub\" ( subject ) claim identifies the principal that is the subject of the JWT. }","title":"Authenticating using Certificates"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#authenticating-using-service-account-tokens","text":"\u53e6\u4e00\u7a2e\u9a57\u8b49 API \u8acb\u6c42\u7684\u65b9\u6cd5\u662f\u4f7f\u7528 \u670d\u52d9\u5e33\u6236 \u7684 JWT \u4ee4\u724c\u3002\u8207\u7528\u6236\u975e\u5e38\u76f8\u4f3c\uff0c\u4e0d\u540c\u7684 \u670d\u52d9\u5e33\u6236 \u5177\u6709\u4e0d\u540c\u7d1a\u5225\u7684\u8a2a\u554f\u6b0a\u9650\u3002\u8b93\u6211\u5011\u770b\u770b\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u9ed8\u8a8d\u670d\u52d9\u5e33\u6236\u53ef\u4ee5\u5be6\u73fe\u4ec0\u9ebc\uff1a $ JWT_TOKEN_DEFAULT_DEFAULT = $( kubectl get secrets \\ $( kubectl get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_DEFAULT_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tNng1ZHEiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImRiZjA0ZDczLWZlOTctNDMzMi04NDM2LWVjNDdlMDZkYzE2MSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.pkJ-AZufRuGcMGXwtL7jQu0BOa6DGgylzTjGcKQcOESjXeTsZfw8pnwHMOJsiV760QMLY33GtpzLy0om5l4gfU1O-CJZXKTaYCHzjyEb6ZVLK0xLeLwsW--LI_Weo0X9KiAjNBqDSUmj8NYHn2-c-wygN6IYWqbT8MmXL-YC8dejeqUlLzAQUw8hZasdWN6KLnmNxhI0-cntp0C8O2I5SPumOxq7IEX8s2Erir2cU2xGI-LPaMm8ccAk5wrKS9rqk23G24vXFgi9u1SwtujC_hZrki_rm8yrMUWvOa5SPZqAag_dkjLXR5YSxF_nJO69XGJ1fId3hr2ruHBTivbfEQ \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"default\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-6x5dq\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"dbf04d73-fe97-4332-8436-ec47e06dc161\" , \"sub\" : \"system:serviceaccount:default:default\" } \u5f9e\u4e00\u500b\u7c21\u55ae\u7684\u4efb\u52d9\u958b\u59cb - \u5728 apps/v1 \u4e2d\u5217\u51fa\u5df2\u77e5\u7684 API \u8cc7\u6e90\u985e\u578b\uff1a $ curl $KUBE_API /apis/apps/v1/ \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"APIResourceList\" , \"apiVersion\" : \"v1\" , \"groupVersion\" : \"apps/v1\" , \"resources\" : [ ... ] } \u63a5\u8457\u8b93\u6211\u5011\u5617\u8a66\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa\u5be6\u969b\u7684\u90e8\u7f72\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_DEFAULT_DEFAULT \" { \"kind\" : \"Status\" , \"apiVersion\" : \"v1\" , \"metadata\" : {} , \"status\" : \"Failure\" , \"message\" : \"deployments.apps is forbidden: User \\\"system:serviceaccount:default:default\\\" cannot list resource \\\"deployments\\\" in API group \\\"apps\\\" in the namespace \\\"default\\\"\" , \"reason\" : \"Forbidden\" , \"details\" : { \"group\" : \"apps\" , \"kind\" : \"deployments\" } , \"code\" : 403 } \u986f\u7136\uff0c\u7528\u6236 system:serviceaccount:default:default \u751a\u81f3\u4e0d\u8db3\u4ee5\u5728\u5176\u81ea\u5df1\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u5217\u51fa Kubernetes \u5c0d\u8c61\u3002 \u8b93\u6211\u5011\u5617\u8a66\u4e00\u500b\u5f37\u5927\u7684 kube-system \u670d\u52d9\u5e33\u6236\uff1a $ JWT_TOKEN_KUBESYSTEM_DEFAULT = $( kubectl -n kube-system get secrets \\ $( kubectl -n kube-system get serviceaccounts/default -o jsonpath = '{.secrets[0].name}' ) \\ -o jsonpath = '{.data.token}' | base64 --decode ) \u628a JWT \u4ee4\u724c\u6253\u5370\u51fa\u4f86\u770b: $ echo $JWT_TOKEN_KUBESYSTEM_DEFAULT eyJhbGciOiJSUzI1NiIsImtpZCI6IjFVa2pVaUVUS25JSzFNT1V0RW1zTWEyT0F3MTFSaFNneUVobXk0dUhjUEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkZWZhdWx0LXRva2VuLW16bWo3Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRlZmF1bHQiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJhN2E4YTc1Mi1jNjQ5LTRkOGYtOTQzMi03MDgxYjE4YzBiNTIiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06ZGVmYXVsdCJ9.talXOCcsaH5VaZEOJo-VilVZUhM6YWrChmKScXHcTwDfVBmX6XlrelomnYMUtwahnF1aGe_vJpLzk-SJhvdLvFSAvw0pIWxsabes7ITfCdOfAMliPhiCIOC4XwawKWmbVJYcvhHppNA41qzNAbtav_e9qB6z84fmAQHQJLITMmMfe-ZC38I3sWh5ezoo-1uiV3iY6SHxd4WGXmuRBqkvWxJM7JiC2TmUU9Z6K4gfrRtfBrB2-A3Ti6v7Jcqwxakqq092X7VpstmJTHgh6KExm-0laIUSOKwUFlFvs4-MYKwmbYdz4IYDxJejZjcfC8XkTM6nQPaXdaTA6olKBzKHKg \u5176\u4e2d payload \u7684\u8cc7\u8a0a\u5982\u4e0b: payload { \"iss\" : \"kubernetes/serviceaccount\" , \"kubernetes.io/serviceaccount/namespace\" : \"kube-system\" , \"kubernetes.io/serviceaccount/secret.name\" : \"default-token-mzmj7\" , \"kubernetes.io/serviceaccount/service-account.name\" : \"default\" , \"kubernetes.io/serviceaccount/service-account.uid\" : \"a7a8a752-c649-4d8f-9432-7081b18c0b52\" , \"sub\" : \"system:serviceaccount:kube-system:default\" } \u5f37\u5927\u7684\u5e33\u6236\u503c\u5f97\u4e00\u9805\u5177\u6709\u6311\u6230\u6027\u7684\u4efb\u52d9 - \u5217\u51fa\u96c6\u7fa4\u7d1a\u8cc7\u6e90\uff1a $ curl $KUBE_API /apis/apps/v1/deployments \\ --cacert ~/.minikube/ca.crt \\ --header \"Authorization: Bearer $JWT_TOKEN_KUBESYSTEM_DEFAULT \" { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"656580\" } , \"items\" : [ ... ] } \u662f\u7684\uff0c\u7b26\u5408\u6211\u5011\u7684\u671f\u5f85\u5730\u5b8c\u6210\u5de5\u4f5c\ud83d\udc4c","title":"Authenticating using Service Account Tokens"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#call-kubernetes-api-inside-a-pod","text":"\u8207\u4efb\u4f55\u5176\u4ed6 Kubernetes \u670d\u52d9\u975e\u5e38\u76f8\u4f3c\uff0cKubernetes API \u670d\u52d9\u5730\u5740\u53ef\u901a\u904e\u74b0\u5883\u8b8a\u91cf\u63d0\u4f9b\u7d66 Pod\uff1a $ kubectl run -it --image curlimages/curl --restart = Never mypod -- sh $ env | grep KUBERNETES KUBERNETES_SERVICE_PORT = 443 KUBERNETES_PORT = tcp://10.96.0.1:443 KUBERNETES_PORT_443_TCP_ADDR = 10 .96.0.1 KUBERNETES_PORT_443_TCP_PORT = 443 KUBERNETES_PORT_443_TCP_PROTO = tcp KUBERNETES_PORT_443_TCP = tcp://10.96.0.1:443 KUBERNETES_SERVICE_PORT_HTTPS = 443 KUBERNETES_SERVICE_HOST = 10 .96.0.1 Pod \u901a\u5e38\u9084\u6703\u5728 /var/run/secrets/kubernetes.io/serviceaccount/ \u4e0a\u5b89\u88dd Kubernetes CA \u8b49\u66f8\u548c \u670d\u52d9\u5e33\u6236 credentials\u3002\u56e0\u6b64\uff0c\u61c9\u7528\u4ee5\u4e0a\u90e8\u5206\u7684\u77e5\u8b58\uff0c\u5f9e Pod \u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u7684 curl \u547d\u4ee4\u53ef\u4ee5\u5982\u4e0b\u6240\u793a\uff1a $ curl https:// ${ KUBERNETES_SERVICE_HOST } : ${ KUBERNETES_SERVICE_PORT } /apis/apps/v1 \\ --cacert /var/run/secrets/kubernetes.io/serviceaccount/ca.crt \\ --header \"Authorization: Bearer $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) \"","title":"Call Kubernetes API inside a Pod"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#creat-read-watch-update-patch-and-delete-objects","text":"Kubernetes API \u652f\u6301\u5c0d Kubernetes \u5c0d\u8c61\u9032\u884c\u4ee5\u4e0b \u64cd\u4f5c \uff1a GET /<resourcePlural> - Retrieve a list of type . POST /<resourcePlural> - Create a new resource from the JSON object provided by the client. GET /<resourcePlural>/<name> - Retrieves a single resource with the given name. DELETE /<resourcePlural>/<name> - Delete the single resource with the given name. DELETE /<resourcePlural> - Deletes a list of type . PUT /<resourcePlural>/<name> - Update or create the resource with the given name with the JSON object provided by client. PATCH /<resourcePlural>/<name> - Selectively modify the specified fields of the resource. GET /<resourcePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. API \u662f RESTful \u7684\u578b\u5f0f\uff0c\u56e0\u6b64\u4e0a\u8ff0 HTTP \u65b9\u6cd5\u5728\u8cc7\u6e90\u64cd\u4f5c\u4e0a\u7684\u6620\u5c04\u61c9\u8a72\u770b\u8d77\u4f86\u5f88\u719f\u6089\u3002 Info \u5373\u4f7f\u6587\u6a94\u50c5\u63d0\u53ca JSON \u5c0d\u8c61\uff0c\u5982\u679c Content-Type \u6a19\u982d\u8a2d\u7f6e\u70ba application/yaml \uff0c\u5247\u652f\u6301\u63d0\u4ea4 YAML \u6709\u6548\u8ca0\u8f09\u3002 CREATE \u4ee5\u4e0b\u662f\u4f7f\u7528 curl \u548c YAML \u6e05\u55ae\u5275\u5efa\u65b0\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X POST \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"365d\"] ' READ \u4ee5\u4e0b\u662f\u5982\u4f55\u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4ee5\u53ca\u5982\u4f55\u901a\u904e\u540d\u7a31\u548c\u547d\u540d\u7a7a\u9593\u7372\u53d6\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \u4e00\u7a2e\u66f4\u9ad8\u7d1a\u7684\u6aa2\u7d22 Kubernetes \u8cc7\u6e90\u7684\u65b9\u6cd5\u662f\u6301\u7e8c\u89c0\u5bdf\u5b83\u5011\u7684\u8b8a\u5316\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments?watch = true \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key Info \u8acb\u6ce8\u610f\uff0c\u53ea\u80fd\u76e3\u8996\u4e00\u7d44\u8cc7\u6e90\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u63d0\u4f9b\u6a19\u7c64\u6216\u5b57\u6bb5\u9078\u64c7\u5668\u5c07\u7d50\u679c\u96c6\u7e2e\u5c0f\u5230\u55ae\u500b\u8cc7\u6e90\u3002 UPDATE \u4ee5\u4e0b\u662f\u66f4\u65b0\u73fe\u6709\u5c0d\u8c61\u7684\u65b9\u6cd5\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PUT \\ -H 'Content-Type: application/yaml' \\ -d '--- apiVersion: apps/v1 kind: Deployment metadata: name: sleep spec: replicas: 1 selector: matchLabels: app: sleep template: metadata: labels: app: sleep spec: containers: - name: sleep image: curlimages/curl command: [\"/bin/sleep\", \"730d\"] # <-- Making it sleep twice longer ' \u4ee5\u4e0b\u662f\u5982\u4f55\u4fee\u88dc\u73fe\u6709\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X PATCH \\ -H 'Content-Type: application/merge-patch+json' \\ -d '{ \"spec\": { \"template\": { \"spec\": { \"containers\": [ { \"name\": \"sleep\", \"image\": \"curlimages/curl\", \"command\": [\"/bin/sleep\", \"1d\"] } ] } } } }' Info \u8acb\u6ce8\u610f UPDATE \u548c PATCH \u662f\u76f8\u7576\u68d8\u624b\u7684\u64cd\u4f5c\u3002\u7b2c\u4e00\u500b\u53d7\u5230\u5404\u7a2e\u7248\u672c\u885d\u7a81\u7684\u5f71\u97ff\uff0c\u7b2c\u4e8c\u500b\u7684\u884c\u70ba\u56e0\u4f7f\u7528\u7684\u88dc\u4e01\u7b56\u7565\u800c\u7570\u3002 DELETE \u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f - \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u5c0d\u8c61\u96c6\u5408\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE \u4ee5\u4e0b\u662f\u5982\u4f55\u522a\u9664\u55ae\u500b\u5c0d\u8c61\uff1a $ curl $KUBE_API /apis/apps/v1/namespaces/default/deployments/sleep \\ --cacert ~/.minikube/ca.crt \\ --cert ~/.minikube/profiles/minikube/client.crt \\ --key ~/.minikube/profiles/minikube/client.key \\ -X DELETE","title":"Creat, Read, Watch, Update, Patch, and Delete objects"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#how-to-call-kubernetes-api-using-kubectl","text":"\u4e0a\u9762\u4f7f\u7528\u8b49\u66f8\u548c\u4ee4\u724c\u4f86\u547c\u53eb Kubernetes API \u5f88\u6709\u8da3\u3002\u81f3\u5c11\u7d93\u6b77\u4e00\u6b21\u662f\u4e00\u500b\u5f88\u597d\u7684\u7df4\u7fd2\uff0c\u53ef\u4ee5\u978f\u56fa\u5c0d\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u79fb\u52d5\u90e8\u4ef6\u7684\u7406\u89e3\u3002\u4f46\u662f\uff0c\u7576\u4f60\u6709\u4e00\u500b\u53ef\u4ee5\u4f7f\u7528\u7684 kubectl \u6642\uff0c\u6bcf\u5929\u90fd\u9019\u6a23\u505a\u53ef\u80fd\u6703\u6709\u9ede\u77ef\u6789\u904e\u6b63\u3002","title":"How to call Kubernetes API using kubectl"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#calling-kubernetes-api-using-kubectl-proxy","text":"\u4f7f\u7528\u6b63\u78ba\u914d\u7f6e\u7684 kubectl \u5de5\u5177\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl proxy \u547d\u4ee4\u5927\u5927\u7c21\u5316 API \u8a2a\u554f\u3002 kubectl proxy \u547d\u4ee4\u5728\u60a8\u7684 localhost \u548c Kubernetes API \u670d\u52d9\u5668 \u4e4b\u9593\u5275\u5efa\u4e00\u500b\u4ee3\u7406\u670d\u52d9\u5668\uff08\u6216\u61c9\u7528\u7a0b\u5e8f\u7d1a\u7db2\u95dc\uff09\u3002\u4f46\u5b83\u5fc5\u9808\u4e0d\u6b62\u65bc\u6b64\u3002\u4e0d\u7136\u600e\u9ebc\u6703\u9019\u9ebc\u65b9\u4fbf\uff1f \u4ee3\u7406 kubectl \u5f9e\u8abf\u7528\u8005\u90a3\u88e1\u5378\u8f09\u4e86\u76f8\u4e92\u7684\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u8cac\u4efb\u3002\u7531\u65bc\u8abf\u7528\u8005\u548c\u4ee3\u7406\u4e4b\u9593\u7684\u901a\u4fe1\u767c\u751f\u5728\u672c\u5730\u4e3b\u6a5f\u4e0a\uff0c\u56e0\u6b64\u5b83\u88ab\u8a8d\u70ba\u662f\u5b89\u5168\u7684\u3002\u4e26\u4e14\u4ee3\u7406\u672c\u8eab\u4f7f\u7528 kubeconfig \u6587\u4ef6\u4e2d\u9078\u64c7\u7684\u7576\u524d\u4e0a\u4e0b\u6587\u4e2d\u7684\u4fe1\u606f\u4f86\u8655\u7406\u5ba2\u6236\u7aef-\u670d\u52d9\u5668\u8eab\u4efd\u9a57\u8b49\u3002 $ kubectl config current-context minikube $ kubectl proxy --port = 8080 & \u555f\u52d5\u4ee3\u7406\u670d\u52d9\u5668\u5f8c\uff0c\u8abf\u7528 Kubernetes API \u670d\u52d9\u5668\u5c31\u8b8a\u5f97\u7c21\u55ae\u591a\u4e86\uff1a $ curl localhost:8080/apis/apps/v1/deployments { \"kind\" : \"DeploymentList\" , \"apiVersion\" : \"apps/v1\" , \"metadata\" : { \"resourceVersion\" : \"660883\" } , \"items\" : [ ... ] }","title":"Calling Kubernetes API using kubectl proxy"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#calling-kubernetes-api-using-kubectl-raw-mode","text":"\u6211\u6700\u8fd1\u5b78\u5230\u7684\u53e6\u4e00\u500b\u5f88\u9177\u7684\u6280\u5de7\u662f\u4e00\u4e9b kubectl \u547d\u4ee4\u652f\u6301\u7684\u539f\u59cb\u6a21\u5f0f\uff1a # Sends HTTP GET request $ kubectl get --raw /api/v1/namespaces/default/pods # Sends HTTP POST request $ kubectl create --raw /api/v1/namespaces/default/pods -f file.yaml # Sends HTTP PUT request $ kubectl replace --raw /api/v1/namespaces/default/pods/mypod -f file.json # Sends HTTP DELETE request $ kubectl delete --raw /api/v1/namespaces/default/pods kubectl \u662f\u4e00\u500b\u975e\u5e38\u5148\u9032\u7684\u5de5\u5177\uff0c\u5373\u4f7f\u662f\u50cf kubectl \u9019\u6a23\u7684\u7c21\u55ae\u547d\u4ee4\u4e5f\u6709\u5927\u91cf\u4ee3\u78bc\u3002\u4f46\u662f\uff0c\u7576\u4f7f\u7528 --raw \u6a19\u8a8c\u6642\uff0c\u5be6\u73fe\u6b78\u7d50\u70ba\u5c07\u552f\u4e00\u7684\u53c3\u6578\u8f49\u63db\u70ba API \u7aef\u9ede URL \u4e26\u8abf\u7528\u539f\u59cb REST API \u5ba2\u6236\u7aef\u3002","title":"Calling Kubernetes API using kubectl raw mode"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#wrapping-up","text":"\u7b2c\u4e00\u6b21\u8a2a\u554f Kubernetes API \u7684\u9700\u6c42\u53ef\u80fd\u5f88\u53ef\u6015 - \u6709\u5f88\u591a\u65b0\u6982\u5ff5\uff0c\u5982\u8cc7\u6e90\u3001API \u7d44\u3001\u7a2e\u985e\u3001\u5c0d\u8c61\u3001\u96c6\u7fa4\u3001\u4e0a\u4e0b\u6587\u3001\u8b49\u66f8\uff0c\u54e6\uff0c\u5929\u54ea\uff01\u4f46\u662f\u4e00\u65e6\u4f60\u5728\u69cb\u5efa\u584a\u4e0a\u5206\u89e3\u5b83\u4e26\u901a\u904e\u57f7\u884c\u4e00\u4e9b\u7463\u788e\u7684\u4efb\u52d9\uff08\u6bd4\u5982\u627e\u51fa API \u670d\u52d9\u5668\u5730\u5740\u6216\u4f7f\u7528 curl \u8abf\u7528\u4e00\u5806\u7aef\u9ede\uff09\u7372\u5f97\u4e00\u4e9b\u5be6\u8e10\u7d93\u9a57\uff0c\u4f60\u5f88\u5feb\u5c31\u6703\u610f\u8b58\u5230\u9019\u500b\u60f3\u6cd5\u52d5\u7269\u5712\u4e26\u4e0d\u662f\u771f\u7684\u4e00\u4e9b\u65b0\u7684\u6771\u897f\u2014\u2014\u5b83\u53ea\u662f\u591a\u5e74\u4f86\u70ba\u6211\u5011\u670d\u52d9\u7684\u773e\u6240\u5468\u77e5\u7684\u6a5f\u5236\u7684\u7d44\u5408 \u2014 REST \u67b6\u69cb\u98a8\u683c\u3001TLS \u8b49\u66f8\u3001JWT \u4ee4\u724c\u3001\u5c0d\u8c61\u65b9\u6848\u7b49\u3002 \u6240\u4ee5\uff0c\u4e0d\u8981\u5bb3\u6015\u4e26\u904b\u884c\u4e00\u4e9b\u67e5\u8a62\uff01 Info \u8feb\u4e0d\u53ca\u5f85\u60f3\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8abf\u7528 API\uff1f\u5728 GitHub \u4e0a\u67e5\u770b\u6211\u6536\u96c6\u7684 Kubernetes \u5ba2\u6236\u7aef\u793a\u4f8b \ud83d\ude09","title":"Wrapping up"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-call-simple-http-client/#resources","text":"Kubernetes Documentation - Access Clusters Using the Kubernetes API Kubernetes Documentation - Configure Access to Multiple Clusters Kubernetes Documentation - Authenticating Kubernetes Documentation - Controlling Access to the Kubernetes API Kubernetes Documentation - Configure Service Accounts for Pods Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"Resources"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-structure-and-terminology/","text":"Kubernetes API \u57fa\u790e \u00b6 \u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-structure-and-terminology/ \u9019\u662f\u95dc\u65bc\u5982\u4f55\u5f9e\u4ee3\u78bc\u4e2d\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\u7ae0\u4e2d\u7684\u7b2c\u4e00\u7bc7\u3002 Kubernetes API \u6bd4\u4e00\u5806 HTTP \u7aef\u9ede\u7d44\u5408\u5728\u4e00\u8d77\u8981\u5148\u9032\u4e00\u9ede\u3002\u56e0\u6b64\uff0c\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8a2a\u554f\u5b83\u4e4b\u524d\uff0c\u4e86\u89e3 Kubernetes API \u7d50\u69cb\u4e26\u719f\u6089\u8853\u8a9e\u81f3\u95dc\u91cd\u8981\u3002\u5426\u5247\uff0c\u5617\u8a66\u5c07\u975e\u5e38\u75db\u82e6\u2014\u2014\u5b98\u65b9\u7684 Go \u5ba2\u6236\u7aef\u5e36\u6709\u592a\u591a\u7684\u82b1\u91cc\u80e1\u54e8\uff0c\u8a66\u5716\u5c07\u4f60\u7684\u982d\u8166\u570d\u7e5e\u5728\u5ba2\u6236\u7aef\u548c API \u6982\u5ff5\u4e0a\uff0c\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u8b93\u4f60\u4e0d\u77e5\u6240\u63aa\u3002 Kubernetes API \u975e\u5e38\u9f90\u5927\u2014\u2014\u5b83\u6709\u6578\u767e\u500b\u7aef\u9ede\u3002\u5e78\u904b\u7684\u662f\uff0c\u5b83\u975e\u5e38\u4e00\u81f4\uff0c\u56e0\u6b64\u53ea\u9700\u4e86\u89e3\u6709\u9650\u6578\u91cf\u7684\u60f3\u6cd5\uff0c\u7136\u5f8c\u5c07\u9019\u4e9b\u77e5\u8b58\u5916\u63a8\u5230 API \u7684\u5176\u9918\u90e8\u5206\u3002\u5728\u9019\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5c07\u5617\u8a66\u89f8\u53ca\u6211\u767c\u73fe\u7684\u6700\u57fa\u672c\u7684\u6982\u5ff5\u3002\u6211\u50be\u5411\u65bc\u7c21\u55ae\u548c\u6613\u6d88\u5316\uff0c\u800c\u4e0d\u662f\u5b78\u8853\u4e0a\u7684\u6b63\u78ba\u6027\u548c\u6750\u6599\u7684\u5b8c\u6574\u6027\u3002\u548c\u5f80\u5e38\u4e00\u6a23\uff0c\u6211\u53ea\u662f\u5206\u4eab\u6211\u5c0d\u4e8b\u7269\u7684\u7406\u89e3\u548c\u601d\u8003\u9019\u500b\u8a71\u984c\u7684\u65b9\u5f0f\u2014\u2014\u6240\u4ee5\uff0c\u5b83\u4e0d\u662f API \u624b\u518a\uff0c\u800c\u662f\u500b\u4eba\u5b78\u7fd2\u7d93\u9a57\u7684\u8a18\u9304\u3002 Resources and Verbs \u00b6 \u7531\u65bc\u5b83\u662f\u4e00\u500b RESTful \u9818\u57df\uff0c\u6211\u5011\u5c07\u6839\u64da resource \uff08\u9b06\u6563\u5730\uff0c\u67d0\u7a2e\u7d50\u69cb\u7684\u5c0d\u8c61\uff09\u548c verb \uff08\u5c0d\u9019\u4e9b\u5c0d\u8c61\u7684\u64cd\u4f5c\uff09\u9032\u884c\u64cd\u4f5c\u3002 \u5728\u8a0e\u8ad6 resources \u6642\uff0c\u5c07 a resource as a certain kind of objects \u8207 a resource as a particular instance of some kind \u5340\u5206\u958b\u4f86\u662f\u5f88\u91cd\u8981\u7684\u3002\u56e0\u6b64\uff0cKubernetes API \u7aef\u9ede\u88ab\u6b63\u5f0f\u547d\u540d\u70ba\u8cc7\u6e90\u985e\u578b (resource types)\uff0c\u4ee5\u907f\u514d\u8207\u8cc7\u6e90\u5be6\u4f8b (resource instances) \u7522\u751f\u6b67\u7fa9\u3002\u7136\u800c\uff0c\u5c0d\u4e00\u822c\u61c9\u7528\u7a0b\u5f0f\u7684\u958b\u767c\u8005\u4f86\uff0c\u7aef\u9ede(endpoint)\u901a\u5e38\u88ab\u7a31\u70ba\u8cc7\u6e90(resource)\uff0c\u56e0\u6b64\u9019\u500b\u8a5e\u7684\u5be6\u969b\u542b\u7fa9\u5f97\u5f9e\u4e0a\u4e0b\u6587\u4e2d\u4f86\u5f97\u51fa\u3002 \u51fa\u65bc\u53ef\u64f4\u5c55\u6027\u7684\u539f\u56e0\uff0c resource types \u3000\u88ab\u7d44\u7e54\u6210 API groups \uff0c\u4e26\u4e14\u9019\u4e9b\u3000API\u3000\u7fa4\u7d44\u5f7c\u6b64\u7368\u7acb\u5730\u9032\u884c\u7248\u672c\u63a7\u5236\uff1a $ kubectl api-resources NAME SHORTNAMES APIVERSION NAMESPACED KIND bindings v1 true Binding componentstatuses cs v1 false ComponentStatus configmaps cm v1 true ConfigMap endpoints ep v1 true Endpoints events ev v1 true Event limitranges limits v1 true LimitRange namespaces ns v1 false Namespace nodes no v1 false Node persistentvolumeclaims pvc v1 true PersistentVolumeClaim persistentvolumes pv v1 false PersistentVolume pods po v1 true Pod podtemplates v1 true PodTemplate replicationcontrollers rc v1 true ReplicationController resourcequotas quota v1 true ResourceQuota secrets v1 true Secret serviceaccounts sa v1 true ServiceAccount services svc v1 true Service mutatingwebhookconfigurations admissionregistration.k8s.io/v1 false MutatingWebhookConfiguration validatingwebhookconfigurations admissionregistration.k8s.io/v1 false ValidatingWebhookConfiguration customresourcedefinitions crd,crds apiextensions.k8s.io/v1 false CustomResourceDefinition apiservices apiregistration.k8s.io/v1 false APIService controllerrevisions apps/v1 true ControllerRevision daemonsets ds apps/v1 true DaemonSet deployments deploy apps/v1 true Deployment replicasets rs apps/v1 true ReplicaSet statefulsets sts apps/v1 true StatefulSet tokenreviews authentication.k8s.io/v1 false TokenReview localsubjectaccessreviews authorization.k8s.io/v1 true LocalSubjectAccessReview selfsubjectaccessreviews authorization.k8s.io/v1 false SelfSubjectAccessReview selfsubjectrulesreviews authorization.k8s.io/v1 false SelfSubjectRulesReview subjectaccessreviews authorization.k8s.io/v1 false SubjectAccessReview horizontalpodautoscalers hpa autoscaling/v2 true HorizontalPodAutoscaler cronjobs cj batch/v1 true CronJob jobs batch/v1 true Job certificatesigningrequests csr certificates.k8s.io/v1 false CertificateSigningRequest leases coordination.k8s.io/v1 true Lease endpointslices discovery.k8s.io/v1 true EndpointSlice events ev events.k8s.io/v1 true Event flowschemas flowcontrol.apiserver.k8s.io/v1beta2 false FlowSchema prioritylevelconfigurations flowcontrol.apiserver.k8s.io/v1beta2 false PriorityLevelConfiguration ingressclasses networking.k8s.io/v1 false IngressClass ingresses ing networking.k8s.io/v1 true Ingress networkpolicies netpol networking.k8s.io/v1 true NetworkPolicy runtimeclasses node.k8s.io/v1 false RuntimeClass poddisruptionbudgets pdb policy/v1 true PodDisruptionBudget podsecuritypolicies psp policy/v1beta1 false PodSecurityPolicy clusterrolebindings rbac.authorization.k8s.io/v1 false ClusterRoleBinding clusterroles rbac.authorization.k8s.io/v1 false ClusterRole rolebindings rbac.authorization.k8s.io/v1 true RoleBinding roles rbac.authorization.k8s.io/v1 true Role priorityclasses pc scheduling.k8s.io/v1 false PriorityClass csidrivers storage.k8s.io/v1 false CSIDriver csinodes storage.k8s.io/v1 false CSINode csistoragecapacities storage.k8s.io/v1beta1 true CSIStorageCapacity storageclasses sc storage.k8s.io/v1 false StorageClass volumeattachments storage.k8s.io/v1 false VolumeAttachment \u5982\u679c\u4f60\u597d\u5947 kubectl api-resources \u547d\u4ee4\u662f\u5982\u4f55\u69cb\u5efa\u9019\u6a23\u4e00\u500b\u652f\u6301\u7684\u8cc7\u6e90\u5217\u8868\u7684\uff0c\u9019\u88e1\u6709\u4e00\u500b\u5f88\u597d\u7684\u6280\u5de7\uff0c\u5b83\u986f\u793a\u4e86\u4efb\u4f55 kubectl \u547d\u4ee4\u9032\u884c\u4e86\u54ea\u4e9b API \u8abf\u7528\uff1a $ kubectl api-resources -v 6 # -v 6 means \"extra verbose logging\" ... I0108 ... GET https://192.168.58.2:8443/api?timeout = 32s 200 OK in 10 milliseconds I0108 ... GET https://192.168.58.2:8443/apis?timeout = 32s 200 OK in 1 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apiregistration.k8s.io/v1?timeout = 32s 200 OK in 7 milliseconds I0108 ... GET https://192.168.58.2:8443/api/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/authentication.k8s.io/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/events.k8s.io/v1?timeout = 32s 200 OK in 15 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apps/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/autoscaling/v2beta1?timeout = 32s 200 OK in 16 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/policy/v1beta1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/scheduling.k8s.io/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1beta1?timeout = 32s 200 OK in 43 milliseconds ... \u5176\u5be6\u3000ubernetes\u3000\u7684\u3000API\u3000\u90fd\u5177\u5099\u4e86\u76f8\u7576\u8c50\u5bcc\u7684 meta data \u4f86\u9673\u8ff0\u9019\u500b\u3000Kubernetes API \u57fa\u672c\u8cc7\u6599\u3002\u986f\u7136\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u8b80\u53d6\uff08\u6216\u5275\u5efa\uff09\u5176\u4ed6\u8cc7\u6e90\u4f86\u5217\u51fa\u73fe\u6709\u7684\uff08\u751a\u81f3\u8a3b\u518a\u65b0\u7684\u8cc7\u6e90\u985e\u578b\uff09\uff01\u4f8b\u5982\uff0c\u4e0a\u9762\u7684\u5217\u8868\u662f\u901a\u904e\u8abf\u7528\u7279\u6b8a\u7684 /api \u548c /apis/<group-name> \u8cc7\u6e90\u7372\u5f97\u7684\u3002 Info /api \u7aef\u9ede\u5df2\u7d93\u662f\u6700\u521d\u3000Kubernetes\u3000\u5b9a\u7fa9\u8207\u4f7f\u7528\u7684\uff0c\u50c5\u7528\u65bc\u6838\u5fc3\u8cc7\u6e90\uff08pod\u3001secrets\u3001configmaps \u7b49\uff09\u3002\u4e00\u500b\u66f4\u73fe\u4ee3\u548c\u901a\u7528\u7684 /apis/<group-name> \u7aef\u9ede\u7528\u65bc\u5176\u9918\u8cc7\u6e90\uff0c\u5305\u62ec\u7528\u6236\u5b9a\u7fa9\u7684\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 curl \u7b49\u6a19\u6e96 HTTP \u5ba2\u6236\u7aef\u8f15\u9b06\u8abf\u7528\u4e0a\u8ff0\u8cc7\u6e90\uff08\u5373 API \u7aef\u9ede\uff09\u4e26\u6aa2\u67e5\u8fd4\u56de\u7684\u8cc7\u6e90\uff08\u5373 JSON \u5c0d\u8c61\uff09\uff1a # Make Kubernetes API available on localhost:8080 # to bypass the auth step in subsequent queries: $ kubectl proxy --port = 8080 & # List all known API paths $ curl http://localhost:8080/ # List known versions of the `core` group $ curl http://localhost:8080/api # List known resources of the `core/v1` group $ curl http://localhost:8080/api/v1 # Get a particular Pod resource $ curl http://localhost:8080/api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg # List known groups (all but `core`) $ curl http://localhost:8080/apis # List known versions of the `apps` group $ curl http://localhost:8080/apis/apps # List known resources of the `apps/v1` group $ curl http://localhost:8080/apis/apps/v1 # Get a particular Deployment resource $ curl http://localhost:8080/apis/apps/v1/namespaces/default/deployments/sleep Info \u6709\u4e00\u7a2e\u66f4\u7c21\u55ae\u7684\u65b9\u6cd5\u4f86\u6aa2\u67e5 Kubernetes API\uff1a kubectl get --raw /SOME/API/PATH \u3002\u7136\u800c\uff0c\u4e0a\u9762\u7684\u7df4\u7fd2\u662f\u70ba\u4e86\u8868\u660e Kubernetes API \u4e26\u4e0d\u795e\u5947\u3002\u64c1\u6709\u4e00\u500b\u901a\u7528\u578b\u7684 HTTP \u5ba2\u6236\u7aef\u6216\u5de5\u5177\u5c31\u8db3\u4ee5\u958b\u59cb\u4f7f\u7528\u5b83\u4e86\u3002 \u8aaa\u5230\u3000 verbs (\u5373\u5c0d\u8cc7\u6e90\u7684\u64cd\u4f5c)\uff0c\u6240\u6709\u6a19\u6e96\u7684 CRUD \u64cd\u4f5c\u53ca\u5176\u50b3\u7d71\u6620\u5c04\u5230 HTTP \u65b9\u6cd5\u90fd\u5728\u90a3\u88e1\u3002\u6b64\u5916\uff0c\u9084\u652f\u6301\u8cc7\u6e90\u7684 patching \uff08\u9078\u64c7\u6027\u5b57\u6bb5\u4fee\u6539\uff09\u548c watching \uff08\u6d41\u5f0f\u96c6\u5408\u7684\u8b80\u53d6\uff09\u3002\u5728\u3000Kubernetes \u5b98\u65b9\u958b\u767c\u6307\u5357\u4e2d\u5b9a\u7fa9\u4e86\u8a73\u7d30\u7684\u8aaa\u660e: sig-architecture/api-conventions.md \uff1a ## Verbs on Resources API resources should use the traditional REST pattern: GET /<resourceNamePlural> - Retrieve a list of type <resourceName>, e.g. GET /pods returns a list of Pods. POST /<resourceNamePlural> - Create a new resource from the JSON object provided by the client. GET /<resourceNamePlural>/<name> - Retrieves a single resource with the given name, e.g. GET /pods/first returns a Pod named 'first'. Should be constant time, and the resource should be bounded in size. DELETE /<resourceNamePlural>/<name> - Delete the single resource with the given name. DeleteOptions may specify gracePeriodSeconds, the optional duration in seconds before the object should be deleted. Individual kinds may declare fields which provide a default grace period, and different kinds may have differing kind-wide default grace periods. A user provided grace period overrides a default grace period, including the zero grace period (\"now\"). DELETE /<resourceNamePlural> - Deletes a list of type <resourceName>, e.g. DELETE /pods a list of Pods. PUT /<resourceNamePlural>/<name> - Update or create the resource with the given name with the JSON object provided by the client. PATCH /<resourceNamePlural>/<name> - Selectively modify the specified fields of the resource. See more information below. GET /<resourceNamePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. ## PATCH operations The API supports three different PATCH operations, determined by their corresponding Content-Type header: JSON Patch, Content-Type: application/json-patch+json As defined in RFC6902, a JSON Patch is a sequence of operations that are executed on the resource, e.g. {\"op\": \"add\", \"path\": \"/a/b/c\", \"value\": [ \"foo\", \"bar\" ]}. For more details on how to use JSON Patch, see the RFC. Merge Patch, Content-Type: application/merge-patch+json As defined in RFC7386, a Merge Patch is essentially a partial representation of the resource. The submitted JSON is \"merged\" with the current resource to create a new one, then the new one is saved. For more details on how to use Merge Patch, see the RFC. Strategic Merge Patch, Content-Type: application/strategic-merge-patch+json Strategic Merge Patch is a custom implementation of Merge Patch. For a detailed explanation of how it works and why it needed to be introduced, see here. Kinds aka Object Schemas \u00b6 kind (\u985e\u578b) \u9019\u500b\u8a5e\u6703\u6642\u4e0d\u6642\u5730\u51fa\u73fe\u5728\u9019\u91cc\u548c\u90a3\u88e1\u3002\u4f8b\u5982\uff0c\u5728 kubectl api-resources \u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 persistentvolumes \u8cc7\u6e90\u5177\u6709\u76f8\u61c9\u7684 PersistentVolume \u985e\u578b\u3002 \u5f88\u9577\u4e00\u6bb5\u6642\u9593\u4ee5\u4f86\uff0c\u6211\u8207 Kubernetes \u7684\u4ea4\u4e92\u50c5\u9650\u65bc\u4f7f\u7528 kubectl apply \u76f2\u76ee\u5730\u70ba\u5176\u63d0\u4f9b\u6e05\u55ae\u3002\u9019\u8b93\u6211\u89ba\u5f97 kind \u7e3d\u662f\u5305\u542b\u4e00\u500b\u8cc7\u6e90\u7684 CamelCase \u540d\u7a31\uff0c\u6bd4\u5982 Pod \u3001 Service \u3001 Deployment \u7b49\u3002 $ cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: my-deployment spec: replicas: 1 selector: ... EOF \u4f46\u5be6\u969b\u4e0a\uff0c\u5c31\u7b97\u4e0d\u662f\u8cc7\u6e90\u7684 Kubernetes \u6578\u64da\u7d50\u69cb\u4e5f\u53ef\u4ee5\u6709 Kind \u7684\u5ba3\u544a\uff1a apiVersion : audit.k8s.io/v1 kind : Policy rules : - level : Metadata \u751a\u81f3 Kubernetes \u5c0d\u8c61\uff08\u5373\u6301\u4e45\u5be6\u9ad4\uff09\u7684\u8cc7\u6e90\u4e5f\u6709 Kind \uff1a $ kubectl get --raw /api | jq { \"kind\" : \"APIVersions\" , \"versions\" : [ \"v1\" ] , \"serverAddressByClientCIDRs\" : [ { \"clientCIDR\" : \"0.0.0.0/0\" , \"serverAddress\" : \"192.168.49.2:8443\" } ] } \u90a3\u9ebc\uff0c\u4ec0\u9ebc\u662f kind \uff1f Info \"All resource types have a concrete representation which is called a kind\" - Kubernetes API reference. \u55ef\uff0c\u9019\u500b\u89e3\u91cb\u4e0d\u662f\u7279\u5225\u6709\u7528! \ud83e\udd14 \u4e8b\u5be6\u8b49\u660e\uff0c\u5728 Kubernetes \u4e2d\uff0c\u4e00\u7a2e Kind \u662f object schema \u3002\u5c31\u50cf\u60a8\u901a\u5e38\u4f7f\u7528 JSON schema \u90a3\u6a23\u3002\u63db\u53e5\u8a71\u8aaa\uff0c Kind \u662f\u6307\u7279\u5b9a\u7684\u6578\u64da\u7d50\u69cb\uff0c\u5373 attributes \u548c properties \u7684\u67d0\u7a2e\u7d44\u5408\u3002 \u6839\u64da sig-architecture/api-conventions.md \uff0c Kind \u5206\u70ba\u4e09\u985e\uff1a Objects (Pod, Service, etc) - persistent entities in the system. Lists - (PodList, APIResourceList, etc) - collections of resources of one or more kinds. Simple - specific actions on objects (status, scale, etc.) or non-persistent auxiliary entities (ListOptions, Policy, etc). Kubernetes \u4e2d\u4f7f\u7528\u7684\u5927\u591a\u6578\u7269\u4ef6(object)\uff0c\u5305\u62ec API \u8fd4\u56de\u7684\u6240\u6709 JSON \u7269\u4ef6\uff0c\u90fd\u6709 kind \u5b57\u6bb5\u3002\u5b83\u5141\u8a31\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u5728\u901a\u904e\u7db2\u7d61\u767c\u9001\u5b83\u5011\u6216\u5c07\u5b83\u5011\u5b58\u5132\u5728\u78c1\u76e4\u4e0a\u4e4b\u524d\u6b63\u78ba\u5730\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u9019\u4e9b\u7269\u4ef6\u3002 Kubernetes Objects \u00b6 \u5c31\u50cf resource \u4e00\u6a23\uff0cKubernetes \u7528\u8a9e\u4e2d\u7684 object \u4e00\u8a5e\u662f\u4e5f\u662f\u641e\u7684\u5927\u5bb6\u6688\u982d\u8f49\u5411\u7684\u3002\u5f9e\u5ee3\u7fa9\u4e0a\u8b1b\uff0c Objects \u53ef\u4ee5\u6307\u4efb\u4f55\u6578\u64da\u7d50\u69cb\u2014\u2014\u8cc7\u6e90\u985e\u578b\u7684\u5be6\u4f8b\uff08\u5982 APIGroup\uff09\u3001\u914d\u7f6e\uff08\u5982\u5be9\u8a08\u7b56\u7565\uff09\u6216\u6301\u4e45\u5be6\u9ad4\uff08\u5982 Pod\uff09\u3002\u4f46\u662f\uff0c\u5728\u672c\u7bc0\u4e2d\uff0c\u6211\u5c07\u5728\u72f9\u7fa9\u7684\u3001\u660e\u78ba\u5b9a\u7fa9\u7684\u610f\u7fa9\u4e0a\u8a0e\u8ad6 object \u3002\u6240\u4ee5\uff0c\u6211\u5c07\u4f7f\u7528\u5927\u5beb\u7684\u8a5e Object \u4f86\u4ee3\u66ff\u3002 \u5927\u591a\u6578 Kubernetes API \u8cc7\u6e90\u4ee3\u8868 Object \u3002\u8207\u50c5\u8981\u6c42 kind \u5b57\u6bb5\u7684\u5176\u4ed6\u5f62\u5f0f\u7684\u8cc7\u6e90\u4e0d\u540c\uff0cObjects \u5fc5\u9808\u5b9a\u7fa9\u66f4\u591a\u5b57\u6bb5\uff1a kind - a string that identifies the schema this object should have apiVersion - a string that identifies the version of the schema the object should have metadata.namespace - a string with the namespace (defaults to \"default\") metadata.name - a string that uniquely identifies this object within the current namespace metadata.uid - a unique in time and space value used to distinguish between objects with the same name that have been deleted and recreated. \u6b64\u5916\uff0c metadata \u4e5f\u53ef\u80fd\u5305\u62ec\u6a19\u7c64\u548c\u8a3b\u91cb\u5b57\u6bb5\uff0c\u4ee5\u53ca\u4e00\u4e9b\u7248\u672c\u63a7\u5236\u548c\u6642\u9593\u6233\u4fe1\u606f\u3002 \u793a\u4f8b - Pod \u5c0d\u8c61\uff08\u622a\u65b7\u8f38\u51fa\uff09\uff1a $ kubectl get --raw /api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"Pod\" , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"sleep-7c7db887d8-dkkcg\" , \"uid\" : \"32bf410a-0009-484e-adac-21179ec28f0f\" , \"labels\" : { \"app\" : \"sleep\" , \"pod-template-hash\" : \"7c7db887d8\" } , \"creationTimestamp\" : \"2022-01-08T18:10:04Z\" , \"resourceVersion\" : \"465766\" } , \"spec\" : { ... } , \"status\" : { ... } } \u5982\u4e0a\u4f8b\u6240\u793a\uff0cKubernetes \u5c0d\u8c61\u901a\u5e38\u5177\u6709 spec \uff08\u671f\u671b\u72c0\u614b\uff09\u548c status \uff08\u5be6\u969b\u72c0\u614b\uff09\u5b57\u6bb5\u3002\u4f46\u60c5\u6cc1\u4e26\u975e\u7e3d\u662f\u5982\u6b64\u3002\u5c07\u4e0a\u9762\u7684\u8f38\u51fa\u8207\u4e0b\u9762\u7684 ConfigMap \u5c0d\u8c61\u9032\u884c\u6bd4\u8f03\uff1a $ kubectl get --raw /api/v1/namespaces/default/configmaps/informer-dynamic-simple-wzgmx | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"ConfigMap\" , \"data\" : { \"foo\" : \"bar\" } , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"informer-dynamic-simple-wzgmx\" , \"uid\" : \"74471398-0244-4686-b490-7007f6246a63\" , \"creationTimestamp\" : \"2022-01-06T21:45:04Z\" , \"generateName\" : \"informer-dynamic-simple-\" , \"resourceVersion\" : \"418185\" } } \u5f9e\u4ee3\u78bc\u4e2d\u8655\u7406 Kubernetes API \u6d89\u53ca\u5230\u5927\u91cf\u7684 Object \u64cd\u4f5c\uff0c\u56e0\u6b64\u5fc5\u9808\u5c0d\u5e38\u898b\u7684\u5c0d\u8c61\u7d50\u69cb\u6709\u7d2e\u5be6\u7684\u7406\u89e3\u3002 kubectl explain \u547d\u4ee4\u53ef\u4ee5\u5e6b\u52a9\u60a8\u3002\u5b83\u6700\u9177\u7684\u90e8\u5206\u662f\u5b83\u4e0d\u50c5\u53ef\u4ee5\u5728\u8cc7\u6e90\u4e0a\u8abf\u7528\uff0c\u9084\u53ef\u4ee5\u5728\u5d4c\u5957\u5b57\u6bb5\u4e0a\u8abf\u7528\uff1a $ kubectl explain deployment.spec.template KIND: Deployment VERSION: apps/v1 RESOURCE: template <Object> DESCRIPTION: Template describes the pods that will be created. PodTemplateSpec describes the data a pod should have when created from a template FIELDS: metadata <Object> Standard object ' s metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata spec <Object> Specification of the desired behavior of the pod. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status Summarizing \u00b6 Kubernetes \u7528\u8a9e\u4e2d\u7684 resource \u53ef\u4ee5\u6307\u8cc7\u6e90\u985e\u578b\u548c\u8cc7\u6e90\u5be6\u4f8b\u3002\u8cc7\u6e90\u985e\u578b\u88ab\u7d44\u7e54\u6210 API groups\uff0c\u4e26\u4e14 API groups\u662f\u7248\u672c\u5316\u7684\u3002\u6bcf\u500b\u8cc7\u6e90\u8868\u793a\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u7279\u5b9a\u6a21\u5f0f\u3002\u96d6\u7136\u6bcf\u500b\u8cc7\u6e90\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u5177\u9ad4\u7d50\u69cb\uff0c\u4f46\u4e26\u975e\u6bcf\u500b\u8cc7\u6e90\u90fd\u4ee3\u8868\u4e00\u500b Kubernetes \u5c0d\u8c61\u3002\u5c0d\u50cf\u662f\u8868\u793a\u610f\u5716\u8a18\u9304\u7684\u6301\u4e45\u5be6\u9ad4\u3002\u4e0d\u540c\u7a2e\u985e\u7684\u5c0d\u8c61\u5177\u6709\u4e0d\u540c\u7684\u7d50\u69cb\uff0c\u4f46\u6240\u6709\u5c0d\u50cf\u90fd\u5e36\u6709\u5171\u540c\u7684\u5143\u6578\u64da\u5c6c\u6027\uff0c\u4f8b\u5982\u547d\u540d\u7a7a\u9593\u3001\u540d\u7a31\u3001uid \u6216 creationTimestamp\u3002 What's next? \u00b6 \u5c0d Kubernetes API \u7684\u7406\u8ad6\u90e8\u5206\u6709\u66f4\u597d\u7684\u4e86\u89e3\u55ce\uff1f \u592a\u597d\u4e86\uff01\u3000\u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u7528\u4e00\u500b\u7c21\u55ae\u7684 HTTP \u5ba2\u6236\u7aef\u8abf\u7528\u5b83(\u4e8b\u5be6\u8b49\u660e\u9019\u4e0d\u662f\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\uff0c\u6709\u5f88\u591a\u5751\u8981\u8df3)\u3002 \u7576\u7406\u8ad6\u548c\u5be6\u8e10\u76f8\u63d0\u4e26\u8ad6\u6642\uff0c\u6211\u5efa\u8b70\u770b\u4e00\u4e0b k8s.io/api \u548c k8s.io/apimachinery \u6a21\u584a - \u9019\u662f \u5b98\u65b9 Go \u5ba2\u6236\u7aef \u7684\u5169\u500b\u4e3b\u8981\u4f9d\u8cf4\u9805\u3002 k8s.io/api \u70ba Kubernetes \u5c0d\u8c61\u5b9a\u7fa9\u7684 Go \u7d50\u69cb\uff0c\u800c k8s.io/apimachinery \u5e36\u4f86\u4e86\u8f03\u4f4e\u7d1a\u5225\u7684\u69cb\u5efa\u584a\u548c\u5e38\u898b\u7684 API \u529f\u80fd\uff0c\u5982\u5e8f\u5217\u5316\u3001\u985e\u578b\u8f49\u63db\u6216\u932f\u8aa4\u8655\u7406\u3002 \u9019\u662f\u6211\u5c0d\u9019\u5169\u500b\u6a21\u584a\u7684\u5716\u89e3\u6982\u8ff0 \u3002 Talk is cheap, show me the code? \u5927\u5bb6\u53ef\u770b\u6211\u5728 GitHub \u4e0a\u6536\u96c6\u7684 Kubernetes client-go \u793a\u4f8b\ud83d\ude09 Resources Kubernetes Documentation - API Overview Kubernetes Documentation - API Concepts Kubernetes Documentation- Understanding Kubernetes Objects SIG Architecture - API Conventions Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"K8S API \u57fa\u790e"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-structure-and-terminology/#kubernetes-api","text":"\u539f\u6587: https://iximiuz.com/en/posts/kubernetes-api-structure-and-terminology/ \u9019\u662f\u95dc\u65bc\u5982\u4f55\u5f9e\u4ee3\u78bc\u4e2d\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\u7ae0\u4e2d\u7684\u7b2c\u4e00\u7bc7\u3002 Kubernetes API \u6bd4\u4e00\u5806 HTTP \u7aef\u9ede\u7d44\u5408\u5728\u4e00\u8d77\u8981\u5148\u9032\u4e00\u9ede\u3002\u56e0\u6b64\uff0c\u5728\u5617\u8a66\u5f9e\u4ee3\u78bc\u4e2d\u8a2a\u554f\u5b83\u4e4b\u524d\uff0c\u4e86\u89e3 Kubernetes API \u7d50\u69cb\u4e26\u719f\u6089\u8853\u8a9e\u81f3\u95dc\u91cd\u8981\u3002\u5426\u5247\uff0c\u5617\u8a66\u5c07\u975e\u5e38\u75db\u82e6\u2014\u2014\u5b98\u65b9\u7684 Go \u5ba2\u6236\u7aef\u5e36\u6709\u592a\u591a\u7684\u82b1\u91cc\u80e1\u54e8\uff0c\u8a66\u5716\u5c07\u4f60\u7684\u982d\u8166\u570d\u7e5e\u5728\u5ba2\u6236\u7aef\u548c API \u6982\u5ff5\u4e0a\uff0c\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u8b93\u4f60\u4e0d\u77e5\u6240\u63aa\u3002 Kubernetes API \u975e\u5e38\u9f90\u5927\u2014\u2014\u5b83\u6709\u6578\u767e\u500b\u7aef\u9ede\u3002\u5e78\u904b\u7684\u662f\uff0c\u5b83\u975e\u5e38\u4e00\u81f4\uff0c\u56e0\u6b64\u53ea\u9700\u4e86\u89e3\u6709\u9650\u6578\u91cf\u7684\u60f3\u6cd5\uff0c\u7136\u5f8c\u5c07\u9019\u4e9b\u77e5\u8b58\u5916\u63a8\u5230 API \u7684\u5176\u9918\u90e8\u5206\u3002\u5728\u9019\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5c07\u5617\u8a66\u89f8\u53ca\u6211\u767c\u73fe\u7684\u6700\u57fa\u672c\u7684\u6982\u5ff5\u3002\u6211\u50be\u5411\u65bc\u7c21\u55ae\u548c\u6613\u6d88\u5316\uff0c\u800c\u4e0d\u662f\u5b78\u8853\u4e0a\u7684\u6b63\u78ba\u6027\u548c\u6750\u6599\u7684\u5b8c\u6574\u6027\u3002\u548c\u5f80\u5e38\u4e00\u6a23\uff0c\u6211\u53ea\u662f\u5206\u4eab\u6211\u5c0d\u4e8b\u7269\u7684\u7406\u89e3\u548c\u601d\u8003\u9019\u500b\u8a71\u984c\u7684\u65b9\u5f0f\u2014\u2014\u6240\u4ee5\uff0c\u5b83\u4e0d\u662f API \u624b\u518a\uff0c\u800c\u662f\u500b\u4eba\u5b78\u7fd2\u7d93\u9a57\u7684\u8a18\u9304\u3002","title":"Kubernetes API \u57fa\u790e"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-structure-and-terminology/#resources-and-verbs","text":"\u7531\u65bc\u5b83\u662f\u4e00\u500b RESTful \u9818\u57df\uff0c\u6211\u5011\u5c07\u6839\u64da resource \uff08\u9b06\u6563\u5730\uff0c\u67d0\u7a2e\u7d50\u69cb\u7684\u5c0d\u8c61\uff09\u548c verb \uff08\u5c0d\u9019\u4e9b\u5c0d\u8c61\u7684\u64cd\u4f5c\uff09\u9032\u884c\u64cd\u4f5c\u3002 \u5728\u8a0e\u8ad6 resources \u6642\uff0c\u5c07 a resource as a certain kind of objects \u8207 a resource as a particular instance of some kind \u5340\u5206\u958b\u4f86\u662f\u5f88\u91cd\u8981\u7684\u3002\u56e0\u6b64\uff0cKubernetes API \u7aef\u9ede\u88ab\u6b63\u5f0f\u547d\u540d\u70ba\u8cc7\u6e90\u985e\u578b (resource types)\uff0c\u4ee5\u907f\u514d\u8207\u8cc7\u6e90\u5be6\u4f8b (resource instances) \u7522\u751f\u6b67\u7fa9\u3002\u7136\u800c\uff0c\u5c0d\u4e00\u822c\u61c9\u7528\u7a0b\u5f0f\u7684\u958b\u767c\u8005\u4f86\uff0c\u7aef\u9ede(endpoint)\u901a\u5e38\u88ab\u7a31\u70ba\u8cc7\u6e90(resource)\uff0c\u56e0\u6b64\u9019\u500b\u8a5e\u7684\u5be6\u969b\u542b\u7fa9\u5f97\u5f9e\u4e0a\u4e0b\u6587\u4e2d\u4f86\u5f97\u51fa\u3002 \u51fa\u65bc\u53ef\u64f4\u5c55\u6027\u7684\u539f\u56e0\uff0c resource types \u3000\u88ab\u7d44\u7e54\u6210 API groups \uff0c\u4e26\u4e14\u9019\u4e9b\u3000API\u3000\u7fa4\u7d44\u5f7c\u6b64\u7368\u7acb\u5730\u9032\u884c\u7248\u672c\u63a7\u5236\uff1a $ kubectl api-resources NAME SHORTNAMES APIVERSION NAMESPACED KIND bindings v1 true Binding componentstatuses cs v1 false ComponentStatus configmaps cm v1 true ConfigMap endpoints ep v1 true Endpoints events ev v1 true Event limitranges limits v1 true LimitRange namespaces ns v1 false Namespace nodes no v1 false Node persistentvolumeclaims pvc v1 true PersistentVolumeClaim persistentvolumes pv v1 false PersistentVolume pods po v1 true Pod podtemplates v1 true PodTemplate replicationcontrollers rc v1 true ReplicationController resourcequotas quota v1 true ResourceQuota secrets v1 true Secret serviceaccounts sa v1 true ServiceAccount services svc v1 true Service mutatingwebhookconfigurations admissionregistration.k8s.io/v1 false MutatingWebhookConfiguration validatingwebhookconfigurations admissionregistration.k8s.io/v1 false ValidatingWebhookConfiguration customresourcedefinitions crd,crds apiextensions.k8s.io/v1 false CustomResourceDefinition apiservices apiregistration.k8s.io/v1 false APIService controllerrevisions apps/v1 true ControllerRevision daemonsets ds apps/v1 true DaemonSet deployments deploy apps/v1 true Deployment replicasets rs apps/v1 true ReplicaSet statefulsets sts apps/v1 true StatefulSet tokenreviews authentication.k8s.io/v1 false TokenReview localsubjectaccessreviews authorization.k8s.io/v1 true LocalSubjectAccessReview selfsubjectaccessreviews authorization.k8s.io/v1 false SelfSubjectAccessReview selfsubjectrulesreviews authorization.k8s.io/v1 false SelfSubjectRulesReview subjectaccessreviews authorization.k8s.io/v1 false SubjectAccessReview horizontalpodautoscalers hpa autoscaling/v2 true HorizontalPodAutoscaler cronjobs cj batch/v1 true CronJob jobs batch/v1 true Job certificatesigningrequests csr certificates.k8s.io/v1 false CertificateSigningRequest leases coordination.k8s.io/v1 true Lease endpointslices discovery.k8s.io/v1 true EndpointSlice events ev events.k8s.io/v1 true Event flowschemas flowcontrol.apiserver.k8s.io/v1beta2 false FlowSchema prioritylevelconfigurations flowcontrol.apiserver.k8s.io/v1beta2 false PriorityLevelConfiguration ingressclasses networking.k8s.io/v1 false IngressClass ingresses ing networking.k8s.io/v1 true Ingress networkpolicies netpol networking.k8s.io/v1 true NetworkPolicy runtimeclasses node.k8s.io/v1 false RuntimeClass poddisruptionbudgets pdb policy/v1 true PodDisruptionBudget podsecuritypolicies psp policy/v1beta1 false PodSecurityPolicy clusterrolebindings rbac.authorization.k8s.io/v1 false ClusterRoleBinding clusterroles rbac.authorization.k8s.io/v1 false ClusterRole rolebindings rbac.authorization.k8s.io/v1 true RoleBinding roles rbac.authorization.k8s.io/v1 true Role priorityclasses pc scheduling.k8s.io/v1 false PriorityClass csidrivers storage.k8s.io/v1 false CSIDriver csinodes storage.k8s.io/v1 false CSINode csistoragecapacities storage.k8s.io/v1beta1 true CSIStorageCapacity storageclasses sc storage.k8s.io/v1 false StorageClass volumeattachments storage.k8s.io/v1 false VolumeAttachment \u5982\u679c\u4f60\u597d\u5947 kubectl api-resources \u547d\u4ee4\u662f\u5982\u4f55\u69cb\u5efa\u9019\u6a23\u4e00\u500b\u652f\u6301\u7684\u8cc7\u6e90\u5217\u8868\u7684\uff0c\u9019\u88e1\u6709\u4e00\u500b\u5f88\u597d\u7684\u6280\u5de7\uff0c\u5b83\u986f\u793a\u4e86\u4efb\u4f55 kubectl \u547d\u4ee4\u9032\u884c\u4e86\u54ea\u4e9b API \u8abf\u7528\uff1a $ kubectl api-resources -v 6 # -v 6 means \"extra verbose logging\" ... I0108 ... GET https://192.168.58.2:8443/api?timeout = 32s 200 OK in 10 milliseconds I0108 ... GET https://192.168.58.2:8443/apis?timeout = 32s 200 OK in 1 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apiregistration.k8s.io/v1?timeout = 32s 200 OK in 7 milliseconds I0108 ... GET https://192.168.58.2:8443/api/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/authentication.k8s.io/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/events.k8s.io/v1?timeout = 32s 200 OK in 15 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/apps/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/autoscaling/v2beta1?timeout = 32s 200 OK in 16 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/policy/v1beta1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/scheduling.k8s.io/v1?timeout = 32s 200 OK in 14 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1?timeout = 32s 200 OK in 13 milliseconds I0108 ... GET https://192.168.58.2:8443/apis/batch/v1beta1?timeout = 32s 200 OK in 43 milliseconds ... \u5176\u5be6\u3000ubernetes\u3000\u7684\u3000API\u3000\u90fd\u5177\u5099\u4e86\u76f8\u7576\u8c50\u5bcc\u7684 meta data \u4f86\u9673\u8ff0\u9019\u500b\u3000Kubernetes API \u57fa\u672c\u8cc7\u6599\u3002\u986f\u7136\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u8b80\u53d6\uff08\u6216\u5275\u5efa\uff09\u5176\u4ed6\u8cc7\u6e90\u4f86\u5217\u51fa\u73fe\u6709\u7684\uff08\u751a\u81f3\u8a3b\u518a\u65b0\u7684\u8cc7\u6e90\u985e\u578b\uff09\uff01\u4f8b\u5982\uff0c\u4e0a\u9762\u7684\u5217\u8868\u662f\u901a\u904e\u8abf\u7528\u7279\u6b8a\u7684 /api \u548c /apis/<group-name> \u8cc7\u6e90\u7372\u5f97\u7684\u3002 Info /api \u7aef\u9ede\u5df2\u7d93\u662f\u6700\u521d\u3000Kubernetes\u3000\u5b9a\u7fa9\u8207\u4f7f\u7528\u7684\uff0c\u50c5\u7528\u65bc\u6838\u5fc3\u8cc7\u6e90\uff08pod\u3001secrets\u3001configmaps \u7b49\uff09\u3002\u4e00\u500b\u66f4\u73fe\u4ee3\u548c\u901a\u7528\u7684 /apis/<group-name> \u7aef\u9ede\u7528\u65bc\u5176\u9918\u8cc7\u6e90\uff0c\u5305\u62ec\u7528\u6236\u5b9a\u7fa9\u7684\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528 curl \u7b49\u6a19\u6e96 HTTP \u5ba2\u6236\u7aef\u8f15\u9b06\u8abf\u7528\u4e0a\u8ff0\u8cc7\u6e90\uff08\u5373 API \u7aef\u9ede\uff09\u4e26\u6aa2\u67e5\u8fd4\u56de\u7684\u8cc7\u6e90\uff08\u5373 JSON \u5c0d\u8c61\uff09\uff1a # Make Kubernetes API available on localhost:8080 # to bypass the auth step in subsequent queries: $ kubectl proxy --port = 8080 & # List all known API paths $ curl http://localhost:8080/ # List known versions of the `core` group $ curl http://localhost:8080/api # List known resources of the `core/v1` group $ curl http://localhost:8080/api/v1 # Get a particular Pod resource $ curl http://localhost:8080/api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg # List known groups (all but `core`) $ curl http://localhost:8080/apis # List known versions of the `apps` group $ curl http://localhost:8080/apis/apps # List known resources of the `apps/v1` group $ curl http://localhost:8080/apis/apps/v1 # Get a particular Deployment resource $ curl http://localhost:8080/apis/apps/v1/namespaces/default/deployments/sleep Info \u6709\u4e00\u7a2e\u66f4\u7c21\u55ae\u7684\u65b9\u6cd5\u4f86\u6aa2\u67e5 Kubernetes API\uff1a kubectl get --raw /SOME/API/PATH \u3002\u7136\u800c\uff0c\u4e0a\u9762\u7684\u7df4\u7fd2\u662f\u70ba\u4e86\u8868\u660e Kubernetes API \u4e26\u4e0d\u795e\u5947\u3002\u64c1\u6709\u4e00\u500b\u901a\u7528\u578b\u7684 HTTP \u5ba2\u6236\u7aef\u6216\u5de5\u5177\u5c31\u8db3\u4ee5\u958b\u59cb\u4f7f\u7528\u5b83\u4e86\u3002 \u8aaa\u5230\u3000 verbs (\u5373\u5c0d\u8cc7\u6e90\u7684\u64cd\u4f5c)\uff0c\u6240\u6709\u6a19\u6e96\u7684 CRUD \u64cd\u4f5c\u53ca\u5176\u50b3\u7d71\u6620\u5c04\u5230 HTTP \u65b9\u6cd5\u90fd\u5728\u90a3\u88e1\u3002\u6b64\u5916\uff0c\u9084\u652f\u6301\u8cc7\u6e90\u7684 patching \uff08\u9078\u64c7\u6027\u5b57\u6bb5\u4fee\u6539\uff09\u548c watching \uff08\u6d41\u5f0f\u96c6\u5408\u7684\u8b80\u53d6\uff09\u3002\u5728\u3000Kubernetes \u5b98\u65b9\u958b\u767c\u6307\u5357\u4e2d\u5b9a\u7fa9\u4e86\u8a73\u7d30\u7684\u8aaa\u660e: sig-architecture/api-conventions.md \uff1a ## Verbs on Resources API resources should use the traditional REST pattern: GET /<resourceNamePlural> - Retrieve a list of type <resourceName>, e.g. GET /pods returns a list of Pods. POST /<resourceNamePlural> - Create a new resource from the JSON object provided by the client. GET /<resourceNamePlural>/<name> - Retrieves a single resource with the given name, e.g. GET /pods/first returns a Pod named 'first'. Should be constant time, and the resource should be bounded in size. DELETE /<resourceNamePlural>/<name> - Delete the single resource with the given name. DeleteOptions may specify gracePeriodSeconds, the optional duration in seconds before the object should be deleted. Individual kinds may declare fields which provide a default grace period, and different kinds may have differing kind-wide default grace periods. A user provided grace period overrides a default grace period, including the zero grace period (\"now\"). DELETE /<resourceNamePlural> - Deletes a list of type <resourceName>, e.g. DELETE /pods a list of Pods. PUT /<resourceNamePlural>/<name> - Update or create the resource with the given name with the JSON object provided by the client. PATCH /<resourceNamePlural>/<name> - Selectively modify the specified fields of the resource. See more information below. GET /<resourceNamePlural>?watch=true - Receive a stream of JSON objects corresponding to changes made to any resource of the given kind over time. ## PATCH operations The API supports three different PATCH operations, determined by their corresponding Content-Type header: JSON Patch, Content-Type: application/json-patch+json As defined in RFC6902, a JSON Patch is a sequence of operations that are executed on the resource, e.g. {\"op\": \"add\", \"path\": \"/a/b/c\", \"value\": [ \"foo\", \"bar\" ]}. For more details on how to use JSON Patch, see the RFC. Merge Patch, Content-Type: application/merge-patch+json As defined in RFC7386, a Merge Patch is essentially a partial representation of the resource. The submitted JSON is \"merged\" with the current resource to create a new one, then the new one is saved. For more details on how to use Merge Patch, see the RFC. Strategic Merge Patch, Content-Type: application/strategic-merge-patch+json Strategic Merge Patch is a custom implementation of Merge Patch. For a detailed explanation of how it works and why it needed to be introduced, see here.","title":"Resources and Verbs"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-structure-and-terminology/#kinds-aka-object-schemas","text":"kind (\u985e\u578b) \u9019\u500b\u8a5e\u6703\u6642\u4e0d\u6642\u5730\u51fa\u73fe\u5728\u9019\u91cc\u548c\u90a3\u88e1\u3002\u4f8b\u5982\uff0c\u5728 kubectl api-resources \u8f38\u51fa\u4e2d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 persistentvolumes \u8cc7\u6e90\u5177\u6709\u76f8\u61c9\u7684 PersistentVolume \u985e\u578b\u3002 \u5f88\u9577\u4e00\u6bb5\u6642\u9593\u4ee5\u4f86\uff0c\u6211\u8207 Kubernetes \u7684\u4ea4\u4e92\u50c5\u9650\u65bc\u4f7f\u7528 kubectl apply \u76f2\u76ee\u5730\u70ba\u5176\u63d0\u4f9b\u6e05\u55ae\u3002\u9019\u8b93\u6211\u89ba\u5f97 kind \u7e3d\u662f\u5305\u542b\u4e00\u500b\u8cc7\u6e90\u7684 CamelCase \u540d\u7a31\uff0c\u6bd4\u5982 Pod \u3001 Service \u3001 Deployment \u7b49\u3002 $ cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: my-deployment spec: replicas: 1 selector: ... EOF \u4f46\u5be6\u969b\u4e0a\uff0c\u5c31\u7b97\u4e0d\u662f\u8cc7\u6e90\u7684 Kubernetes \u6578\u64da\u7d50\u69cb\u4e5f\u53ef\u4ee5\u6709 Kind \u7684\u5ba3\u544a\uff1a apiVersion : audit.k8s.io/v1 kind : Policy rules : - level : Metadata \u751a\u81f3 Kubernetes \u5c0d\u8c61\uff08\u5373\u6301\u4e45\u5be6\u9ad4\uff09\u7684\u8cc7\u6e90\u4e5f\u6709 Kind \uff1a $ kubectl get --raw /api | jq { \"kind\" : \"APIVersions\" , \"versions\" : [ \"v1\" ] , \"serverAddressByClientCIDRs\" : [ { \"clientCIDR\" : \"0.0.0.0/0\" , \"serverAddress\" : \"192.168.49.2:8443\" } ] } \u90a3\u9ebc\uff0c\u4ec0\u9ebc\u662f kind \uff1f Info \"All resource types have a concrete representation which is called a kind\" - Kubernetes API reference. \u55ef\uff0c\u9019\u500b\u89e3\u91cb\u4e0d\u662f\u7279\u5225\u6709\u7528! \ud83e\udd14 \u4e8b\u5be6\u8b49\u660e\uff0c\u5728 Kubernetes \u4e2d\uff0c\u4e00\u7a2e Kind \u662f object schema \u3002\u5c31\u50cf\u60a8\u901a\u5e38\u4f7f\u7528 JSON schema \u90a3\u6a23\u3002\u63db\u53e5\u8a71\u8aaa\uff0c Kind \u662f\u6307\u7279\u5b9a\u7684\u6578\u64da\u7d50\u69cb\uff0c\u5373 attributes \u548c properties \u7684\u67d0\u7a2e\u7d44\u5408\u3002 \u6839\u64da sig-architecture/api-conventions.md \uff0c Kind \u5206\u70ba\u4e09\u985e\uff1a Objects (Pod, Service, etc) - persistent entities in the system. Lists - (PodList, APIResourceList, etc) - collections of resources of one or more kinds. Simple - specific actions on objects (status, scale, etc.) or non-persistent auxiliary entities (ListOptions, Policy, etc). Kubernetes \u4e2d\u4f7f\u7528\u7684\u5927\u591a\u6578\u7269\u4ef6(object)\uff0c\u5305\u62ec API \u8fd4\u56de\u7684\u6240\u6709 JSON \u7269\u4ef6\uff0c\u90fd\u6709 kind \u5b57\u6bb5\u3002\u5b83\u5141\u8a31\u5ba2\u6236\u7aef\u548c\u670d\u52d9\u5668\u5728\u901a\u904e\u7db2\u7d61\u767c\u9001\u5b83\u5011\u6216\u5c07\u5b83\u5011\u5b58\u5132\u5728\u78c1\u76e4\u4e0a\u4e4b\u524d\u6b63\u78ba\u5730\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316\u9019\u4e9b\u7269\u4ef6\u3002","title":"Kinds aka Object Schemas"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-structure-and-terminology/#kubernetes-objects","text":"\u5c31\u50cf resource \u4e00\u6a23\uff0cKubernetes \u7528\u8a9e\u4e2d\u7684 object \u4e00\u8a5e\u662f\u4e5f\u662f\u641e\u7684\u5927\u5bb6\u6688\u982d\u8f49\u5411\u7684\u3002\u5f9e\u5ee3\u7fa9\u4e0a\u8b1b\uff0c Objects \u53ef\u4ee5\u6307\u4efb\u4f55\u6578\u64da\u7d50\u69cb\u2014\u2014\u8cc7\u6e90\u985e\u578b\u7684\u5be6\u4f8b\uff08\u5982 APIGroup\uff09\u3001\u914d\u7f6e\uff08\u5982\u5be9\u8a08\u7b56\u7565\uff09\u6216\u6301\u4e45\u5be6\u9ad4\uff08\u5982 Pod\uff09\u3002\u4f46\u662f\uff0c\u5728\u672c\u7bc0\u4e2d\uff0c\u6211\u5c07\u5728\u72f9\u7fa9\u7684\u3001\u660e\u78ba\u5b9a\u7fa9\u7684\u610f\u7fa9\u4e0a\u8a0e\u8ad6 object \u3002\u6240\u4ee5\uff0c\u6211\u5c07\u4f7f\u7528\u5927\u5beb\u7684\u8a5e Object \u4f86\u4ee3\u66ff\u3002 \u5927\u591a\u6578 Kubernetes API \u8cc7\u6e90\u4ee3\u8868 Object \u3002\u8207\u50c5\u8981\u6c42 kind \u5b57\u6bb5\u7684\u5176\u4ed6\u5f62\u5f0f\u7684\u8cc7\u6e90\u4e0d\u540c\uff0cObjects \u5fc5\u9808\u5b9a\u7fa9\u66f4\u591a\u5b57\u6bb5\uff1a kind - a string that identifies the schema this object should have apiVersion - a string that identifies the version of the schema the object should have metadata.namespace - a string with the namespace (defaults to \"default\") metadata.name - a string that uniquely identifies this object within the current namespace metadata.uid - a unique in time and space value used to distinguish between objects with the same name that have been deleted and recreated. \u6b64\u5916\uff0c metadata \u4e5f\u53ef\u80fd\u5305\u62ec\u6a19\u7c64\u548c\u8a3b\u91cb\u5b57\u6bb5\uff0c\u4ee5\u53ca\u4e00\u4e9b\u7248\u672c\u63a7\u5236\u548c\u6642\u9593\u6233\u4fe1\u606f\u3002 \u793a\u4f8b - Pod \u5c0d\u8c61\uff08\u622a\u65b7\u8f38\u51fa\uff09\uff1a $ kubectl get --raw /api/v1/namespaces/default/pods/sleep-7c7db887d8-dkkcg | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"Pod\" , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"sleep-7c7db887d8-dkkcg\" , \"uid\" : \"32bf410a-0009-484e-adac-21179ec28f0f\" , \"labels\" : { \"app\" : \"sleep\" , \"pod-template-hash\" : \"7c7db887d8\" } , \"creationTimestamp\" : \"2022-01-08T18:10:04Z\" , \"resourceVersion\" : \"465766\" } , \"spec\" : { ... } , \"status\" : { ... } } \u5982\u4e0a\u4f8b\u6240\u793a\uff0cKubernetes \u5c0d\u8c61\u901a\u5e38\u5177\u6709 spec \uff08\u671f\u671b\u72c0\u614b\uff09\u548c status \uff08\u5be6\u969b\u72c0\u614b\uff09\u5b57\u6bb5\u3002\u4f46\u60c5\u6cc1\u4e26\u975e\u7e3d\u662f\u5982\u6b64\u3002\u5c07\u4e0a\u9762\u7684\u8f38\u51fa\u8207\u4e0b\u9762\u7684 ConfigMap \u5c0d\u8c61\u9032\u884c\u6bd4\u8f03\uff1a $ kubectl get --raw /api/v1/namespaces/default/configmaps/informer-dynamic-simple-wzgmx | jq { \"apiVersion\" : \"v1\" , \"kind\" : \"ConfigMap\" , \"data\" : { \"foo\" : \"bar\" } , \"metadata\" : { \"namespace\" : \"default\" , \"name\" : \"informer-dynamic-simple-wzgmx\" , \"uid\" : \"74471398-0244-4686-b490-7007f6246a63\" , \"creationTimestamp\" : \"2022-01-06T21:45:04Z\" , \"generateName\" : \"informer-dynamic-simple-\" , \"resourceVersion\" : \"418185\" } } \u5f9e\u4ee3\u78bc\u4e2d\u8655\u7406 Kubernetes API \u6d89\u53ca\u5230\u5927\u91cf\u7684 Object \u64cd\u4f5c\uff0c\u56e0\u6b64\u5fc5\u9808\u5c0d\u5e38\u898b\u7684\u5c0d\u8c61\u7d50\u69cb\u6709\u7d2e\u5be6\u7684\u7406\u89e3\u3002 kubectl explain \u547d\u4ee4\u53ef\u4ee5\u5e6b\u52a9\u60a8\u3002\u5b83\u6700\u9177\u7684\u90e8\u5206\u662f\u5b83\u4e0d\u50c5\u53ef\u4ee5\u5728\u8cc7\u6e90\u4e0a\u8abf\u7528\uff0c\u9084\u53ef\u4ee5\u5728\u5d4c\u5957\u5b57\u6bb5\u4e0a\u8abf\u7528\uff1a $ kubectl explain deployment.spec.template KIND: Deployment VERSION: apps/v1 RESOURCE: template <Object> DESCRIPTION: Template describes the pods that will be created. PodTemplateSpec describes the data a pod should have when created from a template FIELDS: metadata <Object> Standard object ' s metadata. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata spec <Object> Specification of the desired behavior of the pod. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status","title":"Kubernetes Objects"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-structure-and-terminology/#summarizing","text":"Kubernetes \u7528\u8a9e\u4e2d\u7684 resource \u53ef\u4ee5\u6307\u8cc7\u6e90\u985e\u578b\u548c\u8cc7\u6e90\u5be6\u4f8b\u3002\u8cc7\u6e90\u985e\u578b\u88ab\u7d44\u7e54\u6210 API groups\uff0c\u4e26\u4e14 API groups\u662f\u7248\u672c\u5316\u7684\u3002\u6bcf\u500b\u8cc7\u6e90\u8868\u793a\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u7279\u5b9a\u6a21\u5f0f\u3002\u96d6\u7136\u6bcf\u500b\u8cc7\u6e90\u90fd\u9075\u5faa\u7531\u5176\u7a2e\u985e\u5b9a\u7fa9\u7684\u5177\u9ad4\u7d50\u69cb\uff0c\u4f46\u4e26\u975e\u6bcf\u500b\u8cc7\u6e90\u90fd\u4ee3\u8868\u4e00\u500b Kubernetes \u5c0d\u8c61\u3002\u5c0d\u50cf\u662f\u8868\u793a\u610f\u5716\u8a18\u9304\u7684\u6301\u4e45\u5be6\u9ad4\u3002\u4e0d\u540c\u7a2e\u985e\u7684\u5c0d\u8c61\u5177\u6709\u4e0d\u540c\u7684\u7d50\u69cb\uff0c\u4f46\u6240\u6709\u5c0d\u50cf\u90fd\u5e36\u6709\u5171\u540c\u7684\u5143\u6578\u64da\u5c6c\u6027\uff0c\u4f8b\u5982\u547d\u540d\u7a7a\u9593\u3001\u540d\u7a31\u3001uid \u6216 creationTimestamp\u3002","title":"Summarizing"},{"location":"kubernetes/05-reference/using-api/kubernetes-api-structure-and-terminology/#whats-next","text":"\u5c0d Kubernetes API \u7684\u7406\u8ad6\u90e8\u5206\u6709\u66f4\u597d\u7684\u4e86\u89e3\u55ce\uff1f \u592a\u597d\u4e86\uff01\u3000\u63a5\u4e0b\u4f86\u6211\u5011\u5c07\u7528\u4e00\u500b\u7c21\u55ae\u7684 HTTP \u5ba2\u6236\u7aef\u8abf\u7528\u5b83(\u4e8b\u5be6\u8b49\u660e\u9019\u4e0d\u662f\u4e00\u4ef6\u5bb9\u6613\u7684\u4e8b\uff0c\u6709\u5f88\u591a\u5751\u8981\u8df3)\u3002 \u7576\u7406\u8ad6\u548c\u5be6\u8e10\u76f8\u63d0\u4e26\u8ad6\u6642\uff0c\u6211\u5efa\u8b70\u770b\u4e00\u4e0b k8s.io/api \u548c k8s.io/apimachinery \u6a21\u584a - \u9019\u662f \u5b98\u65b9 Go \u5ba2\u6236\u7aef \u7684\u5169\u500b\u4e3b\u8981\u4f9d\u8cf4\u9805\u3002 k8s.io/api \u70ba Kubernetes \u5c0d\u8c61\u5b9a\u7fa9\u7684 Go \u7d50\u69cb\uff0c\u800c k8s.io/apimachinery \u5e36\u4f86\u4e86\u8f03\u4f4e\u7d1a\u5225\u7684\u69cb\u5efa\u584a\u548c\u5e38\u898b\u7684 API \u529f\u80fd\uff0c\u5982\u5e8f\u5217\u5316\u3001\u985e\u578b\u8f49\u63db\u6216\u932f\u8aa4\u8655\u7406\u3002 \u9019\u662f\u6211\u5c0d\u9019\u5169\u500b\u6a21\u584a\u7684\u5716\u89e3\u6982\u8ff0 \u3002 Talk is cheap, show me the code? \u5927\u5bb6\u53ef\u770b\u6211\u5728 GitHub \u4e0a\u6536\u96c6\u7684 Kubernetes client-go \u793a\u4f8b\ud83d\ude09 Resources Kubernetes Documentation - API Overview Kubernetes Documentation - API Concepts Kubernetes Documentation- Understanding Kubernetes Objects SIG Architecture - API Conventions Building stuff with the Kubernetes API \u2014 Exploring API objects","title":"What's next?"},{"location":"kubernetes/05-reference/using-api/working-with-k8s-api/","text":"Working with Kubernetes API \u00b6 \u539f\u6587: https://iximiuz.com/en/series/working-with-kubernetes-api/ Kubernetes \u5df2\u7d93\u6210\u70ba\u6211\u5011\u8a31\u591a\u4eba\u65b0\u4e00\u4ee3\u57fa\u790e\u8a2d\u65bd\u7684\u901a\u7528\u8a9e\u3002\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\uff0c\u9019\u662f\u7531\u65bc Kubernetes \u63d0\u4f9b\u4e86\u53ef\u79fb\u690d\u7684 API \u4f86\u7ba1\u7406\u670d\u52d9\u5668\u8cc7\u6e90\u3002\u5c31\u50cf POSIX \u5b9a\u7fa9\u4e86\u6d88\u8017\u55ae\u53f0\u8a08\u7b97\u6a5f\u8cc7\u6e90\u7684\u6a19\u6e96\u65b9\u5f0f\u4e00\u6a23\uff0cKubernetes API \u4ee5\u8207\u63d0\u4f9b\u8005\u7121\u95dc\u7684\u65b9\u5f0f\u555f\u7528\u4e86\u6578\u64da\u4e2d\u5fc3\u8cc7\u6e90\u7684\u6d88\u8017\u3002 \u9019\u662f\u95dc\u65bc\u5f9e\u547d\u4ee4\u884c\u548c\u4ee3\u78bc\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\uff1a \u672c\u7cfb\u5217\u9996\u5148\u6982\u8ff0\u6700\u57fa\u672c\u7684 API \u6982\u5ff5\u3002 \u89e3\u91cb\u4e86Resource\u3001Kind\u200b\u200b\u548cObject\u7b49\u95dc\u9375\u7684\u57fa\u790e\u77e5\u8b58\u3002 \u8aaa\u660e API \u7d50\u69cb\u548c\u8853\u8a9e\u3002 \u6709\u5927\u91cf\u95dc\u65bc\u5982\u4f55\u8a2a\u554f\u548c\u64f4\u5c55 API \u7684\u5be6\u969b\u793a\u4f8b\u3002 \u9019\u7cfb\u5217\u9084\u53ef\u4ee5\u5e6b\u52a9\u8b80\u8005\u4e86\u89e3\u7576\u4ee3 Kubernetes API \u5ba2\u6236\u7aef\uff08Go \u548c Rust\uff09\uff0c\u5f9e\u57fa\u672c\u7684 REST \u529f\u80fd\u958b\u59cb\uff0c\u5230 Informers \u548c Work Queues \u7b49\u9ad8\u7d1a\u62bd\u8c61\uff0c\u56e0\u6b64\u5b83\u5c0d\u7de8\u5beb\u5404\u7a2e Kubernetes \u81ea\u52d5\u5316\u7684\u4eba\u5f88\u6709\u7528\u5305\u62ec\u81ea\u5b9a\u7fa9 custom operator \u548c controller\u3002 Kubernetes API Basics - Resources, Kinds, and Objects How To Call Kubernetes API using Simple HTTP Client How To Call Kubernetes API using Go - Types and Common Machinery How To Extend Kubernetes API - Kubernetes vs. Django How To Develop Kubernetes CLIs Like a Pro","title":"\u4f7f\u7528 K8S API"},{"location":"kubernetes/05-reference/using-api/working-with-k8s-api/#working-with-kubernetes-api","text":"\u539f\u6587: https://iximiuz.com/en/series/working-with-kubernetes-api/ Kubernetes \u5df2\u7d93\u6210\u70ba\u6211\u5011\u8a31\u591a\u4eba\u65b0\u4e00\u4ee3\u57fa\u790e\u8a2d\u65bd\u7684\u901a\u7528\u8a9e\u3002\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\uff0c\u9019\u662f\u7531\u65bc Kubernetes \u63d0\u4f9b\u4e86\u53ef\u79fb\u690d\u7684 API \u4f86\u7ba1\u7406\u670d\u52d9\u5668\u8cc7\u6e90\u3002\u5c31\u50cf POSIX \u5b9a\u7fa9\u4e86\u6d88\u8017\u55ae\u53f0\u8a08\u7b97\u6a5f\u8cc7\u6e90\u7684\u6a19\u6e96\u65b9\u5f0f\u4e00\u6a23\uff0cKubernetes API \u4ee5\u8207\u63d0\u4f9b\u8005\u7121\u95dc\u7684\u65b9\u5f0f\u555f\u7528\u4e86\u6578\u64da\u4e2d\u5fc3\u8cc7\u6e90\u7684\u6d88\u8017\u3002 \u9019\u662f\u95dc\u65bc\u5f9e\u547d\u4ee4\u884c\u548c\u4ee3\u78bc\u4f7f\u7528 Kubernetes API \u7684\u7cfb\u5217\u6587\uff1a \u672c\u7cfb\u5217\u9996\u5148\u6982\u8ff0\u6700\u57fa\u672c\u7684 API \u6982\u5ff5\u3002 \u89e3\u91cb\u4e86Resource\u3001Kind\u200b\u200b\u548cObject\u7b49\u95dc\u9375\u7684\u57fa\u790e\u77e5\u8b58\u3002 \u8aaa\u660e API \u7d50\u69cb\u548c\u8853\u8a9e\u3002 \u6709\u5927\u91cf\u95dc\u65bc\u5982\u4f55\u8a2a\u554f\u548c\u64f4\u5c55 API \u7684\u5be6\u969b\u793a\u4f8b\u3002 \u9019\u7cfb\u5217\u9084\u53ef\u4ee5\u5e6b\u52a9\u8b80\u8005\u4e86\u89e3\u7576\u4ee3 Kubernetes API \u5ba2\u6236\u7aef\uff08Go \u548c Rust\uff09\uff0c\u5f9e\u57fa\u672c\u7684 REST \u529f\u80fd\u958b\u59cb\uff0c\u5230 Informers \u548c Work Queues \u7b49\u9ad8\u7d1a\u62bd\u8c61\uff0c\u56e0\u6b64\u5b83\u5c0d\u7de8\u5beb\u5404\u7a2e Kubernetes \u81ea\u52d5\u5316\u7684\u4eba\u5f88\u6709\u7528\u5305\u62ec\u81ea\u5b9a\u7fa9 custom operator \u548c controller\u3002 Kubernetes API Basics - Resources, Kinds, and Objects How To Call Kubernetes API using Simple HTTP Client How To Call Kubernetes API using Go - Types and Common Machinery How To Extend Kubernetes API - Kubernetes vs. Django How To Develop Kubernetes CLIs Like a Pro","title":"Working with Kubernetes API"},{"location":"kubernetes/observability/concept/fullstack-monitoring/","text":"Kubernetes \u53ef\u89c0\u5bdf\u6027\u548c\u76e3\u63a7 \u00b6 \u539f\u6587: https://blogs.vmware.com/management/2020/09/kubernetes-observability-monitoring-in-the-cloud.html \u96a8\u8457 Kubernetes \u7684\u5f15\u5165\uff0c\u201cday 2 operations\u201d \u7684\u8b70\u984c\u4e5f\u96a8\u4e4b\u800c\u4f86\u3002\u80fd\u5920\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u3001Kubernetes \u5806\u68e7\u3001\u5e95\u5c64\u57fa\u790e\u8a2d\u65bd\u548c\u7db2\u7d61\u767c\u751f\u7684\u60c5\u6cc1\u662f\u5728\u57fa\u790e\u8a2d\u65bd\u4e4b\u4e0a\u90e8\u7f72 Kubernetes \u61c9\u7528\u7a0b\u5e8f\u6642\u9700\u8981\u8003\u616e\u7684\u65b9\u9762\u4e4b\u4e00\u3002 \u5c0d\u65bc\u4eca\u5929\u7684\u96f2\u7ba1\u7406\u54e1\u4f86\u8aaa\uff0c\u80fd\u5920\u76e3\u63a7\u6574\u500b\u5806\u68e7\u662f\u4e00\u9805\u6709\u8da3\u7684\u4efb\u52d9\u3002\u56e0\u70ba\u5728\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u8a2d\u65bd\u65b9\u9762\u90fd\u6709\u5f88\u591a\u7d44\u4ef6\u3002\u5373\u4f7f Kubernetes \u81ea\u52d5\u5316\u4e86\u5f88\u591a\u8907\u96dc\u6027\uff0c\u5b83\u4ecd\u7136\u9700\u8981\u88ab\u76e3\u63a7\uff0c\u6211\u5011\u9700\u8981\u78ba\u4fdd\u5806\u68e7\u4e2d\u7684\u6240\u6709\u7d44\u4ef6\u90fd\u6309\u9810\u671f\u5de5\u4f5c\uff0c\u4f46\u4e5f\u8981\u6309\u7167\u7528\u6236\u7684\u671f\u671b\u4ea4\u4ed8\u3002\u70ba\u6b64\uff0c\u60a8\u9700\u8981\u80fd\u5920\u89c0\u5bdf\u6574\u500b\u5806\u68e7\u3002\u5f9e\u4f7f\u7528\u61c9\u7528\u7a0b\u5e8f\u7684\u7528\u6236\u5230\u5e95\u5c64\u57fa\u790e\u8a2d\u65bd\u53ca\u5176\u6240\u6709\u7d44\u4ef6\u3002 \u4e0b\u5716\u7d66\u51fa\u4e86\u5f9e\u61c9\u7528\u7a0b\u5e8f\u5230\u57fa\u790e\u67b6\u69cb\u7684\u5b8c\u6574\u5806\u68e7\u7684\u5716\u5f62\u8868\u793a\u3002 \u5f9e\u4e0a\u5716\u4e2d\u6211\u5011\u53ef\u4ee5\u770b\u5230\uff0c\u6709\u5f88\u591a\u7d44\u4ef6\u7d44\u6210\u4e86\u4e00\u500b\u5b8c\u6574\u7684\uff08Kubernetes\uff09\u61c9\u7528\u7a0b\u5e8f\u68e7\u3002\u4e00\u5207\u90fd\u9700\u8981\u88ab\u76e3\u63a7\u548c\u89c0\u5bdf\u3002\u5f9e\u4e0a\u5230\u4e0b\u6216\u5f9e\u4e0b\u5230\u4e0a\uff0c\u53d6\u6c7a\u65bc\u60a8\u4f86\u81ea\u5e73\u53f0\u7684\u7528\u6236/\u904b\u71df\u5546\u985e\u578b\u3002 \u4e0d\u540c\u7684\u7528\u6236 \u4e0d\u540c\u7684\u5de5\u5177 \u00b6 \u9019\u8aaa\u660e\u4e86\u4e0d\u540c\u7684\u7528\u6236\u5728\u76e3\u63a7\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\u6642\u6709\u4e0d\u540c\u7684\u76ee\u6a19\u3002 \u57fa\u790e\u67b6\u69cb\u7ba1\u7406\u4eba\u54e1\u901a\u5e38\u5c08\u6ce8\u65bc\u57fa\u790e\u8a2d\u65bd\u7d44\u4ef6\u3002\u800c\u958b\u767c\u4eba\u54e1\u66f4\u95dc\u6ce8\u61c9\u7528\u7a0b\u5e8f\u672c\u8eab\u3002\u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f\uff0c\u6211\u5011\u6709\u5e73\u53f0\u7ba1\u7406\u4eba\u54e1\uff0c\u652f\u6301\u61c9\u7528\u7a0b\u5e8f\u958b\u767c\u4eba\u54e1\uff0c\u4ed6\u5011\u9700\u8981\u540c\u6642\u95dc\u6ce8\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u8a2d\u65bd\u3002 \u5f9e\u4e0a\u5716\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u51fa\uff0c\u4e0d\u540c\u7684\u7528\u6236\u5728\u76e3\u63a7\u4e0a\u6703\u6709\u4e0d\u540c\u7684\u9700\u6c42\u8207\u76ee\u6a19\u3002\u70ba\u4e86\u6eff\u8db3\u9019\u4e9b\u9700\u6c42\uff0c\u60a8\u901a\u5e38\u9700\u8981\u4e0d\u540c\u7684\u5de5\u5177\u4f86\u7d44\u6210\u76e3\u63a7\u548c\u89c0\u5bdf\u6280\u5806\u68e7\u3002","title":"Kubernetes \u53ef\u89c0\u5bdf\u6027"},{"location":"kubernetes/observability/concept/fullstack-monitoring/#kubernetes","text":"\u539f\u6587: https://blogs.vmware.com/management/2020/09/kubernetes-observability-monitoring-in-the-cloud.html \u96a8\u8457 Kubernetes \u7684\u5f15\u5165\uff0c\u201cday 2 operations\u201d \u7684\u8b70\u984c\u4e5f\u96a8\u4e4b\u800c\u4f86\u3002\u80fd\u5920\u67e5\u770b\u61c9\u7528\u7a0b\u5e8f\u3001Kubernetes \u5806\u68e7\u3001\u5e95\u5c64\u57fa\u790e\u8a2d\u65bd\u548c\u7db2\u7d61\u767c\u751f\u7684\u60c5\u6cc1\u662f\u5728\u57fa\u790e\u8a2d\u65bd\u4e4b\u4e0a\u90e8\u7f72 Kubernetes \u61c9\u7528\u7a0b\u5e8f\u6642\u9700\u8981\u8003\u616e\u7684\u65b9\u9762\u4e4b\u4e00\u3002 \u5c0d\u65bc\u4eca\u5929\u7684\u96f2\u7ba1\u7406\u54e1\u4f86\u8aaa\uff0c\u80fd\u5920\u76e3\u63a7\u6574\u500b\u5806\u68e7\u662f\u4e00\u9805\u6709\u8da3\u7684\u4efb\u52d9\u3002\u56e0\u70ba\u5728\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u8a2d\u65bd\u65b9\u9762\u90fd\u6709\u5f88\u591a\u7d44\u4ef6\u3002\u5373\u4f7f Kubernetes \u81ea\u52d5\u5316\u4e86\u5f88\u591a\u8907\u96dc\u6027\uff0c\u5b83\u4ecd\u7136\u9700\u8981\u88ab\u76e3\u63a7\uff0c\u6211\u5011\u9700\u8981\u78ba\u4fdd\u5806\u68e7\u4e2d\u7684\u6240\u6709\u7d44\u4ef6\u90fd\u6309\u9810\u671f\u5de5\u4f5c\uff0c\u4f46\u4e5f\u8981\u6309\u7167\u7528\u6236\u7684\u671f\u671b\u4ea4\u4ed8\u3002\u70ba\u6b64\uff0c\u60a8\u9700\u8981\u80fd\u5920\u89c0\u5bdf\u6574\u500b\u5806\u68e7\u3002\u5f9e\u4f7f\u7528\u61c9\u7528\u7a0b\u5e8f\u7684\u7528\u6236\u5230\u5e95\u5c64\u57fa\u790e\u8a2d\u65bd\u53ca\u5176\u6240\u6709\u7d44\u4ef6\u3002 \u4e0b\u5716\u7d66\u51fa\u4e86\u5f9e\u61c9\u7528\u7a0b\u5e8f\u5230\u57fa\u790e\u67b6\u69cb\u7684\u5b8c\u6574\u5806\u68e7\u7684\u5716\u5f62\u8868\u793a\u3002 \u5f9e\u4e0a\u5716\u4e2d\u6211\u5011\u53ef\u4ee5\u770b\u5230\uff0c\u6709\u5f88\u591a\u7d44\u4ef6\u7d44\u6210\u4e86\u4e00\u500b\u5b8c\u6574\u7684\uff08Kubernetes\uff09\u61c9\u7528\u7a0b\u5e8f\u68e7\u3002\u4e00\u5207\u90fd\u9700\u8981\u88ab\u76e3\u63a7\u548c\u89c0\u5bdf\u3002\u5f9e\u4e0a\u5230\u4e0b\u6216\u5f9e\u4e0b\u5230\u4e0a\uff0c\u53d6\u6c7a\u65bc\u60a8\u4f86\u81ea\u5e73\u53f0\u7684\u7528\u6236/\u904b\u71df\u5546\u985e\u578b\u3002","title":"Kubernetes \u53ef\u89c0\u5bdf\u6027\u548c\u76e3\u63a7"},{"location":"kubernetes/observability/concept/fullstack-monitoring/#_1","text":"\u9019\u8aaa\u660e\u4e86\u4e0d\u540c\u7684\u7528\u6236\u5728\u76e3\u63a7\u61c9\u7528\u7a0b\u5e8f\u5806\u68e7\u6642\u6709\u4e0d\u540c\u7684\u76ee\u6a19\u3002 \u57fa\u790e\u67b6\u69cb\u7ba1\u7406\u4eba\u54e1\u901a\u5e38\u5c08\u6ce8\u65bc\u57fa\u790e\u8a2d\u65bd\u7d44\u4ef6\u3002\u800c\u958b\u767c\u4eba\u54e1\u66f4\u95dc\u6ce8\u61c9\u7528\u7a0b\u5e8f\u672c\u8eab\u3002\u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f\uff0c\u6211\u5011\u6709\u5e73\u53f0\u7ba1\u7406\u4eba\u54e1\uff0c\u652f\u6301\u61c9\u7528\u7a0b\u5e8f\u958b\u767c\u4eba\u54e1\uff0c\u4ed6\u5011\u9700\u8981\u540c\u6642\u95dc\u6ce8\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u8a2d\u65bd\u3002 \u5f9e\u4e0a\u5716\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u51fa\uff0c\u4e0d\u540c\u7684\u7528\u6236\u5728\u76e3\u63a7\u4e0a\u6703\u6709\u4e0d\u540c\u7684\u9700\u6c42\u8207\u76ee\u6a19\u3002\u70ba\u4e86\u6eff\u8db3\u9019\u4e9b\u9700\u6c42\uff0c\u60a8\u901a\u5e38\u9700\u8981\u4e0d\u540c\u7684\u5de5\u5177\u4f86\u7d44\u6210\u76e3\u63a7\u548c\u89c0\u5bdf\u6280\u5806\u68e7\u3002","title":"\u4e0d\u540c\u7684\u7528\u6236 \u4e0d\u540c\u7684\u5de5\u5177"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/","text":"\u76e3\u63a7 Kubernetes \u7684\u6311\u6230 \u00b6 \u539f\u6587: https://blogs.vmware.com/management/2020/09/kubernetes-observability-monitoring-in-the-cloud.html \u76e3\u63a7 Kubernetes \u6311\u6230\u7684\u6838\u5fc3\u5728\u65bc\u5176\u67b6\u69cb\uff0c\u4ee5\u53ca\u5b83\u7684\u8a2d\u8a08\u76ee\u7684\u2014 \u7de8\u6392\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09 \u3002\u5b83\u65e8\u5728\u8b93\u6211\u5011\u64fa\u812b\u7ba1\u7406\u201c \u5bf5\u7269 (pets) \u201d\u7684\u8ca0\u64d4\uff0c\u5f15\u9818\u6211\u5011\u9032\u5165\u4e00\u500b\u7c21\u55ae\u7ba1\u7406\u201c \u653e\u7267\u725b (cattle) \u201d\u7684\u65b0\u6642\u4ee3\u3002\u4f46\u662f\u4efb\u4f55\u7267\u5834\u4e3b\u90fd\u6703\u544a\u8a34\u4f60\uff0c\u990a\u725b\u4ecd\u7136\u9700\u8981\u76f8\u7576\u5927\u7684\u52aa\u529b\uff0c\u800c\u4e14\u4e26\u975e\u6c92\u6709\u5371\u96aa\u3002 Kubernetes \u672c\u8cea\u4e0a\u662f\u4e00\u500b\u8907\u96dc\u7684\u3001\u591a\u5c64\u7684\u3001\u4e0d\u65b7\u8b8a\u5316\u7684\u670d\u52d9\u548c\u8cc7\u6e90\u9663\u5217\u3002\u5c0d\u914d\u7f6e\u6587\u4ef6\u7684\u7c21\u55ae\u66f4\u6539\u53ef\u80fd\u6703\u8b93\u60a8\u548c\u60a8\u7684\u5718\u968a\u6df9\u6c92\u5728\u65b0\u6578\u64da\u7684\u6d77\u562f\u4e2d\u3002\u66f4\u7cdf\u7cd5\u7684\u662f\uff0c\u8a31\u591a\uff08\u5982\u679c\u4e0d\u662f\u5927\u591a\u6578\u7684\u8a71\uff09\u73fe\u6709\u76e3\u63a7\u5de5\u5177\u90fd\u6709\u4e00\u500b\u66f4\u7c21\u55ae\u7684\u67b6\u69cb\uff0c\u5b83\u5011\u5047\u8a2d\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u6216\u591a\u6216\u5c11\u662f\u6c38\u4e45\u6027\u7684\u3002\u8a66\u5716\u7528\u50b3\u7d71\u7684\u76e3\u63a7\u5de5\u5177\u4f86\u76e3\u63a7 Kubernetes \uff0c\u57fa\u672c\u4e0a\u662f\u4e0d\u53ef\u80fd\u9054\u6210\u76ee\u6a19\u3002 \u9664\u4e86\u52d5\u7269\u96b1\u55bb (pets \u8207 cattle)\u4e4b\u5916\uff0cKubernetes \u7368\u7279\u7684\u67b6\u69cb\u4e00\u76f4\u5ef6\u4f38\u5230\u5b83\u5982\u4f55\u767c\u51fa\u6578\u64da\u3002 \u95dc\u65bc \u65e5\u8a8c\u8a18\u9304 \uff0c\u6b63\u5982\u4eba\u5011\u6240\u671f\u671b\u7684\u90a3\u6a23\uff0cKubernetes \u5728 \u7bc0\u9ede \u7d1a\u5225\u7ba1\u7406\u548c\u5b58\u5132\u5bb9\u5668\u65e5\u8a8c\u3002\u4f46\u662f\uff0c\u7531\u65bc\u7bc0\u9ede\u7684\u78c1\u76e4\u7a7a\u9593\u6709\u9650\uff0c\u5b83\u5011\u6703\u5f88\u5feb\u8f2a\u63db\u3002\u4e00\u500b\u65b9\u4fbf\u7684\u529f\u80fd\uff0c\u76f4\u5230\u60a8\u767c\u73fe\u81ea\u5df1\u5728\u51cc\u6668 3 \u9ede\u89e3\u6c7a\u751f\u7522\u554f\u984c\u3002\u6b64\u5916\uff0cKubernetes \u547d\u4ee4\u884c\u5de5\u5177 kubectl \u50c5\u6309\u9700\u67e5\u8a62\u4e00\u5c0f\u90e8\u5206\u76ee\u6a19\u7684\u65e5\u8a8c\u3002\u9019\u4f7f\u5f97\u901a\u904e\u65e5\u8a8c\u201cgrepping\u201d\u6210\u70ba\u4e00\u9805\u4e0d\u53ef\u80fd\u5b8c\u6210\u7684\u4efb\u52d9\u3002\u50c5\u9019\u4e00\u4ee4\u4eba\u982d\u75bc\u7684\u554f\u984c\u5c31\u5c0e\u81f4\u5927\u591a\u6578\u4eba\u6295\u8cc7\u65bc\u7b2c\u4e09\u65b9\u5de5\u5177\u6216\u89e3\u6c7a\u65b9\u6848\uff0c\u4f8b\u5982 ELK Stack, Loki \u7b49\uff0c\u4ee5\u6eff\u8db3\u4ed6\u5011\u7684 Kubernetes \u65e5\u8a8c\u8a18\u9304\u9700\u6c42\u3002 \u5728 \u6307\u6a19 \u65b9\u9762\uff0c\u9019\u4e9b\u6578\u64da\u53ef\u4ee5\u901a\u904e Kubernetes API \u8f15\u9b06\u7372\u5f97\u3002\u4f46\u662f\uff0c\u6578\u64da\u6a21\u578b\u975e\u5e38\u8c50\u5bcc\uff0c\u60a8\u5c07\u82b1\u8cbb\u7121\u6578\u6642\u9593\u8a2d\u8a08\u548c\u5be6\u65bd\u6a19\u8a18\u65b9\u6848\u4f86\u7406\u89e3\u6578\u64da\u3002\u6700\u91cd\u8981\u7684\u662f\uff0c\u60a8\u53ef\u4ee5\u81ea\u884c\u8a2d\u8a08\u6216\u4f7f\u7528 Prometheus \u7b49\u5de5\u5177\u4f86\u5b58\u5132\u3001\u95dc\u806f\u548c\u5206\u6790\u6240\u6709\u9019\u4e9b\u6578\u64da\uff01 \u65e5\u8a8c\u548c\u6307\u6a19\u751a\u81f3\u4e0d\u662f\u96c6\u7fa4\u767c\u51fa\u7684\u4e0d\u540c\u985e\u578b\u6578\u64da\u7684\u4e00\u534a\u3002\u4f46\u662f\uff0c\u5047\u8a2d\u60a8\u4f7f\u7528\u66f4\u50b3\u7d71\u7684\u201c3 \u500b\u652f\u67f1\u201d\u65b9\u6cd5\u4f86\u6536\u96c6\u9019\u4e9b\u6578\u64da\uff0c\u4ee5\u7372\u53d6\u53ef\u89c0\u5bdf\u6027\u7684\u4e0d\u540c\u6578\u64da\u6e90\u548c\u5de5\u5177\u3002\u4f60\u5f97\u5230\u4e86\u6240\u6709\u7684\u6578\u64da\uff0c\u4f46\u4f60\u73fe\u5728\u70ba\u4f60\u7684\u6578\u64da\u5de5\u4f5c\uff0c\u800c\u4e0d\u662f\u76f8\u53cd\uff0c\u56e0\u70ba\u5b83\u4ecd\u7136\u662f\u5b64\u7acb\u7684\uff01 \u5982\u679c\u60a8\u7684\u6578\u64da\u6e90\u4e4b\u9593\u6c92\u6709\u4e0a\u4e0b\u6587\uff0c\u60a8\u5c07\u4e0d\u5f97\u4e0d\u52aa\u529b\u5c0b\u627e\u806f\u7e6b\u548c\u76f8\u95dc\u6027\u3002\u9019\u5c07\u82b1\u8cbb\u60a8\u5927\u91cf\u7684\u6642\u9593\u548c\u91d1\u9322\u3002 \u61c9\u8a72\u5728 Kubernetes \u4e2d\u89c0\u5bdf\u4ec0\u9ebc\uff1f \u00b6 \u65e2\u7136\u6211\u5011\u4e86\u89e3\u4e86\u89c0\u5bdf Kubernetes \u96c6\u7fa4\u7684\u8af8\u591a\u6311\u6230\uff0c\u90a3\u9ebc\u6211\u5011\u5f9e\u54ea\u88e1\u958b\u59cb\u89c0\u5bdf Kubernetes \u5462\uff1f\u8b93\u6211\u5011\u9996\u5148\u78ba\u5b9a\u60a8\u61c9\u8a72\u8003\u616e\u6536\u96c6\u7684\u6578\u64da\u985e\u578b\uff0c\u7a0d\u5f8c\u6211\u5011\u5c07\u4ecb\u7d39\u5982\u4f55\u95dc\u806f\u548c\u5206\u6790\u6240\u6709\u9019\u4e9b\u6578\u64da\u3002 \u65e5\u8a8c Logs \u00b6 \u53ef\u4ee5\u8aaa\uff0c\u7b2c\u4e00\u500b\u4e5f\u662f\u6700\u91cd\u8981\u7684\u8d77\u9ede\u662f \u65e5\u8a8c \u3002 \u65e5\u8a8c \u662f\u4efb\u4f55\u74b0\u5883\u4e0b\u53ef\u89c0\u5bdf\u6027\u7684\u57fa\u790e\u3002\u6b63\u5982\u60a8\u53ef\u80fd\u5df2\u7d93\u731c\u5230\u7684\u90a3\u6a23\uff0cKubernetes \u6709\u5404\u7a2e\u5404\u6a23\u7684\u65e5\u8a8c\u4f86\u6e90\u3002 Kubernetes \u4e2d\u7684\u65e5\u8a8c\u985e\u578b\uff1a Container Logs Node Logs Audit Logs Event Logs Ingress Logs API Server Logs Kubernetes \u53ef\u89c0\u5bdf\u6027\u624b\u518a\u7684\u4e00\u500b\u95dc\u9375\u90e8\u5206\u61c9\u8a72\u5f9e\u6355\u7372\u76e1\u53ef\u80fd\u591a\u7684\uff08\u5982\u679c\u4e0d\u662f\u5168\u90e8\u7684\u8a71\uff09\u9019\u4e9b\u985e\u578b\u7684\u65e5\u8a8c\u53ef\u4f9b\u60a8\u4f7f\u7528\u3002 \u6307\u6a19 Metrics \u00b6 \u6307\u6a19\u76e3\u63a7\u66f4\u76f4\u63a5\u4e00\u4e9b\uff0c\u56e0\u70ba\u5728\u66f4\u50b3\u7d71\u7684\u57fa\u790e\u8a2d\u65bd\u4e2d\u767c\u73fe\u7684\u8a31\u591a\u76f8\u540c\u6307\u6a19\u90fd\u53ef\u4ee5\u5728 Kubernetes \u4e2d\u627e\u5230\u3002\u4f46\u662f\uff0c\u60a8\u61c9\u8a72\u6ce8\u610f\u5f88\u591a\u7279\u5b9a\u65bc Kubernetes \u7684\u6307\u6a19\u3002\u6b64\u5916\uff0c\u5728 Kubernetes \u4e2d\u6536\u96c6\u6307\u6a19\u6709\u9ede\u56f0\u96e3\uff0c\u56e0\u70ba\u76ee\u524d\u9084\u6c92\u6709\u91dd\u5c0d\u6307\u6a19\u7684\u539f\u751f\u89e3\u6c7a\u65b9\u6848\u3002 \u516c\u6709\u96f2\u4f9b\u61c9\u5546\u7684 Kubernetes \u7ba1\u7406\u5e73\u53f0\uff08\u4f8b\u5982 Amazon Elastic Kubernetes Service\uff09\u53ef\u4ee5\u70ba\u60a8\u63d0\u4f9b\u8c50\u5bcc\u4e14\u96c6\u6210\u7684\u6307\u6a19\uff0c\u4f46\u5b83\u5011\u6703\u8b93\u60a8\u7f3a\u4e4f\u6240\u6709\u5176\u4ed6\u53ef\u89c0\u5bdf\u6027\u9059\u6e2c\u3002 \u60a8\u7684\u53e6\u4e00\u500b\u9078\u64c7\u662f\u76f4\u63a5\u67e5\u8a62 Kubernetes API\u2014\u2014\u9019\u5c07\u9700\u8981\u53e6\u4e00\u500b\u7b2c\u4e09\u65b9\u5de5\u5177\uff0c\u6216\u8005\u9700\u8981\u5927\u91cf\u7684\u5167\u90e8\u958b\u767c\u5de5\u4f5c\u4f86\u5275\u5efa\u5de5\u5177\u3002 \u7121\u8ad6\u60a8\u9078\u64c7\u6536\u96c6\u6307\u6a19\uff0c\u60a8\u90fd\u61c9\u8a72\u4e86\u89e3\u5404\u7a2e\u985e\u578b\u7684\u6307\u6a19\u3002 Application Metrics: \u00b6 \u6700\u5f8c\uff0c\u4efb\u4f55\u5b8c\u5168\u53ef\u89c0\u5bdf\u7684\u74b0\u5883\u90fd\u5fc5\u9808\u5305\u542b\u61c9\u7528\u7a0b\u5e8f\u6307\u6a19\u3002\u6bcf\u500b\u7d44\u7e54\u90fd\u5fc5\u9808\u6c7a\u5b9a\u54ea\u4e00\u500b\u53ef\u4ee5\u5e6b\u52a9\u4ed6\u5011\u6700\u597d\u5730\u8861\u91cf\u8207\u6bcf\u500b\u7522\u54c1\u548c\u670d\u52d9\u7684\u696d\u52d9\u7bc4\u570d\u548c\u76ee\u6a19\u76f8\u95dc\u7684\u6027\u80fd\u548c\u53ef\u9760\u6027\u3002 \u4ee5\u4e0b\u662f\u7d44\u7e54\u61c9\u8ddf\u8e2a\u7684\u4e00\u4e9b\u6700\u91cd\u8981\u7684\u8207\u7e3e\u6548\u76f8\u95dc\u7684\u6307\u6a19\u3002 Availability Error Rates Application Performance Index (Apdex Score) Average Response Time Request Rate Container Metrics \u00b6 \u9019\u4e9b\u6307\u6a19\u662f\u7528\u6236\u6700\u719f\u6089\u7684\uff0c\u56e0\u70ba\u5b83\u5011\u63d0\u4f9b\u4e86\u6709\u95dc\u5404\u7a2e\u201c\u786c\u4ef6\u201d\u7d44\u4ef6\u548c\u4f7f\u7528\u7d71\u8a08\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u5b83\u5011\u8207\u60a8\u5728\u66f4\u50b3\u7d71\u7684\u74b0\u5883\u4e2d\u767c\u73fe\u7684\u76f8\u4f3c\u3002 Container CPU Container memory utilization Network usage Kubernetes Metrics \u00b6 \u5f9e\u96c6\u7fa4\u7d1a\u5225\u79fb\u52d5\u5230\u55ae\u500b Pod \u7d1a\u5225\uff0cKubernetes \u6307\u6a19\u8b93\u60a8\u53ef\u4ee5\u4e00\u76ee\u4e86\u7136\u5730\u8861\u91cf Pod \u7684\u5065\u5eb7\u72c0\u6cc1\u3002 Current Deployment (and Daemonset) Missing and Failed Pods Running vs Desired Pods Pod Restarts Available and Unavailable Pods Pods in the CrashLoopBackOff state Cluster & Node Metrics \u00b6 \u60a8\u61c9\u8a72\u95dc\u6ce8\u7684\u7b2c\u4e00\u500b\u6307\u6a19\u662f\u8207\u96c6\u7fa4\u6574\u9ad4\u904b\u884c\u72c0\u6cc1\u76f8\u95dc\u7684\u6307\u6a19\u3002\u9019\u5c07\u6709\u52a9\u65bc\u78ba\u4fdd\u60a8\u6709\u8db3\u5920\u7684\u7269\u7406\u8cc7\u6e90\u4f86\u8655\u7406\u60a8\u7684\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09\uff0c\u67e5\u770b\u54ea\u4e9b\u61c9\u7528\u7a0b\u5e8f\u5728\u54ea\u4e9b\u7bc0\u9ede\u4e0a\u904b\u884c\uff0c\u4e26\u78ba\u4fdd\u7bc0\u9ede\u6b63\u5e38\u5de5\u4f5c\u3002 Memory, CPU, and Network Usage Number of Nodes Available Number of Running Pods (per Node) \u8ddf\u8e2a Traces \u00b6 \u5728\u60a8\u78ba\u5b9a\u4e86\u8981\u6536\u96c6\u7684\u5404\u7a2e\u65e5\u8a8c\u548c\u6307\u6a19\u4e4b\u5f8c\uff0c\u60a8\u9084\u53ef\u4ee5\u8003\u616e\u6536\u96c6 \u8ddf\u8e2a \u3002 \u8ddf\u8e2a \u5141\u8a31\u60a8\u6620\u5c04\u4e0d\u540c\u670d\u52d9\u548c\u8cc7\u6e90\u4e4b\u9593\u7684\u4ea4\u4e92\uff0c\u4ee5\u8b58\u5225\u6545\u969c\u6216\u4e8b\u4ef6\u7684\u6839\u672c\u539f\u56e0\u3002 Kubernetes \u7cfb\u7d71\u7d44\u4ef6\u7684\u8ddf\u8e2a\u76f8\u5c0d\u5bb9\u6613\u6536\u96c6\uff0c\u5118\u7ba1\u5b83\u78ba\u5be6\u9700\u8981\u4e00\u4e9b\u914d\u7f6e\u548c\u4e00\u5169\u500b\u7b2c\u4e09\u65b9\u5de5\u5177\u3002\u53ef\u4ee5\u4f7f\u7528 OpenTelemtry \u6536\u96c6\u5668\u5b8c\u6210\u6536\u96c6\uff0c\u5c07\u5b83\u5011\u8def\u7531\u5230\u9069\u7576\u7684\u8ddf\u8e2a\u5f8c\u7aef\u9032\u884c\u5b58\u5132\u3001\u8655\u7406\u548c\u5206\u6790\u3002 \u5728\u5f9e\u61c9\u7528\u7a0b\u5e8f\u7372\u53d6\u8ddf\u8e2a\u65b9\u9762\uff0c\u9019\u5c07\u9700\u8981\u60a8\u9032\u884c\u4e00\u4e9b\u6aa2\u6e2c\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u76f4\u63a5\u5728\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u4e2d\u5be6\u73fe\u5206\u4f48\u5f0f\u8ddf\u8e2a\u5eab\uff08\u4f8b\u5982 OpenTracing\uff09\u6216\u4f7f\u7528\u670d\u52d9\u7db2\u683c\u4f86\u5be6\u73fe\u61c9\u7528\u7a0b\u5e8f\u7d1a\u8ddf\u8e2a\u3002\u5169\u8005\u90fd\u9700\u8981\u5927\u91cf\u7684\u958b\u767c\u548c\u5be6\u65bd\u6642\u9593\u3002","title":"\u76e3\u63a7 Kubernetes \u7684\u6311\u6230"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#kubernetes","text":"\u539f\u6587: https://blogs.vmware.com/management/2020/09/kubernetes-observability-monitoring-in-the-cloud.html \u76e3\u63a7 Kubernetes \u6311\u6230\u7684\u6838\u5fc3\u5728\u65bc\u5176\u67b6\u69cb\uff0c\u4ee5\u53ca\u5b83\u7684\u8a2d\u8a08\u76ee\u7684\u2014 \u7de8\u6392\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09 \u3002\u5b83\u65e8\u5728\u8b93\u6211\u5011\u64fa\u812b\u7ba1\u7406\u201c \u5bf5\u7269 (pets) \u201d\u7684\u8ca0\u64d4\uff0c\u5f15\u9818\u6211\u5011\u9032\u5165\u4e00\u500b\u7c21\u55ae\u7ba1\u7406\u201c \u653e\u7267\u725b (cattle) \u201d\u7684\u65b0\u6642\u4ee3\u3002\u4f46\u662f\u4efb\u4f55\u7267\u5834\u4e3b\u90fd\u6703\u544a\u8a34\u4f60\uff0c\u990a\u725b\u4ecd\u7136\u9700\u8981\u76f8\u7576\u5927\u7684\u52aa\u529b\uff0c\u800c\u4e14\u4e26\u975e\u6c92\u6709\u5371\u96aa\u3002 Kubernetes \u672c\u8cea\u4e0a\u662f\u4e00\u500b\u8907\u96dc\u7684\u3001\u591a\u5c64\u7684\u3001\u4e0d\u65b7\u8b8a\u5316\u7684\u670d\u52d9\u548c\u8cc7\u6e90\u9663\u5217\u3002\u5c0d\u914d\u7f6e\u6587\u4ef6\u7684\u7c21\u55ae\u66f4\u6539\u53ef\u80fd\u6703\u8b93\u60a8\u548c\u60a8\u7684\u5718\u968a\u6df9\u6c92\u5728\u65b0\u6578\u64da\u7684\u6d77\u562f\u4e2d\u3002\u66f4\u7cdf\u7cd5\u7684\u662f\uff0c\u8a31\u591a\uff08\u5982\u679c\u4e0d\u662f\u5927\u591a\u6578\u7684\u8a71\uff09\u73fe\u6709\u76e3\u63a7\u5de5\u5177\u90fd\u6709\u4e00\u500b\u66f4\u7c21\u55ae\u7684\u67b6\u69cb\uff0c\u5b83\u5011\u5047\u8a2d\u60a8\u7684\u57fa\u790e\u8a2d\u65bd\u6216\u591a\u6216\u5c11\u662f\u6c38\u4e45\u6027\u7684\u3002\u8a66\u5716\u7528\u50b3\u7d71\u7684\u76e3\u63a7\u5de5\u5177\u4f86\u76e3\u63a7 Kubernetes \uff0c\u57fa\u672c\u4e0a\u662f\u4e0d\u53ef\u80fd\u9054\u6210\u76ee\u6a19\u3002 \u9664\u4e86\u52d5\u7269\u96b1\u55bb (pets \u8207 cattle)\u4e4b\u5916\uff0cKubernetes \u7368\u7279\u7684\u67b6\u69cb\u4e00\u76f4\u5ef6\u4f38\u5230\u5b83\u5982\u4f55\u767c\u51fa\u6578\u64da\u3002 \u95dc\u65bc \u65e5\u8a8c\u8a18\u9304 \uff0c\u6b63\u5982\u4eba\u5011\u6240\u671f\u671b\u7684\u90a3\u6a23\uff0cKubernetes \u5728 \u7bc0\u9ede \u7d1a\u5225\u7ba1\u7406\u548c\u5b58\u5132\u5bb9\u5668\u65e5\u8a8c\u3002\u4f46\u662f\uff0c\u7531\u65bc\u7bc0\u9ede\u7684\u78c1\u76e4\u7a7a\u9593\u6709\u9650\uff0c\u5b83\u5011\u6703\u5f88\u5feb\u8f2a\u63db\u3002\u4e00\u500b\u65b9\u4fbf\u7684\u529f\u80fd\uff0c\u76f4\u5230\u60a8\u767c\u73fe\u81ea\u5df1\u5728\u51cc\u6668 3 \u9ede\u89e3\u6c7a\u751f\u7522\u554f\u984c\u3002\u6b64\u5916\uff0cKubernetes \u547d\u4ee4\u884c\u5de5\u5177 kubectl \u50c5\u6309\u9700\u67e5\u8a62\u4e00\u5c0f\u90e8\u5206\u76ee\u6a19\u7684\u65e5\u8a8c\u3002\u9019\u4f7f\u5f97\u901a\u904e\u65e5\u8a8c\u201cgrepping\u201d\u6210\u70ba\u4e00\u9805\u4e0d\u53ef\u80fd\u5b8c\u6210\u7684\u4efb\u52d9\u3002\u50c5\u9019\u4e00\u4ee4\u4eba\u982d\u75bc\u7684\u554f\u984c\u5c31\u5c0e\u81f4\u5927\u591a\u6578\u4eba\u6295\u8cc7\u65bc\u7b2c\u4e09\u65b9\u5de5\u5177\u6216\u89e3\u6c7a\u65b9\u6848\uff0c\u4f8b\u5982 ELK Stack, Loki \u7b49\uff0c\u4ee5\u6eff\u8db3\u4ed6\u5011\u7684 Kubernetes \u65e5\u8a8c\u8a18\u9304\u9700\u6c42\u3002 \u5728 \u6307\u6a19 \u65b9\u9762\uff0c\u9019\u4e9b\u6578\u64da\u53ef\u4ee5\u901a\u904e Kubernetes API \u8f15\u9b06\u7372\u5f97\u3002\u4f46\u662f\uff0c\u6578\u64da\u6a21\u578b\u975e\u5e38\u8c50\u5bcc\uff0c\u60a8\u5c07\u82b1\u8cbb\u7121\u6578\u6642\u9593\u8a2d\u8a08\u548c\u5be6\u65bd\u6a19\u8a18\u65b9\u6848\u4f86\u7406\u89e3\u6578\u64da\u3002\u6700\u91cd\u8981\u7684\u662f\uff0c\u60a8\u53ef\u4ee5\u81ea\u884c\u8a2d\u8a08\u6216\u4f7f\u7528 Prometheus \u7b49\u5de5\u5177\u4f86\u5b58\u5132\u3001\u95dc\u806f\u548c\u5206\u6790\u6240\u6709\u9019\u4e9b\u6578\u64da\uff01 \u65e5\u8a8c\u548c\u6307\u6a19\u751a\u81f3\u4e0d\u662f\u96c6\u7fa4\u767c\u51fa\u7684\u4e0d\u540c\u985e\u578b\u6578\u64da\u7684\u4e00\u534a\u3002\u4f46\u662f\uff0c\u5047\u8a2d\u60a8\u4f7f\u7528\u66f4\u50b3\u7d71\u7684\u201c3 \u500b\u652f\u67f1\u201d\u65b9\u6cd5\u4f86\u6536\u96c6\u9019\u4e9b\u6578\u64da\uff0c\u4ee5\u7372\u53d6\u53ef\u89c0\u5bdf\u6027\u7684\u4e0d\u540c\u6578\u64da\u6e90\u548c\u5de5\u5177\u3002\u4f60\u5f97\u5230\u4e86\u6240\u6709\u7684\u6578\u64da\uff0c\u4f46\u4f60\u73fe\u5728\u70ba\u4f60\u7684\u6578\u64da\u5de5\u4f5c\uff0c\u800c\u4e0d\u662f\u76f8\u53cd\uff0c\u56e0\u70ba\u5b83\u4ecd\u7136\u662f\u5b64\u7acb\u7684\uff01 \u5982\u679c\u60a8\u7684\u6578\u64da\u6e90\u4e4b\u9593\u6c92\u6709\u4e0a\u4e0b\u6587\uff0c\u60a8\u5c07\u4e0d\u5f97\u4e0d\u52aa\u529b\u5c0b\u627e\u806f\u7e6b\u548c\u76f8\u95dc\u6027\u3002\u9019\u5c07\u82b1\u8cbb\u60a8\u5927\u91cf\u7684\u6642\u9593\u548c\u91d1\u9322\u3002","title":"\u76e3\u63a7 Kubernetes \u7684\u6311\u6230"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#kubernetes_1","text":"\u65e2\u7136\u6211\u5011\u4e86\u89e3\u4e86\u89c0\u5bdf Kubernetes \u96c6\u7fa4\u7684\u8af8\u591a\u6311\u6230\uff0c\u90a3\u9ebc\u6211\u5011\u5f9e\u54ea\u88e1\u958b\u59cb\u89c0\u5bdf Kubernetes \u5462\uff1f\u8b93\u6211\u5011\u9996\u5148\u78ba\u5b9a\u60a8\u61c9\u8a72\u8003\u616e\u6536\u96c6\u7684\u6578\u64da\u985e\u578b\uff0c\u7a0d\u5f8c\u6211\u5011\u5c07\u4ecb\u7d39\u5982\u4f55\u95dc\u806f\u548c\u5206\u6790\u6240\u6709\u9019\u4e9b\u6578\u64da\u3002","title":"\u61c9\u8a72\u5728 Kubernetes \u4e2d\u89c0\u5bdf\u4ec0\u9ebc\uff1f"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#logs","text":"\u53ef\u4ee5\u8aaa\uff0c\u7b2c\u4e00\u500b\u4e5f\u662f\u6700\u91cd\u8981\u7684\u8d77\u9ede\u662f \u65e5\u8a8c \u3002 \u65e5\u8a8c \u662f\u4efb\u4f55\u74b0\u5883\u4e0b\u53ef\u89c0\u5bdf\u6027\u7684\u57fa\u790e\u3002\u6b63\u5982\u60a8\u53ef\u80fd\u5df2\u7d93\u731c\u5230\u7684\u90a3\u6a23\uff0cKubernetes \u6709\u5404\u7a2e\u5404\u6a23\u7684\u65e5\u8a8c\u4f86\u6e90\u3002 Kubernetes \u4e2d\u7684\u65e5\u8a8c\u985e\u578b\uff1a Container Logs Node Logs Audit Logs Event Logs Ingress Logs API Server Logs Kubernetes \u53ef\u89c0\u5bdf\u6027\u624b\u518a\u7684\u4e00\u500b\u95dc\u9375\u90e8\u5206\u61c9\u8a72\u5f9e\u6355\u7372\u76e1\u53ef\u80fd\u591a\u7684\uff08\u5982\u679c\u4e0d\u662f\u5168\u90e8\u7684\u8a71\uff09\u9019\u4e9b\u985e\u578b\u7684\u65e5\u8a8c\u53ef\u4f9b\u60a8\u4f7f\u7528\u3002","title":"\u65e5\u8a8c Logs"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#metrics","text":"\u6307\u6a19\u76e3\u63a7\u66f4\u76f4\u63a5\u4e00\u4e9b\uff0c\u56e0\u70ba\u5728\u66f4\u50b3\u7d71\u7684\u57fa\u790e\u8a2d\u65bd\u4e2d\u767c\u73fe\u7684\u8a31\u591a\u76f8\u540c\u6307\u6a19\u90fd\u53ef\u4ee5\u5728 Kubernetes \u4e2d\u627e\u5230\u3002\u4f46\u662f\uff0c\u60a8\u61c9\u8a72\u6ce8\u610f\u5f88\u591a\u7279\u5b9a\u65bc Kubernetes \u7684\u6307\u6a19\u3002\u6b64\u5916\uff0c\u5728 Kubernetes \u4e2d\u6536\u96c6\u6307\u6a19\u6709\u9ede\u56f0\u96e3\uff0c\u56e0\u70ba\u76ee\u524d\u9084\u6c92\u6709\u91dd\u5c0d\u6307\u6a19\u7684\u539f\u751f\u89e3\u6c7a\u65b9\u6848\u3002 \u516c\u6709\u96f2\u4f9b\u61c9\u5546\u7684 Kubernetes \u7ba1\u7406\u5e73\u53f0\uff08\u4f8b\u5982 Amazon Elastic Kubernetes Service\uff09\u53ef\u4ee5\u70ba\u60a8\u63d0\u4f9b\u8c50\u5bcc\u4e14\u96c6\u6210\u7684\u6307\u6a19\uff0c\u4f46\u5b83\u5011\u6703\u8b93\u60a8\u7f3a\u4e4f\u6240\u6709\u5176\u4ed6\u53ef\u89c0\u5bdf\u6027\u9059\u6e2c\u3002 \u60a8\u7684\u53e6\u4e00\u500b\u9078\u64c7\u662f\u76f4\u63a5\u67e5\u8a62 Kubernetes API\u2014\u2014\u9019\u5c07\u9700\u8981\u53e6\u4e00\u500b\u7b2c\u4e09\u65b9\u5de5\u5177\uff0c\u6216\u8005\u9700\u8981\u5927\u91cf\u7684\u5167\u90e8\u958b\u767c\u5de5\u4f5c\u4f86\u5275\u5efa\u5de5\u5177\u3002 \u7121\u8ad6\u60a8\u9078\u64c7\u6536\u96c6\u6307\u6a19\uff0c\u60a8\u90fd\u61c9\u8a72\u4e86\u89e3\u5404\u7a2e\u985e\u578b\u7684\u6307\u6a19\u3002","title":"\u6307\u6a19 Metrics"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#application-metrics","text":"\u6700\u5f8c\uff0c\u4efb\u4f55\u5b8c\u5168\u53ef\u89c0\u5bdf\u7684\u74b0\u5883\u90fd\u5fc5\u9808\u5305\u542b\u61c9\u7528\u7a0b\u5e8f\u6307\u6a19\u3002\u6bcf\u500b\u7d44\u7e54\u90fd\u5fc5\u9808\u6c7a\u5b9a\u54ea\u4e00\u500b\u53ef\u4ee5\u5e6b\u52a9\u4ed6\u5011\u6700\u597d\u5730\u8861\u91cf\u8207\u6bcf\u500b\u7522\u54c1\u548c\u670d\u52d9\u7684\u696d\u52d9\u7bc4\u570d\u548c\u76ee\u6a19\u76f8\u95dc\u7684\u6027\u80fd\u548c\u53ef\u9760\u6027\u3002 \u4ee5\u4e0b\u662f\u7d44\u7e54\u61c9\u8ddf\u8e2a\u7684\u4e00\u4e9b\u6700\u91cd\u8981\u7684\u8207\u7e3e\u6548\u76f8\u95dc\u7684\u6307\u6a19\u3002 Availability Error Rates Application Performance Index (Apdex Score) Average Response Time Request Rate","title":"Application Metrics:"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#container-metrics","text":"\u9019\u4e9b\u6307\u6a19\u662f\u7528\u6236\u6700\u719f\u6089\u7684\uff0c\u56e0\u70ba\u5b83\u5011\u63d0\u4f9b\u4e86\u6709\u95dc\u5404\u7a2e\u201c\u786c\u4ef6\u201d\u7d44\u4ef6\u548c\u4f7f\u7528\u7d71\u8a08\u7684\u8a73\u7d30\u4fe1\u606f\u3002\u5b83\u5011\u8207\u60a8\u5728\u66f4\u50b3\u7d71\u7684\u74b0\u5883\u4e2d\u767c\u73fe\u7684\u76f8\u4f3c\u3002 Container CPU Container memory utilization Network usage","title":"Container Metrics"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#kubernetes-metrics","text":"\u5f9e\u96c6\u7fa4\u7d1a\u5225\u79fb\u52d5\u5230\u55ae\u500b Pod \u7d1a\u5225\uff0cKubernetes \u6307\u6a19\u8b93\u60a8\u53ef\u4ee5\u4e00\u76ee\u4e86\u7136\u5730\u8861\u91cf Pod \u7684\u5065\u5eb7\u72c0\u6cc1\u3002 Current Deployment (and Daemonset) Missing and Failed Pods Running vs Desired Pods Pod Restarts Available and Unavailable Pods Pods in the CrashLoopBackOff state","title":"Kubernetes Metrics"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#cluster-node-metrics","text":"\u60a8\u61c9\u8a72\u95dc\u6ce8\u7684\u7b2c\u4e00\u500b\u6307\u6a19\u662f\u8207\u96c6\u7fa4\u6574\u9ad4\u904b\u884c\u72c0\u6cc1\u76f8\u95dc\u7684\u6307\u6a19\u3002\u9019\u5c07\u6709\u52a9\u65bc\u78ba\u4fdd\u60a8\u6709\u8db3\u5920\u7684\u7269\u7406\u8cc7\u6e90\u4f86\u8655\u7406\u60a8\u7684\u5bb9\u5668\u5316\u5de5\u4f5c\u8ca0\u8f09\uff0c\u67e5\u770b\u54ea\u4e9b\u61c9\u7528\u7a0b\u5e8f\u5728\u54ea\u4e9b\u7bc0\u9ede\u4e0a\u904b\u884c\uff0c\u4e26\u78ba\u4fdd\u7bc0\u9ede\u6b63\u5e38\u5de5\u4f5c\u3002 Memory, CPU, and Network Usage Number of Nodes Available Number of Running Pods (per Node)","title":"Cluster &amp; Node Metrics"},{"location":"kubernetes/observability/concept/kubernetes-observability-for-humans/#traces","text":"\u5728\u60a8\u78ba\u5b9a\u4e86\u8981\u6536\u96c6\u7684\u5404\u7a2e\u65e5\u8a8c\u548c\u6307\u6a19\u4e4b\u5f8c\uff0c\u60a8\u9084\u53ef\u4ee5\u8003\u616e\u6536\u96c6 \u8ddf\u8e2a \u3002 \u8ddf\u8e2a \u5141\u8a31\u60a8\u6620\u5c04\u4e0d\u540c\u670d\u52d9\u548c\u8cc7\u6e90\u4e4b\u9593\u7684\u4ea4\u4e92\uff0c\u4ee5\u8b58\u5225\u6545\u969c\u6216\u4e8b\u4ef6\u7684\u6839\u672c\u539f\u56e0\u3002 Kubernetes \u7cfb\u7d71\u7d44\u4ef6\u7684\u8ddf\u8e2a\u76f8\u5c0d\u5bb9\u6613\u6536\u96c6\uff0c\u5118\u7ba1\u5b83\u78ba\u5be6\u9700\u8981\u4e00\u4e9b\u914d\u7f6e\u548c\u4e00\u5169\u500b\u7b2c\u4e09\u65b9\u5de5\u5177\u3002\u53ef\u4ee5\u4f7f\u7528 OpenTelemtry \u6536\u96c6\u5668\u5b8c\u6210\u6536\u96c6\uff0c\u5c07\u5b83\u5011\u8def\u7531\u5230\u9069\u7576\u7684\u8ddf\u8e2a\u5f8c\u7aef\u9032\u884c\u5b58\u5132\u3001\u8655\u7406\u548c\u5206\u6790\u3002 \u5728\u5f9e\u61c9\u7528\u7a0b\u5e8f\u7372\u53d6\u8ddf\u8e2a\u65b9\u9762\uff0c\u9019\u5c07\u9700\u8981\u60a8\u9032\u884c\u4e00\u4e9b\u6aa2\u6e2c\u3002\u60a8\u53ef\u4ee5\u901a\u904e\u76f4\u63a5\u5728\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u4e2d\u5be6\u73fe\u5206\u4f48\u5f0f\u8ddf\u8e2a\u5eab\uff08\u4f8b\u5982 OpenTracing\uff09\u6216\u4f7f\u7528\u670d\u52d9\u7db2\u683c\u4f86\u5be6\u73fe\u61c9\u7528\u7a0b\u5e8f\u7d1a\u8ddf\u8e2a\u3002\u5169\u8005\u90fd\u9700\u8981\u5927\u91cf\u7684\u958b\u767c\u548c\u5be6\u65bd\u6642\u9593\u3002","title":"\u8ddf\u8e2a Traces"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part1/","text":"Observability \u5b78\u7fd2\u6307\u5357\u8aaa\u660e \u00b6 \u539f\u6587: Kubernetes Observability with Prometheus, Loki & Grafana \u2013 Part I: Learning guide \u5728\u672c\u6587\u4e2d\uff0c\u5b9a\u7fa9\u4e86\u8853\u8a9e\" \u53ef\u89c0\u5bdf\u6027(Observability) \"\uff0c\u70ba\u4ec0\u9ebc\u9700\u8981\u5b83\u4ee5\u53ca\u5be6\u73fe\u5b83\u6240\u9700\u7684\u57fa\u672c\u6b65\u9a5f\u3002\u7136\u5f8c\uff0c\u5c07\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Prometheus \u5806\u68e7\u70ba Kubernetes \u5be6\u73fe\u53ef\u89c0\u5bdf\u6027\u7684\u901a\u7528\u5b78\u7fd2\u6307\u5357\u3002 \u53ef\u89c0\u5bdf\u6027\u7c21\u4ecb \u00b6 \u5feb\u901f\u78ba\u5b9a\u60a8\u7684\u7cfb\u7d71\u51fa\u73fe\u6545\u969c\u4e26\u6e1b\u5c11\u8a3a\u65b7\u548c\u4fee\u5fa9\u554f\u984c\u6240\u9700\u7684\u6642\u9593\u59cb\u7d42\u5f88\u91cd\u8981\u3002\u5c0d\u65bc\u5728\u55ae\u53f0\u6a5f\u5668\u4e0a\u904b\u884c\u7684\u8f03\u5c0f\u7684\u975e\u5206\u4f48\u5f0f\u7cfb\u7d71\uff0c\u60a8\u53ef\u4ee5\u9032\u884c\u9ed1\u76d2\u76e3\u63a7\uff08\u4f8b\u5982 Nagios \u6a23\u5f0f\u7684\u6aa2\u67e5\uff09\u4ee5\u78ba\u5b9a\u662f\u5426\u6709\u554f\u984c\u3002\u4e00\u65e6\u6aa2\u67e5\u5931\u6557\uff0c\u5c31\u6703\u89f8\u767c\u8b66\u5831\uff0c\u60a8\u5c07\u67e5\u770b\u7cfb\u7d71\u65e5\u8a8c\u4ee5\u78ba\u5b9a\u554f\u984c\u6240\u5728\u3002 \u4f46\u662f\uff0c\u5177\u6709\u5927\u91cf\u7528\u6236\u7fa4\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u6839\u64da\u8acb\u6c42\u8ca0\u8f09\u9032\u884c\u64f4\u5c55\u3002\u50cf Kubernetes \u9019\u6a23\u7684\u5e73\u53f0\u5be6\u73fe\u4e86\u6c34\u5e73\u64f4\u5c55\u67b6\u69cb\uff0c\u5176\u4e2d\u7cfb\u7d71\u7684\u7d44\u4ef6\u5206\u4f48\u5728\u8a31\u591a\u8a08\u7b97\u7bc0\u9ede\u4e0a\uff0c\u9019\u4e9b\u7bc0\u9ede\u662f\u52d5\u614b\u555f\u52d5\u548c\u505c\u6b62\u7684\u3002\u4e0d\u5e78\u7684\u662f\uff0c\u9019\u4e9b\u7cfb\u7d71\u66f4\u96e3\u76e3\u63a7\uff0c\u56e0\u70ba\u73fe\u5728\u60a8\u5fc5\u9808\u5f9e\u6240\u6709\u7bc0\u9ede\u6536\u96c6\u3001\u532f\u7e3d\u548c\u5206\u6790\u4e0d\u540c\u985e\u578b\u7684\u6578\u64da\uff08\u4f8b\u5982\u65e5\u8a8c\uff09\u3002 \u8fd1\u5e74\u4f86\uff0c\u51fa\u73fe\u4e86\u8853\u8a9e\u201c\u53ef\u89c0\u5bdf\u6027\u201d\uff08\u7528\u65bc\u5206\u4f48\u5f0f\u7cfb\u7d71\uff09\uff0c\u8a0e\u8ad6\u4e86\u9019\u500b\u554f\u984c\u3002\u6211\u5f37\u70c8\u63a8\u85a6 Cindy Sridharan \u7684\u512a\u79c0\u5165\u9580\u8b80\u7269\u201c\u5206\u4f48\u5f0f\u7cfb\u7d71\u53ef\u89c0\u5bdf\u6027\u201d\uff0c\u4ee5\u4e86\u89e3\u6709\u95dc\u53ef\u89c0\u5bdf\u6027\u7684\u66f4\u591a\u4fe1\u606f\uff08 \u6b64\u8655\u63d0\u4f9b\u514d\u8cbb\u96fb\u5b50\u66f8 \uff09\u3002 \u4ec0\u9ebc\u662f\u53ef\u89c0\u5bdf\u6027\uff1f \u00b6 \u6839\u64da Cindy Sridharan \u7684\u8aaa\u6cd5\uff0c\u53ef\u89c0\u5bdf\u6027\u662f\u4e00\u7a2e\u7cfb\u7d71\u5c6c\u6027\uff0c\u901a\u904e\u89c0\u5bdf\u5176\u8f38\u51fa\uff0c\u60a8\u53ef\u4ee5\u5feb\u901f\u4e86\u89e3\u7cfb\u7d71\u5167\u90e8\u51fa\u4e86\u4ec0\u9ebc\u554f\u984c\uff08\u4e26\u8b93\u60a8\u80fd\u5920\u5feb\u901f\u4fee\u5fa9\u5b83\uff09\u3002\u7136\u800c\uff0c\u53ef\u89c0\u5bdf\u6027\u6bd4\u8a31\u591a\u5f9e\u696d\u8005\u60f3\u50cf\u7684\u8981\u591a\uff1a\u50c5\u50c5\u6536\u96c6\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u5206\u4f48\u5f0f\u8ddf\u8e2a\uff0c\u4e26\u5c0d\u6307\u6a19\u9032\u884c\u8b66\u5831\u662f\u4e0d\u5920\u7684\u3002\u76f8\u53cd\uff0c\u60a8\u9700\u8981\u5b8c\u5168\u6539\u8b8a\u601d\u7dad\u65b9\u5f0f\uff0c\u4e26\u5c07\u984d\u5916\u7684\u5de5\u4f5c\u6295\u5165\u8edf\u4ef6\u958b\u767c\u751f\u547d\u9031\u671f (SDLC) \u7684\u591a\u500b\u968e\u6bb5\u3002\u60a8\u78ba\u5be6\u9700\u8981\u5c07\u53ef\u89c0\u5bdf\u6027\u201c\u5d4c\u5165\u201d\u5230\u60a8\u7684\u7cfb\u7d71\u4e2d\u3002\u66f4\u5177\u9ad4\u5730\u8aaa\uff0c\u8b93\u6211\u5011\u770b\u4e00\u4e0b SDLC \u968e\u6bb5\u7684\u53ef\u80fd\u4fee\u6539\uff1a \u958b\u767c (Development) \uff1a\u5728\u8a2d\u8a08\u548c\u5be6\u73fe\u4f60\u7684\u7cfb\u7d71\u6642\uff0c\u4f60\u9700\u8981\u4fee\u6539\u4f60\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u4ee3\u78bc\uff0c\u4e26\u4e14\u5c0d\u7b2c\u4e09\u65b9\u7cfb\u7d71\u6709\u4e00\u500b\u5f88\u597d\u7684\u4e86\u89e3\uff1a \u95dc\u65bc\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u60a8\u53ef\u4ee5\u505a\u5f88\u591a\u4e8b\u60c5\uff0c\u4f8b\u5982\uff1a \u6dfb\u52a0\u5ee3\u6cdb\u7684\u65e5\u8a8c\u8a18\u9304\uff08\u4f7f\u7528\u7d50\u69cb\u5316\u65e5\u8a8c\u4f86\u7c21\u5316\u89e3\u6790\uff09 \u6dfb\u52a0\uff08\u5206\u4f48\u5f0f\uff09\u8ddf\u8e2a\u4ee3\u78bc\uff08\u4ee5\u9632\u60a8\u6709\u591a\u500b\u76f8\u4e92\u8abf\u7528\u7684\u5fae\u670d\u52d9\uff09 \u516c\u958b\u7279\u5b9a\u65bc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u6307\u6a19\uff08\u4e5f\u7a31\u70ba\u201c\u6aa2\u6e2c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u201d\uff09\uff0c\u4e26\u4f7f\u7528\u516c\u958b\u984d\u5916\u7684\u901a\u7528\uff08\u975e\u61c9\u7528\u7a0b\u5e8f\u7279\u5b9a\uff09\u6307\u6a19\uff08\u4f8b\u5982\u5783\u573e\u6536\u96c6\u5668\u9031\u671f\uff09\u7684 APM \u5de5\u5177 \u5be6\u73fe\u4e00\u500b /health HTTP \u7aef\u9ede\uff0c\u4f9b Kubernetes \u7b49\u5e73\u53f0\u7684\u6062\u5fa9\u6a5f\u5236\u4f7f\u7528 \u8a2d\u8a08\u6307\u793a\u554f\u984c\u7684\u6709\u7528\u4e14\u7279\u5b9a\u65bc\u61c9\u7528\u7a0b\u5e8f\u7684\u8b66\u5831 - \u9019\u4e9b\u4e0d\u4e00\u5b9a\u662f\u6280\u8853\u6027\u7684\uff0c\u4f46\u4e5f\u53ef\u80fd\u662f\u696d\u52d9 KPI\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u516c\u958b\u767b\u9304/\u8a3b\u92b7\u4e8b\u4ef6\u6307\u6a19\uff0c\u4ee5\u4fbf\u8b66\u5831\u53ef\u4ee5\u57f7\u884c\u8da8\u52e2\u5206\u6790\uff0c\u5728\u51fa\u73fe\u554f\u984c\u6642\u901a\u77e5\u60a8\uff0c\u4f8b\u5982\u5982\u679c\u60a8\u7684\u6bcf\u6708\u767b\u9304\u6b21\u6578\u958b\u59cb\u4e0b\u964d \u95dc\u65bc\u60a8\u4f5c\u70ba\u7cfb\u7d71\u4e00\u90e8\u5206\u4f7f\u7528\u7684\u7b2c\u4e09\u65b9\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\u3001\u8ca0\u8f09\u5747\u8861\u5668\u7b49\uff09\uff0c\u60a8\u9700\u8981\u4e86\u89e3\u53ef\u4ee5\u5f9e\u4e2d\u6aa2\u6e2c\u54ea\u4e9b\u6307\u6a19\uff0c\u4e26\u4e14\u53ea\u6293\u53d6\u90a3\u4e9b\u8207\u60a8\u7684\u7cfb\u7d71\u76f8\u95dc\u7684\u6307\u6a19 \u6e2c\u8a66 (Testing) \uff1a\u9664\u4e86\u7de8\u5beb\u60a8\u901a\u5e38\u7684\u201c\u9810\u751f\u7522\u968e\u6bb5\u201d\u6e2c\u8a66\uff08\u5728\u67d0\u4e9b\u55ae\u7368\uff08\u96c6\u6210\uff09\u74b0\u5883\u4e2d\u904b\u884c\uff0c\u4f8b\u5982\u5728 CI \u7ba1\u9053\u4e2d\uff09\u4e4b\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u7de8\u5beb\u6a21\u64ec\u751f\u7522\u74b0\u5883\u4e2d\u771f\u5be6\uff08\u8ca0\u8f09\uff09\u689d\u4ef6\u7684\u6e2c\u8a66\uff0c\u6216\u8005\u5b83\u7684\u7cbe\u78ba\u514b\u9686\u3002\u9019\u5305\u62ec\u7de8\u5beb\u89f8\u767c\u8b66\u5831\u7684\u6e2c\u8a66\u3002\u5426\u5247\uff0c\u4f60\u600e\u9ebc\u77e5\u9053\u4f60\u914d\u7f6e\u7684\u8b66\u5831\u771f\u7684\u6709\u6548\uff1f\u9019\u5305\u62ec\u61c9\u7528 chaos monkey \u6a21\u5f0f\u3002 \u7dad\u904b (Operations) \uff1a\u60a8\u914d\u7f6e\u548c\u904b\u884c\u76e3\u63a7\u8edf\u4ef6\uff08\u4f8b\u5982 Prometheus \u5806\u68e7\uff09\uff0c\u8a72\u8edf\u4ef6\u6301\u7e8c\u76e3\u63a7\u6307\u6a19\u4e26\u751f\u6210\u8b66\u5831\uff0c\u4e26\u63d0\u4f9b\u53ef\u4ee5\u6309\u9700\u4f7f\u7528\u7684\u5100\u8868\u677f\u4f86\u8a3a\u65b7\u554f\u984c\uff08\u4f8b\u5982\u5206\u6790\u65e5\u8a8c\u548c\u8ddf\u8e2a\uff09\u3002\u60a8\u9084\u53ef\u4ee5\u76e3\u63a7\u90e8\u7f72\u904e\u7a0b\u672c\u8eab\uff0c\u4f8b\u5982\u901a\u904e\u6536\u96c6\u4f5c\u70ba CI/CD \u7ba1\u9053\u7684\u4e00\u90e8\u5206\u5275\u5efa\u7684\u4e8b\u4ef6\u6578\u64da\u3002 Observability vs. monitoring \" \u53ef\u89c0\u5bdf\u6027 \"\u662f\u4e00\u500b\u975e\u5e38\u91cd\u8981\u7684\u8853\u8a9e\u3002\u5c0d\u65bc\u5c07\" \u53ef\u89c0\u5bdf\u6027 \"\u8207\" \u76e3\u63a7 \"\u5340\u5206\u958b\u4f86\uff0c\u4e26\u6c92\u6709\u660e\u78ba\u4e14\u7d55\u5c0d\u7684\u5b9a\u7fa9\uff0c\u53ea\u662f\" \u53ef\u89c0\u5bdf\u6027 \"\u4e0d\u50c5\u50c5\u662f\" \u76e3\u63a7 \"\u3002\u4e0a\u9762\u7684\u5b9a\u7fa9\u662f Cindy \u7684\uff0c\u5176\u4ed6\u4eba\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u770b\u6cd5\uff0c\u5c24\u5176\u662f\u5de5\u5177\u5546\uff0c\u4ed6\u5011\u9700\u8981\u8ce3\u7d66\u4f60\u4e00\u4e9b\u6771\u897f\u3002\u8acb\u53c3\u95b1\u9019\u7bc7 \u51fa\u8272\u7684\u6587\u7ae0 \u9032\u884c\u8a0e\u8ad6\u3002 \u70ba\u4ec0\u9ebc\u9078\u64c7 Prometheus\u3001Loki \u548c Grafana? \u00b6 \u53ef\u89c0\u5bdf\u6027\u9818\u57df\u6709\u8a31\u591a\u5de5\u5177\uff0c\u5f9e Netdata \u6216 Zabbix \u7b49\u958b\u6e90\u8edf\u4ef6\uff0c\u5230 Datadog\u3001Splunk\u3001LightStep\u3001sumo logic \u6216 Instana \u7b49\u5546\u696d (SaaS) \u7522\u54c1\u3002\u5728\u672c\u7cfb\u5217\u6587\u7ae0\u4e2d\uff0c\u6211\u5c07\u91cd\u9ede\u4ecb\u7d39\u201cPrometheus \u5806\u68e7\u201d\uff08\u9644\u5e36\u5de5\u5177\u3001Alertmanager\u3001Loki \u548c Grafana\uff09\uff0c\u5b83\u662f OSS\uff0c\u4e26\u4e14\u5728 Kubernetes \u74b0\u5883\u548c\u5176\u4ed6\u74b0\u5883\u4e2d\u8b8a\u5f97\u975e\u5e38\u6d41\u884c\u3002\u4e5f\u5c31\u662f\u8aaa\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5728\u88f8\u6a5f\u4e0a\u64cd\u4f5c Prometheus \u7b49\uff0c\u6216\u8005\u4f7f\u7528 Docker\uff08compose\uff09\u3002 \u5982\u679c\u4f60\u4e5f\u5c0d\u5206\u4f48\u5f0f\u8ddf\u8e2a\u611f\u8208\u8da3\uff0c\u6211\u5efa\u8b70\u4f60\u770b\u770b Grafana \u7684 Tempo \u3002 \u5b78\u7fd2\u6307\u5357 \u00b6 \u7576\u6211\u958b\u59cb\u5b78\u7fd2\u9019\u500b\u9818\u57df\u6642\uff0c\u6211\u4e0d\u77e5\u9053\u5f9e\u54ea\u88e1\u958b\u59cb\u3002\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\uff0c\u6211\u5f04\u6e05\u695a\u4e86\u54ea\u4e9b\u77e5\u8b58\u584a\u662f\u76f8\u4e92\u4f9d\u8cf4\u7684\u3002\u6211\u78ba\u5b9a\u4e86\u4e0b\u9762\u63cf\u8ff0\u7684\u4e09\u500b\u8ecc\u9053\uff0c\u9019\u662f\u4e00\u7a2e\u6d41\u7a0b\u5716\u3002\u60a8\u53ef\u4ee5\uff08\u4e26\u4e14\u61c9\u8a72\uff09\u540c\u6642\u9032\u884c\u6280\u8853\u8ddf\u8e2a\u548c\u9ad8\u7d1a\u53ef\u89c0\u5bdf\u6027\u8ddf\u8e2a\u3002\u628a\u5b83\u5011\u60f3\u50cf\u6210\u4f60\u5728\u7372\u5f97\u99d5\u7167\u6642\u8981\u7d93\u6b77\u7684\u201c\u7406\u8ad6\u548c\u5be6\u8e10\u201d\u8ecc\u9053\u3002\u53ea\u6709\u7576\u4f60\u5b8c\u6210\u4e86\u9019\u5169\u500b\u8ecc\u9053\u4e4b\u5f8c\uff0c\u624d\u6709\u610f\u7fa9\u958b\u59cb\u5728 Kubernetes \u4e2d\u4f7f\u7528 Prometheus\u3002 \u70ba\u7c21\u55ae\u8d77\u898b\uff0c\u672c\u5b78\u7fd2\u6307\u5357\u50c5\u9650\u65bc Prometheus\u3001Alertmanager \u548c Grafana\u3002\u4f7f\u7528 Loki \u9032\u884c\u65e5\u8a8c\u7ba1\u7406\u4e0d\u662f\u5176\u4e2d\u7684\u4e00\u90e8\u5206\uff0c\u56e0\u70ba\u4e00\u65e6\u60a8\u719f\u6089\u4e86\u6240\u6709\u5176\u4ed6\u6982\u5ff5\uff0c\u5b83\u5c31\u662f\u4e00\u500b\u201c\u7c21\u55ae\u201d\u7684\u9644\u52a0\u529f\u80fd\u3002\u6211\u5c07\u5728\u4ee5\u5f8c\u7684\u6587\u7ae0\u4e2d\u8a73\u7d30\u4ecb\u7d39 Loki\u3002 \u8b93\u6211\u5011\u66f4\u8a73\u7d30\u5730\u770b\u4e00\u4e0b\u6bcf\u500b\u55ae\u7368\u6b65\u9a5f\u7684\u76ee\u6a19\uff1a Technical track : \u4e86\u89e3\u9ad8\u5c64\u67b6\u69cb\u548c\u6578\u64da\u6d41\uff1a\u4e86\u89e3 Prometheus \u5806\u68e7\u7684\u4e0d\u540c\u7d44\u4ef6/\uff08Linux\uff09\u9032\u7a0b\uff0c\u5b83\u5011\u5404\u81ea\u505a\u4ec0\u9ebc\uff0c\u4ee5\u53ca\u4ec0\u9ebc\u6578\u64da\u5728\u4ec0\u9ebc\u6642\u9593\u6d41\u5411\u53e6\u4e00\u500b\u7d44\u4ef6\u3002 \u4e86\u89e3\u6982\u5ff5\u548c\u8853\u8a9e\uff1aPrometheus \u5f15\u5165\u4e86\u5f88\u591a\u6982\u5ff5\uff0c\u6bd4\u5982 metric\u3001\u6642\u9593\u5e8f\u5217\u3001instrumentation\u3001recording/alerting rules\u3001target label \u7b49\uff0c\u5927\u5bb6\u90fd\u9700\u8981\u638c\u63e1\u597d\u3002 \u4e86\u89e3\u5728\u54ea\u91cc\u4ee5\u53ca\u5982\u4f55\u914d\u7f6e\u548c\u9023\u63a5\u4e0d\u540c\u7684\u9032\u7a0b\uff1a\u4e86\u89e3\u54ea\u4e9b\u7d44\u4ef6\u914d\u7f6e\u4e86\uff08\u7121\u72c0\u614b\uff09\u914d\u7f6e\u6587\u4ef6\uff0c\u54ea\u4e9b\u7d44\u4ef6\u5c07\u914d\u7f6e\u5b58\u5132\u5728\u53ef\u8b8a/\u6709\u72c0\u614b\u6578\u64da\u5eab\u4e2d\u3002 Prometheus \u5806\u68e7\u4e2d\u7684\u6240\u6709\u5de5\u5177\u90fd\u4ee5\u4e0d\u540c\u7684\u65b9\u6cd5\u914d\u7f6e\u5728\u4e0d\u540c\u7684\u5730\u65b9\u3002 \u5b78\u7fd2 PromQL\uff1a\u719f\u6089 Prometheus \u7684\u67e5\u8a62\u8a9e\u8a00\uff0c\u60a8\u9700\u8981\u4f7f\u7528\u5b83\u4f86\u69cb\u5efa\u8b66\u5831\u548c Grafana \u5100\u8868\u677f\u3002 \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u73fe\u6709\u5100\u8868\u677f\u3001\u4fee\u6539\u5b83\u5011\u4e26\u5275\u5efa\u81ea\u5df1\u7684\u5100\u8868\u677f\uff1a\u60a8\u4e0d\u50c5\u9700\u8981\u4e86\u89e3\u5982\u4f55\u8fed\u4ee3\u69cb\u5efa\u5100\u8868\u677f\uff08\u5f9e\u73fe\u6709\u5100\u8868\u677f\u958b\u59cb\uff09\u4ee5\u7bc0\u7701\u6642\u9593\uff0c\u9084\u9700\u8981\u7372\u5f97\u4e00\u4e9b\u7d93\u9a57\u4ee5\u907f\u514d\u69cb\u5efa\u904e\u8f09\u7684\u5100\u8868\u677f. \u4e86\u89e3\u5982\u4f55\u70ba\u7b2c\u4e09\u65b9\u670d\u52d9\u69cb\u5efa\u548c\u9078\u64c7\u8b66\u5831\uff1a\u96d6\u7136\u60a8\u9084\u9700\u8981\u70ba\u81ea\u5df1\u7684\u7d44\u4ef6\u69cb\u5efa\u8b66\u5831\uff08\u8acb\u53c3\u95b1\u9ad8\u7d1a\u53ef\u89c0\u5bdf\u6027\u8ecc\u9053\u4e2d\u7684\u7b2c\u4e09\u500b\u4efb\u52d9\uff09\uff0c\u4f46\u60a8\u9084\u9700\u8981\u78ba\u5b9a\u8981\u4f7f\u7528\u7684 Prometheus \u5c0e\u51fa\u5668\u5c0d\u65bc\u7b2c\u4e09\u65b9\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\uff09\uff0c\u4ee5\u53ca\u60a8\u61c9\u8a72\u70ba\u5176\u773e\u591a\u6307\u6a19\u4e2d\u7684\u54ea\u4e00\u500b\u5275\u5efa\u8b66\u5831\u3002 High-level track : \u5c0d\u201c\u53ef\u89c0\u5bdf\u6027\u201d\u6709\u5927\u81f4\u7684\u4e86\u89e3\uff08\u6216\u5b9a\u7fa9\u60a8\u81ea\u5df1\u7684\uff09\uff1a\u5728\u60a8\u7684\u5718\u968a\u4e2d\uff0c\u78ba\u4fdd\u6bcf\u500b\u4eba\u90fd\u5c0d\uff08\u5c0d\u60a8\u800c\u8a00\uff09\u53ef\u89c0\u5bdf\u6027\u610f\u5473\u8457\u4ec0\u9ebc\u6709\u76f8\u540c\u7684\u7406\u89e3\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u73fe\u6709\u7684\u5b9a\u7fa9\uff0c\u4e5f\u53ef\u4ee5\u5efa\u7acb\u81ea\u5df1\u7684\u66f4\u72f9\u7a84\u4f46\u9069\u7528\u65bc\u60a8\u7684\u7279\u5b9a\u4fc2\u7d71\u548c\u5718\u968a\u7684\u5b9a\u7fa9\u3002 \u5efa\u7acb\u53ef\u89c0\u5bdf\u6027\u7b56\u7565\uff0c\u8a73\u7d30\u8aaa\u660e\u60a8\u7684\u76ee\u6a19\u548c\u8def\u7dda\u5716\uff1a\u9019\u5305\u62ec\u5b9a\u7fa9\u53ef\u89c0\u5bdf\u6027\u5e6b\u52a9\u60a8\u5be6\u73fe\u7684\u7e3d\u9ad4\u6700\u7d42\u76ee\u6a19\uff08\u4f7f\u7528\u201c\u786c\u201d\u6578\u5b57\uff0c\u4f8b\u5982\u4ee5 SLO \u7684\u5f62\u5f0f\uff09\uff0c\u60a8\u5e0c\u671b\u5982\u4f55\u958b\u59cb\uff08\u9010\u6f38\u6dfb\u52a0\u53ef\u89c0\u5bdf\u6027\uff09 \uff0c\u5b9a\u7fa9\u5206\u914d\u7d66\u69cb\u5efa\u53ef\u89c0\u5bdf\u6027\u529f\u80fd\u7684\uff08\u5de5\u6642\uff09\u9810\u7b97\uff0c\u662f\u5426\uff08\u4ee5\u53ca\u5982\u4f55\uff09\u5be6\u65bd\u201c\u96a8\u53eb\u96a8\u5230\u201d\uff0c\u6216\u5982\u4f55\u8ddf\u8e2a\u4e8b\u4ef6\u3002 \u5b78\u7fd2\u9ad8\u7d1a\u8b66\u5831\u8a2d\u8a08\u539f\u5247\uff1a\u9019\u672c\u8cea\u4e0a\u662f\u5728\u8a72\u9818\u57df\u5de5\u4f5c\u7684\u4eba\u5011\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u6536\u96c6\u7684\u539f\u5247\u5217\u8868\u3002\u4f8b\u5982\uff0c\u60a8\u61c9\u8a72\u5f9e\u7528\u6236\u7684\u89d2\u5ea6\uff08\u4f7f\u7528\u696d\u52d9 KPI\uff09\u800c\u4e0d\u662f\u6280\u8853\u8b66\u5831\uff08\u91dd\u5c0d\u670d\u52d9\u5668\u6216\u670d\u52d9\uff09\u958b\u59cb\u69cb\u5efa\u8b66\u5831\u3002 \u6536\u96c6\u76e3\u63a7\u63d0\u793a\uff1a\u5c0d\u65bc\u7cfb\u7d71\u7684\u6bcf\u7a2e\u985e\u578b\u7684\u7d44\u4ef6\uff08\u4f8b\u5982\u524d\u7aef\u3001\u670d\u52d9\u5668\u7bc0\u9ede\u6216\u670d\u52d9\uff09\uff0c\u5df2\u7d93\u6709\u5f88\u591a\u95dc\u65bc\u5982\u4f55\u9032\u884c\u6aa2\u6e2c\u4ee5\u53ca\u70ba\u54ea\u4e9b\u6307\u6a19\u7de8\u5beb\u8b66\u5831\u7684\u7d93\u9a57\u8b49\u64da\u548c\u63d0\u793a\u3002\u4f8b\u5982\uff0c\u524d\u7aef\u6700\u91cd\u8981\u7684\u56e0\u7d20\u901a\u5e38\u662f\u97ff\u61c9\u6642\u9593\u3002 Kubernetes track : \u4e86\u89e3\u53ef\u7528\u7684\u5de5\u5177\u548c\u5468\u908a\u751f\u614b\u7cfb\u7d71\uff1a\u5728 Kubernetes \u4e2d\u90e8\u7f72\u548c\u5b9a\u5236 Prometheus \u5806\u68e7\u7684\u65b9\u5f0f\u6709\u5f88\u591a\u7a2e\uff0c\u4f8b\u5982 Prometheus operator\uff0c\u60a8\u9700\u8981\u5f9e\u4e2d\u9078\u64c7\u4e00\u7a2e\u3002\u9084\u6709\u4e00\u500b\u7531\u793e\u5340\u69cb\u5efa\u7684\u751f\u614b\u7cfb\u7d71\uff0c\u5305\u62ec\u984d\u5916\u7684\u6709\u7528\u8cc7\u6e90\u548c\u5de5\u5177\u4f86\u7c21\u5316\u6d41\u7a0b\uff0c\u4f8b\u5982 kube-prometheus\u3002 \u4f7f\u7528\u539f\u751f K8s \u5c0d\u8c61\u91cd\u65b0\u5b78\u7fd2\u914d\u7f6e [...]\uff1a\u7576\u4f7f\u7528 Kubernetes \u7684 Prometheus operator \u6642\uff0c\u60a8\u5c07\u4e0d\u518d\u70ba Prometheus \u7b49\u7de8\u5beb\u201c\u50b3\u7d71\u201d yaml \u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u662f\u4f7f\u7528 Kubernetes \u539f\u751f\u5de5\u4f5c\u8ca0\u8f09\u5c0d\u8c61\uff08\u4f8b\u5982 ServiceMonitor\uff09\u4f86\u914d\u7f6e\u5b83\u5011\uff0c\u64cd\u4f5c\u54e1\u5728\u904b\u884c\u6642\u5c07\u5176\u8f49\u63db\u70ba\u50b3\u7d71\u7684\u914d\u7f6e\u6587\u4ef6\u3002 \u7d50\u8ad6 \u00b6 \u5728 Kubernetes \u4e2d\u555f\u52d5\u4e26\u904b\u884c Prometheus \u4e26\u975e\u6613\u4e8b\uff0c\u56e0\u70ba\u60a8\u9700\u8981\u5177\u5099\u5927\u91cf\u80cc\u666f\u77e5\u8b58\u3002\u901a\u904e\u672c\u6587\u4e2d\u4ecb\u7d39\u7684\u5b78\u7fd2\u6307\u5357\uff0c\u6211\u53ea\u7e6a\u88fd\u4e86\u4e00\u5f35\u7c97\u7565\u7684\u5730\u5716\uff0c\u6982\u8ff0\u4e86\u901a\u5f80 Kubernetes \u7684\u57fa\u65bc Prometheus \u7684\u53ef\u89c0\u5bdf\u6027\u5806\u68e7\u7684\u65c5\u7a0b\u3002\u4f46\u662f\uff0c\u5c0d\u65bc\u5b78\u7fd2\u6307\u5357\u7684\u6bcf\u500b\u6b65\u9a5f\uff0c\u60a8\u4ecd\u7136\u9700\u8981\u5177\u9ad4\u7684\u5b78\u7fd2\u8cc7\u6e90\u3002 \u5c0d\u65bc\u9ad8\u7d1a\u8ab2\u7a0b\u6db5\u84cb\u7684\u6b65\u9a5f\uff0c\u6211\u5efa\u8b70\u60a8\u67e5\u770b Practical Monitoring \u2013 Effective Strategies for the Real World (2017) \u4e00\u66f8\uff0c\u8a72\u66f8\u63d0\u4f9b\u4e86\u5f88\u597d\u7684\u6982\u8ff0\u3002\u81f3\u65bc\u5c0e\u5165\u7684\u6b65\u9a5f\uff0c\u8acb\u67e5\u770b\u672c\u7cfb\u5217\u5176\u4ed6\u6587\u7ae0\u3002","title":"Part 1. \u5b78\u7fd2\u6307\u5357\u8aaa\u660e"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part1/#observability","text":"\u539f\u6587: Kubernetes Observability with Prometheus, Loki & Grafana \u2013 Part I: Learning guide \u5728\u672c\u6587\u4e2d\uff0c\u5b9a\u7fa9\u4e86\u8853\u8a9e\" \u53ef\u89c0\u5bdf\u6027(Observability) \"\uff0c\u70ba\u4ec0\u9ebc\u9700\u8981\u5b83\u4ee5\u53ca\u5be6\u73fe\u5b83\u6240\u9700\u7684\u57fa\u672c\u6b65\u9a5f\u3002\u7136\u5f8c\uff0c\u5c07\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Prometheus \u5806\u68e7\u70ba Kubernetes \u5be6\u73fe\u53ef\u89c0\u5bdf\u6027\u7684\u901a\u7528\u5b78\u7fd2\u6307\u5357\u3002","title":"Observability \u5b78\u7fd2\u6307\u5357\u8aaa\u660e"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part1/#_1","text":"\u5feb\u901f\u78ba\u5b9a\u60a8\u7684\u7cfb\u7d71\u51fa\u73fe\u6545\u969c\u4e26\u6e1b\u5c11\u8a3a\u65b7\u548c\u4fee\u5fa9\u554f\u984c\u6240\u9700\u7684\u6642\u9593\u59cb\u7d42\u5f88\u91cd\u8981\u3002\u5c0d\u65bc\u5728\u55ae\u53f0\u6a5f\u5668\u4e0a\u904b\u884c\u7684\u8f03\u5c0f\u7684\u975e\u5206\u4f48\u5f0f\u7cfb\u7d71\uff0c\u60a8\u53ef\u4ee5\u9032\u884c\u9ed1\u76d2\u76e3\u63a7\uff08\u4f8b\u5982 Nagios \u6a23\u5f0f\u7684\u6aa2\u67e5\uff09\u4ee5\u78ba\u5b9a\u662f\u5426\u6709\u554f\u984c\u3002\u4e00\u65e6\u6aa2\u67e5\u5931\u6557\uff0c\u5c31\u6703\u89f8\u767c\u8b66\u5831\uff0c\u60a8\u5c07\u67e5\u770b\u7cfb\u7d71\u65e5\u8a8c\u4ee5\u78ba\u5b9a\u554f\u984c\u6240\u5728\u3002 \u4f46\u662f\uff0c\u5177\u6709\u5927\u91cf\u7528\u6236\u7fa4\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u6839\u64da\u8acb\u6c42\u8ca0\u8f09\u9032\u884c\u64f4\u5c55\u3002\u50cf Kubernetes \u9019\u6a23\u7684\u5e73\u53f0\u5be6\u73fe\u4e86\u6c34\u5e73\u64f4\u5c55\u67b6\u69cb\uff0c\u5176\u4e2d\u7cfb\u7d71\u7684\u7d44\u4ef6\u5206\u4f48\u5728\u8a31\u591a\u8a08\u7b97\u7bc0\u9ede\u4e0a\uff0c\u9019\u4e9b\u7bc0\u9ede\u662f\u52d5\u614b\u555f\u52d5\u548c\u505c\u6b62\u7684\u3002\u4e0d\u5e78\u7684\u662f\uff0c\u9019\u4e9b\u7cfb\u7d71\u66f4\u96e3\u76e3\u63a7\uff0c\u56e0\u70ba\u73fe\u5728\u60a8\u5fc5\u9808\u5f9e\u6240\u6709\u7bc0\u9ede\u6536\u96c6\u3001\u532f\u7e3d\u548c\u5206\u6790\u4e0d\u540c\u985e\u578b\u7684\u6578\u64da\uff08\u4f8b\u5982\u65e5\u8a8c\uff09\u3002 \u8fd1\u5e74\u4f86\uff0c\u51fa\u73fe\u4e86\u8853\u8a9e\u201c\u53ef\u89c0\u5bdf\u6027\u201d\uff08\u7528\u65bc\u5206\u4f48\u5f0f\u7cfb\u7d71\uff09\uff0c\u8a0e\u8ad6\u4e86\u9019\u500b\u554f\u984c\u3002\u6211\u5f37\u70c8\u63a8\u85a6 Cindy Sridharan \u7684\u512a\u79c0\u5165\u9580\u8b80\u7269\u201c\u5206\u4f48\u5f0f\u7cfb\u7d71\u53ef\u89c0\u5bdf\u6027\u201d\uff0c\u4ee5\u4e86\u89e3\u6709\u95dc\u53ef\u89c0\u5bdf\u6027\u7684\u66f4\u591a\u4fe1\u606f\uff08 \u6b64\u8655\u63d0\u4f9b\u514d\u8cbb\u96fb\u5b50\u66f8 \uff09\u3002","title":"\u53ef\u89c0\u5bdf\u6027\u7c21\u4ecb"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part1/#_2","text":"\u6839\u64da Cindy Sridharan \u7684\u8aaa\u6cd5\uff0c\u53ef\u89c0\u5bdf\u6027\u662f\u4e00\u7a2e\u7cfb\u7d71\u5c6c\u6027\uff0c\u901a\u904e\u89c0\u5bdf\u5176\u8f38\u51fa\uff0c\u60a8\u53ef\u4ee5\u5feb\u901f\u4e86\u89e3\u7cfb\u7d71\u5167\u90e8\u51fa\u4e86\u4ec0\u9ebc\u554f\u984c\uff08\u4e26\u8b93\u60a8\u80fd\u5920\u5feb\u901f\u4fee\u5fa9\u5b83\uff09\u3002\u7136\u800c\uff0c\u53ef\u89c0\u5bdf\u6027\u6bd4\u8a31\u591a\u5f9e\u696d\u8005\u60f3\u50cf\u7684\u8981\u591a\uff1a\u50c5\u50c5\u6536\u96c6\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u5206\u4f48\u5f0f\u8ddf\u8e2a\uff0c\u4e26\u5c0d\u6307\u6a19\u9032\u884c\u8b66\u5831\u662f\u4e0d\u5920\u7684\u3002\u76f8\u53cd\uff0c\u60a8\u9700\u8981\u5b8c\u5168\u6539\u8b8a\u601d\u7dad\u65b9\u5f0f\uff0c\u4e26\u5c07\u984d\u5916\u7684\u5de5\u4f5c\u6295\u5165\u8edf\u4ef6\u958b\u767c\u751f\u547d\u9031\u671f (SDLC) \u7684\u591a\u500b\u968e\u6bb5\u3002\u60a8\u78ba\u5be6\u9700\u8981\u5c07\u53ef\u89c0\u5bdf\u6027\u201c\u5d4c\u5165\u201d\u5230\u60a8\u7684\u7cfb\u7d71\u4e2d\u3002\u66f4\u5177\u9ad4\u5730\u8aaa\uff0c\u8b93\u6211\u5011\u770b\u4e00\u4e0b SDLC \u968e\u6bb5\u7684\u53ef\u80fd\u4fee\u6539\uff1a \u958b\u767c (Development) \uff1a\u5728\u8a2d\u8a08\u548c\u5be6\u73fe\u4f60\u7684\u7cfb\u7d71\u6642\uff0c\u4f60\u9700\u8981\u4fee\u6539\u4f60\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u4ee3\u78bc\uff0c\u4e26\u4e14\u5c0d\u7b2c\u4e09\u65b9\u7cfb\u7d71\u6709\u4e00\u500b\u5f88\u597d\u7684\u4e86\u89e3\uff1a \u95dc\u65bc\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u60a8\u53ef\u4ee5\u505a\u5f88\u591a\u4e8b\u60c5\uff0c\u4f8b\u5982\uff1a \u6dfb\u52a0\u5ee3\u6cdb\u7684\u65e5\u8a8c\u8a18\u9304\uff08\u4f7f\u7528\u7d50\u69cb\u5316\u65e5\u8a8c\u4f86\u7c21\u5316\u89e3\u6790\uff09 \u6dfb\u52a0\uff08\u5206\u4f48\u5f0f\uff09\u8ddf\u8e2a\u4ee3\u78bc\uff08\u4ee5\u9632\u60a8\u6709\u591a\u500b\u76f8\u4e92\u8abf\u7528\u7684\u5fae\u670d\u52d9\uff09 \u516c\u958b\u7279\u5b9a\u65bc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u6307\u6a19\uff08\u4e5f\u7a31\u70ba\u201c\u6aa2\u6e2c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u201d\uff09\uff0c\u4e26\u4f7f\u7528\u516c\u958b\u984d\u5916\u7684\u901a\u7528\uff08\u975e\u61c9\u7528\u7a0b\u5e8f\u7279\u5b9a\uff09\u6307\u6a19\uff08\u4f8b\u5982\u5783\u573e\u6536\u96c6\u5668\u9031\u671f\uff09\u7684 APM \u5de5\u5177 \u5be6\u73fe\u4e00\u500b /health HTTP \u7aef\u9ede\uff0c\u4f9b Kubernetes \u7b49\u5e73\u53f0\u7684\u6062\u5fa9\u6a5f\u5236\u4f7f\u7528 \u8a2d\u8a08\u6307\u793a\u554f\u984c\u7684\u6709\u7528\u4e14\u7279\u5b9a\u65bc\u61c9\u7528\u7a0b\u5e8f\u7684\u8b66\u5831 - \u9019\u4e9b\u4e0d\u4e00\u5b9a\u662f\u6280\u8853\u6027\u7684\uff0c\u4f46\u4e5f\u53ef\u80fd\u662f\u696d\u52d9 KPI\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u516c\u958b\u767b\u9304/\u8a3b\u92b7\u4e8b\u4ef6\u6307\u6a19\uff0c\u4ee5\u4fbf\u8b66\u5831\u53ef\u4ee5\u57f7\u884c\u8da8\u52e2\u5206\u6790\uff0c\u5728\u51fa\u73fe\u554f\u984c\u6642\u901a\u77e5\u60a8\uff0c\u4f8b\u5982\u5982\u679c\u60a8\u7684\u6bcf\u6708\u767b\u9304\u6b21\u6578\u958b\u59cb\u4e0b\u964d \u95dc\u65bc\u60a8\u4f5c\u70ba\u7cfb\u7d71\u4e00\u90e8\u5206\u4f7f\u7528\u7684\u7b2c\u4e09\u65b9\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\u3001\u8ca0\u8f09\u5747\u8861\u5668\u7b49\uff09\uff0c\u60a8\u9700\u8981\u4e86\u89e3\u53ef\u4ee5\u5f9e\u4e2d\u6aa2\u6e2c\u54ea\u4e9b\u6307\u6a19\uff0c\u4e26\u4e14\u53ea\u6293\u53d6\u90a3\u4e9b\u8207\u60a8\u7684\u7cfb\u7d71\u76f8\u95dc\u7684\u6307\u6a19 \u6e2c\u8a66 (Testing) \uff1a\u9664\u4e86\u7de8\u5beb\u60a8\u901a\u5e38\u7684\u201c\u9810\u751f\u7522\u968e\u6bb5\u201d\u6e2c\u8a66\uff08\u5728\u67d0\u4e9b\u55ae\u7368\uff08\u96c6\u6210\uff09\u74b0\u5883\u4e2d\u904b\u884c\uff0c\u4f8b\u5982\u5728 CI \u7ba1\u9053\u4e2d\uff09\u4e4b\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u7de8\u5beb\u6a21\u64ec\u751f\u7522\u74b0\u5883\u4e2d\u771f\u5be6\uff08\u8ca0\u8f09\uff09\u689d\u4ef6\u7684\u6e2c\u8a66\uff0c\u6216\u8005\u5b83\u7684\u7cbe\u78ba\u514b\u9686\u3002\u9019\u5305\u62ec\u7de8\u5beb\u89f8\u767c\u8b66\u5831\u7684\u6e2c\u8a66\u3002\u5426\u5247\uff0c\u4f60\u600e\u9ebc\u77e5\u9053\u4f60\u914d\u7f6e\u7684\u8b66\u5831\u771f\u7684\u6709\u6548\uff1f\u9019\u5305\u62ec\u61c9\u7528 chaos monkey \u6a21\u5f0f\u3002 \u7dad\u904b (Operations) \uff1a\u60a8\u914d\u7f6e\u548c\u904b\u884c\u76e3\u63a7\u8edf\u4ef6\uff08\u4f8b\u5982 Prometheus \u5806\u68e7\uff09\uff0c\u8a72\u8edf\u4ef6\u6301\u7e8c\u76e3\u63a7\u6307\u6a19\u4e26\u751f\u6210\u8b66\u5831\uff0c\u4e26\u63d0\u4f9b\u53ef\u4ee5\u6309\u9700\u4f7f\u7528\u7684\u5100\u8868\u677f\u4f86\u8a3a\u65b7\u554f\u984c\uff08\u4f8b\u5982\u5206\u6790\u65e5\u8a8c\u548c\u8ddf\u8e2a\uff09\u3002\u60a8\u9084\u53ef\u4ee5\u76e3\u63a7\u90e8\u7f72\u904e\u7a0b\u672c\u8eab\uff0c\u4f8b\u5982\u901a\u904e\u6536\u96c6\u4f5c\u70ba CI/CD \u7ba1\u9053\u7684\u4e00\u90e8\u5206\u5275\u5efa\u7684\u4e8b\u4ef6\u6578\u64da\u3002 Observability vs. monitoring \" \u53ef\u89c0\u5bdf\u6027 \"\u662f\u4e00\u500b\u975e\u5e38\u91cd\u8981\u7684\u8853\u8a9e\u3002\u5c0d\u65bc\u5c07\" \u53ef\u89c0\u5bdf\u6027 \"\u8207\" \u76e3\u63a7 \"\u5340\u5206\u958b\u4f86\uff0c\u4e26\u6c92\u6709\u660e\u78ba\u4e14\u7d55\u5c0d\u7684\u5b9a\u7fa9\uff0c\u53ea\u662f\" \u53ef\u89c0\u5bdf\u6027 \"\u4e0d\u50c5\u50c5\u662f\" \u76e3\u63a7 \"\u3002\u4e0a\u9762\u7684\u5b9a\u7fa9\u662f Cindy \u7684\uff0c\u5176\u4ed6\u4eba\u53ef\u80fd\u6709\u4e0d\u540c\u7684\u770b\u6cd5\uff0c\u5c24\u5176\u662f\u5de5\u5177\u5546\uff0c\u4ed6\u5011\u9700\u8981\u8ce3\u7d66\u4f60\u4e00\u4e9b\u6771\u897f\u3002\u8acb\u53c3\u95b1\u9019\u7bc7 \u51fa\u8272\u7684\u6587\u7ae0 \u9032\u884c\u8a0e\u8ad6\u3002","title":"\u4ec0\u9ebc\u662f\u53ef\u89c0\u5bdf\u6027\uff1f"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part1/#prometheusloki-grafana","text":"\u53ef\u89c0\u5bdf\u6027\u9818\u57df\u6709\u8a31\u591a\u5de5\u5177\uff0c\u5f9e Netdata \u6216 Zabbix \u7b49\u958b\u6e90\u8edf\u4ef6\uff0c\u5230 Datadog\u3001Splunk\u3001LightStep\u3001sumo logic \u6216 Instana \u7b49\u5546\u696d (SaaS) \u7522\u54c1\u3002\u5728\u672c\u7cfb\u5217\u6587\u7ae0\u4e2d\uff0c\u6211\u5c07\u91cd\u9ede\u4ecb\u7d39\u201cPrometheus \u5806\u68e7\u201d\uff08\u9644\u5e36\u5de5\u5177\u3001Alertmanager\u3001Loki \u548c Grafana\uff09\uff0c\u5b83\u662f OSS\uff0c\u4e26\u4e14\u5728 Kubernetes \u74b0\u5883\u548c\u5176\u4ed6\u74b0\u5883\u4e2d\u8b8a\u5f97\u975e\u5e38\u6d41\u884c\u3002\u4e5f\u5c31\u662f\u8aaa\uff0c\u4f60\u4e5f\u53ef\u4ee5\u5728\u88f8\u6a5f\u4e0a\u64cd\u4f5c Prometheus \u7b49\uff0c\u6216\u8005\u4f7f\u7528 Docker\uff08compose\uff09\u3002 \u5982\u679c\u4f60\u4e5f\u5c0d\u5206\u4f48\u5f0f\u8ddf\u8e2a\u611f\u8208\u8da3\uff0c\u6211\u5efa\u8b70\u4f60\u770b\u770b Grafana \u7684 Tempo \u3002","title":"\u70ba\u4ec0\u9ebc\u9078\u64c7 Prometheus\u3001Loki \u548c Grafana?"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part1/#_3","text":"\u7576\u6211\u958b\u59cb\u5b78\u7fd2\u9019\u500b\u9818\u57df\u6642\uff0c\u6211\u4e0d\u77e5\u9053\u5f9e\u54ea\u88e1\u958b\u59cb\u3002\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\uff0c\u6211\u5f04\u6e05\u695a\u4e86\u54ea\u4e9b\u77e5\u8b58\u584a\u662f\u76f8\u4e92\u4f9d\u8cf4\u7684\u3002\u6211\u78ba\u5b9a\u4e86\u4e0b\u9762\u63cf\u8ff0\u7684\u4e09\u500b\u8ecc\u9053\uff0c\u9019\u662f\u4e00\u7a2e\u6d41\u7a0b\u5716\u3002\u60a8\u53ef\u4ee5\uff08\u4e26\u4e14\u61c9\u8a72\uff09\u540c\u6642\u9032\u884c\u6280\u8853\u8ddf\u8e2a\u548c\u9ad8\u7d1a\u53ef\u89c0\u5bdf\u6027\u8ddf\u8e2a\u3002\u628a\u5b83\u5011\u60f3\u50cf\u6210\u4f60\u5728\u7372\u5f97\u99d5\u7167\u6642\u8981\u7d93\u6b77\u7684\u201c\u7406\u8ad6\u548c\u5be6\u8e10\u201d\u8ecc\u9053\u3002\u53ea\u6709\u7576\u4f60\u5b8c\u6210\u4e86\u9019\u5169\u500b\u8ecc\u9053\u4e4b\u5f8c\uff0c\u624d\u6709\u610f\u7fa9\u958b\u59cb\u5728 Kubernetes \u4e2d\u4f7f\u7528 Prometheus\u3002 \u70ba\u7c21\u55ae\u8d77\u898b\uff0c\u672c\u5b78\u7fd2\u6307\u5357\u50c5\u9650\u65bc Prometheus\u3001Alertmanager \u548c Grafana\u3002\u4f7f\u7528 Loki \u9032\u884c\u65e5\u8a8c\u7ba1\u7406\u4e0d\u662f\u5176\u4e2d\u7684\u4e00\u90e8\u5206\uff0c\u56e0\u70ba\u4e00\u65e6\u60a8\u719f\u6089\u4e86\u6240\u6709\u5176\u4ed6\u6982\u5ff5\uff0c\u5b83\u5c31\u662f\u4e00\u500b\u201c\u7c21\u55ae\u201d\u7684\u9644\u52a0\u529f\u80fd\u3002\u6211\u5c07\u5728\u4ee5\u5f8c\u7684\u6587\u7ae0\u4e2d\u8a73\u7d30\u4ecb\u7d39 Loki\u3002 \u8b93\u6211\u5011\u66f4\u8a73\u7d30\u5730\u770b\u4e00\u4e0b\u6bcf\u500b\u55ae\u7368\u6b65\u9a5f\u7684\u76ee\u6a19\uff1a Technical track : \u4e86\u89e3\u9ad8\u5c64\u67b6\u69cb\u548c\u6578\u64da\u6d41\uff1a\u4e86\u89e3 Prometheus \u5806\u68e7\u7684\u4e0d\u540c\u7d44\u4ef6/\uff08Linux\uff09\u9032\u7a0b\uff0c\u5b83\u5011\u5404\u81ea\u505a\u4ec0\u9ebc\uff0c\u4ee5\u53ca\u4ec0\u9ebc\u6578\u64da\u5728\u4ec0\u9ebc\u6642\u9593\u6d41\u5411\u53e6\u4e00\u500b\u7d44\u4ef6\u3002 \u4e86\u89e3\u6982\u5ff5\u548c\u8853\u8a9e\uff1aPrometheus \u5f15\u5165\u4e86\u5f88\u591a\u6982\u5ff5\uff0c\u6bd4\u5982 metric\u3001\u6642\u9593\u5e8f\u5217\u3001instrumentation\u3001recording/alerting rules\u3001target label \u7b49\uff0c\u5927\u5bb6\u90fd\u9700\u8981\u638c\u63e1\u597d\u3002 \u4e86\u89e3\u5728\u54ea\u91cc\u4ee5\u53ca\u5982\u4f55\u914d\u7f6e\u548c\u9023\u63a5\u4e0d\u540c\u7684\u9032\u7a0b\uff1a\u4e86\u89e3\u54ea\u4e9b\u7d44\u4ef6\u914d\u7f6e\u4e86\uff08\u7121\u72c0\u614b\uff09\u914d\u7f6e\u6587\u4ef6\uff0c\u54ea\u4e9b\u7d44\u4ef6\u5c07\u914d\u7f6e\u5b58\u5132\u5728\u53ef\u8b8a/\u6709\u72c0\u614b\u6578\u64da\u5eab\u4e2d\u3002 Prometheus \u5806\u68e7\u4e2d\u7684\u6240\u6709\u5de5\u5177\u90fd\u4ee5\u4e0d\u540c\u7684\u65b9\u6cd5\u914d\u7f6e\u5728\u4e0d\u540c\u7684\u5730\u65b9\u3002 \u5b78\u7fd2 PromQL\uff1a\u719f\u6089 Prometheus \u7684\u67e5\u8a62\u8a9e\u8a00\uff0c\u60a8\u9700\u8981\u4f7f\u7528\u5b83\u4f86\u69cb\u5efa\u8b66\u5831\u548c Grafana \u5100\u8868\u677f\u3002 \u4e86\u89e3\u5982\u4f55\u4f7f\u7528\u73fe\u6709\u5100\u8868\u677f\u3001\u4fee\u6539\u5b83\u5011\u4e26\u5275\u5efa\u81ea\u5df1\u7684\u5100\u8868\u677f\uff1a\u60a8\u4e0d\u50c5\u9700\u8981\u4e86\u89e3\u5982\u4f55\u8fed\u4ee3\u69cb\u5efa\u5100\u8868\u677f\uff08\u5f9e\u73fe\u6709\u5100\u8868\u677f\u958b\u59cb\uff09\u4ee5\u7bc0\u7701\u6642\u9593\uff0c\u9084\u9700\u8981\u7372\u5f97\u4e00\u4e9b\u7d93\u9a57\u4ee5\u907f\u514d\u69cb\u5efa\u904e\u8f09\u7684\u5100\u8868\u677f. \u4e86\u89e3\u5982\u4f55\u70ba\u7b2c\u4e09\u65b9\u670d\u52d9\u69cb\u5efa\u548c\u9078\u64c7\u8b66\u5831\uff1a\u96d6\u7136\u60a8\u9084\u9700\u8981\u70ba\u81ea\u5df1\u7684\u7d44\u4ef6\u69cb\u5efa\u8b66\u5831\uff08\u8acb\u53c3\u95b1\u9ad8\u7d1a\u53ef\u89c0\u5bdf\u6027\u8ecc\u9053\u4e2d\u7684\u7b2c\u4e09\u500b\u4efb\u52d9\uff09\uff0c\u4f46\u60a8\u9084\u9700\u8981\u78ba\u5b9a\u8981\u4f7f\u7528\u7684 Prometheus \u5c0e\u51fa\u5668\u5c0d\u65bc\u7b2c\u4e09\u65b9\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\uff09\uff0c\u4ee5\u53ca\u60a8\u61c9\u8a72\u70ba\u5176\u773e\u591a\u6307\u6a19\u4e2d\u7684\u54ea\u4e00\u500b\u5275\u5efa\u8b66\u5831\u3002 High-level track : \u5c0d\u201c\u53ef\u89c0\u5bdf\u6027\u201d\u6709\u5927\u81f4\u7684\u4e86\u89e3\uff08\u6216\u5b9a\u7fa9\u60a8\u81ea\u5df1\u7684\uff09\uff1a\u5728\u60a8\u7684\u5718\u968a\u4e2d\uff0c\u78ba\u4fdd\u6bcf\u500b\u4eba\u90fd\u5c0d\uff08\u5c0d\u60a8\u800c\u8a00\uff09\u53ef\u89c0\u5bdf\u6027\u610f\u5473\u8457\u4ec0\u9ebc\u6709\u76f8\u540c\u7684\u7406\u89e3\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u73fe\u6709\u7684\u5b9a\u7fa9\uff0c\u4e5f\u53ef\u4ee5\u5efa\u7acb\u81ea\u5df1\u7684\u66f4\u72f9\u7a84\u4f46\u9069\u7528\u65bc\u60a8\u7684\u7279\u5b9a\u4fc2\u7d71\u548c\u5718\u968a\u7684\u5b9a\u7fa9\u3002 \u5efa\u7acb\u53ef\u89c0\u5bdf\u6027\u7b56\u7565\uff0c\u8a73\u7d30\u8aaa\u660e\u60a8\u7684\u76ee\u6a19\u548c\u8def\u7dda\u5716\uff1a\u9019\u5305\u62ec\u5b9a\u7fa9\u53ef\u89c0\u5bdf\u6027\u5e6b\u52a9\u60a8\u5be6\u73fe\u7684\u7e3d\u9ad4\u6700\u7d42\u76ee\u6a19\uff08\u4f7f\u7528\u201c\u786c\u201d\u6578\u5b57\uff0c\u4f8b\u5982\u4ee5 SLO \u7684\u5f62\u5f0f\uff09\uff0c\u60a8\u5e0c\u671b\u5982\u4f55\u958b\u59cb\uff08\u9010\u6f38\u6dfb\u52a0\u53ef\u89c0\u5bdf\u6027\uff09 \uff0c\u5b9a\u7fa9\u5206\u914d\u7d66\u69cb\u5efa\u53ef\u89c0\u5bdf\u6027\u529f\u80fd\u7684\uff08\u5de5\u6642\uff09\u9810\u7b97\uff0c\u662f\u5426\uff08\u4ee5\u53ca\u5982\u4f55\uff09\u5be6\u65bd\u201c\u96a8\u53eb\u96a8\u5230\u201d\uff0c\u6216\u5982\u4f55\u8ddf\u8e2a\u4e8b\u4ef6\u3002 \u5b78\u7fd2\u9ad8\u7d1a\u8b66\u5831\u8a2d\u8a08\u539f\u5247\uff1a\u9019\u672c\u8cea\u4e0a\u662f\u5728\u8a72\u9818\u57df\u5de5\u4f5c\u7684\u4eba\u5011\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u6536\u96c6\u7684\u539f\u5247\u5217\u8868\u3002\u4f8b\u5982\uff0c\u60a8\u61c9\u8a72\u5f9e\u7528\u6236\u7684\u89d2\u5ea6\uff08\u4f7f\u7528\u696d\u52d9 KPI\uff09\u800c\u4e0d\u662f\u6280\u8853\u8b66\u5831\uff08\u91dd\u5c0d\u670d\u52d9\u5668\u6216\u670d\u52d9\uff09\u958b\u59cb\u69cb\u5efa\u8b66\u5831\u3002 \u6536\u96c6\u76e3\u63a7\u63d0\u793a\uff1a\u5c0d\u65bc\u7cfb\u7d71\u7684\u6bcf\u7a2e\u985e\u578b\u7684\u7d44\u4ef6\uff08\u4f8b\u5982\u524d\u7aef\u3001\u670d\u52d9\u5668\u7bc0\u9ede\u6216\u670d\u52d9\uff09\uff0c\u5df2\u7d93\u6709\u5f88\u591a\u95dc\u65bc\u5982\u4f55\u9032\u884c\u6aa2\u6e2c\u4ee5\u53ca\u70ba\u54ea\u4e9b\u6307\u6a19\u7de8\u5beb\u8b66\u5831\u7684\u7d93\u9a57\u8b49\u64da\u548c\u63d0\u793a\u3002\u4f8b\u5982\uff0c\u524d\u7aef\u6700\u91cd\u8981\u7684\u56e0\u7d20\u901a\u5e38\u662f\u97ff\u61c9\u6642\u9593\u3002 Kubernetes track : \u4e86\u89e3\u53ef\u7528\u7684\u5de5\u5177\u548c\u5468\u908a\u751f\u614b\u7cfb\u7d71\uff1a\u5728 Kubernetes \u4e2d\u90e8\u7f72\u548c\u5b9a\u5236 Prometheus \u5806\u68e7\u7684\u65b9\u5f0f\u6709\u5f88\u591a\u7a2e\uff0c\u4f8b\u5982 Prometheus operator\uff0c\u60a8\u9700\u8981\u5f9e\u4e2d\u9078\u64c7\u4e00\u7a2e\u3002\u9084\u6709\u4e00\u500b\u7531\u793e\u5340\u69cb\u5efa\u7684\u751f\u614b\u7cfb\u7d71\uff0c\u5305\u62ec\u984d\u5916\u7684\u6709\u7528\u8cc7\u6e90\u548c\u5de5\u5177\u4f86\u7c21\u5316\u6d41\u7a0b\uff0c\u4f8b\u5982 kube-prometheus\u3002 \u4f7f\u7528\u539f\u751f K8s \u5c0d\u8c61\u91cd\u65b0\u5b78\u7fd2\u914d\u7f6e [...]\uff1a\u7576\u4f7f\u7528 Kubernetes \u7684 Prometheus operator \u6642\uff0c\u60a8\u5c07\u4e0d\u518d\u70ba Prometheus \u7b49\u7de8\u5beb\u201c\u50b3\u7d71\u201d yaml \u914d\u7f6e\u6587\u4ef6\uff0c\u800c\u662f\u4f7f\u7528 Kubernetes \u539f\u751f\u5de5\u4f5c\u8ca0\u8f09\u5c0d\u8c61\uff08\u4f8b\u5982 ServiceMonitor\uff09\u4f86\u914d\u7f6e\u5b83\u5011\uff0c\u64cd\u4f5c\u54e1\u5728\u904b\u884c\u6642\u5c07\u5176\u8f49\u63db\u70ba\u50b3\u7d71\u7684\u914d\u7f6e\u6587\u4ef6\u3002","title":"\u5b78\u7fd2\u6307\u5357"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part1/#_4","text":"\u5728 Kubernetes \u4e2d\u555f\u52d5\u4e26\u904b\u884c Prometheus \u4e26\u975e\u6613\u4e8b\uff0c\u56e0\u70ba\u60a8\u9700\u8981\u5177\u5099\u5927\u91cf\u80cc\u666f\u77e5\u8b58\u3002\u901a\u904e\u672c\u6587\u4e2d\u4ecb\u7d39\u7684\u5b78\u7fd2\u6307\u5357\uff0c\u6211\u53ea\u7e6a\u88fd\u4e86\u4e00\u5f35\u7c97\u7565\u7684\u5730\u5716\uff0c\u6982\u8ff0\u4e86\u901a\u5f80 Kubernetes \u7684\u57fa\u65bc Prometheus \u7684\u53ef\u89c0\u5bdf\u6027\u5806\u68e7\u7684\u65c5\u7a0b\u3002\u4f46\u662f\uff0c\u5c0d\u65bc\u5b78\u7fd2\u6307\u5357\u7684\u6bcf\u500b\u6b65\u9a5f\uff0c\u60a8\u4ecd\u7136\u9700\u8981\u5177\u9ad4\u7684\u5b78\u7fd2\u8cc7\u6e90\u3002 \u5c0d\u65bc\u9ad8\u7d1a\u8ab2\u7a0b\u6db5\u84cb\u7684\u6b65\u9a5f\uff0c\u6211\u5efa\u8b70\u60a8\u67e5\u770b Practical Monitoring \u2013 Effective Strategies for the Real World (2017) \u4e00\u66f8\uff0c\u8a72\u66f8\u63d0\u4f9b\u4e86\u5f88\u597d\u7684\u6982\u8ff0\u3002\u81f3\u65bc\u5c0e\u5165\u7684\u6b65\u9a5f\uff0c\u8acb\u67e5\u770b\u672c\u7cfb\u5217\u5176\u4ed6\u6587\u7ae0\u3002","title":"\u7d50\u8ad6"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/","text":"Prometheus, Alertmanager & Grafana \u67b6\u69cb\u4ecb\u8a54 \u00b6 \u539f\u6587: Kubernetes Observability \u2013 Part II: architecture introduction to Prometheus, Alertmanager & Grafana \u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86 Prometheus \u5806\u68e7\u7684\u67b6\u69cb\uff0c\u7531\u5404\u500b\u61c9\u7528\u7a0b\u5e8f Prometheus\u3001Alertmanager\u3001Grafana\u3001Pushgateway \u548c\u5404\u7a2e Exporter \u7d44\u6210\u3002\u672c\u6587\u6703\u8a0e\u8ad6\u4e86\u6bcf\u500b\u7d44\u4ef6\u662f\u5982\u4f55\u914d\u7f6e\u7684\uff0c\u5b83\u5b58\u5132\u4e86\u54ea\u7a2e\u6578\u64da\uff0c\u4ee5\u53ca\u5982\u4f55\u64f4\u5c55 Prometheus\u3002 Prometheus \u7c21\u4ecb \u00b6 Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c\u53ef\u89c0\u5bdf\u6027\u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u7b2c\u4e00\u6b65\uff08\u5728\u6280\u8853\u8ecc\u9053\u4e0a\uff09\u662f\u4e86\u89e3\u6b64\u5806\u68e7\u7684\u67b6\u69cb\uff0c\u4ee5\u53ca\u4e0d\u540c\u5de5\u5177\u5982\u4f55\u7d44\u5408\u5728\u4e00\u8d77\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86\u67b6\u69cb\uff0c\u89e3\u91cb\u4e86\u5176\u80cc\u5f8c\u7684\u57fa\u672c\u539f\u7406\uff0c\u5982\u4f55\u914d\u7f6e\u5404\u500b\u7d44\u4ef6\uff0c\u9084\u89e3\u91cb\u4e86 Prometheus \u5982\u4f55\u64f4\u5c55\u3002 \u67b6\u69cb high-level \u6982\u8ff0 \u00b6 Prometheus \u5806\u68e7\u7531\u8a31\u591a\u7368\u7acb\u7684\u7a0b\u5e8f/\u61c9\u7528\u7a0b\u5e8f\u7d44\u6210\uff0c\u5b83\u5011\u90fd\u6709\u5c08\u9580\u7684\u8077\u8cac\u3002\u5b83\u5011\u90fd\u901a\u904e HTTP \u76f8\u4e92\u901a\u4fe1\u4ee5\u5be6\u73fe\u5b83\u5011\u7684\u7e3d\u9ad4\u76ee\u6a19\uff1a\uff08\u53ef\u80fd\u662f\u5927\u898f\u6a21\u7684\uff09\u5206\u4f48\u5f0f\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002 Prometheus \u80cc\u5f8c\u7684\u5718\u968a\u9078\u64c7\u4e86\u9019\u7a2e\u95dc\u6ce8\u9ede\u5206\u96e2\u7684\u65b9\u6cd5\uff0c\u4ee5\u4fbf\u6bcf\u500b\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u55ae\u7368\u914d\u7f6e\u548c\u90e8\u7f72\uff08\u5982\u679c\u9700\u8981\uff0c\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u6a5f\u5668\u4e0a\uff09\u3002\u5b83\u9084\u964d\u4f4e\u4e86\u6bcf\u500b\u55ae\u7368\u7a0b\u5e8f\u7684\u8907\u96dc\u6027\u3002\u5148\u770b\u4e00\u4e0b \u5b98\u65b9\u6587\u6a94\u7684 Prometheus \u67b6\u69cb\u5716 \uff1a \u6211\u5011\u7684\u6838\u5fc3\u662f Prometheus \u670d\u52d9\u5668\uff0c\u5b83\u6709\u5e7e\u500b\u5b50\u7cfb\u7d71\uff0c\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f TSDB\u3001\u6aa2\u7d22\u7d44\u4ef6\u548c HTTP \u670d\u52d9\u5668\u3002 TSDB \u662f\u4e00\u500b\u6301\u4e45\u7684\u3001\u57fa\u65bc\u78c1\u76e4\u7684\u6642\u5e8f\u6578\u64da\u5eab\u3002\u6aa2\u7d22\u7d44\u4ef6\u5b9a\u671f\u5f9e\u516c\u958b\u9019\u4e9b\u6307\u6a19\uff08\u901a\u904e HTTP\uff09\u7684\u5176\u4ed6\u61c9\u7528\u7a0b\u5e8f\u4e2d\u63d0\u53d6\u201c\u6307\u6a19\u6578\u64da\u201d\uff0c\u4f8b\u5982\u6bcf 15 \u79d2\uff0c\u4e26\u5c07\u5b83\u5011\u5b58\u5132\u5728 TSDB \u4e2d\u3002\u9019\u7a2e\u6709\u898f\u5f8b\u7684\u62c9\u52d5\u4e5f\u7a31\u70ba\u201c \u522e\u53d6(scrape) \u201d\u3002 Prometheus HTTP \u670d\u52d9\u5668\u63d0\u4f9b\u4e86\u4e00\u500b REST \u7aef\u9ede\uff0c\u5141\u8a31\u5176\u4ed6\u7cfb\u7d71\uff08\u4f8b\u5982 Grafana\uff09\u67e5\u8a62\u5b58\u5132\u7684\u6307\u6a19\u6578\u64da\u3002 \u4ec0\u9ebc\u662f\u6307\u6a19 (Metrics) \u4e00\u822c\u800c\u8a00\uff0c\u6307\u6a19\u662f\u63d0\u4f9b\u6709\u95dc\u7279\u5b9a\u670d\u52d9\uff08\u4f8b\u5982\u9032\u7a0b\uff09\u6216\u7cfb\u7d71\uff08\u4f8b\u5982\u670d\u52d9\u5668\u7bc0\u9ede\uff09\u7684\u4fe1\u606f\u7684\u6578\u5b57\u6578\u64da\u3002\u4e00\u500b\u5177\u9ad4\u7684\u4f8b\u5b50\u53ef\u4ee5\u662f\u7bc0\u9ede\u7684\u78c1\u76e4\u4f7f\u7528\u91cf\uff0c\u6216\u8005\u5c0d HTTP \u670d\u52d9\u5668\uff08\u6216\u7279\u5b9a HTTP \u8def\u5f91\uff09\u7684\u8acb\u6c42\u7e3d\u6578\u3002\u6307\u6a19\u6a19\u6e96\u5b58\u5132\u5728 TSDB \u4e2d\uff0c\u53ef\u4ee5\u6709\u6548\u5730\u58d3\u7e2e\u3001\u8655\u7406\u548c\u6aa2\u7d22\u5b83\u5011\u3002 \u5728 Prometheus \u4e2d\uff0c\u6307\u6a19\u7684\u683c\u5f0f\u5f88\u7c21\u55ae\uff1a <name>{label1=value1,label2=value2,...} <float64 value> \u4e00\u500b\u5177\u9ad4\u7684\u4f8b\u5b50\uff1a prometheus_target_metadata_cache_bytes{scrape_job=\"alertmanager\"} 5672 \u5728 Prometheus \u4e2d\uff0c\u6307\u6a19\u662f\u7531 Exporter \u7b49\u61c9\u7528\u7a0b\u5e8f\u5275\u5efa\u7684\uff08\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u898b\u4e0b\u6587\uff09\u3002\u6307\u6a19\u901a\u904e HTTP \u4ee5\u7d14\u6587\u672c\u5f62\u5f0f\u516c\u958b\uff0c\u901a\u5e38\u5728 /metric \u7aef\u9ede\u4e0a\uff0c\u6bcf\u884c\u4e00\u500b\u6307\u6a19\u3002\u5982\u60a8\u6240\u898b\uff0c\u8f38\u51fa\u4e2d\u6c92\u6709\u6642\u9593\u6233\uff0c\u56e0\u70ba Prometheus \u671f\u671b\u8fd4\u56de\u7684\u6307\u6a19\u53cd\u6620\u7576\u524d\u72c0\u614b\uff0c\u800c Prometheus \u5728\u5c07\u6293\u53d6\u7684\u6578\u64da\u5b58\u5132\u5230\u5176 TSDB \u6642\u6703\u6dfb\u52a0\u6642\u9593\u6233\u3002 \u6307\u6a19\u5f9e\u4f55\u800c\u4f86\uff1f\u516c\u958b\u66b4\u9732\u6307\u6a19\u7684\u61c9\u7528\u7a0b\u5e8f\u6709\u5169\u7a2e\u57fa\u672c\u985e\u578b\uff1a Your own application \uff0c\u60a8\u70ba\u6b64\u5be6\u65bd\u4e86\u4e00\u500b\u63d0\u4f9b\u9019\u4e9b\u6307\u6a19\u7684 /metrics HTTP \u7aef\u9ede\u3002 Prometheus \u793e\u5340\u70ba\u6240\u6709\u5e38\u898b\u7684\u7de8\u7a0b\u8a9e\u8a00\u69cb\u5efa\u4e86\u7c21\u5316\u6b64\u4efb\u52d9\u7684 SDK\u3002 A third-party exporter \u3002\u5c0e\u51fa\u5668(exporter)\u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u4f7f\u7528\u8a72\u7cfb\u7d71\u7684\u5c08\u6709 API \u5f9e\u7b2c\u4e09\u65b9\u7cfb\u7d71\uff08\u4f8b\u5982\u6578\u64da\u5eab\u670d\u52d9\u5668\u6216\u4e3b\u6a5f\u7684\u64cd\u4f5c\u7cfb\u7d71\u5167\u6838\uff09\u4e2d\u6293\u53d6\u6307\u6a19\uff0c\u4e26\u5c07\u7372\u5f97\u7684\u6307\u6a19\u8f49\u63db\u70ba Prometheus \u6307\u6a19\u683c\u5f0f\uff0c\u4e26\u5c07\u5b83\u5011\u66b4\u9732\u5728 /metrics \u7aef\u9ede\u3002\u7b2c\u4e09\u65b9\u7cfb\u7d71\u672c\u8eab\u4e26\u4e0d\u77e5\u9053\u5b83\u6b63\u5728\u88ab\u89c0\u5bdf\u3002\u6709\u6578\u767e\u500b\u5373\u7528\u578b exporter\uff0c\u8acb\u53c3\u898b \u6b64\u8655 \u548c \u6b64\u8655 \uff01\u6700\u8457\u540d\u7684\u662f \u7bc0\u9ede\u5c0e\u51fa\u5668(node exporter) \uff0c\u5b83\u5f9e\u8a08\u7b97\u7bc0\u9ede\u4e2d\u63d0\u53d6\u6307\u6a19\uff0c\u4f8b\u5982\u5167\u5b58\u3001\u5b58\u5132\u3001\u7db2\u7d61\u548c CPU \u7684\u4f7f\u7528\u60c5\u6cc1\u3002\u53e6\u4e00\u500b\u91cd\u8981\u7684\u662f cAdvisor \uff0c\u5b83\u5c0e\u51fa\u4e86\u904b\u884c Docker \u5bb9\u5668\u7684\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u548c\u6027\u80fd\u7279\u5fb5\u3002 \u56de\u5230\u201c \u522e\u53d6(scrape) \u201d\u7684\u8a2d\u8a08\u3002\u5728\u6bcf\u500b\u6293\u53d6\u5faa\u74b0\u7d50\u675f\u6642\uff0cPrometheus \u6703\u6839\u64da\u76ee\u524d\u5b58\u5132\u7684\u6307\u6a19\u8a55\u4f30\u8b66\u5831\u898f\u5247\u3002\u60a8\u4f7f\u7528 Prometheus \u7684\u67e5\u8a62\u8a9e\u8a00 PromQL \u7de8\u5beb\u9019\u4e9b\u8b66\u5831\u898f\u5247\u3002\u8b66\u5831\u898f\u5247\u7684\u793a\u4f8b\u53ef\u80fd\u662f\u201c\u4efb\u4f55\u7bc0\u9ede\u4e0a\u7684\u4efb\u4f55\u78c1\u76e4\u7684\u78c1\u76e4\u4f7f\u7528\u7387\u5df2\u8d85\u904e 90%\u201d\u3002\u5982\u679c\u89f8\u767c\u4e86\u4efb\u4f55\u914d\u7f6e\u7684\u8b66\u5831\u898f\u5247\uff0cPrometheus \u6703\u751f\u6210\u8b66\u5831\u4e26\u5c07\u5176\u63a8\u9001\u5230 Alertmanager \u61c9\u7528\u7a0b\u5e8f\u3002 \u8acb\u6ce8\u610f\uff0c\u8b66\u5831\u53ea\u662f\u4e00\u500b (JSON) \u5c0d\u8c61\uff0c\u5c1a\u672a\u767c\u9001\u4efb\u4f55\u96fb\u5b50\u90f5\u4ef6\u3001\u5c0b\u547c\u6a5f\u6d88\u606f\u7b49\uff01\u7576 Alertmanager \u6536\u5230\u8b66\u5831\u6642\uff0c\u5b83\u6703\u5c07\u5176\u5b58\u5132\u5728\u5176\u5167\u90e8\u6578\u64da\u5eab\u4e2d\u3002 Alertmanager \u4f7f\u7528\u60a8\u63d0\u4f9b\u7684\u914d\u7f6e\u5c0d\u8b66\u5831\u9032\u884c\u91cd\u8907\u6578\u64da\u522a\u9664\u548c\u5206\u7d44\uff08\u4ee5\u6e1b\u5c11\u5783\u573e\u90f5\u4ef6\uff09\u3002\u7136\u5f8c\u5b83\u6703\u751f\u6210\u8b66\u5831\u901a\u77e5\uff0c\u5373\u5c07\u8b66\u5831\u8def\u7531\u5230\u6b63\u78ba\u7684\u63a5\u6536\u8005\uff0c\u4f8b\u5982\u96fb\u5b50\u90f5\u4ef6\u6216 PagerDuty\u3002 \u67b6\u69cb\u5716\u4e2d\u9084\u6709\u5169\u500b\u65b9\u6846\u9700\u8981\u7279\u5225\u8aaa\u660e\uff1a Pushgateway \u548c short-lived jobs \uff1a\u5982\u679c\u60a8\u5e0c\u671b Prometheus \u6536\u96c6\u751f\u547d\u9031\u671f\u975e\u5e38\u77ed\uff08\u6bd4 Prometheus \u7684\u6293\u53d6\u9593\u9694\u77ed\uff09\u7684\u61c9\u7528\u7a0b\u5e8f\u6216\u4f5c\u696d\uff08\u4f8b\u5982 cron \u4f5c\u696d\uff09\u7684\u6307\u6a19\uff0c\u90a3\u9ebc\u60a8\u6703\u9047\u5230\u554f\u984c\uff1a\u7576 Prometheus \u5617\u8a66\u6293\u53d6\u61c9\u7528\u7a0b\u5e8f\uff08\u53ca\u5176 /metrics HTTP \u7aef\u9ede\uff09\u6642\uff0c\u5b83\u53ef\u80fd\u4e0d\u5b58\u5728\u3002\u70ba\u4e86\u898f\u907f\u9019\u500b\u554f\u984c\uff0c\u60a8\u53ef\u4ee5\u904b\u884c Pushgateway \u4e4b\u985e\u7684\u5de5\u5177\uff0c\u9019\u662f\u4e00\u500b\u6c38\u4e45\u904b\u884c\u7684\u6307\u6a19\u7de9\u5b58\uff0c\u77ed\u671f\u4f5c\u696d\u53ef\u4ee5\u5c07\u6307\u6a19\u63a8\u9001\u5230\u8a72\u7de9\u5b58\u3002\u7136\u5f8c\uff0cPrometheus \u5f9e Pushgateway \u7684 /metrics \u7aef\u9ede\u6293\u53d6\u9019\u4e9b\u7de9\u5b58\u7684\u6307\u6a19\u3002 Service discovery \uff1aPrometheus \u662f\u70ba\u76e3\u63a7\u5927\u578b\u6c34\u5e73\u64f4\u5c55\u5206\u4f48\u5f0f\u7cfb\u7d71\u800c\u69cb\u5efa\u7684\u3002\u5b83\u5011\u7531\u8a31\u591a\uff08\u8a08\u7b97\uff09\u7bc0\u9ede\u548c\u670d\u52d9\u5be6\u4f8b\u7d44\u6210\uff0c\u5b83\u5011\u4e00\u76f4\u4f86\u4f86\u53bb\u53bb\uff0c\u4f8b\u5982\u7531\u65bc\u5f48\u6027\u7e2e\u653e\u3002\u5c0d\u65bc\u9019\u6a23\u7684\u7cfb\u7d71\uff0c\u624b\u52d5\u914d\u7f6e Prometheus \u7684\u6aa2\u7d22\u7d44\u4ef6\u61c9\u8a72\u6293\u53d6\u7684\u4e3b\u6a5f/\u76ee\u6a19\u7684\u975c\u614b\u5217\u8868\u5c07\u662f\u4e00\u500b\u96e3\u4ee5\u7ba1\u7406\u7684\u8ca0\u64d4\u3002 Prometheus \u7684\u670d\u52d9\u767c\u73fe\uff08SD\uff09\u6a5f\u5236\u5be6\u73fe\u4e86\u4e00\u7a2e\u52d5\u614b\u767c\u73fe\u6a5f\u5236\uff0c\u5df2\u7d93\u6709\u5f88\u591a\u5177\u9ad4\u7684\u5be6\u73fe\uff0c\u53ef\u4ee5\u52d5\u614b\u767c\u73fe\u6293\u53d6\u76ee\u6a19\u3002\u4f8b\u5982\uff0cSD \u53ef\u4ee5\u6aa2\u6e2c Kubernetes \u6216 Consul \u4e2d\u7684\u670d\u52d9\u548c\u7bc0\u9ede\uff08\u6709\u95dc\u5be6\u73fe\u5217\u8868\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94\u4e2d\u7684 ..._sd_config \uff09\u3002 \u5b83\u61c9\u8a72\u53ef\u4ee5\u5e6b\u52a9\u60a8\u4e86\u89e3\u4e0d\u540c\u61c9\u7528\u7a0b\u5e8f\u7684\u5b50\u7d44\u4ef6\u3002\u8b93\u6211\u5011\u518d\u770b\u4e00\u4e0b\u6578\u64da\u6d41\uff1a Prometheus \u7684\u6aa2\u7d22\u7d44\u4ef6\u5b9a\u671f\u5f9e\u61c9\u7528\u7a0b\u5e8f\u3001\u5c0e\u51fa\u5668\u751a\u81f3 Prometheus \u81ea\u5df1\u5c0e\u51fa\u7684\u6307\u6a19\u63d0\u4f9b\u7684 /metric \u7aef\u9ede\u8f2a\u8a62\u6307\u6a19\u3002\u9019\u4e9b\u6307\u6a19\u5b58\u5132\u5728 Prometheus \u7684\uff08\u5d4c\u5165\u5f0f\uff09TSDB \u4e2d\uff0c\u7576\u524d\u7684\u6293\u53d6\u6642\u9593\u6233\u88ab\u6dfb\u52a0\u5230\u6578\u64da\u4e2d\u3002 \u6bcf\u7576 Prometheus \u7684 Alert \u898f\u5247\u8a55\u4f30\u5668\u7d44\u4ef6\u6aa2\u6e2c\u5230\u5176\u914d\u7f6e\u7684\u67d0\u4e9b\u8b66\u5831\u898f\u5247\u88ab\u89f8\u767c\uff08\u5b83\u901a\u904e\u67e5\u8a62 TSDB \u4f86\u78ba\u5b9a\uff09\u6642\uff0c\u5b83\u5c31\u6703\u751f\u6210\u4e00\u500b\u8b66\u5831\u5c0d\u8c61\u4e26\u5c07\u5176\u767c\u9001\u7d66 Alertmanager\u3002 Alertmanager \u5c07\u6536\u5230\u7684\u8b66\u5831\u5c0d\u8c61\u5b58\u5132\u5728\u5b83\u81ea\u5df1\u7684\uff08\u5d4c\u5165\u5f0f\uff09\u6578\u64da\u5eab\u4e2d\uff0c\u540c\u6642\u9032\u884c\u91cd\u8907\u6578\u64da\u522a\u9664\u3002 Alertmanager \u7684 Notification \u7ba1\u9053\u5b9a\u671f\u8a55\u4f30\u5b58\u5132\u5728\u6578\u64da\u5eab\u4e2d\u7684\u8b66\u5831\uff08\u6839\u64da\u914d\u7f6e\u7684\u8b66\u5831\u8def\u7531\u6a39\uff0c\u4e0b\u9762\u6709\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff09\uff0c\u4e26\u5728\u9069\u7528\u6642\u5411\u914d\u7f6e\u7684\u63a5\u6536\u5668\u767c\u9001\u8b66\u5831\u901a\u77e5\u3002 \u201c\u63a5\u6536\u8005\u201d\u4e0d\u662f\u6307\u201c\u4eba\u201d\uff0c\u800c\u662f\u5be6\u969b\u901a\u77e5\u4eba\u5011\u7684\u7cfb\u7d71\uff08\u96fb\u5b50\u90f5\u4ef6\u3001Slack \u7b49\uff09 \u914d\u7f6e \u00b6 \u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff08Prometheus\u3001Alertmanager\u3001Grafana\u3001Exporters\uff09\u90fd\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u65b9\u6cd5\uff0c\u5982\u4e0b\u8868\u6240\u793a\uff1a Component Configuration approach Persisted stateful data Prometheus Stateless (files) Metrics Alertmanager Stateless (files) Alerts, silences Grafana Stateful + Stateless (provisioning mechanism) Grafana configuration Exporter Usually stateless (files), depends on exporter \u2014 \u6bcf\u4e00\u500b\u6b04\u5217\u7684\u542b\u7fa9\uff1a Configuration approach \uff1a\u7121\u72c0\u614b\u610f\u5473\u8457\u61c9\u7528\u7a0b\u5e8f\u4e0d\u6703\uff08\u6709\u72c0\u614b\u5730\uff09\u5728\u5167\u90e8\u5b58\u5132\u4efb\u4f55\u914d\u7f6e\u503c\uff0c\u4f8b\u5982\u5728\u6578\u64da\u5eab\u4e2d\u3002\u76f8\u53cd\uff0c\u914d\u7f6e\u901a\u5e38\u901a\u904e\u6587\u4ef6\u63d0\u4f9b\uff08\u4f8b\u5982\u683c\u5f0f\u5316\u70ba YAML \u6216 JSON\uff09\u3002\u9019\u4e9b\u6587\u4ef6\u61c9\u53d7\u7248\u672c\u63a7\u5236\uff0c\u4f8b\u5982\u5728 Git \u4e2d\u3002 \u7121\u72c0\u614b\u65b9\u6cd5\u7684\u512a\u9ede\u662f\uff1a \u60a8\u59cb\u7d42\u5728\u9019\u4e9b\u6587\u4ef6\u4e2d\u660e\u78ba\u66f4\u6539\u914d\u7f6e\uff08\u55ae\u4e00\u4e8b\u5be6\u4f86\u6e90\uff09 \u5c07\u61c9\u7528\u7a0b\u5e8f\u7684\u5be6\u4f8b\u5f9e\u4e00\u500b\u7bc0\u9ede\u79fb\u52d5\u5230\u53e6\u4e00\u500b\u7bc0\u9ede\u66f4\u5bb9\u6613\uff0c\u56e0\u70ba\u53ea\u9700\u8981\u639b\u8f09\u5e7e\u500b\u6587\u4ef6\uff08\u800c\u4e0d\u662f\u5fc5\u9808\u63d0\u53d6\u548c\u50b3\u8f38\u72c0\u614b\uff09 \u5c0d\u914d\u7f6e\u6240\u505a\u7684\u66f4\u6539\u662f\u53ef\u8ffd\u6eaf\u7684\uff08\u901a\u904e Git\uff09 \u914d\u7f6e\u6587\u4ef6\u662f\u4eba\u548c\u6a5f\u5668\u53ef\u8b80\u7684 \u7121\u72c0\u614b\u65b9\u6cd5\u7684\u7f3a\u9ede\u662f: \u60a8\u4e0d\u80fd\u52d5\u614b\u8abf\u6574\u914d\u7f6e\uff0c\u4f8b\u5982\u901a\u904e API \u8abf\u7528 \u8207 GUI \u76f8\u6bd4\uff0c\u901a\u904e\u6587\u672c\u66f4\u6539\u914d\u7f6e\u4e0d\u592a\u65b9\u4fbf\u4e14\u5bb9\u6613\u51fa\u932f Persisted stateful data \uff1a\u6307\u793a\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6709\u5167\u90e8\uff08\u6709\u72c0\u614b\uff09\u6578\u64da\u5b58\u5132\uff0c\u5982\u679c\u6709\uff0c\u5176\u4e2d\u5b58\u5132\u4e86\u54ea\u7a2e\u6578\u64da\u3002 \u8b93\u6211\u5011\u66f4\u4ed4\u7d30\u5730\u4f86\u4e86\u89e3\u6bcf\u4e00\u500b\u5143\u4ef6\u3002 Prometheus \u00b6 Prometheus \u5c0d\u65bc\u6536\u96c6\u7684\u6307\u6a19\uff08\u5b58\u5132\u5728 TSDB \u4e2d\uff09\u662f\u6709\u72c0\u614b\u7684\uff0c\u4f46\u5c0d\u65bc\u914d\u7f6e\u662f\u7121\u72c0\u614b\u7684\u3002\u56e0\u6b64\uff0c\u60a8\u7121\u6cd5\u901a\u904e Prometheus Web \u754c\u9762\u6216 API \u66f4\u6539\u914d\u7f6e\u3002\u4f46\u662f\uff0c\u6709\u7b2c\u4e09\u65b9\u9805\u76ee\uff0c\u4f8b\u5982 prometheus-configmanager \uff0c\u901a\u904e\u63d0\u4f9b\u914d\u7f6e API \u4f7f\u9019\u6210\u70ba\u53ef\u80fd\u3002 \u914d\u7f6e\u662f\u901a\u904e\u591a\u500b\u6587\u4ef6\u5b8c\u6210\u7684\uff0c\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff1a prometheus.yml global : scrape_interval : 15s evaluation_interval : 15s rule_files : - \"alert-rules.yml\" scrape_configs : - job_name : 'nodeexporter' scrape_interval : 5s static_configs : - targets : [ 'nodeexporter:9100' ] - job_name : 'cadvisor' scrape_interval : 5s static_configs : - targets : [ 'cadvisor:8080' ] - job_name : 'prometheus' scrape_interval : 10s static_configs : - targets : [ 'localhost:9090' ] alerting : alertmanagers : - scheme : http static_configs : - targets : - 'alertmanager:9093' global section: \u6307\u5b9a\u5168\u5c40\u914d\u7f6e\u53c3\u6578\uff0c\u4f8b\u5982\u6293\u53d6\u9593\u9694\u3002 rule_files section: \u6307\u5b9a\u8981\u8003\u616e\u7684\u8b66\u5831\u898f\u5247 yaml \u6587\u4ef6\u540d\u3002 scrape_configs section: \u6307\u5b9a\u6307\u6a19\u6293\u53d6\u4f5c\u696d\u7684\u5217\u8868\u3002\u6bcf\u500b\u4f5c\u696d\u90fd\u6709\u4e00\u500b\u540d\u7a31\uff08\u9019\u6a23 prometheus.yml \u4e2d\u7684 job_name: 'nodeexporter' \u4e4b\u985e\u7684\u6771\u897f\u6703\u5c0e\u81f4 Prometheus \u5728\u5c07\u6293\u53d6\u7684\u6307\u6a19\u5b58\u5132\u5728\u5176 TSDB \u4e2d\u6642\u6dfb\u52a0\u4e00\u500b\u6a19\u7c64\uff0c\u4f8b\u5982 job: 'nodeexporter'\uff09\u548c\u4e00\u500b\u6216\u591a\u500b\u76ee\u6a19IP\uff1a\u7aef\u53e3+\u8def\u5f91\u7684\u5f62\u5f0f\uff09\u3002 scrape_configs \u6578\u7d44\u4e2d\u7684\u5178\u578b\u689d\u76ee\u662f Prometheus \u670d\u52d9\u5668\u672c\u8eab\u3001Alertmanager\u3001cAdvisor\u3001nodeexporter\u3001Pushgateway \u548c\u5176\u4ed6\u81ea\u5b9a\u7fa9\u6307\u6a19 exporter\u3002\u5c0d\u65bc\u6bcf\u500b\u76ee\u6a19\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 static_config \uff08\u60a8\u53ea\u9700\u624b\u52d5\u63d0\u4f9b\u8981\u67e5\u8a62\u7684\u4e3b\u6a5f\u3001\u7aef\u53e3\u548c\u6307\u6a19 URL\uff09\uff0c\u6216\u4f7f\u7528\u52d5\u614b\u670d\u52d9\u767c\u73fe (service discovery) \u9078\u9805\u4e4b\u4e00\uff0c\u4f8b\u5982 kubernetes_sd_config \u6216 openstack_sd_config\u3002 alerting seciont: \u6307\u5b9a\u5411\u54ea\u500b Alertmanager \u5be6\u4f8b\u767c\u9001\u8b66\u5831\u3002 alert-rules.yml groups : - name : group1 rules : - alert : alert-name-1 expr : up == 0 for : 30s labels : # labels to attach to alerts severity : critical annotations : summary : \"Some monitoring-related service is non-operational\" description : \"Service {{ $labels.instance }} ({{ $labels.job }}) is down.\" - name : group2 rules : - alert : SomeHttpServicesAreDown expr : probe_success == 0 for : 10m labels : severity : critical annotations : summary : \"Some HTTP service is non-operational\" description : \"Service {{ $labels.instance }} ({{ $labels.job }}) is down.\" \u60a8\u53ef\u4ee5\u5728\u6b64\u8655\u5b9a\u7fa9\u8a18\u9304\u898f\u5247\u6216\u8b66\u5831\u898f\u5247\u3002 \u8a18\u9304\u898f\u5247\u5141\u8a31\u60a8\u9810\u5148\u8a08\u7b97\u60a8\u7d93\u5e38\u9700\u8981\u7684\u8a08\u7b97\u91cf\u5927\u7684\u6307\u6a19\u6578\u64da\uff08\u4f86\u81ea\u50b3\u5165\u7684\u539f\u59cb\u6307\u6a19\uff09\uff0c\u4e26\u5c07\u8a08\u7b97\u7d50\u679c\u4fdd\u5b58\u70ba\u4e00\u7d44\u65b0\u7684\u6307\u6a19\u3002\u9019\u5c0d\u65bc\u6bcf\u6b21\u5237\u65b0\u6642\u91cd\u8907\u67e5\u8a62\u76f8\u540c\uff08\u8a08\u7b97\u6210\u672c\u9ad8\uff09\u6307\u6a19\u6578\u64da\u7684\u5100\u8868\u677f\u8edf\u4ef6\uff08\u4f8b\u5982 Grafana\uff09\u5f88\u6709\u7528\u3002 \u8b66\u5831\u898f\u5247\u662f\u544a\u8a34 Prometheus \u4f55\u6642\u61c9\u8a72\u5411 Alertmanager \u767c\u9001\u8b66\u5831\u7684\u898f\u5247\u3002 alert-rules.yml \u6587\u4ef6\u4ee5 groups: \u90e8\u5206\u958b\u982d\uff0c\u60a8\u53ef\u4ee5\u5728\u5176\u4e2d\u6307\u5b9a\u4e00\u500b\u6216\u591a\u500b\u7d44\u3002\u5c0d\u65bc\u6bcf\u500b\u7d44\uff0c\u60a8\u5b9a\u7fa9\u4e00\u500b\u6216\u591a\u500b\u898f\u5247\u3002\u9664\u4e86\u9019\u4e9b\u898f\u5247\u4e4b\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u7d66\u6bcf\u500b\u7d44\u4e00\u500b\u540d\u7a31\u548c\u4e00\u500b\u53ef\u9078\u7684\u81ea\u5b9a\u7fa9\u9593\u9694\uff08\u8a55\u4f30\u767c\u751f\u7684\u6642\u9593\uff09\u3002\u60a8\u53ef\u4ee5\u8a8d\u70ba\u6bcf\u500b\u7d44\u90fd\u7531\u4e00\u500b\u55ae\u7368\u7684\u7dda\u7a0b\u4e26\u884c\u57f7\u884c\u3002\u7d44\u5167\u7684\u898f\u5247\u90fd\u6309\u9806\u5e8f\u9032\u884c\u8a55\u4f30\u3002 \u5c0d\u65bc\u6bcf\u500b\u8b66\u5831\u898f\u5247\uff0c\u60a8\u5b9a\u7fa9\u4e00\u500b\u540d\u7a31\uff08\u8b66\u5831\uff1afoo\uff09\u3001\u4e00\u500b PromQL \u8868\u9054\u5f0f\u3001\u6301\u7e8c\u6642\u9593\uff08\u4ee5\u904e\u6ffe\u5608\u96dc\u7684\u8b66\u5831\uff0c\u4f8b\u5982\uff1a30 \u79d2\uff09\uff0c\u4e26\u53ef\u9078\u5730\u6dfb\u52a0 Prometheus \u5c07\u5728\u8b66\u5831\u89f8\u767c\u6642\u9644\u52a0\u5230\u8b66\u5831\u7684\u6a19\u7c64\u6216\u8a3b\u91cb\uff1a \u6a19\u7c64\u53ef\u4ee5\u4f8b\u5982\u5305\u542b\u56b4\u91cd\u6027\u7d1a\u5225 \u8a3b\u91cb\u901a\u5e38\u5305\u62ec\u6458\u8981\u548c\u63cf\u8ff0\u3002 \u60a8\u53ef\u4ee5\u5728\u6a19\u7c64\u548c\u8a3b\u91cb\u4e2d\u4f7f\u7528\u8b8a\u91cf\uff08\u6a21\u677f\uff09 Alertmanager \u00b6 \u8207 Prometheus \u4e00\u6a23\uff0cAlertmanager \u662f\u90e8\u5206\u6709\u72c0\u614b\u7684\uff08\u5b58\u5132\u6536\u5230\u7684\u8b66\u5831\u548c\u975c\u9ed8\uff09\uff0c\u4f46\u4e5f\u90e8\u5206\u662f\u7121\u72c0\u614b\u7684\uff0c\u56e0\u70ba\u5b83\u4e5f\u662f\u4f7f\u7528\u6587\u4ef6\u914d\u7f6e\u7684\u3002 config.yml global : smtp_smarthost : smtp.example.org:587 route : receiver : 'default-receiver' group_wait : 30s group_interval : 5m repeat_interval : 4h group_by : [ cluster , alertname ] # Note: this root \"route\" node may not have any \"matchers\"! All incoming alerts must match the root routes : - receiver : 'database-pager' group_wait : 10s matchers : - service=~\"mysql|cassandra\" - receiver : 'frontend-pager' group_by : [ product , environment ] matchers : - team=\"frontend\" receivers : - name : 'default-receiver' email_configs : - send_resolved : true to : some.receiver@mail.com from : no-reply@host.com - name : 'database-pager' ... - name : 'frontend-pager' ... inhibit_rules : [ - <inhibit_rule> ... ] global \u8a2d\u7f6e\uff0c\u4f8b\u5982\u7279\u5b9a\u65bc\u63a5\u6536\u5668\u7684\u5168\u5c40\u503c\uff08\u7528\u65bc\u6d88\u9664\u914d\u7f6e\u503c\u7684\u5197\u9918\uff0c\u5426\u5247\u5fc5\u9808\u5c07\u5176\u8907\u88fd\u5230 config.yml \u6587\u4ef6\u4e2d\u7684\u4e0d\u540c\u4f4d\u7f6e\uff09 receivers \u914d\u7f6e\u63a5\u6536\u8005\uff08\u4f8b\u5982 SMTP \u670d\u52d9\u6216\u7db2\u7d61\u639b\u9264\uff09\u53ca\u5176\u6191\u64da route \uff1a\u8def\u7531\u662f\u905e\u6b78\u7684\u6578\u64da\u7d50\u69cb\uff0c\u5f9e\u800c\u5f62\u6210\u8def\u7531\u6a39\u3002\u57fa\u672c\u601d\u60f3\u662f\u8b66\u5831\u6cbf\u8457\u8b66\u5831\u8def\u7531\u6a39\u904d\u6b77\uff0c\u57fa\u65bc\u5339\u914d\u6536\u5230\u8b66\u5831\u7684\u6a19\u7c64\u7684\u5339\u914d\u5668\u3002\u5982\u679c\u8b66\u5831\u4e0d\u5339\u914d\u8def\u7531\u7bc0\u9ede\u7684\u4efb\u4f55\u5b50\u7bc0\u9ede\uff08\u56e0\u70ba\u6c92\u6709\u5b50\u7bc0\u9ede\u7684\u5339\u914d\u5668\u5339\u914d\uff0c\u6216\u8005\u56e0\u70ba\u6c92\u6709\u5b50\u7bc0\u9ede\uff09\uff0c\u5247\u8b66\u5831\u7531\u7576\u524d\u7bc0\u9ede\u8655\u7406\u3002\u901a\u5e38\uff0c\u8def\u7531\u7bc0\u9ede\u5f9e\u5176\u7236\u7bc0\u9ede\u7e7c\u627f\u503c\u3002\u6bcf\u500b\u8def\u7531\u7bc0\u9ede\u90fd\u6709\u4ee5\u4e0b\u914d\u7f6e\u53c3\u6578\uff1a \u5339\u914d\u5668\uff1a\u53ea\u6709\u5177\u6709\u6307\u5b9a\u6a19\u7c64/\u503c\uff08\u6216\u503c\u7684\u6b63\u5247\u8868\u9054\u5f0f\uff09\u7684\u8b66\u5831\u624d\u6703\u7e7c\u7e8c\u6cbf\u8457\u6a39\u7684\u9019\u500b\u5206\u652f group_by\uff1a\u7528\u65bc\u5c0d\u8b66\u5831\u9032\u884c\u5206\u7d44\u7684\u6a19\u7c64\u9375\u5217\u8868\u3002 Alertmanager \u7136\u5f8c\u70ba\u6bcf\u500b\u6a19\u7c64\u503c\u5275\u5efa\u4e00\u500b\u7d44\u3002\u9019\u6a23\u53ef\u4ee5\u907f\u514d\u60a8\u7684\u958b\u767c\u4eba\u54e1/\u64cd\u4f5c\u54e1\u6536\u5230\u8b66\u5831\u901a\u77e5\u7684\u5783\u573e\u90f5\u4ef6\u3002 \u5404\u7a2e\u7b49\u5f85\u671f\u6216\u9593\u9694\uff0c\u4ee5\u6e1b\u5c11\u767c\u9001\u8b66\u5831\u901a\u77e5\u7684\u6578\u91cf receiver\uff1a\u61c9\u5411\u5176\u767c\u9001\u8b66\u5831\u901a\u77e5\u7684\u63a5\u6536\u8005\u7684\u540d\u7a31 routes\uff1a\u8def\u7dda\u5b50\u5c0d\u8c61\u7684\u6578\u7d44 inhibit_rules\uff1a\u7981\u6b62\u898f\u5247\u5c0d\u50cf\u6578\u7d44\u3002\u5141\u8a31\u975c\u97f3\u4e00\u7d44\u8b66\u5831\uff0c\u56e0\u70ba\u53e6\u4e00\u500b\u8b66\u5831\u5df2\u7d93\u89f8\u767c\u3002\u9019\u6e1b\u5c11\u4e86\u8b66\u5831\uff08\u901a\u77e5\uff09\u5783\u573e\u90f5\u4ef6\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u6aa2\u6e2c\u5230\u6574\u500b\u7bc0\u9ede\u5df2\u95dc\u9589\uff0c\u5247\u4e0d\u9700\u8981\u70ba\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c\u7684 10 \u500b\u670d\u52d9\uff08\u56e0\u6b64\u4e5f\u5df2\u95dc\u9589\uff09\u518d\u767c\u9001 10 \u500b\u8b66\u5831\u901a\u77e5\u3002 Grafana \u00b6 Grafana \u4e0d\u5b58\u5132\u4efb\u4f55\u6307\u6a19\u6578\u64da\uff0c\u4f46\u7e3d\u662f\u5728\u904b\u884c\u6642\u5f9e Prometheus \u6aa2\u7d22\u5b83\u3002\u7136\u800c\uff0cGrafana \u7684\u914d\u7f6e\uff08\u4f8b\u5982\u6578\u64da\u6e90\u3001\u7528\u6236\u548c\u8eab\u4efd\u9a57\u8b49\u6216\u5100\u8868\u677f\uff09\u662f\u6709\u72c0\u614b\u5730\u5b58\u5132\u5728 Grafana \u7684\u5167\u90e8\u6578\u64da\u5eab\u4e2d\u3002\u5b83\u5011\u53ef\u4ee5\u901a\u904e Grafana \u7684 REST API \u6216\u5176 Web \u754c\u9762\u9032\u884c\u64cd\u4f5c\u3002\u4f46\u662f\uff0cGrafana \u4e5f\u6709\u4e00\u500b\u914d\u7f6e\u6a5f\u5236\uff0c\u5141\u8a31\u60a8\u5728 Grafana \u555f\u52d5\u6642\u4ee5\u53ca\u5b9a\u671f\uff08\u6bcf\u7576 Grafana \u6aa2\u6e2c\u5230\u6587\u4ef6\u5167\u5bb9\u9aee\u751f\u66f4\u6539\u6642\uff09\u901a\u904e\u6587\u4ef6\u8986\u84cb\u5167\u90e8\u5b58\u5132\u7684\u914d\u7f6e\u3002 Exporters \u00b6 \u56e0\u70ba Prometheus \u671f\u671b Exporter \u50c5\u5728\u6293\u53d6\u6642\u516c\u958b\u61c9\u7528\u7a0b\u5e8f\u7684\u6307\u6a19\u6578\u64da\uff08\u63db\u53e5\u8a71\u8aaa\uff0cPrometheus \u4e0d\u671f\u671b\u6b77\u53f2\u6307\u6a19\u6578\u64da\uff09\uff0c\u6240\u4ee5 Exporter \u901a\u5e38\u662f\u5b8c\u5168\u7121\u72c0\u614b\u7684\u3002 \u914d\u7f6e\u65b9\u6cd5\u9ad8\u5ea6\u4f9d\u8cf4\u65bc\u61c9\u7528\u7a0b\u5e8f\u548c Exporter\u3002\u4e00\u4e9b Exporter \u4e0d\u9700\u8981\u4efb\u4f55\u914d\u7f6e\uff0c\u4f46\u6700\u5178\u578b\u7684\u662f\uff0c\u7121\u72c0\u614b CLI \u53c3\u6578\u548c/\u6216\u74b0\u5883\u8b8a\u91cf\u7528\u65bc\u914d\u7f6e Exporter\u3002 \u62c9\u5f0f\u76e3\u63a7\u67b6\u69cb\u7684\u6ce8\u610f\u4e8b\u9805 \u00b6 Prometheus \u4f7f\u7528\u57fa\u65bc\u62c9\u53d6\u7684\u65b9\u6cd5\uff0c\u5176\u4e2d Prometheus \u670d\u52d9\u5668\u5f9e\u7aef\u9ede\u6536\u96c6/\u62c9\u53d6\u6307\u6a19\uff0cPrometheus \u5fc5\u9808\u901a\u904e\u975c\u614b\u548c\u52d5\u614b\u670d\u52d9\u767c\u73fe\u4f86\u78ba\u5b9a\u54ea\u4e9b\u5217\u8868\u3002\u5176\u4ed6\u7cfb\u7d71\uff0c\u4f8b\u5982 Graphite\uff0c\u5247\u4f7f\u7528\u57fa\u65bc\u63a8\u9001\u7684\u65b9\u6cd5\uff0c\u5176\u4e2d\u4ee3\u7406\u9700\u8981\u4e86\u89e3\u6536\u96c6\u5668\uff0c\u4e26\u5c07\u5ea6\u91cf\u6578\u64da\u63a8\u9001\u7d66\u5b83\u3002 \u5982\u679c\u60a8\u641c\u7d22\u201c\u63a8\u9001\u8207\u62c9\u53d6\u76e3\u63a7\u201d\uff0c\u60a8\u6703\u767c\u73fe\u95dc\u65bc\u54ea\u500b\u201c\u66f4\u597d\u201d\u7684\u770b\u6cd5\u622a\u7136\u4e0d\u540c\u3002\u9019\u4e9b\u6587\u7ae0\u4e2d\u7684\u5927\u591a\u6578\u90fd\u662f\u7531\u5de5\u5177\u88fd\u9020\u5546\u64b0\u5beb\u7684\uff0c\u7136\u5f8c\u4ed6\u5011\u8b49\u660e\u4e86\u70ba\u4ec0\u9ebc\u4ed6\u5011\u7684\u65b9\u6cd5\u662f\u201c\u7565\u52dd\u4e00\u7c4c\u201d\u7684\u65b9\u6cd5\uff0c\u56e0\u70ba\u4ed6\u5011\u61c9\u7528\u4e86\u4e00\u4e9b\u512a\u5316\uff0c\u6216\u8005\u56e0\u70ba\u4ed6\u5011\u80fd\u5920\u63ed\u7a7f\u4e00\u4e9b\u95dc\u65bc\u4ed6\u5011\u7684\u65b9\u6cd5\u4e0d\u597d\u7684\u795e\u8a71\uff0c\u7b49\u7b49\u3002\u6700\u5f8c\uff0c\u57fa\u65bc\u63a8\u548c\u62c9\u7684\u7cfb\u7d71\u90fd\u6709\u7f3a\u9ede\uff0c\u4f46\uff08\u7f3a\u9ede\uff09\u7684\u56b4\u91cd\u7a0b\u5ea6\u53d6\u6c7a\u65bc\u60a8\u7684\u5177\u9ad4\u7528\u4f8b\u3002 \u5c0d\u65bc\u4efb\u4f55\u76e3\u63a7\u7cfb\u7d71\uff0c\u60a8\u90fd\u9700\u8981\u8655\u7406\u4ee5\u4e0b\u8a73\u7d30\u4fe1\u606f\uff1a \u5ef6\u9072\uff1a\u201c\u5df2\u77e5\u5ea6\u91cf\u6578\u64da\u9ede\u201d\u548c\u201c\u76e3\u63a7\u7cfb\u7d71\u5df2\u8655\u7406\u5b83\u201d\u4e4b\u9593\u7684\u5ef6\u9072\u3002\u4e00\u4e9b\u4f5c\u8005\u8a8d\u70ba\u57fa\u65bc\u63a8\u9001\u7684\u7cfb\u7d71\u63d0\u4f9b\u66f4\u4f4e\u7684\u5ef6\u9072\uff0c\u56e0\u6b64\u512a\u65bc\u57fa\u65bc\u62c9\u53d6\u7684\u7cfb\u7d71\u3002\u4ed6\u5011\u5f88\u5bb9\u6613\u5fd8\u8a18\u63d0\u5230\u7bc0\u7701\u9019\u5e7e\u79d2\u9418\u5728\u5be6\u8e10\u4e2d\u662f\u7121\u95dc\u7dca\u8981\u7684\uff0c\u56e0\u70ba\uff1a \u60a8\u7684\u5718\u968a\u5c07\u82b1\u8cbb\u5e7e\u5206\u9418\u751a\u81f3\u5e7e\u5c0f\u6642\u4f86\u5be6\u969b\u8a3a\u65b7\u548c\u89e3\u6c7a\u554f\u984c\uff0c \u60a8\u901a\u5e38\u5728\u670d\u52d9\u5668/\u6536\u96c6\u5668\u4e0a\u61c9\u7528\u7a4d\u6975\u7684\u6ed1\u52d5\u7a97\u53e3\u5e73\u5747\uff08\u4ee5\u6d88\u9664\u7570\u5e38\u503c\u548c\u8aa4\u5831\uff09\uff0c\u7a97\u53e3\u5927\u5c0f\u9060\u5927\u65bc\u4f7f\u7528\u57fa\u65bc\u63a8\u9001\u7684\u7cfb\u7d71\u6e1b\u5c11\u7684\u5ef6\u9072\u3002 \u767c\u73fe\uff1a\u8b93\u4ee3\u7406\u5be6\u4f8b\u4e86\u89e3\u6536\u96c6\u5668/\u670d\u52d9\u5668\u5be6\u4f8b\uff08\u53cd\u4e4b\u4ea6\u7136\uff09\u7e3d\u662f\u6d89\u53ca\u5fa9\u96dc\u6027\u3002\u5929\u4e0b\u6c92\u6709\u514d\u8cbb\u7684\u5348\u9910\u2026 \u5b89\u5168\u6027\uff1a\u6613\u65bc\u5be6\u65bd\u6a5f\u5236\uff08\u53ca\u5176\u5b89\u5168\u7a0b\u5ea6\uff09\uff0c\u78ba\u4fdd\u6c92\u6709\u672a\u7d93\u6388\u6b0a\u7684\u4e00\u65b9\u53ef\u4ee5\u8a2a\u554f\uff08\u4ee3\u7406\u6216\u6536\u96c6\u5668\u7684\uff09\u6307\u6a19\u6578\u64da \u53ef\u64f4\u5c55\u6027\uff1a\u4e00\u65e6\u4f60\u6709\u8a31\u591a\u4ee3\u7406\u7522\u751f\u5927\u91cf\u6578\u64da\uff0c\u9019\u5169\u7a2e\u65b9\u6cd5\u90fd\u4e0d\u80fd\u5f88\u597d\u5730\u5de5\u4f5c\uff0c\u53ea\u4f7f\u7528\u4e00\u500b\u6536\u96c6\u5668\u670d\u52d9\u5668\u3002\u5927\u591a\u6578\u5be6\u73fe\u90fd\u6709\u7528\u65bc\u64f4\u5c55\u7684\u89e3\u6c7a\u65b9\u6848\u3002\u6709\u95dc Prometheus \u7684\u64f4\u5c55\u65b9\u6cd5\uff0c\u8acb\u53c3\u898b\u4e0b\u6587\u3002 \u7dad\u904b\u8907\u96dc\u5ea6\uff1a\u6d89\u53ca\u9632\u706b\u7246\u914d\u7f6e\uff0c\u4ee5\u53ca\u66f4\u6539\u6574\u500b\u76e3\u63a7\u7cfb\u7d71\u914d\u7f6e\u7684\u96e3\u6613\u7a0b\u5ea6 \u5728\u5be6\u8e10\u4e2d\uff0c\u60a8\u53ef\u80fd\u6703\u4f7f\u7528\u4efb\u4f55\u4e00\u7a2e\u65b9\u6cd5\u90fd\u505a\u5f97\u5f88\u597d\u3002\u5f9e\u67b6\u69cb\u4e0a\u8b1b\uff0c\u60a8\u53ef\u4ee5\u6df7\u5408\u548c\u5339\u914d\u62c9\u5f0f\u8207\u57fa\u65bc\u63a8\u5f0f\u7684\u65b9\u6cd5\u3002\u4f8b\u5982\uff0cPushgateway \u6b63\u5728\u5c07\u63a8\u9001\u8f49\u63db\u70ba\u62c9\u53d6\uff0c\u800c Telegraf \u7b49\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u5c07\u62c9\u53d6\u8f49\u63db\u70ba\u63a8\u9001\u3002 Prometheus \u7684\u57fa\u65bc\u62c9\u7684\u65b9\u6cd5\u78ba\u5be6\u6709\u5169\u500b\u7f3a\u9ede\uff08\u7dad\u904b\u8907\u96dc\u5ea6\uff09\uff0c\u6211\u60f3\u89e3\u6c7a\u9019\u4e9b\u7f3a\u9ede\uff1a \u76e3\u63a7\u591a\u9032\u7a0b\u61c9\u7528\u7a0b\u5e8f\uff1a\u5982\u679c\u60a8\u4f7f\u7528\u591a\u500b\u9032\u7a0b\uff0c\u5247\u5f9e\u61c9\u7528\u7a0b\u5e8f\u7684 /metrics \u7aef\u9ede\u63d0\u53d6\u6307\u6a19\u5177\u6709\u6311\u6230\u6027\u3002\u539f\u56e0\u662f\u6307\u6a19\u6578\u64da\u901a\u5e38\u53ea\u4fdd\u5b58\u5728\u5167\u5b58\u4e2d\uff0c\u5206\u5225\u91dd\u5c0d\u6bcf\u500b\u9032\u7a0b\uff0c\u4e26\u4e14\u4e0d\u6e05\u695a\u60a8\u7684\u54ea\u4e9b\u9032\u7a0b\u5be6\u969b\u4e0a\u70ba /metrics \u7aef\u9ede\u63d0\u4f9b\u670d\u52d9\uff0c\u4ee5\u53ca\u6307\u6a19\u6578\u64da\u662f\u5982\u4f55\u7d2f\u7a4d\u7684\u3002\u5047\u8a2d\u60a8\u6b63\u5728\u69cb\u5efa\u4e00\u500b Python Web \u61c9\u7528\u7a0b\u5e8f\uff08\u4f8b\u5982\uff0c\u4f7f\u7528 Django \u6216 Flask\uff09\u4e26\u4f7f\u7528 WSGI \u61c9\u7528\u7a0b\u5e8f\u670d\u52d9\u5668\u4f86\u5be6\u73fe\u53ef\u4f38\u7e2e\u6027\uff0c\u4f8b\u5982 Gunicorn \u6216 uWSGI\uff0c\u5b83\u5011\u904b\u884c\u591a\u500b\u5de5\u4f5c\u9032\u7a0b\uff1a \u89e3\u6c7a\u65b9\u6848 #1 \uff1a\u8b93\u6bcf\u500b\u9032\u7a0b\u6536\u96c6\u81ea\u5df1\u7684\u6307\u6a19\uff0c\u6bcf\u7576\u8abf\u7528 /metrics \u6642\uff0cPrometheus \u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u4e00\u4e9b\u9032\u7a0b\u9593\u901a\u4fe1\u4f86\u6536\u96c6\u4f86\u81ea\u6240\u6709\u9032\u7a0b\u7684\u805a\u5408\u6307\u6a19\uff08\u4f8b\u5982\uff0c\u4f7f\u7528\u5f15\u64ce\u84cb\u4e0b\u7684\u6587\u4ef6\uff09\u3002\u6709\u95dc\u5be6\u73fe\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 Prometheus \u7684 Python \u5eab\u7684\u591a\u9032\u7a0b\u6a21\u5f0f\u3002 \u89e3\u6c7a\u65b9\u6848 #2 \uff1a\u5c07\u6bcf\u500b\u5de5\u4f5c\u9032\u7a0b\u8996\u70ba\u4e00\u500b\u55ae\u7368\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5373\u6bcf\u500b\u5de5\u4f5c\u9032\u7a0b\u90fd\u88ab\u7a31\u70ba Prometheus \u7684\u55ae\u7368\u76ee\u6a19\uff0c\u6bcf\u500b\u5de5\u4f5c\u9032\u7a0b\u90fd\u6709\u81ea\u5df1\u7684 /metrics \u7aef\u9ede\uff0c\u4f8b\u5982\u5728\u4e0d\u540c\u7684\u7aef\u53e3\u4e0b\u3002\u6307\u6a19\u7684\u805a\u5408\u5728\u67e5\u8a62\u6642\u5728\u670d\u52d9\u5668\u4e0a\u7684 PromQL \u4e2d\u5ef6\u9072\u548c\u57f7\u884c\u3002\u6709\u95dc\u793a\u4f8b\uff0c\u8acb\u53c3\u898b\u6b64\u8655\u3002 \u89e3\u6c7a\u65b9\u6848 #3 \uff1a\u8b93\u5de5\u4f5c\u4eba\u54e1\u5c07\u6307\u6a19\u63a8\u9001\u5230\u805a\u5408\u5668\uff08\u4f8b\u5982 Pushgateway \u6216 statsd\uff09\uff0cPrometheus \u5f9e\u4e2d\u63d0\u53d6\u805a\u5408\u7684\u6307\u6a19\u3002\u53c3\u898b\u4f8b\u5982\u9019\u88e1\u3002 \u76e3\u63a7\u77ed\u66ab\u7684\u9032\u7a0b\uff1a\u9032\u7a0b\uff08\u4f8b\u5982\u5099\u4efd\u8173\u672c\uff09\u7684\u5b58\u6d3b\u6642\u9593\u53ef\u80fd\u4e0d\u5920\u9577\uff0c\u7121\u6cd5\u70ba\u6307\u6a19\u6293\u53d6\u63d0\u4f9b\u670d\u52d9\u3002\u5728\u9019\u88e1\uff0c\u53ea\u6709\u57fa\u65bc\u63a8\u9001\u7684\u65b9\u6cd5\u624d\u6709\u610f\u7fa9\u3002\u89e3\u6c7a\u65b9\u6848\u662f\u6df7\u5408\u57fa\u65bc\u63a8\u548c\u62c9\u7684\u65b9\u6cd5\uff0c\u4e26\u4f7f\u7528\u985e\u4f3c\u63a8\u9001\u7db2\u95dc\u7684\u6771\u897f\uff08\u53c3\u898b\u4e0a\u9762\u7684\u89e3\u6c7a\u65b9\u6848\u65b9\u6cd5 #3 \uff09\u3002 \u7d50\u8ad6 \u00b6 Prometheus \u5806\u68e7\u662f\u4e00\u500b\u8907\u96dc\u7684\u7cfb\u7d71\u3002\u5728\u6211\u770b\u4f86\uff0c\u5c07\u5806\u68e7\u5206\u6210\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\uff08\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u90fd\u6709\u4e00\u500b\u55ae\u7368\u7684\u95dc\u6ce8\u9ede\uff09\u662f\u4e00\u7a2e\u5f88\u597d\u7684\u65b9\u6cd5\u3002\u60a8\u5c07\u5f88\u5feb\u7fd2\u6163\u9019\u5f71\u97ff\u7d44\u4ef6\u914d\u7f6e\u7684\u65b9\u5f0f\uff0c\u4e86\u89e3\u914d\u7f6e\u7684\u54ea\u500b\u90e8\u5206\u5c6c\u65bc\u54ea\u500b\u6587\u4ef6\u3002\u60a8\u73fe\u5728\u64c1\u6709\u8a31\u591a\uff08\u8f03\u5c0f\u7684\uff09\u6587\u4ef6\uff08\u5b58\u5132\u5728\u7248\u672c\u63a7\u5236\u4e2d\uff09\u9019\u4e00\u4e8b\u5be6\u6709\u52a9\u65bc\u66f4\u5927\u7684\u5718\u968a\u6839\u64da\u8ab0\u914d\u7f6e\u4ec0\u9ebc\u4f86\u5283\u5206\u8077\u8cac\u3002","title":"Part 2. Prometheus, Alertmanager & Grafana \u67b6\u69cb\u4ecb\u8a54"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#prometheus-alertmanager-grafana","text":"\u539f\u6587: Kubernetes Observability \u2013 Part II: architecture introduction to Prometheus, Alertmanager & Grafana \u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86 Prometheus \u5806\u68e7\u7684\u67b6\u69cb\uff0c\u7531\u5404\u500b\u61c9\u7528\u7a0b\u5e8f Prometheus\u3001Alertmanager\u3001Grafana\u3001Pushgateway \u548c\u5404\u7a2e Exporter \u7d44\u6210\u3002\u672c\u6587\u6703\u8a0e\u8ad6\u4e86\u6bcf\u500b\u7d44\u4ef6\u662f\u5982\u4f55\u914d\u7f6e\u7684\uff0c\u5b83\u5b58\u5132\u4e86\u54ea\u7a2e\u6578\u64da\uff0c\u4ee5\u53ca\u5982\u4f55\u64f4\u5c55 Prometheus\u3002","title":"Prometheus, Alertmanager &amp; Grafana \u67b6\u69cb\u4ecb\u8a54"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#prometheus","text":"Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c\u53ef\u89c0\u5bdf\u6027\u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u7b2c\u4e00\u6b65\uff08\u5728\u6280\u8853\u8ecc\u9053\u4e0a\uff09\u662f\u4e86\u89e3\u6b64\u5806\u68e7\u7684\u67b6\u69cb\uff0c\u4ee5\u53ca\u4e0d\u540c\u5de5\u5177\u5982\u4f55\u7d44\u5408\u5728\u4e00\u8d77\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86\u67b6\u69cb\uff0c\u89e3\u91cb\u4e86\u5176\u80cc\u5f8c\u7684\u57fa\u672c\u539f\u7406\uff0c\u5982\u4f55\u914d\u7f6e\u5404\u500b\u7d44\u4ef6\uff0c\u9084\u89e3\u91cb\u4e86 Prometheus \u5982\u4f55\u64f4\u5c55\u3002","title":"Prometheus \u7c21\u4ecb"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#high-level","text":"Prometheus \u5806\u68e7\u7531\u8a31\u591a\u7368\u7acb\u7684\u7a0b\u5e8f/\u61c9\u7528\u7a0b\u5e8f\u7d44\u6210\uff0c\u5b83\u5011\u90fd\u6709\u5c08\u9580\u7684\u8077\u8cac\u3002\u5b83\u5011\u90fd\u901a\u904e HTTP \u76f8\u4e92\u901a\u4fe1\u4ee5\u5be6\u73fe\u5b83\u5011\u7684\u7e3d\u9ad4\u76ee\u6a19\uff1a\uff08\u53ef\u80fd\u662f\u5927\u898f\u6a21\u7684\uff09\u5206\u4f48\u5f0f\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002 Prometheus \u80cc\u5f8c\u7684\u5718\u968a\u9078\u64c7\u4e86\u9019\u7a2e\u95dc\u6ce8\u9ede\u5206\u96e2\u7684\u65b9\u6cd5\uff0c\u4ee5\u4fbf\u6bcf\u500b\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u55ae\u7368\u914d\u7f6e\u548c\u90e8\u7f72\uff08\u5982\u679c\u9700\u8981\uff0c\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u6a5f\u5668\u4e0a\uff09\u3002\u5b83\u9084\u964d\u4f4e\u4e86\u6bcf\u500b\u55ae\u7368\u7a0b\u5e8f\u7684\u8907\u96dc\u6027\u3002\u5148\u770b\u4e00\u4e0b \u5b98\u65b9\u6587\u6a94\u7684 Prometheus \u67b6\u69cb\u5716 \uff1a \u6211\u5011\u7684\u6838\u5fc3\u662f Prometheus \u670d\u52d9\u5668\uff0c\u5b83\u6709\u5e7e\u500b\u5b50\u7cfb\u7d71\uff0c\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f TSDB\u3001\u6aa2\u7d22\u7d44\u4ef6\u548c HTTP \u670d\u52d9\u5668\u3002 TSDB \u662f\u4e00\u500b\u6301\u4e45\u7684\u3001\u57fa\u65bc\u78c1\u76e4\u7684\u6642\u5e8f\u6578\u64da\u5eab\u3002\u6aa2\u7d22\u7d44\u4ef6\u5b9a\u671f\u5f9e\u516c\u958b\u9019\u4e9b\u6307\u6a19\uff08\u901a\u904e HTTP\uff09\u7684\u5176\u4ed6\u61c9\u7528\u7a0b\u5e8f\u4e2d\u63d0\u53d6\u201c\u6307\u6a19\u6578\u64da\u201d\uff0c\u4f8b\u5982\u6bcf 15 \u79d2\uff0c\u4e26\u5c07\u5b83\u5011\u5b58\u5132\u5728 TSDB \u4e2d\u3002\u9019\u7a2e\u6709\u898f\u5f8b\u7684\u62c9\u52d5\u4e5f\u7a31\u70ba\u201c \u522e\u53d6(scrape) \u201d\u3002 Prometheus HTTP \u670d\u52d9\u5668\u63d0\u4f9b\u4e86\u4e00\u500b REST \u7aef\u9ede\uff0c\u5141\u8a31\u5176\u4ed6\u7cfb\u7d71\uff08\u4f8b\u5982 Grafana\uff09\u67e5\u8a62\u5b58\u5132\u7684\u6307\u6a19\u6578\u64da\u3002 \u4ec0\u9ebc\u662f\u6307\u6a19 (Metrics) \u4e00\u822c\u800c\u8a00\uff0c\u6307\u6a19\u662f\u63d0\u4f9b\u6709\u95dc\u7279\u5b9a\u670d\u52d9\uff08\u4f8b\u5982\u9032\u7a0b\uff09\u6216\u7cfb\u7d71\uff08\u4f8b\u5982\u670d\u52d9\u5668\u7bc0\u9ede\uff09\u7684\u4fe1\u606f\u7684\u6578\u5b57\u6578\u64da\u3002\u4e00\u500b\u5177\u9ad4\u7684\u4f8b\u5b50\u53ef\u4ee5\u662f\u7bc0\u9ede\u7684\u78c1\u76e4\u4f7f\u7528\u91cf\uff0c\u6216\u8005\u5c0d HTTP \u670d\u52d9\u5668\uff08\u6216\u7279\u5b9a HTTP \u8def\u5f91\uff09\u7684\u8acb\u6c42\u7e3d\u6578\u3002\u6307\u6a19\u6a19\u6e96\u5b58\u5132\u5728 TSDB \u4e2d\uff0c\u53ef\u4ee5\u6709\u6548\u5730\u58d3\u7e2e\u3001\u8655\u7406\u548c\u6aa2\u7d22\u5b83\u5011\u3002 \u5728 Prometheus \u4e2d\uff0c\u6307\u6a19\u7684\u683c\u5f0f\u5f88\u7c21\u55ae\uff1a <name>{label1=value1,label2=value2,...} <float64 value> \u4e00\u500b\u5177\u9ad4\u7684\u4f8b\u5b50\uff1a prometheus_target_metadata_cache_bytes{scrape_job=\"alertmanager\"} 5672 \u5728 Prometheus \u4e2d\uff0c\u6307\u6a19\u662f\u7531 Exporter \u7b49\u61c9\u7528\u7a0b\u5e8f\u5275\u5efa\u7684\uff08\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u898b\u4e0b\u6587\uff09\u3002\u6307\u6a19\u901a\u904e HTTP \u4ee5\u7d14\u6587\u672c\u5f62\u5f0f\u516c\u958b\uff0c\u901a\u5e38\u5728 /metric \u7aef\u9ede\u4e0a\uff0c\u6bcf\u884c\u4e00\u500b\u6307\u6a19\u3002\u5982\u60a8\u6240\u898b\uff0c\u8f38\u51fa\u4e2d\u6c92\u6709\u6642\u9593\u6233\uff0c\u56e0\u70ba Prometheus \u671f\u671b\u8fd4\u56de\u7684\u6307\u6a19\u53cd\u6620\u7576\u524d\u72c0\u614b\uff0c\u800c Prometheus \u5728\u5c07\u6293\u53d6\u7684\u6578\u64da\u5b58\u5132\u5230\u5176 TSDB \u6642\u6703\u6dfb\u52a0\u6642\u9593\u6233\u3002 \u6307\u6a19\u5f9e\u4f55\u800c\u4f86\uff1f\u516c\u958b\u66b4\u9732\u6307\u6a19\u7684\u61c9\u7528\u7a0b\u5e8f\u6709\u5169\u7a2e\u57fa\u672c\u985e\u578b\uff1a Your own application \uff0c\u60a8\u70ba\u6b64\u5be6\u65bd\u4e86\u4e00\u500b\u63d0\u4f9b\u9019\u4e9b\u6307\u6a19\u7684 /metrics HTTP \u7aef\u9ede\u3002 Prometheus \u793e\u5340\u70ba\u6240\u6709\u5e38\u898b\u7684\u7de8\u7a0b\u8a9e\u8a00\u69cb\u5efa\u4e86\u7c21\u5316\u6b64\u4efb\u52d9\u7684 SDK\u3002 A third-party exporter \u3002\u5c0e\u51fa\u5668(exporter)\u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5b83\u4f7f\u7528\u8a72\u7cfb\u7d71\u7684\u5c08\u6709 API \u5f9e\u7b2c\u4e09\u65b9\u7cfb\u7d71\uff08\u4f8b\u5982\u6578\u64da\u5eab\u670d\u52d9\u5668\u6216\u4e3b\u6a5f\u7684\u64cd\u4f5c\u7cfb\u7d71\u5167\u6838\uff09\u4e2d\u6293\u53d6\u6307\u6a19\uff0c\u4e26\u5c07\u7372\u5f97\u7684\u6307\u6a19\u8f49\u63db\u70ba Prometheus \u6307\u6a19\u683c\u5f0f\uff0c\u4e26\u5c07\u5b83\u5011\u66b4\u9732\u5728 /metrics \u7aef\u9ede\u3002\u7b2c\u4e09\u65b9\u7cfb\u7d71\u672c\u8eab\u4e26\u4e0d\u77e5\u9053\u5b83\u6b63\u5728\u88ab\u89c0\u5bdf\u3002\u6709\u6578\u767e\u500b\u5373\u7528\u578b exporter\uff0c\u8acb\u53c3\u898b \u6b64\u8655 \u548c \u6b64\u8655 \uff01\u6700\u8457\u540d\u7684\u662f \u7bc0\u9ede\u5c0e\u51fa\u5668(node exporter) \uff0c\u5b83\u5f9e\u8a08\u7b97\u7bc0\u9ede\u4e2d\u63d0\u53d6\u6307\u6a19\uff0c\u4f8b\u5982\u5167\u5b58\u3001\u5b58\u5132\u3001\u7db2\u7d61\u548c CPU \u7684\u4f7f\u7528\u60c5\u6cc1\u3002\u53e6\u4e00\u500b\u91cd\u8981\u7684\u662f cAdvisor \uff0c\u5b83\u5c0e\u51fa\u4e86\u904b\u884c Docker \u5bb9\u5668\u7684\u8cc7\u6e90\u4f7f\u7528\u60c5\u6cc1\u548c\u6027\u80fd\u7279\u5fb5\u3002 \u56de\u5230\u201c \u522e\u53d6(scrape) \u201d\u7684\u8a2d\u8a08\u3002\u5728\u6bcf\u500b\u6293\u53d6\u5faa\u74b0\u7d50\u675f\u6642\uff0cPrometheus \u6703\u6839\u64da\u76ee\u524d\u5b58\u5132\u7684\u6307\u6a19\u8a55\u4f30\u8b66\u5831\u898f\u5247\u3002\u60a8\u4f7f\u7528 Prometheus \u7684\u67e5\u8a62\u8a9e\u8a00 PromQL \u7de8\u5beb\u9019\u4e9b\u8b66\u5831\u898f\u5247\u3002\u8b66\u5831\u898f\u5247\u7684\u793a\u4f8b\u53ef\u80fd\u662f\u201c\u4efb\u4f55\u7bc0\u9ede\u4e0a\u7684\u4efb\u4f55\u78c1\u76e4\u7684\u78c1\u76e4\u4f7f\u7528\u7387\u5df2\u8d85\u904e 90%\u201d\u3002\u5982\u679c\u89f8\u767c\u4e86\u4efb\u4f55\u914d\u7f6e\u7684\u8b66\u5831\u898f\u5247\uff0cPrometheus \u6703\u751f\u6210\u8b66\u5831\u4e26\u5c07\u5176\u63a8\u9001\u5230 Alertmanager \u61c9\u7528\u7a0b\u5e8f\u3002 \u8acb\u6ce8\u610f\uff0c\u8b66\u5831\u53ea\u662f\u4e00\u500b (JSON) \u5c0d\u8c61\uff0c\u5c1a\u672a\u767c\u9001\u4efb\u4f55\u96fb\u5b50\u90f5\u4ef6\u3001\u5c0b\u547c\u6a5f\u6d88\u606f\u7b49\uff01\u7576 Alertmanager \u6536\u5230\u8b66\u5831\u6642\uff0c\u5b83\u6703\u5c07\u5176\u5b58\u5132\u5728\u5176\u5167\u90e8\u6578\u64da\u5eab\u4e2d\u3002 Alertmanager \u4f7f\u7528\u60a8\u63d0\u4f9b\u7684\u914d\u7f6e\u5c0d\u8b66\u5831\u9032\u884c\u91cd\u8907\u6578\u64da\u522a\u9664\u548c\u5206\u7d44\uff08\u4ee5\u6e1b\u5c11\u5783\u573e\u90f5\u4ef6\uff09\u3002\u7136\u5f8c\u5b83\u6703\u751f\u6210\u8b66\u5831\u901a\u77e5\uff0c\u5373\u5c07\u8b66\u5831\u8def\u7531\u5230\u6b63\u78ba\u7684\u63a5\u6536\u8005\uff0c\u4f8b\u5982\u96fb\u5b50\u90f5\u4ef6\u6216 PagerDuty\u3002 \u67b6\u69cb\u5716\u4e2d\u9084\u6709\u5169\u500b\u65b9\u6846\u9700\u8981\u7279\u5225\u8aaa\u660e\uff1a Pushgateway \u548c short-lived jobs \uff1a\u5982\u679c\u60a8\u5e0c\u671b Prometheus \u6536\u96c6\u751f\u547d\u9031\u671f\u975e\u5e38\u77ed\uff08\u6bd4 Prometheus \u7684\u6293\u53d6\u9593\u9694\u77ed\uff09\u7684\u61c9\u7528\u7a0b\u5e8f\u6216\u4f5c\u696d\uff08\u4f8b\u5982 cron \u4f5c\u696d\uff09\u7684\u6307\u6a19\uff0c\u90a3\u9ebc\u60a8\u6703\u9047\u5230\u554f\u984c\uff1a\u7576 Prometheus \u5617\u8a66\u6293\u53d6\u61c9\u7528\u7a0b\u5e8f\uff08\u53ca\u5176 /metrics HTTP \u7aef\u9ede\uff09\u6642\uff0c\u5b83\u53ef\u80fd\u4e0d\u5b58\u5728\u3002\u70ba\u4e86\u898f\u907f\u9019\u500b\u554f\u984c\uff0c\u60a8\u53ef\u4ee5\u904b\u884c Pushgateway \u4e4b\u985e\u7684\u5de5\u5177\uff0c\u9019\u662f\u4e00\u500b\u6c38\u4e45\u904b\u884c\u7684\u6307\u6a19\u7de9\u5b58\uff0c\u77ed\u671f\u4f5c\u696d\u53ef\u4ee5\u5c07\u6307\u6a19\u63a8\u9001\u5230\u8a72\u7de9\u5b58\u3002\u7136\u5f8c\uff0cPrometheus \u5f9e Pushgateway \u7684 /metrics \u7aef\u9ede\u6293\u53d6\u9019\u4e9b\u7de9\u5b58\u7684\u6307\u6a19\u3002 Service discovery \uff1aPrometheus \u662f\u70ba\u76e3\u63a7\u5927\u578b\u6c34\u5e73\u64f4\u5c55\u5206\u4f48\u5f0f\u7cfb\u7d71\u800c\u69cb\u5efa\u7684\u3002\u5b83\u5011\u7531\u8a31\u591a\uff08\u8a08\u7b97\uff09\u7bc0\u9ede\u548c\u670d\u52d9\u5be6\u4f8b\u7d44\u6210\uff0c\u5b83\u5011\u4e00\u76f4\u4f86\u4f86\u53bb\u53bb\uff0c\u4f8b\u5982\u7531\u65bc\u5f48\u6027\u7e2e\u653e\u3002\u5c0d\u65bc\u9019\u6a23\u7684\u7cfb\u7d71\uff0c\u624b\u52d5\u914d\u7f6e Prometheus \u7684\u6aa2\u7d22\u7d44\u4ef6\u61c9\u8a72\u6293\u53d6\u7684\u4e3b\u6a5f/\u76ee\u6a19\u7684\u975c\u614b\u5217\u8868\u5c07\u662f\u4e00\u500b\u96e3\u4ee5\u7ba1\u7406\u7684\u8ca0\u64d4\u3002 Prometheus \u7684\u670d\u52d9\u767c\u73fe\uff08SD\uff09\u6a5f\u5236\u5be6\u73fe\u4e86\u4e00\u7a2e\u52d5\u614b\u767c\u73fe\u6a5f\u5236\uff0c\u5df2\u7d93\u6709\u5f88\u591a\u5177\u9ad4\u7684\u5be6\u73fe\uff0c\u53ef\u4ee5\u52d5\u614b\u767c\u73fe\u6293\u53d6\u76ee\u6a19\u3002\u4f8b\u5982\uff0cSD \u53ef\u4ee5\u6aa2\u6e2c Kubernetes \u6216 Consul \u4e2d\u7684\u670d\u52d9\u548c\u7bc0\u9ede\uff08\u6709\u95dc\u5be6\u73fe\u5217\u8868\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94\u4e2d\u7684 ..._sd_config \uff09\u3002 \u5b83\u61c9\u8a72\u53ef\u4ee5\u5e6b\u52a9\u60a8\u4e86\u89e3\u4e0d\u540c\u61c9\u7528\u7a0b\u5e8f\u7684\u5b50\u7d44\u4ef6\u3002\u8b93\u6211\u5011\u518d\u770b\u4e00\u4e0b\u6578\u64da\u6d41\uff1a Prometheus \u7684\u6aa2\u7d22\u7d44\u4ef6\u5b9a\u671f\u5f9e\u61c9\u7528\u7a0b\u5e8f\u3001\u5c0e\u51fa\u5668\u751a\u81f3 Prometheus \u81ea\u5df1\u5c0e\u51fa\u7684\u6307\u6a19\u63d0\u4f9b\u7684 /metric \u7aef\u9ede\u8f2a\u8a62\u6307\u6a19\u3002\u9019\u4e9b\u6307\u6a19\u5b58\u5132\u5728 Prometheus \u7684\uff08\u5d4c\u5165\u5f0f\uff09TSDB \u4e2d\uff0c\u7576\u524d\u7684\u6293\u53d6\u6642\u9593\u6233\u88ab\u6dfb\u52a0\u5230\u6578\u64da\u4e2d\u3002 \u6bcf\u7576 Prometheus \u7684 Alert \u898f\u5247\u8a55\u4f30\u5668\u7d44\u4ef6\u6aa2\u6e2c\u5230\u5176\u914d\u7f6e\u7684\u67d0\u4e9b\u8b66\u5831\u898f\u5247\u88ab\u89f8\u767c\uff08\u5b83\u901a\u904e\u67e5\u8a62 TSDB \u4f86\u78ba\u5b9a\uff09\u6642\uff0c\u5b83\u5c31\u6703\u751f\u6210\u4e00\u500b\u8b66\u5831\u5c0d\u8c61\u4e26\u5c07\u5176\u767c\u9001\u7d66 Alertmanager\u3002 Alertmanager \u5c07\u6536\u5230\u7684\u8b66\u5831\u5c0d\u8c61\u5b58\u5132\u5728\u5b83\u81ea\u5df1\u7684\uff08\u5d4c\u5165\u5f0f\uff09\u6578\u64da\u5eab\u4e2d\uff0c\u540c\u6642\u9032\u884c\u91cd\u8907\u6578\u64da\u522a\u9664\u3002 Alertmanager \u7684 Notification \u7ba1\u9053\u5b9a\u671f\u8a55\u4f30\u5b58\u5132\u5728\u6578\u64da\u5eab\u4e2d\u7684\u8b66\u5831\uff08\u6839\u64da\u914d\u7f6e\u7684\u8b66\u5831\u8def\u7531\u6a39\uff0c\u4e0b\u9762\u6709\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff09\uff0c\u4e26\u5728\u9069\u7528\u6642\u5411\u914d\u7f6e\u7684\u63a5\u6536\u5668\u767c\u9001\u8b66\u5831\u901a\u77e5\u3002 \u201c\u63a5\u6536\u8005\u201d\u4e0d\u662f\u6307\u201c\u4eba\u201d\uff0c\u800c\u662f\u5be6\u969b\u901a\u77e5\u4eba\u5011\u7684\u7cfb\u7d71\uff08\u96fb\u5b50\u90f5\u4ef6\u3001Slack \u7b49\uff09","title":"\u67b6\u69cb high-level \u6982\u8ff0"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#_1","text":"\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\uff08Prometheus\u3001Alertmanager\u3001Grafana\u3001Exporters\uff09\u90fd\u6709\u4e0d\u540c\u7684\u914d\u7f6e\u65b9\u6cd5\uff0c\u5982\u4e0b\u8868\u6240\u793a\uff1a Component Configuration approach Persisted stateful data Prometheus Stateless (files) Metrics Alertmanager Stateless (files) Alerts, silences Grafana Stateful + Stateless (provisioning mechanism) Grafana configuration Exporter Usually stateless (files), depends on exporter \u2014 \u6bcf\u4e00\u500b\u6b04\u5217\u7684\u542b\u7fa9\uff1a Configuration approach \uff1a\u7121\u72c0\u614b\u610f\u5473\u8457\u61c9\u7528\u7a0b\u5e8f\u4e0d\u6703\uff08\u6709\u72c0\u614b\u5730\uff09\u5728\u5167\u90e8\u5b58\u5132\u4efb\u4f55\u914d\u7f6e\u503c\uff0c\u4f8b\u5982\u5728\u6578\u64da\u5eab\u4e2d\u3002\u76f8\u53cd\uff0c\u914d\u7f6e\u901a\u5e38\u901a\u904e\u6587\u4ef6\u63d0\u4f9b\uff08\u4f8b\u5982\u683c\u5f0f\u5316\u70ba YAML \u6216 JSON\uff09\u3002\u9019\u4e9b\u6587\u4ef6\u61c9\u53d7\u7248\u672c\u63a7\u5236\uff0c\u4f8b\u5982\u5728 Git \u4e2d\u3002 \u7121\u72c0\u614b\u65b9\u6cd5\u7684\u512a\u9ede\u662f\uff1a \u60a8\u59cb\u7d42\u5728\u9019\u4e9b\u6587\u4ef6\u4e2d\u660e\u78ba\u66f4\u6539\u914d\u7f6e\uff08\u55ae\u4e00\u4e8b\u5be6\u4f86\u6e90\uff09 \u5c07\u61c9\u7528\u7a0b\u5e8f\u7684\u5be6\u4f8b\u5f9e\u4e00\u500b\u7bc0\u9ede\u79fb\u52d5\u5230\u53e6\u4e00\u500b\u7bc0\u9ede\u66f4\u5bb9\u6613\uff0c\u56e0\u70ba\u53ea\u9700\u8981\u639b\u8f09\u5e7e\u500b\u6587\u4ef6\uff08\u800c\u4e0d\u662f\u5fc5\u9808\u63d0\u53d6\u548c\u50b3\u8f38\u72c0\u614b\uff09 \u5c0d\u914d\u7f6e\u6240\u505a\u7684\u66f4\u6539\u662f\u53ef\u8ffd\u6eaf\u7684\uff08\u901a\u904e Git\uff09 \u914d\u7f6e\u6587\u4ef6\u662f\u4eba\u548c\u6a5f\u5668\u53ef\u8b80\u7684 \u7121\u72c0\u614b\u65b9\u6cd5\u7684\u7f3a\u9ede\u662f: \u60a8\u4e0d\u80fd\u52d5\u614b\u8abf\u6574\u914d\u7f6e\uff0c\u4f8b\u5982\u901a\u904e API \u8abf\u7528 \u8207 GUI \u76f8\u6bd4\uff0c\u901a\u904e\u6587\u672c\u66f4\u6539\u914d\u7f6e\u4e0d\u592a\u65b9\u4fbf\u4e14\u5bb9\u6613\u51fa\u932f Persisted stateful data \uff1a\u6307\u793a\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u6709\u5167\u90e8\uff08\u6709\u72c0\u614b\uff09\u6578\u64da\u5b58\u5132\uff0c\u5982\u679c\u6709\uff0c\u5176\u4e2d\u5b58\u5132\u4e86\u54ea\u7a2e\u6578\u64da\u3002 \u8b93\u6211\u5011\u66f4\u4ed4\u7d30\u5730\u4f86\u4e86\u89e3\u6bcf\u4e00\u500b\u5143\u4ef6\u3002","title":"\u914d\u7f6e"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#prometheus_1","text":"Prometheus \u5c0d\u65bc\u6536\u96c6\u7684\u6307\u6a19\uff08\u5b58\u5132\u5728 TSDB \u4e2d\uff09\u662f\u6709\u72c0\u614b\u7684\uff0c\u4f46\u5c0d\u65bc\u914d\u7f6e\u662f\u7121\u72c0\u614b\u7684\u3002\u56e0\u6b64\uff0c\u60a8\u7121\u6cd5\u901a\u904e Prometheus Web \u754c\u9762\u6216 API \u66f4\u6539\u914d\u7f6e\u3002\u4f46\u662f\uff0c\u6709\u7b2c\u4e09\u65b9\u9805\u76ee\uff0c\u4f8b\u5982 prometheus-configmanager \uff0c\u901a\u904e\u63d0\u4f9b\u914d\u7f6e API \u4f7f\u9019\u6210\u70ba\u53ef\u80fd\u3002 \u914d\u7f6e\u662f\u901a\u904e\u591a\u500b\u6587\u4ef6\u5b8c\u6210\u7684\uff0c\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff1a prometheus.yml global : scrape_interval : 15s evaluation_interval : 15s rule_files : - \"alert-rules.yml\" scrape_configs : - job_name : 'nodeexporter' scrape_interval : 5s static_configs : - targets : [ 'nodeexporter:9100' ] - job_name : 'cadvisor' scrape_interval : 5s static_configs : - targets : [ 'cadvisor:8080' ] - job_name : 'prometheus' scrape_interval : 10s static_configs : - targets : [ 'localhost:9090' ] alerting : alertmanagers : - scheme : http static_configs : - targets : - 'alertmanager:9093' global section: \u6307\u5b9a\u5168\u5c40\u914d\u7f6e\u53c3\u6578\uff0c\u4f8b\u5982\u6293\u53d6\u9593\u9694\u3002 rule_files section: \u6307\u5b9a\u8981\u8003\u616e\u7684\u8b66\u5831\u898f\u5247 yaml \u6587\u4ef6\u540d\u3002 scrape_configs section: \u6307\u5b9a\u6307\u6a19\u6293\u53d6\u4f5c\u696d\u7684\u5217\u8868\u3002\u6bcf\u500b\u4f5c\u696d\u90fd\u6709\u4e00\u500b\u540d\u7a31\uff08\u9019\u6a23 prometheus.yml \u4e2d\u7684 job_name: 'nodeexporter' \u4e4b\u985e\u7684\u6771\u897f\u6703\u5c0e\u81f4 Prometheus \u5728\u5c07\u6293\u53d6\u7684\u6307\u6a19\u5b58\u5132\u5728\u5176 TSDB \u4e2d\u6642\u6dfb\u52a0\u4e00\u500b\u6a19\u7c64\uff0c\u4f8b\u5982 job: 'nodeexporter'\uff09\u548c\u4e00\u500b\u6216\u591a\u500b\u76ee\u6a19IP\uff1a\u7aef\u53e3+\u8def\u5f91\u7684\u5f62\u5f0f\uff09\u3002 scrape_configs \u6578\u7d44\u4e2d\u7684\u5178\u578b\u689d\u76ee\u662f Prometheus \u670d\u52d9\u5668\u672c\u8eab\u3001Alertmanager\u3001cAdvisor\u3001nodeexporter\u3001Pushgateway \u548c\u5176\u4ed6\u81ea\u5b9a\u7fa9\u6307\u6a19 exporter\u3002\u5c0d\u65bc\u6bcf\u500b\u76ee\u6a19\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 static_config \uff08\u60a8\u53ea\u9700\u624b\u52d5\u63d0\u4f9b\u8981\u67e5\u8a62\u7684\u4e3b\u6a5f\u3001\u7aef\u53e3\u548c\u6307\u6a19 URL\uff09\uff0c\u6216\u4f7f\u7528\u52d5\u614b\u670d\u52d9\u767c\u73fe (service discovery) \u9078\u9805\u4e4b\u4e00\uff0c\u4f8b\u5982 kubernetes_sd_config \u6216 openstack_sd_config\u3002 alerting seciont: \u6307\u5b9a\u5411\u54ea\u500b Alertmanager \u5be6\u4f8b\u767c\u9001\u8b66\u5831\u3002 alert-rules.yml groups : - name : group1 rules : - alert : alert-name-1 expr : up == 0 for : 30s labels : # labels to attach to alerts severity : critical annotations : summary : \"Some monitoring-related service is non-operational\" description : \"Service {{ $labels.instance }} ({{ $labels.job }}) is down.\" - name : group2 rules : - alert : SomeHttpServicesAreDown expr : probe_success == 0 for : 10m labels : severity : critical annotations : summary : \"Some HTTP service is non-operational\" description : \"Service {{ $labels.instance }} ({{ $labels.job }}) is down.\" \u60a8\u53ef\u4ee5\u5728\u6b64\u8655\u5b9a\u7fa9\u8a18\u9304\u898f\u5247\u6216\u8b66\u5831\u898f\u5247\u3002 \u8a18\u9304\u898f\u5247\u5141\u8a31\u60a8\u9810\u5148\u8a08\u7b97\u60a8\u7d93\u5e38\u9700\u8981\u7684\u8a08\u7b97\u91cf\u5927\u7684\u6307\u6a19\u6578\u64da\uff08\u4f86\u81ea\u50b3\u5165\u7684\u539f\u59cb\u6307\u6a19\uff09\uff0c\u4e26\u5c07\u8a08\u7b97\u7d50\u679c\u4fdd\u5b58\u70ba\u4e00\u7d44\u65b0\u7684\u6307\u6a19\u3002\u9019\u5c0d\u65bc\u6bcf\u6b21\u5237\u65b0\u6642\u91cd\u8907\u67e5\u8a62\u76f8\u540c\uff08\u8a08\u7b97\u6210\u672c\u9ad8\uff09\u6307\u6a19\u6578\u64da\u7684\u5100\u8868\u677f\u8edf\u4ef6\uff08\u4f8b\u5982 Grafana\uff09\u5f88\u6709\u7528\u3002 \u8b66\u5831\u898f\u5247\u662f\u544a\u8a34 Prometheus \u4f55\u6642\u61c9\u8a72\u5411 Alertmanager \u767c\u9001\u8b66\u5831\u7684\u898f\u5247\u3002 alert-rules.yml \u6587\u4ef6\u4ee5 groups: \u90e8\u5206\u958b\u982d\uff0c\u60a8\u53ef\u4ee5\u5728\u5176\u4e2d\u6307\u5b9a\u4e00\u500b\u6216\u591a\u500b\u7d44\u3002\u5c0d\u65bc\u6bcf\u500b\u7d44\uff0c\u60a8\u5b9a\u7fa9\u4e00\u500b\u6216\u591a\u500b\u898f\u5247\u3002\u9664\u4e86\u9019\u4e9b\u898f\u5247\u4e4b\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u7d66\u6bcf\u500b\u7d44\u4e00\u500b\u540d\u7a31\u548c\u4e00\u500b\u53ef\u9078\u7684\u81ea\u5b9a\u7fa9\u9593\u9694\uff08\u8a55\u4f30\u767c\u751f\u7684\u6642\u9593\uff09\u3002\u60a8\u53ef\u4ee5\u8a8d\u70ba\u6bcf\u500b\u7d44\u90fd\u7531\u4e00\u500b\u55ae\u7368\u7684\u7dda\u7a0b\u4e26\u884c\u57f7\u884c\u3002\u7d44\u5167\u7684\u898f\u5247\u90fd\u6309\u9806\u5e8f\u9032\u884c\u8a55\u4f30\u3002 \u5c0d\u65bc\u6bcf\u500b\u8b66\u5831\u898f\u5247\uff0c\u60a8\u5b9a\u7fa9\u4e00\u500b\u540d\u7a31\uff08\u8b66\u5831\uff1afoo\uff09\u3001\u4e00\u500b PromQL \u8868\u9054\u5f0f\u3001\u6301\u7e8c\u6642\u9593\uff08\u4ee5\u904e\u6ffe\u5608\u96dc\u7684\u8b66\u5831\uff0c\u4f8b\u5982\uff1a30 \u79d2\uff09\uff0c\u4e26\u53ef\u9078\u5730\u6dfb\u52a0 Prometheus \u5c07\u5728\u8b66\u5831\u89f8\u767c\u6642\u9644\u52a0\u5230\u8b66\u5831\u7684\u6a19\u7c64\u6216\u8a3b\u91cb\uff1a \u6a19\u7c64\u53ef\u4ee5\u4f8b\u5982\u5305\u542b\u56b4\u91cd\u6027\u7d1a\u5225 \u8a3b\u91cb\u901a\u5e38\u5305\u62ec\u6458\u8981\u548c\u63cf\u8ff0\u3002 \u60a8\u53ef\u4ee5\u5728\u6a19\u7c64\u548c\u8a3b\u91cb\u4e2d\u4f7f\u7528\u8b8a\u91cf\uff08\u6a21\u677f\uff09","title":"Prometheus"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#alertmanager","text":"\u8207 Prometheus \u4e00\u6a23\uff0cAlertmanager \u662f\u90e8\u5206\u6709\u72c0\u614b\u7684\uff08\u5b58\u5132\u6536\u5230\u7684\u8b66\u5831\u548c\u975c\u9ed8\uff09\uff0c\u4f46\u4e5f\u90e8\u5206\u662f\u7121\u72c0\u614b\u7684\uff0c\u56e0\u70ba\u5b83\u4e5f\u662f\u4f7f\u7528\u6587\u4ef6\u914d\u7f6e\u7684\u3002 config.yml global : smtp_smarthost : smtp.example.org:587 route : receiver : 'default-receiver' group_wait : 30s group_interval : 5m repeat_interval : 4h group_by : [ cluster , alertname ] # Note: this root \"route\" node may not have any \"matchers\"! All incoming alerts must match the root routes : - receiver : 'database-pager' group_wait : 10s matchers : - service=~\"mysql|cassandra\" - receiver : 'frontend-pager' group_by : [ product , environment ] matchers : - team=\"frontend\" receivers : - name : 'default-receiver' email_configs : - send_resolved : true to : some.receiver@mail.com from : no-reply@host.com - name : 'database-pager' ... - name : 'frontend-pager' ... inhibit_rules : [ - <inhibit_rule> ... ] global \u8a2d\u7f6e\uff0c\u4f8b\u5982\u7279\u5b9a\u65bc\u63a5\u6536\u5668\u7684\u5168\u5c40\u503c\uff08\u7528\u65bc\u6d88\u9664\u914d\u7f6e\u503c\u7684\u5197\u9918\uff0c\u5426\u5247\u5fc5\u9808\u5c07\u5176\u8907\u88fd\u5230 config.yml \u6587\u4ef6\u4e2d\u7684\u4e0d\u540c\u4f4d\u7f6e\uff09 receivers \u914d\u7f6e\u63a5\u6536\u8005\uff08\u4f8b\u5982 SMTP \u670d\u52d9\u6216\u7db2\u7d61\u639b\u9264\uff09\u53ca\u5176\u6191\u64da route \uff1a\u8def\u7531\u662f\u905e\u6b78\u7684\u6578\u64da\u7d50\u69cb\uff0c\u5f9e\u800c\u5f62\u6210\u8def\u7531\u6a39\u3002\u57fa\u672c\u601d\u60f3\u662f\u8b66\u5831\u6cbf\u8457\u8b66\u5831\u8def\u7531\u6a39\u904d\u6b77\uff0c\u57fa\u65bc\u5339\u914d\u6536\u5230\u8b66\u5831\u7684\u6a19\u7c64\u7684\u5339\u914d\u5668\u3002\u5982\u679c\u8b66\u5831\u4e0d\u5339\u914d\u8def\u7531\u7bc0\u9ede\u7684\u4efb\u4f55\u5b50\u7bc0\u9ede\uff08\u56e0\u70ba\u6c92\u6709\u5b50\u7bc0\u9ede\u7684\u5339\u914d\u5668\u5339\u914d\uff0c\u6216\u8005\u56e0\u70ba\u6c92\u6709\u5b50\u7bc0\u9ede\uff09\uff0c\u5247\u8b66\u5831\u7531\u7576\u524d\u7bc0\u9ede\u8655\u7406\u3002\u901a\u5e38\uff0c\u8def\u7531\u7bc0\u9ede\u5f9e\u5176\u7236\u7bc0\u9ede\u7e7c\u627f\u503c\u3002\u6bcf\u500b\u8def\u7531\u7bc0\u9ede\u90fd\u6709\u4ee5\u4e0b\u914d\u7f6e\u53c3\u6578\uff1a \u5339\u914d\u5668\uff1a\u53ea\u6709\u5177\u6709\u6307\u5b9a\u6a19\u7c64/\u503c\uff08\u6216\u503c\u7684\u6b63\u5247\u8868\u9054\u5f0f\uff09\u7684\u8b66\u5831\u624d\u6703\u7e7c\u7e8c\u6cbf\u8457\u6a39\u7684\u9019\u500b\u5206\u652f group_by\uff1a\u7528\u65bc\u5c0d\u8b66\u5831\u9032\u884c\u5206\u7d44\u7684\u6a19\u7c64\u9375\u5217\u8868\u3002 Alertmanager \u7136\u5f8c\u70ba\u6bcf\u500b\u6a19\u7c64\u503c\u5275\u5efa\u4e00\u500b\u7d44\u3002\u9019\u6a23\u53ef\u4ee5\u907f\u514d\u60a8\u7684\u958b\u767c\u4eba\u54e1/\u64cd\u4f5c\u54e1\u6536\u5230\u8b66\u5831\u901a\u77e5\u7684\u5783\u573e\u90f5\u4ef6\u3002 \u5404\u7a2e\u7b49\u5f85\u671f\u6216\u9593\u9694\uff0c\u4ee5\u6e1b\u5c11\u767c\u9001\u8b66\u5831\u901a\u77e5\u7684\u6578\u91cf receiver\uff1a\u61c9\u5411\u5176\u767c\u9001\u8b66\u5831\u901a\u77e5\u7684\u63a5\u6536\u8005\u7684\u540d\u7a31 routes\uff1a\u8def\u7dda\u5b50\u5c0d\u8c61\u7684\u6578\u7d44 inhibit_rules\uff1a\u7981\u6b62\u898f\u5247\u5c0d\u50cf\u6578\u7d44\u3002\u5141\u8a31\u975c\u97f3\u4e00\u7d44\u8b66\u5831\uff0c\u56e0\u70ba\u53e6\u4e00\u500b\u8b66\u5831\u5df2\u7d93\u89f8\u767c\u3002\u9019\u6e1b\u5c11\u4e86\u8b66\u5831\uff08\u901a\u77e5\uff09\u5783\u573e\u90f5\u4ef6\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u6aa2\u6e2c\u5230\u6574\u500b\u7bc0\u9ede\u5df2\u95dc\u9589\uff0c\u5247\u4e0d\u9700\u8981\u70ba\u8a72\u7bc0\u9ede\u4e0a\u904b\u884c\u7684 10 \u500b\u670d\u52d9\uff08\u56e0\u6b64\u4e5f\u5df2\u95dc\u9589\uff09\u518d\u767c\u9001 10 \u500b\u8b66\u5831\u901a\u77e5\u3002","title":"Alertmanager"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#grafana","text":"Grafana \u4e0d\u5b58\u5132\u4efb\u4f55\u6307\u6a19\u6578\u64da\uff0c\u4f46\u7e3d\u662f\u5728\u904b\u884c\u6642\u5f9e Prometheus \u6aa2\u7d22\u5b83\u3002\u7136\u800c\uff0cGrafana \u7684\u914d\u7f6e\uff08\u4f8b\u5982\u6578\u64da\u6e90\u3001\u7528\u6236\u548c\u8eab\u4efd\u9a57\u8b49\u6216\u5100\u8868\u677f\uff09\u662f\u6709\u72c0\u614b\u5730\u5b58\u5132\u5728 Grafana \u7684\u5167\u90e8\u6578\u64da\u5eab\u4e2d\u3002\u5b83\u5011\u53ef\u4ee5\u901a\u904e Grafana \u7684 REST API \u6216\u5176 Web \u754c\u9762\u9032\u884c\u64cd\u4f5c\u3002\u4f46\u662f\uff0cGrafana \u4e5f\u6709\u4e00\u500b\u914d\u7f6e\u6a5f\u5236\uff0c\u5141\u8a31\u60a8\u5728 Grafana \u555f\u52d5\u6642\u4ee5\u53ca\u5b9a\u671f\uff08\u6bcf\u7576 Grafana \u6aa2\u6e2c\u5230\u6587\u4ef6\u5167\u5bb9\u9aee\u751f\u66f4\u6539\u6642\uff09\u901a\u904e\u6587\u4ef6\u8986\u84cb\u5167\u90e8\u5b58\u5132\u7684\u914d\u7f6e\u3002","title":"Grafana"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#exporters","text":"\u56e0\u70ba Prometheus \u671f\u671b Exporter \u50c5\u5728\u6293\u53d6\u6642\u516c\u958b\u61c9\u7528\u7a0b\u5e8f\u7684\u6307\u6a19\u6578\u64da\uff08\u63db\u53e5\u8a71\u8aaa\uff0cPrometheus \u4e0d\u671f\u671b\u6b77\u53f2\u6307\u6a19\u6578\u64da\uff09\uff0c\u6240\u4ee5 Exporter \u901a\u5e38\u662f\u5b8c\u5168\u7121\u72c0\u614b\u7684\u3002 \u914d\u7f6e\u65b9\u6cd5\u9ad8\u5ea6\u4f9d\u8cf4\u65bc\u61c9\u7528\u7a0b\u5e8f\u548c Exporter\u3002\u4e00\u4e9b Exporter \u4e0d\u9700\u8981\u4efb\u4f55\u914d\u7f6e\uff0c\u4f46\u6700\u5178\u578b\u7684\u662f\uff0c\u7121\u72c0\u614b CLI \u53c3\u6578\u548c/\u6216\u74b0\u5883\u8b8a\u91cf\u7528\u65bc\u914d\u7f6e Exporter\u3002","title":"Exporters"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#_2","text":"Prometheus \u4f7f\u7528\u57fa\u65bc\u62c9\u53d6\u7684\u65b9\u6cd5\uff0c\u5176\u4e2d Prometheus \u670d\u52d9\u5668\u5f9e\u7aef\u9ede\u6536\u96c6/\u62c9\u53d6\u6307\u6a19\uff0cPrometheus \u5fc5\u9808\u901a\u904e\u975c\u614b\u548c\u52d5\u614b\u670d\u52d9\u767c\u73fe\u4f86\u78ba\u5b9a\u54ea\u4e9b\u5217\u8868\u3002\u5176\u4ed6\u7cfb\u7d71\uff0c\u4f8b\u5982 Graphite\uff0c\u5247\u4f7f\u7528\u57fa\u65bc\u63a8\u9001\u7684\u65b9\u6cd5\uff0c\u5176\u4e2d\u4ee3\u7406\u9700\u8981\u4e86\u89e3\u6536\u96c6\u5668\uff0c\u4e26\u5c07\u5ea6\u91cf\u6578\u64da\u63a8\u9001\u7d66\u5b83\u3002 \u5982\u679c\u60a8\u641c\u7d22\u201c\u63a8\u9001\u8207\u62c9\u53d6\u76e3\u63a7\u201d\uff0c\u60a8\u6703\u767c\u73fe\u95dc\u65bc\u54ea\u500b\u201c\u66f4\u597d\u201d\u7684\u770b\u6cd5\u622a\u7136\u4e0d\u540c\u3002\u9019\u4e9b\u6587\u7ae0\u4e2d\u7684\u5927\u591a\u6578\u90fd\u662f\u7531\u5de5\u5177\u88fd\u9020\u5546\u64b0\u5beb\u7684\uff0c\u7136\u5f8c\u4ed6\u5011\u8b49\u660e\u4e86\u70ba\u4ec0\u9ebc\u4ed6\u5011\u7684\u65b9\u6cd5\u662f\u201c\u7565\u52dd\u4e00\u7c4c\u201d\u7684\u65b9\u6cd5\uff0c\u56e0\u70ba\u4ed6\u5011\u61c9\u7528\u4e86\u4e00\u4e9b\u512a\u5316\uff0c\u6216\u8005\u56e0\u70ba\u4ed6\u5011\u80fd\u5920\u63ed\u7a7f\u4e00\u4e9b\u95dc\u65bc\u4ed6\u5011\u7684\u65b9\u6cd5\u4e0d\u597d\u7684\u795e\u8a71\uff0c\u7b49\u7b49\u3002\u6700\u5f8c\uff0c\u57fa\u65bc\u63a8\u548c\u62c9\u7684\u7cfb\u7d71\u90fd\u6709\u7f3a\u9ede\uff0c\u4f46\uff08\u7f3a\u9ede\uff09\u7684\u56b4\u91cd\u7a0b\u5ea6\u53d6\u6c7a\u65bc\u60a8\u7684\u5177\u9ad4\u7528\u4f8b\u3002 \u5c0d\u65bc\u4efb\u4f55\u76e3\u63a7\u7cfb\u7d71\uff0c\u60a8\u90fd\u9700\u8981\u8655\u7406\u4ee5\u4e0b\u8a73\u7d30\u4fe1\u606f\uff1a \u5ef6\u9072\uff1a\u201c\u5df2\u77e5\u5ea6\u91cf\u6578\u64da\u9ede\u201d\u548c\u201c\u76e3\u63a7\u7cfb\u7d71\u5df2\u8655\u7406\u5b83\u201d\u4e4b\u9593\u7684\u5ef6\u9072\u3002\u4e00\u4e9b\u4f5c\u8005\u8a8d\u70ba\u57fa\u65bc\u63a8\u9001\u7684\u7cfb\u7d71\u63d0\u4f9b\u66f4\u4f4e\u7684\u5ef6\u9072\uff0c\u56e0\u6b64\u512a\u65bc\u57fa\u65bc\u62c9\u53d6\u7684\u7cfb\u7d71\u3002\u4ed6\u5011\u5f88\u5bb9\u6613\u5fd8\u8a18\u63d0\u5230\u7bc0\u7701\u9019\u5e7e\u79d2\u9418\u5728\u5be6\u8e10\u4e2d\u662f\u7121\u95dc\u7dca\u8981\u7684\uff0c\u56e0\u70ba\uff1a \u60a8\u7684\u5718\u968a\u5c07\u82b1\u8cbb\u5e7e\u5206\u9418\u751a\u81f3\u5e7e\u5c0f\u6642\u4f86\u5be6\u969b\u8a3a\u65b7\u548c\u89e3\u6c7a\u554f\u984c\uff0c \u60a8\u901a\u5e38\u5728\u670d\u52d9\u5668/\u6536\u96c6\u5668\u4e0a\u61c9\u7528\u7a4d\u6975\u7684\u6ed1\u52d5\u7a97\u53e3\u5e73\u5747\uff08\u4ee5\u6d88\u9664\u7570\u5e38\u503c\u548c\u8aa4\u5831\uff09\uff0c\u7a97\u53e3\u5927\u5c0f\u9060\u5927\u65bc\u4f7f\u7528\u57fa\u65bc\u63a8\u9001\u7684\u7cfb\u7d71\u6e1b\u5c11\u7684\u5ef6\u9072\u3002 \u767c\u73fe\uff1a\u8b93\u4ee3\u7406\u5be6\u4f8b\u4e86\u89e3\u6536\u96c6\u5668/\u670d\u52d9\u5668\u5be6\u4f8b\uff08\u53cd\u4e4b\u4ea6\u7136\uff09\u7e3d\u662f\u6d89\u53ca\u5fa9\u96dc\u6027\u3002\u5929\u4e0b\u6c92\u6709\u514d\u8cbb\u7684\u5348\u9910\u2026 \u5b89\u5168\u6027\uff1a\u6613\u65bc\u5be6\u65bd\u6a5f\u5236\uff08\u53ca\u5176\u5b89\u5168\u7a0b\u5ea6\uff09\uff0c\u78ba\u4fdd\u6c92\u6709\u672a\u7d93\u6388\u6b0a\u7684\u4e00\u65b9\u53ef\u4ee5\u8a2a\u554f\uff08\u4ee3\u7406\u6216\u6536\u96c6\u5668\u7684\uff09\u6307\u6a19\u6578\u64da \u53ef\u64f4\u5c55\u6027\uff1a\u4e00\u65e6\u4f60\u6709\u8a31\u591a\u4ee3\u7406\u7522\u751f\u5927\u91cf\u6578\u64da\uff0c\u9019\u5169\u7a2e\u65b9\u6cd5\u90fd\u4e0d\u80fd\u5f88\u597d\u5730\u5de5\u4f5c\uff0c\u53ea\u4f7f\u7528\u4e00\u500b\u6536\u96c6\u5668\u670d\u52d9\u5668\u3002\u5927\u591a\u6578\u5be6\u73fe\u90fd\u6709\u7528\u65bc\u64f4\u5c55\u7684\u89e3\u6c7a\u65b9\u6848\u3002\u6709\u95dc Prometheus \u7684\u64f4\u5c55\u65b9\u6cd5\uff0c\u8acb\u53c3\u898b\u4e0b\u6587\u3002 \u7dad\u904b\u8907\u96dc\u5ea6\uff1a\u6d89\u53ca\u9632\u706b\u7246\u914d\u7f6e\uff0c\u4ee5\u53ca\u66f4\u6539\u6574\u500b\u76e3\u63a7\u7cfb\u7d71\u914d\u7f6e\u7684\u96e3\u6613\u7a0b\u5ea6 \u5728\u5be6\u8e10\u4e2d\uff0c\u60a8\u53ef\u80fd\u6703\u4f7f\u7528\u4efb\u4f55\u4e00\u7a2e\u65b9\u6cd5\u90fd\u505a\u5f97\u5f88\u597d\u3002\u5f9e\u67b6\u69cb\u4e0a\u8b1b\uff0c\u60a8\u53ef\u4ee5\u6df7\u5408\u548c\u5339\u914d\u62c9\u5f0f\u8207\u57fa\u65bc\u63a8\u5f0f\u7684\u65b9\u6cd5\u3002\u4f8b\u5982\uff0cPushgateway \u6b63\u5728\u5c07\u63a8\u9001\u8f49\u63db\u70ba\u62c9\u53d6\uff0c\u800c Telegraf \u7b49\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u5c07\u62c9\u53d6\u8f49\u63db\u70ba\u63a8\u9001\u3002 Prometheus \u7684\u57fa\u65bc\u62c9\u7684\u65b9\u6cd5\u78ba\u5be6\u6709\u5169\u500b\u7f3a\u9ede\uff08\u7dad\u904b\u8907\u96dc\u5ea6\uff09\uff0c\u6211\u60f3\u89e3\u6c7a\u9019\u4e9b\u7f3a\u9ede\uff1a \u76e3\u63a7\u591a\u9032\u7a0b\u61c9\u7528\u7a0b\u5e8f\uff1a\u5982\u679c\u60a8\u4f7f\u7528\u591a\u500b\u9032\u7a0b\uff0c\u5247\u5f9e\u61c9\u7528\u7a0b\u5e8f\u7684 /metrics \u7aef\u9ede\u63d0\u53d6\u6307\u6a19\u5177\u6709\u6311\u6230\u6027\u3002\u539f\u56e0\u662f\u6307\u6a19\u6578\u64da\u901a\u5e38\u53ea\u4fdd\u5b58\u5728\u5167\u5b58\u4e2d\uff0c\u5206\u5225\u91dd\u5c0d\u6bcf\u500b\u9032\u7a0b\uff0c\u4e26\u4e14\u4e0d\u6e05\u695a\u60a8\u7684\u54ea\u4e9b\u9032\u7a0b\u5be6\u969b\u4e0a\u70ba /metrics \u7aef\u9ede\u63d0\u4f9b\u670d\u52d9\uff0c\u4ee5\u53ca\u6307\u6a19\u6578\u64da\u662f\u5982\u4f55\u7d2f\u7a4d\u7684\u3002\u5047\u8a2d\u60a8\u6b63\u5728\u69cb\u5efa\u4e00\u500b Python Web \u61c9\u7528\u7a0b\u5e8f\uff08\u4f8b\u5982\uff0c\u4f7f\u7528 Django \u6216 Flask\uff09\u4e26\u4f7f\u7528 WSGI \u61c9\u7528\u7a0b\u5e8f\u670d\u52d9\u5668\u4f86\u5be6\u73fe\u53ef\u4f38\u7e2e\u6027\uff0c\u4f8b\u5982 Gunicorn \u6216 uWSGI\uff0c\u5b83\u5011\u904b\u884c\u591a\u500b\u5de5\u4f5c\u9032\u7a0b\uff1a \u89e3\u6c7a\u65b9\u6848 #1 \uff1a\u8b93\u6bcf\u500b\u9032\u7a0b\u6536\u96c6\u81ea\u5df1\u7684\u6307\u6a19\uff0c\u6bcf\u7576\u8abf\u7528 /metrics \u6642\uff0cPrometheus \u5ba2\u6236\u7aef\u5eab\u4f7f\u7528\u4e00\u4e9b\u9032\u7a0b\u9593\u901a\u4fe1\u4f86\u6536\u96c6\u4f86\u81ea\u6240\u6709\u9032\u7a0b\u7684\u805a\u5408\u6307\u6a19\uff08\u4f8b\u5982\uff0c\u4f7f\u7528\u5f15\u64ce\u84cb\u4e0b\u7684\u6587\u4ef6\uff09\u3002\u6709\u95dc\u5be6\u73fe\u793a\u4f8b\uff0c\u8acb\u53c3\u95b1 Prometheus \u7684 Python \u5eab\u7684\u591a\u9032\u7a0b\u6a21\u5f0f\u3002 \u89e3\u6c7a\u65b9\u6848 #2 \uff1a\u5c07\u6bcf\u500b\u5de5\u4f5c\u9032\u7a0b\u8996\u70ba\u4e00\u500b\u55ae\u7368\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5373\u6bcf\u500b\u5de5\u4f5c\u9032\u7a0b\u90fd\u88ab\u7a31\u70ba Prometheus \u7684\u55ae\u7368\u76ee\u6a19\uff0c\u6bcf\u500b\u5de5\u4f5c\u9032\u7a0b\u90fd\u6709\u81ea\u5df1\u7684 /metrics \u7aef\u9ede\uff0c\u4f8b\u5982\u5728\u4e0d\u540c\u7684\u7aef\u53e3\u4e0b\u3002\u6307\u6a19\u7684\u805a\u5408\u5728\u67e5\u8a62\u6642\u5728\u670d\u52d9\u5668\u4e0a\u7684 PromQL \u4e2d\u5ef6\u9072\u548c\u57f7\u884c\u3002\u6709\u95dc\u793a\u4f8b\uff0c\u8acb\u53c3\u898b\u6b64\u8655\u3002 \u89e3\u6c7a\u65b9\u6848 #3 \uff1a\u8b93\u5de5\u4f5c\u4eba\u54e1\u5c07\u6307\u6a19\u63a8\u9001\u5230\u805a\u5408\u5668\uff08\u4f8b\u5982 Pushgateway \u6216 statsd\uff09\uff0cPrometheus \u5f9e\u4e2d\u63d0\u53d6\u805a\u5408\u7684\u6307\u6a19\u3002\u53c3\u898b\u4f8b\u5982\u9019\u88e1\u3002 \u76e3\u63a7\u77ed\u66ab\u7684\u9032\u7a0b\uff1a\u9032\u7a0b\uff08\u4f8b\u5982\u5099\u4efd\u8173\u672c\uff09\u7684\u5b58\u6d3b\u6642\u9593\u53ef\u80fd\u4e0d\u5920\u9577\uff0c\u7121\u6cd5\u70ba\u6307\u6a19\u6293\u53d6\u63d0\u4f9b\u670d\u52d9\u3002\u5728\u9019\u88e1\uff0c\u53ea\u6709\u57fa\u65bc\u63a8\u9001\u7684\u65b9\u6cd5\u624d\u6709\u610f\u7fa9\u3002\u89e3\u6c7a\u65b9\u6848\u662f\u6df7\u5408\u57fa\u65bc\u63a8\u548c\u62c9\u7684\u65b9\u6cd5\uff0c\u4e26\u4f7f\u7528\u985e\u4f3c\u63a8\u9001\u7db2\u95dc\u7684\u6771\u897f\uff08\u53c3\u898b\u4e0a\u9762\u7684\u89e3\u6c7a\u65b9\u6848\u65b9\u6cd5 #3 \uff09\u3002","title":"\u62c9\u5f0f\u76e3\u63a7\u67b6\u69cb\u7684\u6ce8\u610f\u4e8b\u9805"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part2/#_3","text":"Prometheus \u5806\u68e7\u662f\u4e00\u500b\u8907\u96dc\u7684\u7cfb\u7d71\u3002\u5728\u6211\u770b\u4f86\uff0c\u5c07\u5806\u68e7\u5206\u6210\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\uff08\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u90fd\u6709\u4e00\u500b\u55ae\u7368\u7684\u95dc\u6ce8\u9ede\uff09\u662f\u4e00\u7a2e\u5f88\u597d\u7684\u65b9\u6cd5\u3002\u60a8\u5c07\u5f88\u5feb\u7fd2\u6163\u9019\u5f71\u97ff\u7d44\u4ef6\u914d\u7f6e\u7684\u65b9\u5f0f\uff0c\u4e86\u89e3\u914d\u7f6e\u7684\u54ea\u500b\u90e8\u5206\u5c6c\u65bc\u54ea\u500b\u6587\u4ef6\u3002\u60a8\u73fe\u5728\u64c1\u6709\u8a31\u591a\uff08\u8f03\u5c0f\u7684\uff09\u6587\u4ef6\uff08\u5b58\u5132\u5728\u7248\u672c\u63a7\u5236\u4e2d\uff09\u9019\u4e00\u4e8b\u5be6\u6709\u52a9\u65bc\u66f4\u5927\u7684\u5718\u968a\u6839\u64da\u8ab0\u914d\u7f6e\u4ec0\u9ebc\u4f86\u5283\u5206\u8077\u8cac\u3002","title":"\u7d50\u8ad6"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/","text":"Prometheus & Alertmanager \u57fa\u672c\u6982\u5ff5 \u00b6 \u539f\u6587: Kubernetes Observability \u2013 Part III: Prometheus & Alertmanager basic concepts \u672c\u6587\u5e6b\u52a9\u60a8\u4e86\u89e3\u57fa\u672c\u7684 Alertmanager \u548c Prometheus \u6982\u5ff5\uff0c\u4f8b\u5982\u6307\u6a19\u3001\u6642\u9593\u5e8f\u5217\u3001\u793a\u4f8b\u3001\u8b66\u5831\u548c\u8b66\u5831\u901a\u77e5\u3002\u540c\u6642\u9084\u89e3\u91cb\u4e86\u6307\u6a19\u6578\u64da\u5728\u6982\u5ff5\u4e0a\u662f\u5982\u4f55\u5b58\u5132\u7684\u3001\u61c9\u8a72\u5982\u4f55\u6aa2\u6e2c\u61c9\u7528\u7a0b\u5e8f\u4ee5\u53ca\u5100\u8868\u677f\u7684\u57fa\u672c\u6982\u5ff5\u3002 \u4ecb\u7d39 \u00b6 Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c\u53ef\u89c0\u5bdf\u6027\u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u4e00\u500b\u91cd\u8981\u7684\u6b65\u9a5f\uff08\u5728\u6280\u8853\u8ecc\u9053\u4e0a\uff09\u662f\u4e86\u89e3\u57fa\u672c\u7684 Prometheus \u6982\u5ff5\u548c\u8853\u8a9e\u3002\u60a8\u9700\u8981\u5f88\u597d\u5730\u638c\u63e1\u5b83\u5011\uff0c\u624d\u80fd\u771f\u6b63\u4f7f\u7528 PromQL \u69cb\u5efa\u8b66\u5831\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86\u57fa\u672c\u6982\u5ff5\uff0c\u4f8b\u5982\u6307\u6a19\uff08\u4ee5\u53ca\u4e0d\u540c\u7684\u6307\u6a19\u985e\u578b\uff09\u3001\u6642\u9593\u5e8f\u5217\u3001\u6a23\u672c\u3001\u6578\u64da\u7684\u5b58\u5132\u65b9\u5f0f\u3001\u6aa2\u6e2c\u3001\u6a19\u7c64\u3001\u8b66\u5831\u548c\u8b66\u5831\u901a\u77e5\u4ee5\u53ca\u5100\u8868\u677f\u3002 \u6211\u5efa\u8b70\u60a8\u5f9e\u73fe\u5728\u958b\u59cb\u8457\u624b\u5be6\u969b\u4f7f\u7528 Prometheus \u5806\u68e7\u3002\u8981\u555f\u52d5\u4e26\u904b\u884c\u5b83\uff0c\u60a8\u6709\u591a\u7a2e\u9078\u64c7\uff1a \u4f7f\u7528\u7b2c\u4e09\u65b9\u6f14\u793a\u7cfb\u7d71\uff0c\u4f8b\u5982 http://demo.robustperception.io \u6216 https://demo.promlens.com - \u60a8\u7121\u9700\u5728\u672c\u5730\u8a2d\u7f6e\u4efb\u4f55\u5167\u5bb9\uff0c\u4f46\u60a8\u7121\u6cd5\u5f71\u97ff\u6216\u66f4\u6539\u9019\u4e9b\u7cfb\u7d71\u4e0a\u7684\u4efb\u4f55\u5167\u5bb9\u3002 \u57fa\u65bc\u672c\u5730 Docker (compose) \u7684\u5806\u68e7\uff0c\u53c3\u898b\u4f8b\u5982\u9019\u91cc\u6216\u9019\u88e1\u7684\u6a21\u677f\u3002\u5982\u679c\u60a8\u5728\u4e3b\u6a5f\u4e0a\u672c\u5730\u904b\u884c Linux\uff0c\u9019\u662f\u5b8c\u7f8e\u7684\u89e3\u6c7a\u65b9\u6848\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u5728\u4e3b\u6a5f\u4e0a\u4f7f\u7528 Windows \u6216 macOS\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6b64 Docker-compose \u8a2d\u7f6e\u7684\u7bc0\u9ede\u5c0e\u51fa\u5668\u4e0d\u6703\u6355\u7372\u5be6\u969b Windows/macOS \u4e3b\u6a5f\u7684\u6307\u6a19\uff0c\u800c\u662f Docker \u5bb9\u5668\u6240\u5728\u7684 VM\u8dd1\u6b65\u3002\u6539\u7528\u88f8\u6a5f\u9078\u9805\u53ef\u80fd\u6703\u66f4\u597d\u3002 \u672c\u5730\u88f8\u6a5f\u5b89\u88dd\uff1a\u4e0b\u8f09\u5404\u500b\u61c9\u7528\u7a0b\u5e8f\u4e8c\u9032\u88fd\u6587\u4ef6\uff08Prometheus\u3001Alertmanager\u3001Grafana\u3001Pushgateway\u3001\u7bc0\u9ede\u5c0e\u51fa\u5668\u7b49\uff09\u4e26\u624b\u52d5\u5b89\u88dd\u3002\u9019\u5c07\u82b1\u8cbb\u6700\u9577\u7684\u6642\u9593\uff0c\u4f46\u6703\u6559\u60a8\u6700\u591a\u6709\u95dc\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u7684\u4fe1\u606f\u3002 \u5728\u672c\u5730\u7684 K8S \u4e2d\u4f7f\u7528 Helm chart \u5b89\u88dd \u6307\u6a19\u3001\u6642\u9593\u5e8f\u5217\u3001\u6a23\u672c\u548c\u5b58\u5132 \u00b6 \u8853\u8a9e\u89e3\u8aaa \u00b6 \u5728\u672c\u7cfb\u5217\u7684\u524d\u5e7e\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u89e3\u91cb\u4e86\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff08\u4ee5\u53ca\u7b2c\u4e09\u65b9\u5c0e\u51fa\u5668\uff09\u516c\u958b\u201c\u6307\u6a19\u6578\u64da\u201d\uff0c\u901a\u904e HTTP \u5728 /metrics \u7aef\u9ede\u4e0a\u4ee5\u201cPrometheus \u683c\u5f0f\u201d\u63d0\u4f9b\u5b83\u5011\uff0c\u6bcf\u884c\u4e00\u500b\u6307\u6a19\u3002\u4f7f\u7528\u7684\u8853\u8a9e\uff0c\u5982\u201c\u6307\u6a19\u201d\u6216\u201c\u6307\u6a19\u6578\u64da\u201d\uff0c\u5be6\u969b\u4e0a\u4e26\u4e0d\u7cbe\u78ba\u2014\u2014\u9019\u88e1\u6709\u4e00\u4e9b\u5340\u5225\u3002\u8b93\u6211\u5011\u9996\u5148\u67e5\u770b Prometheus \u672c\u8eab\u7684 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\u7247\u6bb5\uff08\u55ae\u64ca\u6b64\u8655\u67e5\u770b\u5b8c\u6574\u8f38\u51fa\uff09\uff1a # HELP net_conntrack_dialer_conn_attempted_total Total number of connections attempted by the given dialer a given name. # TYPE net_conntrack_dialer_conn_attempted_total counter net_conntrack_dialer_conn_attempted_total { dialer_name = \"alertmanager\" } 2 net_conntrack_dialer_conn_attempted_total { dialer_name = \"node\" } 1 net_conntrack_dialer_conn_attempted_total { dialer_name = \"prometheus\" } 1 net_conntrack_dialer_conn_attempted_total { dialer_name = \"pushgateway\" } 1 ... # HELP go_memstats_mspan_sys_bytes Number of bytes used for mspan structures obtained from system. # TYPE go_memstats_mspan_sys_bytes gauge go_memstats_mspan_sys_bytes 8 .699904e+06 ... # HELP prometheus_http_response_size_bytes Histogram of response size for HTTP requests. # TYPE prometheus_http_response_size_bytes histogram prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"100\" } 1342 prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"1000\" } 1342 prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"10000\" } 1342 prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"+Inf\" } 1342 prometheus_http_response_size_bytes_sum { handler = \"/\" } 38918 prometheus_http_response_size_bytes_count { handler = \"/\" } 1342 ... # HELP prometheus_rule_evaluation_duration_seconds The duration for a rule to execute. # TYPE prometheus_rule_evaluation_duration_seconds summary prometheus_rule_evaluation_duration_seconds { quantile = \"0.5\" } 4 .4054e-05 prometheus_rule_evaluation_duration_seconds { quantile = \"0.9\" } 7 .1597e-05 prometheus_rule_evaluation_duration_seconds { quantile = \"0.99\" } 0 .00017088 prometheus_rule_evaluation_duration_seconds_sum 2 .8554187595358095e+06 prometheus_rule_evaluation_duration_seconds_count 2 .539804519e+09 ... \u5230\u76ee\u524d\u70ba\u6b62\uff0c\u6211\u5011\u6240\u8aaa\u7684\u201c\u6307\u6a19\u201d\u6216\u201c\u6307\u6a19\u6578\u64da\u201d\u6709\u4e00\u4e9b\u5fae\u5999\u7684\u8853\u8a9e\u3002\u4f7f\u7528\u4e0a\u9762\u7684\u793a\u4f8b\u8f38\u51fa\uff1a \u6642\u9593\u5e8f\u5217(time series) \u985e\u4f3c\u65bc net_conntrack_dialer_conn_attempted_total{dialer_name=\"alertmanager\"} \u6216 prometheus_rule_evaluation_duration_seconds_count \u3002\u57fa\u672c\u4e0a\u6240\u6709\u5167\u5bb9\u90fd\u662f\u4e00\u500b\u6642\u9593\u5e8f\u5217\uff0c\u5982\u679c\u60a8\u5728 Prometheus \u67e5\u8a62\u7a97\u53e3\u4e2d\u5c07\u5176\u4f5c\u70ba\u67e5\u8a62\u8f38\u5165\uff0c\u5247\u6703\u7522\u751f\u55ae\u884c\u8f38\u51fa\u3002 \u6307\u6a19(metric) \u985e\u4f3c\u65bc net_conntrack_dialer_conn_attempted_total \u6216 prometheus_http_response_size_bytes \uff0c\u6216\u9075\u5faa # TYPE <metric name> <metric type> \u5f62\u5f0f\u7684\u4efb\u4f55\u5176\u4ed6\u5167\u5bb9\u3002\u4e00\u500b\u6307\u6a19\u7d50\u5408\u4e86\u4e00\u500b\uff08\u6216\u591a\u500b\uff09\u6642\u9593\u5e8f\u5217\u3002 \u6642\u9593\u5e8f\u5217\u4e4b\u6240\u4ee5\u5f97\u540d\uff0c\u662f\u56e0\u70ba\u5b83\u7531\u4e00\u7cfb\u5217\" \u6a23\u672c(sample) \"\u7d44\u6210\u3002\u6a23\u672c\u662f\u5b58\u5132\u5728 TSDB \u4e2d\u7684\u5be6\u969b\u6578\u64da\u9ede\u3002\u6a23\u672c\u5177\u6709\u6642\u9593\u6233\uff08\u6beb\u79d2\u7cbe\u5ea6\uff09\u548c 64 \u4f4d\u6d6e\u9ede\u503c\u3002 \u6ce8\u610f\uff1a\u5118\u7ba1\u4e0a\u9762\u793a\u4f8b\u8f38\u51fa\u4e2d\u7684\u67d0\u4e9b\u503c\u770b\u8d77\u4f86\u50cf\u6574\u6578\uff0c\u4f46\u5b83\u5011\u5be6\u969b\u4e0a\u662f\u6d6e\u9ede\u6578\uff0c\u4e26\u4e14\u5b83\u5011\u662f\u9019\u6a23\u8655\u7406\u548c\u5b58\u5132\u7684\uff01 \u5f9e\u6307\u6a19\u4e2d\u8fa8\u5225\u6642\u9593\u5e8f\u5217\u4e26\u4e0d\u7e3d\u662f\u53ef\u884c\u7684\u3002\u4f8b\u5982\uff0c\u6c92\u6709\u6a19\u7c64\u7684\u985e\u578b gauge \u7684\u5ea6\u91cf\uff0c\u4f8b\u5982 go_memstats_mspan_sys_bytes\uff0c\u8853\u8a9e\u6642\u9593\u5e8f\u5217\u548c\u5ea6\u91cf\u78ba\u5be6\u6307\u7684\u662f\u540c\u4e00\u4ef6\u4e8b\u3002 \u6307\u6a19\u985e\u578b (Metric types) \u00b6 \u6b63\u5982\u4e0a\u9762\u7684\u793a\u4f8b\u8f38\u51fa\u6240\u793a\uff0cPrometheus \u6709\u5e7e\u7a2e\u985e\u578b\u7684\u6307\u6a19\uff08 \u5b98\u65b9\u6587\u6a94 \uff09: Counter Gauge Histogram Summary Counter \u6307\u6a19\u662f\u4e00\u500b\u7c21\u55ae\u7684\u6578\u5b57\uff0c\u53ef\u4ee5\u8a08\u7b97\u4e00\u4e9b\u6771\u897f\u3002\u793a\u4f8b\u5305\u62ec\u5411\u61c9\u7528\u7a0b\u5e8f\u767c\u51fa\u7684\u8acb\u6c42\u6578\u3001\u5df2\u5b8c\u6210\u6216\u5931\u6557\u7684\u4f5c\u696d\u6578\u7b49 - \u4f8b\u5982\uff1a net_conntrack_dialer_conn_attempted_total{dialer_name=\"alertmanager\"} 2 \u7576\u751f\u6210\u6b64\u6307\u6a19\u7684\u61c9\u7528\u7a0b\u5e8f\u904b\u884c\u6642\uff0c\u8a08\u6578\u5668\u7684\u503c\u9700\u8981\u55ae\u8abf\u589e\u52a0\uff08\u5c07\u8a08\u6578\u5668\u7684\u503c\u4fdd\u5b58\u5728\u6613\u5931\u6027\u5167\u5b58\u4e2d\uff09\u3002\u4f46\u662f\uff0c\u5982\u679c\u61c9\u7528\u7a0b\u5e8f\u91cd\u65b0\u555f\u52d5\uff0c\u5247\u5141\u8a31\u91cd\u7f6e\u8a08\u6578\u5668\uff08\u56e0\u6b64\u5176\u503c\u5c07\u6e1b\u5c0f\uff09\uff0c\u5f9e\u800c\u4e1f\u5931\u5167\u5b58\u4e2d\u4fdd\u5b58\u7684\u5148\u524d\u8a08\u6578\u5668\u7684\u503c\u3002 Prometheus \u7684\u6293\u53d6\u7a0b\u5e8f\u53ef\u4ee5\u667a\u80fd\u5730\u8655\u7406\u6b64\u985e\u91cd\u7f6e\u3002\u4f8b\u5982\uff0c\u5982\u679c Prometheus \u6293\u53d6\u4e00\u7cfb\u5217\u6a23\u672c\u503c\uff0c\u4f8b\u5982 1\u30014\u30016\u30012\uff0c\u5b83\u5be6\u969b\u4e0a\u6703\u5c07 1\u30014\u30016\u30018 \u5b58\u5132\u5728 TSDB \u4e2d\u3002 \u8207 Counter \u4e00\u6a23\uff0cGauge \u6307\u6a19\u662f\u4e00\u500b\u7c21\u55ae\u7684\u6578\u5b57\uff0c\u4f46\u5b83\u53ef\u4ee5\u96a8\u6642\u9593\u4efb\u610f\u4e0a\u4e0b\u6ce2\u52d5\u3002\u6b63\u5982\u6587\u6a94\u6240\u89e3\u91cb\u7684\u90a3\u6a23\uff0cGauge \u901a\u5e38\u7528\u65bc\u6e2c\u91cf\u67d0\u7a2e\u6578\u503c\u7576\u4e0b\u7684\u503c\uff0c\u4f8b\u5982\u6eab\u5ea6\u6216\u7576\u524d\u5167\u5b58\u4f7f\u7528\u60c5\u6cc1\uff0c\u4f46\u4e5f\u7528\u65bc\u53ef\u4ee5\u4e0a\u4e0b\u6ce2\u52d5\u7684\u201c\u8a08\u6578\u201d\uff0c\u4f8b\u5982\u4f75\u767c\u8acb\u6c42\u7684\u6578\u91cf\u3002 \u6b63\u5982\u5b98\u65b9\u6587\u6a94\u6240\u8ff0\uff1a\u76f4\u65b9\u5716\u5c0d\u89c0\u5bdf\u7d50\u679c\u9032\u884c\u63a1\u6a23\uff08\u901a\u5e38\u662f\u8acb\u6c42\u6301\u7e8c\u6642\u9593\u6216\u97ff\u61c9\u5927\u5c0f\u7b49\uff09\uff0c\u4e26\u5c07\u5b83\u5011\u8a08\u5165\u53ef\u914d\u7f6e\u7684\u5b58\u5132\u6876\u4e2d\u3002\u5b83\u9084\u63d0\u4f9b\u6240\u6709\u89c0\u5bdf\u503c\u7684\u7e3d\u548c\u3002 \u57fa\u672c\u6307\u6a19\u540d\u7a31\u70ba \u7684\u76f4\u65b9\u5716\u5728\u4e00\u6b21\u6293\u53d6\u671f\u9593\u516c\u958b\u4e86\u591a\u500b\u6642\u9593\u5e8f\u5217\uff1a \u89c0\u5bdf\u6876\u7684\u7d2f\u7a4d\u8a08\u6578\u5668\uff0c\u986f\u793a\u70ba <basename>_bucket{le=\"<upper inclusive bound>\"} - \u201cle\u201d\u4ee3\u8868\u201c\u5c0f\u65bc\u6216\u7b49\u65bc\u201d \u6240\u6709\u89c0\u5bdf\u503c\u7684\u7e3d\u548c\uff0c\u986f\u793a\u70ba <basename>_sum \u5df2\u89c0\u5bdf\u5230\u7684\u4e8b\u4ef6\u8a08\u6578\uff0c\u986f\u793a\u70ba <basename>_count \uff08\u8207 <basename>_bucket{le=\"+Inf\"} \u76f8\u540c\uff09 \u8b93\u6211\u5011\u4f7f\u7528\u9019\u4e9b\u77e5\u8b58\u4f86\u89e3\u91cb\u4e0a\u9762\u793a\u4f8b\u7247\u6bb5\u4e2d\u7684 prometheus_http_response_size_bytes_bucket \u76f4\u65b9\u5716\u6307\u6a19\uff1a prometheus_http_response_size_bytes_bucket{handler=\"/\",le=\"100\"} 1342 \u884c\u544a\u8a34\u6211\u5011\uff0c\u6709 1342 \u500b\u5c0d Prometheus \u7684\u201c/\u201d\u8655\u7406\u7a0b\u5e8f\u7684\u8acb\u6c42\uff0c\u7522\u751f\u5927\u5c0f\u5c0f\u65bc\u6216\u7b49\u65bc 100 \u5b57\u7bc0\u7684 HTTP \u97ff\u61c9\u3002 \u5176\u4ed6 _bucket \u884c\u5177\u6709\u76f8\u540c\u7684\u503c (1342)\u3002\u7531\u65bc Prometheus \u76f4\u65b9\u5716\u662f\u7d2f\u7a4d\u7684\uff0c\u9019\u544a\u8a34\u6211\u5011\u6c92\u6709\u4efb\u4f55\u5c0d Prometheus \u7684\u201c/\u201d\u8655\u7406\u7a0b\u5e8f\u7684\u8acb\u6c42\u7522\u751f\u5927\u65bc 100 \u5b57\u7bc0\u7684\u97ff\u61c9\u5927\u5c0f\u3002 prometheus_http_response_size_bytes_count{handler=\"/\"} 1342 \u9019\u4e00\u884c\u544a\u8a34\u6211\u5011\uff0c\u7e3d\u5171\u6709 1342 \u500b\u5c0d Prometheus \u7684\u201c/\u201d\u8655\u7406\u7a0b\u5e8f\u7684\u8acb\u6c42\u3002 prometheus_http_response_size_bytes_sum{handler=\"/\"} 38918 \u884c\u544a\u8a34\u6211\u5011\u6240\u6709\u97ff\u61c9\u5927\u5c0f\uff08\u6240\u6709 1342 \u500b\u8acb\u6c42\uff09\u7684\u7e3d\u548c\u70ba 38918 \u5b57\u7bc0\u3002\u56e0\u6b64\uff0c\u5982\u679c\u6211\u5011\u5c0d\u5b83\u611f\u5230\u597d\u5947\uff0c\u6211\u5011\u53ef\u4ee5\u81ea\u5df1\u8a08\u7b97\u5e73\u5747\u97ff\u61c9\u5927\u5c0f\uff08\u56e0\u70ba\u5230\u76ee\u524d\u70ba\u6b62\u6211\u5011\u53ea\u77e5\u9053\u5b83\u5c0f\u65bc\u6216\u7b49\u65bc 100 \u5b57\u7bc0\uff09\uff1a\u53ea\u9700\u8a08\u7b97 38918 / 1342 = 29 \u500b\u5b57\u7bc0\u3002 Summary \u6307\u6a19\u8207 Histogram \u6307\u6a19\u975e\u5e38\u76f8\u4f3c\uff0c\u4f46\u5b83\u7522\u751f \u5206\u4f4d\u6578 \uff08\u5728\u6ed1\u52d5\u6642\u9593\u7a97\u53e3\u4e0a\uff09\u800c\u4e0d\u662f\u7d2f\u7a4d\u7bb1/\u6876\u3002\u6709\u95dc\u5206\u4f4d\u6578\u7684\u8a73\u7d30\u8aaa\u660e\uff0c\u4ee5\u53ca\u4f55\u6642\u4f7f\u7528\u6458\u8981\u8207\u76f4\u65b9\u5716\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002 \u5206\u6790\u6211\u5011\u4e0a\u9762\u7684\u4f8b\u5b50\uff08prometheus_rule_evaluation_duration_seconds\uff09\uff0c\u6211\u5011\u770b\u5230\uff1a \u4e00\u534a (50%) \u7684\u898f\u5247\u8a55\u4f30\u6700\u591a\u9700\u8981 0.000044054 \u79d2 (0.044054 ms) - \u53e6\u4e00\u534a\u9700\u8981\u66f4\u9577\u7684\u6642\u9593 \u6700\u6162\u7684 10% \u7684\u898f\u5247\u8a55\u4f30\u6700\u591a\u9700\u8981 0.000071597 \u79d2 \u6700\u6162\u7684 1% \u7684\u898f\u5247\u8a55\u4f30\u6700\u591a\u9700\u8981 0.00017088 \u79d2 \u7e3d\u9ad4\u800c\u8a00\uff0c\u8a55\u4f30\u898f\u5247\u82b1\u8cbb\u4e86 2.8554187595358095e+06 \u79d2\uff08\u7d04 33 \u5929\uff09 \u5230\u76ee\u524d\u70ba\u6b62\uff0c\u6b64\u51fa\u53e3\u5546\u5df2\u5b8c\u6210 2.539804519e+09 \u6b21\u89c0\u5bdf\uff08\u898f\u5247\u8a55\u4f30\u6301\u7e8c\u6642\u9593\u6e2c\u91cf\uff09 \u57fa\u65bc\u4e0a\u8ff0\u6307\u6a19\u985e\u578b\uff0c\u60a8\u5728\u5be6\u8e10\u4e2d\u7d93\u5e38\u6703\u767c\u73fe\u53e6\u5916\u5169\u7a2e\uff08\u76f8\u7576\u672a\u8a18\u9304\u7684\uff09\u6307\u6a19\u985e\u578b\uff1a Enum Info \u7531\u65bc Prometheus \u50c5\u652f\u6301\u6d6e\u9ede\u503c\uff0c\u60a8\u53ef\u80fd\u60f3\u77e5\u9053\u5982\u4f55\u8868\u793a\u5b57\u7b26\u4e32\u503c\u3002\u679a\u8209\u6307\u6a19\u662f\u4e00\u7a2e\u53ef\u4ee5\u8b93\u60a8\u505a\u5230\u9019\u4e00\u9ede\u7684\u65b9\u6cd5\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u5275\u5efa\u4e00\u500b\u540d\u70ba my_app_state \u7684\u6307\u6a19\uff0c\u5b83\u53ef\u4ee5\u63a1\u7528\u201cstarting\u201d\u3001\u201crunning\u201d\u6216\u201cerror\u201d\u503c\u3002 \u60a8\u61c9\u8a72\u907f\u514d\u4f7f\u7528\u55ae\u4e00\u8a08\u91cf\u6307\u6a19\uff0c\u5c07\u4efb\u610f\u6578\u503c\u5206\u914d\u7d66\u72c0\u614b\uff08\u4f8b\u5982 1=starting\u30012=running\u30013=error\uff09\uff0c\u56e0\u70ba\u9019\u6a23\u60a8\u5c31\u4e0d\u80fd\u518d\u4f7f\u7528 PromQL \u4f86\u805a\u5408\u503c\uff08\u4f8b\u5982\u8b93 PromQL \u78ba\u5b9a\u201c\u904b\u884c\u201d\u5be6\u4f8b\u7684\u6578\u91cf\uff09\u3002 \u76f8\u53cd\uff0c\u5275\u5efa\u8207\u72c0\u614b\u4e00\u6a23\u591a\u7684\u6642\u9593\u5e8f\u5217\u985e\u578b\u8a08\u91cf\u5668\uff08\u6b64\u8655\uff1a3\uff09\uff0c\u5c07\u5b57\u7b26\u4e32\u503c\u5be6\u73fe\u70ba\u6a19\u7c64\uff0c\u4e26\u5206\u914d\u5e03\u723e\u503c\uff081=true\uff0c0=false\uff09\u3002\u5728\u4efb\u4f55\u7d66\u5b9a\u6642\u9593\uff0c\u53ea\u6709\u4e00\u500b\u6642\u9593\u5e8f\u5217\u7684\u503c\u53ef\u80fd\u70ba 1\u3002\u4ee5\u4e0b\u662f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684 /metrics \u7aef\u9ede\u53ef\u80fd\u8fd4\u56de\u7684\u793a\u4f8b\uff08\u60a8\u70ba\u6b64\u5275\u5efa\u4e86 my_app_state \u679a\u8209\u6307\u6a19\uff09\uff1a # HELP my_app_state The state of your application # TYPE my_app_state gauge my_app_state { state = \"starting\" } 1 my_app_state { state = \"running\" } 0 my_app_state { state = \"error\" } 0 \u7531\u65bc\u8a2d\u7f6e\u65b0\u7684\u679a\u8209\u6307\u6a19\u503c\u4e0d\u518d\u662f\u539f\u5b50\u64cd\u4f5c\uff0c\u56e0\u6b64\u60a8\u53ef\u80fd\u6703\u9047\u5230\u7af6\u722d\u689d\u4ef6\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0cscrape \u6703\u770b\u5230\u66ab\u6642\u4e0d\u4e00\u81f4\u7684\u72c0\u614b\uff08\u96f6\u500b\u6216\u591a\u500b\u6642\u9593\u5e8f\u5217\u5177\u6709 1\uff09\u3002\u4e00\u4e9b Prometheus SDK \u63d0\u4f9b\u4e86\u7d93\u904e\u5145\u5206\u6e2c\u8a66\u7684 Enum \u6307\u6a19\u5be6\u73fe\uff08\u53c3\u898b\u4f8b\u5982 Python\uff09\u3002\u5982\u679c\u60a8\u9078\u64c7\u7684 SDK \u6c92\u6709\u5be6\u73fe\uff0c\u5247\u8a72\u65b9\u6cd5\u662f\u5be6\u73fe\u4e00\u500b\u81ea\u5b9a\u7fa9\u6536\u96c6\u5668\uff0c\u8a72\u6536\u96c6\u5668\u5728\u5f8c\u53f0\u7ba1\u7406\u8a08\u91cf\u6307\u6a19\uff0c\u5176 set(value) \u65b9\u6cd5\u901a\u904e\u4f7f\u7528\u67d0\u7a2e\u7dda\u7a0b\u540c\u6b65\u539f\u8a9e\uff08\u4f8b\u5982\u4f5c\u70ba\u4e92\u65a5\u9ad4\uff09\u540c\u6b65\u8b80\u53d6\u548c\u5beb\u5165\u8acb\u6c42\u3002 \u8207 enum \u6307\u6a19\u985e\u4f3c\uff0cinfo \u6307\u6a19\u4e5f\u5141\u8a31\u60a8\u8868\u9054\u5b57\u7b26\u4e32\u503c\uff0c\u5373\u4f7f Prometheus \u50c5\u63d0\u4f9b\u6d6e\u9ede\u503c\u3002\u4fe1\u606f\u5ea6\u91cf\u7684\u60f3\u6cd5\u662f\u516c\u958b\u4efb\u4f55\u985e\u578b\u7684\u69cb\u5efa\u4fe1\u606f\uff0c\u4f8b\u5982\u7248\u672c\u6216\u69cb\u5efa\u865f\u3002\u8207\u5c07\u9019\u4e9b\u4fe1\u606f\u5197\u9918\u5730\u6dfb\u52a0\u5230\u5176\u4ed6\u73fe\u6709\u6307\u6a19\u76f8\u6bd4\uff0c\u5c07\u9019\u4e9b\u4fe1\u606f\u653e\u5728\u55ae\u7368\u7684\u4fe1\u606f\u6307\u6a19\u4e2d\u66f4\u5177\u6210\u672c\u6548\u76ca\u3002 \u4ee5\u4e0b\u662f Info \u6307\u6a19\u7684\u793a\u4f8b\uff1a # HELP python_info Python platform information # TYPE python_info gauge python_info { implementation = \"CPython\" ,major = \"3\" ,minor = \"6\" ,patchlevel = \"7\" ,version = \"3.6.7\" } 1 \u5982\u60a8\u6240\u898b\uff0c\u4fe1\u606f\u6307\u6a19\u7684\u540d\u7a31\u5177\u6709 _info \u5f8c\u7db4\u3002\u60a8\u60f3\u8981\u8868\u9054\u7684\u69cb\u5efa\u4fe1\u606f\u4f4d\u4f5c\u70ba\u6a19\u7c64\u5305\u542b\u5728\u5167\u3002\u8a72\u503c\u53ea\u662f\u4e00\u500b\u865b\u64ec\u503c 1\u3002 \u61c9\u7528\u7cfb\u7d71\u6307\u6a19\u5316\u5d4c\u5165 (Instrumentation) \u00b6 \u5728 Prometheus \u4e16\u754c\u4e2d\uff0c\u201cInstrumentation\u201d \u662f\u6307\u5728\u60a8\u81ea\u5df1\u7684\u4ee3\u78bc\u5eab\u4e2d\u6dfb\u52a0\u984d\u5916\u4ee3\u78bc\u4ee5\u516c\u958b\u6307\u6a19\u6578\u64da\u7684\u904e\u7a0b\u3002\u9019\u4e9b\u6307\u6a19\u7279\u5b9a\u65bc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5f9e\u8a9e\u7fa9\u7684\u89d2\u5ea6\u4f86\u770b\uff0c\u5b83\u5011\u53ef\u80fd\u8655\u65bc\u201c\u4f4e\u7d1a\u5225\u201d\uff0c\u4f8b\u5982 HTTP \u8acb\u6c42\u7684\u6578\u91cf\uff08\u5982\u679c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u63d0\u4f9b HTTP\uff09\uff0c\u6216\u8005\u201c\u9ad8\u7d1a\u201d\uff0c\u4f8b\u5982\u7528\u6236\u9ede\u64ca\u89f8\u767c\u61c9\u7528\u7a0b\u5e8f\u67d0\u4e9b\u529f\u80fd\u7684\u7279\u5b9a\u6309\u9215\u7684\u6b21\u6578\u3002\u60a8\u901a\u5e38\u6703\u4f7f\u7528 Prometheus \u793e\u5340\u69cb\u5efa\u7684 Prometheus SDK \u4f86\u5b8c\u6210\u6b64\u4efb\u52d9\uff08\u8acb\u53c3\u95b1\u6b64\u8655\uff09\u3002\u9019\u4e9b SDK \u5be6\u73fe\u4e86\u670d\u52d9\u65bc /metrics \u7aef\u9ede\u7684 HTTP \u670d\u52d9\u5668\uff0c\u4e26\u63d0\u4f9b\u4e86\u7528\u65bc\u5275\u5efa\u4e0d\u540c\u985e\u578b\u7684\u6307\u6a19\u4e26\u66f4\u65b0\u5176\u503c\u7684\u9ad8\u7d1a\u65b9\u6cd5\u3002\u7136\u5f8c\u7531 SDK \u7ba1\u7406\u7684 HTTP \u670d\u52d9\u5668\u516c\u958b\u9019\u4e9b\u6307\u6a19\u3002 \u7576\u6dfb\u52a0\u984d\u5916\u4ee3\u78bc\u4ee5\u516c\u958b\u6307\u6a19\u6578\u64da\u6642\uff0c\u60a8\u5fc5\u9808\u70ba\u6307\u6a19\u672c\u8eab\u5b9a\u7fa9\u5408\u9069\u7684\u540d\u7a31\u3001\u6307\u6a19\u7684\u6a19\u7c64\uff0c\u4e26\u4e14\u60a8\u5fc5\u9808\u78ba\u5b9a\u4f55\u6642\u958b\u59cb\u4e00\u500b\u5168\u65b0\u7684\u6307\u6a19\u8207\u70ba\u73fe\u6709\u6307\u6a19\u5275\u5efa\u984d\u5916\u7684\u6a19\u7c64\u3002\u60a8\u53ef\u4ee5\u9075\u5faa\u4e00\u4e9b\u5e38\u898b\u7684\u624b\u6cd5\uff1a Metric names \u7531\u4e0b\u5283\u7dda\u5206\u9694\u7684\u591a\u500b\u55ae\u8a5e\u7d44\u6210\u3002\u4e00\u500b\u5e38\u7528\u7684\u65b9\u6848\u662f\uff1a <libraryname>_<unit>_<suffix> \u3002 libraryname \u90e8\u5206\u6a19\u8b58\u60a8\u7684\u6307\u6a19\u3002\u5b83\u61c9\u8a72\u8868\u660e\u6307\u6a19\u662f\u95dc\u65bc\u4ec0\u9ebc\u7684\u3002\u60a8\u9084\u61c9\u8a72\u78ba\u4fdd\u5b83\u5728 Prometheus \u751f\u614b\u7cfb\u7d71\u4e2d\u7684\u6240\u6709\u5176\u4ed6\u73fe\u6709\u6307\u6a19\u540d\u7a31\u4e2d\u662f\u552f\u4e00\u7684\u3002\u5b83\u53ef\u80fd\u7531\u591a\u500b\u7528\u4e0b\u5283\u7dda\u5206\u9694\u7684\u55ae\u8a5e\u7d44\u6210\u3002 unit \u985e\u4f3c\u65bc\u201c\u79d2\u201d\u6216\u201c\u5b57\u7bc0\u201d\u3002 suffix \uff1a\u6309\u7167\u6163\u4f8b\uff0cgauge \u6307\u6a19\u5177\u6709\u5f8c\u7db4\u201c_total\u201d\uff0c\u800c counter \u6307\u6a19\u4e0d\u9700\u8981\u5f8c\u7db4\u3002histograms \u548c summary \u6307\u6a19\u6709\u591a\u884c\uff08\u5728 /metrics \u7684\u8f38\u51fa\u4e2d\uff09\uff0c\u5176\u5167\u5bb9\u5404\u4e0d\u76f8\u540c\uff1a\u4e00\u884c\u4ee5 _sum \u7d50\u5c3e\uff0c\u4e00\u884c\u4ee5 _count \u7d50\u5c3e\uff0c\u9084\u6709\u5176\u4ed6\u5e7e\u884c\uff08\u4f8b\u5982\uff0c_bucket{\u2026} \u7528\u65bchistograms\uff09\u3002\u901a\u5e38\uff0cSDK \u6703\u70ba\u60a8\u751f\u6210\u9019\u4e9b\u3002 Label \u5340\u5206\u6307\u6a19\u91cf\u6e2c\u67d0\u7a2e\u4e8b\u7269\u7684\u7279\u5fb5\u3002\u5b83\u5011\u7531\u9375\u548c\u503c\u5b57\u7b26\u4e32\u7d44\u6210\uff0c\u5176\u4e2d\u9375\u53ef\u80fd\u6709\u591a\u500b\u7531\u4e0b\u5283\u7dda\u5206\u9694\u7684\u55ae\u8a5e\u3002\u6211\u5c07\u5728\u4e0b\u9762\u7684\u90e8\u5206\u4e2d\u8a73\u7d30\u4ecb\u7d39\u6a19\u7c64\u3002 \u60a8\u53ef\u80fd\u60f3\u77e5\u9053\uff1a\u4ec0\u9ebc\u6642\u5019\u61c9\u8a72\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6307\u6a19? \u4ec0\u9ebc\u6642\u5019\u61c9\u8a72\u70ba\u73fe\u6709\u6307\u6a19\u6dfb\u52a0\u65b0\u6a19\u7c64? \u6b63\u5982\u672c\u6587\u4e2d\u66f4\u8a73\u7d30\u89e3\u91cb\u7684\u90a3\u6a23\uff0c\u57fa\u672c\u601d\u60f3\u662f\u60a8\u53ef\u4ee5\u4f7f\u7528 PromQL \u4f86\u8a08\u7b97\u6307\u6a19\u7684\u805a\u5408\uff08\u4f8b\u5982\uff0c\u7e3d\u548c\uff0c\u6216\u60a8\u6307\u5b9a\u7684\u6642\u9593\u6bb5\u5167\u7684\u5e73\u5747\u503c\uff09\u3002\u4f46\u662f\uff0c\u9019\u4e9b PromQL \u805a\u5408\u6a5f\u5236\u50c5\u5728\u7279\u5b9a\u6307\u6a19\u5167\u904b\u884c\u826f\u597d\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u60a8\u7e3d\u662f\u5728\u532f\u7e3d\u7279\u5b9a\u6307\u6a19\u7684\u4e0d\u540c\u6a19\u7c64\u3002\u8981\u56de\u7b54\u6700\u521d\u7684\u554f\u984c\uff1a\u60a8\u61c9\u8a72\u7e7c\u7e8c\u5411\u73fe\u6709\u6307\u6a19\u6dfb\u52a0\u6a19\u7c64\uff0c\u53ea\u8981\u9019\u4e9b\u6a19\u7c64\u4e0a\u7684\u805a\u5408\u64cd\u4f5c\uff08\u6c42\u548c\u7b49\uff09\u662f\u6709\u610f\u7fa9\u7684\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u6709\u4e00\u500b\u6307\u6a19 http_requests_total \uff08\u5e36\u6709\u8af8\u5982 path=\"/foo\" \u7b49\u6a19\u7c64\uff09\uff0c\u4e26\u4e14\u73fe\u5728\u60a8\u9084\u60f3\u5305\u62ec\u54ea\u500b\u670d\u52d9\u6b63\u5728\u70ba\u8acb\u6c42\u63d0\u4f9b\u670d\u52d9\uff0c\u8acb\u6dfb\u52a0\u53e6\u4e00\u500b\u6a19\u7c64\uff0c\u4f8b\u5982 service=\"users-directory\" \u8207\u5275\u5efa\u65b0\u6307\u6a19\uff08\u4f8b\u5982 http_requests_users_directory_total \uff09\u76f8\u6bd4\uff0c\u5b83\u66f4\u6709\u610f\u7fa9\u3002\u4f46\u662f\uff0c\u5982\u679c\u6a19\u7c64\u805a\u5408\u4e0d\u518d\u6709\u610f\u7fa9\uff0c\u8acb\u8003\u616e\u5275\u5efa\u4e00\u500b\u65b0\u6307\u6a19\u3002 Prometheus \u5b98\u65b9\u624b\u518a\u4e5f\u6709\u4e00\u4e9b\u95dc\u65bc\u6307\u6a19\u548c\u6a19\u7c64\u547d\u540d\u7684\u5efa\u8b70\u3002 \u6a19\u7c64 (Labels) \u00b6 \u5728 Prometheus\uff08\u4ee5\u53ca Kubernetes\uff09\u4e2d\uff0c\u6a19\u7c64\u662f\u9375\u503c\u5c0d\uff0c\u5176\u4e2d\u9375\u548c\u503c\u90fd\u662f\u5b57\u7b26\u4e32\u3002\u5982\u679c\u503c\u6216\u9375\u4e0d\u540c\uff0c\u6211\u5011\u8aaa\u5169\u500b\u7d66\u5b9a\u7684\u6a19\u7c64\u662f\u4e0d\u540c\u7684\u3002\u4f8b\u5982\uff0c\u6a19\u7c64 path=\"/\" \u548c path=\"/bar\" \u662f\u4e0d\u540c\u7684\uff01 \u6a19\u7c64\u53ef\u4ee5\u9644\u52a0\u5230\u6307\u6a19\u6216\u8b66\u5831\uff1a Metric \u6a19\u7c64 Alert \u6a19\u7c64 Metric \u6307\u6a19\u6709\u5169\u985e\u6a19\u7c64\uff1atarget \u6a19\u7c64\u548c instrumentation \u6a19\u7c64\uff1a Instrumentation \u6a19\u7c64 - \u7531\u6aa2\u6e2c\u4ee3\u78bc\u6dfb\u52a0\u3002\u9019\u4e9b\u662f\u60a8\u5728 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\u4e2d\u770b\u5230\u7684\u6240\u6709\u6a19\u7c64\u3002 Target \u6a19\u7c64 - Prometheus \u670d\u52d9\u5668\u5728\u6293\u53d6\u6307\u6a19\u7684\u904e\u7a0b\u201c\u4e4b\u5f8c\u201d\u518d\u6dfb\u52a0 target \u6a19\u7c64\uff08\u56e0\u6b64\uff0c\u60a8\u4e0d\u6703\u5728 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\u4e2d\u770b\u5230\u5b83\u5011\uff09\uff0c\u5c31\u5728\u5c07\u65b0\u6293\u53d6\u7684\u8a72\u6307\u6a19\u7684\u6a23\u672c\u5b58\u5132\u5230\u5176 TSDB \u4e4b\u524d\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPrometheus \u6dfb\u52a0 target \u6a19\u7c64 job=\"somejob\" \u548c instance=\"somehost:9091\" \uff0c\u5176\u4e2d somejob \u662f\u60a8\u5728 prometheus.yml \u4e2d\u7684 job_name \u5b57\u6bb5\u4e4b\u4e00\u4e2d\u627e\u5230\u7684\u5b57\u7b26\u4e32\uff0cinstance \u6307\u7684\u662f\u5177\u9ad4\u7684\u4e3b\u6a5f\u6216\u9032\u7a0b\u5176 /metrics \u7aef\u9ede\u5df2\u88ab\u6293\u53d6\u3002\u5728 prometheus.yml \u6587\u4ef6\u4e2d\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u60a8\u559c\u6b61\u7684\u5176\u4ed6 target \u6a19\u7c64\u3002 \u95dc\u65bc\u6a19\u7c64\u7684\u4e00\u500b\u6709\u7528\u529f\u80fd\u662f\" \u91cd\u65b0\u6a19\u8a18 \"\u3002\u5b83\u89e3\u6c7a\u4e86\u4ee5\u4e0b\u91cd\u8981\u554f\u984c\uff1a\u5047\u8a2d\u67d0\u500b\u5c0e\u51fa\u5668\u7684 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\uff08\u4e0d\u662f\u60a8\u7de8\u5beb\u7684 -> \u60a8\u7121\u6cd5\u66f4\u6539\u5b83\uff09\u4e0d\u9069\u5408\u60a8\u7684\u7528\u4f8b\u3002\u4f8b\u5982\uff0c\u8f38\u51fa\u53ef\u80fd\u5305\u542b\u592a\u591a\u6307\u6a19\uff08\u60a8\u4e0d\u60f3\u5b58\u5132\uff09\uff0c\u6216\u8005\u67d0\u4e9b\u6642\u9593\u5e8f\u5217\u7684\u67d0\u4e9b\u6a19\u7c64\u5c0d\u60a8\u4f86\u8aaa\u4e0d\u91cd\u8981\uff0c\u6216\u8005\u60a8\u4e0d\u559c\u6b61\u5b83\u5011\u7684\u7279\u5b9a\u547d\u540d\u3002 Prometheus \u7684\u91cd\u65b0\u6a19\u8a18\u529f\u80fd (docs) \u5141\u8a31\u60a8\u5728\u5c07\u6307\u6a19\u548c/\u6216\u6a19\u7c64\u5b58\u5132\u5230 TSDB \u4e4b\u524d\u522a\u9664\u6216\u4fee\u6539\u5b83\u5011\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86\u9019\u500b\u6982\u5ff5\u3002 \u95dc\u65bc Prometheus \u6027\u80fd\u7684\u4e00\u500b\u91cd\u8981\u77e5\u8b58\u662f\u6642\u9593\u5e8f\u5217\u6578\u91cf\uff0c\u5b83\u6307\u7684\u662f TSDB \u4e2d\u6642\u9593\u5e8f\u5217\u7684\u6578\u91cf\u3002\u904e\u591a\u7684\u6642\u9593\u5e8f\u5217\u5c0d\u65bc PromQL \u67e5\u8a62\u7684\u6027\u80fd\u662f\u6709\u554f\u984c\u7684\uff0c\u9019\u9700\u8981\u6642\u9593\u5e8f\u5217\u6578\u64da\u5728\u5167\u5b58\u4e2d\uff08\u4f8b\u5982\uff0c\u7528\u65bc\u8a08\u7b97\u7e3d\u548c\u7b49\u805a\u5408\uff09\u3002\u4f60\u7684\u8a18\u61b6\u662f\u6709\u9650\u7684\uff0c\u56e0\u6b64\uff0c\u8a18\u61b6\u4e2d\u7684\u6642\u9593\u5e8f\u5217\u4e5f\u662f\u6709\u9650\u7684\u3002 \u662f\u4ec0\u9ebc\u63a8\u52d5\u4e86\u6642\u9593\u5e8f\u5217\u7684\u6578\u91cf\u589e\u52a0\uff1f\u4e3b\u8981\u662f\" \u6a19\u7c64 \"\uff08\u4e0d\u662f\u6307\u6a19\u540d\u7a31\uff09\uff0c\u56e0\u70ba\u6a19\u7c64\u53ef\u4ee5\u6709\u8a31\u591a\u4e0d\u540c\u7684\u503c\u3002\u56e0\u6b64\uff0c\u60a8\u61c9\u8a72\u907f\u514d\u5728\u6307\u6a19\u4e2d\u6dfb\u52a0\u8af8\u5982 username=\"peter\" \u9019\u6a23\u7684\u6a19\u7c64\uff0c\u56e0\u70ba\u60a8\u53ef\u80fd\u64c1\u6709\u6578\u767e\u842c\u7528\u6236\uff0c\u5f9e\u800c\u7522\u751f\u6578\u767e\u842c\u500b\u6642\u9593\u5e8f\u5217\u3002\u9019\u540c\u6a23\u9069\u7528\u65bc\u96fb\u5b50\u90f5\u4ef6\u6216 IP \u5730\u5740\u7b49\u6a19\u7c64\u3002\u9019\u4e5f\u610f\u5473\u8457\uff0c\u5c0d\u65bc\u60a8\u5e0c\u671b\u6709\u8a31\u591a\u6a19\u7c64\u7684\u6307\u6a19\uff0c\u60a8\u61c9\u8a72\u907f\u514d\u4f7f\u7528\u6307\u6a19\u985e\u578b\u6458\u8981\u548c\u76f4\u65b9\u5716\uff08\u800c\u66f4\u559c\u6b61\u5100\u8868\u548c\u8a08\u6578\u5668\uff09\uff0c\u56e0\u70ba\u9019\u4e9b\u6307\u6a19\u985e\u578b\u70ba\u60a8\u81ea\u5df1\u7684\u6bcf\u500b\u6a19\u7c64\u6dfb\u52a0\u4e86\u5927\u91cf\u6642\u9593\u5e8f\u5217\uff0c\u7528\u65bc\u4e0d\u540c\u7684\u5206\u4f4d\u6578\u6216\u5b58\u5132\u6876\u3002 \u6bcf\u7576\u8a55\u4f30 for: ... PromQL \u8868\u9054\u5f0f\u5728 alert-rules.yml \u6587\u4ef6\u4e2d\u751f\u6210\u4e00\u500b\u6216\u591a\u500b\u6642\u9593\u5e8f\u5217\u884c\u6642\uff0cPrometheus \u5c31\u6703\u751f\u6210\u4e00\u500b\u8b66\u5831\u5c0d\u8c61\uff08\u5c07\u5176\u767c\u9001\u5230 Alertmanager\uff09\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e9b\u884c\u7684\u6a19\u7c64\uff08\u4f8b\u5982 job=\"somejob\" \u3001 instance=\"host:port\" \u548c\u5176\u4ed6\u7279\u5b9a\u65bc\u6307\u6a19\u7684\u6a19\u7c64\uff09\u9644\u52a0\u5230\u6b64\u8b66\u5831\u5c0d\u8c61\u3002\u5728 alert-rules.yml \u6587\u4ef6\u4e2d\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u5176\u4ed6\u6a19\u7c64\uff0c\u4f8b\u5982 severity=\"critical\" \uff0c\u60a8\u53ef\u4ee5\u5728\u8b66\u5831\u8def\u7531\u6a39\u7684\u5339\u914d\u5668\u4e2d\u4f7f\u7528\u5b83\u3002 \u8b66\u5831\u548c\u8b66\u5831\u901a\u77e5 \u00b6 \u6b63\u5982\u6211\u5728\u672c\u6587\u548c\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u5df2\u7d93\u8a0e\u8ad6\u904e\u7684\uff0c\u8b66\u5831 (alert) \u548c\u8b66\u5831\u901a\u77e5 (alert notification) \u662f\u5169\u500b\u7368\u7acb\u7684\u6982\u5ff5\u3002 \u8b66\u5831\u53ea\u662f Prometheus \u767c\u9001\u7d66 Alertmanager \u7684 JSON \u5c0d\u8c61\u3002 Prometheus \u4e0d\u6703\u5c07\u4efb\u4f55\u8b66\u5831\u7684\u72c0\u614b\u5b58\u5132\u5728\u81ea\u5df1\u7684\u6578\u64da\u5b58\u5132\u4e2d\u3002\u56e0\u6b64\uff0cPrometheus \u4e0d\u6703\u6aa2\u6e2c\u5230\u8b66\u5831\u8f49\u63db\uff08\u4f8b\u5982\u201c\u8b66\u5831\u958b\u59cb\u89f8\u767c\u201d\u8207\u201c\u8b66\u5831\u505c\u6b62\u89f8\u767c\u201d\uff09\u3002\u53ea\u8981\u76f8\u61c9\u8b66\u5831\u898f\u5247\u7684 PromQL \u8868\u9054\u5f0f\u7684\u8a55\u4f30\u7522\u751f\u4e00\u500b\u6216\u591a\u500b\u6642\u9593\u5e8f\u5217\u884c\uff0c\u5b83\u5c31\u6703\u7c21\u55ae\u5730\u767c\u9001\u8b66\u5831\u5c0d\u8c61\uff0c\u5426\u5247\u5b83\u4e0d\u6703\u767c\u9001\u4efb\u4f55\u8b66\u5831\u3002 Alertmanager \u8ca0\u8cac\u5b58\u5132\u9019\u4e9b\u8b66\u5831\u5c0d\u8c61\u3001\u6aa2\u6e2c\u201c\u8b66\u5831\u89f8\u767c\u201d\u8f49\u63db\uff08\u901a\u904e\u6aa2\u67e5\u5b83\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u6536\u5230\u7684\u8b66\u5831\u7684\u5b58\u5728\u8207\u5426\uff09\uff0c\u4e26\u751f\u6210\u8b66\u5831\u901a\u77e5\uff0c\u9019\u4e9b\u901a\u77e5\u88ab\u767c\u9001\u5230\u5be6\u969b\u7522\u751f\u8b66\u5831\u7684\u7cfb\u7d71\uff0c\u7528\u6236\u53ef\u4ee5\u611f\u77e5\u2014\u2014\u4f8b\u5982\u77ed\u4fe1\u3001\u96fb\u5b50\u90f5\u4ef6\u7b49\u3002 \u9996\u5148\uff0c\u6b63\u78ba\u914d\u7f6e Alertmanager \u78ba\u5be6\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u56e0\u70ba\u60a8\u9996\u5148\u9700\u8981\u5f88\u597d\u5730\u7406\u89e3\u8b66\u5831\u8def\u7531\u6a39\u7684\u6982\u5ff5\uff08\u5728\u6b64\u8655\u7684\u5b98\u65b9\u6587\u6a94\u4e2d\u6709\u5f88\u597d\u7684\u89e3\u91cb\uff09\u548c\u5206\u7d44\u6982\u5ff5\u3002 \u5206\u7d44\u7684\u57fa\u672c\u601d\u60f3\uff08\u53c3\u898b Alertmanager \u914d\u7f6e\u6587\u4ef6\u4e2d\u8def\u7531\u584a\u4e2d\u7684 group_by \u9375\uff09\u662f\u63a7\u5236\u901a\u77e5\u7684\u7c92\u5ea6\u3002\u6587\u6a94\u6c92\u6709\u5f88\u597d\u5730\u89e3\u91cb\u5b83\u3002\u9019\u662f\u6211\u5c0d\u5206\u7d44\u529f\u80fd\u7684\u500b\u4eba\u5fc3\u7406\u6a21\u578b\uff1a Alertmanager \u5728\u8b66\u5831\u8def\u7531\u6a39\u4e2d\u7684\u6bcf\u500b\u8def\u7531\u7bc0\u9ede\u5275\u5efa\u4e00\u500b\u6216\u591a\u500b\uff08\u6211\u7a31\u4e4b\u70ba\uff09\u201c\u901a\u77e5\u6876\u201d\uff08\u6bcf\u7d44\u4e00\u500b\u6876\uff09\u3002\u6bcf\u7576\u8b66\u5831\u6700\u7d42\u5230\u9054\u6a39\u4e2d\u7684\u4e00\u500b\u7bc0\u9ede\u6642\uff0cAlertmanager \u5c31\u6703\u5c07\u5176\u653e\u5165\u5176\u4e2d\u4e00\u500b\u5b58\u5132\u6876\u4e2d\u3002 \u5982\u679c\u60a8\u6c92\u6709\u70ba\u7bc0\u9ede\u6307\u5b9a\u4efb\u4f55 group_by \uff0c\u5247\u8a72\u7bc0\u9ede\u53ea\u6709\u4e00\u500b\u5b58\u5132\u6876/\u7d44\u3002\u4e00\u65e6\u901a\u904e\u4e86\u8db3\u5920\u7684\u7d44\u95be\u503c\uff08\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f group_wait \uff09\uff0c\u5c31\u6703\u751f\u6210\u4e00\u500b\u975e\u5e38\u5927\u7684\u55ae\u500b\u901a\u77e5\uff08\u4f8b\u5982\u96fb\u5b50\u90f5\u4ef6\uff09\uff0c\u56e0\u70ba\u5b83\u5305\u542b\u4e00\u500b\u9577\u5217\u8868\uff0c\u5176\u4e2d\u5305\u542b\u8def\u7531\u6a39\u4e2d\u8def\u7531\u5230\u8a72\u7bc0\u9ede\u7684\u6240\u6709\u8b66\u5831\u3002 \u5982\u679c\u60a8\u6539\u70ba\u6307\u5b9a\u985e\u4f3c group_by: [region] \u7684\u5167\u5bb9\uff0c\u5247 Alertmanager \u5c07\u5275\u5efa\u8207\u8b66\u5831\u4e2d\u6a19\u7c64\u5340\u57df\u7684\u503c\u4e00\u6a23\u591a\u7684\u901a\u77e5\u5b58\u5132\u6876\u3002 Alertmanager \u9084\u70ba\u6839\u672c\u6c92\u6709\u5340\u57df\u6a19\u7c64\u7684\u8b66\u5831\u5275\u5efa\u4e00\u500b\u5b58\u5132\u6876\uff08Alertmanager \u5c07\u5176\u89e3\u91cb\u70ba\u597d\u50cf\u6a19\u7c64\u5b58\u5728\uff0c\u4f46\u6709\u4e00\u500b\u7a7a\u5b57\u7b26\u4e32\u4f5c\u70ba\u503c\uff09\u3002\u7d44\u7279\u5b9a\u7684\u95be\u503c\uff0c\u4f8b\u5982 group_wait \uff0c\u73fe\u5728\u5206\u5225\u61c9\u7528\u65bc\u6bcf\u500b\u901a\u77e5\u6876\uff01\u56e0\u6b64\uff0c\u901a\u77e5\u7684\u89f8\u767c\u983b\u7387\u53ef\u80fd\u6703\u964d\u4f4e\uff08\u8207\u672a\u6307\u5b9a\u4efb\u4f55 group_by \u7684\u60c5\u6cc1\u76f8\u6bd4\uff09\uff0c\u56e0\u70ba\u5b58\u5132\u6876\u201c\u66f4\u5c0f\u201d\uff0c\u4e26\u4e14\u901a\u77e5\u7684\u5167\u5bb9\u6703\u66f4\u5c0f\uff08\u5217\u8868\u5c07\u5305\u542b\u66f4\u5c11\u7684\u8b66\u5831\uff09\u3002 \u5982\u679c\u60a8\u6307\u5b9a\u985e\u4f3c group_by: [region, env] \u7684\u5167\u5bb9\uff08\u5373\u6578\u7d44\u4e2d\u7684\u591a\u500b\u5143\u7d20\uff09\uff0c\u5247 Alertmanager \u5c07\u70ba\u9019\u4e9b\u7d66\u5b9a\u6a19\u7c64\u7684\u503c\u7684\u6bcf\u500b\u53ef\u80fd\u7d44\u5408\u5275\u5efa\u4e00\u500b\u901a\u77e5\u6876\u3002\u56e0\u6b64\uff0c\u5982\u679c\u60a8\u7684\u7cfb\u7d71\u6709 3 \u500b\u5340\u57df\u548c 2 \u500b\u74b0\u5883\uff0c\u60a8\u6700\u591a\u53ef\u4ee5\u6709 3*2 = 6 \u500b\u901a\u77e5\u6876\u3002 Dashboards \u00b6 \u5728\u76e3\u63a7\u4e16\u754c\u4e2d\uff0c\u5100\u8868\u677f\u662f\u55ae\u500b\u5716\u5f62\u7684\u96c6\u5408\uff0c\u6392\u5217\u70ba\u591a\u884c\u548c\u591a\u5217\u7684\u5716\u584a\u3002\u5728 Prometheus \u5806\u68e7\u4e2d\uff0cGrafana \u662f\u69cb\u5efa\u5100\u8868\u677f\u7684\u9996\u9078\uff0cGrafana \u7684\u793e\u5340\u7dad\u8b77\u8457\u4e00\u500b\u9f90\u5927\u7684\u5373\u7528\u578b\u5100\u8868\u677f\u6a21\u677f\u5b58\u5132\u5eab\u3002 \u64c1\u6709\u4e00\u500b\uff08\u6216\u591a\u500b\uff09\u5100\u8868\u677f\u53ef\u5e6b\u52a9\u60a8\u67e5\u660e\u554f\u984c\u3002\u4f5c\u70ba\u4eba\u985e\uff0c\u6211\u5011\u5728\u89e3\u91cb\u5716\u8868\u65b9\u9762\u6bd4\u67e5\u770b\u5927\u91cf\u6578\u5b57\u66f4\u6709\u6548\u3002\u5100\u8868\u677f\u7684\u76ee\u7684\u662f\u5e6b\u52a9\u60a8\u8a3a\u65b7\u60a8\u6536\u5230\u8b66\u5831\u901a\u77e5\u7684\u554f\u984c\u7684\u6839\u672c\u539f\u56e0\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u5100\u8868\u677f\u4e0d\u662f\u8b66\u5831\u7684\u624b\u6bb5\uff01\u60a8\u61c9\u8a72\u907f\u514d\u4f7f\u7528\u5fc5\u9808\u4e00\u76f4\u76ef\u8457\u7684\u5100\u8868\u677f\uff0c\u4ee5\u78ba\u5b9a\u662f\u5426\u6709\u554f\u984c\u3002\u8b93\u8b66\u5831\u4ee3\u66ff\u9019\u9805\u5de5\u4f5c\u3002 \u5100\u8868\u677f\u7684\u7d44\u6210\u5c31\u50cf\u4e00\u9580\u85dd\u8853\uff0c\u9700\u8981\u76f8\u7576\u591a\u7684\u601d\u8003\u3002\u7531\u65bc\u5404\u7a2e\u539f\u56e0\uff0c\u4f8b\u5982\u6027\u80fd\u4e0d\u4f73\u548c\u7f3a\u4e4f\u6982\u89bd\uff0c\u64c1\u6709\u5305\u542b 20 \u500b\u6216\u66f4\u591a\u5716\u8868\u7684\u5927\u578b\u5100\u8868\u677f\u662f\u6c92\u6709\u610f\u7fa9\u7684\u3002\u67e5\u770b\u4e00\u822c\u7684\u201c\u5100\u8868\u677f\u8a2d\u8a08\u539f\u5247\u201d\uff0c\u6216\u5177\u9ad4\u7684\u6700\u4f73\u5be6\u8e10\u6307\u5357\uff0c\u4f8b\u5982\u672c\u6307\u5357\u3002\u60a8\u901a\u5e38\u6700\u7d42\u6703\u69cb\u5efa\u591a\u500b\u5100\u8868\u677f\uff0c\u6bcf\u500b\u5100\u8868\u677f\u90fd\u91dd\u5c0d\u7279\u5b9a\u53d7\u773e\u95dc\u8a3b\u4e00\u500b\u7279\u6b8a\u4e3b\u984c\u3002 \u7d50\u8ad6 \u00b6 \u8853\u8a9e\u548c\u6982\u5ff5\u7684\u89e3\u91cb\u6709\u671b\u5e6b\u52a9\u60a8\u958b\u59cb\u66f4\u8a73\u7d30\u5730\u63a2\u7d22 Prometheus\u3002\u4e0b\u4e00\u500b\u5408\u4e4e\u908f\u8f2f\u7684\u6b65\u9a5f\u662f\u5728 PromQL \u4e2d\u7de8\u5beb\u8b66\u5831\uff08\u548c\u8a18\u9304\uff09\u898f\u5247\uff0c\u5c07\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u4ecb\u7d39\u3002 \u8003\u616e\u5230\u66f4\u7cbe\u7149\u7684\u8853\u8a9e\uff0c\u8b93\u6211\u7e3d\u7d50\u4e00\u4e0b\u6709\u6548\u5de5\u4f5c\u6d41\u7a0b\u7684\u57fa\u672c\u601d\u60f3\uff0c\u4ee5\u6aa2\u6e2c\u548c\u4fee\u5fa9 Prometheus \u5806\u68e7\u7684\u554f\u984c\uff1a \u901a\u904e\u9078\u64c7\u548c\u6293\u53d6\u8a31\u591a\u7b2c\u4e09\u65b9 exporter\uff08\u5c0d\u65bc\u60a8\u6b63\u5728\u4f7f\u7528\u7684\u7b2c\u4e09\u65b9\u670d\u52d9\uff0c\u4f8b\u5982\u6578\u64da\u5eab\u6216\u6d88\u606f\u968a\u5217\uff09\uff0c\u9078\u64c7\u8981\u5b58\u5132\u5728 Prometheus \u7684 TSDB \u4e2d\u7684\u5927\u91cf\u6307\u6a19\u3002\u6b64\u5916\uff0c\u70ba\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u6e2c\u91cf\u6307\u6a19\u3002\u60a8\u5b58\u5132\u7684\u6307\u6a19\u8d8a\u591a\u8d8a\u597d\uff0c\u56e0\u70ba\u5b83\u5011\u53ef\u80fd\u662f\u8a3a\u65b7\u554f\u984c\u7684\u95dc\u9375\uff08\u5728\u6b65\u9a5f 3 \u4e2d\uff09\u3002\u6b64\u5916\uff0c\u5728 Grafana \u7684\u9810\u88fd\u5100\u8868\u677f\u76ee\u9304\u7684\u5e6b\u52a9\u4e0b\uff0c\u70ba\u9019\u4e9b\u6307\u6a19\u7684\u5b50\u96c6\u69cb\u5efa\u5100\u8868\u677f\u3002 \u53ea\u914d\u7f6e\u4e00\u4e9b\u8b66\u5831\u898f\u5247\uff0c\u6307\u793a\u8981\u76e3\u63a7\u7684\u554f\u984c\uff08\u6216\u8005\u5f88\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u51fa\u73fe\u554f\u984c\uff09\u3002\u5982\u679c\u60a8\u6709\u592a\u591a\u8b66\u5831\u898f\u5247\uff0c\u60a8\u5c07\u6536\u5230\u592a\u591a\u8b66\u5831\u901a\u77e5\uff0c\u4e26\u4e14\u5f88\u53ef\u80fd\u4f60\u6703\u5c07\u5b83\u5011\u4f5c\u70ba\u5783\u573e\u90f5\u4ef6\u4e1f\u68c4\u3002 \u6536\u5230\u8b66\u5831\u901a\u77e5\u5f8c\uff0c\u8acb\u6253\u958b\u5100\u8868\u677f\u4ee5\u66f4\u6e96\u78ba\u5730\u8a3a\u65b7\u554f\u984c\u3002","title":"Part 3. Prometheus & Alertmanager \u57fa\u672c\u6982\u5ff5"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#prometheus-alertmanager","text":"\u539f\u6587: Kubernetes Observability \u2013 Part III: Prometheus & Alertmanager basic concepts \u672c\u6587\u5e6b\u52a9\u60a8\u4e86\u89e3\u57fa\u672c\u7684 Alertmanager \u548c Prometheus \u6982\u5ff5\uff0c\u4f8b\u5982\u6307\u6a19\u3001\u6642\u9593\u5e8f\u5217\u3001\u793a\u4f8b\u3001\u8b66\u5831\u548c\u8b66\u5831\u901a\u77e5\u3002\u540c\u6642\u9084\u89e3\u91cb\u4e86\u6307\u6a19\u6578\u64da\u5728\u6982\u5ff5\u4e0a\u662f\u5982\u4f55\u5b58\u5132\u7684\u3001\u61c9\u8a72\u5982\u4f55\u6aa2\u6e2c\u61c9\u7528\u7a0b\u5e8f\u4ee5\u53ca\u5100\u8868\u677f\u7684\u57fa\u672c\u6982\u5ff5\u3002","title":"Prometheus &amp; Alertmanager \u57fa\u672c\u6982\u5ff5"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#_1","text":"Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c\u53ef\u89c0\u5bdf\u6027\u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u4e00\u500b\u91cd\u8981\u7684\u6b65\u9a5f\uff08\u5728\u6280\u8853\u8ecc\u9053\u4e0a\uff09\u662f\u4e86\u89e3\u57fa\u672c\u7684 Prometheus \u6982\u5ff5\u548c\u8853\u8a9e\u3002\u60a8\u9700\u8981\u5f88\u597d\u5730\u638c\u63e1\u5b83\u5011\uff0c\u624d\u80fd\u771f\u6b63\u4f7f\u7528 PromQL \u69cb\u5efa\u8b66\u5831\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86\u57fa\u672c\u6982\u5ff5\uff0c\u4f8b\u5982\u6307\u6a19\uff08\u4ee5\u53ca\u4e0d\u540c\u7684\u6307\u6a19\u985e\u578b\uff09\u3001\u6642\u9593\u5e8f\u5217\u3001\u6a23\u672c\u3001\u6578\u64da\u7684\u5b58\u5132\u65b9\u5f0f\u3001\u6aa2\u6e2c\u3001\u6a19\u7c64\u3001\u8b66\u5831\u548c\u8b66\u5831\u901a\u77e5\u4ee5\u53ca\u5100\u8868\u677f\u3002 \u6211\u5efa\u8b70\u60a8\u5f9e\u73fe\u5728\u958b\u59cb\u8457\u624b\u5be6\u969b\u4f7f\u7528 Prometheus \u5806\u68e7\u3002\u8981\u555f\u52d5\u4e26\u904b\u884c\u5b83\uff0c\u60a8\u6709\u591a\u7a2e\u9078\u64c7\uff1a \u4f7f\u7528\u7b2c\u4e09\u65b9\u6f14\u793a\u7cfb\u7d71\uff0c\u4f8b\u5982 http://demo.robustperception.io \u6216 https://demo.promlens.com - \u60a8\u7121\u9700\u5728\u672c\u5730\u8a2d\u7f6e\u4efb\u4f55\u5167\u5bb9\uff0c\u4f46\u60a8\u7121\u6cd5\u5f71\u97ff\u6216\u66f4\u6539\u9019\u4e9b\u7cfb\u7d71\u4e0a\u7684\u4efb\u4f55\u5167\u5bb9\u3002 \u57fa\u65bc\u672c\u5730 Docker (compose) \u7684\u5806\u68e7\uff0c\u53c3\u898b\u4f8b\u5982\u9019\u91cc\u6216\u9019\u88e1\u7684\u6a21\u677f\u3002\u5982\u679c\u60a8\u5728\u4e3b\u6a5f\u4e0a\u672c\u5730\u904b\u884c Linux\uff0c\u9019\u662f\u5b8c\u7f8e\u7684\u89e3\u6c7a\u65b9\u6848\u3002\u4f46\u662f\uff0c\u5982\u679c\u60a8\u5728\u4e3b\u6a5f\u4e0a\u4f7f\u7528 Windows \u6216 macOS\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u6b64 Docker-compose \u8a2d\u7f6e\u7684\u7bc0\u9ede\u5c0e\u51fa\u5668\u4e0d\u6703\u6355\u7372\u5be6\u969b Windows/macOS \u4e3b\u6a5f\u7684\u6307\u6a19\uff0c\u800c\u662f Docker \u5bb9\u5668\u6240\u5728\u7684 VM\u8dd1\u6b65\u3002\u6539\u7528\u88f8\u6a5f\u9078\u9805\u53ef\u80fd\u6703\u66f4\u597d\u3002 \u672c\u5730\u88f8\u6a5f\u5b89\u88dd\uff1a\u4e0b\u8f09\u5404\u500b\u61c9\u7528\u7a0b\u5e8f\u4e8c\u9032\u88fd\u6587\u4ef6\uff08Prometheus\u3001Alertmanager\u3001Grafana\u3001Pushgateway\u3001\u7bc0\u9ede\u5c0e\u51fa\u5668\u7b49\uff09\u4e26\u624b\u52d5\u5b89\u88dd\u3002\u9019\u5c07\u82b1\u8cbb\u6700\u9577\u7684\u6642\u9593\uff0c\u4f46\u6703\u6559\u60a8\u6700\u591a\u6709\u95dc\u61c9\u7528\u7a0b\u5e8f\u914d\u7f6e\u7684\u4fe1\u606f\u3002 \u5728\u672c\u5730\u7684 K8S \u4e2d\u4f7f\u7528 Helm chart \u5b89\u88dd","title":"\u4ecb\u7d39"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#_2","text":"","title":"\u6307\u6a19\u3001\u6642\u9593\u5e8f\u5217\u3001\u6a23\u672c\u548c\u5b58\u5132"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#_3","text":"\u5728\u672c\u7cfb\u5217\u7684\u524d\u5e7e\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u89e3\u91cb\u4e86\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff08\u4ee5\u53ca\u7b2c\u4e09\u65b9\u5c0e\u51fa\u5668\uff09\u516c\u958b\u201c\u6307\u6a19\u6578\u64da\u201d\uff0c\u901a\u904e HTTP \u5728 /metrics \u7aef\u9ede\u4e0a\u4ee5\u201cPrometheus \u683c\u5f0f\u201d\u63d0\u4f9b\u5b83\u5011\uff0c\u6bcf\u884c\u4e00\u500b\u6307\u6a19\u3002\u4f7f\u7528\u7684\u8853\u8a9e\uff0c\u5982\u201c\u6307\u6a19\u201d\u6216\u201c\u6307\u6a19\u6578\u64da\u201d\uff0c\u5be6\u969b\u4e0a\u4e26\u4e0d\u7cbe\u78ba\u2014\u2014\u9019\u88e1\u6709\u4e00\u4e9b\u5340\u5225\u3002\u8b93\u6211\u5011\u9996\u5148\u67e5\u770b Prometheus \u672c\u8eab\u7684 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\u7247\u6bb5\uff08\u55ae\u64ca\u6b64\u8655\u67e5\u770b\u5b8c\u6574\u8f38\u51fa\uff09\uff1a # HELP net_conntrack_dialer_conn_attempted_total Total number of connections attempted by the given dialer a given name. # TYPE net_conntrack_dialer_conn_attempted_total counter net_conntrack_dialer_conn_attempted_total { dialer_name = \"alertmanager\" } 2 net_conntrack_dialer_conn_attempted_total { dialer_name = \"node\" } 1 net_conntrack_dialer_conn_attempted_total { dialer_name = \"prometheus\" } 1 net_conntrack_dialer_conn_attempted_total { dialer_name = \"pushgateway\" } 1 ... # HELP go_memstats_mspan_sys_bytes Number of bytes used for mspan structures obtained from system. # TYPE go_memstats_mspan_sys_bytes gauge go_memstats_mspan_sys_bytes 8 .699904e+06 ... # HELP prometheus_http_response_size_bytes Histogram of response size for HTTP requests. # TYPE prometheus_http_response_size_bytes histogram prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"100\" } 1342 prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"1000\" } 1342 prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"10000\" } 1342 prometheus_http_response_size_bytes_bucket { handler = \"/\" ,le = \"+Inf\" } 1342 prometheus_http_response_size_bytes_sum { handler = \"/\" } 38918 prometheus_http_response_size_bytes_count { handler = \"/\" } 1342 ... # HELP prometheus_rule_evaluation_duration_seconds The duration for a rule to execute. # TYPE prometheus_rule_evaluation_duration_seconds summary prometheus_rule_evaluation_duration_seconds { quantile = \"0.5\" } 4 .4054e-05 prometheus_rule_evaluation_duration_seconds { quantile = \"0.9\" } 7 .1597e-05 prometheus_rule_evaluation_duration_seconds { quantile = \"0.99\" } 0 .00017088 prometheus_rule_evaluation_duration_seconds_sum 2 .8554187595358095e+06 prometheus_rule_evaluation_duration_seconds_count 2 .539804519e+09 ... \u5230\u76ee\u524d\u70ba\u6b62\uff0c\u6211\u5011\u6240\u8aaa\u7684\u201c\u6307\u6a19\u201d\u6216\u201c\u6307\u6a19\u6578\u64da\u201d\u6709\u4e00\u4e9b\u5fae\u5999\u7684\u8853\u8a9e\u3002\u4f7f\u7528\u4e0a\u9762\u7684\u793a\u4f8b\u8f38\u51fa\uff1a \u6642\u9593\u5e8f\u5217(time series) \u985e\u4f3c\u65bc net_conntrack_dialer_conn_attempted_total{dialer_name=\"alertmanager\"} \u6216 prometheus_rule_evaluation_duration_seconds_count \u3002\u57fa\u672c\u4e0a\u6240\u6709\u5167\u5bb9\u90fd\u662f\u4e00\u500b\u6642\u9593\u5e8f\u5217\uff0c\u5982\u679c\u60a8\u5728 Prometheus \u67e5\u8a62\u7a97\u53e3\u4e2d\u5c07\u5176\u4f5c\u70ba\u67e5\u8a62\u8f38\u5165\uff0c\u5247\u6703\u7522\u751f\u55ae\u884c\u8f38\u51fa\u3002 \u6307\u6a19(metric) \u985e\u4f3c\u65bc net_conntrack_dialer_conn_attempted_total \u6216 prometheus_http_response_size_bytes \uff0c\u6216\u9075\u5faa # TYPE <metric name> <metric type> \u5f62\u5f0f\u7684\u4efb\u4f55\u5176\u4ed6\u5167\u5bb9\u3002\u4e00\u500b\u6307\u6a19\u7d50\u5408\u4e86\u4e00\u500b\uff08\u6216\u591a\u500b\uff09\u6642\u9593\u5e8f\u5217\u3002 \u6642\u9593\u5e8f\u5217\u4e4b\u6240\u4ee5\u5f97\u540d\uff0c\u662f\u56e0\u70ba\u5b83\u7531\u4e00\u7cfb\u5217\" \u6a23\u672c(sample) \"\u7d44\u6210\u3002\u6a23\u672c\u662f\u5b58\u5132\u5728 TSDB \u4e2d\u7684\u5be6\u969b\u6578\u64da\u9ede\u3002\u6a23\u672c\u5177\u6709\u6642\u9593\u6233\uff08\u6beb\u79d2\u7cbe\u5ea6\uff09\u548c 64 \u4f4d\u6d6e\u9ede\u503c\u3002 \u6ce8\u610f\uff1a\u5118\u7ba1\u4e0a\u9762\u793a\u4f8b\u8f38\u51fa\u4e2d\u7684\u67d0\u4e9b\u503c\u770b\u8d77\u4f86\u50cf\u6574\u6578\uff0c\u4f46\u5b83\u5011\u5be6\u969b\u4e0a\u662f\u6d6e\u9ede\u6578\uff0c\u4e26\u4e14\u5b83\u5011\u662f\u9019\u6a23\u8655\u7406\u548c\u5b58\u5132\u7684\uff01 \u5f9e\u6307\u6a19\u4e2d\u8fa8\u5225\u6642\u9593\u5e8f\u5217\u4e26\u4e0d\u7e3d\u662f\u53ef\u884c\u7684\u3002\u4f8b\u5982\uff0c\u6c92\u6709\u6a19\u7c64\u7684\u985e\u578b gauge \u7684\u5ea6\u91cf\uff0c\u4f8b\u5982 go_memstats_mspan_sys_bytes\uff0c\u8853\u8a9e\u6642\u9593\u5e8f\u5217\u548c\u5ea6\u91cf\u78ba\u5be6\u6307\u7684\u662f\u540c\u4e00\u4ef6\u4e8b\u3002","title":"\u8853\u8a9e\u89e3\u8aaa"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#metric-types","text":"\u6b63\u5982\u4e0a\u9762\u7684\u793a\u4f8b\u8f38\u51fa\u6240\u793a\uff0cPrometheus \u6709\u5e7e\u7a2e\u985e\u578b\u7684\u6307\u6a19\uff08 \u5b98\u65b9\u6587\u6a94 \uff09: Counter Gauge Histogram Summary Counter \u6307\u6a19\u662f\u4e00\u500b\u7c21\u55ae\u7684\u6578\u5b57\uff0c\u53ef\u4ee5\u8a08\u7b97\u4e00\u4e9b\u6771\u897f\u3002\u793a\u4f8b\u5305\u62ec\u5411\u61c9\u7528\u7a0b\u5e8f\u767c\u51fa\u7684\u8acb\u6c42\u6578\u3001\u5df2\u5b8c\u6210\u6216\u5931\u6557\u7684\u4f5c\u696d\u6578\u7b49 - \u4f8b\u5982\uff1a net_conntrack_dialer_conn_attempted_total{dialer_name=\"alertmanager\"} 2 \u7576\u751f\u6210\u6b64\u6307\u6a19\u7684\u61c9\u7528\u7a0b\u5e8f\u904b\u884c\u6642\uff0c\u8a08\u6578\u5668\u7684\u503c\u9700\u8981\u55ae\u8abf\u589e\u52a0\uff08\u5c07\u8a08\u6578\u5668\u7684\u503c\u4fdd\u5b58\u5728\u6613\u5931\u6027\u5167\u5b58\u4e2d\uff09\u3002\u4f46\u662f\uff0c\u5982\u679c\u61c9\u7528\u7a0b\u5e8f\u91cd\u65b0\u555f\u52d5\uff0c\u5247\u5141\u8a31\u91cd\u7f6e\u8a08\u6578\u5668\uff08\u56e0\u6b64\u5176\u503c\u5c07\u6e1b\u5c0f\uff09\uff0c\u5f9e\u800c\u4e1f\u5931\u5167\u5b58\u4e2d\u4fdd\u5b58\u7684\u5148\u524d\u8a08\u6578\u5668\u7684\u503c\u3002 Prometheus \u7684\u6293\u53d6\u7a0b\u5e8f\u53ef\u4ee5\u667a\u80fd\u5730\u8655\u7406\u6b64\u985e\u91cd\u7f6e\u3002\u4f8b\u5982\uff0c\u5982\u679c Prometheus \u6293\u53d6\u4e00\u7cfb\u5217\u6a23\u672c\u503c\uff0c\u4f8b\u5982 1\u30014\u30016\u30012\uff0c\u5b83\u5be6\u969b\u4e0a\u6703\u5c07 1\u30014\u30016\u30018 \u5b58\u5132\u5728 TSDB \u4e2d\u3002 \u8207 Counter \u4e00\u6a23\uff0cGauge \u6307\u6a19\u662f\u4e00\u500b\u7c21\u55ae\u7684\u6578\u5b57\uff0c\u4f46\u5b83\u53ef\u4ee5\u96a8\u6642\u9593\u4efb\u610f\u4e0a\u4e0b\u6ce2\u52d5\u3002\u6b63\u5982\u6587\u6a94\u6240\u89e3\u91cb\u7684\u90a3\u6a23\uff0cGauge \u901a\u5e38\u7528\u65bc\u6e2c\u91cf\u67d0\u7a2e\u6578\u503c\u7576\u4e0b\u7684\u503c\uff0c\u4f8b\u5982\u6eab\u5ea6\u6216\u7576\u524d\u5167\u5b58\u4f7f\u7528\u60c5\u6cc1\uff0c\u4f46\u4e5f\u7528\u65bc\u53ef\u4ee5\u4e0a\u4e0b\u6ce2\u52d5\u7684\u201c\u8a08\u6578\u201d\uff0c\u4f8b\u5982\u4f75\u767c\u8acb\u6c42\u7684\u6578\u91cf\u3002 \u6b63\u5982\u5b98\u65b9\u6587\u6a94\u6240\u8ff0\uff1a\u76f4\u65b9\u5716\u5c0d\u89c0\u5bdf\u7d50\u679c\u9032\u884c\u63a1\u6a23\uff08\u901a\u5e38\u662f\u8acb\u6c42\u6301\u7e8c\u6642\u9593\u6216\u97ff\u61c9\u5927\u5c0f\u7b49\uff09\uff0c\u4e26\u5c07\u5b83\u5011\u8a08\u5165\u53ef\u914d\u7f6e\u7684\u5b58\u5132\u6876\u4e2d\u3002\u5b83\u9084\u63d0\u4f9b\u6240\u6709\u89c0\u5bdf\u503c\u7684\u7e3d\u548c\u3002 \u57fa\u672c\u6307\u6a19\u540d\u7a31\u70ba \u7684\u76f4\u65b9\u5716\u5728\u4e00\u6b21\u6293\u53d6\u671f\u9593\u516c\u958b\u4e86\u591a\u500b\u6642\u9593\u5e8f\u5217\uff1a \u89c0\u5bdf\u6876\u7684\u7d2f\u7a4d\u8a08\u6578\u5668\uff0c\u986f\u793a\u70ba <basename>_bucket{le=\"<upper inclusive bound>\"} - \u201cle\u201d\u4ee3\u8868\u201c\u5c0f\u65bc\u6216\u7b49\u65bc\u201d \u6240\u6709\u89c0\u5bdf\u503c\u7684\u7e3d\u548c\uff0c\u986f\u793a\u70ba <basename>_sum \u5df2\u89c0\u5bdf\u5230\u7684\u4e8b\u4ef6\u8a08\u6578\uff0c\u986f\u793a\u70ba <basename>_count \uff08\u8207 <basename>_bucket{le=\"+Inf\"} \u76f8\u540c\uff09 \u8b93\u6211\u5011\u4f7f\u7528\u9019\u4e9b\u77e5\u8b58\u4f86\u89e3\u91cb\u4e0a\u9762\u793a\u4f8b\u7247\u6bb5\u4e2d\u7684 prometheus_http_response_size_bytes_bucket \u76f4\u65b9\u5716\u6307\u6a19\uff1a prometheus_http_response_size_bytes_bucket{handler=\"/\",le=\"100\"} 1342 \u884c\u544a\u8a34\u6211\u5011\uff0c\u6709 1342 \u500b\u5c0d Prometheus \u7684\u201c/\u201d\u8655\u7406\u7a0b\u5e8f\u7684\u8acb\u6c42\uff0c\u7522\u751f\u5927\u5c0f\u5c0f\u65bc\u6216\u7b49\u65bc 100 \u5b57\u7bc0\u7684 HTTP \u97ff\u61c9\u3002 \u5176\u4ed6 _bucket \u884c\u5177\u6709\u76f8\u540c\u7684\u503c (1342)\u3002\u7531\u65bc Prometheus \u76f4\u65b9\u5716\u662f\u7d2f\u7a4d\u7684\uff0c\u9019\u544a\u8a34\u6211\u5011\u6c92\u6709\u4efb\u4f55\u5c0d Prometheus \u7684\u201c/\u201d\u8655\u7406\u7a0b\u5e8f\u7684\u8acb\u6c42\u7522\u751f\u5927\u65bc 100 \u5b57\u7bc0\u7684\u97ff\u61c9\u5927\u5c0f\u3002 prometheus_http_response_size_bytes_count{handler=\"/\"} 1342 \u9019\u4e00\u884c\u544a\u8a34\u6211\u5011\uff0c\u7e3d\u5171\u6709 1342 \u500b\u5c0d Prometheus \u7684\u201c/\u201d\u8655\u7406\u7a0b\u5e8f\u7684\u8acb\u6c42\u3002 prometheus_http_response_size_bytes_sum{handler=\"/\"} 38918 \u884c\u544a\u8a34\u6211\u5011\u6240\u6709\u97ff\u61c9\u5927\u5c0f\uff08\u6240\u6709 1342 \u500b\u8acb\u6c42\uff09\u7684\u7e3d\u548c\u70ba 38918 \u5b57\u7bc0\u3002\u56e0\u6b64\uff0c\u5982\u679c\u6211\u5011\u5c0d\u5b83\u611f\u5230\u597d\u5947\uff0c\u6211\u5011\u53ef\u4ee5\u81ea\u5df1\u8a08\u7b97\u5e73\u5747\u97ff\u61c9\u5927\u5c0f\uff08\u56e0\u70ba\u5230\u76ee\u524d\u70ba\u6b62\u6211\u5011\u53ea\u77e5\u9053\u5b83\u5c0f\u65bc\u6216\u7b49\u65bc 100 \u5b57\u7bc0\uff09\uff1a\u53ea\u9700\u8a08\u7b97 38918 / 1342 = 29 \u500b\u5b57\u7bc0\u3002 Summary \u6307\u6a19\u8207 Histogram \u6307\u6a19\u975e\u5e38\u76f8\u4f3c\uff0c\u4f46\u5b83\u7522\u751f \u5206\u4f4d\u6578 \uff08\u5728\u6ed1\u52d5\u6642\u9593\u7a97\u53e3\u4e0a\uff09\u800c\u4e0d\u662f\u7d2f\u7a4d\u7bb1/\u6876\u3002\u6709\u95dc\u5206\u4f4d\u6578\u7684\u8a73\u7d30\u8aaa\u660e\uff0c\u4ee5\u53ca\u4f55\u6642\u4f7f\u7528\u6458\u8981\u8207\u76f4\u65b9\u5716\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002 \u5206\u6790\u6211\u5011\u4e0a\u9762\u7684\u4f8b\u5b50\uff08prometheus_rule_evaluation_duration_seconds\uff09\uff0c\u6211\u5011\u770b\u5230\uff1a \u4e00\u534a (50%) \u7684\u898f\u5247\u8a55\u4f30\u6700\u591a\u9700\u8981 0.000044054 \u79d2 (0.044054 ms) - \u53e6\u4e00\u534a\u9700\u8981\u66f4\u9577\u7684\u6642\u9593 \u6700\u6162\u7684 10% \u7684\u898f\u5247\u8a55\u4f30\u6700\u591a\u9700\u8981 0.000071597 \u79d2 \u6700\u6162\u7684 1% \u7684\u898f\u5247\u8a55\u4f30\u6700\u591a\u9700\u8981 0.00017088 \u79d2 \u7e3d\u9ad4\u800c\u8a00\uff0c\u8a55\u4f30\u898f\u5247\u82b1\u8cbb\u4e86 2.8554187595358095e+06 \u79d2\uff08\u7d04 33 \u5929\uff09 \u5230\u76ee\u524d\u70ba\u6b62\uff0c\u6b64\u51fa\u53e3\u5546\u5df2\u5b8c\u6210 2.539804519e+09 \u6b21\u89c0\u5bdf\uff08\u898f\u5247\u8a55\u4f30\u6301\u7e8c\u6642\u9593\u6e2c\u91cf\uff09 \u57fa\u65bc\u4e0a\u8ff0\u6307\u6a19\u985e\u578b\uff0c\u60a8\u5728\u5be6\u8e10\u4e2d\u7d93\u5e38\u6703\u767c\u73fe\u53e6\u5916\u5169\u7a2e\uff08\u76f8\u7576\u672a\u8a18\u9304\u7684\uff09\u6307\u6a19\u985e\u578b\uff1a Enum Info \u7531\u65bc Prometheus \u50c5\u652f\u6301\u6d6e\u9ede\u503c\uff0c\u60a8\u53ef\u80fd\u60f3\u77e5\u9053\u5982\u4f55\u8868\u793a\u5b57\u7b26\u4e32\u503c\u3002\u679a\u8209\u6307\u6a19\u662f\u4e00\u7a2e\u53ef\u4ee5\u8b93\u60a8\u505a\u5230\u9019\u4e00\u9ede\u7684\u65b9\u6cd5\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u5275\u5efa\u4e00\u500b\u540d\u70ba my_app_state \u7684\u6307\u6a19\uff0c\u5b83\u53ef\u4ee5\u63a1\u7528\u201cstarting\u201d\u3001\u201crunning\u201d\u6216\u201cerror\u201d\u503c\u3002 \u60a8\u61c9\u8a72\u907f\u514d\u4f7f\u7528\u55ae\u4e00\u8a08\u91cf\u6307\u6a19\uff0c\u5c07\u4efb\u610f\u6578\u503c\u5206\u914d\u7d66\u72c0\u614b\uff08\u4f8b\u5982 1=starting\u30012=running\u30013=error\uff09\uff0c\u56e0\u70ba\u9019\u6a23\u60a8\u5c31\u4e0d\u80fd\u518d\u4f7f\u7528 PromQL \u4f86\u805a\u5408\u503c\uff08\u4f8b\u5982\u8b93 PromQL \u78ba\u5b9a\u201c\u904b\u884c\u201d\u5be6\u4f8b\u7684\u6578\u91cf\uff09\u3002 \u76f8\u53cd\uff0c\u5275\u5efa\u8207\u72c0\u614b\u4e00\u6a23\u591a\u7684\u6642\u9593\u5e8f\u5217\u985e\u578b\u8a08\u91cf\u5668\uff08\u6b64\u8655\uff1a3\uff09\uff0c\u5c07\u5b57\u7b26\u4e32\u503c\u5be6\u73fe\u70ba\u6a19\u7c64\uff0c\u4e26\u5206\u914d\u5e03\u723e\u503c\uff081=true\uff0c0=false\uff09\u3002\u5728\u4efb\u4f55\u7d66\u5b9a\u6642\u9593\uff0c\u53ea\u6709\u4e00\u500b\u6642\u9593\u5e8f\u5217\u7684\u503c\u53ef\u80fd\u70ba 1\u3002\u4ee5\u4e0b\u662f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684 /metrics \u7aef\u9ede\u53ef\u80fd\u8fd4\u56de\u7684\u793a\u4f8b\uff08\u60a8\u70ba\u6b64\u5275\u5efa\u4e86 my_app_state \u679a\u8209\u6307\u6a19\uff09\uff1a # HELP my_app_state The state of your application # TYPE my_app_state gauge my_app_state { state = \"starting\" } 1 my_app_state { state = \"running\" } 0 my_app_state { state = \"error\" } 0 \u7531\u65bc\u8a2d\u7f6e\u65b0\u7684\u679a\u8209\u6307\u6a19\u503c\u4e0d\u518d\u662f\u539f\u5b50\u64cd\u4f5c\uff0c\u56e0\u6b64\u60a8\u53ef\u80fd\u6703\u9047\u5230\u7af6\u722d\u689d\u4ef6\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0cscrape \u6703\u770b\u5230\u66ab\u6642\u4e0d\u4e00\u81f4\u7684\u72c0\u614b\uff08\u96f6\u500b\u6216\u591a\u500b\u6642\u9593\u5e8f\u5217\u5177\u6709 1\uff09\u3002\u4e00\u4e9b Prometheus SDK \u63d0\u4f9b\u4e86\u7d93\u904e\u5145\u5206\u6e2c\u8a66\u7684 Enum \u6307\u6a19\u5be6\u73fe\uff08\u53c3\u898b\u4f8b\u5982 Python\uff09\u3002\u5982\u679c\u60a8\u9078\u64c7\u7684 SDK \u6c92\u6709\u5be6\u73fe\uff0c\u5247\u8a72\u65b9\u6cd5\u662f\u5be6\u73fe\u4e00\u500b\u81ea\u5b9a\u7fa9\u6536\u96c6\u5668\uff0c\u8a72\u6536\u96c6\u5668\u5728\u5f8c\u53f0\u7ba1\u7406\u8a08\u91cf\u6307\u6a19\uff0c\u5176 set(value) \u65b9\u6cd5\u901a\u904e\u4f7f\u7528\u67d0\u7a2e\u7dda\u7a0b\u540c\u6b65\u539f\u8a9e\uff08\u4f8b\u5982\u4f5c\u70ba\u4e92\u65a5\u9ad4\uff09\u540c\u6b65\u8b80\u53d6\u548c\u5beb\u5165\u8acb\u6c42\u3002 \u8207 enum \u6307\u6a19\u985e\u4f3c\uff0cinfo \u6307\u6a19\u4e5f\u5141\u8a31\u60a8\u8868\u9054\u5b57\u7b26\u4e32\u503c\uff0c\u5373\u4f7f Prometheus \u50c5\u63d0\u4f9b\u6d6e\u9ede\u503c\u3002\u4fe1\u606f\u5ea6\u91cf\u7684\u60f3\u6cd5\u662f\u516c\u958b\u4efb\u4f55\u985e\u578b\u7684\u69cb\u5efa\u4fe1\u606f\uff0c\u4f8b\u5982\u7248\u672c\u6216\u69cb\u5efa\u865f\u3002\u8207\u5c07\u9019\u4e9b\u4fe1\u606f\u5197\u9918\u5730\u6dfb\u52a0\u5230\u5176\u4ed6\u73fe\u6709\u6307\u6a19\u76f8\u6bd4\uff0c\u5c07\u9019\u4e9b\u4fe1\u606f\u653e\u5728\u55ae\u7368\u7684\u4fe1\u606f\u6307\u6a19\u4e2d\u66f4\u5177\u6210\u672c\u6548\u76ca\u3002 \u4ee5\u4e0b\u662f Info \u6307\u6a19\u7684\u793a\u4f8b\uff1a # HELP python_info Python platform information # TYPE python_info gauge python_info { implementation = \"CPython\" ,major = \"3\" ,minor = \"6\" ,patchlevel = \"7\" ,version = \"3.6.7\" } 1 \u5982\u60a8\u6240\u898b\uff0c\u4fe1\u606f\u6307\u6a19\u7684\u540d\u7a31\u5177\u6709 _info \u5f8c\u7db4\u3002\u60a8\u60f3\u8981\u8868\u9054\u7684\u69cb\u5efa\u4fe1\u606f\u4f4d\u4f5c\u70ba\u6a19\u7c64\u5305\u542b\u5728\u5167\u3002\u8a72\u503c\u53ea\u662f\u4e00\u500b\u865b\u64ec\u503c 1\u3002","title":"\u6307\u6a19\u985e\u578b (Metric types)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#instrumentation","text":"\u5728 Prometheus \u4e16\u754c\u4e2d\uff0c\u201cInstrumentation\u201d \u662f\u6307\u5728\u60a8\u81ea\u5df1\u7684\u4ee3\u78bc\u5eab\u4e2d\u6dfb\u52a0\u984d\u5916\u4ee3\u78bc\u4ee5\u516c\u958b\u6307\u6a19\u6578\u64da\u7684\u904e\u7a0b\u3002\u9019\u4e9b\u6307\u6a19\u7279\u5b9a\u65bc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u3002\u5f9e\u8a9e\u7fa9\u7684\u89d2\u5ea6\u4f86\u770b\uff0c\u5b83\u5011\u53ef\u80fd\u8655\u65bc\u201c\u4f4e\u7d1a\u5225\u201d\uff0c\u4f8b\u5982 HTTP \u8acb\u6c42\u7684\u6578\u91cf\uff08\u5982\u679c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u63d0\u4f9b HTTP\uff09\uff0c\u6216\u8005\u201c\u9ad8\u7d1a\u201d\uff0c\u4f8b\u5982\u7528\u6236\u9ede\u64ca\u89f8\u767c\u61c9\u7528\u7a0b\u5e8f\u67d0\u4e9b\u529f\u80fd\u7684\u7279\u5b9a\u6309\u9215\u7684\u6b21\u6578\u3002\u60a8\u901a\u5e38\u6703\u4f7f\u7528 Prometheus \u793e\u5340\u69cb\u5efa\u7684 Prometheus SDK \u4f86\u5b8c\u6210\u6b64\u4efb\u52d9\uff08\u8acb\u53c3\u95b1\u6b64\u8655\uff09\u3002\u9019\u4e9b SDK \u5be6\u73fe\u4e86\u670d\u52d9\u65bc /metrics \u7aef\u9ede\u7684 HTTP \u670d\u52d9\u5668\uff0c\u4e26\u63d0\u4f9b\u4e86\u7528\u65bc\u5275\u5efa\u4e0d\u540c\u985e\u578b\u7684\u6307\u6a19\u4e26\u66f4\u65b0\u5176\u503c\u7684\u9ad8\u7d1a\u65b9\u6cd5\u3002\u7136\u5f8c\u7531 SDK \u7ba1\u7406\u7684 HTTP \u670d\u52d9\u5668\u516c\u958b\u9019\u4e9b\u6307\u6a19\u3002 \u7576\u6dfb\u52a0\u984d\u5916\u4ee3\u78bc\u4ee5\u516c\u958b\u6307\u6a19\u6578\u64da\u6642\uff0c\u60a8\u5fc5\u9808\u70ba\u6307\u6a19\u672c\u8eab\u5b9a\u7fa9\u5408\u9069\u7684\u540d\u7a31\u3001\u6307\u6a19\u7684\u6a19\u7c64\uff0c\u4e26\u4e14\u60a8\u5fc5\u9808\u78ba\u5b9a\u4f55\u6642\u958b\u59cb\u4e00\u500b\u5168\u65b0\u7684\u6307\u6a19\u8207\u70ba\u73fe\u6709\u6307\u6a19\u5275\u5efa\u984d\u5916\u7684\u6a19\u7c64\u3002\u60a8\u53ef\u4ee5\u9075\u5faa\u4e00\u4e9b\u5e38\u898b\u7684\u624b\u6cd5\uff1a Metric names \u7531\u4e0b\u5283\u7dda\u5206\u9694\u7684\u591a\u500b\u55ae\u8a5e\u7d44\u6210\u3002\u4e00\u500b\u5e38\u7528\u7684\u65b9\u6848\u662f\uff1a <libraryname>_<unit>_<suffix> \u3002 libraryname \u90e8\u5206\u6a19\u8b58\u60a8\u7684\u6307\u6a19\u3002\u5b83\u61c9\u8a72\u8868\u660e\u6307\u6a19\u662f\u95dc\u65bc\u4ec0\u9ebc\u7684\u3002\u60a8\u9084\u61c9\u8a72\u78ba\u4fdd\u5b83\u5728 Prometheus \u751f\u614b\u7cfb\u7d71\u4e2d\u7684\u6240\u6709\u5176\u4ed6\u73fe\u6709\u6307\u6a19\u540d\u7a31\u4e2d\u662f\u552f\u4e00\u7684\u3002\u5b83\u53ef\u80fd\u7531\u591a\u500b\u7528\u4e0b\u5283\u7dda\u5206\u9694\u7684\u55ae\u8a5e\u7d44\u6210\u3002 unit \u985e\u4f3c\u65bc\u201c\u79d2\u201d\u6216\u201c\u5b57\u7bc0\u201d\u3002 suffix \uff1a\u6309\u7167\u6163\u4f8b\uff0cgauge \u6307\u6a19\u5177\u6709\u5f8c\u7db4\u201c_total\u201d\uff0c\u800c counter \u6307\u6a19\u4e0d\u9700\u8981\u5f8c\u7db4\u3002histograms \u548c summary \u6307\u6a19\u6709\u591a\u884c\uff08\u5728 /metrics \u7684\u8f38\u51fa\u4e2d\uff09\uff0c\u5176\u5167\u5bb9\u5404\u4e0d\u76f8\u540c\uff1a\u4e00\u884c\u4ee5 _sum \u7d50\u5c3e\uff0c\u4e00\u884c\u4ee5 _count \u7d50\u5c3e\uff0c\u9084\u6709\u5176\u4ed6\u5e7e\u884c\uff08\u4f8b\u5982\uff0c_bucket{\u2026} \u7528\u65bchistograms\uff09\u3002\u901a\u5e38\uff0cSDK \u6703\u70ba\u60a8\u751f\u6210\u9019\u4e9b\u3002 Label \u5340\u5206\u6307\u6a19\u91cf\u6e2c\u67d0\u7a2e\u4e8b\u7269\u7684\u7279\u5fb5\u3002\u5b83\u5011\u7531\u9375\u548c\u503c\u5b57\u7b26\u4e32\u7d44\u6210\uff0c\u5176\u4e2d\u9375\u53ef\u80fd\u6709\u591a\u500b\u7531\u4e0b\u5283\u7dda\u5206\u9694\u7684\u55ae\u8a5e\u3002\u6211\u5c07\u5728\u4e0b\u9762\u7684\u90e8\u5206\u4e2d\u8a73\u7d30\u4ecb\u7d39\u6a19\u7c64\u3002 \u60a8\u53ef\u80fd\u60f3\u77e5\u9053\uff1a\u4ec0\u9ebc\u6642\u5019\u61c9\u8a72\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6307\u6a19? \u4ec0\u9ebc\u6642\u5019\u61c9\u8a72\u70ba\u73fe\u6709\u6307\u6a19\u6dfb\u52a0\u65b0\u6a19\u7c64? \u6b63\u5982\u672c\u6587\u4e2d\u66f4\u8a73\u7d30\u89e3\u91cb\u7684\u90a3\u6a23\uff0c\u57fa\u672c\u601d\u60f3\u662f\u60a8\u53ef\u4ee5\u4f7f\u7528 PromQL \u4f86\u8a08\u7b97\u6307\u6a19\u7684\u805a\u5408\uff08\u4f8b\u5982\uff0c\u7e3d\u548c\uff0c\u6216\u60a8\u6307\u5b9a\u7684\u6642\u9593\u6bb5\u5167\u7684\u5e73\u5747\u503c\uff09\u3002\u4f46\u662f\uff0c\u9019\u4e9b PromQL \u805a\u5408\u6a5f\u5236\u50c5\u5728\u7279\u5b9a\u6307\u6a19\u5167\u904b\u884c\u826f\u597d\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u60a8\u7e3d\u662f\u5728\u532f\u7e3d\u7279\u5b9a\u6307\u6a19\u7684\u4e0d\u540c\u6a19\u7c64\u3002\u8981\u56de\u7b54\u6700\u521d\u7684\u554f\u984c\uff1a\u60a8\u61c9\u8a72\u7e7c\u7e8c\u5411\u73fe\u6709\u6307\u6a19\u6dfb\u52a0\u6a19\u7c64\uff0c\u53ea\u8981\u9019\u4e9b\u6a19\u7c64\u4e0a\u7684\u805a\u5408\u64cd\u4f5c\uff08\u6c42\u548c\u7b49\uff09\u662f\u6709\u610f\u7fa9\u7684\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u6709\u4e00\u500b\u6307\u6a19 http_requests_total \uff08\u5e36\u6709\u8af8\u5982 path=\"/foo\" \u7b49\u6a19\u7c64\uff09\uff0c\u4e26\u4e14\u73fe\u5728\u60a8\u9084\u60f3\u5305\u62ec\u54ea\u500b\u670d\u52d9\u6b63\u5728\u70ba\u8acb\u6c42\u63d0\u4f9b\u670d\u52d9\uff0c\u8acb\u6dfb\u52a0\u53e6\u4e00\u500b\u6a19\u7c64\uff0c\u4f8b\u5982 service=\"users-directory\" \u8207\u5275\u5efa\u65b0\u6307\u6a19\uff08\u4f8b\u5982 http_requests_users_directory_total \uff09\u76f8\u6bd4\uff0c\u5b83\u66f4\u6709\u610f\u7fa9\u3002\u4f46\u662f\uff0c\u5982\u679c\u6a19\u7c64\u805a\u5408\u4e0d\u518d\u6709\u610f\u7fa9\uff0c\u8acb\u8003\u616e\u5275\u5efa\u4e00\u500b\u65b0\u6307\u6a19\u3002 Prometheus \u5b98\u65b9\u624b\u518a\u4e5f\u6709\u4e00\u4e9b\u95dc\u65bc\u6307\u6a19\u548c\u6a19\u7c64\u547d\u540d\u7684\u5efa\u8b70\u3002","title":"\u61c9\u7528\u7cfb\u7d71\u6307\u6a19\u5316\u5d4c\u5165 (Instrumentation)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#labels","text":"\u5728 Prometheus\uff08\u4ee5\u53ca Kubernetes\uff09\u4e2d\uff0c\u6a19\u7c64\u662f\u9375\u503c\u5c0d\uff0c\u5176\u4e2d\u9375\u548c\u503c\u90fd\u662f\u5b57\u7b26\u4e32\u3002\u5982\u679c\u503c\u6216\u9375\u4e0d\u540c\uff0c\u6211\u5011\u8aaa\u5169\u500b\u7d66\u5b9a\u7684\u6a19\u7c64\u662f\u4e0d\u540c\u7684\u3002\u4f8b\u5982\uff0c\u6a19\u7c64 path=\"/\" \u548c path=\"/bar\" \u662f\u4e0d\u540c\u7684\uff01 \u6a19\u7c64\u53ef\u4ee5\u9644\u52a0\u5230\u6307\u6a19\u6216\u8b66\u5831\uff1a Metric \u6a19\u7c64 Alert \u6a19\u7c64 Metric \u6307\u6a19\u6709\u5169\u985e\u6a19\u7c64\uff1atarget \u6a19\u7c64\u548c instrumentation \u6a19\u7c64\uff1a Instrumentation \u6a19\u7c64 - \u7531\u6aa2\u6e2c\u4ee3\u78bc\u6dfb\u52a0\u3002\u9019\u4e9b\u662f\u60a8\u5728 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\u4e2d\u770b\u5230\u7684\u6240\u6709\u6a19\u7c64\u3002 Target \u6a19\u7c64 - Prometheus \u670d\u52d9\u5668\u5728\u6293\u53d6\u6307\u6a19\u7684\u904e\u7a0b\u201c\u4e4b\u5f8c\u201d\u518d\u6dfb\u52a0 target \u6a19\u7c64\uff08\u56e0\u6b64\uff0c\u60a8\u4e0d\u6703\u5728 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\u4e2d\u770b\u5230\u5b83\u5011\uff09\uff0c\u5c31\u5728\u5c07\u65b0\u6293\u53d6\u7684\u8a72\u6307\u6a19\u7684\u6a23\u672c\u5b58\u5132\u5230\u5176 TSDB \u4e4b\u524d\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPrometheus \u6dfb\u52a0 target \u6a19\u7c64 job=\"somejob\" \u548c instance=\"somehost:9091\" \uff0c\u5176\u4e2d somejob \u662f\u60a8\u5728 prometheus.yml \u4e2d\u7684 job_name \u5b57\u6bb5\u4e4b\u4e00\u4e2d\u627e\u5230\u7684\u5b57\u7b26\u4e32\uff0cinstance \u6307\u7684\u662f\u5177\u9ad4\u7684\u4e3b\u6a5f\u6216\u9032\u7a0b\u5176 /metrics \u7aef\u9ede\u5df2\u88ab\u6293\u53d6\u3002\u5728 prometheus.yml \u6587\u4ef6\u4e2d\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u60a8\u559c\u6b61\u7684\u5176\u4ed6 target \u6a19\u7c64\u3002 \u95dc\u65bc\u6a19\u7c64\u7684\u4e00\u500b\u6709\u7528\u529f\u80fd\u662f\" \u91cd\u65b0\u6a19\u8a18 \"\u3002\u5b83\u89e3\u6c7a\u4e86\u4ee5\u4e0b\u91cd\u8981\u554f\u984c\uff1a\u5047\u8a2d\u67d0\u500b\u5c0e\u51fa\u5668\u7684 /metrics \u7aef\u9ede\u7684\u8f38\u51fa\uff08\u4e0d\u662f\u60a8\u7de8\u5beb\u7684 -> \u60a8\u7121\u6cd5\u66f4\u6539\u5b83\uff09\u4e0d\u9069\u5408\u60a8\u7684\u7528\u4f8b\u3002\u4f8b\u5982\uff0c\u8f38\u51fa\u53ef\u80fd\u5305\u542b\u592a\u591a\u6307\u6a19\uff08\u60a8\u4e0d\u60f3\u5b58\u5132\uff09\uff0c\u6216\u8005\u67d0\u4e9b\u6642\u9593\u5e8f\u5217\u7684\u67d0\u4e9b\u6a19\u7c64\u5c0d\u60a8\u4f86\u8aaa\u4e0d\u91cd\u8981\uff0c\u6216\u8005\u60a8\u4e0d\u559c\u6b61\u5b83\u5011\u7684\u7279\u5b9a\u547d\u540d\u3002 Prometheus \u7684\u91cd\u65b0\u6a19\u8a18\u529f\u80fd (docs) \u5141\u8a31\u60a8\u5728\u5c07\u6307\u6a19\u548c/\u6216\u6a19\u7c64\u5b58\u5132\u5230 TSDB \u4e4b\u524d\u522a\u9664\u6216\u4fee\u6539\u5b83\u5011\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86\u9019\u500b\u6982\u5ff5\u3002 \u95dc\u65bc Prometheus \u6027\u80fd\u7684\u4e00\u500b\u91cd\u8981\u77e5\u8b58\u662f\u6642\u9593\u5e8f\u5217\u6578\u91cf\uff0c\u5b83\u6307\u7684\u662f TSDB \u4e2d\u6642\u9593\u5e8f\u5217\u7684\u6578\u91cf\u3002\u904e\u591a\u7684\u6642\u9593\u5e8f\u5217\u5c0d\u65bc PromQL \u67e5\u8a62\u7684\u6027\u80fd\u662f\u6709\u554f\u984c\u7684\uff0c\u9019\u9700\u8981\u6642\u9593\u5e8f\u5217\u6578\u64da\u5728\u5167\u5b58\u4e2d\uff08\u4f8b\u5982\uff0c\u7528\u65bc\u8a08\u7b97\u7e3d\u548c\u7b49\u805a\u5408\uff09\u3002\u4f60\u7684\u8a18\u61b6\u662f\u6709\u9650\u7684\uff0c\u56e0\u6b64\uff0c\u8a18\u61b6\u4e2d\u7684\u6642\u9593\u5e8f\u5217\u4e5f\u662f\u6709\u9650\u7684\u3002 \u662f\u4ec0\u9ebc\u63a8\u52d5\u4e86\u6642\u9593\u5e8f\u5217\u7684\u6578\u91cf\u589e\u52a0\uff1f\u4e3b\u8981\u662f\" \u6a19\u7c64 \"\uff08\u4e0d\u662f\u6307\u6a19\u540d\u7a31\uff09\uff0c\u56e0\u70ba\u6a19\u7c64\u53ef\u4ee5\u6709\u8a31\u591a\u4e0d\u540c\u7684\u503c\u3002\u56e0\u6b64\uff0c\u60a8\u61c9\u8a72\u907f\u514d\u5728\u6307\u6a19\u4e2d\u6dfb\u52a0\u8af8\u5982 username=\"peter\" \u9019\u6a23\u7684\u6a19\u7c64\uff0c\u56e0\u70ba\u60a8\u53ef\u80fd\u64c1\u6709\u6578\u767e\u842c\u7528\u6236\uff0c\u5f9e\u800c\u7522\u751f\u6578\u767e\u842c\u500b\u6642\u9593\u5e8f\u5217\u3002\u9019\u540c\u6a23\u9069\u7528\u65bc\u96fb\u5b50\u90f5\u4ef6\u6216 IP \u5730\u5740\u7b49\u6a19\u7c64\u3002\u9019\u4e5f\u610f\u5473\u8457\uff0c\u5c0d\u65bc\u60a8\u5e0c\u671b\u6709\u8a31\u591a\u6a19\u7c64\u7684\u6307\u6a19\uff0c\u60a8\u61c9\u8a72\u907f\u514d\u4f7f\u7528\u6307\u6a19\u985e\u578b\u6458\u8981\u548c\u76f4\u65b9\u5716\uff08\u800c\u66f4\u559c\u6b61\u5100\u8868\u548c\u8a08\u6578\u5668\uff09\uff0c\u56e0\u70ba\u9019\u4e9b\u6307\u6a19\u985e\u578b\u70ba\u60a8\u81ea\u5df1\u7684\u6bcf\u500b\u6a19\u7c64\u6dfb\u52a0\u4e86\u5927\u91cf\u6642\u9593\u5e8f\u5217\uff0c\u7528\u65bc\u4e0d\u540c\u7684\u5206\u4f4d\u6578\u6216\u5b58\u5132\u6876\u3002 \u6bcf\u7576\u8a55\u4f30 for: ... PromQL \u8868\u9054\u5f0f\u5728 alert-rules.yml \u6587\u4ef6\u4e2d\u751f\u6210\u4e00\u500b\u6216\u591a\u500b\u6642\u9593\u5e8f\u5217\u884c\u6642\uff0cPrometheus \u5c31\u6703\u751f\u6210\u4e00\u500b\u8b66\u5831\u5c0d\u8c61\uff08\u5c07\u5176\u767c\u9001\u5230 Alertmanager\uff09\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e9b\u884c\u7684\u6a19\u7c64\uff08\u4f8b\u5982 job=\"somejob\" \u3001 instance=\"host:port\" \u548c\u5176\u4ed6\u7279\u5b9a\u65bc\u6307\u6a19\u7684\u6a19\u7c64\uff09\u9644\u52a0\u5230\u6b64\u8b66\u5831\u5c0d\u8c61\u3002\u5728 alert-rules.yml \u6587\u4ef6\u4e2d\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u5176\u4ed6\u6a19\u7c64\uff0c\u4f8b\u5982 severity=\"critical\" \uff0c\u60a8\u53ef\u4ee5\u5728\u8b66\u5831\u8def\u7531\u6a39\u7684\u5339\u914d\u5668\u4e2d\u4f7f\u7528\u5b83\u3002","title":"\u6a19\u7c64 (Labels)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#_4","text":"\u6b63\u5982\u6211\u5728\u672c\u6587\u548c\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u5df2\u7d93\u8a0e\u8ad6\u904e\u7684\uff0c\u8b66\u5831 (alert) \u548c\u8b66\u5831\u901a\u77e5 (alert notification) \u662f\u5169\u500b\u7368\u7acb\u7684\u6982\u5ff5\u3002 \u8b66\u5831\u53ea\u662f Prometheus \u767c\u9001\u7d66 Alertmanager \u7684 JSON \u5c0d\u8c61\u3002 Prometheus \u4e0d\u6703\u5c07\u4efb\u4f55\u8b66\u5831\u7684\u72c0\u614b\u5b58\u5132\u5728\u81ea\u5df1\u7684\u6578\u64da\u5b58\u5132\u4e2d\u3002\u56e0\u6b64\uff0cPrometheus \u4e0d\u6703\u6aa2\u6e2c\u5230\u8b66\u5831\u8f49\u63db\uff08\u4f8b\u5982\u201c\u8b66\u5831\u958b\u59cb\u89f8\u767c\u201d\u8207\u201c\u8b66\u5831\u505c\u6b62\u89f8\u767c\u201d\uff09\u3002\u53ea\u8981\u76f8\u61c9\u8b66\u5831\u898f\u5247\u7684 PromQL \u8868\u9054\u5f0f\u7684\u8a55\u4f30\u7522\u751f\u4e00\u500b\u6216\u591a\u500b\u6642\u9593\u5e8f\u5217\u884c\uff0c\u5b83\u5c31\u6703\u7c21\u55ae\u5730\u767c\u9001\u8b66\u5831\u5c0d\u8c61\uff0c\u5426\u5247\u5b83\u4e0d\u6703\u767c\u9001\u4efb\u4f55\u8b66\u5831\u3002 Alertmanager \u8ca0\u8cac\u5b58\u5132\u9019\u4e9b\u8b66\u5831\u5c0d\u8c61\u3001\u6aa2\u6e2c\u201c\u8b66\u5831\u89f8\u767c\u201d\u8f49\u63db\uff08\u901a\u904e\u6aa2\u67e5\u5b83\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u6536\u5230\u7684\u8b66\u5831\u7684\u5b58\u5728\u8207\u5426\uff09\uff0c\u4e26\u751f\u6210\u8b66\u5831\u901a\u77e5\uff0c\u9019\u4e9b\u901a\u77e5\u88ab\u767c\u9001\u5230\u5be6\u969b\u7522\u751f\u8b66\u5831\u7684\u7cfb\u7d71\uff0c\u7528\u6236\u53ef\u4ee5\u611f\u77e5\u2014\u2014\u4f8b\u5982\u77ed\u4fe1\u3001\u96fb\u5b50\u90f5\u4ef6\u7b49\u3002 \u9996\u5148\uff0c\u6b63\u78ba\u914d\u7f6e Alertmanager \u78ba\u5be6\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u56e0\u70ba\u60a8\u9996\u5148\u9700\u8981\u5f88\u597d\u5730\u7406\u89e3\u8b66\u5831\u8def\u7531\u6a39\u7684\u6982\u5ff5\uff08\u5728\u6b64\u8655\u7684\u5b98\u65b9\u6587\u6a94\u4e2d\u6709\u5f88\u597d\u7684\u89e3\u91cb\uff09\u548c\u5206\u7d44\u6982\u5ff5\u3002 \u5206\u7d44\u7684\u57fa\u672c\u601d\u60f3\uff08\u53c3\u898b Alertmanager \u914d\u7f6e\u6587\u4ef6\u4e2d\u8def\u7531\u584a\u4e2d\u7684 group_by \u9375\uff09\u662f\u63a7\u5236\u901a\u77e5\u7684\u7c92\u5ea6\u3002\u6587\u6a94\u6c92\u6709\u5f88\u597d\u5730\u89e3\u91cb\u5b83\u3002\u9019\u662f\u6211\u5c0d\u5206\u7d44\u529f\u80fd\u7684\u500b\u4eba\u5fc3\u7406\u6a21\u578b\uff1a Alertmanager \u5728\u8b66\u5831\u8def\u7531\u6a39\u4e2d\u7684\u6bcf\u500b\u8def\u7531\u7bc0\u9ede\u5275\u5efa\u4e00\u500b\u6216\u591a\u500b\uff08\u6211\u7a31\u4e4b\u70ba\uff09\u201c\u901a\u77e5\u6876\u201d\uff08\u6bcf\u7d44\u4e00\u500b\u6876\uff09\u3002\u6bcf\u7576\u8b66\u5831\u6700\u7d42\u5230\u9054\u6a39\u4e2d\u7684\u4e00\u500b\u7bc0\u9ede\u6642\uff0cAlertmanager \u5c31\u6703\u5c07\u5176\u653e\u5165\u5176\u4e2d\u4e00\u500b\u5b58\u5132\u6876\u4e2d\u3002 \u5982\u679c\u60a8\u6c92\u6709\u70ba\u7bc0\u9ede\u6307\u5b9a\u4efb\u4f55 group_by \uff0c\u5247\u8a72\u7bc0\u9ede\u53ea\u6709\u4e00\u500b\u5b58\u5132\u6876/\u7d44\u3002\u4e00\u65e6\u901a\u904e\u4e86\u8db3\u5920\u7684\u7d44\u95be\u503c\uff08\u6700\u503c\u5f97\u6ce8\u610f\u7684\u662f group_wait \uff09\uff0c\u5c31\u6703\u751f\u6210\u4e00\u500b\u975e\u5e38\u5927\u7684\u55ae\u500b\u901a\u77e5\uff08\u4f8b\u5982\u96fb\u5b50\u90f5\u4ef6\uff09\uff0c\u56e0\u70ba\u5b83\u5305\u542b\u4e00\u500b\u9577\u5217\u8868\uff0c\u5176\u4e2d\u5305\u542b\u8def\u7531\u6a39\u4e2d\u8def\u7531\u5230\u8a72\u7bc0\u9ede\u7684\u6240\u6709\u8b66\u5831\u3002 \u5982\u679c\u60a8\u6539\u70ba\u6307\u5b9a\u985e\u4f3c group_by: [region] \u7684\u5167\u5bb9\uff0c\u5247 Alertmanager \u5c07\u5275\u5efa\u8207\u8b66\u5831\u4e2d\u6a19\u7c64\u5340\u57df\u7684\u503c\u4e00\u6a23\u591a\u7684\u901a\u77e5\u5b58\u5132\u6876\u3002 Alertmanager \u9084\u70ba\u6839\u672c\u6c92\u6709\u5340\u57df\u6a19\u7c64\u7684\u8b66\u5831\u5275\u5efa\u4e00\u500b\u5b58\u5132\u6876\uff08Alertmanager \u5c07\u5176\u89e3\u91cb\u70ba\u597d\u50cf\u6a19\u7c64\u5b58\u5728\uff0c\u4f46\u6709\u4e00\u500b\u7a7a\u5b57\u7b26\u4e32\u4f5c\u70ba\u503c\uff09\u3002\u7d44\u7279\u5b9a\u7684\u95be\u503c\uff0c\u4f8b\u5982 group_wait \uff0c\u73fe\u5728\u5206\u5225\u61c9\u7528\u65bc\u6bcf\u500b\u901a\u77e5\u6876\uff01\u56e0\u6b64\uff0c\u901a\u77e5\u7684\u89f8\u767c\u983b\u7387\u53ef\u80fd\u6703\u964d\u4f4e\uff08\u8207\u672a\u6307\u5b9a\u4efb\u4f55 group_by \u7684\u60c5\u6cc1\u76f8\u6bd4\uff09\uff0c\u56e0\u70ba\u5b58\u5132\u6876\u201c\u66f4\u5c0f\u201d\uff0c\u4e26\u4e14\u901a\u77e5\u7684\u5167\u5bb9\u6703\u66f4\u5c0f\uff08\u5217\u8868\u5c07\u5305\u542b\u66f4\u5c11\u7684\u8b66\u5831\uff09\u3002 \u5982\u679c\u60a8\u6307\u5b9a\u985e\u4f3c group_by: [region, env] \u7684\u5167\u5bb9\uff08\u5373\u6578\u7d44\u4e2d\u7684\u591a\u500b\u5143\u7d20\uff09\uff0c\u5247 Alertmanager \u5c07\u70ba\u9019\u4e9b\u7d66\u5b9a\u6a19\u7c64\u7684\u503c\u7684\u6bcf\u500b\u53ef\u80fd\u7d44\u5408\u5275\u5efa\u4e00\u500b\u901a\u77e5\u6876\u3002\u56e0\u6b64\uff0c\u5982\u679c\u60a8\u7684\u7cfb\u7d71\u6709 3 \u500b\u5340\u57df\u548c 2 \u500b\u74b0\u5883\uff0c\u60a8\u6700\u591a\u53ef\u4ee5\u6709 3*2 = 6 \u500b\u901a\u77e5\u6876\u3002","title":"\u8b66\u5831\u548c\u8b66\u5831\u901a\u77e5"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#dashboards","text":"\u5728\u76e3\u63a7\u4e16\u754c\u4e2d\uff0c\u5100\u8868\u677f\u662f\u55ae\u500b\u5716\u5f62\u7684\u96c6\u5408\uff0c\u6392\u5217\u70ba\u591a\u884c\u548c\u591a\u5217\u7684\u5716\u584a\u3002\u5728 Prometheus \u5806\u68e7\u4e2d\uff0cGrafana \u662f\u69cb\u5efa\u5100\u8868\u677f\u7684\u9996\u9078\uff0cGrafana \u7684\u793e\u5340\u7dad\u8b77\u8457\u4e00\u500b\u9f90\u5927\u7684\u5373\u7528\u578b\u5100\u8868\u677f\u6a21\u677f\u5b58\u5132\u5eab\u3002 \u64c1\u6709\u4e00\u500b\uff08\u6216\u591a\u500b\uff09\u5100\u8868\u677f\u53ef\u5e6b\u52a9\u60a8\u67e5\u660e\u554f\u984c\u3002\u4f5c\u70ba\u4eba\u985e\uff0c\u6211\u5011\u5728\u89e3\u91cb\u5716\u8868\u65b9\u9762\u6bd4\u67e5\u770b\u5927\u91cf\u6578\u5b57\u66f4\u6709\u6548\u3002\u5100\u8868\u677f\u7684\u76ee\u7684\u662f\u5e6b\u52a9\u60a8\u8a3a\u65b7\u60a8\u6536\u5230\u8b66\u5831\u901a\u77e5\u7684\u554f\u984c\u7684\u6839\u672c\u539f\u56e0\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u5100\u8868\u677f\u4e0d\u662f\u8b66\u5831\u7684\u624b\u6bb5\uff01\u60a8\u61c9\u8a72\u907f\u514d\u4f7f\u7528\u5fc5\u9808\u4e00\u76f4\u76ef\u8457\u7684\u5100\u8868\u677f\uff0c\u4ee5\u78ba\u5b9a\u662f\u5426\u6709\u554f\u984c\u3002\u8b93\u8b66\u5831\u4ee3\u66ff\u9019\u9805\u5de5\u4f5c\u3002 \u5100\u8868\u677f\u7684\u7d44\u6210\u5c31\u50cf\u4e00\u9580\u85dd\u8853\uff0c\u9700\u8981\u76f8\u7576\u591a\u7684\u601d\u8003\u3002\u7531\u65bc\u5404\u7a2e\u539f\u56e0\uff0c\u4f8b\u5982\u6027\u80fd\u4e0d\u4f73\u548c\u7f3a\u4e4f\u6982\u89bd\uff0c\u64c1\u6709\u5305\u542b 20 \u500b\u6216\u66f4\u591a\u5716\u8868\u7684\u5927\u578b\u5100\u8868\u677f\u662f\u6c92\u6709\u610f\u7fa9\u7684\u3002\u67e5\u770b\u4e00\u822c\u7684\u201c\u5100\u8868\u677f\u8a2d\u8a08\u539f\u5247\u201d\uff0c\u6216\u5177\u9ad4\u7684\u6700\u4f73\u5be6\u8e10\u6307\u5357\uff0c\u4f8b\u5982\u672c\u6307\u5357\u3002\u60a8\u901a\u5e38\u6700\u7d42\u6703\u69cb\u5efa\u591a\u500b\u5100\u8868\u677f\uff0c\u6bcf\u500b\u5100\u8868\u677f\u90fd\u91dd\u5c0d\u7279\u5b9a\u53d7\u773e\u95dc\u8a3b\u4e00\u500b\u7279\u6b8a\u4e3b\u984c\u3002","title":"Dashboards"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part3/#_5","text":"\u8853\u8a9e\u548c\u6982\u5ff5\u7684\u89e3\u91cb\u6709\u671b\u5e6b\u52a9\u60a8\u958b\u59cb\u66f4\u8a73\u7d30\u5730\u63a2\u7d22 Prometheus\u3002\u4e0b\u4e00\u500b\u5408\u4e4e\u908f\u8f2f\u7684\u6b65\u9a5f\u662f\u5728 PromQL \u4e2d\u7de8\u5beb\u8b66\u5831\uff08\u548c\u8a18\u9304\uff09\u898f\u5247\uff0c\u5c07\u5728\u4e0b\u4e00\u7bc7\u6587\u7ae0\u4e2d\u4ecb\u7d39\u3002 \u8003\u616e\u5230\u66f4\u7cbe\u7149\u7684\u8853\u8a9e\uff0c\u8b93\u6211\u7e3d\u7d50\u4e00\u4e0b\u6709\u6548\u5de5\u4f5c\u6d41\u7a0b\u7684\u57fa\u672c\u601d\u60f3\uff0c\u4ee5\u6aa2\u6e2c\u548c\u4fee\u5fa9 Prometheus \u5806\u68e7\u7684\u554f\u984c\uff1a \u901a\u904e\u9078\u64c7\u548c\u6293\u53d6\u8a31\u591a\u7b2c\u4e09\u65b9 exporter\uff08\u5c0d\u65bc\u60a8\u6b63\u5728\u4f7f\u7528\u7684\u7b2c\u4e09\u65b9\u670d\u52d9\uff0c\u4f8b\u5982\u6578\u64da\u5eab\u6216\u6d88\u606f\u968a\u5217\uff09\uff0c\u9078\u64c7\u8981\u5b58\u5132\u5728 Prometheus \u7684 TSDB \u4e2d\u7684\u5927\u91cf\u6307\u6a19\u3002\u6b64\u5916\uff0c\u70ba\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u6e2c\u91cf\u6307\u6a19\u3002\u60a8\u5b58\u5132\u7684\u6307\u6a19\u8d8a\u591a\u8d8a\u597d\uff0c\u56e0\u70ba\u5b83\u5011\u53ef\u80fd\u662f\u8a3a\u65b7\u554f\u984c\u7684\u95dc\u9375\uff08\u5728\u6b65\u9a5f 3 \u4e2d\uff09\u3002\u6b64\u5916\uff0c\u5728 Grafana \u7684\u9810\u88fd\u5100\u8868\u677f\u76ee\u9304\u7684\u5e6b\u52a9\u4e0b\uff0c\u70ba\u9019\u4e9b\u6307\u6a19\u7684\u5b50\u96c6\u69cb\u5efa\u5100\u8868\u677f\u3002 \u53ea\u914d\u7f6e\u4e00\u4e9b\u8b66\u5831\u898f\u5247\uff0c\u6307\u793a\u8981\u76e3\u63a7\u7684\u554f\u984c\uff08\u6216\u8005\u5f88\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u51fa\u73fe\u554f\u984c\uff09\u3002\u5982\u679c\u60a8\u6709\u592a\u591a\u8b66\u5831\u898f\u5247\uff0c\u60a8\u5c07\u6536\u5230\u592a\u591a\u8b66\u5831\u901a\u77e5\uff0c\u4e26\u4e14\u5f88\u53ef\u80fd\u4f60\u6703\u5c07\u5b83\u5011\u4f5c\u70ba\u5783\u573e\u90f5\u4ef6\u4e1f\u68c4\u3002 \u6536\u5230\u8b66\u5831\u901a\u77e5\u5f8c\uff0c\u8acb\u6253\u958b\u5100\u8868\u677f\u4ee5\u66f4\u6e96\u78ba\u5730\u8a3a\u65b7\u554f\u984c\u3002","title":"\u7d50\u8ad6"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/","text":"PromQL \u4ecb\u8a54 \u00b6 \u539f\u6587: Kubernetes Observability \u2013 Part IV: PromQL tips \u9019\u662f\u5c0d PromQL\uff08Prometheus \u67e5\u8a62\u8a9e\u8a00\uff09\u7684\u6df1\u5165\u63a2\u8a0e\u3002\u672c\u6587\u8a0e\u8ad6\u4e86\u57fa\u672c\u7684\u6578\u64da\u683c\u5f0f\uff08\u5373\u6642\u5411\u91cf\u548c\u7bc4\u570d\u5411\u91cf\uff09\uff0c\u89e3\u91cb\u4e86\u4e0d\u540c\u985e\u578b\u7684\u904b\u7b97\u7b26\u548c\u51fd\u6578\uff0c\u7136\u5f8c\u8a73\u7d30\u8aaa\u660e\u4e86\u4e8c\u5143\u904b\u7b97\u7b26\u5982\u4f55\u9032\u884c\u7d50\u679c\u5411\u91cf\u5339\u914d\u3002\u540c\u6642\u4e5f\u7e3d\u7d50\u4e86\u5404\u7a2e PromQL \u6280\u5de7\u548c\u63d0\u793a\uff0c\u4e26\u5e6b\u52a9\u60a8\u958b\u59cb\u5be6\u8e10\u3002 \u4ecb\u7d39 \u00b6 Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c Observability \u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u4e00\u500b\u91cd\u8981\u7684\u6b65\u9a5f\uff08\u5728\u6280\u8853\u8ecc\u9053\u4e0a\uff09\u662f\u4e86\u89e3 Prometheus \u67e5\u8a62\u8a9e\u8a00 PromQL\u3002\u60a8\u9700\u8981\u5728\u5169\u500b\u5730\u65b9\u4f7f\u7528 PromQL\uff1a\u5728 Prometheus \u672c\u8eab\u4e2d\u69cb\u5efa\u8b66\u5831\u548c\u8a18\u9304\u898f\u5247\uff0c\u4ee5\u53ca\u5728 Grafana \u4e2d\u9078\u64c7\u5100\u8868\u677f\u4e2d\u53ef\u8996\u5316\u7684\u6578\u64da\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86 PromQL\u3001\u7d50\u679c\u6578\u64da\u683c\u5f0f\u5373\u6642\u5411\u91cf\u548c\u7bc4\u570d\u5411\u91cf\u3001\u4e0d\u540c\u7684\u904b\u7b97\u7b26\uff0c\u4ee5\u53ca\u5982\u4f55\u5339\u914d\u6a19\u7c64\u6216\u6a23\u672c\u8a08\u6578\u4e0d\u5c0d\u9f4a\u7684\u7d50\u679c\u6578\u64da\u884c\u3002\u6700\u5f8c\uff0c\u6211\u7e3d\u7d50\u4e86\u5404\u7a2e\u6280\u5de7\u548c\u63d0\u793a\u3002 \u6211\u5efa\u8b70\u60a8\u5728\u95b1\u8b80\u672c\u6587\u6642\u5617\u8a66\u4e26\u7de8\u5beb\u81ea\u5df1\u7684 PromQL \u67e5\u8a62\u3002\u5728\u672c\u7cfb\u5217\u7684\u524d\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5df2\u7d93\u6f14\u793a\u4e86\u4e0d\u540c\u7684\u5b89\u88dd\u9078\u9805\u3002\u518d\u4e00\u6b21\uff0c\u6211\u5f37\u70c8\u63a8\u85a6 PromLens\uff0c\u9019\u662f\u4e00\u500b\u975e\u5e38\u6709\u7528\u7684\u5de5\u5177\uff0c\u53ef\u4ee5\u4ee5\u5716\u5f62\u65b9\u5f0f\u53ef\u8996\u5316\u548c\u89e3\u91cb\u8907\u96dc\u7684 PromQL \u67e5\u8a62\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u500b\u4eba\u8a31\u53ef\u8b49\u5728\u60a8\u81ea\u5df1\u7684\uff08\u975e\u5546\u696d\uff09\u57fa\u790e\u8a2d\u65bd\u4e0a\u514d\u8cbb\u904b\u884c\u5b83\uff0c\u6216\u4f7f\u7528\u516c\u5171\u73fe\u5834\u6f14\u793a\u5be6\u4f8b\u3002 \u8907\u7fd2\uff1a\u6642\u9593\u5e8f\u5217\u8207\u6307\u6a19 \u5728\u672c\u6587\u4e2d\uff0c\u6211\u5c07\u5047\u8a2d\u60a8\u77e5\u9053\u201c\u6642\u9593\u5e8f\u5217\u201d\u548c\u201c\u6307\u6a19\u201d\u4e4b\u9593\u7684\u5340\u5225\u3002\u5982\u679c\u6c92\u6709\uff0c\u8acb\u53c3\u8003 \u9019\u88e1 \u7684\u89e3\u91cb\u3002 PromQL\u67e5\u8a62\u7d50\u679c\u6578\u64da\u683c\u5f0f \u00b6 \u7576\u60a8\u5728\u67e5\u8a62\u7a97\u53e3\u4e2d\u8f38\u5165 PromQL \u67e5\u8a62\u6642\uff08\u4f8b\u5982\uff0c\u5728 Grafana \u4e2d\uff0c\u6216\u8005 Prometheus \u670d\u52d9\u5668\u7684\u7aef\u53e3 9090 \u4e0a\u7684 Prometheus \u7684 Web \u754c\u9762\u4e2d\uff09\uff0c\u60a8\u5c07\u8fd4\u56de 0 \u500b\u6216\u66f4\u591a\u7d50\u679c\u884c\u3002\u7d50\u679c\u7e3d\u662f\u6709\u4e00\u500b\u985e\u578b\uff1a\u5373\u6642\u5411\u91cf (instant vector) \u6216\u7bc4\u570d\u5411\u91cf (range vector)\u3002 \u5373\u6642\u5411\u91cf (Instant vector) \u00b6 \u6bcf\u7576\u60a8\u9375\u5165 some_metric_name \u6216 some_metric_name{some_label=\"value\"} \u4e4b\u985e\u7684\u5167\u5bb9\u6642\uff0c\u7d50\u679c\u5c31\u662f\u4e00\u500b\" \u5373\u6642\u5411\u91cf \"\u3002\u8003\u616e\u4ee5\u4e0b\u793a\u4f8b\uff1a \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u7d50\u679c\u662f\u4e00\u500b\u5305\u542b\u7d04 100 \u500b\u6642\u9593\u5e8f\u5217\u884c\u7684\u5373\u6642\u5411\u91cf\uff0c\u6bcf\u884c\u5305\u542b\u8a72\u6642\u9593\u5e8f\u5217\u7684\u6700\u8fd1\u6293\u53d6\u7684\u6a23\u672c\u503c\u3002\u8acb\u6ce8\u610f\uff0c\u7d50\u679c\u4e0d\u5305\u542b\u6536\u96c6\u6b64\u6a23\u672c\u7684\u6642\u9593\u6233\u2014\u2014\u5047\u8a2d\u5b83\u662f\u6700\u8fd1\u6536\u96c6\u7684\u3002 Prometheus \u5be6\u969b\u4e0a\u4e1f\u68c4\u4e86\u8d85\u904e 5 \u5206\u9418\u4e4b\u524d\u6536\u96c6\u7684\u6a23\u672c\uff0c\u4e26\u4e14\u76f8\u61c9\u7684\u6642\u9593\u5e8f\u5217\u884c\u4e0d\u6703\u662f\u8fd4\u56de\u7d50\u679c\u7684\u4e00\u90e8\u5206\u3002 \u70ba\u4e86\u5e6b\u52a9\u60a8\u66f4\u597d\u5730\u8a18\u4f4f\u5b83\uff1a\u201c \u5373\u6642\u5411\u91cf \u201d\u6709\u5b83\u7684\u540d\u5b57\u7684\u53d6\u540d\u539f\u7531\uff0c\u56e0\u70ba\u67e5\u8a62\u7d50\u679c\u884c\u53ea\u5305\u542b\u90a3\u4e9b\u201c\u6b64\u6642\u201d\uff08\u901a\u5e38\u662f\u5e7e\u79d2\u9418\u524d\uff09\u6536\u96c6\u7684\u6a23\u672c\u7684\u6642\u9593\u5e8f\u5217\u3002 \u5373\u6642\u5411\u91cf\u9078\u64c7\u5668 \u5982\u679c\u60a8\u7de8\u5beb\u985e\u4f3c some_metric_name {foo=\"bar\"} \u7684\u5167\u5bb9\uff0c\u7c97\u9ad4\u90e8\u5206\u7a31\u70ba\u9078\u64c7\u5668\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u904e\u6ffe\uff08\u5982\uff1a\u7e2e\u5c0f\uff09\u67e5\u8a62\u4e2d\u8fd4\u56de\u7684\u6642\u9593\u5e8f\u5217\u3002\u6b64\u793a\u4f8b\u4e2d\u7684 = \uff08\u7b49\u865f\uff09\u7a31\u70ba\u5339\u914d\u5668\u3002\u5176\u4ed6\u5339\u914d\u5668\u662f != \uff08\u4e0d\u76f8\u7b49\uff09\u3001 =~ \uff08\u6b63\u5247\u8868\u9054\u5f0f\uff09\u548c !~ \uff08\u5426\u5b9a\u6b63\u5247\u8868\u9054\u5f0f\uff09\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528\u591a\u500b\u9078\u64c7\u5668\u2014\u2014\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u53ea\u8fd4\u56de\u6eff\u8db3\u6240\u6709\u9078\u64c7\u5668\u7684\u90a3\u4e9b\u884c\uff08\u63db\u53e5\u8a71\u8aaa\uff1aPrometheus \u5c07 AND \u908f\u8f2f\u61c9\u7528\u65bc\u9078\u64c7\u5668\uff09\u3002\u60a8\u9084\u53ef\u4ee5\u70ba\u76f8\u540c\u7684\u6a19\u7c64\u9375\uff08\u4f46\u4e0d\u540c\u7684\u5339\u914d\u5668\u985e\u578b\uff09\u63d0\u4f9b\u591a\u500b\u9078\u64c7\u5668\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u7de8\u5beb\u4e00\u500b\u67e5\u8a62\uff0c\u4f8b\u5982 node_filesystem_size_bytes{ mountpoint =~ \"/run/. \", **mountpoint* !~\"/run/user/.*\"}` \u7372\u53d6\u6240\u6709\u7bc0\u9ede\u4e0a\u78c1\u76e4\u5206\u5340\u7684\u7e3d\u5927\u5c0f\uff0c\u5176\u639b\u8f09\u9ede\u4ee5 \u201c/run/\u201d \u958b\u982d\uff0c\u4f46\u4e0d\u5305\u62ec\u6240\u6709\u4ee5 \u201c/run/user/\u201d \u958b\u982d\u7684\u7bc0\u9ede\u3002 \u7bc4\u570d\u5411\u91cf (Range vector) \u00b6 \u8af8\u5982 some_metric_name[ 5m ] \u6216 some_metric_name{some_label=\"value\"}[ 5m ] \u4e4b\u985e\u7684\u67e5\u8a62\u6703\u751f\u6210\" \u7bc4\u570d\u5411\u91cf \"\u985e\u578b\u7684\u7d50\u679c\u3002 \u7bc4\u570d\u5411\u91cf\u985e\u4f3c\u65bc\u5373\u6642\u5411\u91cf\u3002\u5982\u4e0a\u4f8b\u6240\u793a\uff0c\u7bc4\u570d\u5411\u91cf\u548c\u5373\u6642\u5411\u91cf\u4e4b\u9593\u6709\u5169\u500b\u95dc\u9375\u5340\u5225\uff1a \u4e00\u500b\u7bc4\u570d\u5411\u91cf\u5305\u542b\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u7684\u591a\u500b\u6a23\u672c\u2014\u2014\u4e0d\u50c5\u50c5\u662f\u6700\u8fd1\u6536\u96c6\u7684\u4e00\u500b \u7bc4\u570d\u5411\u91cf\u7684\u6a23\u672c\u5e36\u6709\u6642\u9593\u6233\uff08@ \u5b57\u7b26\u5f8c\u7684\u503c\uff09 \u5c16\u62ec\u865f\u4e2d\u7684\u90e8\u5206\uff08\u4f8b\u5982 [5m]\uff09\u6307\u5b9a\u8fd4\u56de\u6a23\u672c\u7684\u6642\u9593\u7a97\u53e3\u3002\u4f8b\u5982\uff0c[5m] \u544a\u8a34 Prometheus \u8fd4\u56de\u5728\u201c\u525b\u525b\u201d\u548c\u201c\u904e\u53bb 5 \u5206\u9418\u201d\u4e4b\u9593\u6293\u53d6\u7684\u6a23\u672c\u3002\u53ef\u7528\u7684\u55ae\u4f4d\u6709\uff1a s \uff08\u79d2\uff09\u3001 m \uff08\u5206\u9418\uff09\u3001 h \uff08\u5c0f\u6642\uff09\u3001 d \uff08\u5929\uff09\u3001 w \uff08\u9031\uff09\u3001 y \uff08\u5e74\uff09\u3002 \u6642\u9593\u504f\u79fb \u6709\u6642\u60a8\u53ef\u80fd\u60f3\u67e5\u8a62\u8f03\u820a\u7684\u6578\u64da\uff0c\u4f8b\u5982\u5c07\u201c\u4e00\u5468\u524d\u201d\u7684\u8acb\u6c42\u7387\u8207\u7576\u524d\u7684\u8acb\u6c42\u7387\u9032\u884c\u6bd4\u8f03\u3002\u70ba\u6b64\uff0cPromQL \u63d0\u4f9b\u4e86\u60a8\u53ef\u4ee5\u5728\u67e5\u8a62\u672b\u5c3e\u6dfb\u52a0\u7684 offset <duration> \u95dc\u9375\u5b57\u3002\u5b83\u9069\u7528\u65bc\u5373\u6642\u548c\u7bc4\u570d\u5411\u91cf\uff01 \u4f8b\u5982\uff0c\u8af8\u5982 some_metric_name[5m] offset 1h \u4e4b\u985e\u7684\u67e5\u8a62\u5c07\u70ba\u60a8\u63d0\u4f9b\u5728\u201c1 \u5c0f\u6642\u524d\u201d\u548c\u201c1 \u5c0f\u6642 5 \u5206\u9418\u524d\u201d\u4e4b\u9593\u6293\u53d6\u7684\u6a23\u672c\u3002 \u904b\u7b97\u7b26 (Operators) \u00b6 \u5728\u5be6\u8e10\u4e2d\uff0cPromQL \u67e5\u8a62\u76f8\u7576\u5927\u4e14\u8907\u96dc\u3002\u901a\u5e38\uff0c\u5b83\u5011\u662f\u591a\u500b\u5b50\u67e5\u8a62\u7684\u7d44\u5408\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u904b\u7b97\u7b26\u7d44\u5408\u9019\u4e9b\u5b50\u67e5\u8a62\uff0c\u9019\u4e5f\u662f SQL \u67e5\u8a62\u4e2d\u7684\u5e38\u7528\u6280\u8853\u3002 PromQL \u904b\u7b97\u7b26\u671f\u5f85\u5b83\u5011\u7684\u201c\u8f38\u5165\u201d\u662f\u6b63\u78ba\u7684\u6578\u64da\u985e\u578b\uff08\u7bc4\u570d\u5411\u91cf\u3001\u5373\u6642\u5411\u91cf\u6216\u6a19\u91cf\uff09\uff0c\u9019\u5c31\u662f\u6211\u5728\u4e0a\u9762\u8a73\u7d30\u89e3\u91cb\u53ef\u7528\u6578\u64da\u985e\u578b\u7684\u539f\u56e0\u3002\u9806\u4fbf\u8aaa\u4e00\u4e0b\uff0c\u6a19\u91cf\u53ea\u662f\u4e00\u500b\u6d6e\u9ede\u6578\u3002 Prometheus \u5177\u6709\u4ee5\u4e0b\u4e09\u7a2e\u904b\u7b97\u7b26\u985e\u5225\uff1a\u805a\u5408\u904b\u7b97\u7b26\u3001\u4e8c\u5143\u904b\u7b97\u7b26\u548c\u51fd\u6578\u3002 \u805a\u5408\u904b\u7b97\u7b26(Aggregation operators) \u4e8c\u5143\u904b\u7b97\u7b26(Binary operators) \u51fd\u6578 (Functions) \u805a\u5408\u904b\u7b97\u7b26\uff0c\u4f8b\u5982 sum / count / min / max / avg / stddev \u5c07\u55ae\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\u4e26\u7522\u751f\u4e00\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u51fa\u3002\u7531\u65bc\u805a\u5408\uff0c\u8207\u8f38\u5165\u5373\u6642\u5411\u91cf\u76f8\u6bd4\uff0c\u7d50\u679c\u901a\u5e38\u5177\u6709\u66f4\u5c11\u7684\u6642\u9593\u5e8f\u5217\uff08\u548c\u6a19\u7c64\uff09\u3002 \u805a\u5408\u7e3d\u662f\u767c\u751f\u5728\u60a8\u6307\u5b9a\u7684\u4e00\u500b\uff08\u6216\u591a\u500b\uff09\u6a19\u7c64\u9375\u4e0a\u3002\u6709\u5169\u7a2e\u6307\u5b9a\u9019\u4e9b\u6a19\u7c64\u7684\u57fa\u672c\u65b9\u6cd5\u3002\u8b93\u6211\u5011\u901a\u904e\u793a\u4f8b\u4f86\u8aaa\u660e\u5b83\u5011\uff0c\u5c0d\u65bc\u6307\u6a19 node_filesystem_size_bytes \uff0c\u5b83\u5177\u6709\u6a19\u7c64\u9375 job \u3001 instance \u3001 device \u3001 mountpoint \u3001 fstype \u3002 \u6307\u5b9a\u5141\u8a31\u5217\u8868\u3002\u793a\u4f8b\u67e5\u8a62\uff1asum by(job, instance, device)(node_filesystem_size_bytes) \u751f\u6210\u7684\u5373\u6642\u5411\u91cf\u5c07\u50c5\u5305\u542b\u60a8\u5728 by-clause \u4e2d\u6307\u5b9a\u5176\u9375\u7684\u90a3\u4e9b\u6a19\u7c64\uff0c\u805a\u5408\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u6e05\u695a\u5730\u8aaa\u660e\u4e86\u805a\u5408\u904e\u7a0b\u7684\u5de5\u4f5c\u539f\u7406\u3002 \u6307\u5b9a\u62d2\u7d55\u5217\u8868\u3002\u793a\u4f8b\u67e5\u8a62\uff1a sum without(fstype, mountpoint)(node_filesystem_size_bytes) \u751f\u6210\u7684\u5373\u6642\u5411\u91cf\u5c07\u4e0d\u518d\u5305\u542b\u60a8\u5728\u7121\u5b50\u53e5\u4e2d\u6307\u5b9a\u7684\u90a3\u4e9b\u6a19\u7c64\u9375\uff0c\u4f46\u5c07\u5305\u542b\u8f38\u5165\u5373\u6642\u5411\u91cf\u5177\u6709\u7684\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff1a\u4f5c\u696d\u3001\u5be6\u4f8b\u3001\u8a2d\u5099 \u904b\u884c\u4e0a\u8ff0\u4efb\u4e00\u67e5\u8a62\u6642\uff08\u5169\u8005\u90fd\u5be6\u73fe\u76f8\u540c\u7684\u76ee\u7684\uff0c\u901a\u904e fstype \u548c mountpoint \u9032\u884c\u805a\u5408\uff09\uff0c\u805a\u5408\u7684\u5de5\u4f5c\u65b9\u5f0f\u5982\u4e0b\uff1a \u5047\u8a2d node_filesystem_size_bytes \u6307\u6a19\u5177\u6709\u4ee5\u4e0b\u5373\u6642\u5411\u91cf\u6642\u9593\u5e8f\u5217\uff1a node_filesystem_size_bytes { device = \"/dev/sda1\" ,fstype = \"vfat\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/boot/efi\" } 100663296 node_filesystem_size_bytes { device = \"/dev/sda5\" ,fstype = \"ext4\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/\" } 90131324928 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/lock\" } 5242880 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/1000\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/119\" } 826961920 Prometheus \u5c07\u5728\u5167\u90e8\u5275\u5efa\u7d44\uff0c\u5176\u4e2d\u6bcf\u500b\u7d44\u5305\u542b\u5177\u6709\u5b8c\u5168\u76f8\u540c\u6a19\u7c64\uff08\u5177\u6709\u76f8\u540c\u6a19\u7c64\u9375\u548c\u6a19\u7c64\u503c\uff09\u7684\u6642\u9593\u5e8f\u5217\uff0c\u9019\u4e9b\u6a19\u7c64\u9375\u61c9\u4fdd\u7559\u5728\u6700\u7d42\u7d50\u679c\u4e2d\u3002\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\uff1a # Group 1 {device=\"/dev/sda1\",instance=\"localhost:9100\",job=\"node\"} node_filesystem_size_bytes { device = \"/dev/sda1\" ,fstype = \"vfat\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/boot/efi\" } 100663296 # Group 2{device=\"/dev/sda5\",instance=\"localhost:9100\",job=\"node\"} node_filesystem_size_bytes { device = \"/dev/sda5\" ,fstype = \"ext4\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/\" } 90131324928 # Group 3 {device=\"tmpfs\",instance=\"localhost:9100\",job=\"node\"} node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/lock\" } 5242880 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/1000\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/119\" } 826961920 sum \u904b\u7b97\u7b26\u5c0d\u6bcf\u500b\u7d44\u4e2d\u7684\u6a23\u672c\u503c\u6c42\u548c\uff0c\u4e26\u8fd4\u56de\u6bcf\u7d44\u4e00\u500b\u6a23\u672c\uff1a { device = \"/dev/sda1\" ,instance = \"localhost:9100\" ,job = \"node\" } 100663296 { device = \"/dev/sda5\" ,instance = \"localhost:9100\" ,job = \"node\" } 90131324928 { device = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" } 2486128640 \u6ce8\u610f\uff1a\u7d50\u679c\u4e0d\u518d\u8207\u8f38\u5165\u6307\u6a19\u7684\uff08\u540d\u7a31\uff09\u76f8\u95dc\uff01\u540d\u7a31 node_filesystem_size_bytes \u5df2\u6d88\u5931\uff0c\u56e0\u70ba\u7d50\u679c\u4e0d\u518d\u985e\u4f3c\u65bc\u7531\u8a72\u5ea6\u91cf\u540d\u7a31\u6e2c\u91cf\u7684\u539f\u59cb\u503c\u3002 \u4e8c\u5143\u904b\u7b97\u7b26\u4e4b\u6240\u4ee5\u9019\u6a23\u7a31\u547c\uff0c\u662f\u56e0\u70ba\u5b83\u5011\u5c07\u5169\u500b\u8f38\u5165\u64cd\u4f5c\u6578\u4f5c\u70ba\u8f38\u5165\u3002 \u4e8c\u5143\u904b\u7b97\u7b26\u5206\u70ba\u4e09\u7a2e\uff1a \u7b97\u8853\u904b\u7b97\u7b26 (Arithmetic): + \u2013 * / ^ % \u6bd4\u8f03\u904b\u7b97\u7b26 (Comparison): larger / smaller (or equal), equal, unequal \u908f\u8f2f\u904b\u7b97\u7b26 (Logical): and, or, unless \u5927\u591a\u6578\u4e8c\u5143\u904b\u7b97\u7b26\u5c07\u5169\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\uff0c\u4e26\u7522\u751f\u4e00\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u51fa\u3002\u4f46\u662f\u4e00\u4e9b\u904b\u7b97\u7b26\u4e5f\u652f\u6301\u6a19\u91cf(scalar)\u4f5c\u70ba\u8f38\u5165\u4e4b\u4e00\uff0c\u4f8b\u5982\u8af8\u5982 some_metric / 1024 \u4e4b\u985e\u7684\u67e5\u8a62\u3002 \u96d6\u7136\u7b97\u8853\u904b\u7b97\u7b26\u5f88\u5bb9\u6613\u7406\u89e3\u548c\u4f7f\u7528\uff0c\u4f46\u95dc\u65bc\u6bd4\u8f03\u904b\u7b97\u7b26\u548c\u908f\u8f2f\u904b\u7b97\u7b26\u6709\u5e7e\u9ede\u9700\u8981\u4e86\u89e3\uff1a \u6bd4\u8f03\u904b\u7b97\u7b26 (Comparison): \u9019\u4e9b\u904b\u7b97\u7b26\u4e0d\u6703\u66f4\u6539\u7d50\u679c\u4e2d\u7684\u503c\uff08\u4f8b\u5982\u66f4\u6539\u70ba\u771f/\u5047\uff09\u3002\u76f8\u53cd\uff0c\u5b83\u5011\u8fd4\u56de\u904b\u7b97\u7b26\u5de6\u5074\u7684\u8f38\u5165\u5411\u91cf\u7684\u6a23\u672c\uff0c\u904e\u6ffe\u6389\u6bd4\u8f03\u7d50\u679c\u70ba\u5047\u7684\u90a3\u4e9b\u6a23\u672c\u3002 \u5982\u679c\u60a8\u4e0d\u60f3\u904e\u6ffe\u6a23\u672c\uff08\u5373\u5f9e\u7d50\u679c\u4e2d\u4e1f\u5931\uff09\uff0c\u4f46\u5728\u7d50\u679c\u4e2d\u5c07\u5b83\u5011\u7684\u503c\u70ba 0\uff0c\u8acb\u4f7f\u7528 bool \u95dc\u9375\u5b57\uff0c\u4f8b\u5982 some_metric > bool 10 \uff08\u800c\u4e0d\u662f some_metric > 10 \uff09\u3002\u4f46\u662f\uff0c\u90a3\u4e9b\u6bd4\u8f03\u8a55\u4f30\u70ba\u771f\u7684\u6a23\u672c\u5c07\u53ea\u6709\u4e00\u500b\u503c 1 \u800c\u4e0d\u662f\u5be6\u969b\u5b58\u5132\u7684\u503c\u3002 \u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002 \u908f\u8f2f\u904b\u7b97\u7b26 (Logical): and \u53d6\u5de6\u53f3\u5169\u908a\u6578\u64da\u7684\u4ea4\u96c6\u3002\u53ea\u6709\u7576\u53f3\u5074\u6709\u5339\u914d\u7684\u6a23\u672c\u6642\uff0c\u5b83\u624d\u6703\u5f9e\u5de6\u5074\u8fd4\u56de\u6a23\u672c\u3002\u9019\u5728\u8b66\u5831\u4e2d\u5f88\u6709\u7528\uff0c\u53ef\u4ee5\u6307\u5b9a\u591a\u500b\u689d\u4ef6\u3002 or \u5f9e\u4efb\u4e00\u5074\u8fd4\u56de\u6a23\u672c\uff0c\u66f4\u559c\u6b61\u5de6\u5074\u7684\u6578\u64da\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u4f86\u81ea\u5de6\u5074\u548c\u53f3\u5074\u7684\u6a23\u672c\u88ab\u5206\u7d44\uff08\u4e26\u4e14 Prometheus \u5617\u8a66\u627e\u5230\u5339\u914d\u9805\uff09\u3002\u5c0d\u65bc\u6bcf\u500b\u7d44\uff0c\u4ee5\u4e0b\u6210\u7acb\uff1a\u5982\u679c\u8a72\u7d44\u5de6\u5074\u6709\u6a23\u672c\uff0c\u5247\u8fd4\u56de\u9019\u4e9b\u6a23\u672c\uff0c\u5982\u679c\u6c92\u6709\uff0c\u5247\u5f9e\u53f3\u5074\u8fd4\u56de\u6a23\u672c unless \u5f9e\u5de6\u5074\u8fd4\u56de\u6a23\u672c\uff0c\u9664\u975e\u53f3\u5074\u6709\u6a23\u672c\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\u4e0d\u8fd4\u56de\u4efb\u4f55\u5167\u5bb9\u3002\u5982\u679c\u7f3a\u5c11\u67d0\u4e9b\u6307\u6a19\uff0c\u9019\u5c0d\u65bc\u5728\u60a8\u60f3\u8981\u767c\u51fa\u8b66\u5831\u7684\u60c5\u6cc1\u4e0b\u767c\u51fa\u8b66\u5831\u5f88\u6709\u7528\u3002 and \u8207 \u5df7unless\u5df7 \u904b\u7b97\u7b26\u652f\u6301 on(...) \u548c ignoring(...) \uff08\u4f46 or \u904b\u7b97\u7b26\u4e0d\u652f\u6301\uff01\uff09 \u6c92\u6709 not \u904b\u7b97\u7b26\u3002\u8acb\u6539\u7528 absent() \u51fd\u6578\uff01 \u5982\u679c\u4e00\u500b\u7a7a\u7684\u5373\u6642\u5411\u91cf\uff08\u5373\u7f3a\u5931\u7684\u7d50\u679c\uff09\u88ab absent() \u51fd\u6578\u904b\u7b97\u6642\uff0c\u5b83\u6703\u8fd4\u56de\u4e00\u500b\uff08\u901a\u5e38\u662f\u7121\u6a19\u7c64\u7684\uff09\u5373\u6642\u5411\u91cf\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u500b\u503c\u70ba 1 \u7684\u6a23\u672c\u3002\u8fd4\u56de\u7684\u7d50\u679c\u53ef\u4ee5\u6709\u6a19\u7c64\uff0c\u4f8b\u5982\u7576\u4f60\u8abf\u7528 absent(up{job=\"missing\"}) \u6642\uff0c\u5b83\u6703\u8fd4\u56de {job=\"missing\"} 1 \u3002 \u7576\u60a8\u7d44\u5408\u7531\u4e8c\u5143\u904b\u7b97\u7b26\u7d44\u6210\u7684\u5d4c\u5957\u5b50\u67e5\u8a62\u6642\uff0c\u4e26\u4e0d\u7e3d\u662f\u6e05\u695a\u54ea\u4e9b\u904b\u7b97\u7b26\u5177\u6709\u66f4\u9ad8\u7684\u512a\u5148\u7d1a\u3002\u5728 Prometheus \u4e2d\uff0c\u904b\u7b97\u7b26\u512a\u5148\u7d1a\uff08\u5f9e\u9ad8\u5230\u4f4e\uff09\u662f\uff1a - ^ - * , / , % - + , - - == , != , <= , < , >= , > - and , unless - or \u4f8b\u5982\uff0c\u5c0d\u65bc some_metric * 2 ^ 3 \u9019\u6a23\u7684\u67e5\u8a62\uff0cPrometheus \u5c07\u9996\u5148\u8a08\u7b97 2^3 (=8)\uff0c\u7136\u5f8c\u5c07 some_metric \u7684\u6a23\u672c\u503c\u4e58\u4ee5 8\uff0c\u56e0\u70ba ^ \u5177\u6709\u6700\u9ad8\u512a\u5148\u7d1a\u3002 \u51fd\u6578\u5c07\u5373\u6642\u5411\u91cf\u6216\u7bc4\u570d\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\uff0c\u901a\u5e38\u6703\u751f\u6210\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u7d50\u679c\u3002\u6709\u4e00\u4e9b\u4f8b\u5916\u6703\u8fd4\u56de\u6a19\u91cf\uff0c\u4f8b\u5982 time() \u548c scalar()\u3002 \u5982\u5b98\u65b9\u6587\u6a94\u6240\u793a\uff0c\u6709\u6578\u5341\u7a2e\u51fd\u6578\u53ef\u7528\u65bc\u5404\u7a2e\u7528\u9014\uff0c\u4f8b\u5982\u6578\u5b78\u51fd\u6578\u6216\u8207\u65e5\u671f/\u6642\u9593\u76f8\u95dc\u7684\u51fd\u6578\u3002\u89e3\u91cb\u5b83\u5011\u90fd\u9700\u8981\u5f88\u9577\u7684\u6587\u7ae0\u3002 \u76f8\u53cd\uff0c\u6211\u53ea\u60f3\u89e3\u91cb\u4e00\u500b\u51fd\u6578\uff0c rate() \uff0c\u4f60\u5728 PromQL \u67e5\u8a62\u4e2d\u7d93\u5e38\u9700\u8981\u5b83\uff0c\u800c\u5b98\u65b9\u6587\u6a94\u5c0d\u5b83\u7684\u89e3\u91cb\u7279\u5225\u5dee\u3002 rate() \u9700\u8981\u4e00\u500b counter \u985e\u578b\u6307\u6a19\u7684\u7bc4\u570d\u5411\u91cf\u3002\u56e0\u70ba counter \u7684\u6a23\u672c\u503c\u662f\u55ae\u8abf\u905e\u589e\u7684\uff0c\u6240\u4ee5\u5b83\u5011\u5c0d\u65bc\u7e6a\u5716\u6216\u5728\u539f\u59cb\u5f62\u5f0f\u7684\u8b66\u5831\u67e5\u8a62\u4e2d\u6c92\u6709\u7528\u2014\u2014\u60a8\u5c07\u4e0d\u77e5\u9053\u5c07\u5b83\u5011\u8207\u4ec0\u9ebc\u503c\u9032\u884c\u6bd4\u8f03\u3002 rate() \u51fd\u6578\u5728\u9019\u88e1\u53ef\u4ee5\u70ba\u60a8\u63d0\u4f9b\u5e6b\u52a9\uff0c\u56e0\u70ba\u5b83\u901a\u904e\u8a08\u7b97\u5b9a\u7fa9\u6642\u9593\u6bb5\u5167\u7684\u6a23\u672c\u503c\u7684\u589e\u91cf\u4f86\u201c\u58d3\u5e73\u201d\u9019\u7a2e\u55ae\u8abf\u905e\u589e\u7684\u503c\uff0c\u4e26\u5c07\u589e\u91cf\u503c\u6a19\u6e96\u5316\u70ba\u201c\u6bcf\u79d2\u201d\u3002 \u4e00\u500b\u4f8b\u5b50\u5c0d\u66f4\u597d\u5730\u7406\u89e3\u9019\u4e00\u9ede\u5f88\u6709\u5e6b\u52a9\u3002\u5047\u8a2d process_cpu_seconds_total[5m] \u7684\u7bc4\u570d\u5411\u91cf\u8fd4\u56de\u4ee5\u4e0b\u6a23\u672c\uff08\u50c5\u986f\u793a\u4e00\u500b\u7279\u5b9a\u6642\u9593\u5e8f\u5217\u7684\u6a23\u672c\uff0c\u6a19\u7c64\u70ba (instance=\"demo.robustperception.io:9090\", job=\"prometheus\"\uff09 \uff1a 4858038 .33 @1633506420.307 4858045 .41 @1633506430.304 ... \u9084\u6709 24 \u500b\u6a23\u672c\uff0c\u70ba\u7c21\u6f54\u8d77\u898b\u7701\u7565 ... 4858214 .65 @1633506680.311 4858221 .63 @1633506690.312 rate() \u5728\u6982\u5ff5\u4e0a\u6240\u505a\u7684\u8a08\u7b97\u662f\uff1a ( latest value - oldest value ) / ( latest timestamp - oldest timestamp ) \u4e5f\u5c31\u662f\uff0c\u6211\u5011\u5c07\u6a23\u672c\u503c\u589e\u91cf\uff08\u6b64\u8655\u70ba 4858221.63 \u2013 4858038.33 = 183.3 CPU \u79d2\uff09\u9664\u4ee5\u6642\u9593\u6233\u589e\u91cf\uff081633506690.312 \u2013 1633506420.307 = 270 \u79d2\uff09\uff0c\u5f97\u5230\u6bcf\u79d2\u7d04 0.68 \u7684\u901f\u7387\u3002\u6211\u5011\u6307\u5b9a\u7684\u6642\u9593\u7a97\u53e3\uff08\u6b64\u8655\uff1a [5m] \uff09\u6307\u5b9a\u4e86\u5e73\u5747/\u5e73\u6ed1\u6548\u679c\u7684\u5f37\u5ea6\u2014\u2014\u6642\u9593\u7a97\u53e3\u8d8a\u5927\uff0c\u5e73\u5747\u503c\u8d8a\u5f37\u3002 \u5be6\u969b\u4e0a\uff0c\u8a72\u7b97\u6cd5\u8981\u5fa9\u96dc\u5f97\u591a\u3002 rate() \u667a\u80fd\u5730\u8003\u616e\u4e1f\u5931\u7684\u6a23\u672c\u503c\uff0c\u4e26\u4e14\u9084\u8655\u7406\u8a08\u6578\u5668\u91cd\u7f6e\uff08\u7531\u65bc\u5c0e\u51fa\u61c9\u7528\u7a0b\u5e8f\u5d29\u6f70/\u91cd\u65b0\u555f\u52d5\uff0c\u6293\u53d6\u7684\u6a23\u672c\u503c\u6b63\u5728\u6e1b\u5c11\uff09\u3002 \u7576\u60a8\u5728\u5c07 rate(some_metric[...]) \u7e6a\u88fd\u70ba\u4e00\u689d\u7dda\u7684\u5716\u8868\u4e2d\u4f7f\u7528 rate() \u6642\uff0c\u5f9e\u6982\u5ff5\u4e0a\u8b1b\uff0c\u8a72\u7dda\u7684\u6bcf\u500b\u50cf\u7d20\u90fd\u662f\u901a\u904e\u5206\u5225\u8abf\u7528 rate() \u5275\u5efa\u7684\uff0c\u5c07\u6642\u9593\u7a97\u53e3\u504f\u79fb\u5e7e\u79d2\u9418\u6bcf\u4e00\u6b21\u3002\u7576\u7136\uff0c\u5be6\u969b\u4e0a\uff0c\u9084\u6709\u66f4\u9ad8\u6548\u7684 API\uff0c\u5176\u4e2d\u4e00\u6b21\u8abf\u7528\u5c07\u751f\u6210\u5716\u5f62\u6240\u9700\u7684 rate() \u503c\u6578\u7d44\u3002 \u95dc\u65bc rate() \u7684\u4e00\u4e9b\u63d0\u793a\uff1a - \u60a8\u63d0\u4f9b\u7d66 rate() \u7684\u6642\u9593\u7a97\u53e3\uff08\u4f8b\u5982 [5m]\uff09\u61c9\u81f3\u5c11\u662f\u70ba\u63d0\u4f9b\u76f8\u61c9\u6307\u6a19\u7684\u76ee\u6a19\u914d\u7f6e\u7684\u6293\u53d6\u9593\u9694\u7684 4 \u500d\u3002 - \u7576\u60a8\u5c07 rate() \u8207 sum() \u7d50\u5408\u4f7f\u7528\u6642\uff0c\u59cb\u7d42\u8abf\u7528 sum by(...)(rate(<counter-type metric>)) \uff0c\u800c\u4e0d\u662f\u76f8\u53cd\uff0c\u56e0\u70ba\u9019\u6a23\u60a8\u5c07\u532f\u7e3d\u539f\u59cb\u8a08\u6578\u5668\u6a23\u672c\u503c\uff0c\u9019\u662f\u6c92\u6709\u610f\u7fa9\u7684\u3002 \u5411\u91cf\u5339\u914d (Vector matching) \u00b6 \u7576\u7d66\u5b9a\u4e8c\u5143\u904b\u7b97\u7b26\u4f5c\u70ba\u8f38\u5165\u7684\u5169\u500b\u5373\u6642\u5411\u91cf\u6642\uff0c\u5b83\u5fc5\u9808\u5c07\u904b\u7b97\u7b26\u5de6\u5074\u7684\u6642\u9593\u5e8f\u5217\u884c\u8207\u53f3\u5074\u7684\u884c\u5339\u914d\u3002\u9019\u7a31\u70ba\" \u5411\u91cf\u5339\u914d \"\u3002\u8003\u616e\u5230\u6a19\u7c64\u6216\uff08\u6578\u91cf\uff09\u6a23\u672c\uff0c\u6216\u5169\u8005\u90fd\u53ef\u80fd\u5b58\u5728\u5dee\u7570\u3002 \u5982\u679c\u4f60\u5f88\u5e78\u904b\uff0c\u6a19\u7c64\u548c\u6837\u672c\u8a08\u6578\u662f\u4e00\u5c0d\u4e00\u7684\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\u4f60\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u7279\u5225\u7684\u4e8b\u60c5\u2014\u2014\u4f60\u7684 PromQL \u67e5\u8a62\u53ef\u4ee5\u7c21\u55ae\u5730\u662f <left expression> <operator> <right expression> \u3002 Prometheus \u53ef\u4ee5\u5c07\u6a23\u672c\u8207\u6a19\u7c64\u5339\u914d\u7684\u5176\u4ed6\u6a23\u672c\u9032\u884c\u5339\u914d\u3002 \u4f46\u662f\uff0c\u901a\u5e38\u60c5\u6cc1\u4e26\u975e\u5982\u6b64\uff0c\u5982\u679c\u4e8c\u5143\u904b\u7b97\u7b26\u67e5\u8a62\u7684\u7d50\u679c\u662f\u4e00\u500b\u7a7a\u7684\u5373\u6642\u5411\u91cf\uff0c\u60a8\u53ef\u4ee5\u5f9e\u5339\u914d\u51fa\u73fe\u554f\u984c\u7684\u4e8b\u5be6\u4e2d\u770b\u51fa\u9019\u4e00\u9ede\u3002\u5e78\u904b\u7684\u662f\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u6a5f\u5236\u4f86\u8655\u7406\u9019\u4e9b\u554f\u984c\uff1a \u8981\u8655\u7406\u6a19\u7c64\u4e0d\u5339\u914d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u95dc\u9375\u5b57 ignoring \u6216 on \uff0c\u5176\u5de5\u4f5c\u65b9\u5f0f\u8207\u95dc\u9375\u5b57 without \u6216 by \u5c0d\u805a\u5408\u904b\u7b97\u7b26\u7684\u5de5\u4f5c\u65b9\u5f0f\u975e\u5e38\u76f8\u4f3c\u3002 \u5177\u9ad4\u4f8b\u5b50\uff1a sum without ( cpu )( rate ( node_cpu_seconds_total { mode = \"idle\" }[ 5m ])) / ignoring ( mode ) sum without ( mode, cpu )( rate ( node_cpu_seconds_total [ 5m ])) - \u5f37\u70c8\u5efa\u8b70\u60a8\u6253\u958b PromLens \u6f14\u793a \u4e26\u904b\u884c\u4e0a\u8ff0\u67e5\u8a62\u3002\u901a\u904e\u55ae\u64ca PromLens \u4e2d\u7684\u4e0d\u540c\u7bc0\u9ede\uff0c\u60a8\u53ef\u4ee5\u8f15\u9b06\u4e86\u89e3\uff08\u4e2d\u9593\uff09\u7d50\u679c\u662f\u4ec0\u9ebc\u3002\u5f88\u660e\u986f\uff0c\u8af8\u5982: sum without(cpu)(...) / sum without(mode, cpu)(...) \uff08\u5373\uff0c\u7701\u7565 ignoring(mode) \u90e8\u5206\uff09\u4e0d\u6703\u8d77\u4f5c\u7528\uff08\u4e0d\u6703\u986f\u793a\u932f\u8aa4\uff0c\u4f46\u60a8\u6703\u5f97\u5230\u4e00\u500b\u7a7a\u7684\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u7d50\u679c\uff09\uff0c\u56e0\u70ba\u7b2c\u4e00\u500b sum \u904b\u7b97\u7b26\u7684\u7d50\u679c\u5177\u6709\u6a19\u7c64 instance\u3001job\u3001node\uff0c\u4f46\u7b2c\u4e8c\u500b\u6c42\u548c\u904b\u7b97\u7b26\u7d50\u679c\u53ea\u6709\u6a19\u7c64 instance, job\u3002 \u5982\u60a8\u6240\u898b\uff0c\u95dc\u9375\u5b57\uff08 ignoring \u6216 on \uff09\u5fc5\u9808\u7dca\u6328\u4e8c\u5143\u904b\u7b97\u7b26\u7684\u53f3\u5074\u3002 \u5982\u679c\u6a19\u7c64\u5339\u914d\uff08\u6216\u8005\u60a8\u4f7f\u7528\u4e0a\u8ff0 ignoring() \u6280\u5de7\u4f7f\u5b83\u5011\u5339\u914d\uff09\uff0c\u4f46\u6a23\u672c/\u7d50\u679c\u884c\u7684\u6578\u91cf\u4e0d\u5339\u914d\uff0c\u60a8\u6703\u6536\u5230\u4e00\u689d\u932f\u8aa4\u6d88\u606f\uff0c\u4f8b\u5982 \u201cmultiple matches for labels: many-to-one matching must be explicit (group_left/group_right)\u201c\uff0c\u56e0\u70ba\u4f60\u6709 many-to-one (rows) \u5339\u914d\u7684\u60c5\u6cc1\u3002 \u5982\u679c\u60a8\u63a1\u7528\u4e0a\u9762\u7684\u793a\u4f8b\u4e26\u53bb\u9664\u4e86 {mode=\"idle\"} \u90e8\u5206\uff0c\u5c31\u6703\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\u3002\u53ea\u9700\u5728 PromLens \u4e2d\u5617\u8a66\uff01\u60a8\u6703\u770b\u5230\u7b2c\u4e00\u500b\u6c42\u548c\u7d50\u679c\u73fe\u5728\u6709\u8a31\u591a\u6642\u9593\u5e8f\u5217\uff08\u6bcf\u500b CPU \u6a21\u5f0f\u4e00\u500b\uff09\uff0c\u4f46\u7b2c\u4e8c\u500b\u6c42\u548c\u7d50\u679c\u4ecd\u7136\u53ea\u6709\u4e00\u500b\u6642\u9593\u5e8f\u5217\u884c\u3002 - PromQL \u78ba\u5be6\u652f\u6301\u591a\u5c0d\u4e00\u5339\u914d\uff0c\u4f46\u60a8\u5fc5\u9808\u901a\u904e\u5728\u4e8c\u5143\u904b\u7b97\u7b26\u53f3\u5074\u6dfb\u52a0 `group_left` \u95dc\u9375\u5b57\u4f86\u660e\u78ba\u544a\u8a34 Prometheus \u9019\u662f\u60a8\u60f3\u8981\u7684\u3002\u5982\u679c\u4f60\u5df2\u7d93\u6709 `ignoring(\u2026)` \u6216 `on(\u2026)` \uff0c `group_left` \u5fc5\u9808\u5728\u5b83\u4e4b\u5f8c\uff09\u3002\u56e0\u6b64\uff0c\u8a9e\u6cd5\u662f\uff1a ```bash <left expression> <operator> [ignoring(labels) | on(labels)] group_left <right expression> ``` - \u672c\u8cea\u4e0a\uff0c`group_left` \u6216 `group_right` \u6307\u793a Prometheus \u5728\u904b\u7b97\u7b26\u7684\u76f8\u61c9\u53e6\u4e00\u5074\u8907\u88fd\u7d50\u679c\u884c/\u6a23\u672c\uff0c\u4ee5\u4fbf\u60a8\u518d\u6b21\u7372\u5f97\u96d9\u65b9\u6a23\u672c\u4e4b\u9593\u7684\u4e00\u5c0d\u4e00\u5339\u914d\u3002\u5728\u6211\u5011\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u5011\u61c9\u8a72\u4f7f\u7528 `group_left`\uff0c\u56e0\u70ba\u904b\u7b97\u7b26\u7684\u53f3\u5074\u662f\u5177\u6709\u8f03\u5c11\u6642\u9593\u5e8f\u5217\u884c\uff08\u9700\u8981\u5fa9\u5236\uff09\u7684\u4e00\u5074\u3002 - \u9084\u6709\u4e00\u500b `group_right` \u95dc\u9375\u5b57\uff0c\u985e\u4f3c\u65bc `group_left`\uff0c\u4f46\u4f5c\u7528\u65b9\u5411\u76f8\u53cd\u3002 - \u901a\u904e\u4f7f\u7528\u8a9e\u6cd5 `group_left(label1,label2,\u2026)` \uff08\u800c\u4e0d\u50c5\u50c5\u662f `group_left`\uff09\uff0c\u6700\u7d42\u7d50\u679c\u5c07\u4e0d\u50c5\u5305\u542b\u904b\u7b97\u7b26\u5de6\u5074\u7d50\u679c\u4e2d\u5b58\u5728\u7684\u6a19\u7c64\uff0c\u800c\u4e14 Prometheus \u9084\u5c07\u5fa9\u5236\u6307\u5b9a\u7684\u6a19\u7c64\uff08\u6b64\u8655\uff1a\u904b\u7b97\u7b26\u53f3\u5074\u7684 label1 \u548c label2) \u9032\u5165\u7d50\u679c\u3002\u4e00\u500b\u5178\u578b\u7684\u7528\u4f8b\u662f\u4f7f\u7528\u4f86\u81ea\u53e6\u4e00\u500b\u6307\u6a19\u7684\u503c\u4f86\u8c50\u5bcc\u7d50\u679c\uff0c\u4f8b\u5982: ```bash up * on(instance) group_left(version) prometheus_build_info ``` \u5b83\u4f7f\u7528 prometheus_build_info \u6307\u6a19\u7684\u7248\u672c\u6a19\u7c64\u8c50\u5bcc\u4e86 up \u6307\u6a19\uff08\u5177\u6709 instance \u548c job \u6a19\u7c64\uff09\u3002 - \u6ce8\u610f\uff1aPrometheus \u4e0d\u652f\u6301\u591a\u5c0d\u591a\u5339\u914d\uff0c\u53ea\u652f\u6301\u4e00\u5c0d\u4e00\u6216\u591a\u5c0d\u4e00\u6216\u4e00\u5c0d\u591a\uff01 PromQL \u5c0f\u6280\u5de7 \u00b6 \u6307\u6a19\u540d\u7a31\u8a9e\u6cd5\u7cd6 \u00b6 \u5728 PromQL \u4e2d\uff0c\u50cf metric_name{key=\"value\"} \u9019\u6a23\u7684\u6771\u897f\u53ea\u662f {__name__=\"metric_name\",key=\"value\"} \u7684\u8a9e\u6cd5\u7cd6 \u907f\u514d\u4f7f\u7528\u7a7a\u9078\u64c7\u5668 \u00b6 \u7de8\u5beb\u67e5\u8a62\u6642\uff0c\u60a8\u8981\u561b\u5fc5\u9808\u7701\u7565\u9078\u64c7\u5668\uff08\u4f8b\u5982 some_metric\uff09\uff0c\u8981\u561b\u5728\u9078\u64c7\u5668\u4e2d\u6307\u5b9a\u81f3\u5c11\u4e00\u500b\u6a19\u7c64\uff08\u4f8b\u5982 some_metric{ key=\"value\" }\uff0c\u5176\u4e2d\u82b1\u62ec\u865f\u90e8\u5206\u662f\u9078\u64c7\u5668\uff09\u3002\u4f60\u4e0d\u80fd\u53ea\u4f7f\u7528\u4e00\u500b\u7a7a\u7684\u9078\u64c7\u5668\u2014\u2014\u50cf some_metric{} \u751a\u81f3\u53ea\u662f {} \u662f\u4e0d\u5141\u8a31\u7684\uff0c\u56e0\u70ba\u9019\u53ef\u80fd\u6703\u4f7f Prometheus \u670d\u52d9\u5668\u904e\u8f09\uff0c\u4e26\u4e14\u6709\u4e00\u500b\u5b89\u5168\u63aa\u65bd\u53ef\u4ee5\u907f\u514d\u9019\u7a2e\u904e\u8f09\u3002 \u53e6\u4e00\u689d\u898f\u5247\u662f\uff0c\u9078\u64c7\u5668\u4e2d\u5fc5\u9808\u81f3\u5c11\u6709\u4e00\u500b\u5339\u914d\u5668\uff0c\u5176\u503c\u8207\u7a7a\u5b57\u7b26\u4e32\u4e0d\u540c\u3002\u4f8b\u5982\uff0c\u8af8\u5982 {foo=\"\"}\u3001{foo!=\"\"} \u548c {foo=~\".*\"} \u4e4b\u985e\u7684\u67e5\u8a62\u5c07\u8fd4\u56de\u932f\u8aa4\uff0c\u56e0\u70ba\u5b83\u5011\u90fd\u53ea\u662f\u4f7f\u7528\uff08\u6216\u5339\u914d\uff09\u4e00\u500b\u7a7a\u5b57\u7b26\u4e32\u4f5c\u70ba\u5339\u914d\u5668\u4e2d\u7684\u503c\uff01 \u7372\u53d6\u5b58\u5132\u5728 Prometheus \u4e2d\u7684\u6240\u6709\uff08\u6216\u7279\u5b9a\uff09\u6642\u9593\u5e8f\u5217\u7684\u5217\u8868 \u00b6 \u4f7f\u7528\u8af8\u5982 { name =~\".+\"} \u4e4b\u985e\u7684\u67e5\u8a62\u4f86\u7372\u53d6\u5b58\u5132\u5728\u670d\u52d9\u5668\u4e0a\u7684\u6240\u6709\u6642\u9593\u5e8f\u5217\u7684\u5217\u8868\u3002 \u50cf { name =~\"foo.*\"} \u9019\u6a23\u7684\u6771\u897f\u6703\u6aa2\u7d22\u4ee5 foo \u958b\u982d\u7684\u90a3\u4e9b\u6642\u9593\u5e8f\u5217\u7684\u5217\u8868\u3002 \u5982\u679c\u60a8\u4e0d\u719f\u6089\u6b63\u5247\u8868\u9054\u5f0f\uff1a . \u4ee3\u8868\u5b57\u7b26\u985e\uff08\u5339\u914d\u4efb\u4f55\u5b57\u7b26\uff09\uff0c + \u5f8c\u7db4\u4ee3\u8868\u201c\u81f3\u5c11\u4e00\u6b21\u201d\uff0c\u56e0\u6b64\u5169\u500b\u5b57\u7b26 .+ \u4e00\u8d77\u544a\u8a34 Prometheus \u5339\u914d\u540d\u7a31\u81f3\u5c11\u5305\u542b\u4e00\u500b\u5b57\u7b26\u7684\u4efb\u4f55\u6307\u6a19\u3002 \u805a\u5408\u904b\u7b97\u7b26\uff1aby \u8207 without \u00b6 \u4f7f\u7528\u805a\u5408\u904b\u7b97\u7b26\u6642\uff0c\u60a8\u901a\u5e38\u61c9\u8a72\u66f4\u559c\u6b61\u4f7f\u7528: <aggregation operator e.g. sum> without ( label1,label2 )( ... ) \u800c\u4e0d\u662f: <aggregation operator e.g. sum> by ( somelabel )( ... ) \u70ba\u4ec0\u9ebc? \u56e0\u70ba\u6642\u9593\u5e8f\u5217\u7684\u6a19\u7c64\u4e26\u4e0d\u7e3d\u662f\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u800c\u7a69\u5b9a\u3002\u6a19\u7c64\u901a\u5e38\u662f\u5100\u5668\u6a19\u7c64\uff08\u901a\u5e38\u4e0d\u6703\u66f4\u6539\uff09\u6216\u76ee\u6a19\u6a19\u7c64\uff08\u7531 Prometheus \u5728\u6293\u53d6\u671f\u9593\u9644\u52a0\uff09\u3002\u76ee\u6a19\u6a19\u7c64\u662f\u975e\u5e38\u52d5\u614b\u7684\uff0c\u4e26\u4e14\u901a\u5e38\u4e0d\u53d7\u7de8\u5beb PromQL \u67e5\u8a62\u7684\u4eba\u7684\u63a7\u5236\u3002\u56e0\u6b64\uff0c\u6700\u597d\u4e0d\u4f7f\u7528\u805a\u5408\uff08\u5728\u7d55\u5c0d\u5df2\u77e5\u7684\u6a19\u7c64\u4e0a\u805a\u5408\uff0c\u9019\u6703\u5c07\u5b83\u5011\u5f9e\u7d50\u679c\u4e2d\u522a\u9664\uff09\uff0c\u5c07\u751f\u6210\u7684\u5373\u6642/\u7bc4\u570d\u5411\u91cf\u8207\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u4e00\u8d77\u4f7f\u7528\u3002 \u9019\u7a2e\u65b9\u6cd5\u8b93\u67e5\u8a62\u4f5c\u8005\u5728\u7a81\u7136\u5f48\u51fa\u65b0\u6a19\u7c64\u6642\u6ce8\u610f\u5230\uff08\u4f8b\u5982\u5728\u5100\u8868\u677f\u6216\u8b66\u5831\u901a\u77e5\u4e2d\uff09\uff0c\u7136\u5f8c\u4ed6\u5011\u53ef\u4ee5\u5728\u9700\u8981\u6642\u8abf\u6574 PromQL \u67e5\u8a62\u3002\u4f7f\u7528 without \u5c0d\u65bc\u8b66\u5831\u898f\u5247\u5c24\u5176\u91cd\u8981\uff0c\u4ee5\u4fdd\u7559\u8b66\u5831\u901a\u77e5\u4e2d\u7684\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002 by \u805a\u5408\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\u4ecd\u7136\u6709\u7528\uff0c\u4f8b\u5982\u5728\u5c0d\u4fe1\u606f\u6307\u6a19\u9032\u884c\u805a\u5408\u6642\uff08\u9810\u8a08\u5176\u5100\u8868\u6a19\u7c64\u6703\u66f4\u983b\u7e41\u5730\u66f4\u6539\uff09\uff0c\u4f8b\u5982\u4e00\u500b\u67e5\u8a62\uff0c\u4f8b\u5982 count by(release)(node_uname_info) Alerting rule \u5c0f\u6280\u5de7 \u00b6 \u5982\u679c\u60a8\u5e0c\u671b\u8b66\u5831\u50c5\u5728\u7279\u5b9a\u6642\u9593\u89f8\u767c\uff0c\u8acb\u7de8\u5beb\u5982\u4e0b\u5167\u5bb9\uff1a <alert rule> and on() hour() > 9 < 17 on() \u78ba\u4fdd\u5373\u6642\u5411\u91cf\u5339\u914d\u4ecd\u7136\u767c\u751f\uff0c\u5373\u4f7f\u8a9e\u53e5\u7684\u8f38\u51fa\u5728\u5de6\u5074\u548c\u53f3\u5074\u4e26\u4e14\u6c92\u6709\u5171\u540c\u7684\u6a19\u7c64\u3002 \u9664\u4e86 hour() \uff0c\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u51fd\u6578\uff0c\u4f8b\u5982 minute \uff0c day_of_week \uff0c day_of_month \uff0c month \uff0c year \u5728\u60a8\u7684 alert-rules.yml \u6587\u4ef6\u4e2d\uff0c\u81f3\u5c11\u4f7f\u7528\uff1a 5m \uff0c\u4ee5\u907f\u514d\u8aa4\u5831\u3002\u7121\u8ad6\u5982\u4f55\uff0c\u4f60\u4e0d\u80fd\u66f4\u5feb\u5730\u53cd\u61c9\u4e86\uff01 \u9700\u8981\u6ce8\u610f\u7684\u8b66\u544a\uff1aPrometheus \u4e0d\u6703\u5c07 for \u7684\u72c0\u614b\u6301\u4e45\u5316\u5230\u78c1\u76e4\uff08\u800c\u53ea\u6703\u5c07\u5176\u4fdd\u5b58\u5728 RAM \u4e2d\uff09\uff0c\u56e0\u6b64\u7576\u60a8\u91cd\u65b0\u555f\u52d5 Prometheus \u6642\uff0c\u5b83\u6703\u5f9e\u982d\u958b\u59cb\u8a55\u4f30\uff01 \u91cd\u8981\u63d0\u793a\uff1a for \u671f\u671b\u5c0d\u8a72\u8b66\u5831\u898f\u5247\u7684\u6bcf\u500b\u8a55\u4f30\u90fd\u5305\u542b\u975e\u9673\u820a\u7d50\u679c\u3002\u5047\u8a2d\u60a8\u6709\u4e00\u500b\u5e36\u6709 expr \u7684\u898f\u5247\uff1a process_open_fds > process_max_fds * .8 \u548c for\uff1a5m \u3002 \u5982\u679c\u50c5\u5c0d process_open_fds \u6307\u6a19\u7684\u4e00\u6b21\u6293\u53d6\u5931\u6557\uff0c\u5247\u5c0d\u8a72\u8868\u9054\u5f0f\u7684\u8a55\u4f30\u5c07\u7522\u751f\u4e00\u500b\u7a7a\u7d50\u679c\uff08\u56e0\u70ba\u904e\u6642\u6a19\u8a18\uff09\uff0c\u4e26\u4e14 for \u72c0\u614b\u5c07\u88ab\u91cd\u7f6e\u3002\u6709\u95dc\u904e\u6642\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u898b\u6b64\u8655\u3002\u89e3\u6c7a\u65b9\u6cd5\u662f\u4f7f\u7528 avg_over_time \u3001 max_over_time \u7b49\u51fd\u6578\uff0c\u4f8b\u5982\u5c07\u4e0a\u8ff0\u793a\u4f8b\u8abf\u6574\u70ba max_over_time(process_open_fds[5m]) > max_over_time(process_max_fds[5m]) * .8 - \u6ce8\u610f\uff1aup \u6307\u6a19\u662f\u4e00\u7a2e\u7279\u6b8a\u60c5\u6cc1\u2014\u2014\u9019\u88e1\u9019\u500b\u554f\u984c\u4e0d\u9069\u7528\uff0c\u56e0\u70ba\u5373\u4f7f\u6293\u53d6\u5931\u6557\uff0cup \u4e5f\u5b58\u5728\uff01 \u60a8\u53ef\u4ee5\u4f7f\u7528 amtool check-config \u547d\u4ee4\u4f86\u9a57\u8b49\u60a8\u7684 alertmanager.yml \u914d\u7f6e\u6587\u4ef6\uff0c\u4f8b\u5982\u5728\u63d0\u4ea4\u7248\u672c\u63a7\u5236\u4e4b\u524d\u3002 \u7d50\u8ad6\uff1a\u5c07 PromQL \u67e5\u8a62\u4ed8\u8af8\u5be6\u8e10 \u00b6 PromQL \u67e5\u8a62\u4e3b\u8981\u7528\u65bc\u7de8\u5beb\u8b66\u5831\u898f\u5247\u548c\u69cb\u5efa Grafana \u5100\u8868\u677f\u3002 PromQL \u7684\u4e3b\u8981\u56f0\u96e3\u662f\u5927\u91cf\u53ef\u7528\u7684\u6307\u6a19\u3002\u4f8b\u5982\uff0cPrometheus \u672c\u8eab\u7684 /metrics \u7aef\u9ede\u5df2\u7d93\u64c1\u6709\u8d85\u904e 150 \u500b\u6307\u6a19\uff0cnode exporter \u53ef\u4ee5\u8f15\u9b06\u64c1\u6709\u8d85\u904e 250 \u500b\u6307\u6a19\uff0c\u800c\u5176\u4ed6 exporter\uff08\u6216\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\uff09\u5c07\u64c1\u6709\u66f4\u591a\u3002\u6383\u63cf\u6240\u6709\u9019\u4e9b\u6307\u6a19\u4ee5\u6c7a\u5b9a\u5728\u5100\u8868\u677f\u6216\u8b66\u5831\u898f\u5247\u4e2d\u4f7f\u7528\u54ea\u4e9b\u6307\u6a19\u5c07\u662f\u4e00\u9805\u8271\u9245\u7684\u4efb\u52d9\u3002 \u5e78\u904b\u7684\u662f\uff0cPrometheus \u548c Grafana \u793e\u7fa4\u5df2\u7d93\u70ba\u4f60\u505a\u4e86\u5f88\u591a\u5de5\u4f5c\uff1a \u5c0d\u65bc Grafana \u5100\u8868\u677f\uff0c\u6709\u5b98\u65b9\u7684 \u5100\u8868\u677f\u5b58\u5132\u5eab \uff0c\u5176\u4e2d\u641c\u7d22\u4e00\u4e9b\u7b2c\u4e09\u65b9 exporter\uff08\u4f8b\u5982\u201cpostgres\u201d\u3001\u201cnode exporter\u201d\u7b49\uff09\u5c07\u70ba\u60a8\u63d0\u4f9b\u5927\u91cf\u53ef\u7528\u4f5c\u57fa\u790e\u7684\u5100\u8868\u677f\u3002 \u5c0d\u65bc Alerting rule\uff0c\u6709\u8af8\u5982 Awesome Prometheus alerts \u4e4b\u985e\u7684\u7db2\u7ad9\uff0c\u5176\u4e2d\u5305\u542b\u5404\u7a2e exporter \u7684\u8a31\u591a\u793a\u4f8b\u3002\u4e26\u975e\u6240\u6709\u898f\u5247\u90fd\u662f\u771f\u6b63\u660e\u667a\u7684\uff1a\u60a8\u4ecd\u7136\u9700\u8981\u8a55\u4f30\u6bcf\u689d\u898f\u5247\uff0c\u7121\u8ad6\u5b83\u662f\u5426\u5c0d\u60a8\u7684\u7cfb\u7d71\u6709\u610f\u7fa9\u3002 \u9019\u4e9b\u8cc7\u6e90\u5c07\u5e6b\u52a9\u60a8\u5165\u9580\uff0c\u56e0\u70ba\u60a8\u4e0d\u518d\u9700\u8981\u5f9e\u982d\u958b\u59cb\u7de8\u5beb\u67e5\u8a62\u3002\u76f8\u53cd\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u60a8\u5c0d\u672c\u6587\u4e2d\u63d0\u4f9b\u7684\u904b\u7b97\u7b26\u3001\u51fd\u6578\u7b49\u7684\u7406\u89e3\u4f86\u8abf\u6574\u5b83\u5011\u4ee5\u9069\u61c9\u60a8\u7684\u9700\u6c42\u3002","title":"Part 4. PromQL \u4ecb\u8a54"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#promql","text":"\u539f\u6587: Kubernetes Observability \u2013 Part IV: PromQL tips \u9019\u662f\u5c0d PromQL\uff08Prometheus \u67e5\u8a62\u8a9e\u8a00\uff09\u7684\u6df1\u5165\u63a2\u8a0e\u3002\u672c\u6587\u8a0e\u8ad6\u4e86\u57fa\u672c\u7684\u6578\u64da\u683c\u5f0f\uff08\u5373\u6642\u5411\u91cf\u548c\u7bc4\u570d\u5411\u91cf\uff09\uff0c\u89e3\u91cb\u4e86\u4e0d\u540c\u985e\u578b\u7684\u904b\u7b97\u7b26\u548c\u51fd\u6578\uff0c\u7136\u5f8c\u8a73\u7d30\u8aaa\u660e\u4e86\u4e8c\u5143\u904b\u7b97\u7b26\u5982\u4f55\u9032\u884c\u7d50\u679c\u5411\u91cf\u5339\u914d\u3002\u540c\u6642\u4e5f\u7e3d\u7d50\u4e86\u5404\u7a2e PromQL \u6280\u5de7\u548c\u63d0\u793a\uff0c\u4e26\u5e6b\u52a9\u60a8\u958b\u59cb\u5be6\u8e10\u3002","title":"PromQL \u4ecb\u8a54"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#_1","text":"Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c Observability \u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u4e00\u500b\u91cd\u8981\u7684\u6b65\u9a5f\uff08\u5728\u6280\u8853\u8ecc\u9053\u4e0a\uff09\u662f\u4e86\u89e3 Prometheus \u67e5\u8a62\u8a9e\u8a00 PromQL\u3002\u60a8\u9700\u8981\u5728\u5169\u500b\u5730\u65b9\u4f7f\u7528 PromQL\uff1a\u5728 Prometheus \u672c\u8eab\u4e2d\u69cb\u5efa\u8b66\u5831\u548c\u8a18\u9304\u898f\u5247\uff0c\u4ee5\u53ca\u5728 Grafana \u4e2d\u9078\u64c7\u5100\u8868\u677f\u4e2d\u53ef\u8996\u5316\u7684\u6578\u64da\u3002\u672c\u6587\u8a73\u7d30\u4ecb\u7d39\u4e86 PromQL\u3001\u7d50\u679c\u6578\u64da\u683c\u5f0f\u5373\u6642\u5411\u91cf\u548c\u7bc4\u570d\u5411\u91cf\u3001\u4e0d\u540c\u7684\u904b\u7b97\u7b26\uff0c\u4ee5\u53ca\u5982\u4f55\u5339\u914d\u6a19\u7c64\u6216\u6a23\u672c\u8a08\u6578\u4e0d\u5c0d\u9f4a\u7684\u7d50\u679c\u6578\u64da\u884c\u3002\u6700\u5f8c\uff0c\u6211\u7e3d\u7d50\u4e86\u5404\u7a2e\u6280\u5de7\u548c\u63d0\u793a\u3002 \u6211\u5efa\u8b70\u60a8\u5728\u95b1\u8b80\u672c\u6587\u6642\u5617\u8a66\u4e26\u7de8\u5beb\u81ea\u5df1\u7684 PromQL \u67e5\u8a62\u3002\u5728\u672c\u7cfb\u5217\u7684\u524d\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u5df2\u7d93\u6f14\u793a\u4e86\u4e0d\u540c\u7684\u5b89\u88dd\u9078\u9805\u3002\u518d\u4e00\u6b21\uff0c\u6211\u5f37\u70c8\u63a8\u85a6 PromLens\uff0c\u9019\u662f\u4e00\u500b\u975e\u5e38\u6709\u7528\u7684\u5de5\u5177\uff0c\u53ef\u4ee5\u4ee5\u5716\u5f62\u65b9\u5f0f\u53ef\u8996\u5316\u548c\u89e3\u91cb\u8907\u96dc\u7684 PromQL \u67e5\u8a62\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u500b\u4eba\u8a31\u53ef\u8b49\u5728\u60a8\u81ea\u5df1\u7684\uff08\u975e\u5546\u696d\uff09\u57fa\u790e\u8a2d\u65bd\u4e0a\u514d\u8cbb\u904b\u884c\u5b83\uff0c\u6216\u4f7f\u7528\u516c\u5171\u73fe\u5834\u6f14\u793a\u5be6\u4f8b\u3002 \u8907\u7fd2\uff1a\u6642\u9593\u5e8f\u5217\u8207\u6307\u6a19 \u5728\u672c\u6587\u4e2d\uff0c\u6211\u5c07\u5047\u8a2d\u60a8\u77e5\u9053\u201c\u6642\u9593\u5e8f\u5217\u201d\u548c\u201c\u6307\u6a19\u201d\u4e4b\u9593\u7684\u5340\u5225\u3002\u5982\u679c\u6c92\u6709\uff0c\u8acb\u53c3\u8003 \u9019\u88e1 \u7684\u89e3\u91cb\u3002","title":"\u4ecb\u7d39"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#promql_1","text":"\u7576\u60a8\u5728\u67e5\u8a62\u7a97\u53e3\u4e2d\u8f38\u5165 PromQL \u67e5\u8a62\u6642\uff08\u4f8b\u5982\uff0c\u5728 Grafana \u4e2d\uff0c\u6216\u8005 Prometheus \u670d\u52d9\u5668\u7684\u7aef\u53e3 9090 \u4e0a\u7684 Prometheus \u7684 Web \u754c\u9762\u4e2d\uff09\uff0c\u60a8\u5c07\u8fd4\u56de 0 \u500b\u6216\u66f4\u591a\u7d50\u679c\u884c\u3002\u7d50\u679c\u7e3d\u662f\u6709\u4e00\u500b\u985e\u578b\uff1a\u5373\u6642\u5411\u91cf (instant vector) \u6216\u7bc4\u570d\u5411\u91cf (range vector)\u3002","title":"PromQL\u67e5\u8a62\u7d50\u679c\u6578\u64da\u683c\u5f0f"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#instant-vector","text":"\u6bcf\u7576\u60a8\u9375\u5165 some_metric_name \u6216 some_metric_name{some_label=\"value\"} \u4e4b\u985e\u7684\u5167\u5bb9\u6642\uff0c\u7d50\u679c\u5c31\u662f\u4e00\u500b\" \u5373\u6642\u5411\u91cf \"\u3002\u8003\u616e\u4ee5\u4e0b\u793a\u4f8b\uff1a \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u7d50\u679c\u662f\u4e00\u500b\u5305\u542b\u7d04 100 \u500b\u6642\u9593\u5e8f\u5217\u884c\u7684\u5373\u6642\u5411\u91cf\uff0c\u6bcf\u884c\u5305\u542b\u8a72\u6642\u9593\u5e8f\u5217\u7684\u6700\u8fd1\u6293\u53d6\u7684\u6a23\u672c\u503c\u3002\u8acb\u6ce8\u610f\uff0c\u7d50\u679c\u4e0d\u5305\u542b\u6536\u96c6\u6b64\u6a23\u672c\u7684\u6642\u9593\u6233\u2014\u2014\u5047\u8a2d\u5b83\u662f\u6700\u8fd1\u6536\u96c6\u7684\u3002 Prometheus \u5be6\u969b\u4e0a\u4e1f\u68c4\u4e86\u8d85\u904e 5 \u5206\u9418\u4e4b\u524d\u6536\u96c6\u7684\u6a23\u672c\uff0c\u4e26\u4e14\u76f8\u61c9\u7684\u6642\u9593\u5e8f\u5217\u884c\u4e0d\u6703\u662f\u8fd4\u56de\u7d50\u679c\u7684\u4e00\u90e8\u5206\u3002 \u70ba\u4e86\u5e6b\u52a9\u60a8\u66f4\u597d\u5730\u8a18\u4f4f\u5b83\uff1a\u201c \u5373\u6642\u5411\u91cf \u201d\u6709\u5b83\u7684\u540d\u5b57\u7684\u53d6\u540d\u539f\u7531\uff0c\u56e0\u70ba\u67e5\u8a62\u7d50\u679c\u884c\u53ea\u5305\u542b\u90a3\u4e9b\u201c\u6b64\u6642\u201d\uff08\u901a\u5e38\u662f\u5e7e\u79d2\u9418\u524d\uff09\u6536\u96c6\u7684\u6a23\u672c\u7684\u6642\u9593\u5e8f\u5217\u3002 \u5373\u6642\u5411\u91cf\u9078\u64c7\u5668 \u5982\u679c\u60a8\u7de8\u5beb\u985e\u4f3c some_metric_name {foo=\"bar\"} \u7684\u5167\u5bb9\uff0c\u7c97\u9ad4\u90e8\u5206\u7a31\u70ba\u9078\u64c7\u5668\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u5b83\u4f86\u904e\u6ffe\uff08\u5982\uff1a\u7e2e\u5c0f\uff09\u67e5\u8a62\u4e2d\u8fd4\u56de\u7684\u6642\u9593\u5e8f\u5217\u3002\u6b64\u793a\u4f8b\u4e2d\u7684 = \uff08\u7b49\u865f\uff09\u7a31\u70ba\u5339\u914d\u5668\u3002\u5176\u4ed6\u5339\u914d\u5668\u662f != \uff08\u4e0d\u76f8\u7b49\uff09\u3001 =~ \uff08\u6b63\u5247\u8868\u9054\u5f0f\uff09\u548c !~ \uff08\u5426\u5b9a\u6b63\u5247\u8868\u9054\u5f0f\uff09\u3002 \u60a8\u53ef\u4ee5\u4f7f\u7528\u591a\u500b\u9078\u64c7\u5668\u2014\u2014\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u53ea\u8fd4\u56de\u6eff\u8db3\u6240\u6709\u9078\u64c7\u5668\u7684\u90a3\u4e9b\u884c\uff08\u63db\u53e5\u8a71\u8aaa\uff1aPrometheus \u5c07 AND \u908f\u8f2f\u61c9\u7528\u65bc\u9078\u64c7\u5668\uff09\u3002\u60a8\u9084\u53ef\u4ee5\u70ba\u76f8\u540c\u7684\u6a19\u7c64\u9375\uff08\u4f46\u4e0d\u540c\u7684\u5339\u914d\u5668\u985e\u578b\uff09\u63d0\u4f9b\u591a\u500b\u9078\u64c7\u5668\u3002\u4f8b\u5982\uff0c\u60a8\u53ef\u4ee5\u7de8\u5beb\u4e00\u500b\u67e5\u8a62\uff0c\u4f8b\u5982 node_filesystem_size_bytes{ mountpoint =~ \"/run/. \", **mountpoint* !~\"/run/user/.*\"}` \u7372\u53d6\u6240\u6709\u7bc0\u9ede\u4e0a\u78c1\u76e4\u5206\u5340\u7684\u7e3d\u5927\u5c0f\uff0c\u5176\u639b\u8f09\u9ede\u4ee5 \u201c/run/\u201d \u958b\u982d\uff0c\u4f46\u4e0d\u5305\u62ec\u6240\u6709\u4ee5 \u201c/run/user/\u201d \u958b\u982d\u7684\u7bc0\u9ede\u3002","title":"\u5373\u6642\u5411\u91cf (Instant vector)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#range-vector","text":"\u8af8\u5982 some_metric_name[ 5m ] \u6216 some_metric_name{some_label=\"value\"}[ 5m ] \u4e4b\u985e\u7684\u67e5\u8a62\u6703\u751f\u6210\" \u7bc4\u570d\u5411\u91cf \"\u985e\u578b\u7684\u7d50\u679c\u3002 \u7bc4\u570d\u5411\u91cf\u985e\u4f3c\u65bc\u5373\u6642\u5411\u91cf\u3002\u5982\u4e0a\u4f8b\u6240\u793a\uff0c\u7bc4\u570d\u5411\u91cf\u548c\u5373\u6642\u5411\u91cf\u4e4b\u9593\u6709\u5169\u500b\u95dc\u9375\u5340\u5225\uff1a \u4e00\u500b\u7bc4\u570d\u5411\u91cf\u5305\u542b\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u7684\u591a\u500b\u6a23\u672c\u2014\u2014\u4e0d\u50c5\u50c5\u662f\u6700\u8fd1\u6536\u96c6\u7684\u4e00\u500b \u7bc4\u570d\u5411\u91cf\u7684\u6a23\u672c\u5e36\u6709\u6642\u9593\u6233\uff08@ \u5b57\u7b26\u5f8c\u7684\u503c\uff09 \u5c16\u62ec\u865f\u4e2d\u7684\u90e8\u5206\uff08\u4f8b\u5982 [5m]\uff09\u6307\u5b9a\u8fd4\u56de\u6a23\u672c\u7684\u6642\u9593\u7a97\u53e3\u3002\u4f8b\u5982\uff0c[5m] \u544a\u8a34 Prometheus \u8fd4\u56de\u5728\u201c\u525b\u525b\u201d\u548c\u201c\u904e\u53bb 5 \u5206\u9418\u201d\u4e4b\u9593\u6293\u53d6\u7684\u6a23\u672c\u3002\u53ef\u7528\u7684\u55ae\u4f4d\u6709\uff1a s \uff08\u79d2\uff09\u3001 m \uff08\u5206\u9418\uff09\u3001 h \uff08\u5c0f\u6642\uff09\u3001 d \uff08\u5929\uff09\u3001 w \uff08\u9031\uff09\u3001 y \uff08\u5e74\uff09\u3002 \u6642\u9593\u504f\u79fb \u6709\u6642\u60a8\u53ef\u80fd\u60f3\u67e5\u8a62\u8f03\u820a\u7684\u6578\u64da\uff0c\u4f8b\u5982\u5c07\u201c\u4e00\u5468\u524d\u201d\u7684\u8acb\u6c42\u7387\u8207\u7576\u524d\u7684\u8acb\u6c42\u7387\u9032\u884c\u6bd4\u8f03\u3002\u70ba\u6b64\uff0cPromQL \u63d0\u4f9b\u4e86\u60a8\u53ef\u4ee5\u5728\u67e5\u8a62\u672b\u5c3e\u6dfb\u52a0\u7684 offset <duration> \u95dc\u9375\u5b57\u3002\u5b83\u9069\u7528\u65bc\u5373\u6642\u548c\u7bc4\u570d\u5411\u91cf\uff01 \u4f8b\u5982\uff0c\u8af8\u5982 some_metric_name[5m] offset 1h \u4e4b\u985e\u7684\u67e5\u8a62\u5c07\u70ba\u60a8\u63d0\u4f9b\u5728\u201c1 \u5c0f\u6642\u524d\u201d\u548c\u201c1 \u5c0f\u6642 5 \u5206\u9418\u524d\u201d\u4e4b\u9593\u6293\u53d6\u7684\u6a23\u672c\u3002","title":"\u7bc4\u570d\u5411\u91cf (Range vector)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#operators","text":"\u5728\u5be6\u8e10\u4e2d\uff0cPromQL \u67e5\u8a62\u76f8\u7576\u5927\u4e14\u8907\u96dc\u3002\u901a\u5e38\uff0c\u5b83\u5011\u662f\u591a\u500b\u5b50\u67e5\u8a62\u7684\u7d44\u5408\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u904b\u7b97\u7b26\u7d44\u5408\u9019\u4e9b\u5b50\u67e5\u8a62\uff0c\u9019\u4e5f\u662f SQL \u67e5\u8a62\u4e2d\u7684\u5e38\u7528\u6280\u8853\u3002 PromQL \u904b\u7b97\u7b26\u671f\u5f85\u5b83\u5011\u7684\u201c\u8f38\u5165\u201d\u662f\u6b63\u78ba\u7684\u6578\u64da\u985e\u578b\uff08\u7bc4\u570d\u5411\u91cf\u3001\u5373\u6642\u5411\u91cf\u6216\u6a19\u91cf\uff09\uff0c\u9019\u5c31\u662f\u6211\u5728\u4e0a\u9762\u8a73\u7d30\u89e3\u91cb\u53ef\u7528\u6578\u64da\u985e\u578b\u7684\u539f\u56e0\u3002\u9806\u4fbf\u8aaa\u4e00\u4e0b\uff0c\u6a19\u91cf\u53ea\u662f\u4e00\u500b\u6d6e\u9ede\u6578\u3002 Prometheus \u5177\u6709\u4ee5\u4e0b\u4e09\u7a2e\u904b\u7b97\u7b26\u985e\u5225\uff1a\u805a\u5408\u904b\u7b97\u7b26\u3001\u4e8c\u5143\u904b\u7b97\u7b26\u548c\u51fd\u6578\u3002 \u805a\u5408\u904b\u7b97\u7b26(Aggregation operators) \u4e8c\u5143\u904b\u7b97\u7b26(Binary operators) \u51fd\u6578 (Functions) \u805a\u5408\u904b\u7b97\u7b26\uff0c\u4f8b\u5982 sum / count / min / max / avg / stddev \u5c07\u55ae\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\u4e26\u7522\u751f\u4e00\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u51fa\u3002\u7531\u65bc\u805a\u5408\uff0c\u8207\u8f38\u5165\u5373\u6642\u5411\u91cf\u76f8\u6bd4\uff0c\u7d50\u679c\u901a\u5e38\u5177\u6709\u66f4\u5c11\u7684\u6642\u9593\u5e8f\u5217\uff08\u548c\u6a19\u7c64\uff09\u3002 \u805a\u5408\u7e3d\u662f\u767c\u751f\u5728\u60a8\u6307\u5b9a\u7684\u4e00\u500b\uff08\u6216\u591a\u500b\uff09\u6a19\u7c64\u9375\u4e0a\u3002\u6709\u5169\u7a2e\u6307\u5b9a\u9019\u4e9b\u6a19\u7c64\u7684\u57fa\u672c\u65b9\u6cd5\u3002\u8b93\u6211\u5011\u901a\u904e\u793a\u4f8b\u4f86\u8aaa\u660e\u5b83\u5011\uff0c\u5c0d\u65bc\u6307\u6a19 node_filesystem_size_bytes \uff0c\u5b83\u5177\u6709\u6a19\u7c64\u9375 job \u3001 instance \u3001 device \u3001 mountpoint \u3001 fstype \u3002 \u6307\u5b9a\u5141\u8a31\u5217\u8868\u3002\u793a\u4f8b\u67e5\u8a62\uff1asum by(job, instance, device)(node_filesystem_size_bytes) \u751f\u6210\u7684\u5373\u6642\u5411\u91cf\u5c07\u50c5\u5305\u542b\u60a8\u5728 by-clause \u4e2d\u6307\u5b9a\u5176\u9375\u7684\u90a3\u4e9b\u6a19\u7c64\uff0c\u805a\u5408\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u6e05\u695a\u5730\u8aaa\u660e\u4e86\u805a\u5408\u904e\u7a0b\u7684\u5de5\u4f5c\u539f\u7406\u3002 \u6307\u5b9a\u62d2\u7d55\u5217\u8868\u3002\u793a\u4f8b\u67e5\u8a62\uff1a sum without(fstype, mountpoint)(node_filesystem_size_bytes) \u751f\u6210\u7684\u5373\u6642\u5411\u91cf\u5c07\u4e0d\u518d\u5305\u542b\u60a8\u5728\u7121\u5b50\u53e5\u4e2d\u6307\u5b9a\u7684\u90a3\u4e9b\u6a19\u7c64\u9375\uff0c\u4f46\u5c07\u5305\u542b\u8f38\u5165\u5373\u6642\u5411\u91cf\u5177\u6709\u7684\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff1a\u4f5c\u696d\u3001\u5be6\u4f8b\u3001\u8a2d\u5099 \u904b\u884c\u4e0a\u8ff0\u4efb\u4e00\u67e5\u8a62\u6642\uff08\u5169\u8005\u90fd\u5be6\u73fe\u76f8\u540c\u7684\u76ee\u7684\uff0c\u901a\u904e fstype \u548c mountpoint \u9032\u884c\u805a\u5408\uff09\uff0c\u805a\u5408\u7684\u5de5\u4f5c\u65b9\u5f0f\u5982\u4e0b\uff1a \u5047\u8a2d node_filesystem_size_bytes \u6307\u6a19\u5177\u6709\u4ee5\u4e0b\u5373\u6642\u5411\u91cf\u6642\u9593\u5e8f\u5217\uff1a node_filesystem_size_bytes { device = \"/dev/sda1\" ,fstype = \"vfat\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/boot/efi\" } 100663296 node_filesystem_size_bytes { device = \"/dev/sda5\" ,fstype = \"ext4\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/\" } 90131324928 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/lock\" } 5242880 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/1000\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/119\" } 826961920 Prometheus \u5c07\u5728\u5167\u90e8\u5275\u5efa\u7d44\uff0c\u5176\u4e2d\u6bcf\u500b\u7d44\u5305\u542b\u5177\u6709\u5b8c\u5168\u76f8\u540c\u6a19\u7c64\uff08\u5177\u6709\u76f8\u540c\u6a19\u7c64\u9375\u548c\u6a19\u7c64\u503c\uff09\u7684\u6642\u9593\u5e8f\u5217\uff0c\u9019\u4e9b\u6a19\u7c64\u9375\u61c9\u4fdd\u7559\u5728\u6700\u7d42\u7d50\u679c\u4e2d\u3002\u5728\u9019\u500b\u4f8b\u5b50\u4e2d\uff1a # Group 1 {device=\"/dev/sda1\",instance=\"localhost:9100\",job=\"node\"} node_filesystem_size_bytes { device = \"/dev/sda1\" ,fstype = \"vfat\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/boot/efi\" } 100663296 # Group 2{device=\"/dev/sda5\",instance=\"localhost:9100\",job=\"node\"} node_filesystem_size_bytes { device = \"/dev/sda5\" ,fstype = \"ext4\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/\" } 90131324928 # Group 3 {device=\"tmpfs\",instance=\"localhost:9100\",job=\"node\"} node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/lock\" } 5242880 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/1000\" } 826961920 node_filesystem_size_bytes { device = \"tmpfs\" ,fstype = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" ,mountpoint = \"/run/user/119\" } 826961920 sum \u904b\u7b97\u7b26\u5c0d\u6bcf\u500b\u7d44\u4e2d\u7684\u6a23\u672c\u503c\u6c42\u548c\uff0c\u4e26\u8fd4\u56de\u6bcf\u7d44\u4e00\u500b\u6a23\u672c\uff1a { device = \"/dev/sda1\" ,instance = \"localhost:9100\" ,job = \"node\" } 100663296 { device = \"/dev/sda5\" ,instance = \"localhost:9100\" ,job = \"node\" } 90131324928 { device = \"tmpfs\" ,instance = \"localhost:9100\" ,job = \"node\" } 2486128640 \u6ce8\u610f\uff1a\u7d50\u679c\u4e0d\u518d\u8207\u8f38\u5165\u6307\u6a19\u7684\uff08\u540d\u7a31\uff09\u76f8\u95dc\uff01\u540d\u7a31 node_filesystem_size_bytes \u5df2\u6d88\u5931\uff0c\u56e0\u70ba\u7d50\u679c\u4e0d\u518d\u985e\u4f3c\u65bc\u7531\u8a72\u5ea6\u91cf\u540d\u7a31\u6e2c\u91cf\u7684\u539f\u59cb\u503c\u3002 \u4e8c\u5143\u904b\u7b97\u7b26\u4e4b\u6240\u4ee5\u9019\u6a23\u7a31\u547c\uff0c\u662f\u56e0\u70ba\u5b83\u5011\u5c07\u5169\u500b\u8f38\u5165\u64cd\u4f5c\u6578\u4f5c\u70ba\u8f38\u5165\u3002 \u4e8c\u5143\u904b\u7b97\u7b26\u5206\u70ba\u4e09\u7a2e\uff1a \u7b97\u8853\u904b\u7b97\u7b26 (Arithmetic): + \u2013 * / ^ % \u6bd4\u8f03\u904b\u7b97\u7b26 (Comparison): larger / smaller (or equal), equal, unequal \u908f\u8f2f\u904b\u7b97\u7b26 (Logical): and, or, unless \u5927\u591a\u6578\u4e8c\u5143\u904b\u7b97\u7b26\u5c07\u5169\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\uff0c\u4e26\u7522\u751f\u4e00\u500b\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u8f38\u51fa\u3002\u4f46\u662f\u4e00\u4e9b\u904b\u7b97\u7b26\u4e5f\u652f\u6301\u6a19\u91cf(scalar)\u4f5c\u70ba\u8f38\u5165\u4e4b\u4e00\uff0c\u4f8b\u5982\u8af8\u5982 some_metric / 1024 \u4e4b\u985e\u7684\u67e5\u8a62\u3002 \u96d6\u7136\u7b97\u8853\u904b\u7b97\u7b26\u5f88\u5bb9\u6613\u7406\u89e3\u548c\u4f7f\u7528\uff0c\u4f46\u95dc\u65bc\u6bd4\u8f03\u904b\u7b97\u7b26\u548c\u908f\u8f2f\u904b\u7b97\u7b26\u6709\u5e7e\u9ede\u9700\u8981\u4e86\u89e3\uff1a \u6bd4\u8f03\u904b\u7b97\u7b26 (Comparison): \u9019\u4e9b\u904b\u7b97\u7b26\u4e0d\u6703\u66f4\u6539\u7d50\u679c\u4e2d\u7684\u503c\uff08\u4f8b\u5982\u66f4\u6539\u70ba\u771f/\u5047\uff09\u3002\u76f8\u53cd\uff0c\u5b83\u5011\u8fd4\u56de\u904b\u7b97\u7b26\u5de6\u5074\u7684\u8f38\u5165\u5411\u91cf\u7684\u6a23\u672c\uff0c\u904e\u6ffe\u6389\u6bd4\u8f03\u7d50\u679c\u70ba\u5047\u7684\u90a3\u4e9b\u6a23\u672c\u3002 \u5982\u679c\u60a8\u4e0d\u60f3\u904e\u6ffe\u6a23\u672c\uff08\u5373\u5f9e\u7d50\u679c\u4e2d\u4e1f\u5931\uff09\uff0c\u4f46\u5728\u7d50\u679c\u4e2d\u5c07\u5b83\u5011\u7684\u503c\u70ba 0\uff0c\u8acb\u4f7f\u7528 bool \u95dc\u9375\u5b57\uff0c\u4f8b\u5982 some_metric > bool 10 \uff08\u800c\u4e0d\u662f some_metric > 10 \uff09\u3002\u4f46\u662f\uff0c\u90a3\u4e9b\u6bd4\u8f03\u8a55\u4f30\u70ba\u771f\u7684\u6a23\u672c\u5c07\u53ea\u6709\u4e00\u500b\u503c 1 \u800c\u4e0d\u662f\u5be6\u969b\u5b58\u5132\u7684\u503c\u3002 \u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5b98\u65b9\u6587\u6a94 \u3002 \u908f\u8f2f\u904b\u7b97\u7b26 (Logical): and \u53d6\u5de6\u53f3\u5169\u908a\u6578\u64da\u7684\u4ea4\u96c6\u3002\u53ea\u6709\u7576\u53f3\u5074\u6709\u5339\u914d\u7684\u6a23\u672c\u6642\uff0c\u5b83\u624d\u6703\u5f9e\u5de6\u5074\u8fd4\u56de\u6a23\u672c\u3002\u9019\u5728\u8b66\u5831\u4e2d\u5f88\u6709\u7528\uff0c\u53ef\u4ee5\u6307\u5b9a\u591a\u500b\u689d\u4ef6\u3002 or \u5f9e\u4efb\u4e00\u5074\u8fd4\u56de\u6a23\u672c\uff0c\u66f4\u559c\u6b61\u5de6\u5074\u7684\u6578\u64da\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u4f86\u81ea\u5de6\u5074\u548c\u53f3\u5074\u7684\u6a23\u672c\u88ab\u5206\u7d44\uff08\u4e26\u4e14 Prometheus \u5617\u8a66\u627e\u5230\u5339\u914d\u9805\uff09\u3002\u5c0d\u65bc\u6bcf\u500b\u7d44\uff0c\u4ee5\u4e0b\u6210\u7acb\uff1a\u5982\u679c\u8a72\u7d44\u5de6\u5074\u6709\u6a23\u672c\uff0c\u5247\u8fd4\u56de\u9019\u4e9b\u6a23\u672c\uff0c\u5982\u679c\u6c92\u6709\uff0c\u5247\u5f9e\u53f3\u5074\u8fd4\u56de\u6a23\u672c unless \u5f9e\u5de6\u5074\u8fd4\u56de\u6a23\u672c\uff0c\u9664\u975e\u53f3\u5074\u6709\u6a23\u672c\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\u4e0d\u8fd4\u56de\u4efb\u4f55\u5167\u5bb9\u3002\u5982\u679c\u7f3a\u5c11\u67d0\u4e9b\u6307\u6a19\uff0c\u9019\u5c0d\u65bc\u5728\u60a8\u60f3\u8981\u767c\u51fa\u8b66\u5831\u7684\u60c5\u6cc1\u4e0b\u767c\u51fa\u8b66\u5831\u5f88\u6709\u7528\u3002 and \u8207 \u5df7unless\u5df7 \u904b\u7b97\u7b26\u652f\u6301 on(...) \u548c ignoring(...) \uff08\u4f46 or \u904b\u7b97\u7b26\u4e0d\u652f\u6301\uff01\uff09 \u6c92\u6709 not \u904b\u7b97\u7b26\u3002\u8acb\u6539\u7528 absent() \u51fd\u6578\uff01 \u5982\u679c\u4e00\u500b\u7a7a\u7684\u5373\u6642\u5411\u91cf\uff08\u5373\u7f3a\u5931\u7684\u7d50\u679c\uff09\u88ab absent() \u51fd\u6578\u904b\u7b97\u6642\uff0c\u5b83\u6703\u8fd4\u56de\u4e00\u500b\uff08\u901a\u5e38\u662f\u7121\u6a19\u7c64\u7684\uff09\u5373\u6642\u5411\u91cf\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u500b\u503c\u70ba 1 \u7684\u6a23\u672c\u3002\u8fd4\u56de\u7684\u7d50\u679c\u53ef\u4ee5\u6709\u6a19\u7c64\uff0c\u4f8b\u5982\u7576\u4f60\u8abf\u7528 absent(up{job=\"missing\"}) \u6642\uff0c\u5b83\u6703\u8fd4\u56de {job=\"missing\"} 1 \u3002 \u7576\u60a8\u7d44\u5408\u7531\u4e8c\u5143\u904b\u7b97\u7b26\u7d44\u6210\u7684\u5d4c\u5957\u5b50\u67e5\u8a62\u6642\uff0c\u4e26\u4e0d\u7e3d\u662f\u6e05\u695a\u54ea\u4e9b\u904b\u7b97\u7b26\u5177\u6709\u66f4\u9ad8\u7684\u512a\u5148\u7d1a\u3002\u5728 Prometheus \u4e2d\uff0c\u904b\u7b97\u7b26\u512a\u5148\u7d1a\uff08\u5f9e\u9ad8\u5230\u4f4e\uff09\u662f\uff1a - ^ - * , / , % - + , - - == , != , <= , < , >= , > - and , unless - or \u4f8b\u5982\uff0c\u5c0d\u65bc some_metric * 2 ^ 3 \u9019\u6a23\u7684\u67e5\u8a62\uff0cPrometheus \u5c07\u9996\u5148\u8a08\u7b97 2^3 (=8)\uff0c\u7136\u5f8c\u5c07 some_metric \u7684\u6a23\u672c\u503c\u4e58\u4ee5 8\uff0c\u56e0\u70ba ^ \u5177\u6709\u6700\u9ad8\u512a\u5148\u7d1a\u3002 \u51fd\u6578\u5c07\u5373\u6642\u5411\u91cf\u6216\u7bc4\u570d\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\uff0c\u901a\u5e38\u6703\u751f\u6210\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u7d50\u679c\u3002\u6709\u4e00\u4e9b\u4f8b\u5916\u6703\u8fd4\u56de\u6a19\u91cf\uff0c\u4f8b\u5982 time() \u548c scalar()\u3002 \u5982\u5b98\u65b9\u6587\u6a94\u6240\u793a\uff0c\u6709\u6578\u5341\u7a2e\u51fd\u6578\u53ef\u7528\u65bc\u5404\u7a2e\u7528\u9014\uff0c\u4f8b\u5982\u6578\u5b78\u51fd\u6578\u6216\u8207\u65e5\u671f/\u6642\u9593\u76f8\u95dc\u7684\u51fd\u6578\u3002\u89e3\u91cb\u5b83\u5011\u90fd\u9700\u8981\u5f88\u9577\u7684\u6587\u7ae0\u3002 \u76f8\u53cd\uff0c\u6211\u53ea\u60f3\u89e3\u91cb\u4e00\u500b\u51fd\u6578\uff0c rate() \uff0c\u4f60\u5728 PromQL \u67e5\u8a62\u4e2d\u7d93\u5e38\u9700\u8981\u5b83\uff0c\u800c\u5b98\u65b9\u6587\u6a94\u5c0d\u5b83\u7684\u89e3\u91cb\u7279\u5225\u5dee\u3002 rate() \u9700\u8981\u4e00\u500b counter \u985e\u578b\u6307\u6a19\u7684\u7bc4\u570d\u5411\u91cf\u3002\u56e0\u70ba counter \u7684\u6a23\u672c\u503c\u662f\u55ae\u8abf\u905e\u589e\u7684\uff0c\u6240\u4ee5\u5b83\u5011\u5c0d\u65bc\u7e6a\u5716\u6216\u5728\u539f\u59cb\u5f62\u5f0f\u7684\u8b66\u5831\u67e5\u8a62\u4e2d\u6c92\u6709\u7528\u2014\u2014\u60a8\u5c07\u4e0d\u77e5\u9053\u5c07\u5b83\u5011\u8207\u4ec0\u9ebc\u503c\u9032\u884c\u6bd4\u8f03\u3002 rate() \u51fd\u6578\u5728\u9019\u88e1\u53ef\u4ee5\u70ba\u60a8\u63d0\u4f9b\u5e6b\u52a9\uff0c\u56e0\u70ba\u5b83\u901a\u904e\u8a08\u7b97\u5b9a\u7fa9\u6642\u9593\u6bb5\u5167\u7684\u6a23\u672c\u503c\u7684\u589e\u91cf\u4f86\u201c\u58d3\u5e73\u201d\u9019\u7a2e\u55ae\u8abf\u905e\u589e\u7684\u503c\uff0c\u4e26\u5c07\u589e\u91cf\u503c\u6a19\u6e96\u5316\u70ba\u201c\u6bcf\u79d2\u201d\u3002 \u4e00\u500b\u4f8b\u5b50\u5c0d\u66f4\u597d\u5730\u7406\u89e3\u9019\u4e00\u9ede\u5f88\u6709\u5e6b\u52a9\u3002\u5047\u8a2d process_cpu_seconds_total[5m] \u7684\u7bc4\u570d\u5411\u91cf\u8fd4\u56de\u4ee5\u4e0b\u6a23\u672c\uff08\u50c5\u986f\u793a\u4e00\u500b\u7279\u5b9a\u6642\u9593\u5e8f\u5217\u7684\u6a23\u672c\uff0c\u6a19\u7c64\u70ba (instance=\"demo.robustperception.io:9090\", job=\"prometheus\"\uff09 \uff1a 4858038 .33 @1633506420.307 4858045 .41 @1633506430.304 ... \u9084\u6709 24 \u500b\u6a23\u672c\uff0c\u70ba\u7c21\u6f54\u8d77\u898b\u7701\u7565 ... 4858214 .65 @1633506680.311 4858221 .63 @1633506690.312 rate() \u5728\u6982\u5ff5\u4e0a\u6240\u505a\u7684\u8a08\u7b97\u662f\uff1a ( latest value - oldest value ) / ( latest timestamp - oldest timestamp ) \u4e5f\u5c31\u662f\uff0c\u6211\u5011\u5c07\u6a23\u672c\u503c\u589e\u91cf\uff08\u6b64\u8655\u70ba 4858221.63 \u2013 4858038.33 = 183.3 CPU \u79d2\uff09\u9664\u4ee5\u6642\u9593\u6233\u589e\u91cf\uff081633506690.312 \u2013 1633506420.307 = 270 \u79d2\uff09\uff0c\u5f97\u5230\u6bcf\u79d2\u7d04 0.68 \u7684\u901f\u7387\u3002\u6211\u5011\u6307\u5b9a\u7684\u6642\u9593\u7a97\u53e3\uff08\u6b64\u8655\uff1a [5m] \uff09\u6307\u5b9a\u4e86\u5e73\u5747/\u5e73\u6ed1\u6548\u679c\u7684\u5f37\u5ea6\u2014\u2014\u6642\u9593\u7a97\u53e3\u8d8a\u5927\uff0c\u5e73\u5747\u503c\u8d8a\u5f37\u3002 \u5be6\u969b\u4e0a\uff0c\u8a72\u7b97\u6cd5\u8981\u5fa9\u96dc\u5f97\u591a\u3002 rate() \u667a\u80fd\u5730\u8003\u616e\u4e1f\u5931\u7684\u6a23\u672c\u503c\uff0c\u4e26\u4e14\u9084\u8655\u7406\u8a08\u6578\u5668\u91cd\u7f6e\uff08\u7531\u65bc\u5c0e\u51fa\u61c9\u7528\u7a0b\u5e8f\u5d29\u6f70/\u91cd\u65b0\u555f\u52d5\uff0c\u6293\u53d6\u7684\u6a23\u672c\u503c\u6b63\u5728\u6e1b\u5c11\uff09\u3002 \u7576\u60a8\u5728\u5c07 rate(some_metric[...]) \u7e6a\u88fd\u70ba\u4e00\u689d\u7dda\u7684\u5716\u8868\u4e2d\u4f7f\u7528 rate() \u6642\uff0c\u5f9e\u6982\u5ff5\u4e0a\u8b1b\uff0c\u8a72\u7dda\u7684\u6bcf\u500b\u50cf\u7d20\u90fd\u662f\u901a\u904e\u5206\u5225\u8abf\u7528 rate() \u5275\u5efa\u7684\uff0c\u5c07\u6642\u9593\u7a97\u53e3\u504f\u79fb\u5e7e\u79d2\u9418\u6bcf\u4e00\u6b21\u3002\u7576\u7136\uff0c\u5be6\u969b\u4e0a\uff0c\u9084\u6709\u66f4\u9ad8\u6548\u7684 API\uff0c\u5176\u4e2d\u4e00\u6b21\u8abf\u7528\u5c07\u751f\u6210\u5716\u5f62\u6240\u9700\u7684 rate() \u503c\u6578\u7d44\u3002 \u95dc\u65bc rate() \u7684\u4e00\u4e9b\u63d0\u793a\uff1a - \u60a8\u63d0\u4f9b\u7d66 rate() \u7684\u6642\u9593\u7a97\u53e3\uff08\u4f8b\u5982 [5m]\uff09\u61c9\u81f3\u5c11\u662f\u70ba\u63d0\u4f9b\u76f8\u61c9\u6307\u6a19\u7684\u76ee\u6a19\u914d\u7f6e\u7684\u6293\u53d6\u9593\u9694\u7684 4 \u500d\u3002 - \u7576\u60a8\u5c07 rate() \u8207 sum() \u7d50\u5408\u4f7f\u7528\u6642\uff0c\u59cb\u7d42\u8abf\u7528 sum by(...)(rate(<counter-type metric>)) \uff0c\u800c\u4e0d\u662f\u76f8\u53cd\uff0c\u56e0\u70ba\u9019\u6a23\u60a8\u5c07\u532f\u7e3d\u539f\u59cb\u8a08\u6578\u5668\u6a23\u672c\u503c\uff0c\u9019\u662f\u6c92\u6709\u610f\u7fa9\u7684\u3002","title":"\u904b\u7b97\u7b26 (Operators)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#vector-matching","text":"\u7576\u7d66\u5b9a\u4e8c\u5143\u904b\u7b97\u7b26\u4f5c\u70ba\u8f38\u5165\u7684\u5169\u500b\u5373\u6642\u5411\u91cf\u6642\uff0c\u5b83\u5fc5\u9808\u5c07\u904b\u7b97\u7b26\u5de6\u5074\u7684\u6642\u9593\u5e8f\u5217\u884c\u8207\u53f3\u5074\u7684\u884c\u5339\u914d\u3002\u9019\u7a31\u70ba\" \u5411\u91cf\u5339\u914d \"\u3002\u8003\u616e\u5230\u6a19\u7c64\u6216\uff08\u6578\u91cf\uff09\u6a23\u672c\uff0c\u6216\u5169\u8005\u90fd\u53ef\u80fd\u5b58\u5728\u5dee\u7570\u3002 \u5982\u679c\u4f60\u5f88\u5e78\u904b\uff0c\u6a19\u7c64\u548c\u6837\u672c\u8a08\u6578\u662f\u4e00\u5c0d\u4e00\u7684\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\u4f60\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u7279\u5225\u7684\u4e8b\u60c5\u2014\u2014\u4f60\u7684 PromQL \u67e5\u8a62\u53ef\u4ee5\u7c21\u55ae\u5730\u662f <left expression> <operator> <right expression> \u3002 Prometheus \u53ef\u4ee5\u5c07\u6a23\u672c\u8207\u6a19\u7c64\u5339\u914d\u7684\u5176\u4ed6\u6a23\u672c\u9032\u884c\u5339\u914d\u3002 \u4f46\u662f\uff0c\u901a\u5e38\u60c5\u6cc1\u4e26\u975e\u5982\u6b64\uff0c\u5982\u679c\u4e8c\u5143\u904b\u7b97\u7b26\u67e5\u8a62\u7684\u7d50\u679c\u662f\u4e00\u500b\u7a7a\u7684\u5373\u6642\u5411\u91cf\uff0c\u60a8\u53ef\u4ee5\u5f9e\u5339\u914d\u51fa\u73fe\u554f\u984c\u7684\u4e8b\u5be6\u4e2d\u770b\u51fa\u9019\u4e00\u9ede\u3002\u5e78\u904b\u7684\u662f\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e9b\u6a5f\u5236\u4f86\u8655\u7406\u9019\u4e9b\u554f\u984c\uff1a \u8981\u8655\u7406\u6a19\u7c64\u4e0d\u5339\u914d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u95dc\u9375\u5b57 ignoring \u6216 on \uff0c\u5176\u5de5\u4f5c\u65b9\u5f0f\u8207\u95dc\u9375\u5b57 without \u6216 by \u5c0d\u805a\u5408\u904b\u7b97\u7b26\u7684\u5de5\u4f5c\u65b9\u5f0f\u975e\u5e38\u76f8\u4f3c\u3002 \u5177\u9ad4\u4f8b\u5b50\uff1a sum without ( cpu )( rate ( node_cpu_seconds_total { mode = \"idle\" }[ 5m ])) / ignoring ( mode ) sum without ( mode, cpu )( rate ( node_cpu_seconds_total [ 5m ])) - \u5f37\u70c8\u5efa\u8b70\u60a8\u6253\u958b PromLens \u6f14\u793a \u4e26\u904b\u884c\u4e0a\u8ff0\u67e5\u8a62\u3002\u901a\u904e\u55ae\u64ca PromLens \u4e2d\u7684\u4e0d\u540c\u7bc0\u9ede\uff0c\u60a8\u53ef\u4ee5\u8f15\u9b06\u4e86\u89e3\uff08\u4e2d\u9593\uff09\u7d50\u679c\u662f\u4ec0\u9ebc\u3002\u5f88\u660e\u986f\uff0c\u8af8\u5982: sum without(cpu)(...) / sum without(mode, cpu)(...) \uff08\u5373\uff0c\u7701\u7565 ignoring(mode) \u90e8\u5206\uff09\u4e0d\u6703\u8d77\u4f5c\u7528\uff08\u4e0d\u6703\u986f\u793a\u932f\u8aa4\uff0c\u4f46\u60a8\u6703\u5f97\u5230\u4e00\u500b\u7a7a\u7684\u5373\u6642\u5411\u91cf\u4f5c\u70ba\u7d50\u679c\uff09\uff0c\u56e0\u70ba\u7b2c\u4e00\u500b sum \u904b\u7b97\u7b26\u7684\u7d50\u679c\u5177\u6709\u6a19\u7c64 instance\u3001job\u3001node\uff0c\u4f46\u7b2c\u4e8c\u500b\u6c42\u548c\u904b\u7b97\u7b26\u7d50\u679c\u53ea\u6709\u6a19\u7c64 instance, job\u3002 \u5982\u60a8\u6240\u898b\uff0c\u95dc\u9375\u5b57\uff08 ignoring \u6216 on \uff09\u5fc5\u9808\u7dca\u6328\u4e8c\u5143\u904b\u7b97\u7b26\u7684\u53f3\u5074\u3002 \u5982\u679c\u6a19\u7c64\u5339\u914d\uff08\u6216\u8005\u60a8\u4f7f\u7528\u4e0a\u8ff0 ignoring() \u6280\u5de7\u4f7f\u5b83\u5011\u5339\u914d\uff09\uff0c\u4f46\u6a23\u672c/\u7d50\u679c\u884c\u7684\u6578\u91cf\u4e0d\u5339\u914d\uff0c\u60a8\u6703\u6536\u5230\u4e00\u689d\u932f\u8aa4\u6d88\u606f\uff0c\u4f8b\u5982 \u201cmultiple matches for labels: many-to-one matching must be explicit (group_left/group_right)\u201c\uff0c\u56e0\u70ba\u4f60\u6709 many-to-one (rows) \u5339\u914d\u7684\u60c5\u6cc1\u3002 \u5982\u679c\u60a8\u63a1\u7528\u4e0a\u9762\u7684\u793a\u4f8b\u4e26\u53bb\u9664\u4e86 {mode=\"idle\"} \u90e8\u5206\uff0c\u5c31\u6703\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\u3002\u53ea\u9700\u5728 PromLens \u4e2d\u5617\u8a66\uff01\u60a8\u6703\u770b\u5230\u7b2c\u4e00\u500b\u6c42\u548c\u7d50\u679c\u73fe\u5728\u6709\u8a31\u591a\u6642\u9593\u5e8f\u5217\uff08\u6bcf\u500b CPU \u6a21\u5f0f\u4e00\u500b\uff09\uff0c\u4f46\u7b2c\u4e8c\u500b\u6c42\u548c\u7d50\u679c\u4ecd\u7136\u53ea\u6709\u4e00\u500b\u6642\u9593\u5e8f\u5217\u884c\u3002 - PromQL \u78ba\u5be6\u652f\u6301\u591a\u5c0d\u4e00\u5339\u914d\uff0c\u4f46\u60a8\u5fc5\u9808\u901a\u904e\u5728\u4e8c\u5143\u904b\u7b97\u7b26\u53f3\u5074\u6dfb\u52a0 `group_left` \u95dc\u9375\u5b57\u4f86\u660e\u78ba\u544a\u8a34 Prometheus \u9019\u662f\u60a8\u60f3\u8981\u7684\u3002\u5982\u679c\u4f60\u5df2\u7d93\u6709 `ignoring(\u2026)` \u6216 `on(\u2026)` \uff0c `group_left` \u5fc5\u9808\u5728\u5b83\u4e4b\u5f8c\uff09\u3002\u56e0\u6b64\uff0c\u8a9e\u6cd5\u662f\uff1a ```bash <left expression> <operator> [ignoring(labels) | on(labels)] group_left <right expression> ``` - \u672c\u8cea\u4e0a\uff0c`group_left` \u6216 `group_right` \u6307\u793a Prometheus \u5728\u904b\u7b97\u7b26\u7684\u76f8\u61c9\u53e6\u4e00\u5074\u8907\u88fd\u7d50\u679c\u884c/\u6a23\u672c\uff0c\u4ee5\u4fbf\u60a8\u518d\u6b21\u7372\u5f97\u96d9\u65b9\u6a23\u672c\u4e4b\u9593\u7684\u4e00\u5c0d\u4e00\u5339\u914d\u3002\u5728\u6211\u5011\u7684\u793a\u4f8b\u4e2d\uff0c\u6211\u5011\u61c9\u8a72\u4f7f\u7528 `group_left`\uff0c\u56e0\u70ba\u904b\u7b97\u7b26\u7684\u53f3\u5074\u662f\u5177\u6709\u8f03\u5c11\u6642\u9593\u5e8f\u5217\u884c\uff08\u9700\u8981\u5fa9\u5236\uff09\u7684\u4e00\u5074\u3002 - \u9084\u6709\u4e00\u500b `group_right` \u95dc\u9375\u5b57\uff0c\u985e\u4f3c\u65bc `group_left`\uff0c\u4f46\u4f5c\u7528\u65b9\u5411\u76f8\u53cd\u3002 - \u901a\u904e\u4f7f\u7528\u8a9e\u6cd5 `group_left(label1,label2,\u2026)` \uff08\u800c\u4e0d\u50c5\u50c5\u662f `group_left`\uff09\uff0c\u6700\u7d42\u7d50\u679c\u5c07\u4e0d\u50c5\u5305\u542b\u904b\u7b97\u7b26\u5de6\u5074\u7d50\u679c\u4e2d\u5b58\u5728\u7684\u6a19\u7c64\uff0c\u800c\u4e14 Prometheus \u9084\u5c07\u5fa9\u5236\u6307\u5b9a\u7684\u6a19\u7c64\uff08\u6b64\u8655\uff1a\u904b\u7b97\u7b26\u53f3\u5074\u7684 label1 \u548c label2) \u9032\u5165\u7d50\u679c\u3002\u4e00\u500b\u5178\u578b\u7684\u7528\u4f8b\u662f\u4f7f\u7528\u4f86\u81ea\u53e6\u4e00\u500b\u6307\u6a19\u7684\u503c\u4f86\u8c50\u5bcc\u7d50\u679c\uff0c\u4f8b\u5982: ```bash up * on(instance) group_left(version) prometheus_build_info ``` \u5b83\u4f7f\u7528 prometheus_build_info \u6307\u6a19\u7684\u7248\u672c\u6a19\u7c64\u8c50\u5bcc\u4e86 up \u6307\u6a19\uff08\u5177\u6709 instance \u548c job \u6a19\u7c64\uff09\u3002 - \u6ce8\u610f\uff1aPrometheus \u4e0d\u652f\u6301\u591a\u5c0d\u591a\u5339\u914d\uff0c\u53ea\u652f\u6301\u4e00\u5c0d\u4e00\u6216\u591a\u5c0d\u4e00\u6216\u4e00\u5c0d\u591a\uff01","title":"\u5411\u91cf\u5339\u914d (Vector matching)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#promql_2","text":"","title":"PromQL \u5c0f\u6280\u5de7"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#_2","text":"\u5728 PromQL \u4e2d\uff0c\u50cf metric_name{key=\"value\"} \u9019\u6a23\u7684\u6771\u897f\u53ea\u662f {__name__=\"metric_name\",key=\"value\"} \u7684\u8a9e\u6cd5\u7cd6","title":"\u6307\u6a19\u540d\u7a31\u8a9e\u6cd5\u7cd6"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#_3","text":"\u7de8\u5beb\u67e5\u8a62\u6642\uff0c\u60a8\u8981\u561b\u5fc5\u9808\u7701\u7565\u9078\u64c7\u5668\uff08\u4f8b\u5982 some_metric\uff09\uff0c\u8981\u561b\u5728\u9078\u64c7\u5668\u4e2d\u6307\u5b9a\u81f3\u5c11\u4e00\u500b\u6a19\u7c64\uff08\u4f8b\u5982 some_metric{ key=\"value\" }\uff0c\u5176\u4e2d\u82b1\u62ec\u865f\u90e8\u5206\u662f\u9078\u64c7\u5668\uff09\u3002\u4f60\u4e0d\u80fd\u53ea\u4f7f\u7528\u4e00\u500b\u7a7a\u7684\u9078\u64c7\u5668\u2014\u2014\u50cf some_metric{} \u751a\u81f3\u53ea\u662f {} \u662f\u4e0d\u5141\u8a31\u7684\uff0c\u56e0\u70ba\u9019\u53ef\u80fd\u6703\u4f7f Prometheus \u670d\u52d9\u5668\u904e\u8f09\uff0c\u4e26\u4e14\u6709\u4e00\u500b\u5b89\u5168\u63aa\u65bd\u53ef\u4ee5\u907f\u514d\u9019\u7a2e\u904e\u8f09\u3002 \u53e6\u4e00\u689d\u898f\u5247\u662f\uff0c\u9078\u64c7\u5668\u4e2d\u5fc5\u9808\u81f3\u5c11\u6709\u4e00\u500b\u5339\u914d\u5668\uff0c\u5176\u503c\u8207\u7a7a\u5b57\u7b26\u4e32\u4e0d\u540c\u3002\u4f8b\u5982\uff0c\u8af8\u5982 {foo=\"\"}\u3001{foo!=\"\"} \u548c {foo=~\".*\"} \u4e4b\u985e\u7684\u67e5\u8a62\u5c07\u8fd4\u56de\u932f\u8aa4\uff0c\u56e0\u70ba\u5b83\u5011\u90fd\u53ea\u662f\u4f7f\u7528\uff08\u6216\u5339\u914d\uff09\u4e00\u500b\u7a7a\u5b57\u7b26\u4e32\u4f5c\u70ba\u5339\u914d\u5668\u4e2d\u7684\u503c\uff01","title":"\u907f\u514d\u4f7f\u7528\u7a7a\u9078\u64c7\u5668"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#prometheus","text":"\u4f7f\u7528\u8af8\u5982 { name =~\".+\"} \u4e4b\u985e\u7684\u67e5\u8a62\u4f86\u7372\u53d6\u5b58\u5132\u5728\u670d\u52d9\u5668\u4e0a\u7684\u6240\u6709\u6642\u9593\u5e8f\u5217\u7684\u5217\u8868\u3002 \u50cf { name =~\"foo.*\"} \u9019\u6a23\u7684\u6771\u897f\u6703\u6aa2\u7d22\u4ee5 foo \u958b\u982d\u7684\u90a3\u4e9b\u6642\u9593\u5e8f\u5217\u7684\u5217\u8868\u3002 \u5982\u679c\u60a8\u4e0d\u719f\u6089\u6b63\u5247\u8868\u9054\u5f0f\uff1a . \u4ee3\u8868\u5b57\u7b26\u985e\uff08\u5339\u914d\u4efb\u4f55\u5b57\u7b26\uff09\uff0c + \u5f8c\u7db4\u4ee3\u8868\u201c\u81f3\u5c11\u4e00\u6b21\u201d\uff0c\u56e0\u6b64\u5169\u500b\u5b57\u7b26 .+ \u4e00\u8d77\u544a\u8a34 Prometheus \u5339\u914d\u540d\u7a31\u81f3\u5c11\u5305\u542b\u4e00\u500b\u5b57\u7b26\u7684\u4efb\u4f55\u6307\u6a19\u3002","title":"\u7372\u53d6\u5b58\u5132\u5728 Prometheus \u4e2d\u7684\u6240\u6709\uff08\u6216\u7279\u5b9a\uff09\u6642\u9593\u5e8f\u5217\u7684\u5217\u8868"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#by-without","text":"\u4f7f\u7528\u805a\u5408\u904b\u7b97\u7b26\u6642\uff0c\u60a8\u901a\u5e38\u61c9\u8a72\u66f4\u559c\u6b61\u4f7f\u7528: <aggregation operator e.g. sum> without ( label1,label2 )( ... ) \u800c\u4e0d\u662f: <aggregation operator e.g. sum> by ( somelabel )( ... ) \u70ba\u4ec0\u9ebc? \u56e0\u70ba\u6642\u9593\u5e8f\u5217\u7684\u6a19\u7c64\u4e26\u4e0d\u7e3d\u662f\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u800c\u7a69\u5b9a\u3002\u6a19\u7c64\u901a\u5e38\u662f\u5100\u5668\u6a19\u7c64\uff08\u901a\u5e38\u4e0d\u6703\u66f4\u6539\uff09\u6216\u76ee\u6a19\u6a19\u7c64\uff08\u7531 Prometheus \u5728\u6293\u53d6\u671f\u9593\u9644\u52a0\uff09\u3002\u76ee\u6a19\u6a19\u7c64\u662f\u975e\u5e38\u52d5\u614b\u7684\uff0c\u4e26\u4e14\u901a\u5e38\u4e0d\u53d7\u7de8\u5beb PromQL \u67e5\u8a62\u7684\u4eba\u7684\u63a7\u5236\u3002\u56e0\u6b64\uff0c\u6700\u597d\u4e0d\u4f7f\u7528\u805a\u5408\uff08\u5728\u7d55\u5c0d\u5df2\u77e5\u7684\u6a19\u7c64\u4e0a\u805a\u5408\uff0c\u9019\u6703\u5c07\u5b83\u5011\u5f9e\u7d50\u679c\u4e2d\u522a\u9664\uff09\uff0c\u5c07\u751f\u6210\u7684\u5373\u6642/\u7bc4\u570d\u5411\u91cf\u8207\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u4e00\u8d77\u4f7f\u7528\u3002 \u9019\u7a2e\u65b9\u6cd5\u8b93\u67e5\u8a62\u4f5c\u8005\u5728\u7a81\u7136\u5f48\u51fa\u65b0\u6a19\u7c64\u6642\u6ce8\u610f\u5230\uff08\u4f8b\u5982\u5728\u5100\u8868\u677f\u6216\u8b66\u5831\u901a\u77e5\u4e2d\uff09\uff0c\u7136\u5f8c\u4ed6\u5011\u53ef\u4ee5\u5728\u9700\u8981\u6642\u8abf\u6574 PromQL \u67e5\u8a62\u3002\u4f7f\u7528 without \u5c0d\u65bc\u8b66\u5831\u898f\u5247\u5c24\u5176\u91cd\u8981\uff0c\u4ee5\u4fdd\u7559\u8b66\u5831\u901a\u77e5\u4e2d\u7684\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002 by \u805a\u5408\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\u4ecd\u7136\u6709\u7528\uff0c\u4f8b\u5982\u5728\u5c0d\u4fe1\u606f\u6307\u6a19\u9032\u884c\u805a\u5408\u6642\uff08\u9810\u8a08\u5176\u5100\u8868\u6a19\u7c64\u6703\u66f4\u983b\u7e41\u5730\u66f4\u6539\uff09\uff0c\u4f8b\u5982\u4e00\u500b\u67e5\u8a62\uff0c\u4f8b\u5982 count by(release)(node_uname_info)","title":"\u805a\u5408\u904b\u7b97\u7b26\uff1aby \u8207 without"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#alerting-rule","text":"\u5982\u679c\u60a8\u5e0c\u671b\u8b66\u5831\u50c5\u5728\u7279\u5b9a\u6642\u9593\u89f8\u767c\uff0c\u8acb\u7de8\u5beb\u5982\u4e0b\u5167\u5bb9\uff1a <alert rule> and on() hour() > 9 < 17 on() \u78ba\u4fdd\u5373\u6642\u5411\u91cf\u5339\u914d\u4ecd\u7136\u767c\u751f\uff0c\u5373\u4f7f\u8a9e\u53e5\u7684\u8f38\u51fa\u5728\u5de6\u5074\u548c\u53f3\u5074\u4e26\u4e14\u6c92\u6709\u5171\u540c\u7684\u6a19\u7c64\u3002 \u9664\u4e86 hour() \uff0c\u60a8\u9084\u53ef\u4ee5\u4f7f\u7528\u5176\u4ed6\u51fd\u6578\uff0c\u4f8b\u5982 minute \uff0c day_of_week \uff0c day_of_month \uff0c month \uff0c year \u5728\u60a8\u7684 alert-rules.yml \u6587\u4ef6\u4e2d\uff0c\u81f3\u5c11\u4f7f\u7528\uff1a 5m \uff0c\u4ee5\u907f\u514d\u8aa4\u5831\u3002\u7121\u8ad6\u5982\u4f55\uff0c\u4f60\u4e0d\u80fd\u66f4\u5feb\u5730\u53cd\u61c9\u4e86\uff01 \u9700\u8981\u6ce8\u610f\u7684\u8b66\u544a\uff1aPrometheus \u4e0d\u6703\u5c07 for \u7684\u72c0\u614b\u6301\u4e45\u5316\u5230\u78c1\u76e4\uff08\u800c\u53ea\u6703\u5c07\u5176\u4fdd\u5b58\u5728 RAM \u4e2d\uff09\uff0c\u56e0\u6b64\u7576\u60a8\u91cd\u65b0\u555f\u52d5 Prometheus \u6642\uff0c\u5b83\u6703\u5f9e\u982d\u958b\u59cb\u8a55\u4f30\uff01 \u91cd\u8981\u63d0\u793a\uff1a for \u671f\u671b\u5c0d\u8a72\u8b66\u5831\u898f\u5247\u7684\u6bcf\u500b\u8a55\u4f30\u90fd\u5305\u542b\u975e\u9673\u820a\u7d50\u679c\u3002\u5047\u8a2d\u60a8\u6709\u4e00\u500b\u5e36\u6709 expr \u7684\u898f\u5247\uff1a process_open_fds > process_max_fds * .8 \u548c for\uff1a5m \u3002 \u5982\u679c\u50c5\u5c0d process_open_fds \u6307\u6a19\u7684\u4e00\u6b21\u6293\u53d6\u5931\u6557\uff0c\u5247\u5c0d\u8a72\u8868\u9054\u5f0f\u7684\u8a55\u4f30\u5c07\u7522\u751f\u4e00\u500b\u7a7a\u7d50\u679c\uff08\u56e0\u70ba\u904e\u6642\u6a19\u8a18\uff09\uff0c\u4e26\u4e14 for \u72c0\u614b\u5c07\u88ab\u91cd\u7f6e\u3002\u6709\u95dc\u904e\u6642\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u898b\u6b64\u8655\u3002\u89e3\u6c7a\u65b9\u6cd5\u662f\u4f7f\u7528 avg_over_time \u3001 max_over_time \u7b49\u51fd\u6578\uff0c\u4f8b\u5982\u5c07\u4e0a\u8ff0\u793a\u4f8b\u8abf\u6574\u70ba max_over_time(process_open_fds[5m]) > max_over_time(process_max_fds[5m]) * .8 - \u6ce8\u610f\uff1aup \u6307\u6a19\u662f\u4e00\u7a2e\u7279\u6b8a\u60c5\u6cc1\u2014\u2014\u9019\u88e1\u9019\u500b\u554f\u984c\u4e0d\u9069\u7528\uff0c\u56e0\u70ba\u5373\u4f7f\u6293\u53d6\u5931\u6557\uff0cup \u4e5f\u5b58\u5728\uff01 \u60a8\u53ef\u4ee5\u4f7f\u7528 amtool check-config \u547d\u4ee4\u4f86\u9a57\u8b49\u60a8\u7684 alertmanager.yml \u914d\u7f6e\u6587\u4ef6\uff0c\u4f8b\u5982\u5728\u63d0\u4ea4\u7248\u672c\u63a7\u5236\u4e4b\u524d\u3002","title":"Alerting rule \u5c0f\u6280\u5de7"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part4/#promql_3","text":"PromQL \u67e5\u8a62\u4e3b\u8981\u7528\u65bc\u7de8\u5beb\u8b66\u5831\u898f\u5247\u548c\u69cb\u5efa Grafana \u5100\u8868\u677f\u3002 PromQL \u7684\u4e3b\u8981\u56f0\u96e3\u662f\u5927\u91cf\u53ef\u7528\u7684\u6307\u6a19\u3002\u4f8b\u5982\uff0cPrometheus \u672c\u8eab\u7684 /metrics \u7aef\u9ede\u5df2\u7d93\u64c1\u6709\u8d85\u904e 150 \u500b\u6307\u6a19\uff0cnode exporter \u53ef\u4ee5\u8f15\u9b06\u64c1\u6709\u8d85\u904e 250 \u500b\u6307\u6a19\uff0c\u800c\u5176\u4ed6 exporter\uff08\u6216\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\uff09\u5c07\u64c1\u6709\u66f4\u591a\u3002\u6383\u63cf\u6240\u6709\u9019\u4e9b\u6307\u6a19\u4ee5\u6c7a\u5b9a\u5728\u5100\u8868\u677f\u6216\u8b66\u5831\u898f\u5247\u4e2d\u4f7f\u7528\u54ea\u4e9b\u6307\u6a19\u5c07\u662f\u4e00\u9805\u8271\u9245\u7684\u4efb\u52d9\u3002 \u5e78\u904b\u7684\u662f\uff0cPrometheus \u548c Grafana \u793e\u7fa4\u5df2\u7d93\u70ba\u4f60\u505a\u4e86\u5f88\u591a\u5de5\u4f5c\uff1a \u5c0d\u65bc Grafana \u5100\u8868\u677f\uff0c\u6709\u5b98\u65b9\u7684 \u5100\u8868\u677f\u5b58\u5132\u5eab \uff0c\u5176\u4e2d\u641c\u7d22\u4e00\u4e9b\u7b2c\u4e09\u65b9 exporter\uff08\u4f8b\u5982\u201cpostgres\u201d\u3001\u201cnode exporter\u201d\u7b49\uff09\u5c07\u70ba\u60a8\u63d0\u4f9b\u5927\u91cf\u53ef\u7528\u4f5c\u57fa\u790e\u7684\u5100\u8868\u677f\u3002 \u5c0d\u65bc Alerting rule\uff0c\u6709\u8af8\u5982 Awesome Prometheus alerts \u4e4b\u985e\u7684\u7db2\u7ad9\uff0c\u5176\u4e2d\u5305\u542b\u5404\u7a2e exporter \u7684\u8a31\u591a\u793a\u4f8b\u3002\u4e26\u975e\u6240\u6709\u898f\u5247\u90fd\u662f\u771f\u6b63\u660e\u667a\u7684\uff1a\u60a8\u4ecd\u7136\u9700\u8981\u8a55\u4f30\u6bcf\u689d\u898f\u5247\uff0c\u7121\u8ad6\u5b83\u662f\u5426\u5c0d\u60a8\u7684\u7cfb\u7d71\u6709\u610f\u7fa9\u3002 \u9019\u4e9b\u8cc7\u6e90\u5c07\u5e6b\u52a9\u60a8\u5165\u9580\uff0c\u56e0\u70ba\u60a8\u4e0d\u518d\u9700\u8981\u5f9e\u982d\u958b\u59cb\u7de8\u5beb\u67e5\u8a62\u3002\u76f8\u53cd\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u60a8\u5c0d\u672c\u6587\u4e2d\u63d0\u4f9b\u7684\u904b\u7b97\u7b26\u3001\u51fd\u6578\u7b49\u7684\u7406\u89e3\u4f86\u8abf\u6574\u5b83\u5011\u4ee5\u9069\u61c9\u60a8\u7684\u9700\u6c42\u3002","title":"\u7d50\u8ad6\uff1a\u5c07 PromQL \u67e5\u8a62\u4ed8\u8af8\u5be6\u8e10"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/","text":"Alert \u6700\u4f73\u5be6\u8e10 \u00b6 \u539f\u6587: Kubernetes Observability \u2013 Part V: alerting best practices \u672c\u6587\u89e3\u91cb\u4e86\u5728\u62bd\u8c61\u7684\u3001\u7368\u7acb\u65bc\u5de5\u5177\u7684\u7d1a\u5225\u4e0a\u7de8\u5beb\u8b66\u5831\u7684\u6700\u4f73\u5be6\u8e10\u3002\u6211\u9032\u5165\u4e86\u6280\u8853\u8b66\u5831\u6a21\u5f0f\uff08\u5305\u62ec RED \u548c USE\uff09\u4ee5\u53ca\u70ba\u4ec0\u9ebc\u5f9e\u696d\u52d9\u89d2\u5ea6\u958b\u59cb\u6703\u66f4\u597d\u3002\u6211\u8a73\u7d30\u4ecb\u7d39\u4e86\u4e00\u822c\u8b66\u5831\u898f\u5247\u8a2d\u8a08\uff0c\u4f8b\u5982\u8b66\u5831\u983b\u7387\u548c\u9069\u7576\u7684\u76ee\u7684\u5730\uff0c\u4e26\u7d66\u51fa\u4e86\u89e3\u6c7a\u61c9\u7528\u7a0b\u5e8f\u4e0d\u540c\u5c64\u4e2d\u53ef\u89c0\u5bdf\u6027\u7684\u5177\u9ad4\u6280\u5de7\uff0c\u4f8b\u5982\u670d\u52d9\u5668\u8207\u670d\u52d9\u8207\u61c9\u7528\u7a0b\u5e8f\u3002\u6211\u9084\u89e3\u91cb\u4e86\u4e8b\u4ef6\u7ba1\u7406\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u4ee5\u53ca\u5728\u751f\u7522\u74b0\u5883\u4e2d\u6e2c\u8a66\u53ef\u89c0\u5bdf\u6027\u5982\u4f55\u5be6\u73fe\u6700\u9ad8\u7d1a\u5225\u7684\u53ef\u89c0\u5bdf\u6027\u3002 \u4ecb\u7d39 \u00b6 Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c\u53ef\u89c0\u5bdf\u6027\u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u4e2d\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u6709\u8a31\u591a\u6280\u8853\u77e5\u8b58\u9700\u8981\u5b78\u7fd2\uff0c\u6211\u5728\u6280\u8853\u8ecc\u9053\u4e2d\u9032\u884c\u4e86\u4ecb\u7d39\u3002\u4f46\u4e5f\u6709\u4f60\u9700\u8981\u7372\u5f97\u7684\u5143\u7d1a\u77e5\u8b58\uff0c\u5b83\u8207\u5de5\u5177\u7121\u95dc\uff0c\u6211\u5c07\u5176\u653e\u5165\u9ad8\u7d1a\u53ef\u89c0\u5bdf\u6027\u8ecc\u9053\u3002\u5177\u9ad4\u7684\u5143\u7d1a\u77e5\u8b58\u9805\u76ee\u4e4b\u4e00\u662f\u5b78\u7fd2\u9ad8\u7d1a\u8b66\u5831\u8a2d\u8a08\u539f\u5247\u2014\u2014\u8a72\u9818\u57df\u7684\u5de5\u4f5c\u4eba\u54e1\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u6536\u96c6\u7684\u539f\u5247\uff0c\u6211\u5011\u5c07\u5728\u672c\u6587\u4e2d\u66f4\u4ed4\u7d30\u5730\u7814\u7a76\u9019\u4e9b\u539f\u5247\u3002 \u672c\u6587\u7684\u76ee\u7684\u662f\u5e6b\u52a9\u60a8\u958b\u59cb\u7de8\u5beb\u60a8\u7684\u7b2c\u4e00\u500b\u8b66\u5831\u898f\u5247\uff0c\u70ba\u60a8\u5e36\u4f86\u6700\u5927\u7684\u597d\u8655\u3002\u6c92\u6709\u9019\u6a23\u7684\u6307\u5c0e\uff0c\u53ea\u6709\u5927\u91cf\u7684\u6280\u8853\u77e5\u8b58\u662f\u6c92\u6709\u7528\u7684\u3002\u60a8\u53ef\u4ee5\u70ba\u5176\u5275\u5efa\u8b66\u5831\u7684\u6307\u6a19\u6578\u64da\u6e90\u592a\u591a\u3002\u60a8\u53ef\u80fd\u6703\u7522\u751f\u975e\u5e38\u5608\u96dc\u7684\u8b66\u5831\u6d2a\u6d41\uff0c\u9019\u4e9b\u5982\u6f6e\u6c34\u822c\u6e67\u4f86\u7684\u8b66\u5831\u6700\u7d42\u90fd\u6703\u88ab\u5ffd\u7565\u3002 \u6b64\u8655\u6db5\u84cb\u7684\u8a31\u591a\u8981\u9ede\u5747\u4f86\u81ea\u300a \u5be6\u7528\u76e3\u63a7 \u300b\u4e00\u66f8\uff082017 \u5e74\u51fa\u7248\uff09\uff0c\u6211\u7d55\u5c0d\u5efa\u8b70\u60a8\u4ed4\u7d30\u95b1\u8b80\u3002\u9019\u672c\u66f8\u88e1\u6240\u7d66\u7684\u5efa\u8b70\u53ef\u80fd\u5df2\u6709\u6578\u5e74\u591a\u7684\u6b77\u53f2\uff0c\u4f46\u5e7e\u4e4e\u6240\u6709\u7684\u5efa\u8b70\u5230\u4e86\u4eca\u5929\u537b\u4ecd\u7136\u9069\u7528\u3002 \u6280\u8853\u8207\u696d\u52d9\u9a45\u52d5\u7684\u8b66\u5831 \u00b6 \u5982\u679c\u4f60\u662f\u4e00\u540d\u5de5\u7a0b\u5e2b\uff0c\u4f60\u5f88\u6709\u53ef\u80fd\u6703\u5f9e\u6280\u8853\u89d2\u5ea6\u4f86\u89e3\u6c7a\u554f\u984c\uff0c\u56e0\u70ba\u90a3\u662f\u4f60\u64c5\u9577\u7684\u548c\u4f60\u6240\u77e5\u9053\u7684\u3002\u60a8\u53ef\u80fd\u6703\u958b\u59cb\u5206\u6790\u60a8\u64c1\u6709\u54ea\u4e9b\u57fa\u790e\u8a2d\u65bd/\u670d\u52d9\u5668\u3001\u5b83\u5011\u904b\u884c\u54ea\u4e9b\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\u7b49\uff09\u3001\u7db2\u7d61\u5982\u4f55\u767c\u63ee\u4f5c\u7528\u4ee5\u53ca\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u80fd\u5b58\u5728\u54ea\u4e9b\u6280\u8853\u554f\u984c\uff08\u4f8b\u5982\u5167\u5b58\u6d88\u8017\u3001\u5783\u573e\u6536\u96c6\u7b49\uff09\u3002 \u5169\u7a2e\u5ee3\u6cdb\u61c9\u7528\u7684\u6280\u8853\u8b66\u5831\u6a21\u5f0f\u662f RED \u548c USE \uff0c\u5982\u4e0b\u6240\u793a\uff1a RED USE RED \u4ee3\u8868\u8acb\u6c42\u7387( R equest Rate)\u3001\u932f\u8aa4\u7387( E rror Rate)\u3001\u8acb\u6c42\u6301\u7e8c\u6642\u9593( D uration of request)\u3002 RED \u6a21\u5f0f\u4e3b\u8981\u9069\u7528\u65bc\u8acb\u6c42\u9a45\u52d5\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u4f8b\u5982\u60a8\u958b\u767c\u7684 Web \u670d\u52d9\u3002\u5c0d\u65bc\u9019\u4e9b\u985e\u578b\u7684\u61c9\u7528\u7a0b\u5e8f\uff0cRED \u53ef\u4ee5\u5e6b\u52a9\u60a8\u9078\u64c7\u73fe\u6709\u7684\u6307\u6a19\u6578\u64da\u4f86\u5275\u5efa\u8b66\u5831\u3002\u4f8b\u5982\uff0c\u60a8\u61c9\u8a72\u4f7f\u7528 HTTP \u53cd\u5411\u4ee3\u7406\uff08\u5982 Nginx\uff09\u63d0\u4f9b\u7684\u773e\u591a\u6307\u6a19\u6578\u64da\u4e2d\u7684\u54ea\u4e00\u500b\u3002\u4f46\u662f RED \u9084\u53ef\u4ee5\u5e6b\u52a9\u60a8\u6c7a\u5b9a\u5982\u4f55\u6aa2\u6e2c\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5373\u60a8\u61c9\u8a72\u5c07\u54ea\u4e9b\u985e\u578b\u7684\u6578\u64da\u516c\u958b\u70ba\u6307\u6a19\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u70ba\u5b83\u5011\u7de8\u5beb\u8b66\u5831\u3002 \u7e3d\u4e4b\uff1a Request rate : \u56de\u7b54\u9019\u500b\u554f\u984c\uff1a\u201c\u6211\u7684\u7cfb\u7d71\u6709\u591a\u5fd9\uff1f\u201d\u3002\u6211\u5011\u53ef\u4ee5\u901a\u904e\u8a08\u7b97\u8acb\u6c42\u7684\u6578\u91cf\uff08\u7531\u8def\u5f91/URL \u5206\u9694\uff09\u4f86\u78ba\u5b9a\uff0c\u7136\u5f8c\u53ef\u89c0\u5bdf\u7cfb\u7d71\uff08\u4f8b\u5982 Prometheus\uff09\u5728\u904b\u884c\u6642\u5c07\u5176\u8f49\u63db\u70ba\u901f\u7387\uff08\u4f8b\u5982 200 requests/second\uff09\u3002 Error rate : \u56de\u7b54\u9019\u500b\u554f\u984c\uff1a\u201c\u8acb\u6c42\u7e3d\u6578\u4e2d\u6709\u591a\u5c11\u662f\u932f\u8aa4\u7684(\u767e\u5206\u6bd4)?\u201d\u3002\u8207 Request rate \u985e\u4f3c\u5730\u8a08\u7b97\u908f\u8f2f\u3002\u60a8\u9084\u53ef\u4ee5\u8003\u616e\u5c0d\u4e0d\u540c\u985e\u578b\u7684\u932f\u8aa4\u9032\u884c\u5206\u985e\uff08\u4f8b\u5982 HTTP \u97ff\u61c9\u4ee3\u78bc 4xx \u8207 5xx\uff09\u3002 Duration of request : \u56de\u7b54\u9019\u500b\u554f\u984c\uff1a\u201c\u6211\u7684\u7cfb\u7d71\u7684\u5ef6\u9072\u5206\u4f48\u60c5\u6cc1\u5982\u4f55\uff1f\u201d\u3002\u60a8\u5e0c\u671b\u5c07\u6b64\u6578\u64da\u4f5c\u70ba\u76f4\u65b9\u5716\uff0c\u800c\u4e0d\u662f\u55ae\u500b\u503c\uff08\u4f8b\u5982\u5e73\u5747\u5ef6\u9072\uff09\uff0c\u56e0\u70ba\u5b83\u5141\u8a31\u60a8\u6aa2\u6e2c\u7570\u5e38\u503c\u3002\u901a\u5e38\uff0c\u60a8\u5c07\u914d\u7f6e\u60a8\u7684 HTTP \u670d\u52d9\u5668\u4ee5\u5728\u5176\u65e5\u8a8c\u4e2d\u5305\u542b\u8acb\u6c42\u6301\u7e8c\u6642\u9593\uff0c\u7136\u5f8c\u4f7f\u7528\u6307\u6a19\u5c0e\u51fa\u5668\u5f9e\u9019\u4e9b\u65e5\u8a8c\u6587\u4ef6\u8a08\u7b97\u76f4\u65b9\u5716\uff08\u8acb\u53c3\u95b1\u6b64\u8655\u7684 Nginx \u6559\u7a0b \u3002 USE \u4ee3\u8868\u5229\u7528\u7387(Utilization)\u3001\u98fd\u548c\u5ea6(Saturation)\u3001\u932f\u8aa4(Errors)\u3002 USE \u4e3b\u8981\u61c9\u7528\u65bc\u57fa\u790e\u8a2d\u65bd\uff0c\u7279\u5225\u662f\u5728\u5f8c\u53f0\u57f7\u884c\u7570\u6b65\u5de5\u4f5c\u7684\u7cfb\u7d71\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u5229\u7528\u7387\u3001\u98fd\u548c\u5ea6\u548c\u932f\u8aa4\u9069\u7528\u65bc\u7cfb\u7d71\u8cc7\u6e90\u3002 Utilization : \u5df2\u4f7f\u7528\u8cc7\u6e90\u7684\u6bd4\u4f8b -> 100% \u5229\u7528\u7387\u610f\u5473\u8457\u7121\u6cd5\u63a5\u53d7\u66f4\u591a\u5de5\u4f5c\u3002\u53ef\u4ee5\u61c9\u7528\u65bc RAM\uff0c\u4e5f\u53ef\u4ee5\u61c9\u7528\u65bc CPU \u8ca0\u8f09\u3002 Saturation : \u8cc7\u6e90\u5177\u6709\u7121\u6cd5\u670d\u52d9\u7684\u984d\u5916\u5de5\u4f5c\u7684\u7a0b\u5ea6\uff0c\u56e0\u6b64\u7d93\u5e38\u6392\u968a\u3002\u53c3\u898b\u4f8b\u5982\u5728\u9019\u91cc\u548c\u9019\u88e1\u53ef\u4ee5\u66f4\u597d\u5730\u7406\u89e3 CPU \u7684\u9019\u4e00\u9ede\u3002 Errors : \u932f\u8aa4\u4e8b\u4ef6\u7684\u8a08\u6578\uff0c\u4f8b\u5982\u8a2d\u5099\u932f\u8aa4\u3002 \u56e0\u70ba\u9b54\u9b3c\u5728\u7d30\u7bc0\u4e2d\uff08\u95dc\u65bc\u5982\u4f55\u6536\u96c6\u9019\u4e9b\u6307\u6a19\uff0c\u4ee5\u53ca\u5982\u4f55\u89e3\u91cb\u5b83\u5011\uff09\uff0c\u6211\u63a8\u85a6\u9019\u7bc7 \u512a\u79c0\u7684\u6587\u7ae0 \u3002 \u4f46\u662f\uff0c\u66f4\u597d\u7684\u65b9\u6cd5\u662f\u5f9e\u6700\u7d42\u7528\u6236\u7684\u89d2\u5ea6\u89e3\u6c7a\u554f\u984c\u3002\u7562\u7adf\uff0c\u60a8\u6b63\u5728\u70ba\u6700\u7d42\u7528\u6236\u69cb\u5efa\u8edf\u4ef6\uff0c\u5982\u679c\u4ed6\u5011\u56e0\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7121\u6cd5\u6b63\u5e38\u904b\u884c\uff08\u826f\u597d\uff09\u800c\u96e2\u958b\uff0c\u90a3\u9ebc\u60a8\u5c31\u6703\u5012\u9589\u3002\u60a8\u7684\u6700\u7d42\u7528\u6236\u4e0d\u77e5\u9053\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u63d0\u4f9b\u52d5\u529b\u7684\u670d\u52d9\u5668\u6216\u670d\u52d9\u3002\u5b83\u5011\u50c5\u8207\u67d0\u7a2e\u7528\u6236\u754c\u9762\u4ea4\u4e92\uff0c\u56e0\u6b64\u60a8\u6700\u597d\u958b\u59cb\u69cb\u5efa\u6307\u6a19\uff08\u5e36\u6709\u76f8\u61c9\u7684\u8b66\u5831\uff09\uff0c\u4ee5\u6307\u793a\u8a72\u754c\u9762\u4f55\u6642\u51fa\u73fe\u554f\u984c\u3002 \u50c5\u8003\u616e\u6280\u8853\u65b9\u9762\u6642\uff0c\u53ef\u80fd\u6703\u4ee5\u5169\u7a2e\u4e0d\u540c\u7684\u65b9\u5f0f\u51fa\u932f\uff1a \u4e0d\u77e5\u60c5\u7684\u6280\u8853\u5718\u968a \uff1a\u5982\u4e0a\u5716\u6240\u793a\uff0c\u5c0d\u200b\u200b\u6240\u6709\u55ae\u500b\u7d44\u4ef6\u7684\u76e3\u63a7\u8868\u660e\u4e00\u5207\u6b63\u5e38\uff0c\u4f46\u6700\u7d42\u7528\u6236\u78ba\u5be6\u9047\u5230\u4e86\u554f\u984c\u3002\u5982\u679c\u7f3a\u5c11\u6574\u9ad4\u9858\u666f\u548c\u6700\u7d42\u7528\u6236\u8996\u89d2\uff0c\u4e26\u4e14\u6bcf\u500b\u5718\u968a\u50c5\u91dd\u5c0d\u4ed6\u5011\u64c1\u6709\u7684\u7cfb\u7d71\u90e8\u5206\u5be6\u65bd\u6307\u6a19\u548c\u8b66\u5831\uff0c\u5247\u53ef\u80fd\u6703\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\u3002 \u4e0d\u77e5\u60c5\u7684\u6700\u7d42\u7528\u6236 \uff1a\u9019\u662f\u76f8\u53cd\u7684\u60c5\u6cc1\uff1a\u6700\u7d42\u7528\u6236\u6c92\u6709\u8a3b\u610f\u5230\u4efb\u4f55\u554f\u984c\uff0c\u4f46\u60a8\u7684\u5718\u968a\u6b63\u5728\u6050\u614c\uff0c\u4f8b\u5982\u56e0\u70baCPU\u98fd\u548c\u5ea6\u7a81\u7136\u5f88\u9ad8\u3002\u9019\u901a\u5e38\u662f\u7531\u904e\u65bc\u5608\u96dc\u7684\u8b66\u5831\u5f15\u8d77\u7684\uff0c\u5373\uff0c\u5177\u6709\u6839\u672c\u4e0d\u61c9\u8a72\u6709\u8b66\u5831\u7684\u6280\u8853\u65b9\u9762\u7684\u8b66\u5831\uff0c\u6216\u8005\u56e0\u70ba\u95be\u503c\u9078\u64c7\u4e0d\u7576\u3002 \u81ea\u7136\uff0c\u8a31\u591a\u6280\u8853\u6307\u6a19\u4e5f\u6db5\u84cb\u4e86\u6700\u7d42\u7528\u6236\u7684\u9700\u6c42\uff0c\u4f8b\u5982\u5728\u76e3\u63a7 Web \u61c9\u7528\u7a0b\u5e8f\u7684\u932f\u8aa4\u7387\uff08RED \u4e2d\u7684 E\uff09\u6642\u3002\u4f46\u9b54\u9b3c\u5728\u7d30\u7bc0\u4e2d\uff1a \u793a\u4f8b #1 \uff1a\u6709\u591a\u5c11\u932f\u8aa4\u662f\u6709\u554f\u984c\u7684\u4e26\u4e14\u61c9\u8a72\u89f8\u767c\u8b66\u5831\uff1f\u6240\u6709\u8acb\u6c42\u7684 1%\uff1f 10%\uff1f\u5982\u679c 1% \u5f71\u97ff /register \u7aef\u9ede\u600e\u9ebc\u8fa6\uff1f\u7136\u5f8c\u4f60\u5c31\u5931\u53bb\u4e86 1% \u7684\u6f5b\u5728\u65b0\u5ba2\u6236\uff0c\u4ed6\u5011\u7121\u6cd5\u8a3b\u518a\uff0c\u9019\u6bd4 1% \u5f71\u97ff /generate-pdf-report \u7aef\u9ede\u7684\u60c5\u6cc1\u8981\u7cdf\u7cd5\u5f97\u591a\uff08\u5f9e\u696d\u52d9\u89d2\u5ea6\u4f86\u770b\uff09\u3002 \u793a\u4f8b #2 \uff1a\u60a8\u7684\u7528\u6236\u53ef\u4ee5\u5bb9\u5fcd\u591a\u5c11\u5ef6\u9072\uff1f\u6c92\u6709\u55ae\u4e00\u7c21\u55ae\u7684\u7b54\u6848\uff0c\u5b83\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53d6\u6c7a\u65bc\u61c9\u7528\u7a0b\u5e8f\uff0c\u60a8\u7684\u95be\u503c\u53ef\u80fd\u5f9e 50 \u6beb\u79d2\u5230\u5e7e\u5206\u9418\u4e0d\u7b49\u3002\u7576\u7136\uff0c\u5c0d\u65bc\u66f4\u9577\u7684\u6301\u7e8c\u6642\u9593\uff0cUI \u5fc5\u9808\u5c07\u9810\u671f\u7684\u5ef6\u9072\u50b3\u9054\u7d66\u60a8\u7684\u7528\u6236\u3002\u5982\u679c\u4e00\u500b\u64cd\u4f5c\uff08\u5f9e\u7528\u6236\u7684\u89d2\u5ea6\uff09\u61c9\u8a72\u662f\u5373\u6642\u7684\uff08\u4f8b\u5982\u9ede\u64ca\u201c\u4fdd\u5b58\u6309\u9215\u201d\uff09\u4f46\u5be6\u969b\u60c5\u5f62\u537b\u4e0d\u662f\u7684\u8a71\uff0c\u7528\u6236\u6703\u8a8d\u70ba\u7cfb\u7d71\u662f\u4e00\u500b\u5931\u6557\u7684\u7cfb\u7d71\uff08\u4e26\u4e14\u53ef\u80fd\u5f88\u5feb\u96e2\u958b\uff09\uff0c\u800c\u4f60\u4f5c\u70ba\u4e00\u500b\u5de5\u7a0b\u5e2b\uff0c\u53ea\u6703\u5c07\u5176\u6b78\u985e\u70ba\u201c\u6709\u9ede\u6162\u201d\u3002 \u9019\u5c31\u662f KPI\uff08\u95dc\u9375\u7e3e\u6548\u6307\u6a19\uff09\u767c\u63ee\u4f5c\u7528\u7684\u5730\u65b9\u3002\u4f8b\u5982\uff0c\u60a8\u61c9\u8a72\u5efa\u7acb\u6307\u6a19\u4f86\u5e6b\u52a9\u60a8\u78ba\u5b9a\u60a8\u7684\u696d\u52d9\u4f5c\u70ba\u4e00\u500b\u6574\u9ad4\u662f\u5728\u589e\u9577\u9084\u662f\u5728\u840e\u7e2e\uff0c\u4f8b\u5982\u901a\u904e\u89c0\u5bdf\u767b\u9304\u6b21\u6578/\u6bcf\u6708\u6d3b\u8e8d\u7528\u6236\u3001\u5ba2\u6236\u7e3d\u6578\u3001\u6536\u5165\u3001\u4ed8\u8cbb\u5ba2\u6236\u767e\u5206\u6bd4\uff08\u5982\u679c\u60a8\u6709\u514d\u8cbb\u5957\u9910\uff09\u3001\u7528\u6236\u56de\u7b54\u7684\u8abf\u67e5\u6578\u64da\u7b49\u3002 \u8981\u4e86\u89e3\u6709\u95dc\u60a8\u696d\u52d9\u7684 KPI \u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u4e0d\u8981\u50cf CTO \u90a3\u6a23\u601d\u8003 - \u50cf\u60a8\u7684 CEO\u3001CFO \u7b49\u90a3\u6a23\u601d\u8003\u3002\u8207\u60a8\u7d44\u7e54\u4e2d\u4e0d\u662f\u5de5\u7a0b\u5e2b\u7684\u4eba\u4ea4\u8ac7\uff0c\u4f8b\u5982\u7522\u54c1\u6240\u6709\u8005\u6216\u5ba2\u6236\u652f\u6301\u3002\u60a8\u4e0d\u50c5\u53ef\u4ee5\u4e86\u89e3\u60a8\u7684\u7528\u6236\u95dc\u5fc3\u4f46\u60a8\u4e0d\u77e5\u9053\u5b58\u5728\u7684\u65b9\u9762\uff0c\u800c\u4e14\u60a8\u9084\u53ef\u4ee5\u653e\u9b06\u4e26\u964d\u4f4e\u4e00\u4e9b\u786c\u6027\u8981\u6c42\u6216\u8b66\u5831\u95be\u503c\uff08\u4f8b\u5982\uff0c\u5728\u69cb\u5efa\u96fb\u5b50\u90f5\u4ef6\u670d\u52d9\u5668\u6642\uff0c\u60a8\u525b\u525b\u4e86\u89e3\u5230\u7528\u6236\u5982\u679c\u8655\u7406\u5916\u767c\u90f5\u4ef6\u6700\u591a\u9700\u8981 10 \u79d2\uff0c\u8acb\u4e0d\u8981\u4ecb\u610f\uff09\u3002\u5beb\u4e0b\u60a8\u7684\u670d\u52d9/\u61c9\u7528\u7a0b\u5e8f\u6240\u505a\u7684\u63cf\u8ff0\uff08\u5305\u62ec\u5176\u529f\u80fd\u548c UI \u6f14\u7df4\uff09\u7136\u5f8c\u5206\u6790\u6b64\u63cf\u8ff0\u4e5f\u5f88\u6709\u5e6b\u52a9\u3002 \u4e00\u65e6\u60a8\u5c0d\u6280\u8853\u548c\u696d\u52d9 KPI \u90fd\u6709\u8b66\u5831\uff0c\u8acb\u5617\u8a66\u5c07\u5b83\u5011\u95dc\u806f\u8d77\u4f86\u3002\u5f37\u76f8\u95dc\u6027\u6709\u6642\u53ef\u80fd\u6709\u52a9\u65bc\u89e3\u91cb KPI \u6307\u6a19\u767c\u751f\u8b8a\u5316\u7684\u539f\u56e0\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6bcf\u6708\u6d3b\u8e8d\u7528\u6236\u8a08\u6578\uff08KPI \u6307\u6a19\uff09\u7a81\u7136\u958b\u59cb\u4e0b\u964d\uff0c\u4e26\u4e14\u60a8\u9084\u767c\u73fe\u5e73\u5747\u670d\u52d9\u97ff\u61c9\u6642\u9593\uff08\u6280\u8853\u6307\u6a19\uff09\u4e5f\u540c\u6642\u958b\u59cb\u5927\u5e45\u589e\u52a0\uff0c\u9019\u53ef\u80fd\u662f\u5c0e\u81f4\u7528\u6236\u96e2\u958b\u3002 \u826f\u597d\u7684\u544a\u8b66\u898f\u5247\u8a2d\u8a08 \u00b6 \u4e00\u822c\u4f86\u8aaa\uff0c\u5c07\u544a\u8b66\u5206\u70ba\u5169\u500b\u7d1a\u5225\u662f\u4e00\u500b\u597d\u4e3b\u610f\uff1a Critical : \u4f60\u73fe\u5728\u9700\u8981\u505a\u9ede\u4ec0\u9ebc\uff0c\u5426\u5247\u7cfb\u7d71\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u5d29\u6f70\uff01\u4f8b\u5982\u3002\u56e0\u70ba\u5e7e\u500b\u670d\u52d9\u505c\u6b62\u5de5\u4f5c\u3002 FYI : \u50c5\u4f9b\u53c3\u8003\uff0c\u51fa\u4e86\u9ede\u554f\u984c\uff0c\u4f46\u4e26\u4e0d\u56b4\u91cd\uff0c\u4f8b\u5982\u5099\u4efd\u5931\u6557\uff0c\u6216\u78c1\u76e4\u6162\u6162\u586b\u6eff\u3002 \u5728\u201c\u5be6\u969b\u76e3\u63a7\u201d\u4e00\u66f8\u4e2d\uff0c\u7b2c\u4e8c\u500b\u7d1a\u5225\uff08FYI\uff09\u88ab\u8a8d\u70ba\u53ea\u662f\u4e00\u500b\u6d88\u606f\uff0c\u800c\u4e0d\u662f\u4e00\u500b\u8b66\u5831\u3002\u5c07 FYI \u985e\u578b\u7684\u6d88\u606f\u767c\u9001\u5230\u804a\u5929\u5ba4\u6216\u81ea\u52d5\u751f\u6210 ticket \u5c31\u8db3\u5920\u4e86\u3002\u4f46\u662f\uff0c\u91cd\u8981\u7684\u8b66\u5831\u901a\u77e5\u9700\u8981\u4ee5\u60a8\u9ad8\u5ea6\u78ba\u4fe1\u6709\u4eba\u80af\u5b9a\u6703\u5f88\u5feb\u95b1\u8b80\u5b83\u7684\u65b9\u5f0f\u767c\u9001\uff0c\u4f8b\u5982\u81ea\u52d5\u64a5\u6253\u96fb\u8a71\u6216\u767c\u9001\u77ed\u4fe1\u3002 \u5be6\u7528\u76e3\u63a7 \u63d0\u51fa\u4e86\u5e7e\u500b\u826f\u597d\u8b66\u5831\u8a2d\u8a08\u7684\u901a\u7528\u6280\u5de7\uff1a \u505c\u6b62\u4f7f\u7528\u96fb\u5b50\u90f5\u4ef6\u767c\u9001\u8b66\u5831: \u96fb\u5b50\u90f5\u4ef6\u901a\u5e38\u4e0d\u6703\u559a\u9192\u4efb\u4f55\u4eba\u3002\u77ed\u4fe1\u3001\u5fbe\u4fe1\u6216\u96fb\u8a71\u90fd\u53ef\u4ee5\uff01\u96fb\u5b50\u90f5\u4ef6\u66f4\u9069\u5408\u6d88\u606f\u985e\u578b\u7684\u8b66\u5831\u3002 \u7de8\u5beb\u904b\u884c\u624b\u518a(run book)\uff1a\u70ba\u7279\u5b9a\u670d\u52d9\u7de8\u5beb\u904b\u884c\u624b\u518a\u3002\u5b83\u63cf\u8ff0\u4e86\u9019\u500b\u670d\u52d9\u662f\u4ec0\u9ebc\uff0c\u5b83\u505a\u4ec0\u9ebc\uff0c\u8ab0\u8ca0\u8cac\u5b83\uff0c\u5b83\u6709\u4ec0\u9ebc\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u5b83\u7684\u57fa\u790e\u8a2d\u65bd\u662f\u4ec0\u9ebc\u6a23\u7684\uff0c\u5b83\u767c\u51fa\u4ec0\u9ebc\u6307\u6a19\u548c\u65e5\u8a8c\uff08\u4ee5\u53ca\u5b83\u5011\u7684\u542b\u7fa9\uff09\uff0c\u4ee5\u53ca\u70ba\u4ec0\u9ebc\u8b66\u5831\u8a2d\u7f6e\u5b83\uff08\u4ee5\u53ca\u70ba\u4ec0\u9ebc\uff09\u3002\u5c0d\u65bc\u6bcf\u500b\u8b66\u5831\uff0c\u70ba\u8a72\u670d\u52d9\u7684\u904b\u884c\u624b\u518a\u5275\u5efa\u4e00\u500b\uff08\u53ef\u9ede\u64ca\u7684\uff09\u93c8\u63a5 \u907f\u514d\u5728\u8b66\u5831\u898f\u5247\u5b9a\u7fa9\u4e2d\u4f7f\u7528\u4efb\u610f\u7684\u975c\u614b\u95be\u503c\u3002\u76f8\u53cd\uff0c\u901a\u5e38\u50cf\u589e\u9577\u7387\u9019\u6a23\u7684\u6771\u897f\u66f4\u6709\u8da3\u3002 \u4f8b\u5982\uff1a\u975c\u614b\u8b66\u5831\u898f\u5247\u201c\u50c5\u5269\u9918 10% \u7684\u78c1\u76e4\u7a7a\u9593\u201d\u4e0d\u5982\u201c\u78c1\u76e4\u4f7f\u7528\u7387\u5728\u904e\u53bb 10 \u5206\u9418\u5167\u589e\u9577\u4e86 X%\u201d\u6709\u7528\u3002\u4f7f\u7528\u975c\u614b\u898f\u5247\uff0c\u5982\u679c\u78c1\u76e4\u5f88\u5c0f\u4e26\u4e14\u5728\u77ed\u6642\u9593\u5167\u751f\u6210\u5927\u91cf\u6578\u64da\uff0c\u60a8\u7684\u7cfb\u7d71\u4ecd\u7136\u53ef\u80fd\u5d29\u6f70\u3002\u4f60\u771f\u6b63\u60f3\u8981\u7684\u662f\u5728\u201c\u6b63\u78ba\u7684\u6642\u9593\u201d\u767c\u51fa\u8b66\u544a\uff08\u4f8b\u5982\uff0c\u6709\u5169\u9031\u7684\u8dd1\u9053\uff09\u3002\u975c\u614b\u7684\u201c10%\u201d\u767e\u5206\u6bd4\u503c\u4e0d\u6703\u7d66\u4f60\u9019\u500b\u3002\u76f8\u53cd\uff0c\u60a8\u5fc5\u9808\u6e2c\u91cf\u78c1\u76e4\u586b\u6eff\u7684\u901f\u7387\uff0c\u8a08\u7b97\u5269\u4f59\u5929\u6578\uff08\u8003\u616e\u53ef\u7528\u78c1\u76e4\u7a7a\u9593\uff09\uff0c\u7136\u5f8c\u5728\u5929\u6578\u4f4e\u65bc\u95be\u503c\u6642\u8b66\u544a\u60a8\u3002 \u522a\u9664\u548c\u8abf\u6574\u8b66\u5831\uff0c\u4ee5\u4fbf\u60a8\u6536\u5230\u76e1\u53ef\u80fd\u5c11\u7684\u8b66\u5831\u3002\u9019\u53ef\u4ee5\u6e1b\u5c11\u8b66\u5831\u75b2\u52de\uff0c\u9019\u662f\u7531\u65bc\u8b66\u5831\u592a\u591a\u800c\u958b\u59cb\u5ffd\u7565\u8b66\u5831\u7684\u73fe\u8c61\u3002\u8003\u616e\u5b9a\u671f\u56de\u9867\u60a8\u7684\u8b66\u5831\u6b77\u53f2\u8a18\u9304\uff0c\u4f8b\u5982\u904e\u53bb 30 \u5929\uff1a\u767c\u751f\u4e86\u54ea\u4e9b\u8b66\u5831\uff0c\u5fc5\u9808\u63a1\u53d6\u4ec0\u9ebc\u63aa\u65bd\u4f86\u89e3\u6c7a\u5b83\u5011\uff0c\u60a8\u662f\u5426\u53ef\u4ee5\u4fee\u6539\u95be\u503c\u6216\u7de8\u5beb\u4e0d\u540c\u7684\u898f\u5247\u4f86\u907f\u514d\u5608\u96dc\u7684\u8b66\u5831\uff1f\u6240\u6709\u9019\u4e9b\u8b66\u5831\u90fd\u662f\u5fc5\u8981\u7684\u55ce\uff1f \u4f7f\u7528\u53ef\u89c0\u5bdf\u6027\u5de5\u5177\u7684\u201c\u975c\u97f3\u201d\u529f\u80fd\uff0c\u66ab\u6642\u7981\u7528\u76e3\u8996\u60a8\u5728\u7dad\u8b77\u671f\u9593\u95dc\u9589\u7684\u670d\u52d9\u7684\u8b66\u5831\u3002\u5426\u5247\uff0c\u8b66\u5831\u5c07\u89f8\u767c\u90a3\u4e9b\u95dc\u9589\u7684\u670d\u52d9\uff0c\u518d\u6b21\u589e\u52a0\u8b66\u5831\u75b2\u52de\u7684\u98a8\u96aa\u3002 \u9996\u5148\u5617\u8a66\u81ea\u6211\u4fee\u5fa9\uff1a\u5982\u679c\u6709\u4e00\u7d44\u56fa\u5b9a\u7684\u6307\u4ee4\u53ef\u4ee5\u4fee\u5fa9\u8b66\u5831\uff0c\u8acb\u8003\u616e\u81ea\u52d5\u57f7\u884c\u5b83\u5011\u3002\u914d\u7f6e\u8b66\u5831\u7cfb\u7d71\uff0c\u4ee5\u4fbf\u5982\u679c\u5b83\u7b2c\u4e00\u6b21\u6aa2\u6e2c\u5230\u554f\u984c\uff0c\u5b83\u6703\u57f7\u884c\u81ea\u52d5\u201c\u4fee\u5fa9\u201d\u8173\u672c\uff0c\u800c\u4e0d\u662f\u89f8\u767c\u8b66\u5831\u3002\u53ea\u6709\u5728\u7b2c\u4e8c\u6b21\u6aa2\u6e2c\u5230\u554f\u984c\u6642\u624d\u6703\u89f8\u767c\u5be6\u969b\u8b66\u5831\uff0c\u4ee5\u9632\u81ea\u52d5\u8173\u672c\u7121\u6cd5\u4fee\u5fa9\u554f\u984c\u7684\u539f\u56e0\u3002 \u5305\u62ec\u5b63\u7bc0\u6027\u5206\u6790\uff1a\u4e0d\u50c5\u70ba\u7576\u524d\u7cfb\u7d71\u72c0\u614b\u7de8\u5beb\u8b66\u5831\u898f\u5247\uff0c\u9084\u53ef\u4ee5\u627e\u5230\u898f\u5f8b\u6027\uff0c\u5373\u6578\u64da\u4e2d\u7684\u6a21\u5f0f\u5728\u4e00\u6bb5\u6642\u9593\u5f8c\u958b\u59cb\u91cd\u8907\u3002\u60a8\u901a\u5e38\u53ef\u4ee5\u901a\u904e\u67e5\u770b\u5100\u8868\u677f\u4e2d\u7684\u5716\u8868\u4f86\u8b58\u5225\u6b64\u985e\u6a21\u5f0f\u3002\u63a5\u4e0b\u4f86\uff0c\u60a8\u53ef\u4ee5\u7de8\u5beb\u8b66\u5831\u898f\u5247\uff0c\u5c07\u7576\u524d\u6578\u64da\u8207\u6a21\u5f0f\u7684\u57fa\u7dda\u9032\u884c\u6bd4\u8f03\uff0c\u4ee5\u78ba\u5b9a\u662f\u5426\u6709\u554f\u984c\u3002 \u4f8b\u5982\uff0c\u7db2\u7d61\u6d41\u91cf\u901a\u5e38\u662f\u5b63\u7bc0\u6027\u7684\uff0c\u56e0\u70ba\u60a8\u53ef\u80fd\u6703\u767c\u73fe\u60a8\u7684\u7db2\u7ad9\u6216\u670d\u52d9\u5728\u5de5\u4f5c\u65e5\u665a\u4e0a\u7372\u5f97\u66f4\u591a\u6d41\u91cf\uff0c\u751a\u81f3\u5728\u5468\u672b\u7372\u5f97\u66f4\u591a\u6d41\u91cf\u3002\u7de8\u5beb\u8b66\u5831\u898f\u5247\uff0c\u5c07\u60a8\u7684\u8acb\u6c42\u7387\u8207\u524d\u4e00\u5468\u6216\u524d\u5e7e\u500b\u6708\u7684\u7387\u9032\u884c\u6bd4\u8f03\u3002\u60a8\u53ef\u4ee5\u5f9e\u8acb\u6c42\u7387\u589e\u91cf\u7684\u7a81\u7136\u4e0b\u964d\u4e2d\u5224\u65b7\u51fa\u554f\u984c\u6240\u5728\u3002 \u7279\u5b9a\u65bc\u4e0a\u4e0b\u6587\u7684\u53ef\u89c0\u5bdf\u6027\u63d0\u793a \u00b6 \u8b93\u6211\u5011\u770b\u4e00\u4e0b\u69cb\u5efa\u8b66\u5831\u898f\u5247\u548c\u63d0\u9ad8\u7e3d\u9ad4\u53ef\u89c0\u5bdf\u6027\u7684\u6280\u5de7\uff0c\u6309\u6574\u500b\u7cfb\u7d71\u5806\u68e7\u4e2d\u7684\u4e0d\u5b9a\u5206\u5c64\u4f86\u5206\u985e\u3002 Application Frontend Server Service Network Security \u6838\u5fc3\u601d\u60f3\u662f\u5c07\u6aa2\u6e2c\u6dfb\u52a0\u5230\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u4e2d\uff0c\u9019\u6703\u516c\u958b\u7279\u5b9a\u65bc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u6307\u6a19\u3002\u9019\u4e5f\u610f\u5473\u8457\u7814\u7a76\uff08\u548c\u4f7f\u7528\uff09APM \u5de5\u5177\uff08\u61c9\u7528\u7a0b\u5e8f\u6027\u80fd\u76e3\u63a7\uff09\uff0c\u9019\u4e9b\u5de5\u5177\u53ef\u4ee5\u5206\u6790\u60a8\u7684\u4ee3\u78bc\u4e26\u81ea\u52d5\u5c07\u6aa2\u6e2c\u6dfb\u52a0\u5230\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4e2d\uff0c\u6355\u7372\u901a\u7528\u7684\u6771\u897f\uff0c\u4f8b\u5982\u8acb\u6c42\u7387\u6216\u5783\u573e\u6536\u96c6\u9031\u671f\u3002 \u5982\u4e0a\u6240\u8ff0\uff0c\u5728\u6aa2\u6e2c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u8acb\u8003\u616e\u60a8\u7684\u696d\u52d9\u3002\u4f8b\u5982\uff0c\u8a08\u7b97\u4e00\u500b\u529f\u80fd\u88ab\u4f7f\u7528\u7684\u6b21\u6578\u3002\u4f46\u4e5f\u6709\u5927\u591a\u6578\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u7684\u901a\u7528\u529f\u80fd\uff0c\u4f8b\u5982\u767b\u9304\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u8ddf\u8e2a\u6210\u529f\u767b\u9304\u7684\u6578\u91cf\uff0c\u5f9e\u4e2d\u53ef\u4ee5\u8a08\u7b97\u6bcf\u65e5\u6216\u6bcf\u6708\u7684\u6d3b\u8e8d\u7528\u6236\u3002 \u60a8\u9084\u61c9\u8a72\u5728\u53ef\u89c0\u5bdf\u6027\u5806\u68e7\u4e2d\u5305\u542b\u69cb\u5efa\u548c\u90e8\u7f72 (CI/CD) \u4e8b\u4ef6\u3002\u69cb\u5efa\u6307\u793a\u6bcf\u500b\u7248\u672c\u7684\u90e8\u7f72\u4f55\u6642\u958b\u59cb\u548c\u7d50\u675f\u7684\u6307\u6a19\uff0c\u4ee5\u53ca\u90e8\u7f72\u76ee\u6a19\uff08\u74b0\u5883\uff09\u3002\u4f7f\u7528\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u5de5\u5177\uff0c\u60a8\u53ef\u4ee5\u5c07\u90e8\u7f72\u8207\u5176\u4ed6\u4e8b\u4ef6\u76f8\u95dc\u806f\uff0c\u4f8b\u5982\u6aa2\u6e2c\u5230\u5728\u67d0\u500b\u90e8\u7f72\u4e4b\u5f8c\uff0cAPI \u6545\u969c\u7387\u958b\u59cb\u986f\u8457\u589e\u9577\u3002 \u6dfb\u52a0\u6307\u793a\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u5065\u5eb7\u7684 /health API \u7aef\u9ede\uff0c\u4e26\u4f7f\u7528\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u6293\u53d6\u5b83\u5011\u7684\u8f38\u51fa\u3002\u95dc\u65bc\u5065\u5eb7\u662f\u5426\u61c9\u8a72\u5c40\u9650\u65bc\u63d0\u4f9b\u5065\u5eb7\u7aef\u9ede\u7684\u7d44\u4ef6\uff0c\u6216\u8005\u5b83\u662f\u5426\u61c9\u8a72\u5305\u62ec\u5176\u4ed6\u4f9d\u8cf4\u9805\uff0c\u6709\u4e0d\u540c\u7684\u7406\u5ff5\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7121\u6cd5\u8a2a\u554f\u5e95\u5c64\u6578\u64da\u5eab\u670d\u52d9\uff0cWeb \u61c9\u7528\u7a0b\u5e8f\u7684 /health \u7aef\u9ede\u662f\u5426\u4e5f\u61c9\u8a72\u8fd4\u56de\u72c0\u614b\u78bc 503\uff1f\u5728\u201c\u7d93\u5178\u201d\u7684\u975e\u5206\u4f48\u5f0f\u61c9\u7528\u7a0b\u5e8f\u4e2d\uff0c\u9019\u5c07\u662f\u9810\u671f\u7684\u884c\u70ba\u3002\u4f46\u5728\u5206\u4f48\u5f0f\u74b0\u5883\u4e2d\uff0c\u4f8b\u5982\u57fa\u65bc Kubernetes \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u60a8\u9700\u8981\u5206\u96e2\u95dc\u6ce8\u9ede\u3002\u6709\u5e7e\u7a2e\u985e\u578b\u7684\u5065\u5eb7\u6aa2\u67e5\uff08 liveness \u3001 readiness \u3001 startup \uff09\uff0c\u60a8\u901a\u5e38\u6703\u5c07\u5065\u5eb7\u6aa2\u67e5\u9650\u5236\u5728\u7d44\u4ef6\u672c\u8eab\uff0c\u4ee5\u907f\u514d\u7d1a\u806f\u932f\u8aa4\u3002\u9084\u8981\u78ba\u4fdd\u5065\u5eb7\u7aef\u9ede\u4e0d\u53ef\u516c\u958b\u8a2a\u554f\uff0c\u4ee5\u907f\u514d\u6d29\u9732\u79c1\u4eba\u4fe1\u606f\u3002 \u8abf\u8a66\u554f\u984c\u7684\u53e6\u4e00\u500b\u5f88\u597d\u7684\u4fe1\u606f\u4f86\u6e90\u662f\u65e5\u8a8c\u8a18\u9304\u3002\u6211\u5efa\u8b70\u60a8\u4f7f\u7528\u7d50\u69cb\u5316\u65e5\u8a8c\uff0c\u4f8b\u5982\u7de8\u78bc\u70ba JSON\u3002\u4ed4\u7d30\u8003\u616e\u4f60\u5728\u54ea\u88e1\u653e\u7f6e log() \u8abf\u7528\u2014\u2014\u65e5\u8a8c\u8abf\u7528\u61c9\u8a72\u53ef\u4ee5\u5e6b\u52a9\u4f60\u4ee5\u5f8c\u8a3a\u65b7\u554f\u984c\uff01 \u524d\u7aef\u76e3\u63a7\u662f\u6307\u76e3\u63a7 GUI \u4e2d\u767c\u751f\u7684\u4e8b\u60c5\uff08\u4f8b\u5982\u700f\u89bd\u5668\u3001\u672c\u6a5f/\u684c\u9762\u6216\u667a\u80fd\u624b\u6a5f\u61c9\u7528\u7a0b\u5e8f\uff09\u3002\u524d\u7aef\u76e3\u63a7\u7d93\u5e38\u88ab\u907a\u6f0f\uff08\u5c31\u50cf\u4e00\u500b\u76f2\u9ede\uff09\uff0c\u5c24\u5176\u662f\u7576\u5be6\u65bd\u76e3\u63a7\u7684\u4eba\u66f4\u591a\u5730\u9762\u5411\u64cd\u4f5c\u6216\u5f8c\u7aef\u6642\u3002 \u201c\u597d\u7684\u201d UI \u7684\u57fa\u672c\u7406\u5ff5\uff08\u5f9e\u7d14\u6280\u8853\u7684\u89d2\u5ea6\u4f86\u770b\uff0c\u5ffd\u7565 UX \u65b9\u9762\uff09\u662f\uff1a\u5143\u7d20\u5fc5\u9808\u5feb\u901f\u52a0\u8f09\uff01\u53cd\u61c9\u9072\u920d\u3001\u6eef\u5f8c\u7684 UI \u662f\u4e00\u500b\u5de8\u5927\u7684\u4ea4\u6613\u7834\u58de\u8005\u3002\u9019\u5c31\u662f\u70ba\u4ec0\u9ebc\u5c07\u53ef\u89c0\u5bdf\u6027\u61c9\u7528\u65bc\u60a8\u7684 UI \u5f88\u91cd\u8981\u7684\u539f\u56e0\u3002 \u6709\u5169\u7a2e\u57fa\u672c\u7684\u6e2c\u8a66\u6a21\u5f0f\uff1a \u9ed1\u76d2\u6e2c\u8a66\uff1a\u5f9e\u5916\u90e8\u89c0\u5bdf\u6027\u80fd\u554f\u984c\uff0c\u5ffd\u7565\u5176\u4ee3\u78bc\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u7684\u61c9\u7528\u662f\u7db2\u7ad9/\u7db2\u7d61\u61c9\u7528\uff0c\u8acb\u4f7f\u7528\u670d\u52d9\uff08\u5982 Webpagetest\uff09\u4f86\u67e5\u8a62\u60a8\u7684\u7db2\u7ad9\uff0c\u6e2c\u91cf\u97ff\u61c9\u6642\u9593\u3002 \u767d\u76d2\u6e2c\u8a66\uff1a\u60a8\u64f4\u5c55\u81ea\u5df1\u7684\u4ee3\u78bc\u4ee5\u5305\u62ec\u6027\u80fd\u6e2c\u91cf\uff0c\u4e26\u78ba\u4fdd\u5c07\u5b83\u5011\u63d0\u4ea4\u5230\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u3002 \u60a8\u61c9\u8a72\u66f4\u559c\u6b61\u767d\u76d2\u6e2c\u8a66\u800c\u4e0d\u662f\u9ed1\u76d2\u6e2c\u8a66\u3002\u4f7f\u7528\u73fe\u6210\u7684\u7d44\u4ef6\u4f86\u7c21\u5316\u5275\u5efa\u6b64\u985e\u6307\u6a19\u7684\u4efb\u52d9\u662f\u6709\u610f\u7fa9\u7684\u2014\u2014\u4f46\u60a8\u5fc5\u9808\u7814\u7a76\u4f7f\u7528\u54ea\u4e00\u500b\uff0c\u56e0\u70ba\u6bcf\u7a2e\u524d\u7aef\u6280\u8853\u90fd\u6709\u8a31\u591a\u5c08\u9580\u7684\u89e3\u6c7a\u65b9\u6848\u3002 \u89c0\u5bdf\u4f60\u7684\u57fa\u790e\u8a2d\u65bd/\u670d\u52d9\u5668\u662f\u5be6\u73fe\u826f\u597d\u53ef\u89c0\u5bdf\u6027\u7684\u5fc5\u8981\u6b65\u9a5f\uff0c\u5373\u4f7f\u5b83\u4e0d\u662f\u4f60\u61c9\u8a72\u95dc\u6ce8\u7684\u7b2c\u4e00\u4ef6\u4e8b\u3002\u64cd\u4f5c\u7cfb\u7d71\u7d1a\u5225\u7684\u6307\u6a19\uff0c\u4f8b\u5982 CPU\u3001\u5167\u5b58\u3001\u78c1\u76e4\u3001\u7db2\u7d61\u4f7f\u7528\u60c5\u6cc1\uff0c\u5c0d\u65bc\u8a3a\u65b7\u554f\u984c\u7684\u539f\u56e0\u5f88\u6709\u7528\u3002\u4f46\u662f\uff0c\u8acb\u8a18\u4f4f\uff0c\u6536\u96c6\u6307\u6a19\u6578\u64da\u4e26\u4e0d\u610f\u5473\u8457\u60a8\u61c9\u8a72\u5275\u5efa\u8b66\u5831\u898f\u5247\u3002\u70ba\u64cd\u4f5c\u7cfb\u7d71\u7d1a\u5225\u7684\u6307\u6a19\u8a2d\u7f6e\u8b66\u5831\u901a\u5e38\u6c92\u6709\u610f\u7fa9\uff08\u9664\u975e\u60a8\u6709\u5145\u5206\u7684\u7406\u7531\uff09\uff0c\u56e0\u70ba\u5b83\u5011\u5f88\u5608\u96dc\uff08\u7522\u751f\u8a31\u591a\u8aa4\u5831\u8b66\u5831\uff09\uff0c\u4e26\u4e14\u8207\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7121\u95dc\u3002 \u7531\u65bc\u9b54\u9b3c\u5728\u7d30\u7bc0\u4e2d\uff08\u4e00\u5982\u65e2\u5f80\uff09\uff0c\u9019\u88e1\u6709\u4e00\u4e9b\u5efa\u8b70\uff1a CPU \u6307\u6a19\uff1a\u8981\u7372\u5f97\u6b63\u78ba\u7684 CPU \u4f7f\u7528\u7387\uff0c\u7e3d\u7d50\u7528\u6236\u3001\u7cfb\u7d71\u3001niced \u9032\u7a0b (ni)\u3001\u786c\u4ef6\u4e2d\u65b7 (hi) \u548c\u8edf\u4ef6\u4e2d\u65b7 (si) \u4f7f\u7528\u7387\u3002 \u5c0d\u201c\u7cfb\u7d71\u8ca0\u8f09\u201d\u7684\u8b66\u5831\u975e\u5e38\u8b39\u614e\uff08\u8acb\u53c3\u95b1 \u6b64\u8655 \uff09\u3002\u6709\u8a31\u591a\u7cfb\u7d71\u793a\u4f8b\u7684\u6bcf\u6838\u8ca0\u8f09\u9060\u9ad8\u65bc 1\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u4e26\u4e14\u97ff\u61c9\u8fc5\u901f\u3002\u5982\u679c\u7528\u6236\u6c92\u6709\u8a3b\u610f\u5230\u554f\u984c\uff0c\u5247\u7121\u9700\u4fee\u5fa9\uff01 \u5167\u5b58 (RAM) \u6307\u6a19\uff1a\u901a\u904e\u532f\u7e3d shared+cached+buffered \u4f86\u8a08\u7b97\u5be6\u969b\u4f7f\u7528\u7684\u5167\u5b58 \u7de9\u885d\u5340\u5b58\u5132\u6700\u8fd1\u8a2a\u554f\u7684\u78c1\u76e4\u5340\u57df \u7de9\u5b58\u7684\u5de5\u4f5c\u65b9\u5f0f\u985e\u4f3c\u65bc\u7de9\u885d\u5340\uff0c\u4f46\u7528\u65bc\u6700\u8fd1\u8a2a\u554f\u7684\u6587\u4ef6\u7684\u5167\u5bb9\u3002 \u7de9\u885d\u5340/\u9ad8\u901f\u7de9\u5b58\u4f7f\u7528\u7684\u5167\u5b58\u5728\u6280\u8853\u4e0a\u53ef\u4f9b\u4efb\u4f55\u9700\u8981\u5167\u5b58\u7684\u9032\u7a0b\u4f7f\u7528\u3002 Linux CLI \u5de5\u5177 free \u7684\u8f38\u51fa\u5728\u7b2c\u4e8c\u884c\u986f\u793a\u4e86\u6b63\u78ba\u7684\u5167\u5b58\u4f7f\u7528\u60c5\u6cc1\uff08\u4ee5\u201c-/+ buffers/cache\u201d\u958b\u982d\uff09\uff0c\u9019\u8aaa\u660e\u7de9\u885d\u5340\u548c\u7de9\u5b58\u6d88\u8017\u7684\u5167\u5b58\u5be6\u969b\u4e0a\u53ef\u4ee5\u88ab\u5176\u4ed6\u61c9\u7528\u7a0b\u5e8f\u5728\u4efb\u4f55\u6642\u5019\u3002 \u60a8\u9084\u61c9\u8a72\u8003\u616e\u76e3\u8996\u5167\u5b58\u4e0d\u8db3\u932f\u8aa4\uff0c\u9019\u4e9b\u932f\u8aa4\u662f\u5728\u9032\u7a0b\u56e0\u5167\u5b58\u4e0d\u8db3\u800c\u5fc5\u9808\u7d42\u6b62\u6642\u5275\u5efa\u7684\u3002\u5728\u4e92\u806f\u7db2\u4e0a\u641c\u7d22\u201cOOMKiller\u201d\u4ee5\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\u3002 \u78c1\u76e4\u6307\u6a19\uff1a \u60a8\u901a\u5e38\u9700\u8981\u8f03\u4f4e\u7684 iowait \u503c\uff0c\u56e0\u70ba\u5b83\u8868\u793a CPU \u7531\u65bc\u5728\u78c1\u76e4\u4e0a\u7b49\u5f85\u5b8c\u6210\u64cd\u4f5c\u800c\u8655\u65bc\u7a7a\u9592\u72c0\u614b\u7684\u6642\u9593\u91cf\u3002 \u76e3\u63a7\u78c1\u76e4\u7684 IOPS \u4e5f\u5f88\u6709\u610f\u7fa9\uff0c\u4f46\u60a8\u9700\u8981\u9996\u5148\u4e86\u89e3\u4ec0\u9ebc\u662f\u597d\u7684\u57fa\u7dda\uff0c\u7136\u5f8c\u8b58\u5225\u7a81\u7136\u4e0b\u964d\uff08\u8207\u8a72\u57fa\u7dda\u76f8\u6bd4\uff09\u3002 \u60a8\u53ef\u80fd\u6b63\u5728\u4f7f\u7528\u4e0d\u540c\u7a2e\u985e\u7684\u670d\u52d9\uff0c\u60a8\u61c9\u8a72\u70ba\u6b64\u6536\u96c6\u6307\u6a19\u3002\u9019\u88e1\u6709\u4e00\u4e9b\u63d0\u793a\uff1a Web \u670d\u52d9\u5668\u6307\u6a19\uff1a\u9664\u4e86\u901a\u5e38\u7684\u5acc\u7591\u4eba\uff08RED -> \u8acb\u6c42/\u79d2\u3001\u8acb\u6c42\u6301\u7e8c\u6642\u9593\u3001HTTP \u97ff\u61c9\u4ee3\u78bc\uff09\u4e4b\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u6e2c\u91cf\u4e26\u767c\u9023\u63a5\u6578\u3002 \u6578\u64da\u5eab\u670d\u52d9\u5668\u6307\u6a19\uff1a\u4e26\u767c\u9023\u63a5\u6578\u3001\u6bcf\u79d2\u67e5\u8a62\u6578\u3001\u67e5\u8a62\u6301\u7e8c\u6642\u9593\uff08\u6aa2\u6e2c\u6162\u67e5\u8a62\uff09 \u7de9\u5b58\u670d\u52d9\u5668\u6307\u6a19\uff1a\u9a45\u9010\u9805\u76ee\u7684\u6578\u91cf\uff0c\u4ee5\u53ca\u201c\u547d\u4e2d/\u672a\u547d\u4e2d\u7387\u201d\uff08\u4e5f\u7a31\u70ba\u201c\u7de9\u5b58\u547d\u4e2d\u7387\u201d\uff09\u3002 Evicted items\uff1a\u6578\u5b57\u5927\u8868\u793a\u5206\u914d\u7d66\u7de9\u5b58\u670d\u52d9\u5668\u7684\u5167\u5b58\u592a\u5c11 \u547d\u4e2d/\u672a\u547d\u4e2d\u7387\uff1a\u9019\u500b\u6578\u5b57\u8d8a\u4f4e\uff0c\u7de9\u5b58\u6a5f\u5236\u8d8a\u5dee \u5fc3\u8df3\u76e3\u63a7\uff1a\u4e5f\u7a31\u70ba\u201c\u6b7b\u4eba\u958b\u95dc\u201d\u6216\u201ccron\u4f5c\u696d\u76e3\u63a7\u201d\uff08\u4f7f\u7528\u9019\u4e9b\u8853\u8a9e\u641c\u7d22\u4e92\u806f\u7db2\uff0c\u60a8\u6703\u767c\u73fe\u5f88\u591a\u63d0\u4f9b\u5546\uff09\u6703\u6aa2\u6e2c\u5230\u6c92\u6709\u5fc3\u8df3\u4fe1\u865f\u7136\u5f8c\u901a\u77e5\u60a8\uff01\u9019\u5c0d\u65bc\u76e3\u63a7\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u672c\u8eab\u5f88\u6709\u7528\u3002 \u8003\u616e\u76e3\u63a7\u60a8\u4f7f\u7528\u7684\u4efb\u4f55\u5916\u90e8\u670d\u52d9\uff0c\u4f8b\u5982CDN \u670d\u52d9\u5668 - \u5728\u9019\u88e1\u60a8\u53ef\u4ee5\u76e3\u63a7\u5b83\u5011\u7684\u547d\u4e2d/\u672a\u547d\u4e2d\u7387\u6216\u5ef6\u9072\uff0c\u6216 CDN \u63d0\u4f9b\u7684\u4efb\u4f55\u6307\u6a19\u3002 \u7db2\u7d61\u662f\u4efb\u4f55\u8edf\u4ef6\u61c9\u7528\u7a0b\u5e8f\u7684\u57fa\u672c\u57fa\u790e\u4e4b\u4e00\u3002\u5982\u679c\u60a8\u7684\u7db2\u7d61\u53ea\u6709 99.9% \u7684\u53ef\u7528\u6027\uff0c\u90a3\u9ebc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4e0d\u53ef\u80fd\u6709\u6bd4\u9019\u66f4\u9ad8\u7684\u53ef\u7528\u6027\u3002 \u8a31\u591a\u8def\u7531\u5668\u548c\u5176\u4ed6\u7db2\u7d61\u786c\u4ef6\u5be6\u73fe\u4e86 SNMP \u5354\u8b70\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u8a72\u5354\u8b70\u5f9e\u4e2d\u67e5\u8a62\u4fe1\u606f\u3002\u8981\u76e3\u63a7\u7684\u5177\u9ad4 OID / \u503c\u5728\u6bcf\u500b\u8a2d\u5099\u4e0a\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u60a8\u61c9\u8a72\u76e3\u63a7\u7684\u4e00\u822c\u6307\u6a19\u662f\uff1a\u541e\u5410\u91cf\u3001\u5ef6\u9072\uff08\u548c\u5ef6\u9072\u4e2d\u7684\u6296\u52d5\uff09\u3001rx/tx \u932f\u8aa4/\u4e1f\u68c4\u3001CRC \u932f\u8aa4\u3001\u9023\u63a5\u932f\u8aa4\u548c\u5404\u7a2e\u5176\u4ed6\u932f\u8aa4\u3002 \u60a8\u9084\u53ef\u4ee5\u8ddf\u8e2a\u8a2d\u5099\u914d\u7f6e\u66f4\u6539\uff0c\u4f8b\u5982\u4f7f\u7528 Rancid \u7b49\u5de5\u5177\uff0c\u5b83\u6703\u5b9a\u671f\u5f9e\u60a8\u7684\u8def\u7531\u5668\uff08\u6216\u5176\u4ed6\u7db2\u7d61\u8a2d\u5099\uff09\u4e0b\u8f09\u914d\u7f6e\uff0c\u5c07\u5176\u8207\u524d\u4e00\u500b\u9032\u884c\u6bd4\u8f03\uff0c\u4e26\u5728\u914d\u7f6e\u767c\u751f\u66f4\u6539\u6642\u901a\u77e5\u60a8\u3002 \u61c9\u7528\u7a0b\u5e8f\u5b89\u5168\u662f\u4e00\u500b\u975e\u5e38\u6df1\u5967\u7684\u8a71\u984c\uff0c\u60a8\u9700\u8981\u5c08\u9580\u7684\u5c08\u5bb6\u4f86\u89e3\u6c7a\u3002\u56e0\u6b64\uff0c\u4ee5\u4e0b\u63d0\u793a\u53ea\u662f\u4e00\u500b\u8d77\u9ede\uff01 \u4f7f\u7528\u8af8\u5982 auditd \u4e4b\u985e\u7684 Linux \u5de5\u5177 \u5141\u8a31\u60a8\u8a18\u9304\u6d3b\u52d5\uff0c\u4f8b\u5982\uff1a \u6240\u6709 sudo \u57f7\u884c\uff0c\u57f7\u884c\u7684\u547d\u4ee4\uff0c\u4ee5\u53ca\u57f7\u884c\u8005 \u6587\u4ef6\u8a2a\u554f\u6216\u5c0d\u7279\u5b9a\u6587\u4ef6\u7684\u66f4\u6539\u3001\u4f55\u6642\u4ee5\u53ca\u7531\u8ab0 \u7528\u6236\u8eab\u4efd\u9a57\u8b49\u5617\u8a66\u548c\u5931\u6557 \u5728\u96f2\u539f\u751f\u751f\u614b\u7cfb\u7d71\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Falco \u4e4b\u985e\u7684\u6771\u897f\u800c\u4e0d\u662f auditd \u4f7f\u7528\u4e3b\u6a5f\u5165\u4fb5\u6aa2\u6e2c\u7cfb\u7d71\uff0c\u4f8b\u5982 wazuh \u5b9a\u671f\u6383\u63cf\u60a8\u7684\u90e8\u7f72\u662f\u5426\u5b58\u5728\u5b89\u5168\u554f\u984c\uff0c\u4f8b\u5982\u4f7f\u7528 OWASP Zed \u653b\u64ca\u4ee3\u7406 \u4e8b\u4ef6\u97ff\u61c9\u7ba1\u7406 (Incident) \u00b6 \u5728\u53ef\u89c0\u5bdf\u6027\u4e16\u754c\u4e2d\uff0c\u4e8b\u4ef6\uff08\u97ff\u61c9\uff09\u7ba1\u7406\u662f\u6307\u4e00\u7d44\u8655\u7406\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u6aa2\u6e2c\u5230\u7684\u554f\u984c\uff08\u4f8b\u5982\u89f8\u767c\u7684\u8b66\u5831\uff09\u7684\u904e\u7a0b\u3002\u6709\u5e7e\u500b\u6846\u67b6\uff0c\u5176\u4e2d\u6700\u6d41\u884c\u7684\u4e00\u500b\u4f86\u81ea ITIL\uff0c\u5b83\u6709\u4e00\u500b\u6b63\u5f0f\u5b9a\u7fa9\u7684 9 \u6b65\u8a08\u5283\u3002\u5728\u5be6\u8e10\u4e2d\uff0c\u5927\u591a\u6578\u7d44\u7e54\u4e0d\u9700\u8981\u5982\u6b64\u6b63\u5f0f\u3002\u50cf\u4e0b\u9762\u9019\u6a23\u7684\u5e8f\u5217\u5df2\u7d93\u8db3\u5920\u597d\u4e86\uff1a \u8b58\u5225\u4e8b\u4ef6\uff1a\u901a\u5e38\u7531\u76e3\u63a7\u7cfb\u7d71\u5b8c\u6210\uff0c \u8a18\u9304\u4e8b\u4ef6\uff0c\u4f8b\u5982\u901a\u904e\u8b93\u76e3\u63a7\u7cfb\u7d71\u5728\u67d0\u4e9b\u5de5\u55ae\u7ba1\u7406\u7cfb\u7d71\u4e2d\u81ea\u52d5\u6253\u958b\u4e8b\u4ef6\u5de5\u55ae\uff0c\u751a\u81f3\u53ef\u80fd\u662f\u5c08\u9580\u91dd\u5c0d\u6b64\u985e\u60c5\u6cc1\u7684\u4e8b\u4ef6\u7ba1\u7406\u7cfb\u7d71\uff0c\u4f8b\u5982 Opsgenie\uff0c \u8a3a\u65b7\uff1a\u5c0d\u5176\u9032\u884c\u5206\u985e\uff0c\u627e\u5230\u53ef\u80fd\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u89e3\u6c7a\u4e8b\u4ef6\uff0c\u4e26\u66f4\u65b0\u6216\u95dc\u9589\u76f8\u61c9\u7684\u5de5\u55ae\uff0c \u9810\u9632\uff1a\u4e00\u65e6\u89e3\u6c7a\uff0c\u5c0b\u627e\u88dc\u6551\u63aa\u65bd\uff0c\u4ee5\u907f\u514d\u554f\u984c\u5728\u672a\u4f86\u4e0d\u65b7\u91cd\u8907\u3002\u9019\u53ef\u4ee5\u5305\u62ec\u5beb\u4e00\u500b\u4e8b\u5f8c\u5206\u6790\u3002 \u6b64\u8655 \u63d0\u4f9b\u4e86\u6709\u95dc\u4e8b\u4ef6\u7ba1\u7406\u7684\u66f4\u591a\u4fe1\u606f\u7684\u826f\u597d\u4f86\u6e90\u3002 \u7d50\u8ad6 \u00b6 \u7372\u5f97\u826f\u597d\u7684\u53ef\u89c0\u5bdf\u6027\u5177\u6709\u6311\u6230\u6027\u3002\u60a8\u9700\u8981\u5f9e\u696d\u52d9/\u6700\u7d42\u7528\u6236\u548c\u6280\u8853\u89d2\u5ea6\u4f86\u8655\u7406\u5b83\uff0c\u9019\u9700\u8981\u5718\u968a\u5408\u4f5c\u548c\u6642\u9593\u3002\u4e0d\u8981\u671f\u671b\u60a8\u5728\u4e00\u500b\u6708\u6216\u66f4\u77ed\u7684\u6642\u9593\u5167\u5b8c\u6210\u6240\u6709\u8a2d\u7f6e\uff0c\u4f46\u5be6\u969b\u4e0a\u5c07\u53ef\u89c0\u5bdf\u6027\u8003\u616e\u70ba\u4e00\u500b\u6301\u7e8c\u7684\u904e\u7a0b - \u5c31\u50cf\u4fdd\u6301\u7b2c\u4e09\u65b9\u4f9d\u8cf4\u9805\u6700\u65b0\uff0c\u5c0d\u6297\u6280\u8853\u50b5\u52d9\u7b49\u3002\u78ba\u4fdd\u60a8\uff0c\u60a8\u7684\u5718\u968a\uff0c\u4ee5\u53ca\u60a8\u7d44\u7e54\u4e2d\u7684\u5176\u4ed6\u5229\u76ca\u76f8\u95dc\u8005\u8a2d\u7f6e\u6b63\u78ba\u7684\u512a\u5148\u7d1a\u3002\u9996\u5148\u958b\u59cb\u70ba\u696d\u52d9 KPI \u69cb\u5efa\u6307\u6a19\u548c\u8b66\u5831\uff0c\u7136\u5f8c\u7e7c\u7e8c\u69cb\u5efa\u5c0d\u6700\u7d42\u7528\u6236\uff08\u670d\u52d9\u5668\u7b49\uff09\u4e0d\u53ef\u898b\u7684\u4e8b\u7269\u7684\u5176\u4ed6\u6280\u8853\u6307\u6a19\u3002 \u60a8\u9084\u61c9\u8a72\u907f\u514d\u6c89\u8ff7\u65bc\u5de5\u5177\uff0c\u4f8b\u5982\u4ee3\u7406\u3001\u5ea6\u91cf\u6578\u64da\u5b58\u5132\u6216\u53ef\u8996\u5316\u7cfb\u7d71\u3002\u4fdd\u8b49\u826f\u597d\u53ef\u89c0\u5bdf\u6027\u7684\u4e0d\u662f\u60a8\u4f7f\u7528\u7684\u5de5\u5177\uff08\u6216\u5de5\u5177\u7684\u6578\u91cf\uff09\u3002\u7576\u7136\uff0c\u60a8\u61c9\u8a72\u5728\u958b\u59cb\u6642\u82b1\u5e7e\u5929\u6642\u9593\u7814\u7a76\u4e0d\u540c\u7684\u66ff\u4ee3\u65b9\u6848\uff08\u53ef\u80fd\u6700\u7d42\u4f7f\u7528 Prometheus\uff09\u3002\u4f46\u662f\u4f60\u61c9\u8a72\u907f\u514d\u4e2d\u9014\u4e0d\u65b7\u5730\u5207\u63db\u5de5\u5177\uff0c\u50c5\u50c5\u56e0\u70ba\u5b83\u5011\u770b\u8d77\u4f86\u5f88\u9583\u4eae\uff0c\u6216\u8005\u6709\u65b0\u7684\u529f\u80fd\u3002\u53ea\u6709\u5728\u7576\u524d\u5de5\u5177\u963b\u7919\u60a8\u5feb\u901f\u5be6\u65bd\u66f4\u6539\u6216\u5de5\u5177\u505c\u6b62\u4f7f\u7528\u6642\uff0c\u60a8\u624d\u61c9\u8a72\u5207\u63db\uff08\u4e26\u63a5\u53d7\u5be6\u65bd\u66f4\u6539\u7684\u52aa\u529b\uff09\u3002","title":"Part 5. Alerts \u6700\u4f73\u5be6\u8e10"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/#alert","text":"\u539f\u6587: Kubernetes Observability \u2013 Part V: alerting best practices \u672c\u6587\u89e3\u91cb\u4e86\u5728\u62bd\u8c61\u7684\u3001\u7368\u7acb\u65bc\u5de5\u5177\u7684\u7d1a\u5225\u4e0a\u7de8\u5beb\u8b66\u5831\u7684\u6700\u4f73\u5be6\u8e10\u3002\u6211\u9032\u5165\u4e86\u6280\u8853\u8b66\u5831\u6a21\u5f0f\uff08\u5305\u62ec RED \u548c USE\uff09\u4ee5\u53ca\u70ba\u4ec0\u9ebc\u5f9e\u696d\u52d9\u89d2\u5ea6\u958b\u59cb\u6703\u66f4\u597d\u3002\u6211\u8a73\u7d30\u4ecb\u7d39\u4e86\u4e00\u822c\u8b66\u5831\u898f\u5247\u8a2d\u8a08\uff0c\u4f8b\u5982\u8b66\u5831\u983b\u7387\u548c\u9069\u7576\u7684\u76ee\u7684\u5730\uff0c\u4e26\u7d66\u51fa\u4e86\u89e3\u6c7a\u61c9\u7528\u7a0b\u5e8f\u4e0d\u540c\u5c64\u4e2d\u53ef\u89c0\u5bdf\u6027\u7684\u5177\u9ad4\u6280\u5de7\uff0c\u4f8b\u5982\u670d\u52d9\u5668\u8207\u670d\u52d9\u8207\u61c9\u7528\u7a0b\u5e8f\u3002\u6211\u9084\u89e3\u91cb\u4e86\u4e8b\u4ef6\u7ba1\u7406\u7684\u57fa\u672c\u6982\u5ff5\uff0c\u4ee5\u53ca\u5728\u751f\u7522\u74b0\u5883\u4e2d\u6e2c\u8a66\u53ef\u89c0\u5bdf\u6027\u5982\u4f55\u5be6\u73fe\u6700\u9ad8\u7d1a\u5225\u7684\u53ef\u89c0\u5bdf\u6027\u3002","title":"Alert \u6700\u4f73\u5be6\u8e10"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/#_1","text":"Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u672c\u53ef\u89c0\u5bdf\u6027\u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u4e2d\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u8ff0\uff0c\u6709\u8a31\u591a\u6280\u8853\u77e5\u8b58\u9700\u8981\u5b78\u7fd2\uff0c\u6211\u5728\u6280\u8853\u8ecc\u9053\u4e2d\u9032\u884c\u4e86\u4ecb\u7d39\u3002\u4f46\u4e5f\u6709\u4f60\u9700\u8981\u7372\u5f97\u7684\u5143\u7d1a\u77e5\u8b58\uff0c\u5b83\u8207\u5de5\u5177\u7121\u95dc\uff0c\u6211\u5c07\u5176\u653e\u5165\u9ad8\u7d1a\u53ef\u89c0\u5bdf\u6027\u8ecc\u9053\u3002\u5177\u9ad4\u7684\u5143\u7d1a\u77e5\u8b58\u9805\u76ee\u4e4b\u4e00\u662f\u5b78\u7fd2\u9ad8\u7d1a\u8b66\u5831\u8a2d\u8a08\u539f\u5247\u2014\u2014\u8a72\u9818\u57df\u7684\u5de5\u4f5c\u4eba\u54e1\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u6536\u96c6\u7684\u539f\u5247\uff0c\u6211\u5011\u5c07\u5728\u672c\u6587\u4e2d\u66f4\u4ed4\u7d30\u5730\u7814\u7a76\u9019\u4e9b\u539f\u5247\u3002 \u672c\u6587\u7684\u76ee\u7684\u662f\u5e6b\u52a9\u60a8\u958b\u59cb\u7de8\u5beb\u60a8\u7684\u7b2c\u4e00\u500b\u8b66\u5831\u898f\u5247\uff0c\u70ba\u60a8\u5e36\u4f86\u6700\u5927\u7684\u597d\u8655\u3002\u6c92\u6709\u9019\u6a23\u7684\u6307\u5c0e\uff0c\u53ea\u6709\u5927\u91cf\u7684\u6280\u8853\u77e5\u8b58\u662f\u6c92\u6709\u7528\u7684\u3002\u60a8\u53ef\u4ee5\u70ba\u5176\u5275\u5efa\u8b66\u5831\u7684\u6307\u6a19\u6578\u64da\u6e90\u592a\u591a\u3002\u60a8\u53ef\u80fd\u6703\u7522\u751f\u975e\u5e38\u5608\u96dc\u7684\u8b66\u5831\u6d2a\u6d41\uff0c\u9019\u4e9b\u5982\u6f6e\u6c34\u822c\u6e67\u4f86\u7684\u8b66\u5831\u6700\u7d42\u90fd\u6703\u88ab\u5ffd\u7565\u3002 \u6b64\u8655\u6db5\u84cb\u7684\u8a31\u591a\u8981\u9ede\u5747\u4f86\u81ea\u300a \u5be6\u7528\u76e3\u63a7 \u300b\u4e00\u66f8\uff082017 \u5e74\u51fa\u7248\uff09\uff0c\u6211\u7d55\u5c0d\u5efa\u8b70\u60a8\u4ed4\u7d30\u95b1\u8b80\u3002\u9019\u672c\u66f8\u88e1\u6240\u7d66\u7684\u5efa\u8b70\u53ef\u80fd\u5df2\u6709\u6578\u5e74\u591a\u7684\u6b77\u53f2\uff0c\u4f46\u5e7e\u4e4e\u6240\u6709\u7684\u5efa\u8b70\u5230\u4e86\u4eca\u5929\u537b\u4ecd\u7136\u9069\u7528\u3002","title":"\u4ecb\u7d39"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/#_2","text":"\u5982\u679c\u4f60\u662f\u4e00\u540d\u5de5\u7a0b\u5e2b\uff0c\u4f60\u5f88\u6709\u53ef\u80fd\u6703\u5f9e\u6280\u8853\u89d2\u5ea6\u4f86\u89e3\u6c7a\u554f\u984c\uff0c\u56e0\u70ba\u90a3\u662f\u4f60\u64c5\u9577\u7684\u548c\u4f60\u6240\u77e5\u9053\u7684\u3002\u60a8\u53ef\u80fd\u6703\u958b\u59cb\u5206\u6790\u60a8\u64c1\u6709\u54ea\u4e9b\u57fa\u790e\u8a2d\u65bd/\u670d\u52d9\u5668\u3001\u5b83\u5011\u904b\u884c\u54ea\u4e9b\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\u7b49\uff09\u3001\u7db2\u7d61\u5982\u4f55\u767c\u63ee\u4f5c\u7528\u4ee5\u53ca\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u80fd\u5b58\u5728\u54ea\u4e9b\u6280\u8853\u554f\u984c\uff08\u4f8b\u5982\u5167\u5b58\u6d88\u8017\u3001\u5783\u573e\u6536\u96c6\u7b49\uff09\u3002 \u5169\u7a2e\u5ee3\u6cdb\u61c9\u7528\u7684\u6280\u8853\u8b66\u5831\u6a21\u5f0f\u662f RED \u548c USE \uff0c\u5982\u4e0b\u6240\u793a\uff1a RED USE RED \u4ee3\u8868\u8acb\u6c42\u7387( R equest Rate)\u3001\u932f\u8aa4\u7387( E rror Rate)\u3001\u8acb\u6c42\u6301\u7e8c\u6642\u9593( D uration of request)\u3002 RED \u6a21\u5f0f\u4e3b\u8981\u9069\u7528\u65bc\u8acb\u6c42\u9a45\u52d5\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u4f8b\u5982\u60a8\u958b\u767c\u7684 Web \u670d\u52d9\u3002\u5c0d\u65bc\u9019\u4e9b\u985e\u578b\u7684\u61c9\u7528\u7a0b\u5e8f\uff0cRED \u53ef\u4ee5\u5e6b\u52a9\u60a8\u9078\u64c7\u73fe\u6709\u7684\u6307\u6a19\u6578\u64da\u4f86\u5275\u5efa\u8b66\u5831\u3002\u4f8b\u5982\uff0c\u60a8\u61c9\u8a72\u4f7f\u7528 HTTP \u53cd\u5411\u4ee3\u7406\uff08\u5982 Nginx\uff09\u63d0\u4f9b\u7684\u773e\u591a\u6307\u6a19\u6578\u64da\u4e2d\u7684\u54ea\u4e00\u500b\u3002\u4f46\u662f RED \u9084\u53ef\u4ee5\u5e6b\u52a9\u60a8\u6c7a\u5b9a\u5982\u4f55\u6aa2\u6e2c\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5373\u60a8\u61c9\u8a72\u5c07\u54ea\u4e9b\u985e\u578b\u7684\u6578\u64da\u516c\u958b\u70ba\u6307\u6a19\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u70ba\u5b83\u5011\u7de8\u5beb\u8b66\u5831\u3002 \u7e3d\u4e4b\uff1a Request rate : \u56de\u7b54\u9019\u500b\u554f\u984c\uff1a\u201c\u6211\u7684\u7cfb\u7d71\u6709\u591a\u5fd9\uff1f\u201d\u3002\u6211\u5011\u53ef\u4ee5\u901a\u904e\u8a08\u7b97\u8acb\u6c42\u7684\u6578\u91cf\uff08\u7531\u8def\u5f91/URL \u5206\u9694\uff09\u4f86\u78ba\u5b9a\uff0c\u7136\u5f8c\u53ef\u89c0\u5bdf\u7cfb\u7d71\uff08\u4f8b\u5982 Prometheus\uff09\u5728\u904b\u884c\u6642\u5c07\u5176\u8f49\u63db\u70ba\u901f\u7387\uff08\u4f8b\u5982 200 requests/second\uff09\u3002 Error rate : \u56de\u7b54\u9019\u500b\u554f\u984c\uff1a\u201c\u8acb\u6c42\u7e3d\u6578\u4e2d\u6709\u591a\u5c11\u662f\u932f\u8aa4\u7684(\u767e\u5206\u6bd4)?\u201d\u3002\u8207 Request rate \u985e\u4f3c\u5730\u8a08\u7b97\u908f\u8f2f\u3002\u60a8\u9084\u53ef\u4ee5\u8003\u616e\u5c0d\u4e0d\u540c\u985e\u578b\u7684\u932f\u8aa4\u9032\u884c\u5206\u985e\uff08\u4f8b\u5982 HTTP \u97ff\u61c9\u4ee3\u78bc 4xx \u8207 5xx\uff09\u3002 Duration of request : \u56de\u7b54\u9019\u500b\u554f\u984c\uff1a\u201c\u6211\u7684\u7cfb\u7d71\u7684\u5ef6\u9072\u5206\u4f48\u60c5\u6cc1\u5982\u4f55\uff1f\u201d\u3002\u60a8\u5e0c\u671b\u5c07\u6b64\u6578\u64da\u4f5c\u70ba\u76f4\u65b9\u5716\uff0c\u800c\u4e0d\u662f\u55ae\u500b\u503c\uff08\u4f8b\u5982\u5e73\u5747\u5ef6\u9072\uff09\uff0c\u56e0\u70ba\u5b83\u5141\u8a31\u60a8\u6aa2\u6e2c\u7570\u5e38\u503c\u3002\u901a\u5e38\uff0c\u60a8\u5c07\u914d\u7f6e\u60a8\u7684 HTTP \u670d\u52d9\u5668\u4ee5\u5728\u5176\u65e5\u8a8c\u4e2d\u5305\u542b\u8acb\u6c42\u6301\u7e8c\u6642\u9593\uff0c\u7136\u5f8c\u4f7f\u7528\u6307\u6a19\u5c0e\u51fa\u5668\u5f9e\u9019\u4e9b\u65e5\u8a8c\u6587\u4ef6\u8a08\u7b97\u76f4\u65b9\u5716\uff08\u8acb\u53c3\u95b1\u6b64\u8655\u7684 Nginx \u6559\u7a0b \u3002 USE \u4ee3\u8868\u5229\u7528\u7387(Utilization)\u3001\u98fd\u548c\u5ea6(Saturation)\u3001\u932f\u8aa4(Errors)\u3002 USE \u4e3b\u8981\u61c9\u7528\u65bc\u57fa\u790e\u8a2d\u65bd\uff0c\u7279\u5225\u662f\u5728\u5f8c\u53f0\u57f7\u884c\u7570\u6b65\u5de5\u4f5c\u7684\u7cfb\u7d71\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u5229\u7528\u7387\u3001\u98fd\u548c\u5ea6\u548c\u932f\u8aa4\u9069\u7528\u65bc\u7cfb\u7d71\u8cc7\u6e90\u3002 Utilization : \u5df2\u4f7f\u7528\u8cc7\u6e90\u7684\u6bd4\u4f8b -> 100% \u5229\u7528\u7387\u610f\u5473\u8457\u7121\u6cd5\u63a5\u53d7\u66f4\u591a\u5de5\u4f5c\u3002\u53ef\u4ee5\u61c9\u7528\u65bc RAM\uff0c\u4e5f\u53ef\u4ee5\u61c9\u7528\u65bc CPU \u8ca0\u8f09\u3002 Saturation : \u8cc7\u6e90\u5177\u6709\u7121\u6cd5\u670d\u52d9\u7684\u984d\u5916\u5de5\u4f5c\u7684\u7a0b\u5ea6\uff0c\u56e0\u6b64\u7d93\u5e38\u6392\u968a\u3002\u53c3\u898b\u4f8b\u5982\u5728\u9019\u91cc\u548c\u9019\u88e1\u53ef\u4ee5\u66f4\u597d\u5730\u7406\u89e3 CPU \u7684\u9019\u4e00\u9ede\u3002 Errors : \u932f\u8aa4\u4e8b\u4ef6\u7684\u8a08\u6578\uff0c\u4f8b\u5982\u8a2d\u5099\u932f\u8aa4\u3002 \u56e0\u70ba\u9b54\u9b3c\u5728\u7d30\u7bc0\u4e2d\uff08\u95dc\u65bc\u5982\u4f55\u6536\u96c6\u9019\u4e9b\u6307\u6a19\uff0c\u4ee5\u53ca\u5982\u4f55\u89e3\u91cb\u5b83\u5011\uff09\uff0c\u6211\u63a8\u85a6\u9019\u7bc7 \u512a\u79c0\u7684\u6587\u7ae0 \u3002 \u4f46\u662f\uff0c\u66f4\u597d\u7684\u65b9\u6cd5\u662f\u5f9e\u6700\u7d42\u7528\u6236\u7684\u89d2\u5ea6\u89e3\u6c7a\u554f\u984c\u3002\u7562\u7adf\uff0c\u60a8\u6b63\u5728\u70ba\u6700\u7d42\u7528\u6236\u69cb\u5efa\u8edf\u4ef6\uff0c\u5982\u679c\u4ed6\u5011\u56e0\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7121\u6cd5\u6b63\u5e38\u904b\u884c\uff08\u826f\u597d\uff09\u800c\u96e2\u958b\uff0c\u90a3\u9ebc\u60a8\u5c31\u6703\u5012\u9589\u3002\u60a8\u7684\u6700\u7d42\u7528\u6236\u4e0d\u77e5\u9053\u70ba\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u63d0\u4f9b\u52d5\u529b\u7684\u670d\u52d9\u5668\u6216\u670d\u52d9\u3002\u5b83\u5011\u50c5\u8207\u67d0\u7a2e\u7528\u6236\u754c\u9762\u4ea4\u4e92\uff0c\u56e0\u6b64\u60a8\u6700\u597d\u958b\u59cb\u69cb\u5efa\u6307\u6a19\uff08\u5e36\u6709\u76f8\u61c9\u7684\u8b66\u5831\uff09\uff0c\u4ee5\u6307\u793a\u8a72\u754c\u9762\u4f55\u6642\u51fa\u73fe\u554f\u984c\u3002 \u50c5\u8003\u616e\u6280\u8853\u65b9\u9762\u6642\uff0c\u53ef\u80fd\u6703\u4ee5\u5169\u7a2e\u4e0d\u540c\u7684\u65b9\u5f0f\u51fa\u932f\uff1a \u4e0d\u77e5\u60c5\u7684\u6280\u8853\u5718\u968a \uff1a\u5982\u4e0a\u5716\u6240\u793a\uff0c\u5c0d\u200b\u200b\u6240\u6709\u55ae\u500b\u7d44\u4ef6\u7684\u76e3\u63a7\u8868\u660e\u4e00\u5207\u6b63\u5e38\uff0c\u4f46\u6700\u7d42\u7528\u6236\u78ba\u5be6\u9047\u5230\u4e86\u554f\u984c\u3002\u5982\u679c\u7f3a\u5c11\u6574\u9ad4\u9858\u666f\u548c\u6700\u7d42\u7528\u6236\u8996\u89d2\uff0c\u4e26\u4e14\u6bcf\u500b\u5718\u968a\u50c5\u91dd\u5c0d\u4ed6\u5011\u64c1\u6709\u7684\u7cfb\u7d71\u90e8\u5206\u5be6\u65bd\u6307\u6a19\u548c\u8b66\u5831\uff0c\u5247\u53ef\u80fd\u6703\u767c\u751f\u9019\u7a2e\u60c5\u6cc1\u3002 \u4e0d\u77e5\u60c5\u7684\u6700\u7d42\u7528\u6236 \uff1a\u9019\u662f\u76f8\u53cd\u7684\u60c5\u6cc1\uff1a\u6700\u7d42\u7528\u6236\u6c92\u6709\u8a3b\u610f\u5230\u4efb\u4f55\u554f\u984c\uff0c\u4f46\u60a8\u7684\u5718\u968a\u6b63\u5728\u6050\u614c\uff0c\u4f8b\u5982\u56e0\u70baCPU\u98fd\u548c\u5ea6\u7a81\u7136\u5f88\u9ad8\u3002\u9019\u901a\u5e38\u662f\u7531\u904e\u65bc\u5608\u96dc\u7684\u8b66\u5831\u5f15\u8d77\u7684\uff0c\u5373\uff0c\u5177\u6709\u6839\u672c\u4e0d\u61c9\u8a72\u6709\u8b66\u5831\u7684\u6280\u8853\u65b9\u9762\u7684\u8b66\u5831\uff0c\u6216\u8005\u56e0\u70ba\u95be\u503c\u9078\u64c7\u4e0d\u7576\u3002 \u81ea\u7136\uff0c\u8a31\u591a\u6280\u8853\u6307\u6a19\u4e5f\u6db5\u84cb\u4e86\u6700\u7d42\u7528\u6236\u7684\u9700\u6c42\uff0c\u4f8b\u5982\u5728\u76e3\u63a7 Web \u61c9\u7528\u7a0b\u5e8f\u7684\u932f\u8aa4\u7387\uff08RED \u4e2d\u7684 E\uff09\u6642\u3002\u4f46\u9b54\u9b3c\u5728\u7d30\u7bc0\u4e2d\uff1a \u793a\u4f8b #1 \uff1a\u6709\u591a\u5c11\u932f\u8aa4\u662f\u6709\u554f\u984c\u7684\u4e26\u4e14\u61c9\u8a72\u89f8\u767c\u8b66\u5831\uff1f\u6240\u6709\u8acb\u6c42\u7684 1%\uff1f 10%\uff1f\u5982\u679c 1% \u5f71\u97ff /register \u7aef\u9ede\u600e\u9ebc\u8fa6\uff1f\u7136\u5f8c\u4f60\u5c31\u5931\u53bb\u4e86 1% \u7684\u6f5b\u5728\u65b0\u5ba2\u6236\uff0c\u4ed6\u5011\u7121\u6cd5\u8a3b\u518a\uff0c\u9019\u6bd4 1% \u5f71\u97ff /generate-pdf-report \u7aef\u9ede\u7684\u60c5\u6cc1\u8981\u7cdf\u7cd5\u5f97\u591a\uff08\u5f9e\u696d\u52d9\u89d2\u5ea6\u4f86\u770b\uff09\u3002 \u793a\u4f8b #2 \uff1a\u60a8\u7684\u7528\u6236\u53ef\u4ee5\u5bb9\u5fcd\u591a\u5c11\u5ef6\u9072\uff1f\u6c92\u6709\u55ae\u4e00\u7c21\u55ae\u7684\u7b54\u6848\uff0c\u5b83\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u53d6\u6c7a\u65bc\u61c9\u7528\u7a0b\u5e8f\uff0c\u60a8\u7684\u95be\u503c\u53ef\u80fd\u5f9e 50 \u6beb\u79d2\u5230\u5e7e\u5206\u9418\u4e0d\u7b49\u3002\u7576\u7136\uff0c\u5c0d\u65bc\u66f4\u9577\u7684\u6301\u7e8c\u6642\u9593\uff0cUI \u5fc5\u9808\u5c07\u9810\u671f\u7684\u5ef6\u9072\u50b3\u9054\u7d66\u60a8\u7684\u7528\u6236\u3002\u5982\u679c\u4e00\u500b\u64cd\u4f5c\uff08\u5f9e\u7528\u6236\u7684\u89d2\u5ea6\uff09\u61c9\u8a72\u662f\u5373\u6642\u7684\uff08\u4f8b\u5982\u9ede\u64ca\u201c\u4fdd\u5b58\u6309\u9215\u201d\uff09\u4f46\u5be6\u969b\u60c5\u5f62\u537b\u4e0d\u662f\u7684\u8a71\uff0c\u7528\u6236\u6703\u8a8d\u70ba\u7cfb\u7d71\u662f\u4e00\u500b\u5931\u6557\u7684\u7cfb\u7d71\uff08\u4e26\u4e14\u53ef\u80fd\u5f88\u5feb\u96e2\u958b\uff09\uff0c\u800c\u4f60\u4f5c\u70ba\u4e00\u500b\u5de5\u7a0b\u5e2b\uff0c\u53ea\u6703\u5c07\u5176\u6b78\u985e\u70ba\u201c\u6709\u9ede\u6162\u201d\u3002 \u9019\u5c31\u662f KPI\uff08\u95dc\u9375\u7e3e\u6548\u6307\u6a19\uff09\u767c\u63ee\u4f5c\u7528\u7684\u5730\u65b9\u3002\u4f8b\u5982\uff0c\u60a8\u61c9\u8a72\u5efa\u7acb\u6307\u6a19\u4f86\u5e6b\u52a9\u60a8\u78ba\u5b9a\u60a8\u7684\u696d\u52d9\u4f5c\u70ba\u4e00\u500b\u6574\u9ad4\u662f\u5728\u589e\u9577\u9084\u662f\u5728\u840e\u7e2e\uff0c\u4f8b\u5982\u901a\u904e\u89c0\u5bdf\u767b\u9304\u6b21\u6578/\u6bcf\u6708\u6d3b\u8e8d\u7528\u6236\u3001\u5ba2\u6236\u7e3d\u6578\u3001\u6536\u5165\u3001\u4ed8\u8cbb\u5ba2\u6236\u767e\u5206\u6bd4\uff08\u5982\u679c\u60a8\u6709\u514d\u8cbb\u5957\u9910\uff09\u3001\u7528\u6236\u56de\u7b54\u7684\u8abf\u67e5\u6578\u64da\u7b49\u3002 \u8981\u4e86\u89e3\u6709\u95dc\u60a8\u696d\u52d9\u7684 KPI \u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u4e0d\u8981\u50cf CTO \u90a3\u6a23\u601d\u8003 - \u50cf\u60a8\u7684 CEO\u3001CFO \u7b49\u90a3\u6a23\u601d\u8003\u3002\u8207\u60a8\u7d44\u7e54\u4e2d\u4e0d\u662f\u5de5\u7a0b\u5e2b\u7684\u4eba\u4ea4\u8ac7\uff0c\u4f8b\u5982\u7522\u54c1\u6240\u6709\u8005\u6216\u5ba2\u6236\u652f\u6301\u3002\u60a8\u4e0d\u50c5\u53ef\u4ee5\u4e86\u89e3\u60a8\u7684\u7528\u6236\u95dc\u5fc3\u4f46\u60a8\u4e0d\u77e5\u9053\u5b58\u5728\u7684\u65b9\u9762\uff0c\u800c\u4e14\u60a8\u9084\u53ef\u4ee5\u653e\u9b06\u4e26\u964d\u4f4e\u4e00\u4e9b\u786c\u6027\u8981\u6c42\u6216\u8b66\u5831\u95be\u503c\uff08\u4f8b\u5982\uff0c\u5728\u69cb\u5efa\u96fb\u5b50\u90f5\u4ef6\u670d\u52d9\u5668\u6642\uff0c\u60a8\u525b\u525b\u4e86\u89e3\u5230\u7528\u6236\u5982\u679c\u8655\u7406\u5916\u767c\u90f5\u4ef6\u6700\u591a\u9700\u8981 10 \u79d2\uff0c\u8acb\u4e0d\u8981\u4ecb\u610f\uff09\u3002\u5beb\u4e0b\u60a8\u7684\u670d\u52d9/\u61c9\u7528\u7a0b\u5e8f\u6240\u505a\u7684\u63cf\u8ff0\uff08\u5305\u62ec\u5176\u529f\u80fd\u548c UI \u6f14\u7df4\uff09\u7136\u5f8c\u5206\u6790\u6b64\u63cf\u8ff0\u4e5f\u5f88\u6709\u5e6b\u52a9\u3002 \u4e00\u65e6\u60a8\u5c0d\u6280\u8853\u548c\u696d\u52d9 KPI \u90fd\u6709\u8b66\u5831\uff0c\u8acb\u5617\u8a66\u5c07\u5b83\u5011\u95dc\u806f\u8d77\u4f86\u3002\u5f37\u76f8\u95dc\u6027\u6709\u6642\u53ef\u80fd\u6709\u52a9\u65bc\u89e3\u91cb KPI \u6307\u6a19\u767c\u751f\u8b8a\u5316\u7684\u539f\u56e0\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6bcf\u6708\u6d3b\u8e8d\u7528\u6236\u8a08\u6578\uff08KPI \u6307\u6a19\uff09\u7a81\u7136\u958b\u59cb\u4e0b\u964d\uff0c\u4e26\u4e14\u60a8\u9084\u767c\u73fe\u5e73\u5747\u670d\u52d9\u97ff\u61c9\u6642\u9593\uff08\u6280\u8853\u6307\u6a19\uff09\u4e5f\u540c\u6642\u958b\u59cb\u5927\u5e45\u589e\u52a0\uff0c\u9019\u53ef\u80fd\u662f\u5c0e\u81f4\u7528\u6236\u96e2\u958b\u3002","title":"\u6280\u8853\u8207\u696d\u52d9\u9a45\u52d5\u7684\u8b66\u5831"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/#_3","text":"\u4e00\u822c\u4f86\u8aaa\uff0c\u5c07\u544a\u8b66\u5206\u70ba\u5169\u500b\u7d1a\u5225\u662f\u4e00\u500b\u597d\u4e3b\u610f\uff1a Critical : \u4f60\u73fe\u5728\u9700\u8981\u505a\u9ede\u4ec0\u9ebc\uff0c\u5426\u5247\u7cfb\u7d71\u53ef\u80fd\u5f88\u5feb\u5c31\u6703\u5d29\u6f70\uff01\u4f8b\u5982\u3002\u56e0\u70ba\u5e7e\u500b\u670d\u52d9\u505c\u6b62\u5de5\u4f5c\u3002 FYI : \u50c5\u4f9b\u53c3\u8003\uff0c\u51fa\u4e86\u9ede\u554f\u984c\uff0c\u4f46\u4e26\u4e0d\u56b4\u91cd\uff0c\u4f8b\u5982\u5099\u4efd\u5931\u6557\uff0c\u6216\u78c1\u76e4\u6162\u6162\u586b\u6eff\u3002 \u5728\u201c\u5be6\u969b\u76e3\u63a7\u201d\u4e00\u66f8\u4e2d\uff0c\u7b2c\u4e8c\u500b\u7d1a\u5225\uff08FYI\uff09\u88ab\u8a8d\u70ba\u53ea\u662f\u4e00\u500b\u6d88\u606f\uff0c\u800c\u4e0d\u662f\u4e00\u500b\u8b66\u5831\u3002\u5c07 FYI \u985e\u578b\u7684\u6d88\u606f\u767c\u9001\u5230\u804a\u5929\u5ba4\u6216\u81ea\u52d5\u751f\u6210 ticket \u5c31\u8db3\u5920\u4e86\u3002\u4f46\u662f\uff0c\u91cd\u8981\u7684\u8b66\u5831\u901a\u77e5\u9700\u8981\u4ee5\u60a8\u9ad8\u5ea6\u78ba\u4fe1\u6709\u4eba\u80af\u5b9a\u6703\u5f88\u5feb\u95b1\u8b80\u5b83\u7684\u65b9\u5f0f\u767c\u9001\uff0c\u4f8b\u5982\u81ea\u52d5\u64a5\u6253\u96fb\u8a71\u6216\u767c\u9001\u77ed\u4fe1\u3002 \u5be6\u7528\u76e3\u63a7 \u63d0\u51fa\u4e86\u5e7e\u500b\u826f\u597d\u8b66\u5831\u8a2d\u8a08\u7684\u901a\u7528\u6280\u5de7\uff1a \u505c\u6b62\u4f7f\u7528\u96fb\u5b50\u90f5\u4ef6\u767c\u9001\u8b66\u5831: \u96fb\u5b50\u90f5\u4ef6\u901a\u5e38\u4e0d\u6703\u559a\u9192\u4efb\u4f55\u4eba\u3002\u77ed\u4fe1\u3001\u5fbe\u4fe1\u6216\u96fb\u8a71\u90fd\u53ef\u4ee5\uff01\u96fb\u5b50\u90f5\u4ef6\u66f4\u9069\u5408\u6d88\u606f\u985e\u578b\u7684\u8b66\u5831\u3002 \u7de8\u5beb\u904b\u884c\u624b\u518a(run book)\uff1a\u70ba\u7279\u5b9a\u670d\u52d9\u7de8\u5beb\u904b\u884c\u624b\u518a\u3002\u5b83\u63cf\u8ff0\u4e86\u9019\u500b\u670d\u52d9\u662f\u4ec0\u9ebc\uff0c\u5b83\u505a\u4ec0\u9ebc\uff0c\u8ab0\u8ca0\u8cac\u5b83\uff0c\u5b83\u6709\u4ec0\u9ebc\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u5b83\u7684\u57fa\u790e\u8a2d\u65bd\u662f\u4ec0\u9ebc\u6a23\u7684\uff0c\u5b83\u767c\u51fa\u4ec0\u9ebc\u6307\u6a19\u548c\u65e5\u8a8c\uff08\u4ee5\u53ca\u5b83\u5011\u7684\u542b\u7fa9\uff09\uff0c\u4ee5\u53ca\u70ba\u4ec0\u9ebc\u8b66\u5831\u8a2d\u7f6e\u5b83\uff08\u4ee5\u53ca\u70ba\u4ec0\u9ebc\uff09\u3002\u5c0d\u65bc\u6bcf\u500b\u8b66\u5831\uff0c\u70ba\u8a72\u670d\u52d9\u7684\u904b\u884c\u624b\u518a\u5275\u5efa\u4e00\u500b\uff08\u53ef\u9ede\u64ca\u7684\uff09\u93c8\u63a5 \u907f\u514d\u5728\u8b66\u5831\u898f\u5247\u5b9a\u7fa9\u4e2d\u4f7f\u7528\u4efb\u610f\u7684\u975c\u614b\u95be\u503c\u3002\u76f8\u53cd\uff0c\u901a\u5e38\u50cf\u589e\u9577\u7387\u9019\u6a23\u7684\u6771\u897f\u66f4\u6709\u8da3\u3002 \u4f8b\u5982\uff1a\u975c\u614b\u8b66\u5831\u898f\u5247\u201c\u50c5\u5269\u9918 10% \u7684\u78c1\u76e4\u7a7a\u9593\u201d\u4e0d\u5982\u201c\u78c1\u76e4\u4f7f\u7528\u7387\u5728\u904e\u53bb 10 \u5206\u9418\u5167\u589e\u9577\u4e86 X%\u201d\u6709\u7528\u3002\u4f7f\u7528\u975c\u614b\u898f\u5247\uff0c\u5982\u679c\u78c1\u76e4\u5f88\u5c0f\u4e26\u4e14\u5728\u77ed\u6642\u9593\u5167\u751f\u6210\u5927\u91cf\u6578\u64da\uff0c\u60a8\u7684\u7cfb\u7d71\u4ecd\u7136\u53ef\u80fd\u5d29\u6f70\u3002\u4f60\u771f\u6b63\u60f3\u8981\u7684\u662f\u5728\u201c\u6b63\u78ba\u7684\u6642\u9593\u201d\u767c\u51fa\u8b66\u544a\uff08\u4f8b\u5982\uff0c\u6709\u5169\u9031\u7684\u8dd1\u9053\uff09\u3002\u975c\u614b\u7684\u201c10%\u201d\u767e\u5206\u6bd4\u503c\u4e0d\u6703\u7d66\u4f60\u9019\u500b\u3002\u76f8\u53cd\uff0c\u60a8\u5fc5\u9808\u6e2c\u91cf\u78c1\u76e4\u586b\u6eff\u7684\u901f\u7387\uff0c\u8a08\u7b97\u5269\u4f59\u5929\u6578\uff08\u8003\u616e\u53ef\u7528\u78c1\u76e4\u7a7a\u9593\uff09\uff0c\u7136\u5f8c\u5728\u5929\u6578\u4f4e\u65bc\u95be\u503c\u6642\u8b66\u544a\u60a8\u3002 \u522a\u9664\u548c\u8abf\u6574\u8b66\u5831\uff0c\u4ee5\u4fbf\u60a8\u6536\u5230\u76e1\u53ef\u80fd\u5c11\u7684\u8b66\u5831\u3002\u9019\u53ef\u4ee5\u6e1b\u5c11\u8b66\u5831\u75b2\u52de\uff0c\u9019\u662f\u7531\u65bc\u8b66\u5831\u592a\u591a\u800c\u958b\u59cb\u5ffd\u7565\u8b66\u5831\u7684\u73fe\u8c61\u3002\u8003\u616e\u5b9a\u671f\u56de\u9867\u60a8\u7684\u8b66\u5831\u6b77\u53f2\u8a18\u9304\uff0c\u4f8b\u5982\u904e\u53bb 30 \u5929\uff1a\u767c\u751f\u4e86\u54ea\u4e9b\u8b66\u5831\uff0c\u5fc5\u9808\u63a1\u53d6\u4ec0\u9ebc\u63aa\u65bd\u4f86\u89e3\u6c7a\u5b83\u5011\uff0c\u60a8\u662f\u5426\u53ef\u4ee5\u4fee\u6539\u95be\u503c\u6216\u7de8\u5beb\u4e0d\u540c\u7684\u898f\u5247\u4f86\u907f\u514d\u5608\u96dc\u7684\u8b66\u5831\uff1f\u6240\u6709\u9019\u4e9b\u8b66\u5831\u90fd\u662f\u5fc5\u8981\u7684\u55ce\uff1f \u4f7f\u7528\u53ef\u89c0\u5bdf\u6027\u5de5\u5177\u7684\u201c\u975c\u97f3\u201d\u529f\u80fd\uff0c\u66ab\u6642\u7981\u7528\u76e3\u8996\u60a8\u5728\u7dad\u8b77\u671f\u9593\u95dc\u9589\u7684\u670d\u52d9\u7684\u8b66\u5831\u3002\u5426\u5247\uff0c\u8b66\u5831\u5c07\u89f8\u767c\u90a3\u4e9b\u95dc\u9589\u7684\u670d\u52d9\uff0c\u518d\u6b21\u589e\u52a0\u8b66\u5831\u75b2\u52de\u7684\u98a8\u96aa\u3002 \u9996\u5148\u5617\u8a66\u81ea\u6211\u4fee\u5fa9\uff1a\u5982\u679c\u6709\u4e00\u7d44\u56fa\u5b9a\u7684\u6307\u4ee4\u53ef\u4ee5\u4fee\u5fa9\u8b66\u5831\uff0c\u8acb\u8003\u616e\u81ea\u52d5\u57f7\u884c\u5b83\u5011\u3002\u914d\u7f6e\u8b66\u5831\u7cfb\u7d71\uff0c\u4ee5\u4fbf\u5982\u679c\u5b83\u7b2c\u4e00\u6b21\u6aa2\u6e2c\u5230\u554f\u984c\uff0c\u5b83\u6703\u57f7\u884c\u81ea\u52d5\u201c\u4fee\u5fa9\u201d\u8173\u672c\uff0c\u800c\u4e0d\u662f\u89f8\u767c\u8b66\u5831\u3002\u53ea\u6709\u5728\u7b2c\u4e8c\u6b21\u6aa2\u6e2c\u5230\u554f\u984c\u6642\u624d\u6703\u89f8\u767c\u5be6\u969b\u8b66\u5831\uff0c\u4ee5\u9632\u81ea\u52d5\u8173\u672c\u7121\u6cd5\u4fee\u5fa9\u554f\u984c\u7684\u539f\u56e0\u3002 \u5305\u62ec\u5b63\u7bc0\u6027\u5206\u6790\uff1a\u4e0d\u50c5\u70ba\u7576\u524d\u7cfb\u7d71\u72c0\u614b\u7de8\u5beb\u8b66\u5831\u898f\u5247\uff0c\u9084\u53ef\u4ee5\u627e\u5230\u898f\u5f8b\u6027\uff0c\u5373\u6578\u64da\u4e2d\u7684\u6a21\u5f0f\u5728\u4e00\u6bb5\u6642\u9593\u5f8c\u958b\u59cb\u91cd\u8907\u3002\u60a8\u901a\u5e38\u53ef\u4ee5\u901a\u904e\u67e5\u770b\u5100\u8868\u677f\u4e2d\u7684\u5716\u8868\u4f86\u8b58\u5225\u6b64\u985e\u6a21\u5f0f\u3002\u63a5\u4e0b\u4f86\uff0c\u60a8\u53ef\u4ee5\u7de8\u5beb\u8b66\u5831\u898f\u5247\uff0c\u5c07\u7576\u524d\u6578\u64da\u8207\u6a21\u5f0f\u7684\u57fa\u7dda\u9032\u884c\u6bd4\u8f03\uff0c\u4ee5\u78ba\u5b9a\u662f\u5426\u6709\u554f\u984c\u3002 \u4f8b\u5982\uff0c\u7db2\u7d61\u6d41\u91cf\u901a\u5e38\u662f\u5b63\u7bc0\u6027\u7684\uff0c\u56e0\u70ba\u60a8\u53ef\u80fd\u6703\u767c\u73fe\u60a8\u7684\u7db2\u7ad9\u6216\u670d\u52d9\u5728\u5de5\u4f5c\u65e5\u665a\u4e0a\u7372\u5f97\u66f4\u591a\u6d41\u91cf\uff0c\u751a\u81f3\u5728\u5468\u672b\u7372\u5f97\u66f4\u591a\u6d41\u91cf\u3002\u7de8\u5beb\u8b66\u5831\u898f\u5247\uff0c\u5c07\u60a8\u7684\u8acb\u6c42\u7387\u8207\u524d\u4e00\u5468\u6216\u524d\u5e7e\u500b\u6708\u7684\u7387\u9032\u884c\u6bd4\u8f03\u3002\u60a8\u53ef\u4ee5\u5f9e\u8acb\u6c42\u7387\u589e\u91cf\u7684\u7a81\u7136\u4e0b\u964d\u4e2d\u5224\u65b7\u51fa\u554f\u984c\u6240\u5728\u3002","title":"\u826f\u597d\u7684\u544a\u8b66\u898f\u5247\u8a2d\u8a08"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/#_4","text":"\u8b93\u6211\u5011\u770b\u4e00\u4e0b\u69cb\u5efa\u8b66\u5831\u898f\u5247\u548c\u63d0\u9ad8\u7e3d\u9ad4\u53ef\u89c0\u5bdf\u6027\u7684\u6280\u5de7\uff0c\u6309\u6574\u500b\u7cfb\u7d71\u5806\u68e7\u4e2d\u7684\u4e0d\u5b9a\u5206\u5c64\u4f86\u5206\u985e\u3002 Application Frontend Server Service Network Security \u6838\u5fc3\u601d\u60f3\u662f\u5c07\u6aa2\u6e2c\u6dfb\u52a0\u5230\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u4ee3\u78bc\u4e2d\uff0c\u9019\u6703\u516c\u958b\u7279\u5b9a\u65bc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u6307\u6a19\u3002\u9019\u4e5f\u610f\u5473\u8457\u7814\u7a76\uff08\u548c\u4f7f\u7528\uff09APM \u5de5\u5177\uff08\u61c9\u7528\u7a0b\u5e8f\u6027\u80fd\u76e3\u63a7\uff09\uff0c\u9019\u4e9b\u5de5\u5177\u53ef\u4ee5\u5206\u6790\u60a8\u7684\u4ee3\u78bc\u4e26\u81ea\u52d5\u5c07\u6aa2\u6e2c\u6dfb\u52a0\u5230\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4e2d\uff0c\u6355\u7372\u901a\u7528\u7684\u6771\u897f\uff0c\u4f8b\u5982\u8acb\u6c42\u7387\u6216\u5783\u573e\u6536\u96c6\u9031\u671f\u3002 \u5982\u4e0a\u6240\u8ff0\uff0c\u5728\u6aa2\u6e2c\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u8acb\u8003\u616e\u60a8\u7684\u696d\u52d9\u3002\u4f8b\u5982\uff0c\u8a08\u7b97\u4e00\u500b\u529f\u80fd\u88ab\u4f7f\u7528\u7684\u6b21\u6578\u3002\u4f46\u4e5f\u6709\u5927\u591a\u6578\u61c9\u7528\u7a0b\u5e8f\u5177\u6709\u7684\u901a\u7528\u529f\u80fd\uff0c\u4f8b\u5982\u767b\u9304\uff0c\u56e0\u6b64\u60a8\u53ef\u4ee5\u8ddf\u8e2a\u6210\u529f\u767b\u9304\u7684\u6578\u91cf\uff0c\u5f9e\u4e2d\u53ef\u4ee5\u8a08\u7b97\u6bcf\u65e5\u6216\u6bcf\u6708\u7684\u6d3b\u8e8d\u7528\u6236\u3002 \u60a8\u9084\u61c9\u8a72\u5728\u53ef\u89c0\u5bdf\u6027\u5806\u68e7\u4e2d\u5305\u542b\u69cb\u5efa\u548c\u90e8\u7f72 (CI/CD) \u4e8b\u4ef6\u3002\u69cb\u5efa\u6307\u793a\u6bcf\u500b\u7248\u672c\u7684\u90e8\u7f72\u4f55\u6642\u958b\u59cb\u548c\u7d50\u675f\u7684\u6307\u6a19\uff0c\u4ee5\u53ca\u90e8\u7f72\u76ee\u6a19\uff08\u74b0\u5883\uff09\u3002\u4f7f\u7528\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u5de5\u5177\uff0c\u60a8\u53ef\u4ee5\u5c07\u90e8\u7f72\u8207\u5176\u4ed6\u4e8b\u4ef6\u76f8\u95dc\u806f\uff0c\u4f8b\u5982\u6aa2\u6e2c\u5230\u5728\u67d0\u500b\u90e8\u7f72\u4e4b\u5f8c\uff0cAPI \u6545\u969c\u7387\u958b\u59cb\u986f\u8457\u589e\u9577\u3002 \u6dfb\u52a0\u6307\u793a\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u5426\u5065\u5eb7\u7684 /health API \u7aef\u9ede\uff0c\u4e26\u4f7f\u7528\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u6293\u53d6\u5b83\u5011\u7684\u8f38\u51fa\u3002\u95dc\u65bc\u5065\u5eb7\u662f\u5426\u61c9\u8a72\u5c40\u9650\u65bc\u63d0\u4f9b\u5065\u5eb7\u7aef\u9ede\u7684\u7d44\u4ef6\uff0c\u6216\u8005\u5b83\u662f\u5426\u61c9\u8a72\u5305\u62ec\u5176\u4ed6\u4f9d\u8cf4\u9805\uff0c\u6709\u4e0d\u540c\u7684\u7406\u5ff5\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7121\u6cd5\u8a2a\u554f\u5e95\u5c64\u6578\u64da\u5eab\u670d\u52d9\uff0cWeb \u61c9\u7528\u7a0b\u5e8f\u7684 /health \u7aef\u9ede\u662f\u5426\u4e5f\u61c9\u8a72\u8fd4\u56de\u72c0\u614b\u78bc 503\uff1f\u5728\u201c\u7d93\u5178\u201d\u7684\u975e\u5206\u4f48\u5f0f\u61c9\u7528\u7a0b\u5e8f\u4e2d\uff0c\u9019\u5c07\u662f\u9810\u671f\u7684\u884c\u70ba\u3002\u4f46\u5728\u5206\u4f48\u5f0f\u74b0\u5883\u4e2d\uff0c\u4f8b\u5982\u57fa\u65bc Kubernetes \u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u60a8\u9700\u8981\u5206\u96e2\u95dc\u6ce8\u9ede\u3002\u6709\u5e7e\u7a2e\u985e\u578b\u7684\u5065\u5eb7\u6aa2\u67e5\uff08 liveness \u3001 readiness \u3001 startup \uff09\uff0c\u60a8\u901a\u5e38\u6703\u5c07\u5065\u5eb7\u6aa2\u67e5\u9650\u5236\u5728\u7d44\u4ef6\u672c\u8eab\uff0c\u4ee5\u907f\u514d\u7d1a\u806f\u932f\u8aa4\u3002\u9084\u8981\u78ba\u4fdd\u5065\u5eb7\u7aef\u9ede\u4e0d\u53ef\u516c\u958b\u8a2a\u554f\uff0c\u4ee5\u907f\u514d\u6d29\u9732\u79c1\u4eba\u4fe1\u606f\u3002 \u8abf\u8a66\u554f\u984c\u7684\u53e6\u4e00\u500b\u5f88\u597d\u7684\u4fe1\u606f\u4f86\u6e90\u662f\u65e5\u8a8c\u8a18\u9304\u3002\u6211\u5efa\u8b70\u60a8\u4f7f\u7528\u7d50\u69cb\u5316\u65e5\u8a8c\uff0c\u4f8b\u5982\u7de8\u78bc\u70ba JSON\u3002\u4ed4\u7d30\u8003\u616e\u4f60\u5728\u54ea\u88e1\u653e\u7f6e log() \u8abf\u7528\u2014\u2014\u65e5\u8a8c\u8abf\u7528\u61c9\u8a72\u53ef\u4ee5\u5e6b\u52a9\u4f60\u4ee5\u5f8c\u8a3a\u65b7\u554f\u984c\uff01 \u524d\u7aef\u76e3\u63a7\u662f\u6307\u76e3\u63a7 GUI \u4e2d\u767c\u751f\u7684\u4e8b\u60c5\uff08\u4f8b\u5982\u700f\u89bd\u5668\u3001\u672c\u6a5f/\u684c\u9762\u6216\u667a\u80fd\u624b\u6a5f\u61c9\u7528\u7a0b\u5e8f\uff09\u3002\u524d\u7aef\u76e3\u63a7\u7d93\u5e38\u88ab\u907a\u6f0f\uff08\u5c31\u50cf\u4e00\u500b\u76f2\u9ede\uff09\uff0c\u5c24\u5176\u662f\u7576\u5be6\u65bd\u76e3\u63a7\u7684\u4eba\u66f4\u591a\u5730\u9762\u5411\u64cd\u4f5c\u6216\u5f8c\u7aef\u6642\u3002 \u201c\u597d\u7684\u201d UI \u7684\u57fa\u672c\u7406\u5ff5\uff08\u5f9e\u7d14\u6280\u8853\u7684\u89d2\u5ea6\u4f86\u770b\uff0c\u5ffd\u7565 UX \u65b9\u9762\uff09\u662f\uff1a\u5143\u7d20\u5fc5\u9808\u5feb\u901f\u52a0\u8f09\uff01\u53cd\u61c9\u9072\u920d\u3001\u6eef\u5f8c\u7684 UI \u662f\u4e00\u500b\u5de8\u5927\u7684\u4ea4\u6613\u7834\u58de\u8005\u3002\u9019\u5c31\u662f\u70ba\u4ec0\u9ebc\u5c07\u53ef\u89c0\u5bdf\u6027\u61c9\u7528\u65bc\u60a8\u7684 UI \u5f88\u91cd\u8981\u7684\u539f\u56e0\u3002 \u6709\u5169\u7a2e\u57fa\u672c\u7684\u6e2c\u8a66\u6a21\u5f0f\uff1a \u9ed1\u76d2\u6e2c\u8a66\uff1a\u5f9e\u5916\u90e8\u89c0\u5bdf\u6027\u80fd\u554f\u984c\uff0c\u5ffd\u7565\u5176\u4ee3\u78bc\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u7684\u61c9\u7528\u662f\u7db2\u7ad9/\u7db2\u7d61\u61c9\u7528\uff0c\u8acb\u4f7f\u7528\u670d\u52d9\uff08\u5982 Webpagetest\uff09\u4f86\u67e5\u8a62\u60a8\u7684\u7db2\u7ad9\uff0c\u6e2c\u91cf\u97ff\u61c9\u6642\u9593\u3002 \u767d\u76d2\u6e2c\u8a66\uff1a\u60a8\u64f4\u5c55\u81ea\u5df1\u7684\u4ee3\u78bc\u4ee5\u5305\u62ec\u6027\u80fd\u6e2c\u91cf\uff0c\u4e26\u78ba\u4fdd\u5c07\u5b83\u5011\u63d0\u4ea4\u5230\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u3002 \u60a8\u61c9\u8a72\u66f4\u559c\u6b61\u767d\u76d2\u6e2c\u8a66\u800c\u4e0d\u662f\u9ed1\u76d2\u6e2c\u8a66\u3002\u4f7f\u7528\u73fe\u6210\u7684\u7d44\u4ef6\u4f86\u7c21\u5316\u5275\u5efa\u6b64\u985e\u6307\u6a19\u7684\u4efb\u52d9\u662f\u6709\u610f\u7fa9\u7684\u2014\u2014\u4f46\u60a8\u5fc5\u9808\u7814\u7a76\u4f7f\u7528\u54ea\u4e00\u500b\uff0c\u56e0\u70ba\u6bcf\u7a2e\u524d\u7aef\u6280\u8853\u90fd\u6709\u8a31\u591a\u5c08\u9580\u7684\u89e3\u6c7a\u65b9\u6848\u3002 \u89c0\u5bdf\u4f60\u7684\u57fa\u790e\u8a2d\u65bd/\u670d\u52d9\u5668\u662f\u5be6\u73fe\u826f\u597d\u53ef\u89c0\u5bdf\u6027\u7684\u5fc5\u8981\u6b65\u9a5f\uff0c\u5373\u4f7f\u5b83\u4e0d\u662f\u4f60\u61c9\u8a72\u95dc\u6ce8\u7684\u7b2c\u4e00\u4ef6\u4e8b\u3002\u64cd\u4f5c\u7cfb\u7d71\u7d1a\u5225\u7684\u6307\u6a19\uff0c\u4f8b\u5982 CPU\u3001\u5167\u5b58\u3001\u78c1\u76e4\u3001\u7db2\u7d61\u4f7f\u7528\u60c5\u6cc1\uff0c\u5c0d\u65bc\u8a3a\u65b7\u554f\u984c\u7684\u539f\u56e0\u5f88\u6709\u7528\u3002\u4f46\u662f\uff0c\u8acb\u8a18\u4f4f\uff0c\u6536\u96c6\u6307\u6a19\u6578\u64da\u4e26\u4e0d\u610f\u5473\u8457\u60a8\u61c9\u8a72\u5275\u5efa\u8b66\u5831\u898f\u5247\u3002\u70ba\u64cd\u4f5c\u7cfb\u7d71\u7d1a\u5225\u7684\u6307\u6a19\u8a2d\u7f6e\u8b66\u5831\u901a\u5e38\u6c92\u6709\u610f\u7fa9\uff08\u9664\u975e\u60a8\u6709\u5145\u5206\u7684\u7406\u7531\uff09\uff0c\u56e0\u70ba\u5b83\u5011\u5f88\u5608\u96dc\uff08\u7522\u751f\u8a31\u591a\u8aa4\u5831\u8b66\u5831\uff09\uff0c\u4e26\u4e14\u8207\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u7121\u95dc\u3002 \u7531\u65bc\u9b54\u9b3c\u5728\u7d30\u7bc0\u4e2d\uff08\u4e00\u5982\u65e2\u5f80\uff09\uff0c\u9019\u88e1\u6709\u4e00\u4e9b\u5efa\u8b70\uff1a CPU \u6307\u6a19\uff1a\u8981\u7372\u5f97\u6b63\u78ba\u7684 CPU \u4f7f\u7528\u7387\uff0c\u7e3d\u7d50\u7528\u6236\u3001\u7cfb\u7d71\u3001niced \u9032\u7a0b (ni)\u3001\u786c\u4ef6\u4e2d\u65b7 (hi) \u548c\u8edf\u4ef6\u4e2d\u65b7 (si) \u4f7f\u7528\u7387\u3002 \u5c0d\u201c\u7cfb\u7d71\u8ca0\u8f09\u201d\u7684\u8b66\u5831\u975e\u5e38\u8b39\u614e\uff08\u8acb\u53c3\u95b1 \u6b64\u8655 \uff09\u3002\u6709\u8a31\u591a\u7cfb\u7d71\u793a\u4f8b\u7684\u6bcf\u6838\u8ca0\u8f09\u9060\u9ad8\u65bc 1\uff0c\u4f46\u4ecd\u7136\u53ef\u4ee5\u6b63\u5e38\u5de5\u4f5c\u4e26\u4e14\u97ff\u61c9\u8fc5\u901f\u3002\u5982\u679c\u7528\u6236\u6c92\u6709\u8a3b\u610f\u5230\u554f\u984c\uff0c\u5247\u7121\u9700\u4fee\u5fa9\uff01 \u5167\u5b58 (RAM) \u6307\u6a19\uff1a\u901a\u904e\u532f\u7e3d shared+cached+buffered \u4f86\u8a08\u7b97\u5be6\u969b\u4f7f\u7528\u7684\u5167\u5b58 \u7de9\u885d\u5340\u5b58\u5132\u6700\u8fd1\u8a2a\u554f\u7684\u78c1\u76e4\u5340\u57df \u7de9\u5b58\u7684\u5de5\u4f5c\u65b9\u5f0f\u985e\u4f3c\u65bc\u7de9\u885d\u5340\uff0c\u4f46\u7528\u65bc\u6700\u8fd1\u8a2a\u554f\u7684\u6587\u4ef6\u7684\u5167\u5bb9\u3002 \u7de9\u885d\u5340/\u9ad8\u901f\u7de9\u5b58\u4f7f\u7528\u7684\u5167\u5b58\u5728\u6280\u8853\u4e0a\u53ef\u4f9b\u4efb\u4f55\u9700\u8981\u5167\u5b58\u7684\u9032\u7a0b\u4f7f\u7528\u3002 Linux CLI \u5de5\u5177 free \u7684\u8f38\u51fa\u5728\u7b2c\u4e8c\u884c\u986f\u793a\u4e86\u6b63\u78ba\u7684\u5167\u5b58\u4f7f\u7528\u60c5\u6cc1\uff08\u4ee5\u201c-/+ buffers/cache\u201d\u958b\u982d\uff09\uff0c\u9019\u8aaa\u660e\u7de9\u885d\u5340\u548c\u7de9\u5b58\u6d88\u8017\u7684\u5167\u5b58\u5be6\u969b\u4e0a\u53ef\u4ee5\u88ab\u5176\u4ed6\u61c9\u7528\u7a0b\u5e8f\u5728\u4efb\u4f55\u6642\u5019\u3002 \u60a8\u9084\u61c9\u8a72\u8003\u616e\u76e3\u8996\u5167\u5b58\u4e0d\u8db3\u932f\u8aa4\uff0c\u9019\u4e9b\u932f\u8aa4\u662f\u5728\u9032\u7a0b\u56e0\u5167\u5b58\u4e0d\u8db3\u800c\u5fc5\u9808\u7d42\u6b62\u6642\u5275\u5efa\u7684\u3002\u5728\u4e92\u806f\u7db2\u4e0a\u641c\u7d22\u201cOOMKiller\u201d\u4ee5\u4e86\u89e3\u66f4\u591a\u4fe1\u606f\u3002 \u78c1\u76e4\u6307\u6a19\uff1a \u60a8\u901a\u5e38\u9700\u8981\u8f03\u4f4e\u7684 iowait \u503c\uff0c\u56e0\u70ba\u5b83\u8868\u793a CPU \u7531\u65bc\u5728\u78c1\u76e4\u4e0a\u7b49\u5f85\u5b8c\u6210\u64cd\u4f5c\u800c\u8655\u65bc\u7a7a\u9592\u72c0\u614b\u7684\u6642\u9593\u91cf\u3002 \u76e3\u63a7\u78c1\u76e4\u7684 IOPS \u4e5f\u5f88\u6709\u610f\u7fa9\uff0c\u4f46\u60a8\u9700\u8981\u9996\u5148\u4e86\u89e3\u4ec0\u9ebc\u662f\u597d\u7684\u57fa\u7dda\uff0c\u7136\u5f8c\u8b58\u5225\u7a81\u7136\u4e0b\u964d\uff08\u8207\u8a72\u57fa\u7dda\u76f8\u6bd4\uff09\u3002 \u60a8\u53ef\u80fd\u6b63\u5728\u4f7f\u7528\u4e0d\u540c\u7a2e\u985e\u7684\u670d\u52d9\uff0c\u60a8\u61c9\u8a72\u70ba\u6b64\u6536\u96c6\u6307\u6a19\u3002\u9019\u88e1\u6709\u4e00\u4e9b\u63d0\u793a\uff1a Web \u670d\u52d9\u5668\u6307\u6a19\uff1a\u9664\u4e86\u901a\u5e38\u7684\u5acc\u7591\u4eba\uff08RED -> \u8acb\u6c42/\u79d2\u3001\u8acb\u6c42\u6301\u7e8c\u6642\u9593\u3001HTTP \u97ff\u61c9\u4ee3\u78bc\uff09\u4e4b\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u6e2c\u91cf\u4e26\u767c\u9023\u63a5\u6578\u3002 \u6578\u64da\u5eab\u670d\u52d9\u5668\u6307\u6a19\uff1a\u4e26\u767c\u9023\u63a5\u6578\u3001\u6bcf\u79d2\u67e5\u8a62\u6578\u3001\u67e5\u8a62\u6301\u7e8c\u6642\u9593\uff08\u6aa2\u6e2c\u6162\u67e5\u8a62\uff09 \u7de9\u5b58\u670d\u52d9\u5668\u6307\u6a19\uff1a\u9a45\u9010\u9805\u76ee\u7684\u6578\u91cf\uff0c\u4ee5\u53ca\u201c\u547d\u4e2d/\u672a\u547d\u4e2d\u7387\u201d\uff08\u4e5f\u7a31\u70ba\u201c\u7de9\u5b58\u547d\u4e2d\u7387\u201d\uff09\u3002 Evicted items\uff1a\u6578\u5b57\u5927\u8868\u793a\u5206\u914d\u7d66\u7de9\u5b58\u670d\u52d9\u5668\u7684\u5167\u5b58\u592a\u5c11 \u547d\u4e2d/\u672a\u547d\u4e2d\u7387\uff1a\u9019\u500b\u6578\u5b57\u8d8a\u4f4e\uff0c\u7de9\u5b58\u6a5f\u5236\u8d8a\u5dee \u5fc3\u8df3\u76e3\u63a7\uff1a\u4e5f\u7a31\u70ba\u201c\u6b7b\u4eba\u958b\u95dc\u201d\u6216\u201ccron\u4f5c\u696d\u76e3\u63a7\u201d\uff08\u4f7f\u7528\u9019\u4e9b\u8853\u8a9e\u641c\u7d22\u4e92\u806f\u7db2\uff0c\u60a8\u6703\u767c\u73fe\u5f88\u591a\u63d0\u4f9b\u5546\uff09\u6703\u6aa2\u6e2c\u5230\u6c92\u6709\u5fc3\u8df3\u4fe1\u865f\u7136\u5f8c\u901a\u77e5\u60a8\uff01\u9019\u5c0d\u65bc\u76e3\u63a7\u60a8\u7684\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u672c\u8eab\u5f88\u6709\u7528\u3002 \u8003\u616e\u76e3\u63a7\u60a8\u4f7f\u7528\u7684\u4efb\u4f55\u5916\u90e8\u670d\u52d9\uff0c\u4f8b\u5982CDN \u670d\u52d9\u5668 - \u5728\u9019\u88e1\u60a8\u53ef\u4ee5\u76e3\u63a7\u5b83\u5011\u7684\u547d\u4e2d/\u672a\u547d\u4e2d\u7387\u6216\u5ef6\u9072\uff0c\u6216 CDN \u63d0\u4f9b\u7684\u4efb\u4f55\u6307\u6a19\u3002 \u7db2\u7d61\u662f\u4efb\u4f55\u8edf\u4ef6\u61c9\u7528\u7a0b\u5e8f\u7684\u57fa\u672c\u57fa\u790e\u4e4b\u4e00\u3002\u5982\u679c\u60a8\u7684\u7db2\u7d61\u53ea\u6709 99.9% \u7684\u53ef\u7528\u6027\uff0c\u90a3\u9ebc\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u4e0d\u53ef\u80fd\u6709\u6bd4\u9019\u66f4\u9ad8\u7684\u53ef\u7528\u6027\u3002 \u8a31\u591a\u8def\u7531\u5668\u548c\u5176\u4ed6\u7db2\u7d61\u786c\u4ef6\u5be6\u73fe\u4e86 SNMP \u5354\u8b70\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u8a72\u5354\u8b70\u5f9e\u4e2d\u67e5\u8a62\u4fe1\u606f\u3002\u8981\u76e3\u63a7\u7684\u5177\u9ad4 OID / \u503c\u5728\u6bcf\u500b\u8a2d\u5099\u4e0a\u6709\u6240\u4e0d\u540c\uff0c\u4f46\u60a8\u61c9\u8a72\u76e3\u63a7\u7684\u4e00\u822c\u6307\u6a19\u662f\uff1a\u541e\u5410\u91cf\u3001\u5ef6\u9072\uff08\u548c\u5ef6\u9072\u4e2d\u7684\u6296\u52d5\uff09\u3001rx/tx \u932f\u8aa4/\u4e1f\u68c4\u3001CRC \u932f\u8aa4\u3001\u9023\u63a5\u932f\u8aa4\u548c\u5404\u7a2e\u5176\u4ed6\u932f\u8aa4\u3002 \u60a8\u9084\u53ef\u4ee5\u8ddf\u8e2a\u8a2d\u5099\u914d\u7f6e\u66f4\u6539\uff0c\u4f8b\u5982\u4f7f\u7528 Rancid \u7b49\u5de5\u5177\uff0c\u5b83\u6703\u5b9a\u671f\u5f9e\u60a8\u7684\u8def\u7531\u5668\uff08\u6216\u5176\u4ed6\u7db2\u7d61\u8a2d\u5099\uff09\u4e0b\u8f09\u914d\u7f6e\uff0c\u5c07\u5176\u8207\u524d\u4e00\u500b\u9032\u884c\u6bd4\u8f03\uff0c\u4e26\u5728\u914d\u7f6e\u767c\u751f\u66f4\u6539\u6642\u901a\u77e5\u60a8\u3002 \u61c9\u7528\u7a0b\u5e8f\u5b89\u5168\u662f\u4e00\u500b\u975e\u5e38\u6df1\u5967\u7684\u8a71\u984c\uff0c\u60a8\u9700\u8981\u5c08\u9580\u7684\u5c08\u5bb6\u4f86\u89e3\u6c7a\u3002\u56e0\u6b64\uff0c\u4ee5\u4e0b\u63d0\u793a\u53ea\u662f\u4e00\u500b\u8d77\u9ede\uff01 \u4f7f\u7528\u8af8\u5982 auditd \u4e4b\u985e\u7684 Linux \u5de5\u5177 \u5141\u8a31\u60a8\u8a18\u9304\u6d3b\u52d5\uff0c\u4f8b\u5982\uff1a \u6240\u6709 sudo \u57f7\u884c\uff0c\u57f7\u884c\u7684\u547d\u4ee4\uff0c\u4ee5\u53ca\u57f7\u884c\u8005 \u6587\u4ef6\u8a2a\u554f\u6216\u5c0d\u7279\u5b9a\u6587\u4ef6\u7684\u66f4\u6539\u3001\u4f55\u6642\u4ee5\u53ca\u7531\u8ab0 \u7528\u6236\u8eab\u4efd\u9a57\u8b49\u5617\u8a66\u548c\u5931\u6557 \u5728\u96f2\u539f\u751f\u751f\u614b\u7cfb\u7d71\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Falco \u4e4b\u985e\u7684\u6771\u897f\u800c\u4e0d\u662f auditd \u4f7f\u7528\u4e3b\u6a5f\u5165\u4fb5\u6aa2\u6e2c\u7cfb\u7d71\uff0c\u4f8b\u5982 wazuh \u5b9a\u671f\u6383\u63cf\u60a8\u7684\u90e8\u7f72\u662f\u5426\u5b58\u5728\u5b89\u5168\u554f\u984c\uff0c\u4f8b\u5982\u4f7f\u7528 OWASP Zed \u653b\u64ca\u4ee3\u7406","title":"\u7279\u5b9a\u65bc\u4e0a\u4e0b\u6587\u7684\u53ef\u89c0\u5bdf\u6027\u63d0\u793a"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/#incident","text":"\u5728\u53ef\u89c0\u5bdf\u6027\u4e16\u754c\u4e2d\uff0c\u4e8b\u4ef6\uff08\u97ff\u61c9\uff09\u7ba1\u7406\u662f\u6307\u4e00\u7d44\u8655\u7406\u53ef\u89c0\u5bdf\u6027\u7cfb\u7d71\u6aa2\u6e2c\u5230\u7684\u554f\u984c\uff08\u4f8b\u5982\u89f8\u767c\u7684\u8b66\u5831\uff09\u7684\u904e\u7a0b\u3002\u6709\u5e7e\u500b\u6846\u67b6\uff0c\u5176\u4e2d\u6700\u6d41\u884c\u7684\u4e00\u500b\u4f86\u81ea ITIL\uff0c\u5b83\u6709\u4e00\u500b\u6b63\u5f0f\u5b9a\u7fa9\u7684 9 \u6b65\u8a08\u5283\u3002\u5728\u5be6\u8e10\u4e2d\uff0c\u5927\u591a\u6578\u7d44\u7e54\u4e0d\u9700\u8981\u5982\u6b64\u6b63\u5f0f\u3002\u50cf\u4e0b\u9762\u9019\u6a23\u7684\u5e8f\u5217\u5df2\u7d93\u8db3\u5920\u597d\u4e86\uff1a \u8b58\u5225\u4e8b\u4ef6\uff1a\u901a\u5e38\u7531\u76e3\u63a7\u7cfb\u7d71\u5b8c\u6210\uff0c \u8a18\u9304\u4e8b\u4ef6\uff0c\u4f8b\u5982\u901a\u904e\u8b93\u76e3\u63a7\u7cfb\u7d71\u5728\u67d0\u4e9b\u5de5\u55ae\u7ba1\u7406\u7cfb\u7d71\u4e2d\u81ea\u52d5\u6253\u958b\u4e8b\u4ef6\u5de5\u55ae\uff0c\u751a\u81f3\u53ef\u80fd\u662f\u5c08\u9580\u91dd\u5c0d\u6b64\u985e\u60c5\u6cc1\u7684\u4e8b\u4ef6\u7ba1\u7406\u7cfb\u7d71\uff0c\u4f8b\u5982 Opsgenie\uff0c \u8a3a\u65b7\uff1a\u5c0d\u5176\u9032\u884c\u5206\u985e\uff0c\u627e\u5230\u53ef\u80fd\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u89e3\u6c7a\u4e8b\u4ef6\uff0c\u4e26\u66f4\u65b0\u6216\u95dc\u9589\u76f8\u61c9\u7684\u5de5\u55ae\uff0c \u9810\u9632\uff1a\u4e00\u65e6\u89e3\u6c7a\uff0c\u5c0b\u627e\u88dc\u6551\u63aa\u65bd\uff0c\u4ee5\u907f\u514d\u554f\u984c\u5728\u672a\u4f86\u4e0d\u65b7\u91cd\u8907\u3002\u9019\u53ef\u4ee5\u5305\u62ec\u5beb\u4e00\u500b\u4e8b\u5f8c\u5206\u6790\u3002 \u6b64\u8655 \u63d0\u4f9b\u4e86\u6709\u95dc\u4e8b\u4ef6\u7ba1\u7406\u7684\u66f4\u591a\u4fe1\u606f\u7684\u826f\u597d\u4f86\u6e90\u3002","title":"\u4e8b\u4ef6\u97ff\u61c9\u7ba1\u7406 (Incident)"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part5/#_5","text":"\u7372\u5f97\u826f\u597d\u7684\u53ef\u89c0\u5bdf\u6027\u5177\u6709\u6311\u6230\u6027\u3002\u60a8\u9700\u8981\u5f9e\u696d\u52d9/\u6700\u7d42\u7528\u6236\u548c\u6280\u8853\u89d2\u5ea6\u4f86\u8655\u7406\u5b83\uff0c\u9019\u9700\u8981\u5718\u968a\u5408\u4f5c\u548c\u6642\u9593\u3002\u4e0d\u8981\u671f\u671b\u60a8\u5728\u4e00\u500b\u6708\u6216\u66f4\u77ed\u7684\u6642\u9593\u5167\u5b8c\u6210\u6240\u6709\u8a2d\u7f6e\uff0c\u4f46\u5be6\u969b\u4e0a\u5c07\u53ef\u89c0\u5bdf\u6027\u8003\u616e\u70ba\u4e00\u500b\u6301\u7e8c\u7684\u904e\u7a0b - \u5c31\u50cf\u4fdd\u6301\u7b2c\u4e09\u65b9\u4f9d\u8cf4\u9805\u6700\u65b0\uff0c\u5c0d\u6297\u6280\u8853\u50b5\u52d9\u7b49\u3002\u78ba\u4fdd\u60a8\uff0c\u60a8\u7684\u5718\u968a\uff0c\u4ee5\u53ca\u60a8\u7d44\u7e54\u4e2d\u7684\u5176\u4ed6\u5229\u76ca\u76f8\u95dc\u8005\u8a2d\u7f6e\u6b63\u78ba\u7684\u512a\u5148\u7d1a\u3002\u9996\u5148\u958b\u59cb\u70ba\u696d\u52d9 KPI \u69cb\u5efa\u6307\u6a19\u548c\u8b66\u5831\uff0c\u7136\u5f8c\u7e7c\u7e8c\u69cb\u5efa\u5c0d\u6700\u7d42\u7528\u6236\uff08\u670d\u52d9\u5668\u7b49\uff09\u4e0d\u53ef\u898b\u7684\u4e8b\u7269\u7684\u5176\u4ed6\u6280\u8853\u6307\u6a19\u3002 \u60a8\u9084\u61c9\u8a72\u907f\u514d\u6c89\u8ff7\u65bc\u5de5\u5177\uff0c\u4f8b\u5982\u4ee3\u7406\u3001\u5ea6\u91cf\u6578\u64da\u5b58\u5132\u6216\u53ef\u8996\u5316\u7cfb\u7d71\u3002\u4fdd\u8b49\u826f\u597d\u53ef\u89c0\u5bdf\u6027\u7684\u4e0d\u662f\u60a8\u4f7f\u7528\u7684\u5de5\u5177\uff08\u6216\u5de5\u5177\u7684\u6578\u91cf\uff09\u3002\u7576\u7136\uff0c\u60a8\u61c9\u8a72\u5728\u958b\u59cb\u6642\u82b1\u5e7e\u5929\u6642\u9593\u7814\u7a76\u4e0d\u540c\u7684\u66ff\u4ee3\u65b9\u6848\uff08\u53ef\u80fd\u6700\u7d42\u4f7f\u7528 Prometheus\uff09\u3002\u4f46\u662f\u4f60\u61c9\u8a72\u907f\u514d\u4e2d\u9014\u4e0d\u65b7\u5730\u5207\u63db\u5de5\u5177\uff0c\u50c5\u50c5\u56e0\u70ba\u5b83\u5011\u770b\u8d77\u4f86\u5f88\u9583\u4eae\uff0c\u6216\u8005\u6709\u65b0\u7684\u529f\u80fd\u3002\u53ea\u6709\u5728\u7576\u524d\u5de5\u5177\u963b\u7919\u60a8\u5feb\u901f\u5be6\u65bd\u66f4\u6539\u6216\u5de5\u5177\u505c\u6b62\u4f7f\u7528\u6642\uff0c\u60a8\u624d\u61c9\u8a72\u5207\u63db\uff08\u4e26\u63a5\u53d7\u5be6\u65bd\u66f4\u6539\u7684\u52aa\u529b\uff09\u3002","title":"\u7d50\u8ad6"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/","text":"Kubernetes \u4e2d\u7684 Prometheus \u6307\u5357 \u00b6 \u672c\u6587\u8a0e\u8ad6\u4e86\u5728 Kubernetes \u4e2d\u5b89\u88dd Prometheus \u7684\u4e0d\u540c\u9078\u9805\uff0c\u7136\u5f8c\u4f7f\u7528 kube-prometheus-stack Helm chart\u8a73\u7d30\u89e3\u91cb\u4e86 Prometheus operator \u7684\u5b89\u88dd\u3002\u6700\u5f8c\uff0c\u6211\u5c07\u4ecb\u7d39\u5982\u4f55\u5347\u7d1a\u60a8\u7684 Prometheus \u5806\u68e7\u4ee5\u53ca\u60a8\u81ea\u5df1\u7684\u8b66\u5831\u898f\u5247\u548c Grafana \u5100\u8868\u677f\u3002 \u4ecb\u7d39 \u00b6 Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u6211\u5728\u672c Observability \u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u89e3\u91cb\u7684\u90a3\u6a23\uff0cPrometheus \u5806\u68e7\u53ef\u4ee5\u5728\u55ae\u500b\u670d\u52d9\u5668\u4e0a\u4f7f\u7528\uff08\u4f8b\u5982\u8207 Docker \u4e00\u8d77\u4f7f\u7528\uff09\uff0c\u4f46\u65e8\u5728\u76e3\u63a7\u5927\u578b\u5206\u4f48\u5f0f\u7cfb\u7d71\u3002 Prometheus \u5806\u68e7\u5728 Kubernetes \u4e2d\u4f7f\u7528\u6642\u6703\u5927\u653e\u7570\u5f69\uff0c\u539f\u56e0\u5982\u4e0b\uff1a Prometheus \u5e36\u6709 Kubernetes \u7684\u52d5\u614b\u670d\u52d9\u767c\u73fe (Service Discovery)\uff1a\u5728 Prometheus \u914d\u7f6e\u6587\u4ef6\u7684 scrape_config \u90e8\u5206\u4e2d\uff0c\u60a8\u53ef\u4ee5\u6dfb\u52a0 kubernetes_sd_config \u985e\u578b\u7684\u76ee\u6a19\uff0c\u5b83\u6307\u793a - Prometheus \u806f\u7e6b Kubernetes API \u670d\u52d9\u5668\u4ee5\u767c\u73fe\u53ef\u7528\u7684\u7bc0\u9ede\u3001pod\u3001\u670d\u52d9\u7b49\u3002 \uff0c\u4e26\u5f9e\u5b83\u5011\u4e2d\u63d0\u53d6\u6307\u6a19\u3002 Kubernetes \u7684\u8a31\u591a\u7d44\u4ef6\uff08\u4f8b\u5982 API \u670d\u52d9\u5668\uff09\u5df2\u7d93\u4ee5 Prometheus \u6307\u6a19\u683c\u5f0f\u5c0e\u51fa\u6307\u6a19 \u5728\u793e\u7fa4\u5df2\u7d93\u5f62\u6210\u4e86\u4e00\u500b\u5927\u751f\u614b\u7cfb\u7d71\uff08kube-prometheus\uff09\uff0c\u540c\u6642\u4e5f\u5b8c\u5584\u4e86 Kubernetes \u548c Prometheus\uff08\u4ee5\u53ca\u76f8\u95dc\u7d44\u4ef6\uff0c\u5982 Alertmanager\u3001Grafana \u7b49\uff09\u7684\u96c6\u6210\u3002 \u6240\u9700\u77e5\u8b58 \u8981\u5145\u5206\u5229\u7528\u672c\u6587\uff0c\u60a8\u9700\u8981\u719f\u6089 Prometheus \u548c Kubernetes\uff1a \u95dc\u65bc Prometheus\uff1a\u9996\u5148\u9700\u8981\u5c0d Prometheus \u8981\u6709\u5f88\u597d\u7684\u4e86\u89e3\uff0c\u5305\u62ec\u5b83\u7684\u67b6\u69cb\u3001\u6982\u5ff5\u3001\u5982\u4f55\u914d\u7f6e\u3001PromQL\u8a9e\u8a00\u3002 \u95dc\u65bc Kubernetes\uff1a\u4f60\u61c9\u8a72\u719f\u6089\u57fa\u672c\u6982\u5ff5\uff0c\u5305\u62ec Helm \u5716\u8868\u548c Kubernetes operator\u3002 \u5728\u672c\u6587\u4e2d\uff0c\u5c07\u8a0e\u8ad6\u4e0d\u540c\u7684\u5b89\u88dd\u9078\u9805\uff0c\u8a73\u7d30\u89e3\u91cb Prometheus operator \u7684\u5b89\u88dd\uff0c\u4e26\u7e3d\u7d50\u5982\u4f55\u5347\u7d1a Prometheus \u5806\u68e7\u3001\u8b66\u5831\u898f\u5247\u548c Grafana \u5100\u8868\u677f\u3002 Kubernetes \u7684 Prometheus \u5b89\u88dd\u9078\u9805 \u00b6 \u8981\u5728 Kubernetes \u4e2d\u555f\u52d5\u4e26\u904b\u884c Prometheus\uff0c\u60a8\u6709\u4e09\u500b\u9078\u64c7\uff1a \u4f7f\u7528 Prometheus Helm chart \u4f86\u5b89\u88dd Prometheus\uff08\u4ee5\u53ca\u4e00\u4e9b\u76f8\u95dc\u7d44\u4ef6\uff0c\u4f8b\u5982 Alertmanager\uff0c\u4f46\u4e0d\u5b89\u88dd Grafana\uff09\u3002\u4f7f\u7528 Prometheus \u539f\u751f\u6587\u4ef6\uff08\u4f8b\u5982 prometheus.yml \u6216 alert-rules.yml \uff09\u5b8c\u6210\u914d\u7f6e\u3002 \u4f7f\u7528 Helm chart \u5b89\u88dd Prometheus operator\uff0c\u4e0d\u4f7f\u7528\u4efb\u4f55 CR\uff1a\u4e0d\u5efa\u8b70\u4f7f\u7528\u9019\u7a2e\u5b89\u88dd\u65b9\u6cd5\uff0c\u56e0\u70ba\u73fe\u5728\u4e0d\u63a8\u85a6\u4f7f\u7528\u9019\u7a2e\u5b89\u88dd\u65b9\u5f0f\uff0c\u8acb\u6539\u7528\u9078\u9805 3\u3002 Prometheus operator\uff08\u5b83\u672c\u8eab\u4e26\u6c92\u6709\u88ab\u68c4\u7528\uff09\u662f\u4e00\u500b Kubernetes operator\uff0c\u53ef\u8b93\u60a8\u4f7f\u7528 CRD \u8655\u7406\u4f9b\u61c9\u548c\u64cd\u4f5c\u5404\u7a2e\u7d44\u4ef6\uff08\u4f8b\u5982 Prometheus \u548c Alertmanager\uff09\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u914d\u7f6e\u662f\u4f7f\u7528 Kubernetes \u539f\u751f\u5c0d\u8c61\u5b8c\u6210\u7684\uff0c\u800c\u4e0d\u662f Prometheus \u539f\u751f\u6587\u4ef6\u3002 Prometheus operator \u5c07\u5b83\u5011\u5373\u6642\u8f49\u63db\u70ba Alertmanager/Prometheus-native \u914d\u7f6e\u683c\u5f0f\u3002 \u4f7f\u7528 kube-prometheus \u5305\u5b89\u88dd Prometheus Operator \u4ee5\u53ca Grafana \u548c\u8a31\u591a\u9ed8\u8a8d\u8b66\u5831\u898f\u5247\u548c\u5100\u8868\u677f\u3002 kube-prometheus \u662f\u4e00\u500b GitHub \u9805\u76ee\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u500b\u5de8\u5927\u7684\u6700\u4f73\u5be6\u8e10\u5eab\u548c\u6709\u95dc\u5982\u4f55\u5b89\u88dd Prometheus operator \u7684\u8aaa\u660e\uff0c\u5305\u62ec\u8a31\u591a\u7684\u9ed8\u8a8d\u914d\u7f6e\u3002 \u9078\u9805 3 \u662f\u63a8\u85a6\u7684\u65b9\u6cd5\uff0c\u4e0b\u4e00\u7bc0\u5c07\u4ecb\u7d39\u66f4\u591a\u7d30\u7bc0\u3002 \u4e0b\u8868\u986f\u793a\u9078\u9805 1 \u548c 3 \u7684\u5c0d\u6bd4\uff1a Prometheus Helm chart kube-prometheus-based Prometheus operator Helm chart Configuration type Prometheus-native Kubernetes-native Installed default components Prometheus Alertmanager Node exporter kube-state-metrics Prometheus Alertmanager Node exporter kube-state-metrics Grafana Comes with pre-installed library of alerting rules and dashboards \u274c \u2705 \u5982\u679c\u60a8\u4e0d\u6e05\u695a kube-state-metrics \u3001 prometheus-adapter \u548c metrics-server \u9805\u76ee\u4ee5\u53ca\u5b83\u5011\u8207 Prometheus \u7684\u95dc\u4fc2\uff0c\u8acb\u5c55\u958b\u4e0b\u9762\u7684\u6846\u3002 Metric-Server Kubernetes \u6709\u81ea\u5df1\u7684\u8655\u7406\u6307\u6a19\u7684\u65b9\u6cd5\uff0c\u5b83\u7368\u7acb\u65bc Prometheus\uff0c\u4f46\u4e5f\u9060\u4e0d\u5982 Prometheus \u5f37\u5927\u3002 Kubernetes SIG\uff08\u7279\u6b8a\u8208\u8da3\u7d44\uff09\u4e4b\u4e00\u5b9a\u7fa9\u4e86\u8207\u6307\u6a19\u76f8\u95dc\u7684 API\uff08\u53c3\u898b\u6b64\u8655\uff09\uff0c\u4f8b\u5982 Resource-metrics API\uff08\u5b83\u516c\u958b\u4e86\u7bc0\u9ede\u3001Pod \u548c\u5bb9\u5668\u7684 CPU \u548c RAM \u4f7f\u7528\u60c5\u6cc1\uff09\u548c Custom-metrics API\uff08\u5b83\u516c\u958b\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u7684\u4efb\u610f\u6307\u6a19\uff09\u3002 API \u9700\u8981\u5be6\u969b\u70ba\u5b83\u5011\u670d\u52d9\u7684\u5be6\u73fe\uff08\u53c3\u898b\u5be6\u73fe\u5217\u8868\uff09\u3002\u4e00\u500b\u5e38\u7528\u7684\u5be6\u73fe\u662f Kubernetes \u96c6\u7fa4\u4e2d\u7d93\u5e38\u9810\u88dd\u7684 metrics-server \uff0c\u4f46\u4e5f\u53ef\u4ee5\u4f7f\u7528 Helm chart \u5b89\u88dd\uff08\u904b\u884c kubectl get pods -A | grep metrics-server \u4ee5\u78ba\u5b9a\u662f\u5426\u5b89\u88dd\uff09\u3002\u5b89\u88dd\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl top \u4e4b\u985e\u7684\u547d\u4ee4\uff0c\u6216\u4f7f\u7528\u6c34\u5e73 pod \u81ea\u52d5\u7e2e\u653e\u5668 (HPA)\uff0c\u9019\u9700\u8981\u904b\u884c\u7684 metrics-server \u4f86\u5b8c\u6210\u5176\u5de5\u4f5c\u3002 \u7136\u800c\uff0cmetrics-server / metrics API \u4e26\u4e0d\u662f\u70ba\u4e86\u505a\u53ef\u89c0\u5bdf\u6027\u3002\u5b83\u53ea\u6536\u96c6\u5f88\u5c11\u7684\u6307\u6a19\uff08\u4f8b\u5982 CPU \u548c\u5167\u5b58\uff09\uff0c\u4e26\u4e14\u53ea\u5c07\u6700\u8fd1\u7684\u6a23\u672c\u6b77\u53f2\u8a18\u9304\u4fdd\u5b58\u5728\u6613\u5931\u6027\u5167\u5b58\u4e2d\uff08\u5b83\u4e0d\u662f\u6301\u4e45\u6027\u7684\uff09\uff0c\u4e5f\u4e0d\u63d0\u4f9b\u8b66\u5831\u3002\u9019\u5c31\u662f\u70ba\u4ec0\u9ebc\u9664\u4e86 metrics-server \u4e4b\u5916\uff0c\u60a8\u9084\u61c9\u8a72\u4f7f\u7528\u4e0a\u8ff0\u63a8\u85a6\u7684\u5b89\u88dd\u9078\u9805\u4e4b\u4e00\u5b89\u88dd Prometheus\u3002 Prometheus \u6301\u7e8c\u5b58\u5132\u8a31\u591a\u4e0d\u540c\u985e\u578b\u7684\u6307\u6a19\uff0c\u4e26\u63d0\u4f9b\u8b66\u5831\u3002 \u9084\u6709\u5169\u500b\u5728\u5be6\u8e10\u4e2d\u7d93\u5e38\u7528\u5230\u7684\u9805\u76ee\uff1a kube-state-metrics \u9805\u76ee\u662f\u4e00\u500b\u55ae\u7368\u7684\u670d\u52d9\uff0c\u5b83\u76e3\u8996 Kubernetes API \u670d\u52d9\u5668\u4e8b\u4ef6\uff0c\u4e26\u70ba\u5b89\u88dd\u5728\u96c6\u7fa4\u4e2d\u7684\u81ea\u5b9a\u7fa9\u5de5\u4f5c\u8ca0\u8f09\u7684\u72c0\u614b\u751f\u6210\u5404\u7a2e\u6307\u6a19\uff0c\u4f8b\u5982Pod\u3001\u90e8\u7f72\u7b49\u7684\u72c0\u614b\uff0c\u4ee5 Prometheus \u683c\u5f0f\u5728 /metrics \u7aef\u9ede\u4e0a\u516c\u958b\u5b83\u5011\uff0c\u4ee5\u4fbf Prometheus \u6293\u53d6\u5b83\u5011\u3002\u60a8\u9700\u8981 kube-state-metrics\uff0c\u56e0\u70ba Kubernetes \u7d44\u4ef6\uff08\u4f8b\u5982 API \u670d\u52d9\u5668\uff09\u9ed8\u8a8d\u516c\u958b\u7684\u6307\u6a19\u662f\u95dc\u65bc\u4e00\u822c\u670d\u52d9\u7684\u72c0\u614b\uff08\u4f8b\u5982\u670d\u52d9\u8acb\u6c42\u7684\u6578\u91cf\uff09\uff0c\u800c\u4e0d\u662f\u95dc\u65bc\u5c0d\u8c61/\u5de5\u4f5c\u8ca0\u8f09\u7684\u72c0\u614b\u4ed6\u5011\u5b58\u653e\u5728\u88e1\u9762\u3002 prometheus-adapter \uff1a\u5982\u679c\u4f60\u4f7f\u7528 HPA\uff0c\u4e26\u4e14resource-metrics\uff08CPU/RAM\uff09\u6578\u64da\u4e0d\u9069\u5408\u5224\u65b7\u4f60\u7684\u670d\u52d9\u7684 replica count \u662f\u5426\u61c9\u8a72\u589e\u52a0/\u6e1b\u5c11\uff0c\u4f60\u4e5f\u53ef\u4ee5\u6307\u793a HPA \u4f7f\u7528\u81ea\u5b9a\u7fa9 metrics \u4f86\u4ee3\u66ff\uff08\u4f7f\u7528\u4e0a\u9762\u63d0\u5230\u7684\u81ea\u5b9a\u7fa9\u6307\u6a19 API\uff09\u3002 prometheus-adapter \u662f\u4e00\u500b\u6a4b\u63a5\u7d44\u4ef6\uff0c\u53ef\u4ee5\u5f9e\u6b63\u5728\u904b\u884c\u7684 Prometheus \u5be6\u4f8b\u63d0\u4f9b\u9019\u4e9b\u81ea\u5b9a\u7fa9\u6307\u6a19\u3002\u5b83\u9084\u53ef\u4ee5\uff08\u4f46\u4e0d\u4e00\u5b9a\u5fc5\u9808\uff09\u66ff\u63db\u5c1a\u672a\u5b89\u88dd\u5ea6\u91cf\u670d\u52d9\u5668\u7684\u96c6\u7fa4\u4e0a\u7684\u5ea6\u91cf\u200b\u200b\u670d\u52d9\u5668\u3002 Prometheus operator \u8a73\u89e3 \u00b6 \u4f7f\u7528 Prometheus operator \uff08\u4f86\u81ea kube-prometheus \u5305\uff09\u662f\u5728 Kubernetes \u4e2d\u5b89\u88dd\u548c\u64cd\u4f5c Prometheus \u7684\u63a8\u85a6\u65b9\u6cd5\u3002\u5b83\u5c07\u8981\u6c42\u60a8\u4e86\u89e3\u7279\u5b9a\u65bc Operator \u7684\u65b0\u6982\u5ff5\uff0c\u4f46\u512a\u9ede\u662f Operator \u7c21\u5316\u4e86\u8a31\u591a\u4efb\u52d9\u3002\u6b63\u5982\u5b98\u65b9 GitHub \u5b58\u5132\u5eab\u6240\u8ff0\uff1a \u7c21\u5316\u7684\u90e8\u7f72\u914d\u7f6e\uff1a\u914d\u7f6e Prometheus \u7684\u57fa\u790e\u77e5\u8b58\uff0c\u4f8b\u5982\u7248\u672c\u3001\u6301\u4e45\u6027\u3001\u4fdd\u7559\u7b56\u7565\u548c\u4f86\u81ea\u672c\u6a5f Kubernetes \u8cc7\u6e90\u7684\u526f\u672c\u3002 Prometheus \u76ee\u6a19\u914d\u7f6e\uff1a\u6839\u64da\u719f\u6089\u7684 Kubernetes \u6a19\u7c64\u67e5\u8a62\u81ea\u52d5\u751f\u6210\u76e3\u63a7\u76ee\u6a19\u914d\u7f6e\uff1b\u7121\u9700\u5b78\u7fd2 Prometheus \u7279\u5b9a\u7684\u914d\u7f6e\u8a9e\u8a00\u3002 \u6700\u5f8c\u4e00\u53e5\uff0c\u201c\u7121\u9700\u5b78\u7fd2 Prometheus \u7279\u5b9a\u7684\u914d\u7f6e\u8a9e\u8a00\u201d\uff0c\u7c21\u76f4\u5c31\u662f\u71df\u92b7\u5ee2\u8a71\u3002\u60a8\u78ba\u5be6\u9700\u8981\u719f\u6089 Prometheus \u548c Alertmanager \u7684\u5927\u591a\u6578\u6982\u5ff5\uff0c\u5426\u5247\u60a8\u5c07\u7121\u6cd5\u8abf\u8a66\u554f\u984c\u3002\u6b64\u5916\uff0c\u914d\u7f6e\u7684\u67d0\u4e9b\u65b9\u9762\u8981\u6c42\u60a8\u9010\u5b57\u7de8\u5beb YAML \u90e8\u5206\uff0c\u9019\u4e9b\u90e8\u5206\u901a\u5e38\u662f prometheus.yaml \u3001 alertmanager.yaml \u6216 alert-rules.yaml \u6587\u4ef6\u7684\u4e00\u90e8\u5206\u3002 \u5728\u4ee5\u4e0b\u5c0f\u7bc0\u4e2d\uff0c\u6211\u5011\u5c07\u4e86\u89e3 Prometheus operator \u7684\u6838\u5fc3\u6982\u5ff5\uff0c\u5982\u4f55\u5c07\u5176\u5b89\u88dd\u5230\u60a8\u7684\u96c6\u7fa4\u4e2d\uff0c\u5982\u4f55\u914d\u7f6e\u5c0d\u5176\u4ed6\u670d\u52d9\u7684\u76e3\u63a7\uff0c\u4ee5\u53ca\u5982\u4f55\u5c07\u81ea\u5b9a\u7fa9\u5100\u8868\u677f\u5c0e\u5165 Grafana\u3002 Prometheus operator \u6838\u5fc3\u6982\u5ff5 \u00b6 \u8207\u4efb\u4f55\u5178\u578b\u7684 Kubernetes operator \u4e00\u6a23\uff0cPrometheus operator \u6703\u6383\u63cf\u60a8\u7684\u96c6\u7fa4\u4ee5\u67e5\u627e\u65b0\u7684\u6216\u66f4\u6539\u7684 CR\uff08\u81ea\u5b9a\u7fa9\u8cc7\u6e90\uff09\uff0c\u7136\u5f8c\u6839\u64da\u9019\u4e9b CR \u90e8\u7f72\u984d\u5916\u7684 pod \u6216\u8abf\u6574\u914d\u7f6e\u3002\u6700\u76f8\u95dc\u7684 CRD \u662f\uff1a Prometheus \uff1a\u5b9a\u7fa9 Prometheus \u90e8\u7f72\uff08\u90e8\u7f72\u70ba StatefulSet\uff09\u3002\u5b83\u63d0\u4f9b\u4e86\u914d\u7f6e\u8907\u88fd\uff08HA \u6a21\u5f0f\uff09\u3001\u6301\u4e45\u5b58\u5132\u548c\u5df2\u90e8\u7f72 Prometheus \u5be6\u4f8b\u5411\u5176\u767c\u9001\u8b66\u5831\u7684\u8b66\u5831\u7ba1\u7406\u5668\u7684\u9078\u9805\u3002 Alertmanager \uff1a\u5b9a\u7fa9\u4e00\u500b Alertmanager \u90e8\u7f72\uff08\u90e8\u7f72\u70ba StatefulSet\uff09\u3002\u5b83\u63d0\u4f9b\u4e86\u914d\u7f6e\u8907\u88fd\uff08HA \u6a21\u5f0f\uff09\u548c\u6301\u4e45\u5b58\u5132\u7684\u9078\u9805\u3002 ServiceMonitor \uff1a\u6307\u5b9a\u61c9\u8a72\u88ab Prometheus \u6293\u53d6\u7684 Kubernetes \u670d\u52d9\u3002 Prometheus operator \u6703\u81ea\u52d5\u70ba\u5b83\u5011\u751f\u6210\u6293\u53d6\u914d\u7f6e\uff0c\u4e26\u914d\u7f6e Prometheus \u5be6\u4f8b\u4ee5\u4f7f\u7528\u5b83\u5011\u3002 PodMonitor \uff1a\u985e\u4f3c\u65bc ServiceMonitor\uff0c\u4f46\u7528\u65bc Kubernetes pod\u3002 PrometheusRule \uff1a\u5b9a\u7fa9 Prometheus \u8b66\u5831\u548c/\u6216\u8a18\u9304\u898f\u5247\u3002 Operator \u751f\u6210\u4e00\u500b\u898f\u5247\u6587\u4ef6\uff0c\u4e26\u914d\u7f6e Prometheus \u5be6\u4f8b\u4ee5\u4f7f\u7528\u5b83\u3002 AlertmanagerConfig \uff1a\u6307\u5b9a Alertmanager \u914d\u7f6e\u7684\u5b50\u90e8\u5206\uff0c\u5141\u8a31\u5c07\u8b66\u5831\u8def\u7531\u5230\u81ea\u5b9a\u7fa9\u63a5\u6536\u5668\uff0c\u4e26\u8a2d\u7f6e\u7981\u6b62\u898f\u5247\u3002 \u53ea\u6709\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u60a8\u624d\u9700\u8981\u66f4\u591a\u7684 CRD\u3002\u60a8\u53ef\u4ee5\u5728 prometheus-operator \u7684 \u8a2d\u8a08\u6587\u6a94 \u4e2d\u627e\u5230\u5c0d CRD \u7684\u8a73\u76e1\u3001\u8a73\u7d30\u7684\u63cf\u8ff0\uff08\u7d55\u5c0d\u662f\u63a8\u85a6\u95b1\u8b80\uff09\u3002 Installation of the operator \u00b6 \u8981\u5b89\u88dd kube-prometheus-stack\uff0c\u9996\u5148\u6309\u7167\u6b64\u8655\u7684\u8aaa\u660e\u6dfb\u52a0 Helm chart \u7684\u5b58\u5132\u5eab\u3002\u5275\u5efa\u4e00\u500b custom-values.yaml \u6587\u4ef6\uff0c\u60a8\u53ef\u4ee5\u5728\u5176\u4e2d\u81ea\u5b9a\u7fa9\u8a31\u591a\u4e0d\u540c\u7684\u8a73\u7d30\u4fe1\u606f\uff08\u898b\u4e0b\u6587\uff09\u3002\u6700\u5f8c\uff0c\u5047\u8a2d\u60a8\u7684 kube \u914d\u7f6e\u8a2d\u7f6e\u6b63\u78ba\uff08\u70ba\u6b63\u78ba\u7684\u96c6\u7fa4\u4f7f\u7528\u6b63\u78ba\u7684\u4e0a\u4e0b\u6587\uff09\uff0c\u904b\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u5b89\u88dd\uff08\u6216\u5347\u7d1a\uff09\u5b83\u3002 helm upgrade --install -f custom-values.yaml [ RELEASE_NAME ] -n monitoring --create-namespace prometheus-community/kube-prometheus-stack \u8207\u4efb\u4f55 Helm chart \u4e00\u6a23\uff0c\u60a8\u9700\u8981\u901a\u904e\u67e5\u770b chart.yaml \u548c values.yaml \u6587\u4ef6\u4f86\u7814\u7a76\u5b83\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u4ee5\u4fbf\u5728\u60a8\u7684 custom-values.yaml \u6587\u4ef6\u4e2d\u8986\u84cb\u5c0d\u60a8\u6709\u610f\u7fa9\u7684\u9078\u9805\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u6211\u89ba\u5f97\u5f88\u6709\u5e6b\u52a9\u7684\u5efa\u8b70\uff1a \u5728 kube-prometheus-stack values.yaml \u6587\u4ef6\u4e2d\uff0c\u201cgrafana\u201d\u3001\u201ckubeStateMetrics\u201d \u548c \u201cnodeExporter\u201d \u9375\u4e0b\u65b9\u7684\u914d\u7f6e\u9078\u9805\u6c92\u6709\u8a73\u7d30\u8a18\u9304\uff0c\u56e0\u70ba\u9019\u4e9b\u662f Chart.yaml \u6587\u4ef6\u4e2d\u5b9a\u7fa9\u7684\u5b50 chart\u3002 Chart.yaml \u6587\u4ef6\u6307\u5411\u627e\u5230\u9019\u4e9b helm chart \u7684 GitHub \u5b58\u5132\u5eab\uff0c\u56e0\u6b64\u8acb\u53c3\u95b1\u5b83\u5011\u4ee5\u4e86\u89e3\u9019\u4e9b\u9078\u9805\u7684\u5de5\u4f5c\u539f\u7406\u3002 \u8a72 helm chart \u6703\u5275\u5efa\u5927\u91cf\u8b66\u5831\u898f\u5247\uff08\u8acb\u53c3\u95b1 defaultRules\uff09\uff0c\u4f46\u4e0d\u6703\u5275\u5efa\u9ed8\u8a8d\u7684 Alertmanager \u914d\u7f6e\uff08\u6307\u793a\u5b58\u5728\u54ea\u4e9b\u63a5\u6536\u5668\u4ee5\u53ca\u5982\u4f55\u5c07\u8b66\u5831\u8def\u7531\u5230\u63a5\u6536\u5668\uff09\u3002\u60a8\u4ecd\u7136\u9700\u8981\u63d0\u4f9b\u81ea\u5df1\u7684 Alertmanager \u914d\u7f6e\uff0c\u65b9\u6cd5\u662f\u5275\u5efa\u4e00\u500b\u5305\u542b AlertmanagerConfig CR \u7684 yaml \u6587\u4ef6\uff08\u8acb\u53c3\u95b1\u64cd\u4f5c\u54e1\u8a2d\u8a08\u6587\u6a94\u4e2d\u7684\u76f8\u61c9\u90e8\u5206\uff09\uff0c\u6216\u8005\u5728 custom-values.yaml \u6587\u4ef6\u4e2d\u7684 alertmanager \u90e8\u5206\u63d0\u4f9b\u914d\u7f6e\u3002\u914d\u7f6e\u3002 \u5728 values.yaml \u6587\u4ef6\u4e2d\uff0c\u641c\u7d22\u4ee5\u201cadditional...\u201d\u958b\u982d\u7684\u914d\u7f6e\u9078\u9805\uff0c\u4ee5\u4e86\u89e3\u60a8\u53ef\u4ee5\u5728 Helm chart \u4e2d\u8a2d\u7f6e\u54ea\u4e9b\u81ea\u5b9a\u7fa9\u9078\u9805\u3002\u6709\u8da3\u7684\u767c\u73fe\u662f\uff1a additionalPrometheusRulesMap prometheus.prometheusSpec.additionalScrapeConfigs prometheus.prometheusSpec.additionalAlertManagerConfigs \u5f9e\u9019\u4e9b\u9078\u9805\u7684\u540d\u7a31\uff08\u548c\u5167\u806f\u6587\u6a94\uff09\u4f86\u770b\uff0c\u5982\u4f55\u4f7f\u7528\u5b83\u5011\u61c9\u8a72\u5f88\u660e\u986f\u3002 \u60a8\u61c9\u8a72\u8abf\u6574 Prometheus \u548c Alertmanager \u4f7f\u7528\u7684\u6301\u4e45\u5b58\u5132\u8a2d\u3002\u96d6\u7136\u5e7e GB \u7684\u5b58\u5132\u7a7a\u9593\u5c0d\u65bc Alertmanager\uff08\u5b83\u4e0d\u6703\u5b58\u5132\u592a\u591a\u6578\u64da\uff09\u4f86\u8aaa\u5c31\u8db3\u5920\u4e86\uff0c\u4f46\u5c0d\u65bc Prometheus \u4f86\u8aaa\u4e8b\u60c5\u8b8a\u5f97\u66f4\u52a0\u8907\u96dc\uff0c\u56e0\u70ba\u5b58\u5132\u9700\u6c42\u53d6\u6c7a\u65bc\u4fdd\u7559\u671f\u548c\u6293\u53d6\u6a23\u672c\u7684\u6578\u91cf\uff08\u6bcf\u500b\u6642\u9593\u55ae\u4f4d\uff09\uff0c\u9019\u662f\u4e0d\u540c\u7684\u5c0d\u65bc\u6bcf\u500b\u7cfb\u7d71\u3002\u6709\u95dc\u6307\u91dd\uff0c\u8acb\u53c3\u898b\u6b64\u8655\u3002\u95dc\u65bc Grafana\uff1akube-prometheus-stack Helm chart \u6545\u610f\u5c07 Grafana \u8996\u70ba\u7121\u72c0\u614b\u7d44\u4ef6\uff0c\u5373\u4f7f\u5b83\u901a\u5e38\u662f\u6709\u72c0\u614b\u904b\u884c\u7684\uff0c\u4f8b\u5982\u5b58\u5132\u7528\u6236\u6216\u5100\u8868\u677f\u3002\u539f\u56e0\u662f\u6240\u6709\u914d\u7f6e\u6578\u64da\u90fd\u61c9\u8a72\u5b58\u5132\u5728\uff08\u7d14\u6587\u672c\uff09\u6587\u4ef6\u4e2d\u3002\u9019\u5df2\u7d93\u662f Prometheus \u548c Alertmanager \u7684\u9ed8\u8a8d\u8a2d\u7f6e\uff0cHelm chart\u4e5f\u901a\u904e\u4e0d\u5c07 grafana.persistence.enabled \u8a2d\u7f6e\u70ba true \uff08\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u70ba false\uff0c\u8acb\u53c3\u898b\u6b64\u8655\uff09\u5c07\u5176\u5f37\u5236\u57f7\u884c\u5230 Grafana\u3002 \u5c0d\u65bc Alertmanager\uff0c\u8abf\u6574\u9078\u9805 alertmanager.alertmanagerSpec.retention \u548c alertmanager.alertmanagerSpec.storage \u5c0d\u65bc Prometheus\uff0c\u8abf\u6574\u9078\u9805 prometheus.prometheusSpec.retention \u548c prometheus.prometheusSpec.storageSpec \u9650\u5236\u8cc7\u6e90\u8acb\u6c42\u548c\u9650\u5236\u7e3d\u662f\u4e00\u500b\u597d\u4e3b\u610f\uff0c\u5c24\u5176\u662f\u5c0d\u65bc\u5177\u6709\u9810\u5b9a\u7fa9\u8cc7\u6e90\u914d\u984d\u7684 Kubernetes \u96c6\u7fa4\u3002\u8a2d\u7f6e prometheus.prometheusSpec.resources \u3001 alertmanager.alertmanagerSpec.resources \u3001 grafana.resources \u3001 grafana.sidecar.resources \u3001 nodeExporter.resources \u548c kubeStateMetrics.resources \u3002 Prometheus \u7684\u5168\u81ea\u52d5\u9ad8\u53ef\u7528\u6027\u4ecd\u7136\u5728 Prometheus \u904b\u71df\u5718\u968a\u7684\u8def\u7dda\u5716\u4e0a\u3002\u4ed6\u5011\u64f4\u5c55 Prometheus \u7684\u95dc\u9375\u6982\u5ff5\u662f\u5206\u7247\u548c\u806f\u5408\u3002\u76ee\u524d\uff0c\u60a8\u53ef\u4ee5\u81ea\u5df1\u9032\u884c\u5206\u7247\uff08\u5c07\u6bcf\u500b Prometheus CR \u9650\u5236\u70ba\u50c5\u6293\u53d6\u67d0\u4e9b\u76ee\u6a19\uff0c\u4f8b\u5982\u4f7f\u7528 serviceMonitorSelector \u9078\u9805\uff09\uff0c\u6216\u8005\uff08\u53e6\u5916\uff09\u4f7f\u7528 kube-prometheus-stack Helm chart \u7684\u5206\u7247\u529f\u80fd\uff0c\u4f46\u8acb\u6ce8\u610f\u9019\u6d89\u53ca\u7684\u8907\u96dc\u6027\u3002 \u5c07 prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues \u8a2d\u7f6e\u70ba false \u3002\u5426\u5247\uff0cPrometheus operator \u5c07\u50c5\u6aa2\u6e2c\u4f5c\u70ba kube-prometheus-stack Helm chart \u7684\u4e00\u90e8\u5206\u5b89\u88dd\u7684\u90a3\u4e9b ServiceMonitor CR\uff08\u5177\u6709\u201c\u767c\u5e03\uff1a[RELEASE NAME]\u201d\u6a19\u7c64\uff09\uff0c\u4e26\u4e14\u4e0d\u6703\u6aa2\u6e2c\u4f86\u81ea\u5176\u4ed6\u4f86\u6e90\u7684\u5176\u4ed6 ServiceMonitor CR\uff0c\u6709\u4e0d\u540c\u7684\u6a19\u7c64\u3002\u64da\u63a8\u6e2c\uff0c\u9078\u64c7\u9ed8\u8a8d\u503c (true) \u662f\u70ba\u4e86\u9650\u5236 Prometheus \u5b89\u88dd\u7684\u8cc7\u6e90\u4f7f\u7528\u3002 \u5c07 grafana.sidecar.datasources.searchNamespace \u8a2d\u7f6e\u70ba ALL\uff0c\u9019\u6a23 Grafana \u5c07\u5728\u6bcf\u500b\u547d\u540d\u7a7a\u9593\u4e2d\u7372\u53d6\u5305\u542b\u5100\u8868\u677f\u7684 ConfigMap\u3002\u5426\u5247\uff08\u4f5c\u70ba\u9ed8\u8a8d\u884c\u70ba\uff09Grafana \u50c5\u6aa2\u6e2c\u8207 Grafana \u672c\u8eab\u4f4d\u65bc\u540c\u4e00\u547d\u540d\u7a7a\u9593\u7684 ConfigMap\u3002\u6709\u95dc Grafana \u5100\u8868\u677f\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u898b\u4e0b\u6587\u3002 \u914d\u7f6e ServiceMonitors \u00b6 \u5982\u4e0a\u6240\u8ff0\uff0cServiceMonitor CR \u544a\u8a34 Prometheus \u6839\u64da\u6a19\u7c64\u9078\u64c7\u5668\u6293\u53d6\u7279\u5b9a\u7684 Kubernetes \u670d\u52d9\u3002\u9664\u4e86\u8a2d\u8a08\u6587\u6a94\u4e4b\u5916\uff0cAPI \u5b9a\u7fa9\u662f\u4e86\u89e3\u66f4\u591a\u95dc\u65bc ServiceMonitor CRD \u7684\u5bf6\u8cb4\u8cc7\u6e90\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c ServiceMonitor CR \u5fc5\u9808\u8207\u5b83\u6240\u5f15\u7528\u7684 Service \u7684 Endpoints \u4f4d\u65bc\u76f8\u540c\u7684 Kubernetes \u547d\u540d\u7a7a\u9593\u4e2d \uff0c\u9664\u975e\u60a8\u5728 CR \u4e2d\u5b9a\u7fa9 .spec.namespaceSelector.any = true \u3002 \u6aa2\u67e5\u96c6\u7fa4\u4e2d\u6709\u54ea\u4e9b\u9810\u5148\u5b58\u5728\u7684\u670d\u52d9\uff0c\u9019\u4e9b\u670d\u52d9\u8207\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6c92\u6709\u76f4\u63a5\u95dc\u4fc2\uff0c\u4e26\u70ba\u5b83\u5011\u5275\u5efa ServiceMonitor CR\uff0c\u901a\u5e38\u662f\u6709\u610f\u7fa9\u7684\u3002\u5178\u578b\u793a\u4f8b\u5305\u62ec Ingress \u63a7\u5236\u5668\u6216 GitOps \u63a7\u5236\u5668\uff0c\u4f8b\u5982 ArgoCD\u3002 \u9019\u662f Traefik Ingress \u63a7\u5236\u5668\u7684 ServiceMonitor \u793a\u4f8b\uff1a apiVersion : monitoring.coreos.com/v1 kind : ServiceMonitor metadata : name : traefik-monitor labels : app : traefik spec : selector : matchLabels : app : traefik endpoints : - port : metrics \u8a2d\u7f6e Grafana \u5100\u8868\u677f \u00b6 \u8981\u5c07\u81ea\u5b9a\u7fa9\u5100\u8868\u677f\u5c0e\u5165 Grafana\uff0ckube-prometheus-stack \u4f7f\u7528 ConfigMaps \u3002\u9019\u80cc\u5f8c\u7684\u6a5f\u5236\u662f Grafana \u7684\u908a\u8eca\u5bb9\u5668\u3002\u5728 values.yaml \u4e2d\uff0c\u9ed8\u8a8d\u555f\u7528 grafana.sidecar \u3002\u9019\u6703\u5c0e\u81f4\u5728 Grafana Pod \u4e2d\u5b89\u88dd k8s-sidecar \u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u6703\u4e0d\u65b7\u67e5\u627e\u5e36\u6709\u201cgrafana_dashboard:'1'\u201d\u7b49\u6a19\u7c64\u7684 ConfigMap\u3002\u9019\u4e9b ConfigMap \u9700\u8981\u5305\u542b\u5100\u8868\u677f json \u4f5c\u70ba\u6578\u64da\u503c\u3002\u6aa2\u6e2c\u5230\u5f8c\uff0ck8s-sidecar \u6703\u5c07\u8a72 json \u4f5c\u70ba\u6587\u4ef6\u639b\u8f09\u5230 Grafana \u5bb9\u5668\u4e2d\uff0c\u5f9e\u800c\u5c0e\u81f4 Grafana \u7684\u914d\u7f6e\u6a5f\u5236\u7372\u53d6\u5b83\u3002 \u8981\u5c07\u5100\u8868\u677f\u653e\u5165\u96c6\u7fa4\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u9996\u5148\uff0c\u60a8\u9700\u8981\u4e00\u500b json \u683c\u5f0f\u7684\u5100\u8868\u677f\uff08\u4f8b\u5982\u9019\u500b\uff09\u3002\u901a\u5e38\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u5728 Grafana \u7684 Web UI \u4e2d\u4ee5\u4ea4\u4e92\u65b9\u5f0f\u69cb\u5efa\u5b83\uff0c\u7136\u5f8c\u5c07\u5176\u5c0e\u51fa\u70ba\u6587\u4ef6\uff08\u6587\u6a94\uff09\u4f86\u7372\u5f97\u6b64\u5100\u8868\u677f\u3002 \u5c07 JSON \u6587\u4ef6\u8f49\u63db\u70ba ConfigMap\uff0c\u4f8b\u5982\u901a\u904e: kubectl create cm config-map-name --from-file dashboard.json -o yaml --dry-run > config-map.yaml \u4f7f\u7528\u6587\u672c\u7de8\u8f2f\u5668\u7de8\u8f2f config-map.yaml \uff1a\u6dfb\u52a0\u6a19\u7c64 grafana_dashboard \uff0c\u503c\u70ba\u201c1\u201d \u5c07\u914d\u7f6e\u6620\u5c04\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa4\uff08 kubectl apply -f config-map.yaml -n <namespace> \uff09 \u5982\u679c Grafana \u6c92\u6709\u81ea\u52d5\u62fe\u53d6\u5100\u8868\u677f\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u555f\u52d5 Grafana\u3002 \u5b89\u88dd\u548c\u6293\u53d6\u984d\u5916\u7684\u6307\u6a19 Exporter \u00b6 \u7372\u53d6\u5728 Kubernetes \u4e2d\u76e3\u63a7\u7684\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\u3001\u6d88\u606f\u4ee3\u7406\u7b49\uff09\u59cb\u7d42\u6d89\u53ca\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u9078\u64c7\u4e26\u90e8\u7f72\u5408\u9069\u7684 \u6307\u6a19 Exporter \uff08\u4f7f\u7528 Kubernetes \u6a5f\u5236\uff0c\u4f8b\u5982 Deployment\uff09\uff0c\u9664\u975e\u8a72\u670d\u52d9\u5df2\u7d93\u5e36\u6709\u5167\u7f6e /metrics \u7aef\u9ede \u7de8\u5beb\u4e00\u500b ServiceMonitor \u4f86\u6307\u793a Prometheus \u6293\u53d6\u8a72Exporter\u5c0e\u51fa\u7684\u6307\u6a19 \u70ba\u8a72\u6307\u6a19 Exporter \u7de8\u5beb\u544a\u8b66\u898f\u5247 \u5e78\u904b\u7684\u662f\uff0c\u8a31\u591a\u5e38\u7528\u670d\u52d9\u7684 Helm chart \u5df2\u7d93\u5177\u6709\u70ba\u60a8\u5b8c\u6210\u6240\u6709\u9019\u4e9b\u6b65\u9a5f\u7684\u9078\u9805\u3002\u4e00\u500b\u793a\u4f8b\u662f Bitnami Postgres Helm chart \uff0c\u5176\u4e2d\u5c07 metrics.enabled\u3001metrics.serviceMonitor.enabled \u548c prometheusRule.enabled \u8a2d\u7f6e\u70ba true \u5c31\u5b8c\u6210\u76f8\u95dc\u7684\u8a2d\u5b9a\u4e86\u3002 \u5c0d\u65bc\u8a31\u591a\u5176\u4ed6\u5e38\u898b\u7684\u6307\u6a19 Exporter\uff08\u4f8b\u5982 Blackbox exporter\u3001redis\u3001rabbitmq \u6216 Pushgateway\uff09\uff0c\u60a8\u53ef\u4ee5\u5728 \u6b64\u8655 \u627e\u5230\u652f\u6301\u7684 Helm chart\u3002 \u95dc\u65bc Prometheus target \u6a19\u7c64 \u00b6 Target \u6a19\u7c64\u7531 Prometheus \u5728\u6293\u53d6\u6307\u6a19\u8cc7\u6599\u6642\u9644\u52a0\u4e0a\u53bb\u7684\u3002\u5728 Kubernetes \u4e4b\u5916\u4f7f\u7528 Prometheus \u6642\uff0cPrometheus \u6703\u81ea\u52d5\u6dfb\u52a0\u76ee\u6a19\u6a19\u7c64 job=\"...\" \u548c instance=\".\u200b\u200b..\" \u3002 \u4f46\u662f\uff0c\u7576\u5728 Kubernetes \u4e2d\u904b\u884c Prometheus \u6642\uff0c\u6703\u6dfb\u52a0\u5176\u4ed6\u5e7e\u500b\u6a19\u7c64\uff0c\u5982\u4e0b\u9762\u7684\u5c4f\u5e55\u622a\u5716\u6240\u793a\uff0c\u9019\u662f\u6211\u4f7f\u7528 Prometheus Web UI\uff08\u72c0\u614b -> \u76ee\u6a19\uff09\u62cd\u651d\u7684\uff1a \u5982\u679c\u60a8\u60f3\u70ba\u5f9e\u8a2d\u7f6e\u4e86 ServiceMonitor \u7684\u670d\u52d9\u4e2d\u6293\u53d6\u7684\u6240\u6709\u6307\u6a19\u6dfb\u52a0\u66f4\u591a\uff08\u975c\u614b\uff09\u76ee\u6a19\u6a19\u7c64\uff0c\u60a8\u6709\u5169\u7a2e\u9078\u64c7\uff1a \u66f4\u65b0 Service \u548c ServiceMonitor \uff1a\u5728 Service \u7684 metadata.labels \u4e0b\u6dfb\u52a0\u975c\u614b\u6a19\u7c64\uff08 somekey: somevalue \uff09\u3002\u5728\u60a8\u7684 ServiceMonitor \u4e2d\uff0c\u5c07\u6a19\u7c64\u9375\u6dfb\u52a0\u5230 . spec.targetLabels \uff0c\u5b83\u662f\u4e00\u500b\u9663\u5217\u3002\u6709\u95dc\u793a\u4f8b\uff0c\u8acb\u53c3\u898b \u6b64\u8655 \u3002 \u50c5\u66f4\u65b0 ServiceMonitor : \u4f7f\u7528 Prometheus \u91cd\u65b0\u6a19\u8a18\u529f\u80fd\uff0c\u4f8b\u5982\u5982 \u6b64\u8655 \u6240\u793a\u3002 \u5347\u7d1a\u4f60\u7684\u76e3\u63a7\u5806\u68e7 \u00b6 \u5927\u591a\u6578\u6559\u7a0b\u5fd8\u8a18\u63d0\u5230\u53ea\u904b\u884c\u4e00\u6b21 helm install \u547d\u4ee4\u662f\u4e00\u500b\u58de\u4e3b\u610f\u3002\u60a8\u61c9\u8a72\u4e0d\u6642\u4ee5\u81ea\u52d5\u65b9\u5f0f\u66f4\u65b0\u60a8\u7684\u76e3\u63a7\u5806\u68e7\u3002\u8207\u50cf Helmfile \u6216 Helmsman \u7b49\u4ee3\u78bc\u5de5\u5177\u4e00\u6a23\u7684\u914d\u7f6e\u7ba1\u7406\u76f8\u7d50\u5408\uff0c dependabot \u6216 Renovate bot \u7b49\u5de5\u5177\u63d0\u4f9b\u4e86\u5f88\u5927\u5e6b\u52a9\u3002\u60a8\u53ef\u4ee5\u5728\u6211\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u627e\u5230 Renovate bot \u7684\u8a73\u7d30\u4ecb\u7d39\u3002\u4f7f\u7528\u9019\u4e9b\u6a5f\u5668\u4eba\u5b9a\u671f\u6aa2\u67e5\u65b0\u7684 kube-prometheus-stack Helm chart\uff0c\u4e26\u8b93\u5b83\u5011\u81ea\u52d5\u5c07 Helm chart\u7684\u6b21\u8981\u7248\u672c\u66f4\u65b0\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa4/Git \u5b58\u5132\u5eab\u3002 \u4f46\u662f\uff0c\u6bcf\u7576\u6709\u65b0\u7684\u4e3b\u8981\u7248\u672c\u7684\u5716\u8868\u6642\uff0c\u60a8\u90fd\u61c9\u8a72\u907f\u514d\u5168\u81ea\u52d5\u66f4\u65b0\u3002\u76f8\u53cd\uff0c\u8b93\u6a5f\u5668\u4eba\u5275\u5efa\u4e00\u500b\u5408\u4f75/\u62c9\u53d6\u8acb\u6c42\uff08\u901a\u77e5\u60a8\uff09\uff0c\u7136\u5f8c\u9996\u5148\u624b\u52d5\u6aa2\u67e5 Helm chart \u5347\u7d1a \u90e8\u5206\u4ee5\u4e86\u89e3\u6f5b\u5728\u7684\u8b66\u544a\u3002 \u67e5\u770b \u9019\u7bc7\u6587\u7ae0 \uff0c\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 GitOps \u5be6\u73fe\u76e3\u63a7\u5806\u68e7\u7684\u81ea\u52d5\u5347\u7d1a\u3002 \u66f4\u65b0\u8b66\u5831\u898f\u5247\u548c\u5100\u8868\u677f \u00b6 \u6bcf\u7576\u60a8\u8abf\u6574\u5305\u542b\u8b66\u5831\u898f\u5247\uff08\u6216 Grafana \u5100\u8868\u677f\uff09\u7684\u6587\u4ef6\u6642\uff0c\u60a8\u90fd\u9700\u8981\u4e00\u7a2e\u81ea\u52d5\u5c07\u5b83\u5011\u90e8\u7f72\u5230\u96c6\u7fa4\u7684\u6a5f\u5236\uff1a \u66f4\u65b0 alerting rules: \u9078\u9805 1 \u2013 \u63a8\u9001\uff08\u4f7f\u7528 Helm\uff09\uff1a\u5982\u679c\u60a8\u5728 custom-values.yaml \u6587\u4ef6\u4e2d\uff08\u5728\u984d\u5916\u7684 PrometheusRulesMap \u4e2d\uff09\u63d0\u4f9b\u4e86\u6240\u6709\u8b66\u5831\u898f\u5247\uff0c\u5247\u5c07\u5b83\u5011\u63d0\u4ea4\u7d66 Git \u4e26\u5728\u60a8\u7684 CI/CD \u7ba1\u9053\u4e2d\u69cb\u5efa\u4e00\u500b\u4f5c\u696d\uff0c\u8a72\u7ba1\u9053\u91cd\u65b0\u904b\u884c helm kube-prometheus-stack Helm chart \u7684\u5347\u7d1a\u547d\u4ee4\uff08\u9019\u662f\u201cCI Ops\u201d\u65b9\u6cd5\uff09\u3002 \u9078\u9805 2 \u2013 \u62c9\u53d6\uff08\u4f7f\u7528 GitOps\uff09\uff1a\u5982\u6211\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u6240\u8ff0\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e00\u500b GitOps \u64cd\u4f5c\u54e1\uff08ArgoCD \u7b49\uff09\uff0c\u5b83\u6703\u5b9a\u671f\u5f9e\u60a8\u7684 Git \u5b58\u5132\u5eab\u4e2d\u62c9\u53d6\u66f4\u6539\u3002\u5c07\u8b66\u5831\u898f\u5247\u653e\u5165 yaml \u6587\u4ef6\u4e2d\uff0c\u4f5c\u70ba PrometheusRule CR\uff08\u6587\u4ef6\u5167\u5bb9\u985e\u4f3c\u65bc kube-prometheus-stack Helm \u5716\u8868\u5c07\u5275\u5efa\u7684\u5167\u5bb9\uff0c\u8acb\u53c3\u898b\u6b64\u8655\uff09\u4e26\u5c07\u5b83\u5011\u5b58\u5132\u5728 Git \u4e2d\u3002 \u66f4\u65b0\u5100\u8868\u677f: \u9019\u8207\u66f4\u65b0\u8b66\u5831\u898f\u5247\u5b8c\u5168\u76f8\u540c\u3002\u552f\u4e00\u7684\u5340\u5225\u662f\u60a8\u4e0d\u80fd\u76f4\u63a5\u5728 custom-values.yaml \u6587\u4ef6\u4e2d\u6307\u5b9a\u5176\u4ed6\u5100\u8868\u677f\u3002\u60a8\u5fc5\u9808\u5728 CI/CD \u4f5c\u696d\u4e2d\u63a8\u9001\u5100\u8868\u677f\u914d\u7f6e yaml \u6587\u4ef6\uff08\u4f7f\u7528 kubectl apply -f ... \u547d\u4ee4\uff09\uff0c\u6216\u8005\u4f7f\u7528\u4e0a\u9762\u9078\u9805 2 \u4e2d\u63cf\u8ff0\u7684 GitOps \u65b9\u6cd5\u3002 \u7d50\u8ad6 \u00b6 \u4e00\u958b\u59cb\uff0c\u8b93\u6574\u500b Prometheus \u5806\u68e7\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u904b\u884c\u78ba\u5be6\u9700\u8981\u4e00\u4e9b\u6642\u9593\u3002\u60a8\u5fc5\u9808\u7fd2\u6163 Prometheus operator \u7684\u6982\u5ff5\uff0c\u800c\u4e0d\u662f\u624b\u52d5\u7de8\u5beb\u914d\u7f6e\u6587\u4ef6\u3002\u5f9e\u597d\u7684\u65b9\u9762\u4f86\u8aaa\uff0cPrometheus operator \u8207 kube-prometheus \u9805\u76ee\u63d0\u4f9b\u7684\u6a21\u677f\u76f8\u7d50\u5408\uff0c\u53ef\u4ee5\u6e1b\u8f15\u60a8\u7684\u8ca0\u64d4\u3002 \u5982\u679c\u60a8\u9047\u5230\u554f\u984c\uff0c\u6211\u5efa\u8b70\u60a8\u505a\u5169\u4ef6\u4e8b\uff1a \u67e5\u770b GitHub \u4e0a\u7684 Prometheus operator \u6587\u6a94\u6587\u4ef6 \u901a\u904e\u67e5\u770b\u5b83\u5728\u96c6\u7fa4\u4e2d\u5275\u5efa\u7684 CR\uff08Prometheus\u3001Alertmanager \u7b49\uff09\uff0c\u4e86\u89e3 kube-prometheus-stack Helm chart \u5982\u4f55\u914d\u7f6e\u9ed8\u8a8d\u503c\u3002","title":"Part 6. Kubernetes \u4e2d\u5b89\u88dd\u8a2d\u5b9a Prometheus \u6307\u5357"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#kubernetes-prometheus","text":"\u672c\u6587\u8a0e\u8ad6\u4e86\u5728 Kubernetes \u4e2d\u5b89\u88dd Prometheus \u7684\u4e0d\u540c\u9078\u9805\uff0c\u7136\u5f8c\u4f7f\u7528 kube-prometheus-stack Helm chart\u8a73\u7d30\u89e3\u91cb\u4e86 Prometheus operator \u7684\u5b89\u88dd\u3002\u6700\u5f8c\uff0c\u6211\u5c07\u4ecb\u7d39\u5982\u4f55\u5347\u7d1a\u60a8\u7684 Prometheus \u5806\u68e7\u4ee5\u53ca\u60a8\u81ea\u5df1\u7684\u8b66\u5831\u898f\u5247\u548c Grafana \u5100\u8868\u677f\u3002","title":"Kubernetes \u4e2d\u7684 Prometheus \u6307\u5357"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#_1","text":"Prometheus \u5806\u68e7\u662f\u4e00\u7d44\u6d41\u884c\u7684\u5de5\u5177\uff0c\u7528\u65bc\u5be6\u73fe\u7cfb\u7d71\u7684\u53ef\u89c0\u5bdf\u6027\u3002\u6b63\u5982\u6211\u5728\u672c Observability \u6587\u7ae0\u7cfb\u5217\u7b2c\u4e00\u90e8\u5206\u6982\u8ff0\u7684\u5b78\u7fd2\u6307\u5357\u4e2d\u6240\u89e3\u91cb\u7684\u90a3\u6a23\uff0cPrometheus \u5806\u68e7\u53ef\u4ee5\u5728\u55ae\u500b\u670d\u52d9\u5668\u4e0a\u4f7f\u7528\uff08\u4f8b\u5982\u8207 Docker \u4e00\u8d77\u4f7f\u7528\uff09\uff0c\u4f46\u65e8\u5728\u76e3\u63a7\u5927\u578b\u5206\u4f48\u5f0f\u7cfb\u7d71\u3002 Prometheus \u5806\u68e7\u5728 Kubernetes \u4e2d\u4f7f\u7528\u6642\u6703\u5927\u653e\u7570\u5f69\uff0c\u539f\u56e0\u5982\u4e0b\uff1a Prometheus \u5e36\u6709 Kubernetes \u7684\u52d5\u614b\u670d\u52d9\u767c\u73fe (Service Discovery)\uff1a\u5728 Prometheus \u914d\u7f6e\u6587\u4ef6\u7684 scrape_config \u90e8\u5206\u4e2d\uff0c\u60a8\u53ef\u4ee5\u6dfb\u52a0 kubernetes_sd_config \u985e\u578b\u7684\u76ee\u6a19\uff0c\u5b83\u6307\u793a - Prometheus \u806f\u7e6b Kubernetes API \u670d\u52d9\u5668\u4ee5\u767c\u73fe\u53ef\u7528\u7684\u7bc0\u9ede\u3001pod\u3001\u670d\u52d9\u7b49\u3002 \uff0c\u4e26\u5f9e\u5b83\u5011\u4e2d\u63d0\u53d6\u6307\u6a19\u3002 Kubernetes \u7684\u8a31\u591a\u7d44\u4ef6\uff08\u4f8b\u5982 API \u670d\u52d9\u5668\uff09\u5df2\u7d93\u4ee5 Prometheus \u6307\u6a19\u683c\u5f0f\u5c0e\u51fa\u6307\u6a19 \u5728\u793e\u7fa4\u5df2\u7d93\u5f62\u6210\u4e86\u4e00\u500b\u5927\u751f\u614b\u7cfb\u7d71\uff08kube-prometheus\uff09\uff0c\u540c\u6642\u4e5f\u5b8c\u5584\u4e86 Kubernetes \u548c Prometheus\uff08\u4ee5\u53ca\u76f8\u95dc\u7d44\u4ef6\uff0c\u5982 Alertmanager\u3001Grafana \u7b49\uff09\u7684\u96c6\u6210\u3002 \u6240\u9700\u77e5\u8b58 \u8981\u5145\u5206\u5229\u7528\u672c\u6587\uff0c\u60a8\u9700\u8981\u719f\u6089 Prometheus \u548c Kubernetes\uff1a \u95dc\u65bc Prometheus\uff1a\u9996\u5148\u9700\u8981\u5c0d Prometheus \u8981\u6709\u5f88\u597d\u7684\u4e86\u89e3\uff0c\u5305\u62ec\u5b83\u7684\u67b6\u69cb\u3001\u6982\u5ff5\u3001\u5982\u4f55\u914d\u7f6e\u3001PromQL\u8a9e\u8a00\u3002 \u95dc\u65bc Kubernetes\uff1a\u4f60\u61c9\u8a72\u719f\u6089\u57fa\u672c\u6982\u5ff5\uff0c\u5305\u62ec Helm \u5716\u8868\u548c Kubernetes operator\u3002 \u5728\u672c\u6587\u4e2d\uff0c\u5c07\u8a0e\u8ad6\u4e0d\u540c\u7684\u5b89\u88dd\u9078\u9805\uff0c\u8a73\u7d30\u89e3\u91cb Prometheus operator \u7684\u5b89\u88dd\uff0c\u4e26\u7e3d\u7d50\u5982\u4f55\u5347\u7d1a Prometheus \u5806\u68e7\u3001\u8b66\u5831\u898f\u5247\u548c Grafana \u5100\u8868\u677f\u3002","title":"\u4ecb\u7d39"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#kubernetes-prometheus_1","text":"\u8981\u5728 Kubernetes \u4e2d\u555f\u52d5\u4e26\u904b\u884c Prometheus\uff0c\u60a8\u6709\u4e09\u500b\u9078\u64c7\uff1a \u4f7f\u7528 Prometheus Helm chart \u4f86\u5b89\u88dd Prometheus\uff08\u4ee5\u53ca\u4e00\u4e9b\u76f8\u95dc\u7d44\u4ef6\uff0c\u4f8b\u5982 Alertmanager\uff0c\u4f46\u4e0d\u5b89\u88dd Grafana\uff09\u3002\u4f7f\u7528 Prometheus \u539f\u751f\u6587\u4ef6\uff08\u4f8b\u5982 prometheus.yml \u6216 alert-rules.yml \uff09\u5b8c\u6210\u914d\u7f6e\u3002 \u4f7f\u7528 Helm chart \u5b89\u88dd Prometheus operator\uff0c\u4e0d\u4f7f\u7528\u4efb\u4f55 CR\uff1a\u4e0d\u5efa\u8b70\u4f7f\u7528\u9019\u7a2e\u5b89\u88dd\u65b9\u6cd5\uff0c\u56e0\u70ba\u73fe\u5728\u4e0d\u63a8\u85a6\u4f7f\u7528\u9019\u7a2e\u5b89\u88dd\u65b9\u5f0f\uff0c\u8acb\u6539\u7528\u9078\u9805 3\u3002 Prometheus operator\uff08\u5b83\u672c\u8eab\u4e26\u6c92\u6709\u88ab\u68c4\u7528\uff09\u662f\u4e00\u500b Kubernetes operator\uff0c\u53ef\u8b93\u60a8\u4f7f\u7528 CRD \u8655\u7406\u4f9b\u61c9\u548c\u64cd\u4f5c\u5404\u7a2e\u7d44\u4ef6\uff08\u4f8b\u5982 Prometheus \u548c Alertmanager\uff09\u3002\u63db\u53e5\u8a71\u8aaa\uff1a\u914d\u7f6e\u662f\u4f7f\u7528 Kubernetes \u539f\u751f\u5c0d\u8c61\u5b8c\u6210\u7684\uff0c\u800c\u4e0d\u662f Prometheus \u539f\u751f\u6587\u4ef6\u3002 Prometheus operator \u5c07\u5b83\u5011\u5373\u6642\u8f49\u63db\u70ba Alertmanager/Prometheus-native \u914d\u7f6e\u683c\u5f0f\u3002 \u4f7f\u7528 kube-prometheus \u5305\u5b89\u88dd Prometheus Operator \u4ee5\u53ca Grafana \u548c\u8a31\u591a\u9ed8\u8a8d\u8b66\u5831\u898f\u5247\u548c\u5100\u8868\u677f\u3002 kube-prometheus \u662f\u4e00\u500b GitHub \u9805\u76ee\uff0c\u5176\u4e2d\u5305\u542b\u4e00\u500b\u5de8\u5927\u7684\u6700\u4f73\u5be6\u8e10\u5eab\u548c\u6709\u95dc\u5982\u4f55\u5b89\u88dd Prometheus operator \u7684\u8aaa\u660e\uff0c\u5305\u62ec\u8a31\u591a\u7684\u9ed8\u8a8d\u914d\u7f6e\u3002 \u9078\u9805 3 \u662f\u63a8\u85a6\u7684\u65b9\u6cd5\uff0c\u4e0b\u4e00\u7bc0\u5c07\u4ecb\u7d39\u66f4\u591a\u7d30\u7bc0\u3002 \u4e0b\u8868\u986f\u793a\u9078\u9805 1 \u548c 3 \u7684\u5c0d\u6bd4\uff1a Prometheus Helm chart kube-prometheus-based Prometheus operator Helm chart Configuration type Prometheus-native Kubernetes-native Installed default components Prometheus Alertmanager Node exporter kube-state-metrics Prometheus Alertmanager Node exporter kube-state-metrics Grafana Comes with pre-installed library of alerting rules and dashboards \u274c \u2705 \u5982\u679c\u60a8\u4e0d\u6e05\u695a kube-state-metrics \u3001 prometheus-adapter \u548c metrics-server \u9805\u76ee\u4ee5\u53ca\u5b83\u5011\u8207 Prometheus \u7684\u95dc\u4fc2\uff0c\u8acb\u5c55\u958b\u4e0b\u9762\u7684\u6846\u3002 Metric-Server Kubernetes \u6709\u81ea\u5df1\u7684\u8655\u7406\u6307\u6a19\u7684\u65b9\u6cd5\uff0c\u5b83\u7368\u7acb\u65bc Prometheus\uff0c\u4f46\u4e5f\u9060\u4e0d\u5982 Prometheus \u5f37\u5927\u3002 Kubernetes SIG\uff08\u7279\u6b8a\u8208\u8da3\u7d44\uff09\u4e4b\u4e00\u5b9a\u7fa9\u4e86\u8207\u6307\u6a19\u76f8\u95dc\u7684 API\uff08\u53c3\u898b\u6b64\u8655\uff09\uff0c\u4f8b\u5982 Resource-metrics API\uff08\u5b83\u516c\u958b\u4e86\u7bc0\u9ede\u3001Pod \u548c\u5bb9\u5668\u7684 CPU \u548c RAM \u4f7f\u7528\u60c5\u6cc1\uff09\u548c Custom-metrics API\uff08\u5b83\u516c\u958b\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u7684\u4efb\u610f\u6307\u6a19\uff09\u3002 API \u9700\u8981\u5be6\u969b\u70ba\u5b83\u5011\u670d\u52d9\u7684\u5be6\u73fe\uff08\u53c3\u898b\u5be6\u73fe\u5217\u8868\uff09\u3002\u4e00\u500b\u5e38\u7528\u7684\u5be6\u73fe\u662f Kubernetes \u96c6\u7fa4\u4e2d\u7d93\u5e38\u9810\u88dd\u7684 metrics-server \uff0c\u4f46\u4e5f\u53ef\u4ee5\u4f7f\u7528 Helm chart \u5b89\u88dd\uff08\u904b\u884c kubectl get pods -A | grep metrics-server \u4ee5\u78ba\u5b9a\u662f\u5426\u5b89\u88dd\uff09\u3002\u5b89\u88dd\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl top \u4e4b\u985e\u7684\u547d\u4ee4\uff0c\u6216\u4f7f\u7528\u6c34\u5e73 pod \u81ea\u52d5\u7e2e\u653e\u5668 (HPA)\uff0c\u9019\u9700\u8981\u904b\u884c\u7684 metrics-server \u4f86\u5b8c\u6210\u5176\u5de5\u4f5c\u3002 \u7136\u800c\uff0cmetrics-server / metrics API \u4e26\u4e0d\u662f\u70ba\u4e86\u505a\u53ef\u89c0\u5bdf\u6027\u3002\u5b83\u53ea\u6536\u96c6\u5f88\u5c11\u7684\u6307\u6a19\uff08\u4f8b\u5982 CPU \u548c\u5167\u5b58\uff09\uff0c\u4e26\u4e14\u53ea\u5c07\u6700\u8fd1\u7684\u6a23\u672c\u6b77\u53f2\u8a18\u9304\u4fdd\u5b58\u5728\u6613\u5931\u6027\u5167\u5b58\u4e2d\uff08\u5b83\u4e0d\u662f\u6301\u4e45\u6027\u7684\uff09\uff0c\u4e5f\u4e0d\u63d0\u4f9b\u8b66\u5831\u3002\u9019\u5c31\u662f\u70ba\u4ec0\u9ebc\u9664\u4e86 metrics-server \u4e4b\u5916\uff0c\u60a8\u9084\u61c9\u8a72\u4f7f\u7528\u4e0a\u8ff0\u63a8\u85a6\u7684\u5b89\u88dd\u9078\u9805\u4e4b\u4e00\u5b89\u88dd Prometheus\u3002 Prometheus \u6301\u7e8c\u5b58\u5132\u8a31\u591a\u4e0d\u540c\u985e\u578b\u7684\u6307\u6a19\uff0c\u4e26\u63d0\u4f9b\u8b66\u5831\u3002 \u9084\u6709\u5169\u500b\u5728\u5be6\u8e10\u4e2d\u7d93\u5e38\u7528\u5230\u7684\u9805\u76ee\uff1a kube-state-metrics \u9805\u76ee\u662f\u4e00\u500b\u55ae\u7368\u7684\u670d\u52d9\uff0c\u5b83\u76e3\u8996 Kubernetes API \u670d\u52d9\u5668\u4e8b\u4ef6\uff0c\u4e26\u70ba\u5b89\u88dd\u5728\u96c6\u7fa4\u4e2d\u7684\u81ea\u5b9a\u7fa9\u5de5\u4f5c\u8ca0\u8f09\u7684\u72c0\u614b\u751f\u6210\u5404\u7a2e\u6307\u6a19\uff0c\u4f8b\u5982Pod\u3001\u90e8\u7f72\u7b49\u7684\u72c0\u614b\uff0c\u4ee5 Prometheus \u683c\u5f0f\u5728 /metrics \u7aef\u9ede\u4e0a\u516c\u958b\u5b83\u5011\uff0c\u4ee5\u4fbf Prometheus \u6293\u53d6\u5b83\u5011\u3002\u60a8\u9700\u8981 kube-state-metrics\uff0c\u56e0\u70ba Kubernetes \u7d44\u4ef6\uff08\u4f8b\u5982 API \u670d\u52d9\u5668\uff09\u9ed8\u8a8d\u516c\u958b\u7684\u6307\u6a19\u662f\u95dc\u65bc\u4e00\u822c\u670d\u52d9\u7684\u72c0\u614b\uff08\u4f8b\u5982\u670d\u52d9\u8acb\u6c42\u7684\u6578\u91cf\uff09\uff0c\u800c\u4e0d\u662f\u95dc\u65bc\u5c0d\u8c61/\u5de5\u4f5c\u8ca0\u8f09\u7684\u72c0\u614b\u4ed6\u5011\u5b58\u653e\u5728\u88e1\u9762\u3002 prometheus-adapter \uff1a\u5982\u679c\u4f60\u4f7f\u7528 HPA\uff0c\u4e26\u4e14resource-metrics\uff08CPU/RAM\uff09\u6578\u64da\u4e0d\u9069\u5408\u5224\u65b7\u4f60\u7684\u670d\u52d9\u7684 replica count \u662f\u5426\u61c9\u8a72\u589e\u52a0/\u6e1b\u5c11\uff0c\u4f60\u4e5f\u53ef\u4ee5\u6307\u793a HPA \u4f7f\u7528\u81ea\u5b9a\u7fa9 metrics \u4f86\u4ee3\u66ff\uff08\u4f7f\u7528\u4e0a\u9762\u63d0\u5230\u7684\u81ea\u5b9a\u7fa9\u6307\u6a19 API\uff09\u3002 prometheus-adapter \u662f\u4e00\u500b\u6a4b\u63a5\u7d44\u4ef6\uff0c\u53ef\u4ee5\u5f9e\u6b63\u5728\u904b\u884c\u7684 Prometheus \u5be6\u4f8b\u63d0\u4f9b\u9019\u4e9b\u81ea\u5b9a\u7fa9\u6307\u6a19\u3002\u5b83\u9084\u53ef\u4ee5\uff08\u4f46\u4e0d\u4e00\u5b9a\u5fc5\u9808\uff09\u66ff\u63db\u5c1a\u672a\u5b89\u88dd\u5ea6\u91cf\u670d\u52d9\u5668\u7684\u96c6\u7fa4\u4e0a\u7684\u5ea6\u91cf\u200b\u200b\u670d\u52d9\u5668\u3002","title":"Kubernetes \u7684 Prometheus \u5b89\u88dd\u9078\u9805"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#prometheus-operator","text":"\u4f7f\u7528 Prometheus operator \uff08\u4f86\u81ea kube-prometheus \u5305\uff09\u662f\u5728 Kubernetes \u4e2d\u5b89\u88dd\u548c\u64cd\u4f5c Prometheus \u7684\u63a8\u85a6\u65b9\u6cd5\u3002\u5b83\u5c07\u8981\u6c42\u60a8\u4e86\u89e3\u7279\u5b9a\u65bc Operator \u7684\u65b0\u6982\u5ff5\uff0c\u4f46\u512a\u9ede\u662f Operator \u7c21\u5316\u4e86\u8a31\u591a\u4efb\u52d9\u3002\u6b63\u5982\u5b98\u65b9 GitHub \u5b58\u5132\u5eab\u6240\u8ff0\uff1a \u7c21\u5316\u7684\u90e8\u7f72\u914d\u7f6e\uff1a\u914d\u7f6e Prometheus \u7684\u57fa\u790e\u77e5\u8b58\uff0c\u4f8b\u5982\u7248\u672c\u3001\u6301\u4e45\u6027\u3001\u4fdd\u7559\u7b56\u7565\u548c\u4f86\u81ea\u672c\u6a5f Kubernetes \u8cc7\u6e90\u7684\u526f\u672c\u3002 Prometheus \u76ee\u6a19\u914d\u7f6e\uff1a\u6839\u64da\u719f\u6089\u7684 Kubernetes \u6a19\u7c64\u67e5\u8a62\u81ea\u52d5\u751f\u6210\u76e3\u63a7\u76ee\u6a19\u914d\u7f6e\uff1b\u7121\u9700\u5b78\u7fd2 Prometheus \u7279\u5b9a\u7684\u914d\u7f6e\u8a9e\u8a00\u3002 \u6700\u5f8c\u4e00\u53e5\uff0c\u201c\u7121\u9700\u5b78\u7fd2 Prometheus \u7279\u5b9a\u7684\u914d\u7f6e\u8a9e\u8a00\u201d\uff0c\u7c21\u76f4\u5c31\u662f\u71df\u92b7\u5ee2\u8a71\u3002\u60a8\u78ba\u5be6\u9700\u8981\u719f\u6089 Prometheus \u548c Alertmanager \u7684\u5927\u591a\u6578\u6982\u5ff5\uff0c\u5426\u5247\u60a8\u5c07\u7121\u6cd5\u8abf\u8a66\u554f\u984c\u3002\u6b64\u5916\uff0c\u914d\u7f6e\u7684\u67d0\u4e9b\u65b9\u9762\u8981\u6c42\u60a8\u9010\u5b57\u7de8\u5beb YAML \u90e8\u5206\uff0c\u9019\u4e9b\u90e8\u5206\u901a\u5e38\u662f prometheus.yaml \u3001 alertmanager.yaml \u6216 alert-rules.yaml \u6587\u4ef6\u7684\u4e00\u90e8\u5206\u3002 \u5728\u4ee5\u4e0b\u5c0f\u7bc0\u4e2d\uff0c\u6211\u5011\u5c07\u4e86\u89e3 Prometheus operator \u7684\u6838\u5fc3\u6982\u5ff5\uff0c\u5982\u4f55\u5c07\u5176\u5b89\u88dd\u5230\u60a8\u7684\u96c6\u7fa4\u4e2d\uff0c\u5982\u4f55\u914d\u7f6e\u5c0d\u5176\u4ed6\u670d\u52d9\u7684\u76e3\u63a7\uff0c\u4ee5\u53ca\u5982\u4f55\u5c07\u81ea\u5b9a\u7fa9\u5100\u8868\u677f\u5c0e\u5165 Grafana\u3002","title":"Prometheus operator \u8a73\u89e3"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#prometheus-operator_1","text":"\u8207\u4efb\u4f55\u5178\u578b\u7684 Kubernetes operator \u4e00\u6a23\uff0cPrometheus operator \u6703\u6383\u63cf\u60a8\u7684\u96c6\u7fa4\u4ee5\u67e5\u627e\u65b0\u7684\u6216\u66f4\u6539\u7684 CR\uff08\u81ea\u5b9a\u7fa9\u8cc7\u6e90\uff09\uff0c\u7136\u5f8c\u6839\u64da\u9019\u4e9b CR \u90e8\u7f72\u984d\u5916\u7684 pod \u6216\u8abf\u6574\u914d\u7f6e\u3002\u6700\u76f8\u95dc\u7684 CRD \u662f\uff1a Prometheus \uff1a\u5b9a\u7fa9 Prometheus \u90e8\u7f72\uff08\u90e8\u7f72\u70ba StatefulSet\uff09\u3002\u5b83\u63d0\u4f9b\u4e86\u914d\u7f6e\u8907\u88fd\uff08HA \u6a21\u5f0f\uff09\u3001\u6301\u4e45\u5b58\u5132\u548c\u5df2\u90e8\u7f72 Prometheus \u5be6\u4f8b\u5411\u5176\u767c\u9001\u8b66\u5831\u7684\u8b66\u5831\u7ba1\u7406\u5668\u7684\u9078\u9805\u3002 Alertmanager \uff1a\u5b9a\u7fa9\u4e00\u500b Alertmanager \u90e8\u7f72\uff08\u90e8\u7f72\u70ba StatefulSet\uff09\u3002\u5b83\u63d0\u4f9b\u4e86\u914d\u7f6e\u8907\u88fd\uff08HA \u6a21\u5f0f\uff09\u548c\u6301\u4e45\u5b58\u5132\u7684\u9078\u9805\u3002 ServiceMonitor \uff1a\u6307\u5b9a\u61c9\u8a72\u88ab Prometheus \u6293\u53d6\u7684 Kubernetes \u670d\u52d9\u3002 Prometheus operator \u6703\u81ea\u52d5\u70ba\u5b83\u5011\u751f\u6210\u6293\u53d6\u914d\u7f6e\uff0c\u4e26\u914d\u7f6e Prometheus \u5be6\u4f8b\u4ee5\u4f7f\u7528\u5b83\u5011\u3002 PodMonitor \uff1a\u985e\u4f3c\u65bc ServiceMonitor\uff0c\u4f46\u7528\u65bc Kubernetes pod\u3002 PrometheusRule \uff1a\u5b9a\u7fa9 Prometheus \u8b66\u5831\u548c/\u6216\u8a18\u9304\u898f\u5247\u3002 Operator \u751f\u6210\u4e00\u500b\u898f\u5247\u6587\u4ef6\uff0c\u4e26\u914d\u7f6e Prometheus \u5be6\u4f8b\u4ee5\u4f7f\u7528\u5b83\u3002 AlertmanagerConfig \uff1a\u6307\u5b9a Alertmanager \u914d\u7f6e\u7684\u5b50\u90e8\u5206\uff0c\u5141\u8a31\u5c07\u8b66\u5831\u8def\u7531\u5230\u81ea\u5b9a\u7fa9\u63a5\u6536\u5668\uff0c\u4e26\u8a2d\u7f6e\u7981\u6b62\u898f\u5247\u3002 \u53ea\u6709\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u60a8\u624d\u9700\u8981\u66f4\u591a\u7684 CRD\u3002\u60a8\u53ef\u4ee5\u5728 prometheus-operator \u7684 \u8a2d\u8a08\u6587\u6a94 \u4e2d\u627e\u5230\u5c0d CRD \u7684\u8a73\u76e1\u3001\u8a73\u7d30\u7684\u63cf\u8ff0\uff08\u7d55\u5c0d\u662f\u63a8\u85a6\u95b1\u8b80\uff09\u3002","title":"Prometheus operator \u6838\u5fc3\u6982\u5ff5"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#installation-of-the-operator","text":"\u8981\u5b89\u88dd kube-prometheus-stack\uff0c\u9996\u5148\u6309\u7167\u6b64\u8655\u7684\u8aaa\u660e\u6dfb\u52a0 Helm chart \u7684\u5b58\u5132\u5eab\u3002\u5275\u5efa\u4e00\u500b custom-values.yaml \u6587\u4ef6\uff0c\u60a8\u53ef\u4ee5\u5728\u5176\u4e2d\u81ea\u5b9a\u7fa9\u8a31\u591a\u4e0d\u540c\u7684\u8a73\u7d30\u4fe1\u606f\uff08\u898b\u4e0b\u6587\uff09\u3002\u6700\u5f8c\uff0c\u5047\u8a2d\u60a8\u7684 kube \u914d\u7f6e\u8a2d\u7f6e\u6b63\u78ba\uff08\u70ba\u6b63\u78ba\u7684\u96c6\u7fa4\u4f7f\u7528\u6b63\u78ba\u7684\u4e0a\u4e0b\u6587\uff09\uff0c\u904b\u884c\u4e0b\u5217\u547d\u4ee4\u4f86\u5b89\u88dd\uff08\u6216\u5347\u7d1a\uff09\u5b83\u3002 helm upgrade --install -f custom-values.yaml [ RELEASE_NAME ] -n monitoring --create-namespace prometheus-community/kube-prometheus-stack \u8207\u4efb\u4f55 Helm chart \u4e00\u6a23\uff0c\u60a8\u9700\u8981\u901a\u904e\u67e5\u770b chart.yaml \u548c values.yaml \u6587\u4ef6\u4f86\u7814\u7a76\u5b83\u662f\u5982\u4f55\u5de5\u4f5c\u7684\uff0c\u4ee5\u4fbf\u5728\u60a8\u7684 custom-values.yaml \u6587\u4ef6\u4e2d\u8986\u84cb\u5c0d\u60a8\u6709\u610f\u7fa9\u7684\u9078\u9805\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u6211\u89ba\u5f97\u5f88\u6709\u5e6b\u52a9\u7684\u5efa\u8b70\uff1a \u5728 kube-prometheus-stack values.yaml \u6587\u4ef6\u4e2d\uff0c\u201cgrafana\u201d\u3001\u201ckubeStateMetrics\u201d \u548c \u201cnodeExporter\u201d \u9375\u4e0b\u65b9\u7684\u914d\u7f6e\u9078\u9805\u6c92\u6709\u8a73\u7d30\u8a18\u9304\uff0c\u56e0\u70ba\u9019\u4e9b\u662f Chart.yaml \u6587\u4ef6\u4e2d\u5b9a\u7fa9\u7684\u5b50 chart\u3002 Chart.yaml \u6587\u4ef6\u6307\u5411\u627e\u5230\u9019\u4e9b helm chart \u7684 GitHub \u5b58\u5132\u5eab\uff0c\u56e0\u6b64\u8acb\u53c3\u95b1\u5b83\u5011\u4ee5\u4e86\u89e3\u9019\u4e9b\u9078\u9805\u7684\u5de5\u4f5c\u539f\u7406\u3002 \u8a72 helm chart \u6703\u5275\u5efa\u5927\u91cf\u8b66\u5831\u898f\u5247\uff08\u8acb\u53c3\u95b1 defaultRules\uff09\uff0c\u4f46\u4e0d\u6703\u5275\u5efa\u9ed8\u8a8d\u7684 Alertmanager \u914d\u7f6e\uff08\u6307\u793a\u5b58\u5728\u54ea\u4e9b\u63a5\u6536\u5668\u4ee5\u53ca\u5982\u4f55\u5c07\u8b66\u5831\u8def\u7531\u5230\u63a5\u6536\u5668\uff09\u3002\u60a8\u4ecd\u7136\u9700\u8981\u63d0\u4f9b\u81ea\u5df1\u7684 Alertmanager \u914d\u7f6e\uff0c\u65b9\u6cd5\u662f\u5275\u5efa\u4e00\u500b\u5305\u542b AlertmanagerConfig CR \u7684 yaml \u6587\u4ef6\uff08\u8acb\u53c3\u95b1\u64cd\u4f5c\u54e1\u8a2d\u8a08\u6587\u6a94\u4e2d\u7684\u76f8\u61c9\u90e8\u5206\uff09\uff0c\u6216\u8005\u5728 custom-values.yaml \u6587\u4ef6\u4e2d\u7684 alertmanager \u90e8\u5206\u63d0\u4f9b\u914d\u7f6e\u3002\u914d\u7f6e\u3002 \u5728 values.yaml \u6587\u4ef6\u4e2d\uff0c\u641c\u7d22\u4ee5\u201cadditional...\u201d\u958b\u982d\u7684\u914d\u7f6e\u9078\u9805\uff0c\u4ee5\u4e86\u89e3\u60a8\u53ef\u4ee5\u5728 Helm chart \u4e2d\u8a2d\u7f6e\u54ea\u4e9b\u81ea\u5b9a\u7fa9\u9078\u9805\u3002\u6709\u8da3\u7684\u767c\u73fe\u662f\uff1a additionalPrometheusRulesMap prometheus.prometheusSpec.additionalScrapeConfigs prometheus.prometheusSpec.additionalAlertManagerConfigs \u5f9e\u9019\u4e9b\u9078\u9805\u7684\u540d\u7a31\uff08\u548c\u5167\u806f\u6587\u6a94\uff09\u4f86\u770b\uff0c\u5982\u4f55\u4f7f\u7528\u5b83\u5011\u61c9\u8a72\u5f88\u660e\u986f\u3002 \u60a8\u61c9\u8a72\u8abf\u6574 Prometheus \u548c Alertmanager \u4f7f\u7528\u7684\u6301\u4e45\u5b58\u5132\u8a2d\u3002\u96d6\u7136\u5e7e GB \u7684\u5b58\u5132\u7a7a\u9593\u5c0d\u65bc Alertmanager\uff08\u5b83\u4e0d\u6703\u5b58\u5132\u592a\u591a\u6578\u64da\uff09\u4f86\u8aaa\u5c31\u8db3\u5920\u4e86\uff0c\u4f46\u5c0d\u65bc Prometheus \u4f86\u8aaa\u4e8b\u60c5\u8b8a\u5f97\u66f4\u52a0\u8907\u96dc\uff0c\u56e0\u70ba\u5b58\u5132\u9700\u6c42\u53d6\u6c7a\u65bc\u4fdd\u7559\u671f\u548c\u6293\u53d6\u6a23\u672c\u7684\u6578\u91cf\uff08\u6bcf\u500b\u6642\u9593\u55ae\u4f4d\uff09\uff0c\u9019\u662f\u4e0d\u540c\u7684\u5c0d\u65bc\u6bcf\u500b\u7cfb\u7d71\u3002\u6709\u95dc\u6307\u91dd\uff0c\u8acb\u53c3\u898b\u6b64\u8655\u3002\u95dc\u65bc Grafana\uff1akube-prometheus-stack Helm chart \u6545\u610f\u5c07 Grafana \u8996\u70ba\u7121\u72c0\u614b\u7d44\u4ef6\uff0c\u5373\u4f7f\u5b83\u901a\u5e38\u662f\u6709\u72c0\u614b\u904b\u884c\u7684\uff0c\u4f8b\u5982\u5b58\u5132\u7528\u6236\u6216\u5100\u8868\u677f\u3002\u539f\u56e0\u662f\u6240\u6709\u914d\u7f6e\u6578\u64da\u90fd\u61c9\u8a72\u5b58\u5132\u5728\uff08\u7d14\u6587\u672c\uff09\u6587\u4ef6\u4e2d\u3002\u9019\u5df2\u7d93\u662f Prometheus \u548c Alertmanager \u7684\u9ed8\u8a8d\u8a2d\u7f6e\uff0cHelm chart\u4e5f\u901a\u904e\u4e0d\u5c07 grafana.persistence.enabled \u8a2d\u7f6e\u70ba true \uff08\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u70ba false\uff0c\u8acb\u53c3\u898b\u6b64\u8655\uff09\u5c07\u5176\u5f37\u5236\u57f7\u884c\u5230 Grafana\u3002 \u5c0d\u65bc Alertmanager\uff0c\u8abf\u6574\u9078\u9805 alertmanager.alertmanagerSpec.retention \u548c alertmanager.alertmanagerSpec.storage \u5c0d\u65bc Prometheus\uff0c\u8abf\u6574\u9078\u9805 prometheus.prometheusSpec.retention \u548c prometheus.prometheusSpec.storageSpec \u9650\u5236\u8cc7\u6e90\u8acb\u6c42\u548c\u9650\u5236\u7e3d\u662f\u4e00\u500b\u597d\u4e3b\u610f\uff0c\u5c24\u5176\u662f\u5c0d\u65bc\u5177\u6709\u9810\u5b9a\u7fa9\u8cc7\u6e90\u914d\u984d\u7684 Kubernetes \u96c6\u7fa4\u3002\u8a2d\u7f6e prometheus.prometheusSpec.resources \u3001 alertmanager.alertmanagerSpec.resources \u3001 grafana.resources \u3001 grafana.sidecar.resources \u3001 nodeExporter.resources \u548c kubeStateMetrics.resources \u3002 Prometheus \u7684\u5168\u81ea\u52d5\u9ad8\u53ef\u7528\u6027\u4ecd\u7136\u5728 Prometheus \u904b\u71df\u5718\u968a\u7684\u8def\u7dda\u5716\u4e0a\u3002\u4ed6\u5011\u64f4\u5c55 Prometheus \u7684\u95dc\u9375\u6982\u5ff5\u662f\u5206\u7247\u548c\u806f\u5408\u3002\u76ee\u524d\uff0c\u60a8\u53ef\u4ee5\u81ea\u5df1\u9032\u884c\u5206\u7247\uff08\u5c07\u6bcf\u500b Prometheus CR \u9650\u5236\u70ba\u50c5\u6293\u53d6\u67d0\u4e9b\u76ee\u6a19\uff0c\u4f8b\u5982\u4f7f\u7528 serviceMonitorSelector \u9078\u9805\uff09\uff0c\u6216\u8005\uff08\u53e6\u5916\uff09\u4f7f\u7528 kube-prometheus-stack Helm chart \u7684\u5206\u7247\u529f\u80fd\uff0c\u4f46\u8acb\u6ce8\u610f\u9019\u6d89\u53ca\u7684\u8907\u96dc\u6027\u3002 \u5c07 prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues \u8a2d\u7f6e\u70ba false \u3002\u5426\u5247\uff0cPrometheus operator \u5c07\u50c5\u6aa2\u6e2c\u4f5c\u70ba kube-prometheus-stack Helm chart \u7684\u4e00\u90e8\u5206\u5b89\u88dd\u7684\u90a3\u4e9b ServiceMonitor CR\uff08\u5177\u6709\u201c\u767c\u5e03\uff1a[RELEASE NAME]\u201d\u6a19\u7c64\uff09\uff0c\u4e26\u4e14\u4e0d\u6703\u6aa2\u6e2c\u4f86\u81ea\u5176\u4ed6\u4f86\u6e90\u7684\u5176\u4ed6 ServiceMonitor CR\uff0c\u6709\u4e0d\u540c\u7684\u6a19\u7c64\u3002\u64da\u63a8\u6e2c\uff0c\u9078\u64c7\u9ed8\u8a8d\u503c (true) \u662f\u70ba\u4e86\u9650\u5236 Prometheus \u5b89\u88dd\u7684\u8cc7\u6e90\u4f7f\u7528\u3002 \u5c07 grafana.sidecar.datasources.searchNamespace \u8a2d\u7f6e\u70ba ALL\uff0c\u9019\u6a23 Grafana \u5c07\u5728\u6bcf\u500b\u547d\u540d\u7a7a\u9593\u4e2d\u7372\u53d6\u5305\u542b\u5100\u8868\u677f\u7684 ConfigMap\u3002\u5426\u5247\uff08\u4f5c\u70ba\u9ed8\u8a8d\u884c\u70ba\uff09Grafana \u50c5\u6aa2\u6e2c\u8207 Grafana \u672c\u8eab\u4f4d\u65bc\u540c\u4e00\u547d\u540d\u7a7a\u9593\u7684 ConfigMap\u3002\u6709\u95dc Grafana \u5100\u8868\u677f\u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u898b\u4e0b\u6587\u3002","title":"Installation of the operator"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#servicemonitors","text":"\u5982\u4e0a\u6240\u8ff0\uff0cServiceMonitor CR \u544a\u8a34 Prometheus \u6839\u64da\u6a19\u7c64\u9078\u64c7\u5668\u6293\u53d6\u7279\u5b9a\u7684 Kubernetes \u670d\u52d9\u3002\u9664\u4e86\u8a2d\u8a08\u6587\u6a94\u4e4b\u5916\uff0cAPI \u5b9a\u7fa9\u662f\u4e86\u89e3\u66f4\u591a\u95dc\u65bc ServiceMonitor CRD \u7684\u5bf6\u8cb4\u8cc7\u6e90\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c ServiceMonitor CR \u5fc5\u9808\u8207\u5b83\u6240\u5f15\u7528\u7684 Service \u7684 Endpoints \u4f4d\u65bc\u76f8\u540c\u7684 Kubernetes \u547d\u540d\u7a7a\u9593\u4e2d \uff0c\u9664\u975e\u60a8\u5728 CR \u4e2d\u5b9a\u7fa9 .spec.namespaceSelector.any = true \u3002 \u6aa2\u67e5\u96c6\u7fa4\u4e2d\u6709\u54ea\u4e9b\u9810\u5148\u5b58\u5728\u7684\u670d\u52d9\uff0c\u9019\u4e9b\u670d\u52d9\u8207\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u6c92\u6709\u76f4\u63a5\u95dc\u4fc2\uff0c\u4e26\u70ba\u5b83\u5011\u5275\u5efa ServiceMonitor CR\uff0c\u901a\u5e38\u662f\u6709\u610f\u7fa9\u7684\u3002\u5178\u578b\u793a\u4f8b\u5305\u62ec Ingress \u63a7\u5236\u5668\u6216 GitOps \u63a7\u5236\u5668\uff0c\u4f8b\u5982 ArgoCD\u3002 \u9019\u662f Traefik Ingress \u63a7\u5236\u5668\u7684 ServiceMonitor \u793a\u4f8b\uff1a apiVersion : monitoring.coreos.com/v1 kind : ServiceMonitor metadata : name : traefik-monitor labels : app : traefik spec : selector : matchLabels : app : traefik endpoints : - port : metrics","title":"\u914d\u7f6e ServiceMonitors"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#grafana","text":"\u8981\u5c07\u81ea\u5b9a\u7fa9\u5100\u8868\u677f\u5c0e\u5165 Grafana\uff0ckube-prometheus-stack \u4f7f\u7528 ConfigMaps \u3002\u9019\u80cc\u5f8c\u7684\u6a5f\u5236\u662f Grafana \u7684\u908a\u8eca\u5bb9\u5668\u3002\u5728 values.yaml \u4e2d\uff0c\u9ed8\u8a8d\u555f\u7528 grafana.sidecar \u3002\u9019\u6703\u5c0e\u81f4\u5728 Grafana Pod \u4e2d\u5b89\u88dd k8s-sidecar \u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u6703\u4e0d\u65b7\u67e5\u627e\u5e36\u6709\u201cgrafana_dashboard:'1'\u201d\u7b49\u6a19\u7c64\u7684 ConfigMap\u3002\u9019\u4e9b ConfigMap \u9700\u8981\u5305\u542b\u5100\u8868\u677f json \u4f5c\u70ba\u6578\u64da\u503c\u3002\u6aa2\u6e2c\u5230\u5f8c\uff0ck8s-sidecar \u6703\u5c07\u8a72 json \u4f5c\u70ba\u6587\u4ef6\u639b\u8f09\u5230 Grafana \u5bb9\u5668\u4e2d\uff0c\u5f9e\u800c\u5c0e\u81f4 Grafana \u7684\u914d\u7f6e\u6a5f\u5236\u7372\u53d6\u5b83\u3002 \u8981\u5c07\u5100\u8868\u677f\u653e\u5165\u96c6\u7fa4\uff0c\u8acb\u57f7\u884c\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u9996\u5148\uff0c\u60a8\u9700\u8981\u4e00\u500b json \u683c\u5f0f\u7684\u5100\u8868\u677f\uff08\u4f8b\u5982\u9019\u500b\uff09\u3002\u901a\u5e38\uff0c\u60a8\u53ef\u4ee5\u901a\u904e\u5728 Grafana \u7684 Web UI \u4e2d\u4ee5\u4ea4\u4e92\u65b9\u5f0f\u69cb\u5efa\u5b83\uff0c\u7136\u5f8c\u5c07\u5176\u5c0e\u51fa\u70ba\u6587\u4ef6\uff08\u6587\u6a94\uff09\u4f86\u7372\u5f97\u6b64\u5100\u8868\u677f\u3002 \u5c07 JSON \u6587\u4ef6\u8f49\u63db\u70ba ConfigMap\uff0c\u4f8b\u5982\u901a\u904e: kubectl create cm config-map-name --from-file dashboard.json -o yaml --dry-run > config-map.yaml \u4f7f\u7528\u6587\u672c\u7de8\u8f2f\u5668\u7de8\u8f2f config-map.yaml \uff1a\u6dfb\u52a0\u6a19\u7c64 grafana_dashboard \uff0c\u503c\u70ba\u201c1\u201d \u5c07\u914d\u7f6e\u6620\u5c04\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa4\uff08 kubectl apply -f config-map.yaml -n <namespace> \uff09 \u5982\u679c Grafana \u6c92\u6709\u81ea\u52d5\u62fe\u53d6\u5100\u8868\u677f\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u91cd\u65b0\u555f\u52d5 Grafana\u3002","title":"\u8a2d\u7f6e Grafana \u5100\u8868\u677f"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#exporter","text":"\u7372\u53d6\u5728 Kubernetes \u4e2d\u76e3\u63a7\u7684\u670d\u52d9\uff08\u4f8b\u5982\u6578\u64da\u5eab\u3001\u6d88\u606f\u4ee3\u7406\u7b49\uff09\u59cb\u7d42\u6d89\u53ca\u4ee5\u4e0b\u6b65\u9a5f\uff1a \u9078\u64c7\u4e26\u90e8\u7f72\u5408\u9069\u7684 \u6307\u6a19 Exporter \uff08\u4f7f\u7528 Kubernetes \u6a5f\u5236\uff0c\u4f8b\u5982 Deployment\uff09\uff0c\u9664\u975e\u8a72\u670d\u52d9\u5df2\u7d93\u5e36\u6709\u5167\u7f6e /metrics \u7aef\u9ede \u7de8\u5beb\u4e00\u500b ServiceMonitor \u4f86\u6307\u793a Prometheus \u6293\u53d6\u8a72Exporter\u5c0e\u51fa\u7684\u6307\u6a19 \u70ba\u8a72\u6307\u6a19 Exporter \u7de8\u5beb\u544a\u8b66\u898f\u5247 \u5e78\u904b\u7684\u662f\uff0c\u8a31\u591a\u5e38\u7528\u670d\u52d9\u7684 Helm chart \u5df2\u7d93\u5177\u6709\u70ba\u60a8\u5b8c\u6210\u6240\u6709\u9019\u4e9b\u6b65\u9a5f\u7684\u9078\u9805\u3002\u4e00\u500b\u793a\u4f8b\u662f Bitnami Postgres Helm chart \uff0c\u5176\u4e2d\u5c07 metrics.enabled\u3001metrics.serviceMonitor.enabled \u548c prometheusRule.enabled \u8a2d\u7f6e\u70ba true \u5c31\u5b8c\u6210\u76f8\u95dc\u7684\u8a2d\u5b9a\u4e86\u3002 \u5c0d\u65bc\u8a31\u591a\u5176\u4ed6\u5e38\u898b\u7684\u6307\u6a19 Exporter\uff08\u4f8b\u5982 Blackbox exporter\u3001redis\u3001rabbitmq \u6216 Pushgateway\uff09\uff0c\u60a8\u53ef\u4ee5\u5728 \u6b64\u8655 \u627e\u5230\u652f\u6301\u7684 Helm chart\u3002","title":"\u5b89\u88dd\u548c\u6293\u53d6\u984d\u5916\u7684\u6307\u6a19 Exporter"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#prometheus-target","text":"Target \u6a19\u7c64\u7531 Prometheus \u5728\u6293\u53d6\u6307\u6a19\u8cc7\u6599\u6642\u9644\u52a0\u4e0a\u53bb\u7684\u3002\u5728 Kubernetes \u4e4b\u5916\u4f7f\u7528 Prometheus \u6642\uff0cPrometheus \u6703\u81ea\u52d5\u6dfb\u52a0\u76ee\u6a19\u6a19\u7c64 job=\"...\" \u548c instance=\".\u200b\u200b..\" \u3002 \u4f46\u662f\uff0c\u7576\u5728 Kubernetes \u4e2d\u904b\u884c Prometheus \u6642\uff0c\u6703\u6dfb\u52a0\u5176\u4ed6\u5e7e\u500b\u6a19\u7c64\uff0c\u5982\u4e0b\u9762\u7684\u5c4f\u5e55\u622a\u5716\u6240\u793a\uff0c\u9019\u662f\u6211\u4f7f\u7528 Prometheus Web UI\uff08\u72c0\u614b -> \u76ee\u6a19\uff09\u62cd\u651d\u7684\uff1a \u5982\u679c\u60a8\u60f3\u70ba\u5f9e\u8a2d\u7f6e\u4e86 ServiceMonitor \u7684\u670d\u52d9\u4e2d\u6293\u53d6\u7684\u6240\u6709\u6307\u6a19\u6dfb\u52a0\u66f4\u591a\uff08\u975c\u614b\uff09\u76ee\u6a19\u6a19\u7c64\uff0c\u60a8\u6709\u5169\u7a2e\u9078\u64c7\uff1a \u66f4\u65b0 Service \u548c ServiceMonitor \uff1a\u5728 Service \u7684 metadata.labels \u4e0b\u6dfb\u52a0\u975c\u614b\u6a19\u7c64\uff08 somekey: somevalue \uff09\u3002\u5728\u60a8\u7684 ServiceMonitor \u4e2d\uff0c\u5c07\u6a19\u7c64\u9375\u6dfb\u52a0\u5230 . spec.targetLabels \uff0c\u5b83\u662f\u4e00\u500b\u9663\u5217\u3002\u6709\u95dc\u793a\u4f8b\uff0c\u8acb\u53c3\u898b \u6b64\u8655 \u3002 \u50c5\u66f4\u65b0 ServiceMonitor : \u4f7f\u7528 Prometheus \u91cd\u65b0\u6a19\u8a18\u529f\u80fd\uff0c\u4f8b\u5982\u5982 \u6b64\u8655 \u6240\u793a\u3002","title":"\u95dc\u65bc Prometheus target \u6a19\u7c64"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#_2","text":"\u5927\u591a\u6578\u6559\u7a0b\u5fd8\u8a18\u63d0\u5230\u53ea\u904b\u884c\u4e00\u6b21 helm install \u547d\u4ee4\u662f\u4e00\u500b\u58de\u4e3b\u610f\u3002\u60a8\u61c9\u8a72\u4e0d\u6642\u4ee5\u81ea\u52d5\u65b9\u5f0f\u66f4\u65b0\u60a8\u7684\u76e3\u63a7\u5806\u68e7\u3002\u8207\u50cf Helmfile \u6216 Helmsman \u7b49\u4ee3\u78bc\u5de5\u5177\u4e00\u6a23\u7684\u914d\u7f6e\u7ba1\u7406\u76f8\u7d50\u5408\uff0c dependabot \u6216 Renovate bot \u7b49\u5de5\u5177\u63d0\u4f9b\u4e86\u5f88\u5927\u5e6b\u52a9\u3002\u60a8\u53ef\u4ee5\u5728\u6211\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u627e\u5230 Renovate bot \u7684\u8a73\u7d30\u4ecb\u7d39\u3002\u4f7f\u7528\u9019\u4e9b\u6a5f\u5668\u4eba\u5b9a\u671f\u6aa2\u67e5\u65b0\u7684 kube-prometheus-stack Helm chart\uff0c\u4e26\u8b93\u5b83\u5011\u81ea\u52d5\u5c07 Helm chart\u7684\u6b21\u8981\u7248\u672c\u66f4\u65b0\u61c9\u7528\u5230\u60a8\u7684\u96c6\u7fa4/Git \u5b58\u5132\u5eab\u3002 \u4f46\u662f\uff0c\u6bcf\u7576\u6709\u65b0\u7684\u4e3b\u8981\u7248\u672c\u7684\u5716\u8868\u6642\uff0c\u60a8\u90fd\u61c9\u8a72\u907f\u514d\u5168\u81ea\u52d5\u66f4\u65b0\u3002\u76f8\u53cd\uff0c\u8b93\u6a5f\u5668\u4eba\u5275\u5efa\u4e00\u500b\u5408\u4f75/\u62c9\u53d6\u8acb\u6c42\uff08\u901a\u77e5\u60a8\uff09\uff0c\u7136\u5f8c\u9996\u5148\u624b\u52d5\u6aa2\u67e5 Helm chart \u5347\u7d1a \u90e8\u5206\u4ee5\u4e86\u89e3\u6f5b\u5728\u7684\u8b66\u544a\u3002 \u67e5\u770b \u9019\u7bc7\u6587\u7ae0 \uff0c\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 GitOps \u5be6\u73fe\u76e3\u63a7\u5806\u68e7\u7684\u81ea\u52d5\u5347\u7d1a\u3002","title":"\u5347\u7d1a\u4f60\u7684\u76e3\u63a7\u5806\u68e7"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#_3","text":"\u6bcf\u7576\u60a8\u8abf\u6574\u5305\u542b\u8b66\u5831\u898f\u5247\uff08\u6216 Grafana \u5100\u8868\u677f\uff09\u7684\u6587\u4ef6\u6642\uff0c\u60a8\u90fd\u9700\u8981\u4e00\u7a2e\u81ea\u52d5\u5c07\u5b83\u5011\u90e8\u7f72\u5230\u96c6\u7fa4\u7684\u6a5f\u5236\uff1a \u66f4\u65b0 alerting rules: \u9078\u9805 1 \u2013 \u63a8\u9001\uff08\u4f7f\u7528 Helm\uff09\uff1a\u5982\u679c\u60a8\u5728 custom-values.yaml \u6587\u4ef6\u4e2d\uff08\u5728\u984d\u5916\u7684 PrometheusRulesMap \u4e2d\uff09\u63d0\u4f9b\u4e86\u6240\u6709\u8b66\u5831\u898f\u5247\uff0c\u5247\u5c07\u5b83\u5011\u63d0\u4ea4\u7d66 Git \u4e26\u5728\u60a8\u7684 CI/CD \u7ba1\u9053\u4e2d\u69cb\u5efa\u4e00\u500b\u4f5c\u696d\uff0c\u8a72\u7ba1\u9053\u91cd\u65b0\u904b\u884c helm kube-prometheus-stack Helm chart \u7684\u5347\u7d1a\u547d\u4ee4\uff08\u9019\u662f\u201cCI Ops\u201d\u65b9\u6cd5\uff09\u3002 \u9078\u9805 2 \u2013 \u62c9\u53d6\uff08\u4f7f\u7528 GitOps\uff09\uff1a\u5982\u6211\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u6240\u8ff0\uff0c\u60a8\u53ef\u4ee5\u904b\u884c\u4e00\u500b GitOps \u64cd\u4f5c\u54e1\uff08ArgoCD \u7b49\uff09\uff0c\u5b83\u6703\u5b9a\u671f\u5f9e\u60a8\u7684 Git \u5b58\u5132\u5eab\u4e2d\u62c9\u53d6\u66f4\u6539\u3002\u5c07\u8b66\u5831\u898f\u5247\u653e\u5165 yaml \u6587\u4ef6\u4e2d\uff0c\u4f5c\u70ba PrometheusRule CR\uff08\u6587\u4ef6\u5167\u5bb9\u985e\u4f3c\u65bc kube-prometheus-stack Helm \u5716\u8868\u5c07\u5275\u5efa\u7684\u5167\u5bb9\uff0c\u8acb\u53c3\u898b\u6b64\u8655\uff09\u4e26\u5c07\u5b83\u5011\u5b58\u5132\u5728 Git \u4e2d\u3002 \u66f4\u65b0\u5100\u8868\u677f: \u9019\u8207\u66f4\u65b0\u8b66\u5831\u898f\u5247\u5b8c\u5168\u76f8\u540c\u3002\u552f\u4e00\u7684\u5340\u5225\u662f\u60a8\u4e0d\u80fd\u76f4\u63a5\u5728 custom-values.yaml \u6587\u4ef6\u4e2d\u6307\u5b9a\u5176\u4ed6\u5100\u8868\u677f\u3002\u60a8\u5fc5\u9808\u5728 CI/CD \u4f5c\u696d\u4e2d\u63a8\u9001\u5100\u8868\u677f\u914d\u7f6e yaml \u6587\u4ef6\uff08\u4f7f\u7528 kubectl apply -f ... \u547d\u4ee4\uff09\uff0c\u6216\u8005\u4f7f\u7528\u4e0a\u9762\u9078\u9805 2 \u4e2d\u63cf\u8ff0\u7684 GitOps \u65b9\u6cd5\u3002","title":"\u66f4\u65b0\u8b66\u5831\u898f\u5247\u548c\u5100\u8868\u677f"},{"location":"kubernetes/observability/concept/observability-prometheus-guide-part6/#_4","text":"\u4e00\u958b\u59cb\uff0c\u8b93\u6574\u500b Prometheus \u5806\u68e7\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u904b\u884c\u78ba\u5be6\u9700\u8981\u4e00\u4e9b\u6642\u9593\u3002\u60a8\u5fc5\u9808\u7fd2\u6163 Prometheus operator \u7684\u6982\u5ff5\uff0c\u800c\u4e0d\u662f\u624b\u52d5\u7de8\u5beb\u914d\u7f6e\u6587\u4ef6\u3002\u5f9e\u597d\u7684\u65b9\u9762\u4f86\u8aaa\uff0cPrometheus operator \u8207 kube-prometheus \u9805\u76ee\u63d0\u4f9b\u7684\u6a21\u677f\u76f8\u7d50\u5408\uff0c\u53ef\u4ee5\u6e1b\u8f15\u60a8\u7684\u8ca0\u64d4\u3002 \u5982\u679c\u60a8\u9047\u5230\u554f\u984c\uff0c\u6211\u5efa\u8b70\u60a8\u505a\u5169\u4ef6\u4e8b\uff1a \u67e5\u770b GitHub \u4e0a\u7684 Prometheus operator \u6587\u6a94\u6587\u4ef6 \u901a\u904e\u67e5\u770b\u5b83\u5728\u96c6\u7fa4\u4e2d\u5275\u5efa\u7684 CR\uff08Prometheus\u3001Alertmanager \u7b49\uff09\uff0c\u4e86\u89e3 kube-prometheus-stack Helm chart \u5982\u4f55\u914d\u7f6e\u9ed8\u8a8d\u503c\u3002","title":"\u7d50\u8ad6"},{"location":"kubernetes/observability/day2-ops/day2-challenges/","text":"\u4ec0\u9ebc\u662f Kubernetes Day 2? \u00b6 \u539f\u6587: What is Day 2 Kubernetes? \u7576\u7d44\u7e54\u9077\u79fb\u5230 Kubernetes \u6642\uff0c\u6700\u660e\u986f\u3001\u6700\u7dca\u8feb\u7684\u6311\u6230\u8207 Day 0 \u548c Day 1 \u6709\u95dc\u2014\u2014 \u8a2d\u8a08 \u548c \u90e8\u7f72 \u3002\u63a8\u52d5 Kubernetes \u7684\u52d5\u529b\u901a\u5e38\u662f\u5e0c\u671b\u63d0\u9ad8\u958b\u767c\u4eba\u54e1\u7684\u654f\u6377\u6027\u3001\u63d0\u9ad8\u958b\u767c\u901f\u5ea6\uff0c\u4e26\u901a\u904e\u8b93\u958b\u767c\u4eba\u54e1\u8a2a\u554f\u81ea\u52a9\u670d\u52d9\u914d\u7f6e\u4f86\u6d88\u200b\u200b\u9664\u958b\u767c\u904e\u7a0b\u4e2d\u7684\u6469\u64e6\u3002\u9451\u65bc\u9019\u4e9b\u52d5\u6a5f\uff0c\u91cd\u9ede\u5f80\u5f80\u653e\u5728\u958b\u767c\u968e\u6bb5\u4e5f\u5c31\u4e0d\u8db3\u70ba\u5947\u4e86\u3002 \u4f8b\u5982\uff0c\u8a31\u591a\u7d44\u7e54\u78ba\u5be6\u770b\u5230\u4e86\u901f\u5ea6\u548c\u654f\u6377\u6027\u7684\u986f\u8457\u63d0\u9ad8\uff0c\u5f9e\u6bcf\u6708\u90e8\u7f72\u8f49\u8b8a\u70ba\u6bcf\u65e5\u90e8\u7f72\u3002\u4f46\u662f\u61c9\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u9031\u671f\u4e0d\u6703\u5728\u90e8\u7f72\u6642\u7d50\u675f\u3002\u4efb\u4f55\u61c9\u7528\u7a0b\u5e8f\u6700\u9577\u7684\u751f\u547d\u9031\u671f\u968e\u6bb5\u662f\u9700\u8981\u5c0d\u5176\u9032\u884c\u76e3\u63a7\u3001\u5347\u7d1a\u548c\u4fdd\u8b77\u7684\u751f\u7522\u968e\u6bb5\u3002\u9019\u4e9b Day 2 Kubernetes \u64cd\u4f5c\u5c0d\u65bc Kubernetes \u7684\u6301\u7e8c\u6210\u529f\u81f3\u95dc\u91cd\u8981\uff0c\u4f46\u5728\u6025\u65bc\u90e8\u7f72\u6642\u53ef\u80fd\u6703\u88ab\u5ffd\u7565\u3002 \u5ffd\u7565 Day 2 \u6700\u7d42\u6703\u6bc0\u6389 Kubernetes \u8a08\u5283\uff0c\u963b\u6b62\u7d44\u7e54\u5229\u7528\u654f\u6377\u6027\u548c\u52a0\u901f\u96f2\u539f\u751f\u7522\u54c1\u3002\u7279\u5225\u662f\u5c0d\u65bc\u4f01\u696d\u74b0\u5883\u4e2d\u7684\u4efb\u52d9\u95dc\u9375\u578b\u61c9\u7528\u7a0b\u5e8f\uff0c\u53ef\u9760\u6027\u3001\u53ef\u7528\u6027\u3001\u98a8\u96aa\u7ba1\u7406\u548c\u76e3\u63a7\u4e0d\u662f\u53ef\u9078\u7684\u3002\u4e8b\u4ef6\u592a\u591a\uff0cKubernetes \u5be6\u9a57\u5f88\u53ef\u80fd\u88ab\u53d6\u6d88\u3002 \u9077\u79fb\u5230 Kubernetes \u4e5f\u4e0d\u662f\u6191\u7a7a\u800c\u4f86\u7684\u3002\u5b83\u901a\u5e38\u4f34\u96a8\u8457\u5411\u6df7\u5408\u548c\u591a\u96f2\u74b0\u5883\u7684\u8f49\u8b8a\uff1b\u901a\u5e38\u6bcf\u500b\u74b0\u5883\u90fd\u6709\u7565\u5fae\u4e0d\u540c\u7684\u914d\u7f6e\u8981\u6c42\u548c\u64cd\u4f5c\u9700\u6c42\u3002 Kubernetes \u672c\u8eab\u5f88\u8907\u96dc\uff0c\u4e26\u4e14\u5728\u898f\u6a21\u4e0a\u53ef\u80fd\u6d89\u53ca\u7ba1\u7406\u5206\u4f48\u5728\u591a\u500b\u96f2\u4e2d\u7684\u8a31\u591a\u96c6\u7fa4\u3002\u6b64\u5916\uff0cKubernetes \u4e26\u4e0d\u662f\u55ae\u7368\u4f7f\u7528\u7684\u3002\u5927\u591a\u6578\u516c\u53f8\u4f7f\u7528\u6578\u5341\u7a2e\u9644\u52a0\u5de5\u5177\u4f86\u7ba1\u7406\u5f9e CI/CD \u7ba1\u9053\u5230\u76e3\u63a7\u7684\u6240\u6709\u5167\u5bb9\u3002\u9019\u53ef\u80fd\u5c0e\u81f4\u5100\u8868\u677f\u7684\u6fc0\u589e\uff0c\u5f9e\u800c\u4f7f\u64cd\u4f5c\u6545\u4e8b\u9032\u4e00\u6b65\u8907\u96dc\u5316\uff0c\u4e26\u4e14\u96e3\u4ee5\u8f15\u9b06\u4e86\u89e3\u7cfb\u7d71\u7684\u5065\u5eb7\u72c0\u6cc1\u3002 Day 2 \u6311\u6230 - Kubernetes Operations \u00b6 \u4ee5\u4e0b\u662f\u516c\u53f8\u5728\u4f7f\u7528 Kubernetes \u6642\u9047\u5230\u7684\u4e00\u4e9b\u6700\u5e38\u898b\u7684 Day2 \u9677\u9631\u3002 Health and Availability - \u7279\u5225\u662f\u5c0d\u65bc\u4efb\u52d9\u95dc\u9375\u578b\u61c9\u7528\u7a0b\u5e8f\uff0c\u6eff\u8db3\u6b63\u5e38\u904b\u884c\u6642\u9593 SLA \u7684\u80fd\u529b\u65e2\u91cd\u8981\u53c8\u5177\u6709\u6311\u6230\u6027\uff0c\u5c24\u5176\u662f\u96a8\u8457\u8907\u96dc\u6027\u7684\u589e\u52a0\u548c\u7d44\u7e54\u52aa\u529b\u69cb\u5efa\u78ba\u4fdd\u9ad8\u53ef\u7528\u6027\u6240\u9700\u7684\u7279\u5b9a\u65bc Kubernetes \u7684\u6280\u80fd\u3002 Monitoring and logging - \u7d44\u7e54\u9700\u8981\u80fd\u5920\u8de8\u96c6\u7fa4\u548c\u5de5\u4f5c\u8ca0\u8f09\u5de5\u4f5c\u7684\u76e3\u63a7\u548c\u65e5\u8a8c\u5de5\u5177\uff0c\u4ee5\u4fbf\u5f9e Kubernetes \u90e8\u7f72\u4e2d\u7372\u53d6\u4ed6\u5011\u9700\u8981\u7684\u4fe1\u606f\uff0c\u800c\u50b3\u7d71\u7684\u76e3\u63a7\u5de5\u5177\u901a\u5e38\u7121\u6cd5\u505a\u5230\u9019\u4e00\u9ede\u3002 CI/CD integration - \u6578\u91cf\u9a5a\u4eba\u7684 Kubernetes \u65b0\u7528\u6236\u5728\u5f04\u6e05\u695a\u5982\u4f55\u70ba\u61c9\u7528\u7a0b\u5e8f\u6295\u5165\u751f\u7522\u92ea\u5e73\u9053\u8def\u6642\u9047\u5230\u4e86\u56f0\u96e3\u3002\u8207 DevOps \u5de5\u4f5c\u6d41\u548c CI/CD \u7684\u96c6\u6210\u5c0d\u65bc\u7372\u5f97\u958b\u767c\u4eba\u54e1\u654f\u6377\u6027\u548c\u7d44\u7e54\u5f9e Kubernetes \u4e2d\u5c0b\u627e\u7684\u901f\u5ea6\u81f3\u95dc\u91cd\u8981\u3002 Platform management - \u5728\u4f01\u696d\u74b0\u5883\u4e2d\uff0c\u5c07\u96c6\u7fa4 add-ons \u4f5c\u70ba\u5171\u4eab\u5e73\u53f0\u670d\u52d9\u63d0\u4f9b\u548c\u7ba1\u7406\uff0c\u5305\u62ec\u8a2d\u7f6e\u8ca0\u8f09\u5e73\u8861\uff0c\u662f\u4e00\u9805\u6311\u6230\u3002\u9664\u975e\u6709\u5de5\u5177\u5141\u8a31\u958b\u767c\u4eba\u54e1\u81ea\u5df1\u7ba1\u7406\u9019\u500b\u904e\u7a0b\uff0c\u5426\u5247\u5b83\u4e5f\u53ef\u80fd\u6210\u70ba\u958b\u767c\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u7684\u4e00\u500b\u6469\u64e6\u9ede\u3002 \u5b89\u5168\u548c\u6cbb\u7406 - \u7d44\u7e54\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u4f86\u78ba\u4fdd\u5c0d\u751f\u7522\u4e2d\u7684\u4efb\u4f55\u5de5\u4f5c\u8ca0\u8f09\u5be6\u65bd\u5b89\u5168\u6700\u4f73\u5be6\u8e10\u548c\u7d44\u7e54\u6cbb\u7406\u7b56\u7565\u3002 Kubernetes \u7684\u5206\u4f48\u5f0f\u7279\u6027\u2014\u2014\u4ee5\u53ca\u5b83\u901a\u5e38\u914d\u5408\u4f7f\u7528\u7684\u5feb\u901f\u3001DevOps \u98a8\u683c\u7684\u4ea4\u4ed8\u65b9\u6cd5\u2014\u2014\u4f7f\u5f97\u9019\u5177\u6709\u6311\u6230\u6027\uff0c\u9664\u975e guardrails \u8a2d\u8a08\u5230\u4f4d\u4e26\u4e14\u4e2d\u592e\u5e73\u53f0\u5718\u968a\u540c\u6642\u5177\u6709\u53ef\u898b\u6027\u548c\u63a7\u5236\u6b0a\u3002 Kubernetes Day 2 \u7ba1\u7406\u904b\u71df\u7684\u6838\u5fc3\u6311\u6230\u6b78\u7d50\u70ba\u7ba1\u7406\u8907\u96dc\u6027\u3002\u904b\u71df\u5718\u968a\u9700\u8981\u914d\u7f6e\u7684\u65cb\u9215\u592a\u591a\uff0c\u4f7f\u7528\u7684\u5de5\u5177\u592a\u591a\uff0c\u7121\u6cd5\u5728\u6c92\u6709\u96c6\u6210\u5e73\u53f0\u5e6b\u52a9\u7684\u60c5\u6cc1\u4e0b\u6709\u6548\u78ba\u4fdd\u6b63\u78ba\u914d\u7f6e\u3001\u7406\u89e3\u65e5\u8a8c\u4e26\u70ba\u958b\u767c\u4eba\u54e1\u69cb\u5efa\u81ea\u52a9\u670d\u52d9\u80fd\u529b\u3002 \u99b4\u670d\u64cd\u4f5c\u8907\u96dc\u6027 \u00b6 \u96a8\u8457\u898f\u6a21\u7684\u64f4\u5927\uff0c\u96f2\u539f\u751f\u7cfb\u7d71\u8b8a\u5f97\u66f4\u52a0\u8907\u96dc\u3002\u591a\u500b\u96c6\u7fa4\u3001\u5de5\u5177\u3001\u5408\u898f\u6846\u67b6\u3001\u696d\u52d9\u90e8\u9580\u548c\u96f2\u74b0\u5883\u7684\u7d44\u5408\u5f88\u5feb\u5c31\u6703\u8b8a\u5f97\u904e\u65bc\u5fa9\u96dc\uff0c\u7121\u6cd5\u9032\u884c\u53ef\u8996\u5316\u6216\u7ba1\u7406\u3002\u4ee5\u4e0b\u662f\u7d44\u7e54\u5728 Kubernetes Day2 \u904b\u71df\u4e2d\u53d6\u5f97\u6210\u529f\u6240\u9700\u7684\u4e00\u4e9b\u7d44\u4ef6\u3002 A single pane of glass platform - \u904b\u71df\u5718\u968a\u9700\u8981\u80fd\u5920\u901a\u904e\u4e00\u500b\u7d71\u4e00\u7684\u5100\u8868\u677f\u5728\u4e00\u500b\u5730\u65b9\u53ef\u8996\u5316\u6574\u500b\u7cfb\u7d71\u3002\u9700\u8981\u5c07\u96b1\u85cf\u5728\u6578\u5341\u7a2e\u4e0d\u540c\u5de5\u5177\u4e2d\u7684\u4fe1\u606f\u96c6\u4e2d\u5230\u4e00\u500b\u5730\u65b9\uff0c\u4ee5\u4fbf\u5718\u968a\u53ef\u4ee5\u8f15\u9b06\u67e5\u770b\u4e0d\u540c\u4fe1\u865f\u4e4b\u9593\u7684\u95dc\u4fc2\uff0c\u4e26\u5728\u5e7e\u5206\u9418\u5167\u4e86\u89e3\u7cfb\u7d71\u7684\u7e3d\u9ad4\u5065\u5eb7\u72c0\u6cc1\u3002 Complete separation of concerns - \u61c9\u7528\u7a0b\u5e8f\u958b\u767c\u4eba\u54e1\u61c9\u8a72\u80fd\u5920\u76e1\u53ef\u80fd\u5730\u81ea\u52a9\u670d\u52d9\uff0c\u4f9d\u9760\u4e00\u5c0f\u7fa4\u5e73\u53f0\u5de5\u7a0b\u5e2b\u4f86\u7ba1\u7406\u5e95\u5c64\u64cd\u4f5c\u7cfb\u7d71\u3002 Centralized policy controls - \u904b\u71df\u5718\u968a\u9700\u8981\u4e00\u7a2e\u96c6\u4e2d\u63a7\u5236\u96c6\u7fa4\u548c\u5de5\u4f5c\u8ca0\u8f09\u7b56\u7565\u7684\u65b9\u6cd5\uff0c\u4ee5\u78ba\u4fdd\u6839\u64da\u7d44\u7e54\u570d\u7e5e\u5b89\u5168\u6027\u3001\u5408\u898f\u6027\u548c\u5176\u4ed6\u6700\u4f73\u5be6\u8e10\u7684\u7b56\u7565\u914d\u7f6e Kubernetes \u548c\u5bb9\u5668\u3002\u5982\u679c\u6c92\u6709\u96c6\u4e2d\u7ba1\u7406\u7b56\u7565\u7684\u80fd\u529b\uff0c\u932f\u8aa4\u5e7e\u4e4e\u662f\u4e0d\u53ef\u907f\u514d\u7684\u3002 Kubernetes-native monitoring and logging for security and availability - \u4e2d\u592e\u7ba1\u7406\u9762\u677f\u5fc5\u9808\u5305\u542b\u5f37\u5927\u7684\u76e3\u63a7\u529f\u80fd\uff0c\u9019\u4e9b\u529f\u80fd\u65e8\u5728\u5728\u96f2\u539f\u751f\u74b0\u5883\u4e2d\u5de5\u4f5c\u3002\u904b\u71df\u5546\u9700\u8981\u80fd\u5920\u76e3\u63a7\u6f5b\u5728\u7684\u5b89\u5168\u6f0f\u6d1e\u4ee5\u53ca\u6027\u80fd\u548c\u53ef\u7528\u6027\u554f\u984c\u3002 Resource utilization tools - \u8a31\u591a\u7d44\u7e54\u5e0c\u671b\u901a\u904e\u9077\u79fb\u5230\u96f2\u539f\u751f\u4f86\u6e1b\u5c11\u5176 IT \u652f\u51fa\u2014\u2014\u8a31\u591a\u4eba\u9a5a\u8a1d\u5730\u767c\u73fe\u9077\u79fb\u5230\u96f2\u4e26\u4e0d\u7e3d\u80fd\u964d\u4f4e\u6210\u672c\u3002Kubernetes Day2 \u7ba1\u7406\u904b\u71df\u5fc5\u9808\u5305\u62ec\u5e6b\u52a9\u516c\u53f8\u4e86\u89e3\u5176\u6210\u672c\u3001\u512a\u5316\u8cc7\u6e90\u5229\u7528\u7387\u4e26\u6700\u7d42\u964d\u4f4e\u7e3d\u9ad4\u6210\u672c\u7684\u5de5\u5177\u3002 \u66f4\u597d\u7684 Kubernetes Day2 \u00b6 \u958b\u59cb\u8003\u616e Day2 \u7684\u904b\u71df\u6c38\u9060\u4e0d\u6703\u592a\u65e9\u3002\u7d44\u7e54\u5728\u8a2d\u8a08\u548c\u5be6\u65bd\u968e\u6bb5\u505a\u51fa\u7684\u9078\u64c7\u5728 Day2 \u6703\u7522\u751f\u5de8\u5927\u7684\u5f71\u97ff\u3002\u4e0d\u50c5\u76e3\u63a7\u5de5\u5177\u548c\u96c6\u4e2d\u63a7\u5236\u61c9\u5728\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u4e4b\u524d\u5c31\u4f4d\uff0c\u800c\u4e14\u70ba\u61c9\u7528\u7a0b\u5e8f\u958b\u767c\u4eba\u54e1\u5efa\u7acb\u6b63\u78ba\u7684\u8b77\u6b04\u90fd\u53ef\u4ee5\u6e1b\u5c11\u958b\u767c\u6469\u64e6\u540c\u6642\u9084\u7c21\u5316\u4e86\u672a\u4f86\u7684\u904b\u71df\u3002","title":"Day2 \u7684\u6311\u6230"},{"location":"kubernetes/observability/day2-ops/day2-challenges/#kubernetes-day-2","text":"\u539f\u6587: What is Day 2 Kubernetes? \u7576\u7d44\u7e54\u9077\u79fb\u5230 Kubernetes \u6642\uff0c\u6700\u660e\u986f\u3001\u6700\u7dca\u8feb\u7684\u6311\u6230\u8207 Day 0 \u548c Day 1 \u6709\u95dc\u2014\u2014 \u8a2d\u8a08 \u548c \u90e8\u7f72 \u3002\u63a8\u52d5 Kubernetes \u7684\u52d5\u529b\u901a\u5e38\u662f\u5e0c\u671b\u63d0\u9ad8\u958b\u767c\u4eba\u54e1\u7684\u654f\u6377\u6027\u3001\u63d0\u9ad8\u958b\u767c\u901f\u5ea6\uff0c\u4e26\u901a\u904e\u8b93\u958b\u767c\u4eba\u54e1\u8a2a\u554f\u81ea\u52a9\u670d\u52d9\u914d\u7f6e\u4f86\u6d88\u200b\u200b\u9664\u958b\u767c\u904e\u7a0b\u4e2d\u7684\u6469\u64e6\u3002\u9451\u65bc\u9019\u4e9b\u52d5\u6a5f\uff0c\u91cd\u9ede\u5f80\u5f80\u653e\u5728\u958b\u767c\u968e\u6bb5\u4e5f\u5c31\u4e0d\u8db3\u70ba\u5947\u4e86\u3002 \u4f8b\u5982\uff0c\u8a31\u591a\u7d44\u7e54\u78ba\u5be6\u770b\u5230\u4e86\u901f\u5ea6\u548c\u654f\u6377\u6027\u7684\u986f\u8457\u63d0\u9ad8\uff0c\u5f9e\u6bcf\u6708\u90e8\u7f72\u8f49\u8b8a\u70ba\u6bcf\u65e5\u90e8\u7f72\u3002\u4f46\u662f\u61c9\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u9031\u671f\u4e0d\u6703\u5728\u90e8\u7f72\u6642\u7d50\u675f\u3002\u4efb\u4f55\u61c9\u7528\u7a0b\u5e8f\u6700\u9577\u7684\u751f\u547d\u9031\u671f\u968e\u6bb5\u662f\u9700\u8981\u5c0d\u5176\u9032\u884c\u76e3\u63a7\u3001\u5347\u7d1a\u548c\u4fdd\u8b77\u7684\u751f\u7522\u968e\u6bb5\u3002\u9019\u4e9b Day 2 Kubernetes \u64cd\u4f5c\u5c0d\u65bc Kubernetes \u7684\u6301\u7e8c\u6210\u529f\u81f3\u95dc\u91cd\u8981\uff0c\u4f46\u5728\u6025\u65bc\u90e8\u7f72\u6642\u53ef\u80fd\u6703\u88ab\u5ffd\u7565\u3002 \u5ffd\u7565 Day 2 \u6700\u7d42\u6703\u6bc0\u6389 Kubernetes \u8a08\u5283\uff0c\u963b\u6b62\u7d44\u7e54\u5229\u7528\u654f\u6377\u6027\u548c\u52a0\u901f\u96f2\u539f\u751f\u7522\u54c1\u3002\u7279\u5225\u662f\u5c0d\u65bc\u4f01\u696d\u74b0\u5883\u4e2d\u7684\u4efb\u52d9\u95dc\u9375\u578b\u61c9\u7528\u7a0b\u5e8f\uff0c\u53ef\u9760\u6027\u3001\u53ef\u7528\u6027\u3001\u98a8\u96aa\u7ba1\u7406\u548c\u76e3\u63a7\u4e0d\u662f\u53ef\u9078\u7684\u3002\u4e8b\u4ef6\u592a\u591a\uff0cKubernetes \u5be6\u9a57\u5f88\u53ef\u80fd\u88ab\u53d6\u6d88\u3002 \u9077\u79fb\u5230 Kubernetes \u4e5f\u4e0d\u662f\u6191\u7a7a\u800c\u4f86\u7684\u3002\u5b83\u901a\u5e38\u4f34\u96a8\u8457\u5411\u6df7\u5408\u548c\u591a\u96f2\u74b0\u5883\u7684\u8f49\u8b8a\uff1b\u901a\u5e38\u6bcf\u500b\u74b0\u5883\u90fd\u6709\u7565\u5fae\u4e0d\u540c\u7684\u914d\u7f6e\u8981\u6c42\u548c\u64cd\u4f5c\u9700\u6c42\u3002 Kubernetes \u672c\u8eab\u5f88\u8907\u96dc\uff0c\u4e26\u4e14\u5728\u898f\u6a21\u4e0a\u53ef\u80fd\u6d89\u53ca\u7ba1\u7406\u5206\u4f48\u5728\u591a\u500b\u96f2\u4e2d\u7684\u8a31\u591a\u96c6\u7fa4\u3002\u6b64\u5916\uff0cKubernetes \u4e26\u4e0d\u662f\u55ae\u7368\u4f7f\u7528\u7684\u3002\u5927\u591a\u6578\u516c\u53f8\u4f7f\u7528\u6578\u5341\u7a2e\u9644\u52a0\u5de5\u5177\u4f86\u7ba1\u7406\u5f9e CI/CD \u7ba1\u9053\u5230\u76e3\u63a7\u7684\u6240\u6709\u5167\u5bb9\u3002\u9019\u53ef\u80fd\u5c0e\u81f4\u5100\u8868\u677f\u7684\u6fc0\u589e\uff0c\u5f9e\u800c\u4f7f\u64cd\u4f5c\u6545\u4e8b\u9032\u4e00\u6b65\u8907\u96dc\u5316\uff0c\u4e26\u4e14\u96e3\u4ee5\u8f15\u9b06\u4e86\u89e3\u7cfb\u7d71\u7684\u5065\u5eb7\u72c0\u6cc1\u3002","title":"\u4ec0\u9ebc\u662f Kubernetes  Day 2?"},{"location":"kubernetes/observability/day2-ops/day2-challenges/#day-2-kubernetes-operations","text":"\u4ee5\u4e0b\u662f\u516c\u53f8\u5728\u4f7f\u7528 Kubernetes \u6642\u9047\u5230\u7684\u4e00\u4e9b\u6700\u5e38\u898b\u7684 Day2 \u9677\u9631\u3002 Health and Availability - \u7279\u5225\u662f\u5c0d\u65bc\u4efb\u52d9\u95dc\u9375\u578b\u61c9\u7528\u7a0b\u5e8f\uff0c\u6eff\u8db3\u6b63\u5e38\u904b\u884c\u6642\u9593 SLA \u7684\u80fd\u529b\u65e2\u91cd\u8981\u53c8\u5177\u6709\u6311\u6230\u6027\uff0c\u5c24\u5176\u662f\u96a8\u8457\u8907\u96dc\u6027\u7684\u589e\u52a0\u548c\u7d44\u7e54\u52aa\u529b\u69cb\u5efa\u78ba\u4fdd\u9ad8\u53ef\u7528\u6027\u6240\u9700\u7684\u7279\u5b9a\u65bc Kubernetes \u7684\u6280\u80fd\u3002 Monitoring and logging - \u7d44\u7e54\u9700\u8981\u80fd\u5920\u8de8\u96c6\u7fa4\u548c\u5de5\u4f5c\u8ca0\u8f09\u5de5\u4f5c\u7684\u76e3\u63a7\u548c\u65e5\u8a8c\u5de5\u5177\uff0c\u4ee5\u4fbf\u5f9e Kubernetes \u90e8\u7f72\u4e2d\u7372\u53d6\u4ed6\u5011\u9700\u8981\u7684\u4fe1\u606f\uff0c\u800c\u50b3\u7d71\u7684\u76e3\u63a7\u5de5\u5177\u901a\u5e38\u7121\u6cd5\u505a\u5230\u9019\u4e00\u9ede\u3002 CI/CD integration - \u6578\u91cf\u9a5a\u4eba\u7684 Kubernetes \u65b0\u7528\u6236\u5728\u5f04\u6e05\u695a\u5982\u4f55\u70ba\u61c9\u7528\u7a0b\u5e8f\u6295\u5165\u751f\u7522\u92ea\u5e73\u9053\u8def\u6642\u9047\u5230\u4e86\u56f0\u96e3\u3002\u8207 DevOps \u5de5\u4f5c\u6d41\u548c CI/CD \u7684\u96c6\u6210\u5c0d\u65bc\u7372\u5f97\u958b\u767c\u4eba\u54e1\u654f\u6377\u6027\u548c\u7d44\u7e54\u5f9e Kubernetes \u4e2d\u5c0b\u627e\u7684\u901f\u5ea6\u81f3\u95dc\u91cd\u8981\u3002 Platform management - \u5728\u4f01\u696d\u74b0\u5883\u4e2d\uff0c\u5c07\u96c6\u7fa4 add-ons \u4f5c\u70ba\u5171\u4eab\u5e73\u53f0\u670d\u52d9\u63d0\u4f9b\u548c\u7ba1\u7406\uff0c\u5305\u62ec\u8a2d\u7f6e\u8ca0\u8f09\u5e73\u8861\uff0c\u662f\u4e00\u9805\u6311\u6230\u3002\u9664\u975e\u6709\u5de5\u5177\u5141\u8a31\u958b\u767c\u4eba\u54e1\u81ea\u5df1\u7ba1\u7406\u9019\u500b\u904e\u7a0b\uff0c\u5426\u5247\u5b83\u4e5f\u53ef\u80fd\u6210\u70ba\u958b\u767c\u5de5\u4f5c\u6d41\u7a0b\u4e2d\u7684\u4e00\u500b\u6469\u64e6\u9ede\u3002 \u5b89\u5168\u548c\u6cbb\u7406 - \u7d44\u7e54\u9700\u8981\u4e00\u7a2e\u65b9\u6cd5\u4f86\u78ba\u4fdd\u5c0d\u751f\u7522\u4e2d\u7684\u4efb\u4f55\u5de5\u4f5c\u8ca0\u8f09\u5be6\u65bd\u5b89\u5168\u6700\u4f73\u5be6\u8e10\u548c\u7d44\u7e54\u6cbb\u7406\u7b56\u7565\u3002 Kubernetes \u7684\u5206\u4f48\u5f0f\u7279\u6027\u2014\u2014\u4ee5\u53ca\u5b83\u901a\u5e38\u914d\u5408\u4f7f\u7528\u7684\u5feb\u901f\u3001DevOps \u98a8\u683c\u7684\u4ea4\u4ed8\u65b9\u6cd5\u2014\u2014\u4f7f\u5f97\u9019\u5177\u6709\u6311\u6230\u6027\uff0c\u9664\u975e guardrails \u8a2d\u8a08\u5230\u4f4d\u4e26\u4e14\u4e2d\u592e\u5e73\u53f0\u5718\u968a\u540c\u6642\u5177\u6709\u53ef\u898b\u6027\u548c\u63a7\u5236\u6b0a\u3002 Kubernetes Day 2 \u7ba1\u7406\u904b\u71df\u7684\u6838\u5fc3\u6311\u6230\u6b78\u7d50\u70ba\u7ba1\u7406\u8907\u96dc\u6027\u3002\u904b\u71df\u5718\u968a\u9700\u8981\u914d\u7f6e\u7684\u65cb\u9215\u592a\u591a\uff0c\u4f7f\u7528\u7684\u5de5\u5177\u592a\u591a\uff0c\u7121\u6cd5\u5728\u6c92\u6709\u96c6\u6210\u5e73\u53f0\u5e6b\u52a9\u7684\u60c5\u6cc1\u4e0b\u6709\u6548\u78ba\u4fdd\u6b63\u78ba\u914d\u7f6e\u3001\u7406\u89e3\u65e5\u8a8c\u4e26\u70ba\u958b\u767c\u4eba\u54e1\u69cb\u5efa\u81ea\u52a9\u670d\u52d9\u80fd\u529b\u3002","title":"Day 2 \u6311\u6230 - Kubernetes Operations"},{"location":"kubernetes/observability/day2-ops/day2-challenges/#_1","text":"\u96a8\u8457\u898f\u6a21\u7684\u64f4\u5927\uff0c\u96f2\u539f\u751f\u7cfb\u7d71\u8b8a\u5f97\u66f4\u52a0\u8907\u96dc\u3002\u591a\u500b\u96c6\u7fa4\u3001\u5de5\u5177\u3001\u5408\u898f\u6846\u67b6\u3001\u696d\u52d9\u90e8\u9580\u548c\u96f2\u74b0\u5883\u7684\u7d44\u5408\u5f88\u5feb\u5c31\u6703\u8b8a\u5f97\u904e\u65bc\u5fa9\u96dc\uff0c\u7121\u6cd5\u9032\u884c\u53ef\u8996\u5316\u6216\u7ba1\u7406\u3002\u4ee5\u4e0b\u662f\u7d44\u7e54\u5728 Kubernetes Day2 \u904b\u71df\u4e2d\u53d6\u5f97\u6210\u529f\u6240\u9700\u7684\u4e00\u4e9b\u7d44\u4ef6\u3002 A single pane of glass platform - \u904b\u71df\u5718\u968a\u9700\u8981\u80fd\u5920\u901a\u904e\u4e00\u500b\u7d71\u4e00\u7684\u5100\u8868\u677f\u5728\u4e00\u500b\u5730\u65b9\u53ef\u8996\u5316\u6574\u500b\u7cfb\u7d71\u3002\u9700\u8981\u5c07\u96b1\u85cf\u5728\u6578\u5341\u7a2e\u4e0d\u540c\u5de5\u5177\u4e2d\u7684\u4fe1\u606f\u96c6\u4e2d\u5230\u4e00\u500b\u5730\u65b9\uff0c\u4ee5\u4fbf\u5718\u968a\u53ef\u4ee5\u8f15\u9b06\u67e5\u770b\u4e0d\u540c\u4fe1\u865f\u4e4b\u9593\u7684\u95dc\u4fc2\uff0c\u4e26\u5728\u5e7e\u5206\u9418\u5167\u4e86\u89e3\u7cfb\u7d71\u7684\u7e3d\u9ad4\u5065\u5eb7\u72c0\u6cc1\u3002 Complete separation of concerns - \u61c9\u7528\u7a0b\u5e8f\u958b\u767c\u4eba\u54e1\u61c9\u8a72\u80fd\u5920\u76e1\u53ef\u80fd\u5730\u81ea\u52a9\u670d\u52d9\uff0c\u4f9d\u9760\u4e00\u5c0f\u7fa4\u5e73\u53f0\u5de5\u7a0b\u5e2b\u4f86\u7ba1\u7406\u5e95\u5c64\u64cd\u4f5c\u7cfb\u7d71\u3002 Centralized policy controls - \u904b\u71df\u5718\u968a\u9700\u8981\u4e00\u7a2e\u96c6\u4e2d\u63a7\u5236\u96c6\u7fa4\u548c\u5de5\u4f5c\u8ca0\u8f09\u7b56\u7565\u7684\u65b9\u6cd5\uff0c\u4ee5\u78ba\u4fdd\u6839\u64da\u7d44\u7e54\u570d\u7e5e\u5b89\u5168\u6027\u3001\u5408\u898f\u6027\u548c\u5176\u4ed6\u6700\u4f73\u5be6\u8e10\u7684\u7b56\u7565\u914d\u7f6e Kubernetes \u548c\u5bb9\u5668\u3002\u5982\u679c\u6c92\u6709\u96c6\u4e2d\u7ba1\u7406\u7b56\u7565\u7684\u80fd\u529b\uff0c\u932f\u8aa4\u5e7e\u4e4e\u662f\u4e0d\u53ef\u907f\u514d\u7684\u3002 Kubernetes-native monitoring and logging for security and availability - \u4e2d\u592e\u7ba1\u7406\u9762\u677f\u5fc5\u9808\u5305\u542b\u5f37\u5927\u7684\u76e3\u63a7\u529f\u80fd\uff0c\u9019\u4e9b\u529f\u80fd\u65e8\u5728\u5728\u96f2\u539f\u751f\u74b0\u5883\u4e2d\u5de5\u4f5c\u3002\u904b\u71df\u5546\u9700\u8981\u80fd\u5920\u76e3\u63a7\u6f5b\u5728\u7684\u5b89\u5168\u6f0f\u6d1e\u4ee5\u53ca\u6027\u80fd\u548c\u53ef\u7528\u6027\u554f\u984c\u3002 Resource utilization tools - \u8a31\u591a\u7d44\u7e54\u5e0c\u671b\u901a\u904e\u9077\u79fb\u5230\u96f2\u539f\u751f\u4f86\u6e1b\u5c11\u5176 IT \u652f\u51fa\u2014\u2014\u8a31\u591a\u4eba\u9a5a\u8a1d\u5730\u767c\u73fe\u9077\u79fb\u5230\u96f2\u4e26\u4e0d\u7e3d\u80fd\u964d\u4f4e\u6210\u672c\u3002Kubernetes Day2 \u7ba1\u7406\u904b\u71df\u5fc5\u9808\u5305\u62ec\u5e6b\u52a9\u516c\u53f8\u4e86\u89e3\u5176\u6210\u672c\u3001\u512a\u5316\u8cc7\u6e90\u5229\u7528\u7387\u4e26\u6700\u7d42\u964d\u4f4e\u7e3d\u9ad4\u6210\u672c\u7684\u5de5\u5177\u3002","title":"\u99b4\u670d\u64cd\u4f5c\u8907\u96dc\u6027"},{"location":"kubernetes/observability/day2-ops/day2-challenges/#kubernetes-day2","text":"\u958b\u59cb\u8003\u616e Day2 \u7684\u904b\u71df\u6c38\u9060\u4e0d\u6703\u592a\u65e9\u3002\u7d44\u7e54\u5728\u8a2d\u8a08\u548c\u5be6\u65bd\u968e\u6bb5\u505a\u51fa\u7684\u9078\u64c7\u5728 Day2 \u6703\u7522\u751f\u5de8\u5927\u7684\u5f71\u97ff\u3002\u4e0d\u50c5\u76e3\u63a7\u5de5\u5177\u548c\u96c6\u4e2d\u63a7\u5236\u61c9\u5728\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\u4e4b\u524d\u5c31\u4f4d\uff0c\u800c\u4e14\u70ba\u61c9\u7528\u7a0b\u5e8f\u958b\u767c\u4eba\u54e1\u5efa\u7acb\u6b63\u78ba\u7684\u8b77\u6b04\u90fd\u53ef\u4ee5\u6e1b\u5c11\u958b\u767c\u6469\u64e6\u540c\u6642\u9084\u7c21\u5316\u4e86\u672a\u4f86\u7684\u904b\u71df\u3002","title":"\u66f4\u597d\u7684 Kubernetes Day2"},{"location":"kubernetes/observability/day2-ops/day2-definition/","text":"Day2 Operation \u7684\u5b9a\u7fa9 \u00b6 \u539f\u6587: Defining Day-2 Operations Day2 Operation \u662f\u7cfb\u7d71\u70ba\u7d44\u7e54\u751f\u6210\u7d50\u679c\u7684\u5730\u65b9\u3002\u56e0\u6b64\uff0c\u5728 Day2 Operation \u4e2d\u4e0d\u65b7\u5c0b\u6c42\u6539\u9032\uff0c\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8\u6536\u76ca\u3002 Day2 Operation \u4e0d\u4e00\u5b9a\u662f\u6307\u7b2c 2 \u5929\u7684\u64cd\u4f5c\u3002\u5f88\u62b1\u6b49\u5f9e\u5b57\u7fa9\u7684\u89d2\u5ea6\u8b93\u4eba\u7522\u751f\u8aa4\u89e3\uff0c\u4f46\u8b93\u6211\u5011\u6f84\u6e05\u4e00\u4e0b\u3002\u4e00\u65e6\u201c\u67d0\u7269\u201d\u6295\u5165\u904b\u71df\uff0c\u201cDay2 operation\u201d\u5c31\u662f\u5269\u9918\u7684\u6642\u9593\u6bb5\uff0c\u76f4\u5230\u8a72\u201c\u67d0\u7269\u201d\u672a\u88ab\u6bba\u6b7b\u6216\u88ab\u201c\u5176\u4ed6\u6771\u897f\u201d\u53d6\u4ee3\u3002 \u7576\u6211\u5011\u67e5\u770b\u696d\u52d9\u6d41\u7a0b\u3001\u61c9\u7528\u7a0b\u5e8f\u6216 IT \u57fa\u790e\u67b6\u69cb\u751f\u547d\u9031\u671f\u4e2d\u7684\u5404\u500b\u968e\u6bb5\u6642\uff0c\u6709\u4e9b\u4eba\u559c\u6b61\u5c07\u5b83\u5011\u63cf\u8ff0\u70ba\u56de\u6536\u904e\u7a0b\u3002\u6211\u76f8\u4fe1\u9019\u662f\u56e0\u70ba\u4eba\u5011\u50be\u5411\u65bc\u4f7f\u7528\u201c\u61c9\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u9031\u671f\u201d\u9019\u500b\u8a5e\uff0c\u4e26\u4e14\u4e0d\u77e5\u4f55\u6545\u9677\u5165\u4e86\u76f8\u4fe1\u5716\u7247\u5fc5\u9808\u56de\u5230\u958b\u982d\u7684\u60f3\u6cd5\u3002\u5404\u500b\u968e\u6bb5\u901a\u5e38\u6703\u96a8\u8457\u6642\u9593\u5411\u524d\u63a8\u9032\uff0c\u4e0d\u6703\u5e36\u4f60\u56de\u5230\u8d77\u9ede\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5c07\u7d44\u7e54\u6216\u5be6\u9ad4\u6240\u9700\u7684\u6771\u897f\u7a31\u70ba\u201cX\u201d\u2014\u2014\u9019\u53ef\u4ee5\u662f\u696d\u52d9\u6d41\u7a0b\u3001\u61c9\u7528\u7a0b\u5e8f\u6216\u67d0\u4e9b IT \u57fa\u790e\u8a2d\u65bd\u3002\u5f9e\u6280\u8853\u4e0a\u8b1b\uff0c\u6bcf\u7576\u6709\u4eba\u8a2d\u60f3 X \u6642\uff0c\u7e3d\u6703\u6709\u4e00\u500b\u8d77\u9ede\u2014\u2014\u8b93\u6211\u5011\u7a31\u4e4b\u70ba\u201cDay0\u201d\uff08Geek Speak\uff1a\u9019\u662f\u9ad8\u4e2d\u7269\u7406\u7684\u907a\u7559\u7269\uff0c\u8d77\u9ede\u901a\u5e38\u662f T-Zero\uff09\u3002 Day0 \u53ef\u80fd\u4e0d\u662f\u4e00\u5929\uff1a\u5b83\u662f\u70ba X \u63d0\u51fa\u4e26\u8a18\u9304\u4e00\u6574\u5957\u9700\u6c42\u6240\u9700\u7684\u6642\u9593\u6bb5\u3002\u9019\u4e9b\u6d3b\u52d5\u53ef\u80fd\u5305\u62ec\u9ad8\u7d1a\u8a2d\u8a08\u3001\u8a18\u9304\u548c\u5411\u67d0\u4eba\u92b7\u552e\u5229\u76ca\u3001\u7de8\u5beb\u696d\u52d9\u6848\u4f8b\uff0c\u5c0b\u6c42\u8cc7\u91d1\u7b49\u3002 \u8a72\u904e\u7a0b\u7684\u4e0b\u4e00\u6b65\u662f\u69cb\u5efa\u548c\u8a2d\u7f6e\u5b83\u3002Day1 \u5305\u62ec\u5f9e\u8a73\u7d30\uff08\u6216\u5e95\u5c64\uff09\u8a2d\u8a08\u958b\u59cb\u5230\u69cb\u5efa\u3001\u6e2c\u8a66\u3001\u63d0\u51fa\u4efb\u4f55\u6240\u9700\u6d41\u7a0b\u548c\u4eba\u54e1\u4ee5\u652f\u6301 X \u4ee5\u9020\u798f\u65bc\u7d44\u7e54\u7684\u6240\u6709\u6d3b\u52d5\u3002\u5728\u8a31\u591a\u60c5\u6cc1\u4e0b\uff0c\u9019\u88e1\u53ef\u80fd\u9084\u6d89\u53ca\u4e00\u4e9b\u63a1\u8cfc\u6d3b\u52d5\u3002\u4e00\u65e6\u5b89\u88dd\u3001\u8a2d\u7f6e\u3001\u914d\u7f6e\u548c\u6279\u51c6\uff08\u201c\u5f88\u597d\u201d\uff09X \u88ab\u8a8d\u70ba\u662f\u201c\u6d3b\u52d5\u7684\u201d\u6216\u201c\u71df\u696d\u7684\u201d\u3002 \u5f9e\u9019\u4e00\u9ede\u958b\u59cb\uff0c\u76f4\u5230 X \u9000\u5f79\u3001\u88ab\u6bba\u6b7b\u3001\u9000\u5f79\u6216\u88ab\u66ff\u63db\uff0c\u6211\u5011\u6709 Day2 \u64cd\u4f5c\u3002\u9019\u5305\u62ec\u4e00\u7d44\u6d3b\u52d5\uff0c\u4ee5\u4fdd\u6301 X \u904b\u884c\u3001\u7167\u9867\u548c\u9935\u990a X\uff0c\u4f7f\u5176\u4ee5\u6700\u4f73\u65b9\u5f0f\u904b\u884c\uff0c\u78ba\u4fdd X \u904b\u884c\u4e26\u63d0\u4f9b\u7b26\u5408\u539f\u59cb\u610f\u5716\u548c\u671f\u671b\u7684\u7d50\u679c\u3002\u76e3\u63a7\u5229\u7528\u7387\u3001\u78ba\u4fdd\u53ef\u7528\u6027\u548c\u6210\u672c\u512a\u5316\u6dfb\u52a0\u5230\u901a\u5e38\u7684\u5167\u52d9\u6d3b\u52d5\u4e2d\uff0c\u4ee5\u4fdd\u6301 X \u4ee5\u201c\u6700\u4f73\u201d\u65b9\u5f0f\u57f7\u884c\u3002 \u96a8\u8457\u6211\u5011\u5468\u570d\u4e16\u754c\u7684\u9700\u6c42\u767c\u751f\u8b8a\u5316\uff0c\u7531\u7d44\u7e54\u6c7a\u5b9a\u662f\u5426\u5c07\u59cb\u7d42\u9700\u8981\u7684\u5c0d X \u7684\u8abf\u6574\u6216\u5347\u7d1a\u7a31\u70ba\u5168\u9762\u6aa2\u4fee\u6216\u50c5\u5347\u7d1a\u3002\u5982\u679c\u9019\u662f\u4e00\u6b21\u5168\u9762\u6aa2\u4fee\uff0c\u53ef\u4ee5\u5047\u8a2d X \u5df2\u9000\u5f79\u4e26\u88ab\u65b0\u7cfb\u7d71 Y \u53d6\u4ee3\u3002\u5982\u679c\u4e0d\u518d\u9700\u8981 X\uff0c\u5247 X \u7684 day2 \u7d50\u675f\u3002\u5982\u679c\u65b0\u7684 X \u53ea\u662f\u5c0d\u4e4b\u524d X \u7684\u589e\u91cf\u6539\u9032\uff0c\u90a3\u9ebc day2 \u5c07\u7e7c\u7e8c\u4e26\u5305\u542b\u6240\u6709\u6d3b\u52d5\u4ee5\u589e\u91cf\u6539\u9032 X\u3002 \u4e00\u500b\u5feb\u901f\u7684\u65c1\u6ce8\uff1a\u201c\u4e0d\u53ef\u8b8a\u7cfb\u7d71\u201d\u7684\u6982\u5ff5\u50be\u5411\u65bc\u901a\u904e\u4e0d\u5141\u8a31\u66f4\u6539\u4f46\u59cb\u7d42\u90e8\u7f72\u65b0\u7cfb\u7d71\u4f86\u63d0\u9ad8\u53ef\u7528\u6027\uff0c\u9019\u8207\u4e0a\u8ff0\u4e0d\u885d\u7a81\u3002\u7ba1\u7406\u4e0d\u53ef\u8b8a\u7cfb\u7d71\u7684\u904e\u7a0b\u6210\u70ba day2 \u7684\u4e00\u90e8\u5206\u3002 \u5c0d\u65bc\u5927\u591a\u6578\u4f01\u696d\u4f86\u8aaa\uff0cday2 \u672c\u8cea\u4e0a\u662f\u91cd\u8907\u7684\u3002\u4f46\u9019\u662f\u7cfb\u7d71\u70ba\u7d44\u7e54\u7522\u751f\u7d50\u679c\u7684\u5730\u65b9\u3002\u56e0\u6b64\uff0c\u5728 day2 \u4e2d\u4e0d\u65b7\u5c0b\u6c42\u6539\u9032\u61c9\u8a72\u662f\u5f88\u81ea\u7136\u7684\uff0c\u9019\u6a23\u53ef\u4ee5\u5e36\u4f86\u6700\u5927\u7684\u6536\u76ca\u3002","title":"Day2 \u7684\u5b9a\u7fa9"},{"location":"kubernetes/observability/day2-ops/day2-definition/#day2-operation","text":"\u539f\u6587: Defining Day-2 Operations Day2 Operation \u662f\u7cfb\u7d71\u70ba\u7d44\u7e54\u751f\u6210\u7d50\u679c\u7684\u5730\u65b9\u3002\u56e0\u6b64\uff0c\u5728 Day2 Operation \u4e2d\u4e0d\u65b7\u5c0b\u6c42\u6539\u9032\uff0c\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u63d0\u9ad8\u6536\u76ca\u3002 Day2 Operation \u4e0d\u4e00\u5b9a\u662f\u6307\u7b2c 2 \u5929\u7684\u64cd\u4f5c\u3002\u5f88\u62b1\u6b49\u5f9e\u5b57\u7fa9\u7684\u89d2\u5ea6\u8b93\u4eba\u7522\u751f\u8aa4\u89e3\uff0c\u4f46\u8b93\u6211\u5011\u6f84\u6e05\u4e00\u4e0b\u3002\u4e00\u65e6\u201c\u67d0\u7269\u201d\u6295\u5165\u904b\u71df\uff0c\u201cDay2 operation\u201d\u5c31\u662f\u5269\u9918\u7684\u6642\u9593\u6bb5\uff0c\u76f4\u5230\u8a72\u201c\u67d0\u7269\u201d\u672a\u88ab\u6bba\u6b7b\u6216\u88ab\u201c\u5176\u4ed6\u6771\u897f\u201d\u53d6\u4ee3\u3002 \u7576\u6211\u5011\u67e5\u770b\u696d\u52d9\u6d41\u7a0b\u3001\u61c9\u7528\u7a0b\u5e8f\u6216 IT \u57fa\u790e\u67b6\u69cb\u751f\u547d\u9031\u671f\u4e2d\u7684\u5404\u500b\u968e\u6bb5\u6642\uff0c\u6709\u4e9b\u4eba\u559c\u6b61\u5c07\u5b83\u5011\u63cf\u8ff0\u70ba\u56de\u6536\u904e\u7a0b\u3002\u6211\u76f8\u4fe1\u9019\u662f\u56e0\u70ba\u4eba\u5011\u50be\u5411\u65bc\u4f7f\u7528\u201c\u61c9\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u9031\u671f\u201d\u9019\u500b\u8a5e\uff0c\u4e26\u4e14\u4e0d\u77e5\u4f55\u6545\u9677\u5165\u4e86\u76f8\u4fe1\u5716\u7247\u5fc5\u9808\u56de\u5230\u958b\u982d\u7684\u60f3\u6cd5\u3002\u5404\u500b\u968e\u6bb5\u901a\u5e38\u6703\u96a8\u8457\u6642\u9593\u5411\u524d\u63a8\u9032\uff0c\u4e0d\u6703\u5e36\u4f60\u56de\u5230\u8d77\u9ede\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5c07\u7d44\u7e54\u6216\u5be6\u9ad4\u6240\u9700\u7684\u6771\u897f\u7a31\u70ba\u201cX\u201d\u2014\u2014\u9019\u53ef\u4ee5\u662f\u696d\u52d9\u6d41\u7a0b\u3001\u61c9\u7528\u7a0b\u5e8f\u6216\u67d0\u4e9b IT \u57fa\u790e\u8a2d\u65bd\u3002\u5f9e\u6280\u8853\u4e0a\u8b1b\uff0c\u6bcf\u7576\u6709\u4eba\u8a2d\u60f3 X \u6642\uff0c\u7e3d\u6703\u6709\u4e00\u500b\u8d77\u9ede\u2014\u2014\u8b93\u6211\u5011\u7a31\u4e4b\u70ba\u201cDay0\u201d\uff08Geek Speak\uff1a\u9019\u662f\u9ad8\u4e2d\u7269\u7406\u7684\u907a\u7559\u7269\uff0c\u8d77\u9ede\u901a\u5e38\u662f T-Zero\uff09\u3002 Day0 \u53ef\u80fd\u4e0d\u662f\u4e00\u5929\uff1a\u5b83\u662f\u70ba X \u63d0\u51fa\u4e26\u8a18\u9304\u4e00\u6574\u5957\u9700\u6c42\u6240\u9700\u7684\u6642\u9593\u6bb5\u3002\u9019\u4e9b\u6d3b\u52d5\u53ef\u80fd\u5305\u62ec\u9ad8\u7d1a\u8a2d\u8a08\u3001\u8a18\u9304\u548c\u5411\u67d0\u4eba\u92b7\u552e\u5229\u76ca\u3001\u7de8\u5beb\u696d\u52d9\u6848\u4f8b\uff0c\u5c0b\u6c42\u8cc7\u91d1\u7b49\u3002 \u8a72\u904e\u7a0b\u7684\u4e0b\u4e00\u6b65\u662f\u69cb\u5efa\u548c\u8a2d\u7f6e\u5b83\u3002Day1 \u5305\u62ec\u5f9e\u8a73\u7d30\uff08\u6216\u5e95\u5c64\uff09\u8a2d\u8a08\u958b\u59cb\u5230\u69cb\u5efa\u3001\u6e2c\u8a66\u3001\u63d0\u51fa\u4efb\u4f55\u6240\u9700\u6d41\u7a0b\u548c\u4eba\u54e1\u4ee5\u652f\u6301 X \u4ee5\u9020\u798f\u65bc\u7d44\u7e54\u7684\u6240\u6709\u6d3b\u52d5\u3002\u5728\u8a31\u591a\u60c5\u6cc1\u4e0b\uff0c\u9019\u88e1\u53ef\u80fd\u9084\u6d89\u53ca\u4e00\u4e9b\u63a1\u8cfc\u6d3b\u52d5\u3002\u4e00\u65e6\u5b89\u88dd\u3001\u8a2d\u7f6e\u3001\u914d\u7f6e\u548c\u6279\u51c6\uff08\u201c\u5f88\u597d\u201d\uff09X \u88ab\u8a8d\u70ba\u662f\u201c\u6d3b\u52d5\u7684\u201d\u6216\u201c\u71df\u696d\u7684\u201d\u3002 \u5f9e\u9019\u4e00\u9ede\u958b\u59cb\uff0c\u76f4\u5230 X \u9000\u5f79\u3001\u88ab\u6bba\u6b7b\u3001\u9000\u5f79\u6216\u88ab\u66ff\u63db\uff0c\u6211\u5011\u6709 Day2 \u64cd\u4f5c\u3002\u9019\u5305\u62ec\u4e00\u7d44\u6d3b\u52d5\uff0c\u4ee5\u4fdd\u6301 X \u904b\u884c\u3001\u7167\u9867\u548c\u9935\u990a X\uff0c\u4f7f\u5176\u4ee5\u6700\u4f73\u65b9\u5f0f\u904b\u884c\uff0c\u78ba\u4fdd X \u904b\u884c\u4e26\u63d0\u4f9b\u7b26\u5408\u539f\u59cb\u610f\u5716\u548c\u671f\u671b\u7684\u7d50\u679c\u3002\u76e3\u63a7\u5229\u7528\u7387\u3001\u78ba\u4fdd\u53ef\u7528\u6027\u548c\u6210\u672c\u512a\u5316\u6dfb\u52a0\u5230\u901a\u5e38\u7684\u5167\u52d9\u6d3b\u52d5\u4e2d\uff0c\u4ee5\u4fdd\u6301 X \u4ee5\u201c\u6700\u4f73\u201d\u65b9\u5f0f\u57f7\u884c\u3002 \u96a8\u8457\u6211\u5011\u5468\u570d\u4e16\u754c\u7684\u9700\u6c42\u767c\u751f\u8b8a\u5316\uff0c\u7531\u7d44\u7e54\u6c7a\u5b9a\u662f\u5426\u5c07\u59cb\u7d42\u9700\u8981\u7684\u5c0d X \u7684\u8abf\u6574\u6216\u5347\u7d1a\u7a31\u70ba\u5168\u9762\u6aa2\u4fee\u6216\u50c5\u5347\u7d1a\u3002\u5982\u679c\u9019\u662f\u4e00\u6b21\u5168\u9762\u6aa2\u4fee\uff0c\u53ef\u4ee5\u5047\u8a2d X \u5df2\u9000\u5f79\u4e26\u88ab\u65b0\u7cfb\u7d71 Y \u53d6\u4ee3\u3002\u5982\u679c\u4e0d\u518d\u9700\u8981 X\uff0c\u5247 X \u7684 day2 \u7d50\u675f\u3002\u5982\u679c\u65b0\u7684 X \u53ea\u662f\u5c0d\u4e4b\u524d X \u7684\u589e\u91cf\u6539\u9032\uff0c\u90a3\u9ebc day2 \u5c07\u7e7c\u7e8c\u4e26\u5305\u542b\u6240\u6709\u6d3b\u52d5\u4ee5\u589e\u91cf\u6539\u9032 X\u3002 \u4e00\u500b\u5feb\u901f\u7684\u65c1\u6ce8\uff1a\u201c\u4e0d\u53ef\u8b8a\u7cfb\u7d71\u201d\u7684\u6982\u5ff5\u50be\u5411\u65bc\u901a\u904e\u4e0d\u5141\u8a31\u66f4\u6539\u4f46\u59cb\u7d42\u90e8\u7f72\u65b0\u7cfb\u7d71\u4f86\u63d0\u9ad8\u53ef\u7528\u6027\uff0c\u9019\u8207\u4e0a\u8ff0\u4e0d\u885d\u7a81\u3002\u7ba1\u7406\u4e0d\u53ef\u8b8a\u7cfb\u7d71\u7684\u904e\u7a0b\u6210\u70ba day2 \u7684\u4e00\u90e8\u5206\u3002 \u5c0d\u65bc\u5927\u591a\u6578\u4f01\u696d\u4f86\u8aaa\uff0cday2 \u672c\u8cea\u4e0a\u662f\u91cd\u8907\u7684\u3002\u4f46\u9019\u662f\u7cfb\u7d71\u70ba\u7d44\u7e54\u7522\u751f\u7d50\u679c\u7684\u5730\u65b9\u3002\u56e0\u6b64\uff0c\u5728 day2 \u4e2d\u4e0d\u65b7\u5c0b\u6c42\u6539\u9032\u61c9\u8a72\u662f\u5f88\u81ea\u7136\u7684\uff0c\u9019\u6a23\u53ef\u4ee5\u5e36\u4f86\u6700\u5927\u7684\u6536\u76ca\u3002","title":"Day2 Operation \u7684\u5b9a\u7fa9"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/","text":"Kubernes \u904b\u71df - Day2 \u7684\u6311\u6230 \u00b6 \u539f\u6587: Why Is Everyone Ignoring the Day 2 Kubernetes Problem? \u4e00\u500b\u7d44\u7e54\u958b\u59cb\u63a1\u7528\u96f2\u539f\u751f\u6280\u8853\u4e26\u5be6\u65bd Kubernetes\u3002\u7136\u5f8c\u4e8b\u60c5\u958b\u59cb\u8b8a\u5f97\u2026\u2026\u6709\u8da3\u3002 \u96c6\u7fa4\u500d\u589e\u3002\u8b8a\u5316\u6fc0\u589e\u3002\u8a2a\u554f\u9700\u6c42\u5806\u7a4d\u5982\u5c71\u3002\u96f2\u6210\u672c\u98c6\u5347\u3002 \u201c\u6211\u5982\u4f55\u7ba1\u7406\u5c0d\u96c6\u7fa4\u7684\u8a2a\u554f\uff1f\u6211\u5c07\u5728\u6240\u6709\u74b0\u5883\u4e2d\u4f7f\u7528\u7684\u7b56\u7565\u6a21\u578b\u662f\u4ec0\u9ebc\uff1f\u6211\u7684\u751f\u7522\u96c6\u7fa4\u7684\u6a19\u6e96\u85cd\u5716\u4e2d\u5fc5\u9808\u59cb\u7d42\u5305\u542b\u54ea\u4e9b\u9644\u52a0\u7d44\u4ef6\uff1f\u6211\u90e8\u7f72\u5c6c\u65bc\u591a\u500b\u696d\u52d9\u90e8\u9580\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u7b56\u7565\u662f\u4ec0\u9ebc\uff1f\u6211\u5fc5\u9808\u76e1\u5feb\u5347\u7d1a\u6240\u6709\u96c6\u7fa4\uff0c\u56e0\u70ba\u6211\u5df2\u7d93\u5168\u9762\u843d\u5f8c\u4e86\u4e09\u500b\u7248\u672c\u2014\u2014\u6211\u8a72\u600e\u9ebc\u505a\uff1f\u201d \u9019\u4e9b\u554f\u984c\u90fd\u53ef\u4ee5\u6b78\u985e\u5728\u201cDay 2\u201d\u7684\u6a19\u984c\u4e0b\u3002Day2 \u5c0d\u65bc\u7ad9\u9ede\u53ef\u9760\u6027\u5de5\u7a0b\u5e2b (SRE) \u548c IT \u904b\u71df\u5de5\u7a0b\u5e2b\u4f86\u8aaa\u53ef\u80fd\u610f\u5473\u8457\u6c38\u9060\u7684\u982d\u75db\u3002 \u70ba\u4ec0\u9ebc Day 2 \u5982\u6b64\u75db\u82e6\uff1f \u00b6 Budhani \u8aaa\uff0c\u75bc\u75db\u6709\u8a31\u591a\u6839\u672c\u539f\u56e0\u3002\u9996\u5148\u662f\u6280\u80fd\u5dee\u8ddd\u554f\u984c\u2014\u2014Kubernetes \u6642\u4ee3\u5df2\u7d93\u904e\u53bb 8 \u5e74\uff0c\u4f46\u4ecd\u7136\u6c92\u6709\u8db3\u5920\u591a\u7684\u5de5\u7a0b\u5e2b\u5c0d K8s \u751f\u614b\u7cfb\u7d71\u6709\u8db3\u5920\u7684\u4e86\u89e3\u3002 \u6839\u64da Canonical \u53bb\u5e74 6 \u6708\u767c\u5e03\u7684\u4e00\u9805\u8abf\u67e5\uff0c \u7f3a\u4e4f\u5167\u90e8\u6280\u80fd \u662f\u516c\u53f8\u5728\u63a1\u7528\u5bb9\u5668\u548c Kubernetes \u6642\u9047\u5230\u7684\u6700\u5927\u6311\u6230\u3002 Kubernetes and cloud native operations report 2021 Kubernetes \u7d66\u4f01\u696d\u5e36\u4f86\u7684\u6700\u5927\u6311\u6230\u662f\u4ec0\u9ebc\uff1f \u5728\u9077\u79fb\u5230/\u4f7f\u7528 Kubernetes \u548c\u5bb9\u5668\u6642\uff0c\u60a8\u9762\u81e8\u7684\u6700\u5927\u6311\u6230\u662f\u4ec0\u9ebc\uff1f \u8a31\u591a\u7d44\u7e54\u6b63\u5728\u4f7f\u7528\u6216\u8a66\u9a57 Kubernetes\uff0c\u4f46\u9019\u4e9b\u7d50\u679c\u6709\u52a9\u65bc\u8aaa\u660e\u4f7f\u7528\u5c1a\u672a\u5b8c\u5168\u6ef2\u900f\u3002\u8fd1 55% \u7684\u53d7\u8a2a\u8005\u8a8d\u70ba\u4ed6\u5011\u7f3a\u4e4f Kubernetes \u6280\u80fd\u548c\u5167\u90e8\u5c08\u696d\u77e5\u8b58\u3002 \u9019\u5c0e\u81f4\u4e86\u8abf\u6574\u5e73\u53f0\u4ee5\u5be6\u73fe\u6700\u4f73\u5b89\u5168\u6027\u3001\u53ef\u89c0\u5bdf\u6027\u3001\u7db2\u7d61\u548c\u5b58\u5132\u914d\u7f6e\u7684\u6311\u6230\u3001\u57f9\u8a13\u7528\u6236\u7684\u6311\u6230 (29.7%) \u4ee5\u53ca\u516c\u53f8 IT \u6587\u5316 (37%) \u6216\u55ae\u9ad4\u67b6\u69cb\u9020\u6210\u7684\u963b\u529b 33%\u3002 \u6211\u767c\u73fe\u7f3a\u4e4f\u6280\u80fd\u7684\u7b54\u6848\u7279\u5225\u6709\u8da3\u3002\u6211\u76f8\u4fe1\u4eba\u5011\u4f4e\u4f30\u4e86\u904e\u53bb\u4e94\u5e74\u4e2d\u6280\u8853\u98db\u8e8d\u7684\u5de8\u5927\u7a0b\u5ea6\uff1aKubernetes\u3001\u96f2\u3001CICD\u3001DevOps\u3001GitOps\u3001ChatOps\u3002\u8b8a\u5316\u592a\u5927\u4e86\u3002\u5c0d\u65bc\u5f88\u591a\u4eba\u4f86\u8aaa\uff0c\u5728\u7e7c\u7e8c\u5de5\u4f5c\u7684\u540c\u6642\u5b78\u7fd2\u6240\u6709\u9019\u4e9b\u65b0\u6771\u897f\u771f\u7684\u5f88\u56f0\u96e3\u3002\u7f3a\u4e4f\u6280\u80fd\u548c\u57f9\u8a13\u4eba\u529b\u662f\u76ee\u524d\u7684\u4e00\u500b\u5927\u554f\u984c\u3002\u800c\u4e14\u6211\u8a8d\u70ba\u771f\u6b63\u5b78\u7fd2\u7684\u552f\u4e00\u65b9\u6cd5\u662f\u5be6\u8e10\uff1b\u9078\u64c7\u4e00\u689d\u9053\u8def\u4e26\u5617\u8a66\u65b0\u6280\u8853\u3002 \u7136\u5f8c\u662f\u96f2\u539f\u751f\u751f\u614b\u7cfb\u7d71\u4e2d\u7528\u65bc\u904b\u71df Kubernetes \u7684\u5de5\u5177\u7684\u5927\u96dc\u71f4\uff0c\u6bcf\u500b\u5de5\u5177\u4e5f\u7d93\u5e38\u9700\u8981\u5347\u7d1a\u548c\u95dc\u6ce8\u3002 \u201c\u6240\u6709\u9019\u4e9b\u5de5\u5177\u90fd\u9075\u5faa\u81ea\u5df1\u7684\u751f\u547d\u9031\u671f\u3002\u6bcf\u9694\u4e00\u6bb5\u6642\u9593\uff0c\u9019\u4e9b\u5de5\u5177\u4e2d\u7684\u6bcf\u4e00\u500b\u90fd\u9700\u8981\u5728\u6240\u6709\u96c6\u7fa4\u4e2d\u9032\u884c\u66f4\u65b0\u3002 \u201c\u56e0\u6b64\uff0c\u60a8\u5fc5\u9808\u7ba1\u7406 Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3001\u9019\u4e9b\u5de5\u5177\u7684\u751f\u547d\u9031\u671f\u3001\u61c9\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u9031\u671f\u3001\u96c6\u4e2d\u7b56\u7565\u548c\u8a2a\u554f\u7ba1\u7406\uff0c\u56e0\u70ba\u65b0\u7684\u5167\u90e8\u5718\u968a\u90e8\u7f72\u4e86\u66f4\u591a\u61c9\u7528\u7a0b\u5e8f\u3001\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u707d\u96e3\u6062\u5fa9\u7b56\u7565\u3001\u6536\u8cbb- \u9032\u7248\u9000\u7248\u7b56\u7565\u7b49\u7b49\u3002\u201d \u201cDay2 \u662f\u95dc\u65bc\u9700\u8981\u505a\u4e9b\u4ec0\u9ebc\u4f86\u4fdd\u6301\u7da0\u71c8\u662f\u4eae\u7684\uff0c\u800c\u5e95\u5c64\u6280\u8853\u90fd\u9700\u8981\u4ee5\u5168\u81ea\u52d5\u65b9\u5f0f\u70ba\u5176\u6cbb\u7406\u3001\u904b\u71df\u5b89\u5168\u6027\u548c\u53ef\u898b\u6027\u5b9a\u5236\u7b56\u7565\u3002\u201d \u4e00\u500b\u9996\u8981\u554f\u984c\u662f\uff0c\u6c92\u6709\u8db3\u5920\u591a\u7684\u4f01\u696d\u4f7f\u7528\u4ed6\u6240\u8b02\u7684\u201c\u6cbb\u7406\u81ea\u52d5\u5316\u201d\u2014\u2014\u96f2\u539f\u751f\u67b6\u69cb\u6240\u627f\u8afe\u7684\u958b\u767c\u4eba\u54e1\u7684\u901f\u5ea6\u548c\u514d\u65bc\u4e0d\u5fc5\u8981\u7684\u8f9b\u52e4\u5de5\u4f5c\uff0c\u518d\u52a0\u4e0a\u7d44\u7e54\u9700\u8981\u63a7\u5236\u5c0d\u95dc\u9375\u6578\u64da\u7684\u8a2a\u554f\u7684\u88fd\u8861\u3001\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u8a2d\u65bd\uff0c\u4e26\u63a7\u5236\u96f2\u6210\u672c\u3002 Kubernetes Day2 Ops \u8981\u4f5c\u90a3\u4e9b\u4e8b? \u00b6 \u5728\u6301\u7e8c\u7684\u57fa\u790e\u4e0a\uff0c\u7ba1\u7406\u60a8\u7684 Kubernetes \u64cd\u4f5c\u9700\u8981\u8ddf\u8e2a\u8a31\u591a\u4e8b\u60c5\u3002\u5c0d\u65bc\u9700\u8981\u90e8\u7f72\u5230\u591a\u96f2\u6216\u6df7\u5408\u74b0\u5883\u7684\u7d44\u7e54\u800c\u8a00\uff0c\u9019\u7a2e\u8907\u96dc\u6027\u4ee5\u53ca\u5bc6\u5207\u95dc\u6ce8\u6240\u6709\u79fb\u52d5\u90e8\u4ef6\u7684\u6311\u6230\u8b8a\u5f97\u66f4\u52a0\u8907\u96dc\u3002\u4e8b\u5be6\u4e0a\uff0c\u5c0d\u8655\u7406\u9019\u7a2e\u8907\u96dc\u6027\u7684\u6050\u61fc\u53ef\u80fd\u6703\u963b\u6b62\u7d44\u7e54\u9996\u5148\u8f49\u5411\u591a\u96f2\u89e3\u6c7a\u65b9\u6848\uff0c\u4e26\u53ef\u80fd\u5c0e\u81f4\u4f9b\u61c9\u5546\u9396\u5b9a\uff0c\u5f9e\u800c\u963b\u6b62\u7d44\u7e54\u5be6\u73fe\u5176\u696d\u52d9\u76ee\u6a19\u3002 \u4f46\u662f\uff0c\u7121\u8ad6\u60a8\u5728\u54ea\u88e1\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\uff0c\u9700\u8981\u6ce8\u610f\u7684\u95dc\u9375\u9818\u57df\u90fd\u662f\u4e00\u6a23\u7684\u3002\u9019\u662f Kubernetes Ops \u7684\u4e94\u500b\u652f\u67f1\uff1a Cluster Standardization and Lifecycle Management \u00b6 \u7576\u4f60\u69cb\u5efa\u5b83\u6642\uff0c\u4f60\u77e5\u9053\u4f60\u7684\u96c6\u7fa4\u4eca\u5929\u662f\u4ec0\u9ebc\u6a23\u5b50\u3002 \u201c\u4f46\u4f60\u600e\u9ebc\u77e5\u9053\u4e00\u500b\u6708\u5f8c\u7684\u6a23\u5b50\uff1f\u201d\u4ed6\u6307\u51fa\uff0c\u5373\u4f7f\u60a8\u4e0d\u518d\u63a5\u89f8\u96c6\u7fa4\uff0c\u201c\u5177\u6709\u8db3\u5920\u9ad8\u6b0a\u9650\u7684\u5df2\u5b89\u88dd\u9644\u52a0\u7d44\u4ef6\u6700\u7d42\u53ef\u80fd\u6703\u5728\u60a8\u4e0d\u77e5\u60c5\u7684\u60c5\u6cc1\u4e0b\u66f4\u6539\u57fa\u790e\u914d\u7f6e\u3002\u201d \u60a8\u9700\u8981\u5bc6\u5207\u95dc\u6ce8\u96c6\u7fa4\u7684\u6574\u500b\u751f\u547d\u9031\u671f\uff0c\u5305\u62ec\u5b83\u5982\u4f55\u53d7\u5230\u8207\u5b83\u4ea4\u4e92\u7684\u5176\u4ed6\u5de5\u5177\u548c\u7528\u6236\u7684\u5f71\u97ff\u3002\u70ba\u5728\u60a8\u7684\u7d44\u7e54\u4e2d\u5275\u5efa\u548c\u66f4\u65b0\u96c6\u7fa4\u8a2d\u7f6e\u6a19\u6e96\uff0c\u540c\u6642\u78ba\u4fdd\u4e00\u7d44\u7d93\u904e\u6279\u51c6\u7684\u9644\u52a0\u7d44\u4ef6\u59cb\u7d42\u5728\u60a8\u7684\u96c6\u7fa4\u968a\u5217\u4e2d\u904b\u884c\uff0c\u6709\u52a9\u65bc\u7c21\u5316\u5728\u767c\u751f\u7570\u5e38\u6642\u8b58\u5225\u7570\u5e38\u7684 Day2 \u4efb\u52d9\u3002 Secure Access and Isolation \u00b6 \u5728 Kubernetes \u7684\u5e6b\u52a9\u4e0b\u5b8c\u5168\u6216\u90e8\u5206\u5728\u96f2\u4e0a\u904b\u884c\u7684\u5206\u4f48\u5f0f\u7db2\u7d61\u9700\u8981\u4e00\u7a2e\u5168\u65b0\u7684\u65b9\u6cd5\u4f86\u5be6\u73fe\u904b\u71df\u5546/\u958b\u767c\u4eba\u54e1\u7684\u8a2a\u554f\u548c\u5b89\u5168\u6027\u3002\u7121\u8655\u4e0d\u5728\u7684\u7db2\u7d61\u5f88\u5bb9\u6613\u53d7\u5230\u4efb\u4f55\u5730\u65b9\u7684\u653b\u64ca\u3002 \u96f6\u4fe1\u4efb\u5b89\u5168\u65b9\u6cd5\u5df2\u5728\u5df2\u9077\u79fb\u6216\u6b63\u5728\u9077\u79fb\u5230\u96f2\u7684\u7d44\u7e54\u4e2d\u53d6\u5f97\u9032\u5c55\u3002\u96f6\u4fe1\u4efb\u62d2\u7d55\u820a\u7684\u201c\u57ce\u5821\u548c\u8b77\u57ce\u6cb3\u201d\u5b89\u5168\u6a21\u578b\uff0c\u800c\u662f\u4f7f\u7528\u7cbe\u7d30\u7684\u81ea\u52d5\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u6b0a\u9650\u4f86\u4fdd\u8b77\u91cd\u8981\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u6578\u64da\uff0c\u7121\u8ad6\u5b83\u5011\u4f4d\u65bc\u4f55\u8655\u3002 \u4f46\u662f\uff0c\u5728\u8a2a\u554f\u63a7\u5236\u65b9\u9762\uff0c\u8a31\u591a\uff08\u5982\u679c\u4e0d\u662f\u5927\u591a\u6578\uff09\u7d44\u7e54\u4ecd\u5728\u52aa\u529b\u89e3\u6c7a\u57fa\u790e\u554f\u984c\u3002\u5728 strongDM 1 \u6708\u4efd\u767c\u5e03\u7684\u4e00\u9805\u8abf\u67e5\u4e2d\uff0c80% \u7684\u53c3\u8207\u8005\u8868\u793a\u4ed6\u5011\u7684\u7d44\u7e54\u4eca\u5e74\u5c07\u81f4\u529b\u65bc\u8a2a\u554f\u7ba1\u7406\uff1b\u53ea\u6709 30% \u7684\u4eba\u8868\u793a\u4ed6\u5011\u7684\u8a08\u5283\u4e2d\u6709\u4e00\u500b\u96f6\u4fe1\u4efb\u9805\u76ee\u3002 \uff08\u5728\u540c\u4e00\u7814\u7a76\u4e2d\uff0c\u4e09\u5206\u4e4b\u4e00\u7684\u53d7\u8a2a\u8005\u7a31 Kubernetes \u662f\u4ed6\u5011\u4f7f\u7528\u7684\u6700\u5177\u6311\u6230\u6027\u7684\u6280\u8853\u3002\uff09 \u4fdd\u8b77\u5c0d Kubernetes API \u670d\u52d9\u5668\u7684\u8a2a\u554f\u6709\u52a9\u65bc\u9632\u6b62\u672a\u7d93\u6388\u6b0a\u7684\u63a2\u6e2c\u3002\u7576\u67d0\u500b\u7279\u5b9a\u7684 Kubernetes \u96c6\u7fa4\u51fa\u73fe\u554f\u984c\u6642\u2014\u2014\u4f8b\u5982\u6ce8\u5165\u60e1\u610f\u8edf\u4ef6\u2014\u2014\u9700\u8981\u9694\u96e2\u8a72\u96c6\u7fa4\u6216\u5fae\u670d\u52d9\u4ee5\u907f\u514d\u554f\u984c\u8513\u5ef6\u3002 Observability and Visibility \u00b6 Kubernetes \u96c6\u7fa4\u7684\u7ba1\u7406\u54e1\u9700\u8981\u5c0d\u6240\u6709\u74b0\u5883\u6709\u8db3\u5920\u7684\u53ef\u898b\u6027\uff0c\u4ee5\u53ca\u5fc5\u8981\u7684\u8b66\u5831\u548c\u76e3\u63a7\u7d1a\u5225\uff0c\u4ee5\u4fbf\u5728\u554f\u984c\u51fa\u73fe\u6642\u5c0d\u5176\u9032\u884c\u5206\u985e\u3002 Rafay \u7684 Kubernetes Operations Platform \u7b49\u89e3\u6c7a\u65b9\u6848\u63d0\u4f9b\u4e86\u958b\u7bb1\u5373\u7528\u7684\u9019\u4e9b\u529f\u80fd\u3002\u8a2a\u554f\u9577\u671f\u6307\u6a19\u548c\u8b66\u5831\u6578\u64da\u53ef\u4ee5\u771f\u6b63\u5e6b\u52a9 SRE \u548c IT Ops \u4e86\u89e3\u5176\u96c6\u7fa4\u8266\u968a\u7684\u8da8\u52e2\uff0c\u4ee5\u5e6b\u52a9\u9032\u884c\u898f\u5283\u548c\u9810\u6e2c\u3002 Governance and Compliance \u00b6 \u7576\u7136\uff0cKubernetes \u662f\u958b\u6e90\u7684\u2014\u2014\u5b8c\u5168\u958b\u653e\uff0c\u5c31\u50cf\u72c2\u91ce\u7684\u897f\u90e8\u4e00\u6a23\u3002\u4f7f\u7528\u5b83\u7684\u516c\u53f8\u901a\u5e38\u96e3\u4ee5\u6dfb\u52a0\u95dc\u9375\u7684\u6cbb\u7406\u548c\u5408\u898f\u6027\u529f\u80fd\uff0c\u4f8b\u5982\u65e5\u8a8c\u8a18\u9304\u3001\u6f02\u79fb\u6aa2\u6e2c\u548c\u53ef\u5be9\u8a08\u6027\u3002 \u96c6\u4e2d\u7684\u53ef\u57f7\u884c\u96c6\u7fa4\u914d\u7f6e\u6a21\u578b\u6709\u52a9\u65bc\u5be6\u73fe\u4f01\u696d\u7bc4\u570d\u7684\u96c6\u7fa4\u6a19\u6e96\u5316\u3002\u6709\u4e00\u7a2e\u65b9\u6cd5\u4f86\u78ba\u4fdd\u90e8\u7f72\u6240\u6709\u5f37\u5236\u7684\u5b89\u5168\u548c\u64cd\u4f5c\u9644\u52a0\u7d44\u4ef6\u6709\u52a9\u65bc\u78ba\u4fdd\u7b26\u5408\u4f01\u696d\u7b56\u7565\u3002\u6b64\u5916\uff0c\u6709\u4e00\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u6aa2\u6e2c\u96c6\u7fa4\u4f55\u6642\u504f\u96e2\u4f01\u696d\u7b56\u7565\uff0c\u4e26\u5728\u51fa\u73fe\u554f\u984c\u6642\u5c0d\u5176\u9032\u884c\u88dc\u6551\uff0c\u9019\u4e5f\u662f\u4e00\u9805\u95dc\u9375\u8981\u6c42\u3002 Rafay \u7684 Kubernetes \u904b\u71df\u5e73\u53f0\u63d0\u4f9b\u96c6\u7fa4\u85cd\u5716\u3001\u9644\u52a0\u7248\u672c\u63a7\u5236\u3001\u7b56\u7565\u5be6\u65bd\u548c\u9055\u898f\u5831\u544a\u7b49\u529f\u80fd\uff0c\u4ee5\u53ca\u53ef\u4ee5\u963b\u6b62\u5c0d\u96c6\u7fa4\u7bc4\u570d\u8cc7\u6e90\uff08\u5982\u5165\u53e3\u63a7\u5236\u5668\u3001\u904b\u884c\u6642\u5b89\u5168\u5de5\u5177\u7b49\uff09\u7684\u66f4\u6539\u7684\u6f02\u79fb\u6aa2\u6e2c\u908f\u8f2f\uff0c\u4ee5\u53ca\u96c6\u7fa4\u6d3b\u52d5\u7684\u7aef\u5230\u7aef\u5be9\u8a08\u8ddf\u8e2a\u3002 Third-Party Integrations and Maintenance \u00b6 \u4f7f\u652f\u6301\u73fe\u4ee3\uff08\u57fa\u65bc Kubernetes\uff09\u57fa\u790e\u8a2d\u65bd\u7684\u6240\u6709\u670d\u52d9\u548c\u5de5\u5177\u7121\u7e2b\u904b\u884c\u4e26\u5354\u540c\u5de5\u4f5c\u53ef\u80fd\u6703\u5f88\u68d8\u624b\u3002\u4e3b\u8981\u7684\u96f2\u63d0\u4f9b\u5546\u901a\u5e38\u6709\u4e00\u5957\u5de5\u5177\u4f86\u5e6b\u52a9\u7ba1\u7406 Kubernetes\u2014\u2014\u4f46\u5982\u679c\u4f60\u8d70\u51fa\u8a72\u96f2\u63d0\u4f9b\u5546\u7684\u9818\u57df\uff0c\u9019\u4e9b\u5de5\u5177\u4e26\u4e0d\u7e3d\u662f\u80fd\u5f88\u597d\u5730\u8f49\u5316\uff0c\u4e5f\u8a31\u662f\u70ba\u4e86\u90e8\u7f72\u5230\u591a\u500b\u96f2\u3001\u5728\u672c\u5730\u74b0\u5883\u4e2d\uff0c\u6216\u8005\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u5728\u908a\u7de3\u3002 \u9019\u5c31\u50cf\u4e00\u500b\u62fc\u5716\uff0c\u9700\u8981\u4e0d\u65b7\u5730\u7d44\u5408\u5728\u4e00\u8d77\uff0c\u5373\u4f7f\u6bcf\u500b\u62fc\u5716\u90fd\u6709\u81ea\u5df1\u7684\u751f\u547d\u9031\u671f\u9700\u8981\u7ba1\u7406\u3002\u958b\u6e90\u5de5\u5177\u548c\u7d44\u4ef6\u53ef\u80fd\u6703\u5e36\u4f86\u81ea\u5df1\u7684\u554f\u984c\uff1a\u4f8b\u5982 2021 \u5e74\u672b\u5728 Log4j \u4e2d\u767c\u73fe\u7684\u6f0f\u6d1e\u3002\u6216\u8005\u53ea\u662f\u6bcf\u5b63\u5ea6\u66f4\u65b0\u60a8\u7684 Kubernetes \u672c\u8eab\u7248\u672c\u6240\u6d89\u53ca\u7684\u8f9b\u52de\u3002 \u904e\u6642\u7684\u5de5\u5177\u53ef\u80fd\u6703\u5c0e\u81f4\u8a08\u5283\u5916\u505c\u6a5f\uff0c\u5f9e\u800c\u76f4\u63a5\u5f71\u97ff\u6700\u7d42\u5ba2\u6236\uff0c\u6700\u7d42\u5f71\u97ff\u696d\u52d9\u3002 \u69cb\u5efa K8s \u5e73\u53f0\u7684\u6301\u7e8c\u6210\u672c \u00b6 Kubernetes Day2 \u7684\u8ca0\u64d4\u4e0d\u50c5\u50c5\u662f\u96f2\u652f\u51fa\u3002\u904b\u71df\u548c\u7dad\u8b77 Kubernetes \u9084\u53ef\u4ee5\u8b93\u5718\u968a\u6210\u54e1\u9060\u96e2\u76f4\u63a5\u70ba\u516c\u53f8\u5e36\u4f86\u6536\u5165\u7684\u7522\u54c1\u548c\u61c9\u7528\u7a0b\u5e8f\u3002 \u4e00\u4e9b\u53ef\u80fd\u589e\u52a0 Day2 \u982d\u75db\u7684\u4e8b\u60c5\u6e90\u65bc \u7f3a\u4e4f\u6a19\u6e96\u5316 \u3002\u7576\u5177\u6709\u7368\u7279\u914d\u7f6e\u7684\u96c6\u7fa4\u5931\u6557\u6642\uff0c\u5b83\u5011\u53ef\u80fd\u5305\u62ec\u8907\u96dc\u7684\u5206\u985e\u548c\u652f\u6301\u6210\u672c\uff0c\u6216\u8005\u7531\u63a7\u5236\u5668\u548c\u96c6\u7fa4\u4e4b\u9593\u7684\u81ea\u5b9a\u7fa9\u8a2a\u554f\u548c\u806f\u7db2\u5c0e\u81f4\u7684\u5b89\u5168\u98a8\u96aa\u3002\u7f3a\u4e4f kubectl \u8a2a\u554f\u63a7\u5236\u4e5f\u6703\u4f7f\u696d\u52d9\u9762\u81e8\u5408\u898f\u548c\u6cbb\u7406\u98a8\u96aa\u3002 \u201c\u7ba1\u7406\u8005\u6709\u6642\u4e0d\u9858\u610f\u5728 Kubernetes \u4e4b\u65c5\u7684\u65e9\u671f\u63d0\u51fa Day2 \u7684\u554f\u984c\uff0c\u56e0\u70ba\u201c\u4ed6\u5011\u4e0d\u60f3\u6253\u4e82\u958b\u767c\u4eba\u54e1\u7684\u5fc3\u614b\u3002\u201d \u9019\u7a2e\u6c89\u9ed8\u662f\u932f\u8aa4\u7684\uff1a\u958b\u767c\u4eba\u54e1\u5df2\u7d93\u77e5\u9053\u4ed6\u5011\u7684\u5de5\u4f5c\u91cf\u56e0\u70ba Kubernetes Day 2 \u7684\u554f\u984c\u800c\u5931\u53bb\u5e73\u8861\u3002 \u7576\u6211\u8207\u5be6\u969b\u7684\u958b\u767c\u4eba\u54e1\u4ea4\u8ac7\u6642\uff0c\u4ed6\u5011\u6703\u8aaa\uff0c\"\u6211\u4e0d\u77e5\u9053\u70ba\u4ec0\u9ebc\u6211\u8981\u7de8\u5beb Helm chart \u800c\u4e0d\u662f\u6211\u7684\u61c9\u7528\u7a0b\u5e8f\"\u3002 \u201c\u662f\u7684\uff0c\u6211\u60f3\u8a66\u9a57\u4e00\u4e0b Kubernetes\u3002\u6211\u6709\u9ede\u559c\u6b61\u9019\u9805\u65b0\u6280\u8853\u3002\u7576\u6211\u6700\u521d\u63a5\u89f8\u5b83\u6642\uff0c\u6211\u559c\u6b61\u5b78\u7fd2\u5b83\u3002\u4f46\u662f\uff0c\u6211\u7684\u4e0a\u5e1d\uff0c\u6211\u9084\u6709\u5de5\u4f5c\u8981\u505a\u3002\u201d \u4ed6\u8aaa\uff0cC \u7d1a\u4e3b\u7ba1\u3001DevOps \u7d93\u7406\u548c\u958b\u767c\u4eba\u54e1\u90fd\u60f3\u8981\u540c\u6a23\u7684\u6771\u897f\uff1a\u4e00\u7a2e\u4ea4\u4ed8\u66f4\u591a\u66f4\u597d\u4ee3\u78bc\u4e26\u70ba\u696d\u52d9\u5275\u9020\u66f4\u591a\u6536\u5165\u7684\u6709\u6548\u65b9\u5f0f\u3002\u4f46\u662f\uff0c\u4ed6\u6307\u51fa\uff0c\u201c\u4ed6\u5011\u8aaa\u7684\u4e0d\u662f\u540c\u4e00\u7a2e\u8a9e\u8a00\u3002\u5728\u6b64\u904e\u7a0b\u4e2d\uff0c\u9019\u4e9b\u5927\u578b\u4f01\u696d\u7684\u4ea4\u4ed8\u6210\u679c\u9060\u9060\u843d\u5f8c\u65bc\u8a08\u5283\u3002\u201d \u89e3\u6c7a Kubernetes Day2 \u554f\u984c \u00b6 \u70ba\u4e86\u8b93\u60a8\u7684\u5718\u968a\u548c\u60a8\u7684\u7d44\u7e54\u70ba\u76e3\u7763\u57fa\u65bc Kubernetes \u69cb\u5efa\u7684\u96f2\u67b6\u69cb\u7684\u9577\u671f\u627f\u8afe\u505a\u597d\u6e96\u5099\uff0c\u6e96\u78ba\u4e86\u89e3\u60a8\u7684\u7d44\u7e54\u6b63\u5728\u5f9e\u4e8b\u7684\u5de5\u4f5c\u975e\u5e38\u91cd\u8981\u3002 \u5728\u4f60\u958b\u59cb\u4e00\u500b\u5305\u542b\u904b\u884c Kubernetes \u7684\u96f2\u539f\u751f\u9805\u76ee\u4e4b\u524d\uff0c\u8acb\u8003\u616e\u4e00\u4e0b\u4f60\u7684\u7d44\u7e54\u6b63\u5728\u52aa\u529b\u5b8c\u6210\u4ec0\u9ebc\u3002 \u9996\u5e2d\u4fe1\u606f\u5b98\u548c\u5176\u4ed6\u9ad8\u7d1a\u7ba1\u7406\u4eba\u54e1\u201c\u904e\u53bb\u5e38\u5e38\u6311\u6230\u4ed6\u5011\u7684\u5718\u968a\u505a\u66f4\u591a\u7684\u4e8b\u60c5\uff0c\u9032\u884c\u66f4\u591a\u7684\u5be6\u9a57\u3002\u73fe\u5728\u554f\u984c\u61c9\u8a72\u662f\uff0c\u201c\u4f60\u70ba\u4ec0\u9ebc\u8981\u8a66\u9a57 Kubernetes \u9644\u52a0\u7d44\u4ef6\uff1f\u5411\u6211\u8b49\u660e\uff0c\u5728\u9032\u884c\u5be6\u9a57\u4e4b\u524d\uff0c\u60a8\u9700\u8981\u69cb\u5efa\u4e00\u4e9b\u8d85\u51fa\u53ef\u4ee5\u8cfc\u8cb7\u73fe\u6210\u7684\u6771\u897f\u7684\u6771\u897f\u3002\u201d K8s \u6a19\u6e96\u5316\u7684\u771f\u6b63\u6210\u672c\u5305\u62ec\u5b9a\u50f9\u6a21\u578b\u3001\u5be6\u65bd\u548c\u7dad\u8b77\u3002\u5728\u8981\u554f\u7684\u554f\u984c\u4e2d\uff1a \u60a8\u5c07\u5982\u4f55\u78ba\u5b9a\u54ea\u4e9b\u5de5\u5177\u6700\u9069\u5408\u60a8\u7684\u7528\u4f8b\uff1f \u4f60\u5c07\u5982\u4f55\u8ddf\u4e0a\u958b\u6e90\u7684\u8b8a\u5316\uff1f \u662f\u5426\u6703\u7e7c\u7e8c\u6295\u8cc7\u65bc\u5de5\u5177\u96c6\u6210\uff1f \u7576\u51fa\u73fe\u4e92\u64cd\u4f5c\u6027\u554f\u984c\u548c\u64cd\u4f5c\u554f\u984c\u6642\uff0c\u8ab0\u4f86\u89e3\u6c7a\u5b83\u5011\uff1f \u60a8\u80fd\u5426\u4ee5\u8db3\u5920\u5feb\u7684\u901f\u5ea6\u50f1\u50ad\u8db3\u5920\u591a\u5177\u6709\u4e91\u539f\u751f\u6280\u80fd\u7684\u4eba\u54e1\u2014\u2014\u6216\u8005\u57f9\u8a13\u73fe\u6709\u7684\u5718\u968a\u6210\u54e1\uff1f \u6700\u91cd\u8981\u7684\u662f\uff0c\u8003\u616e\u8207\u5176\u4ed6\u4e5f\u8de8\u8d8a\u9d3b\u6e9d\u4e26\u5be6\u65bd Kubernetes \u7684\u7d44\u7e54\u4ea4\u8ac7\u3002 \u9996\u5148\uff0c\u4e86\u89e3\u5176\u4ed6\u4eba\u662f\u5982\u4f55\u505a\u4e8b\u7684\u2014\u2014\u56e0\u70ba\u9019\u6703\u8b93\u4f60\u4e86\u89e3\u9019\u500b\u554f\u984c\u6709\u591a\u96e3\u6216\u591a\u7c21\u55ae\u3002 \u201c\u5f9e\u5931\u6557\u4e2d\u5b78\u7fd2\u5f88\u68d2\uff0c\u4f46\u5b83\u662f\u4ee5\u6642\u9593\u70ba\u4ee3\u50f9\u7684\u3002\u7576\u60a8\u53ef\u4ee5\u5411\u540c\u884c\u5b78\u7fd2\u6642\uff0c\u70ba\u4ec0\u9ebc\u8981\u8d70\u9019\u689d\u8def\uff1f Kubernetes \u793e\u5340\u7684\u7f8e\u5999\u4e4b\u8655\u5728\u65bc\u4eba\u5011\u975e\u5e38\u9858\u610f\u5206\u4eab\u4ed6\u5011\u7684\u7d93\u9a57\u548c\u610f\u898b\u3002\u201d \u5230 2022 \u5e74\uff0c\u4f60\u4e26\u4e0d\u662f\u552f\u4e00\u4e00\u5bb6\u81f4\u529b\u65bc Kubernetes \u7684\u516c\u53f8\u3002\u8a31\u591a\u5176\u4ed6\u516c\u53f8\u5df2\u7d93\u7d93\u6b77\u6216\u6b63\u5728\u7d93\u6b77\u9019\u4e00\u65c5\u7a0b\u3002\u6709\u8cc7\u6e90\u53ef\u4ee5\u505a\u5230\u9019\u4e00\u9ede\u3002\u5c0b\u627e\u4ed6\u5011\u3002\u201d","title":"Kubernetes Day2 \u904b\u71df"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#kubernes-day2","text":"\u539f\u6587: Why Is Everyone Ignoring the Day 2 Kubernetes Problem? \u4e00\u500b\u7d44\u7e54\u958b\u59cb\u63a1\u7528\u96f2\u539f\u751f\u6280\u8853\u4e26\u5be6\u65bd Kubernetes\u3002\u7136\u5f8c\u4e8b\u60c5\u958b\u59cb\u8b8a\u5f97\u2026\u2026\u6709\u8da3\u3002 \u96c6\u7fa4\u500d\u589e\u3002\u8b8a\u5316\u6fc0\u589e\u3002\u8a2a\u554f\u9700\u6c42\u5806\u7a4d\u5982\u5c71\u3002\u96f2\u6210\u672c\u98c6\u5347\u3002 \u201c\u6211\u5982\u4f55\u7ba1\u7406\u5c0d\u96c6\u7fa4\u7684\u8a2a\u554f\uff1f\u6211\u5c07\u5728\u6240\u6709\u74b0\u5883\u4e2d\u4f7f\u7528\u7684\u7b56\u7565\u6a21\u578b\u662f\u4ec0\u9ebc\uff1f\u6211\u7684\u751f\u7522\u96c6\u7fa4\u7684\u6a19\u6e96\u85cd\u5716\u4e2d\u5fc5\u9808\u59cb\u7d42\u5305\u542b\u54ea\u4e9b\u9644\u52a0\u7d44\u4ef6\uff1f\u6211\u90e8\u7f72\u5c6c\u65bc\u591a\u500b\u696d\u52d9\u90e8\u9580\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u7b56\u7565\u662f\u4ec0\u9ebc\uff1f\u6211\u5fc5\u9808\u76e1\u5feb\u5347\u7d1a\u6240\u6709\u96c6\u7fa4\uff0c\u56e0\u70ba\u6211\u5df2\u7d93\u5168\u9762\u843d\u5f8c\u4e86\u4e09\u500b\u7248\u672c\u2014\u2014\u6211\u8a72\u600e\u9ebc\u505a\uff1f\u201d \u9019\u4e9b\u554f\u984c\u90fd\u53ef\u4ee5\u6b78\u985e\u5728\u201cDay 2\u201d\u7684\u6a19\u984c\u4e0b\u3002Day2 \u5c0d\u65bc\u7ad9\u9ede\u53ef\u9760\u6027\u5de5\u7a0b\u5e2b (SRE) \u548c IT \u904b\u71df\u5de5\u7a0b\u5e2b\u4f86\u8aaa\u53ef\u80fd\u610f\u5473\u8457\u6c38\u9060\u7684\u982d\u75db\u3002","title":"Kubernes \u904b\u71df - Day2 \u7684\u6311\u6230"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#day-2","text":"Budhani \u8aaa\uff0c\u75bc\u75db\u6709\u8a31\u591a\u6839\u672c\u539f\u56e0\u3002\u9996\u5148\u662f\u6280\u80fd\u5dee\u8ddd\u554f\u984c\u2014\u2014Kubernetes \u6642\u4ee3\u5df2\u7d93\u904e\u53bb 8 \u5e74\uff0c\u4f46\u4ecd\u7136\u6c92\u6709\u8db3\u5920\u591a\u7684\u5de5\u7a0b\u5e2b\u5c0d K8s \u751f\u614b\u7cfb\u7d71\u6709\u8db3\u5920\u7684\u4e86\u89e3\u3002 \u6839\u64da Canonical \u53bb\u5e74 6 \u6708\u767c\u5e03\u7684\u4e00\u9805\u8abf\u67e5\uff0c \u7f3a\u4e4f\u5167\u90e8\u6280\u80fd \u662f\u516c\u53f8\u5728\u63a1\u7528\u5bb9\u5668\u548c Kubernetes \u6642\u9047\u5230\u7684\u6700\u5927\u6311\u6230\u3002 Kubernetes and cloud native operations report 2021 Kubernetes \u7d66\u4f01\u696d\u5e36\u4f86\u7684\u6700\u5927\u6311\u6230\u662f\u4ec0\u9ebc\uff1f \u5728\u9077\u79fb\u5230/\u4f7f\u7528 Kubernetes \u548c\u5bb9\u5668\u6642\uff0c\u60a8\u9762\u81e8\u7684\u6700\u5927\u6311\u6230\u662f\u4ec0\u9ebc\uff1f \u8a31\u591a\u7d44\u7e54\u6b63\u5728\u4f7f\u7528\u6216\u8a66\u9a57 Kubernetes\uff0c\u4f46\u9019\u4e9b\u7d50\u679c\u6709\u52a9\u65bc\u8aaa\u660e\u4f7f\u7528\u5c1a\u672a\u5b8c\u5168\u6ef2\u900f\u3002\u8fd1 55% \u7684\u53d7\u8a2a\u8005\u8a8d\u70ba\u4ed6\u5011\u7f3a\u4e4f Kubernetes \u6280\u80fd\u548c\u5167\u90e8\u5c08\u696d\u77e5\u8b58\u3002 \u9019\u5c0e\u81f4\u4e86\u8abf\u6574\u5e73\u53f0\u4ee5\u5be6\u73fe\u6700\u4f73\u5b89\u5168\u6027\u3001\u53ef\u89c0\u5bdf\u6027\u3001\u7db2\u7d61\u548c\u5b58\u5132\u914d\u7f6e\u7684\u6311\u6230\u3001\u57f9\u8a13\u7528\u6236\u7684\u6311\u6230 (29.7%) \u4ee5\u53ca\u516c\u53f8 IT \u6587\u5316 (37%) \u6216\u55ae\u9ad4\u67b6\u69cb\u9020\u6210\u7684\u963b\u529b 33%\u3002 \u6211\u767c\u73fe\u7f3a\u4e4f\u6280\u80fd\u7684\u7b54\u6848\u7279\u5225\u6709\u8da3\u3002\u6211\u76f8\u4fe1\u4eba\u5011\u4f4e\u4f30\u4e86\u904e\u53bb\u4e94\u5e74\u4e2d\u6280\u8853\u98db\u8e8d\u7684\u5de8\u5927\u7a0b\u5ea6\uff1aKubernetes\u3001\u96f2\u3001CICD\u3001DevOps\u3001GitOps\u3001ChatOps\u3002\u8b8a\u5316\u592a\u5927\u4e86\u3002\u5c0d\u65bc\u5f88\u591a\u4eba\u4f86\u8aaa\uff0c\u5728\u7e7c\u7e8c\u5de5\u4f5c\u7684\u540c\u6642\u5b78\u7fd2\u6240\u6709\u9019\u4e9b\u65b0\u6771\u897f\u771f\u7684\u5f88\u56f0\u96e3\u3002\u7f3a\u4e4f\u6280\u80fd\u548c\u57f9\u8a13\u4eba\u529b\u662f\u76ee\u524d\u7684\u4e00\u500b\u5927\u554f\u984c\u3002\u800c\u4e14\u6211\u8a8d\u70ba\u771f\u6b63\u5b78\u7fd2\u7684\u552f\u4e00\u65b9\u6cd5\u662f\u5be6\u8e10\uff1b\u9078\u64c7\u4e00\u689d\u9053\u8def\u4e26\u5617\u8a66\u65b0\u6280\u8853\u3002 \u7136\u5f8c\u662f\u96f2\u539f\u751f\u751f\u614b\u7cfb\u7d71\u4e2d\u7528\u65bc\u904b\u71df Kubernetes \u7684\u5de5\u5177\u7684\u5927\u96dc\u71f4\uff0c\u6bcf\u500b\u5de5\u5177\u4e5f\u7d93\u5e38\u9700\u8981\u5347\u7d1a\u548c\u95dc\u6ce8\u3002 \u201c\u6240\u6709\u9019\u4e9b\u5de5\u5177\u90fd\u9075\u5faa\u81ea\u5df1\u7684\u751f\u547d\u9031\u671f\u3002\u6bcf\u9694\u4e00\u6bb5\u6642\u9593\uff0c\u9019\u4e9b\u5de5\u5177\u4e2d\u7684\u6bcf\u4e00\u500b\u90fd\u9700\u8981\u5728\u6240\u6709\u96c6\u7fa4\u4e2d\u9032\u884c\u66f4\u65b0\u3002 \u201c\u56e0\u6b64\uff0c\u60a8\u5fc5\u9808\u7ba1\u7406 Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3001\u9019\u4e9b\u5de5\u5177\u7684\u751f\u547d\u9031\u671f\u3001\u61c9\u7528\u7a0b\u5e8f\u7684\u751f\u547d\u9031\u671f\u3001\u96c6\u4e2d\u7b56\u7565\u548c\u8a2a\u554f\u7ba1\u7406\uff0c\u56e0\u70ba\u65b0\u7684\u5167\u90e8\u5718\u968a\u90e8\u7f72\u4e86\u66f4\u591a\u61c9\u7528\u7a0b\u5e8f\u3001\u6bcf\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u707d\u96e3\u6062\u5fa9\u7b56\u7565\u3001\u6536\u8cbb- \u9032\u7248\u9000\u7248\u7b56\u7565\u7b49\u7b49\u3002\u201d \u201cDay2 \u662f\u95dc\u65bc\u9700\u8981\u505a\u4e9b\u4ec0\u9ebc\u4f86\u4fdd\u6301\u7da0\u71c8\u662f\u4eae\u7684\uff0c\u800c\u5e95\u5c64\u6280\u8853\u90fd\u9700\u8981\u4ee5\u5168\u81ea\u52d5\u65b9\u5f0f\u70ba\u5176\u6cbb\u7406\u3001\u904b\u71df\u5b89\u5168\u6027\u548c\u53ef\u898b\u6027\u5b9a\u5236\u7b56\u7565\u3002\u201d \u4e00\u500b\u9996\u8981\u554f\u984c\u662f\uff0c\u6c92\u6709\u8db3\u5920\u591a\u7684\u4f01\u696d\u4f7f\u7528\u4ed6\u6240\u8b02\u7684\u201c\u6cbb\u7406\u81ea\u52d5\u5316\u201d\u2014\u2014\u96f2\u539f\u751f\u67b6\u69cb\u6240\u627f\u8afe\u7684\u958b\u767c\u4eba\u54e1\u7684\u901f\u5ea6\u548c\u514d\u65bc\u4e0d\u5fc5\u8981\u7684\u8f9b\u52e4\u5de5\u4f5c\uff0c\u518d\u52a0\u4e0a\u7d44\u7e54\u9700\u8981\u63a7\u5236\u5c0d\u95dc\u9375\u6578\u64da\u7684\u8a2a\u554f\u7684\u88fd\u8861\u3001\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u8a2d\u65bd\uff0c\u4e26\u63a7\u5236\u96f2\u6210\u672c\u3002","title":"\u70ba\u4ec0\u9ebc Day 2 \u5982\u6b64\u75db\u82e6\uff1f"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#kubernetes-day2-ops","text":"\u5728\u6301\u7e8c\u7684\u57fa\u790e\u4e0a\uff0c\u7ba1\u7406\u60a8\u7684 Kubernetes \u64cd\u4f5c\u9700\u8981\u8ddf\u8e2a\u8a31\u591a\u4e8b\u60c5\u3002\u5c0d\u65bc\u9700\u8981\u90e8\u7f72\u5230\u591a\u96f2\u6216\u6df7\u5408\u74b0\u5883\u7684\u7d44\u7e54\u800c\u8a00\uff0c\u9019\u7a2e\u8907\u96dc\u6027\u4ee5\u53ca\u5bc6\u5207\u95dc\u6ce8\u6240\u6709\u79fb\u52d5\u90e8\u4ef6\u7684\u6311\u6230\u8b8a\u5f97\u66f4\u52a0\u8907\u96dc\u3002\u4e8b\u5be6\u4e0a\uff0c\u5c0d\u8655\u7406\u9019\u7a2e\u8907\u96dc\u6027\u7684\u6050\u61fc\u53ef\u80fd\u6703\u963b\u6b62\u7d44\u7e54\u9996\u5148\u8f49\u5411\u591a\u96f2\u89e3\u6c7a\u65b9\u6848\uff0c\u4e26\u53ef\u80fd\u5c0e\u81f4\u4f9b\u61c9\u5546\u9396\u5b9a\uff0c\u5f9e\u800c\u963b\u6b62\u7d44\u7e54\u5be6\u73fe\u5176\u696d\u52d9\u76ee\u6a19\u3002 \u4f46\u662f\uff0c\u7121\u8ad6\u60a8\u5728\u54ea\u88e1\u90e8\u7f72\u61c9\u7528\u7a0b\u5e8f\uff0c\u9700\u8981\u6ce8\u610f\u7684\u95dc\u9375\u9818\u57df\u90fd\u662f\u4e00\u6a23\u7684\u3002\u9019\u662f Kubernetes Ops \u7684\u4e94\u500b\u652f\u67f1\uff1a","title":"Kubernetes Day2 Ops \u8981\u4f5c\u90a3\u4e9b\u4e8b?"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#cluster-standardization-and-lifecycle-management","text":"\u7576\u4f60\u69cb\u5efa\u5b83\u6642\uff0c\u4f60\u77e5\u9053\u4f60\u7684\u96c6\u7fa4\u4eca\u5929\u662f\u4ec0\u9ebc\u6a23\u5b50\u3002 \u201c\u4f46\u4f60\u600e\u9ebc\u77e5\u9053\u4e00\u500b\u6708\u5f8c\u7684\u6a23\u5b50\uff1f\u201d\u4ed6\u6307\u51fa\uff0c\u5373\u4f7f\u60a8\u4e0d\u518d\u63a5\u89f8\u96c6\u7fa4\uff0c\u201c\u5177\u6709\u8db3\u5920\u9ad8\u6b0a\u9650\u7684\u5df2\u5b89\u88dd\u9644\u52a0\u7d44\u4ef6\u6700\u7d42\u53ef\u80fd\u6703\u5728\u60a8\u4e0d\u77e5\u60c5\u7684\u60c5\u6cc1\u4e0b\u66f4\u6539\u57fa\u790e\u914d\u7f6e\u3002\u201d \u60a8\u9700\u8981\u5bc6\u5207\u95dc\u6ce8\u96c6\u7fa4\u7684\u6574\u500b\u751f\u547d\u9031\u671f\uff0c\u5305\u62ec\u5b83\u5982\u4f55\u53d7\u5230\u8207\u5b83\u4ea4\u4e92\u7684\u5176\u4ed6\u5de5\u5177\u548c\u7528\u6236\u7684\u5f71\u97ff\u3002\u70ba\u5728\u60a8\u7684\u7d44\u7e54\u4e2d\u5275\u5efa\u548c\u66f4\u65b0\u96c6\u7fa4\u8a2d\u7f6e\u6a19\u6e96\uff0c\u540c\u6642\u78ba\u4fdd\u4e00\u7d44\u7d93\u904e\u6279\u51c6\u7684\u9644\u52a0\u7d44\u4ef6\u59cb\u7d42\u5728\u60a8\u7684\u96c6\u7fa4\u968a\u5217\u4e2d\u904b\u884c\uff0c\u6709\u52a9\u65bc\u7c21\u5316\u5728\u767c\u751f\u7570\u5e38\u6642\u8b58\u5225\u7570\u5e38\u7684 Day2 \u4efb\u52d9\u3002","title":"Cluster Standardization and Lifecycle Management"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#secure-access-and-isolation","text":"\u5728 Kubernetes \u7684\u5e6b\u52a9\u4e0b\u5b8c\u5168\u6216\u90e8\u5206\u5728\u96f2\u4e0a\u904b\u884c\u7684\u5206\u4f48\u5f0f\u7db2\u7d61\u9700\u8981\u4e00\u7a2e\u5168\u65b0\u7684\u65b9\u6cd5\u4f86\u5be6\u73fe\u904b\u71df\u5546/\u958b\u767c\u4eba\u54e1\u7684\u8a2a\u554f\u548c\u5b89\u5168\u6027\u3002\u7121\u8655\u4e0d\u5728\u7684\u7db2\u7d61\u5f88\u5bb9\u6613\u53d7\u5230\u4efb\u4f55\u5730\u65b9\u7684\u653b\u64ca\u3002 \u96f6\u4fe1\u4efb\u5b89\u5168\u65b9\u6cd5\u5df2\u5728\u5df2\u9077\u79fb\u6216\u6b63\u5728\u9077\u79fb\u5230\u96f2\u7684\u7d44\u7e54\u4e2d\u53d6\u5f97\u9032\u5c55\u3002\u96f6\u4fe1\u4efb\u62d2\u7d55\u820a\u7684\u201c\u57ce\u5821\u548c\u8b77\u57ce\u6cb3\u201d\u5b89\u5168\u6a21\u578b\uff0c\u800c\u662f\u4f7f\u7528\u7cbe\u7d30\u7684\u81ea\u52d5\u8eab\u4efd\u9a57\u8b49\u548c\u6388\u6b0a\u6b0a\u9650\u4f86\u4fdd\u8b77\u91cd\u8981\u7684\u57fa\u790e\u8a2d\u65bd\u548c\u6578\u64da\uff0c\u7121\u8ad6\u5b83\u5011\u4f4d\u65bc\u4f55\u8655\u3002 \u4f46\u662f\uff0c\u5728\u8a2a\u554f\u63a7\u5236\u65b9\u9762\uff0c\u8a31\u591a\uff08\u5982\u679c\u4e0d\u662f\u5927\u591a\u6578\uff09\u7d44\u7e54\u4ecd\u5728\u52aa\u529b\u89e3\u6c7a\u57fa\u790e\u554f\u984c\u3002\u5728 strongDM 1 \u6708\u4efd\u767c\u5e03\u7684\u4e00\u9805\u8abf\u67e5\u4e2d\uff0c80% \u7684\u53c3\u8207\u8005\u8868\u793a\u4ed6\u5011\u7684\u7d44\u7e54\u4eca\u5e74\u5c07\u81f4\u529b\u65bc\u8a2a\u554f\u7ba1\u7406\uff1b\u53ea\u6709 30% \u7684\u4eba\u8868\u793a\u4ed6\u5011\u7684\u8a08\u5283\u4e2d\u6709\u4e00\u500b\u96f6\u4fe1\u4efb\u9805\u76ee\u3002 \uff08\u5728\u540c\u4e00\u7814\u7a76\u4e2d\uff0c\u4e09\u5206\u4e4b\u4e00\u7684\u53d7\u8a2a\u8005\u7a31 Kubernetes \u662f\u4ed6\u5011\u4f7f\u7528\u7684\u6700\u5177\u6311\u6230\u6027\u7684\u6280\u8853\u3002\uff09 \u4fdd\u8b77\u5c0d Kubernetes API \u670d\u52d9\u5668\u7684\u8a2a\u554f\u6709\u52a9\u65bc\u9632\u6b62\u672a\u7d93\u6388\u6b0a\u7684\u63a2\u6e2c\u3002\u7576\u67d0\u500b\u7279\u5b9a\u7684 Kubernetes \u96c6\u7fa4\u51fa\u73fe\u554f\u984c\u6642\u2014\u2014\u4f8b\u5982\u6ce8\u5165\u60e1\u610f\u8edf\u4ef6\u2014\u2014\u9700\u8981\u9694\u96e2\u8a72\u96c6\u7fa4\u6216\u5fae\u670d\u52d9\u4ee5\u907f\u514d\u554f\u984c\u8513\u5ef6\u3002","title":"Secure Access and Isolation"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#observability-and-visibility","text":"Kubernetes \u96c6\u7fa4\u7684\u7ba1\u7406\u54e1\u9700\u8981\u5c0d\u6240\u6709\u74b0\u5883\u6709\u8db3\u5920\u7684\u53ef\u898b\u6027\uff0c\u4ee5\u53ca\u5fc5\u8981\u7684\u8b66\u5831\u548c\u76e3\u63a7\u7d1a\u5225\uff0c\u4ee5\u4fbf\u5728\u554f\u984c\u51fa\u73fe\u6642\u5c0d\u5176\u9032\u884c\u5206\u985e\u3002 Rafay \u7684 Kubernetes Operations Platform \u7b49\u89e3\u6c7a\u65b9\u6848\u63d0\u4f9b\u4e86\u958b\u7bb1\u5373\u7528\u7684\u9019\u4e9b\u529f\u80fd\u3002\u8a2a\u554f\u9577\u671f\u6307\u6a19\u548c\u8b66\u5831\u6578\u64da\u53ef\u4ee5\u771f\u6b63\u5e6b\u52a9 SRE \u548c IT Ops \u4e86\u89e3\u5176\u96c6\u7fa4\u8266\u968a\u7684\u8da8\u52e2\uff0c\u4ee5\u5e6b\u52a9\u9032\u884c\u898f\u5283\u548c\u9810\u6e2c\u3002","title":"Observability and Visibility"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#governance-and-compliance","text":"\u7576\u7136\uff0cKubernetes \u662f\u958b\u6e90\u7684\u2014\u2014\u5b8c\u5168\u958b\u653e\uff0c\u5c31\u50cf\u72c2\u91ce\u7684\u897f\u90e8\u4e00\u6a23\u3002\u4f7f\u7528\u5b83\u7684\u516c\u53f8\u901a\u5e38\u96e3\u4ee5\u6dfb\u52a0\u95dc\u9375\u7684\u6cbb\u7406\u548c\u5408\u898f\u6027\u529f\u80fd\uff0c\u4f8b\u5982\u65e5\u8a8c\u8a18\u9304\u3001\u6f02\u79fb\u6aa2\u6e2c\u548c\u53ef\u5be9\u8a08\u6027\u3002 \u96c6\u4e2d\u7684\u53ef\u57f7\u884c\u96c6\u7fa4\u914d\u7f6e\u6a21\u578b\u6709\u52a9\u65bc\u5be6\u73fe\u4f01\u696d\u7bc4\u570d\u7684\u96c6\u7fa4\u6a19\u6e96\u5316\u3002\u6709\u4e00\u7a2e\u65b9\u6cd5\u4f86\u78ba\u4fdd\u90e8\u7f72\u6240\u6709\u5f37\u5236\u7684\u5b89\u5168\u548c\u64cd\u4f5c\u9644\u52a0\u7d44\u4ef6\u6709\u52a9\u65bc\u78ba\u4fdd\u7b26\u5408\u4f01\u696d\u7b56\u7565\u3002\u6b64\u5916\uff0c\u6709\u4e00\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u6aa2\u6e2c\u96c6\u7fa4\u4f55\u6642\u504f\u96e2\u4f01\u696d\u7b56\u7565\uff0c\u4e26\u5728\u51fa\u73fe\u554f\u984c\u6642\u5c0d\u5176\u9032\u884c\u88dc\u6551\uff0c\u9019\u4e5f\u662f\u4e00\u9805\u95dc\u9375\u8981\u6c42\u3002 Rafay \u7684 Kubernetes \u904b\u71df\u5e73\u53f0\u63d0\u4f9b\u96c6\u7fa4\u85cd\u5716\u3001\u9644\u52a0\u7248\u672c\u63a7\u5236\u3001\u7b56\u7565\u5be6\u65bd\u548c\u9055\u898f\u5831\u544a\u7b49\u529f\u80fd\uff0c\u4ee5\u53ca\u53ef\u4ee5\u963b\u6b62\u5c0d\u96c6\u7fa4\u7bc4\u570d\u8cc7\u6e90\uff08\u5982\u5165\u53e3\u63a7\u5236\u5668\u3001\u904b\u884c\u6642\u5b89\u5168\u5de5\u5177\u7b49\uff09\u7684\u66f4\u6539\u7684\u6f02\u79fb\u6aa2\u6e2c\u908f\u8f2f\uff0c\u4ee5\u53ca\u96c6\u7fa4\u6d3b\u52d5\u7684\u7aef\u5230\u7aef\u5be9\u8a08\u8ddf\u8e2a\u3002","title":"Governance and Compliance"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#third-party-integrations-and-maintenance","text":"\u4f7f\u652f\u6301\u73fe\u4ee3\uff08\u57fa\u65bc Kubernetes\uff09\u57fa\u790e\u8a2d\u65bd\u7684\u6240\u6709\u670d\u52d9\u548c\u5de5\u5177\u7121\u7e2b\u904b\u884c\u4e26\u5354\u540c\u5de5\u4f5c\u53ef\u80fd\u6703\u5f88\u68d8\u624b\u3002\u4e3b\u8981\u7684\u96f2\u63d0\u4f9b\u5546\u901a\u5e38\u6709\u4e00\u5957\u5de5\u5177\u4f86\u5e6b\u52a9\u7ba1\u7406 Kubernetes\u2014\u2014\u4f46\u5982\u679c\u4f60\u8d70\u51fa\u8a72\u96f2\u63d0\u4f9b\u5546\u7684\u9818\u57df\uff0c\u9019\u4e9b\u5de5\u5177\u4e26\u4e0d\u7e3d\u662f\u80fd\u5f88\u597d\u5730\u8f49\u5316\uff0c\u4e5f\u8a31\u662f\u70ba\u4e86\u90e8\u7f72\u5230\u591a\u500b\u96f2\u3001\u5728\u672c\u5730\u74b0\u5883\u4e2d\uff0c\u6216\u8005\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u5728\u908a\u7de3\u3002 \u9019\u5c31\u50cf\u4e00\u500b\u62fc\u5716\uff0c\u9700\u8981\u4e0d\u65b7\u5730\u7d44\u5408\u5728\u4e00\u8d77\uff0c\u5373\u4f7f\u6bcf\u500b\u62fc\u5716\u90fd\u6709\u81ea\u5df1\u7684\u751f\u547d\u9031\u671f\u9700\u8981\u7ba1\u7406\u3002\u958b\u6e90\u5de5\u5177\u548c\u7d44\u4ef6\u53ef\u80fd\u6703\u5e36\u4f86\u81ea\u5df1\u7684\u554f\u984c\uff1a\u4f8b\u5982 2021 \u5e74\u672b\u5728 Log4j \u4e2d\u767c\u73fe\u7684\u6f0f\u6d1e\u3002\u6216\u8005\u53ea\u662f\u6bcf\u5b63\u5ea6\u66f4\u65b0\u60a8\u7684 Kubernetes \u672c\u8eab\u7248\u672c\u6240\u6d89\u53ca\u7684\u8f9b\u52de\u3002 \u904e\u6642\u7684\u5de5\u5177\u53ef\u80fd\u6703\u5c0e\u81f4\u8a08\u5283\u5916\u505c\u6a5f\uff0c\u5f9e\u800c\u76f4\u63a5\u5f71\u97ff\u6700\u7d42\u5ba2\u6236\uff0c\u6700\u7d42\u5f71\u97ff\u696d\u52d9\u3002","title":"Third-Party Integrations and Maintenance"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#k8s","text":"Kubernetes Day2 \u7684\u8ca0\u64d4\u4e0d\u50c5\u50c5\u662f\u96f2\u652f\u51fa\u3002\u904b\u71df\u548c\u7dad\u8b77 Kubernetes \u9084\u53ef\u4ee5\u8b93\u5718\u968a\u6210\u54e1\u9060\u96e2\u76f4\u63a5\u70ba\u516c\u53f8\u5e36\u4f86\u6536\u5165\u7684\u7522\u54c1\u548c\u61c9\u7528\u7a0b\u5e8f\u3002 \u4e00\u4e9b\u53ef\u80fd\u589e\u52a0 Day2 \u982d\u75db\u7684\u4e8b\u60c5\u6e90\u65bc \u7f3a\u4e4f\u6a19\u6e96\u5316 \u3002\u7576\u5177\u6709\u7368\u7279\u914d\u7f6e\u7684\u96c6\u7fa4\u5931\u6557\u6642\uff0c\u5b83\u5011\u53ef\u80fd\u5305\u62ec\u8907\u96dc\u7684\u5206\u985e\u548c\u652f\u6301\u6210\u672c\uff0c\u6216\u8005\u7531\u63a7\u5236\u5668\u548c\u96c6\u7fa4\u4e4b\u9593\u7684\u81ea\u5b9a\u7fa9\u8a2a\u554f\u548c\u806f\u7db2\u5c0e\u81f4\u7684\u5b89\u5168\u98a8\u96aa\u3002\u7f3a\u4e4f kubectl \u8a2a\u554f\u63a7\u5236\u4e5f\u6703\u4f7f\u696d\u52d9\u9762\u81e8\u5408\u898f\u548c\u6cbb\u7406\u98a8\u96aa\u3002 \u201c\u7ba1\u7406\u8005\u6709\u6642\u4e0d\u9858\u610f\u5728 Kubernetes \u4e4b\u65c5\u7684\u65e9\u671f\u63d0\u51fa Day2 \u7684\u554f\u984c\uff0c\u56e0\u70ba\u201c\u4ed6\u5011\u4e0d\u60f3\u6253\u4e82\u958b\u767c\u4eba\u54e1\u7684\u5fc3\u614b\u3002\u201d \u9019\u7a2e\u6c89\u9ed8\u662f\u932f\u8aa4\u7684\uff1a\u958b\u767c\u4eba\u54e1\u5df2\u7d93\u77e5\u9053\u4ed6\u5011\u7684\u5de5\u4f5c\u91cf\u56e0\u70ba Kubernetes Day 2 \u7684\u554f\u984c\u800c\u5931\u53bb\u5e73\u8861\u3002 \u7576\u6211\u8207\u5be6\u969b\u7684\u958b\u767c\u4eba\u54e1\u4ea4\u8ac7\u6642\uff0c\u4ed6\u5011\u6703\u8aaa\uff0c\"\u6211\u4e0d\u77e5\u9053\u70ba\u4ec0\u9ebc\u6211\u8981\u7de8\u5beb Helm chart \u800c\u4e0d\u662f\u6211\u7684\u61c9\u7528\u7a0b\u5e8f\"\u3002 \u201c\u662f\u7684\uff0c\u6211\u60f3\u8a66\u9a57\u4e00\u4e0b Kubernetes\u3002\u6211\u6709\u9ede\u559c\u6b61\u9019\u9805\u65b0\u6280\u8853\u3002\u7576\u6211\u6700\u521d\u63a5\u89f8\u5b83\u6642\uff0c\u6211\u559c\u6b61\u5b78\u7fd2\u5b83\u3002\u4f46\u662f\uff0c\u6211\u7684\u4e0a\u5e1d\uff0c\u6211\u9084\u6709\u5de5\u4f5c\u8981\u505a\u3002\u201d \u4ed6\u8aaa\uff0cC \u7d1a\u4e3b\u7ba1\u3001DevOps \u7d93\u7406\u548c\u958b\u767c\u4eba\u54e1\u90fd\u60f3\u8981\u540c\u6a23\u7684\u6771\u897f\uff1a\u4e00\u7a2e\u4ea4\u4ed8\u66f4\u591a\u66f4\u597d\u4ee3\u78bc\u4e26\u70ba\u696d\u52d9\u5275\u9020\u66f4\u591a\u6536\u5165\u7684\u6709\u6548\u65b9\u5f0f\u3002\u4f46\u662f\uff0c\u4ed6\u6307\u51fa\uff0c\u201c\u4ed6\u5011\u8aaa\u7684\u4e0d\u662f\u540c\u4e00\u7a2e\u8a9e\u8a00\u3002\u5728\u6b64\u904e\u7a0b\u4e2d\uff0c\u9019\u4e9b\u5927\u578b\u4f01\u696d\u7684\u4ea4\u4ed8\u6210\u679c\u9060\u9060\u843d\u5f8c\u65bc\u8a08\u5283\u3002\u201d","title":"\u69cb\u5efa K8s \u5e73\u53f0\u7684\u6301\u7e8c\u6210\u672c"},{"location":"kubernetes/observability/day2-ops/k8s-day2-problem/#kubernetes-day2","text":"\u70ba\u4e86\u8b93\u60a8\u7684\u5718\u968a\u548c\u60a8\u7684\u7d44\u7e54\u70ba\u76e3\u7763\u57fa\u65bc Kubernetes \u69cb\u5efa\u7684\u96f2\u67b6\u69cb\u7684\u9577\u671f\u627f\u8afe\u505a\u597d\u6e96\u5099\uff0c\u6e96\u78ba\u4e86\u89e3\u60a8\u7684\u7d44\u7e54\u6b63\u5728\u5f9e\u4e8b\u7684\u5de5\u4f5c\u975e\u5e38\u91cd\u8981\u3002 \u5728\u4f60\u958b\u59cb\u4e00\u500b\u5305\u542b\u904b\u884c Kubernetes \u7684\u96f2\u539f\u751f\u9805\u76ee\u4e4b\u524d\uff0c\u8acb\u8003\u616e\u4e00\u4e0b\u4f60\u7684\u7d44\u7e54\u6b63\u5728\u52aa\u529b\u5b8c\u6210\u4ec0\u9ebc\u3002 \u9996\u5e2d\u4fe1\u606f\u5b98\u548c\u5176\u4ed6\u9ad8\u7d1a\u7ba1\u7406\u4eba\u54e1\u201c\u904e\u53bb\u5e38\u5e38\u6311\u6230\u4ed6\u5011\u7684\u5718\u968a\u505a\u66f4\u591a\u7684\u4e8b\u60c5\uff0c\u9032\u884c\u66f4\u591a\u7684\u5be6\u9a57\u3002\u73fe\u5728\u554f\u984c\u61c9\u8a72\u662f\uff0c\u201c\u4f60\u70ba\u4ec0\u9ebc\u8981\u8a66\u9a57 Kubernetes \u9644\u52a0\u7d44\u4ef6\uff1f\u5411\u6211\u8b49\u660e\uff0c\u5728\u9032\u884c\u5be6\u9a57\u4e4b\u524d\uff0c\u60a8\u9700\u8981\u69cb\u5efa\u4e00\u4e9b\u8d85\u51fa\u53ef\u4ee5\u8cfc\u8cb7\u73fe\u6210\u7684\u6771\u897f\u7684\u6771\u897f\u3002\u201d K8s \u6a19\u6e96\u5316\u7684\u771f\u6b63\u6210\u672c\u5305\u62ec\u5b9a\u50f9\u6a21\u578b\u3001\u5be6\u65bd\u548c\u7dad\u8b77\u3002\u5728\u8981\u554f\u7684\u554f\u984c\u4e2d\uff1a \u60a8\u5c07\u5982\u4f55\u78ba\u5b9a\u54ea\u4e9b\u5de5\u5177\u6700\u9069\u5408\u60a8\u7684\u7528\u4f8b\uff1f \u4f60\u5c07\u5982\u4f55\u8ddf\u4e0a\u958b\u6e90\u7684\u8b8a\u5316\uff1f \u662f\u5426\u6703\u7e7c\u7e8c\u6295\u8cc7\u65bc\u5de5\u5177\u96c6\u6210\uff1f \u7576\u51fa\u73fe\u4e92\u64cd\u4f5c\u6027\u554f\u984c\u548c\u64cd\u4f5c\u554f\u984c\u6642\uff0c\u8ab0\u4f86\u89e3\u6c7a\u5b83\u5011\uff1f \u60a8\u80fd\u5426\u4ee5\u8db3\u5920\u5feb\u7684\u901f\u5ea6\u50f1\u50ad\u8db3\u5920\u591a\u5177\u6709\u4e91\u539f\u751f\u6280\u80fd\u7684\u4eba\u54e1\u2014\u2014\u6216\u8005\u57f9\u8a13\u73fe\u6709\u7684\u5718\u968a\u6210\u54e1\uff1f \u6700\u91cd\u8981\u7684\u662f\uff0c\u8003\u616e\u8207\u5176\u4ed6\u4e5f\u8de8\u8d8a\u9d3b\u6e9d\u4e26\u5be6\u65bd Kubernetes \u7684\u7d44\u7e54\u4ea4\u8ac7\u3002 \u9996\u5148\uff0c\u4e86\u89e3\u5176\u4ed6\u4eba\u662f\u5982\u4f55\u505a\u4e8b\u7684\u2014\u2014\u56e0\u70ba\u9019\u6703\u8b93\u4f60\u4e86\u89e3\u9019\u500b\u554f\u984c\u6709\u591a\u96e3\u6216\u591a\u7c21\u55ae\u3002 \u201c\u5f9e\u5931\u6557\u4e2d\u5b78\u7fd2\u5f88\u68d2\uff0c\u4f46\u5b83\u662f\u4ee5\u6642\u9593\u70ba\u4ee3\u50f9\u7684\u3002\u7576\u60a8\u53ef\u4ee5\u5411\u540c\u884c\u5b78\u7fd2\u6642\uff0c\u70ba\u4ec0\u9ebc\u8981\u8d70\u9019\u689d\u8def\uff1f Kubernetes \u793e\u5340\u7684\u7f8e\u5999\u4e4b\u8655\u5728\u65bc\u4eba\u5011\u975e\u5e38\u9858\u610f\u5206\u4eab\u4ed6\u5011\u7684\u7d93\u9a57\u548c\u610f\u898b\u3002\u201d \u5230 2022 \u5e74\uff0c\u4f60\u4e26\u4e0d\u662f\u552f\u4e00\u4e00\u5bb6\u81f4\u529b\u65bc Kubernetes \u7684\u516c\u53f8\u3002\u8a31\u591a\u5176\u4ed6\u516c\u53f8\u5df2\u7d93\u7d93\u6b77\u6216\u6b63\u5728\u7d93\u6b77\u9019\u4e00\u65c5\u7a0b\u3002\u6709\u8cc7\u6e90\u53ef\u4ee5\u505a\u5230\u9019\u4e00\u9ede\u3002\u5c0b\u627e\u4ed6\u5011\u3002\u201d","title":"\u89e3\u6c7a Kubernetes Day2 \u554f\u984c"},{"location":"kubernetes/observability/logging/event-exporter/","text":"# add Bitname repository to Helm helm repo add bitnami https://charts.bitnami.com/bitnami # update chart information helm repo update $ helm repo add bitnami https://charts.bitnami.com/bitnami $ helm install my-release bitnami/kubernetes-event-exporter # list all available charts in the Bitname repository $ helm search repo bitnami NAME CHART VERSION APP VERSION DESCRIPTION bitnami/airflow 13.1.4 2.3.4 Apache Airflow is a tool to express and execute... bitnami/apache 9.2.3 2.4.54 Apache HTTP Server is an open-source HTTP serve... bitnami/argo-cd 4.1.3 2.4.11 Argo CD is a continuous delivery tool for Kuber... bitnami/argo-workflows 2.4.3 3.3.9 Argo Workflows is meant to orchestrate Kubernet... bitnami/aspnet-core 3.5.2 6.0.8 ASP.NET Core is an open-source framework for we... bitnami/cassandra 9.4.2 4.0.6 Apache Cassandra is an open source distributed ... bitnami/cert-manager 0.8.2 1.9.1 Cert Manager is a Kubernetes add-on to automate... bitnami/common 2.0.2 2.0.2 A Library Helm Chart for grouping common logic ... bitnami/concourse 1.4.2 7.8.2 Concourse is an automation system written in Go... bitnami/consul 10.8.2 1.13.1 HashiCorp Consul is a tool for discovering and ... bitnami/contour 9.1.2 1.22.1 Contour is an open source Kubernetes ingress co... bitnami/contour-operator 2.1.3 1.22.1 The Contour Operator extends the Kubernetes API... bitnami/dataplatform-bp1 12.0.2 1.0.1 DEPRECATED This Helm chart can be used for the ... bitnami/dataplatform-bp2 12.0.5 1.0.1 DEPRECATED This Helm chart can be used for the ... bitnami/discourse 8.1.3 2.8.8 Discourse is an open source discussion platform... bitnami/dokuwiki 13.1.2 2022.7.31 DokuWiki is a standards-compliant wiki optimize... bitnami/drupal 12.4.3 9.4.5 Drupal is one of the most versatile open source... bitnami/ejbca 6.3.3 7.9.0-2 EJBCA is an enterprise class PKI Certificate Au... bitnami/elasticsearch 19.3.0 8.4.1 Elasticsearch is a distributed search and analy... bitnami/etcd 8.4.5 3.5.4 etcd is a distributed key-value store designed ... bitnami/external-dns 6.8.2 0.12.2 ExternalDNS is a Kubernetes addon that configur... bitnami/fluentd 5.3.4 1.15.2 Fluentd collects events from various data sourc... bitnami/geode 1.1.1 1.15.0 Apache Geode is a data management platform that... bitnami/ghost 19.1.7 5.14.0 Ghost is an open source publishing platform des... bitnami/grafana 8.2.6 9.1.3 Grafana is an open source metric analytics and ... bitnami/grafana-loki 2.3.3 2.6.1 Grafana Loki is a horizontally scalable, highly... bitnami/grafana-operator 2.7.2 4.6.0 Grafana Operator is a Kubernetes operator that ... bitnami/grafana-tempo 1.4.1 1.5.0 Grafana Tempo is a distributed tracing system t... bitnami/haproxy 0.5.3 2.6.5 HAProxy is a TCP proxy and a HTTP reverse proxy... bitnami/haproxy-intel 0.2.5 2.6.5 HAProxy is a high-performance, open-source load... bitnami/harbor 15.2.2 2.6.0 Harbor is an open source trusted cloud-native r... bitnami/influxdb 5.4.1 2.4.0 InfluxDB(TM) is an open source time-series data... bitnami/jasperreports 14.3.1 8.1.0 JasperReports Server is a stand-alone and embed... bitnami/jenkins 11.0.1 2.361.1 Jenkins is an open source Continuous Integratio... bitnami/joomla 13.3.5 4.2.2 Joomla! is an award winning open source CMS pla... bitnami/jupyterhub 1.4.3 1.5.0 JupyterHub brings the power of notebooks to gro... bitnami/kafka 18.3.1 3.2.1 Apache Kafka is a distributed streaming platfor... bitnami/keycloak 9.8.1 18.0.2 Keycloak is a high performance Java-based ident... bitnami/kiam 1.1.2 4.2.0 kiam is a proxy that captures AWS Metadata API ... bitnami/kibana 10.2.2 8.4.1 Kibana is an open source, browser based analyti... bitnami/kong 6.4.8 2.8.1 Kong is an open source Microservice API gateway... bitnami/kube-prometheus 8.1.5 0.59.0 Prometheus Operator provides easy monitoring de... bitnami/kube-state-metrics 3.2.2 2.6.0 kube-state-metrics is a simple service that lis... bitnami/kubeapps 10.3.3 2.5.1 Kubeapps is a web-based UI for launching and ma... bitnami/kubernetes-event-exporter 1.5.2 0.11.0 Kubernetes Event Exporter makes it easy to expo... bitnami/kubewatch 3.3.4 0.1.0 DEPRECATED Kubewatch is a Kubernetes watcher th... bitnami/logstash 5.1.2 8.4.1 Logstash is an open source data processing engi... bitnami/magento 21.1.3 2.4.5 Magento is a powerful open source e-commerce pl... bitnami/mariadb 11.3.0 10.6.9 MariaDB is an open source, community-developed ... bitnami/mariadb-galera 7.4.1 10.6.9 MariaDB Galera is a multi-primary database clus... bitnami/matomo 0.2.2 4.11.0 Matomo, formerly known as Piwik, is a real time... bitnami/mediawiki 14.3.1 1.38.2 MediaWiki is the free and open source wiki soft... bitnami/memcached 6.2.3 1.6.17 Memcached is an high-performance, distributed m... bitnami/metallb 4.1.2 0.13.5 MetalLB is a load-balancer implementation for b... bitnami/metrics-server 6.1.2 0.6.1 Metrics Server aggregates resource usage data, ... bitnami/minio 11.10.1 2022.9.7 MinIO(R) is an object storage server, compatibl... bitnami/mongodb 13.1.2 6.0.1 MongoDB(R) is a relational open source NoSQL da... bitnami/mongodb-sharded 6.1.1 6.0.1 MongoDB(R) is an open source NoSQL database tha... bitnami/moodle 14.2.1 4.0.3 Moodle(TM) LMS is an open source online Learnin... bitnami/mxnet 3.1.2 1.9.1 Apache MXNet (Incubating) is a flexible and eff... bitnami/mysql 9.3.2 8.0.30 MySQL is a fast, reliable, scalable, and easy t... bitnami/nats 7.4.2 2.8.4 NATS is an open source, lightweight and high-pe... bitnami/nginx 13.2.4 1.23.1 NGINX Open Source is a web server that can be a... bitnami/nginx-ingress-controller 9.3.8 1.3.1 NGINX Ingress Controller is an Ingress controll... bitnami/nginx-intel 2.1.3 0.4.7 NGINX Open Source for Intel is a lightweight se... bitnami/node 19.1.2 16.17.0 Node.js is a runtime environment built on V8 Ja... bitnami/node-exporter 3.1.2 1.3.1 Prometheus exporter for hardware and OS metrics... bitnami/oauth2-proxy 3.3.1 7.3.0 A reverse proxy and static file server that pro... bitnami/odoo 21.6.2 15.0.20220810 Odoo is an open source ERP and CRM platform, fo... bitnami/opencart 12.4.1 3.0.3-8 OpenCart is free open source ecommerce platform... bitnami/orangehrm 11.0.3 4.9.0-0 DEPRECATED OrangeHRM is a free HR management sy... bitnami/osclass 14.2.2 8.0.2 Osclass allows you to easily create a classifie... bitnami/owncloud 12.2.2 10.10.0 ownCloud is an open source content collaboratio... bitnami/parse 19.1.3 5.2.5 Parse is a platform that enables users to add a... bitnami/phpbb 12.3.3 3.3.8 phpBB is a popular bulletin board that features... bitnami/phpmyadmin 10.3.2 5.2.0 phpMyAdmin is a free software tool written in P... bitnami/pinniped 0.3.0 0.19.0 Pinniped is an identity service provider for Ku... bitnami/postgresql 11.8.1 14.5.0 PostgreSQL (Postgres) is an open source object-... bitnami/postgresql-ha 9.4.1 14.5.0 This PostgreSQL cluster solution includes the P... bitnami/prestashop 15.3.1 1.7.8-7 PrestaShop is a powerful open source eCommerce ... bitnami/pytorch 2.5.2 1.12.1 PyTorch is a deep learning platform that accele... bitnami/rabbitmq 10.3.5 3.10.7 RabbitMQ is an open source general-purpose mess... bitnami/rabbitmq-cluster-operator 2.7.2 1.14.0 The RabbitMQ Cluster Kubernetes Operator automa... bitnami/redis 17.1.4 7.0.4 Redis(R) is an open source, advanced key-value ... bitnami/redis-cluster 8.2.2 7.0.4 Redis(R) is an open source, scalable, distribut... bitnami/redmine 20.3.3 5.0.2 Redmine is an open source management applicatio... bitnami/schema-registry 5.1.3 7.2.1 Confluent Schema Registry provides a RESTful in... bitnami/sealed-secrets 1.1.2 0.18.2 Sealed Secrets are \"one-way\" encrypted K8s Secr... bitnami/solr 6.1.4 9.0.0 Apache Solr is an extremely powerful, open sour... bitnami/sonarqube 1.6.0 9.6.1 SonarQube is an open source quality management ... bitnami/spark 6.3.2 3.3.0 Apache Spark is a high-performance engine for l... bitnami/spring-cloud-dataflow 12.1.5 2.9.5 Spring Cloud Data Flow is a microservices-based... bitnami/suitecrm 11.2.1 7.12.7 SuiteCRM is a completely open source, enterpris... bitnami/tensorflow-resnet 3.6.2 2.9.1 TensorFlow ResNet is a client utility for use w... bitnami/testlink 10.0.16 1.9.20 DEPRECATED TestLink is test management software... bitnami/thanos 11.4.0 0.28.0 Thanos is a highly available metrics system tha... bitnami/tomcat 10.4.3 10.0.23 Apache Tomcat is an open-source web server desi... bitnami/wavefront 4.2.3 1.12.0 Wavefront is a high-performance streaming analy... bitnami/wavefront-adapter-for-istio 2.0.6 0.1.5 DEPRECATED Wavefront Adapter for Istio is an ad... bitnami/wavefront-hpa-adapter 1.3.2 0.9.9 Wavefront HPA Adapter for Kubernetes is a Kuber... bitnami/wavefront-prometheus-storage-adapter 2.1.2 1.0.5 Wavefront Storage Adapter is a Prometheus integ... bitnami/wildfly 13.5.3 26.1.2 Wildfly is a lightweight, open source applicati... bitnami/wordpress 15.2.0 6.0.2 WordPress is the world's most popular blogging ... bitnami/wordpress-intel 2.1.5 6.0.2 WordPress for Intel is the most popular bloggin... bitnami/zookeeper 10.1.1 3.8.0 Apache ZooKeeper provides a reliable, centraliz... \u70ba Event Exporter \u91cf\u8eab\u5b9a\u5236\u7684\u914d\u7f6e \u00b6 # download value file from grafana/loki-stack helm show values bitnami/kubernetes-event-exporter > ~/kubernetes-event-exporter-values.yaml \u4f7f\u7528 Helm \u90e8\u7f72 Event Exporter \u00b6 \u6709\u4e86\u81ea\u5b9a\u7fa9\u7684\u503c\u6587\u4ef6\uff0c\u6211\u5011\u7d42\u65bc\u53ef\u4ee5\u4f7f\u7528 Helm \u5b89\u88dd bitnami/kubernetes-event-exporter \uff1a $ helm install k8s-event-exporter bitnami/kubernetes-event-exporter -n kexp --create-namespace -f kubernetes-event-exporter-values.yaml","title":"Event exporter"},{"location":"kubernetes/observability/logging/event-exporter/#event-exporter","text":"# download value file from grafana/loki-stack helm show values bitnami/kubernetes-event-exporter > ~/kubernetes-event-exporter-values.yaml","title":"\u70ba Event Exporter \u91cf\u8eab\u5b9a\u5236\u7684\u914d\u7f6e"},{"location":"kubernetes/observability/logging/event-exporter/#helm-event-exporter","text":"\u6709\u4e86\u81ea\u5b9a\u7fa9\u7684\u503c\u6587\u4ef6\uff0c\u6211\u5011\u7d42\u65bc\u53ef\u4ee5\u4f7f\u7528 Helm \u5b89\u88dd bitnami/kubernetes-event-exporter \uff1a $ helm install k8s-event-exporter bitnami/kubernetes-event-exporter -n kexp --create-namespace -f kubernetes-event-exporter-values.yaml","title":"\u4f7f\u7528 Helm \u90e8\u7f72 Event Exporter"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/","text":"\u4f7f\u7528 Loki \u505a\u70ba Kubernetes \u7684\u65e5\u8a8c\u805a\u5408\u4e93\u4ef6 \u00b6 \u539f\u6587: https://www.thorsten-hans.com/logging-in-kubernetes-with-loki-and-plg-stack/ \u5728\u96f2\u539f\u751f\u74b0\u5883\u4e2d\uff0c\u53ef\u89c0\u5bdf\u6027\u662f\u4e00\u500b\u5de8\u5927\u7684\u8a71\u984c\u3002\u5fc5\u9808\u6536\u96c6\u3001\u7406\u89e3\u548c\u8abf\u67e5\u4f86\u81ea\u4e0d\u540c\u4f86\u6e90\u7684\u6578\u767e\u842c\u689d\u65e5\u8a8c\uff0c\u4ee5\u4e86\u89e3\u4e0d\u540c\u61c9\u7528\u7a0b\u5e8f\u904b\u884c\u5728 Kubernetes \u5e73\u53f0\u6642\u767c\u751f\u7684\u60c5\u6cc1\u3002 \u65e5\u8a8c\u5806\u68e7\uff08\u5982 PLG\uff09\u7684\u76ee\u6a19\u5c31\u662f\u60f3\u8981\u89e3\u6c7a\u9019\u4e9b\u554f\u984c\uff0c\u4e26\u4e14\u901a\u5e38\u7531\u5177\u6709\u5c08\u9580\u8077\u8cac\u7684\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u7d44\u6210\u3002\u5728\u6bcf\u500b\u65e5\u8a8c\u5806\u68e7\u7684\u6838\u5fc3\uff0c\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71\u8ca0\u8cac\u7d22\u5f15\u3001\u5b58\u5132\u548c\u516c\u958b\u65e5\u8a8c\u6d88\u606f\u7684\u67e5\u8a62\u63a5\u53e3\u3002 Loki \u7531 Grafana \u5718\u968a\u69cb\u5efa \uff0c\u662f\u4e00\u500b\u53d7 Prometheus \u9ad8\u5ea6\u555f\u767c\u7684 \u53ef\u64f4\u5c55\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71 \u3002 Loki \u8d8a\u4f86\u8d8a\u53d7\u6b61\u8fce\uff0c\u56e0\u70ba\u5b83\u6613\u65bc\u64cd\u4f5c\u548c\u6aa2\u67e5\u8cc7\u6e90\u5206\u914d - \u7279\u5225\u662f\u5982\u679c\u60a8\u5c07\u5b83\u5176\u5b83\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71(ELK)\u9032\u884c\u6bd4\u8f03\u3002\u672c\u6587\u5c07\u4ecb\u7d39 PLG \u5806\u68e7\uff0c\u5b83\u7531 Promtail\u3001Loki \u548c Grafana \u7d44\u6210\u3002 \u63a2\u7d22 PLG \u5806\u68e7 \u00b6 \u5728\u6211\u5011\u958b\u59cb\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG \u5806\u68e7\u4e4b\u524d\uff0c\u8b93\u6211\u5011\u5feb\u901f\u56de\u9867\u4e00\u4e0b PLG \u7684\u4e09\u500b\u4e3b\u8981\u7d44\u4ef6\u3002\u4e00\u65e6\u6211\u5011\u5c0d\u6bcf\u500b\u7d44\u4ef6\u7684\u4e3b\u8981\u8077\u8cac\u6709\u4e86\u57fa\u672c\u7684\u4e86\u89e3\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u958b\u59cb\u5728\u4e00\u500b\u9583\u4eae\u7684\u65b0 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG\u3002 \u4ec0\u9ebc\u662f Promtail \u00b6 Promtail \u8ca0\u8cac\u5c07\u6578\u64da\u5f15\u5165 Loki\u3002\u5b83\u4ee5 DaemonSet \u7684\u5f62\u5f0f\u5be6\u73fe\uff0c\u9019\u610f\u5473\u8457 Promtail \u5be6\u4f8b\u904b\u884c\u5728 Kubernetes \u96c6\u7fa4\u7684\u6bcf\u500b\u7bc0\u9ede\u4e0a\u3002 DaemonSet \u5b9a\u671f\u5f9e\u5728\u8a72\u7279\u5b9a Kubernetes \u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u6240\u6709\u5bb9\u5668\uff08 stdout \u548c stderr \uff09\u8b80\u53d6\u65e5\u8a8c\u3002\u9664\u4e86\u672c\u5730\u5316\u548c\u8b80\u53d6\u65e5\u8a8c\u6d41\u4e4b\u5916\uff0cPromtail \u9084\u53ef\u4ee5\u5728\u5c07\u65e5\u8a8c\u63a8\u9001\u5230 Loki \u4e4b\u524d\u5c07\u6a19\u7c64\u9644\u52a0\u5230\u65e5\u8a8c\u3002 \u4ec0\u9ebc\u662f Loki \u00b6 Loki \u662f PLG \u5806\u68e7\u7684\u6838\u5fc3\u3002\u5b83\u662f\u91dd\u5c0d\u65e5\u8a8c\u512a\u5316\u7684\u6578\u64da\u5b58\u5132\u3002\u8207\u5176\u4ed6\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71\u76f8\u6bd4\uff0cLoki \u672c\u8eab\u4e26\u4e0d\u7d22\u5f15\u65e5\u8a8c\u6d88\u606f\u3002\u76f8\u53cd\uff0c\u5b83\u7d22\u5f15\u5206\u914d\u7d66\u6bcf\u500b\u65e5\u8a8c\u7684\u6a19\u7c64\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 LogQL \u67e5\u8a62\u5b58\u5132\u5728 Loki \u4e2d\u7684\u65e5\u8a8c\uff0c LogQL \u662f\u4e00\u7a2e\u53d7 PromQL \u555f\u767c\u7684\u67e5\u8a62\u8a9e\u8a00\u3002\u4f7f\u7528 LogQL\uff0c\u6211\u5011\u4e0d\u50c5\u53ef\u4ee5\u5728\u5e7e\u79d2\u9418\u5167\u700f\u89bd\u6578\u767e\u842c\u689d\u65e5\u8a8c\u3002\u6211\u5011\u9084\u53ef\u4ee5\u8f15\u9b06\u5730\u5f9e\u65e5\u8a8c\u4e2d\u63d0\u53d6\u6307\u6a19\u3002 \u4ec0\u9ebc\u662f Grafana \u00b6 Grafana \u7528\u65bc\u53ef\u8996\u5316\u5b58\u5132\u5728 Loki \u4e2d\u7684\u65e5\u8a8c\u3002 Loki \u8207 Grafana \u7121\u7e2b\u96c6\u6210\u3002\u6211\u5011\u53ef\u4ee5\u6839\u64da\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u548c\u5f9e\u8a72\u65e5\u8a8c\u8a08\u7b97\u7684\u6307\u6a19\u5728 Grafana \u4e2d\u69cb\u5efa\u55ae\u7368\u7684\u5100\u8868\u677f\u3002 \u7bc4\u4f8b\u74b0\u5883 \u00b6 \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 \u00b6 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4f86\u5275\u5efa Kubernetes \u96c6\u7fa4\u3002 (\u8a73\u7d30\u8aaa\u660e\u898b: \u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 ) $ k3d cluster create [ NAME ] \u7531\u65bc\u5b83\u5728\u7b2c\u4e00\u6b21\u5b89\u88dd\u6642\u6703\u4e0b\u8f09\u5927\u7d04 150\u2013200MB \u7684 docker \u6620\u50cf\uff0c\u56e0\u6b64\u5b89\u88dd\u6642\u9593\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7684\u4e92\u806f\u7db2\u901f\u5ea6\uff0c\u4f46\u9664\u975e\u60a8\u522a\u9664\u9019\u4e9b\u6620\u50cf\uff0c\u5426\u5247\u60a8\u7684\u4e0b\u4e00\u6b21\u96c6\u7fa4\u5b89\u88dd\u5c07\u82b1\u8cbb\u66f4\u5c11\u7684\u6642\u9593\u3002 INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .27.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u4f7f\u7528 k3d cluster list \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u5df2\u5275\u5efa\u7684\u96c6\u7fa4\u53ca\u5176\u72c0\u614b\u3002 $ k3d cluster list NAME SERVERS AGENTS LOADBALANCER k3s-default 1 /1 0 /0 true \u90e8\u7f72\u793a\u4f8b\u5de5\u4f5c\u8ca0\u8f09 \u00b6 \u96d6\u7136 Promtail \u9ed8\u8a8d\u6703\u5f9e\u6240\u6709\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u5bb9\u5668\u8b80\u53d6\u65e5\u8a8c\uff0c\u4f46\u6211\u5011\u73fe\u5728\u5c07\u90e8\u7f72\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u4f86\u7372\u53d6\u4e00\u4e9b\u6211\u5011\u53ef\u4ee5\u700f\u89bd\u7684\u6578\u64da\u3002 \u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u8abf\u8a66\u7528\u7684\u65e5\u8a8c\u8a18\u9304\u7522\u751f\u5668 (fake logger)\uff0c\u5b83\u5c07\u5177\u6709\u8abf\u8a66\u3001\u4fe1\u606f\u548c\u8b66\u544a\u7684\u65e5\u8a8c\u7d1a\u5225\u7684\u6d88\u606f\u8a18\u9304\u5230\u6a19\u6e96\u8f38\u51fa(stdout)\u3002\u932f\u8aa4\u7d1a\u5225\u7684\u65e5\u8a8c\u5c07\u88ab\u5beb\u5165\u6a19\u6e96\u932f\u8aa4(stderr)\u3002\u5be6\u969b\u7684\u65e5\u8a8c\u6d88\u606f\u4ee5 **JSON \u683c\u5f0f**\u751f\u6210\u3002\u6bcf 500 \u6beb\u79d2\u5c07\u5275\u5efa\u4e00\u689d\u65b0\u7684\u65e5\u8a8c\u6d88\u606f\u3002\u65e5\u8a8c\u6d88\u606f\u5982\u4e0b\u6240\u793a\uff1a { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-04-04T13:41:50+02:00\" , \"version\" : \"1.0.0\" } \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl \u5275\u5efa\u90e8\u7f72\uff0c\u5982\u4ee5\u4e0b\u4ee3\u78bc\u7247\u6bb5\u6240\u793a\uff1a # Create a new Namespace in Kubernetes kubectl create ns sample # Create a new Deployment cat <<EOF | kubectl apply -n sample -f - apiVersion: apps/v1 kind: Deployment metadata: labels: app: fake-logger environment: development name: fake-logger spec: selector: matchLabels: app: fake-logger environment: development template: metadata: labels: app: fake-logger environment: development spec: containers: - image: thorstenhans/fake-logger:0.0.2 name: fake-logger EOF pod \u6e96\u5099\u5c31\u7dd2\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl logs -n sample -l app=fake-logger \u4f86\u6aa2\u67e5\u65e5\u8a8c\u3002 kubectl logs -n sample -l app = fake-logger \u7d50\u679c\u5982\u4e0b: { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:32Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:32Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"warning\" , \"msg\" : \"This is a warning\" , \"time\" : \"2022-08-20T03:00:33Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"warning\" , \"msg\" : \"This is a warning\" , \"time\" : \"2022-08-20T03:00:33Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-08-20T03:00:34Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-08-20T03:00:34Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"error\" , \"msg\" : \"Oh no! this is an error\" , \"time\" : \"2022-08-20T03:00:35Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"error\" , \"msg\" : \"Oh no! this is an error\" , \"time\" : \"2022-08-20T03:00:35Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:36Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:36Z\" , \"version\" : \"1.0.0\" } ... ... \u4f7f\u7528 Helm \u5b89\u88dd PLG \u5806\u68e7 \u00b6 \u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG \u5806\u68e7\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u4f7f\u7528 Helm - Kubernetes \u7684\u5305\u7ba1\u7406\u5668\u3002\u5982\u679c\u60a8\u4ee5\u524d\u6c92\u6709\u4f7f\u7528\u904e helm\uff0c\u8acb\u8003\u616e\u95b1\u8b80 \u201c \u200b\u200bHelm 3 \u5165\u9580 \u201d \u6587\u7ae0\u3002 \u5c07 Grafana \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 Helm \u00b6 \u5728\u6211\u5011\u4f7f\u7528 Helm 3 \u5728\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG \u5806\u68e7\u4e4b\u524d\uff0c\u6211\u5011\u5fc5\u9808\u5c07\u5b98\u65b9 Grafana \u5b58\u5132\u5eab\u6dfb\u52a0\u5230\u6211\u5011\u7684\u672c\u5730 Helm 3 \u5ba2\u6236\u7aef\u4e26\u66f4\u65b0\u5716\u8868\u4fe1\u606f\uff1a # add Grafana repository to Helm helm repo add grafana https://grafana.github.io/helm-charts # update chart information helm repo update \u5c07\u5b98\u65b9 Grafana \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 Helm \u4e26\u66f4\u65b0\u6240\u6709 charts \u4fe1\u606f\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 helm search \u6aa2\u67e5 Grafana \u5b58\u5132\u5eab\u4e2d\u53ef\u7528\u7684 chart\uff1a # list all available charts in the Grafana repository $ helm search repo grafana NAME CHART VERSION APP VERSION DESCRIPTION grafana/grafana 6.32.14 9.0.5 The leading tool for querying and visualizing t... grafana/grafana-agent-operator 0.2.3 0.25.1 A Helm chart for Grafana Agent Operator grafana/enterprise-logs 2.4.1 v1.5.1 Grafana Enterprise Logs grafana/enterprise-logs-simple 1.2.1 v1.4.0 DEPRECATED Grafana Enterprise Logs (Simple Scal... grafana/enterprise-metrics 1.9.0 v1.7.0 DEPRECATED Grafana Enterprise Metrics grafana/fluent-bit 2.3.1 v2.1.0 Uses fluent-bit Loki go plugin for gathering lo... grafana/loki 2.14.1 v2.6.1 Loki: like Prometheus, but for logs. grafana/loki-canary 0.9.2 2.6.1 Helm chart for Grafana Loki Canary grafana/loki-distributed 0.55.5 2.6.1 Helm chart for Grafana Loki in microservices mode grafana/loki-simple-scalable 1.8.9 2.6.1 Helm chart for Grafana Loki in simple, scalable... grafana/loki-stack 2.7.1 v2.6.1 Loki: like Prometheus, but for logs. grafana/mimir-distributed 3.0.0 2.2.0 Grafana Mimir grafana/mimir-openshift-experimental 2.1.0 2.0.0 Grafana Mimir on OpenShift Experiment grafana/oncall 1.0.3 v1.0.13 Developer-friendly incident response with brill... grafana/promtail 6.3.0 2.6.1 Promtail is an agent which ships the contents o... grafana/rollout-operator 0.1.2 v0.1.1 Grafana rollout-operator grafana/synthetic-monitoring-agent 0.1.0 v0.9.3-0-gcd7aadd Grafana's Synthetic Monitoring application. The... grafana/tempo 0.16.1 1.5.0 Grafana Tempo Single Binary Mode grafana/tempo-distributed 0.24.0 1.5.0 Grafana Tempo in MicroService mode grafana/tempo-vulture 0.2.0 1.3.0 Grafana Tempo Vulture - A tool to monitor Tempo... \u8f38\u51fa\u986f\u793a\u500b\u5225 chart \u53ef\u7528\u65bc Promtail\u3001Loki \u548c Grafana\u3002\u4f46\u662f\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 grafana/loki-stack \u4e00\u6b21\u5b89\u88dd\u6240\u6709\u5fc5\u8981\u7684\u7d44\u4ef6\u3002\u5728\u6211\u5011\u5b89\u88dd chart \u4e4b\u524d\uff0c\u8b93\u6211\u5011\u4e0b\u8f09 value \u6587\u4ef6\u4e26\u67e5\u770b grafana/loki-stack \u652f\u6301\u54ea\u4e9b\u81ea\u5b9a\u7fa9\uff1a \u70ba PLG \u5806\u68e7\u91cf\u8eab\u5b9a\u5236\u7684\u914d\u7f6e \u00b6 # download value file from grafana/loki-stack helm show values grafana/loki-stack > ~/loki-stack-values.yml \u5982\u679c\u6211\u5011\u67e5\u770b loki-stack-values.yml \u6587\u4ef6\uff0c\u6211\u5011\u6703\u7acb\u5373\u8a8d\u8b58\u5230\u9019\u500b Helm chart \u53ef\u4ee5\u90e8\u7f72\u7684\u4e0d\u50c5\u50c5\u662f Promtail\u3001Loki \u548c Grafana\u3002\u4f46\u662f\uff0c\u6211\u5011\u73fe\u5728\u6703\u5ba2\u88fd\u4e00\u500b\u5b9a\u7fa9\u3000value \u6587\u4ef6\u4ee5\u50c5\u90e8\u7f72 Promtail\u3001Loki \u548c Grafana\u3000\u7d44\u4ef6\uff1a loki-helm-values.yml loki : enabled : true persistence : enabled : true # storageClassName: default size : 10Gi promtail : enabled : true pipelineStages : - cri : {} - json : expressions : is_even : is_even level : level version : version grafana : enabled : true sidecar : datasources : enabled : true image : tag : 8.3.5 \u5c0d\u65bc Loki\uff0c\u6211\u5011\u914d\u7f6e\u6301\u4e45\u6027\u4ee5\u5c07\u65e5\u8a8c\u5b58\u5132\u5728\u5927\u5c0f\u70ba 10 GB \u7684\u8a17\u7ba1\u78c1\u76e4\u4e0a\u3002 Promtail \u914d\u7f6e\u66f4\u6709\u8da3\u4e00\u4e9b\u3002\u9996\u5148\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 pipelineStages \u544a\u8a34 Promtail \u5982\u4f55\u8655\u7406\u4f86\u81ea\u7279\u5b9a\u4f86\u6e90\u7684\u65e5\u8a8c\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u914d\u7f6e promtail \u4ee5\u6b63\u78ba\u8655\u7406 CRI \u65e5\u8a8c \uff0c\u7136\u5f8c\u5f9e JSON \u65e5\u8a8c\u4e2d\u63d0\u53d6\u4e09\u500b\u57fa\u672c\u5c6c\u6027\u3002 \u4f7f\u7528 Helm \u90e8\u7f72 PLG \u5806\u68e7 \u00b6 \u6709\u4e86\u81ea\u5b9a\u7fa9\u7684\u503c\u6587\u4ef6\uff0c\u6211\u5011\u7d42\u65bc\u53ef\u4ee5\u4f7f\u7528 Helm \u5b89\u88dd grafana/loki-stack\uff1a # Install PLG stack $ helm install loki grafana/loki-stack -n loki --create-namespace -f ~/loki-helm-values.yml W0820 12 :54:30.365795 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.367307 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.368669 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.440305 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.440326 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.441110 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ NAME: loki LAST DEPLOYED: Sat Aug 20 12 :54:29 2022 NAMESPACE: loki STATUS: deployed REVISION: 1 NOTES: The Loki stack has been deployed to your cluster. Loki can now be added as a datasource in Grafana. See http://docs.grafana.org/features/datasources/loki/ for more detail. \u4f7f\u7528 kubectl all -n loki \u7372\u53d6\u90e8\u7f72\u5230\u96c6\u7fa4\u7684\u6240\u6709\u7d44\u4ef6\u7684\u5217\u8868\u3002\u60a8\u61c9\u8a72\u6703\u5728\u5e7e\u79d2\u9418\u5167\u770b\u5230\u5fc5\u8981\u7684 pod \u9032\u5165\u5c31\u7dd2\u72c0\u614b\uff08kubectl get po -n loki\uff09\uff1a $ kubectl get pod -n loki NAME READY STATUS RESTARTS AGE loki-promtail-knt2g 1 /1 Running 0 16m loki-grafana-64646b7ffd-b4tp4 2 /2 Running 0 16m loki-0 1 /1 Running 0 16m \u5f9e\u672c\u5730\u6a5f\u5668\u8a2a\u554f Grafana \u00b6 \u986f\u7136\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u5411 Kubernetes \u96c6\u7fa4\u90e8\u7f72\u984d\u5916\u7684 Ingress \u898f\u5247\u4f86\u516c\u958b Grafana\u3002\u4f46\u662f\uff0c\u70ba\u4e86\u672c\u6587\u7684\u76ee\u7684\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u7c21\u55ae\u7684\u7aef\u53e3\u8f49\u767c\u3002\u5728\u6211\u5011\u771f\u6b63\u958b\u59cb\u7aef\u53e3\u8f49\u767c\u4e4b\u524d\uff0c\u6211\u5011\u5fc5\u9808\u7372\u5f97\u5fc5\u8981\u7684\u8eab\u4efd\u9a57\u8b49\u4fe1\u606f\u3002 \u67e5\u627e Grafana \u5bc6\u78bc \u00b6 Grafana \u9ed8\u8a8d\u901a\u904e\u57fa\u672c\u8eab\u4efd\u9a57\u8b49\u9032\u884c\u4fdd\u8b77\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl \u5f9e loki \u547d\u540d\u7a7a\u9593\u4e2d\u7684 loki-grafana secret \u7372\u53d6\u5bc6\u78bc\uff08\u7528\u6236\u540d\u662f admin\uff09\uff1a # Grab the password from loki-grafana secret kubectl get secret loki-grafana -n loki \\ -o template \\ --template '{{ index .data \"admin-password\" }}' | base64 -d ; echo \u7d50\u679c\u985e\u4f3c\u5982\u4e0b: znK67sfNIrpmZtcsCVbJCFAHhpIIzgJUtGKet75s Tip \u5f9eKubernetes\u4e2d\u53d6\u56de\u4f86Secret\u7684\u5167\u5bb9\u6703\u8b8a\u52d5\uff01 \u5f9e localhost \u5230 Grafana \u7684\u7aef\u53e3\u8f49\u767c \u00b6 \u77e5\u9053\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u9032\u884c\u7aef\u53e3\u8f49\u767c\uff0c\u4e26\u901a\u904e\u7aef\u53e3 8080 \u5f9e\u672c\u5730\u6a5f\u5668\u8f15\u9b06\u8a2a\u554f Grafana\uff1a # find your Grafana Pod $ kubectl get pod -n loki -l app.kubernetes.io/name = grafana NAME READY STATUS RESTARTS AGE loki-grafana-64646b7ffd-b4tp4 2 /2 Running 0 27m # Start port forwarding kubectl port-forward -n loki loki-grafana-64646b7ffd-b4tp4 8080 :3000 --address = \"0.0.0.0\" Forwarding from 127 .0.0.1:8080 -> 3000 Forwarding from [ ::1 ] :8080 -> 3000 \u5728\u700f\u89bd\u5668\u4e0a\u4f7f\u7528\u3000 admin \u8207\u524d\u4e00\u6b65\u9a5f\u6240\u53d6\u5f97\u7684\u5bc6\u78bc\u4f86\u767b\u5165\u3000Grafana: \u4f7f\u7528 LogQL \u67e5\u8a62\u65e5\u8a8c \u00b6 \u672c\u6587\u5e76\u4e0d\u662f LogQL \u7684\u7aef\u5230\u7aef\u6559\u7a0b\uff0c\u800c\u662f\u53c3\u8003 LogQL \u5b98\u65b9\u6587\u6a94 \u4ee5\u66f4\u6df1\u5165\u5730\u4e86\u89e3 LogQL\u3002\u5982\u679c\u60a8\u4e4b\u524d\u6c92\u6709\u4f7f\u7528\u904e LogQL \u6216 PromQL\uff0c\u8acb\u8003\u616e\u95b1\u8b80 Loki \u6587\u6a94\u7684\u76f8\u61c9\u90e8\u5206\u3002\u4f7f\u7528 LogQL\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u57fa\u65bc\u6a19\u7c64\u6216\u5e95\u5c64\u65e5\u8a8c\u6d88\u606f\u672c\u8eab\u7684\u904e\u6ffe\u4f86\u7acb\u5373\u700f\u89bd\u6578\u767e\u842c\u689d\u65e5\u8a8c\u6d88\u606f\u3002 \u4e00\u4e9b\u57fa\u672c\u7684 LogQL \u67e5\u8a62 \u00b6 \u51fa\u65bc\u6f14\u793a\u76ee\u7684\uff0c\u8b93\u6211\u5011\u4f7f\u7528 Grafana \u7684 Explore (\ud83e\udded) \u4f86\u700f\u89bd\u6211\u5011\u7684\u65e5\u8a8c\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 \u6a19\u7c64\u904e\u6ffe\u5668 {namespace=\"sample\"} \u9650\u5236\u97ff\u61c9\u4ee5\u63a5\u6536\u50c5\u5728\u793a\u4f8b\u547d\u540d\u7a7a\u9593\u4e2d\u751f\u6210\u7684\u65e5\u8a8c\u6d88\u606f\u3002 { na mespace= \"sample\" } All logs from the sample namespace \u60a8\u53ea\u60f3\u67e5\u770b\u4f86\u81ea stderr \u7684\u65e5\u8a8c\u55ce\uff1f\u6211\u5011\u53ef\u4ee5\u9023\u63a5\u591a\u500b\u6a19\u7c64\u904e\u6ffe\u5668\u4ee5\u9032\u4e00\u6b65\u7e2e\u5c0f\u7d50\u679c\u5217\u8868 {namespace=\"sample\", stream=\"stderr\"} \u3002\u82b1\u9ede\u6642\u9593\u700f\u89bd\u65e5\u8a8c\u700f\u89bd\u5668\uff0c\u5728\u5c07\u65e5\u8a8c\u651d\u53d6\u5230 Loki \u4e4b\u524d\uff0c\u627e\u51fa\u6240\u6709\u9644\u52a0\u5230\u4f86\u81ea Promtail \u7684\u65e5\u8a8c\u6d88\u606f\u7684\u6a19\u7c64\u3002 All logs from the stderr stream in the sample namespace \u5f9e\u9019\u4e00\u9ede\u4f86\u770b\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u904e\u6ffe\u4f86\u81ea JSON \u65e5\u8a8c\u6d88\u606f\u672c\u8eab\u7684\u6aa2\u6e2c\u5230\u7684\u5b57\u6bb5\u4f86\u4f7f\u67e5\u8a62\u66f4\u52a0\u7cbe\u78ba\u3002\u4f7f\u7528 json \u683c\u5f0f\u5316\u7a0b\u5e8f\u4e26\u904e\u6ffe\u5217\u8868\u4ee5\u50c5\u67e5\u770b is_even \u8a2d\u7f6e\u70ba true \u7684\u6d88\u606f\u3002\u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u67e5\u627e\u7279\u5b9a\u5b57\u7b26\u4e32\u7684\u51fa\u73fe\u4f86\u904e\u6ffe\u7d50\u679c\u3002\u9019\u5c0e\u81f4\u6700\u7d42\u67e5\u8a62\u70ba: { na mespace= \"sample\" , s trea m= \"stderr\" } |jso n |is_eve n = \"true\" All even logs from the stderr stream in the sample namespace \u5118\u7ba1\u64c1\u6709\u7d50\u69cb\u5316\u6578\u64da\uff08\u4f8b\u5982 JSON\uff09\u5f88\u68d2\uff0c\u4f46\u66f4\u5bb9\u6613\u5728\u666e\u901a\u7684\u820a\u5b57\u7b26\u4e32\u4e2d\u767c\u73fe\u67d0\u4e9b\u6a21\u5f0f\u3002\u8b93\u6211\u5011\u4f7f\u7528 line_format \u8868\u9054\u5f0f\u4f86\u4fee\u6539\u6211\u5011\u7684\u65e5\u8a8c\u6d88\u606f\u7684\u6700\u7d42\u8868\u793a\uff0c\u5c07\u67e5\u8a62\u4fee\u6539\u70ba { na mespace= \"sample\" , s trea m= \"stderr\" } |jso n |is_eve n = \"true\" | li ne _ f orma t \"{{.ts}} {{.level}}@{{.pod}}| {{.msg}}\" Logs with custom line format \u4f7f\u7528 LogQL \u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19 \u00b6 \u5728\u700f\u89bd\u6578\u5343\u751a\u81f3\u6578\u767e\u842c\u689d\u65e5\u8a8c\u6d88\u606f\u6642\uff0cLogQL \u975e\u5e38\u5f37\u5927\u3002\u6700\u91cd\u8981\u7684\u662f\uff0cLogQL \u5177\u6709\u5f9e\u65e5\u8a8c\u6d88\u606f\u751f\u6210\u57fa\u672c\u6307\u6a19\u7684\u5167\u7f6e\u652f\u6301\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u4ee5\u7372\u53d6\u793a\u4f8b\u547d\u540d\u7a7a\u9593\u4e2d\u7522\u751f\u7684\u932f\u8aa4\u6578\u91cf\uff08\u5728\u4e94\u5206\u9418\u7684\u6642\u9593\u7a97\u53e3\u5167\uff09\uff0c\u4e26\u4f7f\u7528\u67e5\u8a62 sum(count_over_time({namespace=\"sample\",stream=\"stderr\"} [5m])) Metrics based on logs on the Grafana Dashboard Tip \u8acb\u8a18\u4f4f\uff1a\u5728\u57fa\u65bc\u672a\u7d22\u5f15\u7684\u65e5\u8a8c\u6d88\u606f\u9032\u884c\u904e\u6ffe\u4e4b\u524d\uff0c\u901a\u904e\u61c9\u7528\u81f3\u5c11\u4e00\u500b\u6a19\u7c64\u904e\u6ffe\u5668\u4f86\u7e2e\u5c0f\u65e5\u8a8c\u7bc4\u570d\u59cb\u7d42\u662f\u4e00\u7a2e\u597d\u7fd2\u6163\u3002 \u7d50\u8ad6 \u00b6 \u5728\u5206\u4f48\u5f0f\u61c9\u7528\u7a0b\u5e8f\u4e2d\u767c\u73fe\u65e5\u8a8c\u53ef\u80fd\u5f88\u9ebb\u7169\u3002\u4e0d\u540c\u683c\u5f0f\u7684\u65e5\u8a8c\u5fc5\u9808\u7d71\u4e00\u6574\u5408\u3002 PLG \u5806\u68e7\u662f\u4e00\u7a2e\u8f15\u91cf\u7d1a\u89e3\u6c7a\u65b9\u6848\uff0c\u7528\u65bc\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5c0d\u65e5\u8a8c\u9032\u884c\u89c0\u5bdf\u3001\u5b58\u5132\u548c\u53ef\u8996\u5316\u3002\u672c\u6587\u4f7f\u7528\u7684 grafana/loki-stack helm chart \u4f7f\u90e8\u7f72\u8b8a\u5f97\u5bb9\u6613\u3002\u5b9a\u5236\u7684 Promtail \u914d\u7f6e\u662f\u63a7\u5236\u4e0d\u540c\u65e5\u8a8c\u683c\u5f0f\u4e26\u5728\u651d\u53d6\u6642\u7d71\u4e00\u7684\u5fc5\u5099\u689d\u4ef6\u3002","title":"\u4f7f\u7528 Loki \u505a\u70ba Kubernetes \u7684\u65e5\u8a8c\u805a\u5408\u4e93\u4ef6"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#loki-kubernetes","text":"\u539f\u6587: https://www.thorsten-hans.com/logging-in-kubernetes-with-loki-and-plg-stack/ \u5728\u96f2\u539f\u751f\u74b0\u5883\u4e2d\uff0c\u53ef\u89c0\u5bdf\u6027\u662f\u4e00\u500b\u5de8\u5927\u7684\u8a71\u984c\u3002\u5fc5\u9808\u6536\u96c6\u3001\u7406\u89e3\u548c\u8abf\u67e5\u4f86\u81ea\u4e0d\u540c\u4f86\u6e90\u7684\u6578\u767e\u842c\u689d\u65e5\u8a8c\uff0c\u4ee5\u4e86\u89e3\u4e0d\u540c\u61c9\u7528\u7a0b\u5e8f\u904b\u884c\u5728 Kubernetes \u5e73\u53f0\u6642\u767c\u751f\u7684\u60c5\u6cc1\u3002 \u65e5\u8a8c\u5806\u68e7\uff08\u5982 PLG\uff09\u7684\u76ee\u6a19\u5c31\u662f\u60f3\u8981\u89e3\u6c7a\u9019\u4e9b\u554f\u984c\uff0c\u4e26\u4e14\u901a\u5e38\u7531\u5177\u6709\u5c08\u9580\u8077\u8cac\u7684\u591a\u500b\u61c9\u7528\u7a0b\u5e8f\u7d44\u6210\u3002\u5728\u6bcf\u500b\u65e5\u8a8c\u5806\u68e7\u7684\u6838\u5fc3\uff0c\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71\u8ca0\u8cac\u7d22\u5f15\u3001\u5b58\u5132\u548c\u516c\u958b\u65e5\u8a8c\u6d88\u606f\u7684\u67e5\u8a62\u63a5\u53e3\u3002 Loki \u7531 Grafana \u5718\u968a\u69cb\u5efa \uff0c\u662f\u4e00\u500b\u53d7 Prometheus \u9ad8\u5ea6\u555f\u767c\u7684 \u53ef\u64f4\u5c55\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71 \u3002 Loki \u8d8a\u4f86\u8d8a\u53d7\u6b61\u8fce\uff0c\u56e0\u70ba\u5b83\u6613\u65bc\u64cd\u4f5c\u548c\u6aa2\u67e5\u8cc7\u6e90\u5206\u914d - \u7279\u5225\u662f\u5982\u679c\u60a8\u5c07\u5b83\u5176\u5b83\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71(ELK)\u9032\u884c\u6bd4\u8f03\u3002\u672c\u6587\u5c07\u4ecb\u7d39 PLG \u5806\u68e7\uff0c\u5b83\u7531 Promtail\u3001Loki \u548c Grafana \u7d44\u6210\u3002","title":"\u4f7f\u7528 Loki \u505a\u70ba Kubernetes \u7684\u65e5\u8a8c\u805a\u5408\u4e93\u4ef6"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#plg","text":"\u5728\u6211\u5011\u958b\u59cb\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG \u5806\u68e7\u4e4b\u524d\uff0c\u8b93\u6211\u5011\u5feb\u901f\u56de\u9867\u4e00\u4e0b PLG \u7684\u4e09\u500b\u4e3b\u8981\u7d44\u4ef6\u3002\u4e00\u65e6\u6211\u5011\u5c0d\u6bcf\u500b\u7d44\u4ef6\u7684\u4e3b\u8981\u8077\u8cac\u6709\u4e86\u57fa\u672c\u7684\u4e86\u89e3\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u958b\u59cb\u5728\u4e00\u500b\u9583\u4eae\u7684\u65b0 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG\u3002","title":"\u63a2\u7d22 PLG \u5806\u68e7"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#promtail","text":"Promtail \u8ca0\u8cac\u5c07\u6578\u64da\u5f15\u5165 Loki\u3002\u5b83\u4ee5 DaemonSet \u7684\u5f62\u5f0f\u5be6\u73fe\uff0c\u9019\u610f\u5473\u8457 Promtail \u5be6\u4f8b\u904b\u884c\u5728 Kubernetes \u96c6\u7fa4\u7684\u6bcf\u500b\u7bc0\u9ede\u4e0a\u3002 DaemonSet \u5b9a\u671f\u5f9e\u5728\u8a72\u7279\u5b9a Kubernetes \u7bc0\u9ede\u4e0a\u904b\u884c\u7684\u6240\u6709\u5bb9\u5668\uff08 stdout \u548c stderr \uff09\u8b80\u53d6\u65e5\u8a8c\u3002\u9664\u4e86\u672c\u5730\u5316\u548c\u8b80\u53d6\u65e5\u8a8c\u6d41\u4e4b\u5916\uff0cPromtail \u9084\u53ef\u4ee5\u5728\u5c07\u65e5\u8a8c\u63a8\u9001\u5230 Loki \u4e4b\u524d\u5c07\u6a19\u7c64\u9644\u52a0\u5230\u65e5\u8a8c\u3002","title":"\u4ec0\u9ebc\u662f Promtail"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#loki","text":"Loki \u662f PLG \u5806\u68e7\u7684\u6838\u5fc3\u3002\u5b83\u662f\u91dd\u5c0d\u65e5\u8a8c\u512a\u5316\u7684\u6578\u64da\u5b58\u5132\u3002\u8207\u5176\u4ed6\u65e5\u8a8c\u805a\u5408\u7cfb\u7d71\u76f8\u6bd4\uff0cLoki \u672c\u8eab\u4e26\u4e0d\u7d22\u5f15\u65e5\u8a8c\u6d88\u606f\u3002\u76f8\u53cd\uff0c\u5b83\u7d22\u5f15\u5206\u914d\u7d66\u6bcf\u500b\u65e5\u8a8c\u7684\u6a19\u7c64\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 LogQL \u67e5\u8a62\u5b58\u5132\u5728 Loki \u4e2d\u7684\u65e5\u8a8c\uff0c LogQL \u662f\u4e00\u7a2e\u53d7 PromQL \u555f\u767c\u7684\u67e5\u8a62\u8a9e\u8a00\u3002\u4f7f\u7528 LogQL\uff0c\u6211\u5011\u4e0d\u50c5\u53ef\u4ee5\u5728\u5e7e\u79d2\u9418\u5167\u700f\u89bd\u6578\u767e\u842c\u689d\u65e5\u8a8c\u3002\u6211\u5011\u9084\u53ef\u4ee5\u8f15\u9b06\u5730\u5f9e\u65e5\u8a8c\u4e2d\u63d0\u53d6\u6307\u6a19\u3002","title":"\u4ec0\u9ebc\u662f Loki"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#grafana","text":"Grafana \u7528\u65bc\u53ef\u8996\u5316\u5b58\u5132\u5728 Loki \u4e2d\u7684\u65e5\u8a8c\u3002 Loki \u8207 Grafana \u7121\u7e2b\u96c6\u6210\u3002\u6211\u5011\u53ef\u4ee5\u6839\u64da\u61c9\u7528\u7a0b\u5e8f\u65e5\u8a8c\u548c\u5f9e\u8a72\u65e5\u8a8c\u8a08\u7b97\u7684\u6307\u6a19\u5728 Grafana \u4e2d\u69cb\u5efa\u55ae\u7368\u7684\u5100\u8868\u677f\u3002","title":"\u4ec0\u9ebc\u662f Grafana"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#_1","text":"","title":"\u7bc4\u4f8b\u74b0\u5883"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#kubernetes","text":"\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u4f86\u5275\u5efa Kubernetes \u96c6\u7fa4\u3002 (\u8a73\u7d30\u8aaa\u660e\u898b: \u4f7f\u7528 K3D \u8a2d\u7f6e Kubernetes \u96c6\u7fa4 ) $ k3d cluster create [ NAME ] \u7531\u65bc\u5b83\u5728\u7b2c\u4e00\u6b21\u5b89\u88dd\u6642\u6703\u4e0b\u8f09\u5927\u7d04 150\u2013200MB \u7684 docker \u6620\u50cf\uff0c\u56e0\u6b64\u5b89\u88dd\u6642\u9593\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u6642\u9593\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u60a8\u7684\u4e92\u806f\u7db2\u901f\u5ea6\uff0c\u4f46\u9664\u975e\u60a8\u522a\u9664\u9019\u4e9b\u6620\u50cf\uff0c\u5426\u5247\u60a8\u7684\u4e0b\u4e00\u6b21\u96c6\u7fa4\u5b89\u88dd\u5c07\u82b1\u8cbb\u66f4\u5c11\u7684\u6642\u9593\u3002 INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .27.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u4f7f\u7528 k3d cluster list \u547d\u4ee4\uff0c\u60a8\u53ef\u4ee5\u67e5\u770b\u5df2\u5275\u5efa\u7684\u96c6\u7fa4\u53ca\u5176\u72c0\u614b\u3002 $ k3d cluster list NAME SERVERS AGENTS LOADBALANCER k3s-default 1 /1 0 /0 true","title":"\u8a2d\u7f6e Kubernetes \u96c6\u7fa4"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#_2","text":"\u96d6\u7136 Promtail \u9ed8\u8a8d\u6703\u5f9e\u6240\u6709\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u5bb9\u5668\u8b80\u53d6\u65e5\u8a8c\uff0c\u4f46\u6211\u5011\u73fe\u5728\u5c07\u90e8\u7f72\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u4f86\u7372\u53d6\u4e00\u4e9b\u6211\u5011\u53ef\u4ee5\u700f\u89bd\u7684\u6578\u64da\u3002 \u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u8abf\u8a66\u7528\u7684\u65e5\u8a8c\u8a18\u9304\u7522\u751f\u5668 (fake logger)\uff0c\u5b83\u5c07\u5177\u6709\u8abf\u8a66\u3001\u4fe1\u606f\u548c\u8b66\u544a\u7684\u65e5\u8a8c\u7d1a\u5225\u7684\u6d88\u606f\u8a18\u9304\u5230\u6a19\u6e96\u8f38\u51fa(stdout)\u3002\u932f\u8aa4\u7d1a\u5225\u7684\u65e5\u8a8c\u5c07\u88ab\u5beb\u5165\u6a19\u6e96\u932f\u8aa4(stderr)\u3002\u5be6\u969b\u7684\u65e5\u8a8c\u6d88\u606f\u4ee5 **JSON \u683c\u5f0f**\u751f\u6210\u3002\u6bcf 500 \u6beb\u79d2\u5c07\u5275\u5efa\u4e00\u689d\u65b0\u7684\u65e5\u8a8c\u6d88\u606f\u3002\u65e5\u8a8c\u6d88\u606f\u5982\u4e0b\u6240\u793a\uff1a { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-04-04T13:41:50+02:00\" , \"version\" : \"1.0.0\" } \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl \u5275\u5efa\u90e8\u7f72\uff0c\u5982\u4ee5\u4e0b\u4ee3\u78bc\u7247\u6bb5\u6240\u793a\uff1a # Create a new Namespace in Kubernetes kubectl create ns sample # Create a new Deployment cat <<EOF | kubectl apply -n sample -f - apiVersion: apps/v1 kind: Deployment metadata: labels: app: fake-logger environment: development name: fake-logger spec: selector: matchLabels: app: fake-logger environment: development template: metadata: labels: app: fake-logger environment: development spec: containers: - image: thorstenhans/fake-logger:0.0.2 name: fake-logger EOF pod \u6e96\u5099\u5c31\u7dd2\u5f8c\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 kubectl logs -n sample -l app=fake-logger \u4f86\u6aa2\u67e5\u65e5\u8a8c\u3002 kubectl logs -n sample -l app = fake-logger \u7d50\u679c\u5982\u4e0b: { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:32Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:32Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"warning\" , \"msg\" : \"This is a warning\" , \"time\" : \"2022-08-20T03:00:33Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"warning\" , \"msg\" : \"This is a warning\" , \"time\" : \"2022-08-20T03:00:33Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-08-20T03:00:34Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-08-20T03:00:34Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"error\" , \"msg\" : \"Oh no! this is an error\" , \"time\" : \"2022-08-20T03:00:35Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"error\" , \"msg\" : \"Oh no! this is an error\" , \"time\" : \"2022-08-20T03:00:35Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : false , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:36Z\" , \"version\" : \"1.0.0\" } { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"info\" , \"msg\" : \"This is an informational log\" , \"time\" : \"2022-08-20T03:00:36Z\" , \"version\" : \"1.0.0\" } ... ...","title":"\u90e8\u7f72\u793a\u4f8b\u5de5\u4f5c\u8ca0\u8f09"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#helm-plg","text":"\u5728 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG \u5806\u68e7\u7684\u6700\u7c21\u55ae\u65b9\u6cd5\u662f\u4f7f\u7528 Helm - Kubernetes \u7684\u5305\u7ba1\u7406\u5668\u3002\u5982\u679c\u60a8\u4ee5\u524d\u6c92\u6709\u4f7f\u7528\u904e helm\uff0c\u8acb\u8003\u616e\u95b1\u8b80 \u201c \u200b\u200bHelm 3 \u5165\u9580 \u201d \u6587\u7ae0\u3002","title":"\u4f7f\u7528 Helm \u5b89\u88dd PLG \u5806\u68e7"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#grafana-helm","text":"\u5728\u6211\u5011\u4f7f\u7528 Helm 3 \u5728\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e0a\u5b89\u88dd PLG \u5806\u68e7\u4e4b\u524d\uff0c\u6211\u5011\u5fc5\u9808\u5c07\u5b98\u65b9 Grafana \u5b58\u5132\u5eab\u6dfb\u52a0\u5230\u6211\u5011\u7684\u672c\u5730 Helm 3 \u5ba2\u6236\u7aef\u4e26\u66f4\u65b0\u5716\u8868\u4fe1\u606f\uff1a # add Grafana repository to Helm helm repo add grafana https://grafana.github.io/helm-charts # update chart information helm repo update \u5c07\u5b98\u65b9 Grafana \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 Helm \u4e26\u66f4\u65b0\u6240\u6709 charts \u4fe1\u606f\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 helm search \u6aa2\u67e5 Grafana \u5b58\u5132\u5eab\u4e2d\u53ef\u7528\u7684 chart\uff1a # list all available charts in the Grafana repository $ helm search repo grafana NAME CHART VERSION APP VERSION DESCRIPTION grafana/grafana 6.32.14 9.0.5 The leading tool for querying and visualizing t... grafana/grafana-agent-operator 0.2.3 0.25.1 A Helm chart for Grafana Agent Operator grafana/enterprise-logs 2.4.1 v1.5.1 Grafana Enterprise Logs grafana/enterprise-logs-simple 1.2.1 v1.4.0 DEPRECATED Grafana Enterprise Logs (Simple Scal... grafana/enterprise-metrics 1.9.0 v1.7.0 DEPRECATED Grafana Enterprise Metrics grafana/fluent-bit 2.3.1 v2.1.0 Uses fluent-bit Loki go plugin for gathering lo... grafana/loki 2.14.1 v2.6.1 Loki: like Prometheus, but for logs. grafana/loki-canary 0.9.2 2.6.1 Helm chart for Grafana Loki Canary grafana/loki-distributed 0.55.5 2.6.1 Helm chart for Grafana Loki in microservices mode grafana/loki-simple-scalable 1.8.9 2.6.1 Helm chart for Grafana Loki in simple, scalable... grafana/loki-stack 2.7.1 v2.6.1 Loki: like Prometheus, but for logs. grafana/mimir-distributed 3.0.0 2.2.0 Grafana Mimir grafana/mimir-openshift-experimental 2.1.0 2.0.0 Grafana Mimir on OpenShift Experiment grafana/oncall 1.0.3 v1.0.13 Developer-friendly incident response with brill... grafana/promtail 6.3.0 2.6.1 Promtail is an agent which ships the contents o... grafana/rollout-operator 0.1.2 v0.1.1 Grafana rollout-operator grafana/synthetic-monitoring-agent 0.1.0 v0.9.3-0-gcd7aadd Grafana's Synthetic Monitoring application. The... grafana/tempo 0.16.1 1.5.0 Grafana Tempo Single Binary Mode grafana/tempo-distributed 0.24.0 1.5.0 Grafana Tempo in MicroService mode grafana/tempo-vulture 0.2.0 1.3.0 Grafana Tempo Vulture - A tool to monitor Tempo... \u8f38\u51fa\u986f\u793a\u500b\u5225 chart \u53ef\u7528\u65bc Promtail\u3001Loki \u548c Grafana\u3002\u4f46\u662f\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 grafana/loki-stack \u4e00\u6b21\u5b89\u88dd\u6240\u6709\u5fc5\u8981\u7684\u7d44\u4ef6\u3002\u5728\u6211\u5011\u5b89\u88dd chart \u4e4b\u524d\uff0c\u8b93\u6211\u5011\u4e0b\u8f09 value \u6587\u4ef6\u4e26\u67e5\u770b grafana/loki-stack \u652f\u6301\u54ea\u4e9b\u81ea\u5b9a\u7fa9\uff1a","title":"\u5c07 Grafana \u5b58\u5132\u5eab\u6dfb\u52a0\u5230 Helm"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#plg_1","text":"# download value file from grafana/loki-stack helm show values grafana/loki-stack > ~/loki-stack-values.yml \u5982\u679c\u6211\u5011\u67e5\u770b loki-stack-values.yml \u6587\u4ef6\uff0c\u6211\u5011\u6703\u7acb\u5373\u8a8d\u8b58\u5230\u9019\u500b Helm chart \u53ef\u4ee5\u90e8\u7f72\u7684\u4e0d\u50c5\u50c5\u662f Promtail\u3001Loki \u548c Grafana\u3002\u4f46\u662f\uff0c\u6211\u5011\u73fe\u5728\u6703\u5ba2\u88fd\u4e00\u500b\u5b9a\u7fa9\u3000value \u6587\u4ef6\u4ee5\u50c5\u90e8\u7f72 Promtail\u3001Loki \u548c Grafana\u3000\u7d44\u4ef6\uff1a loki-helm-values.yml loki : enabled : true persistence : enabled : true # storageClassName: default size : 10Gi promtail : enabled : true pipelineStages : - cri : {} - json : expressions : is_even : is_even level : level version : version grafana : enabled : true sidecar : datasources : enabled : true image : tag : 8.3.5 \u5c0d\u65bc Loki\uff0c\u6211\u5011\u914d\u7f6e\u6301\u4e45\u6027\u4ee5\u5c07\u65e5\u8a8c\u5b58\u5132\u5728\u5927\u5c0f\u70ba 10 GB \u7684\u8a17\u7ba1\u78c1\u76e4\u4e0a\u3002 Promtail \u914d\u7f6e\u66f4\u6709\u8da3\u4e00\u4e9b\u3002\u9996\u5148\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 pipelineStages \u544a\u8a34 Promtail \u5982\u4f55\u8655\u7406\u4f86\u81ea\u7279\u5b9a\u4f86\u6e90\u7684\u65e5\u8a8c\u3002\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u914d\u7f6e promtail \u4ee5\u6b63\u78ba\u8655\u7406 CRI \u65e5\u8a8c \uff0c\u7136\u5f8c\u5f9e JSON \u65e5\u8a8c\u4e2d\u63d0\u53d6\u4e09\u500b\u57fa\u672c\u5c6c\u6027\u3002","title":"\u70ba PLG \u5806\u68e7\u91cf\u8eab\u5b9a\u5236\u7684\u914d\u7f6e"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#helm-plg_1","text":"\u6709\u4e86\u81ea\u5b9a\u7fa9\u7684\u503c\u6587\u4ef6\uff0c\u6211\u5011\u7d42\u65bc\u53ef\u4ee5\u4f7f\u7528 Helm \u5b89\u88dd grafana/loki-stack\uff1a # Install PLG stack $ helm install loki grafana/loki-stack -n loki --create-namespace -f ~/loki-helm-values.yml W0820 12 :54:30.365795 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.367307 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.368669 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.440305 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.440326 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ W0820 12 :54:30.441110 228082 warnings.go:70 ] policy/v1beta1 PodSecurityPolicy is deprecated in v1.21+, unavailable in v1.25+ NAME: loki LAST DEPLOYED: Sat Aug 20 12 :54:29 2022 NAMESPACE: loki STATUS: deployed REVISION: 1 NOTES: The Loki stack has been deployed to your cluster. Loki can now be added as a datasource in Grafana. See http://docs.grafana.org/features/datasources/loki/ for more detail. \u4f7f\u7528 kubectl all -n loki \u7372\u53d6\u90e8\u7f72\u5230\u96c6\u7fa4\u7684\u6240\u6709\u7d44\u4ef6\u7684\u5217\u8868\u3002\u60a8\u61c9\u8a72\u6703\u5728\u5e7e\u79d2\u9418\u5167\u770b\u5230\u5fc5\u8981\u7684 pod \u9032\u5165\u5c31\u7dd2\u72c0\u614b\uff08kubectl get po -n loki\uff09\uff1a $ kubectl get pod -n loki NAME READY STATUS RESTARTS AGE loki-promtail-knt2g 1 /1 Running 0 16m loki-grafana-64646b7ffd-b4tp4 2 /2 Running 0 16m loki-0 1 /1 Running 0 16m","title":"\u4f7f\u7528 Helm \u90e8\u7f72 PLG \u5806\u68e7"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#grafana_1","text":"\u986f\u7136\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u5411 Kubernetes \u96c6\u7fa4\u90e8\u7f72\u984d\u5916\u7684 Ingress \u898f\u5247\u4f86\u516c\u958b Grafana\u3002\u4f46\u662f\uff0c\u70ba\u4e86\u672c\u6587\u7684\u76ee\u7684\uff0c\u6211\u5011\u5c07\u4f7f\u7528\u7c21\u55ae\u7684\u7aef\u53e3\u8f49\u767c\u3002\u5728\u6211\u5011\u771f\u6b63\u958b\u59cb\u7aef\u53e3\u8f49\u767c\u4e4b\u524d\uff0c\u6211\u5011\u5fc5\u9808\u7372\u5f97\u5fc5\u8981\u7684\u8eab\u4efd\u9a57\u8b49\u4fe1\u606f\u3002","title":"\u5f9e\u672c\u5730\u6a5f\u5668\u8a2a\u554f Grafana"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#grafana_2","text":"Grafana \u9ed8\u8a8d\u901a\u904e\u57fa\u672c\u8eab\u4efd\u9a57\u8b49\u9032\u884c\u4fdd\u8b77\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl \u5f9e loki \u547d\u540d\u7a7a\u9593\u4e2d\u7684 loki-grafana secret \u7372\u53d6\u5bc6\u78bc\uff08\u7528\u6236\u540d\u662f admin\uff09\uff1a # Grab the password from loki-grafana secret kubectl get secret loki-grafana -n loki \\ -o template \\ --template '{{ index .data \"admin-password\" }}' | base64 -d ; echo \u7d50\u679c\u985e\u4f3c\u5982\u4e0b: znK67sfNIrpmZtcsCVbJCFAHhpIIzgJUtGKet75s Tip \u5f9eKubernetes\u4e2d\u53d6\u56de\u4f86Secret\u7684\u5167\u5bb9\u6703\u8b8a\u52d5\uff01","title":"\u67e5\u627e Grafana \u5bc6\u78bc"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#localhost-grafana","text":"\u77e5\u9053\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 kubectl port-forward \u9032\u884c\u7aef\u53e3\u8f49\u767c\uff0c\u4e26\u901a\u904e\u7aef\u53e3 8080 \u5f9e\u672c\u5730\u6a5f\u5668\u8f15\u9b06\u8a2a\u554f Grafana\uff1a # find your Grafana Pod $ kubectl get pod -n loki -l app.kubernetes.io/name = grafana NAME READY STATUS RESTARTS AGE loki-grafana-64646b7ffd-b4tp4 2 /2 Running 0 27m # Start port forwarding kubectl port-forward -n loki loki-grafana-64646b7ffd-b4tp4 8080 :3000 --address = \"0.0.0.0\" Forwarding from 127 .0.0.1:8080 -> 3000 Forwarding from [ ::1 ] :8080 -> 3000 \u5728\u700f\u89bd\u5668\u4e0a\u4f7f\u7528\u3000 admin \u8207\u524d\u4e00\u6b65\u9a5f\u6240\u53d6\u5f97\u7684\u5bc6\u78bc\u4f86\u767b\u5165\u3000Grafana:","title":"\u5f9e localhost \u5230 Grafana \u7684\u7aef\u53e3\u8f49\u767c"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#logql","text":"\u672c\u6587\u5e76\u4e0d\u662f LogQL \u7684\u7aef\u5230\u7aef\u6559\u7a0b\uff0c\u800c\u662f\u53c3\u8003 LogQL \u5b98\u65b9\u6587\u6a94 \u4ee5\u66f4\u6df1\u5165\u5730\u4e86\u89e3 LogQL\u3002\u5982\u679c\u60a8\u4e4b\u524d\u6c92\u6709\u4f7f\u7528\u904e LogQL \u6216 PromQL\uff0c\u8acb\u8003\u616e\u95b1\u8b80 Loki \u6587\u6a94\u7684\u76f8\u61c9\u90e8\u5206\u3002\u4f7f\u7528 LogQL\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u57fa\u65bc\u6a19\u7c64\u6216\u5e95\u5c64\u65e5\u8a8c\u6d88\u606f\u672c\u8eab\u7684\u904e\u6ffe\u4f86\u7acb\u5373\u700f\u89bd\u6578\u767e\u842c\u689d\u65e5\u8a8c\u6d88\u606f\u3002","title":"\u4f7f\u7528 LogQL \u67e5\u8a62\u65e5\u8a8c"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#logql_1","text":"\u51fa\u65bc\u6f14\u793a\u76ee\u7684\uff0c\u8b93\u6211\u5011\u4f7f\u7528 Grafana \u7684 Explore (\ud83e\udded) \u4f86\u700f\u89bd\u6211\u5011\u7684\u65e5\u8a8c\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 \u6a19\u7c64\u904e\u6ffe\u5668 {namespace=\"sample\"} \u9650\u5236\u97ff\u61c9\u4ee5\u63a5\u6536\u50c5\u5728\u793a\u4f8b\u547d\u540d\u7a7a\u9593\u4e2d\u751f\u6210\u7684\u65e5\u8a8c\u6d88\u606f\u3002 { na mespace= \"sample\" } All logs from the sample namespace \u60a8\u53ea\u60f3\u67e5\u770b\u4f86\u81ea stderr \u7684\u65e5\u8a8c\u55ce\uff1f\u6211\u5011\u53ef\u4ee5\u9023\u63a5\u591a\u500b\u6a19\u7c64\u904e\u6ffe\u5668\u4ee5\u9032\u4e00\u6b65\u7e2e\u5c0f\u7d50\u679c\u5217\u8868 {namespace=\"sample\", stream=\"stderr\"} \u3002\u82b1\u9ede\u6642\u9593\u700f\u89bd\u65e5\u8a8c\u700f\u89bd\u5668\uff0c\u5728\u5c07\u65e5\u8a8c\u651d\u53d6\u5230 Loki \u4e4b\u524d\uff0c\u627e\u51fa\u6240\u6709\u9644\u52a0\u5230\u4f86\u81ea Promtail \u7684\u65e5\u8a8c\u6d88\u606f\u7684\u6a19\u7c64\u3002 All logs from the stderr stream in the sample namespace \u5f9e\u9019\u4e00\u9ede\u4f86\u770b\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u904e\u6ffe\u4f86\u81ea JSON \u65e5\u8a8c\u6d88\u606f\u672c\u8eab\u7684\u6aa2\u6e2c\u5230\u7684\u5b57\u6bb5\u4f86\u4f7f\u67e5\u8a62\u66f4\u52a0\u7cbe\u78ba\u3002\u4f7f\u7528 json \u683c\u5f0f\u5316\u7a0b\u5e8f\u4e26\u904e\u6ffe\u5217\u8868\u4ee5\u50c5\u67e5\u770b is_even \u8a2d\u7f6e\u70ba true \u7684\u6d88\u606f\u3002\u6700\u5f8c\u4f46\u540c\u6a23\u91cd\u8981\u7684\u662f\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e\u67e5\u627e\u7279\u5b9a\u5b57\u7b26\u4e32\u7684\u51fa\u73fe\u4f86\u904e\u6ffe\u7d50\u679c\u3002\u9019\u5c0e\u81f4\u6700\u7d42\u67e5\u8a62\u70ba: { na mespace= \"sample\" , s trea m= \"stderr\" } |jso n |is_eve n = \"true\" All even logs from the stderr stream in the sample namespace \u5118\u7ba1\u64c1\u6709\u7d50\u69cb\u5316\u6578\u64da\uff08\u4f8b\u5982 JSON\uff09\u5f88\u68d2\uff0c\u4f46\u66f4\u5bb9\u6613\u5728\u666e\u901a\u7684\u820a\u5b57\u7b26\u4e32\u4e2d\u767c\u73fe\u67d0\u4e9b\u6a21\u5f0f\u3002\u8b93\u6211\u5011\u4f7f\u7528 line_format \u8868\u9054\u5f0f\u4f86\u4fee\u6539\u6211\u5011\u7684\u65e5\u8a8c\u6d88\u606f\u7684\u6700\u7d42\u8868\u793a\uff0c\u5c07\u67e5\u8a62\u4fee\u6539\u70ba { na mespace= \"sample\" , s trea m= \"stderr\" } |jso n |is_eve n = \"true\" | li ne _ f orma t \"{{.ts}} {{.level}}@{{.pod}}| {{.msg}}\" Logs with custom line format","title":"\u4e00\u4e9b\u57fa\u672c\u7684 LogQL \u67e5\u8a62"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#logql_2","text":"\u5728\u700f\u89bd\u6578\u5343\u751a\u81f3\u6578\u767e\u842c\u689d\u65e5\u8a8c\u6d88\u606f\u6642\uff0cLogQL \u975e\u5e38\u5f37\u5927\u3002\u6700\u91cd\u8981\u7684\u662f\uff0cLogQL \u5177\u6709\u5f9e\u65e5\u8a8c\u6d88\u606f\u751f\u6210\u57fa\u672c\u6307\u6a19\u7684\u5167\u7f6e\u652f\u6301\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u4ee5\u7372\u53d6\u793a\u4f8b\u547d\u540d\u7a7a\u9593\u4e2d\u7522\u751f\u7684\u932f\u8aa4\u6578\u91cf\uff08\u5728\u4e94\u5206\u9418\u7684\u6642\u9593\u7a97\u53e3\u5167\uff09\uff0c\u4e26\u4f7f\u7528\u67e5\u8a62 sum(count_over_time({namespace=\"sample\",stream=\"stderr\"} [5m])) Metrics based on logs on the Grafana Dashboard Tip \u8acb\u8a18\u4f4f\uff1a\u5728\u57fa\u65bc\u672a\u7d22\u5f15\u7684\u65e5\u8a8c\u6d88\u606f\u9032\u884c\u904e\u6ffe\u4e4b\u524d\uff0c\u901a\u904e\u61c9\u7528\u81f3\u5c11\u4e00\u500b\u6a19\u7c64\u904e\u6ffe\u5668\u4f86\u7e2e\u5c0f\u65e5\u8a8c\u7bc4\u570d\u59cb\u7d42\u662f\u4e00\u7a2e\u597d\u7fd2\u6163\u3002","title":"\u4f7f\u7528 LogQL \u57fa\u65bc\u65e5\u8a8c\u7684\u6307\u6a19"},{"location":"kubernetes/observability/logging/loki/logging-with-loki-and-plg/#_3","text":"\u5728\u5206\u4f48\u5f0f\u61c9\u7528\u7a0b\u5e8f\u4e2d\u767c\u73fe\u65e5\u8a8c\u53ef\u80fd\u5f88\u9ebb\u7169\u3002\u4e0d\u540c\u683c\u5f0f\u7684\u65e5\u8a8c\u5fc5\u9808\u7d71\u4e00\u6574\u5408\u3002 PLG \u5806\u68e7\u662f\u4e00\u7a2e\u8f15\u91cf\u7d1a\u89e3\u6c7a\u65b9\u6848\uff0c\u7528\u65bc\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u5c0d\u65e5\u8a8c\u9032\u884c\u89c0\u5bdf\u3001\u5b58\u5132\u548c\u53ef\u8996\u5316\u3002\u672c\u6587\u4f7f\u7528\u7684 grafana/loki-stack helm chart \u4f7f\u90e8\u7f72\u8b8a\u5f97\u5bb9\u6613\u3002\u5b9a\u5236\u7684 Promtail \u914d\u7f6e\u662f\u63a7\u5236\u4e0d\u540c\u65e5\u8a8c\u683c\u5f0f\u4e26\u5728\u651d\u53d6\u6642\u7d71\u4e00\u7684\u5fc5\u5099\u689d\u4ef6\u3002","title":"\u7d50\u8ad6"},{"location":"kubernetes/observability/logging/loki/loki-nginx/","text":"\u4f7f\u7528 Logging Operator \u5c07 Nginx \u8a2a\u554f\u65e5\u8a8c\u5b58\u5132\u5728 Grafana Loki \u00b6 \u539f\u6587: https://banzaicloud.com/docs/one-eye/logging-operator/quickstarts/loki-nginx/ \u672c\u6307\u5357\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Logging operator \u5728 Kubernetes \u4e2d\u6536\u96c6\u61c9\u7528\u7a0b\u5e8f\u548c\u5bb9\u5668\u65e5\u8a8c\uff0c\u4ee5\u53ca\u5982\u4f55\u5c07\u5b83\u5011\u767c\u9001\u5230 Grafana Loki\u3002 \u4e0b\u5716\u6982\u8ff0\u4e86\u7cfb\u7d71\u7684\u5de5\u4f5c\u539f\u7406\u3002 Logging operator \u5f9e\u61c9\u7528\u7a0b\u5e8f\u6536\u96c6\u65e5\u8a8c\uff0c\u9078\u64c7\u8981\u8f49\u767c\u5230\u8f38\u51fa\u7684\u65e5\u8a8c\uff0c\u4e26\u5c07\u9078\u5b9a\u7684\u65e5\u8a8c\u6d88\u606f\u767c\u9001\u5230\u8f38\u51fa\u3002\u6709\u95dc Logging operator \u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Logging operator \u6982\u8ff0\u3002 \u90e8\u7f72 Loki \u548c Grafana \u00b6 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6dfb\u52a0 Loki \u548c Grafana \u7684 chart \u5b58\u5132\u5eab\uff1a helm repo add grafana https://grafana.github.io/helm-charts helm repo add loki https://grafana.github.io/loki/charts helm repo update \u5c07 Loki \u5b89\u88dd\u5230 logging \u547d\u540d\u7a7a\u9593\u4e2d\uff1a helm upgrade --install --create-namespace --namespace logging loki grafana/loki-stack \\ --set promtail.enabled = false \u5c07 Grafana \u5b89\u88dd\u5230 logging \u547d\u540d\u7a7a\u9593\u4e2d\uff1a helm upgrade --install --create-namespace --namespace logging grafana grafana/grafana \\ --set \"datasources.datasources\\\\.yaml.apiVersion=1\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].name=Loki\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].type=loki\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].url=http://loki.logging:3100\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].access=proxy\" \u90e8\u7f72 Logging operator \u548c\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f \u00b6 \u5b89\u88dd Logging operator \u548c\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f\u4ee5\u63d0\u4f9b\u793a\u4f8b\u65e5\u8a8c\u6d88\u606f\u3002 \u4f7f\u7528 Helm \u90e8\u7f72 Logging operator \u00b6 \u8981\u4f7f\u7528 Helm \u5b89\u88dd Logging operator\uff0c\u8acb\u5b8c\u6210\u9019\u4e9b\u6b65\u9a5f\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6dfb\u52a0 Logging operator \u7684 helm \u5b58\u5132\u5eab\uff1a helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com helm repo update \u5c07 Logging operator \u5b89\u88dd\u5230 logging \u547d\u540d\u7a7a\u9593\u4e2d\uff1a helm upgrade --install --wait --create-namespace --namespace logging logging-operator banzaicloud-stable/logging-operator \u5728 logging \u7684\u547d\u540d\u7a7a\u9593\u88e1\u5b89\u88dd\u7bc4\u4f8b\u61c9\u7528\u7a0b\u5e8f\u53ca\u5176\u65e5\u8a8c\u8a18\u9304\u5b9a\u7fa9\u3002 helm upgrade --install --wait --create-namespace --namespace logging logging-demo banzaicloud-stable/logging-demo \\ --set \"loki.enabled=True\" \u90e8\u7f72 Logging operator \u548c\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f \u00b6 \u5275\u5efa\u65e5\u8a8c Logging \u8cc7\u6e90\u3002 \u00b6 kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: Logging metadata: name: default-logging-simple spec: fluentd: {} fluentbit: {} controlNamespace: logging EOF Info \u6ce8\u610f\uff1a\u60a8\u53ea\u80fd\u5728 controlNamespace \u4e2d\u4f7f\u7528 ClusterOutput \u548c ClusterFlow \u8cc7\u6e90\u3002 \u5275\u5efa Loki Output / ClusterOutput \u5b9a\u7fa9\u3002 \u00b6 Output \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\uff0c\u76ee\u524d Logging Operator \u652f\u6301\u7684\u65e5\u8a8c\u8f38\u51fa\u63d2\u4ef6\u975e\u5e38\u591a\uff0c\u5305\u542b\u5982\u4e0b\u5167\u5bb9\uff1a Alibaba Cloud Amazon CloudWatch Amazon Elasticsearch Amazon Kinesis Amazon S3 Azure Storage Buffer Datadog Elasticsearch File Format Format rfc5424 Forward GELF Google Cloud Storage Grafana Loki Http Kafka LogDNA LogZ NewRelic Splunk SumoLogic Syslog \u672c\u6b21\u7684\u6559\u7a0b\u4f7f\u7528\u4e86 Grafana Loki \u4f5c\u793a\u4f8b\u3002 Grafana Loki \u63d2\u4ef6\u7528\u4f86\u5b9a\u7fa9 fluentd \u5c07\u65e5\u8a8c\u8f38\u51fa\u5230 Loki \u7576\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u4e9b\u7279\u5b9a\u7684\u53c3\u6578\u4f86\u63a7\u5236\u548c\u512a\u5316\u65e5\u8a8c\u8f38\u51fa\u3002 Output ClusterOutput \uff2futput \u662f\u4e00\u500b namespaces \u7d1a\u5225\u7684 CRD \u8cc7\u6e90\u3002\u56e0\u6b64\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u61c9\u7528\u6240\u5728\u7684\u547d\u540d\u7a7a\u9593\u5167\u642d\u914d\u3000Flow CRD\u7684\u5b9a\u7fa9\u4f86\u6c7a\u5b9a\u65e5\u8a8c\u88ab\u6536\u96c6\u76ee\u7684\u5730\u3002\u8209\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: Output metadata: name: loki-output spec: loki: url: http://loki.logging:3100 configure_kubernetes_labels: true buffer: flush_mode: interval flush_interval: 5s timekey: 1m timekey_wait: 30s timekey_use_utc: true EOF ClusterOutput \u5b9a\u7fa9\u4e86\u4e00\u500b\u6c92\u6709\u547d\u540d\u7a7a\u9593\u9650\u5236\u7684\u8f38\u51fa\u3002\u5b83\u50c5\u5728\u8207\u3000Logging Operator \u90e8\u7f72\u5728\u540c\u4e00\u547d\u540d\u7a7a\u9593\u4e2d\u6642\u624d\u6709\u6548\u3002 kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterOutput metadata: name: loki-cluster-output spec: loki: url: http://loki.logging:3100 configure_kubernetes_labels: true buffer: flush_mode: interval flush_interval: 5s timekey: 1m timekey_wait: 30s timekey_use_utc: true EOF \u5275\u5efa Flow / ClusterFlow \u8cc7\u6e90\u3002 \u00b6 Flow ClusterFlow Flow \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684 filters \u548c outputs\uff0c\u5b83\u662f\u4e00\u500b namespaces \u7d1a\u5225\u7684 CRD \u8cc7\u6e90\u3002\u56e0\u6b64\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u61c9\u7528\u6240\u5728\u7684\u547d\u540d\u7a7a\u9593\u5167\u6839\u64da Kubernetes \u6a19\u7c64\u4f86\u6c7a\u5b9a\u65e5\u8a8c\u662f\u5426\u88ab\u63a1\u96c6\uff0c\u540c\u6642\u4e5f\u80fd\u5b9a\u7fa9\u591a\u500b filter \u4f86\u5c0d\u65e5\u8a8c\u9032\u884c\u8655\u7406\u3002\u8209\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: Flow metadata: name: loki-flow spec: filters: - tag_normaliser: {} - parser: remove_key_name_field: true reserve_data: true parse: type: nginx match: - select : labels: app.kubernetes.io/name: log-generator localOutputRefs: - loki-output EOF \u9019\u689d Flow \u7684\u610f\u601d\u662f\uff0c\u8b93\u65e5\u8a8c\u63a1\u96c6\u7aef\u53ea\u8655\u7406\u4f86\u81ea logging \u547d\u540d\u7a7a\u9593\u4e0b\uff0c\u6a19\u7c64 app.kubernetes.io/name: log-generator \u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u540c\u6642\u4e26\u5c0d\u63a1\u96c6\u7684\u65e5\u8a8c\u6309\u7167 nginx \u7684\u683c\u5f0f\u9032\u884c\u89e3\u6790\u3002 \u5982\u679c\u6211\u5011\u9700\u8981\u7c21\u55ae\u7c97\u66b4\u7684\u63a1\u96c6\u6574\u500bKubernetes \u96c6\u7fa4\u88e1\u6240\u6709\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u90a3\u9ebc\u53ea\u9700\u8981\u5b9a\u7fa9\u4e00\u500b\u5982\u4e0b\u5167\u5bb9\u7684 ClusterFlow \u5373\u53ef: kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterFlow metadata: name: loki-cluster-flow spec: filters: - tag_normaliser: {} globalOutputRefs: - loki-cluster-output EOF \u6216\u662f\u8981\u63a1\u96c6\u6307\u5b9a namespaces \u4e0b\u6240\u6709\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u90a3\u9ebc\u53ef\u5b9a\u7fa9\u4e00\u500b\u5982\u4e0b\u5167\u5bb9\u7684 ClusterFlow : kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterFlow metadata: name: loki-cluster-flow spec: filters: - tag_normaliser: {} match\uff1a - select : namespaces: - default - logging - kube-system globalOutputRefs: - loki-cluster-output EOF \u5b89\u88dd\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f \u00b6 kubectl -n logging apply -f - << \"EOF\" apiVersion: apps/v1 kind: Deployment metadata: name: log-generator spec: selector: matchLabels: app.kubernetes.io/name: log-generator replicas: 1 template: metadata: labels: app.kubernetes.io/name: log-generator spec: containers: - name: nginx image: banzaicloud/log-generator:0.3.2 EOF \u9a57\u8b49\u90e8\u7f72 \u00b6 Grafana Dashboard \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u7d22 Grafana \u7ba1\u7406\u54e1\u7528\u6236\u7684\u5bc6\u78bc\uff1a kubectl get secret --namespace logging grafana -o jsonpath = \"{.data.admin-password}\" | base64 --decode ; echo \u555f\u7528\u5230 Grafana \u670d\u52d9\u7684\u7aef\u53e3\u8f49\u767c\u3002 kubectl -n logging port-forward svc/grafana 3000 :80 --address = \"0.0.0.0\" \u6253\u958b Grafana \u5100\u8868\u677f\uff1a http://localhost:3000 \u4f7f\u7528\u5728\u6b65\u9a5f 1 \u4e2d\u6aa2\u7d22\u5230\u7684 admin \u7528\u6236\u540d\u548c\u5bc6\u78bc\u767b\u9304\u3002 \u9078\u64c7 Menu > Explore, \u9078\u64c7 Data source > Loki, \u7136\u5f8c\u9078\u64c7 Log labels \u4e26\u8f38\u5165 {namespace=\"logging\"} \u3002\u6700\u5f8c\u9ede\u64ca Run Query \u3002","title":"\u4f7f\u7528 Logging Operator \u5c07 Nginx \u65e5\u8a8c\u5b58\u5132\u5728 Grafana Loki"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#logging-operator-nginx-grafana-loki","text":"\u539f\u6587: https://banzaicloud.com/docs/one-eye/logging-operator/quickstarts/loki-nginx/ \u672c\u6307\u5357\u4ecb\u7d39\u5982\u4f55\u4f7f\u7528 Logging operator \u5728 Kubernetes \u4e2d\u6536\u96c6\u61c9\u7528\u7a0b\u5e8f\u548c\u5bb9\u5668\u65e5\u8a8c\uff0c\u4ee5\u53ca\u5982\u4f55\u5c07\u5b83\u5011\u767c\u9001\u5230 Grafana Loki\u3002 \u4e0b\u5716\u6982\u8ff0\u4e86\u7cfb\u7d71\u7684\u5de5\u4f5c\u539f\u7406\u3002 Logging operator \u5f9e\u61c9\u7528\u7a0b\u5e8f\u6536\u96c6\u65e5\u8a8c\uff0c\u9078\u64c7\u8981\u8f49\u767c\u5230\u8f38\u51fa\u7684\u65e5\u8a8c\uff0c\u4e26\u5c07\u9078\u5b9a\u7684\u65e5\u8a8c\u6d88\u606f\u767c\u9001\u5230\u8f38\u51fa\u3002\u6709\u95dc Logging operator \u7684\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Logging operator \u6982\u8ff0\u3002","title":"\u4f7f\u7528 Logging Operator \u5c07 Nginx \u8a2a\u554f\u65e5\u8a8c\u5b58\u5132\u5728 Grafana Loki"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#loki-grafana","text":"\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6dfb\u52a0 Loki \u548c Grafana \u7684 chart \u5b58\u5132\u5eab\uff1a helm repo add grafana https://grafana.github.io/helm-charts helm repo add loki https://grafana.github.io/loki/charts helm repo update \u5c07 Loki \u5b89\u88dd\u5230 logging \u547d\u540d\u7a7a\u9593\u4e2d\uff1a helm upgrade --install --create-namespace --namespace logging loki grafana/loki-stack \\ --set promtail.enabled = false \u5c07 Grafana \u5b89\u88dd\u5230 logging \u547d\u540d\u7a7a\u9593\u4e2d\uff1a helm upgrade --install --create-namespace --namespace logging grafana grafana/grafana \\ --set \"datasources.datasources\\\\.yaml.apiVersion=1\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].name=Loki\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].type=loki\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].url=http://loki.logging:3100\" \\ --set \"datasources.datasources\\\\.yaml.datasources[0].access=proxy\"","title":"\u90e8\u7f72 Loki \u548c Grafana"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#logging-operator","text":"\u5b89\u88dd Logging operator \u548c\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f\u4ee5\u63d0\u4f9b\u793a\u4f8b\u65e5\u8a8c\u6d88\u606f\u3002","title":"\u90e8\u7f72 Logging operator \u548c\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#helm-logging-operator","text":"\u8981\u4f7f\u7528 Helm \u5b89\u88dd Logging operator\uff0c\u8acb\u5b8c\u6210\u9019\u4e9b\u6b65\u9a5f\u3002 \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6dfb\u52a0 Logging operator \u7684 helm \u5b58\u5132\u5eab\uff1a helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com helm repo update \u5c07 Logging operator \u5b89\u88dd\u5230 logging \u547d\u540d\u7a7a\u9593\u4e2d\uff1a helm upgrade --install --wait --create-namespace --namespace logging logging-operator banzaicloud-stable/logging-operator \u5728 logging \u7684\u547d\u540d\u7a7a\u9593\u88e1\u5b89\u88dd\u7bc4\u4f8b\u61c9\u7528\u7a0b\u5e8f\u53ca\u5176\u65e5\u8a8c\u8a18\u9304\u5b9a\u7fa9\u3002 helm upgrade --install --wait --create-namespace --namespace logging logging-demo banzaicloud-stable/logging-demo \\ --set \"loki.enabled=True\"","title":"\u4f7f\u7528 Helm \u90e8\u7f72 Logging operator"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#logging-operator_1","text":"","title":"\u90e8\u7f72 Logging operator \u548c\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#logging","text":"kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: Logging metadata: name: default-logging-simple spec: fluentd: {} fluentbit: {} controlNamespace: logging EOF Info \u6ce8\u610f\uff1a\u60a8\u53ea\u80fd\u5728 controlNamespace \u4e2d\u4f7f\u7528 ClusterOutput \u548c ClusterFlow \u8cc7\u6e90\u3002","title":"\u5275\u5efa\u65e5\u8a8c Logging \u8cc7\u6e90\u3002"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#loki-output-clusteroutput","text":"Output \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\uff0c\u76ee\u524d Logging Operator \u652f\u6301\u7684\u65e5\u8a8c\u8f38\u51fa\u63d2\u4ef6\u975e\u5e38\u591a\uff0c\u5305\u542b\u5982\u4e0b\u5167\u5bb9\uff1a Alibaba Cloud Amazon CloudWatch Amazon Elasticsearch Amazon Kinesis Amazon S3 Azure Storage Buffer Datadog Elasticsearch File Format Format rfc5424 Forward GELF Google Cloud Storage Grafana Loki Http Kafka LogDNA LogZ NewRelic Splunk SumoLogic Syslog \u672c\u6b21\u7684\u6559\u7a0b\u4f7f\u7528\u4e86 Grafana Loki \u4f5c\u793a\u4f8b\u3002 Grafana Loki \u63d2\u4ef6\u7528\u4f86\u5b9a\u7fa9 fluentd \u5c07\u65e5\u8a8c\u8f38\u51fa\u5230 Loki \u7576\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u4e9b\u7279\u5b9a\u7684\u53c3\u6578\u4f86\u63a7\u5236\u548c\u512a\u5316\u65e5\u8a8c\u8f38\u51fa\u3002 Output ClusterOutput \uff2futput \u662f\u4e00\u500b namespaces \u7d1a\u5225\u7684 CRD \u8cc7\u6e90\u3002\u56e0\u6b64\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u61c9\u7528\u6240\u5728\u7684\u547d\u540d\u7a7a\u9593\u5167\u642d\u914d\u3000Flow CRD\u7684\u5b9a\u7fa9\u4f86\u6c7a\u5b9a\u65e5\u8a8c\u88ab\u6536\u96c6\u76ee\u7684\u5730\u3002\u8209\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: Output metadata: name: loki-output spec: loki: url: http://loki.logging:3100 configure_kubernetes_labels: true buffer: flush_mode: interval flush_interval: 5s timekey: 1m timekey_wait: 30s timekey_use_utc: true EOF ClusterOutput \u5b9a\u7fa9\u4e86\u4e00\u500b\u6c92\u6709\u547d\u540d\u7a7a\u9593\u9650\u5236\u7684\u8f38\u51fa\u3002\u5b83\u50c5\u5728\u8207\u3000Logging Operator \u90e8\u7f72\u5728\u540c\u4e00\u547d\u540d\u7a7a\u9593\u4e2d\u6642\u624d\u6709\u6548\u3002 kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterOutput metadata: name: loki-cluster-output spec: loki: url: http://loki.logging:3100 configure_kubernetes_labels: true buffer: flush_mode: interval flush_interval: 5s timekey: 1m timekey_wait: 30s timekey_use_utc: true EOF","title":"\u5275\u5efa Loki Output / ClusterOutput \u5b9a\u7fa9\u3002"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#flow-clusterflow","text":"Flow ClusterFlow Flow \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684 filters \u548c outputs\uff0c\u5b83\u662f\u4e00\u500b namespaces \u7d1a\u5225\u7684 CRD \u8cc7\u6e90\u3002\u56e0\u6b64\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u61c9\u7528\u6240\u5728\u7684\u547d\u540d\u7a7a\u9593\u5167\u6839\u64da Kubernetes \u6a19\u7c64\u4f86\u6c7a\u5b9a\u65e5\u8a8c\u662f\u5426\u88ab\u63a1\u96c6\uff0c\u540c\u6642\u4e5f\u80fd\u5b9a\u7fa9\u591a\u500b filter \u4f86\u5c0d\u65e5\u8a8c\u9032\u884c\u8655\u7406\u3002\u8209\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: Flow metadata: name: loki-flow spec: filters: - tag_normaliser: {} - parser: remove_key_name_field: true reserve_data: true parse: type: nginx match: - select : labels: app.kubernetes.io/name: log-generator localOutputRefs: - loki-output EOF \u9019\u689d Flow \u7684\u610f\u601d\u662f\uff0c\u8b93\u65e5\u8a8c\u63a1\u96c6\u7aef\u53ea\u8655\u7406\u4f86\u81ea logging \u547d\u540d\u7a7a\u9593\u4e0b\uff0c\u6a19\u7c64 app.kubernetes.io/name: log-generator \u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u540c\u6642\u4e26\u5c0d\u63a1\u96c6\u7684\u65e5\u8a8c\u6309\u7167 nginx \u7684\u683c\u5f0f\u9032\u884c\u89e3\u6790\u3002 \u5982\u679c\u6211\u5011\u9700\u8981\u7c21\u55ae\u7c97\u66b4\u7684\u63a1\u96c6\u6574\u500bKubernetes \u96c6\u7fa4\u88e1\u6240\u6709\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u90a3\u9ebc\u53ea\u9700\u8981\u5b9a\u7fa9\u4e00\u500b\u5982\u4e0b\u5167\u5bb9\u7684 ClusterFlow \u5373\u53ef: kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterFlow metadata: name: loki-cluster-flow spec: filters: - tag_normaliser: {} globalOutputRefs: - loki-cluster-output EOF \u6216\u662f\u8981\u63a1\u96c6\u6307\u5b9a namespaces \u4e0b\u6240\u6709\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u90a3\u9ebc\u53ef\u5b9a\u7fa9\u4e00\u500b\u5982\u4e0b\u5167\u5bb9\u7684 ClusterFlow : kubectl -n logging apply -f - << \"EOF\" apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterFlow metadata: name: loki-cluster-flow spec: filters: - tag_normaliser: {} match\uff1a - select : namespaces: - default - logging - kube-system globalOutputRefs: - loki-cluster-output EOF","title":"\u5275\u5efa Flow / ClusterFlow \u8cc7\u6e90\u3002"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#_1","text":"kubectl -n logging apply -f - << \"EOF\" apiVersion: apps/v1 kind: Deployment metadata: name: log-generator spec: selector: matchLabels: app.kubernetes.io/name: log-generator replicas: 1 template: metadata: labels: app.kubernetes.io/name: log-generator spec: containers: - name: nginx image: banzaicloud/log-generator:0.3.2 EOF","title":"\u5b89\u88dd\u6f14\u793a\u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/observability/logging/loki/loki-nginx/#_2","text":"Grafana Dashboard \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u7d22 Grafana \u7ba1\u7406\u54e1\u7528\u6236\u7684\u5bc6\u78bc\uff1a kubectl get secret --namespace logging grafana -o jsonpath = \"{.data.admin-password}\" | base64 --decode ; echo \u555f\u7528\u5230 Grafana \u670d\u52d9\u7684\u7aef\u53e3\u8f49\u767c\u3002 kubectl -n logging port-forward svc/grafana 3000 :80 --address = \"0.0.0.0\" \u6253\u958b Grafana \u5100\u8868\u677f\uff1a http://localhost:3000 \u4f7f\u7528\u5728\u6b65\u9a5f 1 \u4e2d\u6aa2\u7d22\u5230\u7684 admin \u7528\u6236\u540d\u548c\u5bc6\u78bc\u767b\u9304\u3002 \u9078\u64c7 Menu > Explore, \u9078\u64c7 Data source > Loki, \u7136\u5f8c\u9078\u64c7 Log labels \u4e26\u8f38\u5165 {namespace=\"logging\"} \u3002\u6700\u5f8c\u9ede\u64ca Run Query \u3002","title":"\u9a57\u8b49\u90e8\u7f72"},{"location":"kubernetes/observability/logging/loki/loki-ql/","text":"Grafana Loki \u67e5\u8a62\u8a9e\u8a00 LogQL \u4f7f\u7528 \u00b6 \u539f\u6587: https://grafana.com/docs/loki/latest/logql/log_queries/ \u53d7 PromQL \u7684\u5553\u767c\uff0cLoki \u4e5f\u6709\u81ea\u5df1\u7684\u67e5\u8a62\u8a9e\u8a00\uff0c\u7a31\u7232 LogQL\uff0c\u5b83\u5c31\u50cf\u4e00\u500b\u5206\u4f48\u5f0f\u7684 grep\uff0c\u53ef\u4ee5\u805a\u5408\u67e5\u770b\u65e5\u8a8c\u3002\u548c PromQL \u4e00\u6a23\uff0cLogQL \u4e5f\u662f\u4f7f\u7528\u6a19\u7c64\u548c\u904b\u7b97\u7b26\u9032\u884c\u904e\u6ffe\u7684\uff0c\u4e3b\u8981\u6709\u5169\u7a2e\u985e\u578b\u7684\u67e5\u8a62\u529f\u80fd\uff1a Log query \u67e5\u8a62\u8fd4\u56de\u65e5\u8a8c\u884c\u5167\u5bb9 Metrics query \u901a\u904e\u904e\u6ffe\u898f\u5247\u5728\u65e5\u8a8c\u6d41\u4e2d\u8a08\u7b97\u76f8\u95dc\u7684\u5ea6\u91cf\u6307\u6a19 Log query \u00b6 \u4e00\u500b\u57fa\u672c\u7684\u65e5\u8a8c\u67e5\u8a62\u7531\u5169\u90e8\u5206\u7d44\u6210\u3002 log stream selector\uff08\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\uff09 log pipeline\uff08\u65e5\u8a8c\u7ba1\u9053\uff09 \u7531\u65bc Loki \u7684\u8a2d\u8a08\uff0c\u6240\u6709 LogQL \u67e5\u8a62\u5fc5\u9808\u5305\u542b\u4e00\u500b\u65e5\u8a8c\u6d41\u9078\u64c7\u5668 (log stream selector)\u3002\u4e00\u500b Log Stream \u4ee3\u8868\u4e86\u5177\u6709\u76f8\u540c\u5143\u6578\u64da (Label \u96c6) \u7684\u65e5\u8a8c\u689d\u76ee\u3002 \u65e5\u8a8c\u6d41\u9078\u64c7\u5668 (log stream selector) \u6c7a\u5b9a\u4e86\u6709\u591a\u5c11\u65e5\u8a8c\u5c07\u88ab\u641c\u7d22\u5230\uff0c\u4e00\u500b\u66f4\u7d30\u7c92\u5ea6\u7684\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u5c07\u641c\u7d22\u5230\u6d41\u7684\u6578\u91cf\u6e1b\u5c11\u5230\u4e00\u500b\u53ef\u7ba1\u7406\u7684\u6578\u91cf\uff0c\u901a\u904e\u7cbe\u7d30\u7684\u5339\u914d\u65e5\u8a8c\u6d41\uff0c\u53ef\u4ee5\u5927\u5e45\u6e1b\u5c11\u67e5\u8a62\u671f\u9593\u5e36\u4f86\u8cc7\u6e90\u6d88\u8017\u3002 \u800c\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u5f8c\u9762\u7684 \u65e5\u8a8c\u7ba1\u9053 (log pipeline) \u662f\u53ef\u9078\u7684\uff0c\u7528\u65bc\u9032\u4e00\u6b65\u8655\u7406\u548c\u904e\u6ffe\u65e5\u8a8c\u6d41\u4fe1\u606f\uff0c\u5b83\u7531\u4e00\u7d44\u8868\u9054\u5f0f\u7d44\u6210\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u90fd\u4ee5\u5f9e\u5de6\u5230\u53f3\u7684\u9806\u5e8f\u7232\u6bcf\u500b\u65e5\u8a8c\u884c\u57f7\u884c\u76f8\u95dc\u904e\u6ffe\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u90fd\u53ef\u4ee5\u904e\u6ffe\u3001\u89e3\u6790\u548c\u6539\u8b8a\u65e5\u8a8c\u884c\u5167\u5bb9\u4ee5\u53ca\u5404\u81ea\u7684\u6a19\u7c64\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u986f\u793a\u4e86\u4e00\u500b\u5b8c\u6574\u7684\u65e5\u8a8c\u67e5\u8a62\u7684\u64cd\u4f5c\uff1a log ql { container = \"query-frontend\" ,namespace = \"loki-dev\" } | = \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \u8a72\u67e5\u8a62\u8a9e\u53e5\u7531\u4ee5\u4e0b\u5e7e\u500b\u90e8\u5206\u7d44\u6210\uff1a \u4e00\u500b\u65e5\u8a8c\u6d41\u9078\u64c7\u5668 {container=\"query-frontend\",namespace=\"loki-dev\"} \uff0c\u7528\u65bc\u904e\u6ffe loki-dev \u547d\u540d\u7a7a\u9593\u4e0b\u9762\u7684 query-frontend \u5bb9\u5668\u7684\u65e5\u8a8c \u7136\u5f8c\u5f8c\u9762\u8ddf\u7740\u4e00\u500b\u65e5\u8a8c\u7ba1\u9053 |= \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \uff0c\u8a72\u7ba1\u9053\u8868\u793a\u5c07\u7be9\u9078\u51fa\u5305\u542b metrics.go \u9019\u500b\u8a5e\u7684\u65e5\u8a8c\uff0c\u7136\u5f8c\u89e3\u6790\u6bcf\u4e00\u884c\u65e5\u8a8c\u63d0\u53d6\u66f4\u591a\u7684\u8868\u9054\u5f0f\u4e26\u9032\u884c\u904e\u6ffe Tip \u70ba\u907f\u514d escape \u7279\u6b8a\u5b57\u7b26\uff0c\u60a8\u53ef\u4ee5\u5728\u5f15\u7528\u5b57\u7b26\u4e32\u6642\u4f7f\u7528 \\' (backtick) \u800c\u4e0d\u662f \"\u3002\u4f8b\u5982\uff0c`\\w+` \u8207 \"\\w+\" \u76f8\u540c\u3002\u9019\u5728\u7de8\u5beb\u5305\u542b\u591a\u500b\u53cd\u659c\u6760\u7684\u6b63\u5247\u8868\u9054\u5f0f\u6642\u7279\u5225\u6709\u7528\u9700\u8981 escape\u3002 Log Stream Selector \u00b6 \u65e5\u8a8c\u6d41\u9078\u64c7\u5668 (Log Stream Selector) \u6c7a\u5b9a\u4e86\u54ea\u4e9b\u65e5\u8a8c\u6d41\u61c9\u8a72\u88ab\u5305\u542b\u5728\u4f60\u7684\u67e5\u8a62\u7d50\u679c\u4e2d\uff0c\u9078\u64c7\u5668\u7531\u4e00\u500b\u6216\u591a\u500b\u9375\u503c\u5c0d\u7d44\u6210\uff0c\u5176\u4e2d\u6bcf\u500b\u9375\u662f\u4e00\u500b\u65e5\u8a8c\u6a19\u7c64\uff0c\u6bcf\u500b\u503c\u662f\u8a72\u6a19\u7c64\u7684\u503c\u3002 \u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u662f\u901a\u904e\u5c07\u9375\u503c\u5c0d\u5305\u88f9\u5728\u4e00\u5c0d \u5927\u62ec\u865f \u4e2d\u7de8\u5beb\u7684\uff0c\u6bd4\u5982\uff1a { app = \"mysql\" , } \u4e0a\u9762\u9019\u500b\u793a\u4f8b\u8868\u793a\uff0c\u6240\u6709\u6a19\u7c64\u7232 app \u4e14\u5176\u503c\u7232 mysql \u548c\u6a19\u7c64\u7232 name \u4e14\u5176\u503c\u7232 mysql-backup \u7684\u65e5\u8a8c\u6d41\u5c07\u88ab\u5305\u62ec\u5728\u67e5\u8a62\u7d50\u679c\u4e2d\u3002 \u5176\u4e2d\u6a19\u7c64\u540d\u5f8c\u9762\u7684 = \u904b\u7b97\u7b26\u662f\u4e00\u500b\u6a19\u7c64\u5339\u914d\u904b\u7b97\u7b26\uff0cLogQL \u4e2d\u4e00\u5171\u652f\u6301\u4ee5\u4e0b\u5e7e\u7a2e\u6a19\u7c64\u5339\u914d\u904b\u7b97\u7b26\uff1a = \u5b8c\u5168\u5339\u914d != \u4e0d\u76f8\u7b49 =~ \u6b63\u5247\u8868\u9054\u5f0f\u5339\u914d !~ \u6b63\u5247\u8868\u9054\u5f0f\u4e0d\u5339\u914d \u4f8b\u5982\uff1a { name = ~ \"mysql.+\" } { name!~ \"mysql.+\" } { name!~ \"mysql-\\\\d+\" } \u9069\u7528\u65bc Prometheus \u6a19\u7c64\u9078\u64c7\u5668\u7684\u898f\u5247\u540c\u6a23\u9069\u7528\u65bc Loki \u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u3002 Log Pipeline \u00b6 \u65e5\u8a8c\u7ba1\u9053\u53ef\u4ee5\u9644\u52a0\u5230\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e0a\uff0c\u4ee5\u9032\u4e00\u6b65\u8655\u7406\u548c\u904e\u6ffe\u65e5\u8a8c\u6d41\u3002\u5b83\u901a\u5e38\u7531\u4e00\u500b\u6216\u591a\u500b \u8868\u9054\u5f0f \u7d44\u6210\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u91dd\u5c0d\u6bcf\u500b\u65e5\u8a8c\u884c\u4f9d\u6b21\u57f7\u884c\u3002\u5982\u679c\u4e00\u500b\u8868\u9054\u5f0f\u904e\u6ffe\u6389\u4e86\u65e5\u8a8c\u884c\uff0c\u5247\u7ba1\u9053\u5c07\u5728\u6b64\u8655\u505c\u6b62\u4e26\u958b\u59cb\u8655\u7406\u4e0b\u4e00\u884c\u3002\u4e00\u4e9b\u8868\u9054\u5f0f\u53ef\u4ee5\u6539\u8b8a\u65e5\u8a8c\u5167\u5bb9\u548c\u5404\u81ea\u7684\u6a19\u7c64\uff0c\u7136\u5f8c\u53ef\u7528\u65bc\u9032\u4e00\u6b65\u904e\u6ffe\u548c\u8655\u7406\u5f8c\u7e8c\u8868\u9054\u5f0f\u6216\u6307\u6a19\u67e5\u8a62\u3002 \u4e00\u500b\u65e5\u8a8c\u7ba1\u9053\u53ef\u4ee5\u7531\u4ee5\u4e0b\u90e8\u5206\u7d44\u6210\u3002 \u904e\u6ffe\u8868\u9054\u5f0f (Filtering expressions) \u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f (Line filter expressions) \u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f (Label filter expressions) \u89e3\u6790\u5668\u8868\u9054\u5f0f (Parsing expressions) \u683c\u5f0f\u5316\u8868\u9054\u5f0f (Formatting expressions) \u65e5\u8a8c\u884c\u683c\u5f0f\u5316\u8868\u9054\u5f0f (Line format expression) \u6a19\u7c64\u683c\u5f0f\u5316\u8868\u9054\u5f0f (Labels format expression) Line filter expressions \u00b6 \u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f\u7528\u65bc\u5c0d\u5339\u914d\u65e5\u8a8c\u6d41\u4e2d\u7684\u805a\u5408\u65e5\u8a8c\u9032\u884c\u5206\u4f48\u5f0f grep\u3002 \u7de8\u5beb\u5165\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u5f8c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b \u641c\u7d22\u8868\u9054\u5f0f \u9032\u4e00\u6b65\u904e\u6ffe\u5f97\u5230\u7684\u65e5\u8a8c\u6578\u64da\u96c6\uff0c\u641c\u7d22\u8868\u9054\u5f0f\u53ef\u4ee5\u662f\u6587\u672c\u6216\u6b63\u5247\u8868\u9054\u5f0f\uff0c\u6bd4\u5982\uff1a { job = \"mysql\" } | = \"error\" { instance = ~ \"kafka-[23]\" ,name = \"kafka\" } ! = \"kafka.server:type=ReplicaManager\" { name = \"kafka\" } | ~ \"tsdb-ops.*io:2003\" { name = \"cassandra\" } | ~ ` error = \\w + ` \u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 |= \u3001 |~ \u548c != \u662f\u904e\u6ffe\u904b\u7b97\u7b26\uff0c\u652f\u6301\u4e0b\u9762\u5e7e\u7a2e\u985e\u578b\uff1a |= \u65e5\u8a8c\u884c\u5305\u542b\u7684\u5b57\u7b26\u4e32 != \u65e5\u8a8c\u884c\u4e0d\u5305\u542b\u7684\u5b57\u7b26\u4e32 |~ \u65e5\u8a8c\u884c\u5339\u914d\u6b63\u5247\u8868\u9054\u5f0f !~ \u65e5\u8a8c\u884c\u8207\u6b63\u5247\u8868\u9054\u5f0f\u4e0d\u5339\u914d \u904e\u6ffe\u904b\u7b97\u7b26\u53ef\u4ee5\u662f\u4e32\u9023\u5728\u4e00\u8d77\u4f7f\u7528\u7684\uff0c\u4e26\u5c07\u6309\u9806\u5e8f\u57f7\u884c\u904e\u6ffe\u8868\u9054\u5f0f\uff0c\u7522\u751f\u7684\u65e5\u8a8c\u884c\u5fc5\u9808\u6eff\u8db3\u6bcf\u500b\u904e\u6ffe\u5668\u3002\u7576\u4f7f\u7528 |~ \u548c !~ \u6642\uff0c\u53ef\u4ee5\u4f7f\u7528 Golang \u7684 RE2 \u8a9e\u6cd5 \u7684\u6b63\u5247\u8868\u9054\u5f0f\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5339\u914d\u662f\u5340\u5206\u5927\u5c0f\u5beb\u7684\uff0c\u53ef\u4ee5\u7528 (?i) \u4f5c\u7232\u6b63\u5247\u8868\u9054\u5f0f\u7684\u524d\u7db4\uff0c\u5207\u63db\u7232\u4e0d\u5340\u5206\u5927\u5c0f\u5beb\u3002 \u96d6\u7136\u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f\u53ef\u4ee5\u653e\u5728\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\uff0c\u4f46\u6700\u597d\u628a\u5b83\u5011\u653e\u5728\u958b\u982d\uff0c\u9019\u6a23\u53ef\u4ee5\u63d0\u9ad8\u67e5\u8a62\u7684\u6027\u80fd\uff0c\u7576\u67d0\u4e00\u884c\u5339\u914d\u6642\u624d\u505a\u9032\u4e00\u6b65\u7684\u5f8c\u7e8c\u8655\u7406\u3002\u4f8b\u5982\uff0c\u96d6\u7136\u7d50\u679c\u662f\u4e00\u6a23\u7684\uff0c\u4f46\u4e0b\u9762\u7684\u67e5\u8a62 {job=\"mysql\"} |= \"error\" |json | line_format \"{{.err}}\" \u6703\u6bd4 {job=\"mysql\"} | json | line_format \"{{.message}}\" |= \"error\" \u66f4\u5feb\uff0c \u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f\u662f\u7e7c\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e4b\u5f8c\u904e\u6ffe\u65e5\u8a8c\u7684\u6700\u5feb\u65b9\u5f0f \u3002 Label filter expressions \u00b6 \u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f \u5141\u8a31\u4f7f\u7528\u5176\u539f\u59cb\u548c\u63d0\u53d6\u7684\u6a19\u7c64\u4f86\u904e\u6ffe\u65e5\u8a8c\u884c\uff0c\u5b83\u53ef\u4ee5\u5305\u542b\u591a\u500b \u8b02\u8a5e \u3002 \u4e00\u500b\u8b02\u8a5e\u5305\u542b\u4e00\u500b\u6a19\u7c64\u6a19\u8b58\u7b26\u3001\u64cd\u4f5c\u7b26\u548c\u7528\u65bc\u6bd4\u8f03\u6a19\u7c64\u7684\u503c\u3002 \u4f8b\u5982 cluster=\"namespace\" \u5176\u4e2d\u7684 cluster \u662f\u6a19\u7c64\u6a19\u8b58\u7b26\uff0c\u64cd\u4f5c\u7b26\u662f = \uff0c\u503c\u662f \"namespace\" \u3002 LogQL \u652f\u6301\u5f9e\u67e5\u8a62\u8f38\u5165\u4e2d\u81ea\u52d5\u63a8\u65b7\u51fa\u7684\u591a\u7a2e\u503c\u985e\u578b\uff1a String \uff08\u5b57\u7b26\u4e32\uff09\u7528\u96d9\u5f15\u865f\u6216\u53cd\u5f15\u865f\u5f15\u8d77\u4f86\uff0c\u4f8b\u5982\"200\"\u6216 us-central1\u3002 Duration \uff08\u6642\u9593\uff09\u662f\u4e00\u4e32\u5341\u9032\u5236\u6578\u5b57\uff0c\u6bcf\u500b\u6578\u5b57\u90fd\u6709\u53ef\u9078\u7684\u6578\u548c\u55ae\u4f4d\u5f8c\u7db4\uff0c\u5982 \"300ms\"\u3001\"1.5h\" \u6216 \"2h45m\"\uff0c\u6709\u6548\u7684\u6642\u9593\u55ae\u4f4d\u662f \"ns\"\u3001\"us\"\uff08\u6216 \"\u00b5s\"\uff09\u3001\"ms\"\u3001\"s\"\u3001\"m\"\u3001\"h\"\u3002 Number \uff08\u6578\u5b57\uff09\u662f\u6d6e\u9ede\u6578\uff0864 \u4f4d\uff09\uff0c\u5982 250\u300189.923\u3002 Bytes \uff08\u5b57\u7bc0\uff09\u662f\u4e00\u4e32\u5341\u9032\u5236\u6578\u5b57\uff0c\u6bcf\u500b\u6578\u5b57\u90fd\u6709\u53ef\u9078\u7684\u6578\u548c\u55ae\u4f4d\u5f8c\u7db4\uff0c\u5982 \"42MB\"\u3001\"1.5Kib\" \u6216 \"20b\"\uff0c\u6709\u6548\u7684\u5b57\u7bc0\u55ae\u4f4d\u662f \"b\"\u3001\"kib\"\u3001\"kb\"\u3001\"mib\"\u3001\"mb\"\u3001\"gib\"\u3001\"gb\"\u3001\"tib\"\u3001\"tb\"\u3001\"pib\"\u3001\"bb\"\u3001\"eb\"\u3002 \u5b57\u7b26\u4e32\u985e\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u8207 Prometheus \u6a19\u7c64\u5339\u914d\u5668\u5728\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e2d\u4f7f\u7528\u7684\u65b9\u5f0f\u5b8c\u5168\u4e00\u6a23\uff0c\u9019\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u4f7f\u7528\u540c\u6a23\u7684\u64cd\u4f5c\u7b26\uff08 = \u3001 != \u3001 =~ \u3001 !~ u\uff09\u3002 \u4f7f\u7528 Duration\u3001Number \u548c Bytes \u5c07\u5728\u6bd4\u8f03\u524d\u8f49\u63db\u6a19\u7c64\u503c\uff0c\u4e26\u652f\u6301\u4ee5\u4e0b\u6bd4\u8f03\u5668\u3002 == \u6216 = \u76f8\u7b49\u6bd4\u8f03 != \u4e0d\u7b49\u65bc\u6bd4\u8f03 > \u548c >= \u7528\u65bc\u5927\u65bc\u6216\u5927\u65bc\u7b49\u65bc\u6bd4\u8f03 < \u548c <= \u7528\u65bc\u5c0f\u65bc\u6216\u5c0f\u65bc\u7b49\u65bc\u6bd4\u8f03 \u4f8b\u5982 logfmt | duration > 1m and bytes_consumed > 20MB \u904e\u6ffe\u8868\u9054\u5f0f\u3002 \u5982\u679c\u6a19\u7c64\u503c\u7684\u8f49\u63db\u6216\u63d0\u53d6\u5931\u6557\uff0c\u65e5\u8a8c\u884c\u5c31\u4e0d\u6703\u88ab\u904e\u6ffe\uff0c\u800c\u6703\u6dfb\u52a0\u4e00\u500b error \u6a19\u7c64\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 and \u3000\u548c or \u4f86\u9023\u63a5\u591a\u500b\u8b02\u8a5e\uff0c\u5b83\u5011\u5206\u5225\u8868\u793a \u4e14 \u548c \u6216 \u7684\u4e8c\u9032\u5236\u64cd\u4f5c\uff0c and \u53ef\u4ee5\u7528\u9017\u865f\u3001\u7a7a\u683c\u6216\u5176\u4ed6\u7ba1\u9053\u4f86\u8868\u793a\uff0c\u6a19\u7c64\u904e\u6ffe\u5668\u53ef\u4ee5\u653e\u5728\u65e5\u8a8c\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\u3002 \u4ee5\u4e0b\u6240\u6709\u7684\u8868\u9054\u5f0f\u90fd\u662f\u7b49\u50f9\u7684: | duration > = 20ms or size == 20kb and method!~ \"2..\" | duration > = 20ms or size == 20kb | method!~ \"2..\" | duration > = 20ms or size == 20kb,method!~ \"2..\" | duration > = 20ms or size == 20kb method!~ \"2..\" \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u591a\u500b\u8b02\u8a5e\u7684\u512a\u5148\u7d1a\u662f\u5f9e\u53f3\u5230\u5de6\uff0c\u4f60\u53ef\u4ee5\u7528\u5713\u62ec\u865f\u5305\u88dd\u8b02\u8a5e\uff0c\u5f37\u5236\u4f7f\u7528\u5f9e\u5de6\u5230\u53f3\u7684\u4e0d\u540c\u512a\u5148\u7d1a\u3002 \u4f8b\u5982\uff0c\u4ee5\u4e0b\u5167\u5bb9\u662f\u7b49\u50f9\u7684\uff1a | duration > = 20ms or method = \"GET\" and size < = 20KB | (( duration > = 20ms or method = \"GET\" ) and size < = 20KB ) \u5b83\u5c07\u9996\u5148\u8a55\u4f30 duration>=20ms or method=\"GET\"\uff0c\u8981\u9996\u5148\u8a55\u4f30 method=\"GET\" and size<=20KB\uff0c\u8acb\u78ba\u4fdd\u4f7f\u7528\u9069\u7576\u7684\u62ec\u865f\uff0c\u5982\u4e0b\u6240\u793a\u3002 | duration > = 20ms or ( method = \"GET\" and size < = 20KB ) \u6a19\u7c64\u904e\u6ffe\u5668\u8868\u9054\u5f0f\u652f\u6301\u5339\u914d IP \u5730\u5740\u3002\u6709\u95dc\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5339\u914d IP \u5730\u5740 \u3002 Parser expression \u00b6 \u89e3\u6790\u5668\u8868\u9054\u5f0f \u53ef\u4ee5\u89e3\u6790\u548c\u63d0\u53d6\u65e5\u8a8c\u5167\u5bb9\u4e2d\u7684\u6a19\u7c64\uff0c\u9019\u4e9b\u63d0\u53d6\u7684\u6a19\u7c64\u53ef\u4ee5\u7528\u65bc\u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f\u9032\u884c\u904e\u6ffe\uff0c\u6216\u8005\u7528\u65bc\u6307\u6a19\u805a\u5408\u3002 \u63d0\u53d6\u7684\u6a19\u7c64\u9375\u5c07\u7531\u89e3\u6790\u5668\u9032\u884c\u81ea\u52d5\u683c\u5f0f\u5316\uff0c\u4ee5\u9075\u5faa Prometheus \u6307\u6a19\u540d\u7a31\u7684\u7d04\u5b9a\uff08\u5b83\u5011\u53ea\u80fd\u5305\u542b ASCII \u5b57\u6bcd\u548c\u6578\u5b57\uff0c\u4ee5\u53ca\u4e0b\u5283\u7dda\u548c\u5192\u865f\uff0c\u4e0d\u80fd\u4ee5\u6578\u5b57\u958b\u982d\uff09\u3002 \u4f8b\u5982\u4e0b\u9762\u7684\u65e5\u8a8c\u7d93\u904e\u7ba1\u9053 | json \u5c07\u7522\u751f\u4ee5\u4e0b Map \u6578\u64da\uff1a \u65e5\u8a8c\u539f\u59cb\u6578\u64da: log line { \"a.b\" : { \"c\" : \"d\" }, \"e\" : \"f\" } \u89e3\u6790\u5668\u8868\u9054\u5f0f\u8655\u7406\u5f8c\u7d50\u679c: { a_b_c = \"d\" , e = \"f\" } \u5728\u51fa\u73fe\u932f\u8aa4\u7684\u60c5\u6cc1\u4e0b\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u8a72\u884c\u4e0d\u662f\u9810\u671f\u7684\u683c\u5f0f\uff0c\u8a72\u65e5\u8a8c\u884c\u4e0d\u6703\u88ab\u904e\u6ffe\uff0c\u800c\u662f\u6703\u88ab\u6dfb\u52a0\u4e00\u500b\u65b0\u7684 __error__ \u6a19\u7c64\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u4e00\u500b\u63d0\u53d6\u7684\u6a19\u7c64\u9375\u540d\u5df2\u7d93\u5b58\u5728\u65bc\u539f\u59cb\u65e5\u8a8c\u6d41\u4e2d\uff0c\u90a3\u9ebc\u63d0\u53d6\u7684\u6a19\u7c64\u9375\u5c07\u4ee5 _extracted \u4f5c\u7232\u5f8c\u7db4\uff0c\u4ee5\u5340\u5206\u5169\u500b\u6a19\u7c64\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b\u6a19\u7c64\u683c\u5f0f\u5316\u8868\u9054\u5f0f\u4f86\u5f37\u884c\u8986\u84cb\u539f\u59cb\u6a19\u7c64\uff0c\u4f46\u662f\u5982\u679c\u4e00\u500b\u63d0\u53d6\u7684\u9375\u51fa\u73fe\u4e86\u5169\u6b21\uff0c\u90a3\u9ebc\u53ea\u6709\u6700\u65b0\u7684\u6a19\u7c64\u503c\u6703\u88ab\u4fdd\u7559\u3002 \u76ee\u524d\u652f\u6301 json\u3001logfmt\u3001pattern\u3001regexp \u548c unpack \u9019\u5e7e\u7a2e\u89e3\u6790\u5668\u3002 \u6211\u5011\u61c9\u8a72\u5118\u53ef\u80fd\u4f7f\u7528 json \u548c logfmt \u7b49\u9810\u5b9a\u7fa9\u7684\u89e3\u6790\u5668\uff0c\u9019\u6703\u66f4\u52a0\u5bb9\u6613\uff0c\u800c\u7576\u65e5\u5fd7\u884c\u7d50\u69cb\u7570\u5e38\u6642\uff0c\u53ef\u4ee5\u4f7f\u7528 regexp\uff0c\u53ef\u4ee5\u5728\u540c\u4e00\u65e5\u8a8c\u7ba1\u9053\u4e2d\u4f7f\u7528\u591a\u500b\u89e3\u6790\u5668\uff0c\u9019\u5728\u4f60\u89e3\u6790\u8907\u96dc\u65e5\u8a8c\u6642\u5f88\u6709\u7528\u3002 json \u89e3\u6790\u5668 \u00b6 json \u89e3\u6790\u5668\u6709\u5169\u7a2e\u6a21\u5f0f\u904b\u884c\u3002 \u6c92\u6709\u53c3\u6578 : \u5982\u679c\u65e5\u8a8c\u884c\u662f\u4e00\u500b\u6709\u6548\u7684 json \u6587\u6a94\uff0c\u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u6dfb\u52a0 | json \u5c07\u63d0\u53d6\u6240\u6709 json \u5c6c\u6027\u4f5c\u7232\u6a19\u7c64\uff0c\u5d4c\u5957\u7684\u5c6c\u6027\u6703\u4f7f\u7528 _ \u5206\u9694\u7b26\u88ab\u5e73\u92ea\u5230\u6a19\u7c64\u9375\u4e2d\u3002 Info \u6ce8\u610f\uff1a\u6578\u7d44\u6703\u88ab\u5ffd\u7565\u3002 \u4f8b\u5982\uff0c\u4f7f\u7528 json \u89e3\u6790\u5668\u5f9e\u4ee5\u4e0b\u6587\u4ef6\u5167\u5bb9\u4e2d\u63d0\u53d6\u6a19\u7c64\u3002 { \"protocol\" : \"HTTP/2.0\" , \"servers\" : [ \"129.0.1.1\" , \"10.2.1.3\" ], \"request\" : { \"time\" : \"6.032\" , \"method\" : \"GET\" , \"host\" : \"foo.grafana.net\" , \"size\" : \"55\" , \"headers\" : { \"Accept\" : \"*/*\" , \"User-Agent\" : \"curl/7.68.0\" } }, \"response\" : { \"status\" : 401 , \"size\" : \"228\" , \"latency_seconds\" : \"6.031\" } } \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6a19\u7c64\u5217\u8868\uff1a \"protocol\" = > \"HTTP/2.0\" \"request_time\" = > \"6.032\" \"request_method\" = > \"GET\" \"request_host\" = > \"foo.grafana.net\" \"request_size\" = > \"55\" \"response_status\" = > \"401\" \"response_size\" = > \"228\" \"response_latency_seconds\" = > \"6.031\" \u5e36\u53c3\u6578\u7684 : \u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u4f7f\u7528 |json label=\"expression\", another=\"expression\" \u5c07\u53ea\u63d0\u53d6\u6307\u5b9a\u7684 json \u5b57\u6bb5\u7232\u6a19\u7c64\uff0c\u4f60\u53ef\u4ee5\u7528\u9019\u7a2e\u65b9\u5f0f\u6307\u5b9a\u4e00\u500b\u6216\u591a\u500b\u8868\u9054\u5f0f\uff0c\u8207 label_format \u76f8\u540c\uff0c\u6240\u6709\u8868\u9054\u5f0f\u5fc5\u9808\u52a0\u5f15\u865f\u3002 \u7576\u524d\u50c5\u652f\u6301\u5b57\u6bb5\u8a2a\u554f\uff08 my.field , my[\"field\"] \uff09\u548c\u6578\u7d44\u8a2a\u554f\uff08 list[0] \uff09\uff0c\u4ee5\u53ca\u4efb\u4f55\u7d1a\u5225\u5d4c\u5957\u4e2d\u7684\u9019\u4e9b\u7d44\u5408\uff08 my.list[0][\"field\"] \uff09\u3002 \u4f8b\u5982\uff0c |json first_server=\"servers[0]\", ua=\"request.headers[\\\"User-Agent\\\"] \u5c07\u5f9e\u4ee5\u4e0b\u65e5\u8a8c\u6587\u4ef6\u4e2d\u63d0\u53d6\u6a19\u7c64\uff1a { \"protocol\" : \"HTTP/2.0\" , \"servers\" : [ \"129.0.1.1\" , \"10.2.1.3\" ], \"request\" : { \"time\" : \"6.032\" , \"method\" : \"GET\" , \"host\" : \"foo.grafana.net\" , \"size\" : \"55\" , \"headers\" : { \"Accept\" : \"*/*\" , \"User-Agent\" : \"curl/7.68.0\" } }, \"response\" : { \"status\" : 401 , \"size\" : \"228\" , \"latency_seconds\" : \"6.031\" } } \u63d0\u53d6\u7684\u6a19\u7c64\u5217\u8868\u7232\uff1a \"first_server\" = > \"129.0.1.1\" \"ua\" = > \"curl/7.68.0\" logfmt \u89e3\u6790\u5668 \u00b6 logfmt \u89e3\u6790\u5668\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 | logfmt \u4f86\u6dfb\u52a0\uff0c\u5b83\u5c07\u5f9e logfmt \u683c\u5f0f\u7684\u65e5\u8a8c\u884c\u4e2d\u63d0\u524d\u6240\u6709\u7684\u9375\u548c\u503c\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u65e5\u8a8c\u884c\u6578\u64da\uff1a log line at = info method = GET path = / host = grafana.net fwd = \"124.133.124.161\" service = 8ms status = 200 \u5c07\u63d0\u53d6\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6a19\u7c64\uff1a \"at\" = > \"info\" \"method\" = > \"GET\" \"path\" = > \"/\" \"host\" = > \"grafana.net\" \"fwd\" = > \"124.133.124.161\" \"service\" = > \"8ms\" \"status\" = > \"200\" regexp \u89e3\u6790\u5668 \u00b6 \u8207 logfmt \u548c json\uff08\u5b83\u5011\u96b1\u5f0f\u63d0\u53d6\u6240\u6709\u503c\u4e14\u4e0d\u9700\u8981\u53c3\u6578\uff09\u4e0d\u540c\uff0cregexp \u89e3\u6790\u5668\u63a1\u7528\u55ae\u500b\u53c3\u6578 | regexp \"<re>\" \u7684\u683c\u5f0f\uff0c\u5176\u53c3\u6578\u662f\u4f7f\u7528 Golang RE2 \u8a9e\u6cd5\u7684\u6b63\u5247\u8868\u9054\u5f0f\u3002 \u6b63\u5247\u8868\u9054\u5f0f\u5fc5\u9808\u5305\u542b\u81f3\u5c11\u4e00\u500b\u547d\u540d\u7684\u5b50\u5339\u914d\uff08\u4f8b\u5982 (?P<name>re) \uff09\uff0c\u6bcf\u500b\u5b50\u5339\u914d\u9805\u90fd\u6703\u63d0\u53d6\u4e00\u500b\u4e0d\u540c\u7684\u6a19\u7c64\u3002 \u4f8b\u5982\uff0c\u89e3\u6790\u5668 | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\" \u5c07\u5f9e\u4ee5\u4e0b\u884c\u4e2d\u63d0\u53d6\u6a19\u7c64\uff1a POST /api/prom/api/v1/query_range ( 200 ) 1 .5s \u63d0\u53d6\u7684\u6a19\u7c64\u7232\uff1a \"method\" = > \"POST\" \"path\" = > \"/api/prom/api/v1/query_range\" \"status\" = > \"200\" \"duration\" = > \"1.5s\" \u4e0b\u5217\u5de5\u5177\u53ef\u5e6b\u52a9\u9a57\u8b49\u8a9e\u6cd5\u7684\u57f7\u884c\uff1a \u5de5\u5177\uff1a\u3000 https://regoio.herokuapp.com/ \u6b63\u5247\u8868\u9054\u5f0f: (?P<method>\\w+) (?P<path>[\\w|/]+) \\((?P<status>\\d+?)\\) (?P<duration>.*) \u5de5\u5177\uff1a\u3000 https://grafana.com/docs/loki/latest/logql/analyzer/ Query\u8868\u9054\u5f0f: | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\" pattern \u89e3\u6790\u5668 \u00b6 \u6a21\u5f0f\u89e3\u6790\u5668\u5141\u8a31\u901a\u904e\u5b9a\u7fa9\u6a21\u5f0f\u8868\u9054\u5f0f | pattern \"<pattern-expression>\" \u5f9e\u65e5\u8a8c\u884c\u4e2d\u986f\u5f0f\u63d0\u53d6\u5b57\u6bb5\uff0c\u8a72\u8868\u9054\u5f0f\u8207\u65e5\u8a8c\u884c\u7684\u7d50\u69cb\u76f8\u5339\u914d\u3002 \u6bd4\u5982\u6211\u5011\u4f86\u8003\u616e\u4e0b\u9762\u7684 NGINX \u65e5\u8a8c\u884c\u6578\u64da\uff1a log line 0 .191.12.2 - - [ 10 /Jun/2021:09:14:29 +0000 ] \"GET /api/plugins/versioncheck HTTP/1.1\" 200 2 \"-\" \"Go-http-client/2.0\" \"13.76.247.102, 34.120.177.193\" \"TLSv1.2\" \"US\" \"\" \u8a72\u65e5\u8a8c\u884c\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4f86\u89e3\u6790\uff1a <ip> - - <_> \"<method> <uri> <_>\" <status> <size> <_> \"<agent>\" <_> \u89e3\u6790\u5f8c\u53ef\u4ee5\u63d0\u53d6\u51fa\u4e0b\u9762\u7684\u9019\u4e9b\u5c6c\u6027\uff1a \"ip\" = > \"0.191.12.2\" \"method\" = > \"GET\" \"uri\" = > \"/api/plugins/versioncheck\" \"status\" = > \"200\" \"size\" = > \"2\" \"agent\" = > \"Go-http-client/2.0\" \u6a21\u5f0f\u8868\u9054\u5f0f\u7684\u6355\u7372\u662f\u7531 < \u548c > \u5b57\u7b26\u5206\u9694\u7684\u5b57\u6bb5\u540d\u7a31\uff0c\u6bd4\u5982 \u5b9a\u7fa9\u4e86\u5b57\u6bb5\u540d\u7a31\u7232 example\uff0c\u672a\u547d\u540d\u7684 capture \u986f\u793a\u7232 <_> \uff0c\u672a\u547d\u540d\u7684 capture \u6703\u8df3\u904e\u5339\u914d\u7684\u5167\u5bb9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6a21\u5f0f\u8868\u9054\u5f0f\u9328\u5b9a\u5728\u65e5\u8a8c\u884c\u7684\u958b\u982d\uff0c\u53ef\u4ee5\u5728\u8868\u9054\u5f0f\u7684\u958b\u982d\u4f7f\u7528 <_> \u5c07\u8868\u9054\u5f0f\u9328\u5b9a\u5728\u958b\u982d\u3002 \u6bd4\u5982\u6211\u5011\u67e5\u770b\u4e0b\u9762\u7684\u65e5\u8a8c\u884c\u6578\u64da\uff1a log line level = debug ts = 2021 -06-10T09:24:13.472094048Z caller = logging.go:66 traceID = 0568b66ad2d9294c msg = \"POST /loki/api/v1/push (204) 16.652862ms\" \u6211\u5011\u5982\u679c\u53ea\u5e0c\u671b\u53bb\u5339\u914d msg=\" \u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4f86\u9032\u884c\u5339\u914d\uff1a <_> msg = \"<method> <path> (<status>) <latency>\" Line format expression \u00b6 \u65e5\u8a8c\u884c\u683c\u5f0f\u5316\u8868\u9054\u5f0f\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 Golang \u7684 text/template \u6a21\u677f\u683c\u5f0f\u91cd\u5beb\u65e5\u8a8c\u884c\u7684\u5167\u5bb9\uff0c\u5b83\u9700\u8981\u4e00\u500b\u5b57\u7b26\u4e32\u53c3\u6578 | line_format \"{{.label_name}}\" \u4f5c\u7232\u6a21\u677f\u683c\u5f0f\uff0c\u6240\u6709\u7684\u6a19\u7c64\u90fd\u662f\u6ce8\u5165\u6a21\u677f\u7684\u8b8a\u91cf\uff0c\u53ef\u4ee5\u7528 {{.label_name}} \u7684\u7b26\u865f\u4f86\u4f7f\u7528\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u8868\u9054\u5f0f\uff1a log ql { container = \"frontend\" } | logfmt | line_format \"{{.query}} {{.duration}}\" \u5c07\u63d0\u53d6\u4e26\u91cd\u5beb\u65e5\u8a8c\u884c\uff0c\u53ea\u5305\u542b query \u548c\u8acb\u6c42\u7684 duration\u3002\u4f60\u53ef\u4ee5\u7232\u6a21\u677f\u4f7f\u7528\u96d9\u5f15\u865f\u5b57\u7b26\u4e32\u6216\u53cd\u5f15\u865f \"{{.label_name}}\" \u4f86\u907f\u514d\u8f49\u7fa9\u7279\u6b8a\u5b57\u7b26\u3002 \u6b64\u5916 line_format \u4e5f\u652f\u6301\u6578\u5b78\u51fd\u6578\uff0c\u4f8b\u5982\uff1a \u5982\u679c\u6211\u5011\u6709\u4ee5\u4e0b\u6a19\u7c64 ip=1.1.1.1, status=200 \u548c duration=3000(ms), \u6211\u5011\u53ef\u4ee5\u7528 duration \u9664\u4ee5 1000 \u5f97\u5230\u4ee5\u79d2\u7232\u55ae\u4f4d\u7684\u503c\uff1a log ql { container = \"frontend\" } | logfmt | line_format \"{{.ip}} {{.status}} {{div .duration 1000}}\" \u4e0a\u9762\u7684\u67e5\u8a62\u5c07\u5f97\u5230\u7684\u65e5\u8a8c\u884c\u5167\u5bb9\u7232: 1 .1.1.1 200 3 \u8acb\u53c3\u95b1 \u6a21\u677f\u51fd\u6578 \u4ee5\u4e86\u89e3\u6a21\u677f\u683c\u5f0f\u4e2d\u7684\u53ef\u7528\u51fd\u6578\u3002 Labels format expression \u00b6 | label_format \u8868\u9054\u5f0f\u53ef\u4ee5\u91cd\u547d\u540d\u3001\u4fee\u6539\u6216\u6dfb\u52a0\u6a19\u7c64\uff0c\u5b83\u4ee5\u9017\u865f\u5206\u9694\u7684\u64cd\u4f5c\u5217\u8868\u4f5c\u7232\u53c3\u6578\uff0c\u53ef\u4ee5\u540c\u6642\u9032\u884c\u591a\u500b\u64cd\u4f5c\u3002 \u7576\u5169\u908a\u90fd\u662f\u6a19\u7c64\u6a19\u8b58\u7b26\u6642\uff0c\u4f8b\u5982 dst=src \uff0c\u8a72\u64cd\u4f5c\u5c07\u628a src \u6a19\u7c64\u91cd\u547d\u540d\u7232 dst \u3002 \u5de6\u908a\u4e5f\u53ef\u4ee5\u662f\u4e00\u500b\u6a21\u677f\u5b57\u7b26\u4e32\uff0c\u4f8b\u5982 dst=\"{{.status}} {{.query}}\" \uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c dst \u6a19\u7c64\u503c\u6703\u88ab Golang \u6a21\u677f\u57f7\u884c\u7d50\u679c\u6240\u53d6\u4ee3\uff0c\u9019\u8207 | line_format \u8868\u9054\u5f0f\u662f\u540c\u4e00\u500b\u6a21\u677f\u5f15\u64ce\uff0c\u9019\u610f\u5473\u7740\u6a19\u7c64\u53ef\u4ee5\u4f5c\u7232\u8b8a\u91cf\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u540c\u6a23\u7684\u51fd\u6578\u5217\u8868\u3002 \u5728\u4e0a\u9762\u5169\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u76ee\u6a19\u6a19\u7c64\u4e0d\u5b58\u5728\uff0c\u90a3\u9ebc\u5c31\u6703\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6a19\u7c64\u3002 \u91cd\u547d\u540d\u5f62\u5f0f dst=src \u6703\u5728\u5c07 src \u6a19\u7c64\u91cd\u65b0\u6620\u5c04\u5230 dst \u6a19\u7c64\u5f8c\u5c07\u5176\u522a\u9664\uff0c\u7136\u800c\uff0c\u6a21\u677f\u5f62\u5f0f\u5c07\u4fdd\u7559\u5f15\u7528\u7684\u6a19\u7c64\uff0c\u4f8b\u5982 dst=\"{{.src}}\" \u7684\u7d50\u679c\u662f dst \u548c src \u90fd\u6709\u76f8\u540c\u7684\u503c\u3002 Tip \u4e00\u500b\u6a19\u7c64\u540d\u7a31\u5728\u6bcf\u500b\u8868\u9054\u5f0f\u4e2d\u53ea\u80fd\u51fa\u73fe\u4e00\u6b21\uff0c\u9019\u610f\u5473\u7740 | label_format foo=bar,foo=\"new\" \u662f\u4e0d\u5141\u8a31\u7684\uff0c\u4f46\u4f60\u53ef\u4ee5\u4f7f\u7528\u5169\u500b\u8868\u9054\u5f0f\u4f86\u9054\u5230\u9810\u671f\u6548\u679c\uff0c\u6bd4\u5982 | label_format foo=bar | label_format foo=\"new\" \u3002 Log query \u793a\u4f8b \u00b6 Multiple filtering \u00b6 \u904e\u6ffe\u61c9\u8a72\u9996\u5148\u5728\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4f7f\u7528\u6a19\u7c64\u5339\u914d\u5668\u4f86\u9650\u7e2eloki\u8981\u67e5\u627e\u7684\u65e5\u8a8c\uff0c\u7136\u5f8c\u662f\u65e5\u8a8c\u884c\u904e\u6ffe\u5668\uff08\u5982\u679c\u53ef\u80fd\uff09\uff0c\u6700\u5f8c\u518d\u4f7f\u7528\u6a19\u7c64\u904e\u6ffe\u5668\u3002\u4ee5\u4e0b\u67e5\u8a62\u793a\u7bc4\u4e86\u9019\u4e00\u9ede\u3002 log ql { cluster = \"ops-tools1\" , namespace = \"loki-dev\" , job = \"loki-dev/query-frontend\" } | = \"metrics.go\" ! = \"out of order\" | logfmt | duration > 30s or status_code! = \"200\" \u65e5\u8a8c\u6d41\u9078\u64c7\u5668: {cluster=\"ops-tools1\", namespace=\"loki-dev\", job=\"loki-dev/query-frontend\"} \u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f: |= \"metrics.go\" !=\"out of order\" \u89e3\u6790\u5668\u8868\u9054\u5f0f: | logfmt \u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f: | duration > 30s or status_code!=\"200\" Multiple parsers \u00b6 \u63d0\u53d6\u4ee5\u4e0b logfmt \u65e5\u8a8c\u884c\u7684\u65b9\u6cd5\u548c\u8def\u5f91\uff1a log line level = debug ts = 2020 -10-02T10:10:42.092268913Z caller = logging.go:66 traceID = a9d4d8a928d8db1 msg = \"POST /api/prom/api/v1/query_range (200) 1.5s\" \u60a8\u53ef\u4ee5\u50cf\u9019\u6a23\u4f7f\u7528\u591a\u500b\u89e3\u6790\u5668\uff08logfmt \u548c regexp\uff09\u3002_ log ql { job = \"loki-ops/query-frontend\" } | logfmt | line_format \"{{.msg}}\" | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\" \u9019\u662f\u53ef\u80fd\u7684\uff0c\u56e0\u70ba | line_format \u5c07\u65e5\u8a8c\u884c\u91cd\u65b0\u683c\u5f0f\u5316\u70ba POST /api/prom/api/v1/query_range (200) 1.5s \u7136\u5f8c\u53ef\u4ee5\u4f7f\u7528 | regexp ... \u89e3\u6790\u5668\u3002 \u53e6\u5916\u4e00\u500b\u5e38\u7528\u89e3\u6790 Niginx \u65e5\u8a8c\u884c\u7684\u7bc4\u4f8b\uff1a log line 54 .203.113.59 - - [ 09 /Sep/2022:03:34:45 +0000 ] \"PUT /index.html HTTP/1.1\" 200 3622 \"-\" \"Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.101 Safari/537.36 OPR/40.0.2308.62\" \"-\" log ql { namespace = \"default\" } | json | line_format \"{{.message}}\" | pattern \"<_> - <_> <_> \\\"<method> <url> <protocol>\\\" <status> <_> <_> \\\"<_>\\\" <_>\" Formatting \u00b6 \u4ee5\u4e0b\u67e5\u8a62\u986f\u793a\u77ad\u5982\u4f55\u91cd\u65b0\u683c\u5f0f\u5316\u65e5\u8a8c\u884c\u4ee5\u4f7f\u5176\u66f4\u6613\u65bc\u5728\u5c4f\u5e55\u4e0a\u95b1\u8b80\u3002 log ql { cluster = \"ops-tools1\" , name = \"querier\" , namespace = \"loki-dev\" } | = \"metrics.go\" ! = \"loki-canary\" | logfmt | query ! = \"\" | label_format query = \"{{ Replace .query \\\"\\\\n\\\" \\\"\\\" -1 }}\" | line_format \"{{ .ts}}\\t{{.duration}}\\ttraceID = {{.traceID}}\\t{{ printf \\\"%-100.100s\\\" .query }} \" \u6a19\u7c64\u683c\u5f0f\u7528\u65bc\u6e05\u7406\u67e5\u8a62\uff0c\u800c\u884c\u683c\u5f0f\u6e1b\u5c11\u4fe1\u606f\u91cf\u4e26\u5275\u5efa\u8868\u683c\u8f38\u51fa\u3002 \u5c0d\u65bc\u9019\u4e9b\u7d66\u5b9a\u7684\u65e5\u8a8c\u884c\uff1a log line level = info ts = 2020 -10-23T20:32:18.094668233Z caller = metrics.go:81 org_id = 29 traceID = 1980d41501b57b68 latency = fast query = \"{cluster=\\\"ops-tools1\\\", job=\\\"loki-ops/query-frontend\\\"} |= \\\"query_range\\\"\" query_type = filter range_type = range length = 15m0s step = 7s duration = 650 .22401ms status = 200 throughput_mb = 1 .529717 total_bytes_mb = 0 .994659 level = info ts = 2020 -10-23T20:32:18.068866235Z caller = metrics.go:81 org_id = 29 traceID = 1980d41501b57b68 latency = fast query = \"{cluster=\\\"ops-tools1\\\", job=\\\"loki-ops/query-frontend\\\"} |= \\\"query_range\\\"\" query_type = filter range_type = range length = 15m0s step = 7s duration = 624 .008132ms status = 200 throughput_mb = 0 .693449 total_bytes_mb = 0 .432718 \u7d50\u679c\u5c07\u662f\uff1a 2020 -10-23T20:32:18.094668233Z 650 .22401ms traceID = 1980d41501b57b68 { cluster = \"ops-tools1\" , job = \"loki-ops/query-frontend\" } | = \"query_range\" 2020 -10-23T20:32:18.068866235Z 624 .008132ms traceID = 1980d41501b57b68 { cluster = \"ops-tools1\" , job = \"loki-ops/query-frontend\" } | = \"query_range\" Metric query \u00b6 \u5ea6\u91cf\u67e5\u8a62\u901a\u904e\u61c9\u7528\u51fd\u6578\u4f86\u8a18\u9304\u67e5\u8a62\u7d50\u679c\u4f86\u64f4\u5c55\u65e5\u8a8c\u67e5\u8a62\u3002\u9019\u500b\u5f37\u5927\u7684\u529f\u80fd\u5f9e\u65e5\u8a8c\u4e2d\u5275\u5efa\u6307\u6a19\u3002 \u6307\u6a19\u67e5\u8a62\u53ef\u7528\u65bc\u8a08\u7b97\u932f\u8aa4\u6d88\u606f\u7387\u6216\u6700\u8fd1 3 \u5c0f\u6642\u5167\u65e5\u8a8c\u6578\u91cf\u6700\u591a\u7684\u524d N \u200b\u200b\u500b\u65e5\u8a8c\u6e90\u3002 \u8207\u89e3\u6790\u5668\u76f8\u7d50\u5408\uff0c\u5ea6\u91cf\u67e5\u8a62\u9084\u53ef\u7528\u65bc\u5f9e\u65e5\u8a8c\u884c\u4e2d\u7684\u6a23\u672c\u503c\u8a08\u7b97\u5ea6\u91cf\uff0c\u4f8b\u5982\u5ef6\u9072\u6216\u8acb\u6c42\u5927\u5c0f\u3002\u6240\u6709\u6a19\u7c64\uff0c\u5305\u62ec\u63d0\u53d6\u7684\u6a19\u7c64\uff0c\u90fd\u53ef\u7528\u65bc\u805a\u5408\u548c\u751f\u6210\u65b0\u7cfb\u5217\u3002 Range Vector aggregation \u00b6 LogQL \u5b78\u7fd2\u4e86 Prometheus \u7684\u7bc4\u570d\u5411\u91cf\u6982\u5ff5\u3002\u5728 Grafana Loki \u4e2d\uff0c\u6240\u9078\u6a23\u672c\u7bc4\u570d\u662f\u6240\u9078\u5c0d\u6578\u6216\u6a19\u7c64\u503c\u7684\u7bc4\u570d\u3002 \u5728\u4e00\u6bb5\u6642\u9593\u5167\u61c9\u7528\u805a\u5408\u3002 Loki \u4f7f\u7528\u8207 Prometheus \u76f8\u540c\u7684\u8a9e\u6cd5\u5b9a\u7fa9 Time Duration\u3002 Loki \u652f\u6301\u5169\u7a2e\u985e\u578b\u7684\u7bc4\u570d\u5411\u91cf\u805a\u5408\uff1a\u65e5\u8a8c\u7bc4\u570d\u805a\u5408\u548c\u5c55\u958b\u7bc4\u570d\u805a\u5408\u3002 Log range aggregations \u00b6 \u65e5\u8a8c\u7bc4\u570d\u805a\u5408\u662f\u4e00\u500b\u67e5\u8a62\uff0c\u5f8c\u7db4\u5b9a\u7fa9\u4e86\u4e00\u500b\u6301\u7e8c\u6642\u9593\u3002\u61c9\u7528\u4e00\u500b\u51fd\u6578\u5728\u6301\u7e8c\u6642\u9593\u5167\u805a\u5408\u67e5\u8a62\u3002\u6301\u7e8c\u6642\u9593\u53ef\u4ee5\u653e\u5728\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e4b\u5f8c\u6216\u65e5\u8a8c\u7ba1\u9053\u7684\u672b\u5c3e\u3002 \u805a\u5408\u51fd\u6578\uff1a rate(log-range) : \u8a08\u7b97\u6bcf\u79d2\u7684\u65e5\u8a8c\u689d\u76ee count_over_time(log-range) : \u5c0d\u6307\u5b9a\u7bc4\u570d\u5167\u7684\u6bcf\u500b\u65e5\u8a8c\u6d41\u7684\u689d\u76ee\u9032\u884c\u8a08\u6578 bytes_rate(log-range) : \u8a08\u7b97\u65e5\u8a8c\u6d41\u6bcf\u79d2\u7684\u5b57\u7bc0\u6578 bytes_over_time(log-range) : \u5c0d\u6307\u5b9a\u7bc4\u570d\u5167\u7684\u6bcf\u500b\u65e5\u8a8c\u6d41\u7684\u4f7f\u7528\u7684\u5b57\u7bc0\u6578 absent_over_time(log-range) : \u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6709\u4efb\u4f55\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u7a7a\u5411\u91cf\uff1b\u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6c92\u6709\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u503c\u70ba 1 \u7684 1 \u5143\u7d20\u5411\u91cf\u3002 \uff08absent_over_time \u5c0d\u65bc\u5728\u4e00\u6bb5\u6642\u9593\u5167\u4e0d\u5b58\u5728\u6a19\u7c64\u7d44\u5408\u7684\u6642\u9593\u5e8f\u5217\u548c\u65e5\u8a8c\u6d41\u6642\u767c\u51fa\u8b66\u5831\u5f88\u6709\u7528\u3002\uff09 \u4f8b\u5b50\uff1a \u8a08\u7b97 MySQL job\u6700\u5f8c\u4e94\u5206\u9418\u5167\u7684\u6240\u6709\u65e5\u8a8c\u884c\u8a08\u6578\u3002 count_over_time ({ job = \"mysql\" }[ 5m ]) \u6b64\u805a\u5408\u5305\u62ec\u904e\u6ffe\u5668\u548c\u89e3\u6790\u5668\u3002\u5b83\u8fd4\u56de MySQL job\u5728\u6bcf\u53f0\u4e3b\u6a5f\u7684\u6700\u5f8c\u5e7e\u5206\u9418\u5167\u6240\u6709\u975e\u8d85\u6642\u932f\u8aa4\u7684\u6bcf\u79d2\u901f\u7387\uff0c\u4e26\u4e14\u50c5\u5305\u62ec\u6301\u7e8c\u6642\u9593\u8d85\u904e 10 \u79d2\u7684\u932f\u8aa4\u3002 sum by ( host ) ( rate ({ job = \"mysql\" } | = \"error\" ! = \"timeout\" | json | duration > 10s [ 1m ])) Unwrapped range aggregations \u00b6 Unwrapped\u7684\u7bc4\u570d\u4f7f\u7528\u63d0\u53d6\u7684 \u6a19\u7c64(label) \u4f86\u4f5c\u70ba\u6a23\u672c\u503c\u800c\u4e0d\u662f \u65e5\u8a8c\u884c(log line) \u3002\u4f46\u662f\uff0c\u8981\u9078\u64c7\u5728\u805a\u5408\u4e2d\u4f7f\u7528\u54ea\u500b\u6a19\u7c64\uff0c\u65e5\u8a8c\u67e5\u8a62\u5fc5\u9808\u4ee5\u5c55\u958b\u8868\u9054\u5f0f\u548c\u53ef\u9078\u7684\u6a19\u7c64\u904e\u6ffe\u5668\u8868\u9054\u5f0f\u7d50\u5c3e\u4ee5\u4e1f\u68c4\u932f\u8aa4\u3002 \u8a3b\u91cb\u89e3\u5305\u8868\u9054\u5f0f | unwrap label_identifier \u5176\u4e2d\u6a19\u7c64\u6a19\u8b58\u7b26\u662f\u7528\u65bc\u63d0\u53d6\u6a23\u672c\u503c\u7684\u6a19\u7c64\u540d\u7a31\u3002 \u7531\u65bc\u6a19\u7c64\u503c\u662f\u5b57\u7b26\u4e32\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u5c07\u5617\u8a66\u8f49\u63db\u70ba\u6d6e\u9ede\u6578\uff0864 \u4f4d\uff09\uff0c\u5982\u679c\u5931\u6557\uff0c\u5247\u5c07 error \u6a19\u7c64\u6dfb\u52a0\u5230\u6a23\u672c\u4e2d\u3002\u53ef\u9078\u5730\uff0c\u6a19\u7c64\u6a19\u8b58\u7b26\u53ef\u4ee5\u7531\u8f49\u63db\u51fd\u6578\u5305\u88f9 | unwrap <function>(label_identifier) \uff0c\u5b83\u5c07\u5617\u8a66\u5c07\u6a19\u7c64\u503c\u5f9e\u7279\u5b9a\u683c\u5f0f\u8f49\u63db\u3002 Loki \u76ee\u524d\u652f\u6301\u7684\u4e0b\u5217\u8f49\u63db\u51fd\u6578\uff1a duration_seconds(label_identifier) (\u6216\u662f duration\uff08label_identifier) ) \u5b83\u5c07\u4ee5\u79d2\u70ba\u55ae\u4f4d\u5f9e go duration \u683c\u5f0f\u8f49\u63db\u6a19\u7c64\u503c\u3002 bytes(label_identifier) \u9019\u6703\u5c07\u6a19\u7c64\u503c\u8f49\u63db\u70ba\u61c9\u7528\u5b57\u7bc0\u55ae\u4f4d\u7684\u539f\u59cb\u5b57\u7bc0\uff08\u4f8b\u5982 5 MiB\u30013k\u30011G\uff09\u3002 \u652f\u6301 Unwrapped \u7bc4\u570d\u5167\u64cd\u4f5c\u7684\u51fd\u6578\u6709\uff1a rate(unwrapped-range) : \u8a08\u7b97\u6307\u5b9a\u6642\u9593\u9593\u9694\u5167\u6240\u6709\u503c\u4e4b\u548c\u7684\u6bcf\u79d2\u901f\u7387\u3002 rate_counter(unwrapped-range) : \u8a08\u7b97\u6307\u5b9a\u9593\u9694\u5167\u7684\u503c\u7684\u6bcf\u79d2\u901f\u7387\uff0c\u4e26\u5c07\u5b83\u5011\u8996\u70ba\u201c\u8a08\u6578\u5668\u5ea6\u91cf\u201d sum_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u503c\u7684\u7e3d\u548c\u3002 avg_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u5e73\u5747\u503c\u3002 max_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u6700\u5927\u503c\u3002 min_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u6700\u5c0f\u503c first_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u7b2c\u4e00\u500b\u503c last_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u6700\u5f8c\u4e00\u500b\u503c stdvar_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u65b9\u5dee\u3002 stddev_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u5dee\u3002 quantile_over_time(scalar,unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u7684\u503c\u7684 \u03c6 \u5206\u4f4d\u6578 (0 \u2264 \u03c6 \u2264 1)\u3002 absent_over_time(unwrapped-range) : \u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6709\u4efb\u4f55\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u7a7a\u5411\u91cf\uff1b\u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6c92\u6709\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u503c\u70ba 1 \u7684 1 \u5143\u7d20\u5411\u91cf\u3002 \uff08absent_over_time \u5c0d\u65bc\u5728\u4e00\u6bb5\u6642\u9593\u5167\u4e0d\u5b58\u5728\u6a19\u7c64\u7d44\u5408\u7684\u6642\u9593\u5e8f\u5217\u548c\u65e5\u8a8c\u6d41\u6642\u767c\u51fa\u8b66\u5831\u5f88\u6709\u7528\u3002\uff09 \u9664\u4e86 sum_over_time \u3001 absent_over_time \u548c rate \uff0c\u5c55\u958b\u7684\u7bc4\u570d\u805a\u5408\u652f\u6301\u5206\u7d44\u3002 <aggr-op> ([ parameter, ] <unwrapped-range> ) [ without | by ( <label list> )] \u901a\u904e\u5305\u542b without \u6216 by \u5b50\u53e5\uff0c\u53ef\u7528\u65bc\u805a\u5408\u4e0d\u540c\u7684\u6a19\u7c64\u7dad\u5ea6\u3002 without \u5f9e\u7d50\u679c\u5411\u91cf\u4e2d\u522a\u9664\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u800c\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u90fd\u4fdd\u7559\u8f38\u51fa\u3002 by \u57f7\u884c\u76f8\u53cd\u7684\u64cd\u4f5c\u4e26\u522a\u9664\u672a\u5728 by \u5b50\u53e5\u4e2d\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u5373\u4f7f\u5b83\u5011\u7684\u6a19\u7c64\u503c\u5728\u5411\u91cf\u7684\u6240\u6709\u5143\u7d20\u4e4b\u9593\u662f\u76f8\u540c\u7684\u3002 Unwrapped \u7bc4\u4f8b : quantile_over_time ( 0 .99, # \u5b9a\u7fa9\u8981\u8a08\u7b97\u7684\u5206\u4f4d\u6578 { cluster = \"ops-tools1\" ,container = \"ingress-nginx\" } \u3000 # \u9078\u64c7\u7279\u5b9a\u7684 lost stream | json # \u4f7f\u7528 JSON \u4f86\u89e3\u6790\u4e26\u64f7\u53d6 label | __error__ = \"\" # \u53bb\u9664\u89e3\u6790\u6709\u554f\u984c\u7684\u65e5\u8a8c\u884c | unwrap request_time [ 1m ]) by ( path ) \u3000 # \u4f7f\u7528 \"requet_time\" \u7684\u6a19\u7c64\u503c\u4f86\u8a08\u7b97\u4e26\u4e14\u4f7f\u7528 path \u6a19\u7c64\u503c\u4f86\u5206\u7d44 \u6b64\u793a\u4f8b\u6309\u8def\u5f91\u8a08\u7b97 nginx-ingress \u5ef6\u9072\u7684 p99 \u56de\u61c9\u6642\u9593\u3002 sum by ( org_id ) ( sum_over_time ( { cluster = \"ops-tools1\" ,container = \"loki-dev\" } | = \"metrics.go\" | logfmt | unwrap bytes_processed [ 1m ]) ) \u9019\u5c07\u8a08\u7b97\u6bcf\u500b\u7d44\u7e54 ID \u8655\u7406\u7684\u5b57\u7bc0\u6578\u3002 Built-in aggregation operators \u00b6 \u8207 PromQL \u4e00\u6a23\uff0cLogQL \u652f\u6301\u5167\u7f6e\u805a\u5408\u904b\u7b97\u7b26\u7684\u5b50\u96c6\uff0c\u53ef\u7528\u65bc\u805a\u5408\u55ae\u500b\u5411\u91cf\u7684\u5143\u7d20\uff0c\u5f9e\u800c\u751f\u6210\u5305\u542b\u66f4\u5c11\u5143\u7d20\u4f46\u5177\u6709\u805a\u5408\u503c\u7684\u65b0\u5411\u91cf\uff1a sum : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u7e3d\u548c avg : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u5e73\u5747\u503c min : \u9078\u64c7\u6a19\u7c64\u503c\u7684\u6700\u5c0f\u503c max : \u9078\u64c7\u6a19\u7c64\u503c\u7684\u6700\u5927\u503c stddev : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u5dee stdvar : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u65b9\u5dee count : \u8a08\u7b97\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u500b\u6578 topk : \u6309\u6a23\u672c\u6a19\u7c64\u503c\u9078\u64c7\u6700\u5927\u7684 k \u500b\u5143\u7d20 bottomk : \u6309\u6a23\u672c\u6a19\u7c64\u503c\u9078\u64c7\u6700\u5c0f\u7684 k \u500b\u5143\u7d20 \u805a\u5408\u904b\u7b97\u7b26\u53ef\u7528\u65bc\u805a\u5408\u6240\u6709\u6a19\u7c64\u503c\u6216\u4e00\u7d44\u4e0d\u540c\u7684\u6a19\u7c64\u503c\uff0c\u65b9\u6cd5\u662f\u5305\u542b without \u6216 by \u5b50\u53e5\uff1a <aggr-op> ([ parameter, ] <vector expression> ) [ without | by ( <label list> )] \u4f7f\u7528 topk \u548c bottomk \u6642\u9700\u8981\u5b9a\u7fa9\u53c3\u6578(parameter)\u3002 topk \u548c bottomk \u8207\u5176\u4ed6\u805a\u5408\u5668\u7684\u4e0d\u540c\u4e4b\u8655\u5728\u65bc\uff0c\u8f38\u5165\u6a23\u672c\u7684\u5b50\u96c6\uff08\u5305\u62ec\u539f\u59cb\u6a19\u7c64\uff09\u5728\u7d50\u679c\u5411\u91cf\u4e2d\u8fd4\u56de\u3002 by \u548c without \u50c5\u7528\u65bc\u5c0d\u8f38\u5165\u5411\u91cf\u9032\u884c\u5206\u7d44\u3002 without \u5b50\u53e5\u5f9e\u7d50\u679c\u5411\u91cf\u4e2d\u522a\u9664\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u4fdd\u7559\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002 by \u5b50\u53e5\u76f8\u53cd\uff0c\u522a\u9664\u5b50\u53e5\u4e2d\u672a\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u5373\u4f7f\u5b83\u5011\u7684\u6a19\u7c64\u503c\u5728\u5411\u91cf\u7684\u6240\u6709\u5143\u7d20\u4e4b\u9593\u662f\u76f8\u540c\u7684\u3002 Vector aggregation \u7bc4\u4f8b : \u7372\u53d6\u65e5\u8a8c\u541e\u5410\u91cf\u6700\u9ad8\u7684\u524d 10 \u500b\u61c9\u7528\u7a0b\u5e8f\uff1a topk ( 10 ,sum ( rate ({ region = \"us-east1\" }[ 5m ])) by ( name )) \u7372\u53d6\u6307\u5b9a\u4f5c\u696d\u7684\u6700\u5f8c\u4e94\u5206\u9418\u7684\u65e5\u8a8c\u884c\u6578\uff0c\u6309\u7d1a\u5225\u5206\u7d44\uff1a sum ( count_over_time ({ job = \"mysql\" }[ 5m ])) by ( level ) \u6309\u5340\u57df\u7372\u53d6 NGINX \u65e5\u8a8c\u7684 /home \u7aef\u9ede\u7684 HTTP GET \u8acb\u6c42\u901f\u7387\uff1a avg ( rate (({ job = \"nginx\" } | = \"GET\" | json | path = \"/home\" )[ 10s ])) by ( region ) Binary operators \u00b6 Arithmetic operators \u00b6 Loki \u4e2d\u5b58\u5728\u4ee5\u4e0b\u4e8c\u5143\u7b97\u8853\u904b\u7b97\u7b26\uff1a + \u52a0\u6cd5 - \u6e1b\u6cd5 * \u4e58\u6cd5 / \u9664\u6cd5 % \u6c42\u6a21 ^ \u6c42\u51aa \u4e8c\u9032\u5236\u7b97\u8853\u904b\u7b97\u7b26\u5b9a\u7fa9\u5728\u5169\u500b\u6587\u5b57\uff08\u6a19\u91cf\uff09\u3001\u4e00\u500b\u6587\u5b57\u548c\u4e00\u500b\u5411\u91cf\u4ee5\u53ca\u5169\u500b\u5411\u91cf\u4e4b\u9593\u3002 \u5728\u5169\u500b\u6587\u5b57\u4e4b\u9593\uff0c\u884c\u70ba\u662f\u986f\u800c\u6613\u898b\u7684\uff1a\u5b83\u5011\u8a55\u4f30\u53e6\u4e00\u500b\u6587\u5b57\uff0c\u9019\u662f\u61c9\u7528\u65bc\u5169\u500b\u6a19\u91cf\u64cd\u4f5c\u6578 (1 + 1 = 2) \u7684\u904b\u7b97\u7b26\u7684\u7d50\u679c\u3002 \u5728\u5411\u91cf\u548c\u6587\u5b57\u4e4b\u9593\uff0c\u904b\u7b97\u7b26\u61c9\u7528\u65bc\u5411\u91cf\u4e2d\u6bcf\u500b\u6578\u64da\u6a23\u672c\u7684\u503c\uff0c\u4f8b\u5982\u5982\u679c\u6642\u9593\u5e8f\u5217\u5411\u91cf\u4e58\u4ee5 2\uff0c\u5247\u7d50\u679c\u662f\u53e6\u4e00\u500b\u5411\u91cf\uff0c\u5176\u4e2d\u539f\u59cb\u5411\u91cf\u7684\u6bcf\u500b\u6a23\u672c\u503c\u90fd\u4e58\u4ee5 2\u3002 \u5728\u5169\u500b\u5411\u91cf\u4e4b\u9593\uff0c\u4e8c\u9032\u5236\u7b97\u8853\u904b\u7b97\u7b26\u61c9\u7528\u65bc\u5de6\u5074\u5411\u91cf\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u53ca\u5176\u53f3\u5074\u5411\u91cf\u4e2d\u7684\u5339\u914d\u5143\u7d20\u3002\u7d50\u679c\u50b3\u64ad\u5230\u7d50\u679c\u5411\u91cf\u4e2d\uff0c\u5206\u7d44\u6a19\u7c64\u6210\u70ba\u8f38\u51fa\u6a19\u7c64\u96c6\u3002\u5728\u53f3\u5074\u5411\u91cf\u4e2d\u627e\u4e0d\u5230\u5339\u914d\u689d\u76ee\u7684\u689d\u76ee\u4e0d\u5c6c\u65bc\u7d50\u679c\u3002 \u93c8\u63a5\u7b97\u8853\u904b\u7b97\u7b26\u6642\u8981\u7279\u5225\u6ce8\u610f \u904b\u7b97\u7b26\u9806\u5e8f \u3002 Arithmetic \u7bc4\u4f8b \u00b6 \u5c07\u65e5\u8a8c\u6d41\u689d\u76ee\u7684\u901f\u7387\u52a0\u500d\uff1a sum ( rate ({ app = \"foo\" }[ 1m ])) * 2 \u7372\u53d6 foo \u61c9\u7528\u7a0b\u5e8f\u7684\u8b66\u544a\u65e5\u8a8c\u8207\u932f\u8aa4\u65e5\u8a8c\u7684\u6bd4\u4f8b sum ( rate ({ app = \"foo\" , level = \"warn\" }[ 1m ])) / sum ( rate ({ app = \"foo\" , level = \"error\" }[ 1m ])) Logical and set operators \u00b6 \u96c6\u5408\u904b\u7b97\u50c5\u5728\u5340\u9593\u5411\u91cf\u7bc4\u570d\u5167\u6709\u6548\uff0c\u7576\u524d\u652f\u6301\uff1a and \u4ea4\u96c6 - vector1 \u548c vector2 \u7522\u751f\u4e00\u500b\u7531 vector1 \u7684\u5143\u7d20\u7d44\u6210\u7684\u5411\u91cf\uff0c\u5176\u4e2d vector2 \u4e2d\u7684\u5143\u7d20\u5177\u6709\u5b8c\u5168\u5339\u914d\u7684\u6a19\u7c64\u96c6\u3002\u5176\u4ed6\u5143\u7d20\u88ab\u4e1f\u68c4\u3002 or \u806f\u96c6 - vector1 \u6216 vector2 \u751f\u6210\u4e00\u500b\u5411\u91cf\uff0c\u8a72\u5411\u91cf\u5305\u542b vector1 \u7684\u6240\u6709\u539f\u59cb\u5143\u7d20\uff08\u6a19\u7c64\u96c6 + \u503c\uff09\uff0c\u4ee5\u53ca vector2 \u4e2d\u5728 vector1 \u4e2d\u6c92\u6709\u5339\u914d\u6a19\u7c64\u96c6\u7684\u6240\u6709\u5143\u7d20\u3002 unless \u88dc\u5145 - vector1 \u9664\u975e vector2 \u7522\u751f\u4e00\u500b\u7531 vector1 \u7684\u5143\u7d20\u7d44\u6210\u7684\u5411\u91cf\uff0c\u5c0d\u65bc\u9019\u4e9b\u5143\u7d20\uff0cvector2 \u4e2d\u6c92\u6709\u8207\u6a19\u7c64\u96c6\u5b8c\u5168\u5339\u914d\u7684\u5143\u7d20\u3002\u5169\u500b\u5411\u91cf\u4e2d\u7684\u6240\u6709\u5339\u914d\u5143\u7d20\u90fd\u88ab\u522a\u9664\u3002 Binary operators \u7bc4\u4f8b \u00b6 \u4e0b\u5217\u7684\u67e5\u8a62\u5c07\u8fd4\u56de\u9019\u4e9b\u67e5\u8a62\u7684\u4ea4\u96c6, \u7b49\u540c\u3000 rate({app=\"bar\"}) \uff1a rate ({ app = ~ \"foo|bar\" }[ 1m ]) and rate ({ app = \"bar\" }[ 1m ]) Comparison operators \u00b6 == \u7b49\u65bc != \u4e0d\u7b49\u65bc > \u5927\u65bc >= \u5927\u65bc\u6216\u7b49\u65bc < \u5c0f\u65bc <= \u5c0f\u65bc\u6216\u7b49\u65bc \u6bd4\u8f03\u904b\u7b97\u7b26\u5728\u6a19\u91cf/\u6a19\u91cf\u3001\u5411\u91cf/\u6a19\u91cf\u548c\u5411\u91cf/\u5411\u91cf\u503c\u5c0d\u4e4b\u9593\u5b9a\u7fa9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5011\u6703\u904e\u6ffe\u3002\u5b83\u5011\u7684\u884c\u70ba\u53ef\u4ee5\u901a\u904e\u5728\u904b\u7b97\u7b26\u5f8c\u63d0\u4f9b bool \u4f86\u4fee\u6539\uff0c\u5b83\u5c07\u8fd4\u56de 0 \u6216 1 \u4f5c\u70ba\u503c\u800c\u4e0d\u662f\u904e\u6ffe\u3002 \u5728\u5169\u500b\u6a19\u91cf\u4e4b\u9593\uff0c\u9019\u4e9b\u904b\u7b97\u7b26\u6703\u7522\u751f\u53e6\u4e00\u500b\u6a19\u91cf\uff0c\u5373 0\uff08\u5047\uff09\u6216 1\uff08\u771f\uff09\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u6bd4\u8f03\u7d50\u679c\u3002\u4e0d\u5f97\u63d0\u4f9b bool \u4fee\u98fe\u7b26\u3002 \u5728\u5411\u91cf\u548c\u6a19\u91cf\u4e4b\u9593\uff0c\u9019\u4e9b\u904b\u7b97\u7b26\u61c9\u7528\u65bc\u5411\u91cf\u4e2d\u6bcf\u500b\u6578\u64da\u6a23\u672c\u7684\u503c\uff0c\u4e26\u4e14\u6bd4\u8f03\u7d50\u679c\u70ba\u5047\u7684\u5411\u91cf\u5143\u7d20\u5f9e\u7d50\u679c\u5411\u91cf\u4e2d\u522a\u9664\u3002\u5982\u679c\u63d0\u4f9b\u4e86 bool \u4fee\u98fe\u7b26\uff0c\u5247\u5c07\u88ab\u522a\u9664\u7684\u5411\u91cf\u5143\u7d20\u7684\u503c\u70ba 0\uff0c\u800c\u5c07\u4fdd\u7559\u7684\u5411\u91cf\u5143\u7d20\u7684\u503c\u70ba 1\u3002 \u8a3b\u91cb \u00b6 LogQL \u67e5\u8a62\u53ef\u4ee5\u4f7f\u7528 # \u5b57\u7b26\u9032\u884c\u8a3b\u91cb\uff1a { app = \"foo\" } # anything that comes after will not be interpreted in your query \u4f7f\u7528\u591a\u884c LogQL \u67e5\u8a62\uff0c\u67e5\u8a62\u89e3\u6790\u5668\u53ef\u4ee5\u4f7f\u7528 # \u6392\u9664\u6574\u884c\u6216\u90e8\u4efd\u884c\uff1a { app = \"foo\" } | json # this line will be ignored | bar = \"baz\" # this checks if bar = \"baz\" Pipeline \u932f\u8aa4 \u00b6 \u5c0e\u81f4\u7ba1\u9053\u8655\u7406\u932f\u8aa4\u7684\u539f\u56e0\u6709\u591a\u7a2e\uff0c\u4f8b\u5982\uff1a \u6578\u5b57\u6a19\u7c64\u904e\u6ffe\u5668\u53ef\u80fd\u7121\u6cd5\u5c07\u6a19\u7c64\u503c\u8f49\u63db\u70ba\u6578\u5b57 \u6a19\u7c64\u7684\u5ea6\u91cf\u8f49\u63db\u53ef\u80fd\u6703\u5931\u6557\u3002 \u65e5\u8a8c\u884c\u4e0d\u662f\u6709\u6548\u7684 json \u6587\u6a94\u3002 ETC\u2026 \u7576\u9019\u4e9b\u6545\u969c\u767c\u751f\u6642\uff0cLoki \u4e0d\u6703\u904e\u6ffe\u6389\u90a3\u4e9b\u65e5\u8a8c\u884c\u3002\u76f8\u53cd\uff0c\u5b83\u5011\u88ab\u50b3\u905e\u5230\u7ba1\u9053\u7684\u4e0b\u4e00\u500b\u968e\u6bb5\uff0c\u4e26\u5e36\u6709\u4e00\u500b\u540d\u70ba __error__ \u7684\u65b0\u7cfb\u7d71\u6a19\u7c64\u3002\u904e\u6ffe\u932f\u8aa4\u7684\u552f\u4e00\u65b9\u6cd5\u662f\u4f7f\u7528\u6a19\u7c64\u904e\u6ffe\u5668\u8868\u9054\u5f0f\u3002 __error__ \u6a19\u7c64\u4e0d\u80fd\u901a\u904e\u8a9e\u8a00\u91cd\u547d\u540d\u3002 \u4f8b\u5982\u8981\u522a\u9664 json \u932f\u8aa4\uff1a log ql { cluster = \"ops-tools1\" ,container = \"ingress-nginx\" } | json | __error__ ! = \"JSONParserErr\" \u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6355\u7372\u6240\u6709\u5339\u914d\u5668\uff08\u4f8b\u5982 __error__ = \"\" \uff09\u522a\u9664\u6240\u6709\u932f\u8aa4\uff0c\u751a\u81f3\u4f7f\u7528 __error__ != \"\" \u50c5\u986f\u793a\u932f\u8aa4\u3002 \u904e\u6ffe\u5668\u61c9\u653e\u7f6e\u5728\u7522\u751f\u6b64\u932f\u8aa4\u7684\u968e\u6bb5\u4e4b\u5f8c\u3002\u9019\u610f\u5473\u8457\u5982\u679c\u60a8\u9700\u8981\u5f9e\u5c55\u958b\u8868\u9054\u5f0f\u4e2d\u522a\u9664\u932f\u8aa4\uff0c\u5247\u9700\u8981\u5c07\u5176\u653e\u5728\u5c55\u958b\u4e4b\u5f8c\u3002 log ql quantile_over_time ( 0 .99, { container = \"ingress-nginx\" ,service = \"hosted-grafana\" } | json | unwrap response_latency_seconds | __error__ = \"\" [ 1m ] ) by ( cluster ) Info \u6307\u6a19\u67e5\u8a62\u4e0d\u80fd\u5305\u542b\u932f\u8aa4\uff0c\u5982\u679c\u5728\u57f7\u884c\u904e\u7a0b\u4e2d\u767c\u73fe\u932f\u8aa4\uff0cLoki \u5c07\u8fd4\u56de\u932f\u8aa4\u548c\u76f8\u61c9\u7684\u72c0\u614b\u78bc\u3002 \u67e5\u8a62\u793a\u4f8b \u00b6 \u9019\u88e1\u90e8\u7f72\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u6d88\u606f\u61c9\u7528\u7684\u793a\u4f8b\uff0c\u8a72\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u6d88\u606f\uff0c\u5b83\u7684\u65e5\u8a8c\u5305\u542b\u8abf\u8a66\u3001\u4fe1\u606f\u548c\u8b66\u544a\u8f38\u51fa\u5230\u6a19\u6e96\u8f38\u51fa\u3002\u932f\u8aa4\u7b49\u7d1a\u7684\u5c07\u88ab\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\uff0c\u5be6\u969b\u7684\u65e5\u8a8c\u4ee5 JSON \u683c\u5f0f\u751f\u6210\uff0c\u6bcf\u500b500 \u689d\u65e5\u8a8c\u5c07\u5275\u5efa\u4e00\u689d\u65b0\u6d88\u606f\u7684\u6d88\u606f\u3002 \u65e5\u8a8c\u683c\u5f0f\u5982\u4e0b\uff1a { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-04-04T13:41:50+02:00\" , \"version\" : \"1.0.0\" } \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4f86\u5275\u5efa\u793a\u4f8b\u61c9\u7528\uff1a cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: labels: app: fake-logger environment: development name: fake-logger spec: selector: matchLabels: app: fake-logger environment: development template: metadata: labels: app: fake-logger environment: development spec: containers: - image: thorstenhans/fake-logger:0.0.2 name: fake-logger resources: requests: cpu: 10m memory: 32Mi limits: cpu: 10m memory: 32Mi EOF \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 {app=\"fake-logger\"} \u5728 Grafana \u4e2d\u67e5\u8a62\u5230\u8a72\u61c9\u7528\u7684\u65e5\u8a8c\u6d41\u6578\u64da\u3002 \u7531\u65bc\u6211\u5011\u8a72\u793a\u4f8b\u61c9\u7528\u7684\u65e5\u8a8c\u662f JSON \u5f62\u5f0f\u7684\uff0c\u6211\u5011\u53ef\u4ee5\u63a1\u7528 JSON \u89e3\u6790\u5668\u4f86\u89e3\u6790\u65e5\u8a8c\uff0c\u8868\u9054\u5f0f\u7232 {app=\"fake-logger\"} | json \uff0c\u5982\u4e0b\u6240\u793a\u3002 \u4f7f\u7528 JSON \u89e3\u6790\u5668\u89e3\u6790\u65e5\u8a8c\u5f8c\u53ef\u4ee5\u770b\u5230 Grafana \u63d0\u4f9b\u7684\u9762\u677f\u6703\u6839\u64da level \u7684\u503c\u4f7f\u7528\u4e0d\u540c\u7684\u984f\u8272\u9032\u884c\u5340\u5206\uff0c\u800c\u4e14\u73fe\u5728\u6211\u5011\u65e5\u8a8c\u7684\u5c6c\u6027\u4e5f\u88ab\u6dfb\u52a0\u5230\u4e86 Log \u7684\u6a19\u7c64\u4e2d\u53bb\u4e86\u3002 \u73fe\u5728 JSON \u4e2d\u7684\u6578\u64da\u8b8a\u6210\u4e86\u65e5\u8a8c\u6a19\u7c64\u6211\u5011\u81ea\u7136\u5c31\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u6a19\u7c64\u4f86\u904e\u6ffe\u65e5\u8a8c\u6578\u64da\u4e86\uff0c\u6bd4\u5982\u6211\u5011\u8981\u904e\u6ffe level=error \u7684\u65e5\u8a8c\uff0c\u53ea\u4f7f\u7528\u8868\u9054\u5f0f {app=\"fake-logger\"} | json | level=\"error\" \u5373\u53ef\u5be6\u73fe\u3002 \u6b64\u5916\u6211\u5011\u9084\u53ef\u4ee5\u6839\u64da\u6211\u5011\u7684\u9700\u6c42\u53bb\u683c\u5f0f\u5316\u8f38\u51fa\u65e5\u8a8c\uff0c\u4f7f\u7528 line_format \u5373\u53ef\u5be6\u73fe\uff0c\u6bd4\u5982\u6211\u5011\u9019\u88cf\u4f7f\u7528\u67e5\u8a62\u8a9e\u53e5 `{app=\"fake-logger\"} | json |is_even=\"true\" | line_format \"\u5728 {{.time}} \u65bc {{.level}}@{{.pod}} Pod\u4e2d\u7522\u751f\u4e86\u65e5\u8a8c {{.msg}}\" \u4f86\u683c\u5f0f\u5316\u65e5\u8a8c\u8f38\u51fa\u3002","title":"Loki \u67e5\u8a62\u8a9e\u8a00 LogQL"},{"location":"kubernetes/observability/logging/loki/loki-ql/#grafana-loki-logql","text":"\u539f\u6587: https://grafana.com/docs/loki/latest/logql/log_queries/ \u53d7 PromQL \u7684\u5553\u767c\uff0cLoki \u4e5f\u6709\u81ea\u5df1\u7684\u67e5\u8a62\u8a9e\u8a00\uff0c\u7a31\u7232 LogQL\uff0c\u5b83\u5c31\u50cf\u4e00\u500b\u5206\u4f48\u5f0f\u7684 grep\uff0c\u53ef\u4ee5\u805a\u5408\u67e5\u770b\u65e5\u8a8c\u3002\u548c PromQL \u4e00\u6a23\uff0cLogQL \u4e5f\u662f\u4f7f\u7528\u6a19\u7c64\u548c\u904b\u7b97\u7b26\u9032\u884c\u904e\u6ffe\u7684\uff0c\u4e3b\u8981\u6709\u5169\u7a2e\u985e\u578b\u7684\u67e5\u8a62\u529f\u80fd\uff1a Log query \u67e5\u8a62\u8fd4\u56de\u65e5\u8a8c\u884c\u5167\u5bb9 Metrics query \u901a\u904e\u904e\u6ffe\u898f\u5247\u5728\u65e5\u8a8c\u6d41\u4e2d\u8a08\u7b97\u76f8\u95dc\u7684\u5ea6\u91cf\u6307\u6a19","title":"Grafana Loki \u67e5\u8a62\u8a9e\u8a00 LogQL \u4f7f\u7528"},{"location":"kubernetes/observability/logging/loki/loki-ql/#log-query","text":"\u4e00\u500b\u57fa\u672c\u7684\u65e5\u8a8c\u67e5\u8a62\u7531\u5169\u90e8\u5206\u7d44\u6210\u3002 log stream selector\uff08\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\uff09 log pipeline\uff08\u65e5\u8a8c\u7ba1\u9053\uff09 \u7531\u65bc Loki \u7684\u8a2d\u8a08\uff0c\u6240\u6709 LogQL \u67e5\u8a62\u5fc5\u9808\u5305\u542b\u4e00\u500b\u65e5\u8a8c\u6d41\u9078\u64c7\u5668 (log stream selector)\u3002\u4e00\u500b Log Stream \u4ee3\u8868\u4e86\u5177\u6709\u76f8\u540c\u5143\u6578\u64da (Label \u96c6) \u7684\u65e5\u8a8c\u689d\u76ee\u3002 \u65e5\u8a8c\u6d41\u9078\u64c7\u5668 (log stream selector) \u6c7a\u5b9a\u4e86\u6709\u591a\u5c11\u65e5\u8a8c\u5c07\u88ab\u641c\u7d22\u5230\uff0c\u4e00\u500b\u66f4\u7d30\u7c92\u5ea6\u7684\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u5c07\u641c\u7d22\u5230\u6d41\u7684\u6578\u91cf\u6e1b\u5c11\u5230\u4e00\u500b\u53ef\u7ba1\u7406\u7684\u6578\u91cf\uff0c\u901a\u904e\u7cbe\u7d30\u7684\u5339\u914d\u65e5\u8a8c\u6d41\uff0c\u53ef\u4ee5\u5927\u5e45\u6e1b\u5c11\u67e5\u8a62\u671f\u9593\u5e36\u4f86\u8cc7\u6e90\u6d88\u8017\u3002 \u800c\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u5f8c\u9762\u7684 \u65e5\u8a8c\u7ba1\u9053 (log pipeline) \u662f\u53ef\u9078\u7684\uff0c\u7528\u65bc\u9032\u4e00\u6b65\u8655\u7406\u548c\u904e\u6ffe\u65e5\u8a8c\u6d41\u4fe1\u606f\uff0c\u5b83\u7531\u4e00\u7d44\u8868\u9054\u5f0f\u7d44\u6210\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u90fd\u4ee5\u5f9e\u5de6\u5230\u53f3\u7684\u9806\u5e8f\u7232\u6bcf\u500b\u65e5\u8a8c\u884c\u57f7\u884c\u76f8\u95dc\u904e\u6ffe\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u90fd\u53ef\u4ee5\u904e\u6ffe\u3001\u89e3\u6790\u548c\u6539\u8b8a\u65e5\u8a8c\u884c\u5167\u5bb9\u4ee5\u53ca\u5404\u81ea\u7684\u6a19\u7c64\u3002 \u4e0b\u9762\u7684\u4f8b\u5b50\u986f\u793a\u4e86\u4e00\u500b\u5b8c\u6574\u7684\u65e5\u8a8c\u67e5\u8a62\u7684\u64cd\u4f5c\uff1a log ql { container = \"query-frontend\" ,namespace = \"loki-dev\" } | = \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \u8a72\u67e5\u8a62\u8a9e\u53e5\u7531\u4ee5\u4e0b\u5e7e\u500b\u90e8\u5206\u7d44\u6210\uff1a \u4e00\u500b\u65e5\u8a8c\u6d41\u9078\u64c7\u5668 {container=\"query-frontend\",namespace=\"loki-dev\"} \uff0c\u7528\u65bc\u904e\u6ffe loki-dev \u547d\u540d\u7a7a\u9593\u4e0b\u9762\u7684 query-frontend \u5bb9\u5668\u7684\u65e5\u8a8c \u7136\u5f8c\u5f8c\u9762\u8ddf\u7740\u4e00\u500b\u65e5\u8a8c\u7ba1\u9053 |= \"metrics.go\" | logfmt | duration > 10s and throughput_mb < 500 \uff0c\u8a72\u7ba1\u9053\u8868\u793a\u5c07\u7be9\u9078\u51fa\u5305\u542b metrics.go \u9019\u500b\u8a5e\u7684\u65e5\u8a8c\uff0c\u7136\u5f8c\u89e3\u6790\u6bcf\u4e00\u884c\u65e5\u8a8c\u63d0\u53d6\u66f4\u591a\u7684\u8868\u9054\u5f0f\u4e26\u9032\u884c\u904e\u6ffe Tip \u70ba\u907f\u514d escape \u7279\u6b8a\u5b57\u7b26\uff0c\u60a8\u53ef\u4ee5\u5728\u5f15\u7528\u5b57\u7b26\u4e32\u6642\u4f7f\u7528 \\' (backtick) \u800c\u4e0d\u662f \"\u3002\u4f8b\u5982\uff0c`\\w+` \u8207 \"\\w+\" \u76f8\u540c\u3002\u9019\u5728\u7de8\u5beb\u5305\u542b\u591a\u500b\u53cd\u659c\u6760\u7684\u6b63\u5247\u8868\u9054\u5f0f\u6642\u7279\u5225\u6709\u7528\u9700\u8981 escape\u3002","title":"Log query"},{"location":"kubernetes/observability/logging/loki/loki-ql/#log-stream-selector","text":"\u65e5\u8a8c\u6d41\u9078\u64c7\u5668 (Log Stream Selector) \u6c7a\u5b9a\u4e86\u54ea\u4e9b\u65e5\u8a8c\u6d41\u61c9\u8a72\u88ab\u5305\u542b\u5728\u4f60\u7684\u67e5\u8a62\u7d50\u679c\u4e2d\uff0c\u9078\u64c7\u5668\u7531\u4e00\u500b\u6216\u591a\u500b\u9375\u503c\u5c0d\u7d44\u6210\uff0c\u5176\u4e2d\u6bcf\u500b\u9375\u662f\u4e00\u500b\u65e5\u8a8c\u6a19\u7c64\uff0c\u6bcf\u500b\u503c\u662f\u8a72\u6a19\u7c64\u7684\u503c\u3002 \u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u662f\u901a\u904e\u5c07\u9375\u503c\u5c0d\u5305\u88f9\u5728\u4e00\u5c0d \u5927\u62ec\u865f \u4e2d\u7de8\u5beb\u7684\uff0c\u6bd4\u5982\uff1a { app = \"mysql\" , } \u4e0a\u9762\u9019\u500b\u793a\u4f8b\u8868\u793a\uff0c\u6240\u6709\u6a19\u7c64\u7232 app \u4e14\u5176\u503c\u7232 mysql \u548c\u6a19\u7c64\u7232 name \u4e14\u5176\u503c\u7232 mysql-backup \u7684\u65e5\u8a8c\u6d41\u5c07\u88ab\u5305\u62ec\u5728\u67e5\u8a62\u7d50\u679c\u4e2d\u3002 \u5176\u4e2d\u6a19\u7c64\u540d\u5f8c\u9762\u7684 = \u904b\u7b97\u7b26\u662f\u4e00\u500b\u6a19\u7c64\u5339\u914d\u904b\u7b97\u7b26\uff0cLogQL \u4e2d\u4e00\u5171\u652f\u6301\u4ee5\u4e0b\u5e7e\u7a2e\u6a19\u7c64\u5339\u914d\u904b\u7b97\u7b26\uff1a = \u5b8c\u5168\u5339\u914d != \u4e0d\u76f8\u7b49 =~ \u6b63\u5247\u8868\u9054\u5f0f\u5339\u914d !~ \u6b63\u5247\u8868\u9054\u5f0f\u4e0d\u5339\u914d \u4f8b\u5982\uff1a { name = ~ \"mysql.+\" } { name!~ \"mysql.+\" } { name!~ \"mysql-\\\\d+\" } \u9069\u7528\u65bc Prometheus \u6a19\u7c64\u9078\u64c7\u5668\u7684\u898f\u5247\u540c\u6a23\u9069\u7528\u65bc Loki \u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u3002","title":"Log Stream Selector"},{"location":"kubernetes/observability/logging/loki/loki-ql/#log-pipeline","text":"\u65e5\u8a8c\u7ba1\u9053\u53ef\u4ee5\u9644\u52a0\u5230\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e0a\uff0c\u4ee5\u9032\u4e00\u6b65\u8655\u7406\u548c\u904e\u6ffe\u65e5\u8a8c\u6d41\u3002\u5b83\u901a\u5e38\u7531\u4e00\u500b\u6216\u591a\u500b \u8868\u9054\u5f0f \u7d44\u6210\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u91dd\u5c0d\u6bcf\u500b\u65e5\u8a8c\u884c\u4f9d\u6b21\u57f7\u884c\u3002\u5982\u679c\u4e00\u500b\u8868\u9054\u5f0f\u904e\u6ffe\u6389\u4e86\u65e5\u8a8c\u884c\uff0c\u5247\u7ba1\u9053\u5c07\u5728\u6b64\u8655\u505c\u6b62\u4e26\u958b\u59cb\u8655\u7406\u4e0b\u4e00\u884c\u3002\u4e00\u4e9b\u8868\u9054\u5f0f\u53ef\u4ee5\u6539\u8b8a\u65e5\u8a8c\u5167\u5bb9\u548c\u5404\u81ea\u7684\u6a19\u7c64\uff0c\u7136\u5f8c\u53ef\u7528\u65bc\u9032\u4e00\u6b65\u904e\u6ffe\u548c\u8655\u7406\u5f8c\u7e8c\u8868\u9054\u5f0f\u6216\u6307\u6a19\u67e5\u8a62\u3002 \u4e00\u500b\u65e5\u8a8c\u7ba1\u9053\u53ef\u4ee5\u7531\u4ee5\u4e0b\u90e8\u5206\u7d44\u6210\u3002 \u904e\u6ffe\u8868\u9054\u5f0f (Filtering expressions) \u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f (Line filter expressions) \u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f (Label filter expressions) \u89e3\u6790\u5668\u8868\u9054\u5f0f (Parsing expressions) \u683c\u5f0f\u5316\u8868\u9054\u5f0f (Formatting expressions) \u65e5\u8a8c\u884c\u683c\u5f0f\u5316\u8868\u9054\u5f0f (Line format expression) \u6a19\u7c64\u683c\u5f0f\u5316\u8868\u9054\u5f0f (Labels format expression)","title":"Log Pipeline"},{"location":"kubernetes/observability/logging/loki/loki-ql/#line-filter-expressions","text":"\u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f\u7528\u65bc\u5c0d\u5339\u914d\u65e5\u8a8c\u6d41\u4e2d\u7684\u805a\u5408\u65e5\u8a8c\u9032\u884c\u5206\u4f48\u5f0f grep\u3002 \u7de8\u5beb\u5165\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u5f8c\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b \u641c\u7d22\u8868\u9054\u5f0f \u9032\u4e00\u6b65\u904e\u6ffe\u5f97\u5230\u7684\u65e5\u8a8c\u6578\u64da\u96c6\uff0c\u641c\u7d22\u8868\u9054\u5f0f\u53ef\u4ee5\u662f\u6587\u672c\u6216\u6b63\u5247\u8868\u9054\u5f0f\uff0c\u6bd4\u5982\uff1a { job = \"mysql\" } | = \"error\" { instance = ~ \"kafka-[23]\" ,name = \"kafka\" } ! = \"kafka.server:type=ReplicaManager\" { name = \"kafka\" } | ~ \"tsdb-ops.*io:2003\" { name = \"cassandra\" } | ~ ` error = \\w + ` \u4e0a\u9762\u793a\u4f8b\u4e2d\u7684 |= \u3001 |~ \u548c != \u662f\u904e\u6ffe\u904b\u7b97\u7b26\uff0c\u652f\u6301\u4e0b\u9762\u5e7e\u7a2e\u985e\u578b\uff1a |= \u65e5\u8a8c\u884c\u5305\u542b\u7684\u5b57\u7b26\u4e32 != \u65e5\u8a8c\u884c\u4e0d\u5305\u542b\u7684\u5b57\u7b26\u4e32 |~ \u65e5\u8a8c\u884c\u5339\u914d\u6b63\u5247\u8868\u9054\u5f0f !~ \u65e5\u8a8c\u884c\u8207\u6b63\u5247\u8868\u9054\u5f0f\u4e0d\u5339\u914d \u904e\u6ffe\u904b\u7b97\u7b26\u53ef\u4ee5\u662f\u4e32\u9023\u5728\u4e00\u8d77\u4f7f\u7528\u7684\uff0c\u4e26\u5c07\u6309\u9806\u5e8f\u57f7\u884c\u904e\u6ffe\u8868\u9054\u5f0f\uff0c\u7522\u751f\u7684\u65e5\u8a8c\u884c\u5fc5\u9808\u6eff\u8db3\u6bcf\u500b\u904e\u6ffe\u5668\u3002\u7576\u4f7f\u7528 |~ \u548c !~ \u6642\uff0c\u53ef\u4ee5\u4f7f\u7528 Golang \u7684 RE2 \u8a9e\u6cd5 \u7684\u6b63\u5247\u8868\u9054\u5f0f\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5339\u914d\u662f\u5340\u5206\u5927\u5c0f\u5beb\u7684\uff0c\u53ef\u4ee5\u7528 (?i) \u4f5c\u7232\u6b63\u5247\u8868\u9054\u5f0f\u7684\u524d\u7db4\uff0c\u5207\u63db\u7232\u4e0d\u5340\u5206\u5927\u5c0f\u5beb\u3002 \u96d6\u7136\u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f\u53ef\u4ee5\u653e\u5728\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\uff0c\u4f46\u6700\u597d\u628a\u5b83\u5011\u653e\u5728\u958b\u982d\uff0c\u9019\u6a23\u53ef\u4ee5\u63d0\u9ad8\u67e5\u8a62\u7684\u6027\u80fd\uff0c\u7576\u67d0\u4e00\u884c\u5339\u914d\u6642\u624d\u505a\u9032\u4e00\u6b65\u7684\u5f8c\u7e8c\u8655\u7406\u3002\u4f8b\u5982\uff0c\u96d6\u7136\u7d50\u679c\u662f\u4e00\u6a23\u7684\uff0c\u4f46\u4e0b\u9762\u7684\u67e5\u8a62 {job=\"mysql\"} |= \"error\" |json | line_format \"{{.err}}\" \u6703\u6bd4 {job=\"mysql\"} | json | line_format \"{{.message}}\" |= \"error\" \u66f4\u5feb\uff0c \u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f\u662f\u7e7c\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e4b\u5f8c\u904e\u6ffe\u65e5\u8a8c\u7684\u6700\u5feb\u65b9\u5f0f \u3002","title":"Line filter expressions"},{"location":"kubernetes/observability/logging/loki/loki-ql/#label-filter-expressions","text":"\u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f \u5141\u8a31\u4f7f\u7528\u5176\u539f\u59cb\u548c\u63d0\u53d6\u7684\u6a19\u7c64\u4f86\u904e\u6ffe\u65e5\u8a8c\u884c\uff0c\u5b83\u53ef\u4ee5\u5305\u542b\u591a\u500b \u8b02\u8a5e \u3002 \u4e00\u500b\u8b02\u8a5e\u5305\u542b\u4e00\u500b\u6a19\u7c64\u6a19\u8b58\u7b26\u3001\u64cd\u4f5c\u7b26\u548c\u7528\u65bc\u6bd4\u8f03\u6a19\u7c64\u7684\u503c\u3002 \u4f8b\u5982 cluster=\"namespace\" \u5176\u4e2d\u7684 cluster \u662f\u6a19\u7c64\u6a19\u8b58\u7b26\uff0c\u64cd\u4f5c\u7b26\u662f = \uff0c\u503c\u662f \"namespace\" \u3002 LogQL \u652f\u6301\u5f9e\u67e5\u8a62\u8f38\u5165\u4e2d\u81ea\u52d5\u63a8\u65b7\u51fa\u7684\u591a\u7a2e\u503c\u985e\u578b\uff1a String \uff08\u5b57\u7b26\u4e32\uff09\u7528\u96d9\u5f15\u865f\u6216\u53cd\u5f15\u865f\u5f15\u8d77\u4f86\uff0c\u4f8b\u5982\"200\"\u6216 us-central1\u3002 Duration \uff08\u6642\u9593\uff09\u662f\u4e00\u4e32\u5341\u9032\u5236\u6578\u5b57\uff0c\u6bcf\u500b\u6578\u5b57\u90fd\u6709\u53ef\u9078\u7684\u6578\u548c\u55ae\u4f4d\u5f8c\u7db4\uff0c\u5982 \"300ms\"\u3001\"1.5h\" \u6216 \"2h45m\"\uff0c\u6709\u6548\u7684\u6642\u9593\u55ae\u4f4d\u662f \"ns\"\u3001\"us\"\uff08\u6216 \"\u00b5s\"\uff09\u3001\"ms\"\u3001\"s\"\u3001\"m\"\u3001\"h\"\u3002 Number \uff08\u6578\u5b57\uff09\u662f\u6d6e\u9ede\u6578\uff0864 \u4f4d\uff09\uff0c\u5982 250\u300189.923\u3002 Bytes \uff08\u5b57\u7bc0\uff09\u662f\u4e00\u4e32\u5341\u9032\u5236\u6578\u5b57\uff0c\u6bcf\u500b\u6578\u5b57\u90fd\u6709\u53ef\u9078\u7684\u6578\u548c\u55ae\u4f4d\u5f8c\u7db4\uff0c\u5982 \"42MB\"\u3001\"1.5Kib\" \u6216 \"20b\"\uff0c\u6709\u6548\u7684\u5b57\u7bc0\u55ae\u4f4d\u662f \"b\"\u3001\"kib\"\u3001\"kb\"\u3001\"mib\"\u3001\"mb\"\u3001\"gib\"\u3001\"gb\"\u3001\"tib\"\u3001\"tb\"\u3001\"pib\"\u3001\"bb\"\u3001\"eb\"\u3002 \u5b57\u7b26\u4e32\u985e\u578b\u7684\u5de5\u4f5c\u65b9\u5f0f\u8207 Prometheus \u6a19\u7c64\u5339\u914d\u5668\u5728\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e2d\u4f7f\u7528\u7684\u65b9\u5f0f\u5b8c\u5168\u4e00\u6a23\uff0c\u9019\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u4f7f\u7528\u540c\u6a23\u7684\u64cd\u4f5c\u7b26\uff08 = \u3001 != \u3001 =~ \u3001 !~ u\uff09\u3002 \u4f7f\u7528 Duration\u3001Number \u548c Bytes \u5c07\u5728\u6bd4\u8f03\u524d\u8f49\u63db\u6a19\u7c64\u503c\uff0c\u4e26\u652f\u6301\u4ee5\u4e0b\u6bd4\u8f03\u5668\u3002 == \u6216 = \u76f8\u7b49\u6bd4\u8f03 != \u4e0d\u7b49\u65bc\u6bd4\u8f03 > \u548c >= \u7528\u65bc\u5927\u65bc\u6216\u5927\u65bc\u7b49\u65bc\u6bd4\u8f03 < \u548c <= \u7528\u65bc\u5c0f\u65bc\u6216\u5c0f\u65bc\u7b49\u65bc\u6bd4\u8f03 \u4f8b\u5982 logfmt | duration > 1m and bytes_consumed > 20MB \u904e\u6ffe\u8868\u9054\u5f0f\u3002 \u5982\u679c\u6a19\u7c64\u503c\u7684\u8f49\u63db\u6216\u63d0\u53d6\u5931\u6557\uff0c\u65e5\u8a8c\u884c\u5c31\u4e0d\u6703\u88ab\u904e\u6ffe\uff0c\u800c\u6703\u6dfb\u52a0\u4e00\u500b error \u6a19\u7c64\u3002\u4f60\u53ef\u4ee5\u4f7f\u7528 and \u3000\u548c or \u4f86\u9023\u63a5\u591a\u500b\u8b02\u8a5e\uff0c\u5b83\u5011\u5206\u5225\u8868\u793a \u4e14 \u548c \u6216 \u7684\u4e8c\u9032\u5236\u64cd\u4f5c\uff0c and \u53ef\u4ee5\u7528\u9017\u865f\u3001\u7a7a\u683c\u6216\u5176\u4ed6\u7ba1\u9053\u4f86\u8868\u793a\uff0c\u6a19\u7c64\u904e\u6ffe\u5668\u53ef\u4ee5\u653e\u5728\u65e5\u8a8c\u7ba1\u9053\u7684\u4efb\u4f55\u5730\u65b9\u3002 \u4ee5\u4e0b\u6240\u6709\u7684\u8868\u9054\u5f0f\u90fd\u662f\u7b49\u50f9\u7684: | duration > = 20ms or size == 20kb and method!~ \"2..\" | duration > = 20ms or size == 20kb | method!~ \"2..\" | duration > = 20ms or size == 20kb,method!~ \"2..\" | duration > = 20ms or size == 20kb method!~ \"2..\" \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u591a\u500b\u8b02\u8a5e\u7684\u512a\u5148\u7d1a\u662f\u5f9e\u53f3\u5230\u5de6\uff0c\u4f60\u53ef\u4ee5\u7528\u5713\u62ec\u865f\u5305\u88dd\u8b02\u8a5e\uff0c\u5f37\u5236\u4f7f\u7528\u5f9e\u5de6\u5230\u53f3\u7684\u4e0d\u540c\u512a\u5148\u7d1a\u3002 \u4f8b\u5982\uff0c\u4ee5\u4e0b\u5167\u5bb9\u662f\u7b49\u50f9\u7684\uff1a | duration > = 20ms or method = \"GET\" and size < = 20KB | (( duration > = 20ms or method = \"GET\" ) and size < = 20KB ) \u5b83\u5c07\u9996\u5148\u8a55\u4f30 duration>=20ms or method=\"GET\"\uff0c\u8981\u9996\u5148\u8a55\u4f30 method=\"GET\" and size<=20KB\uff0c\u8acb\u78ba\u4fdd\u4f7f\u7528\u9069\u7576\u7684\u62ec\u865f\uff0c\u5982\u4e0b\u6240\u793a\u3002 | duration > = 20ms or ( method = \"GET\" and size < = 20KB ) \u6a19\u7c64\u904e\u6ffe\u5668\u8868\u9054\u5f0f\u652f\u6301\u5339\u914d IP \u5730\u5740\u3002\u6709\u95dc\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u5339\u914d IP \u5730\u5740 \u3002","title":"Label filter expressions"},{"location":"kubernetes/observability/logging/loki/loki-ql/#parser-expression","text":"\u89e3\u6790\u5668\u8868\u9054\u5f0f \u53ef\u4ee5\u89e3\u6790\u548c\u63d0\u53d6\u65e5\u8a8c\u5167\u5bb9\u4e2d\u7684\u6a19\u7c64\uff0c\u9019\u4e9b\u63d0\u53d6\u7684\u6a19\u7c64\u53ef\u4ee5\u7528\u65bc\u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f\u9032\u884c\u904e\u6ffe\uff0c\u6216\u8005\u7528\u65bc\u6307\u6a19\u805a\u5408\u3002 \u63d0\u53d6\u7684\u6a19\u7c64\u9375\u5c07\u7531\u89e3\u6790\u5668\u9032\u884c\u81ea\u52d5\u683c\u5f0f\u5316\uff0c\u4ee5\u9075\u5faa Prometheus \u6307\u6a19\u540d\u7a31\u7684\u7d04\u5b9a\uff08\u5b83\u5011\u53ea\u80fd\u5305\u542b ASCII \u5b57\u6bcd\u548c\u6578\u5b57\uff0c\u4ee5\u53ca\u4e0b\u5283\u7dda\u548c\u5192\u865f\uff0c\u4e0d\u80fd\u4ee5\u6578\u5b57\u958b\u982d\uff09\u3002 \u4f8b\u5982\u4e0b\u9762\u7684\u65e5\u8a8c\u7d93\u904e\u7ba1\u9053 | json \u5c07\u7522\u751f\u4ee5\u4e0b Map \u6578\u64da\uff1a \u65e5\u8a8c\u539f\u59cb\u6578\u64da: log line { \"a.b\" : { \"c\" : \"d\" }, \"e\" : \"f\" } \u89e3\u6790\u5668\u8868\u9054\u5f0f\u8655\u7406\u5f8c\u7d50\u679c: { a_b_c = \"d\" , e = \"f\" } \u5728\u51fa\u73fe\u932f\u8aa4\u7684\u60c5\u6cc1\u4e0b\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u8a72\u884c\u4e0d\u662f\u9810\u671f\u7684\u683c\u5f0f\uff0c\u8a72\u65e5\u8a8c\u884c\u4e0d\u6703\u88ab\u904e\u6ffe\uff0c\u800c\u662f\u6703\u88ab\u6dfb\u52a0\u4e00\u500b\u65b0\u7684 __error__ \u6a19\u7c64\u3002 \u9700\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u4e00\u500b\u63d0\u53d6\u7684\u6a19\u7c64\u9375\u540d\u5df2\u7d93\u5b58\u5728\u65bc\u539f\u59cb\u65e5\u8a8c\u6d41\u4e2d\uff0c\u90a3\u9ebc\u63d0\u53d6\u7684\u6a19\u7c64\u9375\u5c07\u4ee5 _extracted \u4f5c\u7232\u5f8c\u7db4\uff0c\u4ee5\u5340\u5206\u5169\u500b\u6a19\u7c64\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b\u6a19\u7c64\u683c\u5f0f\u5316\u8868\u9054\u5f0f\u4f86\u5f37\u884c\u8986\u84cb\u539f\u59cb\u6a19\u7c64\uff0c\u4f46\u662f\u5982\u679c\u4e00\u500b\u63d0\u53d6\u7684\u9375\u51fa\u73fe\u4e86\u5169\u6b21\uff0c\u90a3\u9ebc\u53ea\u6709\u6700\u65b0\u7684\u6a19\u7c64\u503c\u6703\u88ab\u4fdd\u7559\u3002 \u76ee\u524d\u652f\u6301 json\u3001logfmt\u3001pattern\u3001regexp \u548c unpack \u9019\u5e7e\u7a2e\u89e3\u6790\u5668\u3002 \u6211\u5011\u61c9\u8a72\u5118\u53ef\u80fd\u4f7f\u7528 json \u548c logfmt \u7b49\u9810\u5b9a\u7fa9\u7684\u89e3\u6790\u5668\uff0c\u9019\u6703\u66f4\u52a0\u5bb9\u6613\uff0c\u800c\u7576\u65e5\u5fd7\u884c\u7d50\u69cb\u7570\u5e38\u6642\uff0c\u53ef\u4ee5\u4f7f\u7528 regexp\uff0c\u53ef\u4ee5\u5728\u540c\u4e00\u65e5\u8a8c\u7ba1\u9053\u4e2d\u4f7f\u7528\u591a\u500b\u89e3\u6790\u5668\uff0c\u9019\u5728\u4f60\u89e3\u6790\u8907\u96dc\u65e5\u8a8c\u6642\u5f88\u6709\u7528\u3002","title":"Parser expression"},{"location":"kubernetes/observability/logging/loki/loki-ql/#json","text":"json \u89e3\u6790\u5668\u6709\u5169\u7a2e\u6a21\u5f0f\u904b\u884c\u3002 \u6c92\u6709\u53c3\u6578 : \u5982\u679c\u65e5\u8a8c\u884c\u662f\u4e00\u500b\u6709\u6548\u7684 json \u6587\u6a94\uff0c\u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u6dfb\u52a0 | json \u5c07\u63d0\u53d6\u6240\u6709 json \u5c6c\u6027\u4f5c\u7232\u6a19\u7c64\uff0c\u5d4c\u5957\u7684\u5c6c\u6027\u6703\u4f7f\u7528 _ \u5206\u9694\u7b26\u88ab\u5e73\u92ea\u5230\u6a19\u7c64\u9375\u4e2d\u3002 Info \u6ce8\u610f\uff1a\u6578\u7d44\u6703\u88ab\u5ffd\u7565\u3002 \u4f8b\u5982\uff0c\u4f7f\u7528 json \u89e3\u6790\u5668\u5f9e\u4ee5\u4e0b\u6587\u4ef6\u5167\u5bb9\u4e2d\u63d0\u53d6\u6a19\u7c64\u3002 { \"protocol\" : \"HTTP/2.0\" , \"servers\" : [ \"129.0.1.1\" , \"10.2.1.3\" ], \"request\" : { \"time\" : \"6.032\" , \"method\" : \"GET\" , \"host\" : \"foo.grafana.net\" , \"size\" : \"55\" , \"headers\" : { \"Accept\" : \"*/*\" , \"User-Agent\" : \"curl/7.68.0\" } }, \"response\" : { \"status\" : 401 , \"size\" : \"228\" , \"latency_seconds\" : \"6.031\" } } \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6a19\u7c64\u5217\u8868\uff1a \"protocol\" = > \"HTTP/2.0\" \"request_time\" = > \"6.032\" \"request_method\" = > \"GET\" \"request_host\" = > \"foo.grafana.net\" \"request_size\" = > \"55\" \"response_status\" = > \"401\" \"response_size\" = > \"228\" \"response_latency_seconds\" = > \"6.031\" \u5e36\u53c3\u6578\u7684 : \u5728\u4f60\u7684\u7ba1\u9053\u4e2d\u4f7f\u7528 |json label=\"expression\", another=\"expression\" \u5c07\u53ea\u63d0\u53d6\u6307\u5b9a\u7684 json \u5b57\u6bb5\u7232\u6a19\u7c64\uff0c\u4f60\u53ef\u4ee5\u7528\u9019\u7a2e\u65b9\u5f0f\u6307\u5b9a\u4e00\u500b\u6216\u591a\u500b\u8868\u9054\u5f0f\uff0c\u8207 label_format \u76f8\u540c\uff0c\u6240\u6709\u8868\u9054\u5f0f\u5fc5\u9808\u52a0\u5f15\u865f\u3002 \u7576\u524d\u50c5\u652f\u6301\u5b57\u6bb5\u8a2a\u554f\uff08 my.field , my[\"field\"] \uff09\u548c\u6578\u7d44\u8a2a\u554f\uff08 list[0] \uff09\uff0c\u4ee5\u53ca\u4efb\u4f55\u7d1a\u5225\u5d4c\u5957\u4e2d\u7684\u9019\u4e9b\u7d44\u5408\uff08 my.list[0][\"field\"] \uff09\u3002 \u4f8b\u5982\uff0c |json first_server=\"servers[0]\", ua=\"request.headers[\\\"User-Agent\\\"] \u5c07\u5f9e\u4ee5\u4e0b\u65e5\u8a8c\u6587\u4ef6\u4e2d\u63d0\u53d6\u6a19\u7c64\uff1a { \"protocol\" : \"HTTP/2.0\" , \"servers\" : [ \"129.0.1.1\" , \"10.2.1.3\" ], \"request\" : { \"time\" : \"6.032\" , \"method\" : \"GET\" , \"host\" : \"foo.grafana.net\" , \"size\" : \"55\" , \"headers\" : { \"Accept\" : \"*/*\" , \"User-Agent\" : \"curl/7.68.0\" } }, \"response\" : { \"status\" : 401 , \"size\" : \"228\" , \"latency_seconds\" : \"6.031\" } } \u63d0\u53d6\u7684\u6a19\u7c64\u5217\u8868\u7232\uff1a \"first_server\" = > \"129.0.1.1\" \"ua\" = > \"curl/7.68.0\"","title":"json \u89e3\u6790\u5668"},{"location":"kubernetes/observability/logging/loki/loki-ql/#logfmt","text":"logfmt \u89e3\u6790\u5668\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 | logfmt \u4f86\u6dfb\u52a0\uff0c\u5b83\u5c07\u5f9e logfmt \u683c\u5f0f\u7684\u65e5\u8a8c\u884c\u4e2d\u63d0\u524d\u6240\u6709\u7684\u9375\u548c\u503c\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u65e5\u8a8c\u884c\u6578\u64da\uff1a log line at = info method = GET path = / host = grafana.net fwd = \"124.133.124.161\" service = 8ms status = 200 \u5c07\u63d0\u53d6\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u6a19\u7c64\uff1a \"at\" = > \"info\" \"method\" = > \"GET\" \"path\" = > \"/\" \"host\" = > \"grafana.net\" \"fwd\" = > \"124.133.124.161\" \"service\" = > \"8ms\" \"status\" = > \"200\"","title":"logfmt \u89e3\u6790\u5668"},{"location":"kubernetes/observability/logging/loki/loki-ql/#regexp","text":"\u8207 logfmt \u548c json\uff08\u5b83\u5011\u96b1\u5f0f\u63d0\u53d6\u6240\u6709\u503c\u4e14\u4e0d\u9700\u8981\u53c3\u6578\uff09\u4e0d\u540c\uff0cregexp \u89e3\u6790\u5668\u63a1\u7528\u55ae\u500b\u53c3\u6578 | regexp \"<re>\" \u7684\u683c\u5f0f\uff0c\u5176\u53c3\u6578\u662f\u4f7f\u7528 Golang RE2 \u8a9e\u6cd5\u7684\u6b63\u5247\u8868\u9054\u5f0f\u3002 \u6b63\u5247\u8868\u9054\u5f0f\u5fc5\u9808\u5305\u542b\u81f3\u5c11\u4e00\u500b\u547d\u540d\u7684\u5b50\u5339\u914d\uff08\u4f8b\u5982 (?P<name>re) \uff09\uff0c\u6bcf\u500b\u5b50\u5339\u914d\u9805\u90fd\u6703\u63d0\u53d6\u4e00\u500b\u4e0d\u540c\u7684\u6a19\u7c64\u3002 \u4f8b\u5982\uff0c\u89e3\u6790\u5668 | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\" \u5c07\u5f9e\u4ee5\u4e0b\u884c\u4e2d\u63d0\u53d6\u6a19\u7c64\uff1a POST /api/prom/api/v1/query_range ( 200 ) 1 .5s \u63d0\u53d6\u7684\u6a19\u7c64\u7232\uff1a \"method\" = > \"POST\" \"path\" = > \"/api/prom/api/v1/query_range\" \"status\" = > \"200\" \"duration\" = > \"1.5s\" \u4e0b\u5217\u5de5\u5177\u53ef\u5e6b\u52a9\u9a57\u8b49\u8a9e\u6cd5\u7684\u57f7\u884c\uff1a \u5de5\u5177\uff1a\u3000 https://regoio.herokuapp.com/ \u6b63\u5247\u8868\u9054\u5f0f: (?P<method>\\w+) (?P<path>[\\w|/]+) \\((?P<status>\\d+?)\\) (?P<duration>.*) \u5de5\u5177\uff1a\u3000 https://grafana.com/docs/loki/latest/logql/analyzer/ Query\u8868\u9054\u5f0f: | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\"","title":"regexp \u89e3\u6790\u5668"},{"location":"kubernetes/observability/logging/loki/loki-ql/#pattern","text":"\u6a21\u5f0f\u89e3\u6790\u5668\u5141\u8a31\u901a\u904e\u5b9a\u7fa9\u6a21\u5f0f\u8868\u9054\u5f0f | pattern \"<pattern-expression>\" \u5f9e\u65e5\u8a8c\u884c\u4e2d\u986f\u5f0f\u63d0\u53d6\u5b57\u6bb5\uff0c\u8a72\u8868\u9054\u5f0f\u8207\u65e5\u8a8c\u884c\u7684\u7d50\u69cb\u76f8\u5339\u914d\u3002 \u6bd4\u5982\u6211\u5011\u4f86\u8003\u616e\u4e0b\u9762\u7684 NGINX \u65e5\u8a8c\u884c\u6578\u64da\uff1a log line 0 .191.12.2 - - [ 10 /Jun/2021:09:14:29 +0000 ] \"GET /api/plugins/versioncheck HTTP/1.1\" 200 2 \"-\" \"Go-http-client/2.0\" \"13.76.247.102, 34.120.177.193\" \"TLSv1.2\" \"US\" \"\" \u8a72\u65e5\u8a8c\u884c\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4f86\u89e3\u6790\uff1a <ip> - - <_> \"<method> <uri> <_>\" <status> <size> <_> \"<agent>\" <_> \u89e3\u6790\u5f8c\u53ef\u4ee5\u63d0\u53d6\u51fa\u4e0b\u9762\u7684\u9019\u4e9b\u5c6c\u6027\uff1a \"ip\" = > \"0.191.12.2\" \"method\" = > \"GET\" \"uri\" = > \"/api/plugins/versioncheck\" \"status\" = > \"200\" \"size\" = > \"2\" \"agent\" = > \"Go-http-client/2.0\" \u6a21\u5f0f\u8868\u9054\u5f0f\u7684\u6355\u7372\u662f\u7531 < \u548c > \u5b57\u7b26\u5206\u9694\u7684\u5b57\u6bb5\u540d\u7a31\uff0c\u6bd4\u5982 \u5b9a\u7fa9\u4e86\u5b57\u6bb5\u540d\u7a31\u7232 example\uff0c\u672a\u547d\u540d\u7684 capture \u986f\u793a\u7232 <_> \uff0c\u672a\u547d\u540d\u7684 capture \u6703\u8df3\u904e\u5339\u914d\u7684\u5167\u5bb9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u6a21\u5f0f\u8868\u9054\u5f0f\u9328\u5b9a\u5728\u65e5\u8a8c\u884c\u7684\u958b\u982d\uff0c\u53ef\u4ee5\u5728\u8868\u9054\u5f0f\u7684\u958b\u982d\u4f7f\u7528 <_> \u5c07\u8868\u9054\u5f0f\u9328\u5b9a\u5728\u958b\u982d\u3002 \u6bd4\u5982\u6211\u5011\u67e5\u770b\u4e0b\u9762\u7684\u65e5\u8a8c\u884c\u6578\u64da\uff1a log line level = debug ts = 2021 -06-10T09:24:13.472094048Z caller = logging.go:66 traceID = 0568b66ad2d9294c msg = \"POST /loki/api/v1/push (204) 16.652862ms\" \u6211\u5011\u5982\u679c\u53ea\u5e0c\u671b\u53bb\u5339\u914d msg=\" \u7684\u5167\u5bb9\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4f86\u9032\u884c\u5339\u914d\uff1a <_> msg = \"<method> <path> (<status>) <latency>\"","title":"pattern \u89e3\u6790\u5668"},{"location":"kubernetes/observability/logging/loki/loki-ql/#line-format-expression","text":"\u65e5\u8a8c\u884c\u683c\u5f0f\u5316\u8868\u9054\u5f0f\u53ef\u4ee5\u901a\u904e\u4f7f\u7528 Golang \u7684 text/template \u6a21\u677f\u683c\u5f0f\u91cd\u5beb\u65e5\u8a8c\u884c\u7684\u5167\u5bb9\uff0c\u5b83\u9700\u8981\u4e00\u500b\u5b57\u7b26\u4e32\u53c3\u6578 | line_format \"{{.label_name}}\" \u4f5c\u7232\u6a21\u677f\u683c\u5f0f\uff0c\u6240\u6709\u7684\u6a19\u7c64\u90fd\u662f\u6ce8\u5165\u6a21\u677f\u7684\u8b8a\u91cf\uff0c\u53ef\u4ee5\u7528 {{.label_name}} \u7684\u7b26\u865f\u4f86\u4f7f\u7528\u3002 \u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u8868\u9054\u5f0f\uff1a log ql { container = \"frontend\" } | logfmt | line_format \"{{.query}} {{.duration}}\" \u5c07\u63d0\u53d6\u4e26\u91cd\u5beb\u65e5\u8a8c\u884c\uff0c\u53ea\u5305\u542b query \u548c\u8acb\u6c42\u7684 duration\u3002\u4f60\u53ef\u4ee5\u7232\u6a21\u677f\u4f7f\u7528\u96d9\u5f15\u865f\u5b57\u7b26\u4e32\u6216\u53cd\u5f15\u865f \"{{.label_name}}\" \u4f86\u907f\u514d\u8f49\u7fa9\u7279\u6b8a\u5b57\u7b26\u3002 \u6b64\u5916 line_format \u4e5f\u652f\u6301\u6578\u5b78\u51fd\u6578\uff0c\u4f8b\u5982\uff1a \u5982\u679c\u6211\u5011\u6709\u4ee5\u4e0b\u6a19\u7c64 ip=1.1.1.1, status=200 \u548c duration=3000(ms), \u6211\u5011\u53ef\u4ee5\u7528 duration \u9664\u4ee5 1000 \u5f97\u5230\u4ee5\u79d2\u7232\u55ae\u4f4d\u7684\u503c\uff1a log ql { container = \"frontend\" } | logfmt | line_format \"{{.ip}} {{.status}} {{div .duration 1000}}\" \u4e0a\u9762\u7684\u67e5\u8a62\u5c07\u5f97\u5230\u7684\u65e5\u8a8c\u884c\u5167\u5bb9\u7232: 1 .1.1.1 200 3 \u8acb\u53c3\u95b1 \u6a21\u677f\u51fd\u6578 \u4ee5\u4e86\u89e3\u6a21\u677f\u683c\u5f0f\u4e2d\u7684\u53ef\u7528\u51fd\u6578\u3002","title":"Line format expression"},{"location":"kubernetes/observability/logging/loki/loki-ql/#labels-format-expression","text":"| label_format \u8868\u9054\u5f0f\u53ef\u4ee5\u91cd\u547d\u540d\u3001\u4fee\u6539\u6216\u6dfb\u52a0\u6a19\u7c64\uff0c\u5b83\u4ee5\u9017\u865f\u5206\u9694\u7684\u64cd\u4f5c\u5217\u8868\u4f5c\u7232\u53c3\u6578\uff0c\u53ef\u4ee5\u540c\u6642\u9032\u884c\u591a\u500b\u64cd\u4f5c\u3002 \u7576\u5169\u908a\u90fd\u662f\u6a19\u7c64\u6a19\u8b58\u7b26\u6642\uff0c\u4f8b\u5982 dst=src \uff0c\u8a72\u64cd\u4f5c\u5c07\u628a src \u6a19\u7c64\u91cd\u547d\u540d\u7232 dst \u3002 \u5de6\u908a\u4e5f\u53ef\u4ee5\u662f\u4e00\u500b\u6a21\u677f\u5b57\u7b26\u4e32\uff0c\u4f8b\u5982 dst=\"{{.status}} {{.query}}\" \uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c dst \u6a19\u7c64\u503c\u6703\u88ab Golang \u6a21\u677f\u57f7\u884c\u7d50\u679c\u6240\u53d6\u4ee3\uff0c\u9019\u8207 | line_format \u8868\u9054\u5f0f\u662f\u540c\u4e00\u500b\u6a21\u677f\u5f15\u64ce\uff0c\u9019\u610f\u5473\u7740\u6a19\u7c64\u53ef\u4ee5\u4f5c\u7232\u8b8a\u91cf\u4f7f\u7528\uff0c\u4e5f\u53ef\u4ee5\u4f7f\u7528\u540c\u6a23\u7684\u51fd\u6578\u5217\u8868\u3002 \u5728\u4e0a\u9762\u5169\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5982\u679c\u76ee\u6a19\u6a19\u7c64\u4e0d\u5b58\u5728\uff0c\u90a3\u9ebc\u5c31\u6703\u5275\u5efa\u4e00\u500b\u65b0\u7684\u6a19\u7c64\u3002 \u91cd\u547d\u540d\u5f62\u5f0f dst=src \u6703\u5728\u5c07 src \u6a19\u7c64\u91cd\u65b0\u6620\u5c04\u5230 dst \u6a19\u7c64\u5f8c\u5c07\u5176\u522a\u9664\uff0c\u7136\u800c\uff0c\u6a21\u677f\u5f62\u5f0f\u5c07\u4fdd\u7559\u5f15\u7528\u7684\u6a19\u7c64\uff0c\u4f8b\u5982 dst=\"{{.src}}\" \u7684\u7d50\u679c\u662f dst \u548c src \u90fd\u6709\u76f8\u540c\u7684\u503c\u3002 Tip \u4e00\u500b\u6a19\u7c64\u540d\u7a31\u5728\u6bcf\u500b\u8868\u9054\u5f0f\u4e2d\u53ea\u80fd\u51fa\u73fe\u4e00\u6b21\uff0c\u9019\u610f\u5473\u7740 | label_format foo=bar,foo=\"new\" \u662f\u4e0d\u5141\u8a31\u7684\uff0c\u4f46\u4f60\u53ef\u4ee5\u4f7f\u7528\u5169\u500b\u8868\u9054\u5f0f\u4f86\u9054\u5230\u9810\u671f\u6548\u679c\uff0c\u6bd4\u5982 | label_format foo=bar | label_format foo=\"new\" \u3002","title":"Labels format expression"},{"location":"kubernetes/observability/logging/loki/loki-ql/#log-query_1","text":"","title":"Log query \u793a\u4f8b"},{"location":"kubernetes/observability/logging/loki/loki-ql/#multiple-filtering","text":"\u904e\u6ffe\u61c9\u8a72\u9996\u5148\u5728\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4f7f\u7528\u6a19\u7c64\u5339\u914d\u5668\u4f86\u9650\u7e2eloki\u8981\u67e5\u627e\u7684\u65e5\u8a8c\uff0c\u7136\u5f8c\u662f\u65e5\u8a8c\u884c\u904e\u6ffe\u5668\uff08\u5982\u679c\u53ef\u80fd\uff09\uff0c\u6700\u5f8c\u518d\u4f7f\u7528\u6a19\u7c64\u904e\u6ffe\u5668\u3002\u4ee5\u4e0b\u67e5\u8a62\u793a\u7bc4\u4e86\u9019\u4e00\u9ede\u3002 log ql { cluster = \"ops-tools1\" , namespace = \"loki-dev\" , job = \"loki-dev/query-frontend\" } | = \"metrics.go\" ! = \"out of order\" | logfmt | duration > 30s or status_code! = \"200\" \u65e5\u8a8c\u6d41\u9078\u64c7\u5668: {cluster=\"ops-tools1\", namespace=\"loki-dev\", job=\"loki-dev/query-frontend\"} \u65e5\u8a8c\u884c\u904e\u6ffe\u8868\u9054\u5f0f: |= \"metrics.go\" !=\"out of order\" \u89e3\u6790\u5668\u8868\u9054\u5f0f: | logfmt \u6a19\u7c64\u904e\u6ffe\u8868\u9054\u5f0f: | duration > 30s or status_code!=\"200\"","title":"Multiple filtering"},{"location":"kubernetes/observability/logging/loki/loki-ql/#multiple-parsers","text":"\u63d0\u53d6\u4ee5\u4e0b logfmt \u65e5\u8a8c\u884c\u7684\u65b9\u6cd5\u548c\u8def\u5f91\uff1a log line level = debug ts = 2020 -10-02T10:10:42.092268913Z caller = logging.go:66 traceID = a9d4d8a928d8db1 msg = \"POST /api/prom/api/v1/query_range (200) 1.5s\" \u60a8\u53ef\u4ee5\u50cf\u9019\u6a23\u4f7f\u7528\u591a\u500b\u89e3\u6790\u5668\uff08logfmt \u548c regexp\uff09\u3002_ log ql { job = \"loki-ops/query-frontend\" } | logfmt | line_format \"{{.msg}}\" | regexp \"(?P<method>\\\\w+) (?P<path>[\\\\w|/]+) \\\\((?P<status>\\\\d+?)\\\\) (?P<duration>.*)\" \u9019\u662f\u53ef\u80fd\u7684\uff0c\u56e0\u70ba | line_format \u5c07\u65e5\u8a8c\u884c\u91cd\u65b0\u683c\u5f0f\u5316\u70ba POST /api/prom/api/v1/query_range (200) 1.5s \u7136\u5f8c\u53ef\u4ee5\u4f7f\u7528 | regexp ... \u89e3\u6790\u5668\u3002 \u53e6\u5916\u4e00\u500b\u5e38\u7528\u89e3\u6790 Niginx \u65e5\u8a8c\u884c\u7684\u7bc4\u4f8b\uff1a log line 54 .203.113.59 - - [ 09 /Sep/2022:03:34:45 +0000 ] \"PUT /index.html HTTP/1.1\" 200 3622 \"-\" \"Mozilla/5.0 (X11; Linux i686) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.101 Safari/537.36 OPR/40.0.2308.62\" \"-\" log ql { namespace = \"default\" } | json | line_format \"{{.message}}\" | pattern \"<_> - <_> <_> \\\"<method> <url> <protocol>\\\" <status> <_> <_> \\\"<_>\\\" <_>\"","title":"Multiple parsers"},{"location":"kubernetes/observability/logging/loki/loki-ql/#formatting","text":"\u4ee5\u4e0b\u67e5\u8a62\u986f\u793a\u77ad\u5982\u4f55\u91cd\u65b0\u683c\u5f0f\u5316\u65e5\u8a8c\u884c\u4ee5\u4f7f\u5176\u66f4\u6613\u65bc\u5728\u5c4f\u5e55\u4e0a\u95b1\u8b80\u3002 log ql { cluster = \"ops-tools1\" , name = \"querier\" , namespace = \"loki-dev\" } | = \"metrics.go\" ! = \"loki-canary\" | logfmt | query ! = \"\" | label_format query = \"{{ Replace .query \\\"\\\\n\\\" \\\"\\\" -1 }}\" | line_format \"{{ .ts}}\\t{{.duration}}\\ttraceID = {{.traceID}}\\t{{ printf \\\"%-100.100s\\\" .query }} \" \u6a19\u7c64\u683c\u5f0f\u7528\u65bc\u6e05\u7406\u67e5\u8a62\uff0c\u800c\u884c\u683c\u5f0f\u6e1b\u5c11\u4fe1\u606f\u91cf\u4e26\u5275\u5efa\u8868\u683c\u8f38\u51fa\u3002 \u5c0d\u65bc\u9019\u4e9b\u7d66\u5b9a\u7684\u65e5\u8a8c\u884c\uff1a log line level = info ts = 2020 -10-23T20:32:18.094668233Z caller = metrics.go:81 org_id = 29 traceID = 1980d41501b57b68 latency = fast query = \"{cluster=\\\"ops-tools1\\\", job=\\\"loki-ops/query-frontend\\\"} |= \\\"query_range\\\"\" query_type = filter range_type = range length = 15m0s step = 7s duration = 650 .22401ms status = 200 throughput_mb = 1 .529717 total_bytes_mb = 0 .994659 level = info ts = 2020 -10-23T20:32:18.068866235Z caller = metrics.go:81 org_id = 29 traceID = 1980d41501b57b68 latency = fast query = \"{cluster=\\\"ops-tools1\\\", job=\\\"loki-ops/query-frontend\\\"} |= \\\"query_range\\\"\" query_type = filter range_type = range length = 15m0s step = 7s duration = 624 .008132ms status = 200 throughput_mb = 0 .693449 total_bytes_mb = 0 .432718 \u7d50\u679c\u5c07\u662f\uff1a 2020 -10-23T20:32:18.094668233Z 650 .22401ms traceID = 1980d41501b57b68 { cluster = \"ops-tools1\" , job = \"loki-ops/query-frontend\" } | = \"query_range\" 2020 -10-23T20:32:18.068866235Z 624 .008132ms traceID = 1980d41501b57b68 { cluster = \"ops-tools1\" , job = \"loki-ops/query-frontend\" } | = \"query_range\"","title":"Formatting"},{"location":"kubernetes/observability/logging/loki/loki-ql/#metric-query","text":"\u5ea6\u91cf\u67e5\u8a62\u901a\u904e\u61c9\u7528\u51fd\u6578\u4f86\u8a18\u9304\u67e5\u8a62\u7d50\u679c\u4f86\u64f4\u5c55\u65e5\u8a8c\u67e5\u8a62\u3002\u9019\u500b\u5f37\u5927\u7684\u529f\u80fd\u5f9e\u65e5\u8a8c\u4e2d\u5275\u5efa\u6307\u6a19\u3002 \u6307\u6a19\u67e5\u8a62\u53ef\u7528\u65bc\u8a08\u7b97\u932f\u8aa4\u6d88\u606f\u7387\u6216\u6700\u8fd1 3 \u5c0f\u6642\u5167\u65e5\u8a8c\u6578\u91cf\u6700\u591a\u7684\u524d N \u200b\u200b\u500b\u65e5\u8a8c\u6e90\u3002 \u8207\u89e3\u6790\u5668\u76f8\u7d50\u5408\uff0c\u5ea6\u91cf\u67e5\u8a62\u9084\u53ef\u7528\u65bc\u5f9e\u65e5\u8a8c\u884c\u4e2d\u7684\u6a23\u672c\u503c\u8a08\u7b97\u5ea6\u91cf\uff0c\u4f8b\u5982\u5ef6\u9072\u6216\u8acb\u6c42\u5927\u5c0f\u3002\u6240\u6709\u6a19\u7c64\uff0c\u5305\u62ec\u63d0\u53d6\u7684\u6a19\u7c64\uff0c\u90fd\u53ef\u7528\u65bc\u805a\u5408\u548c\u751f\u6210\u65b0\u7cfb\u5217\u3002","title":"Metric query"},{"location":"kubernetes/observability/logging/loki/loki-ql/#range-vector-aggregation","text":"LogQL \u5b78\u7fd2\u4e86 Prometheus \u7684\u7bc4\u570d\u5411\u91cf\u6982\u5ff5\u3002\u5728 Grafana Loki \u4e2d\uff0c\u6240\u9078\u6a23\u672c\u7bc4\u570d\u662f\u6240\u9078\u5c0d\u6578\u6216\u6a19\u7c64\u503c\u7684\u7bc4\u570d\u3002 \u5728\u4e00\u6bb5\u6642\u9593\u5167\u61c9\u7528\u805a\u5408\u3002 Loki \u4f7f\u7528\u8207 Prometheus \u76f8\u540c\u7684\u8a9e\u6cd5\u5b9a\u7fa9 Time Duration\u3002 Loki \u652f\u6301\u5169\u7a2e\u985e\u578b\u7684\u7bc4\u570d\u5411\u91cf\u805a\u5408\uff1a\u65e5\u8a8c\u7bc4\u570d\u805a\u5408\u548c\u5c55\u958b\u7bc4\u570d\u805a\u5408\u3002","title":"Range Vector aggregation"},{"location":"kubernetes/observability/logging/loki/loki-ql/#log-range-aggregations","text":"\u65e5\u8a8c\u7bc4\u570d\u805a\u5408\u662f\u4e00\u500b\u67e5\u8a62\uff0c\u5f8c\u7db4\u5b9a\u7fa9\u4e86\u4e00\u500b\u6301\u7e8c\u6642\u9593\u3002\u61c9\u7528\u4e00\u500b\u51fd\u6578\u5728\u6301\u7e8c\u6642\u9593\u5167\u805a\u5408\u67e5\u8a62\u3002\u6301\u7e8c\u6642\u9593\u53ef\u4ee5\u653e\u5728\u65e5\u8a8c\u6d41\u9078\u64c7\u5668\u4e4b\u5f8c\u6216\u65e5\u8a8c\u7ba1\u9053\u7684\u672b\u5c3e\u3002 \u805a\u5408\u51fd\u6578\uff1a rate(log-range) : \u8a08\u7b97\u6bcf\u79d2\u7684\u65e5\u8a8c\u689d\u76ee count_over_time(log-range) : \u5c0d\u6307\u5b9a\u7bc4\u570d\u5167\u7684\u6bcf\u500b\u65e5\u8a8c\u6d41\u7684\u689d\u76ee\u9032\u884c\u8a08\u6578 bytes_rate(log-range) : \u8a08\u7b97\u65e5\u8a8c\u6d41\u6bcf\u79d2\u7684\u5b57\u7bc0\u6578 bytes_over_time(log-range) : \u5c0d\u6307\u5b9a\u7bc4\u570d\u5167\u7684\u6bcf\u500b\u65e5\u8a8c\u6d41\u7684\u4f7f\u7528\u7684\u5b57\u7bc0\u6578 absent_over_time(log-range) : \u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6709\u4efb\u4f55\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u7a7a\u5411\u91cf\uff1b\u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6c92\u6709\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u503c\u70ba 1 \u7684 1 \u5143\u7d20\u5411\u91cf\u3002 \uff08absent_over_time \u5c0d\u65bc\u5728\u4e00\u6bb5\u6642\u9593\u5167\u4e0d\u5b58\u5728\u6a19\u7c64\u7d44\u5408\u7684\u6642\u9593\u5e8f\u5217\u548c\u65e5\u8a8c\u6d41\u6642\u767c\u51fa\u8b66\u5831\u5f88\u6709\u7528\u3002\uff09 \u4f8b\u5b50\uff1a \u8a08\u7b97 MySQL job\u6700\u5f8c\u4e94\u5206\u9418\u5167\u7684\u6240\u6709\u65e5\u8a8c\u884c\u8a08\u6578\u3002 count_over_time ({ job = \"mysql\" }[ 5m ]) \u6b64\u805a\u5408\u5305\u62ec\u904e\u6ffe\u5668\u548c\u89e3\u6790\u5668\u3002\u5b83\u8fd4\u56de MySQL job\u5728\u6bcf\u53f0\u4e3b\u6a5f\u7684\u6700\u5f8c\u5e7e\u5206\u9418\u5167\u6240\u6709\u975e\u8d85\u6642\u932f\u8aa4\u7684\u6bcf\u79d2\u901f\u7387\uff0c\u4e26\u4e14\u50c5\u5305\u62ec\u6301\u7e8c\u6642\u9593\u8d85\u904e 10 \u79d2\u7684\u932f\u8aa4\u3002 sum by ( host ) ( rate ({ job = \"mysql\" } | = \"error\" ! = \"timeout\" | json | duration > 10s [ 1m ]))","title":"Log range aggregations"},{"location":"kubernetes/observability/logging/loki/loki-ql/#unwrapped-range-aggregations","text":"Unwrapped\u7684\u7bc4\u570d\u4f7f\u7528\u63d0\u53d6\u7684 \u6a19\u7c64(label) \u4f86\u4f5c\u70ba\u6a23\u672c\u503c\u800c\u4e0d\u662f \u65e5\u8a8c\u884c(log line) \u3002\u4f46\u662f\uff0c\u8981\u9078\u64c7\u5728\u805a\u5408\u4e2d\u4f7f\u7528\u54ea\u500b\u6a19\u7c64\uff0c\u65e5\u8a8c\u67e5\u8a62\u5fc5\u9808\u4ee5\u5c55\u958b\u8868\u9054\u5f0f\u548c\u53ef\u9078\u7684\u6a19\u7c64\u904e\u6ffe\u5668\u8868\u9054\u5f0f\u7d50\u5c3e\u4ee5\u4e1f\u68c4\u932f\u8aa4\u3002 \u8a3b\u91cb\u89e3\u5305\u8868\u9054\u5f0f | unwrap label_identifier \u5176\u4e2d\u6a19\u7c64\u6a19\u8b58\u7b26\u662f\u7528\u65bc\u63d0\u53d6\u6a23\u672c\u503c\u7684\u6a19\u7c64\u540d\u7a31\u3002 \u7531\u65bc\u6a19\u7c64\u503c\u662f\u5b57\u7b26\u4e32\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u5c07\u5617\u8a66\u8f49\u63db\u70ba\u6d6e\u9ede\u6578\uff0864 \u4f4d\uff09\uff0c\u5982\u679c\u5931\u6557\uff0c\u5247\u5c07 error \u6a19\u7c64\u6dfb\u52a0\u5230\u6a23\u672c\u4e2d\u3002\u53ef\u9078\u5730\uff0c\u6a19\u7c64\u6a19\u8b58\u7b26\u53ef\u4ee5\u7531\u8f49\u63db\u51fd\u6578\u5305\u88f9 | unwrap <function>(label_identifier) \uff0c\u5b83\u5c07\u5617\u8a66\u5c07\u6a19\u7c64\u503c\u5f9e\u7279\u5b9a\u683c\u5f0f\u8f49\u63db\u3002 Loki \u76ee\u524d\u652f\u6301\u7684\u4e0b\u5217\u8f49\u63db\u51fd\u6578\uff1a duration_seconds(label_identifier) (\u6216\u662f duration\uff08label_identifier) ) \u5b83\u5c07\u4ee5\u79d2\u70ba\u55ae\u4f4d\u5f9e go duration \u683c\u5f0f\u8f49\u63db\u6a19\u7c64\u503c\u3002 bytes(label_identifier) \u9019\u6703\u5c07\u6a19\u7c64\u503c\u8f49\u63db\u70ba\u61c9\u7528\u5b57\u7bc0\u55ae\u4f4d\u7684\u539f\u59cb\u5b57\u7bc0\uff08\u4f8b\u5982 5 MiB\u30013k\u30011G\uff09\u3002 \u652f\u6301 Unwrapped \u7bc4\u570d\u5167\u64cd\u4f5c\u7684\u51fd\u6578\u6709\uff1a rate(unwrapped-range) : \u8a08\u7b97\u6307\u5b9a\u6642\u9593\u9593\u9694\u5167\u6240\u6709\u503c\u4e4b\u548c\u7684\u6bcf\u79d2\u901f\u7387\u3002 rate_counter(unwrapped-range) : \u8a08\u7b97\u6307\u5b9a\u9593\u9694\u5167\u7684\u503c\u7684\u6bcf\u79d2\u901f\u7387\uff0c\u4e26\u5c07\u5b83\u5011\u8996\u70ba\u201c\u8a08\u6578\u5668\u5ea6\u91cf\u201d sum_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u503c\u7684\u7e3d\u548c\u3002 avg_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u5e73\u5747\u503c\u3002 max_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u6700\u5927\u503c\u3002 min_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u6700\u5c0f\u503c first_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u7b2c\u4e00\u500b\u503c last_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u6240\u6709\u9ede\u7684\u6700\u5f8c\u4e00\u500b\u503c stdvar_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u65b9\u5dee\u3002 stddev_over_time(unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u5dee\u3002 quantile_over_time(scalar,unwrapped-range) : \u6307\u5b9a\u5340\u9593\u5167\u7684\u503c\u7684 \u03c6 \u5206\u4f4d\u6578 (0 \u2264 \u03c6 \u2264 1)\u3002 absent_over_time(unwrapped-range) : \u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6709\u4efb\u4f55\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u7a7a\u5411\u91cf\uff1b\u5982\u679c\u50b3\u905e\u7d66\u5b83\u7684\u7bc4\u570d\u5411\u91cf\u6c92\u6709\u5143\u7d20\uff0c\u5247\u8fd4\u56de\u4e00\u500b\u503c\u70ba 1 \u7684 1 \u5143\u7d20\u5411\u91cf\u3002 \uff08absent_over_time \u5c0d\u65bc\u5728\u4e00\u6bb5\u6642\u9593\u5167\u4e0d\u5b58\u5728\u6a19\u7c64\u7d44\u5408\u7684\u6642\u9593\u5e8f\u5217\u548c\u65e5\u8a8c\u6d41\u6642\u767c\u51fa\u8b66\u5831\u5f88\u6709\u7528\u3002\uff09 \u9664\u4e86 sum_over_time \u3001 absent_over_time \u548c rate \uff0c\u5c55\u958b\u7684\u7bc4\u570d\u805a\u5408\u652f\u6301\u5206\u7d44\u3002 <aggr-op> ([ parameter, ] <unwrapped-range> ) [ without | by ( <label list> )] \u901a\u904e\u5305\u542b without \u6216 by \u5b50\u53e5\uff0c\u53ef\u7528\u65bc\u805a\u5408\u4e0d\u540c\u7684\u6a19\u7c64\u7dad\u5ea6\u3002 without \u5f9e\u7d50\u679c\u5411\u91cf\u4e2d\u522a\u9664\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u800c\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u90fd\u4fdd\u7559\u8f38\u51fa\u3002 by \u57f7\u884c\u76f8\u53cd\u7684\u64cd\u4f5c\u4e26\u522a\u9664\u672a\u5728 by \u5b50\u53e5\u4e2d\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u5373\u4f7f\u5b83\u5011\u7684\u6a19\u7c64\u503c\u5728\u5411\u91cf\u7684\u6240\u6709\u5143\u7d20\u4e4b\u9593\u662f\u76f8\u540c\u7684\u3002 Unwrapped \u7bc4\u4f8b : quantile_over_time ( 0 .99, # \u5b9a\u7fa9\u8981\u8a08\u7b97\u7684\u5206\u4f4d\u6578 { cluster = \"ops-tools1\" ,container = \"ingress-nginx\" } \u3000 # \u9078\u64c7\u7279\u5b9a\u7684 lost stream | json # \u4f7f\u7528 JSON \u4f86\u89e3\u6790\u4e26\u64f7\u53d6 label | __error__ = \"\" # \u53bb\u9664\u89e3\u6790\u6709\u554f\u984c\u7684\u65e5\u8a8c\u884c | unwrap request_time [ 1m ]) by ( path ) \u3000 # \u4f7f\u7528 \"requet_time\" \u7684\u6a19\u7c64\u503c\u4f86\u8a08\u7b97\u4e26\u4e14\u4f7f\u7528 path \u6a19\u7c64\u503c\u4f86\u5206\u7d44 \u6b64\u793a\u4f8b\u6309\u8def\u5f91\u8a08\u7b97 nginx-ingress \u5ef6\u9072\u7684 p99 \u56de\u61c9\u6642\u9593\u3002 sum by ( org_id ) ( sum_over_time ( { cluster = \"ops-tools1\" ,container = \"loki-dev\" } | = \"metrics.go\" | logfmt | unwrap bytes_processed [ 1m ]) ) \u9019\u5c07\u8a08\u7b97\u6bcf\u500b\u7d44\u7e54 ID \u8655\u7406\u7684\u5b57\u7bc0\u6578\u3002","title":"Unwrapped range aggregations"},{"location":"kubernetes/observability/logging/loki/loki-ql/#built-in-aggregation-operators","text":"\u8207 PromQL \u4e00\u6a23\uff0cLogQL \u652f\u6301\u5167\u7f6e\u805a\u5408\u904b\u7b97\u7b26\u7684\u5b50\u96c6\uff0c\u53ef\u7528\u65bc\u805a\u5408\u55ae\u500b\u5411\u91cf\u7684\u5143\u7d20\uff0c\u5f9e\u800c\u751f\u6210\u5305\u542b\u66f4\u5c11\u5143\u7d20\u4f46\u5177\u6709\u805a\u5408\u503c\u7684\u65b0\u5411\u91cf\uff1a sum : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u7e3d\u548c avg : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u5e73\u5747\u503c min : \u9078\u64c7\u6a19\u7c64\u503c\u7684\u6700\u5c0f\u503c max : \u9078\u64c7\u6a19\u7c64\u503c\u7684\u6700\u5927\u503c stddev : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u5dee stdvar : \u8a08\u7b97\u6a19\u7c64\u503c\u7684\u7e3d\u9ad4\u6a19\u6e96\u65b9\u5dee count : \u8a08\u7b97\u5411\u91cf\u4e2d\u7684\u5143\u7d20\u500b\u6578 topk : \u6309\u6a23\u672c\u6a19\u7c64\u503c\u9078\u64c7\u6700\u5927\u7684 k \u500b\u5143\u7d20 bottomk : \u6309\u6a23\u672c\u6a19\u7c64\u503c\u9078\u64c7\u6700\u5c0f\u7684 k \u500b\u5143\u7d20 \u805a\u5408\u904b\u7b97\u7b26\u53ef\u7528\u65bc\u805a\u5408\u6240\u6709\u6a19\u7c64\u503c\u6216\u4e00\u7d44\u4e0d\u540c\u7684\u6a19\u7c64\u503c\uff0c\u65b9\u6cd5\u662f\u5305\u542b without \u6216 by \u5b50\u53e5\uff1a <aggr-op> ([ parameter, ] <vector expression> ) [ without | by ( <label list> )] \u4f7f\u7528 topk \u548c bottomk \u6642\u9700\u8981\u5b9a\u7fa9\u53c3\u6578(parameter)\u3002 topk \u548c bottomk \u8207\u5176\u4ed6\u805a\u5408\u5668\u7684\u4e0d\u540c\u4e4b\u8655\u5728\u65bc\uff0c\u8f38\u5165\u6a23\u672c\u7684\u5b50\u96c6\uff08\u5305\u62ec\u539f\u59cb\u6a19\u7c64\uff09\u5728\u7d50\u679c\u5411\u91cf\u4e2d\u8fd4\u56de\u3002 by \u548c without \u50c5\u7528\u65bc\u5c0d\u8f38\u5165\u5411\u91cf\u9032\u884c\u5206\u7d44\u3002 without \u5b50\u53e5\u5f9e\u7d50\u679c\u5411\u91cf\u4e2d\u522a\u9664\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u4fdd\u7559\u6240\u6709\u5176\u4ed6\u6a19\u7c64\u3002 by \u5b50\u53e5\u76f8\u53cd\uff0c\u522a\u9664\u5b50\u53e5\u4e2d\u672a\u5217\u51fa\u7684\u6a19\u7c64\uff0c\u5373\u4f7f\u5b83\u5011\u7684\u6a19\u7c64\u503c\u5728\u5411\u91cf\u7684\u6240\u6709\u5143\u7d20\u4e4b\u9593\u662f\u76f8\u540c\u7684\u3002 Vector aggregation \u7bc4\u4f8b : \u7372\u53d6\u65e5\u8a8c\u541e\u5410\u91cf\u6700\u9ad8\u7684\u524d 10 \u500b\u61c9\u7528\u7a0b\u5e8f\uff1a topk ( 10 ,sum ( rate ({ region = \"us-east1\" }[ 5m ])) by ( name )) \u7372\u53d6\u6307\u5b9a\u4f5c\u696d\u7684\u6700\u5f8c\u4e94\u5206\u9418\u7684\u65e5\u8a8c\u884c\u6578\uff0c\u6309\u7d1a\u5225\u5206\u7d44\uff1a sum ( count_over_time ({ job = \"mysql\" }[ 5m ])) by ( level ) \u6309\u5340\u57df\u7372\u53d6 NGINX \u65e5\u8a8c\u7684 /home \u7aef\u9ede\u7684 HTTP GET \u8acb\u6c42\u901f\u7387\uff1a avg ( rate (({ job = \"nginx\" } | = \"GET\" | json | path = \"/home\" )[ 10s ])) by ( region )","title":"Built-in aggregation operators"},{"location":"kubernetes/observability/logging/loki/loki-ql/#binary-operators","text":"","title":"Binary operators"},{"location":"kubernetes/observability/logging/loki/loki-ql/#arithmetic-operators","text":"Loki \u4e2d\u5b58\u5728\u4ee5\u4e0b\u4e8c\u5143\u7b97\u8853\u904b\u7b97\u7b26\uff1a + \u52a0\u6cd5 - \u6e1b\u6cd5 * \u4e58\u6cd5 / \u9664\u6cd5 % \u6c42\u6a21 ^ \u6c42\u51aa \u4e8c\u9032\u5236\u7b97\u8853\u904b\u7b97\u7b26\u5b9a\u7fa9\u5728\u5169\u500b\u6587\u5b57\uff08\u6a19\u91cf\uff09\u3001\u4e00\u500b\u6587\u5b57\u548c\u4e00\u500b\u5411\u91cf\u4ee5\u53ca\u5169\u500b\u5411\u91cf\u4e4b\u9593\u3002 \u5728\u5169\u500b\u6587\u5b57\u4e4b\u9593\uff0c\u884c\u70ba\u662f\u986f\u800c\u6613\u898b\u7684\uff1a\u5b83\u5011\u8a55\u4f30\u53e6\u4e00\u500b\u6587\u5b57\uff0c\u9019\u662f\u61c9\u7528\u65bc\u5169\u500b\u6a19\u91cf\u64cd\u4f5c\u6578 (1 + 1 = 2) \u7684\u904b\u7b97\u7b26\u7684\u7d50\u679c\u3002 \u5728\u5411\u91cf\u548c\u6587\u5b57\u4e4b\u9593\uff0c\u904b\u7b97\u7b26\u61c9\u7528\u65bc\u5411\u91cf\u4e2d\u6bcf\u500b\u6578\u64da\u6a23\u672c\u7684\u503c\uff0c\u4f8b\u5982\u5982\u679c\u6642\u9593\u5e8f\u5217\u5411\u91cf\u4e58\u4ee5 2\uff0c\u5247\u7d50\u679c\u662f\u53e6\u4e00\u500b\u5411\u91cf\uff0c\u5176\u4e2d\u539f\u59cb\u5411\u91cf\u7684\u6bcf\u500b\u6a23\u672c\u503c\u90fd\u4e58\u4ee5 2\u3002 \u5728\u5169\u500b\u5411\u91cf\u4e4b\u9593\uff0c\u4e8c\u9032\u5236\u7b97\u8853\u904b\u7b97\u7b26\u61c9\u7528\u65bc\u5de6\u5074\u5411\u91cf\u4e2d\u7684\u6bcf\u500b\u689d\u76ee\u53ca\u5176\u53f3\u5074\u5411\u91cf\u4e2d\u7684\u5339\u914d\u5143\u7d20\u3002\u7d50\u679c\u50b3\u64ad\u5230\u7d50\u679c\u5411\u91cf\u4e2d\uff0c\u5206\u7d44\u6a19\u7c64\u6210\u70ba\u8f38\u51fa\u6a19\u7c64\u96c6\u3002\u5728\u53f3\u5074\u5411\u91cf\u4e2d\u627e\u4e0d\u5230\u5339\u914d\u689d\u76ee\u7684\u689d\u76ee\u4e0d\u5c6c\u65bc\u7d50\u679c\u3002 \u93c8\u63a5\u7b97\u8853\u904b\u7b97\u7b26\u6642\u8981\u7279\u5225\u6ce8\u610f \u904b\u7b97\u7b26\u9806\u5e8f \u3002","title":"Arithmetic operators"},{"location":"kubernetes/observability/logging/loki/loki-ql/#arithmetic","text":"\u5c07\u65e5\u8a8c\u6d41\u689d\u76ee\u7684\u901f\u7387\u52a0\u500d\uff1a sum ( rate ({ app = \"foo\" }[ 1m ])) * 2 \u7372\u53d6 foo \u61c9\u7528\u7a0b\u5e8f\u7684\u8b66\u544a\u65e5\u8a8c\u8207\u932f\u8aa4\u65e5\u8a8c\u7684\u6bd4\u4f8b sum ( rate ({ app = \"foo\" , level = \"warn\" }[ 1m ])) / sum ( rate ({ app = \"foo\" , level = \"error\" }[ 1m ]))","title":"Arithmetic \u7bc4\u4f8b"},{"location":"kubernetes/observability/logging/loki/loki-ql/#logical-and-set-operators","text":"\u96c6\u5408\u904b\u7b97\u50c5\u5728\u5340\u9593\u5411\u91cf\u7bc4\u570d\u5167\u6709\u6548\uff0c\u7576\u524d\u652f\u6301\uff1a and \u4ea4\u96c6 - vector1 \u548c vector2 \u7522\u751f\u4e00\u500b\u7531 vector1 \u7684\u5143\u7d20\u7d44\u6210\u7684\u5411\u91cf\uff0c\u5176\u4e2d vector2 \u4e2d\u7684\u5143\u7d20\u5177\u6709\u5b8c\u5168\u5339\u914d\u7684\u6a19\u7c64\u96c6\u3002\u5176\u4ed6\u5143\u7d20\u88ab\u4e1f\u68c4\u3002 or \u806f\u96c6 - vector1 \u6216 vector2 \u751f\u6210\u4e00\u500b\u5411\u91cf\uff0c\u8a72\u5411\u91cf\u5305\u542b vector1 \u7684\u6240\u6709\u539f\u59cb\u5143\u7d20\uff08\u6a19\u7c64\u96c6 + \u503c\uff09\uff0c\u4ee5\u53ca vector2 \u4e2d\u5728 vector1 \u4e2d\u6c92\u6709\u5339\u914d\u6a19\u7c64\u96c6\u7684\u6240\u6709\u5143\u7d20\u3002 unless \u88dc\u5145 - vector1 \u9664\u975e vector2 \u7522\u751f\u4e00\u500b\u7531 vector1 \u7684\u5143\u7d20\u7d44\u6210\u7684\u5411\u91cf\uff0c\u5c0d\u65bc\u9019\u4e9b\u5143\u7d20\uff0cvector2 \u4e2d\u6c92\u6709\u8207\u6a19\u7c64\u96c6\u5b8c\u5168\u5339\u914d\u7684\u5143\u7d20\u3002\u5169\u500b\u5411\u91cf\u4e2d\u7684\u6240\u6709\u5339\u914d\u5143\u7d20\u90fd\u88ab\u522a\u9664\u3002","title":"Logical and set operators"},{"location":"kubernetes/observability/logging/loki/loki-ql/#binary-operators_1","text":"\u4e0b\u5217\u7684\u67e5\u8a62\u5c07\u8fd4\u56de\u9019\u4e9b\u67e5\u8a62\u7684\u4ea4\u96c6, \u7b49\u540c\u3000 rate({app=\"bar\"}) \uff1a rate ({ app = ~ \"foo|bar\" }[ 1m ]) and rate ({ app = \"bar\" }[ 1m ])","title":"Binary operators \u7bc4\u4f8b"},{"location":"kubernetes/observability/logging/loki/loki-ql/#comparison-operators","text":"== \u7b49\u65bc != \u4e0d\u7b49\u65bc > \u5927\u65bc >= \u5927\u65bc\u6216\u7b49\u65bc < \u5c0f\u65bc <= \u5c0f\u65bc\u6216\u7b49\u65bc \u6bd4\u8f03\u904b\u7b97\u7b26\u5728\u6a19\u91cf/\u6a19\u91cf\u3001\u5411\u91cf/\u6a19\u91cf\u548c\u5411\u91cf/\u5411\u91cf\u503c\u5c0d\u4e4b\u9593\u5b9a\u7fa9\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u5b83\u5011\u6703\u904e\u6ffe\u3002\u5b83\u5011\u7684\u884c\u70ba\u53ef\u4ee5\u901a\u904e\u5728\u904b\u7b97\u7b26\u5f8c\u63d0\u4f9b bool \u4f86\u4fee\u6539\uff0c\u5b83\u5c07\u8fd4\u56de 0 \u6216 1 \u4f5c\u70ba\u503c\u800c\u4e0d\u662f\u904e\u6ffe\u3002 \u5728\u5169\u500b\u6a19\u91cf\u4e4b\u9593\uff0c\u9019\u4e9b\u904b\u7b97\u7b26\u6703\u7522\u751f\u53e6\u4e00\u500b\u6a19\u91cf\uff0c\u5373 0\uff08\u5047\uff09\u6216 1\uff08\u771f\uff09\uff0c\u5177\u9ad4\u53d6\u6c7a\u65bc\u6bd4\u8f03\u7d50\u679c\u3002\u4e0d\u5f97\u63d0\u4f9b bool \u4fee\u98fe\u7b26\u3002 \u5728\u5411\u91cf\u548c\u6a19\u91cf\u4e4b\u9593\uff0c\u9019\u4e9b\u904b\u7b97\u7b26\u61c9\u7528\u65bc\u5411\u91cf\u4e2d\u6bcf\u500b\u6578\u64da\u6a23\u672c\u7684\u503c\uff0c\u4e26\u4e14\u6bd4\u8f03\u7d50\u679c\u70ba\u5047\u7684\u5411\u91cf\u5143\u7d20\u5f9e\u7d50\u679c\u5411\u91cf\u4e2d\u522a\u9664\u3002\u5982\u679c\u63d0\u4f9b\u4e86 bool \u4fee\u98fe\u7b26\uff0c\u5247\u5c07\u88ab\u522a\u9664\u7684\u5411\u91cf\u5143\u7d20\u7684\u503c\u70ba 0\uff0c\u800c\u5c07\u4fdd\u7559\u7684\u5411\u91cf\u5143\u7d20\u7684\u503c\u70ba 1\u3002","title":"Comparison operators"},{"location":"kubernetes/observability/logging/loki/loki-ql/#_1","text":"LogQL \u67e5\u8a62\u53ef\u4ee5\u4f7f\u7528 # \u5b57\u7b26\u9032\u884c\u8a3b\u91cb\uff1a { app = \"foo\" } # anything that comes after will not be interpreted in your query \u4f7f\u7528\u591a\u884c LogQL \u67e5\u8a62\uff0c\u67e5\u8a62\u89e3\u6790\u5668\u53ef\u4ee5\u4f7f\u7528 # \u6392\u9664\u6574\u884c\u6216\u90e8\u4efd\u884c\uff1a { app = \"foo\" } | json # this line will be ignored | bar = \"baz\" # this checks if bar = \"baz\"","title":"\u8a3b\u91cb"},{"location":"kubernetes/observability/logging/loki/loki-ql/#pipeline","text":"\u5c0e\u81f4\u7ba1\u9053\u8655\u7406\u932f\u8aa4\u7684\u539f\u56e0\u6709\u591a\u7a2e\uff0c\u4f8b\u5982\uff1a \u6578\u5b57\u6a19\u7c64\u904e\u6ffe\u5668\u53ef\u80fd\u7121\u6cd5\u5c07\u6a19\u7c64\u503c\u8f49\u63db\u70ba\u6578\u5b57 \u6a19\u7c64\u7684\u5ea6\u91cf\u8f49\u63db\u53ef\u80fd\u6703\u5931\u6557\u3002 \u65e5\u8a8c\u884c\u4e0d\u662f\u6709\u6548\u7684 json \u6587\u6a94\u3002 ETC\u2026 \u7576\u9019\u4e9b\u6545\u969c\u767c\u751f\u6642\uff0cLoki \u4e0d\u6703\u904e\u6ffe\u6389\u90a3\u4e9b\u65e5\u8a8c\u884c\u3002\u76f8\u53cd\uff0c\u5b83\u5011\u88ab\u50b3\u905e\u5230\u7ba1\u9053\u7684\u4e0b\u4e00\u500b\u968e\u6bb5\uff0c\u4e26\u5e36\u6709\u4e00\u500b\u540d\u70ba __error__ \u7684\u65b0\u7cfb\u7d71\u6a19\u7c64\u3002\u904e\u6ffe\u932f\u8aa4\u7684\u552f\u4e00\u65b9\u6cd5\u662f\u4f7f\u7528\u6a19\u7c64\u904e\u6ffe\u5668\u8868\u9054\u5f0f\u3002 __error__ \u6a19\u7c64\u4e0d\u80fd\u901a\u904e\u8a9e\u8a00\u91cd\u547d\u540d\u3002 \u4f8b\u5982\u8981\u522a\u9664 json \u932f\u8aa4\uff1a log ql { cluster = \"ops-tools1\" ,container = \"ingress-nginx\" } | json | __error__ ! = \"JSONParserErr\" \u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6355\u7372\u6240\u6709\u5339\u914d\u5668\uff08\u4f8b\u5982 __error__ = \"\" \uff09\u522a\u9664\u6240\u6709\u932f\u8aa4\uff0c\u751a\u81f3\u4f7f\u7528 __error__ != \"\" \u50c5\u986f\u793a\u932f\u8aa4\u3002 \u904e\u6ffe\u5668\u61c9\u653e\u7f6e\u5728\u7522\u751f\u6b64\u932f\u8aa4\u7684\u968e\u6bb5\u4e4b\u5f8c\u3002\u9019\u610f\u5473\u8457\u5982\u679c\u60a8\u9700\u8981\u5f9e\u5c55\u958b\u8868\u9054\u5f0f\u4e2d\u522a\u9664\u932f\u8aa4\uff0c\u5247\u9700\u8981\u5c07\u5176\u653e\u5728\u5c55\u958b\u4e4b\u5f8c\u3002 log ql quantile_over_time ( 0 .99, { container = \"ingress-nginx\" ,service = \"hosted-grafana\" } | json | unwrap response_latency_seconds | __error__ = \"\" [ 1m ] ) by ( cluster ) Info \u6307\u6a19\u67e5\u8a62\u4e0d\u80fd\u5305\u542b\u932f\u8aa4\uff0c\u5982\u679c\u5728\u57f7\u884c\u904e\u7a0b\u4e2d\u767c\u73fe\u932f\u8aa4\uff0cLoki \u5c07\u8fd4\u56de\u932f\u8aa4\u548c\u76f8\u61c9\u7684\u72c0\u614b\u78bc\u3002","title":"Pipeline \u932f\u8aa4"},{"location":"kubernetes/observability/logging/loki/loki-ql/#_2","text":"\u9019\u88e1\u90e8\u7f72\u6211\u5011\u7684\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u6d88\u606f\u61c9\u7528\u7684\u793a\u4f8b\uff0c\u8a72\u61c9\u7528\u7a0b\u5e8f\u662f\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\u7684\u6d88\u606f\uff0c\u5b83\u7684\u65e5\u8a8c\u5305\u542b\u8abf\u8a66\u3001\u4fe1\u606f\u548c\u8b66\u544a\u8f38\u51fa\u5230\u6a19\u6e96\u8f38\u51fa\u3002\u932f\u8aa4\u7b49\u7d1a\u7684\u5c07\u88ab\u5beb\u5165\u6a19\u6e96\u8f38\u51fa\uff0c\u5be6\u969b\u7684\u65e5\u8a8c\u4ee5 JSON \u683c\u5f0f\u751f\u6210\uff0c\u6bcf\u500b500 \u689d\u65e5\u8a8c\u5c07\u5275\u5efa\u4e00\u689d\u65b0\u6d88\u606f\u7684\u6d88\u606f\u3002 \u65e5\u8a8c\u683c\u5f0f\u5982\u4e0b\uff1a { \"app\" : \"The fanciest app of mankind\" , \"executable\" : \"fake-logger\" , \"is_even\" : true , \"level\" : \"debug\" , \"msg\" : \"This is a debug message. Hope you'll catch the bug\" , \"time\" : \"2022-04-04T13:41:50+02:00\" , \"version\" : \"1.0.0\" } \u4f7f\u7528\u4e0b\u9762\u7684\u547d\u4ee4\u4f86\u5275\u5efa\u793a\u4f8b\u61c9\u7528\uff1a cat <<EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: labels: app: fake-logger environment: development name: fake-logger spec: selector: matchLabels: app: fake-logger environment: development template: metadata: labels: app: fake-logger environment: development spec: containers: - image: thorstenhans/fake-logger:0.0.2 name: fake-logger resources: requests: cpu: 10m memory: 32Mi limits: cpu: 10m memory: 32Mi EOF \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 {app=\"fake-logger\"} \u5728 Grafana \u4e2d\u67e5\u8a62\u5230\u8a72\u61c9\u7528\u7684\u65e5\u8a8c\u6d41\u6578\u64da\u3002 \u7531\u65bc\u6211\u5011\u8a72\u793a\u4f8b\u61c9\u7528\u7684\u65e5\u8a8c\u662f JSON \u5f62\u5f0f\u7684\uff0c\u6211\u5011\u53ef\u4ee5\u63a1\u7528 JSON \u89e3\u6790\u5668\u4f86\u89e3\u6790\u65e5\u8a8c\uff0c\u8868\u9054\u5f0f\u7232 {app=\"fake-logger\"} | json \uff0c\u5982\u4e0b\u6240\u793a\u3002 \u4f7f\u7528 JSON \u89e3\u6790\u5668\u89e3\u6790\u65e5\u8a8c\u5f8c\u53ef\u4ee5\u770b\u5230 Grafana \u63d0\u4f9b\u7684\u9762\u677f\u6703\u6839\u64da level \u7684\u503c\u4f7f\u7528\u4e0d\u540c\u7684\u984f\u8272\u9032\u884c\u5340\u5206\uff0c\u800c\u4e14\u73fe\u5728\u6211\u5011\u65e5\u8a8c\u7684\u5c6c\u6027\u4e5f\u88ab\u6dfb\u52a0\u5230\u4e86 Log \u7684\u6a19\u7c64\u4e2d\u53bb\u4e86\u3002 \u73fe\u5728 JSON \u4e2d\u7684\u6578\u64da\u8b8a\u6210\u4e86\u65e5\u8a8c\u6a19\u7c64\u6211\u5011\u81ea\u7136\u5c31\u53ef\u4ee5\u4f7f\u7528\u9019\u4e9b\u6a19\u7c64\u4f86\u904e\u6ffe\u65e5\u8a8c\u6578\u64da\u4e86\uff0c\u6bd4\u5982\u6211\u5011\u8981\u904e\u6ffe level=error \u7684\u65e5\u8a8c\uff0c\u53ea\u4f7f\u7528\u8868\u9054\u5f0f {app=\"fake-logger\"} | json | level=\"error\" \u5373\u53ef\u5be6\u73fe\u3002 \u6b64\u5916\u6211\u5011\u9084\u53ef\u4ee5\u6839\u64da\u6211\u5011\u7684\u9700\u6c42\u53bb\u683c\u5f0f\u5316\u8f38\u51fa\u65e5\u8a8c\uff0c\u4f7f\u7528 line_format \u5373\u53ef\u5be6\u73fe\uff0c\u6bd4\u5982\u6211\u5011\u9019\u88cf\u4f7f\u7528\u67e5\u8a62\u8a9e\u53e5 `{app=\"fake-logger\"} | json |is_even=\"true\" | line_format \"\u5728 {{.time}} \u65bc {{.level}}@{{.pod}} Pod\u4e2d\u7522\u751f\u4e86\u65e5\u8a8c {{.msg}}\" \u4f86\u683c\u5f0f\u5316\u65e5\u8a8c\u8f38\u51fa\u3002","title":"\u67e5\u8a62\u793a\u4f8b"},{"location":"kubernetes/observability/logging/operator/logging-operator-extensions/","text":"Logging Operator \u7684\u64f4\u5c55 \u00b6 \u539f\u6587: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/extensions/ \u65e5\u8a8c\u64f4\u5c55\u662f\u5c08\u9580\u70ba\u89e3\u6c7a\u7528\u6236\u7684\u554f\u984c\u800c\u958b\u767c\u7684\uff1a \u6536\u96c6 Kubernetes \u4e8b\u4ef6\u4ee5\u6df1\u5165\u4e86\u89e3\u96c6\u7fa4\u5167\u90e8\u6b63\u5728\u767c\u751f\u7684\u4e8b\u60c5\uff0c\u4f8b\u5982\u8abf\u5ea6\u7a0b\u5e8f\u505a\u51fa\u7684\u6c7a\u7b56\uff0c\u6216\u8005\u70ba\u4ec0\u9ebc\u67d0\u4e9b pod \u5f9e\u7bc0\u9ede\u4e2d\u88ab\u9a45\u9010\u3002 \u5f9e\u7bc0\u9ede\u6536\u96c6\u65e5\u8a8c\uff0c\u5982 kubelet \u65e5\u8a8c\u3002 \u5f9e\u7bc0\u9ede\u4e0a\u7684\u6587\u4ef6\u4e2d\u6536\u96c6\u65e5\u8a8c\uff0c\u4f8b\u5982\u5be9\u8a08\u65e5\u8a8c\u6216 systemd \u65e5\u8a8c\u3002 Kubernetes Event Tailer \u00b6 Kubernetes \u4e8b\u4ef6\u662f\u63d0\u4f9b\u6d1e\u5bdf\u96c6\u7fa4\u5167\u90e8\u767c\u751f\u7684\u4e8b\u60c5\u7684\u5c0d\u8c61\uff0c\u4f8b\u5982\u8abf\u5ea6\u7a0b\u5e8f\u505a\u51fa\u4e86\u54ea\u4e9b\u6c7a\u5b9a\u6216\u70ba\u4ec0\u9ebc\u67d0\u4e9b pod \u5f9e\u7bc0\u9ede\u4e2d\u88ab\u9010\u51fa\u3002 \u914d\u7f6e\u9078\u9805 \u00b6 VARIABLE NAME TYPE REQUIRED DEFAULT DESCRIPTION controlNamespace string Yes - Eventtailer \u7684\u8cc7\u6e90\u6703\u88ab\u653e\u5230\u9019\u500b\u547d\u540d\u7a7a\u9593\u4e2d positionVolume volume. KubernetesVolume No - \u7528\u65bc\u8ddf\u8e2a fluentbit \u6587\u4ef6\u4f4d\u7f6e\u7684\u6372\u5b9a\u7fa9\uff08\u53ef\u9078\uff09 workloadMetaOverrides *types.MetaBase No - \u8986\u84cb\u5df2\u5275\u5efa\u8cc7\u6e90\u7684\u5143\u6578\u64da workloadOverrides *types.PodSpecBase No - \u8986\u84cb\u7d66\u5b9a statefulset \u7684 podSpec \u5b57\u6bb5 Event Tailer \u7bc4\u4f8b \u00b6 \u7bc4\u4f8b: Configure Kubernetes event tailer \u00b6 kubectl apply -f - <<EOF apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : EventTailer metadata : name : sample-eventtailer spec : controlNamespace : logging # \u4fee\u6539\u8207\u3000LoggerOperator\u3000\u540c\u4e00\u500b\u547d\u540d\u7a7a\u9593 EOF \u6aa2\u67e5\u88ab\u5275\u5efa\u7684 resources \u7269\u4ef6: # \u65b0\u7684 EventTaile CRD \u88ab\u5275\u5efa $ kubectl get EventTailer NAME AGE sample-eventtailer 95s # \u4f7f\u7528\u6a19\u7c64\u5c0b\u627e\u88ab\u5275\u5efa\u7684\u8cc7\u6e90 $ kubectl get all -l app.kubernetes.io/name = event-tailer NAME READY STATUS RESTARTS AGE pod/sample-eventtailer-event-ta iler-0 1 /1 Running 0 8m7s NAME READY AGE statefulset.apps/sample-eventtailer-event-tailer 1 /1 8m7s \u5728 Grafana \u4e2d\u67e5\u627e Loki \u6536\u96c6\u7684\u65e5\u8a8c: log ql { container = \"event-tailer\" } | json | line_format \"{{.message}}\" | json | __error__ = \"\" | event_involvedObject_name = ~ \"fake-logger.*\" | line_format \"{{.event_involvedObject_kind}} {{.event_type}} {{.event_reason}} {{.event_reportingComponent}} {{.event_message}}\"","title":"Logging Operator \u7684\u64f4\u5c55"},{"location":"kubernetes/observability/logging/operator/logging-operator-extensions/#logging-operator","text":"\u539f\u6587: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/extensions/ \u65e5\u8a8c\u64f4\u5c55\u662f\u5c08\u9580\u70ba\u89e3\u6c7a\u7528\u6236\u7684\u554f\u984c\u800c\u958b\u767c\u7684\uff1a \u6536\u96c6 Kubernetes \u4e8b\u4ef6\u4ee5\u6df1\u5165\u4e86\u89e3\u96c6\u7fa4\u5167\u90e8\u6b63\u5728\u767c\u751f\u7684\u4e8b\u60c5\uff0c\u4f8b\u5982\u8abf\u5ea6\u7a0b\u5e8f\u505a\u51fa\u7684\u6c7a\u7b56\uff0c\u6216\u8005\u70ba\u4ec0\u9ebc\u67d0\u4e9b pod \u5f9e\u7bc0\u9ede\u4e2d\u88ab\u9a45\u9010\u3002 \u5f9e\u7bc0\u9ede\u6536\u96c6\u65e5\u8a8c\uff0c\u5982 kubelet \u65e5\u8a8c\u3002 \u5f9e\u7bc0\u9ede\u4e0a\u7684\u6587\u4ef6\u4e2d\u6536\u96c6\u65e5\u8a8c\uff0c\u4f8b\u5982\u5be9\u8a08\u65e5\u8a8c\u6216 systemd \u65e5\u8a8c\u3002","title":"Logging Operator \u7684\u64f4\u5c55"},{"location":"kubernetes/observability/logging/operator/logging-operator-extensions/#kubernetes-event-tailer","text":"Kubernetes \u4e8b\u4ef6\u662f\u63d0\u4f9b\u6d1e\u5bdf\u96c6\u7fa4\u5167\u90e8\u767c\u751f\u7684\u4e8b\u60c5\u7684\u5c0d\u8c61\uff0c\u4f8b\u5982\u8abf\u5ea6\u7a0b\u5e8f\u505a\u51fa\u4e86\u54ea\u4e9b\u6c7a\u5b9a\u6216\u70ba\u4ec0\u9ebc\u67d0\u4e9b pod \u5f9e\u7bc0\u9ede\u4e2d\u88ab\u9010\u51fa\u3002","title":"Kubernetes Event Tailer"},{"location":"kubernetes/observability/logging/operator/logging-operator-extensions/#_1","text":"VARIABLE NAME TYPE REQUIRED DEFAULT DESCRIPTION controlNamespace string Yes - Eventtailer \u7684\u8cc7\u6e90\u6703\u88ab\u653e\u5230\u9019\u500b\u547d\u540d\u7a7a\u9593\u4e2d positionVolume volume. KubernetesVolume No - \u7528\u65bc\u8ddf\u8e2a fluentbit \u6587\u4ef6\u4f4d\u7f6e\u7684\u6372\u5b9a\u7fa9\uff08\u53ef\u9078\uff09 workloadMetaOverrides *types.MetaBase No - \u8986\u84cb\u5df2\u5275\u5efa\u8cc7\u6e90\u7684\u5143\u6578\u64da workloadOverrides *types.PodSpecBase No - \u8986\u84cb\u7d66\u5b9a statefulset \u7684 podSpec \u5b57\u6bb5","title":"\u914d\u7f6e\u9078\u9805"},{"location":"kubernetes/observability/logging/operator/logging-operator-extensions/#event-tailer","text":"","title":"Event Tailer \u7bc4\u4f8b"},{"location":"kubernetes/observability/logging/operator/logging-operator-extensions/#configure-kubernetes-event-tailer","text":"kubectl apply -f - <<EOF apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : EventTailer metadata : name : sample-eventtailer spec : controlNamespace : logging # \u4fee\u6539\u8207\u3000LoggerOperator\u3000\u540c\u4e00\u500b\u547d\u540d\u7a7a\u9593 EOF \u6aa2\u67e5\u88ab\u5275\u5efa\u7684 resources \u7269\u4ef6: # \u65b0\u7684 EventTaile CRD \u88ab\u5275\u5efa $ kubectl get EventTailer NAME AGE sample-eventtailer 95s # \u4f7f\u7528\u6a19\u7c64\u5c0b\u627e\u88ab\u5275\u5efa\u7684\u8cc7\u6e90 $ kubectl get all -l app.kubernetes.io/name = event-tailer NAME READY STATUS RESTARTS AGE pod/sample-eventtailer-event-ta iler-0 1 /1 Running 0 8m7s NAME READY AGE statefulset.apps/sample-eventtailer-event-tailer 1 /1 8m7s \u5728 Grafana \u4e2d\u67e5\u627e Loki \u6536\u96c6\u7684\u65e5\u8a8c: log ql { container = \"event-tailer\" } | json | line_format \"{{.message}}\" | json | __error__ = \"\" | event_involvedObject_name = ~ \"fake-logger.*\" | line_format \"{{.event_involvedObject_kind}} {{.event_type}} {{.event_reason}} {{.event_reportingComponent}} {{.event_message}}\"","title":"\u7bc4\u4f8b: Configure Kubernetes event tailer"},{"location":"kubernetes/observability/logging/operator/logging-operator/","text":"Logging Operator - \u512a\u96c5\u7684\u96f2\u539f\u751f\u65e5\u8a8c\u7ba1\u7406\u65b9\u6848 \u00b6 \u539f\u6587: Logging Operator - \u4f18\u96c5\u7684\u4e91\u539f\u751f\u65e5\u5fd7\u7ba1\u7406\u65b9\u6848 (\u4e00) Logging Operator - \u4f18\u96c5\u7684\u4e91\u539f\u751f\u65e5\u5fd7\u7ba1\u7406\u65b9\u6848 (\u4e8c) Logging Operator - \u4f18\u96c5\u7684\u4e91\u539f\u751f\u65e5\u5fd7\u7ba1\u7406\u65b9\u6848 (\u4e09) Logging Operator \u662f BanzaiCloud \u958b\u6e90\u7684\u4e00\u500b\u96f2\u539f\u751f\u5834\u666f\u4e0b\u7684\u65e5\u8a8c\u63a1\u96c6\u65b9\u6848\u3002\u5b83\u5728 2020 \u5e74 3 \u6708\u7684\u6642\u5019\u7d93\u904e\u91cd\u69cb\u5f8c\u7684 v3 \u7248\u672c\uff0c\u5e95\u5c64\u6191\u85c9\u9ad8\u6548\u7684 fluentbit \u548c\u63d2\u4ef6\u8c50\u5bcc\u7684 flunetd\uff0cLogging Operator\u5e7e\u4e4e\u5df2\u7d93\u5b8c\u7f8e\u7684\u9069\u914d\u4e86 kubernetes \u6a21\u5f0f\u4e0b\u7684\u65e5\u8a8c\u63a1\u96c6\u5834\u666f\u3002 Rancher \u5728 2.5 \u7248\u672c\u4e4b\u5f8c\u4e5f\u63a1\u7528\u4e86 Logging Operator \u4f5c\u70ba\u7d71\u4e00\u7684\u65e5\u8a8c\u89e3\u6c7a\u65b9\u6848\uff0c\u8db3\u4ee5\u8aaa\u660e\u5b83\u6b63\u5728\u88ab\u4e00\u4e9b\u4ee5 Kubernetes \u70ba\u6838\u5fc3\u7684\u7ba1\u7406\u5e73\u53f0\u63a5\u53d7\uff0c\u4e26\u96c6\u6210\u81f3\u5167\u90e8\u6838\u5fc3\u7d44\u4ef6\u3002 \u6211\u5011\u5148\u4f86\u770b\u770b\u5b83\u7684\u67b6\u69cb\u3002 \u53ef\u4ee5\u770b\u5230 Logging Operator \u5229\u7528 CRD \u7684\u65b9\u5f0f\u4ecb\u5165\u4e86\u65e5\u8a8c\u5f9e\u63a1\u96c6\u3001\u8def\u7531\u3001\u8f38\u51fa\u9019\u4e09\u500b\u968e\u6bb5\u7684\u914d\u7f6e\u3002\u5b83\u672c\u8cea\u4e0a\u4f86\u8aaa\u9084\u662f\u5229\u7528 DaemonSet \u548c StatefulSet \u5728\u96c6\u7fa4\u5167\u5206\u5225\u90e8\u7f72\u4e86 FluentBit \u548c Fluentd \u5169\u500b\u7d44\u4ef6\uff0cFluentBit \u5c07\u5bb9\u5668\u65e5\u8a8c\u63a1\u96c6\u4e26\u521d\u6b65\u8655\u7406\u5f8c\u8f49\u767c\u7d66 Fluentd \u505a\u9032\u4e00\u6b65\u7684\u89e3\u6790\u548c\u8def\u7531\uff0c\u6700\u7d42\u7531 Fluentd \u5c07\u65e5\u8a8c\u7d50\u679c\u8f49\u767c\u7d66\u4e0d\u540c\u7684\u670d\u52d9\u3002 \u9664\u4e86\u7ba1\u7406\u65e5\u8a8c\u5de5\u4f5c\u6d41\u5916\uff0cLogging Operator \u9084\u53ef\u4ee5\u8b93\u7ba1\u7406\u8005\u958b\u555f TLS \u4f86\u52a0\u5bc6\u65e5\u8a8c\u5728\u96c6\u7fa4\u5167\u90e8\u7684\u7db2\u7d61\u50b3\u8f38\uff0c\u4ee5\u53ca\u9ed8\u8a8d\u96c6\u6210\u4e86 ServiceMonitor \u4f86\u66b4\u9732\u65e5\u8a8c\u63a1\u96c6\u7aef\u7684\u72c0\u614b\u3002 Logging Operator CRD \u00b6 \u6574\u500b Logging Operator \u7684\u6838\u5fc3 CRD \u5c31\u53ea\u67095\u500b\uff0c\u5b83\u5011\u5206\u5225\u662f logging \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u65e5\u8a8c\u63a1\u96c6\u7aef(FleuntBit)\u548c\u50b3\u8f38\u7aef(Fleuntd)\u670d\u52d9\u7684\u57fa\u790e\u914d\u7f6e\uff1b flow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces \u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\u3002 clusterflow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\u3002 output \uff1a \u7528\u65bc\u5b9a\u7fa9namespace\u7d1a\u5225\u7684\u65e5\u8a8c\u7684\u8f38\u51fa\u548c\u53c3\u6578\uff1b clusteroutput \uff1a \u7528\u65bc\u5b9a\u7fa9\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u80fd\u628a\u88ab\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\uff1b \u901a\u904e\u90195\u500b CRD\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u51fa\u4e00\u500b Kubernetes \u96c6\u7fa4\u5167\u6bcf\u500b\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u5bb9\u5668\u65e5\u8a8c\u6d41\u5411 Logging Operator \u5b89\u88dd \u00b6 Logging Operator \u4f9d\u8cf4 Kuberentes1.14 \u4e4b\u5f8c\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u5206\u5225\u7528 helm \u548c mainfest \u5169\u7a2e\u65b9\u5f0f\u5b89\u88dd\u3002 Helm(v3.21.0+)\u5b89\u88dd $ helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com $ helm repo update $ helm upgrade --install --wait --create-namespace --namespace logging logging-operator banzaicloud-stable/logging-operator \\ --set \"createCustomResource=false\" Manifest \u5b89\u88dd $ kubectl create ns logging # RBAC $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator-docs/master/docs/install/manifests/rbac.yaml # CRD $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_clusterflows.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_clusteroutputs.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_flows.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_loggings.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_outputs.yaml # Operator $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator-docs/master/docs/install/manifests/deployment.yaml \u7576\u5b89\u88dd\u5b8c\u6210\u5f8c\uff0c\u6211\u5011\u9700\u8981\u9a57\u8b49\u4e0b\u670d\u52d9\u7684\u72c0\u614b # Operator \u72c0\u614b $ kubectl -n logging get pods NAME READY STATUS RESTARTS AGE logging-logging-operator-599c9cf846-5nw2n 1 /1 Running 0 52s # CRD \u72c0\u614b $ kubectl get crd | grep banzaicloud.io NAME CREATED AT clusterflows.logging.banzaicloud.io 2021 -03-25T08:49:30Z clusteroutputs.logging.banzaicloud.io 2021 -03-25T08:49:30Z flows.logging.banzaicloud.io 2021 -03-25T08:49:30Z loggings.logging.banzaicloud.io 2021 -03-25T08:49:30Z outputs.logging.banzaicloud.io 2021 -03-25T08:49:30Z Logging Operator \u914d\u7f6e \u00b6 Logging CRD \u00b6 LoggingSpec \u00b6 LoggingSpec \u5b9a\u7fa9\u4e86\u6536\u96c6\u548c\u50b3\u8f38\u65e5\u8a8c\u6d88\u606f\u7684\u65e5\u8a8c\u57fa\u790e\u67b6\u69cb\u670d\u52d9\uff0c\u5176\u4e2d\u5305\u542b Fluentd \u548c Fluent-bit \u7684\u914d\u7f6e\u3002\u5b83\u5011\u90fd\u90e8\u7f72\u5728 controlNamespace \u6307\u5b9a\u7684\u547d\u540d\u7a7a\u9593\u5167\u3002\u4e00\u500b\u7c21\u55ae\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple namespace : logging spec : fluentd : {} fluentbit : {} controlNamespace : logging \u9019\u4efd\u6a23\u4f8b\u544a\u8a34\u4e86 Operator \u5728 logging \u547d\u540d\u7a7a\u9593\u5167\u5275\u5efa\u4e00\u500b\u9ed8\u8a8d\u914d\u7f6e\u7684\u65e5\u8a8c\u670d\u52d9\uff0c\u5176\u4e2d\u5305\u542b FluentBit \u548c Fluentd \u5169\u500b\u670d\u52d9\u3002 \u7576\u7136\u5be6\u969b\u4e0a\u6211\u5011\u5728\u751f\u7522\u74b0\u5883\u4e0a\u90e8\u7f72 FluentBit \u548c Fluentd \u4e0d\u6703\u53ea\u7528\u9ed8\u8a8d\u7684\u914d\u7f6e\uff0c\u901a\u5e38\u6211\u5011\u8981\u8003\u616e\u5f88\u591a\u65b9\u9762\uff0c\u6bd4\u5982\uff1a \u81ea\u5b9a\u7fa9\u93e1\u50cf \u65e5\u8a8c\u63a1\u96c6\u4f4d\u9ede\u6587\u4ef6\u7684\u6578\u64da\u6301\u4e45\u5316 Buffer \u6578\u64da\u6301\u4e45\u5316 CPU/\u5167\u5b58\u8cc7\u6e90\u9650\u5236 \u72c0\u614b\u76e3\u63a7 Fluentd \u526f\u672c\u6578\u4ee5\u53ca\u8ca0\u8f09\u5747\u8861 \u7db2\u7d61\u53c3\u6578\u512a\u5316 \u5bb9\u5668\u904b\u884c\u5b89\u5168 \u597d\u5728 Loggingspec \u88e1\u5c0d\u4e0a\u8ff0\u652f\u6301\u5f97\u90fd\u6bd4\u8f03\u5168\u9762\uff0c\u6211\u5011\u53ef\u4ee5\u53c3\u8003\u6587\u6a94\u4f86\u500b\u6027\u5316\u5b9a\u5236\u81ea\u5df1\u7684\u670d\u52d9\u3002 \u8b93\u6211\u5011\u6311\u5e7e\u500b\u91cd\u8981\u7684\u5b57\u6bb5\u8aaa\u660e\u7528\u9014\uff1a watchNamespaces \u5236\u5b9a\u8b93 Operator \u76e3\u807d Flow \u548c OutPut \u8cc7\u6e90\u7684\u547d\u540d\u7a7a\u9593\uff0c\u5982\u679c\u4f60\u662f\u591a\u79df\u6236\u5834\u666f\uff0c\u4e14\u6bcf\u500b\u79df\u6236\u90fd\u7528 logging \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u67b6\u69cb\u5316\uff0c\u53ef\u4ee5\u7528 watchNamespaces \u4f86\u95dc\u806f\u79df\u6236\u7684\u547d\u540d\u7a7a\u9593\u4f86\u7e2e\u5c0f\u8cc7\u6e90\u904e\u6ffe\u7bc4\u570d allowClusterResourcesFromAllNamespaces ClusterOutput\u548cClusterFlow \u9019\u6a23\u7684\u5168\u5c40\u8cc7\u6e90\u9ed8\u8a8d\u53ea\u5728 controlNamespace \u95dc\u806f\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u751f\u6548\uff0c\u5982\u679c\u5728\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u4e2d\u5b9a\u7fa9\u90fd\u6703\u88ab\u5ffd\u7565\uff0c\u9664\u975e\u5c07allowClusterResourcesFromAllNamespaces \u8a2d\u7f6e\u70ba true Info LoggingSpec\u63cf\u8ff0\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/logging_types/ FluentbitSpec \u00b6 filterKubernetes \u7528\u4f86\u7372\u53d6\u65e5\u8a8c\u7684 Kubernetes \u5143\u6578\u64da\u7684\u63d2\u4ef6\uff0c\u4f7f\u7528\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : {} fluentbit : filterKubernetes : Kube_URL : \"https://kubernetes.default.svc:443\" Match : \"kube.*\" controlNamespace : logging \u4e5f\u53ef\u4ee5\u7528 disableKubernetesFilter \u5c07\u8a72\u529f\u80fd\u7981\u6b62\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : {} fluentbit : disableKubernetesFilter : true controlNamespace : logging Info filterKubernetes \u63cf\u8ff0\u6587\u6a94: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentbit_types/#filterkubernetes inputTail \u5b9a\u7fa9 FluentBit \u7684\u65e5\u8a8c tail \u63a1\u96c6\u914d\u7f6e\uff0c\u9019\u88e1\u9762\u6709\u5f88\u591a\u7d30\u7bc0\u7684\u53c3\u6578\u4f86\u63a7\u5236\uff0c\u914d\u7f6e\u6a23\u4f8b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : inputTail : Skip_Long_Lines : \"true\" #Parser: docker Parser : cri Refresh_Interval : \"60\" Rotate_Wait : \"5\" Mem_Buf_Limit : \"128M\" #Docker_Mode: \"true\" Docker_Mode : \"false \u5982\u679c Kubernetes \u96c6\u7fa4\u7684\u5bb9\u5668\u904b\u884c\u6642\u662f Containerd \u6216\u9019\u5176\u4ed6 CRI\uff0c\u5c31\u9700\u8981\u628a Parser \u6539\u6210 cri\uff0c\u540c\u6642\u7981\u7528 Docker_Mode\u3002 Info inputTail \u63cf\u8ff0\u6587\u6a94: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentbit_types/#inputtail buffers \u5b9a\u7fa9\u4e86 FluentBit \u7684\u7de9\u885d\u5340\u8a2d\u7f6e\uff0c\u9019\u500b\u6bd4\u8f03\u91cd\u8981\u3002\u7531\u65bc FluentBit \u662f\u4ee5 DaemonSet \u7684\u65b9\u5f0f\u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u63a1\u7528 hostPath \u7684\u6372\u639b\u8f09\u65b9\u5f0f\u4f86\u7d66\u5b83\u63d0\u4f9b\u6578\u64da\u6301\u4e45\u5316\u7684\u914d\u7f6e\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : bufferStorage : storage.backlog.mem_limit : 10M storage.path : /var/log/log-buffer bufferStorageVolume : hostPath : path : \"/var/log/log-buffer\" Info bufferStorage \u63cf\u8ff0\u6587\u6a94: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentbit_types/#bufferstorage positiondb \u5b9a\u7fa9\u4e86 FluentBit \u63a1\u96c6\u65e5\u8a8c\u7684\u6587\u4ef6\u4f4d\u9ede\u4fe1\u606f\uff0c\u540c\u7406\u6211\u5011\u53ef\u4ee5\u7528 hostPath \u65b9\u5f0f\u652f\u6301\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : positiondb : hostPath : path : \"/var/log/positiondb\" image \u63d0\u4f9b\u81ea\u5b9a\u7fa9\u7684 FluentBit \u7684\u93e1\u50cf\u4fe1\u606f\uff0c\u9019\u88e1\u6211\u5f37\u70c8\u63a8\u85a6\u4f7f\u7528 FluentBit-1.7.3 \u4e4b\u5f8c\u7684\u93e1\u50cf\uff0c\u5b83\u4fee\u5fa9\u4e86\u63a1\u96c6\u7aef\u773e\u591a\u7db2\u7d61\u9023\u63a5\u8d85\u6642\u7684\u554f\u984c,\u5b83\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : image : repository : fluent/fluent-bit tag : 1.7.3 pullPolicy : IfNotPresent metrics \u5b9a\u7fa9\u4e86 FluentBit \u7684\u76e3\u63a7\u66b4\u9732\u7aef\u53e3\uff0c\u4ee5\u53ca\u96c6\u6210\u7684 ServiceMonitor \u63a1\u96c6\u5b9a\u7fa9\uff0c\u5b83\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : metrics : interval : 60s path : /api/v1/metrics/prometheus port : 2020 serviceMonitor : true resources \u5b9a\u7fa9\u4e86FluentBit\u7684\u8cc7\u6e90\u5206\u914d\u548c\u9650\u5236\u4fe1\u606f\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : resources : limits : cpu : \"1\" memory : 512Mi requests : cpu : 200m memory : 128Mi security \u5b9a\u7fa9\u4e86 FluentBit \u904b\u884c\u671f\u9593\u7684\u5b89\u5168\u8a2d\u7f6e\uff0c\u5176\u4e2d\u5305\u542b\u4e86 PSP\u3001RBAC\u3001securityContext\u548cpodSecurityContext\u3002\u4ed6\u5011\u5171\u540c\u7d44\u6210\u63a7\u5236\u4e86 FluentBit \u5bb9\u5668\u5167\u7684\u6b0a\u9650\uff0c\u5b83\u5011\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : security : podSecurityPolicyCreate : true roleBasedAccessControlCreate : true securityContext : allowPrivilegeEscalation : false readOnlyRootFilesystem : true podSecurityContext : fsGroup : 101 \u6027\u80fd\u53c3\u6578 \u9019\u88e1\u9762\u5b9a\u7fa9\u4e86 FluentBit \u7684\u4e00\u4e9b\u904b\u884c\u6027\u80fd\u65b9\u9762\u7684\u53c3\u6578\uff0c\u5176\u4e2d\u5305\u542b\uff1a \u958b\u555f forward \u8f49\u767c\u4e0a\u6e38\u61c9\u7b54\u76f8\u61c9 apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : forwardOptions : Require_ack_response : true TCP \u9023\u63a5\u53c3\u6578 apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : network : connectTimeout : 30 keepaliveIdleTimeout : 60 \u958b\u555f\u8ca0\u8f09\u5747\u8861\u6a21\u5f0f apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : enableUpstream : true \u8abf\u5ea6\u6c61\u9ede\u5bb9\u5fcd apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : tolerations : - effect : NoSchedule key : node-role.kubernetes.io/master FluentdSpec \u00b6 buffers \u9019\u88e1\u4e3b\u8981\u5b9a\u7fa9 Fluentd \u7684 buffer \u6578\u64da\u6301\u4e45\u5316\u914d\u7f6e\uff0c\u7531\u65bc Fluentd \u662f\u4ee5 StatefulSet \u7684\u65b9\u5f0f\u90e8\u7f72\u7684\uff0c\u6240\u4ee5\u6211\u5011\u7528 hostPath \u5c31\u4e0d\u592a\u5408\u9069\uff0c\u9019\u88e1\u6211\u5011\u61c9\u8a72\u7528PersistentVolumeCliamTemplate \u7684\u65b9\u5f0f\u70ba\u6bcf\u4e00\u500b fluentd \u5be6\u4f8b\u5275\u5efa\u4e00\u584a\u5c08\u9580\u7684 buffer \u6578\u64da\u5377\uff0c\u6a23\u4f8b\u5982\u4e0b: apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : bufferStorageVolume : pvc : spec : accessModes : - ReadWriteOnce resources : requests : storage : 50Gi storageClassName : csi-rbd volumeMode : Filesystem \u9019\u88e1\u5982\u679c\u4e0d\u6307\u5b9a storageClassName \u7684\u8a71\uff0cOperator \u5c07\u901a\u904e StorageClass \u70ba default \u7684\u5b58\u5132\u63d2\u4ef6\u5275\u5efa pvc\u3002 FluentOutLogrotate \u5b9a\u7fa9\u4e86 Fluentd \u7684\u6a19\u6e96\u8f38\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u914d\u7f6e\uff0c\u9019\u4e3b\u8981\u662f\u70ba\u4e86\u907f\u514d\u5728\u51fa\u73fe\u932f\u8aa4\u6642 Fluentd \u7522\u751f\u9023\u9396\u53cd\u61c9\uff0c\u4e26\u4e14\u932f\u8aa4\u6d88\u606f\u4f5c\u70ba\u65e5\u8a8c\u6d88\u606f\u8fd4\u56de\u7cfb\u7d71\u751f\u6210\u53e6\u4e00\u500b\u932f\u8aa4\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : fluentOutLogrotate : enabled : true path : /fluentd/log/out age : 10 size : 10485760 \u9019\u88e1\u8868\u9054\u7684\u610f\u601d\u5c31\u662f\u5c07 fluentd \u65e5\u8a8c\u91cd\u5b9a\u5411\u5230 /fluentd/log/out \u76ee\u9304\uff0c\u540c\u6642\u4fdd\u755910\u5929\uff0c\u6587\u4ef6\u6700\u5927\u4e0d\u8d85\u904e10M Info FluentOutLogrotate \u63cf\u8ff0\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentd_types/#fluentoutlogrotate Scaling \u9019\u88e1\u4e3b\u8981\u5b9a\u7fa9 fluentd \u7684\u526f\u672c\u6578\uff0c\u5982\u679c FluentBit \u958b\u555f UpStraem \u7684\u652f\u6301\uff0c\u8abf\u6574 Fluentd \u7684\u526f\u672c\u6578\u6703\u5c0e\u81f4 FluentBit \u6efe\u52d5\u66f4\u65b0\uff0c\u5b83\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : scaling : replicas : 4 Info scaling \u63cf\u8ff0\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentd_types/#fluentdscaling Worker \u9019\u88e1\u5b9a\u7fa9\u4e86 Fluentd \u5167\u90e8\u7684 Worker \u6578\u91cf\uff0c\u7531\u65bc Fluentd \u53d7\u9650\u65bc ruby\uff0c\u5b83\u9084\u662f\u4ee5\u55ae\u9032\u7a0b\u7684\u65b9\u5f0f\u8655\u7406\u65e5\u8a8c\u5de5\u4f5c\u6d41\uff0c\u589e\u52a0 worker \u6578\u53ef\u4ee5\u986f\u8457\u63d0\u9ad8 Fluentd \u7684\u4e26\u767c\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : workers : 2 image \u5b9a\u7fa9\u4e86 Fluentd \u7684\u93e1\u50cf\u4fe1\u606f\uff0c\u9019\u88e1\u5fc5\u9808\u8981\u7528 Logging Operator \u5b9a\u5236\u7684\u93e1\u50cf\uff0c\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u93e1\u50cf\u7248\u672c\uff0c\u7d50\u69cb\u548c FluetnBit \u985e\u4f3c\u3002 security \u5b9a\u7fa9\u4e86 Fluentd \u904b\u884c\u671f\u9593\u7684\u5b89\u5168\u8a2d\u7f6e\uff0c\u5176\u4e2d\u5305\u542b\u4e86 PSP\u3001RBAC\u3001securityContext\u548cpodSecurityContext\uff0c\u7d50\u69cb\u548c FluentBit \u985e\u4f3c\u3002 metrics \u5b9a\u7fa9\u4e86 Fluentd \u7684\u76e3\u63a7\u66b4\u9732\u7aef\u53e3\uff0c\u4ee5\u53ca\u96c6\u6210\u7684 ServiceMonitor \u63a1\u96c6\u5b9a\u7fa9\uff0c\u7d50\u69cb\u548c FluentBit \u985e\u4f3c\u3002 resources \u5b9a\u7fa9\u4e86 Fluentd \u7684\u8cc7\u6e90\u5206\u914d\u548c\u9650\u5236\u4fe1\u606f\uff0c\u7d50\u69cb\u548c FluentBit \u985e\u4f3c\u3002 \u63a5\u4e0b\u4f86\u6211\u5011\u8981\u8b1b\u89e3 Logging Operator \u4e2d\u9664 logging \u5916\u7684 CRD \u61c9\u7528\u3002\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u6211\u5011\u9084\u662f\u5148\u770b\u4e0b Logging Operator \u5c0d K8S \u4e2d\u8655\u7406\u5bb9\u5668\u65e5\u8a8c\u6d41\u5411\u7684\u908f\u8f2f\u5716\u3002 \u5176\u5be6\u6211\u5011\u53ef\u4ee5\u770b\u51fa\u4f86\uff0cLogging Operator \u6838\u5fc3\u7684\u908f\u8f2f\u4e3b\u8981\u5c31\u5728 Flow \u548c Output \u9019\u5169\u500b CRD\u3002\u7c21\u55ae\u4f86\u8aaa\uff0cFlow \u7684\u4f5c\u7528\u662f\u7528\u4f86\u8655\u7406\u65e5\u8a8c\u6d41\u7684\uff0cOutput \u7528\u4f86\u5b9a\u7fa9\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\u3002\u81f3\u65bc ClusterFlow \u548c ClusterOutput \u7121\u5916\u4e4e\u5c31\u662f\u4e00\u500b\u5168\u5c40\u7684\u8072\u660e\u7f77\u4e86\u3002 Flow \u8207 ClusterFlow CRD \u00b6 Flow \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684 filters \u548c outputs\uff0c\u5b83\u662f\u4e00\u500b namespaces \u7d1a\u5225\u7684 CRD \u8cc7\u6e90\u3002\u56e0\u6b64\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u61c9\u7528\u6240\u5728\u7684\u547d\u540d\u7a7a\u9593\u5167\u6839\u64da Kubernetes \u6a19\u7c64\u4f86\u6c7a\u5b9a\u65e5\u8a8c\u662f\u5426\u88ab\u63a1\u96c6\uff0c\u540c\u6642\u4e5f\u80fd\u5b9a\u7fa9\u591a\u500b filter \u4f86\u5c0d\u65e5\u8a8c\u9032\u884c\u8655\u7406\u3002\u8209\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample namespace : default spec : filters : - parser : remove_key_name_field : true parse : type : nginx - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} localOutputRefs : - loki-output match : - select : labels : app : nginx \u9019\u689d Flow \u7684\u610f\u601d\u662f\uff0c\u8b93\u65e5\u8a8c\u63a1\u96c6\u7aef\u53ea\u8655\u7406\u4f86\u81ea default \u547d\u540d\u7a7a\u9593\u4e0b\uff0c\u6a19\u7c64 app=nginx \u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u540c\u6642\u4e26\u5c0d\u63a1\u96c6\u7684\u65e5\u8a8c\u6309\u7167 nginx \u7684\u683c\u5f0f\u9032\u884c\u89e3\u6790\uff0c\u4e26\u628a\u9019\u689d\u65e5\u8a8c\u6d41\u7684 tag \u5728fluentd \u5167\u90e8\u91cd\u5b9a\u5411\u70ba ${namespace_name}.${pod_name}.${container_name} \u3002 \u9019\u500b\u4f8b\u5b50\u88e1\u9762\uff0c\u6211\u5011\u8457\u91cd\u8a3b\u610f\u4e09\u500b\u5730\u65b9 match , filters \u548c localOutputRefs \u3002 match \u00b6 match \u662f\u8655\u7406\u65e5\u8a8c\u7684\u7b2c\u4e00\u6b65\uff0c\u6211\u5011\u9700\u8981\u5229\u7528 Kubernetes \u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6\u3002\u7576\u524d\u53ef\u7528\u7684\u5b57\u6bb5\u5982\u4e0b\uff1a namespaces \uff0c \u5339\u914d\u547d\u540d\u7a7a\u9593 labels \uff0c\u5339\u914d labels hosts \uff0c\u5339\u914d host \u6a5f\u5668 container_names \uff0c\u5339\u914d\u5bb9\u5668\u540d\u5b57 \u6211\u5011\u901a\u904e select \u548c exclude \u4f86\u9078\u64c7\u6216\u6392\u9664\u6211\u5011\u8981\u5339\u914d\u7684\u8cc7\u6e90\u985e\u578b\u3002\u6bd4\u5982\u4e0b\u9762\u4f8b\u5b50\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample namespace : default spec : match : - exclude : labels : component : reloader - select : labels : app : nginx componnet : nginx \u9019\u689d Flow \u5c31\u8072\u660e\u8b93\u5ba2\u6236\u7aef\u53ea\u8655\u7406 default \u547d\u540d\u7a7a\u9593\u4e0b\u6a19\u7c64\u70ba app=nginx, componnet=nginx \uff0c\u6392\u9664 component: reloader \u7684\u5bb9\u5668\u65e5\u8a8c\u3002 \u5c0d\u65bc ClusterFlow\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e select \u4f86\u63a7\u5236\u591a\u500b namespaces \u4e0b\u7684\u65e5\u8a8c\u63a1\u96c6\u3002\u6bd4\u5982: apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : clusterflow-sample spec : match : - exclude : namespaces : - dev - test - select : labels : app : nginx \u9019\u689d\u8072\u660e\u5c31\u544a\u8a34\u4e86\u5ba2\u6236\u7aef\u53ea\u8655\u7406\u547d\u540d\u7a7a\u9593\u4e0d\u662f dev \u548c test \u800c\u4e14\u6a19\u7c64\u70ba app=nginx \u7684\u5bb9\u5668\u65e5\u8a8c\u3002 Tip ClusterFlow \u7684\u8072\u660e\u9ed8\u8a8d\u53ea\u5728 controlNamespace \u5b9a\u7fa9\u7684 namespace \u4e0b\u751f\u6548\uff0c\u5982\u679c\u8981\u5b9a\u7fa9\u5230\u5176\u4ed6\u547d\u540d\u7a7a\u9593\uff0c\u4f60\u9700\u8981\u5728\u5b9a\u7fa9 logging CRD\u6642\u6253\u958b allowClusterResourcesFromAllNamespaces \u5982\u679c\u6211\u5011\u9700\u8981\u7c21\u55ae\u7c97\u66b4\u7684\u63a1\u96c6\u6307\u5b9a namespaces \u4e0b\u6240\u6709\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u90a3\u9ebc\u53ea\u9700\u8981\u5b9a\u7fa9\u4e00\u500b\u5982\u4e0b\u5167\u5bb9\u7684 ClusterFlow \u5373\u53ef: apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : clusterflow-sample spec : match : - select : namespaces : - prod - dev - test filter \u00b6 Logging Operator \u7684 filter \u652f\u6301\u4e00\u4e9b\u5e38\u898b\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6\u3002\u53ef\u4ee5\u53c3\u8003\u4e0b\u9762\u9019\u500b\u8868\u683c: \u540d\u7a31 \u985e\u578b \u63cf\u8ff0 \u72c0\u614b \u7248\u672c Concat filters \u7528\u65bcfluentd\u8655\u7406\u65e5\u8a8c\u591a\u884c\u7684\u63d2\u4ef6 GA 2.4.0 Dedot filters \u8655\u7406\u5e36.\u7684\u5b57\u6bb5\u66ff\u63db\u63d2\u4ef6\uff0c\u901a\u5e38\u7528\u65bc\u8f38\u51fa\u5230elaticsearch\u524d\u7684\u5b57\u6bb5\u8f49\u5316 GA 1.0.0 Exception Detector filters Exception\u65e5\u8a8c\u6355\u7372\u5668\uff0c\u652f\u6301java, js, csharp, python, go, ruby, php GA 0.0.13 Enhance K8s Metadata filters banzaicloud\u958b\u767c\u7684k8s\u64f4\u5c55\u5143\u6578\u64da GA 0.0.0 Geo IP filters fluentd\u7684GeoIP\u5730\u5740\u5eab GA 1.3.2 Grep filters fluentd\u7684grep\u904e\u6ffe\u5668 GA more info Parser filters fluentd\u7684Parser\u89e3\u6790\u5668 GA more info Prometheus filters Prometheus\u63d2\u4ef6\uff0c\u53ef\u7528\u65bc\u5c0d\u65e5\u8a8c\u505a\u8a08\u6578 GA 1.8.5 Record Modifier filters fluentd \u5b57\u6bb5\u4fee\u6539\u63d2\u4ef6 GA 2.1.0 Record Transformer filters Mutates/transforms incoming event streams. GA more info Stdout filters \u6a19\u6e96\u8f38\u51fa\u63d2\u4ef6 GA more info SumoLogic filters Sumo Logic\u516c\u53f8\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6 GA 2.3.1 Tag Normaliser filters fluentd\u4e2d\u7684tag\u4fee\u6539\u5668 GA 0.1.1 Info filter \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/ Parser \u63d2\u4ef6 \u00b6 Parser \u63d2\u4ef6\u6bd4\u8f03\u5e38\u898b\uff0c\u901a\u5e38\u6211\u5011\u7528\u5b83\u4f86\u89e3\u6790\u63a1\u96c6\u7684\u65e5\u8a8c\u5167\u5bb9\uff0c\u6bd4\u5982\u6211\u5011\u8981\u89e3\u6790\u7684\u65e5\u8a8c\u662f json \u683c\u5f0f\u5c31\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u65b9\u5f0f\u914d\u7f6e\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample filters : - parser : remove_key_name_field : true reserve_data : true key_name : \"log\" parse : type : json time_key : time time_format : \"%Y-%m-%dT%H:%M:%S.%NZ\" \u751a\u81f3\uff0c\u6211\u5011\u4e5f\u53ef\u4ee5\u5728\u65e5\u8a8c\u88e1\u5b9a\u7fa9\u591a\u7a2e\u985e\u578b\u7684\u683c\u5f0f\uff0c\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample spec : filters : - parser : remove_key_name_field : true reserve_data : true parse : type : multi_format patterns : - format : nginx - format : regexp expression : /foo/ - format : none \u9019\u6703\u751f\u6210 fluentd \u7684\u5982\u4e0b\u7684 fluentd \u914d\u7f6e <filter ** > @type parser @id test_parser key_name message remove_key_name_field true reserve_data true <parse> @type multi_format <pattern> format nginx </pattern> <pattern> expression /foo/ format regexp </pattern> <pattern> format none </pattern> </parse> </filter> Info parser \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/parser/ record_modifier \u63d2\u4ef6 \u00b6 record_modifier \u5141\u8a31\u6211\u5011\u5f9e\u5df2\u89e3\u6790\u7684\u65e5\u8a8c\u5b57\u6bb5\u88e1\u9762\u63d0\u53d6\u548c\u4fee\u6539\u5b57\u6bb5\u3002\u6bd4\u5982\u6211\u5011\u5728\u63a1\u96c6 kubernetes \u7684\u5bb9\u5668\u65e5\u8a8c\u6642\uff0c\u5e0c\u671b\u4fee\u6539\u90e8\u5206\u5143\u6578\u64da\u6642\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u9019\u500b\u63d2\u4ef6\u3002 apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample spec : filters : - record_modifier : records : - host : ${record.dig('kubernetes', 'host')} \u9019\u689d filter \u898f\u5247\u5c31\u5b9a\u7fa9\u4e86\u8b93 fluentd \u5728\u8655\u7406\u65e5\u8a8c\u5143\u6578\u64da\u6642\uff0c\u65b0\u52a0\u4e00\u500b\u5b57\u6bb5 host\uff0c\u5b83\u7684\u503c\u4f86\u81ea\u65bc .kubernetes.host \u3002\u5b83\u6700\u7d42\u5728 fluentd \u4e2d\u64cd\u4f5c\u7684\u914d\u7f6e\u662f\u9019\u6a23\u7684\u3002 <filter ** > @type record_modifier @id test_record_modifier <record> host ${record.dig('kubernetes', 'host')} </record> </filter> prometheus \u63d2\u4ef6 \u00b6 prometheus \u662f\u7528\u4f86\u7d71\u8a08\u9032\u5165 fluentd \u65e5\u8a8c\u6d41\u4e26\u8655\u7406\u7684\u65e5\u8a8c\u57fa\u6578\uff0c\u6bd4\u5982\u6211\u5011\u60f3\u7d71\u8a08\u6a19\u7c64 app=nginx \u9019\u500b\u6253\u5370\u4e86\u591a\u5c11\u65e5\u8a8c\u6642\uff0c\u5c31\u53ef\u4ee5\u7528\u8a72\u63d2\u4ef6\u8655\u7406\uff0c apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample spec : filters : - parser : remove_key_name_field : true reserve_data : true parse : type : nginx - prometheus : metrics : - name : total_counter desc : The total number of nginx in message. type : counter labels : app : nginx labels : host : ${hostname} tag : ${tag} namespace : $.kubernetes.namespace \u9019\u500b\u5c31\u8868\u793a\u4e86 nginx \u65e5\u8a8c\u5728 fluentd \u5171\u8a08\u8655\u7406\u4e86\u591a\u5c11\u884c\u6d88\u606f\uff0c\u9019\u5c0d\u6211\u5011\u7d71\u8a08\u696d\u52d9\u65e5\u8a8c\u8cc7\u6e90\u4f7f\u7528\u4f86\u8aaa\u6bd4\u8f03\u65b9\u4fbf\u7684\u3002 Info prometheus \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/prometheus/ outputRefs \u00b6 OutputRefs \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u8def\u5f91\u3002\u5b83\u5206\u70ba localOutputRefs \u548c globalOutputRefs \u3002\u6545\u540d\u601d\u7fa9\uff0c localOutputRefs \u662f\u8ddf flow \u4e00\u6a23\u4f5c\u7528\u5728 namespace \u7d1a\u5225\uff0c\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u4e0b\u7684 Flow \u770b\u4e0d\u5230\u7576\u524d\u547d\u540d\u7a7a\u9593\u4e0b\u7684 output \u5b9a\u7fa9\u3002 globalOutputRefs \u70ba\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u8072\u660e\uff0c\u5b83\u80fd\u88ab\u6240\u6709\u547d\u540d\u7a7a\u9593\u4e0b\u7684 Flow \u548c ClusterFlow \u5f15\u7528\u3002 Output \u8207 ClusterOutput CRD \u00b6 Output \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\uff0c\u76ee\u524d Logging Operator \u652f\u6301\u7684\u65e5\u8a8c\u8f38\u51fa\u63d2\u4ef6\u975e\u5e38\u591a\uff0c\u5305\u542b\u5982\u4e0b\u5167\u5bb9\uff1a Alibaba Cloud Amazon CloudWatch Amazon Elasticsearch Amazon Kinesis Amazon S3 Azure Storage Buffer Datadog Elasticsearch File Format Format rfc5424 Forward GELF Google Cloud Storage Grafana Loki Http Kafka LogDNA LogZ NewRelic Splunk SumoLogic Syslog \u9019\u88e1\u9762\u6211\u5011\u65e5\u5e38\u5de5\u4f5c\u4e2d\u7528\u5230\u7684\u65e5\u8a8c\u5b58\u5132\u6216\u67b6\u69cb\u5927\u6982\u5c31\u5305\u542b Loki , ElasticSearch , Kafka \u6216 S3 \u3002 Grafana Loki \u00b6 Grafana Loki \u63d2\u4ef6\u7528\u4f86\u5b9a\u7fa9 fluentd \u5c07\u65e5\u8a8c\u8f38\u51fa\u5230 Loki \u7576\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u4e9b\u7279\u5b9a\u7684\u53c3\u6578\u4f86\u63a7\u5236\u548c\u512a\u5316\u65e5\u8a8c\u8f38\u51fa\uff0c\u6bd4\u5982\u4e0b\u9762\u9019\u500b\u6a23\u4f8b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : loki-output spec : loki : buffer : chunk_limit_size : 8M flush_at_shutdown : true flush_interval : 10s flush_mode : interval flush_thread_count : 4 overflow_action : throw_exception queued_chunks_limit_size : 64 retry_max_interval : 60s retry_timeout : 1h retry_type : exponential_backoff retry_wait : 10s total_limit_size : 10G type : file configure_kubernetes_labels : false drop_single_key : true extra_labels : cluster : cluster-xxx extract_kubernetes_labels : false labels : namespace : \"\" pod : \"\" images : \"\" host : \"\" container : \"\" tream : \"\" remove_keys : - time - kubernetes - logtag - docker - metadata url : http://loki:3100 \u5728\u591a\u79df\u6236\u7684\u5834\u666f\u4e0b\uff0c\u6211\u5011\u751a\u81f3\u4e5f\u53ef\u4ee5\u5c07 Loki \u7684\u591a\u79df\u6236\u529f\u80fd\u6253\u958b\uff0c\u9019\u6a23\u6211\u5011\u53ef\u4ee5\u5728\u5b9a\u7fa9 output \u7684\u6642\u5019\u6307\u5b9a\u79df\u6236\u4fe1\u606f\uff0c\u6bd4\u5982: apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : loki-output spec : loki : url : http://loki:3100 username : test password : test tenant : test \u9019\u6a23\u6211\u5011\u5c31\u53ef\u4ee5\u9748\u6d3b\u7684\u5728 kubernets \u96c6\u7fa4\u4e2d\u5b9a\u7fa9\u591a\u79df\u6236\u7684\u65e5\u8a8c\u8f38\u51fa\u554f\u984c\u3002 Info loki \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/loki/ Kafka \u00b6 Fluentd \u7684 kafka \u8f38\u51fa\u63d2\u4ef6: apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : kafka-output spec : kafka : brokers : kafka-headless.kafka.svc.cluster.local:29092 topic_key : topic default_topic : topic required_acks\uff1a1 format : type : json buffer : tags : topic timekey : 1m timekey_wait : 30s timekey_use_utc : true Info kafka \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/kafka/ ElasticSearch \u00b6 Fluentd \u7684 ES \u8f38\u51fa\u63d2\u4ef6: apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : es-output spec : elasticsearch : host : elasticsearch.logging.svc.cluster.local port : 9200 scheme : https ssl_verify : false ssl_version : TLSv1_2 user : elastic logstash_format : true password : valueFrom : secretKeyRef : name : quickstart-es-elastic-user key : elastic buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true Info elasticsearch \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/elasticsearch/ \u53e6\u5916\u503c\u5f97\u63d0\u9192\u7684\u662f\uff0cOutput \u548c ClusterOutput \u90fd\u53ef\u4ee5\u88ab OutputRefs \u5f15\u7528\uff0c\u6bd4\u5982\u6211\u5011\u9700\u8981\u5c07\u65e5\u8a8c\u540c\u6642\u767c\u9001\u7d66 kafka \u548c elastichsearch \u6642\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u5982\u4e0b\u5b9a\u7fa9\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : nginx-flow namespace : default spec : filters : - parser : remove_key_name_field : true reserve_data : true parse : type : nginx match : - select : labels : app : nginx localOutputRefs : - kafka-output - es-output \u65e5\u8a8c\u6307\u6a19 \u00b6 \u61c9\u7528\u5728\u5bb9\u5668\u5316\u7684\u904e\u7a0b\u4e2d\uff0c\u7531\u65bc\u5bb9\u5668\u6587\u4ef6\u7cfb\u7d71\u7684\u81e8\u6642\u6027\uff0c\u958b\u767c\u8005\u59cb\u7d42\u9762\u81e8\u81ea\u5df1\u7684\u65e5\u8a8c\u6587\u4ef6\u843d\u76e4\u548c\u8f38\u51fa stdout \u7684\u5169\u96e3\u9078\u64c7\uff0c\u7576\u7814\u767c\u5c07\u61c9\u7528\u65e5\u8a8c\u7ba1\u7406\u7684\u6b0a\u5229\u4ea4\u7d66\u5e73\u53f0\u6642\uff0c\u610f\u5473\u8457\u5e73\u53f0\u8981\u505a\u7684\u6771\u897f\u9060\u6bd4\u61c9\u7528\u4e00\u5c0d\u4e00\u63a1\u96c6\u8981\u5fa9\u96dc\u3002 \u5728\u773e\u591a\u9700\u6c42\u4e2d\uff0c\u67d0\u5929\u6709SRE\u540c\u5b78\u63d0\u554f\uff1a\u201c\u6211\u5011\u5728\u963f\u91cc\u96f2\u4e2d\u53ef\u4ee5\u770b\u5230\u65e5\u8a8c\u63a1\u96c6\u7684\u5be6\u6642\u901f\u7387\uff0c\u6211\u5011\u9700\u8981\u70ba\u6b64\u5b9a\u5236\u8cea\u91cf\u76e3\u63a7\u6307\u6a19\u201d\u3002\u9019\u500b\u554f\u984c\u4e5f\u9ede\u9192\u4e86\u6211\uff0c\u5c0d\u65bc\u6211\u5011\u5728\u505a\u79c1\u6709\u96f2\u6642\uff0c\u7ad9\u5728\u5e73\u53f0\u5916\u9762\u5c0d\u65e5\u8a8c\u63a1\u96c6\u7684\u7ba1\u9053\u5167\u90e8\u7684\u89c0\u5bdf\u4e00\u76f4\u662f\u8655\u65bc\u4fe1\u606f\u7f3a\u5931\u7684\u76f2\u5340\u3002\u597d\u5728 fluentbit \u548c fluentd \u90fd\u6709\u7368\u7acb\u7684 prometheus \u63d2\u4ef6\u4f86\u66b4\u9732\u5167\u90e8\u7684\u6307\u6a19\uff0c\u4e0d\u904e\u5728\u7528 Logging Operator \u5f8c\uff0c\u5b83\u7684\u6307\u6a19\u63a1\u96c6\u4f9d\u6258 prometheus operator\uff0c\u4e14\u67b6\u69cb\u8db3\u5920\u6e05\u6670\uff0c\u56e0\u6b64\u6211\u5011\u4e5f\u53ef\u4ee5\u6709\u66f4\u591a\u7684\u9078\u64c7\u4f86\u6eff\u8db3\u7814\u767c\u7684\u9700\u6c42\u3002 \u9996\u5148\uff0c\u6211\u5011\u5728\u5b9a\u7fa9 logging \u6642\u53ef\u4ee5\u8b93 fluent bit(d)\u958b\u555f prometheus \u7684\u63a1\u96c6: spec : fluentd : metrics : serviceMonitor : true serviceMonitorConfig : honorLabels : true # \u6253\u958bhonorLabels\u4e3b\u8981\u662f\u70ba\u4e86\u4fdd\u6301\u7d44\u4ef6\u539f\u6709\u7684label\uff0c\u907f\u514d\u6a19\u7c64\u88ab\u8986\u84cb\u3002 fluentbit : metrics : serviceMonitor : true Info \u9019\u88e1\u53ef\u4ee5\u770b\u5230 Logging Operator \u4e3b\u8981\u4f9d\u9760 ServiceMonitor \u4f86\u505a\u63a1\u96c6\u7aef\u7684\u670d\u52d9\u767c\u73fe\uff0c\u9019\u88e1\u9700\u8981\u96c6\u7fa4\u5167\u90e8\u904b\u884c Prometheus Operator \u4ee5\u652f\u6301\u8a72 CRD\u3002\u5982\u679c\u96c6\u7fa4\u5167\u90e8\u6c92\u6709\u6539\u8cc7\u6e90\u985e\u578b\uff0c\u4e5f\u53ef\u4ee5\u85c9\u52a9 Prometheus \u81ea\u8eab\u7684\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u4f86\u5b8c\u6210\u6307\u6a19\u7684\u767c\u73fe\u548c\u63a1\u96c6\u3002 \u4e0d\u904e\u9019\u88e1\u50c5\u50c5\u53ea\u8072\u660e\u4e86\u63a1\u96c6\u7aef\u7684\u6307\u6a19\u5165\u53e3\uff0c\u9019\u88e1\u9762\u9ed8\u8a8d\u53ea\u5305\u542b\u4e86 Fluent bit(d)\u5167\u90e8\u57fa\u672c\u7684\u904b\u884c\u72c0\u614b\uff0c\u5982\u679c\u8981\u9032\u4e00\u6b65\u5be6\u73fe\u5c0d\u65e5\u8a8c\u901f\u7387\u7684\u76e3\u63a7\uff0c\u5c31\u5f97\u9700\u8981 Flunetd \u51fa\u99ac\u4e86\u3002 <filter ** > @type prometheus <metric> type counter name logging_entry_count desc Total number of log entries generated by either application containers or system components </metric> <labels> container: $.kubernetes.container_name pod: $.kubernetes.pod_name </labels> </filter> \u9019\u689d\u898f\u5247\u5c07\u5339\u914d\u6240\u6709\u9032\u5165 Fluentd \u7684\u65e5\u8a8c\uff0c \u4e26\u9032\u5165\u5230 Prometheus \u9019\u500b filter \u9032\u884c\u8a08\u6578\u8655\u7406\u3002\u4e26\u5c07\u7d71\u8a08\u5f8c\u7684\u6307\u6a19\u4ee5 logging_entry_count \u547d\u540d\uff0c\u6309\u7167\u65e5\u8a8c\u4e2d\u7684\u4e00\u4e9b\u5143\u6578\u64da\u4fe1\u606f\u4f5c\u70ba\u6307\u6a19\u7684 label\uff0c\u7528\u65bc\u5340\u5206\u4f86\u81f3\u4e0d\u540c\u7684\u5bb9\u5668\u3002 Info \u7531\u65bc\u9700\u8981\u89e3\u6790\u65e5\u8a8c\u7684 kubernetes \u5143\u6578\u64da\uff0c\u9019\u88e1\u53c8\u9700\u8981 Fluentd \u7684 kubernetes-metadata-filter\u63d2\u4ef6\u4f86\u505a\u5bb9\u5668\u5143\u6578\u64da\u7684\u63d0\u53d6\u3002\u5728 Logging Operator\u4e2d Kubernetes \u7684\u5143\u6578\u64da\u5728 FluentBit \u4e2d\u89e3\u6790\uff0c\u7121\u9700\u518d\u5728 Fluentd \u984d\u5916\u6dfb\u52a0\u8a72\u63d2\u4ef6\u3002 apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default namespace : demo spec : - prometheus : labels : container : $.kubernetes.container_name namespace : $.kubernetes.namespace_name node : $.kubernetes.host pod : $.kubernetes.pod_name metrics : - desc : Total number of log entries generated by either application containers or system components name : logging_entry_count type : counter globalOutputRefs : - containers-console match : - select : labels : what.you.want : collect \u7576\u4e0a\u8ff0\u6307\u6a19\u5165\u5eab Prometheus \u4e4b\u5f8c\uff0c\u6211\u5011\u4fbf\u53ef\u4ee5\u901a\u904e\u9019\u689d\u8a9e\u53e5\u67e5\u51fa\u7576\u524d\u96c6\u7fa4\u4e0b\u65e5\u8a8c\u63a1\u96c6\u5668\u7684\u61c9\u7528\u901f\u7387: sum by (pod) (rate(logging_entry_count[1m])) Tip \u4e0a\u8ff0\u50c5\u50c5\u662f\u5c0d\u65e5\u8a8c\u7e3d\u9ad4\u901f\u7387\u7684\u63a1\u96c6\u76e3\u63a7\uff0c\u5982\u679c\u6211\u5011\u9700\u8981\u5c0d\u65e5\u8a8c\u5167\u51fa\u73fe\u7684\u7279\u5b9a\u7684\u5167\u5bb9\u6216\u8005\u5c0d\u65e5\u8a8c\u7684 byte \u9032\u884c\u7d71\u8a08\u6642\uff0c\u5c31\u9700\u8981\u7d50\u5408\u5176\u5b83\u7684\u63d2\u4ef6\u9032\u884c\u7d44\u5408\u3002\u7576\u524d Logging Operator \u652f\u6301\u7684\u63d2\u4ef6\u9084\u9060\u4e0d\u5982 Fluentd \u8c50\u5bcc\uff0c\u4e0d\u904e\u6211\u5011\u53ef\u4ee5\u53c3\u7167\u5b98\u65b9\u6587\u6a94\uff0c\u7de8\u5beb\u9700\u8981\u7684plugin\u96c6\u6210\u81f3 Operator\u3002 Logging Operator Developers\u624b\u518a \u5c0d\u65bc\u65e5\u8a8c\u7d44\u4ef6\u5167\u90e8\u7684\u76e3\u63a7\u548c\u544a\u8b66\uff0cLogging Operator \u6709\u4e00\u5957\u81ea\u5df1\u7684\u898f\u5247\uff0c\u53ef\u4ee5\u5728 logging \u9019\u500b CRD \u4e2d\u555f\u7528\u9019\u500b\u529f\u80fd: spec : fluentbit : metrics : prometheusRules : true fluentd : metrics : prometheusRules : true Tip \u9019\u88e1\u7684 prometheusRules \u540c\u6a23\u662f Prometheus Operator \u7ba1\u7406\u7684\u8cc7\u6e90\uff0c\u5982\u679c\u96c6\u7fa4\u5167\u6c92\u6709\u6b64\u8cc7\u6e90\u985e\u578b\uff0c\u53ef\u624b\u52d5\u70ba Prometheus \u914d\u7f6e Rules \u56de\u5230\u6700\u521d\u7684\u554f\u984c\uff0c\u5982\u679c\u9700\u8981\u5c07\u65e5\u8a8c\u7684\u63a1\u96c6\u901f\u7387\u4f5c\u70ba\u61c9\u7528\u7684\u91cf\u5316\u6307\u6a19\u6642\uff0c\u5229\u7528 logging_entry_count \u5373\u53ef\u3002 \u65e5\u8a8c\u63a1\u6a23 \u00b6 \u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u65e5\u8a8c\u67b6\u69cb\u4e0d\u61c9\u8a72\u5c0d\u696d\u52d9\u65e5\u8a8c\u63a1\u53d6\u4e00\u4e9b\u4e0d\u53ef\u63a7\u7684\u7b56\u7565\uff0c\u9020\u6210\u61c9\u7528\u65e5\u8a8c\u7684\u4e0d\u5b8c\u6574\uff0c\u4f8b\u5982\u63a1\u6a23\u3002\u5728\u9019\u88e1\u986f\u7136\u6211\u4e5f\u4e0d\u63a8\u85a6\u4f60\u5728\u73fe\u6709\u7684\u67b6\u69cb\u4e2d\u555f\u7528\u6b64\u529f\u80fd\u3002\u4e0d\u904e\u6709\u6642\u5019\uff0c\u6216\u8005\u662f\u90e8\u5206\u9b54\u6cd5\u5e2b\u7121\u6cd5\u6709\u6548\u63a7\u88fd\u7a0b\u5e8f\u7684\u201c\u6d2a\u8352\u4e4b\u529b\u201d\u800c\u760b\u72c2\u8f38\u51fa\u6642\uff0c\u5e73\u53f0\u5c0d\u65bc\u9019\u985e\u4fcf\u76ae\u7684\u61c9\u7528\u6642\u5c31\u53ef\u4ee5\u63a1\u6a23\u7684\u65b9\u6848\uff0c\u7562\u7adf\u4fdd\u8b49\u6574\u500b\u65e5\u8a8c\u901a\u9053\u7684\u53ef\u7528\u6027\u662f\u5e73\u53f0\u7b2c\u4e00\u512a\u5148\u8981\u8003\u616e\u56e0\u7d20\u3002 Logging Operator \u5728\u65e5\u8a8c\u63a1\u6a23\u65b9\u9762\uff0c\u63a1\u7528\u4e86 Throttle \u9019\u500b\u63d2\u4ef6\u9650\u901f\u5668\uff0c\u7528\u4e00\u53e5\u8a71\u7e3d\u7d50\u9019\u500b\u63d2\u4ef6\u5c31\u662f\u70ba\u6bcf\u500b\u9032\u5165\u5230 filter \u65e5\u8a8c\u7684\u7ba1\u9053\u5f15\u5165\u4e86\u6f0f\u6876\u7b97\u6cd5\uff0c\u8b93\u5176\u4e1f\u68c4\u5230\u8d85\u904e\u901f\u7387\u9650\u5236\u7684\u65e5\u8a8c\u3002 apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default namespace : demo spec : - throttle : group_bucket_limit : 3000 group_bucket_period_s : 10 group_key : kubernetes.pod_name globalOutputRefs : - containers-console match : - select : labels : what.you.want : collect group_key: \u65e5\u8a8c\u63a1\u6a23\u7684\u805a\u5408 key\uff0c\u901a\u5e38\u6211\u5011\u6309\u7167 pod \u540d\u7a31\u4f86\u505a\u805a\u5408\uff0c\u4ea6\u6216\u76f4\u63a5\u586b\u5beb kubenretes.metadata \u7684\u5176\u5b83\u503c\u805a\u5408\u4e5f\u884c group_bucket_period_s: \u63a1\u6a23\u7684\u6642\u9593\u7bc4\u570d\uff0c\u9ed8\u8a8d 60s group_bucket_limit: \u63a1\u6a23\u671f\u9593\u7684\u65e5\u8a8c\u6876\u6700\u5927\u5bb9\u91cf \u65e5\u8a8c\u7684\u63a1\u6a23\u901f\u7387\u7531\u516c\u5f0f group_bucket_limit / group_bucket_period_s \u8a08\u7b97\uff0c\u7576 group_key \u4e2d\u7684\u65e5\u8a8c\u901f\u7387\u8d85\u904e\u503c\u6642\u5247\u6703\u4e1f\u5230\u5f8c\u7e8c\u65e5\u8a8c\u3002 \u7531\u65bc Throttle \u4e26\u6c92\u6709\u63a1\u7528\u4ee4\u724c\u6876\u7684\u7b97\u6cd5\uff0c\u6240\u4ee5\u5b83\u4e0d\u6703\u6709 burst \u4f86\u61c9\u5c0d\u7a81\u767c\u65e5\u8a8c\u91cf\u7684\u63a1\u96c6\u3002 \u65e5\u8a8c\u843d\u76e4 \u00b6 \u524d\u9762\u8aaa\u5230\uff0c\u6240\u6709\u57fa\u65bc\u5bb9\u5668\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u65e5\u8a8c\u7684\u6700\u4f73\u5be6\u8e10\u662f\u5c07\u65e5\u8a8c\u5b9a\u5411\u5230 stdout\u3001stderr \u4e2d\uff0c\u4f46\u4e26\u4e0d\u662f\u6240\u6709\u201c\u958b\u767c\u5718\u968a\u201d\u90fd\u6703\u9075\u5faa\u6b64\u7d04\u5b9a\uff0c\u65e5\u8a8c\u6587\u4ef6\u843d\u76e4\u4ecd\u7136\u662f\u7576\u4e0b\u591a\u6578\u7814\u767c\u7684\u9078\u64c7\u3002\u96d6\u7136\u7406\u8ad6\u4e0a\u4f86\u8aaa\u5bb9\u5668\u7684\u6a19\u6e96 (\u932f\u8aa4)\u8f38\u51fa\u4e5f\u662f\u5c07\u65e5\u8a8c\u6d41\u96c6\u4e2d\u91cd\u5b9a\u5230 /var/log/containers \u4e0b\u7684\u65e5\u8a8c\u6587\u4ef6\u4e0a\uff0c\u4f46\u4ecd\u7136\u53d7\u9650\u65bc\u904b\u884c\u6642\u914d\u7f6e\u6216\u8005\u5176\u4ed6\u786c\u76e4\u539f\u56e0\u5e36\u4f86\u4e0d\u53ef\u63a7\u7684\u56e0\u7d20\u3002 \u5c0d\u65bc\u65e5\u8a8c\u843d\u76e4\u7684\u5834\u666f\uff0c\u7576\u524d\u696d\u754c\u4e5f\u7121\u7d71\u4e00\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u4f46\u6b78\u7e3d\u8d77\u4f86\u5176\u5be6\u4e5f\u5c312\u500b\u5be6\u73fe\u65b9\u5f0f\uff1a sidecar \u65b9\u6848 \u00b6 \u6b64\u65b9\u6848\u662f\u5c07\u65e5\u8a8c\u63a1\u96c6\u5668\u8ddf\u96a8\u61c9\u7528\u5bb9\u5668\u4e00\u540c\u904b\u884c\u5728 pod \u7576\u4e2d\uff0c\u901a\u904e volume \u5171\u4eab\u65e5\u8a8c\u8def\u5f91\u7684\u65b9\u5f0f\u63a1\u96c6\u3002\u5e38\u898b\u7684\u662f\u65b9\u5f0f\u662f\u70ba kubernetes \u958b\u767c\u4e00\u5957\u55ae\u7368\u7684\u63a7\u5236\u5668\uff0c\u4e26\u63a1\u7528 MutatingWebhook \u5728pod \u555f\u52d5\u968e\u6bb5\u5c07 sidecar \u7684\u4fe1\u606f\u6ce8\u5165\u3002 sidecar \u7684\u65b9\u6848\u512a\u52e2\u5728\u65bc\u70ba\u6bcf\u500b\u61c9\u7528\u7684 sidecar \u914d\u7f6e\u76f8\u5c0d\u7368\u7acb\uff0c\u4f46\u52a3\u52e2\u9664\u4f54\u7528\u904e\u591a\u8cc7\u6e90\u5916\uff0c \u63a1\u96c6\u5668\u7684\u66f4\u65b0\u8fed\u4ee3\u9700\u8ddf\u96a8\u61c9\u7528\u7684\u751f\u547d\u9031\u671f \uff0c\u5c0d\u65bc\u6301\u7e8c\u7dad\u8b77\u4e0d\u592a\u512a\u96c5\u3002 node agent \u65b9\u6848 \u00b6 \u6b64\u65b9\u6848\u5c07\u65e5\u8a8c\u63a1\u96c6\u5668\u4ee5 DaemonSet \u7684\u65b9\u5f0f\u904b\u884c\u5728\u6bcf\u500b Node \u7576\u4e2d\uff0c\u7136\u5f8c\u5728\u64cd\u4f5c\u7cfb\u7d71\u5c64\u9762\u9032\u884c\u96c6\u4e2d\u63a1\u96c6\u3002\u901a\u5e38\u6b64\u65b9\u6848\u9700\u8981\u5e73\u53f0\u7684\u7814\u767c\u9700\u8981\u505a\u4e00\u5b9a\u8def\u5f91\u7b56\u7565\uff0c\u5c07\u56fa\u5b9a hostpath \u7684 vulume \u639b\u8f09\u7d66\u5bb9\u5668\u7528\u65bc\u61c9\u7528\u65e5\u8a8c\u843d\u76e4\u6642\u4f7f\u7528\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u5011\u77e5\u9053\u6240\u6709 Kubernetes \u9ed8\u8a8d\u7684\u5b58\u5132\u985e\u578b\u6216\u8005\u7b2c\u4e09\u65b9\u7684\u9075\u5faa CSI \u6a19\u6e96\u7684\u5b58\u5132\uff0c\u90fd\u6703\u5c07 Volume \u639b\u8f09\u5230 /var/lib/kubelet/pods/<pod_id>/volumes/kubernetes.io~<type>/<pvc_id>/mount \u76ee\u9304\u4e0b\uff0c\u6240\u4ee5\u5c0d\u65bc node agent \u66f4\u52a0\u512a\u96c5\u4e00\u9ede\u7684\u65b9\u6848\u662f\u5728 node agent \u4e2d\u8ce6\u4e88\u8abf\u7528 Kubernetes API \u7684\u6b0a\u9650\uff0c\u8b93\u5176\u77e5\u66c9\u88ab\u63a1\u96c6\u5bb9\u5668\u65e5\u8a8c\u6620\u5c04\u5728\u4e3b\u6a5f\u4e0b\u7684\u8def\u5f91\u3002 node agent \u65b9\u6848\u7684\u512a\u52e2\u5728\u65bc\u914d\u7f6e\u96c6\u4e2d\u7ba1\u7406\uff0c\u63a1\u96c6\u5668\u8ddf\u61c9\u7528\u5bb9\u5668\u89e3\u8026\uff0c\u4e92\u4e0d\u5f71\u97ff\u3002\u7f3a\u9ede\u5728\u65bc\u63a1\u96c6\u5668\u5b58\u5728\u541e\u5410\u4e0d\u8db3\u7684\u98a8\u96aa\u3002 \u53ef\u4ee5\u770b\u5230\u4e0a\u8ff0\u5169\u500b\u65b9\u6848\u4e2d\uff0c\u4e0d\u7ba1\u54ea\u4e00\u500b\u90fd\u8207 Logging Operator \u6cbe\u4e0d\u4e0a\u95dc\u4fc2\u3002\u78ba\u5be6\uff0c\u7576\u4e0b\u793e\u5340\u5c0d\u6b64\u5834\u666f\u4e0b\u9084\u6c92\u6709\u4e00\u500b\u884c\u4e4b\u6709\u6548\u7684\u65b9\u6848\uff0c\u4e0d\u904e\u6309\u7167\u5176\u601d\u8def\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u65e5\u8a8c\u6587\u4ef6\u8f49\u6210\u6a19\u6e96\uff08\u932f\u8aa4\uff09\u8f38\u51fa\u6d41\u4f86\u8b8a\u76f8\u8655\u7406\u9019\u500b\u554f\u984c\u3002 \u7528 tail \u4f86\u8209\u500b\u76f4\u89c0\u7684\u4f8b\u5b50\u4f86\u8aaa\u660e\u4e0a\u8ff0\u7684\u65b9\u6848\u3002 ... containers : - args : - -F - /path/to/your/log/file.log command : - tail image : busybox name : stream-log-file-[name] volumeMounts : - mountPath : /path/to/your/log name : mounted-log ... \u96d6\u7136 tail \u662f\u4e00\u500b\u6975\u5176\u7c21\u55ae\u7c97\u66b4\u7684\u65b9\u5f0f\uff0c\u4e14\u7121\u6cd5\u89e3\u6c7a\u65e5\u8a8c\u8f2a\u8f49\u7b49\u554f\u984c\uff0c\u4f46\u5b83\u7684\u78ba\u70ba Logging Operator \u63d0\u4f9b\u4e86\u4e00\u500b\u65b0\u7684\u65e5\u8a8c\u843d\u76e4\u5834\u666f\u4e0b\u7684\u65b9\u6848\u3002\u96d6\u7136\u770b\u4e0a\u53bb\u8207 sidecar \u5982\u51fa\u4e00\u8f4d\uff0c\u4e0d\u904e\u6700\u5927\u7684\u5340\u5225\u5728\u65bc\uff0c\u6b64\u65b9\u6848\u80fd\u8207 Logging Operator \u73fe\u6709\u7684\u65e5\u8a8c\u7ba1\u9053\u7121\u7e2b\u517c\u5bb9\uff0c\u65e5\u8a8c\u88ab\u63a1\u96c6\u5f8c\u4ecd\u7136\u80fd\u5728 flow \u968e\u6bb5\u9032\u884c\u8655\u7406\u3002 \u7e3d\u7d50 \u00b6 Logging Operator \u7ad9\u5728\u81ea\u52d5\u5316\u904b\u7dad\u7684\u89d2\u5ea6\u78ba\u5be6\u6709\u6548\u89e3\u6c7a\u4e86 Kubernetes \u5834\u666f\u4e0b\u65e5\u8a8c\u67b6\u69cb\u8907\u96dc\u548c\u61c9\u7528\u65e5\u8a8c\u63a1\u96c6\u96e3\u7684\u554f\u984c\uff0c\u96d6\u7136\u7576\u4e0b\u5c0d\u843d\u76e4\u65e5\u8a8c\u7684\u652f\u6301\u9084\u4e0d\u5920\u5168\u9762\u3002\u4f46\u96a8\u8457\u63a5\u5165\u7684\u7528\u6236\u9010\u6f38\u6210\u9577\uff0c\u73fe\u5728\u7684\u554f\u984c\u5728\u5c07\u4f86\u6216\u8a31\u9084\u6709\u66f4\u597d\u7684\u89e3\u6c7a\u65b9\u6848\u3002\u4e0d\u904e\uff0c\u7576\u4e0b\u5b83\u7684\u78ba\u4e0d\u5931\u70ba\u6700\u597d\u7684\u96f2\u539f\u751f\u65e5\u8a8c\u67b6\u69cb\u4e4b\u4e00\u3002","title":"Logging Operator \u65e5\u8a8c\u7ba1\u7406\u65b9\u6848"},{"location":"kubernetes/observability/logging/operator/logging-operator/#logging-operator-","text":"\u539f\u6587: Logging Operator - \u4f18\u96c5\u7684\u4e91\u539f\u751f\u65e5\u5fd7\u7ba1\u7406\u65b9\u6848 (\u4e00) Logging Operator - \u4f18\u96c5\u7684\u4e91\u539f\u751f\u65e5\u5fd7\u7ba1\u7406\u65b9\u6848 (\u4e8c) Logging Operator - \u4f18\u96c5\u7684\u4e91\u539f\u751f\u65e5\u5fd7\u7ba1\u7406\u65b9\u6848 (\u4e09) Logging Operator \u662f BanzaiCloud \u958b\u6e90\u7684\u4e00\u500b\u96f2\u539f\u751f\u5834\u666f\u4e0b\u7684\u65e5\u8a8c\u63a1\u96c6\u65b9\u6848\u3002\u5b83\u5728 2020 \u5e74 3 \u6708\u7684\u6642\u5019\u7d93\u904e\u91cd\u69cb\u5f8c\u7684 v3 \u7248\u672c\uff0c\u5e95\u5c64\u6191\u85c9\u9ad8\u6548\u7684 fluentbit \u548c\u63d2\u4ef6\u8c50\u5bcc\u7684 flunetd\uff0cLogging Operator\u5e7e\u4e4e\u5df2\u7d93\u5b8c\u7f8e\u7684\u9069\u914d\u4e86 kubernetes \u6a21\u5f0f\u4e0b\u7684\u65e5\u8a8c\u63a1\u96c6\u5834\u666f\u3002 Rancher \u5728 2.5 \u7248\u672c\u4e4b\u5f8c\u4e5f\u63a1\u7528\u4e86 Logging Operator \u4f5c\u70ba\u7d71\u4e00\u7684\u65e5\u8a8c\u89e3\u6c7a\u65b9\u6848\uff0c\u8db3\u4ee5\u8aaa\u660e\u5b83\u6b63\u5728\u88ab\u4e00\u4e9b\u4ee5 Kubernetes \u70ba\u6838\u5fc3\u7684\u7ba1\u7406\u5e73\u53f0\u63a5\u53d7\uff0c\u4e26\u96c6\u6210\u81f3\u5167\u90e8\u6838\u5fc3\u7d44\u4ef6\u3002 \u6211\u5011\u5148\u4f86\u770b\u770b\u5b83\u7684\u67b6\u69cb\u3002 \u53ef\u4ee5\u770b\u5230 Logging Operator \u5229\u7528 CRD \u7684\u65b9\u5f0f\u4ecb\u5165\u4e86\u65e5\u8a8c\u5f9e\u63a1\u96c6\u3001\u8def\u7531\u3001\u8f38\u51fa\u9019\u4e09\u500b\u968e\u6bb5\u7684\u914d\u7f6e\u3002\u5b83\u672c\u8cea\u4e0a\u4f86\u8aaa\u9084\u662f\u5229\u7528 DaemonSet \u548c StatefulSet \u5728\u96c6\u7fa4\u5167\u5206\u5225\u90e8\u7f72\u4e86 FluentBit \u548c Fluentd \u5169\u500b\u7d44\u4ef6\uff0cFluentBit \u5c07\u5bb9\u5668\u65e5\u8a8c\u63a1\u96c6\u4e26\u521d\u6b65\u8655\u7406\u5f8c\u8f49\u767c\u7d66 Fluentd \u505a\u9032\u4e00\u6b65\u7684\u89e3\u6790\u548c\u8def\u7531\uff0c\u6700\u7d42\u7531 Fluentd \u5c07\u65e5\u8a8c\u7d50\u679c\u8f49\u767c\u7d66\u4e0d\u540c\u7684\u670d\u52d9\u3002 \u9664\u4e86\u7ba1\u7406\u65e5\u8a8c\u5de5\u4f5c\u6d41\u5916\uff0cLogging Operator \u9084\u53ef\u4ee5\u8b93\u7ba1\u7406\u8005\u958b\u555f TLS \u4f86\u52a0\u5bc6\u65e5\u8a8c\u5728\u96c6\u7fa4\u5167\u90e8\u7684\u7db2\u7d61\u50b3\u8f38\uff0c\u4ee5\u53ca\u9ed8\u8a8d\u96c6\u6210\u4e86 ServiceMonitor \u4f86\u66b4\u9732\u65e5\u8a8c\u63a1\u96c6\u7aef\u7684\u72c0\u614b\u3002","title":"Logging Operator - \u512a\u96c5\u7684\u96f2\u539f\u751f\u65e5\u8a8c\u7ba1\u7406\u65b9\u6848"},{"location":"kubernetes/observability/logging/operator/logging-operator/#logging-operator-crd","text":"\u6574\u500b Logging Operator \u7684\u6838\u5fc3 CRD \u5c31\u53ea\u67095\u500b\uff0c\u5b83\u5011\u5206\u5225\u662f logging \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u65e5\u8a8c\u63a1\u96c6\u7aef(FleuntBit)\u548c\u50b3\u8f38\u7aef(Fleuntd)\u670d\u52d9\u7684\u57fa\u790e\u914d\u7f6e\uff1b flow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces \u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\u3002 clusterflow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\u3002 output \uff1a \u7528\u65bc\u5b9a\u7fa9namespace\u7d1a\u5225\u7684\u65e5\u8a8c\u7684\u8f38\u51fa\u548c\u53c3\u6578\uff1b clusteroutput \uff1a \u7528\u65bc\u5b9a\u7fa9\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u80fd\u628a\u88ab\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\uff1b \u901a\u904e\u90195\u500b CRD\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u51fa\u4e00\u500b Kubernetes \u96c6\u7fa4\u5167\u6bcf\u500b\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u5bb9\u5668\u65e5\u8a8c\u6d41\u5411","title":"Logging Operator CRD"},{"location":"kubernetes/observability/logging/operator/logging-operator/#logging-operator","text":"Logging Operator \u4f9d\u8cf4 Kuberentes1.14 \u4e4b\u5f8c\u7684\u7248\u672c\uff0c\u53ef\u4ee5\u5206\u5225\u7528 helm \u548c mainfest \u5169\u7a2e\u65b9\u5f0f\u5b89\u88dd\u3002 Helm(v3.21.0+)\u5b89\u88dd $ helm repo add banzaicloud-stable https://kubernetes-charts.banzaicloud.com $ helm repo update $ helm upgrade --install --wait --create-namespace --namespace logging logging-operator banzaicloud-stable/logging-operator \\ --set \"createCustomResource=false\" Manifest \u5b89\u88dd $ kubectl create ns logging # RBAC $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator-docs/master/docs/install/manifests/rbac.yaml # CRD $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_clusterflows.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_clusteroutputs.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_flows.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_loggings.yaml $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator/master/config/crd/bases/logging.banzaicloud.io_outputs.yaml # Operator $ kubectl -n logging create -f https://raw.githubusercontent.com/banzaicloud/logging-operator-docs/master/docs/install/manifests/deployment.yaml \u7576\u5b89\u88dd\u5b8c\u6210\u5f8c\uff0c\u6211\u5011\u9700\u8981\u9a57\u8b49\u4e0b\u670d\u52d9\u7684\u72c0\u614b # Operator \u72c0\u614b $ kubectl -n logging get pods NAME READY STATUS RESTARTS AGE logging-logging-operator-599c9cf846-5nw2n 1 /1 Running 0 52s # CRD \u72c0\u614b $ kubectl get crd | grep banzaicloud.io NAME CREATED AT clusterflows.logging.banzaicloud.io 2021 -03-25T08:49:30Z clusteroutputs.logging.banzaicloud.io 2021 -03-25T08:49:30Z flows.logging.banzaicloud.io 2021 -03-25T08:49:30Z loggings.logging.banzaicloud.io 2021 -03-25T08:49:30Z outputs.logging.banzaicloud.io 2021 -03-25T08:49:30Z","title":"Logging Operator \u5b89\u88dd"},{"location":"kubernetes/observability/logging/operator/logging-operator/#logging-operator_1","text":"","title":"Logging Operator \u914d\u7f6e"},{"location":"kubernetes/observability/logging/operator/logging-operator/#logging-crd","text":"","title":"Logging CRD"},{"location":"kubernetes/observability/logging/operator/logging-operator/#loggingspec","text":"LoggingSpec \u5b9a\u7fa9\u4e86\u6536\u96c6\u548c\u50b3\u8f38\u65e5\u8a8c\u6d88\u606f\u7684\u65e5\u8a8c\u57fa\u790e\u67b6\u69cb\u670d\u52d9\uff0c\u5176\u4e2d\u5305\u542b Fluentd \u548c Fluent-bit \u7684\u914d\u7f6e\u3002\u5b83\u5011\u90fd\u90e8\u7f72\u5728 controlNamespace \u6307\u5b9a\u7684\u547d\u540d\u7a7a\u9593\u5167\u3002\u4e00\u500b\u7c21\u55ae\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple namespace : logging spec : fluentd : {} fluentbit : {} controlNamespace : logging \u9019\u4efd\u6a23\u4f8b\u544a\u8a34\u4e86 Operator \u5728 logging \u547d\u540d\u7a7a\u9593\u5167\u5275\u5efa\u4e00\u500b\u9ed8\u8a8d\u914d\u7f6e\u7684\u65e5\u8a8c\u670d\u52d9\uff0c\u5176\u4e2d\u5305\u542b FluentBit \u548c Fluentd \u5169\u500b\u670d\u52d9\u3002 \u7576\u7136\u5be6\u969b\u4e0a\u6211\u5011\u5728\u751f\u7522\u74b0\u5883\u4e0a\u90e8\u7f72 FluentBit \u548c Fluentd \u4e0d\u6703\u53ea\u7528\u9ed8\u8a8d\u7684\u914d\u7f6e\uff0c\u901a\u5e38\u6211\u5011\u8981\u8003\u616e\u5f88\u591a\u65b9\u9762\uff0c\u6bd4\u5982\uff1a \u81ea\u5b9a\u7fa9\u93e1\u50cf \u65e5\u8a8c\u63a1\u96c6\u4f4d\u9ede\u6587\u4ef6\u7684\u6578\u64da\u6301\u4e45\u5316 Buffer \u6578\u64da\u6301\u4e45\u5316 CPU/\u5167\u5b58\u8cc7\u6e90\u9650\u5236 \u72c0\u614b\u76e3\u63a7 Fluentd \u526f\u672c\u6578\u4ee5\u53ca\u8ca0\u8f09\u5747\u8861 \u7db2\u7d61\u53c3\u6578\u512a\u5316 \u5bb9\u5668\u904b\u884c\u5b89\u5168 \u597d\u5728 Loggingspec \u88e1\u5c0d\u4e0a\u8ff0\u652f\u6301\u5f97\u90fd\u6bd4\u8f03\u5168\u9762\uff0c\u6211\u5011\u53ef\u4ee5\u53c3\u8003\u6587\u6a94\u4f86\u500b\u6027\u5316\u5b9a\u5236\u81ea\u5df1\u7684\u670d\u52d9\u3002 \u8b93\u6211\u5011\u6311\u5e7e\u500b\u91cd\u8981\u7684\u5b57\u6bb5\u8aaa\u660e\u7528\u9014\uff1a watchNamespaces \u5236\u5b9a\u8b93 Operator \u76e3\u807d Flow \u548c OutPut \u8cc7\u6e90\u7684\u547d\u540d\u7a7a\u9593\uff0c\u5982\u679c\u4f60\u662f\u591a\u79df\u6236\u5834\u666f\uff0c\u4e14\u6bcf\u500b\u79df\u6236\u90fd\u7528 logging \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u67b6\u69cb\u5316\uff0c\u53ef\u4ee5\u7528 watchNamespaces \u4f86\u95dc\u806f\u79df\u6236\u7684\u547d\u540d\u7a7a\u9593\u4f86\u7e2e\u5c0f\u8cc7\u6e90\u904e\u6ffe\u7bc4\u570d allowClusterResourcesFromAllNamespaces ClusterOutput\u548cClusterFlow \u9019\u6a23\u7684\u5168\u5c40\u8cc7\u6e90\u9ed8\u8a8d\u53ea\u5728 controlNamespace \u95dc\u806f\u7684\u547d\u540d\u7a7a\u9593\u4e2d\u751f\u6548\uff0c\u5982\u679c\u5728\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u4e2d\u5b9a\u7fa9\u90fd\u6703\u88ab\u5ffd\u7565\uff0c\u9664\u975e\u5c07allowClusterResourcesFromAllNamespaces \u8a2d\u7f6e\u70ba true Info LoggingSpec\u63cf\u8ff0\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/logging_types/","title":"LoggingSpec"},{"location":"kubernetes/observability/logging/operator/logging-operator/#fluentbitspec","text":"filterKubernetes \u7528\u4f86\u7372\u53d6\u65e5\u8a8c\u7684 Kubernetes \u5143\u6578\u64da\u7684\u63d2\u4ef6\uff0c\u4f7f\u7528\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : {} fluentbit : filterKubernetes : Kube_URL : \"https://kubernetes.default.svc:443\" Match : \"kube.*\" controlNamespace : logging \u4e5f\u53ef\u4ee5\u7528 disableKubernetesFilter \u5c07\u8a72\u529f\u80fd\u7981\u6b62\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : {} fluentbit : disableKubernetesFilter : true controlNamespace : logging Info filterKubernetes \u63cf\u8ff0\u6587\u6a94: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentbit_types/#filterkubernetes inputTail \u5b9a\u7fa9 FluentBit \u7684\u65e5\u8a8c tail \u63a1\u96c6\u914d\u7f6e\uff0c\u9019\u88e1\u9762\u6709\u5f88\u591a\u7d30\u7bc0\u7684\u53c3\u6578\u4f86\u63a7\u5236\uff0c\u914d\u7f6e\u6a23\u4f8b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : inputTail : Skip_Long_Lines : \"true\" #Parser: docker Parser : cri Refresh_Interval : \"60\" Rotate_Wait : \"5\" Mem_Buf_Limit : \"128M\" #Docker_Mode: \"true\" Docker_Mode : \"false \u5982\u679c Kubernetes \u96c6\u7fa4\u7684\u5bb9\u5668\u904b\u884c\u6642\u662f Containerd \u6216\u9019\u5176\u4ed6 CRI\uff0c\u5c31\u9700\u8981\u628a Parser \u6539\u6210 cri\uff0c\u540c\u6642\u7981\u7528 Docker_Mode\u3002 Info inputTail \u63cf\u8ff0\u6587\u6a94: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentbit_types/#inputtail buffers \u5b9a\u7fa9\u4e86 FluentBit \u7684\u7de9\u885d\u5340\u8a2d\u7f6e\uff0c\u9019\u500b\u6bd4\u8f03\u91cd\u8981\u3002\u7531\u65bc FluentBit \u662f\u4ee5 DaemonSet \u7684\u65b9\u5f0f\u90e8\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u63a1\u7528 hostPath \u7684\u6372\u639b\u8f09\u65b9\u5f0f\u4f86\u7d66\u5b83\u63d0\u4f9b\u6578\u64da\u6301\u4e45\u5316\u7684\u914d\u7f6e\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : bufferStorage : storage.backlog.mem_limit : 10M storage.path : /var/log/log-buffer bufferStorageVolume : hostPath : path : \"/var/log/log-buffer\" Info bufferStorage \u63cf\u8ff0\u6587\u6a94: https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentbit_types/#bufferstorage positiondb \u5b9a\u7fa9\u4e86 FluentBit \u63a1\u96c6\u65e5\u8a8c\u7684\u6587\u4ef6\u4f4d\u9ede\u4fe1\u606f\uff0c\u540c\u7406\u6211\u5011\u53ef\u4ee5\u7528 hostPath \u65b9\u5f0f\u652f\u6301\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : positiondb : hostPath : path : \"/var/log/positiondb\" image \u63d0\u4f9b\u81ea\u5b9a\u7fa9\u7684 FluentBit \u7684\u93e1\u50cf\u4fe1\u606f\uff0c\u9019\u88e1\u6211\u5f37\u70c8\u63a8\u85a6\u4f7f\u7528 FluentBit-1.7.3 \u4e4b\u5f8c\u7684\u93e1\u50cf\uff0c\u5b83\u4fee\u5fa9\u4e86\u63a1\u96c6\u7aef\u773e\u591a\u7db2\u7d61\u9023\u63a5\u8d85\u6642\u7684\u554f\u984c,\u5b83\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : image : repository : fluent/fluent-bit tag : 1.7.3 pullPolicy : IfNotPresent metrics \u5b9a\u7fa9\u4e86 FluentBit \u7684\u76e3\u63a7\u66b4\u9732\u7aef\u53e3\uff0c\u4ee5\u53ca\u96c6\u6210\u7684 ServiceMonitor \u63a1\u96c6\u5b9a\u7fa9\uff0c\u5b83\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : metrics : interval : 60s path : /api/v1/metrics/prometheus port : 2020 serviceMonitor : true resources \u5b9a\u7fa9\u4e86FluentBit\u7684\u8cc7\u6e90\u5206\u914d\u548c\u9650\u5236\u4fe1\u606f\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : resources : limits : cpu : \"1\" memory : 512Mi requests : cpu : 200m memory : 128Mi security \u5b9a\u7fa9\u4e86 FluentBit \u904b\u884c\u671f\u9593\u7684\u5b89\u5168\u8a2d\u7f6e\uff0c\u5176\u4e2d\u5305\u542b\u4e86 PSP\u3001RBAC\u3001securityContext\u548cpodSecurityContext\u3002\u4ed6\u5011\u5171\u540c\u7d44\u6210\u63a7\u5236\u4e86 FluentBit \u5bb9\u5668\u5167\u7684\u6b0a\u9650\uff0c\u5b83\u5011\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : security : podSecurityPolicyCreate : true roleBasedAccessControlCreate : true securityContext : allowPrivilegeEscalation : false readOnlyRootFilesystem : true podSecurityContext : fsGroup : 101 \u6027\u80fd\u53c3\u6578 \u9019\u88e1\u9762\u5b9a\u7fa9\u4e86 FluentBit \u7684\u4e00\u4e9b\u904b\u884c\u6027\u80fd\u65b9\u9762\u7684\u53c3\u6578\uff0c\u5176\u4e2d\u5305\u542b\uff1a \u958b\u555f forward \u8f49\u767c\u4e0a\u6e38\u61c9\u7b54\u76f8\u61c9 apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : forwardOptions : Require_ack_response : true TCP \u9023\u63a5\u53c3\u6578 apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : network : connectTimeout : 30 keepaliveIdleTimeout : 60 \u958b\u555f\u8ca0\u8f09\u5747\u8861\u6a21\u5f0f apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : enableUpstream : true \u8abf\u5ea6\u6c61\u9ede\u5bb9\u5fcd apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentbit : tolerations : - effect : NoSchedule key : node-role.kubernetes.io/master","title":"FluentbitSpec"},{"location":"kubernetes/observability/logging/operator/logging-operator/#fluentdspec","text":"buffers \u9019\u88e1\u4e3b\u8981\u5b9a\u7fa9 Fluentd \u7684 buffer \u6578\u64da\u6301\u4e45\u5316\u914d\u7f6e\uff0c\u7531\u65bc Fluentd \u662f\u4ee5 StatefulSet \u7684\u65b9\u5f0f\u90e8\u7f72\u7684\uff0c\u6240\u4ee5\u6211\u5011\u7528 hostPath \u5c31\u4e0d\u592a\u5408\u9069\uff0c\u9019\u88e1\u6211\u5011\u61c9\u8a72\u7528PersistentVolumeCliamTemplate \u7684\u65b9\u5f0f\u70ba\u6bcf\u4e00\u500b fluentd \u5be6\u4f8b\u5275\u5efa\u4e00\u584a\u5c08\u9580\u7684 buffer \u6578\u64da\u5377\uff0c\u6a23\u4f8b\u5982\u4e0b: apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : bufferStorageVolume : pvc : spec : accessModes : - ReadWriteOnce resources : requests : storage : 50Gi storageClassName : csi-rbd volumeMode : Filesystem \u9019\u88e1\u5982\u679c\u4e0d\u6307\u5b9a storageClassName \u7684\u8a71\uff0cOperator \u5c07\u901a\u904e StorageClass \u70ba default \u7684\u5b58\u5132\u63d2\u4ef6\u5275\u5efa pvc\u3002 FluentOutLogrotate \u5b9a\u7fa9\u4e86 Fluentd \u7684\u6a19\u6e96\u8f38\u51fa\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u914d\u7f6e\uff0c\u9019\u4e3b\u8981\u662f\u70ba\u4e86\u907f\u514d\u5728\u51fa\u73fe\u932f\u8aa4\u6642 Fluentd \u7522\u751f\u9023\u9396\u53cd\u61c9\uff0c\u4e26\u4e14\u932f\u8aa4\u6d88\u606f\u4f5c\u70ba\u65e5\u8a8c\u6d88\u606f\u8fd4\u56de\u7cfb\u7d71\u751f\u6210\u53e6\u4e00\u500b\u932f\u8aa4\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : fluentOutLogrotate : enabled : true path : /fluentd/log/out age : 10 size : 10485760 \u9019\u88e1\u8868\u9054\u7684\u610f\u601d\u5c31\u662f\u5c07 fluentd \u65e5\u8a8c\u91cd\u5b9a\u5411\u5230 /fluentd/log/out \u76ee\u9304\uff0c\u540c\u6642\u4fdd\u755910\u5929\uff0c\u6587\u4ef6\u6700\u5927\u4e0d\u8d85\u904e10M Info FluentOutLogrotate \u63cf\u8ff0\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentd_types/#fluentoutlogrotate Scaling \u9019\u88e1\u4e3b\u8981\u5b9a\u7fa9 fluentd \u7684\u526f\u672c\u6578\uff0c\u5982\u679c FluentBit \u958b\u555f UpStraem \u7684\u652f\u6301\uff0c\u8abf\u6574 Fluentd \u7684\u526f\u672c\u6578\u6703\u5c0e\u81f4 FluentBit \u6efe\u52d5\u66f4\u65b0\uff0c\u5b83\u7684\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : scaling : replicas : 4 Info scaling \u63cf\u8ff0\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/crds/v1beta1/fluentd_types/#fluentdscaling Worker \u9019\u88e1\u5b9a\u7fa9\u4e86 Fluentd \u5167\u90e8\u7684 Worker \u6578\u91cf\uff0c\u7531\u65bc Fluentd \u53d7\u9650\u65bc ruby\uff0c\u5b83\u9084\u662f\u4ee5\u55ae\u9032\u7a0b\u7684\u65b9\u5f0f\u8655\u7406\u65e5\u8a8c\u5de5\u4f5c\u6d41\uff0c\u589e\u52a0 worker \u6578\u53ef\u4ee5\u986f\u8457\u63d0\u9ad8 Fluentd \u7684\u4e26\u767c\uff0c\u6a23\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Logging metadata : name : default-logging-simple spec : fluentd : workers : 2 image \u5b9a\u7fa9\u4e86 Fluentd \u7684\u93e1\u50cf\u4fe1\u606f\uff0c\u9019\u88e1\u5fc5\u9808\u8981\u7528 Logging Operator \u5b9a\u5236\u7684\u93e1\u50cf\uff0c\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u93e1\u50cf\u7248\u672c\uff0c\u7d50\u69cb\u548c FluetnBit \u985e\u4f3c\u3002 security \u5b9a\u7fa9\u4e86 Fluentd \u904b\u884c\u671f\u9593\u7684\u5b89\u5168\u8a2d\u7f6e\uff0c\u5176\u4e2d\u5305\u542b\u4e86 PSP\u3001RBAC\u3001securityContext\u548cpodSecurityContext\uff0c\u7d50\u69cb\u548c FluentBit \u985e\u4f3c\u3002 metrics \u5b9a\u7fa9\u4e86 Fluentd \u7684\u76e3\u63a7\u66b4\u9732\u7aef\u53e3\uff0c\u4ee5\u53ca\u96c6\u6210\u7684 ServiceMonitor \u63a1\u96c6\u5b9a\u7fa9\uff0c\u7d50\u69cb\u548c FluentBit \u985e\u4f3c\u3002 resources \u5b9a\u7fa9\u4e86 Fluentd \u7684\u8cc7\u6e90\u5206\u914d\u548c\u9650\u5236\u4fe1\u606f\uff0c\u7d50\u69cb\u548c FluentBit \u985e\u4f3c\u3002 \u63a5\u4e0b\u4f86\u6211\u5011\u8981\u8b1b\u89e3 Logging Operator \u4e2d\u9664 logging \u5916\u7684 CRD \u61c9\u7528\u3002\u5728\u958b\u59cb\u4e4b\u524d\uff0c\u6211\u5011\u9084\u662f\u5148\u770b\u4e0b Logging Operator \u5c0d K8S \u4e2d\u8655\u7406\u5bb9\u5668\u65e5\u8a8c\u6d41\u5411\u7684\u908f\u8f2f\u5716\u3002 \u5176\u5be6\u6211\u5011\u53ef\u4ee5\u770b\u51fa\u4f86\uff0cLogging Operator \u6838\u5fc3\u7684\u908f\u8f2f\u4e3b\u8981\u5c31\u5728 Flow \u548c Output \u9019\u5169\u500b CRD\u3002\u7c21\u55ae\u4f86\u8aaa\uff0cFlow \u7684\u4f5c\u7528\u662f\u7528\u4f86\u8655\u7406\u65e5\u8a8c\u6d41\u7684\uff0cOutput \u7528\u4f86\u5b9a\u7fa9\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\u3002\u81f3\u65bc ClusterFlow \u548c ClusterOutput \u7121\u5916\u4e4e\u5c31\u662f\u4e00\u500b\u5168\u5c40\u7684\u8072\u660e\u7f77\u4e86\u3002","title":"FluentdSpec"},{"location":"kubernetes/observability/logging/operator/logging-operator/#flow-clusterflow-crd","text":"Flow \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684 filters \u548c outputs\uff0c\u5b83\u662f\u4e00\u500b namespaces \u7d1a\u5225\u7684 CRD \u8cc7\u6e90\u3002\u56e0\u6b64\uff0c\u6211\u5011\u53ef\u4ee5\u5728\u61c9\u7528\u6240\u5728\u7684\u547d\u540d\u7a7a\u9593\u5167\u6839\u64da Kubernetes \u6a19\u7c64\u4f86\u6c7a\u5b9a\u65e5\u8a8c\u662f\u5426\u88ab\u63a1\u96c6\uff0c\u540c\u6642\u4e5f\u80fd\u5b9a\u7fa9\u591a\u500b filter \u4f86\u5c0d\u65e5\u8a8c\u9032\u884c\u8655\u7406\u3002\u8209\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample namespace : default spec : filters : - parser : remove_key_name_field : true parse : type : nginx - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} localOutputRefs : - loki-output match : - select : labels : app : nginx \u9019\u689d Flow \u7684\u610f\u601d\u662f\uff0c\u8b93\u65e5\u8a8c\u63a1\u96c6\u7aef\u53ea\u8655\u7406\u4f86\u81ea default \u547d\u540d\u7a7a\u9593\u4e0b\uff0c\u6a19\u7c64 app=nginx \u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u540c\u6642\u4e26\u5c0d\u63a1\u96c6\u7684\u65e5\u8a8c\u6309\u7167 nginx \u7684\u683c\u5f0f\u9032\u884c\u89e3\u6790\uff0c\u4e26\u628a\u9019\u689d\u65e5\u8a8c\u6d41\u7684 tag \u5728fluentd \u5167\u90e8\u91cd\u5b9a\u5411\u70ba ${namespace_name}.${pod_name}.${container_name} \u3002 \u9019\u500b\u4f8b\u5b50\u88e1\u9762\uff0c\u6211\u5011\u8457\u91cd\u8a3b\u610f\u4e09\u500b\u5730\u65b9 match , filters \u548c localOutputRefs \u3002","title":"Flow \u8207 ClusterFlow CRD"},{"location":"kubernetes/observability/logging/operator/logging-operator/#match","text":"match \u662f\u8655\u7406\u65e5\u8a8c\u7684\u7b2c\u4e00\u6b65\uff0c\u6211\u5011\u9700\u8981\u5229\u7528 Kubernetes \u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6\u3002\u7576\u524d\u53ef\u7528\u7684\u5b57\u6bb5\u5982\u4e0b\uff1a namespaces \uff0c \u5339\u914d\u547d\u540d\u7a7a\u9593 labels \uff0c\u5339\u914d labels hosts \uff0c\u5339\u914d host \u6a5f\u5668 container_names \uff0c\u5339\u914d\u5bb9\u5668\u540d\u5b57 \u6211\u5011\u901a\u904e select \u548c exclude \u4f86\u9078\u64c7\u6216\u6392\u9664\u6211\u5011\u8981\u5339\u914d\u7684\u8cc7\u6e90\u985e\u578b\u3002\u6bd4\u5982\u4e0b\u9762\u4f8b\u5b50\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample namespace : default spec : match : - exclude : labels : component : reloader - select : labels : app : nginx componnet : nginx \u9019\u689d Flow \u5c31\u8072\u660e\u8b93\u5ba2\u6236\u7aef\u53ea\u8655\u7406 default \u547d\u540d\u7a7a\u9593\u4e0b\u6a19\u7c64\u70ba app=nginx, componnet=nginx \uff0c\u6392\u9664 component: reloader \u7684\u5bb9\u5668\u65e5\u8a8c\u3002 \u5c0d\u65bc ClusterFlow\uff0c\u6211\u5011\u53ef\u4ee5\u901a\u904e select \u4f86\u63a7\u5236\u591a\u500b namespaces \u4e0b\u7684\u65e5\u8a8c\u63a1\u96c6\u3002\u6bd4\u5982: apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : clusterflow-sample spec : match : - exclude : namespaces : - dev - test - select : labels : app : nginx \u9019\u689d\u8072\u660e\u5c31\u544a\u8a34\u4e86\u5ba2\u6236\u7aef\u53ea\u8655\u7406\u547d\u540d\u7a7a\u9593\u4e0d\u662f dev \u548c test \u800c\u4e14\u6a19\u7c64\u70ba app=nginx \u7684\u5bb9\u5668\u65e5\u8a8c\u3002 Tip ClusterFlow \u7684\u8072\u660e\u9ed8\u8a8d\u53ea\u5728 controlNamespace \u5b9a\u7fa9\u7684 namespace \u4e0b\u751f\u6548\uff0c\u5982\u679c\u8981\u5b9a\u7fa9\u5230\u5176\u4ed6\u547d\u540d\u7a7a\u9593\uff0c\u4f60\u9700\u8981\u5728\u5b9a\u7fa9 logging CRD\u6642\u6253\u958b allowClusterResourcesFromAllNamespaces \u5982\u679c\u6211\u5011\u9700\u8981\u7c21\u55ae\u7c97\u66b4\u7684\u63a1\u96c6\u6307\u5b9a namespaces \u4e0b\u6240\u6709\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u90a3\u9ebc\u53ea\u9700\u8981\u5b9a\u7fa9\u4e00\u500b\u5982\u4e0b\u5167\u5bb9\u7684 ClusterFlow \u5373\u53ef: apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : clusterflow-sample spec : match : - select : namespaces : - prod - dev - test","title":"match"},{"location":"kubernetes/observability/logging/operator/logging-operator/#filter","text":"Logging Operator \u7684 filter \u652f\u6301\u4e00\u4e9b\u5e38\u898b\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6\u3002\u53ef\u4ee5\u53c3\u8003\u4e0b\u9762\u9019\u500b\u8868\u683c: \u540d\u7a31 \u985e\u578b \u63cf\u8ff0 \u72c0\u614b \u7248\u672c Concat filters \u7528\u65bcfluentd\u8655\u7406\u65e5\u8a8c\u591a\u884c\u7684\u63d2\u4ef6 GA 2.4.0 Dedot filters \u8655\u7406\u5e36.\u7684\u5b57\u6bb5\u66ff\u63db\u63d2\u4ef6\uff0c\u901a\u5e38\u7528\u65bc\u8f38\u51fa\u5230elaticsearch\u524d\u7684\u5b57\u6bb5\u8f49\u5316 GA 1.0.0 Exception Detector filters Exception\u65e5\u8a8c\u6355\u7372\u5668\uff0c\u652f\u6301java, js, csharp, python, go, ruby, php GA 0.0.13 Enhance K8s Metadata filters banzaicloud\u958b\u767c\u7684k8s\u64f4\u5c55\u5143\u6578\u64da GA 0.0.0 Geo IP filters fluentd\u7684GeoIP\u5730\u5740\u5eab GA 1.3.2 Grep filters fluentd\u7684grep\u904e\u6ffe\u5668 GA more info Parser filters fluentd\u7684Parser\u89e3\u6790\u5668 GA more info Prometheus filters Prometheus\u63d2\u4ef6\uff0c\u53ef\u7528\u65bc\u5c0d\u65e5\u8a8c\u505a\u8a08\u6578 GA 1.8.5 Record Modifier filters fluentd \u5b57\u6bb5\u4fee\u6539\u63d2\u4ef6 GA 2.1.0 Record Transformer filters Mutates/transforms incoming event streams. GA more info Stdout filters \u6a19\u6e96\u8f38\u51fa\u63d2\u4ef6 GA more info SumoLogic filters Sumo Logic\u516c\u53f8\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6 GA 2.3.1 Tag Normaliser filters fluentd\u4e2d\u7684tag\u4fee\u6539\u5668 GA 0.1.1 Info filter \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/","title":"filter"},{"location":"kubernetes/observability/logging/operator/logging-operator/#parser","text":"Parser \u63d2\u4ef6\u6bd4\u8f03\u5e38\u898b\uff0c\u901a\u5e38\u6211\u5011\u7528\u5b83\u4f86\u89e3\u6790\u63a1\u96c6\u7684\u65e5\u8a8c\u5167\u5bb9\uff0c\u6bd4\u5982\u6211\u5011\u8981\u89e3\u6790\u7684\u65e5\u8a8c\u662f json \u683c\u5f0f\u5c31\u53ef\u4ee5\u6309\u7167\u5982\u4e0b\u65b9\u5f0f\u914d\u7f6e\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample filters : - parser : remove_key_name_field : true reserve_data : true key_name : \"log\" parse : type : json time_key : time time_format : \"%Y-%m-%dT%H:%M:%S.%NZ\" \u751a\u81f3\uff0c\u6211\u5011\u4e5f\u53ef\u4ee5\u5728\u65e5\u8a8c\u88e1\u5b9a\u7fa9\u591a\u7a2e\u985e\u578b\u7684\u683c\u5f0f\uff0c\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample spec : filters : - parser : remove_key_name_field : true reserve_data : true parse : type : multi_format patterns : - format : nginx - format : regexp expression : /foo/ - format : none \u9019\u6703\u751f\u6210 fluentd \u7684\u5982\u4e0b\u7684 fluentd \u914d\u7f6e <filter ** > @type parser @id test_parser key_name message remove_key_name_field true reserve_data true <parse> @type multi_format <pattern> format nginx </pattern> <pattern> expression /foo/ format regexp </pattern> <pattern> format none </pattern> </parse> </filter> Info parser \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/parser/","title":"Parser \u63d2\u4ef6"},{"location":"kubernetes/observability/logging/operator/logging-operator/#record_modifier","text":"record_modifier \u5141\u8a31\u6211\u5011\u5f9e\u5df2\u89e3\u6790\u7684\u65e5\u8a8c\u5b57\u6bb5\u88e1\u9762\u63d0\u53d6\u548c\u4fee\u6539\u5b57\u6bb5\u3002\u6bd4\u5982\u6211\u5011\u5728\u63a1\u96c6 kubernetes \u7684\u5bb9\u5668\u65e5\u8a8c\u6642\uff0c\u5e0c\u671b\u4fee\u6539\u90e8\u5206\u5143\u6578\u64da\u6642\uff0c\u5c31\u53ef\u4ee5\u4f7f\u7528\u9019\u500b\u63d2\u4ef6\u3002 apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample spec : filters : - record_modifier : records : - host : ${record.dig('kubernetes', 'host')} \u9019\u689d filter \u898f\u5247\u5c31\u5b9a\u7fa9\u4e86\u8b93 fluentd \u5728\u8655\u7406\u65e5\u8a8c\u5143\u6578\u64da\u6642\uff0c\u65b0\u52a0\u4e00\u500b\u5b57\u6bb5 host\uff0c\u5b83\u7684\u503c\u4f86\u81ea\u65bc .kubernetes.host \u3002\u5b83\u6700\u7d42\u5728 fluentd \u4e2d\u64cd\u4f5c\u7684\u914d\u7f6e\u662f\u9019\u6a23\u7684\u3002 <filter ** > @type record_modifier @id test_record_modifier <record> host ${record.dig('kubernetes', 'host')} </record> </filter>","title":"record_modifier \u63d2\u4ef6"},{"location":"kubernetes/observability/logging/operator/logging-operator/#prometheus","text":"prometheus \u662f\u7528\u4f86\u7d71\u8a08\u9032\u5165 fluentd \u65e5\u8a8c\u6d41\u4e26\u8655\u7406\u7684\u65e5\u8a8c\u57fa\u6578\uff0c\u6bd4\u5982\u6211\u5011\u60f3\u7d71\u8a08\u6a19\u7c64 app=nginx \u9019\u500b\u6253\u5370\u4e86\u591a\u5c11\u65e5\u8a8c\u6642\uff0c\u5c31\u53ef\u4ee5\u7528\u8a72\u63d2\u4ef6\u8655\u7406\uff0c apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : flow-sample spec : filters : - parser : remove_key_name_field : true reserve_data : true parse : type : nginx - prometheus : metrics : - name : total_counter desc : The total number of nginx in message. type : counter labels : app : nginx labels : host : ${hostname} tag : ${tag} namespace : $.kubernetes.namespace \u9019\u500b\u5c31\u8868\u793a\u4e86 nginx \u65e5\u8a8c\u5728 fluentd \u5171\u8a08\u8655\u7406\u4e86\u591a\u5c11\u884c\u6d88\u606f\uff0c\u9019\u5c0d\u6211\u5011\u7d71\u8a08\u696d\u52d9\u65e5\u8a8c\u8cc7\u6e90\u4f7f\u7528\u4f86\u8aaa\u6bd4\u8f03\u65b9\u4fbf\u7684\u3002 Info prometheus \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/prometheus/","title":"prometheus \u63d2\u4ef6"},{"location":"kubernetes/observability/logging/operator/logging-operator/#outputrefs","text":"OutputRefs \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u8def\u5f91\u3002\u5b83\u5206\u70ba localOutputRefs \u548c globalOutputRefs \u3002\u6545\u540d\u601d\u7fa9\uff0c localOutputRefs \u662f\u8ddf flow \u4e00\u6a23\u4f5c\u7528\u5728 namespace \u7d1a\u5225\uff0c\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u4e0b\u7684 Flow \u770b\u4e0d\u5230\u7576\u524d\u547d\u540d\u7a7a\u9593\u4e0b\u7684 output \u5b9a\u7fa9\u3002 globalOutputRefs \u70ba\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u8072\u660e\uff0c\u5b83\u80fd\u88ab\u6240\u6709\u547d\u540d\u7a7a\u9593\u4e0b\u7684 Flow \u548c ClusterFlow \u5f15\u7528\u3002","title":"outputRefs"},{"location":"kubernetes/observability/logging/operator/logging-operator/#output-clusteroutput-crd","text":"Output \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\uff0c\u76ee\u524d Logging Operator \u652f\u6301\u7684\u65e5\u8a8c\u8f38\u51fa\u63d2\u4ef6\u975e\u5e38\u591a\uff0c\u5305\u542b\u5982\u4e0b\u5167\u5bb9\uff1a Alibaba Cloud Amazon CloudWatch Amazon Elasticsearch Amazon Kinesis Amazon S3 Azure Storage Buffer Datadog Elasticsearch File Format Format rfc5424 Forward GELF Google Cloud Storage Grafana Loki Http Kafka LogDNA LogZ NewRelic Splunk SumoLogic Syslog \u9019\u88e1\u9762\u6211\u5011\u65e5\u5e38\u5de5\u4f5c\u4e2d\u7528\u5230\u7684\u65e5\u8a8c\u5b58\u5132\u6216\u67b6\u69cb\u5927\u6982\u5c31\u5305\u542b Loki , ElasticSearch , Kafka \u6216 S3 \u3002","title":"Output \u8207 ClusterOutput CRD"},{"location":"kubernetes/observability/logging/operator/logging-operator/#grafana-loki","text":"Grafana Loki \u63d2\u4ef6\u7528\u4f86\u5b9a\u7fa9 fluentd \u5c07\u65e5\u8a8c\u8f38\u51fa\u5230 Loki \u7576\u4e2d\uff0c\u6211\u5011\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u4e9b\u7279\u5b9a\u7684\u53c3\u6578\u4f86\u63a7\u5236\u548c\u512a\u5316\u65e5\u8a8c\u8f38\u51fa\uff0c\u6bd4\u5982\u4e0b\u9762\u9019\u500b\u6a23\u4f8b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : loki-output spec : loki : buffer : chunk_limit_size : 8M flush_at_shutdown : true flush_interval : 10s flush_mode : interval flush_thread_count : 4 overflow_action : throw_exception queued_chunks_limit_size : 64 retry_max_interval : 60s retry_timeout : 1h retry_type : exponential_backoff retry_wait : 10s total_limit_size : 10G type : file configure_kubernetes_labels : false drop_single_key : true extra_labels : cluster : cluster-xxx extract_kubernetes_labels : false labels : namespace : \"\" pod : \"\" images : \"\" host : \"\" container : \"\" tream : \"\" remove_keys : - time - kubernetes - logtag - docker - metadata url : http://loki:3100 \u5728\u591a\u79df\u6236\u7684\u5834\u666f\u4e0b\uff0c\u6211\u5011\u751a\u81f3\u4e5f\u53ef\u4ee5\u5c07 Loki \u7684\u591a\u79df\u6236\u529f\u80fd\u6253\u958b\uff0c\u9019\u6a23\u6211\u5011\u53ef\u4ee5\u5728\u5b9a\u7fa9 output \u7684\u6642\u5019\u6307\u5b9a\u79df\u6236\u4fe1\u606f\uff0c\u6bd4\u5982: apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : loki-output spec : loki : url : http://loki:3100 username : test password : test tenant : test \u9019\u6a23\u6211\u5011\u5c31\u53ef\u4ee5\u9748\u6d3b\u7684\u5728 kubernets \u96c6\u7fa4\u4e2d\u5b9a\u7fa9\u591a\u79df\u6236\u7684\u65e5\u8a8c\u8f38\u51fa\u554f\u984c\u3002 Info loki \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/loki/","title":"Grafana Loki"},{"location":"kubernetes/observability/logging/operator/logging-operator/#kafka","text":"Fluentd \u7684 kafka \u8f38\u51fa\u63d2\u4ef6: apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : kafka-output spec : kafka : brokers : kafka-headless.kafka.svc.cluster.local:29092 topic_key : topic default_topic : topic required_acks\uff1a1 format : type : json buffer : tags : topic timekey : 1m timekey_wait : 30s timekey_use_utc : true Info kafka \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/kafka/","title":"Kafka"},{"location":"kubernetes/observability/logging/operator/logging-operator/#elasticsearch","text":"Fluentd \u7684 ES \u8f38\u51fa\u63d2\u4ef6: apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : es-output spec : elasticsearch : host : elasticsearch.logging.svc.cluster.local port : 9200 scheme : https ssl_verify : false ssl_version : TLSv1_2 user : elastic logstash_format : true password : valueFrom : secretKeyRef : name : quickstart-es-elastic-user key : elastic buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true Info elasticsearch \u63d2\u4ef6\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/elasticsearch/ \u53e6\u5916\u503c\u5f97\u63d0\u9192\u7684\u662f\uff0cOutput \u548c ClusterOutput \u90fd\u53ef\u4ee5\u88ab OutputRefs \u5f15\u7528\uff0c\u6bd4\u5982\u6211\u5011\u9700\u8981\u5c07\u65e5\u8a8c\u540c\u6642\u767c\u9001\u7d66 kafka \u548c elastichsearch \u6642\uff0c\u6211\u5011\u5c31\u53ef\u4ee5\u5982\u4e0b\u5b9a\u7fa9\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : nginx-flow namespace : default spec : filters : - parser : remove_key_name_field : true reserve_data : true parse : type : nginx match : - select : labels : app : nginx localOutputRefs : - kafka-output - es-output","title":"ElasticSearch"},{"location":"kubernetes/observability/logging/operator/logging-operator/#_1","text":"\u61c9\u7528\u5728\u5bb9\u5668\u5316\u7684\u904e\u7a0b\u4e2d\uff0c\u7531\u65bc\u5bb9\u5668\u6587\u4ef6\u7cfb\u7d71\u7684\u81e8\u6642\u6027\uff0c\u958b\u767c\u8005\u59cb\u7d42\u9762\u81e8\u81ea\u5df1\u7684\u65e5\u8a8c\u6587\u4ef6\u843d\u76e4\u548c\u8f38\u51fa stdout \u7684\u5169\u96e3\u9078\u64c7\uff0c\u7576\u7814\u767c\u5c07\u61c9\u7528\u65e5\u8a8c\u7ba1\u7406\u7684\u6b0a\u5229\u4ea4\u7d66\u5e73\u53f0\u6642\uff0c\u610f\u5473\u8457\u5e73\u53f0\u8981\u505a\u7684\u6771\u897f\u9060\u6bd4\u61c9\u7528\u4e00\u5c0d\u4e00\u63a1\u96c6\u8981\u5fa9\u96dc\u3002 \u5728\u773e\u591a\u9700\u6c42\u4e2d\uff0c\u67d0\u5929\u6709SRE\u540c\u5b78\u63d0\u554f\uff1a\u201c\u6211\u5011\u5728\u963f\u91cc\u96f2\u4e2d\u53ef\u4ee5\u770b\u5230\u65e5\u8a8c\u63a1\u96c6\u7684\u5be6\u6642\u901f\u7387\uff0c\u6211\u5011\u9700\u8981\u70ba\u6b64\u5b9a\u5236\u8cea\u91cf\u76e3\u63a7\u6307\u6a19\u201d\u3002\u9019\u500b\u554f\u984c\u4e5f\u9ede\u9192\u4e86\u6211\uff0c\u5c0d\u65bc\u6211\u5011\u5728\u505a\u79c1\u6709\u96f2\u6642\uff0c\u7ad9\u5728\u5e73\u53f0\u5916\u9762\u5c0d\u65e5\u8a8c\u63a1\u96c6\u7684\u7ba1\u9053\u5167\u90e8\u7684\u89c0\u5bdf\u4e00\u76f4\u662f\u8655\u65bc\u4fe1\u606f\u7f3a\u5931\u7684\u76f2\u5340\u3002\u597d\u5728 fluentbit \u548c fluentd \u90fd\u6709\u7368\u7acb\u7684 prometheus \u63d2\u4ef6\u4f86\u66b4\u9732\u5167\u90e8\u7684\u6307\u6a19\uff0c\u4e0d\u904e\u5728\u7528 Logging Operator \u5f8c\uff0c\u5b83\u7684\u6307\u6a19\u63a1\u96c6\u4f9d\u6258 prometheus operator\uff0c\u4e14\u67b6\u69cb\u8db3\u5920\u6e05\u6670\uff0c\u56e0\u6b64\u6211\u5011\u4e5f\u53ef\u4ee5\u6709\u66f4\u591a\u7684\u9078\u64c7\u4f86\u6eff\u8db3\u7814\u767c\u7684\u9700\u6c42\u3002 \u9996\u5148\uff0c\u6211\u5011\u5728\u5b9a\u7fa9 logging \u6642\u53ef\u4ee5\u8b93 fluent bit(d)\u958b\u555f prometheus \u7684\u63a1\u96c6: spec : fluentd : metrics : serviceMonitor : true serviceMonitorConfig : honorLabels : true # \u6253\u958bhonorLabels\u4e3b\u8981\u662f\u70ba\u4e86\u4fdd\u6301\u7d44\u4ef6\u539f\u6709\u7684label\uff0c\u907f\u514d\u6a19\u7c64\u88ab\u8986\u84cb\u3002 fluentbit : metrics : serviceMonitor : true Info \u9019\u88e1\u53ef\u4ee5\u770b\u5230 Logging Operator \u4e3b\u8981\u4f9d\u9760 ServiceMonitor \u4f86\u505a\u63a1\u96c6\u7aef\u7684\u670d\u52d9\u767c\u73fe\uff0c\u9019\u88e1\u9700\u8981\u96c6\u7fa4\u5167\u90e8\u904b\u884c Prometheus Operator \u4ee5\u652f\u6301\u8a72 CRD\u3002\u5982\u679c\u96c6\u7fa4\u5167\u90e8\u6c92\u6709\u6539\u8cc7\u6e90\u985e\u578b\uff0c\u4e5f\u53ef\u4ee5\u85c9\u52a9 Prometheus \u81ea\u8eab\u7684\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u4f86\u5b8c\u6210\u6307\u6a19\u7684\u767c\u73fe\u548c\u63a1\u96c6\u3002 \u4e0d\u904e\u9019\u88e1\u50c5\u50c5\u53ea\u8072\u660e\u4e86\u63a1\u96c6\u7aef\u7684\u6307\u6a19\u5165\u53e3\uff0c\u9019\u88e1\u9762\u9ed8\u8a8d\u53ea\u5305\u542b\u4e86 Fluent bit(d)\u5167\u90e8\u57fa\u672c\u7684\u904b\u884c\u72c0\u614b\uff0c\u5982\u679c\u8981\u9032\u4e00\u6b65\u5be6\u73fe\u5c0d\u65e5\u8a8c\u901f\u7387\u7684\u76e3\u63a7\uff0c\u5c31\u5f97\u9700\u8981 Flunetd \u51fa\u99ac\u4e86\u3002 <filter ** > @type prometheus <metric> type counter name logging_entry_count desc Total number of log entries generated by either application containers or system components </metric> <labels> container: $.kubernetes.container_name pod: $.kubernetes.pod_name </labels> </filter> \u9019\u689d\u898f\u5247\u5c07\u5339\u914d\u6240\u6709\u9032\u5165 Fluentd \u7684\u65e5\u8a8c\uff0c \u4e26\u9032\u5165\u5230 Prometheus \u9019\u500b filter \u9032\u884c\u8a08\u6578\u8655\u7406\u3002\u4e26\u5c07\u7d71\u8a08\u5f8c\u7684\u6307\u6a19\u4ee5 logging_entry_count \u547d\u540d\uff0c\u6309\u7167\u65e5\u8a8c\u4e2d\u7684\u4e00\u4e9b\u5143\u6578\u64da\u4fe1\u606f\u4f5c\u70ba\u6307\u6a19\u7684 label\uff0c\u7528\u65bc\u5340\u5206\u4f86\u81f3\u4e0d\u540c\u7684\u5bb9\u5668\u3002 Info \u7531\u65bc\u9700\u8981\u89e3\u6790\u65e5\u8a8c\u7684 kubernetes \u5143\u6578\u64da\uff0c\u9019\u88e1\u53c8\u9700\u8981 Fluentd \u7684 kubernetes-metadata-filter\u63d2\u4ef6\u4f86\u505a\u5bb9\u5668\u5143\u6578\u64da\u7684\u63d0\u53d6\u3002\u5728 Logging Operator\u4e2d Kubernetes \u7684\u5143\u6578\u64da\u5728 FluentBit \u4e2d\u89e3\u6790\uff0c\u7121\u9700\u518d\u5728 Fluentd \u984d\u5916\u6dfb\u52a0\u8a72\u63d2\u4ef6\u3002 apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default namespace : demo spec : - prometheus : labels : container : $.kubernetes.container_name namespace : $.kubernetes.namespace_name node : $.kubernetes.host pod : $.kubernetes.pod_name metrics : - desc : Total number of log entries generated by either application containers or system components name : logging_entry_count type : counter globalOutputRefs : - containers-console match : - select : labels : what.you.want : collect \u7576\u4e0a\u8ff0\u6307\u6a19\u5165\u5eab Prometheus \u4e4b\u5f8c\uff0c\u6211\u5011\u4fbf\u53ef\u4ee5\u901a\u904e\u9019\u689d\u8a9e\u53e5\u67e5\u51fa\u7576\u524d\u96c6\u7fa4\u4e0b\u65e5\u8a8c\u63a1\u96c6\u5668\u7684\u61c9\u7528\u901f\u7387: sum by (pod) (rate(logging_entry_count[1m])) Tip \u4e0a\u8ff0\u50c5\u50c5\u662f\u5c0d\u65e5\u8a8c\u7e3d\u9ad4\u901f\u7387\u7684\u63a1\u96c6\u76e3\u63a7\uff0c\u5982\u679c\u6211\u5011\u9700\u8981\u5c0d\u65e5\u8a8c\u5167\u51fa\u73fe\u7684\u7279\u5b9a\u7684\u5167\u5bb9\u6216\u8005\u5c0d\u65e5\u8a8c\u7684 byte \u9032\u884c\u7d71\u8a08\u6642\uff0c\u5c31\u9700\u8981\u7d50\u5408\u5176\u5b83\u7684\u63d2\u4ef6\u9032\u884c\u7d44\u5408\u3002\u7576\u524d Logging Operator \u652f\u6301\u7684\u63d2\u4ef6\u9084\u9060\u4e0d\u5982 Fluentd \u8c50\u5bcc\uff0c\u4e0d\u904e\u6211\u5011\u53ef\u4ee5\u53c3\u7167\u5b98\u65b9\u6587\u6a94\uff0c\u7de8\u5beb\u9700\u8981\u7684plugin\u96c6\u6210\u81f3 Operator\u3002 Logging Operator Developers\u624b\u518a \u5c0d\u65bc\u65e5\u8a8c\u7d44\u4ef6\u5167\u90e8\u7684\u76e3\u63a7\u548c\u544a\u8b66\uff0cLogging Operator \u6709\u4e00\u5957\u81ea\u5df1\u7684\u898f\u5247\uff0c\u53ef\u4ee5\u5728 logging \u9019\u500b CRD \u4e2d\u555f\u7528\u9019\u500b\u529f\u80fd: spec : fluentbit : metrics : prometheusRules : true fluentd : metrics : prometheusRules : true Tip \u9019\u88e1\u7684 prometheusRules \u540c\u6a23\u662f Prometheus Operator \u7ba1\u7406\u7684\u8cc7\u6e90\uff0c\u5982\u679c\u96c6\u7fa4\u5167\u6c92\u6709\u6b64\u8cc7\u6e90\u985e\u578b\uff0c\u53ef\u624b\u52d5\u70ba Prometheus \u914d\u7f6e Rules \u56de\u5230\u6700\u521d\u7684\u554f\u984c\uff0c\u5982\u679c\u9700\u8981\u5c07\u65e5\u8a8c\u7684\u63a1\u96c6\u901f\u7387\u4f5c\u70ba\u61c9\u7528\u7684\u91cf\u5316\u6307\u6a19\u6642\uff0c\u5229\u7528 logging_entry_count \u5373\u53ef\u3002","title":"\u65e5\u8a8c\u6307\u6a19"},{"location":"kubernetes/observability/logging/operator/logging-operator/#_2","text":"\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u65e5\u8a8c\u67b6\u69cb\u4e0d\u61c9\u8a72\u5c0d\u696d\u52d9\u65e5\u8a8c\u63a1\u53d6\u4e00\u4e9b\u4e0d\u53ef\u63a7\u7684\u7b56\u7565\uff0c\u9020\u6210\u61c9\u7528\u65e5\u8a8c\u7684\u4e0d\u5b8c\u6574\uff0c\u4f8b\u5982\u63a1\u6a23\u3002\u5728\u9019\u88e1\u986f\u7136\u6211\u4e5f\u4e0d\u63a8\u85a6\u4f60\u5728\u73fe\u6709\u7684\u67b6\u69cb\u4e2d\u555f\u7528\u6b64\u529f\u80fd\u3002\u4e0d\u904e\u6709\u6642\u5019\uff0c\u6216\u8005\u662f\u90e8\u5206\u9b54\u6cd5\u5e2b\u7121\u6cd5\u6709\u6548\u63a7\u88fd\u7a0b\u5e8f\u7684\u201c\u6d2a\u8352\u4e4b\u529b\u201d\u800c\u760b\u72c2\u8f38\u51fa\u6642\uff0c\u5e73\u53f0\u5c0d\u65bc\u9019\u985e\u4fcf\u76ae\u7684\u61c9\u7528\u6642\u5c31\u53ef\u4ee5\u63a1\u6a23\u7684\u65b9\u6848\uff0c\u7562\u7adf\u4fdd\u8b49\u6574\u500b\u65e5\u8a8c\u901a\u9053\u7684\u53ef\u7528\u6027\u662f\u5e73\u53f0\u7b2c\u4e00\u512a\u5148\u8981\u8003\u616e\u56e0\u7d20\u3002 Logging Operator \u5728\u65e5\u8a8c\u63a1\u6a23\u65b9\u9762\uff0c\u63a1\u7528\u4e86 Throttle \u9019\u500b\u63d2\u4ef6\u9650\u901f\u5668\uff0c\u7528\u4e00\u53e5\u8a71\u7e3d\u7d50\u9019\u500b\u63d2\u4ef6\u5c31\u662f\u70ba\u6bcf\u500b\u9032\u5165\u5230 filter \u65e5\u8a8c\u7684\u7ba1\u9053\u5f15\u5165\u4e86\u6f0f\u6876\u7b97\u6cd5\uff0c\u8b93\u5176\u4e1f\u68c4\u5230\u8d85\u904e\u901f\u7387\u9650\u5236\u7684\u65e5\u8a8c\u3002 apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default namespace : demo spec : - throttle : group_bucket_limit : 3000 group_bucket_period_s : 10 group_key : kubernetes.pod_name globalOutputRefs : - containers-console match : - select : labels : what.you.want : collect group_key: \u65e5\u8a8c\u63a1\u6a23\u7684\u805a\u5408 key\uff0c\u901a\u5e38\u6211\u5011\u6309\u7167 pod \u540d\u7a31\u4f86\u505a\u805a\u5408\uff0c\u4ea6\u6216\u76f4\u63a5\u586b\u5beb kubenretes.metadata \u7684\u5176\u5b83\u503c\u805a\u5408\u4e5f\u884c group_bucket_period_s: \u63a1\u6a23\u7684\u6642\u9593\u7bc4\u570d\uff0c\u9ed8\u8a8d 60s group_bucket_limit: \u63a1\u6a23\u671f\u9593\u7684\u65e5\u8a8c\u6876\u6700\u5927\u5bb9\u91cf \u65e5\u8a8c\u7684\u63a1\u6a23\u901f\u7387\u7531\u516c\u5f0f group_bucket_limit / group_bucket_period_s \u8a08\u7b97\uff0c\u7576 group_key \u4e2d\u7684\u65e5\u8a8c\u901f\u7387\u8d85\u904e\u503c\u6642\u5247\u6703\u4e1f\u5230\u5f8c\u7e8c\u65e5\u8a8c\u3002 \u7531\u65bc Throttle \u4e26\u6c92\u6709\u63a1\u7528\u4ee4\u724c\u6876\u7684\u7b97\u6cd5\uff0c\u6240\u4ee5\u5b83\u4e0d\u6703\u6709 burst \u4f86\u61c9\u5c0d\u7a81\u767c\u65e5\u8a8c\u91cf\u7684\u63a1\u96c6\u3002","title":"\u65e5\u8a8c\u63a1\u6a23"},{"location":"kubernetes/observability/logging/operator/logging-operator/#_3","text":"\u524d\u9762\u8aaa\u5230\uff0c\u6240\u6709\u57fa\u65bc\u5bb9\u5668\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u65e5\u8a8c\u7684\u6700\u4f73\u5be6\u8e10\u662f\u5c07\u65e5\u8a8c\u5b9a\u5411\u5230 stdout\u3001stderr \u4e2d\uff0c\u4f46\u4e26\u4e0d\u662f\u6240\u6709\u201c\u958b\u767c\u5718\u968a\u201d\u90fd\u6703\u9075\u5faa\u6b64\u7d04\u5b9a\uff0c\u65e5\u8a8c\u6587\u4ef6\u843d\u76e4\u4ecd\u7136\u662f\u7576\u4e0b\u591a\u6578\u7814\u767c\u7684\u9078\u64c7\u3002\u96d6\u7136\u7406\u8ad6\u4e0a\u4f86\u8aaa\u5bb9\u5668\u7684\u6a19\u6e96 (\u932f\u8aa4)\u8f38\u51fa\u4e5f\u662f\u5c07\u65e5\u8a8c\u6d41\u96c6\u4e2d\u91cd\u5b9a\u5230 /var/log/containers \u4e0b\u7684\u65e5\u8a8c\u6587\u4ef6\u4e0a\uff0c\u4f46\u4ecd\u7136\u53d7\u9650\u65bc\u904b\u884c\u6642\u914d\u7f6e\u6216\u8005\u5176\u4ed6\u786c\u76e4\u539f\u56e0\u5e36\u4f86\u4e0d\u53ef\u63a7\u7684\u56e0\u7d20\u3002 \u5c0d\u65bc\u65e5\u8a8c\u843d\u76e4\u7684\u5834\u666f\uff0c\u7576\u524d\u696d\u754c\u4e5f\u7121\u7d71\u4e00\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u4f46\u6b78\u7e3d\u8d77\u4f86\u5176\u5be6\u4e5f\u5c312\u500b\u5be6\u73fe\u65b9\u5f0f\uff1a","title":"\u65e5\u8a8c\u843d\u76e4"},{"location":"kubernetes/observability/logging/operator/logging-operator/#sidecar","text":"\u6b64\u65b9\u6848\u662f\u5c07\u65e5\u8a8c\u63a1\u96c6\u5668\u8ddf\u96a8\u61c9\u7528\u5bb9\u5668\u4e00\u540c\u904b\u884c\u5728 pod \u7576\u4e2d\uff0c\u901a\u904e volume \u5171\u4eab\u65e5\u8a8c\u8def\u5f91\u7684\u65b9\u5f0f\u63a1\u96c6\u3002\u5e38\u898b\u7684\u662f\u65b9\u5f0f\u662f\u70ba kubernetes \u958b\u767c\u4e00\u5957\u55ae\u7368\u7684\u63a7\u5236\u5668\uff0c\u4e26\u63a1\u7528 MutatingWebhook \u5728pod \u555f\u52d5\u968e\u6bb5\u5c07 sidecar \u7684\u4fe1\u606f\u6ce8\u5165\u3002 sidecar \u7684\u65b9\u6848\u512a\u52e2\u5728\u65bc\u70ba\u6bcf\u500b\u61c9\u7528\u7684 sidecar \u914d\u7f6e\u76f8\u5c0d\u7368\u7acb\uff0c\u4f46\u52a3\u52e2\u9664\u4f54\u7528\u904e\u591a\u8cc7\u6e90\u5916\uff0c \u63a1\u96c6\u5668\u7684\u66f4\u65b0\u8fed\u4ee3\u9700\u8ddf\u96a8\u61c9\u7528\u7684\u751f\u547d\u9031\u671f \uff0c\u5c0d\u65bc\u6301\u7e8c\u7dad\u8b77\u4e0d\u592a\u512a\u96c5\u3002","title":"sidecar \u65b9\u6848"},{"location":"kubernetes/observability/logging/operator/logging-operator/#node-agent","text":"\u6b64\u65b9\u6848\u5c07\u65e5\u8a8c\u63a1\u96c6\u5668\u4ee5 DaemonSet \u7684\u65b9\u5f0f\u904b\u884c\u5728\u6bcf\u500b Node \u7576\u4e2d\uff0c\u7136\u5f8c\u5728\u64cd\u4f5c\u7cfb\u7d71\u5c64\u9762\u9032\u884c\u96c6\u4e2d\u63a1\u96c6\u3002\u901a\u5e38\u6b64\u65b9\u6848\u9700\u8981\u5e73\u53f0\u7684\u7814\u767c\u9700\u8981\u505a\u4e00\u5b9a\u8def\u5f91\u7b56\u7565\uff0c\u5c07\u56fa\u5b9a hostpath \u7684 vulume \u639b\u8f09\u7d66\u5bb9\u5668\u7528\u65bc\u61c9\u7528\u65e5\u8a8c\u843d\u76e4\u6642\u4f7f\u7528\u3002 \u9664\u6b64\u4e4b\u5916\uff0c\u6211\u5011\u77e5\u9053\u6240\u6709 Kubernetes \u9ed8\u8a8d\u7684\u5b58\u5132\u985e\u578b\u6216\u8005\u7b2c\u4e09\u65b9\u7684\u9075\u5faa CSI \u6a19\u6e96\u7684\u5b58\u5132\uff0c\u90fd\u6703\u5c07 Volume \u639b\u8f09\u5230 /var/lib/kubelet/pods/<pod_id>/volumes/kubernetes.io~<type>/<pvc_id>/mount \u76ee\u9304\u4e0b\uff0c\u6240\u4ee5\u5c0d\u65bc node agent \u66f4\u52a0\u512a\u96c5\u4e00\u9ede\u7684\u65b9\u6848\u662f\u5728 node agent \u4e2d\u8ce6\u4e88\u8abf\u7528 Kubernetes API \u7684\u6b0a\u9650\uff0c\u8b93\u5176\u77e5\u66c9\u88ab\u63a1\u96c6\u5bb9\u5668\u65e5\u8a8c\u6620\u5c04\u5728\u4e3b\u6a5f\u4e0b\u7684\u8def\u5f91\u3002 node agent \u65b9\u6848\u7684\u512a\u52e2\u5728\u65bc\u914d\u7f6e\u96c6\u4e2d\u7ba1\u7406\uff0c\u63a1\u96c6\u5668\u8ddf\u61c9\u7528\u5bb9\u5668\u89e3\u8026\uff0c\u4e92\u4e0d\u5f71\u97ff\u3002\u7f3a\u9ede\u5728\u65bc\u63a1\u96c6\u5668\u5b58\u5728\u541e\u5410\u4e0d\u8db3\u7684\u98a8\u96aa\u3002 \u53ef\u4ee5\u770b\u5230\u4e0a\u8ff0\u5169\u500b\u65b9\u6848\u4e2d\uff0c\u4e0d\u7ba1\u54ea\u4e00\u500b\u90fd\u8207 Logging Operator \u6cbe\u4e0d\u4e0a\u95dc\u4fc2\u3002\u78ba\u5be6\uff0c\u7576\u4e0b\u793e\u5340\u5c0d\u6b64\u5834\u666f\u4e0b\u9084\u6c92\u6709\u4e00\u500b\u884c\u4e4b\u6709\u6548\u7684\u65b9\u6848\uff0c\u4e0d\u904e\u6309\u7167\u5176\u601d\u8def\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u65e5\u8a8c\u6587\u4ef6\u8f49\u6210\u6a19\u6e96\uff08\u932f\u8aa4\uff09\u8f38\u51fa\u6d41\u4f86\u8b8a\u76f8\u8655\u7406\u9019\u500b\u554f\u984c\u3002 \u7528 tail \u4f86\u8209\u500b\u76f4\u89c0\u7684\u4f8b\u5b50\u4f86\u8aaa\u660e\u4e0a\u8ff0\u7684\u65b9\u6848\u3002 ... containers : - args : - -F - /path/to/your/log/file.log command : - tail image : busybox name : stream-log-file-[name] volumeMounts : - mountPath : /path/to/your/log name : mounted-log ... \u96d6\u7136 tail \u662f\u4e00\u500b\u6975\u5176\u7c21\u55ae\u7c97\u66b4\u7684\u65b9\u5f0f\uff0c\u4e14\u7121\u6cd5\u89e3\u6c7a\u65e5\u8a8c\u8f2a\u8f49\u7b49\u554f\u984c\uff0c\u4f46\u5b83\u7684\u78ba\u70ba Logging Operator \u63d0\u4f9b\u4e86\u4e00\u500b\u65b0\u7684\u65e5\u8a8c\u843d\u76e4\u5834\u666f\u4e0b\u7684\u65b9\u6848\u3002\u96d6\u7136\u770b\u4e0a\u53bb\u8207 sidecar \u5982\u51fa\u4e00\u8f4d\uff0c\u4e0d\u904e\u6700\u5927\u7684\u5340\u5225\u5728\u65bc\uff0c\u6b64\u65b9\u6848\u80fd\u8207 Logging Operator \u73fe\u6709\u7684\u65e5\u8a8c\u7ba1\u9053\u7121\u7e2b\u517c\u5bb9\uff0c\u65e5\u8a8c\u88ab\u63a1\u96c6\u5f8c\u4ecd\u7136\u80fd\u5728 flow \u968e\u6bb5\u9032\u884c\u8655\u7406\u3002","title":"node agent \u65b9\u6848"},{"location":"kubernetes/observability/logging/operator/logging-operator/#_4","text":"Logging Operator \u7ad9\u5728\u81ea\u52d5\u5316\u904b\u7dad\u7684\u89d2\u5ea6\u78ba\u5be6\u6709\u6548\u89e3\u6c7a\u4e86 Kubernetes \u5834\u666f\u4e0b\u65e5\u8a8c\u67b6\u69cb\u8907\u96dc\u548c\u61c9\u7528\u65e5\u8a8c\u63a1\u96c6\u96e3\u7684\u554f\u984c\uff0c\u96d6\u7136\u7576\u4e0b\u5c0d\u843d\u76e4\u65e5\u8a8c\u7684\u652f\u6301\u9084\u4e0d\u5920\u5168\u9762\u3002\u4f46\u96a8\u8457\u63a5\u5165\u7684\u7528\u6236\u9010\u6f38\u6210\u9577\uff0c\u73fe\u5728\u7684\u554f\u984c\u5728\u5c07\u4f86\u6216\u8a31\u9084\u6709\u66f4\u597d\u7684\u89e3\u6c7a\u65b9\u6848\u3002\u4e0d\u904e\uff0c\u7576\u4e0b\u5b83\u7684\u78ba\u4e0d\u5931\u70ba\u6700\u597d\u7684\u96f2\u539f\u751f\u65e5\u8a8c\u67b6\u69cb\u4e4b\u4e00\u3002","title":"\u7e3d\u7d50"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/","text":"Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580 \u00b6 \u539f\u6587: https://mp.weixin.qq.com/s?__biz=MzkyNzM4Nzk1NQ==&mid=2247500852&idx=1&sn=6f993e57a508166cb8d32927742673f4&scene=21#wechat_redirect \u80cc\u666f\u6982\u8ff0 \u00b6 \u5728 SUSE Rancher 2.5 \u4ee5\u524d\uff0c\u65e5\u8a8c\u6536\u96c6\u7684\u67b6\u69cb\u662f\u4f7f\u7528 Fluentd \u6536\u96c6\u6307\u5b9a\u76ee\u9304\u65e5\u8a8c\u6216\u8005\u5bb9\u5668\u6a19\u6e96\u8f38\u51fa\u6d41\u5f8c\uff0c\u518d\u901a\u904e UI \u65e5\u8a8c\u529f\u80fd\u9801\u9762\u7684\u914d\u7f6e\u767c\u9001\u5230\u6307\u5b9a\u7684\u5f8c\u7aef\u3002\u5982 Elasticsearch\u3001splunk\u3001kafka\u3001syslog\u3001fluentd \u7b49\u5e38\u898b\u7684\u5f8c\u7aef\u5de5\u5177\uff0c\u53ef\u4ee5\u81ea\u52d5\u5316\u5730\u6536\u96c6 kubernetes \u96c6\u7fa4\u548c\u904b\u884c\u65bc\u96c6\u7fa4\u4e4b\u4e0a\u7684\u5de5\u4f5c\u8ca0\u8f09\u65e5\u8a8c\u3002\u9019\u7a2e\u65b9\u5f0f\u7121\u7591\u662f\u975e\u5e38\u7c21\u55ae\u3001\u6613\u7528\u3001\u65b9\u4fbf\u7684\uff0c\u4f46\u662f\u96a8\u8457\u7528\u6236\u5c0d\u96f2\u539f\u751f\u7406\u89e3\u7684\u52a0\u6df1\uff0c\u5c0d\u696d\u52d9\u65e5\u8a8c\u5206\u6790\u9846\u7c92\u5ea6\u8981\u6c42\u7684\u63d0\u9ad8\uff0c\u4e4b\u524d\u7684\u65e5\u8a8c\u6536\u96c6\u65b9\u5f0f\u6709\u4e9b\u592a\u904e\u6b7b\u677f\uff0c\u9748\u6d3b\u6027\u975e\u5e38\u5dee\uff0c\u5df2\u7d93\u7121\u6cd5\u6eff\u8db3\u5c0d\u65e5\u8a8c\u6536\u96c6\u5177\u6709\u66f4\u9ad8\u8981\u6c42\u7684\u7528\u6236\u4e86\u3002 \u65bc\u662f\u5f9e SUSE Rancher 2.5 \u7248\u672c\u958b\u59cb\uff0cBanzaiCloud \u516c\u53f8\u7684\u958b\u6e90\u7522\u54c1 Logging Operator \u6210\u70ba\u4e86\u65b0\u4e00\u4ee3 SUSE Rancher \u5bb9\u5668\u96f2\u5e73\u53f0\u65e5\u8a8c\u63a1\u96c6\u529f\u80fd\u7684\u7d44\u6210\u7d44\u4ef6\u3002 SUSE Rancher 2.5 \u7248\u672c\u4f5c\u70ba\u65b0\u65e5\u8a8c\u7d44\u4ef6\u7684\u904e\u6e21\u7248\u672c\uff0c\u4fdd\u7559\u4e86\u8001\u7248\u672c\u7684\u65e5\u8a8c\u6536\u96c6\u65b9\u5f0f\uff0c\u4e26\u5c07\u5168\u65b0\u7684 Logging Operator \u4f5c\u70ba\u5be6\u9a57\u6027\u529f\u80fd\u4f7f\u7528\uff1bSUSE Rancher 2.6 \u7248\u672c\u5247\u5df2\u7d93\u5b8c\u5168\u4f7f\u7528\u4e86 Logging Operator \u4f5c\u70ba\u65e5\u8a8c\u6536\u96c6\u5de5\u5177\u3002 \u672c\u6587\u5c07\u7531\u6dfa\u5230\u6df1\u5730\u63a2\u7d22\u5168\u65b0\u7684 SUSE Rancher 2.6 Logging Operator \u529f\u80fd\u548c\u5b83\u7684\u4f7f\u7528\u65b9\u5f0f\u3002 \u4ec0\u9ebc\u662f Logging Operator \u00b6 Logging Operator \u662f BanzaiCloud \u57fa\u65bc\u96f2\u539f\u751f\u5834\u666f\u7684\u958b\u6e90\u65e5\u8a8c\u63a1\u96c6\u65b9\u6848\uff0cSUSE Rancher 2.6 \u7248\u672c\u5728\u6574\u5408\u4e86\u8a72\u7522\u54c1\u4e4b\u5f8c\uff0c\u5c07\u6703\u5728\u7528\u6236\u7684\u64cd\u4f5c\u4e0b\u81ea\u52d5\u90e8\u7f72 Logging Operator \u4e26\u81ea\u52d5\u914d\u7f6e kuberletes logging pipeline\u3002 Logging Operator \u67b6\u69cb \u00b6 \u4ee5\u4e0a\u662f Logging Operator \u5b98\u65b9\u67b6\u69cb\u5716\u3002 Logging Operator \u4f7f\u7528 CRD \u7684\u65b9\u5f0f\u6c7a\u5b9a\u4e86\u65e5\u8a8c\u63a1\u96c6\u3001\u898f\u5247\u8def\u7531\u3001\u8f38\u51fa\u9019\u4e09\u500b\u968e\u6bb5\u7684\u914d\u7f6e\uff0c\u5b83\u4f7f\u7528 Daemonset \u5728\u96c6\u7fa4\u7bc0\u9ede\u4e0a\u90e8\u7f72 Fluentbit \u7d44\u4ef6\uff0c\u4f7f\u7528 StatefulSet \u90e8\u7f72 Fluentd \u7d44\u4ef6\u3002\u9996\u5148\u7531 Fluentbit \u7d44\u4ef6\u9032\u884c\u65e5\u8a8c\u6536\u96c6\u4e26\u521d\u6b65\u8655\u7406\u4e4b\u5f8c\uff0c\u767c\u9001\u5230 Fluentd \u7d44\u4ef6\u9032\u884c\u9032\u4e00\u6b65\u7684\u89e3\u6790\u8655\u7406\uff0c\u6700\u7d42\u7531 Fluentd \u7d44\u4ef6\u767c\u9001\u5230\u4e0d\u540c\u7684\u5f8c\u7aef\u5de5\u5177\u4e0a\u3002 Logging Operator CRD \u00b6 \u4e0a\u6587\u63d0\u5230\uff0cLogging Operator \u4f7f\u7528 CRD \u7684\u65b9\u5f0f\u6c7a\u5b9a\u4e86\u65e5\u8a8c\u63a1\u96c6\u3001\u898f\u5247\u8def\u7531\u3001\u8f38\u51fa\u9019\u4e09\u500b\u968e\u6bb5\u7684\u914d\u7f6e\uff0c\u5176\u4f7f\u7528\u7684 CRD \u4e3b\u8981\u6709\u4ee5\u4e0b5\u7a2e\u985e\u578b\uff1a logging \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u65e5\u8a8c\u63a1\u96c6\u7aef (FleuntBit) \u548c\u50b3\u8f38\u7aef (Fleuntd) \u670d\u52d9\u7684\u57fa\u790e\u914d\u7f6e\uff0c\u5728 SUSE Rancher 2.6 \u7248\u672c\u4e2d\uff0c\u5df2\u7d93\u7531 Rancher \u81ea\u52d5\u5316\u90e8\u7f72\u5b8c\u6210\uff1b flow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; clusterflow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; output \uff1a\u7528\u65bc\u5b9a\u7fa9 namespace (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u7684\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u53ea\u80fd\u88ab\u540c\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\uff1b clusteroutput \uff1a\u7528\u65bc\u5b9a\u7fa9\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u80fd\u628a\u88ab\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\u3002 \u4ee5\u4e0a 5 \u500b CRD \u985e\u578b\u975e\u5e38\u91cd\u8981\uff0c\u6c7a\u5b9a\u4e86\u4e00\u500b Kubernetes \u96c6\u7fa4\u5167\u6bcf\u500b\u547d\u540d\u7a7a\u9593\u751a\u81f3\u6bcf\u500b\u5bb9\u5668\u7684\u65e5\u8a8c\u8f38\u51fa\u5230\u54ea\u88e1\u3002 \u555f\u7528 SUSE Rancher 2.6 Logging \u00b6 SUSE Rancher 2.6 \u6210\u529f\u5275\u5efa\u4e0b\u6e38 Kubernetes \u96c6\u7fa4\u5f8c\uff0c\u53ef\u4ee5\u5728\u96c6\u7fa4\u5de5\u5177\u9801\u9762\u627e\u5230 Logging \u5de5\u5177\u7684\u90e8\u7f72\u5165\u53e3\uff0c\u5982\u4e0b\u5716\u6240\u793a\uff1a \u9ede\u64ca\u5b89\u88dd\u6309\u9215\u5f8c\uff0c\u9078\u64c7\u7d44\u4ef6\u5b89\u88dd\u7684\u9805\u76ee\uff0c\u4e00\u822c\u9078\u64c7\u70ba System \u9805\u76ee\uff0c\u5728\u8a72\u9805\u76ee\u4e2d\u904b\u884c\u8207\u96c6\u7fa4\u904b\u884c\u76f8\u95dc\u7684\u7d44\u4ef6\uff1b\u9ede\u64ca\u4e0b\u4e00\u6b65\u5f8c\uff0cUI \u6703\u8981\u6c42\u8f38\u5165\u914d\u7f6e Docker \u6839\u76ee\u9304\u548c System Log Path\uff1b \u6ce8\u610f\uff1a\u5982\u679c\u5e95\u5c64\u5bb9\u5668\u904b\u884c\u6642 (Runtime)\u70ba Docker\uff0c\u9ed8\u8a8d\u70ba\uff1a /var/lib/docker \u3002\u5982\u679c\u81ea\u5b9a\u7fa9\u904e\uff0c\u8acb\u586b\u5beb\u6b63\u78ba\u7684 Docker Root Dir \u76ee\u9304\uff0c\u53ef\u4ee5\u901a\u904e docker info \uff5c grep Docker Root Dir \u547d\u4ee4\u67e5\u770b\uff1b \u6ce8\u610f\uff1a System Log Path \u7528\u65bc\u6536\u96c6\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71 Journal \u65e5\u8a8c\uff0c\u5982\u679c\u586b\u5beb\u932f\u8aa4\u6703\u5c0e\u81f4\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u65e5\u8a8c\u7121\u6cd5\u6536\u96c6\uff0c\u78ba\u8a8d\u8a72\u8def\u5f91\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a ## \u786e\u8ba4Journal Log Path\u68c0\u67e5\u65b9\u5f0f\uff0c\u5728\u8282\u70b9\u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4 cat /etc/systemd/journald.conf | grep -E ^ \\# ?Storage | cut -d \"=\" -f2 1 \u3001\u5982\u679c\u8fd4\u56depersistent\uff0c\u5219systemdLogPath\u5e94\u8be5\u662f/var/log/journal\uff1b 2 \u3001\u5982\u679c\u8fd4\u56devolatile\uff0c\u5219systemdLogPath\u5e94\u8be5\u662f/run/log/journal\uff1b 3 \u3001\u5982\u679c\u8fd4\u56deauto\uff0c\u5219\u68c0\u67e5/var/log/journal\u662f\u5426\u5b58\u5728\uff1b - \u5982\u679c/var/log/journal\u5b58\u5728\uff0c\u5219\u4f7f\u7528/var/log/journal\uff1b - \u5982\u679c/var/log/journal\u4e0d\u5b58\u5728\uff0c\u5219\u4f7f\u7528/run/log/journal\uff1b \u8f38\u5165\u6b63\u78ba\u7684 Docker \u6839\u76ee\u9304\u548c systemdLogPath \u5f8c\uff0c\u9ede\u64ca\u5b89\u88dd\uff0cSUSE Rancher 2.6 \u6703\u81ea\u52d5\u90e8\u7f72 Logging Operator \u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u90e8\u7f72\u662f\u5426\u6210\u529f kubectl get pod -n cattle-logging-system NAME READY STATUS RESTARTS AGE rancher-logging-96b68cc4b-vqxnd 1 /1 Running 0 9m54s rancher-logging-fluentbit-cntgb 1 /1 Running 0 69s rancher-logging-fluentbit-hwmdx 1 /1 Running 0 71s rancher-logging-fluentbit-nw7rw 1 /1 Running 0 71s rancher-logging-fluentd-0 2 /2 Running 0 9m34s rancher-logging-fluentd-configcheck-ac2d4553 0 /1 Completed 0 9m48s \u90e8\u7f72\u5b8c\u6210\u5f8c\uff0cSUSE Rancher 2.6 \u96c6\u7fa4 UI \u4e0a\u591a\u4e86\u4e00\u500b\u65e5\u8a8c\u9078\u9805\u5361\uff0c\u53ef\u4ee5\u7531\u6b64\u914d\u7f6e\u4e0a\u6587\u63d0\u5230\u7684 flow\u3001clusterflow\u3001output\u3001clusteroutput \u8cc7\u6e90\u5c0d\u8c61\uff0c\u5f9e\u800c\u5b8c\u6210\u6574\u500b\u65e5\u8a8c\u63a1\u96c6\u3001\u904e\u6ffe\u8def\u7531\u3001\u8f38\u51fa\u7684\u5168\u6d41\u7a0b\u914d\u7f6e\u3002 \u5f9e SUSE Rancher 2.6 UI \u4e0a\u76f4\u63a5\u9032\u884c\u65e5\u8a8c\u63a1\u96c6\u6d41\u7a0b\u7684\u914d\u7f6e\u56fa\u7136\u65b9\u4fbf\uff0c\u4f46\u662f\u5c0d Logging Operator \u6bd4\u8f03\u719f\u6089\u7684\u201c\u5927\u795e\u201d\u6216\u8005\u7d93\u5e38\u4f7f\u7528\u7684\u201c\u5927\u4f6c\u201d\uff0c\u53ef\u4ee5\u4f7f\u7528 SUSE Rancher 2.6 UI \u76f4\u63a5\u9032\u884c\u914d\u7f6e\uff0c\u5f9e\u800c\u5b8c\u6210\u6574\u500b\u65e5\u8a8c\u63a1\u96c6\u3001\u904e\u6ffe\u8def\u7531\u3001\u8f38\u51fa\u7684\u5168\u6d41\u7a0b\u914d\u7f6e\uff1b\u5c0d\u65bc\u525b\u525b\u5347\u7d1a\u70ba SUSE Rancher 2.6 \u6216\u8005\u525b\u525b\u63a5\u89f8 Logging Operator \u7684\u201c\u5c0f\u767d\u201d\u670b\u53cb\u5011\uff0c\u54b1\u5011\u9084\u662f\u4e0d\u8981\u8457\u6025\u4e0a\u624b\u4e86\uff0c\u6df1\u5165\u6dfa\u51fa\u3001\u5faa\u5e8f\u6f38\u9032\uff0c\u7e7c\u7e8c\u5f80\u4e0b\u8b80\u5b8c\uff0c\u770b\u770b\u9019\u4e9b CRD \u662f\u600e\u9ebc\u914d\u7f6e\u548c\u5de5\u4f5c\u7684\u3002 Flow \u548c ClusterFlow \u00b6 \u5f9e\u672c\u6587\u6700\u958b\u59cb\u7684\u67b6\u69cb\u6d41\u7a0b\u5716\u53ef\u4ee5\u770b\u51fa\uff0c\u6574\u500b Logging Operator \u6700\u70ba\u6838\u5fc3\u7684\u5169\u500b\u6982\u5ff5\u5c31\u662f flow \u548c output\uff0c\u5176\u4e2d flow \u5c31\u662f\u7528\u4f86\u8655\u7406\u65e5\u8a8c\u6d41\u7684\uff0c\u6c7a\u5b9a\u4e86\u5f9e\u54ea\u88e1\u63a1\u96c6\u3001\u600e\u9ebc\u904e\u6ffe\u3001\u5982\u4f55\u8def\u7531\u5206\u767c\uff1bclusterflow \u5177\u6709\u76f8\u540c\u7684\u529f\u80fd\uff0c\u662f\u500b\u5168\u5c40 flow\u3002 \u5728\u4e86\u89e3 flow CRD \u7684\u5b9a\u7fa9\u4e4b\u524d\uff0c\u5148\u7528\u4e00\u500b\u7c21\u55ae\u7684 flow \u793a\u4f8b\u4f86\u9032\u884c\u4ee5\u4e0b\u5206\u6790\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"elasticsearch-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx \u9019\u500b flow \u7684\u610f\u601d\u662f\uff0c\u53ea\u6703\u63a1\u96c6 default \u547d\u540d\u7a7a\u9593\u5167\u6a19\u7c64 app=nginx \u7684\u5bb9\u5668\u65e5\u8a8c\uff0c\u63a1\u96c6\u65e5\u8a8c\u5f8c\u6309\u7167 nginx \u683c\u5f0f\u9032\u884c\u89e3\u6790\uff0c\u4e26\u4e14\u5c07\u9019\u500b\u65e5\u8a8c\u6d41\u7684 tag \u5728 fluentd \u6700\u7d42\u532f\u7e3d\u6642\u91cd\u5b9a\u5411\u70ba ${namespace_name}.${pod_name}.${container_name} \u683c\u5f0f\u3002 match \u00b6 \u4e0a\u9762\u7684\u4f8b\u5b50\u88e1\u6709\u4e00\u500b\u975e\u5e38\u91cd\u8981\u7684\u5b9a\u7fa9 match\uff0c\u5b83\u5b9a\u7fa9\u4e86\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6\uff0c\u6839\u64da Logging Operato \u5b98\u65b9\u6587\u6a94\u7d66\u51fa\u7684\u8aaa\u660e\uff0c\u7576\u524d\u53ef\u4ee5\u4f7f\u7528\u7684\u5b57\u6bb5\u6709\u4ee5\u4e0b\u5e7e\u7a2e\uff1a namespaces \u4f7f\u7528\u547d\u540d\u7a7a\u9593\u9032\u884c\u5339\u914d\uff1b labels \u4f7f\u7528\u6a19\u7c64\u9032\u884c\u5339\u914d\uff1b hosts \u4f7f\u7528\u4e3b\u6a5f\u9032\u884c\u5339\u914d\uff1b container_names \u4f7f\u7528\u5bb9\u5668\u540d\u7a31\u9032\u884c\u5339\u914d\u3002 \u8a2d\u60f3\u4e00\u500b\u5834\u666f\uff0c\u5728\u4e00\u500b Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u6211\u5011\u60f3\u6392\u9664\u67d0\u4e9b\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u4f7f\u7528\u5339\u914d\u9700\u8981\u5beb\u7121\u6578\u500b\u5339\u914d\u898f\u5247\uff0c\u9019\u986f\u7136\u662f\u4e0d\u5408\u7406\u7684\uff0c\u6240\u4ee5\u5b98\u65b9\u7d66\u4e86 exclude \u5b57\u6bb5\uff0c\u4f7f\u7528\u6392\u9664\u3002\u4f8b\u5b50\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"es-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - exclude : ## \u6392\u9664\u6240\u6709\u6a19\u7c64\u662fapp:nginx\u7684\u5bb9\u5668 labels : app : nginx \u4e0a\u9762\u9019\u500b\u4f8b\u5b50\u6703\u6392\u9664\u63a1\u96c6\u6240\u6709\u6a19\u7c64\u662f app:nginx \u7684\u5bb9\u5668\u65e5\u8a8c\uff1b exclude \u548c select \u53ef\u4ee5\u540c\u6642\u5b58\u5728\uff0c\u4e5f\u53ef\u4ee5\u6709\u591a\u500b exclude \u548c select \u5b58\u5728\uff0c\u66f4\u9748\u6d3b\u7684\u5b9a\u7fa9\u9700\u8981\u63a1\u96c6\u54ea\u4e9b\u5bb9\u5668\u65e5\u8a8c\u3002 \u9664\u4e86 flow \u4ee5\u5916\u9084\u6709 clusterflow\u3002\u8a2d\u60f3\u4e00\u500b\u5834\u666f\uff0c\u6211\u5011\u6709 N \u500b namespaces\uff0c\u4f46\u662f\u6211\u5011\u9700\u8981\u63a1\u96c6\u9664\u4e86\u67d0\u4e00\u500b namespaces \u4ee5\u5916\u7684\u6240\u6709 namespaces \u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u9019\u500b\u6642\u5019\uff0c\u6bcf\u500b namespaces \u8a2d\u5b9a\u4e00\u689d flow \u660e\u986f\u662f\u4e0d\u5408\u7406\u7684\uff0c\u9019\u5c31\u9700\u8981\u4f7f\u7528 clusterflow \u8a2d\u7f6e\u898f\u5247\u4f86\u9032\u884c\u63a1\u96c6\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow ## \u5b9a\u7fa9\u70baclusterflow metadata : name : default-cluster-flow spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"es-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - exclude : ## \u6392\u9664\u4e0d\u60f3\u8981\u63a1\u96c6\u7684namespaces namespaces : - default - kube-system \u4e0a\u9762\u7684\u793a\u4f8b\u8868\u793a\u9019\u662f\u4e00\u500b cluster \u7d1a\u5225\u7684 flow\uff0c\u6839\u64da match \u5b9a\u7fa9\uff0c\u5c07\u63a1\u96c6\u9664\u4e86 default \u548c kube-system \u547d\u540d\u7a7a\u9593\u4ee5\u5916\u7684\u6240\u6709\u547d\u540d\u7a7a\u9593\u65e5\u8a8c\uff1b\u8207 flow \u76f8\u540c\u7684\u662f\uff0c clusterflow \u4e2d\u7684 match \u5b9a\u7fa9\u7684 exclude \u548c select \u53ef\u4ee5\u540c\u6642\u5b58\u5728\uff0c\u4e5f\u53ef\u4ee5\u6709\u591a\u500b exclude \u548c select \u540c\u6642\u5b58\u5728\uff0c\u5f9e\u800c\u88fd\u5b9a\u66f4\u7d30\u7dfb\u7684\u898f\u5247\u3002 filters \u00b6 filters \u662f Logging Operator \u4e2d\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6\uff0c\u76ee\u524d\u5b98\u65b9\u652f\u6301\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6\u5982\u4e0b\uff1a Concat: \u7528\u65bc fluentd \u8655\u7406\u65e5\u8a8c\u591a\u884c\u7684\u63d2\u4ef6; Dedot: \u8655\u7406\u5e36.\u7684\u5b57\u6bb5\u66ff\u63db\u63d2\u4ef6\uff0c\u901a\u5e38\u7528\u65bc\u8f38\u51fa\u5230 elaticsearch \u524d\u7684\u5b57\u6bb5\u8f49\u5316; Exception Detector: Exception \u65e5\u8a8c\u6355\u7372\u5668\uff0c\u652f\u6301 java, js, csharp, python, go, ruby, php; Enhance K8s Metadata: banzaicloud \u958b\u767c\u7684 k8s \u64f4\u5c55\u5143\u6578\u64da; Geo IP: fluentd \u7684 GeoIP \u5730\u5740\u5eab; Grep: fluentd \u7684 grep \u904e\u6ffe\u5668; Parser: fluentd \u7684 Parser \u89e3\u6790\u5668,parse \u652f\u6301 apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none; Prometheus: Prometheus \u63d2\u4ef6\uff0c\u53ef\u7528\u65bc\u5c0d\u65e5\u8a8c\u505a\u8a08\u6578; Record Modifier: fluentd \u5b57\u6bb5\u4fee\u6539\u63d2\u4ef6; Record Transformer: Mutates/transforms incoming event streams; Stdout: \u6a19\u6e96\u8f38\u51fa\u63d2\u4ef6; SumoLogic: Sumo Logic \u516c\u53f8\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6; Tag Normaliser: fluentd \u4e2d\u7684 tag \u4fee\u6539\u5668\u3002 Parser \u63d2\u4ef6 \u00b6 Parser \u63d2\u4ef6\u6700\u5e38\u7528\u3001\u6700\u7c21\u55ae\uff0c\u652f\u6301\u89e3\u6790\u6301 apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none \u683c\u5f0f\u7684\u65e5\u8a8c\u3002\u5982\u679c\u9700\u8981\u89e3\u6790 nginx \u7684\u65e5\u8a8c\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528 Parser \u63d2\u4ef6\u9032\u884c\u8655\u7406\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-nginx-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 \u5982\u679c\u9700\u8981\u89e3\u6790 json \u683c\u5f0f\u7684\u65e5\u8a8c\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : type : json ## \u89e3\u6790\u70bajson\u683c\u5f0f time_key : time ## \u81ea\u5b9a\u7fa9key time_format : \"%Y-%m-%dT%H:%M:%S\" \u6211\u5011\u53ef\u4ee5\u5728Parser\u63d2\u4ef6\u6307\u5b9a\u591a\u7a2e\u985e\u578b\u7684\u65e5\u8a8c\u89e3\u6790\u683c\u5f0f\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ##\u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ##\u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : type : multi_format patterns : - format : nginx ##\u89e3\u6790Nginx\u683c\u5f0f - format : json ##\u89e3\u6790json\u683c\u5f0f time_key : time time_format : \"%Y-%m-%dT%H:%M:%S\" \u5f9e\u4e0a\u9762\u7684\u5e7e\u500b\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa\u4f86\uff0c\u8655\u7406\u89e3\u6790\u65e5\u8a8c\u683c\u5f0f\u662f\u975e\u5e38\u9748\u6d3b\u7684\uff0c\u53ef\u4ee5\u642d\u914d\u4e0d\u540c\u7684\u63d2\u4ef6\u548c\u89e3\u6790\u683c\u5f0f\u4f86\u61c9\u5c0d\u4e0d\u540c\u985e\u578b\u7684\u65e5\u8a8c\u683c\u5f0f\u3002 \u4ecb\u7d39\u5b8c\u5e38\u7528\u7684 Parser \u63d2\u4ef6\u5f8c\uff0c\u518d\u7d66\u5927\u5bb6\u4ecb\u7d39\u4e00\u500b\u4ee5\u5f80\u53ef\u80fd\u90fd\u6c92\u6709\u9047\u5230\u904e\u6216\u8005\u914d\u7f6e\u8d77\u4f86\u6bd4\u8f03\u8907\u96dc\u7684\u5834\u666f\uff1a\u5982\u679c\u9700\u8981\u7d71\u8a08\u696d\u52d9\u65e5\u8a8c\u5728\u4e00\u5b9a\u6642\u9593\u6bb5\u5167\u6253\u5370\u4e86\u591a\u5c11\u7e3d\u6578\uff0c\u7528\u65bc\u5206\u6790\u696d\u52d9\u904b\u71df\u6307\u6a19\uff0c\u600e\u9ebc\u8fa6\u5462\uff1f\u53ef\u80fd\u5927\u5bb6\u7b2c\u4e00\u6642\u9593\u60f3\u5230\u7684\u662f\uff0c\u53cd\u6b63\u90fd\u5df2\u7d93\u8655\u7406\u5b8c\u4e1f\u5230\u985e\u4f3c Kibana \u7684\u5de5\u5177\u4e0a\u4e86\uff0c\u76f4\u63a5\u904e\u6ffe\u4e00\u4e0b\u4e0d\u5c31\u51fa\u6578\u64da\u4e86\uff1f\u9019\u500b\u65b9\u6cd5\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u662f\u5047\u8a2d\u4e00\u4e0b\uff0c\u60f3\u8981\u901a\u904e\u65e5\u8a8c\u689d\u76ee\u6578\u91cf\u6301\u7e8c\u5206\u6790\u696d\u52d9\u904b\u71df\u6307\u6a19\u600e\u9ebc\u8fa6\uff1f\u63a5\u4e0b\u4f86\u5206\u4eab\u53e6\u5916\u4e00\u500b\u63d2\u4ef6\u3002 Prometheus \u63d2\u4ef6 \u00b6 Prometheus \u4f5c\u70ba\u96f2\u539f\u751f\u6642\u4ee3\u7684\u76e3\u63a7\u5229\u5668\uff0c\u5f37\u5927\u7684\u6642\u5e8f\u578b\u6578\u64da\u5eab\uff0c\u914d\u5408 PromQL \u548c Grafana \u9084\u6709\u773e\u591a\u7684Exporter\uff0c\u57fa\u672c\u53ef\u4ee5\u76e3\u63a7\u6211\u5011\u9700\u8981\u7684\u4efb\u4f55\u6307\u6a19\uff1bLogging Operator \u4e2d\u4e5f\u5f15\u5165\u4e86 Prometheus \u63d2\u4ef6\uff0c\u7528\u65bc\u7d71\u8a08\u66b4\u9732\u6536\u96c6\u7684\u6307\u5b9a\u65e5\u8a8c\u689d\u76ee\u3002\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - prometheus : ## Pormetheus\u63d2\u4ef6 metrics : - desc : The total number of nginx in log. ## \u6307\u6a19\u8aaa\u660e name : nginx_log_total_counter ## \u6307\u6a19\u540d\u7a31 type : counter ## \u6307\u6a19Prometheus\u985e\u578b labels : ## \u6307\u6a19\u6a19\u7c64 app : nginx labels : ## \u6307\u6a19\u6a19\u7c64 host : ${hostname} tag : ${tag} namespace : $.kubernetes.namespaces - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"es-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx \u4ee5\u4e0a\u4f8b\u5b50\u4f7f\u7528\u4e86 Parser \u63d2\u4ef6\u5c0d Nginx \u65e5\u8a8c\u9032\u884c\u8655\u7406\uff0c\u4f7f\u7528\u4e86 Prometheus \u63d2\u4ef6\u5c0d\u8f38\u51fa\u7684 Nginx \u65e5\u8a8c\u9032\u884c\u7d71\u8a08\u3002 Prometheus \u63d2\u4ef6\u4e3b\u8981\u6709\u4ee5\u4e0b\u5e7e\u500b\u5b57\u6bb5\uff1a desc : \u5c0d\u8a72\u6307\u6a19\u7684\u63cf\u8ff0\uff1b name : \u6307\u6a19\u7684\u540d\u7a31\uff1b type : \u6307\u6a19\u7684 Prometheus \u6578\u64da\u985e\u578b(\u4e86\u89e3\u66f4\u591a\u8acb\u53c3\u8003 Prometheus \u6578\u64da\u985e\u578b\u6587\u6a94)\uff1b labels : \u6307\u6a19\u7684\u6a19\u7c64(\u4e86\u89e3\u66f4\u591a\u8acb\u53c3\u8003 Prometheus Label \u6587\u6a94)\u3002 \u901a\u904e\u4e0a\u9762\u9019\u500b Flow \u5c31\u53ef\u4ee5\u7d71\u8a08\u7e3d\u5171\u8655\u7406\u4e86\u591a\u5c11\u884c Nginx \u7684\u65e5\u8a8c\uff0c\u4e26\u4f7f\u7528 Prometheus \u66b4\u9732 counter \u985e\u578b\u6307\u6a19\u4ee5\u505a\u76e3\u63a7\u5206\u6790\u3002 \u5c0f\u7d50 \u00b6 \u901a\u904e\u4ee5\u4e0a\u5169\u500b\u63d2\u4ef6\u7684\u4f7f\u7528\u793a\u4f8b\u53ef\u4ee5\u770b\u51fa Logging Operator \u7684\u9748\u6d3b\u3001\u5f37\u5927\u4e4b\u8655\uff0c\u6b64\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u914d\u5408\u5176\u4ed6\u773e\u591a\u7684\u63d2\u4ef6\uff0c\u9748\u6d3b\u5730\u5b8c\u6210\u5c0d\u65e5\u8a8c\u63a1\u96c6\u8655\u7406\u7684\u9700\u6c42\u3002 \u95dc\u65bc\u66f4\u591a Logging Operator \u7684 filter \u652f\u6301\u7684\u63d2\u4ef6\u8aaa\u660e\uff0c\u8acb\u67e5\u770b https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/ Output \u548c ClusterOutput \u00b6 Output \u548c ClusterOutput \u5169\u500b CRD \u5b9a\u7fa9\u4e86\u8655\u7406\u5b8c\u6210\u7684\u65e5\u8a8c\u61c9\u8a72\u8f38\u51fa\u5230\u54ea\u500b\u5730\u65b9\u3002\u8207 flow \u548c clusterflow \u76f8\u540c\u7684\u662f\uff0coutput \u540c\u6a23\u662f namespaces \u7d1a\u5225\u7684\uff0c\u5b83\u53ea\u80fd\u88ab\u540c\u547d\u540d\u7a7a\u9593\u4e0b\u7684 flow \u5f15\u7528\uff1bclusterflow \u662f\u96c6\u7fa4\u7d1a\u5225\u7684\uff0c\u53ef\u4ee5\u88ab\u4e0d\u540c\u547d\u540d\u7a7a\u9593\u7684 flow \u548c clusterflow \u5f15\u7528\u3002 Output \u00b6 Output \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\uff0c\u76ee\u524d Logging Operator \u652f\u6301\u8f38\u51fa\u63d2\u4ef6\u5982\u4e0b\uff1a Alibaba Cloud Amazon CloudWatch Amazon Elasticsearch Amzon Kinesis Amazon S3 Amzon Storage Buffer Datadog Elasticsearch File Format Format rfc5424 Forward GELF Goole Cloud Storage Grafana Loki Http Kafka LogDNA LogZ NewRelic Splunk SumoLogic Syslog \u53ef\u4ee5\u770b\u5230 Logging Operator \u652f\u6301\u8f38\u51fa\u7684\u63d2\u4ef6\u9084\u662f\u975e\u5e38\u8c50\u5bcc\u7684\uff0c\u57fa\u672c\u4e0a\u6db5\u84cb\u4e86\u4f7f\u7528\u5834\u666f\u4e2d\u7684\u5de5\u5177\u3002\u4e0b\u9762\u6211\u5011\u5c07\u4ee5\u5e38\u7528\u7684\u5169\u7a2e\u63d2\u4ef6 Kafka \u548c Elasticsearch \u9032\u884c\u8209\u4f8b\uff0c\u914d\u7f6e Output CRD\u3002 Output-Kafka \u00b6 apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : kafka-output spec : kafka : brokers : kafka-headless.kafka.svc.cluster.local:29092 ## kafka\u5730\u5740 default_topic : topic topic_key : kafka-output ## kafka topic\u540d\u7a31\uff1b sasl_over_ssl : false ## \u662f\u5426\u4f7f\u7528ssl format : type : json ## \u985e\u578b buffer : ## \u767c\u9001buff\u914d\u7f6e tags : topic timekey : 1m timekey_wait : 30s timekey_use_utc : true \u5728\u4e0a\u9762\u9019\u500b\u7c21\u55ae\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u4e00\u500b\u8f38\u51fa\u5230 kafka \u7684 output CRD\uff0c\u53ef\u4ee5\u770b\u5230\u5e7e\u500b\u95dc\u9375\u914d\u7f6e\uff0ckafka \u7684\u5730\u5740\u3001topic \u7684\u540d\u7a31\u3001\u662f\u5426\u4f7f\u7528 ssl\uff1b\u4e0b\u9762\u7684 buffer\u6307\u767c\u9001 buffer \u914d\u7f6e\uff0c\u9019\u6a23\u4e00\u500b\u767c\u9001\u5230 kafka \u7684 output CRD \u5c31\u5b8c\u6210\u4e86\u3002 Buff \u914d\u7f6e\u4e5f\u53ef\u4ee5\u6839\u64da\u5be6\u969b\u60c5\u6cc1\u9032\u884c\u8abf\u6574\u3002 Output-Elasticsearch \u00b6 apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : elasticsearch-output spec : elasticsearch : host : elasticsearch-elasticsearch-cluster.default.svc.cluster.local port : 9200 scheme : https ssl_verify : false ssl_version : TLSv1_2 buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true \u5728\u4e0a\u9762\u9019\u500b\u7c21\u55ae\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u4e00\u500b\u8f38\u51fa\u5230 elasticsearch \u7684 output CRD\uff0c\u5176\u5be6\u548c kafka\u7684 output \u914d\u7f6e\u985e\u4f3c\uff0c\u9700\u8981\u5b9a\u7fa9 elasticsearch \u7684\u5730\u5740\u3001\u7aef\u53e3\u3001\u662f\u5426\u9700\u8981 ssl \u8a8d\u8b49\uff1bbuffer \u914d\u7f6e\u5b9a\u7fa9\u4e86\u767c\u9001\u6642\u7684 buff \u914d\u7f6e\u3002 \u95dc\u65bc\u66f4\u591a\u914d\u7f6e\u9805\uff0c\u67e5\u770b\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/ flow \u548c output \u76f8\u95dc\u806f \u00b6 \u5728\u5b9a\u7fa9\u597d\u4e86 flow \u548c output \u4e4b\u5f8c\uff0c\u9700\u8981\u5728 flow \u5b9a\u7fa9 localOutputRefs \u4f86\u8207 output \u9032\u884c\u95dc\u806f\uff0c\u4ee5\u9032\u884c\u65e5\u8a8c\u7684\u767c\u9001\u8655\u7406\u3002\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"elasticsearch-output\" ## \u8f38\u51fa\u5230elasticsearch-output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx \u5728\u4e0a\u9762\u9019\u500b\u4f8b\u5b50\u4e2d\uff0clocalOutputRefs \u914d\u7f6e\u4e86 elasticsearch-output\uff0c\u9019\u6a23\u5c31\u8207\u6211\u5011\u525b\u525b\u5b9a\u7fa9\u7684\u540d\u7a31\u70ba elasticsearch-output \u7684 output \u9032\u884c\u4e86\u95dc\u806f\uff0c\u65e5\u8a8c\u5c31\u53ef\u4ee5\u5f9e\u6307\u5b9a\u7684 output \u9032\u884c\u8f38\u51fa\u3002\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0cLogging Operator \u5145\u5206\u8003\u616e\u4e86\u76f8\u540c\u65e5\u8a8c\u9700\u8981\u8f38\u51fa\u5230\u4e0d\u540c\u5730\u9ede\u7684\u9700\u6c42\u3002\u6bd4\u5982\u4e0b\u9762\u9019\u500b\u4f8b\u5b50\uff0c\u5c31\u53ef\u4ee5\u5c07\u65e5\u8a8c\u540c\u6642\u8f38\u51fa\u5230 kafka \u548c elasticsearch\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"elasticsearch-output\" ## \u8f38\u51fa\u5230elasticsearch-output - \"kafka-output\" ## \u8f38\u51fa\u5230kafka-output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx \u5c0f\u7ed3 \u00b6 \u4e0a\u6587\u4ecb\u7d39\u7684 flow\u3001clusterflow \u548c output\u3001clusteroptput \u529f\u80fd\u90fd\u662f\u9748\u6d3b\u800c\u5f37\u5927\u7684\u3002\u5728 SUSE Rancher 2.6 \u7248\u672c\u90e8\u7f72\u5b8c Logging \u5f8c\uff0c\u53ef\u4ee5\u901a\u904e yaml \u7de8\u5beb CRD \u4e26\u76f4\u63a5\u61c9\u7528\u5230\u96c6\u7fa4\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5728 SUSE Rancher UI \u4e0a\u9032\u884c\u914d\u7f6e\u3002\u4e0b\u4e00\u7ae0\u5c07\u6703\u4ecb\u7d39\u5982\u4f55\u5728 SUSE Rancher UI \u4e0a\u5c0d flow \u548c output \u9032\u884c\u914d\u7f6e \u5728 SUSE Rancher UI \u4e0a\u5c0d flow \u548c output \u9032\u884c\u914d\u7f6e \u00b6 \u672c\u7ae0\u7bc0\u5167\u5bb9\u5c07\u6703\u63cf\u8ff0\u5728 SUSE Rancher UI \u4e0a\u9032\u884c\u65e5\u8a8c\u63a1\u96c6\u914d\u7f6e\u3002 \u5275\u5efa outputs/clusteroutputs \u00b6 \u5728 SUSE Rancher UI \u4e0a\u914d\u7f6e\u9996\u5148\u9700\u8981\u5275\u5efa\u4e00\u500b flow \u6216\u8005 clusterflow\uff0c\u9032\u5165\u65e5\u8a8c\u9801\u9762\u9078\u64c7 outputs/clusteroutputs\uff0c\u9078\u64c7\u5c07\u8981\u767c\u9001\u7684\u5f8c\u7aef\u5de5\u5177\uff0c\u793a\u4f8b\u4e2d\u4ee5 es \u70ba\u4f8b\uff0c\u914d\u7f6e\u7d22\u5f15\u540d\u7a31\u3001\u4e3b\u6a5f\u5730\u5740\u3001\u7aef\u53e3\u3001outputs \u540d\u7a31\uff0c\u5982\u679c\u6709 https \u6216\u8005 ssl \u9700\u8981\u5148\u5275\u5efa secrets\u3002 \u5275\u5efa\u5b8c\u6210\u5f8c\u7684 CRD yaml \u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : rancher26-es-output namespace : default spec : elasticsearch : buffer : timekey : 1m timekey_use_utc : true timekey_wait : 30s host : 172.16.0.14 index_name : rancher26 port : 9200 scheme : http \u5275\u5efa flow/clusterflow \u00b6 Outputs \u5275\u5efa\u5b8c\u6210\u4e4b\u5f8c\uff0c\u958b\u59cb\u5275\u5efa flow/clusterflow \u898f\u5247\uff1a\u9032\u5165\u65e5\u8a8c\u9801\u9762\u9078\u64c7 flows/clusterflows\uff0c\u9ede\u64ca\u5275\u5efa\uff0c\u9032\u884c flow \u914d\u7f6e\uff0c\u793a\u4f8b\u4e2d\u5c07\u63a1\u96c6\u6a19\u7c64\u70ba app:nginx \u7684\u5bb9\u5668\u65e5\u8a8c\uff1a \u8f38\u5165\u5bb9\u5668\u6a19\u7c64\u5339\u914d\u898f\u5247\u3001\u540d\u7a31\uff1b\u5982\u679c\u6709\u4e0d\u60f3\u63a1\u96c6\u7684\u4e3b\u6a5f\u6216\u8005\u5bb9\u5668\uff0c\u4e5f\u53ef\u4ee5\u9032\u884c\u9078\u64c7\uff1b\u9801\u9762\u4e0a\u4e5f\u53ef\u4ee5\u6dfb\u52a0\u591a\u500b\u6a19\u7c64\u5339\u914d\u898f\u5247\uff1b \u914d\u7f6e\u8f38\u51fa\u898f\u5247\uff0c\u9019\u88e1\u9078\u64c7\u6211\u5011\u525b\u525b\u5275\u5efa\u7684 outputs\uff0c\u9019\u88e1\u53ef\u4ee5\u9078\u64c7\u591a\u500b outputs \u548c clusteroutput\uff0c\u4e5f\u53ef\u4ee5\u540c\u6642\u9078\u64c7 output \u548c clusteroptput\uff1b \u914d\u7f6e\u904e\u6ffe\u898f\u5247\uff0c\u9019\u88e1\u6211\u5011\u6536\u96c6\u7684\u662f nginx \u65e5\u8a8c\uff0c\u6240\u4ee5\u4f7f\u7528 parser \u63d2\u4ef6\uff0c\u81ea\u52d5\u683c\u5f0f\u5316 nginx \u898f\u5247\uff1b \u5275\u5efa\u5b8c\u6210\u5f8c\u7684 CRD yaml \u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : nginx-flow namespace : default fields : - nginx-flow spec : filters : - parser : parse : type : nginx remove_key_name_field : true localOutputRefs : - rancher26-es-output match : - select : labels : app : nginx \u9a57\u8b49 \u00b6 \u914d\u7f6e\u5b8c\u6210\u5f8c\uff0c\u5982\u679c\u96c6\u7fa4\u4e2d\u6709\u7b26\u5408\u6a19\u7c64\u8981\u6c42\u7684\u5bb9\u5668\uff0c\u5c31\u6703\u81ea\u52d5\u63a1\u96c6\u4e26\u767c\u9001\u5230 es\uff1b \u901a\u904e\u67e5\u770b fluentd \u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u67e5\u770b outputs \u662f\u5426\u751f\u6548 ## \u9032\u5165rancher-logging-fluentd-0 Pod\u547d\u4ee4\u884c cat fluentd/app-config/fluentd.conf <match **> @type elasticsearch @id flow:default:nginx-flow:output:default:rancher26-es-output exception_backup true fail_on_putting_template_retry_exceed true host 172 .16.0.14 index_name rancher26 port 9200 reload_connections true scheme http ssl_verify true utc_index true verify_es_version_at_startup true <buffer tag,time> @type file chunk_limit_size 8MB path /buffers/flow:default:nginx-flow:output:default:rancher26-es-output.*.buffer retry_forever true timekey 1m timekey_use_utc true timekey_wait 30s </buffer> </match> \u67e5\u770b elasticsearch \u4e2d\u7684\u7d22\u5f15 \u67e5\u770b kibana \u4e2d\u7684\u65e5\u8a8c\u8a73\u60c5 \u7e3d\u7d50 \u00b6 \u81f3\u6b64\uff0cSUSE Rancher 2.6 \u5168\u65b0\u7684 Logging Operator \u958b\u7bb1\u4f7f\u7528\u5c31\u5df2\u7d93\u5168\u90e8\u7d50\u675f\u4e86\u3002\u5c0d\u6bd4\u4e4b\u524d\u7684\u65e5\u8a8c\u6536\u96c6\u529f\u80fd\uff0c\u7684\u78ba\u5f37\u5927\u4e86\u4e0d\u5c11\uff0c\u914d\u7f6e\u975e\u5e38\u9748\u6d3b\uff0c\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u591a\u7a2e\u904e\u6ffe\u5668\uff0c\u751a\u81f3\u4f7f\u7528 Prometheus \u66b4\u9732\u81ea\u5b9a\u7fa9\u6307\u6a19\u9032\u884c\u696d\u52d9\u904b\u71df\u5206\u6790\u7b49\u5167\u5bb9\u3002\u4f46\u662f\u8207\u4e4b\u524d\u53ea\u9700\u8981\u8f38\u5165\u76ee\u6a19\u7aef\u5730\u5740\u5c31\u80fd\u4f7f\u7528\u7684\u5834\u666f\u76f8\u5c0d\u6bd4\uff0cLogging Operator \u78ba\u5be6\u4e5f\u589e\u52a0\u4e86\u4e00\u5b9a\u7684\u5b78\u7fd2\u6210\u672c\uff0c\u5efa\u8b70\u201c\u5c0f\u767d\u201d\u670b\u53cb\u9084\u662f\u5f9e\u96f6\u958b\u59cb\u5b78\u7fd2\uff0c\u641e\u6e05\u695a\u6574\u9ad4\u7684\u904b\u884c\u67b6\u69cb\u548c\u908f\u8f2f\uff0c\u9019\u6a23\u6709\u52a9\u65bc\u6545\u969c\u767c\u751f\u6642\u7684\u5b9a\u4f4d\u6392\u67e5\u3002 \u4e00\u4e9b Tips \u00b6 \u6574\u9ad4\u67b6\u69cb\u662f\u7531 Daemonst \u985e\u578b\u7684 fluentbit \u7d44\u4ef6\u9032\u884c\u65e5\u8a8c\u63a1\u96c6\uff0cfluentbit \u7d44\u4ef6\u65e5\u8a8c\u4e2d\u6703\u6709\u65e5\u8a8c\u6587\u4ef6\u7684\u6253\u5370\u8f38\u51fa\uff0c\u7576\u767c\u73fe\u67d0\u4e9b\u65e5\u8a8c\u672a\u88ab\u63a1\u96c6\u7684\u6642\u5019\uff0c\u53ef\u4ee5\u67e5\u770b fluentbit \u7d44\u4ef6\u7684\u65e5\u8a8c\u662f\u5426\u767c\u73fe\u4e86\u9019\u4e9b\u65e5\u8a8c\uff1b Fluentd \u7d44\u4ef6\u8ca0\u8cac\u532f\u7e3d\u3001\u8655\u7406\u3001\u767c\u9001\uff0c\u7576\u767c\u73fe\u76ee\u6a19\u7aef\u6c92\u6709\u6536\u5230\u65e5\u8a8c\uff0c\u6bd4\u5982\u8aaa ES \u6c92\u6709\u5275\u5efa\u7d22\u5f15\u7684\u6642\u5019\uff0c\u53ef\u4ee5\u770b\u770b Fluentd \u7d44\u4ef6\u7684\u65e5\u8a8c\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u622a\u6b62\u6587\u7ae0\u767c\u8868\u6642\uff0cFluentd \u7684\u65e5\u8a8c\u6c92\u6709\u6253\u5370\u5728\u6a19\u6e96\u8f38\u51fa\u4e2d\uff0c\u9700\u8981\u9032\u5165 Pod \u5167\u57f7\u884c\u547d\u4ee4\u67e5\u770b\uff1a tail -f fluentd/log/out \u7121\u8ad6\u662f UI \u9084\u662f CRD \u7684 flow/outputs \u914d\u7f6e\uff0c\u6700\u7d42\u90fd\u6703\u8f49\u5316\u70ba fluentbit \u548c Fluentd \u7684\u914d\u7f6e\uff0c\u5982\u679c\u5c0d\u9019\u5169\u500b\u7d44\u4ef6\u6bd4\u8f03\u719f\u6089\uff0c\u51fa\u73fe\u7570\u5e38\u7684\u6642\u5019\u53ef\u4ee5\u9032\u5165 Pod \u4e2d\u67e5\u770b\u5177\u9ad4\u751f\u6548\u7684\u914d\u7f6e\u662f\u5426\u6b63\u78ba\uff1b \u7531\u65bc\u904e\u6ffe\u5668\u7684\u5b58\u5728\uff0c\u932f\u8aa4\u7684\u904e\u6ffe\u3001\u5339\u914d\u7684\u689d\u4ef6\u53ef\u80fd\u6703\u5c0e\u81f4\u65e5\u8a8c\u7121\u6cd5\u767c\u9001\u51fa\u53bb\uff0c\u9019\u500b\u6642\u5019\u9700\u8981\u6aa2\u67e5 flow \u4e2d\u914d\u7f6e\u7684\u898f\u5247\u60c5\u6cc1\u3002","title":"Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#rancher-26-logging","text":"\u539f\u6587: https://mp.weixin.qq.com/s?__biz=MzkyNzM4Nzk1NQ==&mid=2247500852&idx=1&sn=6f993e57a508166cb8d32927742673f4&scene=21#wechat_redirect","title":"Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#_1","text":"\u5728 SUSE Rancher 2.5 \u4ee5\u524d\uff0c\u65e5\u8a8c\u6536\u96c6\u7684\u67b6\u69cb\u662f\u4f7f\u7528 Fluentd \u6536\u96c6\u6307\u5b9a\u76ee\u9304\u65e5\u8a8c\u6216\u8005\u5bb9\u5668\u6a19\u6e96\u8f38\u51fa\u6d41\u5f8c\uff0c\u518d\u901a\u904e UI \u65e5\u8a8c\u529f\u80fd\u9801\u9762\u7684\u914d\u7f6e\u767c\u9001\u5230\u6307\u5b9a\u7684\u5f8c\u7aef\u3002\u5982 Elasticsearch\u3001splunk\u3001kafka\u3001syslog\u3001fluentd \u7b49\u5e38\u898b\u7684\u5f8c\u7aef\u5de5\u5177\uff0c\u53ef\u4ee5\u81ea\u52d5\u5316\u5730\u6536\u96c6 kubernetes \u96c6\u7fa4\u548c\u904b\u884c\u65bc\u96c6\u7fa4\u4e4b\u4e0a\u7684\u5de5\u4f5c\u8ca0\u8f09\u65e5\u8a8c\u3002\u9019\u7a2e\u65b9\u5f0f\u7121\u7591\u662f\u975e\u5e38\u7c21\u55ae\u3001\u6613\u7528\u3001\u65b9\u4fbf\u7684\uff0c\u4f46\u662f\u96a8\u8457\u7528\u6236\u5c0d\u96f2\u539f\u751f\u7406\u89e3\u7684\u52a0\u6df1\uff0c\u5c0d\u696d\u52d9\u65e5\u8a8c\u5206\u6790\u9846\u7c92\u5ea6\u8981\u6c42\u7684\u63d0\u9ad8\uff0c\u4e4b\u524d\u7684\u65e5\u8a8c\u6536\u96c6\u65b9\u5f0f\u6709\u4e9b\u592a\u904e\u6b7b\u677f\uff0c\u9748\u6d3b\u6027\u975e\u5e38\u5dee\uff0c\u5df2\u7d93\u7121\u6cd5\u6eff\u8db3\u5c0d\u65e5\u8a8c\u6536\u96c6\u5177\u6709\u66f4\u9ad8\u8981\u6c42\u7684\u7528\u6236\u4e86\u3002 \u65bc\u662f\u5f9e SUSE Rancher 2.5 \u7248\u672c\u958b\u59cb\uff0cBanzaiCloud \u516c\u53f8\u7684\u958b\u6e90\u7522\u54c1 Logging Operator \u6210\u70ba\u4e86\u65b0\u4e00\u4ee3 SUSE Rancher \u5bb9\u5668\u96f2\u5e73\u53f0\u65e5\u8a8c\u63a1\u96c6\u529f\u80fd\u7684\u7d44\u6210\u7d44\u4ef6\u3002 SUSE Rancher 2.5 \u7248\u672c\u4f5c\u70ba\u65b0\u65e5\u8a8c\u7d44\u4ef6\u7684\u904e\u6e21\u7248\u672c\uff0c\u4fdd\u7559\u4e86\u8001\u7248\u672c\u7684\u65e5\u8a8c\u6536\u96c6\u65b9\u5f0f\uff0c\u4e26\u5c07\u5168\u65b0\u7684 Logging Operator \u4f5c\u70ba\u5be6\u9a57\u6027\u529f\u80fd\u4f7f\u7528\uff1bSUSE Rancher 2.6 \u7248\u672c\u5247\u5df2\u7d93\u5b8c\u5168\u4f7f\u7528\u4e86 Logging Operator \u4f5c\u70ba\u65e5\u8a8c\u6536\u96c6\u5de5\u5177\u3002 \u672c\u6587\u5c07\u7531\u6dfa\u5230\u6df1\u5730\u63a2\u7d22\u5168\u65b0\u7684 SUSE Rancher 2.6 Logging Operator \u529f\u80fd\u548c\u5b83\u7684\u4f7f\u7528\u65b9\u5f0f\u3002","title":"\u80cc\u666f\u6982\u8ff0"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#logging-operator","text":"Logging Operator \u662f BanzaiCloud \u57fa\u65bc\u96f2\u539f\u751f\u5834\u666f\u7684\u958b\u6e90\u65e5\u8a8c\u63a1\u96c6\u65b9\u6848\uff0cSUSE Rancher 2.6 \u7248\u672c\u5728\u6574\u5408\u4e86\u8a72\u7522\u54c1\u4e4b\u5f8c\uff0c\u5c07\u6703\u5728\u7528\u6236\u7684\u64cd\u4f5c\u4e0b\u81ea\u52d5\u90e8\u7f72 Logging Operator \u4e26\u81ea\u52d5\u914d\u7f6e kuberletes logging pipeline\u3002","title":"\u4ec0\u9ebc\u662f Logging Operator"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#logging-operator_1","text":"\u4ee5\u4e0a\u662f Logging Operator \u5b98\u65b9\u67b6\u69cb\u5716\u3002 Logging Operator \u4f7f\u7528 CRD \u7684\u65b9\u5f0f\u6c7a\u5b9a\u4e86\u65e5\u8a8c\u63a1\u96c6\u3001\u898f\u5247\u8def\u7531\u3001\u8f38\u51fa\u9019\u4e09\u500b\u968e\u6bb5\u7684\u914d\u7f6e\uff0c\u5b83\u4f7f\u7528 Daemonset \u5728\u96c6\u7fa4\u7bc0\u9ede\u4e0a\u90e8\u7f72 Fluentbit \u7d44\u4ef6\uff0c\u4f7f\u7528 StatefulSet \u90e8\u7f72 Fluentd \u7d44\u4ef6\u3002\u9996\u5148\u7531 Fluentbit \u7d44\u4ef6\u9032\u884c\u65e5\u8a8c\u6536\u96c6\u4e26\u521d\u6b65\u8655\u7406\u4e4b\u5f8c\uff0c\u767c\u9001\u5230 Fluentd \u7d44\u4ef6\u9032\u884c\u9032\u4e00\u6b65\u7684\u89e3\u6790\u8655\u7406\uff0c\u6700\u7d42\u7531 Fluentd \u7d44\u4ef6\u767c\u9001\u5230\u4e0d\u540c\u7684\u5f8c\u7aef\u5de5\u5177\u4e0a\u3002","title":"Logging Operator \u67b6\u69cb"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#logging-operator-crd","text":"\u4e0a\u6587\u63d0\u5230\uff0cLogging Operator \u4f7f\u7528 CRD \u7684\u65b9\u5f0f\u6c7a\u5b9a\u4e86\u65e5\u8a8c\u63a1\u96c6\u3001\u898f\u5247\u8def\u7531\u3001\u8f38\u51fa\u9019\u4e09\u500b\u968e\u6bb5\u7684\u914d\u7f6e\uff0c\u5176\u4f7f\u7528\u7684 CRD \u4e3b\u8981\u6709\u4ee5\u4e0b5\u7a2e\u985e\u578b\uff1a logging \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u65e5\u8a8c\u63a1\u96c6\u7aef (FleuntBit) \u548c\u50b3\u8f38\u7aef (Fleuntd) \u670d\u52d9\u7684\u57fa\u790e\u914d\u7f6e\uff0c\u5728 SUSE Rancher 2.6 \u7248\u672c\u4e2d\uff0c\u5df2\u7d93\u7531 Rancher \u81ea\u52d5\u5316\u90e8\u7f72\u5b8c\u6210\uff1b flow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; clusterflow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; output \uff1a\u7528\u65bc\u5b9a\u7fa9 namespace (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u7684\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u53ea\u80fd\u88ab\u540c\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\uff1b clusteroutput \uff1a\u7528\u65bc\u5b9a\u7fa9\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u80fd\u628a\u88ab\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\u3002 \u4ee5\u4e0a 5 \u500b CRD \u985e\u578b\u975e\u5e38\u91cd\u8981\uff0c\u6c7a\u5b9a\u4e86\u4e00\u500b Kubernetes \u96c6\u7fa4\u5167\u6bcf\u500b\u547d\u540d\u7a7a\u9593\u751a\u81f3\u6bcf\u500b\u5bb9\u5668\u7684\u65e5\u8a8c\u8f38\u51fa\u5230\u54ea\u88e1\u3002","title":"Logging Operator CRD"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#suse-rancher-26-logging","text":"SUSE Rancher 2.6 \u6210\u529f\u5275\u5efa\u4e0b\u6e38 Kubernetes \u96c6\u7fa4\u5f8c\uff0c\u53ef\u4ee5\u5728\u96c6\u7fa4\u5de5\u5177\u9801\u9762\u627e\u5230 Logging \u5de5\u5177\u7684\u90e8\u7f72\u5165\u53e3\uff0c\u5982\u4e0b\u5716\u6240\u793a\uff1a \u9ede\u64ca\u5b89\u88dd\u6309\u9215\u5f8c\uff0c\u9078\u64c7\u7d44\u4ef6\u5b89\u88dd\u7684\u9805\u76ee\uff0c\u4e00\u822c\u9078\u64c7\u70ba System \u9805\u76ee\uff0c\u5728\u8a72\u9805\u76ee\u4e2d\u904b\u884c\u8207\u96c6\u7fa4\u904b\u884c\u76f8\u95dc\u7684\u7d44\u4ef6\uff1b\u9ede\u64ca\u4e0b\u4e00\u6b65\u5f8c\uff0cUI \u6703\u8981\u6c42\u8f38\u5165\u914d\u7f6e Docker \u6839\u76ee\u9304\u548c System Log Path\uff1b \u6ce8\u610f\uff1a\u5982\u679c\u5e95\u5c64\u5bb9\u5668\u904b\u884c\u6642 (Runtime)\u70ba Docker\uff0c\u9ed8\u8a8d\u70ba\uff1a /var/lib/docker \u3002\u5982\u679c\u81ea\u5b9a\u7fa9\u904e\uff0c\u8acb\u586b\u5beb\u6b63\u78ba\u7684 Docker Root Dir \u76ee\u9304\uff0c\u53ef\u4ee5\u901a\u904e docker info \uff5c grep Docker Root Dir \u547d\u4ee4\u67e5\u770b\uff1b \u6ce8\u610f\uff1a System Log Path \u7528\u65bc\u6536\u96c6\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71 Journal \u65e5\u8a8c\uff0c\u5982\u679c\u586b\u5beb\u932f\u8aa4\u6703\u5c0e\u81f4\u4e3b\u6a5f\u64cd\u4f5c\u7cfb\u7d71\u65e5\u8a8c\u7121\u6cd5\u6536\u96c6\uff0c\u78ba\u8a8d\u8a72\u8def\u5f91\u7684\u65b9\u6cd5\u5982\u4e0b\uff1a ## \u786e\u8ba4Journal Log Path\u68c0\u67e5\u65b9\u5f0f\uff0c\u5728\u8282\u70b9\u4e0a\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4 cat /etc/systemd/journald.conf | grep -E ^ \\# ?Storage | cut -d \"=\" -f2 1 \u3001\u5982\u679c\u8fd4\u56depersistent\uff0c\u5219systemdLogPath\u5e94\u8be5\u662f/var/log/journal\uff1b 2 \u3001\u5982\u679c\u8fd4\u56devolatile\uff0c\u5219systemdLogPath\u5e94\u8be5\u662f/run/log/journal\uff1b 3 \u3001\u5982\u679c\u8fd4\u56deauto\uff0c\u5219\u68c0\u67e5/var/log/journal\u662f\u5426\u5b58\u5728\uff1b - \u5982\u679c/var/log/journal\u5b58\u5728\uff0c\u5219\u4f7f\u7528/var/log/journal\uff1b - \u5982\u679c/var/log/journal\u4e0d\u5b58\u5728\uff0c\u5219\u4f7f\u7528/run/log/journal\uff1b \u8f38\u5165\u6b63\u78ba\u7684 Docker \u6839\u76ee\u9304\u548c systemdLogPath \u5f8c\uff0c\u9ede\u64ca\u5b89\u88dd\uff0cSUSE Rancher 2.6 \u6703\u81ea\u52d5\u90e8\u7f72 Logging Operator \u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u90e8\u7f72\u662f\u5426\u6210\u529f kubectl get pod -n cattle-logging-system NAME READY STATUS RESTARTS AGE rancher-logging-96b68cc4b-vqxnd 1 /1 Running 0 9m54s rancher-logging-fluentbit-cntgb 1 /1 Running 0 69s rancher-logging-fluentbit-hwmdx 1 /1 Running 0 71s rancher-logging-fluentbit-nw7rw 1 /1 Running 0 71s rancher-logging-fluentd-0 2 /2 Running 0 9m34s rancher-logging-fluentd-configcheck-ac2d4553 0 /1 Completed 0 9m48s \u90e8\u7f72\u5b8c\u6210\u5f8c\uff0cSUSE Rancher 2.6 \u96c6\u7fa4 UI \u4e0a\u591a\u4e86\u4e00\u500b\u65e5\u8a8c\u9078\u9805\u5361\uff0c\u53ef\u4ee5\u7531\u6b64\u914d\u7f6e\u4e0a\u6587\u63d0\u5230\u7684 flow\u3001clusterflow\u3001output\u3001clusteroutput \u8cc7\u6e90\u5c0d\u8c61\uff0c\u5f9e\u800c\u5b8c\u6210\u6574\u500b\u65e5\u8a8c\u63a1\u96c6\u3001\u904e\u6ffe\u8def\u7531\u3001\u8f38\u51fa\u7684\u5168\u6d41\u7a0b\u914d\u7f6e\u3002 \u5f9e SUSE Rancher 2.6 UI \u4e0a\u76f4\u63a5\u9032\u884c\u65e5\u8a8c\u63a1\u96c6\u6d41\u7a0b\u7684\u914d\u7f6e\u56fa\u7136\u65b9\u4fbf\uff0c\u4f46\u662f\u5c0d Logging Operator \u6bd4\u8f03\u719f\u6089\u7684\u201c\u5927\u795e\u201d\u6216\u8005\u7d93\u5e38\u4f7f\u7528\u7684\u201c\u5927\u4f6c\u201d\uff0c\u53ef\u4ee5\u4f7f\u7528 SUSE Rancher 2.6 UI \u76f4\u63a5\u9032\u884c\u914d\u7f6e\uff0c\u5f9e\u800c\u5b8c\u6210\u6574\u500b\u65e5\u8a8c\u63a1\u96c6\u3001\u904e\u6ffe\u8def\u7531\u3001\u8f38\u51fa\u7684\u5168\u6d41\u7a0b\u914d\u7f6e\uff1b\u5c0d\u65bc\u525b\u525b\u5347\u7d1a\u70ba SUSE Rancher 2.6 \u6216\u8005\u525b\u525b\u63a5\u89f8 Logging Operator \u7684\u201c\u5c0f\u767d\u201d\u670b\u53cb\u5011\uff0c\u54b1\u5011\u9084\u662f\u4e0d\u8981\u8457\u6025\u4e0a\u624b\u4e86\uff0c\u6df1\u5165\u6dfa\u51fa\u3001\u5faa\u5e8f\u6f38\u9032\uff0c\u7e7c\u7e8c\u5f80\u4e0b\u8b80\u5b8c\uff0c\u770b\u770b\u9019\u4e9b CRD \u662f\u600e\u9ebc\u914d\u7f6e\u548c\u5de5\u4f5c\u7684\u3002","title":"\u555f\u7528 SUSE Rancher 2.6 Logging"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#flow-clusterflow","text":"\u5f9e\u672c\u6587\u6700\u958b\u59cb\u7684\u67b6\u69cb\u6d41\u7a0b\u5716\u53ef\u4ee5\u770b\u51fa\uff0c\u6574\u500b Logging Operator \u6700\u70ba\u6838\u5fc3\u7684\u5169\u500b\u6982\u5ff5\u5c31\u662f flow \u548c output\uff0c\u5176\u4e2d flow \u5c31\u662f\u7528\u4f86\u8655\u7406\u65e5\u8a8c\u6d41\u7684\uff0c\u6c7a\u5b9a\u4e86\u5f9e\u54ea\u88e1\u63a1\u96c6\u3001\u600e\u9ebc\u904e\u6ffe\u3001\u5982\u4f55\u8def\u7531\u5206\u767c\uff1bclusterflow \u5177\u6709\u76f8\u540c\u7684\u529f\u80fd\uff0c\u662f\u500b\u5168\u5c40 flow\u3002 \u5728\u4e86\u89e3 flow CRD \u7684\u5b9a\u7fa9\u4e4b\u524d\uff0c\u5148\u7528\u4e00\u500b\u7c21\u55ae\u7684 flow \u793a\u4f8b\u4f86\u9032\u884c\u4ee5\u4e0b\u5206\u6790\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"elasticsearch-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx \u9019\u500b flow \u7684\u610f\u601d\u662f\uff0c\u53ea\u6703\u63a1\u96c6 default \u547d\u540d\u7a7a\u9593\u5167\u6a19\u7c64 app=nginx \u7684\u5bb9\u5668\u65e5\u8a8c\uff0c\u63a1\u96c6\u65e5\u8a8c\u5f8c\u6309\u7167 nginx \u683c\u5f0f\u9032\u884c\u89e3\u6790\uff0c\u4e26\u4e14\u5c07\u9019\u500b\u65e5\u8a8c\u6d41\u7684 tag \u5728 fluentd \u6700\u7d42\u532f\u7e3d\u6642\u91cd\u5b9a\u5411\u70ba ${namespace_name}.${pod_name}.${container_name} \u683c\u5f0f\u3002","title":"Flow \u548c ClusterFlow"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#match","text":"\u4e0a\u9762\u7684\u4f8b\u5b50\u88e1\u6709\u4e00\u500b\u975e\u5e38\u91cd\u8981\u7684\u5b9a\u7fa9 match\uff0c\u5b83\u5b9a\u7fa9\u4e86\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6\uff0c\u6839\u64da Logging Operato \u5b98\u65b9\u6587\u6a94\u7d66\u51fa\u7684\u8aaa\u660e\uff0c\u7576\u524d\u53ef\u4ee5\u4f7f\u7528\u7684\u5b57\u6bb5\u6709\u4ee5\u4e0b\u5e7e\u7a2e\uff1a namespaces \u4f7f\u7528\u547d\u540d\u7a7a\u9593\u9032\u884c\u5339\u914d\uff1b labels \u4f7f\u7528\u6a19\u7c64\u9032\u884c\u5339\u914d\uff1b hosts \u4f7f\u7528\u4e3b\u6a5f\u9032\u884c\u5339\u914d\uff1b container_names \u4f7f\u7528\u5bb9\u5668\u540d\u7a31\u9032\u884c\u5339\u914d\u3002 \u8a2d\u60f3\u4e00\u500b\u5834\u666f\uff0c\u5728\u4e00\u500b Kubernetes \u96c6\u7fa4\u4e2d\uff0c\u6211\u5011\u60f3\u6392\u9664\u67d0\u4e9b\u5bb9\u5668\u7684\u65e5\u8a8c\uff0c\u4f7f\u7528\u5339\u914d\u9700\u8981\u5beb\u7121\u6578\u500b\u5339\u914d\u898f\u5247\uff0c\u9019\u986f\u7136\u662f\u4e0d\u5408\u7406\u7684\uff0c\u6240\u4ee5\u5b98\u65b9\u7d66\u4e86 exclude \u5b57\u6bb5\uff0c\u4f7f\u7528\u6392\u9664\u3002\u4f8b\u5b50\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"es-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - exclude : ## \u6392\u9664\u6240\u6709\u6a19\u7c64\u662fapp:nginx\u7684\u5bb9\u5668 labels : app : nginx \u4e0a\u9762\u9019\u500b\u4f8b\u5b50\u6703\u6392\u9664\u63a1\u96c6\u6240\u6709\u6a19\u7c64\u662f app:nginx \u7684\u5bb9\u5668\u65e5\u8a8c\uff1b exclude \u548c select \u53ef\u4ee5\u540c\u6642\u5b58\u5728\uff0c\u4e5f\u53ef\u4ee5\u6709\u591a\u500b exclude \u548c select \u5b58\u5728\uff0c\u66f4\u9748\u6d3b\u7684\u5b9a\u7fa9\u9700\u8981\u63a1\u96c6\u54ea\u4e9b\u5bb9\u5668\u65e5\u8a8c\u3002 \u9664\u4e86 flow \u4ee5\u5916\u9084\u6709 clusterflow\u3002\u8a2d\u60f3\u4e00\u500b\u5834\u666f\uff0c\u6211\u5011\u6709 N \u500b namespaces\uff0c\u4f46\u662f\u6211\u5011\u9700\u8981\u63a1\u96c6\u9664\u4e86\u67d0\u4e00\u500b namespaces \u4ee5\u5916\u7684\u6240\u6709 namespaces \u7684\u5bb9\u5668\u65e5\u8a8c\u3002\u9019\u500b\u6642\u5019\uff0c\u6bcf\u500b namespaces \u8a2d\u5b9a\u4e00\u689d flow \u660e\u986f\u662f\u4e0d\u5408\u7406\u7684\uff0c\u9019\u5c31\u9700\u8981\u4f7f\u7528 clusterflow \u8a2d\u7f6e\u898f\u5247\u4f86\u9032\u884c\u63a1\u96c6\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow ## \u5b9a\u7fa9\u70baclusterflow metadata : name : default-cluster-flow spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"es-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - exclude : ## \u6392\u9664\u4e0d\u60f3\u8981\u63a1\u96c6\u7684namespaces namespaces : - default - kube-system \u4e0a\u9762\u7684\u793a\u4f8b\u8868\u793a\u9019\u662f\u4e00\u500b cluster \u7d1a\u5225\u7684 flow\uff0c\u6839\u64da match \u5b9a\u7fa9\uff0c\u5c07\u63a1\u96c6\u9664\u4e86 default \u548c kube-system \u547d\u540d\u7a7a\u9593\u4ee5\u5916\u7684\u6240\u6709\u547d\u540d\u7a7a\u9593\u65e5\u8a8c\uff1b\u8207 flow \u76f8\u540c\u7684\u662f\uff0c clusterflow \u4e2d\u7684 match \u5b9a\u7fa9\u7684 exclude \u548c select \u53ef\u4ee5\u540c\u6642\u5b58\u5728\uff0c\u4e5f\u53ef\u4ee5\u6709\u591a\u500b exclude \u548c select \u540c\u6642\u5b58\u5728\uff0c\u5f9e\u800c\u88fd\u5b9a\u66f4\u7d30\u7dfb\u7684\u898f\u5247\u3002","title":"match"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#filters","text":"filters \u662f Logging Operator \u4e2d\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6\uff0c\u76ee\u524d\u5b98\u65b9\u652f\u6301\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6\u5982\u4e0b\uff1a Concat: \u7528\u65bc fluentd \u8655\u7406\u65e5\u8a8c\u591a\u884c\u7684\u63d2\u4ef6; Dedot: \u8655\u7406\u5e36.\u7684\u5b57\u6bb5\u66ff\u63db\u63d2\u4ef6\uff0c\u901a\u5e38\u7528\u65bc\u8f38\u51fa\u5230 elaticsearch \u524d\u7684\u5b57\u6bb5\u8f49\u5316; Exception Detector: Exception \u65e5\u8a8c\u6355\u7372\u5668\uff0c\u652f\u6301 java, js, csharp, python, go, ruby, php; Enhance K8s Metadata: banzaicloud \u958b\u767c\u7684 k8s \u64f4\u5c55\u5143\u6578\u64da; Geo IP: fluentd \u7684 GeoIP \u5730\u5740\u5eab; Grep: fluentd \u7684 grep \u904e\u6ffe\u5668; Parser: fluentd \u7684 Parser \u89e3\u6790\u5668,parse \u652f\u6301 apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none; Prometheus: Prometheus \u63d2\u4ef6\uff0c\u53ef\u7528\u65bc\u5c0d\u65e5\u8a8c\u505a\u8a08\u6578; Record Modifier: fluentd \u5b57\u6bb5\u4fee\u6539\u63d2\u4ef6; Record Transformer: Mutates/transforms incoming event streams; Stdout: \u6a19\u6e96\u8f38\u51fa\u63d2\u4ef6; SumoLogic: Sumo Logic \u516c\u53f8\u7684\u65e5\u8a8c\u8655\u7406\u63d2\u4ef6; Tag Normaliser: fluentd \u4e2d\u7684 tag \u4fee\u6539\u5668\u3002","title":"filters"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#parser","text":"Parser \u63d2\u4ef6\u6700\u5e38\u7528\u3001\u6700\u7c21\u55ae\uff0c\u652f\u6301\u89e3\u6790\u6301 apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none \u683c\u5f0f\u7684\u65e5\u8a8c\u3002\u5982\u679c\u9700\u8981\u89e3\u6790 nginx \u7684\u65e5\u8a8c\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528 Parser \u63d2\u4ef6\u9032\u884c\u8655\u7406\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-nginx-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 \u5982\u679c\u9700\u8981\u89e3\u6790 json \u683c\u5f0f\u7684\u65e5\u8a8c\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : type : json ## \u89e3\u6790\u70bajson\u683c\u5f0f time_key : time ## \u81ea\u5b9a\u7fa9key time_format : \"%Y-%m-%dT%H:%M:%S\" \u6211\u5011\u53ef\u4ee5\u5728Parser\u63d2\u4ef6\u6307\u5b9a\u591a\u7a2e\u985e\u578b\u7684\u65e5\u8a8c\u89e3\u6790\u683c\u5f0f\uff0c\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ##\u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ##\u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : type : multi_format patterns : - format : nginx ##\u89e3\u6790Nginx\u683c\u5f0f - format : json ##\u89e3\u6790json\u683c\u5f0f time_key : time time_format : \"%Y-%m-%dT%H:%M:%S\" \u5f9e\u4e0a\u9762\u7684\u5e7e\u500b\u4f8b\u5b50\u53ef\u4ee5\u770b\u51fa\u4f86\uff0c\u8655\u7406\u89e3\u6790\u65e5\u8a8c\u683c\u5f0f\u662f\u975e\u5e38\u9748\u6d3b\u7684\uff0c\u53ef\u4ee5\u642d\u914d\u4e0d\u540c\u7684\u63d2\u4ef6\u548c\u89e3\u6790\u683c\u5f0f\u4f86\u61c9\u5c0d\u4e0d\u540c\u985e\u578b\u7684\u65e5\u8a8c\u683c\u5f0f\u3002 \u4ecb\u7d39\u5b8c\u5e38\u7528\u7684 Parser \u63d2\u4ef6\u5f8c\uff0c\u518d\u7d66\u5927\u5bb6\u4ecb\u7d39\u4e00\u500b\u4ee5\u5f80\u53ef\u80fd\u90fd\u6c92\u6709\u9047\u5230\u904e\u6216\u8005\u914d\u7f6e\u8d77\u4f86\u6bd4\u8f03\u8907\u96dc\u7684\u5834\u666f\uff1a\u5982\u679c\u9700\u8981\u7d71\u8a08\u696d\u52d9\u65e5\u8a8c\u5728\u4e00\u5b9a\u6642\u9593\u6bb5\u5167\u6253\u5370\u4e86\u591a\u5c11\u7e3d\u6578\uff0c\u7528\u65bc\u5206\u6790\u696d\u52d9\u904b\u71df\u6307\u6a19\uff0c\u600e\u9ebc\u8fa6\u5462\uff1f\u53ef\u80fd\u5927\u5bb6\u7b2c\u4e00\u6642\u9593\u60f3\u5230\u7684\u662f\uff0c\u53cd\u6b63\u90fd\u5df2\u7d93\u8655\u7406\u5b8c\u4e1f\u5230\u985e\u4f3c Kibana \u7684\u5de5\u5177\u4e0a\u4e86\uff0c\u76f4\u63a5\u904e\u6ffe\u4e00\u4e0b\u4e0d\u5c31\u51fa\u6578\u64da\u4e86\uff1f\u9019\u500b\u65b9\u6cd5\u662f\u53ef\u4ee5\u7684\uff0c\u4f46\u662f\u5047\u8a2d\u4e00\u4e0b\uff0c\u60f3\u8981\u901a\u904e\u65e5\u8a8c\u689d\u76ee\u6578\u91cf\u6301\u7e8c\u5206\u6790\u696d\u52d9\u904b\u71df\u6307\u6a19\u600e\u9ebc\u8fa6\uff1f\u63a5\u4e0b\u4f86\u5206\u4eab\u53e6\u5916\u4e00\u500b\u63d2\u4ef6\u3002","title":"Parser \u63d2\u4ef6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#prometheus","text":"Prometheus \u4f5c\u70ba\u96f2\u539f\u751f\u6642\u4ee3\u7684\u76e3\u63a7\u5229\u5668\uff0c\u5f37\u5927\u7684\u6642\u5e8f\u578b\u6578\u64da\u5eab\uff0c\u914d\u5408 PromQL \u548c Grafana \u9084\u6709\u773e\u591a\u7684Exporter\uff0c\u57fa\u672c\u53ef\u4ee5\u76e3\u63a7\u6211\u5011\u9700\u8981\u7684\u4efb\u4f55\u6307\u6a19\uff1bLogging Operator \u4e2d\u4e5f\u5f15\u5165\u4e86 Prometheus \u63d2\u4ef6\uff0c\u7528\u65bc\u7d71\u8a08\u66b4\u9732\u6536\u96c6\u7684\u6307\u5b9a\u65e5\u8a8c\u689d\u76ee\u3002\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - prometheus : ## Pormetheus\u63d2\u4ef6 metrics : - desc : The total number of nginx in log. ## \u6307\u6a19\u8aaa\u660e name : nginx_log_total_counter ## \u6307\u6a19\u540d\u7a31 type : counter ## \u6307\u6a19Prometheus\u985e\u578b labels : ## \u6307\u6a19\u6a19\u7c64 app : nginx labels : ## \u6307\u6a19\u6a19\u7c64 host : ${hostname} tag : ${tag} namespace : $.kubernetes.namespaces - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"es-output\" ## \u5b9a\u7fa9Output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx \u4ee5\u4e0a\u4f8b\u5b50\u4f7f\u7528\u4e86 Parser \u63d2\u4ef6\u5c0d Nginx \u65e5\u8a8c\u9032\u884c\u8655\u7406\uff0c\u4f7f\u7528\u4e86 Prometheus \u63d2\u4ef6\u5c0d\u8f38\u51fa\u7684 Nginx \u65e5\u8a8c\u9032\u884c\u7d71\u8a08\u3002 Prometheus \u63d2\u4ef6\u4e3b\u8981\u6709\u4ee5\u4e0b\u5e7e\u500b\u5b57\u6bb5\uff1a desc : \u5c0d\u8a72\u6307\u6a19\u7684\u63cf\u8ff0\uff1b name : \u6307\u6a19\u7684\u540d\u7a31\uff1b type : \u6307\u6a19\u7684 Prometheus \u6578\u64da\u985e\u578b(\u4e86\u89e3\u66f4\u591a\u8acb\u53c3\u8003 Prometheus \u6578\u64da\u985e\u578b\u6587\u6a94)\uff1b labels : \u6307\u6a19\u7684\u6a19\u7c64(\u4e86\u89e3\u66f4\u591a\u8acb\u53c3\u8003 Prometheus Label \u6587\u6a94)\u3002 \u901a\u904e\u4e0a\u9762\u9019\u500b Flow \u5c31\u53ef\u4ee5\u7d71\u8a08\u7e3d\u5171\u8655\u7406\u4e86\u591a\u5c11\u884c Nginx \u7684\u65e5\u8a8c\uff0c\u4e26\u4f7f\u7528 Prometheus \u66b4\u9732 counter \u985e\u578b\u6307\u6a19\u4ee5\u505a\u76e3\u63a7\u5206\u6790\u3002","title":"Prometheus \u63d2\u4ef6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#_2","text":"\u901a\u904e\u4ee5\u4e0a\u5169\u500b\u63d2\u4ef6\u7684\u4f7f\u7528\u793a\u4f8b\u53ef\u4ee5\u770b\u51fa Logging Operator \u7684\u9748\u6d3b\u3001\u5f37\u5927\u4e4b\u8655\uff0c\u6b64\u5916\uff0c\u60a8\u9084\u53ef\u4ee5\u914d\u5408\u5176\u4ed6\u773e\u591a\u7684\u63d2\u4ef6\uff0c\u9748\u6d3b\u5730\u5b8c\u6210\u5c0d\u65e5\u8a8c\u63a1\u96c6\u8655\u7406\u7684\u9700\u6c42\u3002 \u95dc\u65bc\u66f4\u591a Logging Operator \u7684 filter \u652f\u6301\u7684\u63d2\u4ef6\u8aaa\u660e\uff0c\u8acb\u67e5\u770b https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/filters/","title":"\u5c0f\u7d50"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#output-clusteroutput","text":"Output \u548c ClusterOutput \u5169\u500b CRD \u5b9a\u7fa9\u4e86\u8655\u7406\u5b8c\u6210\u7684\u65e5\u8a8c\u61c9\u8a72\u8f38\u51fa\u5230\u54ea\u500b\u5730\u65b9\u3002\u8207 flow \u548c clusterflow \u76f8\u540c\u7684\u662f\uff0coutput \u540c\u6a23\u662f namespaces \u7d1a\u5225\u7684\uff0c\u5b83\u53ea\u80fd\u88ab\u540c\u547d\u540d\u7a7a\u9593\u4e0b\u7684 flow \u5f15\u7528\uff1bclusterflow \u662f\u96c6\u7fa4\u7d1a\u5225\u7684\uff0c\u53ef\u4ee5\u88ab\u4e0d\u540c\u547d\u540d\u7a7a\u9593\u7684 flow \u548c clusterflow \u5f15\u7528\u3002","title":"Output \u548c ClusterOutput"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#output","text":"Output \u5b9a\u7fa9\u4e86\u65e5\u8a8c\u7684\u8f38\u51fa\u65b9\u5f0f\uff0c\u76ee\u524d Logging Operator \u652f\u6301\u8f38\u51fa\u63d2\u4ef6\u5982\u4e0b\uff1a Alibaba Cloud Amazon CloudWatch Amazon Elasticsearch Amzon Kinesis Amazon S3 Amzon Storage Buffer Datadog Elasticsearch File Format Format rfc5424 Forward GELF Goole Cloud Storage Grafana Loki Http Kafka LogDNA LogZ NewRelic Splunk SumoLogic Syslog \u53ef\u4ee5\u770b\u5230 Logging Operator \u652f\u6301\u8f38\u51fa\u7684\u63d2\u4ef6\u9084\u662f\u975e\u5e38\u8c50\u5bcc\u7684\uff0c\u57fa\u672c\u4e0a\u6db5\u84cb\u4e86\u4f7f\u7528\u5834\u666f\u4e2d\u7684\u5de5\u5177\u3002\u4e0b\u9762\u6211\u5011\u5c07\u4ee5\u5e38\u7528\u7684\u5169\u7a2e\u63d2\u4ef6 Kafka \u548c Elasticsearch \u9032\u884c\u8209\u4f8b\uff0c\u914d\u7f6e Output CRD\u3002","title":"Output"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#output-kafka","text":"apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : kafka-output spec : kafka : brokers : kafka-headless.kafka.svc.cluster.local:29092 ## kafka\u5730\u5740 default_topic : topic topic_key : kafka-output ## kafka topic\u540d\u7a31\uff1b sasl_over_ssl : false ## \u662f\u5426\u4f7f\u7528ssl format : type : json ## \u985e\u578b buffer : ## \u767c\u9001buff\u914d\u7f6e tags : topic timekey : 1m timekey_wait : 30s timekey_use_utc : true \u5728\u4e0a\u9762\u9019\u500b\u7c21\u55ae\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u4e00\u500b\u8f38\u51fa\u5230 kafka \u7684 output CRD\uff0c\u53ef\u4ee5\u770b\u5230\u5e7e\u500b\u95dc\u9375\u914d\u7f6e\uff0ckafka \u7684\u5730\u5740\u3001topic \u7684\u540d\u7a31\u3001\u662f\u5426\u4f7f\u7528 ssl\uff1b\u4e0b\u9762\u7684 buffer\u6307\u767c\u9001 buffer \u914d\u7f6e\uff0c\u9019\u6a23\u4e00\u500b\u767c\u9001\u5230 kafka \u7684 output CRD \u5c31\u5b8c\u6210\u4e86\u3002 Buff \u914d\u7f6e\u4e5f\u53ef\u4ee5\u6839\u64da\u5be6\u969b\u60c5\u6cc1\u9032\u884c\u8abf\u6574\u3002","title":"Output-Kafka"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#output-elasticsearch","text":"apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : elasticsearch-output spec : elasticsearch : host : elasticsearch-elasticsearch-cluster.default.svc.cluster.local port : 9200 scheme : https ssl_verify : false ssl_version : TLSv1_2 buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true \u5728\u4e0a\u9762\u9019\u500b\u7c21\u55ae\u4f8b\u5b50\u4e2d\uff0c\u6211\u5011\u5b9a\u7fa9\u4e86\u4e00\u500b\u8f38\u51fa\u5230 elasticsearch \u7684 output CRD\uff0c\u5176\u5be6\u548c kafka\u7684 output \u914d\u7f6e\u985e\u4f3c\uff0c\u9700\u8981\u5b9a\u7fa9 elasticsearch \u7684\u5730\u5740\u3001\u7aef\u53e3\u3001\u662f\u5426\u9700\u8981 ssl \u8a8d\u8b49\uff1bbuffer \u914d\u7f6e\u5b9a\u7fa9\u4e86\u767c\u9001\u6642\u7684 buff \u914d\u7f6e\u3002 \u95dc\u65bc\u66f4\u591a\u914d\u7f6e\u9805\uff0c\u67e5\u770b\u6587\u6a94\uff1a https://banzaicloud.com/docs/one-eye/logging-operator/configuration/plugins/outputs/","title":"Output-Elasticsearch"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#flow-output","text":"\u5728\u5b9a\u7fa9\u597d\u4e86 flow \u548c output \u4e4b\u5f8c\uff0c\u9700\u8981\u5728 flow \u5b9a\u7fa9 localOutputRefs \u4f86\u8207 output \u9032\u884c\u95dc\u806f\uff0c\u4ee5\u9032\u884c\u65e5\u8a8c\u7684\u767c\u9001\u8655\u7406\u3002\u793a\u4f8b\u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"elasticsearch-output\" ## \u8f38\u51fa\u5230elasticsearch-output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx \u5728\u4e0a\u9762\u9019\u500b\u4f8b\u5b50\u4e2d\uff0clocalOutputRefs \u914d\u7f6e\u4e86 elasticsearch-output\uff0c\u9019\u6a23\u5c31\u8207\u6211\u5011\u525b\u525b\u5b9a\u7fa9\u7684\u540d\u7a31\u70ba elasticsearch-output \u7684 output \u9032\u884c\u4e86\u95dc\u806f\uff0c\u65e5\u8a8c\u5c31\u53ef\u4ee5\u5f9e\u6307\u5b9a\u7684 output \u9032\u884c\u8f38\u51fa\u3002\u503c\u5f97\u4e00\u63d0\u7684\u662f\uff0cLogging Operator \u5145\u5206\u8003\u616e\u4e86\u76f8\u540c\u65e5\u8a8c\u9700\u8981\u8f38\u51fa\u5230\u4e0d\u540c\u5730\u9ede\u7684\u9700\u6c42\u3002\u6bd4\u5982\u4e0b\u9762\u9019\u500b\u4f8b\u5b50\uff0c\u5c31\u53ef\u4ee5\u5c07\u65e5\u8a8c\u540c\u6642\u8f38\u51fa\u5230 kafka \u548c elasticsearch\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : default-flow namespace : default ## \u5b9a\u7fa9\u6536\u96c6\u65e5\u8a8c\u7684\u547d\u540d\u7a7a\u9593 spec : filters : ## \u5b9a\u7fa9\u904e\u6ffe\u5668\uff0c\u4e00\u500bflow\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u6216\u8005\u591a\u500b - parser : remove_key_name_field : true parse : ## parse\u652f\u6301apache2, apache_error, nginx, syslog, csv, tsv, ltsv, json, multiline, none, logfmt\u985e\u578b\u89e3\u6790 type : nginx ## \u63a1\u96c6\u65e5\u8a8c\u6309\u7167Nginx\u683c\u5f0f\u9032\u884c\u8655\u7406 - tag_normaliser : format : ${namespace_name}.${pod_name}.${container_name} ## \u5728fluentd\u88e1\u9762\u4f7f\u7528${namespace_name}.${pod_name}.${container_name}\u7684\u683c\u5f0f localOutputRefs : - \"elasticsearch-output\" ## \u8f38\u51fa\u5230elasticsearch-output - \"kafka-output\" ## \u8f38\u51fa\u5230kafka-output match : ## Kubernetes\u6a19\u7c64\u4f86\u5b9a\u7fa9\u54ea\u4e9b\u65e5\u8a8c\u9700\u8981\u88ab\u63a1\u96c6 - select : labels : ## \u4f7f\u7528\u6a19\u7c64\u5339\u914d\u63a1\u96c6\u65e5\u8a8c app : nginx","title":"flow \u548c output \u76f8\u95dc\u806f"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#_3","text":"\u4e0a\u6587\u4ecb\u7d39\u7684 flow\u3001clusterflow \u548c output\u3001clusteroptput \u529f\u80fd\u90fd\u662f\u9748\u6d3b\u800c\u5f37\u5927\u7684\u3002\u5728 SUSE Rancher 2.6 \u7248\u672c\u90e8\u7f72\u5b8c Logging \u5f8c\uff0c\u53ef\u4ee5\u901a\u904e yaml \u7de8\u5beb CRD \u4e26\u76f4\u63a5\u61c9\u7528\u5230\u96c6\u7fa4\u4e2d\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5728 SUSE Rancher UI \u4e0a\u9032\u884c\u914d\u7f6e\u3002\u4e0b\u4e00\u7ae0\u5c07\u6703\u4ecb\u7d39\u5982\u4f55\u5728 SUSE Rancher UI \u4e0a\u5c0d flow \u548c output \u9032\u884c\u914d\u7f6e","title":"\u5c0f\u7ed3"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#suse-rancher-ui-flow-output","text":"\u672c\u7ae0\u7bc0\u5167\u5bb9\u5c07\u6703\u63cf\u8ff0\u5728 SUSE Rancher UI \u4e0a\u9032\u884c\u65e5\u8a8c\u63a1\u96c6\u914d\u7f6e\u3002","title":"\u5728 SUSE Rancher UI \u4e0a\u5c0d flow \u548c output \u9032\u884c\u914d\u7f6e"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#outputsclusteroutputs","text":"\u5728 SUSE Rancher UI \u4e0a\u914d\u7f6e\u9996\u5148\u9700\u8981\u5275\u5efa\u4e00\u500b flow \u6216\u8005 clusterflow\uff0c\u9032\u5165\u65e5\u8a8c\u9801\u9762\u9078\u64c7 outputs/clusteroutputs\uff0c\u9078\u64c7\u5c07\u8981\u767c\u9001\u7684\u5f8c\u7aef\u5de5\u5177\uff0c\u793a\u4f8b\u4e2d\u4ee5 es \u70ba\u4f8b\uff0c\u914d\u7f6e\u7d22\u5f15\u540d\u7a31\u3001\u4e3b\u6a5f\u5730\u5740\u3001\u7aef\u53e3\u3001outputs \u540d\u7a31\uff0c\u5982\u679c\u6709 https \u6216\u8005 ssl \u9700\u8981\u5148\u5275\u5efa secrets\u3002 \u5275\u5efa\u5b8c\u6210\u5f8c\u7684 CRD yaml \u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Output metadata : name : rancher26-es-output namespace : default spec : elasticsearch : buffer : timekey : 1m timekey_use_utc : true timekey_wait : 30s host : 172.16.0.14 index_name : rancher26 port : 9200 scheme : http","title":"\u5275\u5efa outputs/clusteroutputs"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#flowclusterflow","text":"Outputs \u5275\u5efa\u5b8c\u6210\u4e4b\u5f8c\uff0c\u958b\u59cb\u5275\u5efa flow/clusterflow \u898f\u5247\uff1a\u9032\u5165\u65e5\u8a8c\u9801\u9762\u9078\u64c7 flows/clusterflows\uff0c\u9ede\u64ca\u5275\u5efa\uff0c\u9032\u884c flow \u914d\u7f6e\uff0c\u793a\u4f8b\u4e2d\u5c07\u63a1\u96c6\u6a19\u7c64\u70ba app:nginx \u7684\u5bb9\u5668\u65e5\u8a8c\uff1a \u8f38\u5165\u5bb9\u5668\u6a19\u7c64\u5339\u914d\u898f\u5247\u3001\u540d\u7a31\uff1b\u5982\u679c\u6709\u4e0d\u60f3\u63a1\u96c6\u7684\u4e3b\u6a5f\u6216\u8005\u5bb9\u5668\uff0c\u4e5f\u53ef\u4ee5\u9032\u884c\u9078\u64c7\uff1b\u9801\u9762\u4e0a\u4e5f\u53ef\u4ee5\u6dfb\u52a0\u591a\u500b\u6a19\u7c64\u5339\u914d\u898f\u5247\uff1b \u914d\u7f6e\u8f38\u51fa\u898f\u5247\uff0c\u9019\u88e1\u9078\u64c7\u6211\u5011\u525b\u525b\u5275\u5efa\u7684 outputs\uff0c\u9019\u88e1\u53ef\u4ee5\u9078\u64c7\u591a\u500b outputs \u548c clusteroutput\uff0c\u4e5f\u53ef\u4ee5\u540c\u6642\u9078\u64c7 output \u548c clusteroptput\uff1b \u914d\u7f6e\u904e\u6ffe\u898f\u5247\uff0c\u9019\u88e1\u6211\u5011\u6536\u96c6\u7684\u662f nginx \u65e5\u8a8c\uff0c\u6240\u4ee5\u4f7f\u7528 parser \u63d2\u4ef6\uff0c\u81ea\u52d5\u683c\u5f0f\u5316 nginx \u898f\u5247\uff1b \u5275\u5efa\u5b8c\u6210\u5f8c\u7684 CRD yaml \u5982\u4e0b\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : nginx-flow namespace : default fields : - nginx-flow spec : filters : - parser : parse : type : nginx remove_key_name_field : true localOutputRefs : - rancher26-es-output match : - select : labels : app : nginx","title":"\u5275\u5efa flow/clusterflow"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#_4","text":"\u914d\u7f6e\u5b8c\u6210\u5f8c\uff0c\u5982\u679c\u96c6\u7fa4\u4e2d\u6709\u7b26\u5408\u6a19\u7c64\u8981\u6c42\u7684\u5bb9\u5668\uff0c\u5c31\u6703\u81ea\u52d5\u63a1\u96c6\u4e26\u767c\u9001\u5230 es\uff1b \u901a\u904e\u67e5\u770b fluentd \u7684\u914d\u7f6e\uff0c\u53ef\u4ee5\u67e5\u770b outputs \u662f\u5426\u751f\u6548 ## \u9032\u5165rancher-logging-fluentd-0 Pod\u547d\u4ee4\u884c cat fluentd/app-config/fluentd.conf <match **> @type elasticsearch @id flow:default:nginx-flow:output:default:rancher26-es-output exception_backup true fail_on_putting_template_retry_exceed true host 172 .16.0.14 index_name rancher26 port 9200 reload_connections true scheme http ssl_verify true utc_index true verify_es_version_at_startup true <buffer tag,time> @type file chunk_limit_size 8MB path /buffers/flow:default:nginx-flow:output:default:rancher26-es-output.*.buffer retry_forever true timekey 1m timekey_use_utc true timekey_wait 30s </buffer> </match> \u67e5\u770b elasticsearch \u4e2d\u7684\u7d22\u5f15 \u67e5\u770b kibana \u4e2d\u7684\u65e5\u8a8c\u8a73\u60c5","title":"\u9a57\u8b49"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#_5","text":"\u81f3\u6b64\uff0cSUSE Rancher 2.6 \u5168\u65b0\u7684 Logging Operator \u958b\u7bb1\u4f7f\u7528\u5c31\u5df2\u7d93\u5168\u90e8\u7d50\u675f\u4e86\u3002\u5c0d\u6bd4\u4e4b\u524d\u7684\u65e5\u8a8c\u6536\u96c6\u529f\u80fd\uff0c\u7684\u78ba\u5f37\u5927\u4e86\u4e0d\u5c11\uff0c\u914d\u7f6e\u975e\u5e38\u9748\u6d3b\uff0c\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u591a\u7a2e\u904e\u6ffe\u5668\uff0c\u751a\u81f3\u4f7f\u7528 Prometheus \u66b4\u9732\u81ea\u5b9a\u7fa9\u6307\u6a19\u9032\u884c\u696d\u52d9\u904b\u71df\u5206\u6790\u7b49\u5167\u5bb9\u3002\u4f46\u662f\u8207\u4e4b\u524d\u53ea\u9700\u8981\u8f38\u5165\u76ee\u6a19\u7aef\u5730\u5740\u5c31\u80fd\u4f7f\u7528\u7684\u5834\u666f\u76f8\u5c0d\u6bd4\uff0cLogging Operator \u78ba\u5be6\u4e5f\u589e\u52a0\u4e86\u4e00\u5b9a\u7684\u5b78\u7fd2\u6210\u672c\uff0c\u5efa\u8b70\u201c\u5c0f\u767d\u201d\u670b\u53cb\u9084\u662f\u5f9e\u96f6\u958b\u59cb\u5b78\u7fd2\uff0c\u641e\u6e05\u695a\u6574\u9ad4\u7684\u904b\u884c\u67b6\u69cb\u548c\u908f\u8f2f\uff0c\u9019\u6a23\u6709\u52a9\u65bc\u6545\u969c\u767c\u751f\u6642\u7684\u5b9a\u4f4d\u6392\u67e5\u3002","title":"\u7e3d\u7d50"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-01/#tips","text":"\u6574\u9ad4\u67b6\u69cb\u662f\u7531 Daemonst \u985e\u578b\u7684 fluentbit \u7d44\u4ef6\u9032\u884c\u65e5\u8a8c\u63a1\u96c6\uff0cfluentbit \u7d44\u4ef6\u65e5\u8a8c\u4e2d\u6703\u6709\u65e5\u8a8c\u6587\u4ef6\u7684\u6253\u5370\u8f38\u51fa\uff0c\u7576\u767c\u73fe\u67d0\u4e9b\u65e5\u8a8c\u672a\u88ab\u63a1\u96c6\u7684\u6642\u5019\uff0c\u53ef\u4ee5\u67e5\u770b fluentbit \u7d44\u4ef6\u7684\u65e5\u8a8c\u662f\u5426\u767c\u73fe\u4e86\u9019\u4e9b\u65e5\u8a8c\uff1b Fluentd \u7d44\u4ef6\u8ca0\u8cac\u532f\u7e3d\u3001\u8655\u7406\u3001\u767c\u9001\uff0c\u7576\u767c\u73fe\u76ee\u6a19\u7aef\u6c92\u6709\u6536\u5230\u65e5\u8a8c\uff0c\u6bd4\u5982\u8aaa ES \u6c92\u6709\u5275\u5efa\u7d22\u5f15\u7684\u6642\u5019\uff0c\u53ef\u4ee5\u770b\u770b Fluentd \u7d44\u4ef6\u7684\u65e5\u8a8c\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u622a\u6b62\u6587\u7ae0\u767c\u8868\u6642\uff0cFluentd \u7684\u65e5\u8a8c\u6c92\u6709\u6253\u5370\u5728\u6a19\u6e96\u8f38\u51fa\u4e2d\uff0c\u9700\u8981\u9032\u5165 Pod \u5167\u57f7\u884c\u547d\u4ee4\u67e5\u770b\uff1a tail -f fluentd/log/out \u7121\u8ad6\u662f UI \u9084\u662f CRD \u7684 flow/outputs \u914d\u7f6e\uff0c\u6700\u7d42\u90fd\u6703\u8f49\u5316\u70ba fluentbit \u548c Fluentd \u7684\u914d\u7f6e\uff0c\u5982\u679c\u5c0d\u9019\u5169\u500b\u7d44\u4ef6\u6bd4\u8f03\u719f\u6089\uff0c\u51fa\u73fe\u7570\u5e38\u7684\u6642\u5019\u53ef\u4ee5\u9032\u5165 Pod \u4e2d\u67e5\u770b\u5177\u9ad4\u751f\u6548\u7684\u914d\u7f6e\u662f\u5426\u6b63\u78ba\uff1b \u7531\u65bc\u904e\u6ffe\u5668\u7684\u5b58\u5728\uff0c\u932f\u8aa4\u7684\u904e\u6ffe\u3001\u5339\u914d\u7684\u689d\u4ef6\u53ef\u80fd\u6703\u5c0e\u81f4\u65e5\u8a8c\u7121\u6cd5\u767c\u9001\u51fa\u53bb\uff0c\u9019\u500b\u6642\u5019\u9700\u8981\u6aa2\u67e5 flow \u4e2d\u914d\u7f6e\u7684\u898f\u5247\u60c5\u6cc1\u3002","title":"\u4e00\u4e9b Tips"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/","text":"Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580\uff082\uff09 \u00b6 \u539f\u6587: https://itcn.blog/p/22491197293.html \u6982\u8ff0 \u00b6 \u672c\u7bc7\u70ba Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580 \u7684\u5f8c\u7e8c\uff0c\u70ba\u5be6\u969b\u751f\u7522\u914d\u7f6e\u4f7f\u7528\u624b\u518a\u3002\u4e3b\u8981\u4ecb\u7d39\u4ee5\u4e0b\u65e5\u8a8c\u6536\u96c6\u914d\u7f6e\u529f\u80fd\uff1a \u5be9\u8a08\u65e5\u8a8c\u6536\u96c6 Kubernetes \u7d44\u4ef6\u65e5\u8a8c\u6536\u96c6 \u904b\u884c\u5728 Kubernetes \u4e0a\u7684\u5bb9\u5668\u61c9\u7528\u65e5\u8a8c\u6536\u96c6 Runtime \u65e5\u8a8c\u6536\u96c6 Kubernetes \u4e8b\u4ef6\u6536\u96c6\u548c\u7bc0\u9ede \u7bc0\u9ede Kernel \u65e5\u8a8c\u6536\u96c6 Rancher 2.6 \u65e5\u8a8c\u63a1\u7528\u4e86 logging-operator \u65b9\u5f0f\u9032\u884c\u65e5\u8a8c\u7ba1\u7406\uff0c\u5c0d\u61c9\u6982\u5ff5\u5982\u4e0b: logging \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u65e5\u8a8c\u63a1\u96c6\u7aef (FleuntBit) \u548c\u50b3\u8f38\u7aef (Fleuntd) \u670d\u52d9\u7684\u57fa\u790e\u914d\u7f6e\uff0c\u5728 SUSE Rancher 2.6 \u7248\u672c\u4e2d\uff0c\u5df2\u7d93\u7531 Rancher \u81ea\u52d5\u5316\u90e8\u7f72\u5b8c\u6210\uff1b flow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; clusterflow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; output \uff1a\u7528\u65bc\u5b9a\u7fa9 namespace (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u7684\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u53ea\u80fd\u88ab\u540c\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\uff1b clusteroutput \uff1a\u7528\u65bc\u5b9a\u7fa9\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u80fd\u628a\u88ab\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\u3002 Logging \u914d\u7f6e\u4f7f\u7528 \u00b6 ElasticSearch \u548c kibana \u90e8\u7f72 \u00b6 \u70ba\u4e86\u66f4\u597d\u5730\u6f14\u793a\u6548\u679c\uff0c\u9019\u88e1\u90e8\u7f72\u81e8\u6642\u7684 ElasticSearch \u548c kibana \u4f5c\u70ba\u6f14\u793a\u74b0\u5883\uff1a docker run -d --name elasticsearch -p 9200 :9200 -p 9300 :9300 -e \"discovery.type=single-node\" elasticsearch:7.5.2 docker run --name kibana -e ELASTICSEARCH_HOSTS = http://172.16.1.232:9200 -p 5601 :5601 -d kibana:7.5.2 Info \u6ce8\uff1a\u5c07 ELASTICSEARCH_HOSTS \u5730\u5740\u4fee\u6539\u70ba\u5be6\u969b ElasticSearch \u7684\u5730\u5740\u3002 \u90e8\u7f72\u5b8c\u5f8c\u53ef\u901a\u904e http://ip:9200 \u8a2a\u554f ElasticSearch\uff0c\u901a\u904e http://ip:5601 \u8a2a\u554f Kibana\u3002 \u542f\u7528 Rancher Logging \u00b6 \u5207\u63db\u5230\u5c0d\u61c9\u96c6\u7fa4\uff0c\u9078\u64c7 cluster-Tools \u2014\u2014> Logging\uff0c\u4e26\u52fe\u9078\u81ea\u5b9a\u7fa9 Helm \u9078\u9805\uff1a systemd Log Path \u5b58\u5132\u7684\u662f\u7cfb\u7d71\u65e5\u8a8c\uff0c\u56e0\u70ba k3s \u548c RKE2 \u767c\u884c\u7248\u65e5\u8a8c\u90fd\u5b58\u5132\u5728\u6b64\u3002\u56e0\u6b64\u70ba\u4e86\u6536\u96c6\u6b64\u65e5\u8a8c\uff0c\u9700\u8981\u9032\u884c\u914d\u7f6e\u6b64\u9078\u9805\u3002 \u8981\u78ba\u5b9a\u76ee\u9304\u4f4d\u7f6e\uff0c\u53ef\u5728\u5176\u4e2d\u4e00\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\uff1a cat /etc/systemd/journald.conf | grep -E ^ \\# ?Storage | cut -d \"=\" -f2 \u5982\u679c\u8fd4\u56de persistent \uff0c\u5247\u61c9\u70ba: systemdLogPath/var/log/journal \u5982\u679c\u8fd4\u56de volatile \uff0c\u5247\u61c9\u70ba\uff1a systemdLogPath/run/log/journal \u5982\u679c\u8fd4\u56de auto \uff0c\u8acb\u6aa2\u67e5\u662f\u5426\u5b58\u5728 /var/log/journal \u5982\u679c\u5b58\u5728 /var/log/journal \uff0c\u5247\u4f7f\u7528 /var/log/journal \u5982\u679c\u4e0d\u5b58\u5728 /var/log/journal \uff0c\u5247\u4f7f\u7528 /run/log/journal SUSE15 \u9ed8\u8a8d\u70ba /run/log/journal \u90e8\u7f72\u524d\u52fe\u9078\u7de8\u8f2f yaml\uff0c\u9032\u884c\u4ee5\u4e0b\u53c3\u6578\u4fee\u6539\uff1a \u4fee\u6539 loggint-Operator \u7684\u9ed8\u8a8d\u914d\u7f6e\uff0c\u5982 fluentd \u548c fluentbit \u9ed8\u8a8d\u8cc7\u6e90\u9650\u5236\u548c\u5bb9\u5fcd\u898f\u5247\uff0c\u5c07 fluentbit \u90e8\u7f72\u5230 Controller \u7bc0\u9ede\u7528\u65bc\u7cfb\u7d71\u65e5\u8a8c\u6536\u96c6\u3002 bufferStorageVolume \u70ba fluentd \u6536\u96c6 fluentbit \u7684 log buffer \u76ee\u9304\uff0c\u6709\u5206\u4f48\u5f0f\u6587\u4ef6\u7cfb\u7d71\u5b58\u5132\uff0c\u5efa\u8b70\u5b58\u5132\u5230\u5206\u4f48\u5f0f\u6587\u4ef6\u7cfb\u7d71\u4e2d\uff0c\u4fee\u6539 storageClassName \u70ba\u5be6\u969b\u5206\u4f48\u5f0f\u5b58\u5132\u7684 stroageclass \u540d\u5b57\u3002\u5982\u679c\u6c92\u6709\u5c0d\u61c9\u5b58\u5132\uff0c\u53ef\u4ee5\u4fee\u6539\u70babufferStorageVolume: {}\u3002 \u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a fluentbit : filterKubernetes : Merge_Log : '' Merge_Log_Key : '' Merge_Log_Trim : '' Merge_Parser : '' inputTail : Buffer_Chunk_Size : '' Buffer_Max_Size : '' Mem_Buf_Limit : '' Multiline_Flush : '' Skip_Long_Lines : '' resources : limits : cpu : 500mp where you can insert the devi fluentd : bufferStorageVolume : pvc : spec : accessModes : - ReadWriteOnce resources : requests : storage : 40Gi storageClassName : fast volumeMode : Filesystem livenessProbe : initialDelaySeconds : 30 periodSeconds : 15 tcpSocket : port : 24240 nodeSelector : {} resources : limits : cpu : '2' memory : 4096M requests : cpu : 500m memory : 100M tolerations : {} replicas : 3 fullnameOverride : '' Warning \u4e0a\u8ff0\u7684\u8a2d\u5b9a\u5fc5\u9700\u6839\u64da\u500b\u81ea\u3000K8S\u3000\u96c6\u7fa4\u7684\u5143\u4ef6\u8207\u914d\u7f6e\u4f86\u9032\u884c\u76f8\u5c0d\u7684\u4fee\u6539\u3002 \u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u90e8\u7f72\u662f\u5426\u6210\u529f\uff1a kubectl get pod -n cattle-logging-system NAME READY STATUS RESTARTS AGE rancher-logging-96b68cc4b-vqxnd 1 /1 Running 0 9m54s rancher-logging-fluentbit-cntgb 1 /1 Running 0 69s rancher-logging-fluentbit-hwmdx 1 /1 Running 0 71s rancher-logging-fluentbit-nw7rw 1 /1 Running 0 71s rancher-logging-fluentd-0 2 /2 Running 0 9m34s rancher-logging-fluentd-1 2 /2 Running 0 9m34s rancher-logging-fluentd-2 2 /2 Running 0 9m34s rancher-logging-fluentd-configcheck-ac2d4553 0 /1 Completed 0 9m48s \u96c6\u7fa4\u5be9\u8a08\u65e5\u8a8c\u958b\u555f\u548c\u63a1\u96c6 \u00b6 \u8981\u5728\u96c6\u7fa4\u6240\u6709 Controller \u7bc0\u9ede\u4e0a\u5275\u5efa\u5be9\u8a08\u65e5\u8a8c\u7b56\u7565\uff0c\u9700\u8981\u5728\u4e3b\u6a5f\u5275\u5efa\u5be9\u8a08\u65e5\u8a8c\u7b56\u7565\u6587\u4ef6 /etc/kubernetes/audit-policy.yaml \uff0c\u5167\u5bb9\u5982\u4e0b\uff1a apiVersion : audit.k8s.io/v1 kind : Policy omitStages : - \"RequestReceived\" rules : - level : Metadata \u6dfb\u52a0\u96c6\u7fa4\u53c3\u6578\uff0c\u5f9e Cluster-Manager \u9078\u64c7\u5c0d\u61c9\u7684\u96c6\u7fa4 \u2014> edit Config \uff0c\u7d66 Api-server \u6dfb\u52a0\u4ee5\u4e0b\u53c3\u6578\uff1a kube-apiserver-arg : - audit-log-maxsize=100 - audit-log-maxage=60 - audit-log-maxbackup=10 - audit-policy-file=/etc/kubernetes/audit-policy.yaml \u53c3\u6578\u89e3\u91cb\uff1a maxsize \uff1a\u8868\u793a\u65e5\u8a8c\u91cf\u591a\u5927\u6642\u9032\u884c\u4e00\u6b21\u8f2a\u8f49 maxage \uff1a\u8868\u793a\u4fdd\u7559\u5be9\u8a08\u65e5\u8a8c\u591a\u5c11\u5929 maxbackup \uff1a\u8868\u793a\u4fdd\u7559\u5be9\u8a08\u65e5\u8a8c\u6587\u4ef6\u591a\u5c11\u4efd policy-file \uff1a\u5b9a\u7fa9\u5be9\u8a08\u65e5\u8a8c\u4fdd\u5b58\u7b56\u7565 \u6dfb\u52a0 apiserver \u76ee\u9304\u6620\u5c04\u53c3\u6578\uff1a kube-apiserver-extra-mount : - /etc/kubernetes:/etc/kubernetes \u56e0\u70ba api-server \u662f pod \u65b9\u5f0f\u555f\u52d5\uff0c\u70ba\u4e86\u80fd\u52a0\u8f09 auditlog-policy\uff0c\u9700\u8981\u5c07\u6b64\u76ee\u9304\u6620\u5c04\u5230 api-server pod \u4e2d\u3002 \u5b8c\u6210\u5f8c\uff0c\u96c6\u7fa4\u6703\u9032\u5165\u81ea\u52d5\u5347\u7d1a\u6a21\u5f0f\u3002\u7b49\u5f85\u5347\u7d1a\u5b8c\u6210\uff0c\u96c6\u7fa4\u5be9\u8a08\u65e5\u8a8c\u5c07\u5b58\u5132\u5728 /var/lib/rancher/rke2/server/logs/audit.log \u6587\u4ef6\u548c\u76ee\u9304\u3002 Kubernetes \u7d44\u4ef6\u65e5\u8a8c\u6536\u96c6 \u00b6 RKE2 Kubernetes \u7d44\u4ef6\u65e5\u8a8c\u90fd\u96c6\u4e2d\u5728\u4ee5\u4e0b namespace \u4e2d\uff0c\u5728\u555f\u52d5 logging \u6642\uff0c\u914d\u7f6e\u65e5\u8a8c\u76ee\u9304\u6703\u81ea\u52d5\u90e8\u7f72\u63a1\u96c6\u5668\u9032\u884c\u63a1\u96c6\uff1a \u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : test-output namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true host : 172.16.1.166 port : 9200 scheme : http reconnect_on_error : true reload_on_failure : true reload_connections : false logstash_format : true logstash_prefix : k8s-components --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : test namespace : cattle-logging-system spec : globalOutputRefs : - test-output match : - select : namespaces : - cattle-monitoring-system - cattle-system - kube-system ClusterOutput \u5b9a\u7fa9\u65e5\u8a8c\u767c\u9001\u5230\u54ea\uff0c\u9019\u88e1\u914d\u7f6e\u7684\u662f ElasticSearch\uff0c\u6839\u64da\u5be6\u969b\u60c5\u6cc1\uff0c\u4fee\u6539 ElasticSearch \u7684\u5730\u5740\uff1b Logstash_prefix \u5b9a\u7fa9\u7684\u662f\u5c0d\u61c9\u7684 ElasticSearch \u5167\u7684 index \u540d\u7a31\u3002\u5efa\u8b70\u6839\u64da\u5c0d\u61c9\u96c6\u7fa4\u540d\u7a31\u914d\u7f6e\uff1b Logstash_prefix \u5b9a\u7fa9\u767c\u9001\u5230 ES \u5f8c\u5c0d\u61c9\u7684 Index \u540d\u7a31\uff1b Logstash_format \u8868\u793a\u958b\u555f Index \u6309\u5929\u81ea\u52d5\u5275\u5efa\u8f2a\u8f49\uff1b ClusterFlow \u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\uff0c\u5728\u9019\u88e1 labels \u8207\u5c0d\u61c9\u7684\u63a1\u96c6 pod \u7684 label \u76f8\u95dc\u9023\uff0c\u9019\u88e1\u555f\u52d5 Hosttailer \u5f8c\u6703\u81ea\u52d5\u555f\u52d5\u6536\u96c6 pod \u548c\u96c6\u7fa4\u5c64\u7d1a\u6536\u96c6\u95dc\u806f\uff1b GlobalOutputRefs \u5b9a\u7fa9\u7684\u70ba\u4e0a\u9762\u914d\u7f6e\u7684 ClusterOutput \u7684\u540d\u7a31\uff0c\u8868\u793a\u8f38\u51fa\u5230\u4ec0\u9ebc\u5730\u65b9\u3002 Kubernetes Application \u65e5\u8a8c\u63a1\u96c6 \u00b6 \u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : k8s-application-output namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true host : 172.16.1.166 port : 9200 scheme : http reconnect_on_error : true reload_on_failure : true reload_connections : false logstash_format : true logstash_prefix : k8s-application --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : test namespace : cattle-logging-system spec : globalOutputRefs : - k8s-application-output match : - exclude : namespaces : - cattle-monitoring-system - cattle-system - cattle-logging-system - kube-system - cattle-fleet-system - select : {} \u901a\u904e exclude \u5c07\u7cfb\u7d71\u7d44\u4ef6\u547d\u540d\u7a7a\u9593\u6392\u9664\u5728\u5916\uff0c\u63a1\u96c6\u7684\u4fbf\u662f\u5168\u90e8\u61c9\u7528\u7684\u6a19\u6e96\u8f38\u51fa\u65e5\u8a8c\u3002 Runtime \u65e5\u5fd7\u91c7\u96c6 \u00b6 \u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : HostTailer metadata : name : runtimelog-hosttailer namespace : cattle-logging-system spec : fileTailers : - name : runtime-tail path : /var/lib/rancher/rke2/agent/containerd/containerd.log buffer_max_size : 64k #\u6b64\u503c\u4e00\u5b9a\u8981\u4fee\u6539\uff0c\u4e0d\u7136\u542f\u52a8\u4e0d\u6210\u529f disabled : false skip_long_lines : \"true\" containerOverrides : image : www.wanshaoyuan.com/rancher/mirrored-fluent-fluent-bit:1.8.15 workloadOverrides : tolerations : - effect : NoSchedule key : cattle.io/os operator : Equal value : linux - operator : Exists --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : runtimelog-tailer-clusteroutput namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true reconnect_on_error : true reload_on_failure : true reload_connections : false host : 172.16.1.166 port : 9200 scheme : http logstash_format : true logstash_prefix : cluster1-runtimelog-tailer --- apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : runtimetailer-flow namespace : cattle-logging-system spec : filters : - tag_normaliser : {} - parser : parse : type : none match : - select : labels : app.kubernetes.io/instance : runtimelog-hosttailer-host-tailer globalOutputRefs : - runtimelog-tailer-clusteroutput \u914d\u7f6e\u5be9\u8a08\u65e5\u8a8c\u63a1\u96c6 \u00b6 \u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : HostTailer metadata : name : auditlog-hosttailer namespace : cattle-logging-system spec : fileTailers : - name : audit-tail path : /var/lib/rancher/rke2/server/logs/audit.log buffer_max_size : 64k #\u6b64\u503c\u4e00\u5b9a\u8981\u4fee\u6539\uff0c\u4e0d\u7136\u542f\u52a8\u4e0d\u6210\u529f disabled : false skip_long_lines : \"true\" containerOverrides : image : www.wanshaoyuan.com/rancher/mirrored-fluent-fluent-bit:1.8.15 workloadOverrides : tolerations : - effect : NoSchedule key : cattle.io/os operator : Equal value : linux - operator : Exists --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : auditlog-tailer-clusteroutput namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true reconnect_on_error : true reload_on_failure : true reload_connections : false host : 172.16.1.166 port : 9200 scheme : http logstash_format : true logstash_prefix : cluster1-auditlog-tailer --- apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : hosttailer-flow namespace : cattle-logging-system spec : filters : - tag_normaliser : {} - parser : parse : type : json match : - select : labels : app.kubernetes.io/instance : auditlog-hosttailer-host-tailer globalOutputRefs : - auditlog-tailer-clusteroutput containerOverrides \u5b9a\u7fa9\u7684\u662f\u96e2\u7dda\u90e8\u7f72\u7684\u93e1\u50cf\uff0c\u9ed8\u8a8d\u93e1\u50cf\u5730\u5740\u70ba fluent/fluent-bit:1.8.15; HostTailer \u5b9a\u7fa9\u63a1\u96c6\u7684\u6587\u4ef6\uff0c\u4e26\u81ea\u52d5\u90e8\u7f72 fluent-bit \u9032\u884c\u639b\u8f09\u6620\u5c04; ClusterOutput \u5b9a\u7fa9\u65e5\u8a8c\u767c\u9001\u5230\u54ea\uff0c\u9019\u88e1\u914d\u7f6e\u7684\u662f ElasticSearch\uff0c\u6839\u64da\u5be6\u969b\u60c5\u6cc1\uff0c\u4fee\u6539 ElasticSearch \u7684\u5730\u5740\uff0clogstash_prefix \u5b9a\u7fa9\u7684\u662f\u5c0d\u61c9\u7684 ElasticSearch \u5167\u7684 index \u540d\u7a31\u3002\u5efa\u8b70\u6839\u64da\u5c0d\u61c9\u96c6\u7fa4\u540d\u7a31\u914d\u7f6e; Flow \u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\uff0c\u5728\u9019\u88e1 labels \u8207\u5c0d\u61c9\u7684\u63a1\u96c6 pod \u7684 label \u76f8\u95dc\u9023\uff0c\u9019\u88e1\u555f\u52d5 hosttailer \u5f8c\u6703\u81ea\u52d5\u555f\u52d5\u6536\u96c6 pod\uff0c\u5b83\u7684 label \u70baapp.kubernetes.io/instance: auditlog-hosttailer-host-tailer; globalOutputRefs \u5b9a\u7fa9\u7684\u70ba\u4e0a\u9762\u914d\u7f6e\u7684 ClusterOutput \u7684\u540d\u7a31\uff0c\u8868\u793a\u8f38\u51fa\u5230\u4ec0\u9ebc\u5730\u65b9\u3002 Event \u6536\u96c6 \u00b6 \u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : EventTailer metadata : name : rancher spec : controlNamespace : cattle-logging-system containerOverrides : image : www.wanshaoyuan.com/rancher/eventrouter:v0.1.0 --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : event-tailer-clusteroutput namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true reconnect_on_error : true reload_on_failure : true reload_connections : false host : 172.16.1.166 port : 9200 scheme : http logstash_format : true logstash_prefix : kubernetes-event-tailer --- apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : rancher-event-tailer-flow namespace : cattle-logging-system spec : filters : - tag_normaliser : {} - parser : parse : type : json globalOutputRefs : - event-tailer-clusteroutput match : - select : labels : app.kubernetes.io/name : event-tailer EventTailer \uff1a\u8a2d\u7f6e Event \u6536\u96c6\uff0c\u6703\u555f\u52d5\u4e00\u500b rancher-event-tailer statefulset\uff0c\u5167\u7db2\u90e8\u7f72\u9700\u8981\u4fee\u6539\u93e1\u50cf\u5730\u5740\u70ba\u5167\u7db2\u5009\u5eab\u3002\u9ed8\u8a8d\u93e1\u50cf\u5730\u5740\u70babanzaicloud/eventrouter:v0.1.0\uff1b ClusterOutput \uff1a\u5b9a\u7fa9\u65e5\u8a8c\u767c\u9001\u5230\u54ea\uff0c\u9019\u88e1\u914d\u7f6e\u7684\u662f ElasticSearch\uff0c\u6839\u64da\u5be6\u969b\u60c5\u6cc1\uff0c\u4fee\u6539 ElasticSearch \u7684\u5730\u5740\uff0clogstash_prefix \u5b9a\u7fa9\u7684\u662f\u5c0d\u61c9\u7684 ElasticSearch \u5167\u7684 index \u540d\u7a31\uff0c\u5efa\u8b70\u6839\u64da\u5c0d\u61c9\u96c6\u7fa4\u540d\u7a31\u914d\u7f6e\uff1b labels \uff1a\u95dc\u806f\u7684\u662f rancher-event-tailer \u9019\u500b statefulset \u7684 label\u3002 \u7bc0\u9ede Kernel \u65e5\u8a8c\u6536\u96c6 \u00b6 \u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion: logging-extensions.banzaicloud.io/v1alpha1 kind: HostTailer metadata: name: rancher-host-file-tailer namespace: cattle-logging-system spec: fileTailers: - name: system-messages path: /var/log/messages buffer_max_size: 64k disabled: false skip_long_lines: \"true\" containerOverrides: image: www.wanshaoyuan.com/rancher/mirrored-fluent-fluent-bit:1.8.15 workloadOverrides: tolerations: - effect: NoSchedule key: cattle.io/os operator: Equal value: linux - operator: Exists apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterOutput metadata: name: host-files-clusteroutput namespace: cattle-logging-system spec: elasticsearch: buffer: timekey: 1m timekey_wait: 30s timekey_use_utc: true reconnect_on_error: true reload_on_failure: true reload_connections: false host: 172.16.1.166 port: 9200 scheme: http logstash_format: true logstash_prefix: cluster_os_logs apiVersion: logging.banzaicloud.io/v1beta1 kind: Flow metadata: name: rancher-host-files-flow namespace: cattle-logging-system spec: filters: - tag_normaliser: {} - record_modifier: records: - host: ${record.dig('kubernetes', 'host')} whitelist_keys: host,message globalOutputRefs: - host-files-clusteroutput match: - select: labels: app.kubernetes.io/instance: rancher-host-file-tailer-host-tailer \u7d50\u679c\u6aa2\u67e5 \u00b6 \u5728 ElasticSearch \u4e2d\u6aa2\u67e5\u662f\u5426\u5275\u5efa\u51fa\u5c0d\u61c9\u7684 index\uff0c\u4e26\u4e14\u6aa2\u67e5\u5168\u90e8 index\uff1a curl http://172.16.1.166:9200/_cat/indices yellow open k8s-components-2022.06.02 hg9OQTQEQsKLNwn3Kf_jdA 1 1 85231 0 32 .4mb 32 .4mb yellow open cluster_os_logs-2022.06.02 zARda8N1R9OpZRX-cZIS1g 1 1 3666 0 738 .9kb 738 .9kb yellow open k8s-application-2022.06.02 x0XxNvmmQQurdWDn4IL2gA 1 1 433 0 232 .5kb 232 .5kb yellow open cluster1-auditlog-tailer-2022.06.02 qrAzHadxTeWQXF-E8B1VEQ 1 1 1686458 0 761 .2mb 761 .2mb yellow open cluster1-runtimelog-tailer-2022.06.02 0DQp0at8TzOGSt911wnocw 1 1 1545 0 469 .2kb 469 .2kb yellow open kubernetes-event-tailer-2022.06.02 L80_wp6iRQy2d0DGmiSxhA 1 1 1169 0 1 .1mb 1 .1mb \u5728 kibana \u4e2d\u67e5\u770b index \u4e2d\u65e5\u8a8c\u4fe1\u606f\uff1a \u7e3d\u7d50 \u00b6 \u76f8\u6bd4\u65bc Rancher 2.6 \u4e4b\u524d\u7684\u7248\u672c\uff0c Logging-operator \u7684\u5f15\u5165\u5927\u5927\u589e\u5f37\u4e86\u9748\u6d3b\u6027\u548c\u529f\u80fd\u6027\uff0c\u53ef\u4ee5\u975e\u5e38\u9748\u6d3b\u5730\u914d\u7f6e\u5404\u985e\u53c3\u6578\u548c\u60f3\u6536\u96c6\u7684\u65e5\u8a8c\u4fe1\u606f\uff1b\u4f46\u8207\u4e4b\u5c0d\u61c9\u7684\u662f\uff0c\u4f7f\u7528\u9580\u6abb\u6bd4 2.6 \u4e4b\u524d\u7248\u672c\u7684\u6709\u6240\u63d0\u9ad8\u3002\u5e0c\u671b\u672c\u7bc7\u6587\u7ae0\u53ef\u4ee5\u5e6b\u52a9\u4f60\u52a0\u6df1\u5c0d Rancher Logging \u7684\u7406\u89e3\u3002","title":"Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580(2)"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#rancher-26-logging-2","text":"\u539f\u6587: https://itcn.blog/p/22491197293.html","title":"Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580\uff082\uff09"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#_1","text":"\u672c\u7bc7\u70ba Rancher 2.6 \u5168\u65b0 Logging \u5feb\u901f\u5165\u9580 \u7684\u5f8c\u7e8c\uff0c\u70ba\u5be6\u969b\u751f\u7522\u914d\u7f6e\u4f7f\u7528\u624b\u518a\u3002\u4e3b\u8981\u4ecb\u7d39\u4ee5\u4e0b\u65e5\u8a8c\u6536\u96c6\u914d\u7f6e\u529f\u80fd\uff1a \u5be9\u8a08\u65e5\u8a8c\u6536\u96c6 Kubernetes \u7d44\u4ef6\u65e5\u8a8c\u6536\u96c6 \u904b\u884c\u5728 Kubernetes \u4e0a\u7684\u5bb9\u5668\u61c9\u7528\u65e5\u8a8c\u6536\u96c6 Runtime \u65e5\u8a8c\u6536\u96c6 Kubernetes \u4e8b\u4ef6\u6536\u96c6\u548c\u7bc0\u9ede \u7bc0\u9ede Kernel \u65e5\u8a8c\u6536\u96c6 Rancher 2.6 \u65e5\u8a8c\u63a1\u7528\u4e86 logging-operator \u65b9\u5f0f\u9032\u884c\u65e5\u8a8c\u7ba1\u7406\uff0c\u5c0d\u61c9\u6982\u5ff5\u5982\u4e0b: logging \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u65e5\u8a8c\u63a1\u96c6\u7aef (FleuntBit) \u548c\u50b3\u8f38\u7aef (Fleuntd) \u670d\u52d9\u7684\u57fa\u790e\u914d\u7f6e\uff0c\u5728 SUSE Rancher 2.6 \u7248\u672c\u4e2d\uff0c\u5df2\u7d93\u7531 Rancher \u81ea\u52d5\u5316\u90e8\u7f72\u5b8c\u6210\uff1b flow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; clusterflow \uff1a\u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247; output \uff1a\u7528\u65bc\u5b9a\u7fa9 namespace (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u7684\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u53ea\u80fd\u88ab\u540c\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\uff1b clusteroutput \uff1a\u7528\u65bc\u5b9a\u7fa9\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u8f38\u51fa\u548c\u53c3\u6578\uff0c\u5b83\u80fd\u628a\u88ab\u5176\u4ed6\u547d\u540d\u7a7a\u9593\u5167\u7684 flow \u95dc\u806f\u3002","title":"\u6982\u8ff0"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#logging","text":"","title":"Logging \u914d\u7f6e\u4f7f\u7528"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#elasticsearch-kibana","text":"\u70ba\u4e86\u66f4\u597d\u5730\u6f14\u793a\u6548\u679c\uff0c\u9019\u88e1\u90e8\u7f72\u81e8\u6642\u7684 ElasticSearch \u548c kibana \u4f5c\u70ba\u6f14\u793a\u74b0\u5883\uff1a docker run -d --name elasticsearch -p 9200 :9200 -p 9300 :9300 -e \"discovery.type=single-node\" elasticsearch:7.5.2 docker run --name kibana -e ELASTICSEARCH_HOSTS = http://172.16.1.232:9200 -p 5601 :5601 -d kibana:7.5.2 Info \u6ce8\uff1a\u5c07 ELASTICSEARCH_HOSTS \u5730\u5740\u4fee\u6539\u70ba\u5be6\u969b ElasticSearch \u7684\u5730\u5740\u3002 \u90e8\u7f72\u5b8c\u5f8c\u53ef\u901a\u904e http://ip:9200 \u8a2a\u554f ElasticSearch\uff0c\u901a\u904e http://ip:5601 \u8a2a\u554f Kibana\u3002","title":"ElasticSearch \u548c kibana \u90e8\u7f72"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#rancher-logging","text":"\u5207\u63db\u5230\u5c0d\u61c9\u96c6\u7fa4\uff0c\u9078\u64c7 cluster-Tools \u2014\u2014> Logging\uff0c\u4e26\u52fe\u9078\u81ea\u5b9a\u7fa9 Helm \u9078\u9805\uff1a systemd Log Path \u5b58\u5132\u7684\u662f\u7cfb\u7d71\u65e5\u8a8c\uff0c\u56e0\u70ba k3s \u548c RKE2 \u767c\u884c\u7248\u65e5\u8a8c\u90fd\u5b58\u5132\u5728\u6b64\u3002\u56e0\u6b64\u70ba\u4e86\u6536\u96c6\u6b64\u65e5\u8a8c\uff0c\u9700\u8981\u9032\u884c\u914d\u7f6e\u6b64\u9078\u9805\u3002 \u8981\u78ba\u5b9a\u76ee\u9304\u4f4d\u7f6e\uff0c\u53ef\u5728\u5176\u4e2d\u4e00\u500b\u7bc0\u9ede\u4e0a\u904b\u884c\uff1a cat /etc/systemd/journald.conf | grep -E ^ \\# ?Storage | cut -d \"=\" -f2 \u5982\u679c\u8fd4\u56de persistent \uff0c\u5247\u61c9\u70ba: systemdLogPath/var/log/journal \u5982\u679c\u8fd4\u56de volatile \uff0c\u5247\u61c9\u70ba\uff1a systemdLogPath/run/log/journal \u5982\u679c\u8fd4\u56de auto \uff0c\u8acb\u6aa2\u67e5\u662f\u5426\u5b58\u5728 /var/log/journal \u5982\u679c\u5b58\u5728 /var/log/journal \uff0c\u5247\u4f7f\u7528 /var/log/journal \u5982\u679c\u4e0d\u5b58\u5728 /var/log/journal \uff0c\u5247\u4f7f\u7528 /run/log/journal SUSE15 \u9ed8\u8a8d\u70ba /run/log/journal \u90e8\u7f72\u524d\u52fe\u9078\u7de8\u8f2f yaml\uff0c\u9032\u884c\u4ee5\u4e0b\u53c3\u6578\u4fee\u6539\uff1a \u4fee\u6539 loggint-Operator \u7684\u9ed8\u8a8d\u914d\u7f6e\uff0c\u5982 fluentd \u548c fluentbit \u9ed8\u8a8d\u8cc7\u6e90\u9650\u5236\u548c\u5bb9\u5fcd\u898f\u5247\uff0c\u5c07 fluentbit \u90e8\u7f72\u5230 Controller \u7bc0\u9ede\u7528\u65bc\u7cfb\u7d71\u65e5\u8a8c\u6536\u96c6\u3002 bufferStorageVolume \u70ba fluentd \u6536\u96c6 fluentbit \u7684 log buffer \u76ee\u9304\uff0c\u6709\u5206\u4f48\u5f0f\u6587\u4ef6\u7cfb\u7d71\u5b58\u5132\uff0c\u5efa\u8b70\u5b58\u5132\u5230\u5206\u4f48\u5f0f\u6587\u4ef6\u7cfb\u7d71\u4e2d\uff0c\u4fee\u6539 storageClassName \u70ba\u5be6\u969b\u5206\u4f48\u5f0f\u5b58\u5132\u7684 stroageclass \u540d\u5b57\u3002\u5982\u679c\u6c92\u6709\u5c0d\u61c9\u5b58\u5132\uff0c\u53ef\u4ee5\u4fee\u6539\u70babufferStorageVolume: {}\u3002 \u66ff\u63db\u4ee5\u4e0b\u5167\u5bb9\uff1a fluentbit : filterKubernetes : Merge_Log : '' Merge_Log_Key : '' Merge_Log_Trim : '' Merge_Parser : '' inputTail : Buffer_Chunk_Size : '' Buffer_Max_Size : '' Mem_Buf_Limit : '' Multiline_Flush : '' Skip_Long_Lines : '' resources : limits : cpu : 500mp where you can insert the devi fluentd : bufferStorageVolume : pvc : spec : accessModes : - ReadWriteOnce resources : requests : storage : 40Gi storageClassName : fast volumeMode : Filesystem livenessProbe : initialDelaySeconds : 30 periodSeconds : 15 tcpSocket : port : 24240 nodeSelector : {} resources : limits : cpu : '2' memory : 4096M requests : cpu : 500m memory : 100M tolerations : {} replicas : 3 fullnameOverride : '' Warning \u4e0a\u8ff0\u7684\u8a2d\u5b9a\u5fc5\u9700\u6839\u64da\u500b\u81ea\u3000K8S\u3000\u96c6\u7fa4\u7684\u5143\u4ef6\u8207\u914d\u7f6e\u4f86\u9032\u884c\u76f8\u5c0d\u7684\u4fee\u6539\u3002 \u57f7\u884c\u4ee5\u4e0b\u547d\u4ee4\u6aa2\u67e5\u90e8\u7f72\u662f\u5426\u6210\u529f\uff1a kubectl get pod -n cattle-logging-system NAME READY STATUS RESTARTS AGE rancher-logging-96b68cc4b-vqxnd 1 /1 Running 0 9m54s rancher-logging-fluentbit-cntgb 1 /1 Running 0 69s rancher-logging-fluentbit-hwmdx 1 /1 Running 0 71s rancher-logging-fluentbit-nw7rw 1 /1 Running 0 71s rancher-logging-fluentd-0 2 /2 Running 0 9m34s rancher-logging-fluentd-1 2 /2 Running 0 9m34s rancher-logging-fluentd-2 2 /2 Running 0 9m34s rancher-logging-fluentd-configcheck-ac2d4553 0 /1 Completed 0 9m48s","title":"\u542f\u7528 Rancher Logging"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#_2","text":"\u8981\u5728\u96c6\u7fa4\u6240\u6709 Controller \u7bc0\u9ede\u4e0a\u5275\u5efa\u5be9\u8a08\u65e5\u8a8c\u7b56\u7565\uff0c\u9700\u8981\u5728\u4e3b\u6a5f\u5275\u5efa\u5be9\u8a08\u65e5\u8a8c\u7b56\u7565\u6587\u4ef6 /etc/kubernetes/audit-policy.yaml \uff0c\u5167\u5bb9\u5982\u4e0b\uff1a apiVersion : audit.k8s.io/v1 kind : Policy omitStages : - \"RequestReceived\" rules : - level : Metadata \u6dfb\u52a0\u96c6\u7fa4\u53c3\u6578\uff0c\u5f9e Cluster-Manager \u9078\u64c7\u5c0d\u61c9\u7684\u96c6\u7fa4 \u2014> edit Config \uff0c\u7d66 Api-server \u6dfb\u52a0\u4ee5\u4e0b\u53c3\u6578\uff1a kube-apiserver-arg : - audit-log-maxsize=100 - audit-log-maxage=60 - audit-log-maxbackup=10 - audit-policy-file=/etc/kubernetes/audit-policy.yaml \u53c3\u6578\u89e3\u91cb\uff1a maxsize \uff1a\u8868\u793a\u65e5\u8a8c\u91cf\u591a\u5927\u6642\u9032\u884c\u4e00\u6b21\u8f2a\u8f49 maxage \uff1a\u8868\u793a\u4fdd\u7559\u5be9\u8a08\u65e5\u8a8c\u591a\u5c11\u5929 maxbackup \uff1a\u8868\u793a\u4fdd\u7559\u5be9\u8a08\u65e5\u8a8c\u6587\u4ef6\u591a\u5c11\u4efd policy-file \uff1a\u5b9a\u7fa9\u5be9\u8a08\u65e5\u8a8c\u4fdd\u5b58\u7b56\u7565 \u6dfb\u52a0 apiserver \u76ee\u9304\u6620\u5c04\u53c3\u6578\uff1a kube-apiserver-extra-mount : - /etc/kubernetes:/etc/kubernetes \u56e0\u70ba api-server \u662f pod \u65b9\u5f0f\u555f\u52d5\uff0c\u70ba\u4e86\u80fd\u52a0\u8f09 auditlog-policy\uff0c\u9700\u8981\u5c07\u6b64\u76ee\u9304\u6620\u5c04\u5230 api-server pod \u4e2d\u3002 \u5b8c\u6210\u5f8c\uff0c\u96c6\u7fa4\u6703\u9032\u5165\u81ea\u52d5\u5347\u7d1a\u6a21\u5f0f\u3002\u7b49\u5f85\u5347\u7d1a\u5b8c\u6210\uff0c\u96c6\u7fa4\u5be9\u8a08\u65e5\u8a8c\u5c07\u5b58\u5132\u5728 /var/lib/rancher/rke2/server/logs/audit.log \u6587\u4ef6\u548c\u76ee\u9304\u3002","title":"\u96c6\u7fa4\u5be9\u8a08\u65e5\u8a8c\u958b\u555f\u548c\u63a1\u96c6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#kubernetes","text":"RKE2 Kubernetes \u7d44\u4ef6\u65e5\u8a8c\u90fd\u96c6\u4e2d\u5728\u4ee5\u4e0b namespace \u4e2d\uff0c\u5728\u555f\u52d5 logging \u6642\uff0c\u914d\u7f6e\u65e5\u8a8c\u76ee\u9304\u6703\u81ea\u52d5\u90e8\u7f72\u63a1\u96c6\u5668\u9032\u884c\u63a1\u96c6\uff1a \u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : test-output namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true host : 172.16.1.166 port : 9200 scheme : http reconnect_on_error : true reload_on_failure : true reload_connections : false logstash_format : true logstash_prefix : k8s-components --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : test namespace : cattle-logging-system spec : globalOutputRefs : - test-output match : - select : namespaces : - cattle-monitoring-system - cattle-system - kube-system ClusterOutput \u5b9a\u7fa9\u65e5\u8a8c\u767c\u9001\u5230\u54ea\uff0c\u9019\u88e1\u914d\u7f6e\u7684\u662f ElasticSearch\uff0c\u6839\u64da\u5be6\u969b\u60c5\u6cc1\uff0c\u4fee\u6539 ElasticSearch \u7684\u5730\u5740\uff1b Logstash_prefix \u5b9a\u7fa9\u7684\u662f\u5c0d\u61c9\u7684 ElasticSearch \u5167\u7684 index \u540d\u7a31\u3002\u5efa\u8b70\u6839\u64da\u5c0d\u61c9\u96c6\u7fa4\u540d\u7a31\u914d\u7f6e\uff1b Logstash_prefix \u5b9a\u7fa9\u767c\u9001\u5230 ES \u5f8c\u5c0d\u61c9\u7684 Index \u540d\u7a31\uff1b Logstash_format \u8868\u793a\u958b\u555f Index \u6309\u5929\u81ea\u52d5\u5275\u5efa\u8f2a\u8f49\uff1b ClusterFlow \u7528\u65bc\u5b9a\u7fa9\u4e00\u500b\u96c6\u7fa4\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\uff0c\u5728\u9019\u88e1 labels \u8207\u5c0d\u61c9\u7684\u63a1\u96c6 pod \u7684 label \u76f8\u95dc\u9023\uff0c\u9019\u88e1\u555f\u52d5 Hosttailer \u5f8c\u6703\u81ea\u52d5\u555f\u52d5\u6536\u96c6 pod \u548c\u96c6\u7fa4\u5c64\u7d1a\u6536\u96c6\u95dc\u806f\uff1b GlobalOutputRefs \u5b9a\u7fa9\u7684\u70ba\u4e0a\u9762\u914d\u7f6e\u7684 ClusterOutput \u7684\u540d\u7a31\uff0c\u8868\u793a\u8f38\u51fa\u5230\u4ec0\u9ebc\u5730\u65b9\u3002","title":"Kubernetes \u7d44\u4ef6\u65e5\u8a8c\u6536\u96c6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#kubernetes-application","text":"\u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : k8s-application-output namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true host : 172.16.1.166 port : 9200 scheme : http reconnect_on_error : true reload_on_failure : true reload_connections : false logstash_format : true logstash_prefix : k8s-application --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterFlow metadata : name : test namespace : cattle-logging-system spec : globalOutputRefs : - k8s-application-output match : - exclude : namespaces : - cattle-monitoring-system - cattle-system - cattle-logging-system - kube-system - cattle-fleet-system - select : {} \u901a\u904e exclude \u5c07\u7cfb\u7d71\u7d44\u4ef6\u547d\u540d\u7a7a\u9593\u6392\u9664\u5728\u5916\uff0c\u63a1\u96c6\u7684\u4fbf\u662f\u5168\u90e8\u61c9\u7528\u7684\u6a19\u6e96\u8f38\u51fa\u65e5\u8a8c\u3002","title":"Kubernetes Application \u65e5\u8a8c\u63a1\u96c6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#runtime","text":"\u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : HostTailer metadata : name : runtimelog-hosttailer namespace : cattle-logging-system spec : fileTailers : - name : runtime-tail path : /var/lib/rancher/rke2/agent/containerd/containerd.log buffer_max_size : 64k #\u6b64\u503c\u4e00\u5b9a\u8981\u4fee\u6539\uff0c\u4e0d\u7136\u542f\u52a8\u4e0d\u6210\u529f disabled : false skip_long_lines : \"true\" containerOverrides : image : www.wanshaoyuan.com/rancher/mirrored-fluent-fluent-bit:1.8.15 workloadOverrides : tolerations : - effect : NoSchedule key : cattle.io/os operator : Equal value : linux - operator : Exists --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : runtimelog-tailer-clusteroutput namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true reconnect_on_error : true reload_on_failure : true reload_connections : false host : 172.16.1.166 port : 9200 scheme : http logstash_format : true logstash_prefix : cluster1-runtimelog-tailer --- apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : runtimetailer-flow namespace : cattle-logging-system spec : filters : - tag_normaliser : {} - parser : parse : type : none match : - select : labels : app.kubernetes.io/instance : runtimelog-hosttailer-host-tailer globalOutputRefs : - runtimelog-tailer-clusteroutput","title":"Runtime \u65e5\u5fd7\u91c7\u96c6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#_3","text":"\u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : HostTailer metadata : name : auditlog-hosttailer namespace : cattle-logging-system spec : fileTailers : - name : audit-tail path : /var/lib/rancher/rke2/server/logs/audit.log buffer_max_size : 64k #\u6b64\u503c\u4e00\u5b9a\u8981\u4fee\u6539\uff0c\u4e0d\u7136\u542f\u52a8\u4e0d\u6210\u529f disabled : false skip_long_lines : \"true\" containerOverrides : image : www.wanshaoyuan.com/rancher/mirrored-fluent-fluent-bit:1.8.15 workloadOverrides : tolerations : - effect : NoSchedule key : cattle.io/os operator : Equal value : linux - operator : Exists --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : auditlog-tailer-clusteroutput namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true reconnect_on_error : true reload_on_failure : true reload_connections : false host : 172.16.1.166 port : 9200 scheme : http logstash_format : true logstash_prefix : cluster1-auditlog-tailer --- apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : hosttailer-flow namespace : cattle-logging-system spec : filters : - tag_normaliser : {} - parser : parse : type : json match : - select : labels : app.kubernetes.io/instance : auditlog-hosttailer-host-tailer globalOutputRefs : - auditlog-tailer-clusteroutput containerOverrides \u5b9a\u7fa9\u7684\u662f\u96e2\u7dda\u90e8\u7f72\u7684\u93e1\u50cf\uff0c\u9ed8\u8a8d\u93e1\u50cf\u5730\u5740\u70ba fluent/fluent-bit:1.8.15; HostTailer \u5b9a\u7fa9\u63a1\u96c6\u7684\u6587\u4ef6\uff0c\u4e26\u81ea\u52d5\u90e8\u7f72 fluent-bit \u9032\u884c\u639b\u8f09\u6620\u5c04; ClusterOutput \u5b9a\u7fa9\u65e5\u8a8c\u767c\u9001\u5230\u54ea\uff0c\u9019\u88e1\u914d\u7f6e\u7684\u662f ElasticSearch\uff0c\u6839\u64da\u5be6\u969b\u60c5\u6cc1\uff0c\u4fee\u6539 ElasticSearch \u7684\u5730\u5740\uff0clogstash_prefix \u5b9a\u7fa9\u7684\u662f\u5c0d\u61c9\u7684 ElasticSearch \u5167\u7684 index \u540d\u7a31\u3002\u5efa\u8b70\u6839\u64da\u5c0d\u61c9\u96c6\u7fa4\u540d\u7a31\u914d\u7f6e; Flow \u7528\u65bc\u5b9a\u7fa9\u4e00\u500b namespaces (\u547d\u540d\u7a7a\u9593)\u7d1a\u5225\u7684\u65e5\u8a8c\u904e\u6ffe\u3001\u89e3\u6790\u548c\u8def\u7531\u7b49\u898f\u5247\uff0c\u5728\u9019\u88e1 labels \u8207\u5c0d\u61c9\u7684\u63a1\u96c6 pod \u7684 label \u76f8\u95dc\u9023\uff0c\u9019\u88e1\u555f\u52d5 hosttailer \u5f8c\u6703\u81ea\u52d5\u555f\u52d5\u6536\u96c6 pod\uff0c\u5b83\u7684 label \u70baapp.kubernetes.io/instance: auditlog-hosttailer-host-tailer; globalOutputRefs \u5b9a\u7fa9\u7684\u70ba\u4e0a\u9762\u914d\u7f6e\u7684 ClusterOutput \u7684\u540d\u7a31\uff0c\u8868\u793a\u8f38\u51fa\u5230\u4ec0\u9ebc\u5730\u65b9\u3002","title":"\u914d\u7f6e\u5be9\u8a08\u65e5\u8a8c\u63a1\u96c6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#event","text":"\u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion : logging-extensions.banzaicloud.io/v1alpha1 kind : EventTailer metadata : name : rancher spec : controlNamespace : cattle-logging-system containerOverrides : image : www.wanshaoyuan.com/rancher/eventrouter:v0.1.0 --- apiVersion : logging.banzaicloud.io/v1beta1 kind : ClusterOutput metadata : name : event-tailer-clusteroutput namespace : cattle-logging-system spec : elasticsearch : buffer : timekey : 1m timekey_wait : 30s timekey_use_utc : true reconnect_on_error : true reload_on_failure : true reload_connections : false host : 172.16.1.166 port : 9200 scheme : http logstash_format : true logstash_prefix : kubernetes-event-tailer --- apiVersion : logging.banzaicloud.io/v1beta1 kind : Flow metadata : name : rancher-event-tailer-flow namespace : cattle-logging-system spec : filters : - tag_normaliser : {} - parser : parse : type : json globalOutputRefs : - event-tailer-clusteroutput match : - select : labels : app.kubernetes.io/name : event-tailer EventTailer \uff1a\u8a2d\u7f6e Event \u6536\u96c6\uff0c\u6703\u555f\u52d5\u4e00\u500b rancher-event-tailer statefulset\uff0c\u5167\u7db2\u90e8\u7f72\u9700\u8981\u4fee\u6539\u93e1\u50cf\u5730\u5740\u70ba\u5167\u7db2\u5009\u5eab\u3002\u9ed8\u8a8d\u93e1\u50cf\u5730\u5740\u70babanzaicloud/eventrouter:v0.1.0\uff1b ClusterOutput \uff1a\u5b9a\u7fa9\u65e5\u8a8c\u767c\u9001\u5230\u54ea\uff0c\u9019\u88e1\u914d\u7f6e\u7684\u662f ElasticSearch\uff0c\u6839\u64da\u5be6\u969b\u60c5\u6cc1\uff0c\u4fee\u6539 ElasticSearch \u7684\u5730\u5740\uff0clogstash_prefix \u5b9a\u7fa9\u7684\u662f\u5c0d\u61c9\u7684 ElasticSearch \u5167\u7684 index \u540d\u7a31\uff0c\u5efa\u8b70\u6839\u64da\u5c0d\u61c9\u96c6\u7fa4\u540d\u7a31\u914d\u7f6e\uff1b labels \uff1a\u95dc\u806f\u7684\u662f rancher-event-tailer \u9019\u500b statefulset \u7684 label\u3002","title":"Event \u6536\u96c6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#kernel","text":"\u61c9\u7528\u4ee5\u4e0b Yaml \u5230\u96c6\u7fa4\u4e2d\uff1a apiVersion: logging-extensions.banzaicloud.io/v1alpha1 kind: HostTailer metadata: name: rancher-host-file-tailer namespace: cattle-logging-system spec: fileTailers: - name: system-messages path: /var/log/messages buffer_max_size: 64k disabled: false skip_long_lines: \"true\" containerOverrides: image: www.wanshaoyuan.com/rancher/mirrored-fluent-fluent-bit:1.8.15 workloadOverrides: tolerations: - effect: NoSchedule key: cattle.io/os operator: Equal value: linux - operator: Exists apiVersion: logging.banzaicloud.io/v1beta1 kind: ClusterOutput metadata: name: host-files-clusteroutput namespace: cattle-logging-system spec: elasticsearch: buffer: timekey: 1m timekey_wait: 30s timekey_use_utc: true reconnect_on_error: true reload_on_failure: true reload_connections: false host: 172.16.1.166 port: 9200 scheme: http logstash_format: true logstash_prefix: cluster_os_logs apiVersion: logging.banzaicloud.io/v1beta1 kind: Flow metadata: name: rancher-host-files-flow namespace: cattle-logging-system spec: filters: - tag_normaliser: {} - record_modifier: records: - host: ${record.dig('kubernetes', 'host')} whitelist_keys: host,message globalOutputRefs: - host-files-clusteroutput match: - select: labels: app.kubernetes.io/instance: rancher-host-file-tailer-host-tailer","title":"\u7bc0\u9ede Kernel \u65e5\u8a8c\u6536\u96c6"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#_4","text":"\u5728 ElasticSearch \u4e2d\u6aa2\u67e5\u662f\u5426\u5275\u5efa\u51fa\u5c0d\u61c9\u7684 index\uff0c\u4e26\u4e14\u6aa2\u67e5\u5168\u90e8 index\uff1a curl http://172.16.1.166:9200/_cat/indices yellow open k8s-components-2022.06.02 hg9OQTQEQsKLNwn3Kf_jdA 1 1 85231 0 32 .4mb 32 .4mb yellow open cluster_os_logs-2022.06.02 zARda8N1R9OpZRX-cZIS1g 1 1 3666 0 738 .9kb 738 .9kb yellow open k8s-application-2022.06.02 x0XxNvmmQQurdWDn4IL2gA 1 1 433 0 232 .5kb 232 .5kb yellow open cluster1-auditlog-tailer-2022.06.02 qrAzHadxTeWQXF-E8B1VEQ 1 1 1686458 0 761 .2mb 761 .2mb yellow open cluster1-runtimelog-tailer-2022.06.02 0DQp0at8TzOGSt911wnocw 1 1 1545 0 469 .2kb 469 .2kb yellow open kubernetes-event-tailer-2022.06.02 L80_wp6iRQy2d0DGmiSxhA 1 1 1169 0 1 .1mb 1 .1mb \u5728 kibana \u4e2d\u67e5\u770b index \u4e2d\u65e5\u8a8c\u4fe1\u606f\uff1a","title":"\u7d50\u679c\u6aa2\u67e5"},{"location":"kubernetes/observability/logging/operator/rancher-logging-quickstart-02/#_5","text":"\u76f8\u6bd4\u65bc Rancher 2.6 \u4e4b\u524d\u7684\u7248\u672c\uff0c Logging-operator \u7684\u5f15\u5165\u5927\u5927\u589e\u5f37\u4e86\u9748\u6d3b\u6027\u548c\u529f\u80fd\u6027\uff0c\u53ef\u4ee5\u975e\u5e38\u9748\u6d3b\u5730\u914d\u7f6e\u5404\u985e\u53c3\u6578\u548c\u60f3\u6536\u96c6\u7684\u65e5\u8a8c\u4fe1\u606f\uff1b\u4f46\u8207\u4e4b\u5c0d\u61c9\u7684\u662f\uff0c\u4f7f\u7528\u9580\u6abb\u6bd4 2.6 \u4e4b\u524d\u7248\u672c\u7684\u6709\u6240\u63d0\u9ad8\u3002\u5e0c\u671b\u672c\u7bc7\u6587\u7ae0\u53ef\u4ee5\u5e6b\u52a9\u4f60\u52a0\u6df1\u5c0d Rancher Logging \u7684\u7406\u89e3\u3002","title":"\u7e3d\u7d50"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/prometheus-install/","text":"\u5b89\u88dd Prometheus \u00b6 \u76e3\u63a7\u7684\u89e3\u6c7a\u65b9\u6848\u6709\u5f88\u591a\u7a2e\uff0c\u6211\u9019\u88e1\u9078\u64c7\u7684\u662f Prometheus\u3002\u5be6\u969b\u4e0a\u53ea\u6709 Prometheus \u9084\u4e0d\u5920\uff0c\u771f\u6b63\u5176\u5be6\u6703\u5b89\u88dd\u4ee5\u4e0b\u9805\u76ee\uff1a Grafana - \u8996\u89ba\u5316\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u5716\u5f62\u986f\u793a\u76e3\u63a7\u7684\u8cc7\u6599\u3002\uff08\u5176\u5be6\u9084\u53ef\u4ee5\u505a distribute tracing, log \u67e5\u8a62\uff09 Prometheus\u3002 Prometheus Operator - \u63d0\u4f9b Kubernetes CRD\uff0c\u8b93\u6211\u5011\u900f\u904e CRD \u8a2d\u5b9a Prometheus \u7684\u8a2d\u5b9a\u3002 Prometheus Node Exporter - \u8490\u96c6 Kubernetes Worker Node \u7684\u8cc7\u8a0a\uff08Linux \u63d0\u4f9b\u7684\u8cc7\u8a0a\uff09\u3002 kube-state-metrics - \u8490\u96c6 Kubernetes \u7684\u8cc7\u8a0a\uff08Kubernetes API Server \u63d0\u4f9b\u7684\u8cc7\u8a0a\uff09\u3002 Prometheus Adapter for Kubernetes Metrics APIs. \u4ee5\u4e0a\u9019\u4e9b\u5b89\u88dd\u9805\u76ee\u90fd\u53ef\u4ee5\u7528 kube-prometheus-stack \u9019\u500b\u5c08\u6848\u63d0\u4f9b\u7684 helm chart \u5b89\u88dd\u3002 Info \u8a3b - kube-prometheus \u5c08\u6848\u5176\u5be6\u50c5\u63d0\u4f9b YAML \u7684\u65b9\u5f0f\u5b89\u88dd\u3002\u800c kube-prometheus-stack \u5c08\u6848\u5c07 kube-prometheus \u5305\u88dd\u6210 helm chart\u3002 \u5b89\u88dd kube-prometheus-stack \u00b6 \u7528 helm \u5b89\u88dd\uff1a $ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts $ helm repo update $ helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack -n monitoring --create-namespace \u53c3\u8003: https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack \u6aa2\u8996 Web UI \u00b6 \u7576\u5b89\u88dd\u5b8c\u7562\u5f8c\uff0c\u6709 3 \u500b Web UI \u53ef\u4ee5\u4f7f\u7528\uff0c\u53c3\u8003\u5982\u4e0b\uff1a Prometheus-UI kubectl port-forward service/prometheus-kube-prometheus-prometheus 9090 Alert Manager UI kubectl port-forward svc/prometheus-kube-prometheus-alertmanager 9093 Grafana kubectl port-forward deployment/prometheus-grafana 3000 Grafana \u9810\u8a2d\u7684\u5e33\u865f\u3001\u5bc6\u78bc\u5982\u4e0b\uff1a user: admin pwd: prom-operator PodMonitor, ServiceMonitor \u00b6 \u5b89\u88dd helm chart \u7684\u6642\u5019\uff0c\u6211\u8a8d\u70ba\u5efa\u8b70\u5c07\u4ee5\u4e0b\u503c\u8a2d\u5b9a\u70ba false\uff0c\u8b93 Prometheus \u6293\u53d6\u5168\u90e8\u7684 PodMonitor, ServiceMonitor\uff0c\u4e0d\u900f\u904e label \u7be9\u9078\uff08\u907f\u514d\u5b78\u7fd2\u7684\u6642\u5019\u6703\u767c\u751f PodMonitor, ServiceMonitor \u627e\u4e0d\u5230\u7684\u554f\u984c\uff09\uff1a prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues","title":"\u5b89\u88dd Prometheus"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/prometheus-install/#prometheus","text":"\u76e3\u63a7\u7684\u89e3\u6c7a\u65b9\u6848\u6709\u5f88\u591a\u7a2e\uff0c\u6211\u9019\u88e1\u9078\u64c7\u7684\u662f Prometheus\u3002\u5be6\u969b\u4e0a\u53ea\u6709 Prometheus \u9084\u4e0d\u5920\uff0c\u771f\u6b63\u5176\u5be6\u6703\u5b89\u88dd\u4ee5\u4e0b\u9805\u76ee\uff1a Grafana - \u8996\u89ba\u5316\u5de5\u5177\uff0c\u53ef\u4ee5\u7528\u5716\u5f62\u986f\u793a\u76e3\u63a7\u7684\u8cc7\u6599\u3002\uff08\u5176\u5be6\u9084\u53ef\u4ee5\u505a distribute tracing, log \u67e5\u8a62\uff09 Prometheus\u3002 Prometheus Operator - \u63d0\u4f9b Kubernetes CRD\uff0c\u8b93\u6211\u5011\u900f\u904e CRD \u8a2d\u5b9a Prometheus \u7684\u8a2d\u5b9a\u3002 Prometheus Node Exporter - \u8490\u96c6 Kubernetes Worker Node \u7684\u8cc7\u8a0a\uff08Linux \u63d0\u4f9b\u7684\u8cc7\u8a0a\uff09\u3002 kube-state-metrics - \u8490\u96c6 Kubernetes \u7684\u8cc7\u8a0a\uff08Kubernetes API Server \u63d0\u4f9b\u7684\u8cc7\u8a0a\uff09\u3002 Prometheus Adapter for Kubernetes Metrics APIs. \u4ee5\u4e0a\u9019\u4e9b\u5b89\u88dd\u9805\u76ee\u90fd\u53ef\u4ee5\u7528 kube-prometheus-stack \u9019\u500b\u5c08\u6848\u63d0\u4f9b\u7684 helm chart \u5b89\u88dd\u3002 Info \u8a3b - kube-prometheus \u5c08\u6848\u5176\u5be6\u50c5\u63d0\u4f9b YAML \u7684\u65b9\u5f0f\u5b89\u88dd\u3002\u800c kube-prometheus-stack \u5c08\u6848\u5c07 kube-prometheus \u5305\u88dd\u6210 helm chart\u3002","title":"\u5b89\u88dd Prometheus"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/prometheus-install/#kube-prometheus-stack","text":"\u7528 helm \u5b89\u88dd\uff1a $ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts $ helm repo update $ helm install kube-prometheus-stack prometheus-community/kube-prometheus-stack -n monitoring --create-namespace \u53c3\u8003: https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack","title":"\u5b89\u88dd kube-prometheus-stack"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/prometheus-install/#web-ui","text":"\u7576\u5b89\u88dd\u5b8c\u7562\u5f8c\uff0c\u6709 3 \u500b Web UI \u53ef\u4ee5\u4f7f\u7528\uff0c\u53c3\u8003\u5982\u4e0b\uff1a Prometheus-UI kubectl port-forward service/prometheus-kube-prometheus-prometheus 9090 Alert Manager UI kubectl port-forward svc/prometheus-kube-prometheus-alertmanager 9093 Grafana kubectl port-forward deployment/prometheus-grafana 3000 Grafana \u9810\u8a2d\u7684\u5e33\u865f\u3001\u5bc6\u78bc\u5982\u4e0b\uff1a user: admin pwd: prom-operator","title":"\u6aa2\u8996 Web UI"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/prometheus-install/#podmonitor-servicemonitor","text":"\u5b89\u88dd helm chart \u7684\u6642\u5019\uff0c\u6211\u8a8d\u70ba\u5efa\u8b70\u5c07\u4ee5\u4e0b\u503c\u8a2d\u5b9a\u70ba false\uff0c\u8b93 Prometheus \u6293\u53d6\u5168\u90e8\u7684 PodMonitor, ServiceMonitor\uff0c\u4e0d\u900f\u904e label \u7be9\u9078\uff08\u907f\u514d\u5b78\u7fd2\u7684\u6642\u5019\u6703\u767c\u751f PodMonitor, ServiceMonitor \u627e\u4e0d\u5230\u7684\u554f\u984c\uff09\uff1a prometheus.prometheusSpec.podMonitorSelectorNilUsesHelmValues prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues","title":"PodMonitor, ServiceMonitor"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/","text":"\u5982\u4f55\u5728 Kubernetes \u4e0a\u8a2d\u7f6e Prometheus\uff08Operator\uff09\u548c Grafana \u76e3\u63a7 \u00b6 \u539f\u6587: How To Setup Prometheus (Operator) and Grafana Monitoring On Kubernetes \u76e3\u63a7\u662f DevOps \u6700\u4f73\u5be6\u8e10\u7684\u95dc\u9375\u652f\u67f1\u3002\u9019\u63d0\u4f9b\u4e86\u6709\u95dc\u5e73\u53f0\u6027\u80fd\u548c\u5065\u5eb7\u72c0\u6cc1\u7684\u91cd\u8981\u4fe1\u606f\u3002\u5728 Kubernetes \u548c\u5fae\u670d\u52d9\u7b49\u5206\u4f48\u5f0f\u74b0\u5883\u4e2d\uff0c\u66f4\u662f\u5982\u6b64\u3002 Kubernetes \u7684\u4e00\u5927\u512a\u52e2\u662f\u80fd\u5920\u64f4\u5c55\u60a8\u7684\u670d\u52d9\u548c\u61c9\u7528\u7a0b\u5e8f\u3002\u7576\u60a8\u9054\u5230\u6578\u5343\u500b\u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u624b\u52d5\u76e3\u63a7\u5b83\u5011\u6216\u4f7f\u7528\u8173\u672c\u662f\u4e0d\u53ef\u884c\u7684\u3002\u60a8\u9084\u9700\u8981\u63a1\u7528\u53ef\u64f4\u5c55\u7684\u76e3\u63a7\u7cfb\u7d71\uff01\u9019\u5c31\u662f Prometheus \u548c Grafana \u51fa\u73fe\u7684\u5730\u65b9\u3002 Prometheus \u5c07\u6536\u96c6\u3001\u5b58\u5132\u4e26\u5141\u8a31\u60a8\u5229\u7528\u60a8\u7684\u5e73\u53f0\u6307\u6a19\u3002\u53e6\u4e00\u65b9\u9762\uff0cGrafana \u5c07\u6574\u5408 Prometheus \u4e26\u5141\u8a31\u60a8\u5275\u5efa\u6f02\u4eae\u7684\u5100\u8868\u677f\u548c\u5716\u8868\u3002 \u4eca\u5929\uff0c\u6211\u5011\u5c07\u8a0e\u8ad6 Prometheus \u662f\u4ec0\u9ebc\u4ee5\u53ca\u5728 Kubernetes \u4e0a\u90e8\u7f72\u5b83\u7684\u6700\u4f73\u65b9\u5f0f\uff1a\u4f7f\u7528 Prometheus Operator\u3002\u6211\u5011\u5c07\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 Prometheus \u548c Grafana \u8a2d\u7f6e\u76e3\u63a7\u5e73\u53f0\u3002 Prometheus \u00b6 Prometheus \u662f 2012 \u5e74\u5728 SoundCloud \u69cb\u5efa\u7684\u7528\u65bc\u4e8b\u4ef6\u76e3\u63a7\u548c\u8b66\u5831\u7684\u514d\u8cbb\u958b\u6e90\u61c9\u7528\u7a0b\u5e8f\u3002\u96a8\u5f8c\u8a31\u591a\u516c\u53f8\u548c\u7d44\u7e54\u63a1\u7528\u4e26\u8ca2\u737b\u4e86\u5b83\u3002 2016 \u5e74\uff0c\u96f2\u539f\u751f\u8a08\u7b97\u57fa\u91d1\u6703\uff08CNCF\uff09\u5728 Kubernetes \u4e4b\u5f8c\u5b75\u5316\u4e86 Prometheus \u9805\u76ee\u3002 \u6982\u5ff5 \u00b6 Prometheus \u88ab\u8a8d\u70ba\u662f Kubernetes \u7684\u9ed8\u8a8d\u76e3\u63a7\u89e3\u6c7a\u65b9\u6848\uff0c\u5176\u9748\u611f\u4f86\u81ea Google \u7684 Borgman\u3002\u5b83\u4f7f\u7528 HTTP \u62c9\u53d6\u8acb\u6c42\u5f9e\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u67b6\u69cb\u6536\u96c6\u6307\u6a19\u3002\u76ee\u6a19\u662f\u901a\u904e\u670d\u52d9\u767c\u73fe\u6216\u975c\u614b\u914d\u7f6e\u767c\u73fe\u7684\u3002\u901a\u904e\u4e2d\u9593\u7db2\u95dc\u4e5f\u652f\u6301\u63a8\u9001\u6642\u9593\u5e8f\u5217\u7684\u6307\u6a19\u6578\u64da\u3002 Prometheus \u7684\u6307\u6a19\u5177\u6709\u4ee5\u4e0b\u683c\u5f0f\uff1a <metric name>{<label name>=<label value>, ...} <reading_value> Prometheus \u5728\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab (TSDB) \u4e2d\u8a18\u9304\u5be6\u6642\u6307\u6a19\u2014\u2014\u9019\u5e36\u4f86\u4e86\u7dad\u5ea6\u6578\u64da\u6a21\u578b\u3001\u64cd\u4f5c\u7c21\u55ae\u6027\u548c\u53ef\u64f4\u5c55\u7684\u6578\u64da\u6536\u96c6\u3002\u5b83\u63d0\u4f9b\u4e86 PromQL\uff0c\u4e00\u7a2e\u9748\u6d3b\u7684\u67e5\u8a62\u8a9e\u8a00\u4f86\u5229\u7528\u9019\u7a2e\u7dad\u5ea6\u3002 \u67b6\u69cb\u5716\u986f\u793a Prometheus \u662f\u4e00\u500b\u591a\u7d44\u4ef6\u76e3\u63a7\u7cfb\u7d71\u3002\u4ee5\u4e0b\u90e8\u5206\u96c6\u6210\u5230 Prometheus \u90e8\u7f72\u4e2d\uff1a Prometheus server : \u6293\u53d6\u4e26\u5b58\u5132\u6642\u9593\u5e8f\u5217\u6578\u64da\u3002\u5b83\u9084\u63d0\u4f9b\u4e86\u4e00\u500b\u7528\u6236\u754c\u9762\u4f86\u67e5\u8a62\u6307\u6a19\u3002 Client libraries : \u5e6b\u52a9\u61c9\u7528\u7a0b\u5f0ffor instrumenting application code. Pushgateway : \u652f\u6301\u5f9e\u3000short-lived jobs\u3000\u4e2d\u6536\u96c6\u6307\u6a19 Exporters : \u4e0d\u540c\u670d\u52d9\u7684\u6307\u6a19\u5c0e\u51fa\u5668 Alertmanager : \u89f8\u767c\u5668\u8655\u7406\u5be6\u6642\u8b66\u5831 \u70ba\u4ec0\u9ebc\u9078\u64c7 Prometheus Operator? \u00b6 Kubernetes \u63d0\u4f9b\u4e86\u5f88\u591a\u5c0d\u8c61\u4f86\u90e8\u7f72\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1aPod\u3001Deployment\u3001Service\u3001Ingress \u7b49\u2026\u2026\u9019\u4e9b\u662f\u672c\u5730\u8cc7\u6e90\uff0c\u56e0\u70ba\u5b83\u5011\u662f\u901a\u7528\u7684\uff0c\u5b83\u5011\u7684\u884c\u70ba\u4e0d\u50cf\u6700\u7d42\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 Kubernetes \u5141\u8a31\u60a8\u901a\u904e\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9 Custom Resource Definition (CRD) \u5275\u5efa\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002 CRD \u5c0d\u8c61\u5be6\u73fe\u6700\u7d42\u61c9\u7528\u7a0b\u5e8f\u7684\u884c\u70ba\u3002\u9019\u5141\u8a31\u66f4\u597d\u7684\u53ef\u7dad\u8b77\u6027\u4e26\u6e1b\u5c11\u90e8\u7f72\u5de5\u4f5c\u3002\u4f7f\u7528 Prometheus Operator \u6642\uff0c\u67b6\u69cb\u7684\u6bcf\u500b\u7d44\u4ef6\u90fd\u4f86\u81ea\u4e00\u500b CRD\u3002\u9019\u4f7f\u5f97 Prometheus \u8a2d\u7f6e\u6bd4\u50b3\u7d71\u5b89\u88dd\u66f4\u7c21\u55ae\u3002 \u5728\u7d93\u5178\u7684 Prometheus \u5b89\u88dd\u4e2d\uff0c\u6dfb\u52a0\u65b0\u7684\u6307\u6a19\u7aef\u9ede\u9700\u8981\u66f4\u65b0\u670d\u52d9\u5668\u914d\u7f6e\u3002\u9019\u5141\u8a31\u5c07\u65b0\u7aef\u9ede\u8a3b\u518a\u70ba\u6536\u96c6\u6307\u6a19\u7684\u76ee\u6a19\u3002 Prometheus Operator \u4f7f\u7528 Monitor \u5c0d\u8c61\uff08PodMonitor\u3001ServiceMonitor\uff09\u4f86\u52d5\u614b\u767c\u73fe\u7aef\u9ede\u548c\u6293\u53d6\u6307\u6a19\u3002 Tip \u4f7f\u7528 Prometheus Operator \u53ef\u4ee5\u8b93\u60a8\u5728 Prometheus \u5b89\u88dd\u548c\u53ef\u7dad\u8b77\u6027\u4e0a\u7bc0\u7701\u6642\u9593\u3002\u5b83\u70ba\u60a8\u63d0\u4f9b Monitor \u5c0d\u8c61\u4f86\u52d5\u614b\u6536\u96c6\u6307\u6a19\uff0c\u800c\u7121\u9700\u66f4\u65b0 Prometheus \u914d\u7f6e\u3002 kube-prometheus-stack \u662f Kubernetes \u6e05\u55ae\u3001Grafana \u5100\u8868\u677f\u548c Prometheus \u898f\u5247\u7684\u96c6\u5408\u3002\u5b83\u901a\u904e\u4f7f\u7528 Operator \u7684 Prometheus \u63d0\u4f9b\u6613\u65bc\u64cd\u4f5c\u7684\u7aef\u5230\u7aef Kubernetes \u96c6\u7fa4\u76e3\u63a7\u3002 \u8a72\u96c6\u5408\u53ef\u901a\u904e Helm chart \u4f86\u5b89\u88dd\u548c\u90e8\u7f72\u3002\u60a8\u53ef\u4ee5\u5728\u55ae\u500b\u547d\u4ee4\u884c\u4e2d\u90e8\u7f72\u76e3\u63a7\u5806\u68e7\u3002 \u5275\u5efa\u76e3\u63a7\u547d\u540d\u7a7a\u9593 \u00b6 \u5728 Kubernetes \u4e2d\uff0c\u547d\u540d\u7a7a\u9593\u63d0\u4f9b\u4e86\u4e00\u7a2e\u5728\u55ae\u500b\u96c6\u7fa4\u4e2d\u9694\u96e2\u8cc7\u6e90\u7d44\u7684\u6a5f\u5236\u3002\u6211\u5011\u5275\u5efa\u4e00\u500b\u540d\u70ba monitoring \u7684\u547d\u540d\u7a7a\u9593\u4f86\u6e96\u5099\u65b0\u7684\u90e8\u7f72\uff1a $ kubectl create namespace monitoring \u4f7f\u7528 Helm \u5b89\u88dd kube-prometheus-stack \u00b6 \u6dfb\u52a0 Prometheus \u5716\u8868\u5b58\u5132\u5eab\u4e26\u66f4\u65b0\u672c\u5730\u7de9\u5b58\uff1a $ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts $ helm repo update \u4f7f\u7528 Helm \u5728\u547d\u540d\u7a7a\u9593\u76e3\u63a7\u4e2d\u90e8\u7f72 kube-stack-prometheus chart\uff1a $ helm upgrade --install --wait --create-namespace --namespace monitoring kube-stack-prometheus prometheus-community/kube-prometheus-stack CRD \u73fe\u5728\u5b89\u88dd\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u9032\u884c\u9a57\u8b49\uff1a $ kubectl get -n monitoring crds NAME CREATED AT alertmanagerconfigs.monitoring.coreos.com 2022 -03-15T10:54:41Z alertmanagers.monitoring.coreos.com 2022 -03-15T10:54:42Z podmonitors.monitoring.coreos.com 2022 -03-15T10:54:42Z probes.monitoring.coreos.com 2022 -03-15T10:54:42Z prometheuses.monitoring.coreos.com 2022 -03-15T10:54:42Z prometheusrules.monitoring.coreos.com 2022 -03-15T10:54:42Z servicemonitors.monitoring.coreos.com 2022 -03-15T10:54:42Z thanosrulers.monitoring.coreos.com 2022 -03-15T10:54:42Z \u9019\u662f\u6211\u5011\u73fe\u5728\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u904b\u884c\u7684\u5167\u5bb9\uff1a $ kubectl get pods -n monitoring NAME READY STATUS RESTARTS AGE alertmanager-kube-stack-prometheus-kube-alertmanager-0 2 /2 Running 0 2m36s kube-stack-prometheus-grafana-6994bd6c69-h6s9z 3 /3 Running 0 13h kube-stack-prometheus-kube-operator-86667b5cdf-cqndt 1 /1 Running 0 13h kube-stack-prometheus-kube-state-metrics-fc9878699-dpgh6 1 /1 Running 0 13h kube-stack-prometheus-prometheus-node-exporter-vrjsl 1 /1 Running 0 13h prometheus-kube-stack-prometheus-kube-prometheus-0 2 /2 Running 0 13h \u8a72 Helm chart \u5b89\u88dd\u4e86 Prometheus \u7d44\u4ef6\u548c Operator\u3001Grafana \u4ee5\u53ca\u4ee5\u4e0b exporters\uff1a prometheus-node-exporter \u66b4\u9732\u5e95\u5c64\u786c\u4ef6\u548c\u64cd\u4f5c\u7cfb\u7d71\u7684\u76f8\u95dc\u6307\u6a19 kube-state-metrics \u76e3\u807d Kubernetes API \u670d\u52d9\u5668\u4e26\u751f\u6210\u6709\u95dc\u5c0d\u8c61\u72c0\u614b\u7684\u6307\u6a19 \u6211\u5011\u7684 Prometheus \u548c Grafana \u76e3\u63a7\u5806\u68e7\u5df2\u7d93\u6e96\u5099\u5c31\u7dd2\uff01 \u9023\u63a5\u5230 Prometheus Web \u754c\u9762 \u00b6 Prometheus Web UI \u53ef\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u901a\u904e\u7aef\u53e3\u8f49\u767c\u8a2a\u554f\uff1a $ kubectl port-forward --namespace monitoring svc/kube-stack-prometheus-kube-prometheus 9090 :9090 --address = \"0.0.0.0\" \u5728 http://localhost:9090 \u4e0a\u6253\u958b\u700f\u89bd\u5668\u9078\u9805\u5361\u6703\u986f\u793a Prometheus Web UI\u3002\u6211\u5011\u53ef\u4ee5\u6aa2\u7d22\u5f9e\u4e0d\u540c\u6307\u6a19 Exporters \u6240\u6536\u96c6\u56de\u4f86\u7684\u6307\u6a19\uff1a \u8f49\u5230\u201cStatus>Targets\u201d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 Prometheus \u670d\u52d9\u5668\u767c\u73fe\u7684\u6240\u6709\u6307\u6a19\u7aef\u9ede\uff1a \u9023\u63a5\u5230 Grafana \u00b6 \u9023\u63a5\u5230 Grafana Web \u754c\u9762\u7684\u5e33\u5bc6\u5b58\u5132\u5728 Kubernetes Secret \u4e2d\u4e26\u4ee5 base64 \u7de8\u78bc\u3002\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u5169\u500b\u547d\u4ee4\u6aa2\u7d22\u7528\u6236\u540d/\u5bc6\u78bc\uff1a $ kubectl get secret --namespace monitoring kube-stack-prometheus-grafana -o jsonpath = '{.data.admin-user}' | base64 -d $ kubectl get secret --namespace monitoring kube-stack-prometheus-grafana -o jsonpath = '{.data.admin-password}' | base64 -d \u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u5230 Grafana \u7684\u7aef\u53e3\u8f49\u767c\uff1a $ kubectl port-forward --namespace monitoring svc/kube-stack-prometheus-grafana 8080 :80 --address = \"0.0.0.0\" \u6253\u958b\u700f\u89bd\u5668\u4e26\u8f49\u5230 http://localhost:8080 \u4e26\u586b\u5beb\u524d\u4e00\u500b\u547d\u4ee4\u6240\u53d6\u5f97\u7684\u7528\u6236\u540d/\u5bc6\u78bc\uff1a kube-stack-prometheus \u5728\u90e8\u7f72\u6642\u4e5f\u540c\u6642\u914d\u7f6e\u4e86 Grafana \u5100\u8868\u677f\uff1a \u5728\u9019\u88e1\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u4e00\u500b\u986f\u793a Kubernetes pod \u7684\u8a08\u7b97\u8cc7\u6e90\uff1a","title":"Prometheus-operator \u4ecb\u7ecd\u548c\u914d\u7f6e\u89e3\u6790"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#kubernetes-prometheusoperator-grafana","text":"\u539f\u6587: How To Setup Prometheus (Operator) and Grafana Monitoring On Kubernetes \u76e3\u63a7\u662f DevOps \u6700\u4f73\u5be6\u8e10\u7684\u95dc\u9375\u652f\u67f1\u3002\u9019\u63d0\u4f9b\u4e86\u6709\u95dc\u5e73\u53f0\u6027\u80fd\u548c\u5065\u5eb7\u72c0\u6cc1\u7684\u91cd\u8981\u4fe1\u606f\u3002\u5728 Kubernetes \u548c\u5fae\u670d\u52d9\u7b49\u5206\u4f48\u5f0f\u74b0\u5883\u4e2d\uff0c\u66f4\u662f\u5982\u6b64\u3002 Kubernetes \u7684\u4e00\u5927\u512a\u52e2\u662f\u80fd\u5920\u64f4\u5c55\u60a8\u7684\u670d\u52d9\u548c\u61c9\u7528\u7a0b\u5e8f\u3002\u7576\u60a8\u9054\u5230\u6578\u5343\u500b\u61c9\u7528\u7a0b\u5e8f\u6642\uff0c\u624b\u52d5\u76e3\u63a7\u5b83\u5011\u6216\u4f7f\u7528\u8173\u672c\u662f\u4e0d\u53ef\u884c\u7684\u3002\u60a8\u9084\u9700\u8981\u63a1\u7528\u53ef\u64f4\u5c55\u7684\u76e3\u63a7\u7cfb\u7d71\uff01\u9019\u5c31\u662f Prometheus \u548c Grafana \u51fa\u73fe\u7684\u5730\u65b9\u3002 Prometheus \u5c07\u6536\u96c6\u3001\u5b58\u5132\u4e26\u5141\u8a31\u60a8\u5229\u7528\u60a8\u7684\u5e73\u53f0\u6307\u6a19\u3002\u53e6\u4e00\u65b9\u9762\uff0cGrafana \u5c07\u6574\u5408 Prometheus \u4e26\u5141\u8a31\u60a8\u5275\u5efa\u6f02\u4eae\u7684\u5100\u8868\u677f\u548c\u5716\u8868\u3002 \u4eca\u5929\uff0c\u6211\u5011\u5c07\u8a0e\u8ad6 Prometheus \u662f\u4ec0\u9ebc\u4ee5\u53ca\u5728 Kubernetes \u4e0a\u90e8\u7f72\u5b83\u7684\u6700\u4f73\u65b9\u5f0f\uff1a\u4f7f\u7528 Prometheus Operator\u3002\u6211\u5011\u5c07\u4e86\u89e3\u5982\u4f55\u4f7f\u7528 Prometheus \u548c Grafana \u8a2d\u7f6e\u76e3\u63a7\u5e73\u53f0\u3002","title":"\u5982\u4f55\u5728 Kubernetes \u4e0a\u8a2d\u7f6e Prometheus\uff08Operator\uff09\u548c Grafana \u76e3\u63a7"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#prometheus","text":"Prometheus \u662f 2012 \u5e74\u5728 SoundCloud \u69cb\u5efa\u7684\u7528\u65bc\u4e8b\u4ef6\u76e3\u63a7\u548c\u8b66\u5831\u7684\u514d\u8cbb\u958b\u6e90\u61c9\u7528\u7a0b\u5e8f\u3002\u96a8\u5f8c\u8a31\u591a\u516c\u53f8\u548c\u7d44\u7e54\u63a1\u7528\u4e26\u8ca2\u737b\u4e86\u5b83\u3002 2016 \u5e74\uff0c\u96f2\u539f\u751f\u8a08\u7b97\u57fa\u91d1\u6703\uff08CNCF\uff09\u5728 Kubernetes \u4e4b\u5f8c\u5b75\u5316\u4e86 Prometheus \u9805\u76ee\u3002","title":"Prometheus"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#_1","text":"Prometheus \u88ab\u8a8d\u70ba\u662f Kubernetes \u7684\u9ed8\u8a8d\u76e3\u63a7\u89e3\u6c7a\u65b9\u6848\uff0c\u5176\u9748\u611f\u4f86\u81ea Google \u7684 Borgman\u3002\u5b83\u4f7f\u7528 HTTP \u62c9\u53d6\u8acb\u6c42\u5f9e\u61c9\u7528\u7a0b\u5e8f\u548c\u57fa\u790e\u67b6\u69cb\u6536\u96c6\u6307\u6a19\u3002\u76ee\u6a19\u662f\u901a\u904e\u670d\u52d9\u767c\u73fe\u6216\u975c\u614b\u914d\u7f6e\u767c\u73fe\u7684\u3002\u901a\u904e\u4e2d\u9593\u7db2\u95dc\u4e5f\u652f\u6301\u63a8\u9001\u6642\u9593\u5e8f\u5217\u7684\u6307\u6a19\u6578\u64da\u3002 Prometheus \u7684\u6307\u6a19\u5177\u6709\u4ee5\u4e0b\u683c\u5f0f\uff1a <metric name>{<label name>=<label value>, ...} <reading_value> Prometheus \u5728\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab (TSDB) \u4e2d\u8a18\u9304\u5be6\u6642\u6307\u6a19\u2014\u2014\u9019\u5e36\u4f86\u4e86\u7dad\u5ea6\u6578\u64da\u6a21\u578b\u3001\u64cd\u4f5c\u7c21\u55ae\u6027\u548c\u53ef\u64f4\u5c55\u7684\u6578\u64da\u6536\u96c6\u3002\u5b83\u63d0\u4f9b\u4e86 PromQL\uff0c\u4e00\u7a2e\u9748\u6d3b\u7684\u67e5\u8a62\u8a9e\u8a00\u4f86\u5229\u7528\u9019\u7a2e\u7dad\u5ea6\u3002 \u67b6\u69cb\u5716\u986f\u793a Prometheus \u662f\u4e00\u500b\u591a\u7d44\u4ef6\u76e3\u63a7\u7cfb\u7d71\u3002\u4ee5\u4e0b\u90e8\u5206\u96c6\u6210\u5230 Prometheus \u90e8\u7f72\u4e2d\uff1a Prometheus server : \u6293\u53d6\u4e26\u5b58\u5132\u6642\u9593\u5e8f\u5217\u6578\u64da\u3002\u5b83\u9084\u63d0\u4f9b\u4e86\u4e00\u500b\u7528\u6236\u754c\u9762\u4f86\u67e5\u8a62\u6307\u6a19\u3002 Client libraries : \u5e6b\u52a9\u61c9\u7528\u7a0b\u5f0ffor instrumenting application code. Pushgateway : \u652f\u6301\u5f9e\u3000short-lived jobs\u3000\u4e2d\u6536\u96c6\u6307\u6a19 Exporters : \u4e0d\u540c\u670d\u52d9\u7684\u6307\u6a19\u5c0e\u51fa\u5668 Alertmanager : \u89f8\u767c\u5668\u8655\u7406\u5be6\u6642\u8b66\u5831","title":"\u6982\u5ff5"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#prometheus-operator","text":"Kubernetes \u63d0\u4f9b\u4e86\u5f88\u591a\u5c0d\u8c61\u4f86\u90e8\u7f72\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\uff1aPod\u3001Deployment\u3001Service\u3001Ingress \u7b49\u2026\u2026\u9019\u4e9b\u662f\u672c\u5730\u8cc7\u6e90\uff0c\u56e0\u70ba\u5b83\u5011\u662f\u901a\u7528\u7684\uff0c\u5b83\u5011\u7684\u884c\u70ba\u4e0d\u50cf\u6700\u7d42\u7684\u61c9\u7528\u7a0b\u5e8f\u3002 Kubernetes \u5141\u8a31\u60a8\u901a\u904e\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9 Custom Resource Definition (CRD) \u5275\u5efa\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u3002 CRD \u5c0d\u8c61\u5be6\u73fe\u6700\u7d42\u61c9\u7528\u7a0b\u5e8f\u7684\u884c\u70ba\u3002\u9019\u5141\u8a31\u66f4\u597d\u7684\u53ef\u7dad\u8b77\u6027\u4e26\u6e1b\u5c11\u90e8\u7f72\u5de5\u4f5c\u3002\u4f7f\u7528 Prometheus Operator \u6642\uff0c\u67b6\u69cb\u7684\u6bcf\u500b\u7d44\u4ef6\u90fd\u4f86\u81ea\u4e00\u500b CRD\u3002\u9019\u4f7f\u5f97 Prometheus \u8a2d\u7f6e\u6bd4\u50b3\u7d71\u5b89\u88dd\u66f4\u7c21\u55ae\u3002 \u5728\u7d93\u5178\u7684 Prometheus \u5b89\u88dd\u4e2d\uff0c\u6dfb\u52a0\u65b0\u7684\u6307\u6a19\u7aef\u9ede\u9700\u8981\u66f4\u65b0\u670d\u52d9\u5668\u914d\u7f6e\u3002\u9019\u5141\u8a31\u5c07\u65b0\u7aef\u9ede\u8a3b\u518a\u70ba\u6536\u96c6\u6307\u6a19\u7684\u76ee\u6a19\u3002 Prometheus Operator \u4f7f\u7528 Monitor \u5c0d\u8c61\uff08PodMonitor\u3001ServiceMonitor\uff09\u4f86\u52d5\u614b\u767c\u73fe\u7aef\u9ede\u548c\u6293\u53d6\u6307\u6a19\u3002 Tip \u4f7f\u7528 Prometheus Operator \u53ef\u4ee5\u8b93\u60a8\u5728 Prometheus \u5b89\u88dd\u548c\u53ef\u7dad\u8b77\u6027\u4e0a\u7bc0\u7701\u6642\u9593\u3002\u5b83\u70ba\u60a8\u63d0\u4f9b Monitor \u5c0d\u8c61\u4f86\u52d5\u614b\u6536\u96c6\u6307\u6a19\uff0c\u800c\u7121\u9700\u66f4\u65b0 Prometheus \u914d\u7f6e\u3002 kube-prometheus-stack \u662f Kubernetes \u6e05\u55ae\u3001Grafana \u5100\u8868\u677f\u548c Prometheus \u898f\u5247\u7684\u96c6\u5408\u3002\u5b83\u901a\u904e\u4f7f\u7528 Operator \u7684 Prometheus \u63d0\u4f9b\u6613\u65bc\u64cd\u4f5c\u7684\u7aef\u5230\u7aef Kubernetes \u96c6\u7fa4\u76e3\u63a7\u3002 \u8a72\u96c6\u5408\u53ef\u901a\u904e Helm chart \u4f86\u5b89\u88dd\u548c\u90e8\u7f72\u3002\u60a8\u53ef\u4ee5\u5728\u55ae\u500b\u547d\u4ee4\u884c\u4e2d\u90e8\u7f72\u76e3\u63a7\u5806\u68e7\u3002","title":"\u70ba\u4ec0\u9ebc\u9078\u64c7 Prometheus Operator?"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#_2","text":"\u5728 Kubernetes \u4e2d\uff0c\u547d\u540d\u7a7a\u9593\u63d0\u4f9b\u4e86\u4e00\u7a2e\u5728\u55ae\u500b\u96c6\u7fa4\u4e2d\u9694\u96e2\u8cc7\u6e90\u7d44\u7684\u6a5f\u5236\u3002\u6211\u5011\u5275\u5efa\u4e00\u500b\u540d\u70ba monitoring \u7684\u547d\u540d\u7a7a\u9593\u4f86\u6e96\u5099\u65b0\u7684\u90e8\u7f72\uff1a $ kubectl create namespace monitoring","title":"\u5275\u5efa\u76e3\u63a7\u547d\u540d\u7a7a\u9593"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#helm-kube-prometheus-stack","text":"\u6dfb\u52a0 Prometheus \u5716\u8868\u5b58\u5132\u5eab\u4e26\u66f4\u65b0\u672c\u5730\u7de9\u5b58\uff1a $ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts $ helm repo update \u4f7f\u7528 Helm \u5728\u547d\u540d\u7a7a\u9593\u76e3\u63a7\u4e2d\u90e8\u7f72 kube-stack-prometheus chart\uff1a $ helm upgrade --install --wait --create-namespace --namespace monitoring kube-stack-prometheus prometheus-community/kube-prometheus-stack CRD \u73fe\u5728\u5b89\u88dd\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u3002\u60a8\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b kubectl \u547d\u4ee4\u9032\u884c\u9a57\u8b49\uff1a $ kubectl get -n monitoring crds NAME CREATED AT alertmanagerconfigs.monitoring.coreos.com 2022 -03-15T10:54:41Z alertmanagers.monitoring.coreos.com 2022 -03-15T10:54:42Z podmonitors.monitoring.coreos.com 2022 -03-15T10:54:42Z probes.monitoring.coreos.com 2022 -03-15T10:54:42Z prometheuses.monitoring.coreos.com 2022 -03-15T10:54:42Z prometheusrules.monitoring.coreos.com 2022 -03-15T10:54:42Z servicemonitors.monitoring.coreos.com 2022 -03-15T10:54:42Z thanosrulers.monitoring.coreos.com 2022 -03-15T10:54:42Z \u9019\u662f\u6211\u5011\u73fe\u5728\u5728\u547d\u540d\u7a7a\u9593\u4e2d\u904b\u884c\u7684\u5167\u5bb9\uff1a $ kubectl get pods -n monitoring NAME READY STATUS RESTARTS AGE alertmanager-kube-stack-prometheus-kube-alertmanager-0 2 /2 Running 0 2m36s kube-stack-prometheus-grafana-6994bd6c69-h6s9z 3 /3 Running 0 13h kube-stack-prometheus-kube-operator-86667b5cdf-cqndt 1 /1 Running 0 13h kube-stack-prometheus-kube-state-metrics-fc9878699-dpgh6 1 /1 Running 0 13h kube-stack-prometheus-prometheus-node-exporter-vrjsl 1 /1 Running 0 13h prometheus-kube-stack-prometheus-kube-prometheus-0 2 /2 Running 0 13h \u8a72 Helm chart \u5b89\u88dd\u4e86 Prometheus \u7d44\u4ef6\u548c Operator\u3001Grafana \u4ee5\u53ca\u4ee5\u4e0b exporters\uff1a prometheus-node-exporter \u66b4\u9732\u5e95\u5c64\u786c\u4ef6\u548c\u64cd\u4f5c\u7cfb\u7d71\u7684\u76f8\u95dc\u6307\u6a19 kube-state-metrics \u76e3\u807d Kubernetes API \u670d\u52d9\u5668\u4e26\u751f\u6210\u6709\u95dc\u5c0d\u8c61\u72c0\u614b\u7684\u6307\u6a19 \u6211\u5011\u7684 Prometheus \u548c Grafana \u76e3\u63a7\u5806\u68e7\u5df2\u7d93\u6e96\u5099\u5c31\u7dd2\uff01","title":"\u4f7f\u7528 Helm \u5b89\u88dd kube-prometheus-stack"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#prometheus-web","text":"Prometheus Web UI \u53ef\u901a\u904e\u4ee5\u4e0b\u547d\u4ee4\u901a\u904e\u7aef\u53e3\u8f49\u767c\u8a2a\u554f\uff1a $ kubectl port-forward --namespace monitoring svc/kube-stack-prometheus-kube-prometheus 9090 :9090 --address = \"0.0.0.0\" \u5728 http://localhost:9090 \u4e0a\u6253\u958b\u700f\u89bd\u5668\u9078\u9805\u5361\u6703\u986f\u793a Prometheus Web UI\u3002\u6211\u5011\u53ef\u4ee5\u6aa2\u7d22\u5f9e\u4e0d\u540c\u6307\u6a19 Exporters \u6240\u6536\u96c6\u56de\u4f86\u7684\u6307\u6a19\uff1a \u8f49\u5230\u201cStatus>Targets\u201d\uff0c\u60a8\u53ef\u4ee5\u770b\u5230 Prometheus \u670d\u52d9\u5668\u767c\u73fe\u7684\u6240\u6709\u6307\u6a19\u7aef\u9ede\uff1a","title":"\u9023\u63a5\u5230 Prometheus Web \u754c\u9762"},{"location":"kubernetes/observability/metrics/kube-prometheus-stack/setup-prometheus-and-grafana-on-kubernetes/#grafana","text":"\u9023\u63a5\u5230 Grafana Web \u754c\u9762\u7684\u5e33\u5bc6\u5b58\u5132\u5728 Kubernetes Secret \u4e2d\u4e26\u4ee5 base64 \u7de8\u78bc\u3002\u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u5169\u500b\u547d\u4ee4\u6aa2\u7d22\u7528\u6236\u540d/\u5bc6\u78bc\uff1a $ kubectl get secret --namespace monitoring kube-stack-prometheus-grafana -o jsonpath = '{.data.admin-user}' | base64 -d $ kubectl get secret --namespace monitoring kube-stack-prometheus-grafana -o jsonpath = '{.data.admin-password}' | base64 -d \u6211\u5011\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5275\u5efa\u5230 Grafana \u7684\u7aef\u53e3\u8f49\u767c\uff1a $ kubectl port-forward --namespace monitoring svc/kube-stack-prometheus-grafana 8080 :80 --address = \"0.0.0.0\" \u6253\u958b\u700f\u89bd\u5668\u4e26\u8f49\u5230 http://localhost:8080 \u4e26\u586b\u5beb\u524d\u4e00\u500b\u547d\u4ee4\u6240\u53d6\u5f97\u7684\u7528\u6236\u540d/\u5bc6\u78bc\uff1a kube-stack-prometheus \u5728\u90e8\u7f72\u6642\u4e5f\u540c\u6642\u914d\u7f6e\u4e86 Grafana \u5100\u8868\u677f\uff1a \u5728\u9019\u88e1\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u4e00\u500b\u986f\u793a Kubernetes pod \u7684\u8a08\u7b97\u8cc7\u6e90\uff1a","title":"\u9023\u63a5\u5230 Grafana"},{"location":"kubernetes/observability/tracing/dotnet/modern-monitoring-using-openTelemetry-with-Observability/","text":"[OpenTelemetry] \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53ef\u89c0\u6e2c\u6027(Observability) \u00b6 \u539f\u6587: [OpenTelemetry] \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53ef\u89c0\u6e2c\u6027(Observability) \u524d\u8a00 \u00b6 \u6700\u8fd1\u5728 suvery \u76e3\u63a7\u76f8\u95dc\u8b70\u984c\u6642\u63a5\u89f8\u5230 OpenTelemetry \u8490\u96c6\u9059\u6e2c\u6578\u64da\u7684\u958b\u6e90\u6846\u67b6\uff0c\u89ba\u5f97\u9019\u8b70\u984c\u633a\u6709\u8da3\u7684\u56e0\u6b64\u6574\u7406\u8b8a\u6210\u7cfb\u5217\u6587\uff0c\u9019\u7bc7\u662f\u7814\u7a76 OpenTelemetry \u7684\u7cfb\u5217\u6587\u7b2c\u4e00\u7bc7\uff0c \u9019\u7cfb\u5217\u4e3b\u8981\u6703\u5206\u70ba\u56db\u7bc7\u5206\u5225\u662f: \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53ef\u89c0\u6e2c\u6027(Observability) \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : OpenTelemetry \u958b\u653e\u9059\u6e2c \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u5728 .NET \u5982\u4f55\u4f7f\u7528 OpenTelemetry \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53cd\u601d\u8207\u7e3d\u7d50 \u82e5\u5c0d\u65bc\u4e0a\u8ff0\u5167\u5bb9\u6709\u554f\u984c\u6216\u662f\u4e0d\u6e05\u695a\u7684\u5730\u65b9\uff0c\u6b61\u8fce\u63d0\u51fa\u4f86\u4e00\u8d77\u8a0e\u8ad6 \u4f01\u696d\u9762\u81e8\u7684\u6311\u6230 \u00b6 \u96a8\u8457\u79d1\u6280\u6280\u8853\u4e0d\u65b7\u7684\u5275\u65b0\uff0c\u8edf\u9ad4\u67b6\u69cb\u8207\u57fa\u790e\u5efa\u8a2d\u6f14\u8b8a\u901f\u5ea6\u4e5f\u662f\u8b8a\u5316\u76f8\u7576\u5feb\uff0c\u5982\u4e0b\u5716\u6240\u793a\u53ef\u80fd(\u4f46\u4e0d\u9650)\u65bc\u4ee5\u4e0b\u5e7e\u500b\u968e\u6bb5 \u7b2c\u4e00\u968e\u6bb5 : \u61c9\u7528\u7a0b\u5f0f\u67b6\u69cb\u8a2d\u8a08\u4e0a\u8f03\u70ba\u7c21\u55ae\uff0c\u5728\u5546\u696d\u9700\u6c42\u6c92\u90a3\u9ebc\u8907\u96dc\u67b6\u69cb\u4e0a\u4e0d\u6703\u91dd\u5c0d\u5176\u6a21\u7d44\u505a\u592a\u591a\u7684\u5207\u5272\uff0c\u7a0b\u5f0f\u6703\u904b\u884c\u57f7\u884c\u7dd2(Process)\u57f7\u884c\u55ae\u4e00\u7684\u8acb\u6c42\uff0c\u5728\u9032\u884c\u6e2c\u8a66\u8207\u554f\u984c\u6392\u9664\u4e0a\u8f03\u70ba\u7c21\u55ae\uff1b\u5728\u958b\u767c\u5b8c\u7562\u4e4b\u5f8c\u6703\u4f48\u7f72\u5728 VM \u6216\u662f\u6703 IDC \u6a5f\u623f\u4e2d\u63d0\u4f9b\u7d66\u4f7f\u7528\u8005\u4f86\u4f7f\u7528\u3002 \u7b2c\u4e8c\u968e\u6bb5 : \u96a8\u8457\u96f2\u7aef\u6280\u8853\u7684\u63a8\u51fa\uff0c\u4f01\u696d\u958b\u59cb\u5617\u8a66\u5c07\u61c9\u7528\u7a0b\u5f0f\u4f48\u7f72\u5230\u96f2\u7aef\u7684 Iaas \u670d\u52d9\u4e0a\uff0c\u6216\u662f\u7d50\u5408\u516c\u6709\u96f2\u8207\u79c1\u6709\u96f2\u7684\u512a\u52e2\uff0c\u5c07\u4f01\u696d\u4e2d\u6a5f\u5bc6\u8cc7\u6599\u5728\u79c1\u6709\u96f2\u9032\u884c\u8655\u7406\uff0c\u5176\u4ed6\u8cc7\u8a0a\u5728\u516c\u6709\u96f2\u670d\u52d9\u4e0a\u9032\u884c\u904b\u7b97\uff0c\u958b\u767c\u4eba\u54e1\u5728\u61c9\u7528\u7a0b\u5f0f\u7684\u958b\u767c\u8207\u6574\u5408\u4e0a\u6709\u66f4\u591a\u8207 Cloud \u670d\u52d9\u6574\u5408\u7684\u6a5f\u6703\uff0c\u9078\u64c7 Cloud \u4e0a\u9069\u5408\u7684\u670d\u52d9\u4f7f\u7528\u3002 \u7b2c\u4e09\u968e\u6bb5 : \u96f2\u7aef\u6280\u8853\u9010\u6f38\u6210\u719f\u8207\u7a69\u5b9a\uff0c\u66f4\u591a\u7684\u96f2\u7aef\u57fa\u790e\u5efa\u8a2d\u670d\u52d9\u8207\u65b0\u670d\u52d9\u4e0d\u65b7\u7684\u63a8\u51fa\uff0c\u5728\u67b6\u69cb\u8a2d\u8a08\u4e0a\u8d8a\u4f86\u8d8a\u591a\u4eba\u958b\u59cb\u8a0e\u8ad6\u5206\u6563\u5f0f\u7cfb\u7d71\u67b6\u69cb\u7684\u8a2d\u8a08\uff0c\u4e5f\u8d8a\u4f86\u8d8a\u591a\u4eba\u8003\u616e\u5c07\u8cc7\u6599\u5eab\u5f9eIDC\u6a5f\u623f\u9077\u79fb\u5230 Cloud \u96f2\u7aef\u4e0a\uff0c\u52a0\u4e0a\u50cf\u662f RDS\u3001DynamoDB\u3001Redis \u7b49\u96f2\u7aef\u8cc7\u6599\u5eab, \u9019\u4e9b\u670d\u52d9\u6216\u7d44\u4ef6\u8b93\u5927\u5bb6\u5728\u96f2\u7aef\u958b\u767c\u8207\u7ba1\u7406\u4e0a\u66f4\u70ba\u65b9\u4fbf\u3002\u5728\u67b6\u69cb\u4e0a\u4e5f\u66f4\u70ba\u5f48\u6027\u642d\u914d\u8457\u4f01\u696d\u9700\u6c42\u4f86\u4f7f\u7528\uff1b\u5728\u57fa\u790e\u5efa\u8a2d\u4e0a\u4e5f\u4f34\u96a8\u8457\u5bb9\u5668\u5316(dockerize)\u7684\u6280\u8853\u6210\u719f\u958b\u59cb\u9032\u5165\u65b0\u7684\u4e16\u4ee3\u3002 \u7b2c\u56db\u968e\u6bb5 : \u904e\u53bb\u5e7e\u5e74\u5927\u5bb6\u4e00\u76f4\u5728\u8a0e\u8ad6\u8edf\u9ad4\u67b6\u69cb\u5f9e\u55ae\u9ad4\u5230\u5fae\u670d\u52d9 serverless\u3001service meshes \u7b49\u5404\u7a2e\u53ef\u80fd\u7684\u7d44\u5408\uff0c\u4e3b\u8981\u76ee\u7684\u53ef\u80fd\u662f\u5728\u670d\u52d9\u67b6\u69cb\u8a2d\u8a08\u6642\u5982\u4f55\u964d\u4f4e\u670d\u52d9\u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff1b\u5728\u8d8a\u4f86\u8d8a\u591a\u4f01\u696d\u4f7f\u7528\u865b\u64ec\u5bb9\u5668\u6280\u8853 Docker \u5f8c\u767c\u73fe\u7ba1\u7406 Docker \u5be6\u52d9\u4e0a\u662f\u56f0\u96e3\u7684\uff0c\u56e0\u6b64 Kubernetes(K8S) \u958b\u59cb\u76db\u884c\uff0c\u5e6b\u52a9\u5718\u968a\u5728\u8abf\u5ea6 Docker \u4e0a\u66f4\u70ba\u5bb9\u6613\u8207\u9748\u6d3b\uff0c \u4f46\u8207\u6240\u6709\u7f8e\u597d\u4e8b\u7269\u4e00\u6a23\u90fd\u662f\u6709\u4ee3\u50f9\u7684\uff1b\u7576\u670d\u52d9\u8d8a\u5207\u8d8a\u7d30\u6642\uff0c\u5206\u4f48\u5f0f\u7cfb\u7d71\u5e36\u4f86\u4e86\u773e\u591a\u7684\u6311\u6230\u3002\u7576\u958b\u767c\u7684\u4e16\u754c\u8b8a\u5f97\u8907\u96dc\uff0c\u53ef\u80fd\u6703\u5e36\u4f86\u54ea\u4e9b\u5f71\u97ff\u5462 ? \u53ef\u80fd\u6703\u5206\u70ba\u4e09\u500b\u90e8\u5206: \u67b6\u69cb : \u5f9e\u55ae\u9ad4\u5f0f\u67b6\u69cb > SOA > \u5206\u6563\u5f0f\u67b6\u69cb > \u5fae\u670d\u52d9 \u958b\u767c\u4eba\u54e1\u5728\u958b\u767c\u4e0a\u8b8a\u5f97\u66f4\u7e41\u7463\uff0c\u8981\u6ce8\u610f\u7684\u4e8b\u60c5\u8b8a\u5f97\u66f4\u591a\u3002\u4f8b\u5982 : \u670d\u52d9\u5f7c\u6b64\u4e4b\u9593\u7684\u6e9d\u901a\u8981\u5982\u4f55\u9032\u884c ? \u5728\u4e8b\u4ef6\u7684\u7d00\u9304\u4e0a\u8981\u5982\u4f55\u8655\u7406 ? \u7576\u4e00\u500b\u8acb\u6c42\u8981\u7d93\u904e\u591a\u500b\u670d\u52d9\u7684\u6642\u5019\u76f8\u5c0d\u7684\u5ef6\u9072(Lateny)\u4e5f\u6703\u589e\u52a0\uff0c\u670d\u52d9\u7684\u62c6\u5206\u8207\u8acb\u6c42\u6642\u9593\u7684\u90e8\u5206\u8a72\u5982\u4f55\u9054\u5230\u5e73\u8861 ? \u6e2c\u8a66 : \u7576\u7cfb\u7d71\u67b6\u69cb\u8b8a\u5f97\u8907\u96dc\uff0c\u6e2c\u8a66\u4eba\u54e1\u6216\u5718\u968a\u5728\u6e2c\u8a66\u4e0a\u52e2\u5fc5\u9700\u8981\u82b1\u66f4\u591a\u6642\u9593\u4f86\u4e86\u89e3\u65e2\u6709\u67b6\u69cb\u8981\u5982\u4f55\u9032\u884c\u6e2c\u8a66\u3002 \u76e3\u63a7 : \u4e0a\u7dda\u5f8c\u7684\u76e3\u63a7\u6703\u662f\u6700\u5927\u7684\u6311\u6230\uff0c\u7576\u4f60\u6240\u5728\u7684\u7522\u54c1\u670d\u52d9\u662f 7* 24 \u5c0f\u6642\uff0c\u7cfb\u7d71\u67b6\u69cb\u5207\u5206\u5f88\u7d30\u6216\u662f\u5f88\u8907\u96dc\u6642\uff0c\u7576\u4eca\u5929\u67d0\u500b\u670d\u52d9\u6545\u969c\u6642\u8981\u5982\u4f55\u5feb\u901f\u5b9a\u4f4d\u554f\u984c\u8b8a\u7684\u662f\u91cd\u8981\u7684\u95dc\u9375 \u6848\u4f8b: Facebook \u7576\u6a5f\u4e8b\u4ef6 \u00b6 \u6216\u8a31\u4e0a\u9762\u6587\u7ae0\u63d0\u5230\u7684\u90e8\u5206\u6709\u9ede\u62bd\u8c61\uff0c\u6211\u5011\u4f86\u770b\u4e00\u500b\u771f\u5be6\u7684\u6848\u4f8b\uff0c2021/10/4 facebook\u3001whatApp\u53ca IG \u5927\u7576\u6a5f\uff0c\u6574\u500b\u6848\u4ef6\u6839\u672c\u539f\u56e0\u662f\u56e0\u70ba\u5de5\u7a0b\u5e2b\u5728\u90e8\u7f72\u65b0\u529f\u80fd\u6642\u6709\u932f\uff0c\u5c0e\u81f4\u5c0d\u5916 DNS \u670d\u52d9\u7570\u5e38\uff0c\u8a73\u7d30\u53ef\u4ee5\u770b facebook \u5b98\u65b9\u6280\u8853\u90e8\u843d\u683c \u6216 Cloudfare \u7684\u7570\u5e38\u4e8b\u6545\u5831\u544a \u8aaa\u660e\u3002 \u9019\u88e1\u7c21\u55ae\u6574\u7406\u4e8b\u4ef6\u9020\u6210\u7684\u5f71\u97ff: \u4fee\u5fa9\u6642\u9593 : \u5f9e\u554f\u984c\u958b\u59cb\u5230\u6700\u5f8c\u4fee\u5fa9\u5b8c\u6210\u8fd1\u82b1\u8cbb 6 \u5c0f\u6642 \u5f71\u97ff\u4eba\u6578 : \u516b\u5343\u842c\u4eba\u7121\u6cd5\u4f7f\u7528 \u640d\u5931\u91d1\u984d : 10 \u5104\u53f0\u5e63 \u5f71\u97ff\u80a1\u50f9 : \u554f\u984c\u767c\u751f\u5f8c\uff0c\u80a1\u7968\u4e0b\u8dcc 4.89 % \u6700\u91cd\u8981\u7684\u53ef\u80fd\u662f\u5ba2\u6236\u6eff\u610f\u5ea6\uff0c\u4f60\u53ef\u4ee5\u60f3\u50cf\u4e00\u4e0b\u4eca\u5929\u525b\u597d\u5fd9\u788c\u4e00\u5929\u60f3\u6ed1\u4e00\u4e0b\u624b\u6a5f\u770b IG\u3001facebook \u6216\u662f whatApp \u627e\u670b\u53cb\u804a\u5929\u6642\uff0c\u4f46\u767c\u73fe\u9019\u4e9b\u670d\u52d9\u90fd\u6c92\u6709\u8fa6\u6cd5\u4f7f\u7528\u5fc3\u60c5\u6703\u662f\u5982\u4f55 ? \u4f7f\u7528\u8005\u53ef\u80fd\u6703\u8dd1\u53bb\u4f7f\u7528\u5176\u4ed6\u670d\u52d9\uff0cfacebook \u5b98\u65b9\u5728\u670d\u52d9\u7570\u5e38\u5730\u7576\u4e0b\u4e5f\u5728 twitter \u767c\u6587\u8aaa\u660e\u554f\u984c\u8207\u8655\u7406\u7684\u72c0\u6cc1\uff0c\u96a8\u8457\u6642\u9593\u4e00\u5206\u4e00\u79d2\u7684\u904e\u53bb\uff0c\u5ba2\u6236\u9010\u6f38\u5730\u5728\u6d41\u5931\u5230\u5176\u4ed6\u670d\u52d9\u50cf\u662f twitter\uff0c\u5ee3\u544a\u4e3b\u6295\u653e\u7684\u5ee3\u544a\u4e5f\u7121\u6cd5\u6b63\u5e38\u6295\u653e\u3002 \u5f9e\u4e0a\u8ff0\u554f\u984c\u4f86\u770b\uff0c\u5982\u4f55\u8b93\u554f\u984c\u767c\u751f\u6642\u80fd\u5920\u5feb\u901f\u5730\u88ab\u5b9a\u4f4d\u8b8a\u5f97\u66f4\u52a0\u91cd\u8981\uff0c\u5728\u4f01\u696d\u670d\u52d9\u8d8a\u5207\u8d8a\u7d30\u7684\u4e16\u4ee3\uff0c\u6700\u5feb\u6642\u9593\u627e\u5230\u554f\u984c\u8b8a\u5f97\u76f8\u7576\u7684\u95dc\u9375\u3002\u5982\u679c\u4eca\u5929\u662f\u767c\u751f\u5728\u4f60\u7684\u516c\u53f8\u6216\u662f\u8ca0\u8cac\u7684\u7cfb\u7d71\u767c\u751f\u7570\u5e38\u6642\uff0c\u4f60\u8981\u5982\u4f55\u5feb\u901f\u7684\u5b9a\u4f4d\u554f\u984c\u5462 ? \u6839\u64da Google \u95dc\u9375\u5b57\u5831\u544a\u641c\u5c0b \u76e3\u63a7(Monitor) \u95dc\u9375\u5b57\uff0c\u53ef\u4ee5\u767c\u73fe\u5728\u904e\u53bb 20 \u5e74\u7684\u6642\u9593\u5927\u5bb6\u5c0d\u65bc\u61c9\u7528\u7a0b\u5f0f\u7684\u76e3\u63a7\u8d8a\u4f86\u8d8a\u91cd\u8996\uff0c\u80cc\u5f8c\u7684\u6db5\u7fa9\u53ef\u80fd\u662f\u5728\u9019\u8b8a\u5316\u9019\u9ebc\u5feb\u3001\u4e0d\u78ba\u5b9a\u6027\u9019\u9ebc\u9ad8\u3001\u67b6\u69cb\u8d8a\u4f86\u8d8a\u8907\u96dc\u7684\u6642\u4ee3\uff0c\u662f\u5426\u6709\u66f4\u597d\u7684\u65b9\u6cd5\u6216\u65b9\u5f0f\u4f86\u9032\u884c\u76e3\u63a7\uff0c\u6216\u8005\u4e5f\u53ef\u4ee5\u53cd\u554f\uff0c\u6216\u8a31\u5728\u96f2\u539f\u751f(Cloud Native)\u6642\u4ee3\u7684\u76e3\u63a7\uff0c\u61c9\u8a72\u5177\u5099\u751a\u9ebc\u6a23\u7684\u7279\u6027? \u53ef\u89c0\u6e2c\u6027(Observability) \u00b6 \u5206\u6563\u5f0f\u7cfb\u7d71\u610f\u5473\u8005\u5206\u6563\u5f0f\u6545\u969c\uff0c\u7576\u51fa\u73fe\u6545\u969c\u6642\uff0c\u53ef\u80fd\u5f88\u96e3\u5feb\u901f\u6062\u5fa9\u670d\u52d9\uff0c\u751a\u81f3\u4e0d\u77e5\u9053\u5f9e\u54ea\u88e1\u958b\u59cb\u3002\u60a8\u5982\u4f55\u89e3\u6790\u9f90\u5927\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u53d6\u6c7a\u65bc\u4f60\u5c0d\u7cfb\u7d71\u7684\u4e86\u89e3\u8207\u554f\u984c\u5b9a\u4f4d\u6709\u5f88\u5927\u7684\u95dc\u806f\u3002\u53ef\u89c0\u6e2c\u6027\u7c21\u55ae\u4f86\u8aaa\u53ef\u4ee5\u5e6b\u52a9\u958b\u767c\u4eba\u54e1\u6216\u662f SRE \u5925\u4f34\u4e86\u89e3\uff0c\u4ec0\u9ebc\u662f\u6162\u7684 ? \u4ec0\u9ebc\u662f\u58de\u7684 ? \u4ee5\u53ca\u9700\u8981\u505a\u4ec0\u9ebc\u4f86\u63d0\u9ad8\u6027\u80fd\u3002 \u53ef\u89c0\u6e2c\u6027\u4e09\u500b\u91cd\u8981\u7684\u7279\u6027: Metrice \u6307\u6a19: \u7cfb\u7d71\u6709\u72c0\u6cc1 Logs \u65e5\u8a8c: \u554f\u984c\u662f\u751a\u9ebc Traces \u93c8\u8def\u8ffd\u8e2a: \u54ea\u88e1\u51fa\u554f\u984c \u904e\u53bb \u76e3\u63a7 \u53ef\u4ee5\u89e3\u6c7a\u7684\u662f \u5df2\u77e5\u7684\u5df2\u77e5 \u554f\u984c\uff0c \u53ef\u89c0\u6e2c\u6027 \u8981\u89e3\u6c7a\u7684\u662f \u5df2\u77e5\u7684\u672a\u77e5\u7684 \u554f\u984c\uff0c\u90a3\u9ebc\u4ec0\u9ebc\u662f \u5df2\u77e5\u7684\u672a\u77e5 \u5462 ?","title":"\u53ef\u89c0\u6e2c\u6027(Observability)"},{"location":"kubernetes/observability/tracing/dotnet/modern-monitoring-using-openTelemetry-with-Observability/#opentelemetry-opentelemetry-observability","text":"\u539f\u6587: [OpenTelemetry] \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53ef\u89c0\u6e2c\u6027(Observability)","title":"[OpenTelemetry] \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53ef\u89c0\u6e2c\u6027(Observability)"},{"location":"kubernetes/observability/tracing/dotnet/modern-monitoring-using-openTelemetry-with-Observability/#_1","text":"\u6700\u8fd1\u5728 suvery \u76e3\u63a7\u76f8\u95dc\u8b70\u984c\u6642\u63a5\u89f8\u5230 OpenTelemetry \u8490\u96c6\u9059\u6e2c\u6578\u64da\u7684\u958b\u6e90\u6846\u67b6\uff0c\u89ba\u5f97\u9019\u8b70\u984c\u633a\u6709\u8da3\u7684\u56e0\u6b64\u6574\u7406\u8b8a\u6210\u7cfb\u5217\u6587\uff0c\u9019\u7bc7\u662f\u7814\u7a76 OpenTelemetry \u7684\u7cfb\u5217\u6587\u7b2c\u4e00\u7bc7\uff0c \u9019\u7cfb\u5217\u4e3b\u8981\u6703\u5206\u70ba\u56db\u7bc7\u5206\u5225\u662f: \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53ef\u89c0\u6e2c\u6027(Observability) \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : OpenTelemetry \u958b\u653e\u9059\u6e2c \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u5728 .NET \u5982\u4f55\u4f7f\u7528 OpenTelemetry \u73fe\u4ee3\u5316\u76e3\u63a7\u4f7f\u7528 OpenTelemetry \u5be6\u73fe : \u53cd\u601d\u8207\u7e3d\u7d50 \u82e5\u5c0d\u65bc\u4e0a\u8ff0\u5167\u5bb9\u6709\u554f\u984c\u6216\u662f\u4e0d\u6e05\u695a\u7684\u5730\u65b9\uff0c\u6b61\u8fce\u63d0\u51fa\u4f86\u4e00\u8d77\u8a0e\u8ad6","title":"\u524d\u8a00"},{"location":"kubernetes/observability/tracing/dotnet/modern-monitoring-using-openTelemetry-with-Observability/#_2","text":"\u96a8\u8457\u79d1\u6280\u6280\u8853\u4e0d\u65b7\u7684\u5275\u65b0\uff0c\u8edf\u9ad4\u67b6\u69cb\u8207\u57fa\u790e\u5efa\u8a2d\u6f14\u8b8a\u901f\u5ea6\u4e5f\u662f\u8b8a\u5316\u76f8\u7576\u5feb\uff0c\u5982\u4e0b\u5716\u6240\u793a\u53ef\u80fd(\u4f46\u4e0d\u9650)\u65bc\u4ee5\u4e0b\u5e7e\u500b\u968e\u6bb5 \u7b2c\u4e00\u968e\u6bb5 : \u61c9\u7528\u7a0b\u5f0f\u67b6\u69cb\u8a2d\u8a08\u4e0a\u8f03\u70ba\u7c21\u55ae\uff0c\u5728\u5546\u696d\u9700\u6c42\u6c92\u90a3\u9ebc\u8907\u96dc\u67b6\u69cb\u4e0a\u4e0d\u6703\u91dd\u5c0d\u5176\u6a21\u7d44\u505a\u592a\u591a\u7684\u5207\u5272\uff0c\u7a0b\u5f0f\u6703\u904b\u884c\u57f7\u884c\u7dd2(Process)\u57f7\u884c\u55ae\u4e00\u7684\u8acb\u6c42\uff0c\u5728\u9032\u884c\u6e2c\u8a66\u8207\u554f\u984c\u6392\u9664\u4e0a\u8f03\u70ba\u7c21\u55ae\uff1b\u5728\u958b\u767c\u5b8c\u7562\u4e4b\u5f8c\u6703\u4f48\u7f72\u5728 VM \u6216\u662f\u6703 IDC \u6a5f\u623f\u4e2d\u63d0\u4f9b\u7d66\u4f7f\u7528\u8005\u4f86\u4f7f\u7528\u3002 \u7b2c\u4e8c\u968e\u6bb5 : \u96a8\u8457\u96f2\u7aef\u6280\u8853\u7684\u63a8\u51fa\uff0c\u4f01\u696d\u958b\u59cb\u5617\u8a66\u5c07\u61c9\u7528\u7a0b\u5f0f\u4f48\u7f72\u5230\u96f2\u7aef\u7684 Iaas \u670d\u52d9\u4e0a\uff0c\u6216\u662f\u7d50\u5408\u516c\u6709\u96f2\u8207\u79c1\u6709\u96f2\u7684\u512a\u52e2\uff0c\u5c07\u4f01\u696d\u4e2d\u6a5f\u5bc6\u8cc7\u6599\u5728\u79c1\u6709\u96f2\u9032\u884c\u8655\u7406\uff0c\u5176\u4ed6\u8cc7\u8a0a\u5728\u516c\u6709\u96f2\u670d\u52d9\u4e0a\u9032\u884c\u904b\u7b97\uff0c\u958b\u767c\u4eba\u54e1\u5728\u61c9\u7528\u7a0b\u5f0f\u7684\u958b\u767c\u8207\u6574\u5408\u4e0a\u6709\u66f4\u591a\u8207 Cloud \u670d\u52d9\u6574\u5408\u7684\u6a5f\u6703\uff0c\u9078\u64c7 Cloud \u4e0a\u9069\u5408\u7684\u670d\u52d9\u4f7f\u7528\u3002 \u7b2c\u4e09\u968e\u6bb5 : \u96f2\u7aef\u6280\u8853\u9010\u6f38\u6210\u719f\u8207\u7a69\u5b9a\uff0c\u66f4\u591a\u7684\u96f2\u7aef\u57fa\u790e\u5efa\u8a2d\u670d\u52d9\u8207\u65b0\u670d\u52d9\u4e0d\u65b7\u7684\u63a8\u51fa\uff0c\u5728\u67b6\u69cb\u8a2d\u8a08\u4e0a\u8d8a\u4f86\u8d8a\u591a\u4eba\u958b\u59cb\u8a0e\u8ad6\u5206\u6563\u5f0f\u7cfb\u7d71\u67b6\u69cb\u7684\u8a2d\u8a08\uff0c\u4e5f\u8d8a\u4f86\u8d8a\u591a\u4eba\u8003\u616e\u5c07\u8cc7\u6599\u5eab\u5f9eIDC\u6a5f\u623f\u9077\u79fb\u5230 Cloud \u96f2\u7aef\u4e0a\uff0c\u52a0\u4e0a\u50cf\u662f RDS\u3001DynamoDB\u3001Redis \u7b49\u96f2\u7aef\u8cc7\u6599\u5eab, \u9019\u4e9b\u670d\u52d9\u6216\u7d44\u4ef6\u8b93\u5927\u5bb6\u5728\u96f2\u7aef\u958b\u767c\u8207\u7ba1\u7406\u4e0a\u66f4\u70ba\u65b9\u4fbf\u3002\u5728\u67b6\u69cb\u4e0a\u4e5f\u66f4\u70ba\u5f48\u6027\u642d\u914d\u8457\u4f01\u696d\u9700\u6c42\u4f86\u4f7f\u7528\uff1b\u5728\u57fa\u790e\u5efa\u8a2d\u4e0a\u4e5f\u4f34\u96a8\u8457\u5bb9\u5668\u5316(dockerize)\u7684\u6280\u8853\u6210\u719f\u958b\u59cb\u9032\u5165\u65b0\u7684\u4e16\u4ee3\u3002 \u7b2c\u56db\u968e\u6bb5 : \u904e\u53bb\u5e7e\u5e74\u5927\u5bb6\u4e00\u76f4\u5728\u8a0e\u8ad6\u8edf\u9ad4\u67b6\u69cb\u5f9e\u55ae\u9ad4\u5230\u5fae\u670d\u52d9 serverless\u3001service meshes \u7b49\u5404\u7a2e\u53ef\u80fd\u7684\u7d44\u5408\uff0c\u4e3b\u8981\u76ee\u7684\u53ef\u80fd\u662f\u5728\u670d\u52d9\u67b6\u69cb\u8a2d\u8a08\u6642\u5982\u4f55\u964d\u4f4e\u670d\u52d9\u4e4b\u9593\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff1b\u5728\u8d8a\u4f86\u8d8a\u591a\u4f01\u696d\u4f7f\u7528\u865b\u64ec\u5bb9\u5668\u6280\u8853 Docker \u5f8c\u767c\u73fe\u7ba1\u7406 Docker \u5be6\u52d9\u4e0a\u662f\u56f0\u96e3\u7684\uff0c\u56e0\u6b64 Kubernetes(K8S) \u958b\u59cb\u76db\u884c\uff0c\u5e6b\u52a9\u5718\u968a\u5728\u8abf\u5ea6 Docker \u4e0a\u66f4\u70ba\u5bb9\u6613\u8207\u9748\u6d3b\uff0c \u4f46\u8207\u6240\u6709\u7f8e\u597d\u4e8b\u7269\u4e00\u6a23\u90fd\u662f\u6709\u4ee3\u50f9\u7684\uff1b\u7576\u670d\u52d9\u8d8a\u5207\u8d8a\u7d30\u6642\uff0c\u5206\u4f48\u5f0f\u7cfb\u7d71\u5e36\u4f86\u4e86\u773e\u591a\u7684\u6311\u6230\u3002\u7576\u958b\u767c\u7684\u4e16\u754c\u8b8a\u5f97\u8907\u96dc\uff0c\u53ef\u80fd\u6703\u5e36\u4f86\u54ea\u4e9b\u5f71\u97ff\u5462 ? \u53ef\u80fd\u6703\u5206\u70ba\u4e09\u500b\u90e8\u5206: \u67b6\u69cb : \u5f9e\u55ae\u9ad4\u5f0f\u67b6\u69cb > SOA > \u5206\u6563\u5f0f\u67b6\u69cb > \u5fae\u670d\u52d9 \u958b\u767c\u4eba\u54e1\u5728\u958b\u767c\u4e0a\u8b8a\u5f97\u66f4\u7e41\u7463\uff0c\u8981\u6ce8\u610f\u7684\u4e8b\u60c5\u8b8a\u5f97\u66f4\u591a\u3002\u4f8b\u5982 : \u670d\u52d9\u5f7c\u6b64\u4e4b\u9593\u7684\u6e9d\u901a\u8981\u5982\u4f55\u9032\u884c ? \u5728\u4e8b\u4ef6\u7684\u7d00\u9304\u4e0a\u8981\u5982\u4f55\u8655\u7406 ? \u7576\u4e00\u500b\u8acb\u6c42\u8981\u7d93\u904e\u591a\u500b\u670d\u52d9\u7684\u6642\u5019\u76f8\u5c0d\u7684\u5ef6\u9072(Lateny)\u4e5f\u6703\u589e\u52a0\uff0c\u670d\u52d9\u7684\u62c6\u5206\u8207\u8acb\u6c42\u6642\u9593\u7684\u90e8\u5206\u8a72\u5982\u4f55\u9054\u5230\u5e73\u8861 ? \u6e2c\u8a66 : \u7576\u7cfb\u7d71\u67b6\u69cb\u8b8a\u5f97\u8907\u96dc\uff0c\u6e2c\u8a66\u4eba\u54e1\u6216\u5718\u968a\u5728\u6e2c\u8a66\u4e0a\u52e2\u5fc5\u9700\u8981\u82b1\u66f4\u591a\u6642\u9593\u4f86\u4e86\u89e3\u65e2\u6709\u67b6\u69cb\u8981\u5982\u4f55\u9032\u884c\u6e2c\u8a66\u3002 \u76e3\u63a7 : \u4e0a\u7dda\u5f8c\u7684\u76e3\u63a7\u6703\u662f\u6700\u5927\u7684\u6311\u6230\uff0c\u7576\u4f60\u6240\u5728\u7684\u7522\u54c1\u670d\u52d9\u662f 7* 24 \u5c0f\u6642\uff0c\u7cfb\u7d71\u67b6\u69cb\u5207\u5206\u5f88\u7d30\u6216\u662f\u5f88\u8907\u96dc\u6642\uff0c\u7576\u4eca\u5929\u67d0\u500b\u670d\u52d9\u6545\u969c\u6642\u8981\u5982\u4f55\u5feb\u901f\u5b9a\u4f4d\u554f\u984c\u8b8a\u7684\u662f\u91cd\u8981\u7684\u95dc\u9375","title":"\u4f01\u696d\u9762\u81e8\u7684\u6311\u6230"},{"location":"kubernetes/observability/tracing/dotnet/modern-monitoring-using-openTelemetry-with-Observability/#facebook","text":"\u6216\u8a31\u4e0a\u9762\u6587\u7ae0\u63d0\u5230\u7684\u90e8\u5206\u6709\u9ede\u62bd\u8c61\uff0c\u6211\u5011\u4f86\u770b\u4e00\u500b\u771f\u5be6\u7684\u6848\u4f8b\uff0c2021/10/4 facebook\u3001whatApp\u53ca IG \u5927\u7576\u6a5f\uff0c\u6574\u500b\u6848\u4ef6\u6839\u672c\u539f\u56e0\u662f\u56e0\u70ba\u5de5\u7a0b\u5e2b\u5728\u90e8\u7f72\u65b0\u529f\u80fd\u6642\u6709\u932f\uff0c\u5c0e\u81f4\u5c0d\u5916 DNS \u670d\u52d9\u7570\u5e38\uff0c\u8a73\u7d30\u53ef\u4ee5\u770b facebook \u5b98\u65b9\u6280\u8853\u90e8\u843d\u683c \u6216 Cloudfare \u7684\u7570\u5e38\u4e8b\u6545\u5831\u544a \u8aaa\u660e\u3002 \u9019\u88e1\u7c21\u55ae\u6574\u7406\u4e8b\u4ef6\u9020\u6210\u7684\u5f71\u97ff: \u4fee\u5fa9\u6642\u9593 : \u5f9e\u554f\u984c\u958b\u59cb\u5230\u6700\u5f8c\u4fee\u5fa9\u5b8c\u6210\u8fd1\u82b1\u8cbb 6 \u5c0f\u6642 \u5f71\u97ff\u4eba\u6578 : \u516b\u5343\u842c\u4eba\u7121\u6cd5\u4f7f\u7528 \u640d\u5931\u91d1\u984d : 10 \u5104\u53f0\u5e63 \u5f71\u97ff\u80a1\u50f9 : \u554f\u984c\u767c\u751f\u5f8c\uff0c\u80a1\u7968\u4e0b\u8dcc 4.89 % \u6700\u91cd\u8981\u7684\u53ef\u80fd\u662f\u5ba2\u6236\u6eff\u610f\u5ea6\uff0c\u4f60\u53ef\u4ee5\u60f3\u50cf\u4e00\u4e0b\u4eca\u5929\u525b\u597d\u5fd9\u788c\u4e00\u5929\u60f3\u6ed1\u4e00\u4e0b\u624b\u6a5f\u770b IG\u3001facebook \u6216\u662f whatApp \u627e\u670b\u53cb\u804a\u5929\u6642\uff0c\u4f46\u767c\u73fe\u9019\u4e9b\u670d\u52d9\u90fd\u6c92\u6709\u8fa6\u6cd5\u4f7f\u7528\u5fc3\u60c5\u6703\u662f\u5982\u4f55 ? \u4f7f\u7528\u8005\u53ef\u80fd\u6703\u8dd1\u53bb\u4f7f\u7528\u5176\u4ed6\u670d\u52d9\uff0cfacebook \u5b98\u65b9\u5728\u670d\u52d9\u7570\u5e38\u5730\u7576\u4e0b\u4e5f\u5728 twitter \u767c\u6587\u8aaa\u660e\u554f\u984c\u8207\u8655\u7406\u7684\u72c0\u6cc1\uff0c\u96a8\u8457\u6642\u9593\u4e00\u5206\u4e00\u79d2\u7684\u904e\u53bb\uff0c\u5ba2\u6236\u9010\u6f38\u5730\u5728\u6d41\u5931\u5230\u5176\u4ed6\u670d\u52d9\u50cf\u662f twitter\uff0c\u5ee3\u544a\u4e3b\u6295\u653e\u7684\u5ee3\u544a\u4e5f\u7121\u6cd5\u6b63\u5e38\u6295\u653e\u3002 \u5f9e\u4e0a\u8ff0\u554f\u984c\u4f86\u770b\uff0c\u5982\u4f55\u8b93\u554f\u984c\u767c\u751f\u6642\u80fd\u5920\u5feb\u901f\u5730\u88ab\u5b9a\u4f4d\u8b8a\u5f97\u66f4\u52a0\u91cd\u8981\uff0c\u5728\u4f01\u696d\u670d\u52d9\u8d8a\u5207\u8d8a\u7d30\u7684\u4e16\u4ee3\uff0c\u6700\u5feb\u6642\u9593\u627e\u5230\u554f\u984c\u8b8a\u5f97\u76f8\u7576\u7684\u95dc\u9375\u3002\u5982\u679c\u4eca\u5929\u662f\u767c\u751f\u5728\u4f60\u7684\u516c\u53f8\u6216\u662f\u8ca0\u8cac\u7684\u7cfb\u7d71\u767c\u751f\u7570\u5e38\u6642\uff0c\u4f60\u8981\u5982\u4f55\u5feb\u901f\u7684\u5b9a\u4f4d\u554f\u984c\u5462 ? \u6839\u64da Google \u95dc\u9375\u5b57\u5831\u544a\u641c\u5c0b \u76e3\u63a7(Monitor) \u95dc\u9375\u5b57\uff0c\u53ef\u4ee5\u767c\u73fe\u5728\u904e\u53bb 20 \u5e74\u7684\u6642\u9593\u5927\u5bb6\u5c0d\u65bc\u61c9\u7528\u7a0b\u5f0f\u7684\u76e3\u63a7\u8d8a\u4f86\u8d8a\u91cd\u8996\uff0c\u80cc\u5f8c\u7684\u6db5\u7fa9\u53ef\u80fd\u662f\u5728\u9019\u8b8a\u5316\u9019\u9ebc\u5feb\u3001\u4e0d\u78ba\u5b9a\u6027\u9019\u9ebc\u9ad8\u3001\u67b6\u69cb\u8d8a\u4f86\u8d8a\u8907\u96dc\u7684\u6642\u4ee3\uff0c\u662f\u5426\u6709\u66f4\u597d\u7684\u65b9\u6cd5\u6216\u65b9\u5f0f\u4f86\u9032\u884c\u76e3\u63a7\uff0c\u6216\u8005\u4e5f\u53ef\u4ee5\u53cd\u554f\uff0c\u6216\u8a31\u5728\u96f2\u539f\u751f(Cloud Native)\u6642\u4ee3\u7684\u76e3\u63a7\uff0c\u61c9\u8a72\u5177\u5099\u751a\u9ebc\u6a23\u7684\u7279\u6027?","title":"\u6848\u4f8b: Facebook \u7576\u6a5f\u4e8b\u4ef6"},{"location":"kubernetes/observability/tracing/dotnet/modern-monitoring-using-openTelemetry-with-Observability/#observability","text":"\u5206\u6563\u5f0f\u7cfb\u7d71\u610f\u5473\u8005\u5206\u6563\u5f0f\u6545\u969c\uff0c\u7576\u51fa\u73fe\u6545\u969c\u6642\uff0c\u53ef\u80fd\u5f88\u96e3\u5feb\u901f\u6062\u5fa9\u670d\u52d9\uff0c\u751a\u81f3\u4e0d\u77e5\u9053\u5f9e\u54ea\u88e1\u958b\u59cb\u3002\u60a8\u5982\u4f55\u89e3\u6790\u9f90\u5927\u7684\u4f9d\u8cf4\u95dc\u4fc2\uff0c\u53d6\u6c7a\u65bc\u4f60\u5c0d\u7cfb\u7d71\u7684\u4e86\u89e3\u8207\u554f\u984c\u5b9a\u4f4d\u6709\u5f88\u5927\u7684\u95dc\u806f\u3002\u53ef\u89c0\u6e2c\u6027\u7c21\u55ae\u4f86\u8aaa\u53ef\u4ee5\u5e6b\u52a9\u958b\u767c\u4eba\u54e1\u6216\u662f SRE \u5925\u4f34\u4e86\u89e3\uff0c\u4ec0\u9ebc\u662f\u6162\u7684 ? \u4ec0\u9ebc\u662f\u58de\u7684 ? \u4ee5\u53ca\u9700\u8981\u505a\u4ec0\u9ebc\u4f86\u63d0\u9ad8\u6027\u80fd\u3002 \u53ef\u89c0\u6e2c\u6027\u4e09\u500b\u91cd\u8981\u7684\u7279\u6027: Metrice \u6307\u6a19: \u7cfb\u7d71\u6709\u72c0\u6cc1 Logs \u65e5\u8a8c: \u554f\u984c\u662f\u751a\u9ebc Traces \u93c8\u8def\u8ffd\u8e2a: \u54ea\u88e1\u51fa\u554f\u984c \u904e\u53bb \u76e3\u63a7 \u53ef\u4ee5\u89e3\u6c7a\u7684\u662f \u5df2\u77e5\u7684\u5df2\u77e5 \u554f\u984c\uff0c \u53ef\u89c0\u6e2c\u6027 \u8981\u89e3\u6c7a\u7684\u662f \u5df2\u77e5\u7684\u672a\u77e5\u7684 \u554f\u984c\uff0c\u90a3\u9ebc\u4ec0\u9ebc\u662f \u5df2\u77e5\u7684\u672a\u77e5 \u5462 ?","title":"\u53ef\u89c0\u6e2c\u6027(Observability)"},{"location":"kubernetes/observability/tracing/java/spring-boot-opentelemetry/","text":"\u4f7f\u7528 GRAFANA \u3001Prometheus \u548c OPENTELEMETRY \u8a2d\u7f6e\u548c\u89c0\u5bdf Spring Boot \u61c9\u7528\u7a0b\u5e8f \u00b6 \u539f\u6587: SET UP AND OBSERVE A SPRING BOOT APPLICATION WITH GRAFANA CLOUD, PROMETHEUS, AND OPENTELEMETRY Spring Boot \u662f\u4e00\u500b\u975e\u5e38\u6d41\u884c\u7684\u5fae\u670d\u52d9\u6846\u67b6\uff0c\u5b83\u901a\u904e\u70ba Java \u958b\u767c\u4eba\u54e1\u63d0\u4f9b\u4e00\u500b\u5e73\u53f0\u4f86\u958b\u59cb\u4f7f\u7528\u53ef\u81ea\u52d5\u914d\u7f6e\u7684\u751f\u7522\u7d1a Spring \u61c9\u7528\u7a0b\u5e8f\uff0c\u5f9e\u800c\u986f\u8457\u7c21\u5316\u4e86 Web \u61c9\u7528\u7a0b\u5e8f\u7684\u958b\u767c\u3002 \u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u8a73\u7d30\u4ecb\u7d39\u5982\u4f55\u89c0\u5bdf Spring Boot \u61c9\u7528\u7a0b\u5e8f\uff0c\u65b9\u6cd5\u662f\u4f7f\u7528 Prometheus \u548c OpenTelementry \u5c0d\u5176\u9032\u884c\u6aa2\u6e2c\uff0c\u4e26\u5f9e Grafana \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u6536\u96c6\u548c\u95dc\u806f\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u8ddf\u8e2a\u3002 \u66f4\u5177\u9ad4\u5730\u8aaa\uff0c\u6211\u5011\u5c07\uff1a \u4f7f\u7528 OpenTelemetry \u6aa2\u6e2c\u4e00\u500b\u7c21\u55ae\u7684 Spring Boot \u61c9\u7528\u7a0b\u5e8f Hello Observability \uff0c\u4e26\u4f7f\u7528 Grafana Agent \u5c07 trace \u6578\u64da\u767c\u9001\u5230 Grafana\u3002 \u81ea\u52d5\u8a18\u9304\u5c0d\u61c9\u7528\u7a0b\u5e8f\u7684\u6bcf\u500b\u8acb\u6c42\uff0c\u4e26\u4f7f\u7528 Grafana Agent \u5c07\u9019\u4e9b\u65e5\u8a8c\u767c\u9001\u5230 Grafana\u3002\u7136\u5f8c\u5c07\u65e5\u8a8c\u8207\u4f86\u81ea\u61c9\u7528\u7a0b\u5e8f\u7684\u8ddf\u8e2a\u548c\u6307\u6a19\u76f8\u95dc\u806f\u3002 \u4f7f\u7528 Prometheus \u4f86\u6aa2\u6e2c\u61c9\u7528\u7a0b\u5e8f\uff0c\u4ee5\u4fbf\u6211\u5011\u53ef\u4ee5\u6536\u96c6\u6307\u6a19\uff0c\u4e26\u5c07\u6307\u6a19\u8207\u5229\u7528 Grafana exemplars \u8ddf\u8e2a\u76f8\u95dc\u806f\u3002 \u975e\u5e38\u4ee4\u4eba\u8208\u596e\uff01\u8b93\u6211\u5148\u4ecb\u7d39\u4e00\u4e0b\u975e\u5e38\u7c21\u55ae\u7684 Spring Boot \u61c9\u7528\u7a0b\u5e8f Hello Observability\u3002 Spring Boot \u61c9\u7528\u7a0b\u5e8f\u7c21\u4ecb \u00b6 Hello Observability \u61c9\u7528\u7a0b\u5e8f\u975e\u5e38\u7c21\u55ae\u3002\u5b83\u4e3b\u8981\u5305\u542b\u4e00\u500b Java \u985e HelloObservabilityBootApp\uff0c\u5176\u4e2d\u5305\u542b\u5169\u500b\u53ef\u4ee5\u670d\u52d9 HTTP \u8acb\u6c42\u7684\u65b9\u6cd5\u3002 Clone \u5b58\u5132\u5eab\u67e5\u770b\u4ee3\u78bc\uff0c\u7136\u5f8c\u69cb\u5efa\u61c9\u7528\u7a0b\u5e8f\u548c\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\uff1a $ git clone https://github.com/adamquan/hello-observability.git $ cd hello-observability/hello-observability $ ./mvnw package $ docker build -t hello-observability . \u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u76f4\u63a5\u904b\u884c\u8a72\u61c9\u7528\u7a0b\u5e8f\u4e26\u5728\u6b64\u8655\u8a2a\u554f\u5b83\uff1a http://localhost:8080/hello \u3002\u975e\u5e38\u7c21\u55ae\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u78ba\u5be6\uff01 $ java -jar target/*.jar \u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5728 Docker \u5bb9\u5668\u4e2d\u904b\u884c\u5b83\uff0c\u4e26\u5728\u6b64\u8655\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff1a http://localhost:8080/hello $ docker run -d -p 8080 :8080 --name hello-observability hello-observability \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u505c\u6b62 docker \u5bb9\u5668\uff1a docker stop hello-observability \u5230\u76ee\u524d\u70ba\u6b62\uff0c\u6211\u5011\u9084\u6c92\u6709\u9032\u884c\u4efb\u4f55\u5de5\u5177\u4f86\u6536\u96c6\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u8ddf\u8e2a\u3002\u70ba\u6b64\uff0c\u60a8\u5fc5\u9808\u4f7f\u7528 docker-compose \u555f\u52d5\u6240\u6709\u670d\u52d9\u3002\u751f\u6210\u548c\u6536\u96c6\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u8ddf\u8e2a\u6240\u9700\u7684\u6240\u6709\u914d\u7f6e\u5747\u5df2\u914d\u7f6e\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5728 Docker \u4e2d\u672c\u5730\u904b\u884c\u6574\u500b\u5806\u68e7\u4ee5\u67e5\u770b\u5b83\u7684\u904b\u884c\u60c5\u6cc1\u3002\u6574\u500b\u5806\u68e7\u5305\u542b\uff1a The Hello Observability application A simple load runner Prometheus for metrics Grafana Loki for logs Grafana Tempo for traces Grafana Agent to collect logs, metrics, and traces Grafana cd hello-observability/local docker-compose up \u6240\u6709\u5bb9\u5668\u90fd\u555f\u52d5\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728\u6b64\u8655\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff1a http://localhost:8080/hello \u548c Grafana\uff1a http://localhost:3000 \u3002\u9084\u9810\u52a0\u8f09\u4e86\u4e00\u500b\u540d\u70ba Hello Observability \u7684\u5100\u8868\u677f\u3002 \u5e0c\u671b\u9019\u80fd\u8b93\u4f60\u8208\u596e\uff01\u5728\u67e5\u770b\u5100\u5668\u8a73\u7d30\u4fe1\u606f\u4e4b\u524d\uff0c\u6211\u5011\u5c07\u5728\u63a5\u4e0b\u4f86\u5feb\u901f\u4ecb\u7d39 Grafana Cloud \u548c Grafana Agent\u3002","title":"SpringBoot"},{"location":"kubernetes/observability/tracing/java/spring-boot-opentelemetry/#grafana-prometheus-opentelemetry-spring-boot","text":"\u539f\u6587: SET UP AND OBSERVE A SPRING BOOT APPLICATION WITH GRAFANA CLOUD, PROMETHEUS, AND OPENTELEMETRY Spring Boot \u662f\u4e00\u500b\u975e\u5e38\u6d41\u884c\u7684\u5fae\u670d\u52d9\u6846\u67b6\uff0c\u5b83\u901a\u904e\u70ba Java \u958b\u767c\u4eba\u54e1\u63d0\u4f9b\u4e00\u500b\u5e73\u53f0\u4f86\u958b\u59cb\u4f7f\u7528\u53ef\u81ea\u52d5\u914d\u7f6e\u7684\u751f\u7522\u7d1a Spring \u61c9\u7528\u7a0b\u5e8f\uff0c\u5f9e\u800c\u986f\u8457\u7c21\u5316\u4e86 Web \u61c9\u7528\u7a0b\u5e8f\u7684\u958b\u767c\u3002 \u5728\u672c\u6587\u4e2d\uff0c\u6211\u5011\u5c07\u8a73\u7d30\u4ecb\u7d39\u5982\u4f55\u89c0\u5bdf Spring Boot \u61c9\u7528\u7a0b\u5e8f\uff0c\u65b9\u6cd5\u662f\u4f7f\u7528 Prometheus \u548c OpenTelementry \u5c0d\u5176\u9032\u884c\u6aa2\u6e2c\uff0c\u4e26\u5f9e Grafana \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u6536\u96c6\u548c\u95dc\u806f\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u8ddf\u8e2a\u3002 \u66f4\u5177\u9ad4\u5730\u8aaa\uff0c\u6211\u5011\u5c07\uff1a \u4f7f\u7528 OpenTelemetry \u6aa2\u6e2c\u4e00\u500b\u7c21\u55ae\u7684 Spring Boot \u61c9\u7528\u7a0b\u5e8f Hello Observability \uff0c\u4e26\u4f7f\u7528 Grafana Agent \u5c07 trace \u6578\u64da\u767c\u9001\u5230 Grafana\u3002 \u81ea\u52d5\u8a18\u9304\u5c0d\u61c9\u7528\u7a0b\u5e8f\u7684\u6bcf\u500b\u8acb\u6c42\uff0c\u4e26\u4f7f\u7528 Grafana Agent \u5c07\u9019\u4e9b\u65e5\u8a8c\u767c\u9001\u5230 Grafana\u3002\u7136\u5f8c\u5c07\u65e5\u8a8c\u8207\u4f86\u81ea\u61c9\u7528\u7a0b\u5e8f\u7684\u8ddf\u8e2a\u548c\u6307\u6a19\u76f8\u95dc\u806f\u3002 \u4f7f\u7528 Prometheus \u4f86\u6aa2\u6e2c\u61c9\u7528\u7a0b\u5e8f\uff0c\u4ee5\u4fbf\u6211\u5011\u53ef\u4ee5\u6536\u96c6\u6307\u6a19\uff0c\u4e26\u5c07\u6307\u6a19\u8207\u5229\u7528 Grafana exemplars \u8ddf\u8e2a\u76f8\u95dc\u806f\u3002 \u975e\u5e38\u4ee4\u4eba\u8208\u596e\uff01\u8b93\u6211\u5148\u4ecb\u7d39\u4e00\u4e0b\u975e\u5e38\u7c21\u55ae\u7684 Spring Boot \u61c9\u7528\u7a0b\u5e8f Hello Observability\u3002","title":"\u4f7f\u7528 GRAFANA \u3001Prometheus \u548c OPENTELEMETRY \u8a2d\u7f6e\u548c\u89c0\u5bdf Spring Boot \u61c9\u7528\u7a0b\u5e8f"},{"location":"kubernetes/observability/tracing/java/spring-boot-opentelemetry/#spring-boot","text":"Hello Observability \u61c9\u7528\u7a0b\u5e8f\u975e\u5e38\u7c21\u55ae\u3002\u5b83\u4e3b\u8981\u5305\u542b\u4e00\u500b Java \u985e HelloObservabilityBootApp\uff0c\u5176\u4e2d\u5305\u542b\u5169\u500b\u53ef\u4ee5\u670d\u52d9 HTTP \u8acb\u6c42\u7684\u65b9\u6cd5\u3002 Clone \u5b58\u5132\u5eab\u67e5\u770b\u4ee3\u78bc\uff0c\u7136\u5f8c\u69cb\u5efa\u61c9\u7528\u7a0b\u5e8f\u548c\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\uff1a $ git clone https://github.com/adamquan/hello-observability.git $ cd hello-observability/hello-observability $ ./mvnw package $ docker build -t hello-observability . \u7136\u5f8c\uff0c\u60a8\u53ef\u4ee5\u76f4\u63a5\u904b\u884c\u8a72\u61c9\u7528\u7a0b\u5e8f\u4e26\u5728\u6b64\u8655\u8a2a\u554f\u5b83\uff1a http://localhost:8080/hello \u3002\u975e\u5e38\u7c21\u55ae\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u78ba\u5be6\uff01 $ java -jar target/*.jar \u60a8\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5728 Docker \u5bb9\u5668\u4e2d\u904b\u884c\u5b83\uff0c\u4e26\u5728\u6b64\u8655\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff1a http://localhost:8080/hello $ docker run -d -p 8080 :8080 --name hello-observability hello-observability \u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u505c\u6b62 docker \u5bb9\u5668\uff1a docker stop hello-observability \u5230\u76ee\u524d\u70ba\u6b62\uff0c\u6211\u5011\u9084\u6c92\u6709\u9032\u884c\u4efb\u4f55\u5de5\u5177\u4f86\u6536\u96c6\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u8ddf\u8e2a\u3002\u70ba\u6b64\uff0c\u60a8\u5fc5\u9808\u4f7f\u7528 docker-compose \u555f\u52d5\u6240\u6709\u670d\u52d9\u3002\u751f\u6210\u548c\u6536\u96c6\u65e5\u8a8c\u3001\u6307\u6a19\u548c\u8ddf\u8e2a\u6240\u9700\u7684\u6240\u6709\u914d\u7f6e\u5747\u5df2\u914d\u7f6e\u3002 \u73fe\u5728\u8b93\u6211\u5011\u5728 Docker \u4e2d\u672c\u5730\u904b\u884c\u6574\u500b\u5806\u68e7\u4ee5\u67e5\u770b\u5b83\u7684\u904b\u884c\u60c5\u6cc1\u3002\u6574\u500b\u5806\u68e7\u5305\u542b\uff1a The Hello Observability application A simple load runner Prometheus for metrics Grafana Loki for logs Grafana Tempo for traces Grafana Agent to collect logs, metrics, and traces Grafana cd hello-observability/local docker-compose up \u6240\u6709\u5bb9\u5668\u90fd\u555f\u52d5\u5f8c\uff0c\u60a8\u53ef\u4ee5\u5728\u6b64\u8655\u8a2a\u554f\u61c9\u7528\u7a0b\u5e8f\uff1a http://localhost:8080/hello \u548c Grafana\uff1a http://localhost:3000 \u3002\u9084\u9810\u52a0\u8f09\u4e86\u4e00\u500b\u540d\u70ba Hello Observability \u7684\u5100\u8868\u677f\u3002 \u5e0c\u671b\u9019\u80fd\u8b93\u4f60\u8208\u596e\uff01\u5728\u67e5\u770b\u5100\u5668\u8a73\u7d30\u4fe1\u606f\u4e4b\u524d\uff0c\u6211\u5011\u5c07\u5728\u63a5\u4e0b\u4f86\u5feb\u901f\u4ecb\u7d39 Grafana Cloud \u548c Grafana Agent\u3002","title":"Spring Boot \u61c9\u7528\u7a0b\u5e8f\u7c21\u4ecb"},{"location":"kubernetes/package/","text":"\u7ba1\u7406 Kubernetes \u8cc7\u6e90\u7684\u56db\u7a2e\u65b9\u5f0f \u00b6 \u539f\u6587: 4 ways to manage Kubernetes resources \u96f2\u539f\u751f\u61c9\u7528\u65e5\u8da8\u8907\u96dc\uff0c\u50c5\u50c5\u901a\u904e Kubernetes \u5c0d\u8c61\u53ca Yaml \u5f88\u96e3\u6e05\u6670\u7684\u63cf\u8ff0\u4e00\u500b\u8907\u96dc\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u6240\u4ee5\u8a95\u751f Kustomize, Helm \u8207 Operator\u3002 Kustomize \u662f\u7528\u65bc\u81ea\u5b9a\u7fa9 Kubernetes \u914d\u7f6e\u7684\u5de5\u5177\u3002 Helm \u4e3b\u8981\u5be6\u73fe\u662f\u96f2\u539f\u751f\u61c9\u7528\u6253\u5305\u548c\u7248\u672c\u7ba1\u7406\u7b49\u3002 Operator \u672c\u8cea\u662f\u4e00\u7a2e\u8abf\u7bc0\u5668\u6a21\u5f0f\uff08Reconciler Pattern\uff09\u7684\u61c9\u7528\uff0c\u4e3b\u8981\u5be6\u73fe\u96f2\u539f\u751f\u61c9\u7528\u7ba1\u7406\uff0c\u5c24\u5176\u662f\u6709\u72c0\u614b\u61c9\u7528\u7ba1\u7406\uff0c\u5354\u8abf\u61c9\u7528\u7684\u5be6\u969b\u72c0\u614b\u9054\u5230\u9810\u671f\u72c0\u614b\u3002 \u672c\u6587\u5c07\u4ecb\u7d394\u7a2e\u7ba1\u7406 Kubernetes \u8cc7\u6e90\u7684\u65b9\u6cd5\u548c\u5de5\u5177\uff0c\u6bcf\u4e00\u7a2e\u65b9\u6cd5\u548c\u5de5\u5177\u90fd\u662f\u70ba\u8655\u65bc Kubernetes \u65c5\u7a0b\u4e0d\u540c\u968e\u6bb5\u7684\u7d44\u7e54\u6e96\u5099\u7684\u3002 Kubectl\uff0c\u65b0\u7684 ssh \u00b6 \u7576\u958b\u59cb\u63a5\u89f8 Linux \u7cfb\u7d71\u6642\uff0c\u9996\u5148\u8981\u4e86\u89e3\u7684\u5de5\u5177\u662f ssh\u3002\u9019\u662f\u4e00\u500b\u5f37\u5927\u7684\u8edf\u4ef6\u3002\u4f60\u4e0d\u50c5\u53ef\u4ee5\u767b\u9304\u5230\u4f60\u7684\u670d\u52d9\u5668\uff0c\u8907\u88fd\u6587\u4ef6\uff0c\u9084\u53ef\u4ee5\u5275\u5efa vpn\uff0c\u9032\u884c SOCKS \u4ee3\u7406\u548c\u7aef\u53e3\u8f49\u767c\u898f\u5247\u7684\u9632\u706b\u7246\uff0c\u7b49\u7b49\u3002 \u4f46\u662f\uff0c\u5c0d\u65bc Kubernetes\uff0c\u53ef\u4ee5\u4f7f\u7528 kubectl\uff0c\u5b83\u662f\u65b0\u7684 ssh\u3002\u5982\u679c\u4f60\u4e0d\u76f4\u63a5\u4f7f\u7528 API \u8abf\u7528\uff0c\u90a3\u9ebc\u4f60\u53ef\u80fd\u6703\u4ee5\u67d0\u7a2e\u5f62\u5f0f\u4f7f\u7528\u5b83\uff0c\u4e26\u70ba\u5b83\u63d0\u4f9b\u5927\u91cf\u7684 yaml \u6587\u4ef6\u3002\u9019\u5c31\u662f\u5982\u4eca\u7ba1\u7406 Kubernetes \u74b0\u5883\u7684\u6a23\u5b50\u3002 \u4f60\u7528 Kubernetes \u7684\u8cc7\u6e90\u5b9a\u7fa9\u5275\u5efa\u4e86\u90a3\u4e9b\u6f02\u4eae\u7684\u3001\u5197\u9577\u7684\u6587\u672c\u6587\u4ef6\uff0c\u7136\u5f8c\u5c07\u61c9\u7528\u4f48\u7f72\u9032 Kubernetes \u7684\u96c6\u7fa4\u4e2d\u3002 \u7136\u800c\u7576\u4f60\u60f3\u8981\u5275\u5efa\u7684\u4e0d\u662f\u4e00\u500b\u800c\u662f\u6578\u5341\u500b\u6216\u6578\u767e\u500b\u5177\u6709\u4e0d\u540c\u914d\u7f6e\u7684\u61c9\u7528\u7684\u6642\u5019\uff0c\u4e8b\u60c5\u5c31\u6703\u8b8a\u5f97\u6108\u4f86\u6108\u8907\u96dc\u3002 \u7c21\u55ae vs \u9748\u6d3b \u00b6 \u5c0d\u65bc\u57fa\u672c\u5834\u666f\uff0ckubectl \u52a0\u4e0a\u7c21\u55ae\u7684 yaml \u6587\u4ef6\u5c31\u8db3\u5920\u4e86\u3002\u7136\u800c\uff0c\u96a8\u8457\u74b0\u5883\u7684\u589e\u9577\uff0c\u8cc7\u6e90\u548c\u914d\u7f6e\u7684\u6578\u91cf\u4e5f\u5728\u589e\u9577\u3002\u4f60\u53ef\u80fd\u6703\u958b\u59cb\u6ce8\u610f\u5230\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u7684\u65b0\u5be6\u4f8b\u3001\u91cd\u65b0\u914d\u7f6e\u5df2\u7d93\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u3001\u8207\u793e\u5340\u6216\u5e0c\u671b\u6839\u64da\u9700\u8981\u81ea\u5b9a\u7fa9\u61c9\u7528\u7a0b\u5e8f\u7684\u5ba2\u6236\u5171\u4eab\u61c9\u7528\u7a0b\u5e8f\u6240\u82b1\u8cbb\u7684\u6642\u9593\u66f4\u591a\u3002 \u76ee\u524d\uff0c\u6211\u767c\u73fe\u4ee5\u4e0b\u662f\u6700\u5e38\u7528\u7684\u65b9\u6cd5: \u7d14 yaml \u6587\u4ef6 Kustomize Helm Charts \u81ea\u52d5\u5316 Operator \u5b83\u5011\u90fd\u53ef\u4ee5\u7528\u4f86\u7ba1\u7406\u4f60\u5728 Kubernetes \u88e1\u982d\u7684\u8cc7\u6e90\uff0c\u7136\u800c\u5b83\u5011\u5728\u8a31\u591a\u65b9\u9762\u4e5f\u6709\u6240\u4e0d\u540c\u8a2d\u8a08\u8207\u5b9a\u4f4d\u3002\u5176\u4e2d\u4e00\u500b\u660e\u986f\u7684\u56e0\u7d20\u662f\u8907\u96dc\u6027\uff0c\u9019\u4e5f\u610f\u5473\u8457\u9700\u8981\u82b1\u8cbb\u5f88\u591a\u7cbe\u529b\u4f86\u5b78\u7fd2\u3001\u4f7f\u7528\u548c\u7dad\u8b77\u4e00\u500b\u7279\u5b9a\u7684\u65b9\u6cd5\u3002 \u53e6\u4e00\u65b9\u9762\uff0c\u7576\u4f60\u771f\u6b63\u60f3\u8981\u5275\u5efa\u8907\u96dc\u7684\u914d\u7f6e\u6642\uff0c\u5f9e\u9577\u9060\u4f86\u770b\uff0c\u9019\u6a23\u505a\u53ef\u80fd\u6703\u6709\u597d\u8655\u3002\u4f60\u53ef\u4ee5\u5728\u4e0b\u5716\u4e2d\u89c0\u5bdf\u5230\u9019\u7a2e\u95dc\u4fc2: \u6240\u4ee5\u5728 \u9748\u6d3b\u6027 \u548c \u7c21\u55ae\u6027 \u4e4b\u9593\u5b58\u5728\u6b0a\u8861\u3002\u5c0d\u4e00\u4e9b\u4eba\u4f86\u8aaa\uff0c\u7c21\u55ae\u662f\u53ef\u4ee5\u53d6\u52dd\u7684\uff0c\u4f46\u5c0d\u53e6\u4e00\u4e9b\u4eba\u4f86\u8aaa\uff0c\u9019\u9084\u9060\u9060\u4e0d\u5920\u3002\u8b93\u6211\u5011\u4ed4\u7d30\u770b\u770b\u9019\u56db\u7a2e\u65b9\u6cd5\uff0c\u770b\u770b\u5b83\u5011\u5728\u54ea\u4e9b\u60c5\u6cc1\u4e0b\u6700\u9069\u5408\u3002 1\u3001\u4f7f\u7528\u7d14 yaml \u6587\u4ef6\u4fdd\u6301\u7c21\u55ae \u00b6 \u6211\u7e3d\u662f\u544a\u8a34\u53c3\u52a0\u6211\u7684\u8ab2\u7a0b\u7684\u4eba\uff0c\u901a\u904e\u5b78\u7fd2 Kubernetes\uff0c\u4ed6\u5011\u53ef\u4ee5\u6210\u70ba yaml\u7a0b\u5e8f\u54e1\u3002\u9019\u53ef\u80fd\u807d\u8d77\u4f86\u5f88\u50bb\uff0c\u4f46\u5be6\u969b\u4e0a\uff0cKubernetes \u7684\u57fa\u672c\u7528\u6cd5\u6b78\u6839\u7d50\u5e95\u5c31\u662f\u7528 yaml \u7de8\u5beb\u4e00\u4e9b\u5c0d\u8c61\u7684\u5b9a\u7fa9\u3002\u7576\u7136\uff0c\u4f60\u5fc5\u9808\u77e5\u9053\u5169\u4ef6\u4e8b: \u7b2c\u4e00\u4ef6\u662f\u4f60\u60f3\u8981\u5275\u5efa\u4ec0\u9ebc \u7b2c\u4e8c\u4ef6\u662f\u95dc\u65bc Kubernetes API \u7684\u77e5\u8b58\uff0c\u5b83\u662f\u9019\u4e9b yaml \u6587\u4ef6\u7684\u57fa\u790e\u3002 \u5728\u4f60\u5b78\u7fd2\u77ad\u5982\u4f55\u7de8\u5beb yaml \u6587\u4ef6\u4e4b\u5f8c\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl \u5c07\u5176\u767c\u9001\u5230 Kubernetes\uff0c\u9019\u6a23\u4f60\u7684\u5de5\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002\u6c92\u6709\u53c3\u6578\uff0c\u6c92\u6709\u6a21\u677f\uff0c\u4e5f\u4e0d\u77e5\u9053\u5982\u4f55\u6539\u8b8a\u5b83\u3002\u5982\u679c\u4f60\u60f3\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u6216\u6574\u500b\u74b0\u5883\u7684\u9644\u52a0\u5be6\u4f8b\uff0c\u53ea\u9700\u8907\u5236\u548c\u7c98\u8cbc\u5373\u53ef\u3002 \u7576\u7136\uff0c\u9019\u88e1\u6703\u6709\u4e00\u4e9b\u91cd\u8907\uff0c\u4f46\u9019\u662f\u70ba\u4e86\u7c21\u55ae\u6240\u4ed8\u51fa\u7684\u4ee3\u50f9\u3002\u6b64\u5916\uff0c\u5728\u4e00\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e0d\u662f\u4ec0\u9ebc\u5927\u554f\u984c\uff0c\u5927\u591a\u6578\u7d44\u7e54\u53ef\u80fd\u53ef\u4ee5\u63a5\u53d7\u9019\u500b\u4e0d\u5b8c\u7f8e\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u81f3\u5c11\u5728\u4ed6\u5011\u65c5\u9014\u4e0d\u76e1\u5982\u4eba\u610f\u7684\u6642\u5019\u662f\u53ef\u4ee5\u7684\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5c0d\u65bc\u61c9\u7528\u7a0b\u5e8f\u6216\u74b0\u5883\u7684\u914d\u7f6e/\u5be6\u4f8b\u5c11\u65bc 4 \u500b\u7684\u9805\u76ee \u5c0d\u65bc\u5c0f\u578b\u5275\u696d\u516c\u53f8 \u5927\u516c\u53f8\u958b\u59cb\u4ed6\u5011\u7684\u7b2c\u4e00\u500b Kubernetes \u9805\u76ee\uff08\u4f8b\u5982\u4f5c\u70ba PoC \u7684\u4e00\u90e8\u5206\uff09 \u5b78\u7fd2 Kubernetes API \u7684\u500b\u4eba \u4f55\u6642\u907f\u514d\uff1a \u767c\u5e03\u91dd\u5c0d Kubernetes \u74b0\u5883\u7684\u7522\u54c1\u6216\u670d\u52d9\u7684\u7d44\u7e54\u548c\u9805\u76ee \u5728\u9805\u76ee\u4e2d\uff0c\u6bcf\u500b\u5be6\u4f8b\u90fd\u6709\u5f88\u5927\u7684\u5dee\u7570\uff0c\u9700\u8981\u5927\u91cf\u7684\u8abf\u6574 2\u3001\u4f7f\u7528 Kustomize \u00b6 Kustomize \u662f Kubernetes \u5b98\u65b9\u5718\u9ad4\u4e4b\u4e00\u7684\u4e00\u500b\u9805\u76ee\u3002\u5b83\u5b9a\u7fa9\u4e86\u57fa\u65bc\u7e7c\u627f\u7684 Kubernetes \u8cc7\u6e90\u7684\u6982\u5ff5\uff0cyaml \u6587\u4ef6\uff0c\u6c92\u932f\u2014\u2014\u4f60\u9003\u4e0d\u6389\u7684\u3002\u4f46\u662f\uff0c\u9019\u4e00\u6b21\uff0c\u4f7f\u7528 Kustomize\uff0c\u4f60\u53ef\u4ee5\u5c0d\u5df2\u7d93\u5b58\u5728\u7684\u8cc7\u6e90\u96c6\u61c9\u7528\u4efb\u4f55\u4f60\u60f3\u8981\u7684\u66f4\u6539\u3002 \u7c21\u55ae\u5730\u8aaa\uff0cKustomize \u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u500b Kubernetes \u7279\u6709\u7684\u88dc\u4e01\u5de5\u5177\u3002\u5b83\u8b93\u4f60\u8986\u84cb\u6240\u6709\u90e8\u5206\u7684 yaml \u6587\u4ef6\u8207\u5176\u4ed6\u529f\u80fd\uff0c\u5305\u62ec\u4ee5\u4e0b\uff1a \u66f4\u6539\u5bb9\u5668\u93e1\u50cf\u7684\u5b58\u5132\u5eab\u3001\u540d\u7a31\u548c\u6a19\u8a18 \u76f4\u63a5\u5f9e\u6587\u4ef6\u751f\u6210 ConfigMap \u5c0d\u8c61\uff0c\u4e26\u751f\u6210\u6563\u5217\uff0c\u78ba\u4fdd\u90e8\u7f72\u5728\u767c\u751f\u66f4\u6539\u6642\u89f8\u767c\u65b0\u7684 rollout \u4f7f\u7528 kustomize cli \u52d5\u614b\u4fee\u6539\u914d\u7f6e\uff08\u5728 CI/CD \u7ba1\u9053\u4e2d\u975e\u5e38\u6709\u7528\uff09 \u5f9e 1.14 \u7248\u958b\u59cb\uff0c\u5b83\u5c31\u5167\u7f6e\u5728 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u4e2d\uff0c\u9019\u4f7f\u5b83\u5f88\u5bb9\u6613\u958b\u59cb\u3002\u4e0d\u5e78\u7684\u662f\uff0c\u5728\u7368\u7acb\u7684 kustomize \u9805\u76ee\u4e2d\u6dfb\u52a0\u65b0\u7279\u6027\u7684\u901f\u5ea6\u8981\u5feb\u5f97\u591a\uff0c\u800c\u4e14\u5b83\u7684\u767c\u5e03\u9031\u671f\u8207 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u7684\u5b98\u65b9\u7248\u672c\u4e0d\u540c\u6b65\u3002\u56e0\u6b64\uff0c\u6211\u5f37\u70c8\u5efa\u8b70\u4f7f\u7528\u5b83\u7684\u7368\u7acb\u7248\u672c\uff0c\u800c\u4e0d\u662f kubectl \u7684\u5167\u7f6e\u529f\u80fd\u3002 \u6839\u64da\u5176\u5275\u5efa\u8005\u7684\u8aaa\u6cd5\uff0c\u5b83\u9f13\u52f5\u4f60\u76f4\u63a5\u4f7f\u7528 Kubernetes API\uff0c\u800c\u7121\u9700\u5275\u5efa\u53e6\u4e00\u500b\u4eba\u5de5\u62bd\u8c61\u5c64\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5c0d\u65bc\u4e0d\u9700\u8981\u592a\u591a\u53c3\u6578\u7684\u5c11\u65bc 10 \u500b\u914d\u7f6e/\u5be6\u4f8b\u7684\u9805\u76ee \u5c0d\u65bc\u958b\u59cb\u6210\u9577\u4f46\u4ecd\u5728\u5167\u90e8\u4f7f\u7528 Kubernetes \u7684\u521d\u5275\u516c\u53f8\uff08\u5373\u4e0d\u9700\u8981\u5c07\u6e05\u55ae\u4f5c\u70ba\u5176\u7522\u54c1\u7684\u4e00\u90e8\u5206\uff09 \u5c0d\u65bc\u4efb\u4f55\u77e5\u9053 Kubernetes API \u7684\u4eba\u4f86\u8aaa\uff0c\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b83 \u4f55\u6642\u907f\u514d\uff1a - \u5982\u679c\u4f60\u7684\u74b0\u5883\u6216\u5be6\u4f8b\u6700\u591a\u8b8a\u5316 30-50%\uff0c\u56e0\u70ba\u4f60\u53ea\u9700\u901a\u904e\u6dfb\u52a0\u88dc\u4e01\u4f86\u91cd\u5beb\u5927\u90e8\u5206\u6e05\u55ae - \u8207\u666e\u901a yamls \u7684\u60c5\u6cc1\u76f8\u540c 3\u3001\u9032\u968e\uff0c\u5f37\u5927\u7684 Helm Charts \u00b6 \u5982\u679c\u4f60\u9084\u6c92\u6709\u898b\u904e Artifiact Hub \uff0c\u90a3\u9ebc\u6211\u5efa\u8b70\u4f60\u53bb\u770b\u770b\uff0c\u4e26\u5c0b\u627e\u4f60\u6700\u559c\u6b61\u7684\u8edf\u4ef6\uff0c\u7279\u5225\u662f\u5982\u679c\u5b83\u662f\u4e00\u500b\u6d41\u884c\u7684\u958b\u6e90\u9805\u76ee\uff0c\u6211\u975e\u5e38\u78ba\u5b9a\u5b83\u5728\u90a3\u88e1\u3002\u96a8\u8457 Helm 3 \u7684\u767c\u4f48\uff0c\u5b83\u7684\u5927\u90e8\u5206\u7f3a\u9677\u90fd\u5f97\u5230\u4e86\u4fee\u5fa9\u3002\u5be6\u969b\u4e0a\uff0c\u6700\u5927\u7684\u7d44\u4ef6\u662f\u4e0d\u518d\u9700\u8981\u7684 Tiller \u7d44\u4ef6\uff0c\u9019\u4f7f\u5176\u6210\u70ba\u4f60\u90e8\u7f72\u7684\u7d55\u4f73\u5de5\u5177\u3002\u56e0\u70ba\u5b83\u7684\u6a21\u677f\u7cfb\u7d71\u592a\u7c21\u55ae\u4e86\uff08\u6211\u76e1\u91cf\u907f\u514d\u4f7f\u7528\u201c\u7cdf\u7cd5\u201d\u9019\u500b\u8a5e\uff0c\u4f46\u5b83\u78ba\u5be6\u5f88\u7c21\u55ae\uff09\u3002 \u5927\u591a\u6578\u5df2\u7d93\u958b\u59cb\u4f7f\u7528 Helm \u90e8\u7f72\u670d\u52d9\u7684\u4eba\u5e38\u5e38\u958b\u59cb\u70ba\u61c9\u7528\u7a0b\u5e8f\u7de8\u5beb\u81ea\u5df1\u7684 chart\uff0c\u4ee5\u53ca\u5728 Kubernetes \u4e0a\u90e8\u7f72\u7684\u5e7e\u4e4e\u6240\u6709\u6771\u897f\u3002\u5c0d\u65bc\u975e\u5e38\u8907\u96dc\u7684\u914d\u7f6e\u4f86\u8aaa\uff0c\u9019\u53ef\u80fd\u662f\u4e00\u500b\u597d\u4e3b\u610f\uff0c\u4f46\u662f\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u9019\u662f\u591a\u9918\u7684\u3002\u5982\u679c\u4f60\u6c92\u6709\u5c07Chart\u767c\u4f48\u5230\u67d0\u500b Reistry Repository\uff0c\u800c\u53ea\u662f\u4f7f\u7528\u5b83\u5011\u7684\u6a21\u677f\u7279\u6027\uff0c\u90a3\u9ebc\u4f7f\u7528 Kustomize \u53ef\u80fd\u6703\u66f4\u597d\u7684\u9078\u64c7\u3002 \u7136\u800c\uff0c\u5c0d\u65bc\u9ad8\u7d1a\u5834\u666f\uff0cHelm \u662f\u6b63\u78ba\u7684\u9078\u64c7\u3002\u5b83\u53ef\u4ee5\u662f\u4f60\u7528\u4f86\u767c\u5e03\u61c9\u7528\u7a0b\u5e8f\u4ee5\u4f9b\u5176\u4ed6\u5718\u968a\u5c07\u5176\u90e8\u7f72\u5230\u5176\u74b0\u5883\u4e2d\u7684\u55ae\u4e00\u5de5\u5177\u3002\u4f60\u7684\u5ba2\u6236\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b\u7c21\u55ae\u7684\u547d\u4ee4\u4f86\u90e8\u7f72\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u4e00\u500b\u65b0\u7248\u672c\u3002 \u4ee5\u80fd\u5920\u8655\u7406\u6240\u6709\u9019\u4e9b\u60c5\u6cc1\u548c\u914d\u7f6e\u8b8a\u91cf\u7684\u65b9\u5f0f\u7de8\u5beb Chart \u6a21\u677f \u4f7f\u7528 CI/CD \u7ba1\u9053\u3001\u6e2c\u8a66\u548c\u767c\u5e03\u4f86\u5275\u5efa\u548c\u7dad\u8b77\u6574\u500b\u767c\u5e03\u904e\u7a0b Artifiact Hub \u4e0a\u7684\u8a31\u591a\u793a\u4f8b\u986f\u793a\u5982\u4f55\u5c07\u5fa9\u96dc\u7684\u8edf\u4ef6\u6253\u5305\u5230\u4e00\u500b Chart \u4e2d\uff0c\u5f9e\u800c\u4f7f\u5b89\u88dd\u904e\u7a0b\u8b8a\u5f97\u975e\u5e38\u7c21\u55ae\uff0c\u4e26\u4f7f\u5b9a\u5236\u8b8a\u5f97\u66f4\u5bb9\u6613\u8a2a\u554f\uff0c\u7279\u5225\u662f\u5c0d\u65bc\u4e0d\u60f3\u6df1\u5165\u4e86\u89e3\u592a\u591a\u7d30\u7bc0\u7684\u6700\u7d42\u7528\u6236\u3002\u6211\u81ea\u5df1\u4e5f\u4f7f\u7528\u8a31\u591a Helm Charts \u4f86\u5b89\u88dd\u8edf\u4ef6\uff0c\u4e26\u5c07\u5176\u8996\u70ba Kubernetes \u751f\u614b\u7cfb\u7d71\u4e2d\u6700\u91cd\u8981\u7684\u9805\u76ee\u4e4b\u4e00\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5c0d\u65bc\u64c1\u6709\u8d85\u904e 10 \u500b\u914d\u7f6e/\u5be6\u4f8b\u7684\u5927\u578b\u9805\u76ee\uff0c\u9019\u4e9b\u914d\u7f6e/\u5be6\u4f8b\u6709\u8a31\u591a\u8b8a\u91cf\u548c\u53c3\u6578 \u7528\u65bc\u5728 Internet \u4e0a\u767c\u5e03\u4ee5\u4f7f\u5176\u6613\u65bc\u5b89\u88dd\u7684\u9805\u76ee \u4f55\u6642\u907f\u514d\uff1a \u5982\u679c\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u4e0d\u662f\u90a3\u9ebc\u8907\u96dc\uff0c\u4e26\u4e14\u4f60\u4e0d\u9700\u8981\u5728\u4efb\u4f55\u5730\u65b9\u767c\u5e03\u5b83\u5011 \u5982\u679c\u4f60\u4e0d\u6253\u7b97\u70ba\u767c\u5e03\u904e\u7a0b\u7dad\u8b77 CI/CD\uff0c\u56e0\u70ba\u7dad\u8b77\u6c92\u6709\u7ba1\u9053\u7684 Chart \u662f\u975e\u5e38\u8017\u6642\u7684 \u5982\u679c\u4f60\u5c0d Kubernetes API \u9084\u6c92\u6709\u6df1\u5165\u7684\u4e86\u89e3 4\u3001\u81ea\u52d5\u5316\u6a5f\u5668\u4eba\uff08Operator\uff09\u70ba\u4f60\u670d\u52d9 \u00b6 \u6700\u5f8c\u4e00\u500b\uff0c\u6700\u8907\u96dc\u7684\uff0c\u4e5f\u662f\u6700\u5f37\u5927\u7684\u3002\u5be6\u969b\u4e0a\uff0c\u9019\u662f CoreOS\uff08\u73fe\u5728\u7684Red Hat\uff09\u63d0\u51fa\u7684\u4e00\u7a2e\u8a2d\u8a08\u6a21\u5f0f\uff0c\u5b83\u53ea\u662f\u5229\u7528 Kubernetes \u7684\u4e00\u4e9b\u7279\u6027\uff0c\u6bd4\u5982\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9\u548c\u5167\u5d4c\u5728\u76f4\u63a5\u904b\u884c\u5728 Kubernetes \u4e0a\u7684\u8edf\u4ef6\u4e2d\u7684\u81ea\u5b9a\u7fa9\u908f\u8f2f\uff0c\u4e26\u5229\u7528\u5176\u7a31\u70ba controller\u7684 \u5167\u90e8API\u3002 \u5b83\u5728 OpenShift \u751f\u614b\u7cfb\u7d71\u4e2d\u5f97\u5230\u4e86\u5ee3\u6cdb\u7684\u61c9\u7528\uff0c\u4e26\u4e14\u81ea\u5f9e OpenShift 4 \u767c\u5e03\u4ee5\u4f86\uff0c\u7d05\u5e3d\u516c\u53f8\u4e00\u76f4\u5728\u63a8\u5ee3\u5b83\uff0c\u8a8d\u70ba\u5b83\u662f\u5728 OpenShift \u4e0a\u5275\u5efa\u670d\u52d9\u7684\u6700\u4f73\u65b9\u5f0f\u3002\u4ed6\u5011\u751a\u81f3\u63d0\u4f9b\u4e86\u4e00\u500b\u5b9a\u5236OpenShift web \u754c\u9762\u7684\u64cd\u4f5c\u7b26\u3002\u9019\u5c31\u662f\u6211\u6240\u8aaa\u7684\u62bd\u8c61\u5c64\uff01\u9019\u88e1\u7684\u4e00\u5207\u90fd\u7531\u5e7e\u5341\u500b\u81ea\u5b9a\u7fa9\u64cd\u4f5c\u7b26\u8655\u7406 yaml \u4f86\u63a7\u5236\uff0c\u56e0\u70ba\u6574\u500b\u908f\u8f2f\u90fd\u5d4c\u5165\u5728\u9019\u88e1\u3002 \u7c21\u55ae\u5730\u8aaa\uff0c\u4ec0\u9ebc\u662f Operator\uff0c\u6211\u60f3\u8aaa Operator \u662f\u4e00\u500b\u7b49\u50f9\u7684\u96f2\u670d\u52d9\uff0c\u5982\u4e9e\u99ac\u905c RDS\uff0cGCP \u96f2\u767c\u5e03/\u8a02\u95b1\u6216 Azure Cosmos \u6578\u64da\u5eab\u3002\u4f60\u53ef\u4ee5\u69cb\u5efa\u4e00\u500b\u64cd\u4f5c\u7b26\u4f86\u63d0\u4f9b\u4e00\u7a2e\u4e00\u81f4\u7684\u3001\u7c21\u55ae\u7684\u65b9\u6cd5\u4f86\u5b89\u88dd\u548c\u7dad\u8b77\uff08\u5305\u62ec\u5347\u7d1a\uff09\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5728\u4efb\u4f55 Kubernetes \u5e73\u53f0\u4e0a\u90fd\u53ef\u4ee5\u4f7f\u7528\u5176\u672c\u6a5f API \u4ee5\u201c\u5373\u670d\u52d9\u201d\u7684\u65b9\u5f0f\u5b89\u88dd\u548c\u7dad\u8b77\u61c9\u7528\u7a0b\u5e8f\u3002 \u5b83\u4e0d\u50c5\u63d0\u4f9b\u4e86\u6700\u9ad8\u7d1a\u5225\u7684\u81ea\u52d5\u5316\uff0c\u800c\u4e14\u9084\u5141\u8a31\u5305\u62ec\u8907\u96dc\u7684\u908f\u8f2f\uff0c\u5982\u5167\u7f6e\u76e3\u8996\u3001\u7121\u7e2b\u5347\u7d1a\u3001\u81ea\u4fee\u5fa9\u548c\u81ea\u52d5\u6a19\u5ea6\u3002\u540c\u6a23\uff0c\u4f60\u9700\u8981\u505a\u7684\u53ea\u662f\u63d0\u4f9b\u4e00\u500b yaml \u683c\u5f0f\u7684\u5b9a\u7fa9\uff0c\u5176\u9918\u7684\u5c07\u7531\u64cd\u4f5c\u7b26\u8655\u7406\u3002 \u201c\u5b83\u770b\u8d77\u4f86\u592a\u68d2\u4e86\uff01\" \u6709\u4eba\u6703\u8aaa\u3002\u8a31\u591a\u4eba\u8a8d\u70ba\u5b83\u61c9\u8a72\u800c\u4e14\u5c07\u662f\u4ea4\u4ed8\u61c9\u7528\u7a0b\u5e8f\u7684\u9996\u9078\u65b9\u5f0f\u3002\u6211\u4e0d\u540c\u610f\u9019\u7a2e\u8aaa\u6cd5\u3002\u6211\u8a8d\u70ba\uff0c\u5982\u679c\u4f60\u662f\u4e00\u500b\u8edf\u4ef6\u4f9b\u61c9\u5546\uff0c\u70ba\u6578\u767e\u500b\u5ba2\u6236\uff08\u751a\u81f3\u662f\u5167\u90e8\u5ba2\u6236\uff09\u63d0\u4f9b\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u9019\u5c31\u662f\u8a72\u8d70\u7684\u8def\u3002\u5426\u5247\uff0c\u7de8\u5beb Operator \u53ef\u80fd\u904e\u65bc\u5fa9\u96dc\u548c\u8017\u6642\u3002\u7279\u5225\u662f\u5982\u679c\u4f60\u60f3\u8981\u9075\u5faa\u6700\u4f73\u5be6\u8e10\uff0c\u4f7f\u7528 Golang \u4e26\u63d0\u4f9b\u4e00\u500b\u7c21\u55ae\u7684\u5347\u7d1a\u8def\u5f91\uff08\u5b83\u53ef\u80fd\u6703\u8b8a\u5f97\u68d8\u624b\uff09\u3002 \u6211\u767c\u73fe\u4ee5\u4e0b\u9805\u76ee\u5c0d Operator \u7684\u958b\u767c\u548c\u7dad\u8b77\u975e\u5e38\u6709\u5e6b\u52a9\uff1a kubebuilder \uff1a\u7b2c\u4e00\u500b\u9762\u5411 Go \u958b\u767c\u8005\u7684\u64cd\u4f5c\u6846\u67b6\uff0c\u6700\u5f37\u5927\u3001\u6700\u8907\u96dc\u7684\u4e00\u500b kopf \uff1a\u7528\u65bc\u5728 Python KUDO \u4e2d\u958b\u767c\u64cd\u4f5c\u7b26\u7684 kopf \u6846\u67b6\u2014\u2014\u4ee5\u8072\u660e\u7684\u65b9\u5f0f\u7de8\u5beb Operator operator-sdk \uff1a\u4f86\u81ea CoreOS Red Hat \u7684\u6846\u67b6\uff0c\u7528\u65bc\u5728 Go \u548c Ansible \u4e2d\u7de8\u5beb\u64cd\u4f5c\u7b26 operator-lifecycle \uff1a\u5c0d\u65bc\u4efb\u4f55\u6709\u8208\u8da3\u8a8d\u771f\u5c0d\u5f85 Operator \u53ca\u5176 lifrecycle\uff08\u5b89\u88dd\u3001\u7dad\u8b77\u3001\u5347\u7d1a\uff09\u7684\u4eba\u4f86\u8aaa\uff0c\u9019\u662f\u5fc5\u9808\u7684\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5982\u679c\u4f60\u9700\u8981\u5728 Kubernetes \u4e0a\u5275\u5efa\u81ea\u5df1\u7684\u670d\u52d9\uff08\u4f8b\u5982\uff0c\u4f60\u7684\u7522\u54c1\u5373\u670d\u52d9\uff09 \u5982\u679c\u4f60\u8a08\u5283\u70ba\u4f60\u7684\u670d\u52d9\u6dfb\u52a0\u984d\u5916\u7684\u529f\u80fd\uff08\u4f8b\u5982\u76e3\u8996\u3001\u81ea\u52d5\u7e2e\u653e\u3001\u81ea\u52d5\u7652\u5408\u3001\u5206\u6790\uff09 \u5982\u679c\u4f60\u662f\u70ba Kubernetes \u5e73\u53f0\u63d0\u4f9b\u8edf\u4ef6\u7684\u8edf\u4ef6\u4f9b\u61c9\u5546 \u5982\u679c\u4f60\u60f3\u958b\u767c\u5b89\u88dd\u5728 OpenShift \u4e0a\u7684\u8edf\u4ef6\uff0c\u4e26\u6210\u70ba OpenShift \u751f\u614b\u7cfb\u7d71\u7684\u4e00\u90e8\u5206\uff08\u4f8b\u5982\uff0c\u5728\u4ed6\u5011\u7684\u201c\u61c9\u7528\u5e02\u5834\u201d\u4e0a\u767c\u5e03\u4f60\u7684\u8edf\u4ef6\u2014\u2014operatorhu.io\uff09 \u4f55\u6642\u907f\u514d\uff1a - \u5c0d\u65bc\u7c21\u55ae\u7684\u61c9\u7528\u7a0b\u5e8f - \u5c0d\u65bc\u5176\u4ed6\u61c9\u7528\u6642\uff0c\u8235\u8f2a\u5716\u7528\u4e00\u4e9b\u534a\u8907\u96dc\u7684\u6a21\u677f\u5c31\u53ef\u4ee5\u4e86 - \u7576\u4e0d\u9700\u8981\u984d\u5916\u7684\u81ea\u52d5\u5316\u6642\uff0c\u6216\u8005\u53ef\u4ee5\u901a\u904e\u73fe\u6709\u7d44\u4ef6\u7684\u7c21\u55ae\u914d\u7f6e\u4f86\u5be6\u73fe \u7e3d\u7d50 \u00b6 \u6211\u6240\u63cf\u8ff0\u7684\u6bcf\u4e00\u7a2e\u65b9\u6cd5\u548c\u5de5\u5177\u90fd\u662f\u70ba\u8655\u65bc Kubernetes \u65c5\u7a0b\u4e0d\u540c\u968e\u6bb5\u7684\u7d44\u7e54\u6e96\u5099\u7684\u3002\u5c0d\u65bc\u6a19\u6e96\u7528\u4f8b\uff0c\u7c21\u55ae\u7684 yamls \u53ef\u80fd\u5c31\u8db3\u5920\u4e86\uff0c\u96a8\u8457\u66f4\u591a\u7684\u61c9\u7528\uff0cKustomize \u53ef\u4ee5\u6975\u5927\u5730\u589e\u5f37\u9019\u7a2e\u65b9\u6cd5\u3002 \u7576\u4e8b\u60c5\u8b8a\u5f97\u56b4\u91cd\u548c\u61c9\u7528\u7a0b\u5e8f\u8b8a\u5f97\u66f4\u8907\u96dc\u6642\uff0cHelm Chart \u5728\u5fa9\u96dc\u6027\u548c\u9748\u6d3b\u6027\u4e4b\u9593\u63d0\u4f9b\u4e86\u4e00\u500b\u5b8c\u7f8e\u7684\u5e73\u8861\u3002\u5c0d\u65bc\u5728 Kubernetes \u4e2d\u4ee5\u985e\u4f3c\u65bc\u96f2\u670d\u52d9\u7684\u65b9\u5f0f\u4ea4\u4ed8\u61c9\u7528\u7a0b\u5e8f\u7684\u4f9b\u61c9\u5546\uff0c\u4ee5\u53ca\u90a3\u4e9b\u8a08\u5283\u4f7f\u7528OpenShift \u70ba\u4f01\u696d\u5ba2\u6236\u63d0\u4f9b\u61c9\u7528\u7a0b\u5e8f\u7684\u4f9b\u61c9\u5546\uff0c\u6211\u53ef\u4ee5\u63a8\u85a6 Operator\u3002","title":"\u7c21\u4ecb"},{"location":"kubernetes/package/#kubernetes","text":"\u539f\u6587: 4 ways to manage Kubernetes resources \u96f2\u539f\u751f\u61c9\u7528\u65e5\u8da8\u8907\u96dc\uff0c\u50c5\u50c5\u901a\u904e Kubernetes \u5c0d\u8c61\u53ca Yaml \u5f88\u96e3\u6e05\u6670\u7684\u63cf\u8ff0\u4e00\u500b\u8907\u96dc\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u6240\u4ee5\u8a95\u751f Kustomize, Helm \u8207 Operator\u3002 Kustomize \u662f\u7528\u65bc\u81ea\u5b9a\u7fa9 Kubernetes \u914d\u7f6e\u7684\u5de5\u5177\u3002 Helm \u4e3b\u8981\u5be6\u73fe\u662f\u96f2\u539f\u751f\u61c9\u7528\u6253\u5305\u548c\u7248\u672c\u7ba1\u7406\u7b49\u3002 Operator \u672c\u8cea\u662f\u4e00\u7a2e\u8abf\u7bc0\u5668\u6a21\u5f0f\uff08Reconciler Pattern\uff09\u7684\u61c9\u7528\uff0c\u4e3b\u8981\u5be6\u73fe\u96f2\u539f\u751f\u61c9\u7528\u7ba1\u7406\uff0c\u5c24\u5176\u662f\u6709\u72c0\u614b\u61c9\u7528\u7ba1\u7406\uff0c\u5354\u8abf\u61c9\u7528\u7684\u5be6\u969b\u72c0\u614b\u9054\u5230\u9810\u671f\u72c0\u614b\u3002 \u672c\u6587\u5c07\u4ecb\u7d394\u7a2e\u7ba1\u7406 Kubernetes \u8cc7\u6e90\u7684\u65b9\u6cd5\u548c\u5de5\u5177\uff0c\u6bcf\u4e00\u7a2e\u65b9\u6cd5\u548c\u5de5\u5177\u90fd\u662f\u70ba\u8655\u65bc Kubernetes \u65c5\u7a0b\u4e0d\u540c\u968e\u6bb5\u7684\u7d44\u7e54\u6e96\u5099\u7684\u3002","title":"\u7ba1\u7406 Kubernetes \u8cc7\u6e90\u7684\u56db\u7a2e\u65b9\u5f0f"},{"location":"kubernetes/package/#kubectl-ssh","text":"\u7576\u958b\u59cb\u63a5\u89f8 Linux \u7cfb\u7d71\u6642\uff0c\u9996\u5148\u8981\u4e86\u89e3\u7684\u5de5\u5177\u662f ssh\u3002\u9019\u662f\u4e00\u500b\u5f37\u5927\u7684\u8edf\u4ef6\u3002\u4f60\u4e0d\u50c5\u53ef\u4ee5\u767b\u9304\u5230\u4f60\u7684\u670d\u52d9\u5668\uff0c\u8907\u88fd\u6587\u4ef6\uff0c\u9084\u53ef\u4ee5\u5275\u5efa vpn\uff0c\u9032\u884c SOCKS \u4ee3\u7406\u548c\u7aef\u53e3\u8f49\u767c\u898f\u5247\u7684\u9632\u706b\u7246\uff0c\u7b49\u7b49\u3002 \u4f46\u662f\uff0c\u5c0d\u65bc Kubernetes\uff0c\u53ef\u4ee5\u4f7f\u7528 kubectl\uff0c\u5b83\u662f\u65b0\u7684 ssh\u3002\u5982\u679c\u4f60\u4e0d\u76f4\u63a5\u4f7f\u7528 API \u8abf\u7528\uff0c\u90a3\u9ebc\u4f60\u53ef\u80fd\u6703\u4ee5\u67d0\u7a2e\u5f62\u5f0f\u4f7f\u7528\u5b83\uff0c\u4e26\u70ba\u5b83\u63d0\u4f9b\u5927\u91cf\u7684 yaml \u6587\u4ef6\u3002\u9019\u5c31\u662f\u5982\u4eca\u7ba1\u7406 Kubernetes \u74b0\u5883\u7684\u6a23\u5b50\u3002 \u4f60\u7528 Kubernetes \u7684\u8cc7\u6e90\u5b9a\u7fa9\u5275\u5efa\u4e86\u90a3\u4e9b\u6f02\u4eae\u7684\u3001\u5197\u9577\u7684\u6587\u672c\u6587\u4ef6\uff0c\u7136\u5f8c\u5c07\u61c9\u7528\u4f48\u7f72\u9032 Kubernetes \u7684\u96c6\u7fa4\u4e2d\u3002 \u7136\u800c\u7576\u4f60\u60f3\u8981\u5275\u5efa\u7684\u4e0d\u662f\u4e00\u500b\u800c\u662f\u6578\u5341\u500b\u6216\u6578\u767e\u500b\u5177\u6709\u4e0d\u540c\u914d\u7f6e\u7684\u61c9\u7528\u7684\u6642\u5019\uff0c\u4e8b\u60c5\u5c31\u6703\u8b8a\u5f97\u6108\u4f86\u6108\u8907\u96dc\u3002","title":"Kubectl\uff0c\u65b0\u7684 ssh"},{"location":"kubernetes/package/#vs","text":"\u5c0d\u65bc\u57fa\u672c\u5834\u666f\uff0ckubectl \u52a0\u4e0a\u7c21\u55ae\u7684 yaml \u6587\u4ef6\u5c31\u8db3\u5920\u4e86\u3002\u7136\u800c\uff0c\u96a8\u8457\u74b0\u5883\u7684\u589e\u9577\uff0c\u8cc7\u6e90\u548c\u914d\u7f6e\u7684\u6578\u91cf\u4e5f\u5728\u589e\u9577\u3002\u4f60\u53ef\u80fd\u6703\u958b\u59cb\u6ce8\u610f\u5230\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u7684\u65b0\u5be6\u4f8b\u3001\u91cd\u65b0\u914d\u7f6e\u5df2\u7d93\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u3001\u8207\u793e\u5340\u6216\u5e0c\u671b\u6839\u64da\u9700\u8981\u81ea\u5b9a\u7fa9\u61c9\u7528\u7a0b\u5e8f\u7684\u5ba2\u6236\u5171\u4eab\u61c9\u7528\u7a0b\u5e8f\u6240\u82b1\u8cbb\u7684\u6642\u9593\u66f4\u591a\u3002 \u76ee\u524d\uff0c\u6211\u767c\u73fe\u4ee5\u4e0b\u662f\u6700\u5e38\u7528\u7684\u65b9\u6cd5: \u7d14 yaml \u6587\u4ef6 Kustomize Helm Charts \u81ea\u52d5\u5316 Operator \u5b83\u5011\u90fd\u53ef\u4ee5\u7528\u4f86\u7ba1\u7406\u4f60\u5728 Kubernetes \u88e1\u982d\u7684\u8cc7\u6e90\uff0c\u7136\u800c\u5b83\u5011\u5728\u8a31\u591a\u65b9\u9762\u4e5f\u6709\u6240\u4e0d\u540c\u8a2d\u8a08\u8207\u5b9a\u4f4d\u3002\u5176\u4e2d\u4e00\u500b\u660e\u986f\u7684\u56e0\u7d20\u662f\u8907\u96dc\u6027\uff0c\u9019\u4e5f\u610f\u5473\u8457\u9700\u8981\u82b1\u8cbb\u5f88\u591a\u7cbe\u529b\u4f86\u5b78\u7fd2\u3001\u4f7f\u7528\u548c\u7dad\u8b77\u4e00\u500b\u7279\u5b9a\u7684\u65b9\u6cd5\u3002 \u53e6\u4e00\u65b9\u9762\uff0c\u7576\u4f60\u771f\u6b63\u60f3\u8981\u5275\u5efa\u8907\u96dc\u7684\u914d\u7f6e\u6642\uff0c\u5f9e\u9577\u9060\u4f86\u770b\uff0c\u9019\u6a23\u505a\u53ef\u80fd\u6703\u6709\u597d\u8655\u3002\u4f60\u53ef\u4ee5\u5728\u4e0b\u5716\u4e2d\u89c0\u5bdf\u5230\u9019\u7a2e\u95dc\u4fc2: \u6240\u4ee5\u5728 \u9748\u6d3b\u6027 \u548c \u7c21\u55ae\u6027 \u4e4b\u9593\u5b58\u5728\u6b0a\u8861\u3002\u5c0d\u4e00\u4e9b\u4eba\u4f86\u8aaa\uff0c\u7c21\u55ae\u662f\u53ef\u4ee5\u53d6\u52dd\u7684\uff0c\u4f46\u5c0d\u53e6\u4e00\u4e9b\u4eba\u4f86\u8aaa\uff0c\u9019\u9084\u9060\u9060\u4e0d\u5920\u3002\u8b93\u6211\u5011\u4ed4\u7d30\u770b\u770b\u9019\u56db\u7a2e\u65b9\u6cd5\uff0c\u770b\u770b\u5b83\u5011\u5728\u54ea\u4e9b\u60c5\u6cc1\u4e0b\u6700\u9069\u5408\u3002","title":"\u7c21\u55ae vs \u9748\u6d3b"},{"location":"kubernetes/package/#1-yaml","text":"\u6211\u7e3d\u662f\u544a\u8a34\u53c3\u52a0\u6211\u7684\u8ab2\u7a0b\u7684\u4eba\uff0c\u901a\u904e\u5b78\u7fd2 Kubernetes\uff0c\u4ed6\u5011\u53ef\u4ee5\u6210\u70ba yaml\u7a0b\u5e8f\u54e1\u3002\u9019\u53ef\u80fd\u807d\u8d77\u4f86\u5f88\u50bb\uff0c\u4f46\u5be6\u969b\u4e0a\uff0cKubernetes \u7684\u57fa\u672c\u7528\u6cd5\u6b78\u6839\u7d50\u5e95\u5c31\u662f\u7528 yaml \u7de8\u5beb\u4e00\u4e9b\u5c0d\u8c61\u7684\u5b9a\u7fa9\u3002\u7576\u7136\uff0c\u4f60\u5fc5\u9808\u77e5\u9053\u5169\u4ef6\u4e8b: \u7b2c\u4e00\u4ef6\u662f\u4f60\u60f3\u8981\u5275\u5efa\u4ec0\u9ebc \u7b2c\u4e8c\u4ef6\u662f\u95dc\u65bc Kubernetes API \u7684\u77e5\u8b58\uff0c\u5b83\u662f\u9019\u4e9b yaml \u6587\u4ef6\u7684\u57fa\u790e\u3002 \u5728\u4f60\u5b78\u7fd2\u77ad\u5982\u4f55\u7de8\u5beb yaml \u6587\u4ef6\u4e4b\u5f8c\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 kubectl \u5c07\u5176\u767c\u9001\u5230 Kubernetes\uff0c\u9019\u6a23\u4f60\u7684\u5de5\u4f5c\u5c31\u5b8c\u6210\u4e86\u3002\u6c92\u6709\u53c3\u6578\uff0c\u6c92\u6709\u6a21\u677f\uff0c\u4e5f\u4e0d\u77e5\u9053\u5982\u4f55\u6539\u8b8a\u5b83\u3002\u5982\u679c\u4f60\u60f3\u5275\u5efa\u61c9\u7528\u7a0b\u5e8f\u6216\u6574\u500b\u74b0\u5883\u7684\u9644\u52a0\u5be6\u4f8b\uff0c\u53ea\u9700\u8907\u5236\u548c\u7c98\u8cbc\u5373\u53ef\u3002 \u7576\u7136\uff0c\u9019\u88e1\u6703\u6709\u4e00\u4e9b\u91cd\u8907\uff0c\u4f46\u9019\u662f\u70ba\u4e86\u7c21\u55ae\u6240\u4ed8\u51fa\u7684\u4ee3\u50f9\u3002\u6b64\u5916\uff0c\u5728\u4e00\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u9019\u4e0d\u662f\u4ec0\u9ebc\u5927\u554f\u984c\uff0c\u5927\u591a\u6578\u7d44\u7e54\u53ef\u80fd\u53ef\u4ee5\u63a5\u53d7\u9019\u500b\u4e0d\u5b8c\u7f8e\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u81f3\u5c11\u5728\u4ed6\u5011\u65c5\u9014\u4e0d\u76e1\u5982\u4eba\u610f\u7684\u6642\u5019\u662f\u53ef\u4ee5\u7684\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5c0d\u65bc\u61c9\u7528\u7a0b\u5e8f\u6216\u74b0\u5883\u7684\u914d\u7f6e/\u5be6\u4f8b\u5c11\u65bc 4 \u500b\u7684\u9805\u76ee \u5c0d\u65bc\u5c0f\u578b\u5275\u696d\u516c\u53f8 \u5927\u516c\u53f8\u958b\u59cb\u4ed6\u5011\u7684\u7b2c\u4e00\u500b Kubernetes \u9805\u76ee\uff08\u4f8b\u5982\u4f5c\u70ba PoC \u7684\u4e00\u90e8\u5206\uff09 \u5b78\u7fd2 Kubernetes API \u7684\u500b\u4eba \u4f55\u6642\u907f\u514d\uff1a \u767c\u5e03\u91dd\u5c0d Kubernetes \u74b0\u5883\u7684\u7522\u54c1\u6216\u670d\u52d9\u7684\u7d44\u7e54\u548c\u9805\u76ee \u5728\u9805\u76ee\u4e2d\uff0c\u6bcf\u500b\u5be6\u4f8b\u90fd\u6709\u5f88\u5927\u7684\u5dee\u7570\uff0c\u9700\u8981\u5927\u91cf\u7684\u8abf\u6574","title":"1\u3001\u4f7f\u7528\u7d14 yaml \u6587\u4ef6\u4fdd\u6301\u7c21\u55ae"},{"location":"kubernetes/package/#2-kustomize","text":"Kustomize \u662f Kubernetes \u5b98\u65b9\u5718\u9ad4\u4e4b\u4e00\u7684\u4e00\u500b\u9805\u76ee\u3002\u5b83\u5b9a\u7fa9\u4e86\u57fa\u65bc\u7e7c\u627f\u7684 Kubernetes \u8cc7\u6e90\u7684\u6982\u5ff5\uff0cyaml \u6587\u4ef6\uff0c\u6c92\u932f\u2014\u2014\u4f60\u9003\u4e0d\u6389\u7684\u3002\u4f46\u662f\uff0c\u9019\u4e00\u6b21\uff0c\u4f7f\u7528 Kustomize\uff0c\u4f60\u53ef\u4ee5\u5c0d\u5df2\u7d93\u5b58\u5728\u7684\u8cc7\u6e90\u96c6\u61c9\u7528\u4efb\u4f55\u4f60\u60f3\u8981\u7684\u66f4\u6539\u3002 \u7c21\u55ae\u5730\u8aaa\uff0cKustomize \u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u500b Kubernetes \u7279\u6709\u7684\u88dc\u4e01\u5de5\u5177\u3002\u5b83\u8b93\u4f60\u8986\u84cb\u6240\u6709\u90e8\u5206\u7684 yaml \u6587\u4ef6\u8207\u5176\u4ed6\u529f\u80fd\uff0c\u5305\u62ec\u4ee5\u4e0b\uff1a \u66f4\u6539\u5bb9\u5668\u93e1\u50cf\u7684\u5b58\u5132\u5eab\u3001\u540d\u7a31\u548c\u6a19\u8a18 \u76f4\u63a5\u5f9e\u6587\u4ef6\u751f\u6210 ConfigMap \u5c0d\u8c61\uff0c\u4e26\u751f\u6210\u6563\u5217\uff0c\u78ba\u4fdd\u90e8\u7f72\u5728\u767c\u751f\u66f4\u6539\u6642\u89f8\u767c\u65b0\u7684 rollout \u4f7f\u7528 kustomize cli \u52d5\u614b\u4fee\u6539\u914d\u7f6e\uff08\u5728 CI/CD \u7ba1\u9053\u4e2d\u975e\u5e38\u6709\u7528\uff09 \u5f9e 1.14 \u7248\u958b\u59cb\uff0c\u5b83\u5c31\u5167\u7f6e\u5728 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u4e2d\uff0c\u9019\u4f7f\u5b83\u5f88\u5bb9\u6613\u958b\u59cb\u3002\u4e0d\u5e78\u7684\u662f\uff0c\u5728\u7368\u7acb\u7684 kustomize \u9805\u76ee\u4e2d\u6dfb\u52a0\u65b0\u7279\u6027\u7684\u901f\u5ea6\u8981\u5feb\u5f97\u591a\uff0c\u800c\u4e14\u5b83\u7684\u767c\u5e03\u9031\u671f\u8207 kubectl \u4e8c\u9032\u88fd\u6587\u4ef6\u7684\u5b98\u65b9\u7248\u672c\u4e0d\u540c\u6b65\u3002\u56e0\u6b64\uff0c\u6211\u5f37\u70c8\u5efa\u8b70\u4f7f\u7528\u5b83\u7684\u7368\u7acb\u7248\u672c\uff0c\u800c\u4e0d\u662f kubectl \u7684\u5167\u7f6e\u529f\u80fd\u3002 \u6839\u64da\u5176\u5275\u5efa\u8005\u7684\u8aaa\u6cd5\uff0c\u5b83\u9f13\u52f5\u4f60\u76f4\u63a5\u4f7f\u7528 Kubernetes API\uff0c\u800c\u7121\u9700\u5275\u5efa\u53e6\u4e00\u500b\u4eba\u5de5\u62bd\u8c61\u5c64\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5c0d\u65bc\u4e0d\u9700\u8981\u592a\u591a\u53c3\u6578\u7684\u5c11\u65bc 10 \u500b\u914d\u7f6e/\u5be6\u4f8b\u7684\u9805\u76ee \u5c0d\u65bc\u958b\u59cb\u6210\u9577\u4f46\u4ecd\u5728\u5167\u90e8\u4f7f\u7528 Kubernetes \u7684\u521d\u5275\u516c\u53f8\uff08\u5373\u4e0d\u9700\u8981\u5c07\u6e05\u55ae\u4f5c\u70ba\u5176\u7522\u54c1\u7684\u4e00\u90e8\u5206\uff09 \u5c0d\u65bc\u4efb\u4f55\u77e5\u9053 Kubernetes API \u7684\u4eba\u4f86\u8aaa\uff0c\u90fd\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u5b83 \u4f55\u6642\u907f\u514d\uff1a - \u5982\u679c\u4f60\u7684\u74b0\u5883\u6216\u5be6\u4f8b\u6700\u591a\u8b8a\u5316 30-50%\uff0c\u56e0\u70ba\u4f60\u53ea\u9700\u901a\u904e\u6dfb\u52a0\u88dc\u4e01\u4f86\u91cd\u5beb\u5927\u90e8\u5206\u6e05\u55ae - \u8207\u666e\u901a yamls \u7684\u60c5\u6cc1\u76f8\u540c","title":"2\u3001\u4f7f\u7528 Kustomize"},{"location":"kubernetes/package/#3-helm-charts","text":"\u5982\u679c\u4f60\u9084\u6c92\u6709\u898b\u904e Artifiact Hub \uff0c\u90a3\u9ebc\u6211\u5efa\u8b70\u4f60\u53bb\u770b\u770b\uff0c\u4e26\u5c0b\u627e\u4f60\u6700\u559c\u6b61\u7684\u8edf\u4ef6\uff0c\u7279\u5225\u662f\u5982\u679c\u5b83\u662f\u4e00\u500b\u6d41\u884c\u7684\u958b\u6e90\u9805\u76ee\uff0c\u6211\u975e\u5e38\u78ba\u5b9a\u5b83\u5728\u90a3\u88e1\u3002\u96a8\u8457 Helm 3 \u7684\u767c\u4f48\uff0c\u5b83\u7684\u5927\u90e8\u5206\u7f3a\u9677\u90fd\u5f97\u5230\u4e86\u4fee\u5fa9\u3002\u5be6\u969b\u4e0a\uff0c\u6700\u5927\u7684\u7d44\u4ef6\u662f\u4e0d\u518d\u9700\u8981\u7684 Tiller \u7d44\u4ef6\uff0c\u9019\u4f7f\u5176\u6210\u70ba\u4f60\u90e8\u7f72\u7684\u7d55\u4f73\u5de5\u5177\u3002\u56e0\u70ba\u5b83\u7684\u6a21\u677f\u7cfb\u7d71\u592a\u7c21\u55ae\u4e86\uff08\u6211\u76e1\u91cf\u907f\u514d\u4f7f\u7528\u201c\u7cdf\u7cd5\u201d\u9019\u500b\u8a5e\uff0c\u4f46\u5b83\u78ba\u5be6\u5f88\u7c21\u55ae\uff09\u3002 \u5927\u591a\u6578\u5df2\u7d93\u958b\u59cb\u4f7f\u7528 Helm \u90e8\u7f72\u670d\u52d9\u7684\u4eba\u5e38\u5e38\u958b\u59cb\u70ba\u61c9\u7528\u7a0b\u5e8f\u7de8\u5beb\u81ea\u5df1\u7684 chart\uff0c\u4ee5\u53ca\u5728 Kubernetes \u4e0a\u90e8\u7f72\u7684\u5e7e\u4e4e\u6240\u6709\u6771\u897f\u3002\u5c0d\u65bc\u975e\u5e38\u8907\u96dc\u7684\u914d\u7f6e\u4f86\u8aaa\uff0c\u9019\u53ef\u80fd\u662f\u4e00\u500b\u597d\u4e3b\u610f\uff0c\u4f46\u662f\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c\u9019\u662f\u591a\u9918\u7684\u3002\u5982\u679c\u4f60\u6c92\u6709\u5c07Chart\u767c\u4f48\u5230\u67d0\u500b Reistry Repository\uff0c\u800c\u53ea\u662f\u4f7f\u7528\u5b83\u5011\u7684\u6a21\u677f\u7279\u6027\uff0c\u90a3\u9ebc\u4f7f\u7528 Kustomize \u53ef\u80fd\u6703\u66f4\u597d\u7684\u9078\u64c7\u3002 \u7136\u800c\uff0c\u5c0d\u65bc\u9ad8\u7d1a\u5834\u666f\uff0cHelm \u662f\u6b63\u78ba\u7684\u9078\u64c7\u3002\u5b83\u53ef\u4ee5\u662f\u4f60\u7528\u4f86\u767c\u5e03\u61c9\u7528\u7a0b\u5e8f\u4ee5\u4f9b\u5176\u4ed6\u5718\u968a\u5c07\u5176\u90e8\u7f72\u5230\u5176\u74b0\u5883\u4e2d\u7684\u55ae\u4e00\u5de5\u5177\u3002\u4f60\u7684\u5ba2\u6236\u4e5f\u53ef\u4ee5\u4f7f\u7528\u4e00\u500b\u7c21\u55ae\u7684\u547d\u4ee4\u4f86\u90e8\u7f72\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u7684\u4e00\u500b\u65b0\u7248\u672c\u3002 \u4ee5\u80fd\u5920\u8655\u7406\u6240\u6709\u9019\u4e9b\u60c5\u6cc1\u548c\u914d\u7f6e\u8b8a\u91cf\u7684\u65b9\u5f0f\u7de8\u5beb Chart \u6a21\u677f \u4f7f\u7528 CI/CD \u7ba1\u9053\u3001\u6e2c\u8a66\u548c\u767c\u5e03\u4f86\u5275\u5efa\u548c\u7dad\u8b77\u6574\u500b\u767c\u5e03\u904e\u7a0b Artifiact Hub \u4e0a\u7684\u8a31\u591a\u793a\u4f8b\u986f\u793a\u5982\u4f55\u5c07\u5fa9\u96dc\u7684\u8edf\u4ef6\u6253\u5305\u5230\u4e00\u500b Chart \u4e2d\uff0c\u5f9e\u800c\u4f7f\u5b89\u88dd\u904e\u7a0b\u8b8a\u5f97\u975e\u5e38\u7c21\u55ae\uff0c\u4e26\u4f7f\u5b9a\u5236\u8b8a\u5f97\u66f4\u5bb9\u6613\u8a2a\u554f\uff0c\u7279\u5225\u662f\u5c0d\u65bc\u4e0d\u60f3\u6df1\u5165\u4e86\u89e3\u592a\u591a\u7d30\u7bc0\u7684\u6700\u7d42\u7528\u6236\u3002\u6211\u81ea\u5df1\u4e5f\u4f7f\u7528\u8a31\u591a Helm Charts \u4f86\u5b89\u88dd\u8edf\u4ef6\uff0c\u4e26\u5c07\u5176\u8996\u70ba Kubernetes \u751f\u614b\u7cfb\u7d71\u4e2d\u6700\u91cd\u8981\u7684\u9805\u76ee\u4e4b\u4e00\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5c0d\u65bc\u64c1\u6709\u8d85\u904e 10 \u500b\u914d\u7f6e/\u5be6\u4f8b\u7684\u5927\u578b\u9805\u76ee\uff0c\u9019\u4e9b\u914d\u7f6e/\u5be6\u4f8b\u6709\u8a31\u591a\u8b8a\u91cf\u548c\u53c3\u6578 \u7528\u65bc\u5728 Internet \u4e0a\u767c\u5e03\u4ee5\u4f7f\u5176\u6613\u65bc\u5b89\u88dd\u7684\u9805\u76ee \u4f55\u6642\u907f\u514d\uff1a \u5982\u679c\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\u4e0d\u662f\u90a3\u9ebc\u8907\u96dc\uff0c\u4e26\u4e14\u4f60\u4e0d\u9700\u8981\u5728\u4efb\u4f55\u5730\u65b9\u767c\u5e03\u5b83\u5011 \u5982\u679c\u4f60\u4e0d\u6253\u7b97\u70ba\u767c\u5e03\u904e\u7a0b\u7dad\u8b77 CI/CD\uff0c\u56e0\u70ba\u7dad\u8b77\u6c92\u6709\u7ba1\u9053\u7684 Chart \u662f\u975e\u5e38\u8017\u6642\u7684 \u5982\u679c\u4f60\u5c0d Kubernetes API \u9084\u6c92\u6709\u6df1\u5165\u7684\u4e86\u89e3","title":"3\u3001\u9032\u968e\uff0c\u5f37\u5927\u7684 Helm Charts"},{"location":"kubernetes/package/#4operator","text":"\u6700\u5f8c\u4e00\u500b\uff0c\u6700\u8907\u96dc\u7684\uff0c\u4e5f\u662f\u6700\u5f37\u5927\u7684\u3002\u5be6\u969b\u4e0a\uff0c\u9019\u662f CoreOS\uff08\u73fe\u5728\u7684Red Hat\uff09\u63d0\u51fa\u7684\u4e00\u7a2e\u8a2d\u8a08\u6a21\u5f0f\uff0c\u5b83\u53ea\u662f\u5229\u7528 Kubernetes \u7684\u4e00\u4e9b\u7279\u6027\uff0c\u6bd4\u5982\u81ea\u5b9a\u7fa9\u8cc7\u6e90\u5b9a\u7fa9\u548c\u5167\u5d4c\u5728\u76f4\u63a5\u904b\u884c\u5728 Kubernetes \u4e0a\u7684\u8edf\u4ef6\u4e2d\u7684\u81ea\u5b9a\u7fa9\u908f\u8f2f\uff0c\u4e26\u5229\u7528\u5176\u7a31\u70ba controller\u7684 \u5167\u90e8API\u3002 \u5b83\u5728 OpenShift \u751f\u614b\u7cfb\u7d71\u4e2d\u5f97\u5230\u4e86\u5ee3\u6cdb\u7684\u61c9\u7528\uff0c\u4e26\u4e14\u81ea\u5f9e OpenShift 4 \u767c\u5e03\u4ee5\u4f86\uff0c\u7d05\u5e3d\u516c\u53f8\u4e00\u76f4\u5728\u63a8\u5ee3\u5b83\uff0c\u8a8d\u70ba\u5b83\u662f\u5728 OpenShift \u4e0a\u5275\u5efa\u670d\u52d9\u7684\u6700\u4f73\u65b9\u5f0f\u3002\u4ed6\u5011\u751a\u81f3\u63d0\u4f9b\u4e86\u4e00\u500b\u5b9a\u5236OpenShift web \u754c\u9762\u7684\u64cd\u4f5c\u7b26\u3002\u9019\u5c31\u662f\u6211\u6240\u8aaa\u7684\u62bd\u8c61\u5c64\uff01\u9019\u88e1\u7684\u4e00\u5207\u90fd\u7531\u5e7e\u5341\u500b\u81ea\u5b9a\u7fa9\u64cd\u4f5c\u7b26\u8655\u7406 yaml \u4f86\u63a7\u5236\uff0c\u56e0\u70ba\u6574\u500b\u908f\u8f2f\u90fd\u5d4c\u5165\u5728\u9019\u88e1\u3002 \u7c21\u55ae\u5730\u8aaa\uff0c\u4ec0\u9ebc\u662f Operator\uff0c\u6211\u60f3\u8aaa Operator \u662f\u4e00\u500b\u7b49\u50f9\u7684\u96f2\u670d\u52d9\uff0c\u5982\u4e9e\u99ac\u905c RDS\uff0cGCP \u96f2\u767c\u5e03/\u8a02\u95b1\u6216 Azure Cosmos \u6578\u64da\u5eab\u3002\u4f60\u53ef\u4ee5\u69cb\u5efa\u4e00\u500b\u64cd\u4f5c\u7b26\u4f86\u63d0\u4f9b\u4e00\u7a2e\u4e00\u81f4\u7684\u3001\u7c21\u55ae\u7684\u65b9\u6cd5\u4f86\u5b89\u88dd\u548c\u7dad\u8b77\uff08\u5305\u62ec\u5347\u7d1a\uff09\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u5728\u4efb\u4f55 Kubernetes \u5e73\u53f0\u4e0a\u90fd\u53ef\u4ee5\u4f7f\u7528\u5176\u672c\u6a5f API \u4ee5\u201c\u5373\u670d\u52d9\u201d\u7684\u65b9\u5f0f\u5b89\u88dd\u548c\u7dad\u8b77\u61c9\u7528\u7a0b\u5e8f\u3002 \u5b83\u4e0d\u50c5\u63d0\u4f9b\u4e86\u6700\u9ad8\u7d1a\u5225\u7684\u81ea\u52d5\u5316\uff0c\u800c\u4e14\u9084\u5141\u8a31\u5305\u62ec\u8907\u96dc\u7684\u908f\u8f2f\uff0c\u5982\u5167\u7f6e\u76e3\u8996\u3001\u7121\u7e2b\u5347\u7d1a\u3001\u81ea\u4fee\u5fa9\u548c\u81ea\u52d5\u6a19\u5ea6\u3002\u540c\u6a23\uff0c\u4f60\u9700\u8981\u505a\u7684\u53ea\u662f\u63d0\u4f9b\u4e00\u500b yaml \u683c\u5f0f\u7684\u5b9a\u7fa9\uff0c\u5176\u9918\u7684\u5c07\u7531\u64cd\u4f5c\u7b26\u8655\u7406\u3002 \u201c\u5b83\u770b\u8d77\u4f86\u592a\u68d2\u4e86\uff01\" \u6709\u4eba\u6703\u8aaa\u3002\u8a31\u591a\u4eba\u8a8d\u70ba\u5b83\u61c9\u8a72\u800c\u4e14\u5c07\u662f\u4ea4\u4ed8\u61c9\u7528\u7a0b\u5e8f\u7684\u9996\u9078\u65b9\u5f0f\u3002\u6211\u4e0d\u540c\u610f\u9019\u7a2e\u8aaa\u6cd5\u3002\u6211\u8a8d\u70ba\uff0c\u5982\u679c\u4f60\u662f\u4e00\u500b\u8edf\u4ef6\u4f9b\u61c9\u5546\uff0c\u70ba\u6578\u767e\u500b\u5ba2\u6236\uff08\u751a\u81f3\u662f\u5167\u90e8\u5ba2\u6236\uff09\u63d0\u4f9b\u4f60\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u9019\u5c31\u662f\u8a72\u8d70\u7684\u8def\u3002\u5426\u5247\uff0c\u7de8\u5beb Operator \u53ef\u80fd\u904e\u65bc\u5fa9\u96dc\u548c\u8017\u6642\u3002\u7279\u5225\u662f\u5982\u679c\u4f60\u60f3\u8981\u9075\u5faa\u6700\u4f73\u5be6\u8e10\uff0c\u4f7f\u7528 Golang \u4e26\u63d0\u4f9b\u4e00\u500b\u7c21\u55ae\u7684\u5347\u7d1a\u8def\u5f91\uff08\u5b83\u53ef\u80fd\u6703\u8b8a\u5f97\u68d8\u624b\uff09\u3002 \u6211\u767c\u73fe\u4ee5\u4e0b\u9805\u76ee\u5c0d Operator \u7684\u958b\u767c\u548c\u7dad\u8b77\u975e\u5e38\u6709\u5e6b\u52a9\uff1a kubebuilder \uff1a\u7b2c\u4e00\u500b\u9762\u5411 Go \u958b\u767c\u8005\u7684\u64cd\u4f5c\u6846\u67b6\uff0c\u6700\u5f37\u5927\u3001\u6700\u8907\u96dc\u7684\u4e00\u500b kopf \uff1a\u7528\u65bc\u5728 Python KUDO \u4e2d\u958b\u767c\u64cd\u4f5c\u7b26\u7684 kopf \u6846\u67b6\u2014\u2014\u4ee5\u8072\u660e\u7684\u65b9\u5f0f\u7de8\u5beb Operator operator-sdk \uff1a\u4f86\u81ea CoreOS Red Hat \u7684\u6846\u67b6\uff0c\u7528\u65bc\u5728 Go \u548c Ansible \u4e2d\u7de8\u5beb\u64cd\u4f5c\u7b26 operator-lifecycle \uff1a\u5c0d\u65bc\u4efb\u4f55\u6709\u8208\u8da3\u8a8d\u771f\u5c0d\u5f85 Operator \u53ca\u5176 lifrecycle\uff08\u5b89\u88dd\u3001\u7dad\u8b77\u3001\u5347\u7d1a\uff09\u7684\u4eba\u4f86\u8aaa\uff0c\u9019\u662f\u5fc5\u9808\u7684\u3002 \u4f55\u6642\u4f7f\u7528\uff1a \u5982\u679c\u4f60\u9700\u8981\u5728 Kubernetes \u4e0a\u5275\u5efa\u81ea\u5df1\u7684\u670d\u52d9\uff08\u4f8b\u5982\uff0c\u4f60\u7684\u7522\u54c1\u5373\u670d\u52d9\uff09 \u5982\u679c\u4f60\u8a08\u5283\u70ba\u4f60\u7684\u670d\u52d9\u6dfb\u52a0\u984d\u5916\u7684\u529f\u80fd\uff08\u4f8b\u5982\u76e3\u8996\u3001\u81ea\u52d5\u7e2e\u653e\u3001\u81ea\u52d5\u7652\u5408\u3001\u5206\u6790\uff09 \u5982\u679c\u4f60\u662f\u70ba Kubernetes \u5e73\u53f0\u63d0\u4f9b\u8edf\u4ef6\u7684\u8edf\u4ef6\u4f9b\u61c9\u5546 \u5982\u679c\u4f60\u60f3\u958b\u767c\u5b89\u88dd\u5728 OpenShift \u4e0a\u7684\u8edf\u4ef6\uff0c\u4e26\u6210\u70ba OpenShift \u751f\u614b\u7cfb\u7d71\u7684\u4e00\u90e8\u5206\uff08\u4f8b\u5982\uff0c\u5728\u4ed6\u5011\u7684\u201c\u61c9\u7528\u5e02\u5834\u201d\u4e0a\u767c\u5e03\u4f60\u7684\u8edf\u4ef6\u2014\u2014operatorhu.io\uff09 \u4f55\u6642\u907f\u514d\uff1a - \u5c0d\u65bc\u7c21\u55ae\u7684\u61c9\u7528\u7a0b\u5e8f - \u5c0d\u65bc\u5176\u4ed6\u61c9\u7528\u6642\uff0c\u8235\u8f2a\u5716\u7528\u4e00\u4e9b\u534a\u8907\u96dc\u7684\u6a21\u677f\u5c31\u53ef\u4ee5\u4e86 - \u7576\u4e0d\u9700\u8981\u984d\u5916\u7684\u81ea\u52d5\u5316\u6642\uff0c\u6216\u8005\u53ef\u4ee5\u901a\u904e\u73fe\u6709\u7d44\u4ef6\u7684\u7c21\u55ae\u914d\u7f6e\u4f86\u5be6\u73fe","title":"4\u3001\u81ea\u52d5\u5316\u6a5f\u5668\u4eba\uff08Operator\uff09\u70ba\u4f60\u670d\u52d9"},{"location":"kubernetes/package/#_1","text":"\u6211\u6240\u63cf\u8ff0\u7684\u6bcf\u4e00\u7a2e\u65b9\u6cd5\u548c\u5de5\u5177\u90fd\u662f\u70ba\u8655\u65bc Kubernetes \u65c5\u7a0b\u4e0d\u540c\u968e\u6bb5\u7684\u7d44\u7e54\u6e96\u5099\u7684\u3002\u5c0d\u65bc\u6a19\u6e96\u7528\u4f8b\uff0c\u7c21\u55ae\u7684 yamls \u53ef\u80fd\u5c31\u8db3\u5920\u4e86\uff0c\u96a8\u8457\u66f4\u591a\u7684\u61c9\u7528\uff0cKustomize \u53ef\u4ee5\u6975\u5927\u5730\u589e\u5f37\u9019\u7a2e\u65b9\u6cd5\u3002 \u7576\u4e8b\u60c5\u8b8a\u5f97\u56b4\u91cd\u548c\u61c9\u7528\u7a0b\u5e8f\u8b8a\u5f97\u66f4\u8907\u96dc\u6642\uff0cHelm Chart \u5728\u5fa9\u96dc\u6027\u548c\u9748\u6d3b\u6027\u4e4b\u9593\u63d0\u4f9b\u4e86\u4e00\u500b\u5b8c\u7f8e\u7684\u5e73\u8861\u3002\u5c0d\u65bc\u5728 Kubernetes \u4e2d\u4ee5\u985e\u4f3c\u65bc\u96f2\u670d\u52d9\u7684\u65b9\u5f0f\u4ea4\u4ed8\u61c9\u7528\u7a0b\u5e8f\u7684\u4f9b\u61c9\u5546\uff0c\u4ee5\u53ca\u90a3\u4e9b\u8a08\u5283\u4f7f\u7528OpenShift \u70ba\u4f01\u696d\u5ba2\u6236\u63d0\u4f9b\u61c9\u7528\u7a0b\u5e8f\u7684\u4f9b\u61c9\u5546\uff0c\u6211\u53ef\u4ee5\u63a8\u85a6 Operator\u3002","title":"\u7e3d\u7d50"},{"location":"kubernetes/package/helm-app-deploy/","text":"K8S \u61c9\u7528\u90e8\u7f72\u4e4b helm \u521d\u63a2 \u00b6 \u539f\u6587: https://javamana.com/2022/128/202205081436039676.html Kubernetes \u61c9\u7528\u90e8\u7f72\u7684\u6311\u6230 \u00b6 Kubernetes \u662f\u4e00\u500b\u63d0\u4f9b\u4e86\u57fa\u65bc\u5bb9\u5668\u7684\u61c9\u7528\u53e2\u96c6\u7ba1\u7406\u89e3\u6c7a\u65b9\u6848\uff0cKubernetes \u70ba\u5bb9\u5668\u5316\u61c9\u7528\u63d0\u4f9b\u4e86\u90e8\u7f72\u57f7\u884c\u3001\u8cc7\u6e90\u6392\u7a0b\u3001\u670d\u52d9\u767c\u73fe\u548c\u52d5\u614b\u4f38\u7e2e\u7b49\u4e00\u7cfb\u5217\u5b8c\u6574\u529f\u80fd\u3002 Kubernetes \u7684\u6838\u5fc3\u8a2d\u8a08\u7406\u5ff5\u662f: \u4f7f\u7528\u8005\u5b9a\u7fa9\u8981\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5f0f\u7684\u898f\u5247\uff0c\u800c Kubernetes \u5247\u8ca0\u8cac\u6309\u7167\u5b9a\u7fa9\u7684\u898f\u5247\u90e8\u7f72\u4e26\u57f7\u884c\u61c9\u7528\u7a0b\u5f0f\u3002\u5982\u679c\u61c9\u7528\u7a0b\u5f0f\u51fa\u73fe\u554f\u984c\u5c0e\u81f4\u504f\u96e2\u4e86\u5b9a\u7fa9\u7684\u898f\u683c\uff0cKubernetes \u8ca0\u8cac\u5c0d\u5176\u9032\u884c\u81ea\u52d5\u4fee\u6b63\u3002\u4f8b\u5982\uff1a\u5b9a\u7fa9\u7684\u61c9\u7528\u898f\u5247\u8981\u6c42\u90e8\u7f72\u5169\u500b\u4f8b\u9805\uff08Pod\uff09\uff0c\u5176\u4e2d\u4e00\u500b\u4f8b\u9805\u7570\u5e38\u7d42\u6b62\u4e86\uff0cKubernetes \u6703\u6aa2\u67e5\u5230\u4e26\u91cd\u65b0\u555f\u52d5\u4e00\u500b\u65b0\u7684\u4f8b\u9805\u3002 \u4f7f\u7528\u8005\u901a\u904e\u4f7f\u7528 Kubernetes API \u7269\u4ef6\u4f86\u63cf\u8ff0\u61c9\u7528\u7a0b\u5f0f\u898f\u5247\uff0c\u5305\u62ec Pod\u3001Service\u3001Volume\u3001Namespace\u3001ReplicaSet\u3001Deployment\u3001Job\u7b49\u7b49\u3002\u4e00\u822c\u9019\u4e9b\u8cc7\u6e90\u7269\u4ef6\u7684\u5b9a\u7fa9\u9700\u8981\u5beb\u5165\u4e00\u7cfb\u5217\u7684 YAML \u6a94\u6848\u4e2d\uff0c\u7136\u5f8c\u901a\u904e Kubernetes \u547d\u4ee4\u5217\u5de5\u5177 Kubectl \u8abf Kubernetes API \u9032\u884c\u90e8\u7f72\u3002 \u4ee5\u4e00\u500b\u5178\u578b\u7684\u4e09\u5c64\u61c9\u7528 Wordpress \u70ba\u4f8b\uff0c\u8a72\u61c9\u7528\u7a0b\u5f0f\u5c31\u6d89\u53ca\u5230\u591a\u500b Kubernetes API \u7269\u4ef6\uff0c\u800c\u8981\u63cf\u8ff0\u9019\u4e9b Kubernetes API \u7269\u4ef6\u5c31\u53ef\u80fd\u8981\u540c\u6642\u7dad\u8b77\u591a\u500b YAML \u6a94\u6848\u3002 \u5f9e\u4e0a\u5716\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u9032\u884c Kubernetes \u8edf\u9ad4\u90e8\u7f72\u6642\uff0c\u6211\u5011\u9762\u81e8\u4e0b\u8ff0\u5e7e\u500b\u554f\u984c\uff1a \u5982\u4f55\u7ba1\u7406\u3001\u7de8\u8f2f\u548c\u66f4\u65b0\u9019\u4e9b\u9019\u4e9b\u5206\u6563\u7684 Kubernetes \u61c9\u7528\u914d\u7f6e\u6a94\u6848\u3002 \u5982\u4f55\u628a\u4e00\u5957\u76f8\u95dc\u7684\u914d\u7f6e\u6a94\u6848\u4f5c\u70ba\u4e00\u500b\u61c9\u7528\u9032\u884c\u7ba1\u7406\u3002 \u5982\u4f55\u5206\u767c\u548c\u91cd\u7528 Kubernetes \u7684\u61c9\u7528\u914d\u7f6e\u3002 \u70ba\u4ec0\u9ebc\u9700\u8981 helm? \u00b6 \u7531\u65bc Kubernetes \u7f3a\u5c11\u5c0d\u767c\u5e03\u7684\u61c9\u7528\u7248\u672c\u7ba1\u7406\u548c\u63a7\u5236\uff0c\u4f7f\u5f97\u90e8\u7f72\u7684\u61c9\u7528\u7dad\u8b77\u548c\u66f4\u65b0\u7b49\u9762\u81e8\u8af8\u591a\u7684\u6311\u6230\uff0c\u4e3b\u8981\u9762\u81e8\u4ee5\u4e0b\u554f\u984c\uff1a \u5982\u4f55\u5c07\u9019\u4e9b\u670d\u52d9\u4f5c\u70ba\u4e00\u500b\u6574\u9ad4\u7ba1\u7406\uff1f \u9019\u4e9b\u8cc7\u6e90\u6587\u4ef6\u5982\u4f55\u9ad8\u6548\u5fa9\u7528\uff1f \u4e0d\u652f\u6301\u61c9\u7528\u7d1a\u5225\u7684\u7248\u672c\u7ba1\u7406 helm \u4ecb\u7d39 \u00b6 Helm \u662f\u4e00\u500b Kubernetes \u7684\u5305\u7ba1\u7406\u5de5\u5177\uff0c\u5c31\u50cf Linux\u4e0b \u7684\u5305\u7ba1\u7406\u5668\uff0c\u5982 yum/apt \u7b49\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5c07\u4e4b\u524d\u6253\u5305\u597d\u7684 yaml \u6587\u4ef6\u90e8\u7f72\u5230 kubernetes \u4e0a\u3002 Helm \u67093\u500b\u91cd\u8981\u6982\u5ff5\uff1a helm \uff1a\u4e00\u500b\u547d\u4ee4\u884c\u5ba2\u6236\u7aef\u5de5\u5177\uff0c\u4e3b\u8981\u7528\u65bc Kubernetes \u61c9\u7528 chart \u7684\u5275\u5efa\u3001\u6253\u5305\u3001\u767c\u5e03\u548c\u7ba1\u7406\u3002 Chart \uff1a\u61c9\u7528\u63cf\u8ff0\uff0c\u4e00\u7cfb\u5217\u7528\u65bc\u63cf\u8ff0 k8s \u8cc7\u6e90\u76f8\u95dc\u6587\u4ef6\u7684\u96c6\u5408\u3002 Release \uff1a\u57fa\u65bc Chart \u7684\u90e8\u7f72\u5be6\u9ad4\uff0c\u4e00\u500b chart \u88ab Helm \u904b\u884c\u5f8c\u5c07\u6703\u751f\u6210\u5c0d\u61c9\u7684\u4e00\u500b release\uff1b\u5c07\u5728 k8s\u4e2d \u5275\u5efa\u51fa\u771f\u5be6\u904b\u884c\u7684\u8cc7\u6e90\u5c0d\u8c61\u3002 helm \u5de5\u4f5c\u6d41\u7a0b \u00b6 helm \u5b89\u88dd \u00b6 \u4f7f\u7528 helm \u5f88\u7c21\u55ae\uff0c\u4f60\u53ea\u9700\u8981\u4e0b\u8f09\u4e00\u500b\u4e8c\u9032\u5236\u5ba2\u6236\u7aef\u5305\u5373\u53ef\uff0chelm \u6703\u901a\u904e kubeconfig \u914d\u7f6e\uff08\u901a\u5e38 $HOME/.kube/config \uff09\u4f86\u9023\u63a5 Kubernetes\u3002 \u4ee5\u4e0b\u662f\u901a\u904e\u811a\u672c\u5b89\u88c5 helm \u7684\u547d\u4ee4\uff0c\u5176\u4ed6\u7684\u5b89\u88dd\u65b9\u5f0f\u53ef\u53c3\u8003 \u5b98\u7db2 \uff1a $ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 $ chmod 700 get_helm.sh $ ./get_helm.sh \u4f7f\u7528 helm \u7ba1\u7406\u61c9\u7528\u751f\u547d\u9031\u671f \u00b6 \u63a5\u4e0b\u4f86\u6211\u5011\u6703\u4f7f\u7528 helm \u4f86\u7ba1\u7406\u4e00\u500b\u61c9\u7528\u7684\u751f\u547d\u9031\u671f\uff1a helm create \u5275\u5efa Chart helm install \u90e8\u7f72 helm upgrade \u66f4\u65b0 helm rollback \u56de\u6efe helm uninstall \u5378\u8f09 \u6b65\u9a5f 1. helm create \u5275\u5efa Chart \u00b6 \u521b\u5efa\u4e00\u500b\u65b0\u7684 chart\uff1a helm create mychart helm \u6703\u5728\u73fe\u5728\u7684\u76ee\u9304\u4e0b\u5275\u5efa\u4e00\u500b mychart \u7684\u76ee\u9304, \u5b83\u7684\u7d50\u69cb\u5982\u4e0b: mychart/ \u251c\u2500\u2500 charts \u251c\u2500\u2500 Chart.yaml \u251c\u2500\u2500 templates \u2502 \u251c\u2500\u2500 deployment.yaml \u2502 \u251c\u2500\u2500 _helpers.tpl \u2502 \u251c\u2500\u2500 hpa.yaml \u2502 \u251c\u2500\u2500 ingress.yaml \u2502 \u251c\u2500\u2500 NOTES.txt \u2502 \u251c\u2500\u2500 serviceaccount.yaml \u2502 \u251c\u2500\u2500 service.yaml \u2502 \u2514\u2500\u2500 tests \u2502 \u2514\u2500\u2500 test-connection.yaml \u2514\u2500\u2500 values.yaml Chart.yaml \uff1a\u7528\u65bc\u63cf\u8ff0\u9019\u500b Chart \u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5305\u62ec\u540d\u5b57\u3001\u63cf\u8ff0\u4fe1\u606f\u4ee5\u53ca \u7248\u672c\u7b49\u3002 values.yaml \uff1a\u7528\u65bc\u5b58\u5132 templates \u76ee\u9304\u4e2d\u6a21\u677f\u6587\u4ef6\u4e2d\u7528\u5230\u8b8a\u91cf\u7684\u503c\u3002 charts \uff1a\u76ee\u9304\u88e1\u5b58\u653e\u9019\u500b chart \u4f9d\u8cf4\u7684\u6240\u6709\u5b50 chart\u3002 templates \uff1a \u76ee\u9304\u88e1\u9762\u5b58\u653e\u6240\u6709 yaml \u6a21\u677f\u6587\u4ef6\u3002 NOTES.txt \uff1a\u7528\u65bc\u4ecb\u7d39 Chart \u5e6b\u52a9\u4fe1\u606f\uff0c helm install \u90e8\u7f72\u5f8c\u5c55\u793a\u7d66\u7528\u6236\u3002\u4f8b\u5982\uff1a\u5982\u4f55\u4f7f\u7528\u9019\u500b Chart\u3001\u5217\u51fa\u7f3a\u7701\u7684\u8a2d\u7f6e\u7b49\u3002 helpers.tpl\uff1a\u653e\u7f6e\u6a21\u677f\u7684\u5730\u65b9\uff0c\u53ef\u4ee5\u5728\u6574\u500b chart \u4e2d\u91cd\u8907\u4f7f\u7528\u3002 mychart/Chart.yaml apiVersion : v2 name : mychart description : A Helm chart for Kubernetes type : application version : 0.1. appVersion : \"1.16.0\" mychart/templates/deployment.yaml apiVersion : apps/v1 kind : Deployment metadata : name : {{ include \"mychart.fullname\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} spec : {{ - if not .Values.autoscaling.enabled }} replicas : {{ .Values.replicaCount }} {{ - end }} selector : matchLabels : {{ - include \"mychart.selectorLabels\" . | nindent 6 }} template : metadata : {{ - with .Values.podAnnotations }} annotations : {{ - toYaml . | nindent 8 }} {{ - end }} labels : {{ - include \"mychart.selectorLabels\" . | nindent 8 }} spec : {{ - with .Values.imagePullSecrets }} imagePullSecrets : {{ - toYaml . | nindent 8 }} {{ - end }} serviceAccountName : {{ include \"mychart.serviceAccountName\" . }} securityContext : {{ - toYaml .Values.podSecurityContext | nindent 8 }} containers : - name : {{ .Chart.Name }} securityContext : {{ - toYaml .Values.securityContext | nindent 12 }} image : \"{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}\" imagePullPolicy : {{ .Values.image.pullPolicy }} ports : - name : http containerPort : 80 protocol : TCP livenessProbe : httpGet : path : / port : http readinessProbe : httpGet : path : / port : http resources : {{ - toYaml .Values.resources | nindent 12 }} {{ - with .Values.nodeSelector }} nodeSelector : {{ - toYaml . | nindent 8 }} {{ - end }} {{ - with .Values.affinity }} affinity : {{ - toYaml . | nindent 8 }} {{ - end }} {{ - with .Values.tolerations }} tolerations : {{ - toYaml . | nindent 8 }} {{ - end }} mychart/templates/hpa.yaml {{ - if .Values.autoscaling.enabled }} apiVersion : autoscaling/v2beta1 kind : HorizontalPodAutoscaler metadata : name : {{ include \"mychart.fullname\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} spec : scaleTargetRef : apiVersion : apps/v1 kind : Deployment name : {{ include \"mychart.fullname\" . }} minReplicas : {{ .Values.autoscaling.minReplicas }} maxReplicas : {{ .Values.autoscaling.maxReplicas }} metrics : {{ - if .Values.autoscaling.targetCPUUtilizationPercentage }} - type : Resource resource : name : cpu targetAverageUtilization : {{ .Values.autoscaling.targetCPUUtilizationPercentage }} {{ - end }} {{ - if .Values.autoscaling.targetMemoryUtilizationPercentage }} - type : Resource resource : name : memory targetAverageUtilization : {{ .Values.autoscaling.targetMemoryUtilizationPercentage }} {{ - end }} {{ - end }} mychart/templates/ingress.yaml {{ - if .Values.ingress.enabled - }} {{ - $fullName : = include \"mychart.fullname\" . - }} {{ - $svcPort : = .Values.service.port - }} {{ - if and .Values.ingress.className (not (semverCompare \">=1.18-0\" .Capabilities.KubeVersion.GitVersion)) }} {{ - if not (hasKey .Values.ingress.annotations \"kubernetes.io/ingress.class\") }} {{ - $_ : = set .Values.ingress.annotations \"kubernetes.io/ingress.class\" .Values.ingress.className }} {{ - end }} {{ - end }} {{ - if semverCompare \">=1.19-0\" .Capabilities.KubeVersion.GitVersion - }} apiVersion : networking.k8s.io/v1 {{ - else if semverCompare \">=1.14-0\" .Capabilities.KubeVersion.GitVersion - }} apiVersion : networking.k8s.io/v1beta1 {{ - else - }} apiVersion : extensions/v1beta1 {{ - end }} kind : Ingress metadata : name : {{ $fullName }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} {{ - with .Values.ingress.annotations }} annotations : {{ - toYaml . | nindent 4 }} {{ - end }} spec : {{ - if and .Values.ingress.className (semverCompare \">=1.18-0\" .Capabilities.KubeVersion.GitVersion) }} ingressClassName : {{ .Values.ingress.className }} {{ - end }} {{ - if .Values.ingress.tls }} tls : {{ - range .Values.ingress.tls }} - hosts : {{ - range .hosts }} - {{ . | quote }} {{ - end }} secretName : {{ .secretName }} {{ - end }} {{ - end }} rules : {{ - range .Values.ingress.hosts }} - host : {{ .host | quote }} http : paths : {{ - range .paths }} - path : {{ .path }} {{ - if and .pathType (semverCompare \">=1.18-0\" $.Capabilities.KubeVersion.GitVersion) }} pathType : {{ .pathType }} {{ - end }} backend : {{ - if semverCompare \">=1.19-0\" $.Capabilities.KubeVersion.GitVersion }} service : name : {{ $fullName }} port : number : {{ $svcPort }} {{ - else }} serviceName : {{ $fullName }} servicePort : {{ $svcPort }} {{ - end }} {{ - end }} {{ - end }} {{ - end }} mychart/templates/serviceaccount.yaml {{ - if .Values.serviceAccount.create - }} apiVersion : v1 kind : ServiceAccount metadata : name : {{ include \"mychart.serviceAccountName\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} {{ - with .Values.serviceAccount.annotations }} annotations : {{ - toYaml . | nindent 4 }} {{ - end }} {{ - end }} mychart/templates/service.yaml apiVersion : v1 kind : Service metadata : name : {{ include \"mychart.fullname\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} spec : type : {{ .Values.service.type }} ports : - port : {{ .Values.service.port }} targetPort : http protocol : TCP name : http selector : {{ - include \"mychart.selectorLabels\" . | nindent 4 }} mychart/values.yaml # Default values for mychart. # This is a YAML-formatted file. # Declare variables to be passed into your templates. replicaCount : 1 image : repository : nginx pullPolicy : IfNotPresent # Overrides the image tag whose default is the chart appVersion. tag : \"\" imagePullSecrets : [] nameOverride : \"\" fullnameOverride : \"\" serviceAccount : # Specifies whether a service account should be created create : true # Annotations to add to the service account annotations : {} # The name of the service account to use. # If not set and create is true, a name is generated using the fullname template name : \"\" podAnnotations : {} podSecurityContext : {} # fsGroup: 2000 securityContext : {} # capabilities: # drop: # - ALL # readOnlyRootFilesystem: true # runAsNonRoot: true # runAsUser: 1000 service : type : ClusterIP port : 80 ingress : enabled : false className : \"\" annotations : {} # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \"true\" hosts : - host : chart-example.local paths : - path : / pathType : ImplementationSpecific tls : [] # - secretName: chart-example-tls # hosts: # - chart-example.local resources : {} # We usually recommend not to specify default resources and to leave this as a conscious # choice for the user. This also increases chances charts run on environments with little # resources, such as Minikube. If you do want to specify resources, uncomment the following # lines, adjust them as necessary, and remove the curly braces after 'resources:'. # limits: # cpu: 100m # memory: 128Mi # requests: # cpu: 100m # memory: 128Mi autoscaling : enabled : false minReplicas : 1 maxReplicas : 100 targetCPUUtilizationPercentage : 80 # targetMemoryUtilizationPercentage: 80 nodeSelector : {} tolerations : [] affinity : {} \u6b65\u9a5f 2. helm install \u90e8\u7f72 \u00b6 \u9032\u5165\u9019\u500b chart \u7684\u76ee\u9304: cd mychart \u90e8\u7f72\u9019\u500b chart: helm install web mychart/ \u547d\u4ee4\u7d50\u679c\u5982\u4e0b\u6240\u793a: NAME: web LAST DEPLOYED: Sat Aug 6 19:33:08 2022 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: 1. Get the application URL by running these commands: export POD_NAME=$(kubectl get pods --namespace default -l \"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=web\" -o jsonpath=\"{.items[0].metadata.name}\") export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath=\"{.spec.containers[0].ports[0].containerPort}\") echo \"Visit http://127.0.0.1:8080 to use your application\" kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT \u547d\u4ee4\u67e5\u770b\u53ef\u4ee5\u770b\u5230\u5df2\u7d93\u90e8\u7f72\u6210\u529f: helm list \u547d\u4ee4\u7d50\u679c\u5982\u4e0b\u6240\u793a: NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION web default 1 2022-08-06 19:33:08.884653922 +0800 CST deployed mychart-0.1.0 1.16.0 \u6aa2\u67e5 kubernetes \u61c9\u7528\u88ab\u4f48\u7f72\u7684\u72c0\u614b: $ kubectl get all NAME READY STATUS RESTARTS AGE pod/web-mychart-5f94885968-wbwth 1 /1 Running 0 4m38s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 9h service/web-mychart ClusterIP 10 .43.244.237 <none> 80 /TCP 4m38s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/web-mychart 1 /1 1 1 4m38s NAME DESIRED CURRENT READY AGE replicaset.apps/web-mychart-5f94885968 1 1 1 4m38s \u8b93\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u6aa2\u67e5\u88ab\u4f48\u7f72\u7684\u61c9\u7528: kubectl port-forward service/web-mychart 8080:80 --address='0.0.0.0' \u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u8a9e\u6cd5\u5982\u4e0b\u3002 kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0' \u6b65\u9a5f 3. helm upgrade \u66f4\u65b0 \u00b6 helm \u9664\u4e86\u652f\u6301\u53c3\u6578\u503c\u53c3\u6578\u50b3\u905e\uff0c\u9084\u652f\u6301\u52d5\u614b\u50b3\u8f38\uff0c\u5982\u4e0b: helm install web mychart/ --set replicaCount = 2 \u7531\u65bc\u5728 \u6b65\u9a5f #1 \u6211\u5011\u5df1\u7d93\u9032\u884c\u4e86\u7b2c\u4e00\u6b21\u7684\u4f48\u7f72\uff0c\u4e0b\u5217\u7684\u547d\u4ee4\u53ef\u67e5\u8a62\u4f48\u7f72\u6b77\u53f2: $ helm history web REVISION UPDATED STATUS CHART APP VERSION DESCRIPTION 1 Sat Aug 6 19 :33:08 2022 deployed mychart-0.1.0 1 .16.0 Install complete \u8b93\u6211\u5011\u4f7f\u7528\u53c3\u6578\u50b3\u905e\u7684\u624b\u6cd5\u4f86\u66f4\u65b0\u5df1\u4f48\u7f72\u7684\u61c9\u7528: helm upgrade web mychart/ --set replicaCount = 2 \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Release \"web\" has been upgraded. Happy Helming! NAME: web LAST DEPLOYED: Sat Aug 6 20:11:31 2022 NAMESPACE: default STATUS: deployed REVISION: 2 NOTES: 1. Get the application URL by running these commands: export POD_NAME=$(kubectl get pods --namespace default -l \"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=web\" -o jsonpath=\"{.items[0].metadata.name}\") export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath=\"{.spec.containers[0].ports[0].containerPort}\") echo \"Visit http://127.0.0.1:8080 to use your application\" kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT \u6aa2\u67e5\u61c9\u7528\u88ab\u4f48\u7f72\u7684\u72c0\u614b: $ kubectl get all NAME READY STATUS RESTARTS AGE pod/web-mychart-5f94885968-wbwth 1 /1 Running 0 40m pod/web-mychart-5f94885968-x7mpp 1 /1 Running 0 112s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 10h service/web-mychart ClusterIP 10 .43.244.237 <none> 80 /TCP 40m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/web-mychart 2 /2 2 2 40m NAME DESIRED CURRENT READY AGE replicaset.apps/web-mychart-5f94885968 2 2 2 40m \u53ef\u767c\u73fe\u73fe\u5728\u6709 2 Pods \u88ab\u4f48\u7f72\u8d77\u4f86\u3002 \u6b65\u9a5f 4. helm rollback \u56de\u6efe \u00b6 \u73fe\u5728 web \u9019\u500b release \u5df1\u7d93\u6709\u4e86\u591a\u500b\u7248\u672c\u7684\u4f48\u7f72\u8a18\u9304\u4e86\u3002 $ helm history web REVISION UPDATED STATUS CHART APP VERSION DESCRIPTION 1 Sat Aug 6 19:33:08 2022 superseded mychart-0.1.0 1.16.0 Install complete 2 Sat Aug 6 20:11:31 2022 deployed mychart-0.1.0 1.16.0 Upgrade complete \u8981\u9032\u884c\u7248\u672c\u56de\u6efe\u53ef\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4: \u56de\u6efe\u5230\u4e0a\u4e00\u500b\u7248\u672c\uff1a helm rollback web \u56de\u6eda\u5230\u6307\u5b9a\u7248\u672c\uff1a helm rollback web 1 \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Rollback was a success! Happy Helming! \u6b65\u9a5f 5. helm uninstall \u5378\u8f09 \u00b6 \u548c\u56de\u6efe\u4e00\u6a23\uff0chelm uninstall \u5378\u8f09\u4e5f\u662f \u61c9\u7528 \u7b49\u7d1a\u7684\uff0c\u4e0d\u9700\u8981\u4e00\u500b\u670d\u52d9\u522a\u9664: helm uninstall web \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: release \"web\" uninstalled \u6aa2\u67e5\u7d50\u679c: $ helm list NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION $ kubectl get all NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 10h helm \u6e32\u67d3 yaml \u00b6 \u6709\u4e9b\u6642\u5019\u7576\u4f7f\u7528 helm \u8207 chart \u4f86\u5b89\u88dd\u61c9\u7528\u9032\u5230 Kubernetes \u6642\uff0c\u7576\u51fa\u73fe\u4e00\u4e9b\u554f\u984c\u9700\u8981\u9032\u884c\u9664\u932f\u7684\u6642\u5019\uff0c\u6211\u5011\u6703\u9700\u8981\u53d6\u5f97 helm \u6700\u5f8c\u5ba3\u544a\u9032 kubernetes \u96c6\u7fa4\u6642\u7684 manifest (yaml) \u6a94\u6848\u3002 \u7d93\u7531\u4e0b\u5217\u7684\u547d\u4ee4\u53ef\u9a45\u52d5 helm \u4f86\u6e32\u67d3\u51fa\u76f8\u95dc\u7684 yaml \u6a94\u6848: helm template web-demo mychart/ \u6aa2\u67e5\u7d50\u679c: --- # Source: mychart/templates/serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-demo-mychart labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm --- # Source: mychart/templates/service.yaml apiVersion: v1 kind: Service metadata: name: web-demo-mychart labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm spec: type: ClusterIP ports: - port: 80 targetPort: http protocol: TCP name: http selector: app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo --- # Source: mychart/templates/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-demo-mychart labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo template: metadata: labels: app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo spec: serviceAccountName: web-demo-mychart securityContext: {} containers: - name: mychart securityContext: {} image: \"nginx:1.16.0\" imagePullPolicy: IfNotPresent ports: - name: http containerPort: 80 protocol: TCP livenessProbe: httpGet: path: / port: http readinessProbe: httpGet: path: / port: http resources: {} --- # Source: mychart/templates/tests/test-connection.yaml apiVersion: v1 kind: Pod metadata: name: \"web-demo-mychart-test-connection\" labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm annotations: \"helm.sh/hook\": test spec: containers: - name: wget image: busybox command: ['wget'] args: ['web-demo-mychart:80'] restartPolicy: Never","title":"K8S \u61c9\u7528\u90e8\u7f72\u4e4b Helm \u521d\u63a2"},{"location":"kubernetes/package/helm-app-deploy/#k8s-helm","text":"\u539f\u6587: https://javamana.com/2022/128/202205081436039676.html","title":"K8S \u61c9\u7528\u90e8\u7f72\u4e4b helm \u521d\u63a2"},{"location":"kubernetes/package/helm-app-deploy/#kubernetes","text":"Kubernetes \u662f\u4e00\u500b\u63d0\u4f9b\u4e86\u57fa\u65bc\u5bb9\u5668\u7684\u61c9\u7528\u53e2\u96c6\u7ba1\u7406\u89e3\u6c7a\u65b9\u6848\uff0cKubernetes \u70ba\u5bb9\u5668\u5316\u61c9\u7528\u63d0\u4f9b\u4e86\u90e8\u7f72\u57f7\u884c\u3001\u8cc7\u6e90\u6392\u7a0b\u3001\u670d\u52d9\u767c\u73fe\u548c\u52d5\u614b\u4f38\u7e2e\u7b49\u4e00\u7cfb\u5217\u5b8c\u6574\u529f\u80fd\u3002 Kubernetes \u7684\u6838\u5fc3\u8a2d\u8a08\u7406\u5ff5\u662f: \u4f7f\u7528\u8005\u5b9a\u7fa9\u8981\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5f0f\u7684\u898f\u5247\uff0c\u800c Kubernetes \u5247\u8ca0\u8cac\u6309\u7167\u5b9a\u7fa9\u7684\u898f\u5247\u90e8\u7f72\u4e26\u57f7\u884c\u61c9\u7528\u7a0b\u5f0f\u3002\u5982\u679c\u61c9\u7528\u7a0b\u5f0f\u51fa\u73fe\u554f\u984c\u5c0e\u81f4\u504f\u96e2\u4e86\u5b9a\u7fa9\u7684\u898f\u683c\uff0cKubernetes \u8ca0\u8cac\u5c0d\u5176\u9032\u884c\u81ea\u52d5\u4fee\u6b63\u3002\u4f8b\u5982\uff1a\u5b9a\u7fa9\u7684\u61c9\u7528\u898f\u5247\u8981\u6c42\u90e8\u7f72\u5169\u500b\u4f8b\u9805\uff08Pod\uff09\uff0c\u5176\u4e2d\u4e00\u500b\u4f8b\u9805\u7570\u5e38\u7d42\u6b62\u4e86\uff0cKubernetes \u6703\u6aa2\u67e5\u5230\u4e26\u91cd\u65b0\u555f\u52d5\u4e00\u500b\u65b0\u7684\u4f8b\u9805\u3002 \u4f7f\u7528\u8005\u901a\u904e\u4f7f\u7528 Kubernetes API \u7269\u4ef6\u4f86\u63cf\u8ff0\u61c9\u7528\u7a0b\u5f0f\u898f\u5247\uff0c\u5305\u62ec Pod\u3001Service\u3001Volume\u3001Namespace\u3001ReplicaSet\u3001Deployment\u3001Job\u7b49\u7b49\u3002\u4e00\u822c\u9019\u4e9b\u8cc7\u6e90\u7269\u4ef6\u7684\u5b9a\u7fa9\u9700\u8981\u5beb\u5165\u4e00\u7cfb\u5217\u7684 YAML \u6a94\u6848\u4e2d\uff0c\u7136\u5f8c\u901a\u904e Kubernetes \u547d\u4ee4\u5217\u5de5\u5177 Kubectl \u8abf Kubernetes API \u9032\u884c\u90e8\u7f72\u3002 \u4ee5\u4e00\u500b\u5178\u578b\u7684\u4e09\u5c64\u61c9\u7528 Wordpress \u70ba\u4f8b\uff0c\u8a72\u61c9\u7528\u7a0b\u5f0f\u5c31\u6d89\u53ca\u5230\u591a\u500b Kubernetes API \u7269\u4ef6\uff0c\u800c\u8981\u63cf\u8ff0\u9019\u4e9b Kubernetes API \u7269\u4ef6\u5c31\u53ef\u80fd\u8981\u540c\u6642\u7dad\u8b77\u591a\u500b YAML \u6a94\u6848\u3002 \u5f9e\u4e0a\u5716\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u9032\u884c Kubernetes \u8edf\u9ad4\u90e8\u7f72\u6642\uff0c\u6211\u5011\u9762\u81e8\u4e0b\u8ff0\u5e7e\u500b\u554f\u984c\uff1a \u5982\u4f55\u7ba1\u7406\u3001\u7de8\u8f2f\u548c\u66f4\u65b0\u9019\u4e9b\u9019\u4e9b\u5206\u6563\u7684 Kubernetes \u61c9\u7528\u914d\u7f6e\u6a94\u6848\u3002 \u5982\u4f55\u628a\u4e00\u5957\u76f8\u95dc\u7684\u914d\u7f6e\u6a94\u6848\u4f5c\u70ba\u4e00\u500b\u61c9\u7528\u9032\u884c\u7ba1\u7406\u3002 \u5982\u4f55\u5206\u767c\u548c\u91cd\u7528 Kubernetes \u7684\u61c9\u7528\u914d\u7f6e\u3002","title":"Kubernetes \u61c9\u7528\u90e8\u7f72\u7684\u6311\u6230"},{"location":"kubernetes/package/helm-app-deploy/#helm","text":"\u7531\u65bc Kubernetes \u7f3a\u5c11\u5c0d\u767c\u5e03\u7684\u61c9\u7528\u7248\u672c\u7ba1\u7406\u548c\u63a7\u5236\uff0c\u4f7f\u5f97\u90e8\u7f72\u7684\u61c9\u7528\u7dad\u8b77\u548c\u66f4\u65b0\u7b49\u9762\u81e8\u8af8\u591a\u7684\u6311\u6230\uff0c\u4e3b\u8981\u9762\u81e8\u4ee5\u4e0b\u554f\u984c\uff1a \u5982\u4f55\u5c07\u9019\u4e9b\u670d\u52d9\u4f5c\u70ba\u4e00\u500b\u6574\u9ad4\u7ba1\u7406\uff1f \u9019\u4e9b\u8cc7\u6e90\u6587\u4ef6\u5982\u4f55\u9ad8\u6548\u5fa9\u7528\uff1f \u4e0d\u652f\u6301\u61c9\u7528\u7d1a\u5225\u7684\u7248\u672c\u7ba1\u7406","title":"\u70ba\u4ec0\u9ebc\u9700\u8981 helm?"},{"location":"kubernetes/package/helm-app-deploy/#helm_1","text":"Helm \u662f\u4e00\u500b Kubernetes \u7684\u5305\u7ba1\u7406\u5de5\u5177\uff0c\u5c31\u50cf Linux\u4e0b \u7684\u5305\u7ba1\u7406\u5668\uff0c\u5982 yum/apt \u7b49\uff0c\u53ef\u4ee5\u5f88\u65b9\u4fbf\u7684\u5c07\u4e4b\u524d\u6253\u5305\u597d\u7684 yaml \u6587\u4ef6\u90e8\u7f72\u5230 kubernetes \u4e0a\u3002 Helm \u67093\u500b\u91cd\u8981\u6982\u5ff5\uff1a helm \uff1a\u4e00\u500b\u547d\u4ee4\u884c\u5ba2\u6236\u7aef\u5de5\u5177\uff0c\u4e3b\u8981\u7528\u65bc Kubernetes \u61c9\u7528 chart \u7684\u5275\u5efa\u3001\u6253\u5305\u3001\u767c\u5e03\u548c\u7ba1\u7406\u3002 Chart \uff1a\u61c9\u7528\u63cf\u8ff0\uff0c\u4e00\u7cfb\u5217\u7528\u65bc\u63cf\u8ff0 k8s \u8cc7\u6e90\u76f8\u95dc\u6587\u4ef6\u7684\u96c6\u5408\u3002 Release \uff1a\u57fa\u65bc Chart \u7684\u90e8\u7f72\u5be6\u9ad4\uff0c\u4e00\u500b chart \u88ab Helm \u904b\u884c\u5f8c\u5c07\u6703\u751f\u6210\u5c0d\u61c9\u7684\u4e00\u500b release\uff1b\u5c07\u5728 k8s\u4e2d \u5275\u5efa\u51fa\u771f\u5be6\u904b\u884c\u7684\u8cc7\u6e90\u5c0d\u8c61\u3002","title":"helm \u4ecb\u7d39"},{"location":"kubernetes/package/helm-app-deploy/#helm_2","text":"","title":"helm \u5de5\u4f5c\u6d41\u7a0b"},{"location":"kubernetes/package/helm-app-deploy/#helm_3","text":"\u4f7f\u7528 helm \u5f88\u7c21\u55ae\uff0c\u4f60\u53ea\u9700\u8981\u4e0b\u8f09\u4e00\u500b\u4e8c\u9032\u5236\u5ba2\u6236\u7aef\u5305\u5373\u53ef\uff0chelm \u6703\u901a\u904e kubeconfig \u914d\u7f6e\uff08\u901a\u5e38 $HOME/.kube/config \uff09\u4f86\u9023\u63a5 Kubernetes\u3002 \u4ee5\u4e0b\u662f\u901a\u904e\u811a\u672c\u5b89\u88c5 helm \u7684\u547d\u4ee4\uff0c\u5176\u4ed6\u7684\u5b89\u88dd\u65b9\u5f0f\u53ef\u53c3\u8003 \u5b98\u7db2 \uff1a $ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 $ chmod 700 get_helm.sh $ ./get_helm.sh","title":"helm \u5b89\u88dd"},{"location":"kubernetes/package/helm-app-deploy/#helm_4","text":"\u63a5\u4e0b\u4f86\u6211\u5011\u6703\u4f7f\u7528 helm \u4f86\u7ba1\u7406\u4e00\u500b\u61c9\u7528\u7684\u751f\u547d\u9031\u671f\uff1a helm create \u5275\u5efa Chart helm install \u90e8\u7f72 helm upgrade \u66f4\u65b0 helm rollback \u56de\u6efe helm uninstall \u5378\u8f09","title":"\u4f7f\u7528 helm \u7ba1\u7406\u61c9\u7528\u751f\u547d\u9031\u671f"},{"location":"kubernetes/package/helm-app-deploy/#1-helm-create-chart","text":"\u521b\u5efa\u4e00\u500b\u65b0\u7684 chart\uff1a helm create mychart helm \u6703\u5728\u73fe\u5728\u7684\u76ee\u9304\u4e0b\u5275\u5efa\u4e00\u500b mychart \u7684\u76ee\u9304, \u5b83\u7684\u7d50\u69cb\u5982\u4e0b: mychart/ \u251c\u2500\u2500 charts \u251c\u2500\u2500 Chart.yaml \u251c\u2500\u2500 templates \u2502 \u251c\u2500\u2500 deployment.yaml \u2502 \u251c\u2500\u2500 _helpers.tpl \u2502 \u251c\u2500\u2500 hpa.yaml \u2502 \u251c\u2500\u2500 ingress.yaml \u2502 \u251c\u2500\u2500 NOTES.txt \u2502 \u251c\u2500\u2500 serviceaccount.yaml \u2502 \u251c\u2500\u2500 service.yaml \u2502 \u2514\u2500\u2500 tests \u2502 \u2514\u2500\u2500 test-connection.yaml \u2514\u2500\u2500 values.yaml Chart.yaml \uff1a\u7528\u65bc\u63cf\u8ff0\u9019\u500b Chart \u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5305\u62ec\u540d\u5b57\u3001\u63cf\u8ff0\u4fe1\u606f\u4ee5\u53ca \u7248\u672c\u7b49\u3002 values.yaml \uff1a\u7528\u65bc\u5b58\u5132 templates \u76ee\u9304\u4e2d\u6a21\u677f\u6587\u4ef6\u4e2d\u7528\u5230\u8b8a\u91cf\u7684\u503c\u3002 charts \uff1a\u76ee\u9304\u88e1\u5b58\u653e\u9019\u500b chart \u4f9d\u8cf4\u7684\u6240\u6709\u5b50 chart\u3002 templates \uff1a \u76ee\u9304\u88e1\u9762\u5b58\u653e\u6240\u6709 yaml \u6a21\u677f\u6587\u4ef6\u3002 NOTES.txt \uff1a\u7528\u65bc\u4ecb\u7d39 Chart \u5e6b\u52a9\u4fe1\u606f\uff0c helm install \u90e8\u7f72\u5f8c\u5c55\u793a\u7d66\u7528\u6236\u3002\u4f8b\u5982\uff1a\u5982\u4f55\u4f7f\u7528\u9019\u500b Chart\u3001\u5217\u51fa\u7f3a\u7701\u7684\u8a2d\u7f6e\u7b49\u3002 helpers.tpl\uff1a\u653e\u7f6e\u6a21\u677f\u7684\u5730\u65b9\uff0c\u53ef\u4ee5\u5728\u6574\u500b chart \u4e2d\u91cd\u8907\u4f7f\u7528\u3002 mychart/Chart.yaml apiVersion : v2 name : mychart description : A Helm chart for Kubernetes type : application version : 0.1. appVersion : \"1.16.0\" mychart/templates/deployment.yaml apiVersion : apps/v1 kind : Deployment metadata : name : {{ include \"mychart.fullname\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} spec : {{ - if not .Values.autoscaling.enabled }} replicas : {{ .Values.replicaCount }} {{ - end }} selector : matchLabels : {{ - include \"mychart.selectorLabels\" . | nindent 6 }} template : metadata : {{ - with .Values.podAnnotations }} annotations : {{ - toYaml . | nindent 8 }} {{ - end }} labels : {{ - include \"mychart.selectorLabels\" . | nindent 8 }} spec : {{ - with .Values.imagePullSecrets }} imagePullSecrets : {{ - toYaml . | nindent 8 }} {{ - end }} serviceAccountName : {{ include \"mychart.serviceAccountName\" . }} securityContext : {{ - toYaml .Values.podSecurityContext | nindent 8 }} containers : - name : {{ .Chart.Name }} securityContext : {{ - toYaml .Values.securityContext | nindent 12 }} image : \"{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}\" imagePullPolicy : {{ .Values.image.pullPolicy }} ports : - name : http containerPort : 80 protocol : TCP livenessProbe : httpGet : path : / port : http readinessProbe : httpGet : path : / port : http resources : {{ - toYaml .Values.resources | nindent 12 }} {{ - with .Values.nodeSelector }} nodeSelector : {{ - toYaml . | nindent 8 }} {{ - end }} {{ - with .Values.affinity }} affinity : {{ - toYaml . | nindent 8 }} {{ - end }} {{ - with .Values.tolerations }} tolerations : {{ - toYaml . | nindent 8 }} {{ - end }} mychart/templates/hpa.yaml {{ - if .Values.autoscaling.enabled }} apiVersion : autoscaling/v2beta1 kind : HorizontalPodAutoscaler metadata : name : {{ include \"mychart.fullname\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} spec : scaleTargetRef : apiVersion : apps/v1 kind : Deployment name : {{ include \"mychart.fullname\" . }} minReplicas : {{ .Values.autoscaling.minReplicas }} maxReplicas : {{ .Values.autoscaling.maxReplicas }} metrics : {{ - if .Values.autoscaling.targetCPUUtilizationPercentage }} - type : Resource resource : name : cpu targetAverageUtilization : {{ .Values.autoscaling.targetCPUUtilizationPercentage }} {{ - end }} {{ - if .Values.autoscaling.targetMemoryUtilizationPercentage }} - type : Resource resource : name : memory targetAverageUtilization : {{ .Values.autoscaling.targetMemoryUtilizationPercentage }} {{ - end }} {{ - end }} mychart/templates/ingress.yaml {{ - if .Values.ingress.enabled - }} {{ - $fullName : = include \"mychart.fullname\" . - }} {{ - $svcPort : = .Values.service.port - }} {{ - if and .Values.ingress.className (not (semverCompare \">=1.18-0\" .Capabilities.KubeVersion.GitVersion)) }} {{ - if not (hasKey .Values.ingress.annotations \"kubernetes.io/ingress.class\") }} {{ - $_ : = set .Values.ingress.annotations \"kubernetes.io/ingress.class\" .Values.ingress.className }} {{ - end }} {{ - end }} {{ - if semverCompare \">=1.19-0\" .Capabilities.KubeVersion.GitVersion - }} apiVersion : networking.k8s.io/v1 {{ - else if semverCompare \">=1.14-0\" .Capabilities.KubeVersion.GitVersion - }} apiVersion : networking.k8s.io/v1beta1 {{ - else - }} apiVersion : extensions/v1beta1 {{ - end }} kind : Ingress metadata : name : {{ $fullName }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} {{ - with .Values.ingress.annotations }} annotations : {{ - toYaml . | nindent 4 }} {{ - end }} spec : {{ - if and .Values.ingress.className (semverCompare \">=1.18-0\" .Capabilities.KubeVersion.GitVersion) }} ingressClassName : {{ .Values.ingress.className }} {{ - end }} {{ - if .Values.ingress.tls }} tls : {{ - range .Values.ingress.tls }} - hosts : {{ - range .hosts }} - {{ . | quote }} {{ - end }} secretName : {{ .secretName }} {{ - end }} {{ - end }} rules : {{ - range .Values.ingress.hosts }} - host : {{ .host | quote }} http : paths : {{ - range .paths }} - path : {{ .path }} {{ - if and .pathType (semverCompare \">=1.18-0\" $.Capabilities.KubeVersion.GitVersion) }} pathType : {{ .pathType }} {{ - end }} backend : {{ - if semverCompare \">=1.19-0\" $.Capabilities.KubeVersion.GitVersion }} service : name : {{ $fullName }} port : number : {{ $svcPort }} {{ - else }} serviceName : {{ $fullName }} servicePort : {{ $svcPort }} {{ - end }} {{ - end }} {{ - end }} {{ - end }} mychart/templates/serviceaccount.yaml {{ - if .Values.serviceAccount.create - }} apiVersion : v1 kind : ServiceAccount metadata : name : {{ include \"mychart.serviceAccountName\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} {{ - with .Values.serviceAccount.annotations }} annotations : {{ - toYaml . | nindent 4 }} {{ - end }} {{ - end }} mychart/templates/service.yaml apiVersion : v1 kind : Service metadata : name : {{ include \"mychart.fullname\" . }} labels : {{ - include \"mychart.labels\" . | nindent 4 }} spec : type : {{ .Values.service.type }} ports : - port : {{ .Values.service.port }} targetPort : http protocol : TCP name : http selector : {{ - include \"mychart.selectorLabels\" . | nindent 4 }} mychart/values.yaml # Default values for mychart. # This is a YAML-formatted file. # Declare variables to be passed into your templates. replicaCount : 1 image : repository : nginx pullPolicy : IfNotPresent # Overrides the image tag whose default is the chart appVersion. tag : \"\" imagePullSecrets : [] nameOverride : \"\" fullnameOverride : \"\" serviceAccount : # Specifies whether a service account should be created create : true # Annotations to add to the service account annotations : {} # The name of the service account to use. # If not set and create is true, a name is generated using the fullname template name : \"\" podAnnotations : {} podSecurityContext : {} # fsGroup: 2000 securityContext : {} # capabilities: # drop: # - ALL # readOnlyRootFilesystem: true # runAsNonRoot: true # runAsUser: 1000 service : type : ClusterIP port : 80 ingress : enabled : false className : \"\" annotations : {} # kubernetes.io/ingress.class: nginx # kubernetes.io/tls-acme: \"true\" hosts : - host : chart-example.local paths : - path : / pathType : ImplementationSpecific tls : [] # - secretName: chart-example-tls # hosts: # - chart-example.local resources : {} # We usually recommend not to specify default resources and to leave this as a conscious # choice for the user. This also increases chances charts run on environments with little # resources, such as Minikube. If you do want to specify resources, uncomment the following # lines, adjust them as necessary, and remove the curly braces after 'resources:'. # limits: # cpu: 100m # memory: 128Mi # requests: # cpu: 100m # memory: 128Mi autoscaling : enabled : false minReplicas : 1 maxReplicas : 100 targetCPUUtilizationPercentage : 80 # targetMemoryUtilizationPercentage: 80 nodeSelector : {} tolerations : [] affinity : {}","title":"\u6b65\u9a5f 1. helm create \u5275\u5efa Chart"},{"location":"kubernetes/package/helm-app-deploy/#2-helm-install","text":"\u9032\u5165\u9019\u500b chart \u7684\u76ee\u9304: cd mychart \u90e8\u7f72\u9019\u500b chart: helm install web mychart/ \u547d\u4ee4\u7d50\u679c\u5982\u4e0b\u6240\u793a: NAME: web LAST DEPLOYED: Sat Aug 6 19:33:08 2022 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: 1. Get the application URL by running these commands: export POD_NAME=$(kubectl get pods --namespace default -l \"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=web\" -o jsonpath=\"{.items[0].metadata.name}\") export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath=\"{.spec.containers[0].ports[0].containerPort}\") echo \"Visit http://127.0.0.1:8080 to use your application\" kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT \u547d\u4ee4\u67e5\u770b\u53ef\u4ee5\u770b\u5230\u5df2\u7d93\u90e8\u7f72\u6210\u529f: helm list \u547d\u4ee4\u7d50\u679c\u5982\u4e0b\u6240\u793a: NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION web default 1 2022-08-06 19:33:08.884653922 +0800 CST deployed mychart-0.1.0 1.16.0 \u6aa2\u67e5 kubernetes \u61c9\u7528\u88ab\u4f48\u7f72\u7684\u72c0\u614b: $ kubectl get all NAME READY STATUS RESTARTS AGE pod/web-mychart-5f94885968-wbwth 1 /1 Running 0 4m38s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 9h service/web-mychart ClusterIP 10 .43.244.237 <none> 80 /TCP 4m38s NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/web-mychart 1 /1 1 1 4m38s NAME DESIRED CURRENT READY AGE replicaset.apps/web-mychart-5f94885968 1 1 1 4m38s \u8b93\u6211\u5011\u4f7f\u7528 kubectl port-forward \u4f86\u6aa2\u67e5\u88ab\u4f48\u7f72\u7684\u61c9\u7528: kubectl port-forward service/web-mychart 8080:80 --address='0.0.0.0' \u7aef\u53e3\u8f49\u767c\u547d\u4ee4\u7684\u8a9e\u6cd5\u5982\u4e0b\u3002 kubectl port-forward svc/ [ service-name ] -n [ namespace ] [ external-port ] : [ internal-port ] --address = '0.0.0.0'","title":"\u6b65\u9a5f 2. helm install \u90e8\u7f72"},{"location":"kubernetes/package/helm-app-deploy/#3-helm-upgrade","text":"helm \u9664\u4e86\u652f\u6301\u53c3\u6578\u503c\u53c3\u6578\u50b3\u905e\uff0c\u9084\u652f\u6301\u52d5\u614b\u50b3\u8f38\uff0c\u5982\u4e0b: helm install web mychart/ --set replicaCount = 2 \u7531\u65bc\u5728 \u6b65\u9a5f #1 \u6211\u5011\u5df1\u7d93\u9032\u884c\u4e86\u7b2c\u4e00\u6b21\u7684\u4f48\u7f72\uff0c\u4e0b\u5217\u7684\u547d\u4ee4\u53ef\u67e5\u8a62\u4f48\u7f72\u6b77\u53f2: $ helm history web REVISION UPDATED STATUS CHART APP VERSION DESCRIPTION 1 Sat Aug 6 19 :33:08 2022 deployed mychart-0.1.0 1 .16.0 Install complete \u8b93\u6211\u5011\u4f7f\u7528\u53c3\u6578\u50b3\u905e\u7684\u624b\u6cd5\u4f86\u66f4\u65b0\u5df1\u4f48\u7f72\u7684\u61c9\u7528: helm upgrade web mychart/ --set replicaCount = 2 \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Release \"web\" has been upgraded. Happy Helming! NAME: web LAST DEPLOYED: Sat Aug 6 20:11:31 2022 NAMESPACE: default STATUS: deployed REVISION: 2 NOTES: 1. Get the application URL by running these commands: export POD_NAME=$(kubectl get pods --namespace default -l \"app.kubernetes.io/name=mychart,app.kubernetes.io/instance=web\" -o jsonpath=\"{.items[0].metadata.name}\") export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath=\"{.spec.containers[0].ports[0].containerPort}\") echo \"Visit http://127.0.0.1:8080 to use your application\" kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT \u6aa2\u67e5\u61c9\u7528\u88ab\u4f48\u7f72\u7684\u72c0\u614b: $ kubectl get all NAME READY STATUS RESTARTS AGE pod/web-mychart-5f94885968-wbwth 1 /1 Running 0 40m pod/web-mychart-5f94885968-x7mpp 1 /1 Running 0 112s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT ( S ) AGE service/kubernetes ClusterIP 10 .43.0.1 <none> 443 /TCP 10h service/web-mychart ClusterIP 10 .43.244.237 <none> 80 /TCP 40m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/web-mychart 2 /2 2 2 40m NAME DESIRED CURRENT READY AGE replicaset.apps/web-mychart-5f94885968 2 2 2 40m \u53ef\u767c\u73fe\u73fe\u5728\u6709 2 Pods \u88ab\u4f48\u7f72\u8d77\u4f86\u3002","title":"\u6b65\u9a5f 3. helm upgrade \u66f4\u65b0"},{"location":"kubernetes/package/helm-app-deploy/#4-helm-rollback","text":"\u73fe\u5728 web \u9019\u500b release \u5df1\u7d93\u6709\u4e86\u591a\u500b\u7248\u672c\u7684\u4f48\u7f72\u8a18\u9304\u4e86\u3002 $ helm history web REVISION UPDATED STATUS CHART APP VERSION DESCRIPTION 1 Sat Aug 6 19:33:08 2022 superseded mychart-0.1.0 1.16.0 Install complete 2 Sat Aug 6 20:11:31 2022 deployed mychart-0.1.0 1.16.0 Upgrade complete \u8981\u9032\u884c\u7248\u672c\u56de\u6efe\u53ef\u4f7f\u7528\u4e0b\u5217\u547d\u4ee4: \u56de\u6efe\u5230\u4e0a\u4e00\u500b\u7248\u672c\uff1a helm rollback web \u56de\u6eda\u5230\u6307\u5b9a\u7248\u672c\uff1a helm rollback web 1 \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Rollback was a success! Happy Helming!","title":"\u6b65\u9a5f 4. helm rollback \u56de\u6efe"},{"location":"kubernetes/package/helm-app-deploy/#5-helm-uninstall","text":"\u548c\u56de\u6efe\u4e00\u6a23\uff0chelm uninstall \u5378\u8f09\u4e5f\u662f \u61c9\u7528 \u7b49\u7d1a\u7684\uff0c\u4e0d\u9700\u8981\u4e00\u500b\u670d\u52d9\u522a\u9664: helm uninstall web \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: release \"web\" uninstalled \u6aa2\u67e5\u7d50\u679c: $ helm list NAME NAMESPACE REVISION UPDATED STATUS CHART APP VERSION $ kubectl get all NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 10h","title":"\u6b65\u9a5f 5. helm uninstall \u5378\u8f09"},{"location":"kubernetes/package/helm-app-deploy/#helm-yaml","text":"\u6709\u4e9b\u6642\u5019\u7576\u4f7f\u7528 helm \u8207 chart \u4f86\u5b89\u88dd\u61c9\u7528\u9032\u5230 Kubernetes \u6642\uff0c\u7576\u51fa\u73fe\u4e00\u4e9b\u554f\u984c\u9700\u8981\u9032\u884c\u9664\u932f\u7684\u6642\u5019\uff0c\u6211\u5011\u6703\u9700\u8981\u53d6\u5f97 helm \u6700\u5f8c\u5ba3\u544a\u9032 kubernetes \u96c6\u7fa4\u6642\u7684 manifest (yaml) \u6a94\u6848\u3002 \u7d93\u7531\u4e0b\u5217\u7684\u547d\u4ee4\u53ef\u9a45\u52d5 helm \u4f86\u6e32\u67d3\u51fa\u76f8\u95dc\u7684 yaml \u6a94\u6848: helm template web-demo mychart/ \u6aa2\u67e5\u7d50\u679c: --- # Source: mychart/templates/serviceaccount.yaml apiVersion: v1 kind: ServiceAccount metadata: name: web-demo-mychart labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm --- # Source: mychart/templates/service.yaml apiVersion: v1 kind: Service metadata: name: web-demo-mychart labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm spec: type: ClusterIP ports: - port: 80 targetPort: http protocol: TCP name: http selector: app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo --- # Source: mychart/templates/deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: name: web-demo-mychart labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm spec: replicas: 1 selector: matchLabels: app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo template: metadata: labels: app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo spec: serviceAccountName: web-demo-mychart securityContext: {} containers: - name: mychart securityContext: {} image: \"nginx:1.16.0\" imagePullPolicy: IfNotPresent ports: - name: http containerPort: 80 protocol: TCP livenessProbe: httpGet: path: / port: http readinessProbe: httpGet: path: / port: http resources: {} --- # Source: mychart/templates/tests/test-connection.yaml apiVersion: v1 kind: Pod metadata: name: \"web-demo-mychart-test-connection\" labels: helm.sh/chart: mychart-0.1.0 app.kubernetes.io/name: mychart app.kubernetes.io/instance: web-demo app.kubernetes.io/version: \"1.16.0\" app.kubernetes.io/managed-by: Helm annotations: \"helm.sh/hook\": test spec: containers: - name: wget image: busybox command: ['wget'] args: ['web-demo-mychart:80'] restartPolicy: Never","title":"helm \u6e32\u67d3 yaml"},{"location":"kubernetes/package/helm-intro/","text":"helm \u5165\u9580\u6559\u5b78 \u00b6 \u539f\u6587: https://zhuanlan.zhihu.com/p/350328164 \u5f15\u8a00 \u00b6 helm \u662f k8s \u7684\u5305\u7ba1\u7406\u5de5\u5177 \uff0c\u4f7f\u7528 helm\uff0c\u53ef\u4ee5\u4f7f\u7528\u66f4\u70ba\u7c21\u5316\u548c\u7cfb\u7d71\u5316\u7684\u65b9\u5f0f \u5c0dk8s\u61c9\u7528\u9032\u884c\u90e8\u7f72\u3001\u5347\u7d1a \u3002 helm \u662f CNCF \u5df2\u7562\u696d\u7684\u9805\u76ee\uff0c\u793e\u7fa4\u4e5f\u662f\u76f8\u7576\u6d3b\u8e8d\u7684\uff0c\u5728 https://artifacthub.io/ \u4e0a\uff0c\u80fd\u627e\u5230\u5f88\u591a\u73fe\u6210\u7684 helm chart\uff0c\u7a0d\u4f5c\u4fee\u6539\u5c31\u80fd\u7528\u5230\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u975e\u5e38\u65b9\u4fbf\u3002 \u672c\u6587\u6703\u4ecb\u7d39 helm \u7684\u6838\u5fc3\u6982\u5ff5\uff0c\u4e26\u7528\u4e00\u500b\u4f8b\u5b50\u5e6b\u52a9\u5927\u5bb6\u66f4\u76f4\u89c0\u7684\u8a8d\u8b58 helm\uff0c\u5927\u5bb6\u53ef\u4ee5\u8ddf\u8457\u9019\u500b\u4f8b\u5b50\u64cd\u4f5c\u4e00\u904d\uff0c\u76f8\u4fe1\u5c0d\u7406\u89e3 helm \u6703\u6709\u975e\u5e38\u5927\u7684\u4f5c\u7528\u3002 \u6559\u7a0b\u6e90\u78bc: cloud-native-tutorial \u4ec0\u9ebc\u662f helm \u00b6 \u521d\u8b58 helm \u00b6 helm \u5728\u5e0c\u81d8\u8a9e\u4e2d\u7684\u610f\u601d\u662f\uff1a \u8235\uff1b\u99d5\u99db\u76e4 \u3002\u64da\u8aaa\u662f helm \u5275\u59cb\u4eba mutt butcher \u7ffb\u904d\u4e86\u822a\u6d77\u624b\u518a\u627e\u51fa\u4f86\u7684\uff0c\u76ee\u7684\u662f\u70ba\u4e86\u627e\u4e00\u500b\u548c kubernetes \u4e3b\u984c\u76f8\u5339\u914d\u7684\u8a5e\u8a9e\u3002 \u5b98\u7db2\u5730\u5740\uff1a https://helm.sh/ \u5b98\u65b9\u7d66\u51fa\u7684\u89e3\u91cb\u662f\uff1a Helm is the best way to find, share, and use software built for Kubernetes . \u610f\u601d\u662f helm \u662f kubernetes \u4e2d\u67e5\u627e\u3001\u5206\u4eab\u3001\u69cb\u5efa\u61c9\u7528\u7684\u6700\u4f73\u65b9\u5f0f\u3002 \u9019\u7a2e\u8aaa\u6cd5\u7576\u7136\u4e0d\u7b97\u8a87\u5f35\uff0cHelm \u5176\u5be6\u662f\u4e00\u500b Kubernetes \u61c9\u7528\u7684\u5305\u7ba1\u7406\u5de5\u5177 \uff0c\u7528\u4f86\u7ba1\u7406 chart \uff08\u4e00\u7a2e\u9810\u5148\u914d\u7f6e\u597d\u7684\u5b89\u88dd\u5305\u8cc7\u6e90\uff09\uff0c\u6709\u9ede\u985e\u4f3c\u65bc Ubuntu \u7684 APT \u548c CentOS \u4e2d\u7684 YUM \u3002\u56e0\u6b64\uff0chelm \u7684\u51fa\u73fe\u89e3\u6c7a\u4e86 k8s \u61c9\u7528\u7ba1\u7406\u80fd\u529b\u7f3a\u5931\u7684\u554f\u984c\u3002 \u53e6\u5916 helm \u4e5f\u662f dev \u548c ops \u7684\u6a4b\u6a11\uff0c\u904b\u7dad\u4eba\u54e1\u5728\u4f7f\u7528 helm \u7684\u6642\u5019\uff0c\u4e00\u65b9\u9762\u4e0d\u9700\u8981\u7406\u89e3\u5927\u91cf\u5728 chart \u4e2d\u7684\u5404\u7a2e k8s \u5143\u7d20\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u5c11\u91cf\u7684\u74b0\u5883\u8b8a\u91cf\u5373\u53ef\u5b89\u88dd\uff1b\u53e6\u4e00\u65b9\u9762\uff0chelm \u4e5f\u7d66\u521d\u7d1a\u904b\u7dad\u4eba\u54e1\u63d0\u4f9b\u4e86\u5b78\u7fd2\u7684\u6a5f\u6703\uff0c\u4ed6\u5011\u53ef\u4ee5\u5728 chart \u4e2d\u5b78\u7fd2\u4e26\u7406\u89e3\u5404\u7a2e k8s \u5143\u7d20\uff0c\u5f9e\u800c\u80fd\u5920\u66f4\u5feb\u7684\u638c\u63e1 k8s\u3002 \u4e0b\u9762\u5217\u8209\u4e86 helm \u7684\u4e00\u4e9b\u95dc\u9375\u4fe1\u606f: 2019 \u5e7411 \u670813 \u65e5\uff0cHelm 3 \u767c\u5e03\uff1b 2020 \u5e7404 \u670830 \u65e5\uff0c\u5f9e CNCF \u4e2d\u7562\u696d\uff1b \u76ee\u524d github \u4e0a\u63a5\u8fd1\u6709 1.9w \u500b Star\uff1b \u6700\u65b0\u7248\u672c\uff1a3.5.0\uff1b \u4e3b\u8981\u4f5c\u8005\uff1aMutt Butcher\uff0c\u76ee\u524d\u5728 Microsoft\uff0c\u4e3b\u8981\u95dc\u6ce8 DevOps \u9818\u57df\u3002 helm \u8207 apt \u5c0d\u6bd4 \u00b6 \u5728\u6211\u5011\u63a5\u89f8\u4e00\u500b\u65b0\u4e8b\u7269\u7684\u6642\u5019\uff0c\u6700\u597d\u7684\u5b78\u7fd2\u65b9\u5f0f\u5c31\u662f\u548c\u6211\u5011\u719f\u6089\u7684\u4e8b\u52d9\u4f86\u505a\u985e\u6bd4\uff0c\u80fd\u5920\u5e6b\u52a9\u6211\u5011\u5feb\u901f\u7684\u638c\u63e1\u5176\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\u3002 \u7531\u65bc Mutt Butcher \u5728\u8a2d\u8a08 helm \u7684\u6642\u5019\uff0c\u5927\u91cf\u53c3\u8003\u4e86 apt \u548c homebrew \u7684\u8a2d\u8a08\uff0c\u9019\u88e1\u6211\u5011\u7528 apt \u4f86\u505a\u5c0d\u6bd4\uff0c\u5e6b\u52a9\u5927\u5bb6\u66f4\u597d\u7684\u7406\u89e3 helm\u3002 \u5f9e\u4e0b\u8868\u4e2d\u53ef\u4ee5\u770b\u5230\uff0chelm \u548c apt \u4e4b\u9593\u6982\u5ff5\u7684\u5c0d\u6bd4\uff0c\u76f8\u4fe1\u719f\u6089 apt \u7684\u540c\u5b78\u80fd\u5920\u5f88\u5feb\u7684\u5c0d helm \u6709\u4e00\u500b\u521d\u6b65\u7684\u8a8d\u8b58\u3002 helm apt \u5b89\u88dd\u5305 chart deb \u5b58\u5132\u5eab helm repository apt repository/mirror \u64cd\u4f5c\u7cfb\u7d71 kubernetes linux distribution \u5305\u4f9d\u8cf4 helm dependency deb dependency \u5305\u7ba1\u7406\u5de5\u5177 helm client apt/apt-get/apt-cache/apt-config helm \u7e3d\u89bd \u00b6 \u5c0d helm \u6709\u4e86\u4e00\u500b\u521d\u6b65\u7684\u5370\u8c61\u4e4b\u5f8c\uff0c\u6211\u5011\u4f86\u5c0d helm \u505a\u4e00\u500b\u7e3d\u89bd\uff0c\u5305\u62ec helm \u7684\u7684\u6838\u5fc3\u6982\u5ff5\u3001\u904b\u884c\u6d41\u7a0b\u3001\u5e38\u7528\u547d\u4ee4\u3001chart \u505a\u4e00\u500b\u6982\u8981\u6027\u7684\u4e86\u89e3\uff0c\u9019\u6a23\u7684\u8a71\uff0c\u5c0d\u6211\u5011\u5f8c\u7e8c\u6df1\u5165 helm \u7684\u5b78\u7fd2\u548c\u5be6\u8e10\u8d77\u4e00\u500b\u7db1\u9818\u7684\u4f5c\u696d\uff0c\u907f\u514d\u53ea\u898b\u6a39\u6728\u3001\u4e0d\u898b\u68ee\u6797\u3002 helm \u4e09\u5927\u6982\u5ff5 \u00b6 chart \uff1achart \u5c31\u662f helm package\uff0c\u5305\u542b\u4e86\u4e00\u500b k8s app \u61c9\u7528\u904b\u884c\u8d77\u4f86\u7684\u6240\u6709\u8981\u7d20\uff0c\u6bd4\u5982 service, deployment, configmap, serviceaccount, rbac, \u7b49\uff0c\u9019\u4e9b\u8981\u7d20\u90fd\u662f\u4ee5template \u6587\u4ef6\u7684\u5f62\u5f0f\u5b58\u5728\uff0c\u518d\u7d50\u5408 values \u6587\u4ef6\uff0c\u6700\u7d42\u6e32\u67d3\u51fa\u80fd\u5920\u88ab k8s \u57f7\u884c\u7684 yaml \u6587\u4ef6\uff1b repository \uff1a\u5009\u5eab\u662f charts \u7684\u96c6\u5408\uff0c\u65b9\u4fbf\u9032\u884c\u5206\u4eab\u548c\u5206\u767c\u3002\u4e0b\u9762\u662f\u5b98\u7db2\u5009\u5eab\u7684\u5730\u5740\uff0c\u5927\u5bb6\u53ef\u4ee5\u9032\u53bb\u770b\u770b\uff0c\u611f\u53d7\u4e00\u4e0b\uff1b https://artifacthub.io/ release \uff1arelease \u662f helm chart \u5728 kubernetes \u7684\u4e00\u500b\u904b\u884c\u5be6\u4f8b\uff0c\u4f60\u53ef\u4ee5\u7528\u4e0d\u540c\u7684 release name \u591a\u6b21\u5b89\u88dd\u540c\u4e00\u500b chart\uff0c\u6bd4\u5982\uff1a\u7576\u96c6\u7fa4\u4e2d\u9700\u8981\u591a\u500b redis \u5be6\u4f8b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u5b89\u88dd redis chart\u3002 helm \u904b\u884c\u6d41\u7a0b \u00b6 \u4e0b\u9762\u9019\u5f35\u5716\u6211\u5efa\u8b70\u5927\u5bb6\u591a\u770b\u5e7e\u904d\uff0c\u53ef\u4ee5\u8aaa\u638c\u63e1\u4e86\u9019\u5f35\u5716\uff0c\u5c31\u638c\u63e1\u4e86helm\u7684\u6838\u5fc3\u3002 \u5f9e\u4e0b\u5716\u53ef\u4ee5\u770b\u5230\uff0chelm \u7684\u6838\u5fc3\u904b\u884c\u6d41\u7a0b\u5206\u70ba\u4ee5\u4e0b\u5e7e\u6b65\uff1a \u5f9e chart \u5009\u5eab\u4e2d\u7372\u53d6 chart \u4f7f\u7528\u8005\u914d\u7f6e\u81ea\u5df1\u7684 values \u6587\u4ef6\uff0c\u6839\u64da\u81ea\u5df1\u7684\u904b\u884c\u74b0\u5883\u5c0d values \u9032\u884c\u4fee\u6539 \u9ed8\u8a8d values \u6587\u4ef6\u548c\u4f7f\u7528\u8005 values \u6587\u4ef6\u6703\u9032\u884c\u4e00\u500b merge\uff0c\u5f62\u6210\u6700\u7d42\u7684 values \u6587\u4ef6 \u4f7f\u7528\u6700\u7d42\u7684 values \u6587\u4ef6\uff0c\u6e32\u67d3 chart \u7684 template\uff0c\u5f62\u6210\u53ef\u4ee5\u88ab kubernetes \u57f7\u884c\u7684 yaml \u8abf\u7528 kube apply \u63d0\u4ea4 yaml \u5230 kubernetes \u5728\u9019\u88e1\uff0c\u9700\u8981\u6ce8\u610f chart \u958b\u767c\u8005\u548c\u4f7f\u7528\u8005\u7684\u754c\u9650\uff0c\u6b63\u662f\u7531\u65bc\u5728\u8de8\u8d8a\u9019\u500b\u754c\u9650\u7684\u6642\u5019\uff0c\u5f9e\u9700\u8981\u7406\u89e3\u5927\u91cf\u7684\u914d\u7f6e\u5230\u53ea\u9700\u8981\u7406\u89e3\u5c11\u91cf\u7684\u914d\u7f6e\uff0c\u4f7f\u5f97 operation \u7684\u5de5\u4f5c\u8b8a\u5f97\u7c21\u4fbf\uff0c\u9019\u4e5f\u662f helm \u6838\u5fc3\u7684\u8a2d\u8a08\u54f2\u5b78\u3002\u770b\u5b8c\u6574\u500b\u6587\u7ae0\uff0c\u5373\u4f7f\u4f60\u4ec0\u9ebc\u90fd\u6c92\u8a18\u4f4f\uff0c\u53ea\u8a18\u4f4f\u4e86\u9019\u5f35\u5716\uff0c\u4f60\u4e5f\u6703\u6709\u5f88\u5927\u7684\u6536\u7a6b\u4e86\u3002 helm \u5e38\u7528\u547d\u4ee4 \u00b6 \u5229\u7528 helm \u4f86\u5b89\u88dd\u61c9\u7528\u81f3 kubernetes \u7684\u6642\u5019\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7b2c\u4e09\u65b9\u958b\u767c\u7684 chart\uff0c\u4e5f\u53ef\u4ee5\u81ea\u5df1\u958b\u767c chart\uff0c\u4ee5\u4e0b\u662f\u5169\u7a2e\u60c5\u6cc1\u4e0b\u4f7f\u7528\u7684\u5e38\u898b\u547d\u4ee4\u3002\u66f4\u70ba\u8a73\u7d30\u7684\u547d\u4ee4\uff0c\u53ef\u4ee5\u5b89\u88dd\u597d helm \u4e4b\u5f8c\uff0c\u4f7f\u7528 helm help \u4f86\u67e5\u770b\uff0c\u6216\u67e5\u770b\u5b98\u65b9\u6587\u6a94\u3002 Usage: helm [command] Available Commands: completion generate autocompletion scripts for the specified shell create create a new chart with the given name dependency manage a chart's dependencies env helm client environment information get download extended information of a named release help Help about any command history fetch release history install install a chart lint examine a chart for possible issues list list releases package package a chart directory into a chart archive plugin install, list, or uninstall Helm plugins pull download a chart from a repository and (optionally) unpack it in local directory push push a chart to remote registry login to or logout from a registry repo add, list, remove, update, and index chart repositories rollback roll back a release to a previous revision search search for a keyword in charts show show information of a chart status display the status of the named release template locally render templates test run tests for a release uninstall uninstall a release upgrade upgrade a release verify verify that a chart at the given path has been signed and is valid version print the client version information \u4f7f\u7528\u7b2c\u4e09\u65b9\u958b\u767c\u7684 chart \u00b6 \u90e8\u7f72\u524d: repo: add, list, remove, update, and index chart repositories search: search for a keyword in charts \u90e8\u7f72\u540e: install: install a chart list: list releases status: display the status of the named release upgrade: upgrade a release rollback: roll back a release to a previous revision uninstall: uninstall a release \u81ea\u5df1\u958b\u767c chart: \u00b6 lint: examine a chart for possible issues package: package a chart directory into a chart archive push: push helm chart to chartmuseum chart push: push helm chart to OCI repository chart \u00b6 chart \u53ef\u4ee5\u8aaa\u662f helm \u88e1\u9762\u6700\u91cd\u8981\u7684\u6982\u5ff5\u4e86\uff0c\u95dc\u65bc chart \u4e5f\u6709\u5f88\u591a\u5167\u5bb9\u9700\u8981\u638c\u63e1\uff0c\u5728\u9019\u88e1\u505a\u4e00\u500b\u5217\u8209\u3002 chart \u958b\u767c \uff1a\u4e3b\u8981\u662f\u6307\u5229\u7528\u6a21\u677f\u6280\u8853\u958b\u767c\u4e00\u500b chart\uff0c\u6703\u5728\u5f8c\u9762\u505a\u8a73\u7d30\u4ecb\u7d39\uff1b chart hooks \uff1a\u5728 chart \u7684\u751f\u547d\u9031\u671f\u4e2d\uff0c\u63d0\u4f9b\u4e00\u4e9b hooks\uff0c\u65b9\u4fbf\u9032\u884c\u4e00\u4e9b\u524d\u7f6e\u6216\u5f8c\u7f6e\u64cd\u4f5c \u5728 chart \u5b89\u88dd\u524d\uff0c\u5275\u5efa\u61c9\u7528\u9700\u8981\u7684 Secret \u5728 chart \u5b89\u88dd\u524d\uff0c\u5099\u4efd\u6578\u64da\u5eab \u5728 chart \u5378\u8f09\u5f8c\uff0c\u505a\u4e00\u4e9b\u6e05\u7406\u5de5\u4f5c chart test \uff1a\u7576\u4f60 install \u4e86\u4e00\u500b chart \u5f8c\uff0c\u5982\u4f55\u77e5\u9053\u9019\u500b release \u662f\u5426\u904b\u884c\u6b63\u5e38\u5462\uff1f chart test \u63d0\u4f9b\u4e86\u4e00\u7a2e\u6e2c\u8a66\u7684\u65b9\u5f0f\uff0c\u4f86\u9a57\u8b49\u4f60\u7684\u61c9\u7528\u662f\u5426\u6b63\u5e38\u904b\u884c\uff0c\u6bd4\u5982\uff1a \u6821\u9a57 mysql \u61c9\u7528\u80fd\u5920\u6b63\u5e38\u9023\u63a5\u4e26\u63a5\u53d7\u8acb\u6c42 \u6821\u9a57 services \u80fd\u5920\u6b63\u5e38\u505a load balance library chart \uff1a\u4e00\u7a2e\u4ee5 library \u5f62\u5f0f\u5b58\u5728\u7684 chart\uff0c\u53ef\u4ee5 \u5728application chart \u4e4b\u9593\u9032\u884c\u5171\u4eab\u907f\u514d\u91cd\u8907\u908f\u8f2f\uff1b\u985e\u4f3c\u65bc\u7de8\u7a0b\u8a9e\u8a00\u4e2d\u7684 public library\uff1b chart \u6821\u9a57 \uff1a\u57fa\u65bc PKI\u3001GnuPG \u7b49\u6280\u8853\uff0c\u5c0d helm package \u9032\u884c\u7c3d\u540d\uff0c\u4fdd\u8b49\u50b3\u8f38\u6216\u767c\u5e03\u904e\u7a0b\u4e2d\u7684\u5b89\u5168\u6027\uff1b OCI\uff08Open Container Initiative\uff0c\u5bb9\u5668\u958b\u653e\u898f\u7bc4\uff09\u652f\u6301 \uff1ahelm 3\u5f15\u5165\uff08EXPERIMENTAL\uff09\uff0c\u80fd\u5920\u5c07 chart \u63a8\u9001\u5230\u652f\u6301 OCI \u7684\u5009\u5eab\u4e2d\uff0c\u6bd4\u5982 harbor, nexus\uff0c\u7b49\uff0c\u6bd4\u5982\uff0c\u5c07 chart \u4fdd\u5b58\u5230 harbor \u4e2d\uff1a \u4fdd\u5b58 chart \uff1a helm chart save kubeedge/some-harbor-repo/kubeedge-cloud-chart:1.0.0 \u767b\u9304 repo \uff1a helm registry login https://some-harbor-repo \u63a8\u9001 chart \uff1a helm chart push some-harbor-repo/kubeedge-cloud-chart:1.0.0 \u9ad8\u7d1a\u7279\u6027 : post rendering: \u63d0\u4f9b\u5728 helm install \u4e4b\u524d\u5c0d manifests \u9032\u884c\u64cd\u4f5c\u3001\u914d\u7f6e\u7684\u4e00\u7a2e\u6a5f\u5236\uff1b\u4e00\u822c\u7d50\u5408 kustomize \u4f7f\u7528\u3002\u6bd4\u5982\uff1a \u5728 install \u6642\u63d2\u5165 sidecar\uff0c\u5f9e\u800c\u70ba deployment \u589e\u52a0\u529f\u80fd \u4e0d\u4fee\u6539\u539f chart \u7684\u60c5\u6cc1\u4e0b\uff0c\u66f4\u6539 manifests \u7684\u914d\u7f6e \u9019\u53ef\u80fd\u4e0d\u662f\u975e\u5e38\u597d\u7406\u89e3\uff0c\u9019\u88e1\u8209\u4e00\u500b\u4f8b\u5b50\uff0c\u5047\u8a2d\u6211\u9700\u8981\u5c0d\u4e00\u500b\u7b2c\u4e09\u65b9\u7684 chart \u505a\u5c11\u91cf\u7684\u4fee\u6539\uff0c\u4ee5\u6eff\u8db3\u6211\u7684\u90e8\u7f72\u8981\u6c42\uff0c\u90a3\u9ebc\u6211\u53ef\u4ee5 fork \u4e00\u4efd\u9019\u500b chart\uff0c\u7136\u5f8c\u5728\u4e0a\u9762\u505a\u4fee\u6539\uff0c\u4f46\u662f\u9019\u6a23\u6211\u9700\u8981\u4e00\u4e9b\u984d\u5916\u7684\u7dad\u8b77\u5de5\u4f5c\uff0c\u7576\u9019\u500b chart \u5347\u7d1a\u4e4b\u5f8c\uff0c\u6211\u9084\u9700\u8981\u505a merge \u7684\u5de5\u4f5c\uff0c\u5341\u5206\u4e0d\u4fbf\u3002 \u56e0\u6b64 post rendering \u63d0\u4f9b\u4e86\u4e00\u7a2e\u6a5f\u5236\uff0c\u4f60\u53ea\u9700\u8981\u4f7f\u7528 post rendering+kustomize \u7de8\u5beb\u7684\u4e00\u500b\u8173\u672c\uff0c\u5c31\u53ef\u4ee5\u5728 install \u524d\uff0c\u5c0d\u539f\u59cb chart \u7684\u5167\u5bb9\u505a\u4e00\u4e9b\u5b9a\u5236\u5316\u7684\u4fee\u6539\uff0c\u907f\u514d\u4e86\u984d\u5916\u7684\u7dad\u8b77\u5de5\u4f5c\u3002\u5982\u4e0b\u5716\u6240\u793a\u3002 \uff08kustomize\u662f\u4e00\u500b\u958b\u6e90\u7684\u914d\u7f6e\u5de5\u5177\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u5c0d\u73fe\u6709\u7684k8s app\u914d\u7f6e\u505a\u4e00\u4e9b\u5b9a\u5236\u5316\u7684\u4fee\u6539\uff0c\u5b98\u7db2\u5730\u5740\uff1a https://kustomize.io/ \uff09 helm \u6f14\u793a \u00b6 \u4e0b\u9762\u6211\u5011\u4e00\u8d77\u7528\u4e00\u500b demo \u4f86\u5c0d helm \u6709\u4e00\u500b\u66f4\u70ba\u76f4\u89c0\u7684\u4e86\u89e3\u3002\u5728\u9019\u500bdemo\u4e2d\uff0c\u6211\u5011\u7684\u76ee\u6a19\u662f\u90e8\u7f72\u4e00\u500b redis \u96c6\u7fa4\uff0c\u5305\u62ec\u4ee5\u4e0b\u5e7e\u500b\u6b65\u9a5f\uff1a \u5b89\u88dd helm \u4f7f\u7528 helm install \u55ae\u7bc0\u9ede redis \u4f7f\u7528 helm upgrade \u5347\u7d1a\u5230 master-replicas \u4f7f\u7528 helm rollback\uff0c\u56de\u6efe\u5230\u55ae\u7bc0\u9ede\u6a21\u5f0f \u6b65\u9a5f1\uff1a\u5b89\u88dd helm\uff08\u901a\u904e\u8173\u672c\uff09 \u00b6 \u4ee5\u4e0b\u662f\u901a\u904e\u811a\u672c\u5b89\u88c5 helm \u7684\u547d\u4ee4\uff0c\u5176\u4ed6\u7684\u5b89\u88dd\u65b9\u5f0f\u53ef\u53c3\u8003 \u5b98\u7db2 \uff1a $ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 $ chmod 700 get_helm.sh $ ./get_helm.sh \u6b65\u9a5f2\uff1a\u6dfb\u52a0\u5009\u5eab\u4e26\u627e\u5230 redis chart \u00b6 \u5c0b\u627e\u53ef\u4f7f\u7528 Helm \u4f86\u5b89\u88dd\u9032 Kubernetes \u7684\u61c9\u7528\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u662f\u4f7f\u7528 ArtifactHUB \u5728\u641c\u7d22\u6b04\u4e2d\u9375\u5165 redis \u4e26\u5f9e\u4e2d\u9078\u64c7\u5408\u9069\u7684\u6253\u5305\u597d\u7684\u61c9\u7528\u3002\u5728\u6f14\u793a\u4e2d\u6211\u5011\u4f7f\u7528\u4e86 bitnami \u6253\u5305\u597d\u7684 redis \u4f86\u6f14\u793a\u5982\u4f55\u4f7f\u7528 helm\u3002 bitnami redis 1. \u6dfb\u52a0\u5009\u5eab \uff1a helm repo add bitnami https://charts.bitnami.com/bitnami \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: \"bitnami\" has been added to your repositories 2. \u67e5\u770b\u5df2\u7d93\u6dfb\u52a0\u7684\u5009\u5eab helm repo list \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME URL bitnami https://charts.bitnami.com/bitnami 3. \u641c\u7d22\u5009\u5eab\u6709\u54ea\u4e9b chart \uff1a helm search repo bitnami \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: $ helm search repo bitnami NAME CHART VERSION APP VERSION DESCRIPTION bitnami/airflow 13.0.2 2.3.3 Apache Airflow is a tool to express and execute... bitnami/apache 9.1.16 2.4.54 Apache HTTP Server is an open-source HTTP serve... bitnami/argo-cd 4.0.6 2.4.8 Argo CD is a continuous delivery tool for Kuber... bitnami/argo-workflows 2.3.8 3.3.8 Argo Workflows is meant to orchestrate Kubernet... bitnami/aspnet-core 3.4.18 6.0.7 ASP.NET Core is an open-source framework for we... bitnami/cassandra 9.2.11 4.0.5 Apache Cassandra is an open source distributed ... bitnami/cert-manager 0.7.7 1.9.1 Cert Manager is a Kubernetes add-on to automate... bitnami/common 1.16.1 1.16.0 A Library Helm Chart for grouping common logic ... ... ... 4. \u66f4\u65b0\u5009\u5eab\u5217\u8868\u5230\u672c\u5730 \uff1a helm repo update \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"bitnami\" chart repository Update Complete. \u2388Happy Helming!\u2388 5. \u641c\u7d22 redis \uff1a helm search repo redis \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME CHART VERSION APP VERSION DESCRIPTION bitnami/redis 17.0.8 7.0.4 Redis(R) is an open source, advanced key-value ... bitnami/redis-cluster 8.1.3 7.0.4 Redis(R) is an open source, scalable, distribut... 6. \u67e5\u770b redis chart \u8a73\u60c5 \uff1a helm show chart bitnami/redis \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: annotations: category: Database apiVersion: v2 appVersion: 7.0.4 dependencies: - name: common repository: https://charts.bitnami.com/bitnami tags: - bitnami-common version: 1.x.x description: Redis(R) is an open source, advanced key-value store. It is often referred to as a data structure server since keys can contain strings, hashes, lists, sets and sorted sets. home: https://github.com/bitnami/charts/tree/master/bitnami/redis icon: https://bitnami.com/assets/stacks/redis/img/redis-stack-220x234.png keywords: - redis - keyvalue - database maintainers: - name: Bitnami url: https://github.com/bitnami/charts - email: cedric@desaintmartin.fr name: desaintmartin name: redis sources: - https://github.com/bitnami/containers/tree/main/bitnami/redis version: 17.0.8 7. \u67e5\u770b redis values\uff08values\uff1a\u76f8\u7576\u65bcchart\u7684\u914d\u7f6e\u6587\u4ef6\uff09 \uff1a helm show values bitnami/redis \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: ## @section Global parameters ## Global Docker image parameters ## Please, note that this will override the image parameters, including dependencies, configured to use the global value ## Current available global Docker image parameters: imageRegistry, imagePullSecrets and storageClass ## ## @param global.imageRegistry Global Docker image registry ## @param global.imagePullSecrets Global Docker registry secret names as an array ## @param global.storageClass Global StorageClass for Persistent Volume(s) ## @param global.redis.password Global Redis&reg; password (overrides `auth.password`) ## global: imageRegistry: \"\" ## E.g. ## imagePullSecrets: ## - myRegistryKeySecretName ## imagePullSecrets: [] storageClass: \"\" redis: password: \"\" ## @section Common parameters ## ## @param kubeVersion Override Kubernetes version ## kubeVersion: \"\" ## @param nameOverride String to partially override common.names.fullname ## nameOverride: \"\" ... ... \u6b65\u9aa43\uff1ainstall/upgrade/rollback/uninstall \u00b6 \u5efa\u7acb\u55ae\u500b redis master \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u540d\u70ba only-master.values : only-master.values ## Redis architecture. architecture : \"standalone\" ## Redis password (both master and slave) auth : password : \"admin\" \u7136\u540e --dry-run \u4e00\u4e0b\uff0c\u770b\u770b\u751f\u6210\u51fa\u6765\u7684 yaml \u6587\u4ef6\u662f\u5426\u5b58\u5728\u95ee\u9898\uff1a helm install redis-demo bitnami/redis -f ./only-master.values --dry-run \u5982\u679c\u6c92\u6709\u554f\u984c\uff0c\u5247\u9032\u884c\u5be6\u969b\u7684\u5b89\u88dd : helm install redis-demo bitnami/redis -f ./only-master.values \u6aa2\u67e5\u5b89\u88dd\u7d50\u679c: kubectl get pods \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME READY STATUS RESTARTS AGE pod/redis-demo-master-0 1/1 Running 0 49s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 14m service/redis-demo-headless ClusterIP None <none> 6379/TCP 49s service/redis-demo-master ClusterIP 10.43.44.179 <none> 6379/TCP 49s NAME READY AGE statefulset.apps/redis-demo-master 1/1 49s \u5b89\u88dd\u6210\u529f\u4e4b\u5f8c\uff0c\u53ef\u4ee5\u767b\u9304 redis \u9032\u884c\u64cd\u4f5c\uff0c\u505a\u9032\u4e00\u6b65\u7684\u6821\u9a57\uff1a $ kubectl exec -it pod/redis-demo-master-0 -- /bin/bash I have no name!@redis-demo-master-0:/$ redis-cli -h localhost -a admin localhost:6379> set name dxlab OK localhost:6379> get name \"dxlab\" localhost:6379> info replication # Replication role:master connected_slaves:0 # \u53ef\u4ee5\u770b\u5230\u9019\u6642\u5019\u6c92\u6709slave\u9023\u63a5 master_failover_state:no-failover master_replid:0a6c5c20a0b1623802e4df933e5c91e380cb57dc master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 \u5efa\u7acb master-replicas \u914d\u7f6e\u6587\u4ef6\uff0c\u540d\u4e3a master-replicas.values : master-replicas.values ## Redis architecture. architecture : \"replication\" ## Redis password auth : password : \"admin\" ## Number of Redis replicas to deploy replica : replicaCount : 2 --dry-run \u4e00\u4e0b\uff0c\u770b\u770b\u751f\u6210\u51fa\u4f86\u7684 yaml \u6587\u4ef6\u662f\u5426\u5b58\u5728\u554f\u984c\uff1b helm upgrade redis-demo bitnami/redis -f ./master-replicas.values --dry-run \u7531\u65bc\u5728\u7cfb\u7d71\u4e2d\u5df2\u7d93\u6709 redis-demo \u7684 release\uff0c\u56e0\u6b64\u4f7f\u7528 upgrade \u4f86\u9032\u884c\u5347\u7d1a \uff1a helm upgrade redis-demo bitnami/redis -f ./master-replicas.values \u6aa2\u67e5\u5b89\u88dd\u7d50\u679c: kubectl get pods \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME READY STATUS RESTARTS AGE pod/redis-demo-master-0 1/1 Running 0 20m pod/redis-demo-replicas-0 1/1 Running 0 20m pod/redis-demo-replicas-1 0/1 Running 0 21s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 37m service/redis-demo-headless ClusterIP None <none> 6379/TCP 24m service/redis-demo-master ClusterIP 10.43.44.179 <none> 6379/TCP 24m service/redis-demo-replicas ClusterIP 10.43.204.190 <none> 6379/TCP 20m NAME READY AGE statefulset.apps/redis-demo-master 1/1 24m statefulset.apps/redis-demo-replicas 1/2 20m \u6aa2\u67e5\u5f9e\u5c6c replicas \u662f\u5426\u5b89\u88dd\u6210\u529f\uff0c\u4ee5\u53ca\u662f\u5426\u540c\u6b65\u6210\u529f\uff1a $ kubectl exec -it pod/redis-demo-replicas-0 -- /bin/bash I have no name!@redis-demo-replicas-0:/$ redis-cli -h localhost -a admin localhost:6379> get name \"dxlab\" localhost:6379> info replication # Replication role:slave master_host:redis-demo-master-0.redis-demo-headless.default.svc.cluster.local master_port:6379 master_link_status:up master_last_io_seconds_ago:4 master_sync_in_progress:0 slave_read_repl_offset:1904 slave_repl_offset:1904 slave_priority:100 slave_read_only:1 replica_announced:1 connected_slaves:0 master_failover_state:no-failover master_replid:4763ace80c07c84f1925cda63252ba01d4efdc7e master_replid2:0000000000000000000000000000000000000000 master_repl_offset:1904 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:15 repl_backlog_histlen:1890 \u5f9e\u9a57\u8b49\u7684\u7d50\u679c\u4f86\u770b Redis \u7684 replicas \u7684\u78ba\u4e5f\u53d6\u5f97\u5728\u4e4b\u524d master \u4e0a\u8a2d\u7f6e\u7684\u9375\u503c\u3002 \u6700\u5f8c\uff0c\u56de\u6efe\u81f3\u55ae\u4e3b\u6a21\u5f0f : \u67e5\u770b\u6b77\u53f2\u90e8\u7f72: helm history redis-demo \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: REVISION UPDATED STATUS CHART APP VERSION DESCRIPTION 1 Sat Aug 6 11:09:17 2022 superseded redis-17.0.8 7.0.4 Install complete 2 Sat Aug 6 11:17:59 2022 deployed redis-17.0.8 7.0.4 Upgrade complete \u56de\u6efe\u5230\u7684\u55aemaster\u7248\u672c (REVISION = 1) \uff1a helm rollback redis-demo 1 \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Rollback was a success! Happy Helming! \u6aa2\u67e5\u56de\u6efe\u7d50\u679c: kubectl get pods \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME READY STATUS RESTARTS AGE pod/redis-demo-master-0 1/1 Running 0 75s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 70m service/redis-demo-headless ClusterIP None <none> 6379/TCP 12m service/redis-demo-master ClusterIP 10.43.66.90 <none> 6379/TCP 12m NAME READY AGE statefulset.apps/redis-demo-master 1/1 12m \u8907\u672c\u7684 Pods \u5df1\u7d93\u90fd\u4e0d\u5b58\u5728\u4e86\u3002 \u5378\u8f09 redis-demo : helm uninstall redis-demo \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: release \"redis-demo\" uninstalled helm \u6e32\u67d3 yaml \u00b6 \u6709\u4e9b\u6642\u5019\u7576\u4f7f\u7528 helm \u8207 chart \u4f86\u5b89\u88dd\u61c9\u7528\u9032\u5230 Kubernetes \u6642\uff0c\u7576\u51fa\u73fe\u4e00\u4e9b\u554f\u984c\u9700\u8981\u9032\u884c\u9664\u932f\u7684\u6642\u5019\uff0c\u6211\u5011\u6703\u9700\u8981\u53d6\u5f97 helm \u6700\u5f8c\u5ba3\u544a\u9032 kubernetes \u96c6\u7fa4\u6642\u7684 manifest (yaml) \u6a94\u6848\u3002 \u7d93\u7531\u4e0b\u5217\u7684\u547d\u4ee4\u53ef\u9a45\u52d5 helm \u4f86\u6e32\u67d3\u51fa\u76f8\u95dc\u7684 yaml \u6a94\u6848: helm template redis-demo bitnami/redis -f only-master.values --- # Source: redis/templates/serviceaccount.yaml apiVersion : v1 kind : ServiceAccount automountServiceAccountToken : true metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm --- # Source: redis/templates/secret.yaml apiVersion : v1 kind : Secret metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm type : Opaque data : redis-password : \"YWRtaW4=\" --- # Source: redis/templates/configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-configuration namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : redis.conf : |- # User-supplied common configuration: # Enable AOF https://redis.io/topics/persistence#append-only-file appendonly yes # Disable RDB persistence, AOF persistence already enabled. save \"\" # End of common configuration master.conf : |- dir /data # User-supplied master configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of master configuration replica.conf : |- dir /data # User-supplied replica configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of replica configuration --- # Source: redis/templates/health-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-health namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : ping_readiness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ] && [ \"$responseFirstWord\" != \"MASTERDOWN\" ]; then echo \"$response\" exit 1 fi ping_readiness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ]; then echo \"$response\" exit 1 fi ping_readiness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_readiness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_readiness_master.sh\" $1 || exit_status=$? exit $exit_status ping_liveness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_liveness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_liveness_master.sh\" $1 || exit_status=$? exit $exit_status --- # Source: redis/templates/scripts-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-scripts namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : start-master.sh : | #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" if [[ ! -f /opt/bitnami/redis/etc/master.conf ]];then cp /opt/bitnami/redis/mounted-etc/master.conf /opt/bitnami/redis/etc/master.conf fi if [[ ! -f /opt/bitnami/redis/etc/redis.conf ]];then cp /opt/bitnami/redis/mounted-etc/redis.conf /opt/bitnami/redis/etc/redis.conf fi ARGS=(\"--port\" \"${REDIS_PORT}\") ARGS+=(\"--requirepass\" \"${REDIS_PASSWORD}\") ARGS+=(\"--masterauth\" \"${REDIS_PASSWORD}\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/redis.conf\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/master.conf\") exec redis-server \"${ARGS[@]}\" --- # Source: redis/templates/headless-svc.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-headless namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm annotations : spec : type : ClusterIP clusterIP : None ports : - name : tcp-redis port : 6379 targetPort : redis selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo --- # Source: redis/templates/master/service.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : type : ClusterIP internalTrafficPolicy : Cluster sessionAffinity : None ports : - name : tcp-redis port : 6379 targetPort : redis nodePort : null selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master --- # Source: redis/templates/master/application.yaml apiVersion : apps/v1 kind : StatefulSet metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master serviceName : redis-demo-headless updateStrategy : rollingUpdate : {} type : RollingUpdate template : metadata : labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master annotations : checksum/configmap : 516392ae01a6fb95f4c434be19c4eb3f37ac9dc3e1f52fb302724b442ad467dd checksum/health : 28188307c9d7d0ed6376b91fce553bb4e28c9b5f34487c868556960d8fd64cd9 checksum/scripts : 74e0abcaeec26e24a8a2f954723f19f50a1cc681886af9b79e262a208799a86f checksum/secret : 29f6ccaba3639fc35ad8707bfa8bc41a67dd0975dc1c6504f537142622079260 spec : securityContext : fsGroup : 1001 serviceAccountName : redis-demo affinity : podAffinity : podAntiAffinity : preferredDuringSchedulingIgnoredDuringExecution : - podAffinityTerm : labelSelector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master namespaces : - \"default\" topologyKey : kubernetes.io/hostname weight : 1 nodeAffinity : terminationGracePeriodSeconds : 30 containers : - name : redis image : docker.io/bitnami/redis:7.0.4-debian-11-r9 imagePullPolicy : \"IfNotPresent\" securityContext : runAsUser : 1001 command : - /bin/bash args : - -c - /opt/bitnami/scripts/start-scripts/start-master.sh env : - name : BITNAMI_DEBUG value : \"false\" - name : REDIS_REPLICATION_MODE value : master - name : ALLOW_EMPTY_PASSWORD value : \"no\" - name : REDIS_PASSWORD valueFrom : secretKeyRef : name : redis-demo key : redis-password - name : REDIS_TLS_ENABLED value : \"no\" - name : REDIS_PORT value : \"6379\" ports : - name : redis containerPort : 6379 livenessProbe : initialDelaySeconds : 20 periodSeconds : 5 # One second longer than command timeout should prevent generation of zombie processes. timeoutSeconds : 6 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_liveness_local.sh 5 readinessProbe : initialDelaySeconds : 20 periodSeconds : 5 timeoutSeconds : 2 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_readiness_local.sh 1 resources : limits : {} requests : {} volumeMounts : - name : start-scripts mountPath : /opt/bitnami/scripts/start-scripts - name : health mountPath : /health - name : redis-data mountPath : /data subPath : - name : config mountPath : /opt/bitnami/redis/mounted-etc - name : redis-tmp-conf mountPath : /opt/bitnami/redis/etc/ - name : tmp mountPath : /tmp volumes : - name : start-scripts configMap : name : redis-demo-scripts defaultMode : 0755 - name : health configMap : name : redis-demo-health defaultMode : 0755 - name : config configMap : name : redis-demo-configuration - name : redis-tmp-conf emptyDir : {} - name : tmp emptyDir : {} volumeClaimTemplates : - metadata : name : redis-data labels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master spec : accessModes : - \"ReadWriteOnce\" resources : requests : storage : \"8Gi\" $ helm template redis-demo bitnami/redis -f only-master.values --- # Source: redis/templates/serviceaccount.yaml apiVersion : v1 kind : ServiceAccount automountServiceAccountToken : true metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm --- # Source: redis/templates/secret.yaml apiVersion : v1 kind : Secret metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm type : Opaque data : redis-password : \"YWRtaW4=\" --- # Source: redis/templates/configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-configuration namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : redis.conf : |- # User-supplied common configuration: # Enable AOF https://redis.io/topics/persistence#append-only-file appendonly yes # Disable RDB persistence, AOF persistence already enabled. save \"\" # End of common configuration master.conf : |- dir /data # User-supplied master configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of master configuration replica.conf : |- dir /data # User-supplied replica configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of replica configuration --- # Source: redis/templates/health-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-health namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : ping_readiness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ] && [ \"$responseFirstWord\" != \"MASTERDOWN\" ]; then echo \"$response\" exit 1 fi ping_readiness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ]; then echo \"$response\" exit 1 fi ping_readiness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_readiness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_readiness_master.sh\" $1 || exit_status=$? exit $exit_status ping_liveness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_liveness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_liveness_master.sh\" $1 || exit_status=$? exit $exit_status --- # Source: redis/templates/scripts-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-scripts namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : start-master.sh : | #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" if [[ ! -f /opt/bitnami/redis/etc/master.conf ]];then cp /opt/bitnami/redis/mounted-etc/master.conf /opt/bitnami/redis/etc/master.conf fi if [[ ! -f /opt/bitnami/redis/etc/redis.conf ]];then cp /opt/bitnami/redis/mounted-etc/redis.conf /opt/bitnami/redis/etc/redis.conf fi ARGS=(\"--port\" \"${REDIS_PORT}\") ARGS+=(\"--requirepass\" \"${REDIS_PASSWORD}\") ARGS+=(\"--masterauth\" \"${REDIS_PASSWORD}\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/redis.conf\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/master.conf\") exec redis-server \"${ARGS[@]}\" --- # Source: redis/templates/headless-svc.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-headless namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm annotations : spec : type : ClusterIP clusterIP : None ports : - name : tcp-redis port : 6379 targetPort : redis selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo --- # Source: redis/templates/master/service.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : type : ClusterIP internalTrafficPolicy : Cluster sessionAffinity : None ports : - name : tcp-redis port : 6379 targetPort : redis nodePort : null selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master --- # Source: redis/templates/master/application.yaml apiVersion : apps/v1 kind : StatefulSet metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master serviceName : redis-demo-headless updateStrategy : rollingUpdate : {} type : RollingUpdate template : metadata : labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master annotations : checksum/configmap : 516392ae01a6fb95f4c434be19c4eb3f37ac9dc3e1f52fb302724b442ad467dd checksum/health : 28188307c9d7d0ed6376b91fce553bb4e28c9b5f34487c868556960d8fd64cd9 checksum/scripts : 74e0abcaeec26e24a8a2f954723f19f50a1cc681886af9b79e262a208799a86f checksum/secret : 29f6ccaba3639fc35ad8707bfa8bc41a67dd0975dc1c6504f537142622079260 spec : securityContext : fsGroup : 1001 serviceAccountName : redis-demo affinity : podAffinity : podAntiAffinity : preferredDuringSchedulingIgnoredDuringExecution : - podAffinityTerm : labelSelector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master namespaces : - \"default\" topologyKey : kubernetes.io/hostname weight : 1 nodeAffinity : terminationGracePeriodSeconds : 30 containers : - name : redis image : docker.io/bitnami/redis:7.0.4-debian-11-r9 imagePullPolicy : \"IfNotPresent\" securityContext : runAsUser : 1001 command : - /bin/bash args : - -c - /opt/bitnami/scripts/start-scripts/start-master.sh env : - name : BITNAMI_DEBUG value : \"false\" - name : REDIS_REPLICATION_MODE value : master - name : ALLOW_EMPTY_PASSWORD value : \"no\" - name : REDIS_PASSWORD valueFrom : secretKeyRef : name : redis-demo key : redis-password - name : REDIS_TLS_ENABLED value : \"no\" - name : REDIS_PORT value : \"6379\" ports : - name : redis containerPort : 6379 livenessProbe : initialDelaySeconds : 20 periodSeconds : 5 # One second longer than command timeout should prevent generation of zombie processes. timeoutSeconds : 6 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_liveness_local.sh 5 readinessProbe : initialDelaySeconds : 20 periodSeconds : 5 timeoutSeconds : 2 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_readiness_local.sh 1 resources : limits : {} requests : {} volumeMounts : - name : start-scripts mountPath : /opt/bitnami/scripts/start-scripts - name : health mountPath : /health - name : redis-data mountPath : /data subPath : - name : config mountPath : /opt/bitnami/redis/mounted-etc - name : redis-tmp-conf mountPath : /opt/bitnami/redis/etc/ - name : tmp mountPath : /tmp volumes : - name : start-scripts configMap : name : redis-demo-scripts defaultMode : 0755 - name : health configMap : name : redis-demo-health defaultMode : 0755 - name : config configMap : name : redis-demo-configuration - name : redis-tmp-conf emptyDir : {} - name : tmp emptyDir : {} volumeClaimTemplates : - metadata : name : redis-data labels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master spec : accessModes : - \"ReadWriteOnce\" resources : requests : storage : \"8Gi\"","title":"Kustomize \u5165\u9580\u6559\u5b78"},{"location":"kubernetes/package/helm-intro/#helm","text":"\u539f\u6587: https://zhuanlan.zhihu.com/p/350328164","title":"helm \u5165\u9580\u6559\u5b78"},{"location":"kubernetes/package/helm-intro/#_1","text":"helm \u662f k8s \u7684\u5305\u7ba1\u7406\u5de5\u5177 \uff0c\u4f7f\u7528 helm\uff0c\u53ef\u4ee5\u4f7f\u7528\u66f4\u70ba\u7c21\u5316\u548c\u7cfb\u7d71\u5316\u7684\u65b9\u5f0f \u5c0dk8s\u61c9\u7528\u9032\u884c\u90e8\u7f72\u3001\u5347\u7d1a \u3002 helm \u662f CNCF \u5df2\u7562\u696d\u7684\u9805\u76ee\uff0c\u793e\u7fa4\u4e5f\u662f\u76f8\u7576\u6d3b\u8e8d\u7684\uff0c\u5728 https://artifacthub.io/ \u4e0a\uff0c\u80fd\u627e\u5230\u5f88\u591a\u73fe\u6210\u7684 helm chart\uff0c\u7a0d\u4f5c\u4fee\u6539\u5c31\u80fd\u7528\u5230\u751f\u7522\u74b0\u5883\u4e2d\uff0c\u975e\u5e38\u65b9\u4fbf\u3002 \u672c\u6587\u6703\u4ecb\u7d39 helm \u7684\u6838\u5fc3\u6982\u5ff5\uff0c\u4e26\u7528\u4e00\u500b\u4f8b\u5b50\u5e6b\u52a9\u5927\u5bb6\u66f4\u76f4\u89c0\u7684\u8a8d\u8b58 helm\uff0c\u5927\u5bb6\u53ef\u4ee5\u8ddf\u8457\u9019\u500b\u4f8b\u5b50\u64cd\u4f5c\u4e00\u904d\uff0c\u76f8\u4fe1\u5c0d\u7406\u89e3 helm \u6703\u6709\u975e\u5e38\u5927\u7684\u4f5c\u7528\u3002 \u6559\u7a0b\u6e90\u78bc: cloud-native-tutorial","title":"\u5f15\u8a00"},{"location":"kubernetes/package/helm-intro/#helm_1","text":"","title":"\u4ec0\u9ebc\u662f helm"},{"location":"kubernetes/package/helm-intro/#helm_2","text":"helm \u5728\u5e0c\u81d8\u8a9e\u4e2d\u7684\u610f\u601d\u662f\uff1a \u8235\uff1b\u99d5\u99db\u76e4 \u3002\u64da\u8aaa\u662f helm \u5275\u59cb\u4eba mutt butcher \u7ffb\u904d\u4e86\u822a\u6d77\u624b\u518a\u627e\u51fa\u4f86\u7684\uff0c\u76ee\u7684\u662f\u70ba\u4e86\u627e\u4e00\u500b\u548c kubernetes \u4e3b\u984c\u76f8\u5339\u914d\u7684\u8a5e\u8a9e\u3002 \u5b98\u7db2\u5730\u5740\uff1a https://helm.sh/ \u5b98\u65b9\u7d66\u51fa\u7684\u89e3\u91cb\u662f\uff1a Helm is the best way to find, share, and use software built for Kubernetes . \u610f\u601d\u662f helm \u662f kubernetes \u4e2d\u67e5\u627e\u3001\u5206\u4eab\u3001\u69cb\u5efa\u61c9\u7528\u7684\u6700\u4f73\u65b9\u5f0f\u3002 \u9019\u7a2e\u8aaa\u6cd5\u7576\u7136\u4e0d\u7b97\u8a87\u5f35\uff0cHelm \u5176\u5be6\u662f\u4e00\u500b Kubernetes \u61c9\u7528\u7684\u5305\u7ba1\u7406\u5de5\u5177 \uff0c\u7528\u4f86\u7ba1\u7406 chart \uff08\u4e00\u7a2e\u9810\u5148\u914d\u7f6e\u597d\u7684\u5b89\u88dd\u5305\u8cc7\u6e90\uff09\uff0c\u6709\u9ede\u985e\u4f3c\u65bc Ubuntu \u7684 APT \u548c CentOS \u4e2d\u7684 YUM \u3002\u56e0\u6b64\uff0chelm \u7684\u51fa\u73fe\u89e3\u6c7a\u4e86 k8s \u61c9\u7528\u7ba1\u7406\u80fd\u529b\u7f3a\u5931\u7684\u554f\u984c\u3002 \u53e6\u5916 helm \u4e5f\u662f dev \u548c ops \u7684\u6a4b\u6a11\uff0c\u904b\u7dad\u4eba\u54e1\u5728\u4f7f\u7528 helm \u7684\u6642\u5019\uff0c\u4e00\u65b9\u9762\u4e0d\u9700\u8981\u7406\u89e3\u5927\u91cf\u5728 chart \u4e2d\u7684\u5404\u7a2e k8s \u5143\u7d20\uff0c\u53ea\u9700\u8981\u914d\u7f6e\u5c11\u91cf\u7684\u74b0\u5883\u8b8a\u91cf\u5373\u53ef\u5b89\u88dd\uff1b\u53e6\u4e00\u65b9\u9762\uff0chelm \u4e5f\u7d66\u521d\u7d1a\u904b\u7dad\u4eba\u54e1\u63d0\u4f9b\u4e86\u5b78\u7fd2\u7684\u6a5f\u6703\uff0c\u4ed6\u5011\u53ef\u4ee5\u5728 chart \u4e2d\u5b78\u7fd2\u4e26\u7406\u89e3\u5404\u7a2e k8s \u5143\u7d20\uff0c\u5f9e\u800c\u80fd\u5920\u66f4\u5feb\u7684\u638c\u63e1 k8s\u3002 \u4e0b\u9762\u5217\u8209\u4e86 helm \u7684\u4e00\u4e9b\u95dc\u9375\u4fe1\u606f: 2019 \u5e7411 \u670813 \u65e5\uff0cHelm 3 \u767c\u5e03\uff1b 2020 \u5e7404 \u670830 \u65e5\uff0c\u5f9e CNCF \u4e2d\u7562\u696d\uff1b \u76ee\u524d github \u4e0a\u63a5\u8fd1\u6709 1.9w \u500b Star\uff1b \u6700\u65b0\u7248\u672c\uff1a3.5.0\uff1b \u4e3b\u8981\u4f5c\u8005\uff1aMutt Butcher\uff0c\u76ee\u524d\u5728 Microsoft\uff0c\u4e3b\u8981\u95dc\u6ce8 DevOps \u9818\u57df\u3002","title":"\u521d\u8b58 helm"},{"location":"kubernetes/package/helm-intro/#helm-apt","text":"\u5728\u6211\u5011\u63a5\u89f8\u4e00\u500b\u65b0\u4e8b\u7269\u7684\u6642\u5019\uff0c\u6700\u597d\u7684\u5b78\u7fd2\u65b9\u5f0f\u5c31\u662f\u548c\u6211\u5011\u719f\u6089\u7684\u4e8b\u52d9\u4f86\u505a\u985e\u6bd4\uff0c\u80fd\u5920\u5e6b\u52a9\u6211\u5011\u5feb\u901f\u7684\u638c\u63e1\u5176\u4e2d\u7684\u6838\u5fc3\u6982\u5ff5\u3002 \u7531\u65bc Mutt Butcher \u5728\u8a2d\u8a08 helm \u7684\u6642\u5019\uff0c\u5927\u91cf\u53c3\u8003\u4e86 apt \u548c homebrew \u7684\u8a2d\u8a08\uff0c\u9019\u88e1\u6211\u5011\u7528 apt \u4f86\u505a\u5c0d\u6bd4\uff0c\u5e6b\u52a9\u5927\u5bb6\u66f4\u597d\u7684\u7406\u89e3 helm\u3002 \u5f9e\u4e0b\u8868\u4e2d\u53ef\u4ee5\u770b\u5230\uff0chelm \u548c apt \u4e4b\u9593\u6982\u5ff5\u7684\u5c0d\u6bd4\uff0c\u76f8\u4fe1\u719f\u6089 apt \u7684\u540c\u5b78\u80fd\u5920\u5f88\u5feb\u7684\u5c0d helm \u6709\u4e00\u500b\u521d\u6b65\u7684\u8a8d\u8b58\u3002 helm apt \u5b89\u88dd\u5305 chart deb \u5b58\u5132\u5eab helm repository apt repository/mirror \u64cd\u4f5c\u7cfb\u7d71 kubernetes linux distribution \u5305\u4f9d\u8cf4 helm dependency deb dependency \u5305\u7ba1\u7406\u5de5\u5177 helm client apt/apt-get/apt-cache/apt-config","title":"helm \u8207 apt \u5c0d\u6bd4"},{"location":"kubernetes/package/helm-intro/#helm_3","text":"\u5c0d helm \u6709\u4e86\u4e00\u500b\u521d\u6b65\u7684\u5370\u8c61\u4e4b\u5f8c\uff0c\u6211\u5011\u4f86\u5c0d helm \u505a\u4e00\u500b\u7e3d\u89bd\uff0c\u5305\u62ec helm \u7684\u7684\u6838\u5fc3\u6982\u5ff5\u3001\u904b\u884c\u6d41\u7a0b\u3001\u5e38\u7528\u547d\u4ee4\u3001chart \u505a\u4e00\u500b\u6982\u8981\u6027\u7684\u4e86\u89e3\uff0c\u9019\u6a23\u7684\u8a71\uff0c\u5c0d\u6211\u5011\u5f8c\u7e8c\u6df1\u5165 helm \u7684\u5b78\u7fd2\u548c\u5be6\u8e10\u8d77\u4e00\u500b\u7db1\u9818\u7684\u4f5c\u696d\uff0c\u907f\u514d\u53ea\u898b\u6a39\u6728\u3001\u4e0d\u898b\u68ee\u6797\u3002","title":"helm \u7e3d\u89bd"},{"location":"kubernetes/package/helm-intro/#helm_4","text":"chart \uff1achart \u5c31\u662f helm package\uff0c\u5305\u542b\u4e86\u4e00\u500b k8s app \u61c9\u7528\u904b\u884c\u8d77\u4f86\u7684\u6240\u6709\u8981\u7d20\uff0c\u6bd4\u5982 service, deployment, configmap, serviceaccount, rbac, \u7b49\uff0c\u9019\u4e9b\u8981\u7d20\u90fd\u662f\u4ee5template \u6587\u4ef6\u7684\u5f62\u5f0f\u5b58\u5728\uff0c\u518d\u7d50\u5408 values \u6587\u4ef6\uff0c\u6700\u7d42\u6e32\u67d3\u51fa\u80fd\u5920\u88ab k8s \u57f7\u884c\u7684 yaml \u6587\u4ef6\uff1b repository \uff1a\u5009\u5eab\u662f charts \u7684\u96c6\u5408\uff0c\u65b9\u4fbf\u9032\u884c\u5206\u4eab\u548c\u5206\u767c\u3002\u4e0b\u9762\u662f\u5b98\u7db2\u5009\u5eab\u7684\u5730\u5740\uff0c\u5927\u5bb6\u53ef\u4ee5\u9032\u53bb\u770b\u770b\uff0c\u611f\u53d7\u4e00\u4e0b\uff1b https://artifacthub.io/ release \uff1arelease \u662f helm chart \u5728 kubernetes \u7684\u4e00\u500b\u904b\u884c\u5be6\u4f8b\uff0c\u4f60\u53ef\u4ee5\u7528\u4e0d\u540c\u7684 release name \u591a\u6b21\u5b89\u88dd\u540c\u4e00\u500b chart\uff0c\u6bd4\u5982\uff1a\u7576\u96c6\u7fa4\u4e2d\u9700\u8981\u591a\u500b redis \u5be6\u4f8b\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u4e0d\u540c\u7684\u914d\u7f6e\u6587\u4ef6\u5b89\u88dd redis chart\u3002","title":"helm \u4e09\u5927\u6982\u5ff5"},{"location":"kubernetes/package/helm-intro/#helm_5","text":"\u4e0b\u9762\u9019\u5f35\u5716\u6211\u5efa\u8b70\u5927\u5bb6\u591a\u770b\u5e7e\u904d\uff0c\u53ef\u4ee5\u8aaa\u638c\u63e1\u4e86\u9019\u5f35\u5716\uff0c\u5c31\u638c\u63e1\u4e86helm\u7684\u6838\u5fc3\u3002 \u5f9e\u4e0b\u5716\u53ef\u4ee5\u770b\u5230\uff0chelm \u7684\u6838\u5fc3\u904b\u884c\u6d41\u7a0b\u5206\u70ba\u4ee5\u4e0b\u5e7e\u6b65\uff1a \u5f9e chart \u5009\u5eab\u4e2d\u7372\u53d6 chart \u4f7f\u7528\u8005\u914d\u7f6e\u81ea\u5df1\u7684 values \u6587\u4ef6\uff0c\u6839\u64da\u81ea\u5df1\u7684\u904b\u884c\u74b0\u5883\u5c0d values \u9032\u884c\u4fee\u6539 \u9ed8\u8a8d values \u6587\u4ef6\u548c\u4f7f\u7528\u8005 values \u6587\u4ef6\u6703\u9032\u884c\u4e00\u500b merge\uff0c\u5f62\u6210\u6700\u7d42\u7684 values \u6587\u4ef6 \u4f7f\u7528\u6700\u7d42\u7684 values \u6587\u4ef6\uff0c\u6e32\u67d3 chart \u7684 template\uff0c\u5f62\u6210\u53ef\u4ee5\u88ab kubernetes \u57f7\u884c\u7684 yaml \u8abf\u7528 kube apply \u63d0\u4ea4 yaml \u5230 kubernetes \u5728\u9019\u88e1\uff0c\u9700\u8981\u6ce8\u610f chart \u958b\u767c\u8005\u548c\u4f7f\u7528\u8005\u7684\u754c\u9650\uff0c\u6b63\u662f\u7531\u65bc\u5728\u8de8\u8d8a\u9019\u500b\u754c\u9650\u7684\u6642\u5019\uff0c\u5f9e\u9700\u8981\u7406\u89e3\u5927\u91cf\u7684\u914d\u7f6e\u5230\u53ea\u9700\u8981\u7406\u89e3\u5c11\u91cf\u7684\u914d\u7f6e\uff0c\u4f7f\u5f97 operation \u7684\u5de5\u4f5c\u8b8a\u5f97\u7c21\u4fbf\uff0c\u9019\u4e5f\u662f helm \u6838\u5fc3\u7684\u8a2d\u8a08\u54f2\u5b78\u3002\u770b\u5b8c\u6574\u500b\u6587\u7ae0\uff0c\u5373\u4f7f\u4f60\u4ec0\u9ebc\u90fd\u6c92\u8a18\u4f4f\uff0c\u53ea\u8a18\u4f4f\u4e86\u9019\u5f35\u5716\uff0c\u4f60\u4e5f\u6703\u6709\u5f88\u5927\u7684\u6536\u7a6b\u4e86\u3002","title":"helm \u904b\u884c\u6d41\u7a0b"},{"location":"kubernetes/package/helm-intro/#helm_6","text":"\u5229\u7528 helm \u4f86\u5b89\u88dd\u61c9\u7528\u81f3 kubernetes \u7684\u6642\u5019\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u7b2c\u4e09\u65b9\u958b\u767c\u7684 chart\uff0c\u4e5f\u53ef\u4ee5\u81ea\u5df1\u958b\u767c chart\uff0c\u4ee5\u4e0b\u662f\u5169\u7a2e\u60c5\u6cc1\u4e0b\u4f7f\u7528\u7684\u5e38\u898b\u547d\u4ee4\u3002\u66f4\u70ba\u8a73\u7d30\u7684\u547d\u4ee4\uff0c\u53ef\u4ee5\u5b89\u88dd\u597d helm \u4e4b\u5f8c\uff0c\u4f7f\u7528 helm help \u4f86\u67e5\u770b\uff0c\u6216\u67e5\u770b\u5b98\u65b9\u6587\u6a94\u3002 Usage: helm [command] Available Commands: completion generate autocompletion scripts for the specified shell create create a new chart with the given name dependency manage a chart's dependencies env helm client environment information get download extended information of a named release help Help about any command history fetch release history install install a chart lint examine a chart for possible issues list list releases package package a chart directory into a chart archive plugin install, list, or uninstall Helm plugins pull download a chart from a repository and (optionally) unpack it in local directory push push a chart to remote registry login to or logout from a registry repo add, list, remove, update, and index chart repositories rollback roll back a release to a previous revision search search for a keyword in charts show show information of a chart status display the status of the named release template locally render templates test run tests for a release uninstall uninstall a release upgrade upgrade a release verify verify that a chart at the given path has been signed and is valid version print the client version information","title":"helm \u5e38\u7528\u547d\u4ee4"},{"location":"kubernetes/package/helm-intro/#chart","text":"\u90e8\u7f72\u524d: repo: add, list, remove, update, and index chart repositories search: search for a keyword in charts \u90e8\u7f72\u540e: install: install a chart list: list releases status: display the status of the named release upgrade: upgrade a release rollback: roll back a release to a previous revision uninstall: uninstall a release","title":"\u4f7f\u7528\u7b2c\u4e09\u65b9\u958b\u767c\u7684 chart"},{"location":"kubernetes/package/helm-intro/#chart_1","text":"lint: examine a chart for possible issues package: package a chart directory into a chart archive push: push helm chart to chartmuseum chart push: push helm chart to OCI repository","title":"\u81ea\u5df1\u958b\u767c chart:"},{"location":"kubernetes/package/helm-intro/#chart_2","text":"chart \u53ef\u4ee5\u8aaa\u662f helm \u88e1\u9762\u6700\u91cd\u8981\u7684\u6982\u5ff5\u4e86\uff0c\u95dc\u65bc chart \u4e5f\u6709\u5f88\u591a\u5167\u5bb9\u9700\u8981\u638c\u63e1\uff0c\u5728\u9019\u88e1\u505a\u4e00\u500b\u5217\u8209\u3002 chart \u958b\u767c \uff1a\u4e3b\u8981\u662f\u6307\u5229\u7528\u6a21\u677f\u6280\u8853\u958b\u767c\u4e00\u500b chart\uff0c\u6703\u5728\u5f8c\u9762\u505a\u8a73\u7d30\u4ecb\u7d39\uff1b chart hooks \uff1a\u5728 chart \u7684\u751f\u547d\u9031\u671f\u4e2d\uff0c\u63d0\u4f9b\u4e00\u4e9b hooks\uff0c\u65b9\u4fbf\u9032\u884c\u4e00\u4e9b\u524d\u7f6e\u6216\u5f8c\u7f6e\u64cd\u4f5c \u5728 chart \u5b89\u88dd\u524d\uff0c\u5275\u5efa\u61c9\u7528\u9700\u8981\u7684 Secret \u5728 chart \u5b89\u88dd\u524d\uff0c\u5099\u4efd\u6578\u64da\u5eab \u5728 chart \u5378\u8f09\u5f8c\uff0c\u505a\u4e00\u4e9b\u6e05\u7406\u5de5\u4f5c chart test \uff1a\u7576\u4f60 install \u4e86\u4e00\u500b chart \u5f8c\uff0c\u5982\u4f55\u77e5\u9053\u9019\u500b release \u662f\u5426\u904b\u884c\u6b63\u5e38\u5462\uff1f chart test \u63d0\u4f9b\u4e86\u4e00\u7a2e\u6e2c\u8a66\u7684\u65b9\u5f0f\uff0c\u4f86\u9a57\u8b49\u4f60\u7684\u61c9\u7528\u662f\u5426\u6b63\u5e38\u904b\u884c\uff0c\u6bd4\u5982\uff1a \u6821\u9a57 mysql \u61c9\u7528\u80fd\u5920\u6b63\u5e38\u9023\u63a5\u4e26\u63a5\u53d7\u8acb\u6c42 \u6821\u9a57 services \u80fd\u5920\u6b63\u5e38\u505a load balance library chart \uff1a\u4e00\u7a2e\u4ee5 library \u5f62\u5f0f\u5b58\u5728\u7684 chart\uff0c\u53ef\u4ee5 \u5728application chart \u4e4b\u9593\u9032\u884c\u5171\u4eab\u907f\u514d\u91cd\u8907\u908f\u8f2f\uff1b\u985e\u4f3c\u65bc\u7de8\u7a0b\u8a9e\u8a00\u4e2d\u7684 public library\uff1b chart \u6821\u9a57 \uff1a\u57fa\u65bc PKI\u3001GnuPG \u7b49\u6280\u8853\uff0c\u5c0d helm package \u9032\u884c\u7c3d\u540d\uff0c\u4fdd\u8b49\u50b3\u8f38\u6216\u767c\u5e03\u904e\u7a0b\u4e2d\u7684\u5b89\u5168\u6027\uff1b OCI\uff08Open Container Initiative\uff0c\u5bb9\u5668\u958b\u653e\u898f\u7bc4\uff09\u652f\u6301 \uff1ahelm 3\u5f15\u5165\uff08EXPERIMENTAL\uff09\uff0c\u80fd\u5920\u5c07 chart \u63a8\u9001\u5230\u652f\u6301 OCI \u7684\u5009\u5eab\u4e2d\uff0c\u6bd4\u5982 harbor, nexus\uff0c\u7b49\uff0c\u6bd4\u5982\uff0c\u5c07 chart \u4fdd\u5b58\u5230 harbor \u4e2d\uff1a \u4fdd\u5b58 chart \uff1a helm chart save kubeedge/some-harbor-repo/kubeedge-cloud-chart:1.0.0 \u767b\u9304 repo \uff1a helm registry login https://some-harbor-repo \u63a8\u9001 chart \uff1a helm chart push some-harbor-repo/kubeedge-cloud-chart:1.0.0 \u9ad8\u7d1a\u7279\u6027 : post rendering: \u63d0\u4f9b\u5728 helm install \u4e4b\u524d\u5c0d manifests \u9032\u884c\u64cd\u4f5c\u3001\u914d\u7f6e\u7684\u4e00\u7a2e\u6a5f\u5236\uff1b\u4e00\u822c\u7d50\u5408 kustomize \u4f7f\u7528\u3002\u6bd4\u5982\uff1a \u5728 install \u6642\u63d2\u5165 sidecar\uff0c\u5f9e\u800c\u70ba deployment \u589e\u52a0\u529f\u80fd \u4e0d\u4fee\u6539\u539f chart \u7684\u60c5\u6cc1\u4e0b\uff0c\u66f4\u6539 manifests \u7684\u914d\u7f6e \u9019\u53ef\u80fd\u4e0d\u662f\u975e\u5e38\u597d\u7406\u89e3\uff0c\u9019\u88e1\u8209\u4e00\u500b\u4f8b\u5b50\uff0c\u5047\u8a2d\u6211\u9700\u8981\u5c0d\u4e00\u500b\u7b2c\u4e09\u65b9\u7684 chart \u505a\u5c11\u91cf\u7684\u4fee\u6539\uff0c\u4ee5\u6eff\u8db3\u6211\u7684\u90e8\u7f72\u8981\u6c42\uff0c\u90a3\u9ebc\u6211\u53ef\u4ee5 fork \u4e00\u4efd\u9019\u500b chart\uff0c\u7136\u5f8c\u5728\u4e0a\u9762\u505a\u4fee\u6539\uff0c\u4f46\u662f\u9019\u6a23\u6211\u9700\u8981\u4e00\u4e9b\u984d\u5916\u7684\u7dad\u8b77\u5de5\u4f5c\uff0c\u7576\u9019\u500b chart \u5347\u7d1a\u4e4b\u5f8c\uff0c\u6211\u9084\u9700\u8981\u505a merge \u7684\u5de5\u4f5c\uff0c\u5341\u5206\u4e0d\u4fbf\u3002 \u56e0\u6b64 post rendering \u63d0\u4f9b\u4e86\u4e00\u7a2e\u6a5f\u5236\uff0c\u4f60\u53ea\u9700\u8981\u4f7f\u7528 post rendering+kustomize \u7de8\u5beb\u7684\u4e00\u500b\u8173\u672c\uff0c\u5c31\u53ef\u4ee5\u5728 install \u524d\uff0c\u5c0d\u539f\u59cb chart \u7684\u5167\u5bb9\u505a\u4e00\u4e9b\u5b9a\u5236\u5316\u7684\u4fee\u6539\uff0c\u907f\u514d\u4e86\u984d\u5916\u7684\u7dad\u8b77\u5de5\u4f5c\u3002\u5982\u4e0b\u5716\u6240\u793a\u3002 \uff08kustomize\u662f\u4e00\u500b\u958b\u6e90\u7684\u914d\u7f6e\u5de5\u5177\uff0c\u53ef\u4ee5\u65b9\u4fbf\u7684\u5c0d\u73fe\u6709\u7684k8s app\u914d\u7f6e\u505a\u4e00\u4e9b\u5b9a\u5236\u5316\u7684\u4fee\u6539\uff0c\u5b98\u7db2\u5730\u5740\uff1a https://kustomize.io/ \uff09","title":"chart"},{"location":"kubernetes/package/helm-intro/#helm_7","text":"\u4e0b\u9762\u6211\u5011\u4e00\u8d77\u7528\u4e00\u500b demo \u4f86\u5c0d helm \u6709\u4e00\u500b\u66f4\u70ba\u76f4\u89c0\u7684\u4e86\u89e3\u3002\u5728\u9019\u500bdemo\u4e2d\uff0c\u6211\u5011\u7684\u76ee\u6a19\u662f\u90e8\u7f72\u4e00\u500b redis \u96c6\u7fa4\uff0c\u5305\u62ec\u4ee5\u4e0b\u5e7e\u500b\u6b65\u9a5f\uff1a \u5b89\u88dd helm \u4f7f\u7528 helm install \u55ae\u7bc0\u9ede redis \u4f7f\u7528 helm upgrade \u5347\u7d1a\u5230 master-replicas \u4f7f\u7528 helm rollback\uff0c\u56de\u6efe\u5230\u55ae\u7bc0\u9ede\u6a21\u5f0f","title":"helm \u6f14\u793a"},{"location":"kubernetes/package/helm-intro/#1-helm","text":"\u4ee5\u4e0b\u662f\u901a\u904e\u811a\u672c\u5b89\u88c5 helm \u7684\u547d\u4ee4\uff0c\u5176\u4ed6\u7684\u5b89\u88dd\u65b9\u5f0f\u53ef\u53c3\u8003 \u5b98\u7db2 \uff1a $ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 $ chmod 700 get_helm.sh $ ./get_helm.sh","title":"\u6b65\u9a5f1\uff1a\u5b89\u88dd helm\uff08\u901a\u904e\u8173\u672c\uff09"},{"location":"kubernetes/package/helm-intro/#2-redis-chart","text":"\u5c0b\u627e\u53ef\u4f7f\u7528 Helm \u4f86\u5b89\u88dd\u9032 Kubernetes \u7684\u61c9\u7528\uff0c\u6700\u597d\u7684\u65b9\u5f0f\u662f\u4f7f\u7528 ArtifactHUB \u5728\u641c\u7d22\u6b04\u4e2d\u9375\u5165 redis \u4e26\u5f9e\u4e2d\u9078\u64c7\u5408\u9069\u7684\u6253\u5305\u597d\u7684\u61c9\u7528\u3002\u5728\u6f14\u793a\u4e2d\u6211\u5011\u4f7f\u7528\u4e86 bitnami \u6253\u5305\u597d\u7684 redis \u4f86\u6f14\u793a\u5982\u4f55\u4f7f\u7528 helm\u3002 bitnami redis 1. \u6dfb\u52a0\u5009\u5eab \uff1a helm repo add bitnami https://charts.bitnami.com/bitnami \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: \"bitnami\" has been added to your repositories 2. \u67e5\u770b\u5df2\u7d93\u6dfb\u52a0\u7684\u5009\u5eab helm repo list \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME URL bitnami https://charts.bitnami.com/bitnami 3. \u641c\u7d22\u5009\u5eab\u6709\u54ea\u4e9b chart \uff1a helm search repo bitnami \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: $ helm search repo bitnami NAME CHART VERSION APP VERSION DESCRIPTION bitnami/airflow 13.0.2 2.3.3 Apache Airflow is a tool to express and execute... bitnami/apache 9.1.16 2.4.54 Apache HTTP Server is an open-source HTTP serve... bitnami/argo-cd 4.0.6 2.4.8 Argo CD is a continuous delivery tool for Kuber... bitnami/argo-workflows 2.3.8 3.3.8 Argo Workflows is meant to orchestrate Kubernet... bitnami/aspnet-core 3.4.18 6.0.7 ASP.NET Core is an open-source framework for we... bitnami/cassandra 9.2.11 4.0.5 Apache Cassandra is an open source distributed ... bitnami/cert-manager 0.7.7 1.9.1 Cert Manager is a Kubernetes add-on to automate... bitnami/common 1.16.1 1.16.0 A Library Helm Chart for grouping common logic ... ... ... 4. \u66f4\u65b0\u5009\u5eab\u5217\u8868\u5230\u672c\u5730 \uff1a helm repo update \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"bitnami\" chart repository Update Complete. \u2388Happy Helming!\u2388 5. \u641c\u7d22 redis \uff1a helm search repo redis \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME CHART VERSION APP VERSION DESCRIPTION bitnami/redis 17.0.8 7.0.4 Redis(R) is an open source, advanced key-value ... bitnami/redis-cluster 8.1.3 7.0.4 Redis(R) is an open source, scalable, distribut... 6. \u67e5\u770b redis chart \u8a73\u60c5 \uff1a helm show chart bitnami/redis \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: annotations: category: Database apiVersion: v2 appVersion: 7.0.4 dependencies: - name: common repository: https://charts.bitnami.com/bitnami tags: - bitnami-common version: 1.x.x description: Redis(R) is an open source, advanced key-value store. It is often referred to as a data structure server since keys can contain strings, hashes, lists, sets and sorted sets. home: https://github.com/bitnami/charts/tree/master/bitnami/redis icon: https://bitnami.com/assets/stacks/redis/img/redis-stack-220x234.png keywords: - redis - keyvalue - database maintainers: - name: Bitnami url: https://github.com/bitnami/charts - email: cedric@desaintmartin.fr name: desaintmartin name: redis sources: - https://github.com/bitnami/containers/tree/main/bitnami/redis version: 17.0.8 7. \u67e5\u770b redis values\uff08values\uff1a\u76f8\u7576\u65bcchart\u7684\u914d\u7f6e\u6587\u4ef6\uff09 \uff1a helm show values bitnami/redis \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: ## @section Global parameters ## Global Docker image parameters ## Please, note that this will override the image parameters, including dependencies, configured to use the global value ## Current available global Docker image parameters: imageRegistry, imagePullSecrets and storageClass ## ## @param global.imageRegistry Global Docker image registry ## @param global.imagePullSecrets Global Docker registry secret names as an array ## @param global.storageClass Global StorageClass for Persistent Volume(s) ## @param global.redis.password Global Redis&reg; password (overrides `auth.password`) ## global: imageRegistry: \"\" ## E.g. ## imagePullSecrets: ## - myRegistryKeySecretName ## imagePullSecrets: [] storageClass: \"\" redis: password: \"\" ## @section Common parameters ## ## @param kubeVersion Override Kubernetes version ## kubeVersion: \"\" ## @param nameOverride String to partially override common.names.fullname ## nameOverride: \"\" ... ...","title":"\u6b65\u9a5f2\uff1a\u6dfb\u52a0\u5009\u5eab\u4e26\u627e\u5230 redis chart"},{"location":"kubernetes/package/helm-intro/#3installupgraderollbackuninstall","text":"\u5efa\u7acb\u55ae\u500b redis master \u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u540d\u70ba only-master.values : only-master.values ## Redis architecture. architecture : \"standalone\" ## Redis password (both master and slave) auth : password : \"admin\" \u7136\u540e --dry-run \u4e00\u4e0b\uff0c\u770b\u770b\u751f\u6210\u51fa\u6765\u7684 yaml \u6587\u4ef6\u662f\u5426\u5b58\u5728\u95ee\u9898\uff1a helm install redis-demo bitnami/redis -f ./only-master.values --dry-run \u5982\u679c\u6c92\u6709\u554f\u984c\uff0c\u5247\u9032\u884c\u5be6\u969b\u7684\u5b89\u88dd : helm install redis-demo bitnami/redis -f ./only-master.values \u6aa2\u67e5\u5b89\u88dd\u7d50\u679c: kubectl get pods \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME READY STATUS RESTARTS AGE pod/redis-demo-master-0 1/1 Running 0 49s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 14m service/redis-demo-headless ClusterIP None <none> 6379/TCP 49s service/redis-demo-master ClusterIP 10.43.44.179 <none> 6379/TCP 49s NAME READY AGE statefulset.apps/redis-demo-master 1/1 49s \u5b89\u88dd\u6210\u529f\u4e4b\u5f8c\uff0c\u53ef\u4ee5\u767b\u9304 redis \u9032\u884c\u64cd\u4f5c\uff0c\u505a\u9032\u4e00\u6b65\u7684\u6821\u9a57\uff1a $ kubectl exec -it pod/redis-demo-master-0 -- /bin/bash I have no name!@redis-demo-master-0:/$ redis-cli -h localhost -a admin localhost:6379> set name dxlab OK localhost:6379> get name \"dxlab\" localhost:6379> info replication # Replication role:master connected_slaves:0 # \u53ef\u4ee5\u770b\u5230\u9019\u6642\u5019\u6c92\u6709slave\u9023\u63a5 master_failover_state:no-failover master_replid:0a6c5c20a0b1623802e4df933e5c91e380cb57dc master_replid2:0000000000000000000000000000000000000000 master_repl_offset:0 second_repl_offset:-1 repl_backlog_active:0 repl_backlog_size:1048576 repl_backlog_first_byte_offset:0 repl_backlog_histlen:0 \u5efa\u7acb master-replicas \u914d\u7f6e\u6587\u4ef6\uff0c\u540d\u4e3a master-replicas.values : master-replicas.values ## Redis architecture. architecture : \"replication\" ## Redis password auth : password : \"admin\" ## Number of Redis replicas to deploy replica : replicaCount : 2 --dry-run \u4e00\u4e0b\uff0c\u770b\u770b\u751f\u6210\u51fa\u4f86\u7684 yaml \u6587\u4ef6\u662f\u5426\u5b58\u5728\u554f\u984c\uff1b helm upgrade redis-demo bitnami/redis -f ./master-replicas.values --dry-run \u7531\u65bc\u5728\u7cfb\u7d71\u4e2d\u5df2\u7d93\u6709 redis-demo \u7684 release\uff0c\u56e0\u6b64\u4f7f\u7528 upgrade \u4f86\u9032\u884c\u5347\u7d1a \uff1a helm upgrade redis-demo bitnami/redis -f ./master-replicas.values \u6aa2\u67e5\u5b89\u88dd\u7d50\u679c: kubectl get pods \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME READY STATUS RESTARTS AGE pod/redis-demo-master-0 1/1 Running 0 20m pod/redis-demo-replicas-0 1/1 Running 0 20m pod/redis-demo-replicas-1 0/1 Running 0 21s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 37m service/redis-demo-headless ClusterIP None <none> 6379/TCP 24m service/redis-demo-master ClusterIP 10.43.44.179 <none> 6379/TCP 24m service/redis-demo-replicas ClusterIP 10.43.204.190 <none> 6379/TCP 20m NAME READY AGE statefulset.apps/redis-demo-master 1/1 24m statefulset.apps/redis-demo-replicas 1/2 20m \u6aa2\u67e5\u5f9e\u5c6c replicas \u662f\u5426\u5b89\u88dd\u6210\u529f\uff0c\u4ee5\u53ca\u662f\u5426\u540c\u6b65\u6210\u529f\uff1a $ kubectl exec -it pod/redis-demo-replicas-0 -- /bin/bash I have no name!@redis-demo-replicas-0:/$ redis-cli -h localhost -a admin localhost:6379> get name \"dxlab\" localhost:6379> info replication # Replication role:slave master_host:redis-demo-master-0.redis-demo-headless.default.svc.cluster.local master_port:6379 master_link_status:up master_last_io_seconds_ago:4 master_sync_in_progress:0 slave_read_repl_offset:1904 slave_repl_offset:1904 slave_priority:100 slave_read_only:1 replica_announced:1 connected_slaves:0 master_failover_state:no-failover master_replid:4763ace80c07c84f1925cda63252ba01d4efdc7e master_replid2:0000000000000000000000000000000000000000 master_repl_offset:1904 second_repl_offset:-1 repl_backlog_active:1 repl_backlog_size:1048576 repl_backlog_first_byte_offset:15 repl_backlog_histlen:1890 \u5f9e\u9a57\u8b49\u7684\u7d50\u679c\u4f86\u770b Redis \u7684 replicas \u7684\u78ba\u4e5f\u53d6\u5f97\u5728\u4e4b\u524d master \u4e0a\u8a2d\u7f6e\u7684\u9375\u503c\u3002 \u6700\u5f8c\uff0c\u56de\u6efe\u81f3\u55ae\u4e3b\u6a21\u5f0f : \u67e5\u770b\u6b77\u53f2\u90e8\u7f72: helm history redis-demo \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: REVISION UPDATED STATUS CHART APP VERSION DESCRIPTION 1 Sat Aug 6 11:09:17 2022 superseded redis-17.0.8 7.0.4 Install complete 2 Sat Aug 6 11:17:59 2022 deployed redis-17.0.8 7.0.4 Upgrade complete \u56de\u6efe\u5230\u7684\u55aemaster\u7248\u672c (REVISION = 1) \uff1a helm rollback redis-demo 1 \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: Rollback was a success! Happy Helming! \u6aa2\u67e5\u56de\u6efe\u7d50\u679c: kubectl get pods \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: NAME READY STATUS RESTARTS AGE pod/redis-demo-master-0 1/1 Running 0 75s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/kubernetes ClusterIP 10.43.0.1 <none> 443/TCP 70m service/redis-demo-headless ClusterIP None <none> 6379/TCP 12m service/redis-demo-master ClusterIP 10.43.66.90 <none> 6379/TCP 12m NAME READY AGE statefulset.apps/redis-demo-master 1/1 12m \u8907\u672c\u7684 Pods \u5df1\u7d93\u90fd\u4e0d\u5b58\u5728\u4e86\u3002 \u5378\u8f09 redis-demo : helm uninstall redis-demo \u547d\u4ee4\u7d50\u679c\u5982\u4e0b: release \"redis-demo\" uninstalled","title":"\u6b65\u9aa43\uff1ainstall/upgrade/rollback/uninstall"},{"location":"kubernetes/package/helm-intro/#helm-yaml","text":"\u6709\u4e9b\u6642\u5019\u7576\u4f7f\u7528 helm \u8207 chart \u4f86\u5b89\u88dd\u61c9\u7528\u9032\u5230 Kubernetes \u6642\uff0c\u7576\u51fa\u73fe\u4e00\u4e9b\u554f\u984c\u9700\u8981\u9032\u884c\u9664\u932f\u7684\u6642\u5019\uff0c\u6211\u5011\u6703\u9700\u8981\u53d6\u5f97 helm \u6700\u5f8c\u5ba3\u544a\u9032 kubernetes \u96c6\u7fa4\u6642\u7684 manifest (yaml) \u6a94\u6848\u3002 \u7d93\u7531\u4e0b\u5217\u7684\u547d\u4ee4\u53ef\u9a45\u52d5 helm \u4f86\u6e32\u67d3\u51fa\u76f8\u95dc\u7684 yaml \u6a94\u6848: helm template redis-demo bitnami/redis -f only-master.values --- # Source: redis/templates/serviceaccount.yaml apiVersion : v1 kind : ServiceAccount automountServiceAccountToken : true metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm --- # Source: redis/templates/secret.yaml apiVersion : v1 kind : Secret metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm type : Opaque data : redis-password : \"YWRtaW4=\" --- # Source: redis/templates/configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-configuration namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : redis.conf : |- # User-supplied common configuration: # Enable AOF https://redis.io/topics/persistence#append-only-file appendonly yes # Disable RDB persistence, AOF persistence already enabled. save \"\" # End of common configuration master.conf : |- dir /data # User-supplied master configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of master configuration replica.conf : |- dir /data # User-supplied replica configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of replica configuration --- # Source: redis/templates/health-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-health namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : ping_readiness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ] && [ \"$responseFirstWord\" != \"MASTERDOWN\" ]; then echo \"$response\" exit 1 fi ping_readiness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ]; then echo \"$response\" exit 1 fi ping_readiness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_readiness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_readiness_master.sh\" $1 || exit_status=$? exit $exit_status ping_liveness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_liveness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_liveness_master.sh\" $1 || exit_status=$? exit $exit_status --- # Source: redis/templates/scripts-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-scripts namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : start-master.sh : | #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" if [[ ! -f /opt/bitnami/redis/etc/master.conf ]];then cp /opt/bitnami/redis/mounted-etc/master.conf /opt/bitnami/redis/etc/master.conf fi if [[ ! -f /opt/bitnami/redis/etc/redis.conf ]];then cp /opt/bitnami/redis/mounted-etc/redis.conf /opt/bitnami/redis/etc/redis.conf fi ARGS=(\"--port\" \"${REDIS_PORT}\") ARGS+=(\"--requirepass\" \"${REDIS_PASSWORD}\") ARGS+=(\"--masterauth\" \"${REDIS_PASSWORD}\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/redis.conf\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/master.conf\") exec redis-server \"${ARGS[@]}\" --- # Source: redis/templates/headless-svc.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-headless namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm annotations : spec : type : ClusterIP clusterIP : None ports : - name : tcp-redis port : 6379 targetPort : redis selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo --- # Source: redis/templates/master/service.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : type : ClusterIP internalTrafficPolicy : Cluster sessionAffinity : None ports : - name : tcp-redis port : 6379 targetPort : redis nodePort : null selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master --- # Source: redis/templates/master/application.yaml apiVersion : apps/v1 kind : StatefulSet metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master serviceName : redis-demo-headless updateStrategy : rollingUpdate : {} type : RollingUpdate template : metadata : labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master annotations : checksum/configmap : 516392ae01a6fb95f4c434be19c4eb3f37ac9dc3e1f52fb302724b442ad467dd checksum/health : 28188307c9d7d0ed6376b91fce553bb4e28c9b5f34487c868556960d8fd64cd9 checksum/scripts : 74e0abcaeec26e24a8a2f954723f19f50a1cc681886af9b79e262a208799a86f checksum/secret : 29f6ccaba3639fc35ad8707bfa8bc41a67dd0975dc1c6504f537142622079260 spec : securityContext : fsGroup : 1001 serviceAccountName : redis-demo affinity : podAffinity : podAntiAffinity : preferredDuringSchedulingIgnoredDuringExecution : - podAffinityTerm : labelSelector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master namespaces : - \"default\" topologyKey : kubernetes.io/hostname weight : 1 nodeAffinity : terminationGracePeriodSeconds : 30 containers : - name : redis image : docker.io/bitnami/redis:7.0.4-debian-11-r9 imagePullPolicy : \"IfNotPresent\" securityContext : runAsUser : 1001 command : - /bin/bash args : - -c - /opt/bitnami/scripts/start-scripts/start-master.sh env : - name : BITNAMI_DEBUG value : \"false\" - name : REDIS_REPLICATION_MODE value : master - name : ALLOW_EMPTY_PASSWORD value : \"no\" - name : REDIS_PASSWORD valueFrom : secretKeyRef : name : redis-demo key : redis-password - name : REDIS_TLS_ENABLED value : \"no\" - name : REDIS_PORT value : \"6379\" ports : - name : redis containerPort : 6379 livenessProbe : initialDelaySeconds : 20 periodSeconds : 5 # One second longer than command timeout should prevent generation of zombie processes. timeoutSeconds : 6 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_liveness_local.sh 5 readinessProbe : initialDelaySeconds : 20 periodSeconds : 5 timeoutSeconds : 2 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_readiness_local.sh 1 resources : limits : {} requests : {} volumeMounts : - name : start-scripts mountPath : /opt/bitnami/scripts/start-scripts - name : health mountPath : /health - name : redis-data mountPath : /data subPath : - name : config mountPath : /opt/bitnami/redis/mounted-etc - name : redis-tmp-conf mountPath : /opt/bitnami/redis/etc/ - name : tmp mountPath : /tmp volumes : - name : start-scripts configMap : name : redis-demo-scripts defaultMode : 0755 - name : health configMap : name : redis-demo-health defaultMode : 0755 - name : config configMap : name : redis-demo-configuration - name : redis-tmp-conf emptyDir : {} - name : tmp emptyDir : {} volumeClaimTemplates : - metadata : name : redis-data labels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master spec : accessModes : - \"ReadWriteOnce\" resources : requests : storage : \"8Gi\" $ helm template redis-demo bitnami/redis -f only-master.values --- # Source: redis/templates/serviceaccount.yaml apiVersion : v1 kind : ServiceAccount automountServiceAccountToken : true metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm --- # Source: redis/templates/secret.yaml apiVersion : v1 kind : Secret metadata : name : redis-demo namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm type : Opaque data : redis-password : \"YWRtaW4=\" --- # Source: redis/templates/configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-configuration namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : redis.conf : |- # User-supplied common configuration: # Enable AOF https://redis.io/topics/persistence#append-only-file appendonly yes # Disable RDB persistence, AOF persistence already enabled. save \"\" # End of common configuration master.conf : |- dir /data # User-supplied master configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of master configuration replica.conf : |- dir /data # User-supplied replica configuration: rename-command FLUSHDB \"\" rename-command FLUSHALL \"\" # End of replica configuration --- # Source: redis/templates/health-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-health namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : ping_readiness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_local.sh : |- #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" [[ -n \"$REDIS_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h localhost \\ -p $REDIS_PORT \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ] && [ \"$responseFirstWord\" != \"MASTERDOWN\" ]; then echo \"$response\" exit 1 fi ping_readiness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi if [ \"$response\" != \"PONG\" ]; then echo \"$response\" exit 1 fi ping_liveness_master.sh : |- #!/bin/bash [[ -f $REDIS_MASTER_PASSWORD_FILE ]] && export REDIS_MASTER_PASSWORD=\"$(< \"${REDIS_MASTER_PASSWORD_FILE}\")\" [[ -n \"$REDIS_MASTER_PASSWORD\" ]] && export REDISCLI_AUTH=\"$REDIS_MASTER_PASSWORD\" response=$( timeout -s 3 $1 \\ redis-cli \\ -h $REDIS_MASTER_HOST \\ -p $REDIS_MASTER_PORT_NUMBER \\ ping ) if [ \"$?\" -eq \"124\" ]; then echo \"Timed out\" exit 1 fi responseFirstWord=$(echo $response | head -n1 | awk '{print $1;}') if [ \"$response\" != \"PONG\" ] && [ \"$responseFirstWord\" != \"LOADING\" ]; then echo \"$response\" exit 1 fi ping_readiness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_readiness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_readiness_master.sh\" $1 || exit_status=$? exit $exit_status ping_liveness_local_and_master.sh : |- script_dir=\"$(dirname \"$0\")\" exit_status=0 \"$script_dir/ping_liveness_local.sh\" $1 || exit_status=$? \"$script_dir/ping_liveness_master.sh\" $1 || exit_status=$? exit $exit_status --- # Source: redis/templates/scripts-configmap.yaml apiVersion : v1 kind : ConfigMap metadata : name : redis-demo-scripts namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm data : start-master.sh : | #!/bin/bash [[ -f $REDIS_PASSWORD_FILE ]] && export REDIS_PASSWORD=\"$(< \"${REDIS_PASSWORD_FILE}\")\" if [[ ! -f /opt/bitnami/redis/etc/master.conf ]];then cp /opt/bitnami/redis/mounted-etc/master.conf /opt/bitnami/redis/etc/master.conf fi if [[ ! -f /opt/bitnami/redis/etc/redis.conf ]];then cp /opt/bitnami/redis/mounted-etc/redis.conf /opt/bitnami/redis/etc/redis.conf fi ARGS=(\"--port\" \"${REDIS_PORT}\") ARGS+=(\"--requirepass\" \"${REDIS_PASSWORD}\") ARGS+=(\"--masterauth\" \"${REDIS_PASSWORD}\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/redis.conf\") ARGS+=(\"--include\" \"/opt/bitnami/redis/etc/master.conf\") exec redis-server \"${ARGS[@]}\" --- # Source: redis/templates/headless-svc.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-headless namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm annotations : spec : type : ClusterIP clusterIP : None ports : - name : tcp-redis port : 6379 targetPort : redis selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo --- # Source: redis/templates/master/service.yaml apiVersion : v1 kind : Service metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : type : ClusterIP internalTrafficPolicy : Cluster sessionAffinity : None ports : - name : tcp-redis port : 6379 targetPort : redis nodePort : null selector : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master --- # Source: redis/templates/master/application.yaml apiVersion : apps/v1 kind : StatefulSet metadata : name : redis-demo-master namespace : \"default\" labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master spec : replicas : 1 selector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master serviceName : redis-demo-headless updateStrategy : rollingUpdate : {} type : RollingUpdate template : metadata : labels : app.kubernetes.io/name : redis helm.sh/chart : redis-17.0.8 app.kubernetes.io/instance : redis-demo app.kubernetes.io/managed-by : Helm app.kubernetes.io/component : master annotations : checksum/configmap : 516392ae01a6fb95f4c434be19c4eb3f37ac9dc3e1f52fb302724b442ad467dd checksum/health : 28188307c9d7d0ed6376b91fce553bb4e28c9b5f34487c868556960d8fd64cd9 checksum/scripts : 74e0abcaeec26e24a8a2f954723f19f50a1cc681886af9b79e262a208799a86f checksum/secret : 29f6ccaba3639fc35ad8707bfa8bc41a67dd0975dc1c6504f537142622079260 spec : securityContext : fsGroup : 1001 serviceAccountName : redis-demo affinity : podAffinity : podAntiAffinity : preferredDuringSchedulingIgnoredDuringExecution : - podAffinityTerm : labelSelector : matchLabels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master namespaces : - \"default\" topologyKey : kubernetes.io/hostname weight : 1 nodeAffinity : terminationGracePeriodSeconds : 30 containers : - name : redis image : docker.io/bitnami/redis:7.0.4-debian-11-r9 imagePullPolicy : \"IfNotPresent\" securityContext : runAsUser : 1001 command : - /bin/bash args : - -c - /opt/bitnami/scripts/start-scripts/start-master.sh env : - name : BITNAMI_DEBUG value : \"false\" - name : REDIS_REPLICATION_MODE value : master - name : ALLOW_EMPTY_PASSWORD value : \"no\" - name : REDIS_PASSWORD valueFrom : secretKeyRef : name : redis-demo key : redis-password - name : REDIS_TLS_ENABLED value : \"no\" - name : REDIS_PORT value : \"6379\" ports : - name : redis containerPort : 6379 livenessProbe : initialDelaySeconds : 20 periodSeconds : 5 # One second longer than command timeout should prevent generation of zombie processes. timeoutSeconds : 6 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_liveness_local.sh 5 readinessProbe : initialDelaySeconds : 20 periodSeconds : 5 timeoutSeconds : 2 successThreshold : 1 failureThreshold : 5 exec : command : - sh - -c - /health/ping_readiness_local.sh 1 resources : limits : {} requests : {} volumeMounts : - name : start-scripts mountPath : /opt/bitnami/scripts/start-scripts - name : health mountPath : /health - name : redis-data mountPath : /data subPath : - name : config mountPath : /opt/bitnami/redis/mounted-etc - name : redis-tmp-conf mountPath : /opt/bitnami/redis/etc/ - name : tmp mountPath : /tmp volumes : - name : start-scripts configMap : name : redis-demo-scripts defaultMode : 0755 - name : health configMap : name : redis-demo-health defaultMode : 0755 - name : config configMap : name : redis-demo-configuration - name : redis-tmp-conf emptyDir : {} - name : tmp emptyDir : {} volumeClaimTemplates : - metadata : name : redis-data labels : app.kubernetes.io/name : redis app.kubernetes.io/instance : redis-demo app.kubernetes.io/component : master spec : accessModes : - \"ReadWriteOnce\" resources : requests : storage : \"8Gi\"","title":"helm \u6e32\u67d3 yaml"},{"location":"networking/cidr/cidr-intro/","text":"\u7121\u985e\u5225\u5340\u9694\u8def\u7531 CIDR \u6280\u8853 \u00b6 \u4f5c\u8005: \u80e1\u51f1\u667a, \u539f\u6587: \u7121\u985e\u5225\u5340\u9694\u8def\u7531CIDR \u6280\u8853 \u70ba\u4e86\u907f\u514d\u9020\u6210IP\u4f4d\u5740\u7684\u5927\u91cf\u6d6a\u8cbb\uff0c\u65bc\u662f\u51fa\u73fe\u4e86\u7121\u985e\u5225\u5340\u9694\u8def\u7531\uff08CIDR\uff09\u6280\u8853\uff0c\u672c\u6587\u5c07\u4ecb\u7d39CIDR\u985e\u578b\u7684IP\u4f4d\u5740\u5206\u914d\u65b9\u5f0f\u53ca\u76f8\u95dc\u7684\u8def\u7531\u6280\u8853\uff0c\u4e26\u8aaa\u660eCIDR\u7684\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u8207\u8def\u7531\u532f\u7e3d\u5169\u9805\u91cd\u8981\u6280\u8853\u3002 \u7db2\u969b\u7db2\u8def\u901a\u8a0a\u5354\u5b9a\uff08IP\uff09\u4f4d\u5740\u7684\u5206\u914d\u662f\u6839\u64daIP\u4f4d\u5740\u768432\u500b\u4f4d\u5143\uff0c\u5206\u6210 Class A\u3001Class B \u4ee5\u53ca Class C \u7b49\u7db2\u8def\u5340\u57df\uff0c\u4f9d\u64da32\u500b\u4f4d\u5143\u4ee5\u6bcf8\u500b\u4f4d\u5143\u4e00\u7d44\u4f86\u5340\u9694\u505a\u4e0d\u540c\u7684\u985e\u5225\uff08Class\uff09\uff0c\u800c\u6bcf\u4e00\u500b\u985e\u5225\u4f9d\u64da\u9019\u6a23\u7684\u5340\u9694\u6709\u4e0d\u4e00\u6a23\u7684IP\u5bb9\u7d0d\u6578\u91cf\u3002\u4e5f\u56e0\u6b64\uff0c\u53ef\u4ee5\u6839\u64da\u9700\u6c42\u4f86\u6c7a\u5b9a\u8981\u4f7f\u7528\u54ea\u4e00\u7a2e\u985e\u5225\u3002\u4f46\u662f\u9019\u6a23\u7684\u65b9\u5f0f\u904e\u6c92\u591a\u4e45\uff0c\u5c31\u767c\u73fe\u5230\u985e\u5225\u4e4b\u9593\u7684\u5dee\u8ddd\u904e\u5927\uff0c\u800c\u9020\u6210IP\u4f4d\u5740\u7684\u5927\u91cf\u6d6a\u8cbb\u3002 \u5f8c\u4f86\u7522\u751f\u4e86\u6240\u8b02\u7121\u985e\u5225\u5340\u9694\u7684\u8def\u7531\u65b9\u5f0f\uff0c\u82f1\u6587\u7a31\u4e4b\u70ba Classless Inter-Domain Routing \uff0c\u7c21\u7a31 CIDR \uff0c\u9019\u7bc7\u6587\u7ae0\u5c31\u662f\u8981\u4ecb\u7d39\u9019\u7a2e\u985e\u578b\u7684IP\u4f4d\u5740\u5206\u914d\u65b9\u5f0f\u4ee5\u53ca\u76f8\u95dc\u7684\u8def\u7531\u6280\u8853\u3002 IP \u4f4d\u5740\u7684\u76f8\u95dc\u77e5\u8b58 \u00b6 \u5728\u4ecb\u7d39 CIDR \u76f8\u95dc\u6280\u8853\u4e4b\u524d\uff0c\u4e00\u5b9a\u8981\u5148\u5c0d IP \u4f4d\u5740\u6709\u57fa\u672c\u7684\u4e86\u89e3\uff0c\u6240\u4ee5\u5148\u4ecb\u7d39\u8207 IP \u76f8\u95dc\u7684\u5b50\u7db2\u8def\u3001\u7db2\u8def\u906e\u7f69\u3001\u7db2\u8def\u4f4d\u5740\u4ee5\u53ca\u4e3b\u6a5f\u4f4d\u5740\u7b49\u77e5\u8b58\u3002 IP\u4f4d\u5740\u548c\u985e\u5225 \u5927\u5bb6\u90fd\u77e5\u9053\u4e00\u500bIP\u4f4d\u5740\u9577\u5f97\u50cf\u662f\u4e0b\u9762 \u9019\u6a23\uff1a \u9019\u662f\u753132\u500b\u4f4d\u5143\u3001\u6bcf8\u500b\u4f4d\u5143\u7528\u4e00\u500b\u5341\u9032\u4f4d\u7684\u6578\u5b57\u4f86\u8868\u793a\uff0c\u6240\u4ee5\u4e00\u5171\u67094\u500b\u6578\u5b57\u3002\u4e00\u822c\u4f86\u8aaa\uff0c\u6703\u4f9d\u64da\u4f4d\u5143\u7d44\uff088\u500b\u4f4d\u5143\uff09\u7684\u500b\u6578\u4f86\u5340\u9694\u6210\u4e0d\u540c\u985e\u5225\uff08Class\uff09\u7684\u7db2\u8def\uff0c\u4e0d\u540c\u985e\u578b\u7684\u7db2\u8def\u53ef\u4ee5\u5bb9\u7d0d\u4e0d\u540c\u6578\u91cf\u7684IP\u4f4d\u5740\u6578\u76ee\u3002 \u4f8b\u5982\uff0c\u82e5\u4f7f\u75288\u500b\u4f4d\u5143\u4f86\u8b8a\u5316\uff0c\u4ee5\u4fbf\u65bc\u5bb9\u7d0dIP\u4f4d\u5740\u7684\u8a71\uff0c\u5c31\u53ef\u4ee5\u5bb9\u7d0d28\u500bIP\u4f4d\u5740\uff0c\u4e5f\u5c31\u662f256\u500b\u3002\u82e5\u4f7f\u7528\u5169\u500b\u4f4d\u5143\u7d44\uff08\u5c31\u662f16\u500b\u4f4d\u5143\uff09\u4f86\u505a\u8b8a\u5316\uff0c\u5c31\u53ef\u4ee5\u5bb9\u7d0d216\u500b\uff0c\u4e5f\u5c31\u662f65,536\u500bIP\u4f4d\u5740\u3002\u4ee5\u9019\u6a23\u7684\u57fa\u790e\u7684\u5b9a\u5740\u8207\u8def\u7531\uff0c\u90fd\u7a31\u4e4b\u70ba Classful\uff0c\u4e5f\u5c31\u662f\u4ee5 \u985e\u5225 \u70ba\u57fa\u790e\u7684\u65b9\u5f0f\u3002 \u4e0d\u904e\uff0c\u9019\u7a2e\u65b9\u5f0f\u4e26\u4e0d\u662f\u9019\u88e1\u8981\u8b1b\u7684\u4e3b\u984c\uff0c\u6240\u4ee5\u4e0d\u6703\u591a\u52a0\u4ecb\u7d39\u3002\u9019\u7bc7\u6587\u7ae0\u8981\u8aaa\u7684\uff0c\u662f\u8981\u6253\u7834\u9019\u7a2e\u4ee5\u985e\u5225\u70ba\u57fa\u790e\u7684\u5b9a\u5740\u8207\u8def\u7531\uff0c\u6240\u4ee5\u7a31\u4e4b\u70ba Classless \u3002 \u70ba\u4ec0\u9ebc\u5148\u8b1b\u9019\u4e9b\uff1f\u56e0\u70ba\u60f3\u8b93\u5927\u5bb6\u5148\u77e5\u9053 CIDR \u8981\u8457\u91cd\u7684\u7bc4\u570d\u662f\u4ec0\u9ebc\uff0c\u9019\u6a23\u4e00\u4f86\uff0c\u518d\u4f86\u770b\u9019\u7bc7\u6587\u7ae0\u7684\u6642\u5019\u624d\u77e5\u9053\u5728\u8b1b\u4e9b\u4ec0\u9ebc\u3002\u4e0d\u904e\uff0c\u5728\u8a73\u7d30\u4ecb\u7d39 CIDR \u4e4b\u524d\uff0c\u5fc5\u9808\u8981\u78ba\u5be6\u5730\u4e86\u89e3\u4f55\u8b02\u7db2\u8def\u906e\u7f69\u3001\u5b50\u7db2\u8def\u7b49\u7b49\u77e5\u8b58\u3002 \u7db2\u8def\u906e\u7f69\u548cIP\u4f4d\u5740\u8868\u793a\u65b9\u5f0f \u00b6 \u518d\u6b21\u4f7f\u7528\u525b\u624d\u7684\u7bc4\u4f8b\uff0cIP\u4f4d\u5740\u5c31\u5982\u540c\u4ee5\u4e0b\u9019\u822c\uff1a \u9019\u662f\u753132\u500b\u4f4d\u5143\u3001\u6bcf8\u500b\u4f4d\u5143\u7528\u4e00\u500b\u5341\u9032\u4f4d\u7684\u6578\u5b57\u4f86\u8868\u793a\uff0c\u6240\u4ee5\u4e00\u5171\u67094\u500b\u6578\u5b57\u3002\u5982\u679c\u518d\u52a0\u4e0a\u7db2\u8def\u906e\u7f69\u7684\u8cc7\u8a0a\uff0c\u4e00\u822c\u7684\u5beb\u6cd5\u5c31\u5982\u4e0b\u9762\u6240\u793a\uff1a \u4ee5\u4e0a\u7684\u8868\u793a\u6cd5\u4ee3\u8868\u7db2\u8def\u4f4d\u5740\u662f172.16.0.0\uff0c\u800c\u5f8c\u9762\u768416\u5247\u8868\u793a\u300c\u7db2\u8def\u906e\u7f69\u7684\u4e8c\u9032\u4f4d\u8868\u793a\u6cd5\u4e2d\uff0c\u6700\u5f8c16\u500b\u6578\u5b57\u70ba0\u300d\uff0c\u56e0\u6b64\u4e0a\u9762\u7684\u8868\u793a\u6cd5\u662f\u7528\u4f86\u6558\u8ff0\u9019\u6a23\u4e00\u500b\u5b50\u7db2\u8def\u74b0\u5883\u3002\u5018\u82e5\u5c07\u7db2\u8def\u906e\u7f69\u7528\u4e8c\u9032\u4f4d\u4f86\u8868\u793a\uff0c\u5c31\u76f8\u7576\u65bc\u4ee5\u4e0b\u7684\u8868\u793a\u65b9\u5f0f\uff1a \u6700\u5f8c16\u500b\u4f4d\u6578\u90fd\u662f0\uff0c\u82e5\u628a\u9019\u6a23\u7684\u7db2\u8def\u906e\u7f69\u8f49\u63db\u6210\u5341\u9032\u4f4d\uff0c\u4e5f\u5c31\u662f\u8aaa\uff0c\u7db2\u8def\u906e\u7f69\u5c07\u70ba255.255.0.0\u3002 \u7db2\u8def\u4f4d\u5740\u3001\u4e3b\u6a5f\u4f4d\u5740\u8207\u5ee3\u64ad\u4f4d\u5740 \u00b6 \u9084\u6709\u53e6\u4e00\u500b\u8981\u6ce8\u610f\u7684\u57fa\u672c\u77e5\u8b58\u662f\u7db2\u8def\u4f4d\u5740\uff08Network Address\uff09\u8207\u4e3b\u6a5f\u4f4d\u5740\uff08Host Address\uff09\uff0c\u5c31\u4ee5\u525b\u525b\u7684\u5b50\u7db2\u8def\u70ba\u4f8b\uff1a \u5047\u8a2d\u6709\u4e00\u500bIP\u4f4d\u5740172.16.32.4\u662f\u4f4d\u65bc\u9019\u500b\u5b50\u7db2\u8def\u5167\uff0c\u5247\u7db2\u8def\u4f4d\u5740\u70ba172.16.0.0\uff0c\u800c\u4e3b\u6a5f\u4f4d\u5740\u5373\u70ba172.16.32.4\uff0c\u800c\u5ee3\u64ad\u4f4d\u5740\u5c31\u662f\u628a\u5f8c\u9762\u4e3b\u6a5f\u4f4d\u5740\u7684\u90e8\u5206\uff0c\u5728\u4e8c\u9032\u4f4d\u7684\u8868\u793a\u6cd5\u4e2d\u90fd\u70ba1\uff0c\u5982\u679c\u628a172.16.0.0\u8f49\u6210\u4e8c\u9032\u4f4d\u8868\u793a\uff0c\u5247\u5982\u4e0b\u5217\u6240\u793a\uff1a \u56e0\u70ba\u77e5\u9053\u906e\u7f69\u6578\u76ee\u70ba16\uff0c\u6240\u4ee5\u5f9e\u5f8c\u9762\u6578\u904e\u4f8616\u500b\u6578\u5b57\u90fd\u662f\u5c6c\u65bc\u4e3b\u6a5f\u4f4d\u5740\u53ef\u4ee5\u5206\u914d\u7684\u90e8\u5206\uff0c\u56e0\u6b64\u9019\u500b\u7db2\u8def\u7684\u5ee3\u64ad\u4f4d\u5740\u5c31\u53ea\u8981\u628a\u9019\u4e9b\u4e3b\u6a5f\u4f4d\u5740\u53ef\u5206\u914d\u7684\u90e8\u5206\u90fd\u8a2d\u5b9a\u70ba1\u5373\u53ef\uff0c\u4e5f\u5c31\u662f\uff1a \u8f49\u6210\u5341\u9032\u4f4d\u5c31\u662f172.16.255.255\u3002\u53ef\u4ee5\u5f9e\u9019\u88e1\u767c\u73fe\u5230\uff0c\u9019\u500b\u5ee3\u64ad\u4f4d\u5740\u662f\u4e0d\u80fd\u88ab\u62ff\u4f86\u7576\u6210\u4e3b\u6a5f\u4f4d\u5740\uff0c\u7576\u7136\u7db2\u8def\u4f4d\u5740\u4e5f\u4e0d\u80fd\u62ff\u4f86\u7576\u4f5c\u4e3b\u6a5f\u4f4d\u5740\uff0c\u6240\u4ee5\u4e00\u500b\u5b50\u7db2\u8def\u4e2d\u5230\u5e95\u53ef\u4ee5\u7528\u591a\u5c11\u500bIP\u4f4d\u5740\u4f86\u7576\u4f5c\u4e3b\u6a5f\u4f4d\u5740\u5462\uff1f\u518d\u7e7c\u7e8c\u5f80\u4e0b\u770b\uff01 \u5b50\u7db2\u8def\u4e2d\u6240\u80fd\u4f7f\u7528\u7684IP\u6578\u91cf \u00b6 \u7db2\u8def\u906e\u7f69\u5230\u5e95\u6709\u4ec0\u9ebc\u7528\u9014\uff1f\u5b83\u80fd\u8868\u793a\u9019\u500b\u7db2\u8def\u6216\u5b50\u7db2\u8def\u5167\u53ef\u4ee5\u4f7f\u7528\u7684IP\u4f4d\u5740\u6709\u591a\u5c11\uff0c\u9019\u662f\u6700\u57fa\u672c\u7684\u7528\u9014\u3002\u5f9e\u4e0a\u9762\u9019\u500b\u4f8b\u5b50\u4f86\u770b\uff0c\u7531\u65bc\u7db2\u8def\u906e\u7f69\u662f255.255.0.0\uff0c\u6240\u4ee5\u5f9e\u4e8c\u9032\u4f4d\u4f86\u770b\uff0c\u5b83\u5c31\u662f\uff08\u9019\u88e1\u628a\u4e0d\u80fd\u8b8a\u52d5\u7684\u90e8\u5206\u7528\u7c97\u9ad4\u4f86\u8868\u793a\uff09\uff1a \u9019\u4ee3\u8868\u5728\u5206\u914dIP\u4f4d\u5740\u6642\uff0c\u524d\u976216\u500b\u6578\u5b57\u4e0d\u80fd\u8b8a\u52d5\uff0c\u53ea\u6709\u5f8c\u976216\u500b\u6578\u5b57\u53ef\u4ee5\u8b8a\u52d5\uff0c\u800c\u524d\u9762\u4e0d\u80fd\u8b8a\u52d5\u7684\u5c31\u662f\u4f7f\u7528\u7db2\u8def\u4f4d\u5740\u7684\u90e8\u5206\u3002\u73fe\u5728\u4f86\u770b\u7db2\u8def\u4f4d\u5740\uff0c\u5728\u4e0a\u9762\u7684\u7bc4\u4f8b\u4e2d\uff0c\u7db2\u8def\u4f4d\u5740\u662f172.16.0.0\uff0c\u8f49\u6210\u4e8c\u9032\u4f4d\u5c31\u662f\uff1a \u800c\u80fd\u5920\u5206\u914d\u7684IP\u4f4d\u5740\u70ba\uff1a \u8f49\u6210\u5341\u9032\u4f4d\u7684\u8a71\uff0c\u5c31\u4ee3\u8868\u53ef\u4f7f\u7528\u7684IP\u4f4d\u5740\u7bc4\u570d\u70ba172.16.0.1\u5230172.16.255.254\u3002 \u6240\u4ee5\u9019\u500b\u5b50\u7db2\u8def\u4e2d\u53ef\u4ee5\u4f7f\u7528\u7684IP\u6578\u91cf\u70ba2\u768416\u6b21\u65b9\u6e1b2\uff0c\u4e5f\u5c31\u662f216-2=65534\u500bIP\u4f4d\u5740\u3002\u6e1b\u53bb\u5169\u500b\u7684\u90e8\u5206\u5206\u5225\u662f172.16.0.0\u8207172.16.255.255\u9019\u5169\u500bIP\u4f4d\u5740\uff0c\u70ba\u4ec0\u9ebc\u9019\u5169\u500b\u8981\u6e1b\u53bb\u5462\uff1f \u56e0\u70ba172.16.0.0\u5df2\u7d93\u88ab\u62ff\u4f86\u4f7f\u7528\u6210\u9019\u500b\u5b50\u7db2\u8def\u7684\u7db2\u8def\u4f4d\u5740\uff0c\u800c172.16.255.255\u662f\u5ee3\u64ad\u4f4d\u5740\uff0c\u4e0d\u80fd\u88ab\u62ff\u4f86\u5206\u914d\u6210\u4e00\u822cIP\u4f4d\u5740\u4f7f\u7528\u3002\u5230\u76ee\u524d\u70ba\u6b62\uff0c\u5927\u5bb6\u5c0d\u65bcIP\u4f4d\u5740\u5206\u914d\u61c9\u8a72\u5df2\u7d93\u6709\u521d\u6b65\u7684\u6982\u5ff5\u4e86\u3002 \u63a5\u8457\uff0c\u518d\u8aaa\u660eCIDR\u4e2d\u4e00\u500b\u5f88\u91cd\u8981\u7684\u77e5\u8b58\uff1a\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u3002 CIDR \u91cd\u9ede1\uff1a\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69 \u00b6 \u4e00\u822c\u800c\u8a00\uff0c\u5728\u5207\u5272\u5b50\u7db2\u8def\u6642\uff0c\u5b50\u7db2\u8def\u906e\u7f69\u90fd\u662f\u5207\u6210\u985e\u4f3c255.255.255.0\u6216255.255.0.0\u9019\u6a23\u7684\u6578\u5b57\u3002\u4e0d\u904e\uff0c\u9019\u6a23\u5207\u5272\u7684\u8a71\uff0c\u96d6\u7136\u5f88\u5bb9\u6613\u4f7f\u7528\uff0c\u4f46\u53ef\u80fd\u6703\u9020\u6210IP\u7684\u6d6a\u8cbb\uff0c\u56e0\u70ba\u4e0d\u898b\u5f97\u6bcf\u500b\u5b50\u7db2\u8def\u4e2d\u7684IP\u4f7f\u7528\u91cf\u90fd\u662f\u76f8\u540c\u7684\u3002 \u5c31\u62ff\u4e0a\u9762\u7684\u7bc4\u4f8b\u4f86\u8aaa\uff0c\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u5b50\u7db2\u8def\u53ef\u4ee5\u5206\u914d\u51fa65,534\u500bIP\u4f4d\u5740\uff0c\u9019\u4e5f\u592a\u591a\u4e86\u5427\uff1f\u5c31\u7b97\u4f7f\u7528255.255.255.0\u9019\u6a23\u7684\u7db2\u8def\u906e\u7f69\uff0c\u90a3\u5b50\u7db2\u8def\u4e2d\u7684IP\u4f4d\u5740\u500b\u6578\u4e5f\u6709254\u500b\uff0c\u4e5f\u662f\u4e0d\u5c11\u3002 \u5047\u8a2d\u6709\u4e00\u500b\u516c\u53f8\u8981\u70ba\u884c\u653f\u90e8\u9580\u5206\u914d\u51fa20\u500bIP\u4f4d\u5740\uff0c\u800c\u8981\u70ba\u958b\u767c\u90e8\u9580\u5206\u914d\u51fa100\u500bIP\u4f4d\u5740\uff0c\u5247\u6b64\u6642\u8b8a\u6210\u6703\u4f7f\u7528\u5230\u5169\u500b\u5b50\u7db2\u8def\uff0c\u800c\u6bcf\u500b\u5b50\u7db2\u8def\u7684\u7db2\u8def\u906e\u7f69\u90fd\u662f255.255.255.0\uff0c\u4e5f\u5c31\u662f\u6bcf\u500b\u5b50\u7db2\u8def\u90fd\u53ef\u4ee5\u5206\u914d254\u500bIP\u4f4d\u5740\u3002\u9019\u6a23\u7684\u8a71\uff0c\u5c31\u5df2\u7d93\u6d6a\u8cbb\u6389(254-20)+(254-100)\u500bIP\u4f4d\u5740\u3002\u5982\u679c\u5927\u5bb6\u90fd\u9019\u6a23\u4f7f\u7528\uff0c\u90a3\u9084\u5f97\u4e86\uff1f\u5c31\u56e0\u70ba\u5982\u6b64\uff0c\u624d\u6709\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u51fa\u73fe\u3002 \u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69 \uff08Variable-Length Subnet Mask\uff0cVLSM\uff09\u662f\u7528\u4f86\u8b93\u4e0d\u540c\u9577\u5ea6\u3001\u4e0d\u540c\u985e\u5225\uff08Class\uff09\u7684\u5b50\u7db2\u8def\u80fd\u5728\u540c\u4e00\u500b\u7db2\u8def\u5167\u5b58\u5728\u4e26\u4e14\u904b\u4f5c\u3002\u6240\u4ee5\uff0c\u4e5f\u5c31\u662f\u8aaa\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u80fd\u5920\u8b93\u7db2\u8def\u5167\u7684IP\u4f4d\u5740\u5206\u914d\u66f4\u52a0\u5f48\u6027\u5316\uff0c\u4e5f\u53ef\u4ee5\u8b93\u53ef\u7528\u7684IP\u4f4d\u5740\u500b\u6578\u589e\u52a0\u3002 \u8a08\u7b97\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u65b9\u5f0f \u00b6 \u8209\u4f8b\u4f86\u8aaa\u660e\u5982\u4f55\u8a08\u7b97\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u53ef\u80fd\u6703\u6bd4\u8f03\u5bb9\u6613\u4e86\u89e3\u3002\u5047\u8a2d\u6709\u4e00\u500b\u5b50\u7db2\u8def\u662f\uff1a \u800c\u73fe\u5728\u60f3\u5206\u5272\u4e00\u500b\u5b50\u7db2\u8def\u662f\u53ef\u4ee5\u5bb9\u7d0d10\u53f0\u6a5f\u5668\u6240\u4f7f\u7528\uff0c\u4e5f\u5c31\u662f\u8981\u80fd\u5920\u5206\u914d10\u500bIP\u4f4d\u5740\u3002\u800c\u7531\u4e00\u958b\u59cb\u5c0d\u7db2\u8def\u906e\u7f69\u7684\u4ecb\u7d39\uff0c\u61c9\u8a72\u5c31\u80fd\u5920\u7b97\u51fa172.16.32.0/20\u7e3d\u5171\u53ef\u4ee5\u5206\u914d\u51fa\u7684IP\u4f4d\u5740\u500b\u6578\u70ba\uff1a \u5982\u679c\u76f4\u63a5\u628a172.16.32.0/20\u9019\u500b\u5b50\u7db2\u8def\u62ff\u4f86\u7d66\u901910\u500bIP\u4f4d\u5740\u4f7f\u7528\uff0c\u5be6\u5728\u662f\u592a\u6d6a\u8cbb\uff0c\u56e0\u70ba\u53ea\u6703\u752810\u500bIP\u4f4d\u5740\uff0c\u5176\u4ed64,084\u500bIP\u4f4d\u5740\u90fd\u6c92\u6709\u4f7f\u7528\u5230\u3002 \u82e5\u662f\u4f7f\u7528\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u5247\u80fd\u5920\u628a172.16.32.0/20\u5b50\u7db2\u8def\u5206\u5272\u6210172.16.32.0/28\uff0c\u5982\u6b64\u4e00\u4f86\uff0c\u5c07\u5f97\u5230\u4e0b\u5217\u9019\u4e9b\u5b50\u7db2\u8def\uff1a \u9019\u88e1\u628a\u4f4d\u5740\u7684\u6700\u5f8c\u5169\u500b\u6578\u5b57\u7528\u4e8c\u9032\u4f4d\u8868\u793a\uff0c\u9019\u6a23\u6bd4\u8f03\u5bb9\u6613\u8a08\u7b97\uff0c\u5176\u4e2d\uff0c172.16\u7684\u90e8\u5206\u7b97\u662f\u7db2\u8def\u4f4d\u5740\uff0c172.16.0010\u9019\u4e9b\u90e8\u5206\u7b97\u662f\u5b50\u7db2\u8def\u7684\u90e8\u5206\uff0c\u800c172.16.00100000.0001\u5c31\u5df2\u7d93\u7d50\u5408\u4e86\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u81f3\u65bc\u6700\u5f8c\u56db\u500b\u4f4d\u5143\uff0c\u5247\u662f\u7528\u4f86\u5206\u914dIP\u4f4d\u5740\u7d66\u4e3b\u6a5f\u7528\u3002 \u6240\u4ee5\uff0c\u9019\u6a23\u5206\u914d\u4e4b\u5f8c\uff0c172.16.32.0/20\u4e00\u5171\u53ef\u4ee5\u5206\u6210256\u500b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\uff0c256\u7684\u8a08\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a \u800c\u6bcf\u4e00\u500b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u7686\u53ef\u5206\u914d14\u500bIP\u4f4d\u5740\uff0c\u5176\u8a08\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a \u525b\u597d\u7b26\u5408\u539f\u672c\u7684\u9700\u6c42\uff1a\u300c\u5206\u5272\u5b50\u7db2\u8def\u4f86\u5206\u914d10\u500bIP\u4f4d\u5740\u300d\u3002\u9019\u6a23\u5206\u5272\u4e4b\u5f8c\uff0c\u53ea\u6703\u6d6a\u8cbb4\u500bIP\u4f4d\u5740\uff0c\u8207\u539f\u672c\u6703\u6d6a\u8cbb\u56db\u5343\u591a\u500bIP\u4f4d\u5740\u6bd4\u8f03\u8d77\u4f86\uff0c\u771f\u7684\u662f\u5dee\u592a\u591a\u4e86\u3002 IP\u4f4d\u5740\u5206\u914d\u7684\u61c9\u7528\u7bc4\u4f8b \u00b6 \u73fe\u5728\uff0c\u7528\u53e6\u4e00\u500b\u4f8b\u5b50\u8aaa\u660e\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u5982\u4f55\u8b93\u7db2\u8def\u7ba1\u7406\u4eba\u54e1\u66f4\u6709\u6548\u5730\u898f\u5283IP\u4f4d\u5740\u3002\u5047\u8a2d\u73fe\u5728\u5206\u914d\u5230\u7684\u7db2\u6bb5\u662f\uff1a \u6253\u7b97\u5206\u914d\u7d66\u56db\u500b\u4e0d\u540c\u7684\u90e8\u9580\uff0c\u6bcf\u500b\u90e8\u9580\u90fd\u6709\u81ea\u5df1\u7684\u7db2\u6bb5\uff0c\u4e14\u6bcf\u500b\u90e8\u9580\u7684IP\u4f4d\u5740\u500b\u6578\u898155\u500b\u3002\u6bcf\u500b\u90e8\u9580\u5fc5\u9808\u6709\u4e00\u500b\u8def\u7531\u5668\u8ca0\u8cac\u9023\u63a5\u5230\u516c\u53f8\u8981\u9023\u5230\u5916\u90e8WAN\u7db2\u8def\u7684\u8def\u7531\u5668\u4e0a\uff0c\u9019\u4e4b\u9593\u7684IP\u4f4d\u5740\u4e5f\u5fc5\u9808\u5728\u898f\u5283\u4e4b\u4e2d\u3002 \u9996\u5148\uff0c\u5927\u7565\u601d\u8003\u4e00\u4e0b\u53ef\u80fd\u7684\u7db2\u8def\u67b6\u69cb\u5716\u61c9\u8a72\u662f\u5982\u4f55\u3002\u56e0\u70ba\u8981\u5206\u914d\u56db\u500b\u7db2\u6bb5\uff0c\u800c\u6bcf\u500b\u7db2\u6bb5\u6703\u6709\u4e00\u500b\u8def\u7531\u5668\u5fc5\u9808\u9023\u63a5\u5230\u516c\u53f8\u8981\u9023\u5230\u5916\u90e8WAN\u7db2\u8def\u7684\u8def\u7531\u5668\u4e0a\uff08\u9019\u662f\u7576\u7136\u7684\uff0c\u4e0d\u7136\u9019\u4e9b\u90e8\u9580\u7684\u6a5f\u5668\u5c31\u7121\u6cd5\u9023\u51fa\u7db2\u8def\uff09\uff0c\u56e0\u6b64\u7db2\u8def\u67b6\u69cb\u5716\u61c9\u8a72\u5982\u57161\u6240\u793a\u3002 \u800c\u5404\u7db2\u6bb5\u7684IP\u4f4d\u5740\u90fd\u9084\u6c92\u6709\u586b\u4e0a\u53bb\uff0c\u9019\u5c31\u662f\u73fe\u5728\u8981\u505a\u7684\u5de5\u4f5c\u3002\u5728\u9019\u88e1\uff0c\u6240\u8981\u898f\u5283\u7684IP\u4f4d\u5740\u90e8\u5206\u5305\u542b\uff1a \u7531\u65bc\u77e5\u9053\u6bcf\u500b\u90e8\u9580\u90fd\u8981\u898f\u528355\u500bIP\u4f4d\u5740\uff0c\u6240\u4ee5\u4e0b\u4e00\u500b\u6b65\u9a5f\u5c31\u662f\u6c7a\u5b9a\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u8981\u7528\u591a\u5c11\u3002\u88681\u6574\u7406\u51fa\u5e38\u7528\u4e4b\u4e0d\u540c\u7684\u906e\u7f69\u9577\u5ea6\u8207\u6240\u80fd\u5206\u914d\u7684IP\u4f4d\u5740\u500b\u6578\u4e00\u89bd\u8868\uff0c\u53ef\u4ee5\u76f4\u63a5\u67e5\u627e\u3002 \u88681 \u4e0d\u540c\u7684\u906e\u7f69\u9577\u5ea6\u8207\u6240\u80fd\u5206\u914d\u7684IP\u4f4d\u5740\u500b\u6578 \u5f9e\u9019\u88e1\u53ef\u4ee5\u770b\u51fa\uff0c\u7db2\u8def\u906e\u7f69\u9577\u5ea6\u4e0d\u80fd\u8d85\u904e30\u500b\uff0c\u56e0\u70ba\u81f3\u5c11\u8981\u4fdd\u7559\u7db2\u8def\u4f4d\u5740\u53ca\u5ee3\u64ad\u4f4d\u5740\uff0c\u800c\u9084\u8981\u80fd\u5920\u5206\u914dIP\u4f4d\u5740\u7684\u8a71\uff0c\u7db2\u8def\u906e\u7f69\u6700\u591a\u53ea\u80fd\u523030\u500b\u4f4d\u6578\u3002\u7531\u65bc\u6253\u7b97\u80fd\u5920\u5206\u914d55\u500bIP\u4f4d\u5740\uff0c\u6240\u4ee5\u7531\u4e0a\u9762\u9019\u500b\u8868\u683c\u53ef\u4ee5\u770b\u51fa\uff0c\u81f3\u5c11\u5fc5\u9808\u4f7f\u752826\u500b\u4f4d\u5143\u7576\u4f5c\u7db2\u8def\u906e\u7f69\u3002 \u7531\u65bc\u6240\u5206\u914d\u5230\u7684\u7db2\u6bb5\u662f\uff1a \u6240\u4ee5\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\u5f8c\u5373\u70ba\uff1a \u9019\u88e1\u7a0d\u5fae\u5077\u61f6\u4e00\u4e0b\uff0c\u53ea\u628a\u5f8c\u9762\u768432.0\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\u3002\u800c\u7c97\u9ad4\u986f\u793a\u7684\u5730\u65b9\u662f\u5c6c\u65bc\u7db2\u8def\u4f4d\u5740\u7684\u90e8\u5206\uff0c\u5728\u9019\u88e1\u898f\u5283\u6642\u7121\u6cd5\u8b8a\u66f4\u3002\u800c\u525b\u525b\u4e5f\u8a08\u7b97\u51fa\u4f86\u6240\u8981\u4f7f\u7528\u7684\u7db2\u8def\u906e\u7f69\u500b\u6578\u662f26\uff0c\u6240\u4ee5\u53ef\u4ee5\u628a\u6240\u80fd\u7372\u5f97\u7684\u7b2c\u4e00\u500b\u7db2\u6bb5\u5206\u914d\u7d66\u90e8\u95801\uff0c\u4e5f\u5c31\u662f\uff1a \u90a3\u7b2c\u4e8c\u6bb5\u8981\u600e\u9ebc\u8a08\u7b97\u5462\uff1f\u7531\u65bc\u77e5\u9053\u525b\u525b\u5206\u914d\u7684\u906e\u7f69\u6578\u76ee\u662f26\uff0c\u56e0\u6b64\u91cd\u65b0\u770b\u4e00\u4e0b\u525b\u525b\u6240\u5206\u914d\u7684\u5b50\u7db2\u8def\u906e\u7f69\uff1a \u9019\u88e1\u628a\u5c6c\u65bc172.16.32.0/26\u7db2\u6bb5\u7684\u5b50\u7db2\u8def\uff08Subnet\uff09\u90e8\u5206\u6a19\u793a\u5e95\u7dda\uff0c\u5c31\u6703\u6bd4\u8f03\u660e\u767d\uff0c\u56e0\u6b64\u53ef\u4ee5\u770b\u51fa\uff0c\u7c97\u9ad4\u800c\u4e14\u5177\u6709\u5e95\u7dda\u7684\u90e8\u5206\u5c31\u662f\u539f\u672c\u7684\u5b50\u7db2\u8def\u90e8\u5206\uff0c\u800c\u6c92\u6709\u7c97\u9ad4\u4f46\u6709\u5e95\u7dda\u7684\u662fVLSM\u7684\u5b50\u7db2\u8def\u90e8\u5206\u3002\u73fe\u5728\u7531\u65bc\u8981\u8a08\u7b97\u4e0b\u4e00\u500b\u7db2\u6bb5\u7684\u4f4d\u5740\uff0c\u6240\u4ee5\u80fd\u52d5\u7684\u662f\u6a19\u793a\u5e95\u7dda\u7684\u90e8\u5206\uff0c\u56e0\u6b64\u4e0b\u4e00\u500b\u8981\u7d66\u90e8\u95802\u7684\u5b50\u7db2\u8def\u61c9\u8a72\u662f\uff1a \u800c\u8981\u7d66\u90e8\u95803\u7684\u5b50\u7db2\u8def\u662f\uff1a \u540c\u7406\uff0c\u6700\u5f8c\u8981\u7d66\u90e8\u95804\u7684\u5b50\u7db2\u8def\u5247\u662f\uff1a \u73fe\u5728\uff0c\u628a\u9019\u4e9b\u5df2\u7d93\u5206\u914d\u597d\u7684\u5b50\u7db2\u8def\u586b\u5230\u525b\u525b\u7684\u7db2\u8def\u67b6\u69cb\u5716\u4e2d\uff0c\u5982\u57162\u6240\u793a\u3002 \u63a5\u4e0b\u4f86\uff0c\u5c07\u8981\u5206\u914d\u8def\u7531\u5668A\u3001B\u3001C\u3001D\u4ee5\u53ca\u8def\u7531\u5668S\u4e4b\u9593\u7684IP\u4f4d\u5740\u3002\u525b\u525b\u5206\u914d\u5b8c\u56db\u500b\u90e8\u5206\u5f8c\uff0c172.16.32.0/24\u90fd\u4e0d\u80fd\u4f7f\u7528\u4e86\u3002\u6240\u4ee5\uff0c\u63a5\u4e0b\u4f86\u53ef\u5206\u914d\u7684\u7b2c\u4e00\u7d44\u5b50\u7db2\u8def\u53ef\u4ee5\u662f\uff1a \u518d\u4f86\uff0c\u770b\u770b\u906e\u7f69\u6578\u76ee\u61c9\u8a72\u8981\u591a\u5c11\u3002\u5047\u8a2d\u8981\u5148\u5206\u914d\u7d66\u8def\u7531\u5668A\u548c\u8def\u7531\u5668S\u4e4b\u9593\uff0c\u5247\u56e0\u70ba\u53ea\u9700\u8981\u5206\u914d\u5169\u500bIP\u4f4d\u5740\uff0c\u4e00\u500b\u7d66\u8def\u7531\u5668A\u671d\u5411\u8def\u7531\u5668S\u7684\u4ecb\u9762\uff0c\u53e6\u4e00\u500bIP\u4f4d\u5740\u5247\u5206\u914d\u7d66\u8def\u7531\u5668S\u671d\u5411\u8def\u7531\u5668A\u7684\u4ecb\u9762\u3002 \u56e0\u6b64\uff0c\u81f3\u5c11\u8981\u4f7f\u7528\u7684\u906e\u7f69\u662f30\uff0c\u6240\u4ee5\u53ef\u4ee5\u5f97\u77e5\u8981\u5206\u914d\u7684\u5b50\u7db2\u8def\u662f\uff1a \u540c\u6a23\u5730\uff0c\u8def\u7531\u5668B\u548c\u8def\u7531\u5668S\u4e4b\u9593\u7684\u5b50\u7db2\u8def\u5c31\u662f\u4e0b\u4e00\u6bb5\u5b50\u7db2\u8def\u4f4d\u5740\uff1a \u800c\u8def\u7531\u5668C\u548c\u8def\u7531\u5668S\u4e4b\u9593\u7684\u5b50\u7db2\u8def\u5c31\u662f\u4e0b\u4e00\u6bb5\u5b50\u7db2\u8def\u4f4d\u5740\uff1a \u8def\u7531\u5668D\u548c\u8def\u7531\u5668S\u4e4b\u9593\u7684\u5b50\u7db2\u8def\u5c31\u662f\u4e0b\u4e00\u6bb5\u5b50\u7db2\u8def\u4f4d\u5740\uff1a \u73fe\u5728\uff0c\u628a\u9019\u4e9b\u5b50\u7db2\u8def\u8cc7\u8a0a\u52a0\u5230\u525b\u525b\u7684\u7db2\u8def\u67b6\u69cb\u5716\u4e2d\uff0c\u5c31\u5b8c\u6210\u4e86\u6574\u500bIP\u4f4d\u5740\u5206\u914d\uff0c\u5982\u57163\u6240\u793a\u3002 \u5927\u529f\u544a\u6210\uff01\u5230\u9019\u88e1\uff0c\u76f8\u4fe1\u5927\u5bb6\u5df2\u7d93\u4e86\u89e3\u5230\u9019\u500b\u6280\u8853\u7684\u5a01\u529b\u4e86\u3002 CIDR \u91cd\u9ede2\uff1a\u8def\u7531\u532f\u7e3d \u00b6 \u8def\u7531\u532f\u7e3d\u5c31\u662fRoute Summarization\uff0c\u53c8\u7a31\u70baRoute Aggregation\u6216\u662fSuper-netting\u3002\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u5728\u65bc\u5c07\u591a\u7b46\u8def\u7531\u8cc7\u8a0a\u532f\u7e3d\u800c\u6210\u6bd4\u8f03\u7c21\u55ae\u7684\u55ae\u7b46\u8def\u7531\u8cc7\u8a0a\u3002 \u5982\u679c\u7528\u5be6\u969b\u751f\u6d3b\u7684\u7bc4\u4f8b\u4f86\u89e3\u91cb\u7684\u8a71\uff0c\u53ef\u4ee5\u9019\u6a23\u601d\u8003\uff1a\u628a\u4fe1\u4ef6\u60f3\u6210\u662f\u7db2\u8def\u5c01\u5305\uff0c\u5730\u5740\u5c31\u662fIP\u4f4d\u5740\uff0c\u8def\u7531\u7576\u7136\u5c31\u662f\u5404\u500b\u90f5\u5dee\u5982\u4f55\u53bb\u904b\u9001\u9019\u4e9b\u4fe1\u4ef6\u7684\u65b9\u5f0f\u3002\u70ba\u4e86\u9054\u5230\u5f88\u597d\u7684\u6548\u7387\uff0c\u56e0\u6b64\u7522\u751f\u73fe\u5728\u9019\u6a23\u7684\u5730\u5740\u8a2d\u8a08\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u53f0\u5317\u5e02\u5206\u6210\u5404\u500b\u5340\uff0c\u6709\u5927\u5b89\u5340\u3001\u4e2d\u6b63\u5340\u3001\u4fe1\u7fa9\u5340\u7b49\u7b49\uff0c\u6240\u4ee5\u7576\u90f5\u5dee\u9084\u6c92\u6709\u770b\u5230\u8a73\u7d30\u7684\u5730\u5740\u4e4b\u524d\uff0c\u53ef\u4ee5\u5148\u6839\u64da\u5927\u5340\u57df\u5148\u5206\u985e\uff0c\u7136\u5f8c\u518d\u7531\u5404\u500b\u5340\u57df\u7684\u90f5\u5dee\u53bb\u7d30\u90e8\u904b\u9001\u3002\u540c\u6a23\u5730\uff0c\u7576\u5176\u4ed6\u7e23\u5e02\u90f5\u5c40\u770b\u5230\u662f\u9001\u5f80\u53f0\u5317\u5e02\u7684\u4fe1\u4ef6\uff0c\u4e5f\u4e0d\u7528\u770b\u7d30\u90e8\u7684\u5730\u5740\u751a\u81f3\u65bc\u5340\u57df\uff0c\u76f4\u63a5\u5148\u9001\u5f80\u53f0\u5317\u5e02\u8ca0\u8cac\u7684\u90f5\u5c40\uff08\u5047\u8a2d\u6709\u4e00\u500b\u53f0\u5317\u5e02\u90f5\u5c40\u5148\u8655\u7406\u5168\u90e8\u9001\u5f80\u53f0\u5317\u5e02\u7684\u6240\u6709\u4fe1\u4ef6\uff09\uff0c\u9019\u6a23\u7684\u8a2d\u8a08\u6703\u8b8a\u5f97\u5f88\u6709\u6548\u7387\u3002\u8def\u7531\u532f\u7e3d\u7684\u8a2d\u8a08\u539f\u7406\u8ddf\u9019\u7bc4\u4f8b\u662f\u985e\u4f3c\u7684\u3002 \u63a5\u8457\u4f86\u770b\u770b\u57164\u9019\u500b\u4f8b\u5b50\uff0c\u4e5f\u8a31\u5927\u5bb6\u6703\u6bd4\u8f03\u5bb9\u6613\u4e86\u89e3\u8def\u7531\u532f\u7e3d\u7684\u7528\u9014\u548c\u597d\u8655\u5728\u54ea\u88e1\u3002 \u5728\u57164\u7684\u7db2\u8def\u67b6\u69cb\u5716\u4e2d\uff0c\u8def\u7531\u5668X\u9023\u63a5\u8457\u5169\u500b\u5b50\u7db2\u8def\uff0c\u5206\u5225\u662f172.16.32.0/24\u548c172.16.128.0/24\uff0c\u5982\u679c\u6c92\u6709\u8def\u7531\u532f\u7e3d\uff0c\u5247\u8def\u7531\u5668X\u5fc5\u9808\u628a\u9019\u5169\u500b\u5b50\u7db2\u8def \u4e2d\u7684\u8def\u7531\u8cc7\u8a0a\u5168\u90e8\u50b3\u9001\u7d66\u8def\u7531\u5668Y\uff0c\u5982\u6b64\u4e00\u4f86\uff0c\u4e00\u65e6\u9019\u5169\u500b\u5b50\u7db2\u8def\u4e2d\u6709\u4efb\u4f55\u7684\u6539\u8b8a\uff0c\u5247\u8def\u7531\u5668X\u90fd\u5fc5\u9808\u50b3\u9001\u76f8\u5c0d\u61c9\u7684\u8def\u7531\u8cc7\u8a0a\u7d66\u8def\u7531\u5668Y\uff0c\u9019\u6a23\u4e0d\u50c5\u589e\u52a0\u592a\u591a\u7db2\u8def\u8ca0\u64d4\uff0c\u8981\u7dad\u8b77\u9019\u4e9b\u8cc7\u6599\u4e5f\u662f\u76f8\u7576\u9ebb\u7169\u7684\u4e8b\u60c5\u3002 \u5982\u679c\u518d\u4ed4\u7d30\u770b\u4e00\u4e0b\u9019\u500b\u7db2\u8def\u67b6\u69cb\u5716\uff0c\u53ef\u4ee5\u767c\u73fe\u5c0d\u65bc\u8def\u7531\u5668Y\u800c\u8a00\uff0c\u76f8\u7576\u65bc\u300c\u8def\u7531\u5668X\u77e5\u9053\u5982\u4f55\u9001\u5230172.16.0.0/16\u9019\u6a23\u7684\u7db2\u8def\u5340\u6bb5\u300d\u3002\u6240\u4ee5\uff0c\u4ee5\u5f8c\u4e00\u65e6\u8def\u7531\u5668Y\u6536\u5230\u76f8\u7576\u65bc\u50b3\u9001\u7d66172.16.0.0/16\u9019\u6a23\u7684\u76ee\u7684\u5730\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u628a\u9019\u6a23\u7684\u5c01\u5305\u50b3\u9001\u7d66\u8def\u7531\u5668X\uff0c\u56e0\u70ba\u5b83\u77e5\u9053\u600e\u9ebc\u50b3\u9001\u3002\u628a172.16.32.0/24\u548c172.16.128.0/24\u9019\u5169\u500b\u5b50\u7db2\u8def\u8def\u7531\u8cc7\u8a0a\u7d50\u5408\u6210\u4e00\u7b46172.16.0.0/16\u7684\u8def\u7531\uff0c\u5c31\u662f\u8def\u7531\u532f\u7e3d\u7684\u529f\u80fd\u3002 Classless\u7684\u8def\u7531\u5354\u5b9a\uff08\u50cf\u662fRIPv2\u3001OSPF\u3001IS-IS\u4ee5\u53caEIGRP\u8def\u7531\u5354\u5b9a\u7b49\u7b49\uff09\u90fd\u6709\u652f\u63f4\u8def\u7531\u532f\u7e3d\uff0c\u7576\u7136\u4e5f\u652f\u63f4VLSM\uff0c\u800cClassful\u7684\u8def\u7531\u5354\u5b9a\uff08\u4f8b\u5982RIPv1\u548cIGRP\u8def\u7531\u5354\u5b9a\uff09\u5247\u6c92\u6709\u652f\u63f4\u8def\u7531\u532f\u7e3d\uff0c\u56e0\u70ba\u5df2\u7d93\u81ea\u52d5\u505a\u4e86\u76f8\u5c0d\u61c9\u7684\u532f\u7e3d\u52d5\u4f5c\u3002 \u8def\u7531\u532f\u7e3d\u7684\u8a73\u7d30\u8cc7\u8a0a\u8207\u904b\u4f5c\u65b9\u5f0f\uff0c\u90fd\u88ab\u5b9a\u7fa9\u5728RFC 1518\u4e4b\u4e2d\uff08An Architecture for IP Address Allocation with CIDR\uff09\uff0c\u53ef\u524d\u5f80\u67e5\u770b\u4e26\u7814\u8b80\u3002 \u8def\u7531\u532f\u7e3d\u7684\u8a08\u7b97\u65b9\u5f0f \u00b6 \u4e86\u89e3\u8def\u7531\u532f\u7e3d\u7684\u76ee\u7684\u8207\u904b\u4f5c\u65b9\u5f0f\u4e4b\u5f8c\uff0c\u61c9\u8a72\u5c31\u5df2\u7d93\u5927\u7565\u660e\u767d\u5982\u4f55\u8a08\u7b97\u8def\u7531\u532f\u7e3d\u7684\u8cc7\u6599\u3002\u4e0d\u904e\uff0c\u4e0b\u9762\u9084\u662f\u7528\u4f8b\u5b50\u4f86\u8aaa\u660e\u4e00\u4e0b\u3002\u5047\u8a2d\u6709\u500b\u8def\u7531\u5668\u6536\u5230\u4ee5\u4e0b\u9019\u4e9b\u5b50\u7db2\u8def\u7684\u8def\u7531\u8cc7\u8a0a\u66f4\u65b0\uff1a \u90a3\u9ebc\u8def\u7531\u532f\u7e3d\u4e4b\u5f8c\u7684\u8cc7\u6599\u61c9\u8a72\u662f\u5982\u4f55\u5462\uff1f\u9996\u5148\u628a\u9019\u4e9b\u8cc7\u6599\u8f49\u6210\u4e8c\u9032\u4f4d\uff1a \u8f49\u63db\u4e4b\u5f8c\uff0c\u5f88\u5bb9\u6613\u5c31\u53ef\u4ee5\u767c\u73fe\uff0c\u524d\u9762\u7c97\u9ad4\u5b57\u90e8\u5206\u5728\u9019\u516b\u500b\u5b50\u7db2\u8def\u7576\u4e2d\u90fd\u662f\u4e00\u6a23\u7684\uff0c\u6240\u4ee5\u9019\u4e9b\u76f8\u540c\u7684\u90e8\u5206\u5c31\u662f\u8def\u7531\u532f\u7e3d\u4e4b\u5f8c\u7684\u7d50\u679c\uff0c\u4e5f\u5c31\u662f\uff1a \u56e0\u70ba\u76f8\u540c\u7684\u90e8\u5206\u670921\u500b\u6578\u5b57\uff0c\u6240\u4ee5\u906e\u7f69\u5c31\u662f21\u3002\u56e0\u6b64\uff0c\u6700\u5f8c\u8def\u7531\u532f\u7e3d\u7684\u7d50\u679c\u5c31\u662f\uff1a \u73fe\u5728\uff0c\u61c9\u8a72\u4e5f\u80fd\u5b8c\u5168\u4e86\u89e3\u8def\u7531\u532f\u7e3d\u4e86\u3002\u63a5\u8457\uff0c\u4f86\u770b\u770b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u4e0b\u7684\u8def\u7531\u532f\u7e3d\u53c8\u662f\u5982\u4f55\u3002 \u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u8def\u7531\u532f\u7e3d \u00b6 \u4ee5\u57165\u7684\u7db2\u8def\u67b6\u69cb\u5716\u70ba\u4f8b\uff0c\u70ba\u5927\u5bb6\u8aaa\u660e\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u8def\u7531\u532f\u7e3d\u53c8\u662f\u5982\u4f55\u8a08\u7b97\u7684\u3002 \u5047\u8a2d\u8def\u7531\u5668E\u3001F\u4ee5\u53ca\u8def\u7531\u5668H\u6703\u628a\u8def\u7531\u8cc7\u8a0a\u50b3\u9001\u7d66\u8def\u7531\u5668G\uff0c\u7136\u5f8c\u8def\u7531\u5668G\u6703\u628a\u8def\u7531\u8cc7\u8a0a\u50b3\u9001\u7d66\u8def\u7531\u5668Z\uff0c\u9019\u88e1\u53ef\u4ee5\u767c\u73fe\uff0c\u8def\u7531\u5668E\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def\u906e\u7f69\u662f26\uff0c\u800c\u8def\u7531\u5668F\u548c\u8def\u7531\u5668H\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def\u906e\u7f69\u662f20\uff0c\u56e0\u6b64\u9019\u500b\u7db2\u8def\u67b6\u69cb\u662f\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u3002 \u5e95\u4e0b\u4f86\u770b\u770b\u5982\u4f55\u5728\u9019\u500b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u74b0\u5883\u4e2d\u505a\u5230\u8def\u7531\u532f\u7e3d\u3002\u9996\u5148\uff0c\u532f\u7e3d\u8def\u7531\u5668E\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def\uff0c\u82e5\u5c07\u8def\u7531\u5668E\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def172.16.32.64/26\u548c172.16.32.128/26\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\uff0c\u5247\u5982\u4e0b\u5217\u6240\u793a\uff1a \u53ef\u4ee5\u767c\u73fe\u532f\u7e3d\u8d77\u4f86\u7684\u7d50\u679c\u662f\uff1a \u6240\u4ee5\uff0c\u8def\u7531\u5668E\u50b3\u9001\u7d66\u8def\u7531\u5668G\u7684\u8def\u7531\u532f\u7e3d\u8cc7\u6599\u662f172.16.32.0/24\u3002\u56e0\u6b64\uff0c\u8def\u7531\u5668G\u6703\u6536\u5230\u7684\u8def\u7531\u8cc7\u6599\u6709\uff1a 172.16.128.0/20 172.16.32.0/24 172.16.64.0/20 \u82e5\u5c07\u9019\u4e9b\u8cc7\u6599\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\uff0c\u5247\u5982\u4e0b\u5217\u6240\u793a\uff1a \u5373\u4f7f\u9019\u4e09\u7b46\u8def\u7531\u8cc7\u6599\u5404\u4f7f\u7528\u4e0d\u540c\u7684\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u4f46\u5f9e\u4e0a\u9762\u7684\u4e8c\u9032\u4f4d\u8868\u793a\u6cd5\u4e2d\u53ef\u4ee5\u5f88\u6e05\u695a\u5730\u767c\u73fe\uff0c\u76f8\u540c\u4e4b\u8655\u53ea\u6709\u6700\u524d\u9762\u7684\u90e8\u5206\uff0c\u5982\u4e0b\u6240\u793a\uff1a \u800c\u5f8c\u9762\u90fd\u5b8c\u5168\u4e0d\u540c\uff0c\u6240\u4ee5\u9019\u4e09\u7b46\u8def\u7531\u8cc7\u6599\u7d93\u904e\u8def\u7531\u532f\u7e3d\u4e4b\u5f8c\u7684\u7d50\u679c\u61c9\u8a72\u662f\uff1a \u770b\u5230\u9019\u88e1\uff0c\u60f3\u5fc5\u5927\u5bb6\u61c9\u8a72\u90fd\u5df2\u7d93\u5b8c\u5168\u660e\u767d\u5728\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u74b0\u5883\u4e2d\u5982\u4f55\u505a\u5230\u8def\u7531\u532f\u7e3d\u4e86\u3002 \u8a2d\u8a08\u8def\u7531\u532f\u7e3d\u6240\u5fc5\u9808\u8003\u616e\u7684\u56e0\u7d20 \u00b6 \u5f9e\u9019\u4e9b\u4ecb\u7d39\u53ef\u4ee5\u767c\u73fe\u8def\u7531\u532f\u7e3d\u6709\u4ee5\u4e0b\u9019\u4e9b\u597d\u8655\uff1a \u6709\u6548\u5730\u6e1b\u5c11\u8def\u7531\u66f4\u65b0\u7684\u983b\u7387 \u6e1b\u5c11\u4e0d\u5fc5\u8981\u7684\u7db2\u8def\u6d41\u91cf \u6e1b\u5c11\u8def\u7531\u8868\u6240\u4f54\u64da\u7684\u8a18\u61b6\u9ad4\u4f7f\u7528\u91cf \u4f46\u662f\uff0c\u5728\u4f7f\u7528\u8def\u7531\u532f\u7e3d\u7684\u540c\u6642\uff0c\u4ee5\u4e0b\u9019\u4e9b\u56e0\u7d20\u4e5f\u662f\u7db2\u8def\u7ba1\u7406\u4eba\u54e1\u6240\u5fc5\u9808\u8003\u91cf\u7684\uff1a \u6240\u6709\u4e0d\u540c\u7684IP\u4f4d\u5740\u90fd\u5fc5\u9808\u64c1\u6709\u4e00\u5b9a\u7a0b\u5ea6\u7684\u76f8\u540c\u4e4b \u4f4d\u5143\u3002\u9019\u88e1\u6240\u6307\u7684\u76f8\u540c\u7684\u4f4d\u5143\uff0c\u7576\u7136\u90fd\u5fc5\u9808\u662f\u5f9e\u5de6\u908a\u8003\u91cf\u904e\u4f86\uff0c\u4e5f\u5c31\u662f\u6240\u8b02\u7684Highest Order Bits\u3002 \u8def\u7531\u7684\u6c7a\u5b9a\u5fc5\u9808\u53d6\u6c7a\u65bc\u6574\u500b\u5b8c\u6574\u7684\u4f4d\u5740\uff0c\u4e5f\u5c31\u662f\u6574 \u500b32\u4f4d\u5143\u7684\u4f4d\u5740\u3002 \u8def\u7531\u5354\u5b9a\u5fc5\u9808\u50b3\u9001\u5b50\u7db2\u8def\u906e\u7f69\u7684\u9577\u5ea6\u8cc7\u8a0a\u3002 CIDR\u7684\u512a\u52e2\u6240\u5728 \u00b6 \u7531\u4e0a\u9762\u7684\u4f8b\u5b50\u8207\u5404\u7a2e\u6280\u8853\u7684\u8aaa\u660e\uff0c\u53ef\u4ee5\u770b\u51faCIDR\u7684\u80fd\u529b\u8207\u4f7f\u7528\u7684\u65b9\u6cd5\uff0c\u56e0\u6b64\u4ee5\u4e0b\u53ef\u4ee5\u6b78\u7d0d\u51fa\u5e7e\u500bCIDR\u7684\u512a\u9ede\uff1a 1. \u66f4\u6709\u6548\u5730\u4f7f\u7528IP\u4f4d\u5740 \u5f9e\u4e0a\u9762\u7684\u7bc4\u4f8b\u5c31\u53ef\u4ee5\u770b\u51fa\u4f86\uff0c\u5206\u5272\u5b50\u7db2\u8def\u6642\uff0c\u6240\u53ef\u80fd\u6d6a\u8cbb\u7684IP\u4f4d\u5740\u6578\u91cf\u53ef\u85c9\u7531\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u800c\u5927\u91cf\u5730\u6e1b\u5c11\u3002 2. \u53ef\u9054\u5230\u66f4\u597d\u7684\u8def\u7531\u532f\u7e3d\u529f\u80fd \u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u8b93IP\u5206\u914d\u66f4\u6709\u968e\u5c64\u5f0f\u67b6\u69cb\u7684\u611f\u89ba\uff0c\u4f46\u53c8\u4e0d\u53d7\u9650\u65bc\u539f\u672c\u7684\u985e\u5225\u5206\u5272\u65b9\u5f0f\u3002\u8209\u525b\u525b\u7684\u4f8b\u5b50\u4f86\u8aaa\uff0c\u539f\u672c\u5b50\u7db2\u8def\u7684\u90e8\u5206\u70ba172.16.32.0/20\uff0c\u4f46\u662f\u900f\u904e\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u53ef\u4ee5\u518d\u6b21\u5206\u6210172.16.32.0/28\u3001172.16.32.32/28\u7b49\u7b49\u7684\u5b50\u7db2\u8def\u3002 \u56e0\u6b64\uff0c\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u7b49\u65bc\u662f\u5f9e\u539f\u672c\u7684\u5b50\u7db2\u8def\u518d\u6b21\u5207\u5272\u51fa\u4f86\uff0c\u800c\u9019\u7a2e\u60c5\u6cc1\u5728\u8def\u7531\u8868\u683c\u4e2d\u53ef\u4ee5\u9054\u5230\u66f4\u597d\u7684\u8def\u7531\u532f\u7e3d\u529f\u80fd\uff08Route Summarization\uff09\u3002 3. \u80fd\u6709\u6548\u6e1b\u5c11\u5176\u4ed6\u8def\u7531\u5668\u7684\u8def\u7531\u66f4\u65b0\u6b21\u6578 \u5982\u679c\u8def\u7531\u532f\u7e3d\u529f\u80fd\u88ab\u4f7f\u7528\u5728\u5927\u578b\u6216\u662f\u6bd4\u8f03\u8907\u96dc\u7684\u7db2\u8def\u67b6\u69cb\u4e2d\uff0c\u5247\u5728\u67d0\u500b\u5b50\u7db2\u8def\u5e95\u4e0b\u7684\u67d0\u7db2\u8def\u9023\u7d50\u6709\u72c0\u6cc1\u4e0a\u7684\u6539\u8b8a\uff0c\u4e5f\u4e0d\u6703\u5f71\u97ff\u5176\u4ed6\u7db2\u6bb5\u7684\u8def\u7531\u5668\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u5047\u8a2d\u5728172.16.32.0/28\u4e2d\u6709\u500b\u7db2\u8def\u9023\u7dda\u4e0d\u7a69\u5b9a\uff0c\u9023\u7dda\u6642\u597d\u6642\u58de\uff0c\u5247\u56e0\u70ba\u6709\u4f7f\u7528\u8def\u7531\u532f\u7e3d\u529f\u80fd\uff0c\u6240\u4ee5\u5c0d\u5176\u4ed6\u7db2\u6bb5\u7684\u8def\u7531\u5668\u800c\u8a00\uff0c\u6839\u672c\u4e0d\u7528\u8003\u616e\u5230\u5982\u6b64\u8a73\u76e1\u7684\u8cc7\u6599\uff0c\u4e5f\u5c31\u662f\u8aaa\uff0c\u5176\u4ed6\u8def\u7531\u5668\u4e26\u4e0d\u9700\u8981\u505a\u76f8\u5c0d\u983b\u7e41\u7684\u8def\u7531\u8cc7\u6599\u66f4\u65b0\u52d5\u4f5c\u3002 \u7d50\u8a9e \u00b6 \u5176\u5be6\u7c21\u55ae\u4f86\u8aaa\uff0cCIDR\u7d9c\u5408\u4e86\u4ee5\u4e0a\u63d0\u5230\u7684\u6280\u8853\uff0c\u9019\u4e9b\u90fd\u662f\u5f9eRFC 1518\u548c1519\u7b49\u6587\u4ef6\u958b\u59cb\u8a18\u9304\u9019\u4e9b\u6539\u9032\u5f8c\u7684\u8a2d\u8a08\u3002\u9019\u88e1\u6574\u7406\u51fa\u5e7e\u500bCIDR\u7684\u5b97\u65e8\uff1a \u7db2\u8def\u906e\u7f69\u53ef\u4ee5\u6307\u5b9a\u4efb\u610f\u9577\u5ea6\uff0c\u4e5f\u5c31\u662f\u63a1\u7528\u591a\u8b8a\u9577\u5ea6 \u5b50\u7db2\u8def\u906e\u7f69\u7684\u6280\u8853\u3002 \u5229\u7528\u8def\u7531\u532f\u7e3d\u7684\u65b9\u5f0f\uff0c\u4f7f\u5f97\u7db2\u8def\u8def\u7531\u7a0b\u5e8f\u7c21\u55ae\u5316\uff0c \u4e0d\u9700\u8981\u5206\u7d1a\u3002 \u6253\u7834\u539f\u672c\u985e\u5225\u7684\u898f\u7bc4\uff0c\u53ef\u4ee5\u4f9d\u64da\u771f\u6b63\u7684\u9700\u6c42\u4f86\u898f\u5283 IP\u4f4d\u5740\u5206\u914d\u3002 \u5230\u9019\u88e1\u70ba\u6b62\uff0c\u76f8\u4fe1\u5404\u4f4d\u5df2\u7d93\u660e\u767d\u6240\u8b02\u7684CIDR\uff08Classless Inter-Domain Routing\uff09\u662f\u5982\u4f55\u904b\u4f5c\u7684\uff0c\u5305\u542b\u9019\u9805\u6280\u8853\u7684\u8a2d\u8a08\u7de3\u7531\u3001\u8a2d\u8a08\u65b9\u5f0f\u4ee5\u53ca\u904b\u4f5c\u539f\u7406\u7b49\u7b49\uff0c\u5e0c\u671b\u80fd\u5920\u8b93\u5927\u5bb6\u4e86\u89e3\u5982\u4f55\u66f4\u6709\u6548\u5730\u898f\u5283\u4f01\u696d\u7684\u7db2\u8def\u3002","title":"\u7121\u985e\u5225\u5340\u9694\u8def\u7531 CIDR"},{"location":"networking/cidr/cidr-intro/#cidr","text":"\u4f5c\u8005: \u80e1\u51f1\u667a, \u539f\u6587: \u7121\u985e\u5225\u5340\u9694\u8def\u7531CIDR \u6280\u8853 \u70ba\u4e86\u907f\u514d\u9020\u6210IP\u4f4d\u5740\u7684\u5927\u91cf\u6d6a\u8cbb\uff0c\u65bc\u662f\u51fa\u73fe\u4e86\u7121\u985e\u5225\u5340\u9694\u8def\u7531\uff08CIDR\uff09\u6280\u8853\uff0c\u672c\u6587\u5c07\u4ecb\u7d39CIDR\u985e\u578b\u7684IP\u4f4d\u5740\u5206\u914d\u65b9\u5f0f\u53ca\u76f8\u95dc\u7684\u8def\u7531\u6280\u8853\uff0c\u4e26\u8aaa\u660eCIDR\u7684\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u8207\u8def\u7531\u532f\u7e3d\u5169\u9805\u91cd\u8981\u6280\u8853\u3002 \u7db2\u969b\u7db2\u8def\u901a\u8a0a\u5354\u5b9a\uff08IP\uff09\u4f4d\u5740\u7684\u5206\u914d\u662f\u6839\u64daIP\u4f4d\u5740\u768432\u500b\u4f4d\u5143\uff0c\u5206\u6210 Class A\u3001Class B \u4ee5\u53ca Class C \u7b49\u7db2\u8def\u5340\u57df\uff0c\u4f9d\u64da32\u500b\u4f4d\u5143\u4ee5\u6bcf8\u500b\u4f4d\u5143\u4e00\u7d44\u4f86\u5340\u9694\u505a\u4e0d\u540c\u7684\u985e\u5225\uff08Class\uff09\uff0c\u800c\u6bcf\u4e00\u500b\u985e\u5225\u4f9d\u64da\u9019\u6a23\u7684\u5340\u9694\u6709\u4e0d\u4e00\u6a23\u7684IP\u5bb9\u7d0d\u6578\u91cf\u3002\u4e5f\u56e0\u6b64\uff0c\u53ef\u4ee5\u6839\u64da\u9700\u6c42\u4f86\u6c7a\u5b9a\u8981\u4f7f\u7528\u54ea\u4e00\u7a2e\u985e\u5225\u3002\u4f46\u662f\u9019\u6a23\u7684\u65b9\u5f0f\u904e\u6c92\u591a\u4e45\uff0c\u5c31\u767c\u73fe\u5230\u985e\u5225\u4e4b\u9593\u7684\u5dee\u8ddd\u904e\u5927\uff0c\u800c\u9020\u6210IP\u4f4d\u5740\u7684\u5927\u91cf\u6d6a\u8cbb\u3002 \u5f8c\u4f86\u7522\u751f\u4e86\u6240\u8b02\u7121\u985e\u5225\u5340\u9694\u7684\u8def\u7531\u65b9\u5f0f\uff0c\u82f1\u6587\u7a31\u4e4b\u70ba Classless Inter-Domain Routing \uff0c\u7c21\u7a31 CIDR \uff0c\u9019\u7bc7\u6587\u7ae0\u5c31\u662f\u8981\u4ecb\u7d39\u9019\u7a2e\u985e\u578b\u7684IP\u4f4d\u5740\u5206\u914d\u65b9\u5f0f\u4ee5\u53ca\u76f8\u95dc\u7684\u8def\u7531\u6280\u8853\u3002","title":"\u7121\u985e\u5225\u5340\u9694\u8def\u7531 CIDR \u6280\u8853"},{"location":"networking/cidr/cidr-intro/#ip","text":"\u5728\u4ecb\u7d39 CIDR \u76f8\u95dc\u6280\u8853\u4e4b\u524d\uff0c\u4e00\u5b9a\u8981\u5148\u5c0d IP \u4f4d\u5740\u6709\u57fa\u672c\u7684\u4e86\u89e3\uff0c\u6240\u4ee5\u5148\u4ecb\u7d39\u8207 IP \u76f8\u95dc\u7684\u5b50\u7db2\u8def\u3001\u7db2\u8def\u906e\u7f69\u3001\u7db2\u8def\u4f4d\u5740\u4ee5\u53ca\u4e3b\u6a5f\u4f4d\u5740\u7b49\u77e5\u8b58\u3002 IP\u4f4d\u5740\u548c\u985e\u5225 \u5927\u5bb6\u90fd\u77e5\u9053\u4e00\u500bIP\u4f4d\u5740\u9577\u5f97\u50cf\u662f\u4e0b\u9762 \u9019\u6a23\uff1a \u9019\u662f\u753132\u500b\u4f4d\u5143\u3001\u6bcf8\u500b\u4f4d\u5143\u7528\u4e00\u500b\u5341\u9032\u4f4d\u7684\u6578\u5b57\u4f86\u8868\u793a\uff0c\u6240\u4ee5\u4e00\u5171\u67094\u500b\u6578\u5b57\u3002\u4e00\u822c\u4f86\u8aaa\uff0c\u6703\u4f9d\u64da\u4f4d\u5143\u7d44\uff088\u500b\u4f4d\u5143\uff09\u7684\u500b\u6578\u4f86\u5340\u9694\u6210\u4e0d\u540c\u985e\u5225\uff08Class\uff09\u7684\u7db2\u8def\uff0c\u4e0d\u540c\u985e\u578b\u7684\u7db2\u8def\u53ef\u4ee5\u5bb9\u7d0d\u4e0d\u540c\u6578\u91cf\u7684IP\u4f4d\u5740\u6578\u76ee\u3002 \u4f8b\u5982\uff0c\u82e5\u4f7f\u75288\u500b\u4f4d\u5143\u4f86\u8b8a\u5316\uff0c\u4ee5\u4fbf\u65bc\u5bb9\u7d0dIP\u4f4d\u5740\u7684\u8a71\uff0c\u5c31\u53ef\u4ee5\u5bb9\u7d0d28\u500bIP\u4f4d\u5740\uff0c\u4e5f\u5c31\u662f256\u500b\u3002\u82e5\u4f7f\u7528\u5169\u500b\u4f4d\u5143\u7d44\uff08\u5c31\u662f16\u500b\u4f4d\u5143\uff09\u4f86\u505a\u8b8a\u5316\uff0c\u5c31\u53ef\u4ee5\u5bb9\u7d0d216\u500b\uff0c\u4e5f\u5c31\u662f65,536\u500bIP\u4f4d\u5740\u3002\u4ee5\u9019\u6a23\u7684\u57fa\u790e\u7684\u5b9a\u5740\u8207\u8def\u7531\uff0c\u90fd\u7a31\u4e4b\u70ba Classful\uff0c\u4e5f\u5c31\u662f\u4ee5 \u985e\u5225 \u70ba\u57fa\u790e\u7684\u65b9\u5f0f\u3002 \u4e0d\u904e\uff0c\u9019\u7a2e\u65b9\u5f0f\u4e26\u4e0d\u662f\u9019\u88e1\u8981\u8b1b\u7684\u4e3b\u984c\uff0c\u6240\u4ee5\u4e0d\u6703\u591a\u52a0\u4ecb\u7d39\u3002\u9019\u7bc7\u6587\u7ae0\u8981\u8aaa\u7684\uff0c\u662f\u8981\u6253\u7834\u9019\u7a2e\u4ee5\u985e\u5225\u70ba\u57fa\u790e\u7684\u5b9a\u5740\u8207\u8def\u7531\uff0c\u6240\u4ee5\u7a31\u4e4b\u70ba Classless \u3002 \u70ba\u4ec0\u9ebc\u5148\u8b1b\u9019\u4e9b\uff1f\u56e0\u70ba\u60f3\u8b93\u5927\u5bb6\u5148\u77e5\u9053 CIDR \u8981\u8457\u91cd\u7684\u7bc4\u570d\u662f\u4ec0\u9ebc\uff0c\u9019\u6a23\u4e00\u4f86\uff0c\u518d\u4f86\u770b\u9019\u7bc7\u6587\u7ae0\u7684\u6642\u5019\u624d\u77e5\u9053\u5728\u8b1b\u4e9b\u4ec0\u9ebc\u3002\u4e0d\u904e\uff0c\u5728\u8a73\u7d30\u4ecb\u7d39 CIDR \u4e4b\u524d\uff0c\u5fc5\u9808\u8981\u78ba\u5be6\u5730\u4e86\u89e3\u4f55\u8b02\u7db2\u8def\u906e\u7f69\u3001\u5b50\u7db2\u8def\u7b49\u7b49\u77e5\u8b58\u3002","title":"IP \u4f4d\u5740\u7684\u76f8\u95dc\u77e5\u8b58"},{"location":"networking/cidr/cidr-intro/#ip_1","text":"\u518d\u6b21\u4f7f\u7528\u525b\u624d\u7684\u7bc4\u4f8b\uff0cIP\u4f4d\u5740\u5c31\u5982\u540c\u4ee5\u4e0b\u9019\u822c\uff1a \u9019\u662f\u753132\u500b\u4f4d\u5143\u3001\u6bcf8\u500b\u4f4d\u5143\u7528\u4e00\u500b\u5341\u9032\u4f4d\u7684\u6578\u5b57\u4f86\u8868\u793a\uff0c\u6240\u4ee5\u4e00\u5171\u67094\u500b\u6578\u5b57\u3002\u5982\u679c\u518d\u52a0\u4e0a\u7db2\u8def\u906e\u7f69\u7684\u8cc7\u8a0a\uff0c\u4e00\u822c\u7684\u5beb\u6cd5\u5c31\u5982\u4e0b\u9762\u6240\u793a\uff1a \u4ee5\u4e0a\u7684\u8868\u793a\u6cd5\u4ee3\u8868\u7db2\u8def\u4f4d\u5740\u662f172.16.0.0\uff0c\u800c\u5f8c\u9762\u768416\u5247\u8868\u793a\u300c\u7db2\u8def\u906e\u7f69\u7684\u4e8c\u9032\u4f4d\u8868\u793a\u6cd5\u4e2d\uff0c\u6700\u5f8c16\u500b\u6578\u5b57\u70ba0\u300d\uff0c\u56e0\u6b64\u4e0a\u9762\u7684\u8868\u793a\u6cd5\u662f\u7528\u4f86\u6558\u8ff0\u9019\u6a23\u4e00\u500b\u5b50\u7db2\u8def\u74b0\u5883\u3002\u5018\u82e5\u5c07\u7db2\u8def\u906e\u7f69\u7528\u4e8c\u9032\u4f4d\u4f86\u8868\u793a\uff0c\u5c31\u76f8\u7576\u65bc\u4ee5\u4e0b\u7684\u8868\u793a\u65b9\u5f0f\uff1a \u6700\u5f8c16\u500b\u4f4d\u6578\u90fd\u662f0\uff0c\u82e5\u628a\u9019\u6a23\u7684\u7db2\u8def\u906e\u7f69\u8f49\u63db\u6210\u5341\u9032\u4f4d\uff0c\u4e5f\u5c31\u662f\u8aaa\uff0c\u7db2\u8def\u906e\u7f69\u5c07\u70ba255.255.0.0\u3002","title":"\u7db2\u8def\u906e\u7f69\u548cIP\u4f4d\u5740\u8868\u793a\u65b9\u5f0f"},{"location":"networking/cidr/cidr-intro/#_1","text":"\u9084\u6709\u53e6\u4e00\u500b\u8981\u6ce8\u610f\u7684\u57fa\u672c\u77e5\u8b58\u662f\u7db2\u8def\u4f4d\u5740\uff08Network Address\uff09\u8207\u4e3b\u6a5f\u4f4d\u5740\uff08Host Address\uff09\uff0c\u5c31\u4ee5\u525b\u525b\u7684\u5b50\u7db2\u8def\u70ba\u4f8b\uff1a \u5047\u8a2d\u6709\u4e00\u500bIP\u4f4d\u5740172.16.32.4\u662f\u4f4d\u65bc\u9019\u500b\u5b50\u7db2\u8def\u5167\uff0c\u5247\u7db2\u8def\u4f4d\u5740\u70ba172.16.0.0\uff0c\u800c\u4e3b\u6a5f\u4f4d\u5740\u5373\u70ba172.16.32.4\uff0c\u800c\u5ee3\u64ad\u4f4d\u5740\u5c31\u662f\u628a\u5f8c\u9762\u4e3b\u6a5f\u4f4d\u5740\u7684\u90e8\u5206\uff0c\u5728\u4e8c\u9032\u4f4d\u7684\u8868\u793a\u6cd5\u4e2d\u90fd\u70ba1\uff0c\u5982\u679c\u628a172.16.0.0\u8f49\u6210\u4e8c\u9032\u4f4d\u8868\u793a\uff0c\u5247\u5982\u4e0b\u5217\u6240\u793a\uff1a \u56e0\u70ba\u77e5\u9053\u906e\u7f69\u6578\u76ee\u70ba16\uff0c\u6240\u4ee5\u5f9e\u5f8c\u9762\u6578\u904e\u4f8616\u500b\u6578\u5b57\u90fd\u662f\u5c6c\u65bc\u4e3b\u6a5f\u4f4d\u5740\u53ef\u4ee5\u5206\u914d\u7684\u90e8\u5206\uff0c\u56e0\u6b64\u9019\u500b\u7db2\u8def\u7684\u5ee3\u64ad\u4f4d\u5740\u5c31\u53ea\u8981\u628a\u9019\u4e9b\u4e3b\u6a5f\u4f4d\u5740\u53ef\u5206\u914d\u7684\u90e8\u5206\u90fd\u8a2d\u5b9a\u70ba1\u5373\u53ef\uff0c\u4e5f\u5c31\u662f\uff1a \u8f49\u6210\u5341\u9032\u4f4d\u5c31\u662f172.16.255.255\u3002\u53ef\u4ee5\u5f9e\u9019\u88e1\u767c\u73fe\u5230\uff0c\u9019\u500b\u5ee3\u64ad\u4f4d\u5740\u662f\u4e0d\u80fd\u88ab\u62ff\u4f86\u7576\u6210\u4e3b\u6a5f\u4f4d\u5740\uff0c\u7576\u7136\u7db2\u8def\u4f4d\u5740\u4e5f\u4e0d\u80fd\u62ff\u4f86\u7576\u4f5c\u4e3b\u6a5f\u4f4d\u5740\uff0c\u6240\u4ee5\u4e00\u500b\u5b50\u7db2\u8def\u4e2d\u5230\u5e95\u53ef\u4ee5\u7528\u591a\u5c11\u500bIP\u4f4d\u5740\u4f86\u7576\u4f5c\u4e3b\u6a5f\u4f4d\u5740\u5462\uff1f\u518d\u7e7c\u7e8c\u5f80\u4e0b\u770b\uff01","title":"\u7db2\u8def\u4f4d\u5740\u3001\u4e3b\u6a5f\u4f4d\u5740\u8207\u5ee3\u64ad\u4f4d\u5740"},{"location":"networking/cidr/cidr-intro/#ip_2","text":"\u7db2\u8def\u906e\u7f69\u5230\u5e95\u6709\u4ec0\u9ebc\u7528\u9014\uff1f\u5b83\u80fd\u8868\u793a\u9019\u500b\u7db2\u8def\u6216\u5b50\u7db2\u8def\u5167\u53ef\u4ee5\u4f7f\u7528\u7684IP\u4f4d\u5740\u6709\u591a\u5c11\uff0c\u9019\u662f\u6700\u57fa\u672c\u7684\u7528\u9014\u3002\u5f9e\u4e0a\u9762\u9019\u500b\u4f8b\u5b50\u4f86\u770b\uff0c\u7531\u65bc\u7db2\u8def\u906e\u7f69\u662f255.255.0.0\uff0c\u6240\u4ee5\u5f9e\u4e8c\u9032\u4f4d\u4f86\u770b\uff0c\u5b83\u5c31\u662f\uff08\u9019\u88e1\u628a\u4e0d\u80fd\u8b8a\u52d5\u7684\u90e8\u5206\u7528\u7c97\u9ad4\u4f86\u8868\u793a\uff09\uff1a \u9019\u4ee3\u8868\u5728\u5206\u914dIP\u4f4d\u5740\u6642\uff0c\u524d\u976216\u500b\u6578\u5b57\u4e0d\u80fd\u8b8a\u52d5\uff0c\u53ea\u6709\u5f8c\u976216\u500b\u6578\u5b57\u53ef\u4ee5\u8b8a\u52d5\uff0c\u800c\u524d\u9762\u4e0d\u80fd\u8b8a\u52d5\u7684\u5c31\u662f\u4f7f\u7528\u7db2\u8def\u4f4d\u5740\u7684\u90e8\u5206\u3002\u73fe\u5728\u4f86\u770b\u7db2\u8def\u4f4d\u5740\uff0c\u5728\u4e0a\u9762\u7684\u7bc4\u4f8b\u4e2d\uff0c\u7db2\u8def\u4f4d\u5740\u662f172.16.0.0\uff0c\u8f49\u6210\u4e8c\u9032\u4f4d\u5c31\u662f\uff1a \u800c\u80fd\u5920\u5206\u914d\u7684IP\u4f4d\u5740\u70ba\uff1a \u8f49\u6210\u5341\u9032\u4f4d\u7684\u8a71\uff0c\u5c31\u4ee3\u8868\u53ef\u4f7f\u7528\u7684IP\u4f4d\u5740\u7bc4\u570d\u70ba172.16.0.1\u5230172.16.255.254\u3002 \u6240\u4ee5\u9019\u500b\u5b50\u7db2\u8def\u4e2d\u53ef\u4ee5\u4f7f\u7528\u7684IP\u6578\u91cf\u70ba2\u768416\u6b21\u65b9\u6e1b2\uff0c\u4e5f\u5c31\u662f216-2=65534\u500bIP\u4f4d\u5740\u3002\u6e1b\u53bb\u5169\u500b\u7684\u90e8\u5206\u5206\u5225\u662f172.16.0.0\u8207172.16.255.255\u9019\u5169\u500bIP\u4f4d\u5740\uff0c\u70ba\u4ec0\u9ebc\u9019\u5169\u500b\u8981\u6e1b\u53bb\u5462\uff1f \u56e0\u70ba172.16.0.0\u5df2\u7d93\u88ab\u62ff\u4f86\u4f7f\u7528\u6210\u9019\u500b\u5b50\u7db2\u8def\u7684\u7db2\u8def\u4f4d\u5740\uff0c\u800c172.16.255.255\u662f\u5ee3\u64ad\u4f4d\u5740\uff0c\u4e0d\u80fd\u88ab\u62ff\u4f86\u5206\u914d\u6210\u4e00\u822cIP\u4f4d\u5740\u4f7f\u7528\u3002\u5230\u76ee\u524d\u70ba\u6b62\uff0c\u5927\u5bb6\u5c0d\u65bcIP\u4f4d\u5740\u5206\u914d\u61c9\u8a72\u5df2\u7d93\u6709\u521d\u6b65\u7684\u6982\u5ff5\u4e86\u3002 \u63a5\u8457\uff0c\u518d\u8aaa\u660eCIDR\u4e2d\u4e00\u500b\u5f88\u91cd\u8981\u7684\u77e5\u8b58\uff1a\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u3002","title":"\u5b50\u7db2\u8def\u4e2d\u6240\u80fd\u4f7f\u7528\u7684IP\u6578\u91cf"},{"location":"networking/cidr/cidr-intro/#cidr-1","text":"\u4e00\u822c\u800c\u8a00\uff0c\u5728\u5207\u5272\u5b50\u7db2\u8def\u6642\uff0c\u5b50\u7db2\u8def\u906e\u7f69\u90fd\u662f\u5207\u6210\u985e\u4f3c255.255.255.0\u6216255.255.0.0\u9019\u6a23\u7684\u6578\u5b57\u3002\u4e0d\u904e\uff0c\u9019\u6a23\u5207\u5272\u7684\u8a71\uff0c\u96d6\u7136\u5f88\u5bb9\u6613\u4f7f\u7528\uff0c\u4f46\u53ef\u80fd\u6703\u9020\u6210IP\u7684\u6d6a\u8cbb\uff0c\u56e0\u70ba\u4e0d\u898b\u5f97\u6bcf\u500b\u5b50\u7db2\u8def\u4e2d\u7684IP\u4f7f\u7528\u91cf\u90fd\u662f\u76f8\u540c\u7684\u3002 \u5c31\u62ff\u4e0a\u9762\u7684\u7bc4\u4f8b\u4f86\u8aaa\uff0c\u53ef\u4ee5\u770b\u5230\u4e0a\u9762\u7684\u5b50\u7db2\u8def\u53ef\u4ee5\u5206\u914d\u51fa65,534\u500bIP\u4f4d\u5740\uff0c\u9019\u4e5f\u592a\u591a\u4e86\u5427\uff1f\u5c31\u7b97\u4f7f\u7528255.255.255.0\u9019\u6a23\u7684\u7db2\u8def\u906e\u7f69\uff0c\u90a3\u5b50\u7db2\u8def\u4e2d\u7684IP\u4f4d\u5740\u500b\u6578\u4e5f\u6709254\u500b\uff0c\u4e5f\u662f\u4e0d\u5c11\u3002 \u5047\u8a2d\u6709\u4e00\u500b\u516c\u53f8\u8981\u70ba\u884c\u653f\u90e8\u9580\u5206\u914d\u51fa20\u500bIP\u4f4d\u5740\uff0c\u800c\u8981\u70ba\u958b\u767c\u90e8\u9580\u5206\u914d\u51fa100\u500bIP\u4f4d\u5740\uff0c\u5247\u6b64\u6642\u8b8a\u6210\u6703\u4f7f\u7528\u5230\u5169\u500b\u5b50\u7db2\u8def\uff0c\u800c\u6bcf\u500b\u5b50\u7db2\u8def\u7684\u7db2\u8def\u906e\u7f69\u90fd\u662f255.255.255.0\uff0c\u4e5f\u5c31\u662f\u6bcf\u500b\u5b50\u7db2\u8def\u90fd\u53ef\u4ee5\u5206\u914d254\u500bIP\u4f4d\u5740\u3002\u9019\u6a23\u7684\u8a71\uff0c\u5c31\u5df2\u7d93\u6d6a\u8cbb\u6389(254-20)+(254-100)\u500bIP\u4f4d\u5740\u3002\u5982\u679c\u5927\u5bb6\u90fd\u9019\u6a23\u4f7f\u7528\uff0c\u90a3\u9084\u5f97\u4e86\uff1f\u5c31\u56e0\u70ba\u5982\u6b64\uff0c\u624d\u6709\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u51fa\u73fe\u3002 \u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69 \uff08Variable-Length Subnet Mask\uff0cVLSM\uff09\u662f\u7528\u4f86\u8b93\u4e0d\u540c\u9577\u5ea6\u3001\u4e0d\u540c\u985e\u5225\uff08Class\uff09\u7684\u5b50\u7db2\u8def\u80fd\u5728\u540c\u4e00\u500b\u7db2\u8def\u5167\u5b58\u5728\u4e26\u4e14\u904b\u4f5c\u3002\u6240\u4ee5\uff0c\u4e5f\u5c31\u662f\u8aaa\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u80fd\u5920\u8b93\u7db2\u8def\u5167\u7684IP\u4f4d\u5740\u5206\u914d\u66f4\u52a0\u5f48\u6027\u5316\uff0c\u4e5f\u53ef\u4ee5\u8b93\u53ef\u7528\u7684IP\u4f4d\u5740\u500b\u6578\u589e\u52a0\u3002","title":"CIDR \u91cd\u9ede1\uff1a\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69"},{"location":"networking/cidr/cidr-intro/#_2","text":"\u8209\u4f8b\u4f86\u8aaa\u660e\u5982\u4f55\u8a08\u7b97\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u53ef\u80fd\u6703\u6bd4\u8f03\u5bb9\u6613\u4e86\u89e3\u3002\u5047\u8a2d\u6709\u4e00\u500b\u5b50\u7db2\u8def\u662f\uff1a \u800c\u73fe\u5728\u60f3\u5206\u5272\u4e00\u500b\u5b50\u7db2\u8def\u662f\u53ef\u4ee5\u5bb9\u7d0d10\u53f0\u6a5f\u5668\u6240\u4f7f\u7528\uff0c\u4e5f\u5c31\u662f\u8981\u80fd\u5920\u5206\u914d10\u500bIP\u4f4d\u5740\u3002\u800c\u7531\u4e00\u958b\u59cb\u5c0d\u7db2\u8def\u906e\u7f69\u7684\u4ecb\u7d39\uff0c\u61c9\u8a72\u5c31\u80fd\u5920\u7b97\u51fa172.16.32.0/20\u7e3d\u5171\u53ef\u4ee5\u5206\u914d\u51fa\u7684IP\u4f4d\u5740\u500b\u6578\u70ba\uff1a \u5982\u679c\u76f4\u63a5\u628a172.16.32.0/20\u9019\u500b\u5b50\u7db2\u8def\u62ff\u4f86\u7d66\u901910\u500bIP\u4f4d\u5740\u4f7f\u7528\uff0c\u5be6\u5728\u662f\u592a\u6d6a\u8cbb\uff0c\u56e0\u70ba\u53ea\u6703\u752810\u500bIP\u4f4d\u5740\uff0c\u5176\u4ed64,084\u500bIP\u4f4d\u5740\u90fd\u6c92\u6709\u4f7f\u7528\u5230\u3002 \u82e5\u662f\u4f7f\u7528\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u5247\u80fd\u5920\u628a172.16.32.0/20\u5b50\u7db2\u8def\u5206\u5272\u6210172.16.32.0/28\uff0c\u5982\u6b64\u4e00\u4f86\uff0c\u5c07\u5f97\u5230\u4e0b\u5217\u9019\u4e9b\u5b50\u7db2\u8def\uff1a \u9019\u88e1\u628a\u4f4d\u5740\u7684\u6700\u5f8c\u5169\u500b\u6578\u5b57\u7528\u4e8c\u9032\u4f4d\u8868\u793a\uff0c\u9019\u6a23\u6bd4\u8f03\u5bb9\u6613\u8a08\u7b97\uff0c\u5176\u4e2d\uff0c172.16\u7684\u90e8\u5206\u7b97\u662f\u7db2\u8def\u4f4d\u5740\uff0c172.16.0010\u9019\u4e9b\u90e8\u5206\u7b97\u662f\u5b50\u7db2\u8def\u7684\u90e8\u5206\uff0c\u800c172.16.00100000.0001\u5c31\u5df2\u7d93\u7d50\u5408\u4e86\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u81f3\u65bc\u6700\u5f8c\u56db\u500b\u4f4d\u5143\uff0c\u5247\u662f\u7528\u4f86\u5206\u914dIP\u4f4d\u5740\u7d66\u4e3b\u6a5f\u7528\u3002 \u6240\u4ee5\uff0c\u9019\u6a23\u5206\u914d\u4e4b\u5f8c\uff0c172.16.32.0/20\u4e00\u5171\u53ef\u4ee5\u5206\u6210256\u500b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\uff0c256\u7684\u8a08\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a \u800c\u6bcf\u4e00\u500b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u7686\u53ef\u5206\u914d14\u500bIP\u4f4d\u5740\uff0c\u5176\u8a08\u7b97\u65b9\u5f0f\u5982\u4e0b\uff1a \u525b\u597d\u7b26\u5408\u539f\u672c\u7684\u9700\u6c42\uff1a\u300c\u5206\u5272\u5b50\u7db2\u8def\u4f86\u5206\u914d10\u500bIP\u4f4d\u5740\u300d\u3002\u9019\u6a23\u5206\u5272\u4e4b\u5f8c\uff0c\u53ea\u6703\u6d6a\u8cbb4\u500bIP\u4f4d\u5740\uff0c\u8207\u539f\u672c\u6703\u6d6a\u8cbb\u56db\u5343\u591a\u500bIP\u4f4d\u5740\u6bd4\u8f03\u8d77\u4f86\uff0c\u771f\u7684\u662f\u5dee\u592a\u591a\u4e86\u3002","title":"\u8a08\u7b97\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u65b9\u5f0f"},{"location":"networking/cidr/cidr-intro/#ip_3","text":"\u73fe\u5728\uff0c\u7528\u53e6\u4e00\u500b\u4f8b\u5b50\u8aaa\u660e\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u5982\u4f55\u8b93\u7db2\u8def\u7ba1\u7406\u4eba\u54e1\u66f4\u6709\u6548\u5730\u898f\u5283IP\u4f4d\u5740\u3002\u5047\u8a2d\u73fe\u5728\u5206\u914d\u5230\u7684\u7db2\u6bb5\u662f\uff1a \u6253\u7b97\u5206\u914d\u7d66\u56db\u500b\u4e0d\u540c\u7684\u90e8\u9580\uff0c\u6bcf\u500b\u90e8\u9580\u90fd\u6709\u81ea\u5df1\u7684\u7db2\u6bb5\uff0c\u4e14\u6bcf\u500b\u90e8\u9580\u7684IP\u4f4d\u5740\u500b\u6578\u898155\u500b\u3002\u6bcf\u500b\u90e8\u9580\u5fc5\u9808\u6709\u4e00\u500b\u8def\u7531\u5668\u8ca0\u8cac\u9023\u63a5\u5230\u516c\u53f8\u8981\u9023\u5230\u5916\u90e8WAN\u7db2\u8def\u7684\u8def\u7531\u5668\u4e0a\uff0c\u9019\u4e4b\u9593\u7684IP\u4f4d\u5740\u4e5f\u5fc5\u9808\u5728\u898f\u5283\u4e4b\u4e2d\u3002 \u9996\u5148\uff0c\u5927\u7565\u601d\u8003\u4e00\u4e0b\u53ef\u80fd\u7684\u7db2\u8def\u67b6\u69cb\u5716\u61c9\u8a72\u662f\u5982\u4f55\u3002\u56e0\u70ba\u8981\u5206\u914d\u56db\u500b\u7db2\u6bb5\uff0c\u800c\u6bcf\u500b\u7db2\u6bb5\u6703\u6709\u4e00\u500b\u8def\u7531\u5668\u5fc5\u9808\u9023\u63a5\u5230\u516c\u53f8\u8981\u9023\u5230\u5916\u90e8WAN\u7db2\u8def\u7684\u8def\u7531\u5668\u4e0a\uff08\u9019\u662f\u7576\u7136\u7684\uff0c\u4e0d\u7136\u9019\u4e9b\u90e8\u9580\u7684\u6a5f\u5668\u5c31\u7121\u6cd5\u9023\u51fa\u7db2\u8def\uff09\uff0c\u56e0\u6b64\u7db2\u8def\u67b6\u69cb\u5716\u61c9\u8a72\u5982\u57161\u6240\u793a\u3002 \u800c\u5404\u7db2\u6bb5\u7684IP\u4f4d\u5740\u90fd\u9084\u6c92\u6709\u586b\u4e0a\u53bb\uff0c\u9019\u5c31\u662f\u73fe\u5728\u8981\u505a\u7684\u5de5\u4f5c\u3002\u5728\u9019\u88e1\uff0c\u6240\u8981\u898f\u5283\u7684IP\u4f4d\u5740\u90e8\u5206\u5305\u542b\uff1a \u7531\u65bc\u77e5\u9053\u6bcf\u500b\u90e8\u9580\u90fd\u8981\u898f\u528355\u500bIP\u4f4d\u5740\uff0c\u6240\u4ee5\u4e0b\u4e00\u500b\u6b65\u9a5f\u5c31\u662f\u6c7a\u5b9a\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u8981\u7528\u591a\u5c11\u3002\u88681\u6574\u7406\u51fa\u5e38\u7528\u4e4b\u4e0d\u540c\u7684\u906e\u7f69\u9577\u5ea6\u8207\u6240\u80fd\u5206\u914d\u7684IP\u4f4d\u5740\u500b\u6578\u4e00\u89bd\u8868\uff0c\u53ef\u4ee5\u76f4\u63a5\u67e5\u627e\u3002 \u88681 \u4e0d\u540c\u7684\u906e\u7f69\u9577\u5ea6\u8207\u6240\u80fd\u5206\u914d\u7684IP\u4f4d\u5740\u500b\u6578 \u5f9e\u9019\u88e1\u53ef\u4ee5\u770b\u51fa\uff0c\u7db2\u8def\u906e\u7f69\u9577\u5ea6\u4e0d\u80fd\u8d85\u904e30\u500b\uff0c\u56e0\u70ba\u81f3\u5c11\u8981\u4fdd\u7559\u7db2\u8def\u4f4d\u5740\u53ca\u5ee3\u64ad\u4f4d\u5740\uff0c\u800c\u9084\u8981\u80fd\u5920\u5206\u914dIP\u4f4d\u5740\u7684\u8a71\uff0c\u7db2\u8def\u906e\u7f69\u6700\u591a\u53ea\u80fd\u523030\u500b\u4f4d\u6578\u3002\u7531\u65bc\u6253\u7b97\u80fd\u5920\u5206\u914d55\u500bIP\u4f4d\u5740\uff0c\u6240\u4ee5\u7531\u4e0a\u9762\u9019\u500b\u8868\u683c\u53ef\u4ee5\u770b\u51fa\uff0c\u81f3\u5c11\u5fc5\u9808\u4f7f\u752826\u500b\u4f4d\u5143\u7576\u4f5c\u7db2\u8def\u906e\u7f69\u3002 \u7531\u65bc\u6240\u5206\u914d\u5230\u7684\u7db2\u6bb5\u662f\uff1a \u6240\u4ee5\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\u5f8c\u5373\u70ba\uff1a \u9019\u88e1\u7a0d\u5fae\u5077\u61f6\u4e00\u4e0b\uff0c\u53ea\u628a\u5f8c\u9762\u768432.0\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\u3002\u800c\u7c97\u9ad4\u986f\u793a\u7684\u5730\u65b9\u662f\u5c6c\u65bc\u7db2\u8def\u4f4d\u5740\u7684\u90e8\u5206\uff0c\u5728\u9019\u88e1\u898f\u5283\u6642\u7121\u6cd5\u8b8a\u66f4\u3002\u800c\u525b\u525b\u4e5f\u8a08\u7b97\u51fa\u4f86\u6240\u8981\u4f7f\u7528\u7684\u7db2\u8def\u906e\u7f69\u500b\u6578\u662f26\uff0c\u6240\u4ee5\u53ef\u4ee5\u628a\u6240\u80fd\u7372\u5f97\u7684\u7b2c\u4e00\u500b\u7db2\u6bb5\u5206\u914d\u7d66\u90e8\u95801\uff0c\u4e5f\u5c31\u662f\uff1a \u90a3\u7b2c\u4e8c\u6bb5\u8981\u600e\u9ebc\u8a08\u7b97\u5462\uff1f\u7531\u65bc\u77e5\u9053\u525b\u525b\u5206\u914d\u7684\u906e\u7f69\u6578\u76ee\u662f26\uff0c\u56e0\u6b64\u91cd\u65b0\u770b\u4e00\u4e0b\u525b\u525b\u6240\u5206\u914d\u7684\u5b50\u7db2\u8def\u906e\u7f69\uff1a \u9019\u88e1\u628a\u5c6c\u65bc172.16.32.0/26\u7db2\u6bb5\u7684\u5b50\u7db2\u8def\uff08Subnet\uff09\u90e8\u5206\u6a19\u793a\u5e95\u7dda\uff0c\u5c31\u6703\u6bd4\u8f03\u660e\u767d\uff0c\u56e0\u6b64\u53ef\u4ee5\u770b\u51fa\uff0c\u7c97\u9ad4\u800c\u4e14\u5177\u6709\u5e95\u7dda\u7684\u90e8\u5206\u5c31\u662f\u539f\u672c\u7684\u5b50\u7db2\u8def\u90e8\u5206\uff0c\u800c\u6c92\u6709\u7c97\u9ad4\u4f46\u6709\u5e95\u7dda\u7684\u662fVLSM\u7684\u5b50\u7db2\u8def\u90e8\u5206\u3002\u73fe\u5728\u7531\u65bc\u8981\u8a08\u7b97\u4e0b\u4e00\u500b\u7db2\u6bb5\u7684\u4f4d\u5740\uff0c\u6240\u4ee5\u80fd\u52d5\u7684\u662f\u6a19\u793a\u5e95\u7dda\u7684\u90e8\u5206\uff0c\u56e0\u6b64\u4e0b\u4e00\u500b\u8981\u7d66\u90e8\u95802\u7684\u5b50\u7db2\u8def\u61c9\u8a72\u662f\uff1a \u800c\u8981\u7d66\u90e8\u95803\u7684\u5b50\u7db2\u8def\u662f\uff1a \u540c\u7406\uff0c\u6700\u5f8c\u8981\u7d66\u90e8\u95804\u7684\u5b50\u7db2\u8def\u5247\u662f\uff1a \u73fe\u5728\uff0c\u628a\u9019\u4e9b\u5df2\u7d93\u5206\u914d\u597d\u7684\u5b50\u7db2\u8def\u586b\u5230\u525b\u525b\u7684\u7db2\u8def\u67b6\u69cb\u5716\u4e2d\uff0c\u5982\u57162\u6240\u793a\u3002 \u63a5\u4e0b\u4f86\uff0c\u5c07\u8981\u5206\u914d\u8def\u7531\u5668A\u3001B\u3001C\u3001D\u4ee5\u53ca\u8def\u7531\u5668S\u4e4b\u9593\u7684IP\u4f4d\u5740\u3002\u525b\u525b\u5206\u914d\u5b8c\u56db\u500b\u90e8\u5206\u5f8c\uff0c172.16.32.0/24\u90fd\u4e0d\u80fd\u4f7f\u7528\u4e86\u3002\u6240\u4ee5\uff0c\u63a5\u4e0b\u4f86\u53ef\u5206\u914d\u7684\u7b2c\u4e00\u7d44\u5b50\u7db2\u8def\u53ef\u4ee5\u662f\uff1a \u518d\u4f86\uff0c\u770b\u770b\u906e\u7f69\u6578\u76ee\u61c9\u8a72\u8981\u591a\u5c11\u3002\u5047\u8a2d\u8981\u5148\u5206\u914d\u7d66\u8def\u7531\u5668A\u548c\u8def\u7531\u5668S\u4e4b\u9593\uff0c\u5247\u56e0\u70ba\u53ea\u9700\u8981\u5206\u914d\u5169\u500bIP\u4f4d\u5740\uff0c\u4e00\u500b\u7d66\u8def\u7531\u5668A\u671d\u5411\u8def\u7531\u5668S\u7684\u4ecb\u9762\uff0c\u53e6\u4e00\u500bIP\u4f4d\u5740\u5247\u5206\u914d\u7d66\u8def\u7531\u5668S\u671d\u5411\u8def\u7531\u5668A\u7684\u4ecb\u9762\u3002 \u56e0\u6b64\uff0c\u81f3\u5c11\u8981\u4f7f\u7528\u7684\u906e\u7f69\u662f30\uff0c\u6240\u4ee5\u53ef\u4ee5\u5f97\u77e5\u8981\u5206\u914d\u7684\u5b50\u7db2\u8def\u662f\uff1a \u540c\u6a23\u5730\uff0c\u8def\u7531\u5668B\u548c\u8def\u7531\u5668S\u4e4b\u9593\u7684\u5b50\u7db2\u8def\u5c31\u662f\u4e0b\u4e00\u6bb5\u5b50\u7db2\u8def\u4f4d\u5740\uff1a \u800c\u8def\u7531\u5668C\u548c\u8def\u7531\u5668S\u4e4b\u9593\u7684\u5b50\u7db2\u8def\u5c31\u662f\u4e0b\u4e00\u6bb5\u5b50\u7db2\u8def\u4f4d\u5740\uff1a \u8def\u7531\u5668D\u548c\u8def\u7531\u5668S\u4e4b\u9593\u7684\u5b50\u7db2\u8def\u5c31\u662f\u4e0b\u4e00\u6bb5\u5b50\u7db2\u8def\u4f4d\u5740\uff1a \u73fe\u5728\uff0c\u628a\u9019\u4e9b\u5b50\u7db2\u8def\u8cc7\u8a0a\u52a0\u5230\u525b\u525b\u7684\u7db2\u8def\u67b6\u69cb\u5716\u4e2d\uff0c\u5c31\u5b8c\u6210\u4e86\u6574\u500bIP\u4f4d\u5740\u5206\u914d\uff0c\u5982\u57163\u6240\u793a\u3002 \u5927\u529f\u544a\u6210\uff01\u5230\u9019\u88e1\uff0c\u76f8\u4fe1\u5927\u5bb6\u5df2\u7d93\u4e86\u89e3\u5230\u9019\u500b\u6280\u8853\u7684\u5a01\u529b\u4e86\u3002","title":"IP\u4f4d\u5740\u5206\u914d\u7684\u61c9\u7528\u7bc4\u4f8b"},{"location":"networking/cidr/cidr-intro/#cidr-2","text":"\u8def\u7531\u532f\u7e3d\u5c31\u662fRoute Summarization\uff0c\u53c8\u7a31\u70baRoute Aggregation\u6216\u662fSuper-netting\u3002\u4e3b\u8981\u76ee\u7684\u5c31\u662f\u5728\u65bc\u5c07\u591a\u7b46\u8def\u7531\u8cc7\u8a0a\u532f\u7e3d\u800c\u6210\u6bd4\u8f03\u7c21\u55ae\u7684\u55ae\u7b46\u8def\u7531\u8cc7\u8a0a\u3002 \u5982\u679c\u7528\u5be6\u969b\u751f\u6d3b\u7684\u7bc4\u4f8b\u4f86\u89e3\u91cb\u7684\u8a71\uff0c\u53ef\u4ee5\u9019\u6a23\u601d\u8003\uff1a\u628a\u4fe1\u4ef6\u60f3\u6210\u662f\u7db2\u8def\u5c01\u5305\uff0c\u5730\u5740\u5c31\u662fIP\u4f4d\u5740\uff0c\u8def\u7531\u7576\u7136\u5c31\u662f\u5404\u500b\u90f5\u5dee\u5982\u4f55\u53bb\u904b\u9001\u9019\u4e9b\u4fe1\u4ef6\u7684\u65b9\u5f0f\u3002\u70ba\u4e86\u9054\u5230\u5f88\u597d\u7684\u6548\u7387\uff0c\u56e0\u6b64\u7522\u751f\u73fe\u5728\u9019\u6a23\u7684\u5730\u5740\u8a2d\u8a08\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u53f0\u5317\u5e02\u5206\u6210\u5404\u500b\u5340\uff0c\u6709\u5927\u5b89\u5340\u3001\u4e2d\u6b63\u5340\u3001\u4fe1\u7fa9\u5340\u7b49\u7b49\uff0c\u6240\u4ee5\u7576\u90f5\u5dee\u9084\u6c92\u6709\u770b\u5230\u8a73\u7d30\u7684\u5730\u5740\u4e4b\u524d\uff0c\u53ef\u4ee5\u5148\u6839\u64da\u5927\u5340\u57df\u5148\u5206\u985e\uff0c\u7136\u5f8c\u518d\u7531\u5404\u500b\u5340\u57df\u7684\u90f5\u5dee\u53bb\u7d30\u90e8\u904b\u9001\u3002\u540c\u6a23\u5730\uff0c\u7576\u5176\u4ed6\u7e23\u5e02\u90f5\u5c40\u770b\u5230\u662f\u9001\u5f80\u53f0\u5317\u5e02\u7684\u4fe1\u4ef6\uff0c\u4e5f\u4e0d\u7528\u770b\u7d30\u90e8\u7684\u5730\u5740\u751a\u81f3\u65bc\u5340\u57df\uff0c\u76f4\u63a5\u5148\u9001\u5f80\u53f0\u5317\u5e02\u8ca0\u8cac\u7684\u90f5\u5c40\uff08\u5047\u8a2d\u6709\u4e00\u500b\u53f0\u5317\u5e02\u90f5\u5c40\u5148\u8655\u7406\u5168\u90e8\u9001\u5f80\u53f0\u5317\u5e02\u7684\u6240\u6709\u4fe1\u4ef6\uff09\uff0c\u9019\u6a23\u7684\u8a2d\u8a08\u6703\u8b8a\u5f97\u5f88\u6709\u6548\u7387\u3002\u8def\u7531\u532f\u7e3d\u7684\u8a2d\u8a08\u539f\u7406\u8ddf\u9019\u7bc4\u4f8b\u662f\u985e\u4f3c\u7684\u3002 \u63a5\u8457\u4f86\u770b\u770b\u57164\u9019\u500b\u4f8b\u5b50\uff0c\u4e5f\u8a31\u5927\u5bb6\u6703\u6bd4\u8f03\u5bb9\u6613\u4e86\u89e3\u8def\u7531\u532f\u7e3d\u7684\u7528\u9014\u548c\u597d\u8655\u5728\u54ea\u88e1\u3002 \u5728\u57164\u7684\u7db2\u8def\u67b6\u69cb\u5716\u4e2d\uff0c\u8def\u7531\u5668X\u9023\u63a5\u8457\u5169\u500b\u5b50\u7db2\u8def\uff0c\u5206\u5225\u662f172.16.32.0/24\u548c172.16.128.0/24\uff0c\u5982\u679c\u6c92\u6709\u8def\u7531\u532f\u7e3d\uff0c\u5247\u8def\u7531\u5668X\u5fc5\u9808\u628a\u9019\u5169\u500b\u5b50\u7db2\u8def \u4e2d\u7684\u8def\u7531\u8cc7\u8a0a\u5168\u90e8\u50b3\u9001\u7d66\u8def\u7531\u5668Y\uff0c\u5982\u6b64\u4e00\u4f86\uff0c\u4e00\u65e6\u9019\u5169\u500b\u5b50\u7db2\u8def\u4e2d\u6709\u4efb\u4f55\u7684\u6539\u8b8a\uff0c\u5247\u8def\u7531\u5668X\u90fd\u5fc5\u9808\u50b3\u9001\u76f8\u5c0d\u61c9\u7684\u8def\u7531\u8cc7\u8a0a\u7d66\u8def\u7531\u5668Y\uff0c\u9019\u6a23\u4e0d\u50c5\u589e\u52a0\u592a\u591a\u7db2\u8def\u8ca0\u64d4\uff0c\u8981\u7dad\u8b77\u9019\u4e9b\u8cc7\u6599\u4e5f\u662f\u76f8\u7576\u9ebb\u7169\u7684\u4e8b\u60c5\u3002 \u5982\u679c\u518d\u4ed4\u7d30\u770b\u4e00\u4e0b\u9019\u500b\u7db2\u8def\u67b6\u69cb\u5716\uff0c\u53ef\u4ee5\u767c\u73fe\u5c0d\u65bc\u8def\u7531\u5668Y\u800c\u8a00\uff0c\u76f8\u7576\u65bc\u300c\u8def\u7531\u5668X\u77e5\u9053\u5982\u4f55\u9001\u5230172.16.0.0/16\u9019\u6a23\u7684\u7db2\u8def\u5340\u6bb5\u300d\u3002\u6240\u4ee5\uff0c\u4ee5\u5f8c\u4e00\u65e6\u8def\u7531\u5668Y\u6536\u5230\u76f8\u7576\u65bc\u50b3\u9001\u7d66172.16.0.0/16\u9019\u6a23\u7684\u76ee\u7684\u5730\uff0c\u5c31\u53ef\u4ee5\u76f4\u63a5\u628a\u9019\u6a23\u7684\u5c01\u5305\u50b3\u9001\u7d66\u8def\u7531\u5668X\uff0c\u56e0\u70ba\u5b83\u77e5\u9053\u600e\u9ebc\u50b3\u9001\u3002\u628a172.16.32.0/24\u548c172.16.128.0/24\u9019\u5169\u500b\u5b50\u7db2\u8def\u8def\u7531\u8cc7\u8a0a\u7d50\u5408\u6210\u4e00\u7b46172.16.0.0/16\u7684\u8def\u7531\uff0c\u5c31\u662f\u8def\u7531\u532f\u7e3d\u7684\u529f\u80fd\u3002 Classless\u7684\u8def\u7531\u5354\u5b9a\uff08\u50cf\u662fRIPv2\u3001OSPF\u3001IS-IS\u4ee5\u53caEIGRP\u8def\u7531\u5354\u5b9a\u7b49\u7b49\uff09\u90fd\u6709\u652f\u63f4\u8def\u7531\u532f\u7e3d\uff0c\u7576\u7136\u4e5f\u652f\u63f4VLSM\uff0c\u800cClassful\u7684\u8def\u7531\u5354\u5b9a\uff08\u4f8b\u5982RIPv1\u548cIGRP\u8def\u7531\u5354\u5b9a\uff09\u5247\u6c92\u6709\u652f\u63f4\u8def\u7531\u532f\u7e3d\uff0c\u56e0\u70ba\u5df2\u7d93\u81ea\u52d5\u505a\u4e86\u76f8\u5c0d\u61c9\u7684\u532f\u7e3d\u52d5\u4f5c\u3002 \u8def\u7531\u532f\u7e3d\u7684\u8a73\u7d30\u8cc7\u8a0a\u8207\u904b\u4f5c\u65b9\u5f0f\uff0c\u90fd\u88ab\u5b9a\u7fa9\u5728RFC 1518\u4e4b\u4e2d\uff08An Architecture for IP Address Allocation with CIDR\uff09\uff0c\u53ef\u524d\u5f80\u67e5\u770b\u4e26\u7814\u8b80\u3002","title":"CIDR \u91cd\u9ede2\uff1a\u8def\u7531\u532f\u7e3d"},{"location":"networking/cidr/cidr-intro/#_3","text":"\u4e86\u89e3\u8def\u7531\u532f\u7e3d\u7684\u76ee\u7684\u8207\u904b\u4f5c\u65b9\u5f0f\u4e4b\u5f8c\uff0c\u61c9\u8a72\u5c31\u5df2\u7d93\u5927\u7565\u660e\u767d\u5982\u4f55\u8a08\u7b97\u8def\u7531\u532f\u7e3d\u7684\u8cc7\u6599\u3002\u4e0d\u904e\uff0c\u4e0b\u9762\u9084\u662f\u7528\u4f8b\u5b50\u4f86\u8aaa\u660e\u4e00\u4e0b\u3002\u5047\u8a2d\u6709\u500b\u8def\u7531\u5668\u6536\u5230\u4ee5\u4e0b\u9019\u4e9b\u5b50\u7db2\u8def\u7684\u8def\u7531\u8cc7\u8a0a\u66f4\u65b0\uff1a \u90a3\u9ebc\u8def\u7531\u532f\u7e3d\u4e4b\u5f8c\u7684\u8cc7\u6599\u61c9\u8a72\u662f\u5982\u4f55\u5462\uff1f\u9996\u5148\u628a\u9019\u4e9b\u8cc7\u6599\u8f49\u6210\u4e8c\u9032\u4f4d\uff1a \u8f49\u63db\u4e4b\u5f8c\uff0c\u5f88\u5bb9\u6613\u5c31\u53ef\u4ee5\u767c\u73fe\uff0c\u524d\u9762\u7c97\u9ad4\u5b57\u90e8\u5206\u5728\u9019\u516b\u500b\u5b50\u7db2\u8def\u7576\u4e2d\u90fd\u662f\u4e00\u6a23\u7684\uff0c\u6240\u4ee5\u9019\u4e9b\u76f8\u540c\u7684\u90e8\u5206\u5c31\u662f\u8def\u7531\u532f\u7e3d\u4e4b\u5f8c\u7684\u7d50\u679c\uff0c\u4e5f\u5c31\u662f\uff1a \u56e0\u70ba\u76f8\u540c\u7684\u90e8\u5206\u670921\u500b\u6578\u5b57\uff0c\u6240\u4ee5\u906e\u7f69\u5c31\u662f21\u3002\u56e0\u6b64\uff0c\u6700\u5f8c\u8def\u7531\u532f\u7e3d\u7684\u7d50\u679c\u5c31\u662f\uff1a \u73fe\u5728\uff0c\u61c9\u8a72\u4e5f\u80fd\u5b8c\u5168\u4e86\u89e3\u8def\u7531\u532f\u7e3d\u4e86\u3002\u63a5\u8457\uff0c\u4f86\u770b\u770b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u4e0b\u7684\u8def\u7531\u532f\u7e3d\u53c8\u662f\u5982\u4f55\u3002","title":"\u8def\u7531\u532f\u7e3d\u7684\u8a08\u7b97\u65b9\u5f0f"},{"location":"networking/cidr/cidr-intro/#_4","text":"\u4ee5\u57165\u7684\u7db2\u8def\u67b6\u69cb\u5716\u70ba\u4f8b\uff0c\u70ba\u5927\u5bb6\u8aaa\u660e\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u8def\u7531\u532f\u7e3d\u53c8\u662f\u5982\u4f55\u8a08\u7b97\u7684\u3002 \u5047\u8a2d\u8def\u7531\u5668E\u3001F\u4ee5\u53ca\u8def\u7531\u5668H\u6703\u628a\u8def\u7531\u8cc7\u8a0a\u50b3\u9001\u7d66\u8def\u7531\u5668G\uff0c\u7136\u5f8c\u8def\u7531\u5668G\u6703\u628a\u8def\u7531\u8cc7\u8a0a\u50b3\u9001\u7d66\u8def\u7531\u5668Z\uff0c\u9019\u88e1\u53ef\u4ee5\u767c\u73fe\uff0c\u8def\u7531\u5668E\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def\u906e\u7f69\u662f26\uff0c\u800c\u8def\u7531\u5668F\u548c\u8def\u7531\u5668H\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def\u906e\u7f69\u662f20\uff0c\u56e0\u6b64\u9019\u500b\u7db2\u8def\u67b6\u69cb\u662f\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u3002 \u5e95\u4e0b\u4f86\u770b\u770b\u5982\u4f55\u5728\u9019\u500b\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u74b0\u5883\u4e2d\u505a\u5230\u8def\u7531\u532f\u7e3d\u3002\u9996\u5148\uff0c\u532f\u7e3d\u8def\u7531\u5668E\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def\uff0c\u82e5\u5c07\u8def\u7531\u5668E\u6240\u9023\u63a5\u7684\u5b50\u7db2\u8def172.16.32.64/26\u548c172.16.32.128/26\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\uff0c\u5247\u5982\u4e0b\u5217\u6240\u793a\uff1a \u53ef\u4ee5\u767c\u73fe\u532f\u7e3d\u8d77\u4f86\u7684\u7d50\u679c\u662f\uff1a \u6240\u4ee5\uff0c\u8def\u7531\u5668E\u50b3\u9001\u7d66\u8def\u7531\u5668G\u7684\u8def\u7531\u532f\u7e3d\u8cc7\u6599\u662f172.16.32.0/24\u3002\u56e0\u6b64\uff0c\u8def\u7531\u5668G\u6703\u6536\u5230\u7684\u8def\u7531\u8cc7\u6599\u6709\uff1a 172.16.128.0/20 172.16.32.0/24 172.16.64.0/20 \u82e5\u5c07\u9019\u4e9b\u8cc7\u6599\u8f49\u63db\u6210\u4e8c\u9032\u4f4d\uff0c\u5247\u5982\u4e0b\u5217\u6240\u793a\uff1a \u5373\u4f7f\u9019\u4e09\u7b46\u8def\u7531\u8cc7\u6599\u5404\u4f7f\u7528\u4e0d\u540c\u7684\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u4f46\u5f9e\u4e0a\u9762\u7684\u4e8c\u9032\u4f4d\u8868\u793a\u6cd5\u4e2d\u53ef\u4ee5\u5f88\u6e05\u695a\u5730\u767c\u73fe\uff0c\u76f8\u540c\u4e4b\u8655\u53ea\u6709\u6700\u524d\u9762\u7684\u90e8\u5206\uff0c\u5982\u4e0b\u6240\u793a\uff1a \u800c\u5f8c\u9762\u90fd\u5b8c\u5168\u4e0d\u540c\uff0c\u6240\u4ee5\u9019\u4e09\u7b46\u8def\u7531\u8cc7\u6599\u7d93\u904e\u8def\u7531\u532f\u7e3d\u4e4b\u5f8c\u7684\u7d50\u679c\u61c9\u8a72\u662f\uff1a \u770b\u5230\u9019\u88e1\uff0c\u60f3\u5fc5\u5927\u5bb6\u61c9\u8a72\u90fd\u5df2\u7d93\u5b8c\u5168\u660e\u767d\u5728\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u74b0\u5883\u4e2d\u5982\u4f55\u505a\u5230\u8def\u7531\u532f\u7e3d\u4e86\u3002","title":"\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u7684\u8def\u7531\u532f\u7e3d"},{"location":"networking/cidr/cidr-intro/#_5","text":"\u5f9e\u9019\u4e9b\u4ecb\u7d39\u53ef\u4ee5\u767c\u73fe\u8def\u7531\u532f\u7e3d\u6709\u4ee5\u4e0b\u9019\u4e9b\u597d\u8655\uff1a \u6709\u6548\u5730\u6e1b\u5c11\u8def\u7531\u66f4\u65b0\u7684\u983b\u7387 \u6e1b\u5c11\u4e0d\u5fc5\u8981\u7684\u7db2\u8def\u6d41\u91cf \u6e1b\u5c11\u8def\u7531\u8868\u6240\u4f54\u64da\u7684\u8a18\u61b6\u9ad4\u4f7f\u7528\u91cf \u4f46\u662f\uff0c\u5728\u4f7f\u7528\u8def\u7531\u532f\u7e3d\u7684\u540c\u6642\uff0c\u4ee5\u4e0b\u9019\u4e9b\u56e0\u7d20\u4e5f\u662f\u7db2\u8def\u7ba1\u7406\u4eba\u54e1\u6240\u5fc5\u9808\u8003\u91cf\u7684\uff1a \u6240\u6709\u4e0d\u540c\u7684IP\u4f4d\u5740\u90fd\u5fc5\u9808\u64c1\u6709\u4e00\u5b9a\u7a0b\u5ea6\u7684\u76f8\u540c\u4e4b \u4f4d\u5143\u3002\u9019\u88e1\u6240\u6307\u7684\u76f8\u540c\u7684\u4f4d\u5143\uff0c\u7576\u7136\u90fd\u5fc5\u9808\u662f\u5f9e\u5de6\u908a\u8003\u91cf\u904e\u4f86\uff0c\u4e5f\u5c31\u662f\u6240\u8b02\u7684Highest Order Bits\u3002 \u8def\u7531\u7684\u6c7a\u5b9a\u5fc5\u9808\u53d6\u6c7a\u65bc\u6574\u500b\u5b8c\u6574\u7684\u4f4d\u5740\uff0c\u4e5f\u5c31\u662f\u6574 \u500b32\u4f4d\u5143\u7684\u4f4d\u5740\u3002 \u8def\u7531\u5354\u5b9a\u5fc5\u9808\u50b3\u9001\u5b50\u7db2\u8def\u906e\u7f69\u7684\u9577\u5ea6\u8cc7\u8a0a\u3002","title":"\u8a2d\u8a08\u8def\u7531\u532f\u7e3d\u6240\u5fc5\u9808\u8003\u616e\u7684\u56e0\u7d20"},{"location":"networking/cidr/cidr-intro/#cidr_1","text":"\u7531\u4e0a\u9762\u7684\u4f8b\u5b50\u8207\u5404\u7a2e\u6280\u8853\u7684\u8aaa\u660e\uff0c\u53ef\u4ee5\u770b\u51faCIDR\u7684\u80fd\u529b\u8207\u4f7f\u7528\u7684\u65b9\u6cd5\uff0c\u56e0\u6b64\u4ee5\u4e0b\u53ef\u4ee5\u6b78\u7d0d\u51fa\u5e7e\u500bCIDR\u7684\u512a\u9ede\uff1a 1. \u66f4\u6709\u6548\u5730\u4f7f\u7528IP\u4f4d\u5740 \u5f9e\u4e0a\u9762\u7684\u7bc4\u4f8b\u5c31\u53ef\u4ee5\u770b\u51fa\u4f86\uff0c\u5206\u5272\u5b50\u7db2\u8def\u6642\uff0c\u6240\u53ef\u80fd\u6d6a\u8cbb\u7684IP\u4f4d\u5740\u6578\u91cf\u53ef\u85c9\u7531\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u800c\u5927\u91cf\u5730\u6e1b\u5c11\u3002 2. \u53ef\u9054\u5230\u66f4\u597d\u7684\u8def\u7531\u532f\u7e3d\u529f\u80fd \u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\u8b93IP\u5206\u914d\u66f4\u6709\u968e\u5c64\u5f0f\u67b6\u69cb\u7684\u611f\u89ba\uff0c\u4f46\u53c8\u4e0d\u53d7\u9650\u65bc\u539f\u672c\u7684\u985e\u5225\u5206\u5272\u65b9\u5f0f\u3002\u8209\u525b\u525b\u7684\u4f8b\u5b50\u4f86\u8aaa\uff0c\u539f\u672c\u5b50\u7db2\u8def\u7684\u90e8\u5206\u70ba172.16.32.0/20\uff0c\u4f46\u662f\u900f\u904e\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u906e\u7f69\uff0c\u53ef\u4ee5\u518d\u6b21\u5206\u6210172.16.32.0/28\u3001172.16.32.32/28\u7b49\u7b49\u7684\u5b50\u7db2\u8def\u3002 \u56e0\u6b64\uff0c\u591a\u8b8a\u9577\u5ea6\u5b50\u7db2\u8def\u7b49\u65bc\u662f\u5f9e\u539f\u672c\u7684\u5b50\u7db2\u8def\u518d\u6b21\u5207\u5272\u51fa\u4f86\uff0c\u800c\u9019\u7a2e\u60c5\u6cc1\u5728\u8def\u7531\u8868\u683c\u4e2d\u53ef\u4ee5\u9054\u5230\u66f4\u597d\u7684\u8def\u7531\u532f\u7e3d\u529f\u80fd\uff08Route Summarization\uff09\u3002 3. \u80fd\u6709\u6548\u6e1b\u5c11\u5176\u4ed6\u8def\u7531\u5668\u7684\u8def\u7531\u66f4\u65b0\u6b21\u6578 \u5982\u679c\u8def\u7531\u532f\u7e3d\u529f\u80fd\u88ab\u4f7f\u7528\u5728\u5927\u578b\u6216\u662f\u6bd4\u8f03\u8907\u96dc\u7684\u7db2\u8def\u67b6\u69cb\u4e2d\uff0c\u5247\u5728\u67d0\u500b\u5b50\u7db2\u8def\u5e95\u4e0b\u7684\u67d0\u7db2\u8def\u9023\u7d50\u6709\u72c0\u6cc1\u4e0a\u7684\u6539\u8b8a\uff0c\u4e5f\u4e0d\u6703\u5f71\u97ff\u5176\u4ed6\u7db2\u6bb5\u7684\u8def\u7531\u5668\u3002 \u8209\u4f8b\u4f86\u8aaa\uff0c\u5047\u8a2d\u5728172.16.32.0/28\u4e2d\u6709\u500b\u7db2\u8def\u9023\u7dda\u4e0d\u7a69\u5b9a\uff0c\u9023\u7dda\u6642\u597d\u6642\u58de\uff0c\u5247\u56e0\u70ba\u6709\u4f7f\u7528\u8def\u7531\u532f\u7e3d\u529f\u80fd\uff0c\u6240\u4ee5\u5c0d\u5176\u4ed6\u7db2\u6bb5\u7684\u8def\u7531\u5668\u800c\u8a00\uff0c\u6839\u672c\u4e0d\u7528\u8003\u616e\u5230\u5982\u6b64\u8a73\u76e1\u7684\u8cc7\u6599\uff0c\u4e5f\u5c31\u662f\u8aaa\uff0c\u5176\u4ed6\u8def\u7531\u5668\u4e26\u4e0d\u9700\u8981\u505a\u76f8\u5c0d\u983b\u7e41\u7684\u8def\u7531\u8cc7\u6599\u66f4\u65b0\u52d5\u4f5c\u3002","title":"CIDR\u7684\u512a\u52e2\u6240\u5728"},{"location":"networking/cidr/cidr-intro/#_6","text":"\u5176\u5be6\u7c21\u55ae\u4f86\u8aaa\uff0cCIDR\u7d9c\u5408\u4e86\u4ee5\u4e0a\u63d0\u5230\u7684\u6280\u8853\uff0c\u9019\u4e9b\u90fd\u662f\u5f9eRFC 1518\u548c1519\u7b49\u6587\u4ef6\u958b\u59cb\u8a18\u9304\u9019\u4e9b\u6539\u9032\u5f8c\u7684\u8a2d\u8a08\u3002\u9019\u88e1\u6574\u7406\u51fa\u5e7e\u500bCIDR\u7684\u5b97\u65e8\uff1a \u7db2\u8def\u906e\u7f69\u53ef\u4ee5\u6307\u5b9a\u4efb\u610f\u9577\u5ea6\uff0c\u4e5f\u5c31\u662f\u63a1\u7528\u591a\u8b8a\u9577\u5ea6 \u5b50\u7db2\u8def\u906e\u7f69\u7684\u6280\u8853\u3002 \u5229\u7528\u8def\u7531\u532f\u7e3d\u7684\u65b9\u5f0f\uff0c\u4f7f\u5f97\u7db2\u8def\u8def\u7531\u7a0b\u5e8f\u7c21\u55ae\u5316\uff0c \u4e0d\u9700\u8981\u5206\u7d1a\u3002 \u6253\u7834\u539f\u672c\u985e\u5225\u7684\u898f\u7bc4\uff0c\u53ef\u4ee5\u4f9d\u64da\u771f\u6b63\u7684\u9700\u6c42\u4f86\u898f\u5283 IP\u4f4d\u5740\u5206\u914d\u3002 \u5230\u9019\u88e1\u70ba\u6b62\uff0c\u76f8\u4fe1\u5404\u4f4d\u5df2\u7d93\u660e\u767d\u6240\u8b02\u7684CIDR\uff08Classless Inter-Domain Routing\uff09\u662f\u5982\u4f55\u904b\u4f5c\u7684\uff0c\u5305\u542b\u9019\u9805\u6280\u8853\u7684\u8a2d\u8a08\u7de3\u7531\u3001\u8a2d\u8a08\u65b9\u5f0f\u4ee5\u53ca\u904b\u4f5c\u539f\u7406\u7b49\u7b49\uff0c\u5e0c\u671b\u80fd\u5920\u8b93\u5927\u5bb6\u4e86\u89e3\u5982\u4f55\u66f4\u6709\u6548\u5730\u898f\u5283\u4f01\u696d\u7684\u7db2\u8def\u3002","title":"\u7d50\u8a9e"},{"location":"prometheus/alertmanager/alertmanager/","text":"","title":"Alertmanager"},{"location":"prometheus/prometheus/install/","text":"\u5b89\u88dd\u914d\u7f6e \u00b6 \u539f\u6587: \u5b89\u88c5\u914d\u7f6e \u4e0b\u8f09 Prometheus \u00b6 Prometheus \u662f\u63a1\u7528 Go \u8a9e\u8a00\u958b\u767c\u7684\uff0c\u76f4\u63a5\u4f7f\u7528\u7368\u7acb\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u5373\u53ef\u90e8\u7f72\u3002\u4e0b\u9762\u6211\u5011\u5c31\u5728\u4e00\u53f0 Linux \u6a5f\u5668\u4e0a\u4f86\u4e0b\u8f09 Prometheus\u3002 \u9996\u5148\u70ba\u6211\u5011\u7684\u8ab2\u7a0b\u5275\u5efa\u4e00\u500b\u5de5\u4f5c\u76ee\u9304\uff1a mkdir $HOME /training \u5207\u63db\u5230\u8a72\u76ee\u9304\u4e0b\u53bb\uff1a cd $HOME /training \u5728 Prometheus \u5b98\u7db2 https://prometheus.io/download/#prometheus \u7372\u53d6\u9069\u7528\u65bc Linux \u7684 Prometheus \u5b89\u88dd\u5305\uff0c\u9019\u88e1\u6211\u5011\u9078\u64c7\u6700\u65b0\u7684 2.38.0 \u7248\u672c\uff0c\u6211\u5011\u9019\u88e1\u662f Linux \u7cfb\u7d71\uff0c\u6240\u4ee5\u9078\u64c7\u4e0b\u8f09 prometheus-2.38.0.linux-amd64.tar.gz \uff0c\u5176\u4ed6\u7cfb\u7d71\u8acb\u81ea\u884c\u9078\u64c7\u3002 wget https://github.com/prometheus/prometheus/releases/download/v2.38.0/prometheus-2.38.0.linux-amd64.tar.gz \u89e3\u58d3\u58d3\u7e2e\u5305\uff1a tar -xvf prometheus-2.38.0.linux-amd64.tar.gz \u5207\u63db\u5230\u89e3\u58d3\u7e2e\u5f8c\u7684\u76ee\u9304\uff0c\u57f7\u884c prometheus --version \u547d\u4ee4\u67e5\u770b\u662f\u5426\u6b63\u5e38\uff1a $ cd prometheus-2.38.0.linux-amd64 $ ./prometheus --version prometheus, version 2 .38.0 ( branch: HEAD, revision: 818d6e60888b2a3ea363aee8a9828c7bafd73699 ) build user: root@e6b781f65453 build date: 20220816 -13:23:14 go version: go1.18.5 platform: linux/amd64 \u914d\u7f6e Prometheus \u00b6 \u524d\u6587\u6211\u5011\u5df2\u7d93\u4e0b\u8f09\u5b8c\u6210\u4e86 Prometheus\uff0c\u63a5\u4e0b\u4f86\u5728\u555f\u52d5\u4e4b\u524d\u6211\u5011\u9700\u8981\u70ba\u5176\u5275\u5efa\u4e00\u500b\u914d\u7f6e\u6587\u4ef6\u3002 Prometheus \u901a\u904e\u6293\u53d6\u76e3\u63a7\u76ee\u6a19\u4e0a\u7684 HTTP \u7aef\u9ede\u4f86\u6536\u96c6\u6307\u6a19\uff0c\u800c\u4e14 Prometheus \u672c\u8eab\u4e5f\u66b4\u9732 metrics \u6307\u6a19\u63a5\u53e3\uff0c\u6240\u4ee5\u81ea\u7136\u5b83\u4e5f\u53ef\u4ee5\u6293\u53d6\u4e26\u76e3\u63a7\u5176\u81ea\u8eab\u7684\u904b\u884c\u72c0\u6cc1\uff0c\u4e0b\u9762\u6211\u5011\u5c31\u7528\u6536\u96c6\u81ea\u8eab\u7684\u6578\u64da\u70ba\u4f8b\u9032\u884c\u914d\u7f6e\u8aaa\u660e\u3002 \u5c07\u4ee5\u4e0b Prometheus \u914d\u7f6e\u4fdd\u5b58\u70ba prometheus.yml \u6587\u4ef6\uff08\u8986\u84cb\u73fe\u6709\u793a\u4f8b\u7684 prometheus.yml \u6587\u4ef6\uff09\uff1a prometheus.yml global : scrape_interval : 5s # \u6293\u53d6\u9891\u7387 scrape_configs : - job_name : \"prometheus\" static_configs : - targets : [ \"localhost:9090\" ] \u4e0a\u9762\u914d\u7f6e\u4e86 Prometheus \u6bcf 5s \u5f9e\u81ea\u8eab\u6293\u53d6\u6307\u6a19\u3002 global \u5340\u57df\u7528\u65bc\u914d\u7f6e\u4e00\u4e9b\u5168\u5c40\u914d\u7f6e\u548c\u9ed8\u8a8d\u503c\uff0c scrape_configs \u90e8\u5206\u662f\u7528\u4f86\u544a\u8a34 Prometheus \u8981\u6293\u53d6\u54ea\u4e9b\u76ee\u6a19\u7684\u3002 \u5728\u6211\u5011\u9019\u88e1\u4f7f\u7528 static_configs \u5c6c\u6027\u624b\u52d5\u5217\u8209\u4e86\u6293\u53d6\u7684\u76ee\u6a19\uff08\u4ee5 <host>:<port> \u683c\u5f0f\uff09\uff0c\u4e0d\u904e\u4e00\u822c\u751f\u7522\u74b0\u5883\u914d\u7f6e\u4f7f\u7528\u4e00\u500b\u6216\u591a\u500b \u670d\u52d9\u767c\u73fe \u4f86\u767c\u73fe\u76ee\u6a19\uff0c\u5b8c\u6574\u7684\u914d\u7f6e\u53ef\u4ee5\u53c3\u8003 \u5b98\u65b9\u6587\u6a94 \uff0c\u5f8c\u7e8c\u6211\u5011\u4e5f\u6703\u4e0d\u65b7\u63a5\u89f8\u76f8\u95dc\u7684\u914d\u7f6e\u3002 Info \u6ce8\u610f\uff1a5 \u79d2\u9418\u7684\u6293\u53d6\u9593\u9694\u662f\u975e\u5e38\u6fc0\u9032\u7684\uff0c\u4f46\u5c0d\u65bc\u6211\u5011\u9019\u88e1\u7684\u6f14\u793a\u76ee\u7684\u4f86\u8aaa\u9084\u662f\u975e\u5e38\u6709\u7528\u7684\uff0c\u56e0\u70ba\u6211\u5011\u5e0c\u671b\u53ef\u4ee5\u5feb\u901f\u7372\u5f97\u6578\u64da\u3002\u5728\u5be6\u969b\u60c5\u6cc1\u4e0b\uff0c\u9593\u9694\u901a\u5e38\u5728 10 \u5230 60 \u79d2\u4e4b\u9593\u3002 \u555f\u52d5 \u00b6 \u73fe\u5728\u6211\u5011\u4f7f\u7528\u65b0\u5275\u5efa\u7684\u914d\u7f6e\u6587\u4ef6\u555f\u52d5 Prometheus\uff1a ./prometheus \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPrometheus \u5c07\u5176\u6578\u64da\u5eab\u5b58\u5132\u5728 ./data \u76ee\u9304\u4e2d\uff08\u53ef\u4ee5\u4f7f\u7528 --storage.tsdb.path \u6a19\u8a8c\u9032\u884c\u914d\u7f6e\uff09\uff0c\u4e26\u5f9e\u6587\u4ef6 prometheus.yml \uff08\u4f7f\u7528 - -config.file \u914d\u7f6e\uff09\u4e2d\u8b80\u53d6\u5176\u914d\u7f6e\u3002 Info \u6ce8\u610f\uff1a\u901a\u904e\u914d\u7f6e\u6587\u4ef6\u63d0\u4f9b\u7684\u4efb\u4f55\u8a2d\u7f6e\u90fd\u53ef\u4ee5\u5728\u904b\u884c\u6642\uff08\u901a\u904e\u767c\u9001 HUP \u4fe1\u865f\uff09\u91cd\u65b0\u52a0\u8f09\uff0c\u800c\u901a\u904e\u6a19\u8a8c\u8a2d\u7f6e\u7684\u4efb\u4f55\u8b8a\u66f4\u90fd\u9700\u8981\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u5668\u624d\u80fd\u751f\u6548\u3002 \u6b63\u5e38\u60c5\u6cc1\u4e0b Prometheus \u6703\u555f\u52d5\u4e26\u5728 http://<host-ip>:9090/ \u4e0a\u986f\u793a\u76f8\u95dc\u72c0\u614b\u4fe1\u606f\uff0c\u5e7e\u79d2\u9418\u904e\u5f8c\u6703\u5f9e\u5176\u81ea\u8eab\u7684 HTTP \u6307\u6a19\u7aef\u9ede\u6536\u96c6\u95dc\u65bc\u81ea\u5df1\u7684\u6578\u64da\uff0c\u6211\u5011\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5728\u700f\u89bd\u5668\u4e2d\u8a2a\u554f\u5b83\u7684\u6307\u6a19\u7aef\u9ede\u4f86\u9a57\u8b49 Prometheus \u662f\u5426\u6b63\u5728\u63d0\u4f9b\u95dc\u65bc\u81ea\u5df1\u7684\u6307\u6a19\uff1a http://<host-ip>:9090/metrics \u3002 \u67e5\u770b\u76e3\u63a7\u76ee\u6a19 \u00b6 \u7576\u555f\u52d5 Prometheus \u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u6aa2\u67e5\u4e0b\u5b83\u662f\u5426\u6b63\u78ba\u7684\u6293\u53d6\u4e86\u914d\u7f6e\u7684\u76ee\u6a19\uff0c\u53ef\u4ee5\u5728\u700f\u89bd\u5668\u4e2d\u8a2a\u554f http://<host-ip>:9090/targets \u4f86\u67e5\u770b\u6240\u6709\u7684\u6293\u53d6\u76ee\u6a19\u5217\u8868\uff1a \u5982\u679c\u6211\u5011\u914d\u7f6e\u7684\u6293\u53d6\u672c\u8eab\u7684 prometheus \u9019\u500b\u4efb\u52d9\u986f\u793a\u7684\u7da0\u8272\u7684 UP \u72c0\u614b\uff0c\u8b49\u660e Prometheus \u5df2\u7d93\u6b63\u5e38\u6293\u53d6\u81ea\u8eab\u7684\u76e3\u63a7\u6307\u6a19\u4e86\u3002 \u5982\u679c\u5728\u6293\u53d6\u904e\u7a0b\u4e2d\u51fa\u73fe\u4efb\u4f55\u554f\u984c\uff08DNS \u89e3\u6790\u5931\u6557\u3001\u9023\u63a5\u8d85\u6642\u7b49\u7b49\u932f\u8aa4\uff09\uff0c\u6293\u53d6\u76ee\u6a19\u90fd\u6703\u986f\u793a\u70ba DOWN \uff0c\u540c\u6642\u9084\u6709\u4e00\u689d\u932f\u8aa4\u6d88\u606f\uff0c\u63d0\u4f9b\u6709\u95dc\u6293\u53d6\u5931\u6557\u7684\u76f8\u95dc\u4fe1\u606f\uff0c\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u5feb\u901f\u767c\u73fe\u932f\u8aa4\u914d\u7f6e\u6216\u4e0d\u5065\u5eb7\u7684\u76ee\u6a19\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u4f60\u5c07 Prometheus \u914d\u7f6e\u5728\u932f\u8aa4\u7684\u7aef\u53e3\u4e0a\u9032\u884c\u6293\u53d6\uff089091 \u800c\u4e0d\u662f 9090\uff09\uff0ctargets \u76ee\u6a19\u9801\u9762\u5c07\u986f\u793a connection refused \u932f\u8aa4\u3002 \u8868\u9054\u5f0f\u67e5\u8a62 \u00b6 Prometheus \u5167\u7f6e\u4e86\u7528\u65bc PromQL \u67e5\u8a62\u7684\u8868\u9054\u5f0f\u67e5\u8a62\u754c\u9762\uff0c\u700f\u89bd\u5668\u4e2d\u5c0e\u822a\u81f3 http://<host-ip>:9090/graph \u4e26\u9078\u64c7 Table \u8996\u5716\u5373\u53ef\uff1a Table \u9078\u9805\u5361\u986f\u793a\u4e86\u8868\u9054\u5f0f\u7684\u6bcf\u500b\u8f38\u51fa\u5e8f\u5217\u7684\u6700\u65b0\u503c\uff0c\u800c Graph \u9078\u9805\u5361\u662f\u7e6a\u88fd\u96a8\u6642\u9593\u8b8a\u5316\u7684\u503c\uff0c\u7576\u7136\u6703\u5728\u5716\u5f62\u5c0d\u65bc\u670d\u52d9\u7aef\u548c\u700f\u89bd\u5668\u4f86\u8aaa\u662f\u6bd4\u8f03\u8017\u6027\u80fd\u7684\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u6cc1\u90fd\u662f\u5148\u5728 Table \u4e0b\u5617\u8a66\u67e5\u8a62\u53ef\u80fd\u6bd4\u8f03\u8017\u6642\u7684\u8868\u9054\u5f0f\uff0c\u7136\u5f8c\u5c07\u8868\u9054\u5f0f\u7684\u67e5\u8a62\u6642\u9593\u7bc4\u570d\u7e2e\u5c0f\uff0c\u518d\u5207\u63db\u5230 Graph \u4e0b\u9762\u9032\u884c\u5716\u5f62\u7e6a\u88fd\u662f\u4e00\u500b\u66f4\u597d\u7684\u505a\u6cd5\u3002 \u65b0\u7248\u672c\u7684 Prometheus\uff0c\u9084\u5c0d\u67e5\u8a62\u529f\u80fd\u505a\u4e86\u5927\u5e45\u5ea6\u7684\u5347\u7d1a\uff0c\u65b0\u589e\u4e86\u4e00\u500b\u975e\u5e38\u5be6\u7528\u7684\u529f\u80fd\u5c31\u662f\u6709\u67e5\u8a62\u95dc\u9375\u5b57\u76f8\u95dc\u7684\u63d0\u793a\u4e86\u3002 \u9019\u88e1\u7684\u63d0\u793a\u529f\u80fd\u4e0d\u53ea\u662f\u6709\u6307\u6a19\u540d\u7a31\uff0c\u9084\u6709\u67e5\u8a62\u8a9e\u53e5\u4e2d\u4f7f\u7528\u5230\u7684\u67e5\u8a62\u51fd\u6578\uff0c\u4e5f\u5305\u62ec\u9019\u500b\u51fd\u6578\u7684\u7528\u6cd5\u63d0\u793a\u7b49\u4fe1\u606f\uff0c\u53ef\u4ee5\u8aaa\u9019\u500b\u529f\u80fd\u975e\u5e38\u5be6\u7528\u3002 \u6bd4\u5982\u6211\u5011\u9019\u88e1\u53ef\u4ee5\u67e5\u8a62\u4e0b\u9762\u7684\u6307\u6a19\uff0c\u8868\u793a\u81ea\u9032\u7a0b\u958b\u59cb\u4ee5\u4f86\u88ab\u6349\u53d6\u5165 Prometheus \u672c\u5730\u5b58\u5132\u4e2d\u7684\u6a23\u672c\u7e3d\u6578\uff1a prometheus_tsdb_head_samples_appended_total \u7136\u5f8c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4e86\u67e5\u8a62 1 \u5206\u9418\u5167\u5e73\u5747\u6bcf\u79d2\u651d\u53d6\u7684\u6a23\u672c\u6578\uff1a rate ( prometheus_tsdb_head_samples_appended_total [ 1m ] ) \u6211\u5011\u53ef\u4ee5\u5728 Table \u548c Graph \u8996\u5716\u4e0b\u9762\u5207\u63db\u67e5\u770b\u8868\u9054\u5f0f\u67e5\u8a62\u7684\u7d50\u679c\u3002","title":"Prometheus \u5b89\u88dd\u914d\u7f6e"},{"location":"prometheus/prometheus/install/#_1","text":"\u539f\u6587: \u5b89\u88c5\u914d\u7f6e","title":"\u5b89\u88dd\u914d\u7f6e"},{"location":"prometheus/prometheus/install/#prometheus","text":"Prometheus \u662f\u63a1\u7528 Go \u8a9e\u8a00\u958b\u767c\u7684\uff0c\u76f4\u63a5\u4f7f\u7528\u7368\u7acb\u7684\u4e8c\u9032\u88fd\u6587\u4ef6\u5373\u53ef\u90e8\u7f72\u3002\u4e0b\u9762\u6211\u5011\u5c31\u5728\u4e00\u53f0 Linux \u6a5f\u5668\u4e0a\u4f86\u4e0b\u8f09 Prometheus\u3002 \u9996\u5148\u70ba\u6211\u5011\u7684\u8ab2\u7a0b\u5275\u5efa\u4e00\u500b\u5de5\u4f5c\u76ee\u9304\uff1a mkdir $HOME /training \u5207\u63db\u5230\u8a72\u76ee\u9304\u4e0b\u53bb\uff1a cd $HOME /training \u5728 Prometheus \u5b98\u7db2 https://prometheus.io/download/#prometheus \u7372\u53d6\u9069\u7528\u65bc Linux \u7684 Prometheus \u5b89\u88dd\u5305\uff0c\u9019\u88e1\u6211\u5011\u9078\u64c7\u6700\u65b0\u7684 2.38.0 \u7248\u672c\uff0c\u6211\u5011\u9019\u88e1\u662f Linux \u7cfb\u7d71\uff0c\u6240\u4ee5\u9078\u64c7\u4e0b\u8f09 prometheus-2.38.0.linux-amd64.tar.gz \uff0c\u5176\u4ed6\u7cfb\u7d71\u8acb\u81ea\u884c\u9078\u64c7\u3002 wget https://github.com/prometheus/prometheus/releases/download/v2.38.0/prometheus-2.38.0.linux-amd64.tar.gz \u89e3\u58d3\u58d3\u7e2e\u5305\uff1a tar -xvf prometheus-2.38.0.linux-amd64.tar.gz \u5207\u63db\u5230\u89e3\u58d3\u7e2e\u5f8c\u7684\u76ee\u9304\uff0c\u57f7\u884c prometheus --version \u547d\u4ee4\u67e5\u770b\u662f\u5426\u6b63\u5e38\uff1a $ cd prometheus-2.38.0.linux-amd64 $ ./prometheus --version prometheus, version 2 .38.0 ( branch: HEAD, revision: 818d6e60888b2a3ea363aee8a9828c7bafd73699 ) build user: root@e6b781f65453 build date: 20220816 -13:23:14 go version: go1.18.5 platform: linux/amd64","title":"\u4e0b\u8f09 Prometheus"},{"location":"prometheus/prometheus/install/#prometheus_1","text":"\u524d\u6587\u6211\u5011\u5df2\u7d93\u4e0b\u8f09\u5b8c\u6210\u4e86 Prometheus\uff0c\u63a5\u4e0b\u4f86\u5728\u555f\u52d5\u4e4b\u524d\u6211\u5011\u9700\u8981\u70ba\u5176\u5275\u5efa\u4e00\u500b\u914d\u7f6e\u6587\u4ef6\u3002 Prometheus \u901a\u904e\u6293\u53d6\u76e3\u63a7\u76ee\u6a19\u4e0a\u7684 HTTP \u7aef\u9ede\u4f86\u6536\u96c6\u6307\u6a19\uff0c\u800c\u4e14 Prometheus \u672c\u8eab\u4e5f\u66b4\u9732 metrics \u6307\u6a19\u63a5\u53e3\uff0c\u6240\u4ee5\u81ea\u7136\u5b83\u4e5f\u53ef\u4ee5\u6293\u53d6\u4e26\u76e3\u63a7\u5176\u81ea\u8eab\u7684\u904b\u884c\u72c0\u6cc1\uff0c\u4e0b\u9762\u6211\u5011\u5c31\u7528\u6536\u96c6\u81ea\u8eab\u7684\u6578\u64da\u70ba\u4f8b\u9032\u884c\u914d\u7f6e\u8aaa\u660e\u3002 \u5c07\u4ee5\u4e0b Prometheus \u914d\u7f6e\u4fdd\u5b58\u70ba prometheus.yml \u6587\u4ef6\uff08\u8986\u84cb\u73fe\u6709\u793a\u4f8b\u7684 prometheus.yml \u6587\u4ef6\uff09\uff1a prometheus.yml global : scrape_interval : 5s # \u6293\u53d6\u9891\u7387 scrape_configs : - job_name : \"prometheus\" static_configs : - targets : [ \"localhost:9090\" ] \u4e0a\u9762\u914d\u7f6e\u4e86 Prometheus \u6bcf 5s \u5f9e\u81ea\u8eab\u6293\u53d6\u6307\u6a19\u3002 global \u5340\u57df\u7528\u65bc\u914d\u7f6e\u4e00\u4e9b\u5168\u5c40\u914d\u7f6e\u548c\u9ed8\u8a8d\u503c\uff0c scrape_configs \u90e8\u5206\u662f\u7528\u4f86\u544a\u8a34 Prometheus \u8981\u6293\u53d6\u54ea\u4e9b\u76ee\u6a19\u7684\u3002 \u5728\u6211\u5011\u9019\u88e1\u4f7f\u7528 static_configs \u5c6c\u6027\u624b\u52d5\u5217\u8209\u4e86\u6293\u53d6\u7684\u76ee\u6a19\uff08\u4ee5 <host>:<port> \u683c\u5f0f\uff09\uff0c\u4e0d\u904e\u4e00\u822c\u751f\u7522\u74b0\u5883\u914d\u7f6e\u4f7f\u7528\u4e00\u500b\u6216\u591a\u500b \u670d\u52d9\u767c\u73fe \u4f86\u767c\u73fe\u76ee\u6a19\uff0c\u5b8c\u6574\u7684\u914d\u7f6e\u53ef\u4ee5\u53c3\u8003 \u5b98\u65b9\u6587\u6a94 \uff0c\u5f8c\u7e8c\u6211\u5011\u4e5f\u6703\u4e0d\u65b7\u63a5\u89f8\u76f8\u95dc\u7684\u914d\u7f6e\u3002 Info \u6ce8\u610f\uff1a5 \u79d2\u9418\u7684\u6293\u53d6\u9593\u9694\u662f\u975e\u5e38\u6fc0\u9032\u7684\uff0c\u4f46\u5c0d\u65bc\u6211\u5011\u9019\u88e1\u7684\u6f14\u793a\u76ee\u7684\u4f86\u8aaa\u9084\u662f\u975e\u5e38\u6709\u7528\u7684\uff0c\u56e0\u70ba\u6211\u5011\u5e0c\u671b\u53ef\u4ee5\u5feb\u901f\u7372\u5f97\u6578\u64da\u3002\u5728\u5be6\u969b\u60c5\u6cc1\u4e0b\uff0c\u9593\u9694\u901a\u5e38\u5728 10 \u5230 60 \u79d2\u4e4b\u9593\u3002","title":"\u914d\u7f6e Prometheus"},{"location":"prometheus/prometheus/install/#_2","text":"\u73fe\u5728\u6211\u5011\u4f7f\u7528\u65b0\u5275\u5efa\u7684\u914d\u7f6e\u6587\u4ef6\u555f\u52d5 Prometheus\uff1a ./prometheus \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cPrometheus \u5c07\u5176\u6578\u64da\u5eab\u5b58\u5132\u5728 ./data \u76ee\u9304\u4e2d\uff08\u53ef\u4ee5\u4f7f\u7528 --storage.tsdb.path \u6a19\u8a8c\u9032\u884c\u914d\u7f6e\uff09\uff0c\u4e26\u5f9e\u6587\u4ef6 prometheus.yml \uff08\u4f7f\u7528 - -config.file \u914d\u7f6e\uff09\u4e2d\u8b80\u53d6\u5176\u914d\u7f6e\u3002 Info \u6ce8\u610f\uff1a\u901a\u904e\u914d\u7f6e\u6587\u4ef6\u63d0\u4f9b\u7684\u4efb\u4f55\u8a2d\u7f6e\u90fd\u53ef\u4ee5\u5728\u904b\u884c\u6642\uff08\u901a\u904e\u767c\u9001 HUP \u4fe1\u865f\uff09\u91cd\u65b0\u52a0\u8f09\uff0c\u800c\u901a\u904e\u6a19\u8a8c\u8a2d\u7f6e\u7684\u4efb\u4f55\u8b8a\u66f4\u90fd\u9700\u8981\u91cd\u65b0\u555f\u52d5\u670d\u52d9\u5668\u624d\u80fd\u751f\u6548\u3002 \u6b63\u5e38\u60c5\u6cc1\u4e0b Prometheus \u6703\u555f\u52d5\u4e26\u5728 http://<host-ip>:9090/ \u4e0a\u986f\u793a\u76f8\u95dc\u72c0\u614b\u4fe1\u606f\uff0c\u5e7e\u79d2\u9418\u904e\u5f8c\u6703\u5f9e\u5176\u81ea\u8eab\u7684 HTTP \u6307\u6a19\u7aef\u9ede\u6536\u96c6\u95dc\u65bc\u81ea\u5df1\u7684\u6578\u64da\uff0c\u6211\u5011\u4e5f\u53ef\u4ee5\u76f4\u63a5\u5728\u700f\u89bd\u5668\u4e2d\u8a2a\u554f\u5b83\u7684\u6307\u6a19\u7aef\u9ede\u4f86\u9a57\u8b49 Prometheus \u662f\u5426\u6b63\u5728\u63d0\u4f9b\u95dc\u65bc\u81ea\u5df1\u7684\u6307\u6a19\uff1a http://<host-ip>:9090/metrics \u3002","title":"\u555f\u52d5"},{"location":"prometheus/prometheus/install/#_3","text":"\u7576\u555f\u52d5 Prometheus \u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u6aa2\u67e5\u4e0b\u5b83\u662f\u5426\u6b63\u78ba\u7684\u6293\u53d6\u4e86\u914d\u7f6e\u7684\u76ee\u6a19\uff0c\u53ef\u4ee5\u5728\u700f\u89bd\u5668\u4e2d\u8a2a\u554f http://<host-ip>:9090/targets \u4f86\u67e5\u770b\u6240\u6709\u7684\u6293\u53d6\u76ee\u6a19\u5217\u8868\uff1a \u5982\u679c\u6211\u5011\u914d\u7f6e\u7684\u6293\u53d6\u672c\u8eab\u7684 prometheus \u9019\u500b\u4efb\u52d9\u986f\u793a\u7684\u7da0\u8272\u7684 UP \u72c0\u614b\uff0c\u8b49\u660e Prometheus \u5df2\u7d93\u6b63\u5e38\u6293\u53d6\u81ea\u8eab\u7684\u76e3\u63a7\u6307\u6a19\u4e86\u3002 \u5982\u679c\u5728\u6293\u53d6\u904e\u7a0b\u4e2d\u51fa\u73fe\u4efb\u4f55\u554f\u984c\uff08DNS \u89e3\u6790\u5931\u6557\u3001\u9023\u63a5\u8d85\u6642\u7b49\u7b49\u932f\u8aa4\uff09\uff0c\u6293\u53d6\u76ee\u6a19\u90fd\u6703\u986f\u793a\u70ba DOWN \uff0c\u540c\u6642\u9084\u6709\u4e00\u689d\u932f\u8aa4\u6d88\u606f\uff0c\u63d0\u4f9b\u6709\u95dc\u6293\u53d6\u5931\u6557\u7684\u76f8\u95dc\u4fe1\u606f\uff0c\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u5feb\u901f\u767c\u73fe\u932f\u8aa4\u914d\u7f6e\u6216\u4e0d\u5065\u5eb7\u7684\u76ee\u6a19\u3002 \u4f8b\u5982\uff0c\u5982\u679c\u4f60\u5c07 Prometheus \u914d\u7f6e\u5728\u932f\u8aa4\u7684\u7aef\u53e3\u4e0a\u9032\u884c\u6293\u53d6\uff089091 \u800c\u4e0d\u662f 9090\uff09\uff0ctargets \u76ee\u6a19\u9801\u9762\u5c07\u986f\u793a connection refused \u932f\u8aa4\u3002","title":"\u67e5\u770b\u76e3\u63a7\u76ee\u6a19"},{"location":"prometheus/prometheus/install/#_4","text":"Prometheus \u5167\u7f6e\u4e86\u7528\u65bc PromQL \u67e5\u8a62\u7684\u8868\u9054\u5f0f\u67e5\u8a62\u754c\u9762\uff0c\u700f\u89bd\u5668\u4e2d\u5c0e\u822a\u81f3 http://<host-ip>:9090/graph \u4e26\u9078\u64c7 Table \u8996\u5716\u5373\u53ef\uff1a Table \u9078\u9805\u5361\u986f\u793a\u4e86\u8868\u9054\u5f0f\u7684\u6bcf\u500b\u8f38\u51fa\u5e8f\u5217\u7684\u6700\u65b0\u503c\uff0c\u800c Graph \u9078\u9805\u5361\u662f\u7e6a\u88fd\u96a8\u6642\u9593\u8b8a\u5316\u7684\u503c\uff0c\u7576\u7136\u6703\u5728\u5716\u5f62\u5c0d\u65bc\u670d\u52d9\u7aef\u548c\u700f\u89bd\u5668\u4f86\u8aaa\u662f\u6bd4\u8f03\u8017\u6027\u80fd\u7684\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u6cc1\u90fd\u662f\u5148\u5728 Table \u4e0b\u5617\u8a66\u67e5\u8a62\u53ef\u80fd\u6bd4\u8f03\u8017\u6642\u7684\u8868\u9054\u5f0f\uff0c\u7136\u5f8c\u5c07\u8868\u9054\u5f0f\u7684\u67e5\u8a62\u6642\u9593\u7bc4\u570d\u7e2e\u5c0f\uff0c\u518d\u5207\u63db\u5230 Graph \u4e0b\u9762\u9032\u884c\u5716\u5f62\u7e6a\u88fd\u662f\u4e00\u500b\u66f4\u597d\u7684\u505a\u6cd5\u3002 \u65b0\u7248\u672c\u7684 Prometheus\uff0c\u9084\u5c0d\u67e5\u8a62\u529f\u80fd\u505a\u4e86\u5927\u5e45\u5ea6\u7684\u5347\u7d1a\uff0c\u65b0\u589e\u4e86\u4e00\u500b\u975e\u5e38\u5be6\u7528\u7684\u529f\u80fd\u5c31\u662f\u6709\u67e5\u8a62\u95dc\u9375\u5b57\u76f8\u95dc\u7684\u63d0\u793a\u4e86\u3002 \u9019\u88e1\u7684\u63d0\u793a\u529f\u80fd\u4e0d\u53ea\u662f\u6709\u6307\u6a19\u540d\u7a31\uff0c\u9084\u6709\u67e5\u8a62\u8a9e\u53e5\u4e2d\u4f7f\u7528\u5230\u7684\u67e5\u8a62\u51fd\u6578\uff0c\u4e5f\u5305\u62ec\u9019\u500b\u51fd\u6578\u7684\u7528\u6cd5\u63d0\u793a\u7b49\u4fe1\u606f\uff0c\u53ef\u4ee5\u8aaa\u9019\u500b\u529f\u80fd\u975e\u5e38\u5be6\u7528\u3002 \u6bd4\u5982\u6211\u5011\u9019\u88e1\u53ef\u4ee5\u67e5\u8a62\u4e0b\u9762\u7684\u6307\u6a19\uff0c\u8868\u793a\u81ea\u9032\u7a0b\u958b\u59cb\u4ee5\u4f86\u88ab\u6349\u53d6\u5165 Prometheus \u672c\u5730\u5b58\u5132\u4e2d\u7684\u6a23\u672c\u7e3d\u6578\uff1a prometheus_tsdb_head_samples_appended_total \u7136\u5f8c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4e86\u67e5\u8a62 1 \u5206\u9418\u5167\u5e73\u5747\u6bcf\u79d2\u651d\u53d6\u7684\u6a23\u672c\u6578\uff1a rate ( prometheus_tsdb_head_samples_appended_total [ 1m ] ) \u6211\u5011\u53ef\u4ee5\u5728 Table \u548c Graph \u8996\u5716\u4e0b\u9762\u5207\u63db\u67e5\u770b\u8868\u9054\u5f0f\u67e5\u8a62\u7684\u7d50\u679c\u3002","title":"\u8868\u9054\u5f0f\u67e5\u8a62"},{"location":"prometheus/prometheus/overview/","text":"Prometheus \u7c21\u4ecb \u00b6 \u539f\u6587: https://training.promlabs.com/training/introduction-to-prometheus/training-overview/introduction \u672c\u57f9\u8a13\u6559\u60a8\u57fa\u65bc Prometheus \u7684\u76e3\u63a7\u7684\u7d55\u5c0d\u57fa\u790e\u77e5\u8b58\uff0c\u6db5\u84cb\u67b6\u69cb\u6982\u8ff0\u4ee5\u53ca Prometheus \u7684\u4e3b\u8981\u529f\u80fd\u3002\u4f5c\u70ba\u672c\u57f9\u8a13\u7684\u4e00\u90e8\u5206\uff0c\u60a8\u9084\u5c07\u4e0b\u8f09\u3001\u914d\u7f6e\u548c\u904b\u884c\u57fa\u672c\u7684 Prometheus \u8a2d\u7f6e\u3002 \u5728\u672c\u6b21\u57f9\u8a13\u4e4b\u5f8c\uff0c\u60a8\u5c07\u80fd\u5920\u63cf\u8ff0 Prometheus \u5982\u4f55\u878d\u5165\u76e3\u63a7\u74b0\u5883\u4e26\u4ee5\u57fa\u672c\u65b9\u5f0f\u8a2d\u7f6e Prometheus\u3002 \u4ecb\u7d39 \u00b6 Prometheus \u662f\u4e00\u500b\u76e3\u63a7\u7cfb\u7d71\u548c\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\uff0c\u7279\u5225\u9069\u5408\u76e3\u63a7\u52d5\u614b\u96f2\u74b0\u5883\u3002\u5b83\u5177\u6709\u7dad\u5ea6\u6578\u64da\u6a21\u578b\u548c\u5f37\u5927\u7684\u67e5\u8a62\u8a9e\u8a00\uff0c\u4e26\u5c07\u6aa2\u6e2c\u3001\u6307\u6a19\u6536\u96c6\u3001\u670d\u52d9\u767c\u73fe\u548c\u8b66\u5831\u7b49\u65b9\u9762\u96c6\u6210\u5728\u4e00\u500b\u751f\u614b\u7cfb\u7d71\u4e2d\u3002 \u672c\u6559\u7a0b\u6703\u4ecb\u7d39\u57fa\u672c\u7684 Prometheus \u6982\u5ff5\u3002 \u4ec0\u9ebc\u662f Prometheus? \u00b6 Prometheus \u662f\u4e00\u500b\u57fa\u65bc\u6307\u6a19\u7684\u76e3\u63a7\u548c\u8b66\u5831\u5806\u68e7\u3002 Prometheus \u63d0\u4f9b\u51fd\u5f0f\u5eab\u548c\u670d\u52d9\u5668\u7d44\u4ef6\u4ee5\u63d0\u4f9b\u5b8c\u6574\u7684\u76e3\u63a7\u7ba1\u9053\uff1a \u8ddf\u8e2a\u548c\u516c\u958b\u6307\u6a19 \u6536\u96c6\u6307\u6a19 \u5b58\u5132\u6307\u6a19 \u67e5\u8a62\u8b66\u5831\u3001\u5100\u8868\u677f\u7b49\u6307\u6a19 \u9019\u662f Prometheus \u670d\u52d9\u5668\u7684\u67e5\u8a62\u548c\u5716\u5f62 UI \u7684\u6a23\u5b50\uff1a Prometheus \u8db3\u5920\u901a\u7528\uff0c\u53ef\u4ee5\u76e3\u63a7\u5806\u68e7\u7684\u6240\u6709\u7d1a\u5225\uff1a\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u8edf\u4ef6\u3001\u7b2c\u4e09\u65b9\u670d\u52d9\u3001\u4e3b\u6a5f\u3001\u7db2\u7d61\u8a2d\u5099\u6216\u4efb\u4f55\u5176\u4ed6\u53ef\u4ee5\u516c\u958b Prometheus \u517c\u5bb9\u6307\u6a19\u7684\u6771\u897f\u3002\u6709\u4e9b\u4eba\u751a\u81f3\u4f7f\u7528 Prometheus \u4f86\u76e3\u63a7\u98a8\u529b\u767c\u96fb\u5834\u6216\u6578\u5b57\u706b\u8eca\u7ad9\u986f\u793a\u5668\u3002 \u7531\u65bc\u5b83\u8207\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u7684\u96c6\u6210\uff0cPrometheus \u7279\u5225\u9069\u7528\u65bc\u76e3\u63a7\u52d5\u614b\u96f2\u74b0\u5883\u548c\u96c6\u7fa4\u8abf\u5ea6\u7a0b\u5e8f\uff0c\u4f8b\u5982 Kubernetes\u3002 Prometheus \u4e0d\u662f\u4ec0\u9ebc\uff1f \u00b6 Prometheus \u5c08\u6ce8\u65bc\u6210\u70ba\u4e00\u500b\u57fa\u65bc\u6307\u6a19\u7684\u76e3\u63a7\u7cfb\u7d71\uff0c\u5177\u6709\u7c21\u55ae\u7684\u67b6\u69cb\u548c\u660e\u78ba\u7684\u8b66\u5831\u898f\u5247\u3002 \u5b83\u660e\u78ba\u4e0d\u65e8\u5728\u89e3\u6c7a\uff1a \u65e5\u8a8c(logging)\u6216\u8ddf\u8e2a(tracing) \u57fa\u65bc\u6a5f\u5668\u5b78\u7fd2\u6216\u4eba\u5de5\u667a\u80fd\u7684\u7570\u5e38\u6aa2\u6e2c \u6c34\u5e73\u64f4\u5c55\u7684\u96c6\u7fa4\u5b58\u5132 \u9019\u4e9b\u53ef\u80fd\u662f\u6709\u50f9\u503c\u7684\u529f\u80fd\uff0c\u4f46 Prometheus \u5c07\u9019\u4e9b\u7559\u7d66\u5176\u4ed6\u7cfb\u7d71\u4f86\u89e3\u6c7a\uff0c\u60a8\u53ef\u6574\u5408\u5176\u5b83\u5143\u4ef6\u6216\u5de5\u5177\u4f86\u8207 Prometheus \u4e00\u8d77\u904b\u884c\u3002 \u7cfb\u7d71\u67b6\u69cb \u00b6 \u4e0b\u5716\u6982\u8ff0\u4e86\u6574\u500b Prometheus \u7cfb\u7d71\u67b6\u69cb\uff1a \u4e00\u500b\u7d44\u7e54\u901a\u5e38\u6703\u904b\u884c\u4e00\u500b\u6216\u591a\u500b Prometheus \u670d\u52d9\u5668\uff0c\u5b83\u5011\u69cb\u6210\u4e86 Prometheus \u76e3\u63a7\u8a2d\u7f6e\u7684\u6838\u5fc3\u3002\u60a8\u914d\u7f6e Prometheus \u670d\u52d9\u5668\u4ee5\u4f7f\u7528 DNS\u3001Consul\u3001Kubernetes \u7b49\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u767c\u73fe\u4e00\u7d44\u6307\u6a19\u6e90\uff08\u6240\u8b02\u7684\u201c\u76ee\u6a19\u201d\uff09\u3002 \u7136\u5f8c\uff0cPrometheus \u901a\u904e HTTP \u5b9a\u671f\u5f9e\u9019\u4e9b\u76ee\u6a19\u4e2d\u4ee5\u57fa\u65bc\u6587\u672c\u7684\u683c\u5f0f\u63d0\u53d6\uff08\u6216\u201c\u6293\u53d6\u201d\uff09\u6307\u6a19\uff0c\u4e26\u5c07\u6536\u96c6\u5230\u7684\u6578\u64da\u5b58\u5132\u5728\u672c\u5730\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\u4e2d\u3002\u76ee\u6a19\u53ef\u4ee5\u662f\u76f4\u63a5\u8ddf\u8e2a\u548c\u516c\u958b\u6709\u95dc\u5176\u81ea\u8eab\u7684 Prometheus \u6307\u6a19\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u662f\u5c07\u6307\u6a19\u5f9e\u73fe\u6709\u7cfb\u7d71\uff08\u5982 MySQL \u670d\u52d9\u5668\uff09\u8f49\u63db\u70baPrometheus \u6307\u6a19\u5c55\u793a\u683c\u5f0f\u3002 \u7136\u5f8c\uff0cPrometheus \u670d\u52d9\u5668\u901a\u904e\u5176\u5167\u7f6e\u7684 Web UI\u3001\u4f7f\u7528 Grafana \u7b49\u5100\u8868\u677f\u5de5\u5177\u6216\u76f4\u63a5\u4f7f\u7528\u5176 HTTP API \u4f7f\u6536\u96c6\u7684\u6578\u64da\u53ef\u7528\u65bc\u67e5\u8a62\u3002 Info \u6ce8\u610f\uff1a\u6bcf\u6b21 scrape \u53ea\u5c07\u4e00\u500b target \u7684\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u7684\u7576\u524d\u503c\u50b3\u905e\u7d66 Prometheus\uff0c\u6240\u4ee5 scrape \u9593\u9694 \u6c7a\u5b9a\u4e86\u5b58\u5132\u6578\u64da\u7684\u6700\u7d42\u63a1\u6a23\u983b\u7387\u3002\u76ee\u6a19\u9032\u7a0b\u672c\u8eab\u4e0d\u4fdd\u7559\u4efb\u4f55\u6b77\u53f2\u5ea6\u91cf\u6578\u64da\u3002 \u60a8\u9084\u53ef\u4ee5\u5c07 Prometheus \u670d\u52d9\u5668\u914d\u7f6e\u70ba\u6839\u64da\u6536\u96c6\u7684\u6578\u64da\u751f\u6210\u8b66\u5831\u3002\u4f46\u662f\uff0cPrometheus \u4e0d\u6703\u76f4\u63a5\u5411\u4eba\u985e\u767c\u9001\u8b66\u5831\u901a\u77e5\u3002\u76f8\u53cd\uff0c\u5b83\u5c07\u539f\u59cb\u8b66\u5831\u8f49\u767c\u7d66\u4f5c\u70ba\u55ae\u7368\u670d\u52d9\u904b\u884c\u7684 Prometheus Alertmanager\u3002 Alertmanager \u53ef\u4ee5\u5f9e\u7d44\u7e54\u4e2d\u7684\u591a\u500b\uff08\u6216\u6240\u6709\uff09Prometheus \u670d\u52d9\u5668\u63a5\u6536\u8b66\u5831\uff0c\u4e26\u63d0\u4f9b\u4e00\u500b\u96c6\u4e2d\u4f4d\u7f6e\u4f86\u5c0d\u9019\u4e9b\u8b66\u5831\u9032\u884c\u5206\u7d44\u3001\u805a\u5408\u548c\u8def\u7531\u3002\u6700\u5f8c\uff0c\u5b83\u901a\u904e\u96fb\u5b50\u90f5\u4ef6\u3001Slack\u3001PagerDuty \u6216\u5176\u4ed6\u901a\u77e5\u670d\u52d9\u767c\u9001\u901a\u77e5\u3002 \u4e3b\u8981\u7279\u9ede\u548c\u8ce3\u9ede \u00b6 Prometheus \u7d50\u5408\u4e86\u591a\u500b\u95dc\u9375\u529f\u80fd\uff0c\u8b93\u60a8\u53ef\u4ee5\u6709\u6548\u5730\u76e3\u63a7\u60a8\u7684\u7cfb\u7d71\uff1a \u5141\u8a31\u5c0d\u6307\u6a19\u9032\u884c\u5206\u9762\u8ddf\u8e2a\u7684\u591a\u7dad\u5ea6\u6578\u64da\u6a21\u578b \u5f37\u5927\u7684\u67e5\u8a62\u8a9e\u8a00 (PromQL) \u53ef\u63d0\u4f9b\u9748\u6d3b\u7684\u7b54\u6848 \u6642\u9593\u5e8f\u5217\u8655\u7406\u548c\u8b66\u5831\u7684\u96c6\u6210\uff0c \u8207\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u96c6\u6210\u4ee5\u8655\u7406\u52d5\u614b\u74b0\u5883 \u64cd\u4f5c\u7c21\u55ae\uff0c \u4f7f\u7528\u7a0b\u5f0f\u8a9e\u8a00 Golang \u4f86\u9ad8\u6548\u5be6\u73fe \u6211\u5011\u5c07\u5728\u4ee5\u4e0b\u5404\u7bc0\u4e2d\u66f4\u8a73\u7d30\u5730\u8a0e\u8ad6\u9019\u4e9b\u8981\u9ede\u3002 \u6578\u64da\u6a21\u578b \u00b6 Prometheus \u5b58\u5132\u6642\u9593\u5e8f\u5217\uff0c\u5373\u5728\u6301\u7e8c\u6642\u9593\u6233\u8655\u63a1\u6a23\u7684\u6578\u503c\u6d41\uff1a \u6bcf\u500b\u6642\u9593\u5e8f\u5217\u7531\u4e00\u500b\"\u6a19\u8b58\u7b26\"\u548c\u4e00\u7d44\"\u6a23\u672c\u503c\"\u7d44\u6210\uff1a \u6642\u9593\u7cfb\u5217\u6a19\u8b58\u7b26 \u00b6 \u6bcf\u500b\u6642\u9593\u5e8f\u5217\u6578\u503c\u6d41\u90fd\u7531\u4e00\u500b \u5ea6\u91cf\u540d\u7a31 (Metric name) \u548c\u4e00\u7d44\u7a31\u70ba\u201c \u6a19\u7c64 \u201d\u7684 \u9375/\u503c\u5c0d \u6240\u7d44\u5408\u6210\u552f\u4e00\u6a19\u8b58: \u5ea6\u91cf\u540d\u7a31 \u6a19\u8b58\u6b63\u5728\u6e2c\u91cf\u7684\u7cfb\u7d71\u7684\u67d0\u500b\u7279\u5b9a\u9762\u5411\uff08\u5982 http_requests_total\uff0c\u7d66\u5b9a\u670d\u52d9\u5668\u9032\u7a0b\u8655\u7406\u7684 HTTP \u8acb\u6c42\u7e3d\u6578\uff09\u3002 \u6a19\u7c64 \u5141\u8a31\u60a8\u5c07\u6307\u6a19\u5283\u5206\u70ba\u5b50\u7dad\u5ea6\uff08\u4f8b\u5982 method=\"GET\" \u8207 method=\"POST\" \u544a\u8a34\u60a8\u8655\u7406\u4e86\u6bcf\u7a2e HTTP \u65b9\u6cd5\u985e\u578b\u7684\u8acb\u6c42\u6578\uff09\u3002\u6a19\u7c64\u53ef\u4ee5\u6709\u4e0d\u540c\u7684\u4f86\u6e90\uff1a\u4f8b\u5982\uff0c\u6aa2\u6e2c\u7684\u76ee\u6a19\u672c\u8eab\u53ef\u80fd\u6703\u516c\u958b\u5df2\u88ab\u4e00\u7d44\u6a19\u7c64\u62c6\u5206\u7684\u6307\u6a19\uff0c\u6216\u8005 Prometheus \u670d\u52d9\u5668\u53ef\u80fd\u6703\u5c07\u76ee\u6a19\u6a19\u7c64\u9644\u52a0\u5230\u6536\u96c6\u7684\u7cfb\u5217\u4e2d\uff0c\u4ee5\u8b58\u5225\u5b83\u5011\u7684\u4f86\u6e90\u3002 \u69cb\u6210\u6642\u9593\u5e8f\u5217\u6a19\u8b58\u7b26\u7684\u6307\u6a19\u540d\u7a31\u548c\u6a19\u7c64\u5728 Prometheus \u7684 TSDB \u4e2d\u5efa\u7acb\u7d22\u5f15\uff0c\u7528\u65bc\u5728\u67e5\u8a62\u6578\u64da\u6642\u67e5\u627e\u6642\u9593\u5e8f\u5217\u6578\u64da\u3002 \u6642\u9593\u7cfb\u5217\u63a1\u6a23 \u00b6 \u6a23\u672c\u5f62\u6210\u4e00\u500b\u7cfb\u5217\u7684\u5927\u91cf\u6578\u64da\uff0c\u4e26\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u9644\u52a0\u5230\u4e00\u500b\u7cfb\u5217\u7684\u7d22\u5f15\uff1a \u6642\u9593\u6233 \u662f\u6beb\u79d2\u7cbe\u5ea6\u7684 64 \u4f4d\u6574\u6578\u3002 \u6a23\u672c\u503c \u662f 64 \u4f4d\u6d6e\u9ede\u6578\uff08\u5141\u8a31\u6574\u6578\u7cbe\u5ea6\u9ad8\u9054 2^53\uff09\u3002 \u6307\u6a19\u50b3\u8f38\u683c\u5f0f \u00b6 \u60f3\u8981\u516c\u958b Prometheus \u6307\u6a19\u7684\u670d\u52d9\u53ea\u9700\u8981\u516c\u958b\u4e00\u500b HTTP \u7aef\u9ede\uff08\u901a\u5e38\u5728 /metrics \uff09\uff0c\u8a72\u7aef\u9ede\u4ee5 Prometheus \u7684\u57fa\u65bc\u6587\u672c\u7684\u5c55\u793a\u683c\u5f0f\u63d0\u4f9b\u6307\u6a19\u3002\u9019\u7a2e\u7aef\u9ede\u7684\u8f38\u51fa\u662f\u4eba\u985e\u53ef\u8b80\u7684\uff0c\u6700\u7c21\u55ae\u7684\u5f62\u5f0f\u5982\u4e0b\u6240\u793a\uff1a \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u7aef\u9ede\u516c\u958b\u4e86\u4e00\u500b HTTP \u8acb\u6c42\u8a08\u6578\u5668\uff0c\u8a72\u8a08\u6578\u5668\u7531\u97ff\u61c9\u72c0\u614b\u4ee3\u78bc\u4ee5\u53ca\u76ee\u6a19\u9032\u7a0b\u7684\u6253\u958b\u6587\u4ef6\u63cf\u8ff0\u7b26\u6578\u5206\u5272\u3002 \u8981\u5728\u700f\u89bd\u5668\u4e2d\u67e5\u770b\u4f86\u81ea\u201c\u771f\u5be6\u201d\u76ee\u6a19\u7684\u5be6\u6642\u6307\u6a19\uff0c\u8acb\u67e5\u770b\u6211\u5011\u904b\u884c\u7684 \u6f14\u793a\u670d\u52d9\u7684\u6307\u6a19\u7aef\u9ede \u3002 \u8a3b\u91cb\u7684 #HELP \u548c #TYPE \u884c\u63d0\u4f9b\u4e86\u4e00\u500b\u53ef\u9078\u7684\u6587\u6a94\u5b57\u7b26\u4e32\u548c\u95dc\u65bc\u5ea6\u91cf\u540d\u7a31\u7684\u5ea6\u91cf\u985e\u578b\u5143\u6578\u64da\u3002\u6b64\u683c\u5f0f\u4e2d\u7684\u6bcf\u500b\u672a\u8a3b\u91cb\u884c\u4ee3\u8868\u4e00\u500b\u7531 \u5ea6\u91cf\u540d\u7a31 \u3001 \u6a19\u7c64 \u548c \u63a1\u6a23\u503c \u7d44\u6210\u7684\u6a23\u672c\u8a18\u9304\u3002\u9019\u7a2e\u57fa\u65bc\u884c\u7684\u683c\u5f0f\u53ef\u4ee5\u8f15\u9b06\u5730\u5f9e\u7cfb\u7d71\u548c\u670d\u52d9\u4e2d\u516c\u958b\u6307\u6a19\u3002 \u67e5\u770b Prometheus \u6587\u6a94\u4ee5\u7372\u53d6\u6709\u95dc \u6307\u6a19\u50b3\u8f38\u683c\u5f0f \u7684\u5b8c\u6574\u8a73\u7d30\u4fe1\u606f\u3002 Prometheus \u6307\u6a19\u683c\u5f0f\u4e5f\u6b63\u5728\u6f14\u8b8a\u6210\u4e00\u500b\u540d\u70ba OpenMetrics \u7684\u958b\u653e\u6a19\u6e96\uff0cPrometheus \u4e5f\u652f\u6301\u8a72\u6a19\u6e96\u3002 \u67e5\u8a62\u8a9e\u8a00 \u00b6 \u70ba\u4e86\u5229\u7528\u6536\u96c6\u5230\u7684\u6578\u64da\uff0cPrometheus \u5be6\u73fe\u4e86\u81ea\u5df1\u7684\u67e5\u8a62\u8a9e\u8a00 PromQL \u3002 PromQL \u662f\u4e00\u7a2e\u51fd\u6578\u5f0f\u8a9e\u8a00\uff0c\u7d93\u904e\u512a\u5316\uff0c\u53ef\u4ee5\u8a55\u4f30\u5c0d\u6642\u9593\u5e8f\u5217\u6578\u64da\u9032\u884c\u9748\u6d3b\u9ad8\u6548\u7684\u8a08\u7b97\u3002\u8207\u985e\u4f3c SQL \u7684\u8a9e\u8a00\u76f8\u6bd4\uff0c PromQL \u50c5\u7528\u65bc\u8b80\u53d6\u6578\u64da\uff0c\u800c\u4e0d\u7528\u65bc\u63d2\u5165\u3001\u66f4\u65b0\u6216\u522a\u9664\u6578\u64da\uff08\u9019\u767c\u751f\u5728\u67e5\u8a62\u5f15\u64ce\u4e4b\u5916\uff09\u3002 \u6211\u5011\u5c07\u5728\u9019\u88e1\u770b\u5e7e\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\u3002 \u7d66\u5b9a\u4e00\u7d44\u5177\u6709\u5ea6\u91cf\u540d\u7a31 http_requests_total \u7684 HTTP \u8acb\u6c42\u8a08\u6578\u5668\u6642\u9593\u5e8f\u5217\u3001\u4e00\u500b\u6307\u793a\u97ff\u61c9\u72c0\u614b\u4ee3\u78bc\u7684\u72c0\u614b\u6a19\u7c64\u548c\u4e00\u500b\u6307\u793a HTTP \u8def\u5f91\u7684\u8def\u5f91\u6a19\u7c64\uff0c\u4ee5\u4e0b\u67e5\u8a62\u9078\u64c7\u6240\u6709\u5df2\u8655\u7406 HTTP \u8acb\u6c42\u7684\u7e3d\u6578\uff0c\u7d50\u679c\u70ba 500 \u72c0\u614b\u78bc\uff1a http_requests_total { status = \" 500 \"} \u7531\u65bc\u7d55\u5c0d\u8a08\u6578\u5f88\u5c11\u6709\u7528\uff0c\u4ee5\u4e0b\u67e5\u8a62\u6703\u544a\u8a34\u60a8\u6bcf\u500b\u9078\u5b9a\u8a08\u6578\u5668\u5e8f\u5217\u7684\u6bcf\u79d2\u589e\u9577\u7387\uff0c\u5373 5 \u5206\u9418\u7a97\u53e3\u5167\u7684\u5e73\u5747\u503c\uff1a rate ( http_requests_total { status = \" 500 \"}[ 5m ] ) \u4e26\u4e14\u60a8\u53ef\u4ee5\u8a08\u7b97\u5404\u7a2e per-path status=\"500\" \u932f\u8aa4\u7387\u8207\u76f8\u540c HTTP \u8def\u5f91\u7684\u7e3d\u8acb\u6c42\u7387\u7684\u6bd4\u7387\uff0c\u5982\u4e0b\u6240\u793a\uff1a sum by ( path ) ( rate ( http_requests_total { status = \" 500 \"}[ 5m ] )) / sum by ( path ) ( rate ( http_requests_total [ 5m ] )) \u60a8\u9084\u53ef\u4ee5\u50c5\u9078\u64c7\u5927\u65bc 5% \u7684\u6bcf\u689d\u8def\u5f91\u932f\u8aa4\u7387\u6bd4\u7387\uff1a sum by ( path ) ( rate ( http_requests_total { status = \" 500 \"}[ 5m ] )) / sum by ( path ) ( rate ( http_requests_total [ 5m ] )) * 100 > 5 \u9019\u4e9b\u662f\u60a8\u5c07\u5728 PromQL \u4e2d\u770b\u5230\u7684\u4e00\u4e9b\u66f4\u5e38\u898b\u7684\u7d50\u69cb\uff0c\u4f46\u8a72\u8a9e\u8a00\u5177\u6709\u66f4\u591a\u7684\u7279\u6027\u548c\u529f\u80fd\u3002 \u96c6\u6210\u8b66\u5831 \u00b6 Prometheus \u5c07\u6642\u9593\u5e8f\u5217\u6578\u64da\u7684\u6536\u96c6\u548c\u8655\u7406\u8207\u4e3b\u52d5\u8b66\u5831\u7cfb\u7d71\u96c6\u6210\u5728\u4e00\u8d77\u3002\u5b83\u7684\u7406\u5ff5\u662f\u5728\u55ae\u500b\u6578\u64da\u6a21\u578b\u4e2d\u6536\u96c6\u76e1\u53ef\u80fd\u591a\u7684\u95dc\u65bc\u60a8\u7684\u7cfb\u7d71\u7684\u6578\u64da\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u5728\u5176\u4e0a\u88fd\u5b9a\u96c6\u6210\u67e5\u8a62\u3002\u7528\u65bc\u81e8\u6642\u67e5\u8a62\u548c\u5100\u8868\u677f\u7684\u67e5\u8a62\u8a9e\u8a00\u4e5f\u7528\u65bc\u5b9a\u7fa9\u8b66\u5831\u898f\u5247\u3002\u9019\u8207 Nagios \u7b49\u6545\u969c\u6aa2\u6e2c\u7cfb\u7d71\uff08\u904b\u884c\u5b9a\u671f\u6aa2\u67e5\u8173\u672c\u4e26\u4fdd\u7559\u5f88\u5c11\u7684\u6b77\u53f2\u6578\u64da\uff09\u8207\u88ab\u52d5\u5b58\u5132\u6307\u6a19\u7684\u7368\u7acb\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\u4e4b\u9593\u7684\u6b77\u53f2\u5206\u6b67\u5f62\u6210\u9bae\u660e\u5c0d\u6bd4\u3002 \u4f8b\u5982\uff0c\u4ee5\u4e0b\u8b66\u5831\u898f\u5247\uff08\u4f5c\u70ba\u898f\u5247\u914d\u7f6e\u6587\u4ef6\u7684\u4e00\u90e8\u5206\u52a0\u8f09\u5230 Prometheus \u4e2d\uff09\u6703\u5728\u5c0e\u81f4 500 \u72c0\u614b\u4ee3\u78bc\u7684 HTTP \u8acb\u6c42\u6578\u91cf\u8d85\u904e\u7d66\u5b9a\u8def\u5f91\u7e3d\u6d41\u91cf\u7684 5% \u6642\u5411\u60a8\u767c\u51fa\u8b66\u5831\uff1a alert : Many500Errors # This is the PromQL expression that forms the \"heart\" of the alerting rule. expr : | ( sum by ( path ) ( rate ( http_requests_total { status = \" 500 \"}[ 5m ] )) / sum by ( path ) ( rate ( http_requests_total [ 5m ] )) ) * 100 > 5 for : 5m labels : severity : \" critical \" annotations : summary : \" Many 500 errors for path {{$labels.path}} ({{$value}}%) \" expr \u5b57\u6bb5\u4e2d\u7684 PromQL \u8868\u9054\u5f0f\u69cb\u6210\u8b66\u5831\u898f\u5247\u7684\u6838\u5fc3\uff0c\u800c\u5176\u4ed6\u57fa\u65bc YAML \u7684\u914d\u7f6e\u9078\u9805\u5141\u8a31\u60a8\u63a7\u5236\u8b66\u5831\u5143\u6578\u64da\u3001\u8def\u7531\u6a19\u7c64\u7b49\u3002\u9019\u53ef\u4ee5\u6839\u64da\u6536\u96c6\u7684\u6578\u64da\u9032\u884c\u7cbe\u78ba\u548c\u6e96\u78ba\u7684\u8b66\u5831\u3002 \u670d\u52d9\u767c\u73fe\u96c6\u6210 \u00b6 \u73fe\u4ee3\u52d5\u614b IT \u74b0\u5883\u70ba\u76e3\u63a7\u7cfb\u7d71\u5e36\u4f86\u4e86\u65b0\u7684\u6311\u6230\uff1a \u96f2\u63d0\u4f9b\u5546\u4e0a\u7684\u6309\u9700 VM \u53ef\u6839\u64da\u9700\u8981\u9032\u884c\u64f4\u5c55\u548c\u7e2e\u6e1b \u670d\u52d9\u5be6\u4f8b\u7531\u5bb9\u5668\u7de8\u6392\u5668\uff08\u4f8b\u5982 Kubernetes\u3001Docker Swarm \u6216 Mesos\uff09\u52d5\u614b\u8abf\u5ea6\u5230\u4e3b\u6a5f\u4e0a \u5fae\u670d\u52d9\u7684\u8da8\u52e2\u5c0e\u81f4\u8d8a\u4f86\u8d8a\u591a\u7684\u55ae\u500b\u670d\u52d9\u9700\u8981\u904b\u884c\u548c\u76e3\u63a7 \u554f\u984c\u51fa\u73fe\u4e86\uff1a\u76e3\u63a7\u7cfb\u7d71\u5982\u4f55\u4ecd\u7136\u80fd\u5920\u7406\u89e3\u9019\u500b\u52d5\u614b\u7684\u4e16\u754c\uff1f\u5b83\u5982\u4f55\u77e5\u9053\u7576\u524d\u61c9\u8a72\u5b58\u5728\u54ea\u4e9b\u6a5f\u5668\u6216\u670d\u52d9\u5be6\u4f8b\uff0c\u5b83\u5011\u7684\u8eab\u4efd\u662f\u4ec0\u9ebc\uff0c\u4ee5\u53ca\u5982\u4f55\u5f9e\u4e2d\u7372\u53d6\u6307\u6a19\uff1f\u64cd\u4f5c\u54e1\u4e0d\u518d\u53ef\u80fd\u975c\u614b\u914d\u7f6e\u6b64\u4fe1\u606f\uff0c\u56e0\u70ba\u5b83\u592a\u8907\u96dc\u4e14\u8b8a\u5316\u592a\u5feb\u3002 \u70ba\u4e86\u89e3\u6c7a\u9019\u500b\u554f\u984c\uff0cPrometheus \u8207\u57fa\u790e\u8a2d\u65bd\u4e2d\u7684\u5e38\u898b\u670d\u52d9\u767c\u73fe\u63d0\u4f9b\u7a0b\u5e8f\u96c6\u6210\uff0c\u4ee5\u5f9e\u5916\u90e8\u4e8b\u5be6\u4f86\u6e90\u767c\u73fe\u4e26\u6301\u7e8c\u66f4\u65b0\u5176\u76e3\u63a7\u76ee\u6a19\uff1a Prometheus \u652f\u6301\u591a\u7a2e\u5167\u7f6e\u670d\u52d9\u767c\u73fe\u6a5f\u5236\uff0c\u4f8b\u5982\uff1a \u5728\u96f2\u63d0\u4f9b\u5546\uff08AWS\u3001Azure\u3001\u8c37\u6b4c\u2026\u2026\uff09\u4e0a\u767c\u73fe\u865b\u64ec\u6a5f\uff0c \u5728\u96c6\u7fa4\u7de8\u6392\u5668\uff08Kubernetes\u3001Marathon \u7b49\uff09\u4e0a\u767c\u73fe\u670d\u52d9\u5be6\u4f8b\uff0c \u4f7f\u7528\u901a\u7528\u67e5\u627e\u65b9\u6cd5\uff08\u5982 DNS\u3001Consul\u3001Zookeeper \u6216\u81ea\u5b9a\u7fa9\u767c\u73fe\u6a5f\u5236\uff09\u767c\u73fe\u76ee\u6a19\u3002 Prometheus \u5c07\u670d\u52d9\u767c\u73fe\u7528\u65bc\u4e09\u500b\u4e0d\u540c\u4f46\u76f8\u95dc\u7684\u76ee\u7684\uff1a \u69cb\u5efa\u61c9\u8a72\u5b58\u5728\u54ea\u4e9b\u76ee\u6a19\u7684\u8996\u5716\uff08\u4ee5\u4fbf\u5b83\u53ef\u4ee5\u8a18\u9304\u4e26\u5728\u7f3a\u5c11\u76ee\u6a19\u6642\u767c\u51fa\u8b66\u5831\uff09\uff0c \u8981\u7372\u53d6\u6709\u95dc\u5982\u4f55\u901a\u904e HTTP \u5f9e\u76ee\u6a19\u4e2d\u63d0\u53d6\u6307\u6a19\u7684\u6280\u8853\u4fe1\u606f\uff0c \u4f7f\u7528\u6709\u95dc\u76ee\u6a19\u7684\u6a19\u8a18\u5143\u6578\u64da\u8c50\u5bcc\u5f9e\u76ee\u6a19\u6536\u96c6\u7684\u7cfb\u5217\u3002 \u901a\u904e\u9019\u7a2e\u65b9\u5f0f\uff0cPrometheus \u4f7f\u7528\u670d\u52d9\u767c\u73fe\u4f5c\u70ba\u4e8b\u5be6\u4f86\u6e90\u4f86\u53ef\u9760\u5730\u76e3\u63a7\u52d5\u614b\u74b0\u5883\uff0c\u540c\u6642\u6700\u5927\u9650\u5ea6\u5730\u6e1b\u5c11\u7ba1\u7406\u958b\u92b7\u3002 \u64cd\u4f5c\u7c21\u55ae \u00b6 Prometheus \u7684\u6838\u5fc3\u662f\u6982\u5ff5\u4e0a\u7c21\u55ae\u4e14\u6613\u65bc\u64cd\u4f5c\u3002 \u4f7f\u7528 Golang \u7a0b\u5f0f\u8a9e\u8a00\u64b0\u5beb \u00b6 Prometheus \u662f\u7528 Go \u7de8\u5beb\u7684\uff0c\u975c\u614b\u767c\u5e03\u4e8c\u9032\u88fd\u6587\u4ef6\u53ef\u4ee5\u5728\u4e0d\u4f9d\u8cf4\u65bc\u5916\u90e8\u904b\u884c\u6642\uff08\u5982 JVM\uff09\u3001\u89e3\u91cb\u5668\uff08\u5982 Python \u6216 Ruby\uff09\u6216\u5171\u4eab\u7cfb\u7d71\u5eab\u7684\u60c5\u6cc1\u4e0b\u9032\u884c\u90e8\u7f72\u3002 \u7368\u7acb\u7bc0\u9ede \u00b6 \u6bcf\u500b Prometheus \u670d\u52d9\u5668\u7368\u7acb\u65bc\u4efb\u4f55\u5176\u4ed6 Prometheus \u670d\u52d9\u5668\u6536\u96c6\u6578\u64da\u4e26\u8a55\u4f30\u8b66\u5831\u898f\u5247\uff0c\u4e26\u4e14\u50c5\u5728\u672c\u5730\u5b58\u5132\u6578\u64da\uff0c\u800c\u7121\u9700\u7dca\u5bc6\u7684\u96c6\u7fa4\u6216\u8907\u5236\u3002 \u7c21\u55ae\u7684 HA \u8a2d\u7f6e \u00b6 \u8981\u70ba\u8b66\u5831\u5275\u5efa\u9ad8\u53ef\u7528\u6027 (HA) \u8a2d\u7f6e\uff0c\u60a8\u4ecd\u7136\u53ef\u4ee5\u904b\u884c\u5169\u500b\u914d\u7f6e\u76f8\u540c\u7684 Prometheus \u670d\u52d9\u5668\u4f86\u8a08\u7b97\u76f8\u540c\u7684\u8b66\u5831\uff08Alertmanager \u5c07\u522a\u9664\u91cd\u8907\u7684\u901a\u77e5\uff09\uff1a \u7576\u7136\uff0cPrometheus \u7684\u5927\u898f\u6a21\u90e8\u7f72\u6216\u6709\u7279\u6b8a\u9700\u6c42\u7684\u8a2d\u7f6e\u4ecd\u7136\u6703\u8b8a\u5f97\u8907\u96dc\u3002 Prometheus \u9084\u63d0\u4f9b\u63a5\u53e3\u4f86\u89e3\u6c7a\u5176\u5916\u90e8\u7684\u4e00\u4e9b\u9650\u5236\uff0c\u4f8b\u5982\u6301\u4e45\u7684\u9577\u671f\u5b58\u5132\u3002 \u9ad8\u6548\u5be6\u65bd \u00b6 Prometheus \u9700\u8981\u80fd\u5920\u540c\u6642\u5f9e\u591a\u500b\u7cfb\u7d71\u548c\u670d\u52d9\u4e2d\u6536\u96c6\u8a73\u7d30\u7684\u7dad\u5ea6\u6578\u64da\u3002\u70ba\u6b64\uff0c\u7279\u5225\u662f\u5c0d\u4ee5\u4e0b\u7d44\u4ef6\u9032\u884c\u4e86\u9ad8\u5ea6\u512a\u5316\uff1a \u6293\u53d6\u548c\u89e3\u6790\u50b3\u5165\u7684\u6307\u6a19\uff0c \u5beb\u5165\u548c\u8b80\u53d6\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\uff0c \u6839\u64da TSDB \u6578\u64da\u8a55\u4f30 PromQL \u8868\u9054\u5f0f\u3002 \u6839\u64da\u7d93\u9a57\uff0c\u55ae\u500b\u5927\u578b Prometheus \u670d\u52d9\u5668\u6bcf\u79d2\u53ef\u4ee5\u651d\u53d6\u591a\u9054 100 \u842c\u500b\u6642\u9593\u5e8f\u5217\u6a23\u672c\uff0c\u4e26\u4f7f\u7528 1-2 \u500b\u5b57\u7bc0\u5728\u78c1\u76e4\u4e0a\u5b58\u5132\u6bcf\u500b\u6a23\u672c\u3002\u5b83\u53ef\u4ee5\u4e00\u6b21\u8655\u7406\u6578\u767e\u842c\u4e26\u767c\u6d3b\u52d5\uff08\u5b58\u5728\u65bc\u6240\u6709\u76ee\u6a19\u7684\u4e00\u6b21\u6293\u53d6\u8fed\u4ee3\u4e2d\uff09\u6642\u9593\u5e8f\u5217\u3002 \u7d50\u8ad6 \u00b6 \u606d\u559c\uff01\u5728\u672c\u6b21\u57f9\u8a13\u4e2d\uff0c\u60a8\u5b78\u5230\u4e86\uff1a Prometheus \u95dc\u6ce8\u4ec0\u9ebc\u4ee5\u53ca\u5b83\u8a66\u5716\u4e0d\u505a\u7684\u4e8b\u60c5 Prometheus \u5982\u4f55\u5f9e\u76ee\u6a19\u6536\u96c6\u6642\u9593\u5e8f\u5217\u6578\u64da PromQL \u5982\u4f55\u57fa\u65bc\u6536\u96c6\u7684\u6578\u64da\u5be6\u73fe\u9748\u6d3b\u800c\u5f37\u5927\u7684\u67e5\u8a62 Prometheus \u5982\u4f55\u5c07\u6642\u9593\u5e8f\u5217\u6578\u64da\u6536\u96c6\u548c\u8b66\u5831\u806f\u7e6b\u5728\u4e00\u8d77 \u670d\u52d9\u767c\u73fe\u5982\u4f55\u5e6b\u52a9\u6293\u53d6\u548c\u6a19\u8a18\u76ee\u6a19 \u60a8\u73fe\u5728\u61c9\u8a72\u6e96\u5099\u597d\u89e3\u91cb Prometheus \u7684\u6838\u5fc3\u539f\u7406\u548c\u7279\u6027\uff0c\u4e26\u904b\u884c Prometheus \u4ee5\u5f9e\u76ee\u6a19\u4e2d\u6536\u96c6\u6578\u64da\u3002","title":"Prometheus \u7c21\u4ecb"},{"location":"prometheus/prometheus/overview/#prometheus","text":"\u539f\u6587: https://training.promlabs.com/training/introduction-to-prometheus/training-overview/introduction \u672c\u57f9\u8a13\u6559\u60a8\u57fa\u65bc Prometheus \u7684\u76e3\u63a7\u7684\u7d55\u5c0d\u57fa\u790e\u77e5\u8b58\uff0c\u6db5\u84cb\u67b6\u69cb\u6982\u8ff0\u4ee5\u53ca Prometheus \u7684\u4e3b\u8981\u529f\u80fd\u3002\u4f5c\u70ba\u672c\u57f9\u8a13\u7684\u4e00\u90e8\u5206\uff0c\u60a8\u9084\u5c07\u4e0b\u8f09\u3001\u914d\u7f6e\u548c\u904b\u884c\u57fa\u672c\u7684 Prometheus \u8a2d\u7f6e\u3002 \u5728\u672c\u6b21\u57f9\u8a13\u4e4b\u5f8c\uff0c\u60a8\u5c07\u80fd\u5920\u63cf\u8ff0 Prometheus \u5982\u4f55\u878d\u5165\u76e3\u63a7\u74b0\u5883\u4e26\u4ee5\u57fa\u672c\u65b9\u5f0f\u8a2d\u7f6e Prometheus\u3002","title":"Prometheus \u7c21\u4ecb"},{"location":"prometheus/prometheus/overview/#_1","text":"Prometheus \u662f\u4e00\u500b\u76e3\u63a7\u7cfb\u7d71\u548c\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\uff0c\u7279\u5225\u9069\u5408\u76e3\u63a7\u52d5\u614b\u96f2\u74b0\u5883\u3002\u5b83\u5177\u6709\u7dad\u5ea6\u6578\u64da\u6a21\u578b\u548c\u5f37\u5927\u7684\u67e5\u8a62\u8a9e\u8a00\uff0c\u4e26\u5c07\u6aa2\u6e2c\u3001\u6307\u6a19\u6536\u96c6\u3001\u670d\u52d9\u767c\u73fe\u548c\u8b66\u5831\u7b49\u65b9\u9762\u96c6\u6210\u5728\u4e00\u500b\u751f\u614b\u7cfb\u7d71\u4e2d\u3002 \u672c\u6559\u7a0b\u6703\u4ecb\u7d39\u57fa\u672c\u7684 Prometheus \u6982\u5ff5\u3002","title":"\u4ecb\u7d39"},{"location":"prometheus/prometheus/overview/#prometheus_1","text":"Prometheus \u662f\u4e00\u500b\u57fa\u65bc\u6307\u6a19\u7684\u76e3\u63a7\u548c\u8b66\u5831\u5806\u68e7\u3002 Prometheus \u63d0\u4f9b\u51fd\u5f0f\u5eab\u548c\u670d\u52d9\u5668\u7d44\u4ef6\u4ee5\u63d0\u4f9b\u5b8c\u6574\u7684\u76e3\u63a7\u7ba1\u9053\uff1a \u8ddf\u8e2a\u548c\u516c\u958b\u6307\u6a19 \u6536\u96c6\u6307\u6a19 \u5b58\u5132\u6307\u6a19 \u67e5\u8a62\u8b66\u5831\u3001\u5100\u8868\u677f\u7b49\u6307\u6a19 \u9019\u662f Prometheus \u670d\u52d9\u5668\u7684\u67e5\u8a62\u548c\u5716\u5f62 UI \u7684\u6a23\u5b50\uff1a Prometheus \u8db3\u5920\u901a\u7528\uff0c\u53ef\u4ee5\u76e3\u63a7\u5806\u68e7\u7684\u6240\u6709\u7d1a\u5225\uff1a\u60a8\u81ea\u5df1\u7684\u61c9\u7528\u7a0b\u5e8f\u8edf\u4ef6\u3001\u7b2c\u4e09\u65b9\u670d\u52d9\u3001\u4e3b\u6a5f\u3001\u7db2\u7d61\u8a2d\u5099\u6216\u4efb\u4f55\u5176\u4ed6\u53ef\u4ee5\u516c\u958b Prometheus \u517c\u5bb9\u6307\u6a19\u7684\u6771\u897f\u3002\u6709\u4e9b\u4eba\u751a\u81f3\u4f7f\u7528 Prometheus \u4f86\u76e3\u63a7\u98a8\u529b\u767c\u96fb\u5834\u6216\u6578\u5b57\u706b\u8eca\u7ad9\u986f\u793a\u5668\u3002 \u7531\u65bc\u5b83\u8207\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u7684\u96c6\u6210\uff0cPrometheus \u7279\u5225\u9069\u7528\u65bc\u76e3\u63a7\u52d5\u614b\u96f2\u74b0\u5883\u548c\u96c6\u7fa4\u8abf\u5ea6\u7a0b\u5e8f\uff0c\u4f8b\u5982 Kubernetes\u3002","title":"\u4ec0\u9ebc\u662f Prometheus?"},{"location":"prometheus/prometheus/overview/#prometheus_2","text":"Prometheus \u5c08\u6ce8\u65bc\u6210\u70ba\u4e00\u500b\u57fa\u65bc\u6307\u6a19\u7684\u76e3\u63a7\u7cfb\u7d71\uff0c\u5177\u6709\u7c21\u55ae\u7684\u67b6\u69cb\u548c\u660e\u78ba\u7684\u8b66\u5831\u898f\u5247\u3002 \u5b83\u660e\u78ba\u4e0d\u65e8\u5728\u89e3\u6c7a\uff1a \u65e5\u8a8c(logging)\u6216\u8ddf\u8e2a(tracing) \u57fa\u65bc\u6a5f\u5668\u5b78\u7fd2\u6216\u4eba\u5de5\u667a\u80fd\u7684\u7570\u5e38\u6aa2\u6e2c \u6c34\u5e73\u64f4\u5c55\u7684\u96c6\u7fa4\u5b58\u5132 \u9019\u4e9b\u53ef\u80fd\u662f\u6709\u50f9\u503c\u7684\u529f\u80fd\uff0c\u4f46 Prometheus \u5c07\u9019\u4e9b\u7559\u7d66\u5176\u4ed6\u7cfb\u7d71\u4f86\u89e3\u6c7a\uff0c\u60a8\u53ef\u6574\u5408\u5176\u5b83\u5143\u4ef6\u6216\u5de5\u5177\u4f86\u8207 Prometheus \u4e00\u8d77\u904b\u884c\u3002","title":"Prometheus \u4e0d\u662f\u4ec0\u9ebc\uff1f"},{"location":"prometheus/prometheus/overview/#_2","text":"\u4e0b\u5716\u6982\u8ff0\u4e86\u6574\u500b Prometheus \u7cfb\u7d71\u67b6\u69cb\uff1a \u4e00\u500b\u7d44\u7e54\u901a\u5e38\u6703\u904b\u884c\u4e00\u500b\u6216\u591a\u500b Prometheus \u670d\u52d9\u5668\uff0c\u5b83\u5011\u69cb\u6210\u4e86 Prometheus \u76e3\u63a7\u8a2d\u7f6e\u7684\u6838\u5fc3\u3002\u60a8\u914d\u7f6e Prometheus \u670d\u52d9\u5668\u4ee5\u4f7f\u7528 DNS\u3001Consul\u3001Kubernetes \u7b49\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u767c\u73fe\u4e00\u7d44\u6307\u6a19\u6e90\uff08\u6240\u8b02\u7684\u201c\u76ee\u6a19\u201d\uff09\u3002 \u7136\u5f8c\uff0cPrometheus \u901a\u904e HTTP \u5b9a\u671f\u5f9e\u9019\u4e9b\u76ee\u6a19\u4e2d\u4ee5\u57fa\u65bc\u6587\u672c\u7684\u683c\u5f0f\u63d0\u53d6\uff08\u6216\u201c\u6293\u53d6\u201d\uff09\u6307\u6a19\uff0c\u4e26\u5c07\u6536\u96c6\u5230\u7684\u6578\u64da\u5b58\u5132\u5728\u672c\u5730\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\u4e2d\u3002\u76ee\u6a19\u53ef\u4ee5\u662f\u76f4\u63a5\u8ddf\u8e2a\u548c\u516c\u958b\u6709\u95dc\u5176\u81ea\u8eab\u7684 Prometheus \u6307\u6a19\u7684\u61c9\u7528\u7a0b\u5e8f\uff0c\u4e5f\u53ef\u4ee5\u662f\u5c07\u6307\u6a19\u5f9e\u73fe\u6709\u7cfb\u7d71\uff08\u5982 MySQL \u670d\u52d9\u5668\uff09\u8f49\u63db\u70baPrometheus \u6307\u6a19\u5c55\u793a\u683c\u5f0f\u3002 \u7136\u5f8c\uff0cPrometheus \u670d\u52d9\u5668\u901a\u904e\u5176\u5167\u7f6e\u7684 Web UI\u3001\u4f7f\u7528 Grafana \u7b49\u5100\u8868\u677f\u5de5\u5177\u6216\u76f4\u63a5\u4f7f\u7528\u5176 HTTP API \u4f7f\u6536\u96c6\u7684\u6578\u64da\u53ef\u7528\u65bc\u67e5\u8a62\u3002 Info \u6ce8\u610f\uff1a\u6bcf\u6b21 scrape \u53ea\u5c07\u4e00\u500b target \u7684\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u7684\u7576\u524d\u503c\u50b3\u905e\u7d66 Prometheus\uff0c\u6240\u4ee5 scrape \u9593\u9694 \u6c7a\u5b9a\u4e86\u5b58\u5132\u6578\u64da\u7684\u6700\u7d42\u63a1\u6a23\u983b\u7387\u3002\u76ee\u6a19\u9032\u7a0b\u672c\u8eab\u4e0d\u4fdd\u7559\u4efb\u4f55\u6b77\u53f2\u5ea6\u91cf\u6578\u64da\u3002 \u60a8\u9084\u53ef\u4ee5\u5c07 Prometheus \u670d\u52d9\u5668\u914d\u7f6e\u70ba\u6839\u64da\u6536\u96c6\u7684\u6578\u64da\u751f\u6210\u8b66\u5831\u3002\u4f46\u662f\uff0cPrometheus \u4e0d\u6703\u76f4\u63a5\u5411\u4eba\u985e\u767c\u9001\u8b66\u5831\u901a\u77e5\u3002\u76f8\u53cd\uff0c\u5b83\u5c07\u539f\u59cb\u8b66\u5831\u8f49\u767c\u7d66\u4f5c\u70ba\u55ae\u7368\u670d\u52d9\u904b\u884c\u7684 Prometheus Alertmanager\u3002 Alertmanager \u53ef\u4ee5\u5f9e\u7d44\u7e54\u4e2d\u7684\u591a\u500b\uff08\u6216\u6240\u6709\uff09Prometheus \u670d\u52d9\u5668\u63a5\u6536\u8b66\u5831\uff0c\u4e26\u63d0\u4f9b\u4e00\u500b\u96c6\u4e2d\u4f4d\u7f6e\u4f86\u5c0d\u9019\u4e9b\u8b66\u5831\u9032\u884c\u5206\u7d44\u3001\u805a\u5408\u548c\u8def\u7531\u3002\u6700\u5f8c\uff0c\u5b83\u901a\u904e\u96fb\u5b50\u90f5\u4ef6\u3001Slack\u3001PagerDuty \u6216\u5176\u4ed6\u901a\u77e5\u670d\u52d9\u767c\u9001\u901a\u77e5\u3002","title":"\u7cfb\u7d71\u67b6\u69cb"},{"location":"prometheus/prometheus/overview/#_3","text":"Prometheus \u7d50\u5408\u4e86\u591a\u500b\u95dc\u9375\u529f\u80fd\uff0c\u8b93\u60a8\u53ef\u4ee5\u6709\u6548\u5730\u76e3\u63a7\u60a8\u7684\u7cfb\u7d71\uff1a \u5141\u8a31\u5c0d\u6307\u6a19\u9032\u884c\u5206\u9762\u8ddf\u8e2a\u7684\u591a\u7dad\u5ea6\u6578\u64da\u6a21\u578b \u5f37\u5927\u7684\u67e5\u8a62\u8a9e\u8a00 (PromQL) \u53ef\u63d0\u4f9b\u9748\u6d3b\u7684\u7b54\u6848 \u6642\u9593\u5e8f\u5217\u8655\u7406\u548c\u8b66\u5831\u7684\u96c6\u6210\uff0c \u8207\u670d\u52d9\u767c\u73fe\u6a5f\u5236\u96c6\u6210\u4ee5\u8655\u7406\u52d5\u614b\u74b0\u5883 \u64cd\u4f5c\u7c21\u55ae\uff0c \u4f7f\u7528\u7a0b\u5f0f\u8a9e\u8a00 Golang \u4f86\u9ad8\u6548\u5be6\u73fe \u6211\u5011\u5c07\u5728\u4ee5\u4e0b\u5404\u7bc0\u4e2d\u66f4\u8a73\u7d30\u5730\u8a0e\u8ad6\u9019\u4e9b\u8981\u9ede\u3002","title":"\u4e3b\u8981\u7279\u9ede\u548c\u8ce3\u9ede"},{"location":"prometheus/prometheus/overview/#_4","text":"Prometheus \u5b58\u5132\u6642\u9593\u5e8f\u5217\uff0c\u5373\u5728\u6301\u7e8c\u6642\u9593\u6233\u8655\u63a1\u6a23\u7684\u6578\u503c\u6d41\uff1a \u6bcf\u500b\u6642\u9593\u5e8f\u5217\u7531\u4e00\u500b\"\u6a19\u8b58\u7b26\"\u548c\u4e00\u7d44\"\u6a23\u672c\u503c\"\u7d44\u6210\uff1a","title":"\u6578\u64da\u6a21\u578b"},{"location":"prometheus/prometheus/overview/#_5","text":"\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u6578\u503c\u6d41\u90fd\u7531\u4e00\u500b \u5ea6\u91cf\u540d\u7a31 (Metric name) \u548c\u4e00\u7d44\u7a31\u70ba\u201c \u6a19\u7c64 \u201d\u7684 \u9375/\u503c\u5c0d \u6240\u7d44\u5408\u6210\u552f\u4e00\u6a19\u8b58: \u5ea6\u91cf\u540d\u7a31 \u6a19\u8b58\u6b63\u5728\u6e2c\u91cf\u7684\u7cfb\u7d71\u7684\u67d0\u500b\u7279\u5b9a\u9762\u5411\uff08\u5982 http_requests_total\uff0c\u7d66\u5b9a\u670d\u52d9\u5668\u9032\u7a0b\u8655\u7406\u7684 HTTP \u8acb\u6c42\u7e3d\u6578\uff09\u3002 \u6a19\u7c64 \u5141\u8a31\u60a8\u5c07\u6307\u6a19\u5283\u5206\u70ba\u5b50\u7dad\u5ea6\uff08\u4f8b\u5982 method=\"GET\" \u8207 method=\"POST\" \u544a\u8a34\u60a8\u8655\u7406\u4e86\u6bcf\u7a2e HTTP \u65b9\u6cd5\u985e\u578b\u7684\u8acb\u6c42\u6578\uff09\u3002\u6a19\u7c64\u53ef\u4ee5\u6709\u4e0d\u540c\u7684\u4f86\u6e90\uff1a\u4f8b\u5982\uff0c\u6aa2\u6e2c\u7684\u76ee\u6a19\u672c\u8eab\u53ef\u80fd\u6703\u516c\u958b\u5df2\u88ab\u4e00\u7d44\u6a19\u7c64\u62c6\u5206\u7684\u6307\u6a19\uff0c\u6216\u8005 Prometheus \u670d\u52d9\u5668\u53ef\u80fd\u6703\u5c07\u76ee\u6a19\u6a19\u7c64\u9644\u52a0\u5230\u6536\u96c6\u7684\u7cfb\u5217\u4e2d\uff0c\u4ee5\u8b58\u5225\u5b83\u5011\u7684\u4f86\u6e90\u3002 \u69cb\u6210\u6642\u9593\u5e8f\u5217\u6a19\u8b58\u7b26\u7684\u6307\u6a19\u540d\u7a31\u548c\u6a19\u7c64\u5728 Prometheus \u7684 TSDB \u4e2d\u5efa\u7acb\u7d22\u5f15\uff0c\u7528\u65bc\u5728\u67e5\u8a62\u6578\u64da\u6642\u67e5\u627e\u6642\u9593\u5e8f\u5217\u6578\u64da\u3002","title":"\u6642\u9593\u7cfb\u5217\u6a19\u8b58\u7b26"},{"location":"prometheus/prometheus/overview/#_6","text":"\u6a23\u672c\u5f62\u6210\u4e00\u500b\u7cfb\u5217\u7684\u5927\u91cf\u6578\u64da\uff0c\u4e26\u96a8\u8457\u6642\u9593\u7684\u63a8\u79fb\u9644\u52a0\u5230\u4e00\u500b\u7cfb\u5217\u7684\u7d22\u5f15\uff1a \u6642\u9593\u6233 \u662f\u6beb\u79d2\u7cbe\u5ea6\u7684 64 \u4f4d\u6574\u6578\u3002 \u6a23\u672c\u503c \u662f 64 \u4f4d\u6d6e\u9ede\u6578\uff08\u5141\u8a31\u6574\u6578\u7cbe\u5ea6\u9ad8\u9054 2^53\uff09\u3002","title":"\u6642\u9593\u7cfb\u5217\u63a1\u6a23"},{"location":"prometheus/prometheus/overview/#_7","text":"\u60f3\u8981\u516c\u958b Prometheus \u6307\u6a19\u7684\u670d\u52d9\u53ea\u9700\u8981\u516c\u958b\u4e00\u500b HTTP \u7aef\u9ede\uff08\u901a\u5e38\u5728 /metrics \uff09\uff0c\u8a72\u7aef\u9ede\u4ee5 Prometheus \u7684\u57fa\u65bc\u6587\u672c\u7684\u5c55\u793a\u683c\u5f0f\u63d0\u4f9b\u6307\u6a19\u3002\u9019\u7a2e\u7aef\u9ede\u7684\u8f38\u51fa\u662f\u4eba\u985e\u53ef\u8b80\u7684\uff0c\u6700\u7c21\u55ae\u7684\u5f62\u5f0f\u5982\u4e0b\u6240\u793a\uff1a \u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u7aef\u9ede\u516c\u958b\u4e86\u4e00\u500b HTTP \u8acb\u6c42\u8a08\u6578\u5668\uff0c\u8a72\u8a08\u6578\u5668\u7531\u97ff\u61c9\u72c0\u614b\u4ee3\u78bc\u4ee5\u53ca\u76ee\u6a19\u9032\u7a0b\u7684\u6253\u958b\u6587\u4ef6\u63cf\u8ff0\u7b26\u6578\u5206\u5272\u3002 \u8981\u5728\u700f\u89bd\u5668\u4e2d\u67e5\u770b\u4f86\u81ea\u201c\u771f\u5be6\u201d\u76ee\u6a19\u7684\u5be6\u6642\u6307\u6a19\uff0c\u8acb\u67e5\u770b\u6211\u5011\u904b\u884c\u7684 \u6f14\u793a\u670d\u52d9\u7684\u6307\u6a19\u7aef\u9ede \u3002 \u8a3b\u91cb\u7684 #HELP \u548c #TYPE \u884c\u63d0\u4f9b\u4e86\u4e00\u500b\u53ef\u9078\u7684\u6587\u6a94\u5b57\u7b26\u4e32\u548c\u95dc\u65bc\u5ea6\u91cf\u540d\u7a31\u7684\u5ea6\u91cf\u985e\u578b\u5143\u6578\u64da\u3002\u6b64\u683c\u5f0f\u4e2d\u7684\u6bcf\u500b\u672a\u8a3b\u91cb\u884c\u4ee3\u8868\u4e00\u500b\u7531 \u5ea6\u91cf\u540d\u7a31 \u3001 \u6a19\u7c64 \u548c \u63a1\u6a23\u503c \u7d44\u6210\u7684\u6a23\u672c\u8a18\u9304\u3002\u9019\u7a2e\u57fa\u65bc\u884c\u7684\u683c\u5f0f\u53ef\u4ee5\u8f15\u9b06\u5730\u5f9e\u7cfb\u7d71\u548c\u670d\u52d9\u4e2d\u516c\u958b\u6307\u6a19\u3002 \u67e5\u770b Prometheus \u6587\u6a94\u4ee5\u7372\u53d6\u6709\u95dc \u6307\u6a19\u50b3\u8f38\u683c\u5f0f \u7684\u5b8c\u6574\u8a73\u7d30\u4fe1\u606f\u3002 Prometheus \u6307\u6a19\u683c\u5f0f\u4e5f\u6b63\u5728\u6f14\u8b8a\u6210\u4e00\u500b\u540d\u70ba OpenMetrics \u7684\u958b\u653e\u6a19\u6e96\uff0cPrometheus \u4e5f\u652f\u6301\u8a72\u6a19\u6e96\u3002","title":"\u6307\u6a19\u50b3\u8f38\u683c\u5f0f"},{"location":"prometheus/prometheus/overview/#_8","text":"\u70ba\u4e86\u5229\u7528\u6536\u96c6\u5230\u7684\u6578\u64da\uff0cPrometheus \u5be6\u73fe\u4e86\u81ea\u5df1\u7684\u67e5\u8a62\u8a9e\u8a00 PromQL \u3002 PromQL \u662f\u4e00\u7a2e\u51fd\u6578\u5f0f\u8a9e\u8a00\uff0c\u7d93\u904e\u512a\u5316\uff0c\u53ef\u4ee5\u8a55\u4f30\u5c0d\u6642\u9593\u5e8f\u5217\u6578\u64da\u9032\u884c\u9748\u6d3b\u9ad8\u6548\u7684\u8a08\u7b97\u3002\u8207\u985e\u4f3c SQL \u7684\u8a9e\u8a00\u76f8\u6bd4\uff0c PromQL \u50c5\u7528\u65bc\u8b80\u53d6\u6578\u64da\uff0c\u800c\u4e0d\u7528\u65bc\u63d2\u5165\u3001\u66f4\u65b0\u6216\u522a\u9664\u6578\u64da\uff08\u9019\u767c\u751f\u5728\u67e5\u8a62\u5f15\u64ce\u4e4b\u5916\uff09\u3002 \u6211\u5011\u5c07\u5728\u9019\u88e1\u770b\u5e7e\u500b\u7c21\u55ae\u7684\u4f8b\u5b50\u3002 \u7d66\u5b9a\u4e00\u7d44\u5177\u6709\u5ea6\u91cf\u540d\u7a31 http_requests_total \u7684 HTTP \u8acb\u6c42\u8a08\u6578\u5668\u6642\u9593\u5e8f\u5217\u3001\u4e00\u500b\u6307\u793a\u97ff\u61c9\u72c0\u614b\u4ee3\u78bc\u7684\u72c0\u614b\u6a19\u7c64\u548c\u4e00\u500b\u6307\u793a HTTP \u8def\u5f91\u7684\u8def\u5f91\u6a19\u7c64\uff0c\u4ee5\u4e0b\u67e5\u8a62\u9078\u64c7\u6240\u6709\u5df2\u8655\u7406 HTTP \u8acb\u6c42\u7684\u7e3d\u6578\uff0c\u7d50\u679c\u70ba 500 \u72c0\u614b\u78bc\uff1a http_requests_total { status = \" 500 \"} \u7531\u65bc\u7d55\u5c0d\u8a08\u6578\u5f88\u5c11\u6709\u7528\uff0c\u4ee5\u4e0b\u67e5\u8a62\u6703\u544a\u8a34\u60a8\u6bcf\u500b\u9078\u5b9a\u8a08\u6578\u5668\u5e8f\u5217\u7684\u6bcf\u79d2\u589e\u9577\u7387\uff0c\u5373 5 \u5206\u9418\u7a97\u53e3\u5167\u7684\u5e73\u5747\u503c\uff1a rate ( http_requests_total { status = \" 500 \"}[ 5m ] ) \u4e26\u4e14\u60a8\u53ef\u4ee5\u8a08\u7b97\u5404\u7a2e per-path status=\"500\" \u932f\u8aa4\u7387\u8207\u76f8\u540c HTTP \u8def\u5f91\u7684\u7e3d\u8acb\u6c42\u7387\u7684\u6bd4\u7387\uff0c\u5982\u4e0b\u6240\u793a\uff1a sum by ( path ) ( rate ( http_requests_total { status = \" 500 \"}[ 5m ] )) / sum by ( path ) ( rate ( http_requests_total [ 5m ] )) \u60a8\u9084\u53ef\u4ee5\u50c5\u9078\u64c7\u5927\u65bc 5% \u7684\u6bcf\u689d\u8def\u5f91\u932f\u8aa4\u7387\u6bd4\u7387\uff1a sum by ( path ) ( rate ( http_requests_total { status = \" 500 \"}[ 5m ] )) / sum by ( path ) ( rate ( http_requests_total [ 5m ] )) * 100 > 5 \u9019\u4e9b\u662f\u60a8\u5c07\u5728 PromQL \u4e2d\u770b\u5230\u7684\u4e00\u4e9b\u66f4\u5e38\u898b\u7684\u7d50\u69cb\uff0c\u4f46\u8a72\u8a9e\u8a00\u5177\u6709\u66f4\u591a\u7684\u7279\u6027\u548c\u529f\u80fd\u3002","title":"\u67e5\u8a62\u8a9e\u8a00"},{"location":"prometheus/prometheus/overview/#_9","text":"Prometheus \u5c07\u6642\u9593\u5e8f\u5217\u6578\u64da\u7684\u6536\u96c6\u548c\u8655\u7406\u8207\u4e3b\u52d5\u8b66\u5831\u7cfb\u7d71\u96c6\u6210\u5728\u4e00\u8d77\u3002\u5b83\u7684\u7406\u5ff5\u662f\u5728\u55ae\u500b\u6578\u64da\u6a21\u578b\u4e2d\u6536\u96c6\u76e1\u53ef\u80fd\u591a\u7684\u95dc\u65bc\u60a8\u7684\u7cfb\u7d71\u7684\u6578\u64da\uff0c\u4ee5\u4fbf\u60a8\u53ef\u4ee5\u5728\u5176\u4e0a\u88fd\u5b9a\u96c6\u6210\u67e5\u8a62\u3002\u7528\u65bc\u81e8\u6642\u67e5\u8a62\u548c\u5100\u8868\u677f\u7684\u67e5\u8a62\u8a9e\u8a00\u4e5f\u7528\u65bc\u5b9a\u7fa9\u8b66\u5831\u898f\u5247\u3002\u9019\u8207 Nagios \u7b49\u6545\u969c\u6aa2\u6e2c\u7cfb\u7d71\uff08\u904b\u884c\u5b9a\u671f\u6aa2\u67e5\u8173\u672c\u4e26\u4fdd\u7559\u5f88\u5c11\u7684\u6b77\u53f2\u6578\u64da\uff09\u8207\u88ab\u52d5\u5b58\u5132\u6307\u6a19\u7684\u7368\u7acb\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\u4e4b\u9593\u7684\u6b77\u53f2\u5206\u6b67\u5f62\u6210\u9bae\u660e\u5c0d\u6bd4\u3002 \u4f8b\u5982\uff0c\u4ee5\u4e0b\u8b66\u5831\u898f\u5247\uff08\u4f5c\u70ba\u898f\u5247\u914d\u7f6e\u6587\u4ef6\u7684\u4e00\u90e8\u5206\u52a0\u8f09\u5230 Prometheus \u4e2d\uff09\u6703\u5728\u5c0e\u81f4 500 \u72c0\u614b\u4ee3\u78bc\u7684 HTTP \u8acb\u6c42\u6578\u91cf\u8d85\u904e\u7d66\u5b9a\u8def\u5f91\u7e3d\u6d41\u91cf\u7684 5% \u6642\u5411\u60a8\u767c\u51fa\u8b66\u5831\uff1a alert : Many500Errors # This is the PromQL expression that forms the \"heart\" of the alerting rule. expr : | ( sum by ( path ) ( rate ( http_requests_total { status = \" 500 \"}[ 5m ] )) / sum by ( path ) ( rate ( http_requests_total [ 5m ] )) ) * 100 > 5 for : 5m labels : severity : \" critical \" annotations : summary : \" Many 500 errors for path {{$labels.path}} ({{$value}}%) \" expr \u5b57\u6bb5\u4e2d\u7684 PromQL \u8868\u9054\u5f0f\u69cb\u6210\u8b66\u5831\u898f\u5247\u7684\u6838\u5fc3\uff0c\u800c\u5176\u4ed6\u57fa\u65bc YAML \u7684\u914d\u7f6e\u9078\u9805\u5141\u8a31\u60a8\u63a7\u5236\u8b66\u5831\u5143\u6578\u64da\u3001\u8def\u7531\u6a19\u7c64\u7b49\u3002\u9019\u53ef\u4ee5\u6839\u64da\u6536\u96c6\u7684\u6578\u64da\u9032\u884c\u7cbe\u78ba\u548c\u6e96\u78ba\u7684\u8b66\u5831\u3002","title":"\u96c6\u6210\u8b66\u5831"},{"location":"prometheus/prometheus/overview/#_10","text":"\u73fe\u4ee3\u52d5\u614b IT \u74b0\u5883\u70ba\u76e3\u63a7\u7cfb\u7d71\u5e36\u4f86\u4e86\u65b0\u7684\u6311\u6230\uff1a \u96f2\u63d0\u4f9b\u5546\u4e0a\u7684\u6309\u9700 VM \u53ef\u6839\u64da\u9700\u8981\u9032\u884c\u64f4\u5c55\u548c\u7e2e\u6e1b \u670d\u52d9\u5be6\u4f8b\u7531\u5bb9\u5668\u7de8\u6392\u5668\uff08\u4f8b\u5982 Kubernetes\u3001Docker Swarm \u6216 Mesos\uff09\u52d5\u614b\u8abf\u5ea6\u5230\u4e3b\u6a5f\u4e0a \u5fae\u670d\u52d9\u7684\u8da8\u52e2\u5c0e\u81f4\u8d8a\u4f86\u8d8a\u591a\u7684\u55ae\u500b\u670d\u52d9\u9700\u8981\u904b\u884c\u548c\u76e3\u63a7 \u554f\u984c\u51fa\u73fe\u4e86\uff1a\u76e3\u63a7\u7cfb\u7d71\u5982\u4f55\u4ecd\u7136\u80fd\u5920\u7406\u89e3\u9019\u500b\u52d5\u614b\u7684\u4e16\u754c\uff1f\u5b83\u5982\u4f55\u77e5\u9053\u7576\u524d\u61c9\u8a72\u5b58\u5728\u54ea\u4e9b\u6a5f\u5668\u6216\u670d\u52d9\u5be6\u4f8b\uff0c\u5b83\u5011\u7684\u8eab\u4efd\u662f\u4ec0\u9ebc\uff0c\u4ee5\u53ca\u5982\u4f55\u5f9e\u4e2d\u7372\u53d6\u6307\u6a19\uff1f\u64cd\u4f5c\u54e1\u4e0d\u518d\u53ef\u80fd\u975c\u614b\u914d\u7f6e\u6b64\u4fe1\u606f\uff0c\u56e0\u70ba\u5b83\u592a\u8907\u96dc\u4e14\u8b8a\u5316\u592a\u5feb\u3002 \u70ba\u4e86\u89e3\u6c7a\u9019\u500b\u554f\u984c\uff0cPrometheus \u8207\u57fa\u790e\u8a2d\u65bd\u4e2d\u7684\u5e38\u898b\u670d\u52d9\u767c\u73fe\u63d0\u4f9b\u7a0b\u5e8f\u96c6\u6210\uff0c\u4ee5\u5f9e\u5916\u90e8\u4e8b\u5be6\u4f86\u6e90\u767c\u73fe\u4e26\u6301\u7e8c\u66f4\u65b0\u5176\u76e3\u63a7\u76ee\u6a19\uff1a Prometheus \u652f\u6301\u591a\u7a2e\u5167\u7f6e\u670d\u52d9\u767c\u73fe\u6a5f\u5236\uff0c\u4f8b\u5982\uff1a \u5728\u96f2\u63d0\u4f9b\u5546\uff08AWS\u3001Azure\u3001\u8c37\u6b4c\u2026\u2026\uff09\u4e0a\u767c\u73fe\u865b\u64ec\u6a5f\uff0c \u5728\u96c6\u7fa4\u7de8\u6392\u5668\uff08Kubernetes\u3001Marathon \u7b49\uff09\u4e0a\u767c\u73fe\u670d\u52d9\u5be6\u4f8b\uff0c \u4f7f\u7528\u901a\u7528\u67e5\u627e\u65b9\u6cd5\uff08\u5982 DNS\u3001Consul\u3001Zookeeper \u6216\u81ea\u5b9a\u7fa9\u767c\u73fe\u6a5f\u5236\uff09\u767c\u73fe\u76ee\u6a19\u3002 Prometheus \u5c07\u670d\u52d9\u767c\u73fe\u7528\u65bc\u4e09\u500b\u4e0d\u540c\u4f46\u76f8\u95dc\u7684\u76ee\u7684\uff1a \u69cb\u5efa\u61c9\u8a72\u5b58\u5728\u54ea\u4e9b\u76ee\u6a19\u7684\u8996\u5716\uff08\u4ee5\u4fbf\u5b83\u53ef\u4ee5\u8a18\u9304\u4e26\u5728\u7f3a\u5c11\u76ee\u6a19\u6642\u767c\u51fa\u8b66\u5831\uff09\uff0c \u8981\u7372\u53d6\u6709\u95dc\u5982\u4f55\u901a\u904e HTTP \u5f9e\u76ee\u6a19\u4e2d\u63d0\u53d6\u6307\u6a19\u7684\u6280\u8853\u4fe1\u606f\uff0c \u4f7f\u7528\u6709\u95dc\u76ee\u6a19\u7684\u6a19\u8a18\u5143\u6578\u64da\u8c50\u5bcc\u5f9e\u76ee\u6a19\u6536\u96c6\u7684\u7cfb\u5217\u3002 \u901a\u904e\u9019\u7a2e\u65b9\u5f0f\uff0cPrometheus \u4f7f\u7528\u670d\u52d9\u767c\u73fe\u4f5c\u70ba\u4e8b\u5be6\u4f86\u6e90\u4f86\u53ef\u9760\u5730\u76e3\u63a7\u52d5\u614b\u74b0\u5883\uff0c\u540c\u6642\u6700\u5927\u9650\u5ea6\u5730\u6e1b\u5c11\u7ba1\u7406\u958b\u92b7\u3002","title":"\u670d\u52d9\u767c\u73fe\u96c6\u6210"},{"location":"prometheus/prometheus/overview/#_11","text":"Prometheus \u7684\u6838\u5fc3\u662f\u6982\u5ff5\u4e0a\u7c21\u55ae\u4e14\u6613\u65bc\u64cd\u4f5c\u3002","title":"\u64cd\u4f5c\u7c21\u55ae"},{"location":"prometheus/prometheus/overview/#golang","text":"Prometheus \u662f\u7528 Go \u7de8\u5beb\u7684\uff0c\u975c\u614b\u767c\u5e03\u4e8c\u9032\u88fd\u6587\u4ef6\u53ef\u4ee5\u5728\u4e0d\u4f9d\u8cf4\u65bc\u5916\u90e8\u904b\u884c\u6642\uff08\u5982 JVM\uff09\u3001\u89e3\u91cb\u5668\uff08\u5982 Python \u6216 Ruby\uff09\u6216\u5171\u4eab\u7cfb\u7d71\u5eab\u7684\u60c5\u6cc1\u4e0b\u9032\u884c\u90e8\u7f72\u3002","title":"\u4f7f\u7528 Golang \u7a0b\u5f0f\u8a9e\u8a00\u64b0\u5beb"},{"location":"prometheus/prometheus/overview/#_12","text":"\u6bcf\u500b Prometheus \u670d\u52d9\u5668\u7368\u7acb\u65bc\u4efb\u4f55\u5176\u4ed6 Prometheus \u670d\u52d9\u5668\u6536\u96c6\u6578\u64da\u4e26\u8a55\u4f30\u8b66\u5831\u898f\u5247\uff0c\u4e26\u4e14\u50c5\u5728\u672c\u5730\u5b58\u5132\u6578\u64da\uff0c\u800c\u7121\u9700\u7dca\u5bc6\u7684\u96c6\u7fa4\u6216\u8907\u5236\u3002","title":"\u7368\u7acb\u7bc0\u9ede"},{"location":"prometheus/prometheus/overview/#ha","text":"\u8981\u70ba\u8b66\u5831\u5275\u5efa\u9ad8\u53ef\u7528\u6027 (HA) \u8a2d\u7f6e\uff0c\u60a8\u4ecd\u7136\u53ef\u4ee5\u904b\u884c\u5169\u500b\u914d\u7f6e\u76f8\u540c\u7684 Prometheus \u670d\u52d9\u5668\u4f86\u8a08\u7b97\u76f8\u540c\u7684\u8b66\u5831\uff08Alertmanager \u5c07\u522a\u9664\u91cd\u8907\u7684\u901a\u77e5\uff09\uff1a \u7576\u7136\uff0cPrometheus \u7684\u5927\u898f\u6a21\u90e8\u7f72\u6216\u6709\u7279\u6b8a\u9700\u6c42\u7684\u8a2d\u7f6e\u4ecd\u7136\u6703\u8b8a\u5f97\u8907\u96dc\u3002 Prometheus \u9084\u63d0\u4f9b\u63a5\u53e3\u4f86\u89e3\u6c7a\u5176\u5916\u90e8\u7684\u4e00\u4e9b\u9650\u5236\uff0c\u4f8b\u5982\u6301\u4e45\u7684\u9577\u671f\u5b58\u5132\u3002","title":"\u7c21\u55ae\u7684 HA \u8a2d\u7f6e"},{"location":"prometheus/prometheus/overview/#_13","text":"Prometheus \u9700\u8981\u80fd\u5920\u540c\u6642\u5f9e\u591a\u500b\u7cfb\u7d71\u548c\u670d\u52d9\u4e2d\u6536\u96c6\u8a73\u7d30\u7684\u7dad\u5ea6\u6578\u64da\u3002\u70ba\u6b64\uff0c\u7279\u5225\u662f\u5c0d\u4ee5\u4e0b\u7d44\u4ef6\u9032\u884c\u4e86\u9ad8\u5ea6\u512a\u5316\uff1a \u6293\u53d6\u548c\u89e3\u6790\u50b3\u5165\u7684\u6307\u6a19\uff0c \u5beb\u5165\u548c\u8b80\u53d6\u6642\u9593\u5e8f\u5217\u6578\u64da\u5eab\uff0c \u6839\u64da TSDB \u6578\u64da\u8a55\u4f30 PromQL \u8868\u9054\u5f0f\u3002 \u6839\u64da\u7d93\u9a57\uff0c\u55ae\u500b\u5927\u578b Prometheus \u670d\u52d9\u5668\u6bcf\u79d2\u53ef\u4ee5\u651d\u53d6\u591a\u9054 100 \u842c\u500b\u6642\u9593\u5e8f\u5217\u6a23\u672c\uff0c\u4e26\u4f7f\u7528 1-2 \u500b\u5b57\u7bc0\u5728\u78c1\u76e4\u4e0a\u5b58\u5132\u6bcf\u500b\u6a23\u672c\u3002\u5b83\u53ef\u4ee5\u4e00\u6b21\u8655\u7406\u6578\u767e\u842c\u4e26\u767c\u6d3b\u52d5\uff08\u5b58\u5728\u65bc\u6240\u6709\u76ee\u6a19\u7684\u4e00\u6b21\u6293\u53d6\u8fed\u4ee3\u4e2d\uff09\u6642\u9593\u5e8f\u5217\u3002","title":"\u9ad8\u6548\u5be6\u65bd"},{"location":"prometheus/prometheus/overview/#_14","text":"\u606d\u559c\uff01\u5728\u672c\u6b21\u57f9\u8a13\u4e2d\uff0c\u60a8\u5b78\u5230\u4e86\uff1a Prometheus \u95dc\u6ce8\u4ec0\u9ebc\u4ee5\u53ca\u5b83\u8a66\u5716\u4e0d\u505a\u7684\u4e8b\u60c5 Prometheus \u5982\u4f55\u5f9e\u76ee\u6a19\u6536\u96c6\u6642\u9593\u5e8f\u5217\u6578\u64da PromQL \u5982\u4f55\u57fa\u65bc\u6536\u96c6\u7684\u6578\u64da\u5be6\u73fe\u9748\u6d3b\u800c\u5f37\u5927\u7684\u67e5\u8a62 Prometheus \u5982\u4f55\u5c07\u6642\u9593\u5e8f\u5217\u6578\u64da\u6536\u96c6\u548c\u8b66\u5831\u806f\u7e6b\u5728\u4e00\u8d77 \u670d\u52d9\u767c\u73fe\u5982\u4f55\u5e6b\u52a9\u6293\u53d6\u548c\u6a19\u8a18\u76ee\u6a19 \u60a8\u73fe\u5728\u61c9\u8a72\u6e96\u5099\u597d\u89e3\u91cb Prometheus \u7684\u6838\u5fc3\u539f\u7406\u548c\u7279\u6027\uff0c\u4e26\u904b\u884c Prometheus \u4ee5\u5f9e\u76ee\u6a19\u4e2d\u6536\u96c6\u6578\u64da\u3002","title":"\u7d50\u8ad6"},{"location":"prometheus/promql/aggregate/","text":"\u805a\u5408 \u00b6 \u539f\u6587: \u805a\u5408 \u6211\u5011\u77e5\u9053 Prometheus \u7684\u6642\u9593\u5e8f\u5217\u6578\u64da\u662f\u591a\u7dad\u6578\u64da\u6a21\u578b\uff0c\u6211\u5011\u7d93\u5e38\u5c31\u6709\u6839\u64da\u5404\u500b\u7dad\u5ea6\u9032\u884c\u532f\u7e3d\u7684\u9700\u6c42\u3002 \u57fa\u65bc\u6a19\u7c64\u805a\u5408 \u00b6 \u4f8b\u5982\u6211\u5011\u60f3\u77e5\u9053\u6211\u5011\u7684 demo \u670d\u52d9\u6bcf\u79d2\u8655\u7406\u7684\u8acb\u6c42\u6578\uff0c\u90a3\u9ebc\u53ef\u4ee5\u5c07\u55ae\u500b\u7684\u901f\u7387\u76f8\u52a0\u5c31\u53ef\u4ee5\u3002 sum ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u7d50\u679c\uff1a \u4f46\u662f\u6211\u5011\u53ef\u4ee5\u770b\u5230\u7e6a\u88fd\u51fa\u4f86\u7684\u5716\u5f62\u6c92\u6709\u4fdd\u7559\u4efb\u4f55\u6a19\u7c64\u7dad\u5ea6\uff0c\u4e00\u822c\u4f86\u8aaa\u53ef\u80fd\u6211\u5011\u5e0c\u671b\u4fdd\u7559\u4e00\u4e9b\u7dad\u5ea6\uff0c\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u80fd\u66f4\u5e0c\u671b\u8a08\u7b97\u6bcf\u500b instance \u548c path \u7684\u8b8a\u5316\u7387\uff0c\u4f46\u4e26\u4e0d\u95dc\u5fc3\u55ae\u500b method \u6216\u8005 status \u7684\u7d50\u679c\uff0c\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u5728 sum() \u805a\u5408\u5668\u4e2d\u6dfb\u52a0\u4e00\u500b without() \u7684\u4fee\u98fe\u7b26\uff1a sum without ( method , status ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u4e0a\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\u76f8\u7576\u65bc\u7528 by() \u4fee\u98fe\u7b26\u4f86\u4fdd\u7559\u9700\u8981\u7684\u6a19\u7c64\u7684\u53d6\u53cd\u64cd\u4f5c\uff1a sum by ( instance , path , job ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u73fe\u5728\u5f97\u5230\u7684 sum \u7d50\u679c\u662f\u5c31\u662f\u6309\u7167 instance \u3001 path \u3001 job \u4f86\u9032\u884c\u5206\u7d44\u53bb\u805a\u5408\u7684\u4e86\uff1a \u9019\u88e1\u7684\u5206\u7d44\u6982\u5ff5\u548c SQL \u8a9e\u53e5\u4e2d\u7684\u5206\u7d44\u53bb\u805a\u5408\u5c31\u975e\u5e38\u985e\u4f3c\u4e86\u3002 \u9664\u4e86 sum() \u4e4b\u5916\uff0cPrometheus \u9084\u652f\u6301\u4e0b\u9762\u7684\u9019\u4e9b\u805a\u5408\u5668\uff1a sum()\uff1a\u5c0d\u805a\u5408\u5206\u7d44\u4e2d\u7684\u6240\u6709\u503c\u9032\u884c\u6c42\u548c min()\uff1a\u7372\u53d6\u4e00\u500b\u805a\u5408\u5206\u7d44\u4e2d\u6700\u5c0f\u503c max()\uff1a\u7372\u53d6\u4e00\u500b\u805a\u5408\u5206\u7d44\u4e2d\u6700\u5927\u503c avg()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u503c\u7684\u5e73\u5747\u503c stddev()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u6578\u503c\u7684\u6a19\u6e96\u5dee stdvar()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u6578\u503c\u7684\u6a19\u6e96\u65b9\u5dee count()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u5e8f\u5217\u7684\u7e3d\u6578 count_values()\uff1a\u8a08\u7b97\u5177\u6709\u76f8\u540c\u6a23\u672c\u503c\u7684\u5143\u7d20\u6578\u91cf bottomk(k, ...)\uff1a\u8a08\u7b97\u6309\u6a23\u672c\u503c\u8a08\u7b97\u7684\u6700\u5c0f\u7684 k \u500b\u5143\u7d20 topk(k\uff0c...)\uff1a\u8a08\u7b97\u6700\u5927\u7684 k \u500b\u5143\u7d20\u7684\u6a23\u672c\u503c quantile(\u03c6\uff0c...)\uff1a\u8a08\u7b97\u7dad\u5ea6\u4e0a\u7684 \u03c6-\u5206\u4f4d\u6578(0\u2264\u03c6\u22641) group(...)\uff1a\u53ea\u662f\u6309\u6a19\u7c64\u5206\u7d44\uff0c\u4e26\u5c07\u6a23\u672c\u503c\u8a2d\u70ba 1\u3002 !!! \"\u7df4\u7fd2\" 1.\u6309 job \u5206\u7d44\u805a\u5408\uff0c\u8a08\u7b97\u6211\u5011\u6b63\u5728\u76e3\u63a7\u7684\u6240\u6709\u9032\u7a0b\u7684\u7e3d\u5167\u5b58\u4f7f\u7528\u91cf\uff08 process_resident_memory_bytes \u6307\u6a19\uff09\uff1a ```promql sum by(job) (process_resident_memory_bytes) ``` 2.\u8a08\u7b97 `demo_cpu_usage_seconds_total` \u6307\u6a19\u6709\u591a\u5c11\u4e0d\u540c\u7684 CPU \u6a21\u5f0f\uff1a ```promql count (group by(mode) (demo_cpu_usage_seconds_total)) ``` 3.\u8a08\u7b97\u6bcf\u500b job \u4efb\u52d9\u548c\u6307\u6a19\u540d\u7a31\u7684\u6642\u9593\u5e8f\u5217\u6578\u91cf\uff1a ```promql count by (job, __name__) ({__name__ != \"\"}) ``` \u57fa\u65bc\u6642\u9593\u805a\u5408 \u00b6 \u524d\u9762\u6211\u5011\u5df2\u7d93\u5b78\u7fd2\u77ad\u5982\u4f55\u4f7f\u7528 sum() \u3001 avg() \u548c\u76f8\u95dc\u7684\u805a\u5408\u904b\u7b97\u7b26\u5f9e\u6a19\u7c64\u7dad\u5ea6\u9032\u884c\u805a\u5408\uff0c\u9019\u4e9b\u904b\u7b97\u7b26\u5728\u4e00\u500b\u6642\u9593\u5167\u5c0d\u591a\u500b\u5e8f\u5217\u9032\u884c\u805a\u5408\uff0c\u4f46\u662f\u6709\u6642\u5019\u6211\u5011\u53ef\u80fd\u60f3\u5728\u6bcf\u500b\u5e8f\u5217\u4e2d\u6309\u6642\u9593\u9032\u884c\u805a\u5408\uff0c\u4f8b\u5982\uff0c\u4f7f\u5c16\u92b3\u7684\u66f2\u7dda\u66f4\u5e73\u6ed1\uff0c\u6216\u6df1\u5165\u4e86\u89e3\u4e00\u500b\u5e8f\u5217\u5728\u4e00\u6bb5\u6642\u9593\u5167\u7684\u6700\u5927\u503c\u3002 \u70ba\u4e86\u57fa\u65bc\u6642\u9593\u4f86\u8a08\u7b97\u9019\u4e9b\u805a\u5408\uff0cPromQL \u63d0\u4f9b\u4e86\u4e00\u4e9b\u8207\u6a19\u7c64\u805a\u5408\u904b\u7b97\u7b26\u985e\u4f3c\u7684\u51fd\u6578\uff0c\u4f46\u662f\u5728\u9019\u4e9b\u51fd\u6578\u540d\u524d\u9762\u9644\u52a0\u4e86 _over_time() \uff1a avg_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u5e73\u5747\u503c\u3002 min_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6700\u5c0f\u503c\u3002 max_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6700\u5927\u503c\u3002 sum_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6c42\u548c\u3002 count_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6a23\u672c\u6578\u64da\u500b\u6578\u3002 quantile_over_time(scalar, range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6a23\u672c\u6578\u64da\u503c\u5206\u4f4d\u6578\u3002 stddev_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u7e3d\u9ad4\u6a19\u6e96\u5dee\u3002 stdvar_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u7e3d\u9ad4\u6a19\u6e96\u65b9\u5dee\u3002 \u4f8b\u5982\uff0c\u6211\u5011\u67e5\u8a62 demo \u5be6\u4f8b\u4e2d\u4f7f\u7528\u7684 goroutine \u7684\u539f\u59cb\u6578\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u67e5\u8a62\u8a9e\u53e5 go_goroutines{job=\"demo\"} \uff0c\u9019\u6703\u7522\u751f\u4e00\u4e9b\u5c16\u92b3\u7684\u5cf0\u503c\u5716\uff1a \u6211\u5011\u53ef\u4ee5\u901a\u904e\u5c0d\u5716\u4e2d\u7684\u6bcf\u4e00\u500b\u9ede\u4f86\u8a08\u7b97 10 \u5206\u9418\u5167\u7684 goroutines \u6578\u91cf\u9032\u884c\u5e73\u5747\u4f86\u4f7f\u5716\u5f62\u66f4\u52a0\u5e73\u6ed1\uff1a avg_over_time ( go_goroutines { job = \" demo \"}[ 10m ] ) \u9019\u500b\u67e5\u8a62\u7d50\u679c\u751f\u6210\u7684\u5716\u8868\u770b\u8d77\u4f86\u5c31\u5e73\u6ed1\u5f88\u591a\u4e86\uff1a \u6bd4\u5982\u8981\u67e5\u8a62 1 \u5c0f\u6642\u5167\u5167\u5b58\u7684\u4f7f\u7528\u7387\u5247\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a 100 * ( 1 - (( avg_over_time ( node_memory_MemFree_bytes [ 1h ] ) + avg_over_time ( node_memory_Cached_bytes [ 1h ] ) + avg_over_time ( node_memory_Buffers_bytes [ 1h ] )) / avg_over_time ( node_memory_MemTotal_bytes [ 1h ] ))) \u5b50\u67e5\u8a62 \u00b6 \u4e0a\u9762\u6240\u6709\u7684 _over_time() \u51fd\u6578\u90fd\u9700\u8981\u4e00\u500b\u7bc4\u570d\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\uff0c\u901a\u5e38\u60c5\u6cc1\u4e0b\u53ea\u80fd\u7531\u4e00\u500b\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\u4f86\u7522\u751f\uff0c\u6bd4\u5982 my_metric[5m] \u3002\u4f46\u662f\u5982\u679c\u73fe\u5728\u6211\u5011\u60f3\u4f7f\u7528\u4f8b\u5982 max_over_time() \u51fd\u6578\u4f86\u627e\u51fa\u904e\u53bb\u4e00\u5929\u4e2d demo \u670d\u52d9\u7684\u6700\u5927\u8acb\u6c42\u7387\u61c9\u8a72\u600e\u9ebc\u8fa6\u5462\uff1f \u8acb\u6c42\u7387 rate \u4e26\u4e0d\u662f\u4e00\u500b\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u9078\u64c7\u6642\u9593\u7684\u539f\u59cb\u503c\uff0c\u800c\u662f\u4e00\u500b\u8a08\u7b97\u5f8c\u5f97\u5230\u7684\u503c\uff0c\u6bd4\u5982\uff1a rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) \u5982\u679c\u6211\u5011\u76f4\u63a5\u5c07\u8868\u9054\u5f0f\u50b3\u5165 max_over_time() \u4e26\u9644\u52a0\u4e00\u5929\u7684\u6301\u7e8c\u6642\u9593\u67e5\u8a62\u7684\u8a71\u5c31\u6703\u7522\u751f\u932f\u8aa4\uff1a # ERROR! max_over_time ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) [ 1d ] ) \u5be6\u969b\u4e0a Prometheus \u662f\u652f\u6301\u5b50\u67e5\u8a62\u7684\uff0c\u5b83\u5141\u8a31\u6211\u5011\u9996\u5148\u4ee5\u6307\u5b9a\u7684\u6b65\u9577\u5728\u4e00\u6bb5\u6642\u9593\u5167\u57f7\u884c\u5167\u90e8\u67e5\u8a62\uff0c\u7136\u5f8c\u6839\u64da\u5b50\u67e5\u8a62\u7684\u7d50\u679c\u8a08\u7b97\u5916\u90e8\u67e5\u8a62\u3002\u5b50\u67e5\u8a62\u7684\u8868\u793a\u65b9\u5f0f\u985e\u4f3c\u65bc\u5340\u9593\u5411\u91cf\u7684\u6301\u7e8c\u6642\u9593\uff0c\u4f46\u9700\u8981\u5192\u865f\u5f8c\u6dfb\u52a0\u4e86\u4e00\u500b\u984d\u5916\u7684\u6b65\u9577\u53c3\u6578\uff1a [<duration>:<resolution>] \u3002 \u9019\u6a23\u6211\u5011\u53ef\u4ee5\u91cd\u5beb\u4e0a\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff0c\u544a\u8a34 Prometheus \u5728\u4e00\u5929\u7684\u7bc4\u570d\u5167\u8a55\u4f30\u5167\u90e8\u8868\u9054\u5f0f\uff0c\u6b65\u9577\u5206\u8fa8\u7387\u70ba 15s\uff1a max_over_time ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) [ 1d : 15s ] # \u57281\u5929\u5167\u660e\u78ba\u5730\u8a55\u4f30\u5167\u90e8\u67e5\u8a62\uff0c\u6b65\u9577\u70ba15\u79d2 ) \u4e5f\u53ef\u4ee5\u7701\u7565\u5192\u865f\u5f8c\u7684\u6b65\u9577\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0cPrometheus \u6703\u4f7f\u7528\u914d\u7f6e\u7684\u5168\u5c40 evaluation_interval \u53c3\u6578\u9032\u884c\u8a55\u4f30\u5167\u90e8\u8868\u9054\u5f0f\uff1a max_over_time ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) [ 1d : ] ) \u9019\u6a23\u5c31\u53ef\u4ee5\u5f97\u5230\u904e\u53bb\u4e00\u5929\u4e2d demo \u670d\u52d9\u6700\u5927\u7684 5 \u5206\u9418\u8acb\u6c42\u7387\uff0c\u4e0d\u904e\u5192\u865f\u4ecd\u7136\u662f\u9700\u8981\u7684\uff0c\u4ee5\u660e\u78ba\u8868\u793a\u904b\u884c\u5b50\u67e5\u8a62\u3002\u5b50\u67e5\u8a62\u9084\u5141\u8a31\u6dfb\u52a0\u4e00\u500b\u504f\u79fb\u4fee\u98fe\u7b26 offset \u4f86\u5c0d\u5167\u90e8\u67e5\u8a62\u9032\u884c\u6642\u9593\u504f\u79fb\uff0c\u985e\u4f3c\u65bc\u77ac\u6642\u548c\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\u3002 \u4f46\u662f\u4e5f\u9700\u8981\u6ce8\u610f\u9577\u6642\u9593\u8a08\u7b97\u5b50\u67e5\u8a62\u4ee3\u50f9\u4e5f\u662f\u975e\u5e38\u6602\u8cb4\u7684\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u8a18\u9304\u898f\u5247\uff08\u5f8c\u7e8c\u6703\u8b1b\u89e3\uff09\u9810\u5148\u8a18\u9304\u4e2d\u9593\u7684\u8868\u9054\u5f0f\uff0c\u800c\u4e0d\u662f\u6bcf\u6b21\u904b\u884c\u5916\u90e8\u67e5\u8a62\u6642\u90fd\u5be6\u6642\u8a08\u7b97\u5b83\u3002 \u7df4\u7fd2 \u8f38\u51fa\u904e\u53bb\u4e00\u5c0f\u6642\u5167 demo \u670d\u52d9\u7684\u6700\u5927 95 \u5206\u4f4d\u6578\u5ef6\u9072\u503c\uff081 \u5206\u9418\u5167\u5e73\u5747\uff09\uff0c\u6309 path \u5283\u5206\uff1a max_over_time ( histogram_quantile ( 0.95 , sum by ( le , path ) ( rate ( demo_api_request_duration_seconds_bucket [ 1m ] ) ) ) [ 1h : ] )","title":"\u805a\u5408"},{"location":"prometheus/promql/aggregate/#_1","text":"\u539f\u6587: \u805a\u5408 \u6211\u5011\u77e5\u9053 Prometheus \u7684\u6642\u9593\u5e8f\u5217\u6578\u64da\u662f\u591a\u7dad\u6578\u64da\u6a21\u578b\uff0c\u6211\u5011\u7d93\u5e38\u5c31\u6709\u6839\u64da\u5404\u500b\u7dad\u5ea6\u9032\u884c\u532f\u7e3d\u7684\u9700\u6c42\u3002","title":"\u805a\u5408"},{"location":"prometheus/promql/aggregate/#_2","text":"\u4f8b\u5982\u6211\u5011\u60f3\u77e5\u9053\u6211\u5011\u7684 demo \u670d\u52d9\u6bcf\u79d2\u8655\u7406\u7684\u8acb\u6c42\u6578\uff0c\u90a3\u9ebc\u53ef\u4ee5\u5c07\u55ae\u500b\u7684\u901f\u7387\u76f8\u52a0\u5c31\u53ef\u4ee5\u3002 sum ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u7d50\u679c\uff1a \u4f46\u662f\u6211\u5011\u53ef\u4ee5\u770b\u5230\u7e6a\u88fd\u51fa\u4f86\u7684\u5716\u5f62\u6c92\u6709\u4fdd\u7559\u4efb\u4f55\u6a19\u7c64\u7dad\u5ea6\uff0c\u4e00\u822c\u4f86\u8aaa\u53ef\u80fd\u6211\u5011\u5e0c\u671b\u4fdd\u7559\u4e00\u4e9b\u7dad\u5ea6\uff0c\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u80fd\u66f4\u5e0c\u671b\u8a08\u7b97\u6bcf\u500b instance \u548c path \u7684\u8b8a\u5316\u7387\uff0c\u4f46\u4e26\u4e0d\u95dc\u5fc3\u55ae\u500b method \u6216\u8005 status \u7684\u7d50\u679c\uff0c\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u5728 sum() \u805a\u5408\u5668\u4e2d\u6dfb\u52a0\u4e00\u500b without() \u7684\u4fee\u98fe\u7b26\uff1a sum without ( method , status ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u4e0a\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\u76f8\u7576\u65bc\u7528 by() \u4fee\u98fe\u7b26\u4f86\u4fdd\u7559\u9700\u8981\u7684\u6a19\u7c64\u7684\u53d6\u53cd\u64cd\u4f5c\uff1a sum by ( instance , path , job ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u73fe\u5728\u5f97\u5230\u7684 sum \u7d50\u679c\u662f\u5c31\u662f\u6309\u7167 instance \u3001 path \u3001 job \u4f86\u9032\u884c\u5206\u7d44\u53bb\u805a\u5408\u7684\u4e86\uff1a \u9019\u88e1\u7684\u5206\u7d44\u6982\u5ff5\u548c SQL \u8a9e\u53e5\u4e2d\u7684\u5206\u7d44\u53bb\u805a\u5408\u5c31\u975e\u5e38\u985e\u4f3c\u4e86\u3002 \u9664\u4e86 sum() \u4e4b\u5916\uff0cPrometheus \u9084\u652f\u6301\u4e0b\u9762\u7684\u9019\u4e9b\u805a\u5408\u5668\uff1a sum()\uff1a\u5c0d\u805a\u5408\u5206\u7d44\u4e2d\u7684\u6240\u6709\u503c\u9032\u884c\u6c42\u548c min()\uff1a\u7372\u53d6\u4e00\u500b\u805a\u5408\u5206\u7d44\u4e2d\u6700\u5c0f\u503c max()\uff1a\u7372\u53d6\u4e00\u500b\u805a\u5408\u5206\u7d44\u4e2d\u6700\u5927\u503c avg()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u503c\u7684\u5e73\u5747\u503c stddev()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u6578\u503c\u7684\u6a19\u6e96\u5dee stdvar()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u6578\u503c\u7684\u6a19\u6e96\u65b9\u5dee count()\uff1a\u8a08\u7b97\u805a\u5408\u5206\u7d44\u4e2d\u6240\u6709\u5e8f\u5217\u7684\u7e3d\u6578 count_values()\uff1a\u8a08\u7b97\u5177\u6709\u76f8\u540c\u6a23\u672c\u503c\u7684\u5143\u7d20\u6578\u91cf bottomk(k, ...)\uff1a\u8a08\u7b97\u6309\u6a23\u672c\u503c\u8a08\u7b97\u7684\u6700\u5c0f\u7684 k \u500b\u5143\u7d20 topk(k\uff0c...)\uff1a\u8a08\u7b97\u6700\u5927\u7684 k \u500b\u5143\u7d20\u7684\u6a23\u672c\u503c quantile(\u03c6\uff0c...)\uff1a\u8a08\u7b97\u7dad\u5ea6\u4e0a\u7684 \u03c6-\u5206\u4f4d\u6578(0\u2264\u03c6\u22641) group(...)\uff1a\u53ea\u662f\u6309\u6a19\u7c64\u5206\u7d44\uff0c\u4e26\u5c07\u6a23\u672c\u503c\u8a2d\u70ba 1\u3002 !!! \"\u7df4\u7fd2\" 1.\u6309 job \u5206\u7d44\u805a\u5408\uff0c\u8a08\u7b97\u6211\u5011\u6b63\u5728\u76e3\u63a7\u7684\u6240\u6709\u9032\u7a0b\u7684\u7e3d\u5167\u5b58\u4f7f\u7528\u91cf\uff08 process_resident_memory_bytes \u6307\u6a19\uff09\uff1a ```promql sum by(job) (process_resident_memory_bytes) ``` 2.\u8a08\u7b97 `demo_cpu_usage_seconds_total` \u6307\u6a19\u6709\u591a\u5c11\u4e0d\u540c\u7684 CPU \u6a21\u5f0f\uff1a ```promql count (group by(mode) (demo_cpu_usage_seconds_total)) ``` 3.\u8a08\u7b97\u6bcf\u500b job \u4efb\u52d9\u548c\u6307\u6a19\u540d\u7a31\u7684\u6642\u9593\u5e8f\u5217\u6578\u91cf\uff1a ```promql count by (job, __name__) ({__name__ != \"\"}) ```","title":"\u57fa\u65bc\u6a19\u7c64\u805a\u5408"},{"location":"prometheus/promql/aggregate/#_3","text":"\u524d\u9762\u6211\u5011\u5df2\u7d93\u5b78\u7fd2\u77ad\u5982\u4f55\u4f7f\u7528 sum() \u3001 avg() \u548c\u76f8\u95dc\u7684\u805a\u5408\u904b\u7b97\u7b26\u5f9e\u6a19\u7c64\u7dad\u5ea6\u9032\u884c\u805a\u5408\uff0c\u9019\u4e9b\u904b\u7b97\u7b26\u5728\u4e00\u500b\u6642\u9593\u5167\u5c0d\u591a\u500b\u5e8f\u5217\u9032\u884c\u805a\u5408\uff0c\u4f46\u662f\u6709\u6642\u5019\u6211\u5011\u53ef\u80fd\u60f3\u5728\u6bcf\u500b\u5e8f\u5217\u4e2d\u6309\u6642\u9593\u9032\u884c\u805a\u5408\uff0c\u4f8b\u5982\uff0c\u4f7f\u5c16\u92b3\u7684\u66f2\u7dda\u66f4\u5e73\u6ed1\uff0c\u6216\u6df1\u5165\u4e86\u89e3\u4e00\u500b\u5e8f\u5217\u5728\u4e00\u6bb5\u6642\u9593\u5167\u7684\u6700\u5927\u503c\u3002 \u70ba\u4e86\u57fa\u65bc\u6642\u9593\u4f86\u8a08\u7b97\u9019\u4e9b\u805a\u5408\uff0cPromQL \u63d0\u4f9b\u4e86\u4e00\u4e9b\u8207\u6a19\u7c64\u805a\u5408\u904b\u7b97\u7b26\u985e\u4f3c\u7684\u51fd\u6578\uff0c\u4f46\u662f\u5728\u9019\u4e9b\u51fd\u6578\u540d\u524d\u9762\u9644\u52a0\u4e86 _over_time() \uff1a avg_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u5e73\u5747\u503c\u3002 min_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6700\u5c0f\u503c\u3002 max_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6700\u5927\u503c\u3002 sum_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6c42\u548c\u3002 count_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6a23\u672c\u6578\u64da\u500b\u6578\u3002 quantile_over_time(scalar, range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u6a23\u672c\u6578\u64da\u503c\u5206\u4f4d\u6578\u3002 stddev_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u7e3d\u9ad4\u6a19\u6e96\u5dee\u3002 stdvar_over_time(range-vector) \uff1a\u5340\u9593\u5411\u91cf\u5167\u6bcf\u500b\u6307\u6a19\u7684\u7e3d\u9ad4\u6a19\u6e96\u65b9\u5dee\u3002 \u4f8b\u5982\uff0c\u6211\u5011\u67e5\u8a62 demo \u5be6\u4f8b\u4e2d\u4f7f\u7528\u7684 goroutine \u7684\u539f\u59cb\u6578\u91cf\uff0c\u53ef\u4ee5\u4f7f\u7528\u67e5\u8a62\u8a9e\u53e5 go_goroutines{job=\"demo\"} \uff0c\u9019\u6703\u7522\u751f\u4e00\u4e9b\u5c16\u92b3\u7684\u5cf0\u503c\u5716\uff1a \u6211\u5011\u53ef\u4ee5\u901a\u904e\u5c0d\u5716\u4e2d\u7684\u6bcf\u4e00\u500b\u9ede\u4f86\u8a08\u7b97 10 \u5206\u9418\u5167\u7684 goroutines \u6578\u91cf\u9032\u884c\u5e73\u5747\u4f86\u4f7f\u5716\u5f62\u66f4\u52a0\u5e73\u6ed1\uff1a avg_over_time ( go_goroutines { job = \" demo \"}[ 10m ] ) \u9019\u500b\u67e5\u8a62\u7d50\u679c\u751f\u6210\u7684\u5716\u8868\u770b\u8d77\u4f86\u5c31\u5e73\u6ed1\u5f88\u591a\u4e86\uff1a \u6bd4\u5982\u8981\u67e5\u8a62 1 \u5c0f\u6642\u5167\u5167\u5b58\u7684\u4f7f\u7528\u7387\u5247\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a 100 * ( 1 - (( avg_over_time ( node_memory_MemFree_bytes [ 1h ] ) + avg_over_time ( node_memory_Cached_bytes [ 1h ] ) + avg_over_time ( node_memory_Buffers_bytes [ 1h ] )) / avg_over_time ( node_memory_MemTotal_bytes [ 1h ] )))","title":"\u57fa\u65bc\u6642\u9593\u805a\u5408"},{"location":"prometheus/promql/aggregate/#_4","text":"\u4e0a\u9762\u6240\u6709\u7684 _over_time() \u51fd\u6578\u90fd\u9700\u8981\u4e00\u500b\u7bc4\u570d\u5411\u91cf\u4f5c\u70ba\u8f38\u5165\uff0c\u901a\u5e38\u60c5\u6cc1\u4e0b\u53ea\u80fd\u7531\u4e00\u500b\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\u4f86\u7522\u751f\uff0c\u6bd4\u5982 my_metric[5m] \u3002\u4f46\u662f\u5982\u679c\u73fe\u5728\u6211\u5011\u60f3\u4f7f\u7528\u4f8b\u5982 max_over_time() \u51fd\u6578\u4f86\u627e\u51fa\u904e\u53bb\u4e00\u5929\u4e2d demo \u670d\u52d9\u7684\u6700\u5927\u8acb\u6c42\u7387\u61c9\u8a72\u600e\u9ebc\u8fa6\u5462\uff1f \u8acb\u6c42\u7387 rate \u4e26\u4e0d\u662f\u4e00\u500b\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u9078\u64c7\u6642\u9593\u7684\u539f\u59cb\u503c\uff0c\u800c\u662f\u4e00\u500b\u8a08\u7b97\u5f8c\u5f97\u5230\u7684\u503c\uff0c\u6bd4\u5982\uff1a rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) \u5982\u679c\u6211\u5011\u76f4\u63a5\u5c07\u8868\u9054\u5f0f\u50b3\u5165 max_over_time() \u4e26\u9644\u52a0\u4e00\u5929\u7684\u6301\u7e8c\u6642\u9593\u67e5\u8a62\u7684\u8a71\u5c31\u6703\u7522\u751f\u932f\u8aa4\uff1a # ERROR! max_over_time ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) [ 1d ] ) \u5be6\u969b\u4e0a Prometheus \u662f\u652f\u6301\u5b50\u67e5\u8a62\u7684\uff0c\u5b83\u5141\u8a31\u6211\u5011\u9996\u5148\u4ee5\u6307\u5b9a\u7684\u6b65\u9577\u5728\u4e00\u6bb5\u6642\u9593\u5167\u57f7\u884c\u5167\u90e8\u67e5\u8a62\uff0c\u7136\u5f8c\u6839\u64da\u5b50\u67e5\u8a62\u7684\u7d50\u679c\u8a08\u7b97\u5916\u90e8\u67e5\u8a62\u3002\u5b50\u67e5\u8a62\u7684\u8868\u793a\u65b9\u5f0f\u985e\u4f3c\u65bc\u5340\u9593\u5411\u91cf\u7684\u6301\u7e8c\u6642\u9593\uff0c\u4f46\u9700\u8981\u5192\u865f\u5f8c\u6dfb\u52a0\u4e86\u4e00\u500b\u984d\u5916\u7684\u6b65\u9577\u53c3\u6578\uff1a [<duration>:<resolution>] \u3002 \u9019\u6a23\u6211\u5011\u53ef\u4ee5\u91cd\u5beb\u4e0a\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff0c\u544a\u8a34 Prometheus \u5728\u4e00\u5929\u7684\u7bc4\u570d\u5167\u8a55\u4f30\u5167\u90e8\u8868\u9054\u5f0f\uff0c\u6b65\u9577\u5206\u8fa8\u7387\u70ba 15s\uff1a max_over_time ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) [ 1d : 15s ] # \u57281\u5929\u5167\u660e\u78ba\u5730\u8a55\u4f30\u5167\u90e8\u67e5\u8a62\uff0c\u6b65\u9577\u70ba15\u79d2 ) \u4e5f\u53ef\u4ee5\u7701\u7565\u5192\u865f\u5f8c\u7684\u6b65\u9577\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0cPrometheus \u6703\u4f7f\u7528\u914d\u7f6e\u7684\u5168\u5c40 evaluation_interval \u53c3\u6578\u9032\u884c\u8a55\u4f30\u5167\u90e8\u8868\u9054\u5f0f\uff1a max_over_time ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) [ 1d : ] ) \u9019\u6a23\u5c31\u53ef\u4ee5\u5f97\u5230\u904e\u53bb\u4e00\u5929\u4e2d demo \u670d\u52d9\u6700\u5927\u7684 5 \u5206\u9418\u8acb\u6c42\u7387\uff0c\u4e0d\u904e\u5192\u865f\u4ecd\u7136\u662f\u9700\u8981\u7684\uff0c\u4ee5\u660e\u78ba\u8868\u793a\u904b\u884c\u5b50\u67e5\u8a62\u3002\u5b50\u67e5\u8a62\u9084\u5141\u8a31\u6dfb\u52a0\u4e00\u500b\u504f\u79fb\u4fee\u98fe\u7b26 offset \u4f86\u5c0d\u5167\u90e8\u67e5\u8a62\u9032\u884c\u6642\u9593\u504f\u79fb\uff0c\u985e\u4f3c\u65bc\u77ac\u6642\u548c\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\u3002 \u4f46\u662f\u4e5f\u9700\u8981\u6ce8\u610f\u9577\u6642\u9593\u8a08\u7b97\u5b50\u67e5\u8a62\u4ee3\u50f9\u4e5f\u662f\u975e\u5e38\u6602\u8cb4\u7684\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u8a18\u9304\u898f\u5247\uff08\u5f8c\u7e8c\u6703\u8b1b\u89e3\uff09\u9810\u5148\u8a18\u9304\u4e2d\u9593\u7684\u8868\u9054\u5f0f\uff0c\u800c\u4e0d\u662f\u6bcf\u6b21\u904b\u884c\u5916\u90e8\u67e5\u8a62\u6642\u90fd\u5be6\u6642\u8a08\u7b97\u5b83\u3002 \u7df4\u7fd2 \u8f38\u51fa\u904e\u53bb\u4e00\u5c0f\u6642\u5167 demo \u670d\u52d9\u7684\u6700\u5927 95 \u5206\u4f4d\u6578\u5ef6\u9072\u503c\uff081 \u5206\u9418\u5167\u5e73\u5747\uff09\uff0c\u6309 path \u5283\u5206\uff1a max_over_time ( histogram_quantile ( 0.95 , sum by ( le , path ) ( rate ( demo_api_request_duration_seconds_bucket [ 1m ] ) ) ) [ 1h : ] )","title":"\u5b50\u67e5\u8a62"},{"location":"prometheus/promql/check/","text":"\u6aa2\u6e2c \u00b6 \u539f\u6587: \u68c0\u6d4b \u672c\u7bc0\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u4f86\u6aa2\u67e5\u6211\u5011\u7684\u5be6\u4f8b\u6578\u64da\u6293\u53d6\u5065\u5eb7\u72c0\u6cc1\u3002 \u6aa2\u67e5\u6293\u53d6\u5be6\u4f8b \u00b6 \u6bcf\u7576 Prometheus \u6293\u53d6\u4e00\u500b\u76ee\u6a19\u6642\uff0c\u5b83\u90fd\u6703\u5b58\u5132\u4e00\u500b\u5408\u6210\u7684\u6a23\u672c\uff0c\u5176\u4e2d\u5305\u542b\u6307\u6a19\u540d\u7a31 up \u548c\u88ab\u6293\u53d6\u5be6\u4f8b\u7684 job \u548c instance \u6a19\u7c64\uff0c\u5982\u679c\u6293\u53d6\u6210\u529f\uff0c\u5247\u6a23\u672c\u7684\u503c\u88ab\u8a2d\u7f6e\u70ba 1 \uff0c\u5982\u679c\u6293\u53d6\u5931\u6557\uff0c\u5247\u8a2d\u7f6e\u70ba 0 \uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u901a\u904e\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8a62\u4f86\u7372\u53d6\u7576\u524d\u54ea\u4e9b\u5be6\u4f8b\u8655\u65bc\u6b63\u5e38\u6216\u639b\u6389\u7684\u72c0\u614b\uff1a up { job = \" demo \"} \u6b63\u5e38\u4e09\u500b\u6f14\u793a\u670d\u52d9\u5be6\u4f8b\u90fd\u8655\u65bc\u6b63\u5e38\u72c0\u614b\uff0c\u6240\u4ee5\u61c9\u8a72\u90fd\u70ba 1 \u3002\u5982\u679c\u6211\u5011\u5c07\u7b2c\u4e00\u500b\u5be6\u4f8b\u505c\u6389\uff0c\u91cd\u65b0\u67e5\u8a62\u5247\u7b2c\u4e00\u500b\u5be6\u4f8b\u7d50\u679c\u70ba 0 \uff1a \u5982\u679c\u53ea\u5e0c\u671b\u986f\u793a down \u6389\u7684\u5be6\u4f8b\uff0c\u53ef\u4ee5\u901a\u904e\u904e\u6ffe 0 \u503c\u4f86\u7372\u53d6\uff1a \u6216\u8005\u7372\u53d6\u639b\u6389\u5be6\u4f8b\u7684\u7e3d\u6578\uff1a count by ( job ) ( up { job = \" demo \"} == 0 ) \u4e00\u822c\u60c5\u6cc1\u4e0b\u9019\u7a2e\u985e\u578b\u7684\u67e5\u8a62\u6703\u7528\u65bc\u6307\u6a19\u6293\u53d6\u5065\u5eb7\u72c0\u614b\u5831\u8b66\u3002 Info \u6ce8\u610f\uff1a\u56e0\u70ba count() \u662f\u4e00\u500b\u805a\u5408\u904b\u7b97\u7b26\uff0c\u5b83\u671f\u671b\u6709\u4e00\u7d44\u7dad\u5ea6\u7684\u6642\u9593\u5e8f\u5217\u4f5c\u70ba\u5176\u8f38\u5165\uff0c\u4e26\u4e14\u53ef\u4ee5\u6839\u64da by \u6216 without \u5b50\u53e5\u5c07\u8f38\u51fa\u5e8f\u5217\u5206\u7d44\u3002\u4efb\u4f55\u8f38\u51fa\u7d44\u53ea\u80fd\u57fa\u65bc\u73fe\u6709\u7684\u8f38\u5165\u5e8f\u5217\uff0c\u5982\u679c\u6839\u672c\u6c92\u6709\u8f38\u5165\u5e8f\u5217\uff0c\u5c31\u4e0d\u6703\u7522\u751f\u8f38\u51fa\u3002 \u6aa2\u67e5\u5e8f\u5217\u6578\u64da \u00b6 \u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u53ea\u67e5\u770b\u5e8f\u5217\u7684\u6a23\u672c\u503c\u662f\u4e0d\u5920\u7684\uff0c\u6709\u6642\u9084\u9700\u8981\u6aa2\u6e2c\u662f\u5426\u5b58\u5728\u67d0\u4e9b\u5e8f\u5217\uff0c\u4e0a\u9762\u6211\u5011\u7528 up{job=\"demo\"} == 0 \u8a9e\u53e5\u4f86\u67e5\u8a62\u6240\u6709\u7121\u6cd5\u6293\u53d6\u7684\u6f14\u793a\u670d\u52d9\u5be6\u4f8b\uff0c\u4f46\u662f\u53ea\u6709\u5df2\u7d93\u88ab\u6293\u53d6\u7684\u76ee\u6a19\u624d\u6703\u88ab\u52a0\u4e0a up \u6307\u6a19\uff0c\u5982\u679c Prometheus \u90fd\u6c92\u6709\u6293\u53d6\u5230\u4efb\u4f55\u7684\u6f14\u793a\u670d\u52d9\u76ee\u6a19\u61c9\u8a72\u600e\u9ebc\u8fa6\u5462\uff1f \u6bd4\u5982\u5b83\u7684\u6293\u53d6\u914d\u7f6e\u51fa\u554f\u984c\u4e86\uff0c\u670d\u52d9\u767c\u73fe\u53ef\u80fd\u8fd4\u56de\u4e5f\u70ba\u7a7a\uff0c\u6216\u8005\u7531\u65bc Prometheus \u81ea\u8eab\u51fa\u4e86\u67d0\u4e9b\u554f\u984c\u3002 \u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c absent() \u51fd\u6578\u5c31\u975e\u5e38\u6709\u7528\u4e86\uff0c absent() \u5c07\u4e00\u500b\u77ac\u6642\u5411\u91cf\u4f5c\u70ba\u5176\u8f38\u5165\uff0c\u7576\u8f38\u5165\u5305\u542b\u5e8f\u5217\u6642\uff0c\u5c07\u8fd4\u56de\u4e00\u500b\u7a7a\u7d50\u679c\uff0c\u4e0d\u5305\u542b\u6642\u5c07\u8fd4\u56de\u55ae\u500b\u8f38\u51fa\u5e8f\u5217\uff0c\u800c\u4e14\u6a23\u672c\u503c\u70ba 1 \u3002 \u4f8b\u5982\uff0c\u67e5\u8a62\u8a9e\u53e5 absent(up{job=\"demo\"}) \u5c07\u5f97\u5230\u4e00\u500b\u7a7a\u7684\u8f38\u51fa\u7d50\u679c\uff0c\u5982\u679c\u6e2c\u8a66\u4e00\u500b\u6c92\u6709\u88ab\u6293\u53d6\u7684 job \u662f\u5426\u5b58\u5728\u7684\u6642\u5019\uff0c\u5c07\u5f97\u5230\u6a23\u672c\u503c 1 \u3002 \u9019\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u6aa2\u6e2c\u5e8f\u5217\u662f\u5426\u5b58\u5728\u7684\u60c5\u6cc1\u3002\u6b64\u5916\u9084\u6709\u4e00\u500b absent() \u7684\u8b8a\u7a2e\uff0c\u53eb\u505a absent_over_time() \uff0c\u5b83\u63a5\u53d7\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u544a\u8a34\u4f60\u5728\u8a72\u8f38\u5165\u5411\u91cf\u7684\u6574\u500b\u6642\u9593\u7bc4\u570d\u5167\u662f\u5426\u6709\u6a23\u672c\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u6aa2\u6e2c\u6307\u6a19 demo_api_request_duration_seconds_count \u662f\u5426\u5177\u6709 PUT \u7684 method \u6a19\u7c64\u7684\u5e8f\u5217\u3002 absent ( demo_api_request_duration_seconds_count { method = \" PUT \"} ) 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u7576\u904e\u53bb\u4e00\u5c0f\u6642\u5167\u4efb\u52d9 non-existent \u6c92\u6709\u8a18\u9304 up \u6307\u6a19\u6642\uff0c\u8a72\u67e5\u8a62\u8f38\u51fa\u4e00\u500b\u7cfb\u5217\u3002 absent_over_time ( up { job = \" non-existent \"}[ 1h ] ) https://wistron.webhook.office.com/webhookb2/c283298c-1460-4526-8c68-ab18a7691d41@de0795e0-d7c0-4eeb-b9bb-bc94d8980d3b/IncomingWebhook/d5524a67e4d34741a7123a55e5c6acf6/ddaec1ea-a778-4a54-a930-ba53127d7ee6","title":"\u6aa2\u6e2c"},{"location":"prometheus/promql/check/#_1","text":"\u539f\u6587: \u68c0\u6d4b \u672c\u7bc0\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u4f86\u6aa2\u67e5\u6211\u5011\u7684\u5be6\u4f8b\u6578\u64da\u6293\u53d6\u5065\u5eb7\u72c0\u6cc1\u3002","title":"\u6aa2\u6e2c"},{"location":"prometheus/promql/check/#_2","text":"\u6bcf\u7576 Prometheus \u6293\u53d6\u4e00\u500b\u76ee\u6a19\u6642\uff0c\u5b83\u90fd\u6703\u5b58\u5132\u4e00\u500b\u5408\u6210\u7684\u6a23\u672c\uff0c\u5176\u4e2d\u5305\u542b\u6307\u6a19\u540d\u7a31 up \u548c\u88ab\u6293\u53d6\u5be6\u4f8b\u7684 job \u548c instance \u6a19\u7c64\uff0c\u5982\u679c\u6293\u53d6\u6210\u529f\uff0c\u5247\u6a23\u672c\u7684\u503c\u88ab\u8a2d\u7f6e\u70ba 1 \uff0c\u5982\u679c\u6293\u53d6\u5931\u6557\uff0c\u5247\u8a2d\u7f6e\u70ba 0 \uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u901a\u904e\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8a62\u4f86\u7372\u53d6\u7576\u524d\u54ea\u4e9b\u5be6\u4f8b\u8655\u65bc\u6b63\u5e38\u6216\u639b\u6389\u7684\u72c0\u614b\uff1a up { job = \" demo \"} \u6b63\u5e38\u4e09\u500b\u6f14\u793a\u670d\u52d9\u5be6\u4f8b\u90fd\u8655\u65bc\u6b63\u5e38\u72c0\u614b\uff0c\u6240\u4ee5\u61c9\u8a72\u90fd\u70ba 1 \u3002\u5982\u679c\u6211\u5011\u5c07\u7b2c\u4e00\u500b\u5be6\u4f8b\u505c\u6389\uff0c\u91cd\u65b0\u67e5\u8a62\u5247\u7b2c\u4e00\u500b\u5be6\u4f8b\u7d50\u679c\u70ba 0 \uff1a \u5982\u679c\u53ea\u5e0c\u671b\u986f\u793a down \u6389\u7684\u5be6\u4f8b\uff0c\u53ef\u4ee5\u901a\u904e\u904e\u6ffe 0 \u503c\u4f86\u7372\u53d6\uff1a \u6216\u8005\u7372\u53d6\u639b\u6389\u5be6\u4f8b\u7684\u7e3d\u6578\uff1a count by ( job ) ( up { job = \" demo \"} == 0 ) \u4e00\u822c\u60c5\u6cc1\u4e0b\u9019\u7a2e\u985e\u578b\u7684\u67e5\u8a62\u6703\u7528\u65bc\u6307\u6a19\u6293\u53d6\u5065\u5eb7\u72c0\u614b\u5831\u8b66\u3002 Info \u6ce8\u610f\uff1a\u56e0\u70ba count() \u662f\u4e00\u500b\u805a\u5408\u904b\u7b97\u7b26\uff0c\u5b83\u671f\u671b\u6709\u4e00\u7d44\u7dad\u5ea6\u7684\u6642\u9593\u5e8f\u5217\u4f5c\u70ba\u5176\u8f38\u5165\uff0c\u4e26\u4e14\u53ef\u4ee5\u6839\u64da by \u6216 without \u5b50\u53e5\u5c07\u8f38\u51fa\u5e8f\u5217\u5206\u7d44\u3002\u4efb\u4f55\u8f38\u51fa\u7d44\u53ea\u80fd\u57fa\u65bc\u73fe\u6709\u7684\u8f38\u5165\u5e8f\u5217\uff0c\u5982\u679c\u6839\u672c\u6c92\u6709\u8f38\u5165\u5e8f\u5217\uff0c\u5c31\u4e0d\u6703\u7522\u751f\u8f38\u51fa\u3002","title":"\u6aa2\u67e5\u6293\u53d6\u5be6\u4f8b"},{"location":"prometheus/promql/check/#_3","text":"\u5728\u67d0\u4e9b\u60c5\u6cc1\u4e0b\uff0c\u53ea\u67e5\u770b\u5e8f\u5217\u7684\u6a23\u672c\u503c\u662f\u4e0d\u5920\u7684\uff0c\u6709\u6642\u9084\u9700\u8981\u6aa2\u6e2c\u662f\u5426\u5b58\u5728\u67d0\u4e9b\u5e8f\u5217\uff0c\u4e0a\u9762\u6211\u5011\u7528 up{job=\"demo\"} == 0 \u8a9e\u53e5\u4f86\u67e5\u8a62\u6240\u6709\u7121\u6cd5\u6293\u53d6\u7684\u6f14\u793a\u670d\u52d9\u5be6\u4f8b\uff0c\u4f46\u662f\u53ea\u6709\u5df2\u7d93\u88ab\u6293\u53d6\u7684\u76ee\u6a19\u624d\u6703\u88ab\u52a0\u4e0a up \u6307\u6a19\uff0c\u5982\u679c Prometheus \u90fd\u6c92\u6709\u6293\u53d6\u5230\u4efb\u4f55\u7684\u6f14\u793a\u670d\u52d9\u76ee\u6a19\u61c9\u8a72\u600e\u9ebc\u8fa6\u5462\uff1f \u6bd4\u5982\u5b83\u7684\u6293\u53d6\u914d\u7f6e\u51fa\u554f\u984c\u4e86\uff0c\u670d\u52d9\u767c\u73fe\u53ef\u80fd\u8fd4\u56de\u4e5f\u70ba\u7a7a\uff0c\u6216\u8005\u7531\u65bc Prometheus \u81ea\u8eab\u51fa\u4e86\u67d0\u4e9b\u554f\u984c\u3002 \u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c absent() \u51fd\u6578\u5c31\u975e\u5e38\u6709\u7528\u4e86\uff0c absent() \u5c07\u4e00\u500b\u77ac\u6642\u5411\u91cf\u4f5c\u70ba\u5176\u8f38\u5165\uff0c\u7576\u8f38\u5165\u5305\u542b\u5e8f\u5217\u6642\uff0c\u5c07\u8fd4\u56de\u4e00\u500b\u7a7a\u7d50\u679c\uff0c\u4e0d\u5305\u542b\u6642\u5c07\u8fd4\u56de\u55ae\u500b\u8f38\u51fa\u5e8f\u5217\uff0c\u800c\u4e14\u6a23\u672c\u503c\u70ba 1 \u3002 \u4f8b\u5982\uff0c\u67e5\u8a62\u8a9e\u53e5 absent(up{job=\"demo\"}) \u5c07\u5f97\u5230\u4e00\u500b\u7a7a\u7684\u8f38\u51fa\u7d50\u679c\uff0c\u5982\u679c\u6e2c\u8a66\u4e00\u500b\u6c92\u6709\u88ab\u6293\u53d6\u7684 job \u662f\u5426\u5b58\u5728\u7684\u6642\u5019\uff0c\u5c07\u5f97\u5230\u6a23\u672c\u503c 1 \u3002 \u9019\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u6aa2\u6e2c\u5e8f\u5217\u662f\u5426\u5b58\u5728\u7684\u60c5\u6cc1\u3002\u6b64\u5916\u9084\u6709\u4e00\u500b absent() \u7684\u8b8a\u7a2e\uff0c\u53eb\u505a absent_over_time() \uff0c\u5b83\u63a5\u53d7\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u544a\u8a34\u4f60\u5728\u8a72\u8f38\u5165\u5411\u91cf\u7684\u6574\u500b\u6642\u9593\u7bc4\u570d\u5167\u662f\u5426\u6709\u6a23\u672c\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u6aa2\u6e2c\u6307\u6a19 demo_api_request_duration_seconds_count \u662f\u5426\u5177\u6709 PUT \u7684 method \u6a19\u7c64\u7684\u5e8f\u5217\u3002 absent ( demo_api_request_duration_seconds_count { method = \" PUT \"} ) 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u7576\u904e\u53bb\u4e00\u5c0f\u6642\u5167\u4efb\u52d9 non-existent \u6c92\u6709\u8a18\u9304 up \u6307\u6a19\u6642\uff0c\u8a72\u67e5\u8a62\u8f38\u51fa\u4e00\u500b\u7cfb\u5217\u3002 absent_over_time ( up { job = \" non-existent \"}[ 1h ] ) https://wistron.webhook.office.com/webhookb2/c283298c-1460-4526-8c68-ab18a7691d41@de0795e0-d7c0-4eeb-b9bb-bc94d8980d3b/IncomingWebhook/d5524a67e4d34741a7123a55e5c6acf6/ddaec1ea-a778-4a54-a930-ba53127d7ee6","title":"\u6aa2\u67e5\u5e8f\u5217\u6578\u64da"},{"location":"prometheus/promql/compare/","text":"\u6578\u64da\u5c0d\u6bd4 \u00b6 \u539f\u6587: \u6570\u636e\u5bf9\u6bd4 \u6709\u7684\u6642\u5019\u6211\u5011\u53ef\u80fd\u9700\u8981\u53bb\u8a2a\u554f\u904e\u53bb\u7684\u6578\u64da\uff0c\u4e26\u548c\u7576\u524d\u6578\u64da\u9032\u884c\u5c0d\u6bd4\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u80fd\u60f3\u6bd4\u8f03\u4eca\u5929\u7684\u8acb\u6c42\u7387\u548c\u4e00\u5468\u524d\u7684\u8acb\u6c42\u7387\u4e4b\u9593\u7684\u5dee\u7570\u3002\u6211\u5011\u53ef\u4ee5\u5728\u4efb\u4f55\u5340\u9593\u5411\u91cf\u6216\u77ac\u6642\u5411\u91cf\u9078\u64c7\u5668\u4e0a\u9644\u52a0\u4e00\u500b\u504f\u79fb\u91cf offset<duration> \u7684\u4fee\u98fe\u7b26\uff08\u6bd4\u5982 my_metric offset 5m \u6216\u8005 my_metric[1m] offset 7d \uff09\u3002 \u8b93\u6211\u5011\u4f86\u770b\u4e00\u500b\u793a\u4f8b\uff0c\u5728\u6211\u5011\u7684 demo \u670d\u52d9\u4e2d\u66b4\u9732\u4e86\u4e00\u500b Counter \u6307\u6a19 demo_items_shipped_total \uff0c\u8a72\u6307\u6a19\u8ffd\u8e2a\u7269\u54c1\u7684\u904b\u8f38\u60c5\u6cc1\uff0c\u7528 5 \u5206\u9418\u4f86\u6a21\u64ec\"\u6bcf\u65e5\"\u6d41\u91cf\u9031\u671f\uff0c\u6240\u4ee5\u6211\u5011\u4e0d\u5fc5\u7b49\u5f85\u4e00\u6574\u5929\u624d\u80fd\u67e5\u770b\u8a72\u6642\u6bb5\u7684\u6578\u64da\u3002 \u6211\u5011\u53ea\u4f7f\u7528\u7b2c\u4e00\u500b\u6f14\u793a\u670d\u52d9\u5be6\u4f8b\u4f86\u6e2c\u8a66\u5373\u53ef\uff0c\u9996\u5148\u6211\u5011\u4f86\u770b\u770b\u5b83\u7684\u901f\u7387\uff1a rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) \u8a72\u670d\u52d9\u9084\u66b4\u9732\u4e86\u4e00\u500b 0 \u6216 1 \u7684\u5e03\u723e\u6307\u6a19\uff0c\u544a\u8a34\u6211\u5011\u73fe\u5728\u662f\u5426\u662f\u5047\u671f\uff1a \u5c07\u5047\u671f\u8207\u767c\u8ca8\u5546\u54c1\u7387\u9032\u884c\u6bd4\u8f03\uff0c\u6ce8\u610f\u5230\u7bc0\u5047\u65e5\u6642\u5b83\u6703\u6e1b\u5c11!\u6211\u5011\u53ef\u4ee5\u5617\u8a66\u5c07\u7576\u524d\u7684\u767c\u8ca8\u901f\u5ea6\u8207 7\"\u5929\"\uff087 * 5 \u5206\u9418\uff09\u524d\u7684\u901f\u5ea6\u9032\u884c\u6bd4\u8f03\uff0c\u770b\u770b\u662f\u5426\u6709\u4ec0\u9ebc\u4e0d\u6b63\u5e38\u7684\u60c5\u6cc1\u3002 rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) / rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] offset 35m ) \u901a\u5e38\u60c5\u6cc1\u4e0b\uff0c\u8a72\u6bd4\u7387\u7d04\u70ba 1\uff0c\u4f46\u5679\u5679\u5929\u6216\u524d\u4e00\u5929\u662f\u5047\u671f\u6642\uff0c\u6211\u5011\u5f97\u5230\u7684\u6bd4\u7387\u6bd4\u6b63\u5e38\u60c5\u6cc1\u4e0b\u8981\u7565\u4f4e\u6216\u9ad8\u3002 \u4f46\u662f\uff0c\u5982\u679c\u539f\u56e0\u53ea\u662f\u5047\u671f\uff0c\u6211\u5011\u60f3\u5ffd\u7565\u9019\u500b\u8f03\u4f4e\u6216\u8f03\u9ad8\u7684\u6bd4\u7387\u3002\u6211\u5011\u53ef\u4ee5\u5728\u904e\u53bb\u6216\u73fe\u5728\u662f\u5047\u671f\u7684\u6642\u5019\u904e\u6ffe\u6389\u9019\u500b\u6bd4\u7387\uff0c\u65b9\u6cd5\u662f\u9644\u52a0\u4e00\u500b unless \u96c6\u5408\u64cd\u4f5c\u7b26\u3002 ( rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) / rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] offset 35m ) ) unless ( demo_is_holiday == 1 # Is it currently a holiday? or demo_is_holiday offset 35m == 1 # Was it a holiday 7 \"days\" ago? ) \u6216\u8005\u53e6\u5916\u4e00\u7a2e\u65b9\u6cd5\uff0c\u6211\u5011\u53ea\u9700\u8981\u6bd4\u8f03\u4eca\u5929\u548c\u4e00\u5468\u524d\u662f\u5426\u6709\u76f8\u540c\u7684\u7bc0\u65e5\uff1a ( rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) / rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] offset 35m ) ) unless ( demo_is_holiday != demo_is_holiday offset 35m ) \u9019\u6a23\u6211\u5011\u5c31\u53ef\u4ee5\u904e\u6ffe\u6389\u7576\u524d\u6642\u9593\u6709\u5047\u671f\u6216\u904e\u53bb\u6709\u5047\u671f\u7684\u7d50\u679c\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u8a08\u7b97\u6bcf\u500b path \u8def\u5f91\u7684\u7e3d\u8acb\u6c42\u7387\u548c 35 \u5206\u9418\u524d\u7684\u5dee\u7570\u3002 sum by ( path ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) - sum by ( path ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] offset 35m ))","title":"\u6578\u64da\u5c0d\u6bd4"},{"location":"prometheus/promql/compare/#_1","text":"\u539f\u6587: \u6570\u636e\u5bf9\u6bd4 \u6709\u7684\u6642\u5019\u6211\u5011\u53ef\u80fd\u9700\u8981\u53bb\u8a2a\u554f\u904e\u53bb\u7684\u6578\u64da\uff0c\u4e26\u548c\u7576\u524d\u6578\u64da\u9032\u884c\u5c0d\u6bd4\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u80fd\u60f3\u6bd4\u8f03\u4eca\u5929\u7684\u8acb\u6c42\u7387\u548c\u4e00\u5468\u524d\u7684\u8acb\u6c42\u7387\u4e4b\u9593\u7684\u5dee\u7570\u3002\u6211\u5011\u53ef\u4ee5\u5728\u4efb\u4f55\u5340\u9593\u5411\u91cf\u6216\u77ac\u6642\u5411\u91cf\u9078\u64c7\u5668\u4e0a\u9644\u52a0\u4e00\u500b\u504f\u79fb\u91cf offset<duration> \u7684\u4fee\u98fe\u7b26\uff08\u6bd4\u5982 my_metric offset 5m \u6216\u8005 my_metric[1m] offset 7d \uff09\u3002 \u8b93\u6211\u5011\u4f86\u770b\u4e00\u500b\u793a\u4f8b\uff0c\u5728\u6211\u5011\u7684 demo \u670d\u52d9\u4e2d\u66b4\u9732\u4e86\u4e00\u500b Counter \u6307\u6a19 demo_items_shipped_total \uff0c\u8a72\u6307\u6a19\u8ffd\u8e2a\u7269\u54c1\u7684\u904b\u8f38\u60c5\u6cc1\uff0c\u7528 5 \u5206\u9418\u4f86\u6a21\u64ec\"\u6bcf\u65e5\"\u6d41\u91cf\u9031\u671f\uff0c\u6240\u4ee5\u6211\u5011\u4e0d\u5fc5\u7b49\u5f85\u4e00\u6574\u5929\u624d\u80fd\u67e5\u770b\u8a72\u6642\u6bb5\u7684\u6578\u64da\u3002 \u6211\u5011\u53ea\u4f7f\u7528\u7b2c\u4e00\u500b\u6f14\u793a\u670d\u52d9\u5be6\u4f8b\u4f86\u6e2c\u8a66\u5373\u53ef\uff0c\u9996\u5148\u6211\u5011\u4f86\u770b\u770b\u5b83\u7684\u901f\u7387\uff1a rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) \u8a72\u670d\u52d9\u9084\u66b4\u9732\u4e86\u4e00\u500b 0 \u6216 1 \u7684\u5e03\u723e\u6307\u6a19\uff0c\u544a\u8a34\u6211\u5011\u73fe\u5728\u662f\u5426\u662f\u5047\u671f\uff1a \u5c07\u5047\u671f\u8207\u767c\u8ca8\u5546\u54c1\u7387\u9032\u884c\u6bd4\u8f03\uff0c\u6ce8\u610f\u5230\u7bc0\u5047\u65e5\u6642\u5b83\u6703\u6e1b\u5c11!\u6211\u5011\u53ef\u4ee5\u5617\u8a66\u5c07\u7576\u524d\u7684\u767c\u8ca8\u901f\u5ea6\u8207 7\"\u5929\"\uff087 * 5 \u5206\u9418\uff09\u524d\u7684\u901f\u5ea6\u9032\u884c\u6bd4\u8f03\uff0c\u770b\u770b\u662f\u5426\u6709\u4ec0\u9ebc\u4e0d\u6b63\u5e38\u7684\u60c5\u6cc1\u3002 rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) / rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] offset 35m ) \u901a\u5e38\u60c5\u6cc1\u4e0b\uff0c\u8a72\u6bd4\u7387\u7d04\u70ba 1\uff0c\u4f46\u5679\u5679\u5929\u6216\u524d\u4e00\u5929\u662f\u5047\u671f\u6642\uff0c\u6211\u5011\u5f97\u5230\u7684\u6bd4\u7387\u6bd4\u6b63\u5e38\u60c5\u6cc1\u4e0b\u8981\u7565\u4f4e\u6216\u9ad8\u3002 \u4f46\u662f\uff0c\u5982\u679c\u539f\u56e0\u53ea\u662f\u5047\u671f\uff0c\u6211\u5011\u60f3\u5ffd\u7565\u9019\u500b\u8f03\u4f4e\u6216\u8f03\u9ad8\u7684\u6bd4\u7387\u3002\u6211\u5011\u53ef\u4ee5\u5728\u904e\u53bb\u6216\u73fe\u5728\u662f\u5047\u671f\u7684\u6642\u5019\u904e\u6ffe\u6389\u9019\u500b\u6bd4\u7387\uff0c\u65b9\u6cd5\u662f\u9644\u52a0\u4e00\u500b unless \u96c6\u5408\u64cd\u4f5c\u7b26\u3002 ( rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) / rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] offset 35m ) ) unless ( demo_is_holiday == 1 # Is it currently a holiday? or demo_is_holiday offset 35m == 1 # Was it a holiday 7 \"days\" ago? ) \u6216\u8005\u53e6\u5916\u4e00\u7a2e\u65b9\u6cd5\uff0c\u6211\u5011\u53ea\u9700\u8981\u6bd4\u8f03\u4eca\u5929\u548c\u4e00\u5468\u524d\u662f\u5426\u6709\u76f8\u540c\u7684\u7bc0\u65e5\uff1a ( rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] ) / rate ( demo_items_shipped_total { instance = \" demo-service-0:10000 \"}[ 1m ] offset 35m ) ) unless ( demo_is_holiday != demo_is_holiday offset 35m ) \u9019\u6a23\u6211\u5011\u5c31\u53ef\u4ee5\u904e\u6ffe\u6389\u7576\u524d\u6642\u9593\u6709\u5047\u671f\u6216\u904e\u53bb\u6709\u5047\u671f\u7684\u7d50\u679c\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u8a08\u7b97\u6bcf\u500b path \u8def\u5f91\u7684\u7e3d\u8acb\u6c42\u7387\u548c 35 \u5206\u9418\u524d\u7684\u5dee\u7570\u3002 sum by ( path ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) - sum by ( path ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] offset 35m ))","title":"\u6578\u64da\u5c0d\u6bd4"},{"location":"prometheus/promql/data-model/","text":"\u6578\u64da\u6a21\u578b \u00b6 \u539f\u6587: \u6570\u636e\u6a21\u578b \u5728\u958b\u59cb\u5b78\u7fd2 PromQL \u7684\u77e5\u8b58\u4e4b\u524d\uff0c\u6211\u5011\u5148\u91cd\u65b0\u4f86\u719f\u6089\u4e0b Prometheus \u7684\u6578\u64da\u6a21\u578b\u3002 \u6307\u6a19\u683c\u5f0f \u00b6 Prometheus \u6703\u5c07\u6240\u6709\u63a1\u96c6\u5230\u7684\u6a23\u672c\u6578\u64da\u4ee5 \u6642\u9593\u5e8f\u5217 \u7684\u65b9\u5f0f\u4fdd\u5b58\u5728\u5167\u5b58\u6578\u64da\u5eab\u4e2d\uff0c\u4e26\u4e14\u5b9a\u6642\u4fdd\u5b58\u5230\u786c\u76e4\u4e0a\u3002\u6642\u9593\u5e8f\u5217\u662f\u6309\u7167\u6642\u9593\u6233\u548c\u503c\u7684\u5e8f\u5217\u9806\u5e8f\u5b58\u653e\u7684\uff0c\u6211\u5011\u7a31\u4e4b\u70ba \u5411\u91cf (vector) \uff0c\u6bcf\u689d\u6642\u9593\u5e8f\u5217\u901a\u904e \u6307\u6a19\u540d\u7a31(metrics name) \u548c \u4e00\u7d44\u6a19\u7c64\u96c6(labelset) \u547d\u540d\u3002\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u5c07\u6642\u9593\u5e8f\u5217\u7406\u89e3\u70ba\u4e00\u500b\u4ee5\u6642\u9593\u70ba X \u8ef8\u7684\u6578\u5b57\u77e9\u9663\uff1a ^ \u2502 . . . . . . . . . . . . . . . . . . . node_cpu_seconds_total { cpu = \"cpu0\" ,mode = \"idle\" } \u2502 . . . . . . . . . . . . . . . . . . . node_cpu_seconds_total { cpu = \"cpu0\" ,mode = \"system\" } \u2502 . . . . . . . . . . . . . . . . . . node_load1 {} \u2502 . . . . . . . . . . . . . . . . . . v <------------------ \u6642\u9593 ----------------> \u5728\u6642\u9593\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e00\u500b\u6578\u64da\u9ede\u7a31\u70ba\u4e00\u500b\u6a23\u672c\uff08sample\uff09\uff0c\u6a23\u672c\u7531\u4ee5\u4e0b\u4e09\u90e8\u5206\u7d44\u6210\uff1a \u6307\u6a19 (metric) \uff1a\u6307\u6a19\u540d\u548c\u63cf\u8ff0\u7576\u524d\u6a23\u672c\u7279\u5fb5\u7684\u6a19\u7c64\u96c6\u5408 \u6642\u9593\u6233 (timestamp) \uff1a\u4e00\u500b\u7cbe\u78ba\u5230\u6beb\u79d2\u7684\u6642\u9593\u6233 \u6a23\u672c\u503c (value) \uff1a \u4e00\u500b float64 \u7684\u6d6e\u9ede\u578b\u6578\u64da\u8868\u793a\u7576\u524d\u6a23\u672c\u7684\u503c \u5982\u4e0b\u6240\u793a\uff1a <--------------- metric ---------------------><-timestamp -><-value-> http_request_total { status = \"200\" , method = \"GET\" } @1434417560938 = > 94355 http_request_total { status = \"200\" , method = \"GET\" } @1434417561287 = > 94334 http_request_total { status = \"404\" , method = \"GET\" } @1434417560938 = > 38473 http_request_total { status = \"404\" , method = \"GET\" } @1434417561287 = > 38544 http_request_total { status = \"200\" , method = \"POST\" } @1434417560938 = > 4748 http_request_total { status = \"200\" , method = \"POST\" } @1434417561287 = > 4785 \u5728\u5f62\u5f0f\u4e0a\uff0c\u6240\u6709\u7684\u6307\u6a19\u90fd\u901a\u904e\u5982\u4e0b\u683c\u5f0f\u8868\u793a\uff1a <metric name> { <label name> = <label value>, ... } \u6307\u6a19\u7684\u540d\u7a31 \u53ef\u4ee5\u53cd\u6620\u88ab\u76e3\u63a7\u6a23\u672c\u7684\u542b\u7fa9\uff08\u6bd4\u5982\uff0chttp*request_total \u8868\u793a\u7576\u524d\u7cfb\u7d71\u63a5\u6536\u5230\u7684 HTTP \u8acb\u6c42\u7e3d\u91cf\uff09\u3002\u6307\u6a19\u540d\u7a31\u53ea\u80fd\u7531 ASCII \u5b57\u7b26\u3001\u6578\u5b57\u3001\u4e0b\u5283\u7dda\u4ee5\u53ca\u5192\u865f\u7d44\u6210\u4e26\u5fc5\u9808\u7b26\u5408\u6b63\u5247\u8868\u9054\u5f0f [a-zA-Z*:]a-zA-Z0-9\\*:]\\* \u3002 \u6a19\u7c64 (label) \u53cd\u6620\u4e86\u7576\u524d\u6a23\u672c\u7684\u7279\u5fb5\u7dad\u5ea6\uff0c\u901a\u904e\u9019\u4e9b\u7dad\u5ea6 Prometheus \u53ef\u4ee5\u5c0d\u6a23\u672c\u6578\u64da\u9032\u884c\u904e\u6ffe\uff0c\u805a\u5408\u7b49\u3002\u6a19\u7c64\u7684\u540d\u7a31\u53ea\u80fd\u7531 ASCII \u5b57\u7b26\u3001\u6578\u5b57\u4ee5\u53ca\u4e0b\u5283\u7dda\u7d44\u6210\u4e26\u6eff\u8db3\u6b63\u5247\u8868\u9054\u5f0f [a-zA-Z_][a-zA-Z0-9_]* \u3002 Info \u6ce8\u610f\uff1a\u5728 TSDB \u5167\u90e8\uff0c\u6307\u6a19\u540d\u7a31\u4e5f\u53ea\u662f\u4e00\u500b\u7279\u6b8a\u7684\u6a19\u7c64\uff0c\u6a19\u7c64\u540d\u70ba name \uff0c\u7531\u65bc\u9019\u500b\u6a19\u7c64\u5728 PromQL \u4e2d\u96a8\u6642\u90fd\u6703\u4f7f\u7528\uff0c\u6240\u4ee5\u5728\u4f7f\u7528 PromQL \u67e5\u8a62\u7684\u6642\u5019\u5c31\u88ab\u55ae\u7368\u5beb\u5728\u4e86\u6a19\u7c64\u5217\u8868\u524d\u9762\u4e86\u3002\u53e6\u5916\u50cf method=\"\" \u9019\u6a23\u7684\u7a7a\u6a19\u7c64\u5728 Prometheus \u7a2e\u76f8\u7576\u65bc\u4e00\u500b\u4e0d\u5b58\u5728\u7684\u6a19\u7c64\uff0c\u5728 Prometheus \u4ee3\u78bc\u88e1\u9762\u662f\u660e\u78ba\u5730\u525d\u96e2\u4e86\u7a7a\u6a19\u7c64\u7684\uff0c\u4e26\u4e0d\u6703\u5b58\u5132\u5b83\u5011\u3002 \u6307\u6a19\u985e\u578b \u00b6 \u6bcf\u500b\u4e0d\u540c\u7684 metric_name \u548c label \u7d44\u5408\u90fd\u7a31\u70ba \u6642\u9593\u5e8f\u5217 \uff0c\u5728 Prometheus \u7684\u8868\u9054\u5f0f\u8a9e\u8a00\u4e2d\uff0c\u8868\u9054\u5f0f\u6216\u5b50\u8868\u9054\u5f0f\u5305\u62ec\u4ee5\u4e0b\u56db\u7a2e\u985e\u578b\u4e4b\u4e00\uff1a \u77ac\u6642\u5411\u91cf\uff08Instant vector\uff09 \uff1a\u4e00\u7d44\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u5305\u542b\u55ae\u500b\u6a23\u672c\uff0c\u5b83\u5011\u5171\u4eab\u76f8\u540c\u7684\u6642\u9593\u6233\u3002\u4e5f\u5c31\u662f\u8aaa\uff0c\u8868\u9054\u5f0f\u7684\u8fd4\u56de\u503c\u4e2d\u53ea\u6703\u5305\u542b\u8a72\u6642\u9593\u5e8f\u5217\u4e2d\u7684\u6700\u65b0\u7684\u4e00\u500b\u6a23\u672c\u503c\u3002\u800c\u76f8\u61c9\u7684\u9019\u6a23\u7684\u8868\u9054\u5f0f\u7a31\u4e4b\u70ba\u77ac\u6642\u5411\u91cf\u8868\u9054\u5f0f\u3002 \u5340\u9593\u5411\u91cf\uff08Range vector\uff09 \uff1a\u4e00\u7d44\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u5305\u542b\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u7684\u6a23\u672c\u6578\u64da\uff0c\u9019\u4e9b\u662f\u901a\u904e\u5c07\u6642\u9593\u9078\u64c7\u5668\u9644\u52a0\u5230\u65b9\u62ec\u865f\u4e2d\u7684\u77ac\u6642\u5411\u91cf\uff08\u4f8b\u5982[5m]5 \u5206\u9418\uff09\u800c\u751f\u6210\u7684\u3002 \u6a19\u91cf\uff08Scalar\uff09 \uff1a\u4e00\u500b\u7c21\u55ae\u7684\u6578\u5b57\u6d6e\u9ede\u503c\u3002 \u5b57\u7b26\u4e32\uff08String\uff09 \uff1a\u4e00\u500b\u7c21\u55ae\u7684\u5b57\u7b26\u4e32\u503c\u3002 \u6240\u6709\u9019\u4e9b\u6307\u6a19\u90fd\u662f Prometheus \u5b9a\u671f\u5f9e ~/metrics \u63a5\u53e3\u90a3\u88e1\u63a1\u96c6\u904e\u4f86\u7684\u3002\u63a1\u96c6\u7684\u9593\u9694\u6642\u9593\u7684\u8a2d\u7f6e\u7531 prometheus.yml \u914d\u7f6e\u4e2d\u7684 scrape_interval \u6307\u5b9a\u3002\u6700\u591a\u6293\u53d6\u9593\u9694\u70ba 30 \u79d2\uff0c\u9019\u610f\u5473\u8457\u81f3\u5c11\u6bcf 30 \u79d2\u5c31\u6703\u6709\u4e00\u500b\u5e36\u6709\u65b0\u6642\u9593\u6233\u8a18\u9304\u7684\u65b0\u6578\u64da\u9ede\uff0c\u9019\u500b\u503c\u53ef\u80fd\u6703\u66f4\u6539\uff0c\u4e5f\u53ef\u80fd\u4e0d\u6703\u66f4\u6539\uff0c\u4f46\u662f\u6bcf\u9694 scrape_interval \u90fd\u6703\u7522\u751f\u4e00\u500b\u65b0\u7684\u6578\u64da\u9ede\u3002","title":"\u6578\u64da\u6a21\u578b"},{"location":"prometheus/promql/data-model/#_1","text":"\u539f\u6587: \u6570\u636e\u6a21\u578b \u5728\u958b\u59cb\u5b78\u7fd2 PromQL \u7684\u77e5\u8b58\u4e4b\u524d\uff0c\u6211\u5011\u5148\u91cd\u65b0\u4f86\u719f\u6089\u4e0b Prometheus \u7684\u6578\u64da\u6a21\u578b\u3002","title":"\u6578\u64da\u6a21\u578b"},{"location":"prometheus/promql/data-model/#_2","text":"Prometheus \u6703\u5c07\u6240\u6709\u63a1\u96c6\u5230\u7684\u6a23\u672c\u6578\u64da\u4ee5 \u6642\u9593\u5e8f\u5217 \u7684\u65b9\u5f0f\u4fdd\u5b58\u5728\u5167\u5b58\u6578\u64da\u5eab\u4e2d\uff0c\u4e26\u4e14\u5b9a\u6642\u4fdd\u5b58\u5230\u786c\u76e4\u4e0a\u3002\u6642\u9593\u5e8f\u5217\u662f\u6309\u7167\u6642\u9593\u6233\u548c\u503c\u7684\u5e8f\u5217\u9806\u5e8f\u5b58\u653e\u7684\uff0c\u6211\u5011\u7a31\u4e4b\u70ba \u5411\u91cf (vector) \uff0c\u6bcf\u689d\u6642\u9593\u5e8f\u5217\u901a\u904e \u6307\u6a19\u540d\u7a31(metrics name) \u548c \u4e00\u7d44\u6a19\u7c64\u96c6(labelset) \u547d\u540d\u3002\u5982\u4e0b\u6240\u793a\uff0c\u53ef\u4ee5\u5c07\u6642\u9593\u5e8f\u5217\u7406\u89e3\u70ba\u4e00\u500b\u4ee5\u6642\u9593\u70ba X \u8ef8\u7684\u6578\u5b57\u77e9\u9663\uff1a ^ \u2502 . . . . . . . . . . . . . . . . . . . node_cpu_seconds_total { cpu = \"cpu0\" ,mode = \"idle\" } \u2502 . . . . . . . . . . . . . . . . . . . node_cpu_seconds_total { cpu = \"cpu0\" ,mode = \"system\" } \u2502 . . . . . . . . . . . . . . . . . . node_load1 {} \u2502 . . . . . . . . . . . . . . . . . . v <------------------ \u6642\u9593 ----------------> \u5728\u6642\u9593\u5e8f\u5217\u4e2d\u7684\u6bcf\u4e00\u500b\u6578\u64da\u9ede\u7a31\u70ba\u4e00\u500b\u6a23\u672c\uff08sample\uff09\uff0c\u6a23\u672c\u7531\u4ee5\u4e0b\u4e09\u90e8\u5206\u7d44\u6210\uff1a \u6307\u6a19 (metric) \uff1a\u6307\u6a19\u540d\u548c\u63cf\u8ff0\u7576\u524d\u6a23\u672c\u7279\u5fb5\u7684\u6a19\u7c64\u96c6\u5408 \u6642\u9593\u6233 (timestamp) \uff1a\u4e00\u500b\u7cbe\u78ba\u5230\u6beb\u79d2\u7684\u6642\u9593\u6233 \u6a23\u672c\u503c (value) \uff1a \u4e00\u500b float64 \u7684\u6d6e\u9ede\u578b\u6578\u64da\u8868\u793a\u7576\u524d\u6a23\u672c\u7684\u503c \u5982\u4e0b\u6240\u793a\uff1a <--------------- metric ---------------------><-timestamp -><-value-> http_request_total { status = \"200\" , method = \"GET\" } @1434417560938 = > 94355 http_request_total { status = \"200\" , method = \"GET\" } @1434417561287 = > 94334 http_request_total { status = \"404\" , method = \"GET\" } @1434417560938 = > 38473 http_request_total { status = \"404\" , method = \"GET\" } @1434417561287 = > 38544 http_request_total { status = \"200\" , method = \"POST\" } @1434417560938 = > 4748 http_request_total { status = \"200\" , method = \"POST\" } @1434417561287 = > 4785 \u5728\u5f62\u5f0f\u4e0a\uff0c\u6240\u6709\u7684\u6307\u6a19\u90fd\u901a\u904e\u5982\u4e0b\u683c\u5f0f\u8868\u793a\uff1a <metric name> { <label name> = <label value>, ... } \u6307\u6a19\u7684\u540d\u7a31 \u53ef\u4ee5\u53cd\u6620\u88ab\u76e3\u63a7\u6a23\u672c\u7684\u542b\u7fa9\uff08\u6bd4\u5982\uff0chttp*request_total \u8868\u793a\u7576\u524d\u7cfb\u7d71\u63a5\u6536\u5230\u7684 HTTP \u8acb\u6c42\u7e3d\u91cf\uff09\u3002\u6307\u6a19\u540d\u7a31\u53ea\u80fd\u7531 ASCII \u5b57\u7b26\u3001\u6578\u5b57\u3001\u4e0b\u5283\u7dda\u4ee5\u53ca\u5192\u865f\u7d44\u6210\u4e26\u5fc5\u9808\u7b26\u5408\u6b63\u5247\u8868\u9054\u5f0f [a-zA-Z*:]a-zA-Z0-9\\*:]\\* \u3002 \u6a19\u7c64 (label) \u53cd\u6620\u4e86\u7576\u524d\u6a23\u672c\u7684\u7279\u5fb5\u7dad\u5ea6\uff0c\u901a\u904e\u9019\u4e9b\u7dad\u5ea6 Prometheus \u53ef\u4ee5\u5c0d\u6a23\u672c\u6578\u64da\u9032\u884c\u904e\u6ffe\uff0c\u805a\u5408\u7b49\u3002\u6a19\u7c64\u7684\u540d\u7a31\u53ea\u80fd\u7531 ASCII \u5b57\u7b26\u3001\u6578\u5b57\u4ee5\u53ca\u4e0b\u5283\u7dda\u7d44\u6210\u4e26\u6eff\u8db3\u6b63\u5247\u8868\u9054\u5f0f [a-zA-Z_][a-zA-Z0-9_]* \u3002 Info \u6ce8\u610f\uff1a\u5728 TSDB \u5167\u90e8\uff0c\u6307\u6a19\u540d\u7a31\u4e5f\u53ea\u662f\u4e00\u500b\u7279\u6b8a\u7684\u6a19\u7c64\uff0c\u6a19\u7c64\u540d\u70ba name \uff0c\u7531\u65bc\u9019\u500b\u6a19\u7c64\u5728 PromQL \u4e2d\u96a8\u6642\u90fd\u6703\u4f7f\u7528\uff0c\u6240\u4ee5\u5728\u4f7f\u7528 PromQL \u67e5\u8a62\u7684\u6642\u5019\u5c31\u88ab\u55ae\u7368\u5beb\u5728\u4e86\u6a19\u7c64\u5217\u8868\u524d\u9762\u4e86\u3002\u53e6\u5916\u50cf method=\"\" \u9019\u6a23\u7684\u7a7a\u6a19\u7c64\u5728 Prometheus \u7a2e\u76f8\u7576\u65bc\u4e00\u500b\u4e0d\u5b58\u5728\u7684\u6a19\u7c64\uff0c\u5728 Prometheus \u4ee3\u78bc\u88e1\u9762\u662f\u660e\u78ba\u5730\u525d\u96e2\u4e86\u7a7a\u6a19\u7c64\u7684\uff0c\u4e26\u4e0d\u6703\u5b58\u5132\u5b83\u5011\u3002","title":"\u6307\u6a19\u683c\u5f0f"},{"location":"prometheus/promql/data-model/#_3","text":"\u6bcf\u500b\u4e0d\u540c\u7684 metric_name \u548c label \u7d44\u5408\u90fd\u7a31\u70ba \u6642\u9593\u5e8f\u5217 \uff0c\u5728 Prometheus \u7684\u8868\u9054\u5f0f\u8a9e\u8a00\u4e2d\uff0c\u8868\u9054\u5f0f\u6216\u5b50\u8868\u9054\u5f0f\u5305\u62ec\u4ee5\u4e0b\u56db\u7a2e\u985e\u578b\u4e4b\u4e00\uff1a \u77ac\u6642\u5411\u91cf\uff08Instant vector\uff09 \uff1a\u4e00\u7d44\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u5305\u542b\u55ae\u500b\u6a23\u672c\uff0c\u5b83\u5011\u5171\u4eab\u76f8\u540c\u7684\u6642\u9593\u6233\u3002\u4e5f\u5c31\u662f\u8aaa\uff0c\u8868\u9054\u5f0f\u7684\u8fd4\u56de\u503c\u4e2d\u53ea\u6703\u5305\u542b\u8a72\u6642\u9593\u5e8f\u5217\u4e2d\u7684\u6700\u65b0\u7684\u4e00\u500b\u6a23\u672c\u503c\u3002\u800c\u76f8\u61c9\u7684\u9019\u6a23\u7684\u8868\u9054\u5f0f\u7a31\u4e4b\u70ba\u77ac\u6642\u5411\u91cf\u8868\u9054\u5f0f\u3002 \u5340\u9593\u5411\u91cf\uff08Range vector\uff09 \uff1a\u4e00\u7d44\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u5305\u542b\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u7684\u6a23\u672c\u6578\u64da\uff0c\u9019\u4e9b\u662f\u901a\u904e\u5c07\u6642\u9593\u9078\u64c7\u5668\u9644\u52a0\u5230\u65b9\u62ec\u865f\u4e2d\u7684\u77ac\u6642\u5411\u91cf\uff08\u4f8b\u5982[5m]5 \u5206\u9418\uff09\u800c\u751f\u6210\u7684\u3002 \u6a19\u91cf\uff08Scalar\uff09 \uff1a\u4e00\u500b\u7c21\u55ae\u7684\u6578\u5b57\u6d6e\u9ede\u503c\u3002 \u5b57\u7b26\u4e32\uff08String\uff09 \uff1a\u4e00\u500b\u7c21\u55ae\u7684\u5b57\u7b26\u4e32\u503c\u3002 \u6240\u6709\u9019\u4e9b\u6307\u6a19\u90fd\u662f Prometheus \u5b9a\u671f\u5f9e ~/metrics \u63a5\u53e3\u90a3\u88e1\u63a1\u96c6\u904e\u4f86\u7684\u3002\u63a1\u96c6\u7684\u9593\u9694\u6642\u9593\u7684\u8a2d\u7f6e\u7531 prometheus.yml \u914d\u7f6e\u4e2d\u7684 scrape_interval \u6307\u5b9a\u3002\u6700\u591a\u6293\u53d6\u9593\u9694\u70ba 30 \u79d2\uff0c\u9019\u610f\u5473\u8457\u81f3\u5c11\u6bcf 30 \u79d2\u5c31\u6703\u6709\u4e00\u500b\u5e36\u6709\u65b0\u6642\u9593\u6233\u8a18\u9304\u7684\u65b0\u6578\u64da\u9ede\uff0c\u9019\u500b\u503c\u53ef\u80fd\u6703\u66f4\u6539\uff0c\u4e5f\u53ef\u80fd\u4e0d\u6703\u66f4\u6539\uff0c\u4f46\u662f\u6bcf\u9694 scrape_interval \u90fd\u6703\u7522\u751f\u4e00\u500b\u65b0\u7684\u6578\u64da\u9ede\u3002","title":"\u6307\u6a19\u985e\u578b"},{"location":"prometheus/promql/demo-service/","text":"\u6f14\u793a\u670d\u52d9 \u00b6 \u539f\u6587: \u6f14\u793a\u670d\u52a1 \u70ba\u4e86\u76e1\u53ef\u80fd\u8a73\u7d30\u5730\u7d66\u5927\u5bb6\u6f14\u793a PromQL \u6307\u6a19\u67e5\u8a62\uff0c\u9019\u88e1\u6211\u5011\u5c07 Fork \u4e00\u500b\u958b\u6e90\u7684 Prometheus \u6f14\u793a\u670d\u52d9\u4f86\u9032\u884c\u67e5\u8a62\uff0c\u9019\u6a23\u53ef\u4ee5\u8b93\u6211\u5011\u66f4\u52a0\u9748\u6d3b\u5730\u5c0d\u6307\u6a19\u6578\u64da\u9032\u884c\u63a7\u5236\uff0c\u9805\u76ee\u5009\u5eab\u5730\u5740\uff1a https://github.com/cnych/prometheus_demo_service \uff0c\u9019\u662f\u4e00\u500b Go \u8a9e\u8a00\u958b\u767c\u7684\u670d\u52d9\uff0c\u6211\u5011\u53ef\u4ee5\u81ea\u5df1\u69cb\u5efa\u61c9\u7528\u3002 \u9996\u5148\u6e96\u5099 golang \u74b0\u5883\uff1a $ wget https://golang.org/dl/go1.16.3.linux-amd64.tar.gz $ rm -rf /usr/local/go && tar -C /usr/local -xzf go1.16.3.linux-amd64.tar.gz # \u914d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff0c\u53ef\u4ee5\u5c07\u4e0b\u9762\u547d\u4ee4\u6dfb\u52a0\u5230 /etc/profile \u4e2d $ export PATH = $PATH :/usr/local/go/bin # \u57f7\u884cgo\u547d\u4ee4\u9a57\u8b49 $ go version go version go1.16.3 linux/amd64 \u7136\u5f8c clone \u4ee3\u78bc\u69cb\u5efa\uff1a # \u9996\u5148clone\u4ee3\u78bc $ git clone https://github.com/cnych/prometheus_demo_service $ cd prometheus_demo_service # \u69cb\u5efa $ env GOOS = linux GOARCH = amd64 go build -o prometheus_demo_service \u69cb\u5efa\u5b8c\u6210\u5f8c\u555f\u52d5 3 \u500b\u670d\u52d9\uff0c\u5206\u5225\u76e3\u807d 10000\u300110001\u300110002 \u7aef\u53e3\uff1a $ ps -aux | grep demo root 15224 2 .9 0 .1 834120 14836 pts/0 Sl 10 :39 0 :00 ./prometheus_demo_service --listen-address = :10000 root 15333 3 .0 0 .2 899656 16888 pts/0 Sl 10 :39 0 :00 ./prometheus_demo_service --listen-address = :10001 root 15353 2 .7 0 .1 907596 14896 pts/0 Sl 10 :39 0 :00 ./prometheus_demo_service --listen-address = :10002 \u4e0a\u9762 3 \u500b\u670d\u52d9\u90fd\u5728 /metrics \u7aef\u9ede\u66b4\u9732\u4e86\u4e00\u4e9b\u6307\u6a19\u6578\u64da\uff0c\u6211\u5011\u53ef\u4ee5\u628a\u9019 3 \u500b\u670d\u52d9\u914d\u7f6e\u5230 Prometheus \u6293\u53d6\u4efb\u52d9\u4e2d\uff0c\u9019\u6a23\u5f8c\u7e8c\u5c31\u53ef\u4ee5\u4f7f\u7528\u9019\u5e7e\u500b\u670d\u52d9\u4f86\u9032\u884c PromQL \u67e5\u8a62\u8aaa\u660e\u4e86\u3002 \u5b8c\u6574\u7684 prometheus.yml \u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a prometheus.yml global : scrape_interval : 5s # \u6293\u53d6\u983b\u7387 scrape_configs : - job_name : \"prometheus\" static_configs : - targets : [ \"localhost:9090\" ] # \u914d\u7f6edemo\u6293\u53d6\u4efb\u52d9 - job_name : demo scrape_interval : 15s scrape_timeout : 10s static_configs : - targets : - demo-service-0:10000 - demo-service-1:10001 - demo-service-2:10002 \u9019\u88e1\u6211\u5011\u5c07 3 \u500b\u670d\u52d9\u914d\u7f6e\u5230\u540d\u70ba demo \u7684\u6293\u53d6\u4efb\u52d9\u4e2d\uff0c\u70ba\u4e86\u770b\u4e0a\u53bb\u66f4\u52a0\u6e05\u6670\uff0c\u9019\u88e1\u6211\u5011\u4f7f\u7528 demo-service-<index> \u4f86\u4ee3\u66ff\u670d\u52d9\u5730\u5740\uff0c\u76f4\u63a5\u5728 Prometheus \u6240\u5728\u7bc0\u9ede\u7684 /etc/hosts \u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e0a\u5c0d\u61c9\u670d\u52d9\u7684\u6620\u5c04\uff1a $ cat /etc/hosts ...... 192 .xxx.xxx.xxx demo-service-0 192 .xxx.xxx.xxx demo-service-1 192 .xxx.xxx.xxx demo-service-2 Info \u8acb\u4f7f\u7528\u500b\u81ea\u4e3b\u6a5f\u7684IP\u4f86\u66ff\u63db\u4e0a\u8ff0\u7bc4\u4f8b\u4e2d\u7684 192.xxx.xxx.xxx ! \u914d\u7f6e\u5b8c\u6210\u5f8c\u76f4\u63a5\u555f\u52d5 Prometheus \u670d\u52d9\u5373\u53ef\uff08\u53ef\u4ee5\u53c3\u8003\u524d\u9762\u7684 \u5b89\u88dd\u914d\u7f6e \u7ae0\u7bc0\uff09\uff1a ./prometheus \u555f\u52d5\u5f8c\u53ef\u4ee5\u5728 /targets \u9801\u9762\u67e5\u770b\u662f\u5426\u5728\u6b63\u78ba\u6293\u53d6\u76e3\u63a7\u6307\u6a19\uff1a \u8a72\u6f14\u793a\u670d\u52d9\u6a21\u64ec\u4e86\u4e00\u4e9b\u7528\u65bc\u6211\u5011\u6e2c\u8a66\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u5305\u62ec\uff1a \u66b4\u9732\u8acb\u6c42\u8a08\u6578\u548c\u97ff\u61c9\u6642\u9593\uff08\u4ee5 path\u3001method \u548c\u97ff\u61c9\u72c0\u614b\u78bc\u70ba\u6a19\u7c64 key\uff09\u7684 HTTP API \u670d\u52d9 \u4e00\u500b\u5b9a\u671f\u7684\u6279\u8655\u7406\u4efb\u52d9\uff0c\u5b83\u66b4\u9732\u4e86\u6700\u5f8c\u4e00\u6b21\u6210\u529f\u904b\u884c\u7684\u6642\u9593\u6233\u548c\u8655\u7406\u7684\u5b57\u7bc0\u6578 \u6709\u95dc CPU \u6578\u91cf\u53ca\u5176\u4f7f\u7528\u60c5\u6cc1\u7684\u7d9c\u5408\u6307\u6a19 \u6709\u95dc\u5167\u5b58\u4f7f\u7528\u60c5\u6cc1\u7684\u7d9c\u5408\u6307\u6a19 \u6709\u95dc\u78c1\u76e4\u7e3d\u5927\u5c0f\u53ca\u5176\u4f7f\u7528\u60c5\u6cc1\u7684\u7d9c\u5408\u6307\u6a19 \u5176\u4ed6\u6307\u6a19...... \u6211\u5011\u5c07\u5728\u5f8c\u9762\u67e5\u8a62\u5404\u500b\u6307\u6a19\u6642\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u5b83\u5011\u7684\u4fe1\u606f\u3002","title":"\u6f14\u793a\u670d\u52d9"},{"location":"prometheus/promql/demo-service/#_1","text":"\u539f\u6587: \u6f14\u793a\u670d\u52a1 \u70ba\u4e86\u76e1\u53ef\u80fd\u8a73\u7d30\u5730\u7d66\u5927\u5bb6\u6f14\u793a PromQL \u6307\u6a19\u67e5\u8a62\uff0c\u9019\u88e1\u6211\u5011\u5c07 Fork \u4e00\u500b\u958b\u6e90\u7684 Prometheus \u6f14\u793a\u670d\u52d9\u4f86\u9032\u884c\u67e5\u8a62\uff0c\u9019\u6a23\u53ef\u4ee5\u8b93\u6211\u5011\u66f4\u52a0\u9748\u6d3b\u5730\u5c0d\u6307\u6a19\u6578\u64da\u9032\u884c\u63a7\u5236\uff0c\u9805\u76ee\u5009\u5eab\u5730\u5740\uff1a https://github.com/cnych/prometheus_demo_service \uff0c\u9019\u662f\u4e00\u500b Go \u8a9e\u8a00\u958b\u767c\u7684\u670d\u52d9\uff0c\u6211\u5011\u53ef\u4ee5\u81ea\u5df1\u69cb\u5efa\u61c9\u7528\u3002 \u9996\u5148\u6e96\u5099 golang \u74b0\u5883\uff1a $ wget https://golang.org/dl/go1.16.3.linux-amd64.tar.gz $ rm -rf /usr/local/go && tar -C /usr/local -xzf go1.16.3.linux-amd64.tar.gz # \u914d\u7f6e\u74b0\u5883\u8b8a\u91cf\uff0c\u53ef\u4ee5\u5c07\u4e0b\u9762\u547d\u4ee4\u6dfb\u52a0\u5230 /etc/profile \u4e2d $ export PATH = $PATH :/usr/local/go/bin # \u57f7\u884cgo\u547d\u4ee4\u9a57\u8b49 $ go version go version go1.16.3 linux/amd64 \u7136\u5f8c clone \u4ee3\u78bc\u69cb\u5efa\uff1a # \u9996\u5148clone\u4ee3\u78bc $ git clone https://github.com/cnych/prometheus_demo_service $ cd prometheus_demo_service # \u69cb\u5efa $ env GOOS = linux GOARCH = amd64 go build -o prometheus_demo_service \u69cb\u5efa\u5b8c\u6210\u5f8c\u555f\u52d5 3 \u500b\u670d\u52d9\uff0c\u5206\u5225\u76e3\u807d 10000\u300110001\u300110002 \u7aef\u53e3\uff1a $ ps -aux | grep demo root 15224 2 .9 0 .1 834120 14836 pts/0 Sl 10 :39 0 :00 ./prometheus_demo_service --listen-address = :10000 root 15333 3 .0 0 .2 899656 16888 pts/0 Sl 10 :39 0 :00 ./prometheus_demo_service --listen-address = :10001 root 15353 2 .7 0 .1 907596 14896 pts/0 Sl 10 :39 0 :00 ./prometheus_demo_service --listen-address = :10002 \u4e0a\u9762 3 \u500b\u670d\u52d9\u90fd\u5728 /metrics \u7aef\u9ede\u66b4\u9732\u4e86\u4e00\u4e9b\u6307\u6a19\u6578\u64da\uff0c\u6211\u5011\u53ef\u4ee5\u628a\u9019 3 \u500b\u670d\u52d9\u914d\u7f6e\u5230 Prometheus \u6293\u53d6\u4efb\u52d9\u4e2d\uff0c\u9019\u6a23\u5f8c\u7e8c\u5c31\u53ef\u4ee5\u4f7f\u7528\u9019\u5e7e\u500b\u670d\u52d9\u4f86\u9032\u884c PromQL \u67e5\u8a62\u8aaa\u660e\u4e86\u3002 \u5b8c\u6574\u7684 prometheus.yml \u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\u6240\u793a\uff1a prometheus.yml global : scrape_interval : 5s # \u6293\u53d6\u983b\u7387 scrape_configs : - job_name : \"prometheus\" static_configs : - targets : [ \"localhost:9090\" ] # \u914d\u7f6edemo\u6293\u53d6\u4efb\u52d9 - job_name : demo scrape_interval : 15s scrape_timeout : 10s static_configs : - targets : - demo-service-0:10000 - demo-service-1:10001 - demo-service-2:10002 \u9019\u88e1\u6211\u5011\u5c07 3 \u500b\u670d\u52d9\u914d\u7f6e\u5230\u540d\u70ba demo \u7684\u6293\u53d6\u4efb\u52d9\u4e2d\uff0c\u70ba\u4e86\u770b\u4e0a\u53bb\u66f4\u52a0\u6e05\u6670\uff0c\u9019\u88e1\u6211\u5011\u4f7f\u7528 demo-service-<index> \u4f86\u4ee3\u66ff\u670d\u52d9\u5730\u5740\uff0c\u76f4\u63a5\u5728 Prometheus \u6240\u5728\u7bc0\u9ede\u7684 /etc/hosts \u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e0a\u5c0d\u61c9\u670d\u52d9\u7684\u6620\u5c04\uff1a $ cat /etc/hosts ...... 192 .xxx.xxx.xxx demo-service-0 192 .xxx.xxx.xxx demo-service-1 192 .xxx.xxx.xxx demo-service-2 Info \u8acb\u4f7f\u7528\u500b\u81ea\u4e3b\u6a5f\u7684IP\u4f86\u66ff\u63db\u4e0a\u8ff0\u7bc4\u4f8b\u4e2d\u7684 192.xxx.xxx.xxx ! \u914d\u7f6e\u5b8c\u6210\u5f8c\u76f4\u63a5\u555f\u52d5 Prometheus \u670d\u52d9\u5373\u53ef\uff08\u53ef\u4ee5\u53c3\u8003\u524d\u9762\u7684 \u5b89\u88dd\u914d\u7f6e \u7ae0\u7bc0\uff09\uff1a ./prometheus \u555f\u52d5\u5f8c\u53ef\u4ee5\u5728 /targets \u9801\u9762\u67e5\u770b\u662f\u5426\u5728\u6b63\u78ba\u6293\u53d6\u76e3\u63a7\u6307\u6a19\uff1a \u8a72\u6f14\u793a\u670d\u52d9\u6a21\u64ec\u4e86\u4e00\u4e9b\u7528\u65bc\u6211\u5011\u6e2c\u8a66\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u5305\u62ec\uff1a \u66b4\u9732\u8acb\u6c42\u8a08\u6578\u548c\u97ff\u61c9\u6642\u9593\uff08\u4ee5 path\u3001method \u548c\u97ff\u61c9\u72c0\u614b\u78bc\u70ba\u6a19\u7c64 key\uff09\u7684 HTTP API \u670d\u52d9 \u4e00\u500b\u5b9a\u671f\u7684\u6279\u8655\u7406\u4efb\u52d9\uff0c\u5b83\u66b4\u9732\u4e86\u6700\u5f8c\u4e00\u6b21\u6210\u529f\u904b\u884c\u7684\u6642\u9593\u6233\u548c\u8655\u7406\u7684\u5b57\u7bc0\u6578 \u6709\u95dc CPU \u6578\u91cf\u53ca\u5176\u4f7f\u7528\u60c5\u6cc1\u7684\u7d9c\u5408\u6307\u6a19 \u6709\u95dc\u5167\u5b58\u4f7f\u7528\u60c5\u6cc1\u7684\u7d9c\u5408\u6307\u6a19 \u6709\u95dc\u78c1\u76e4\u7e3d\u5927\u5c0f\u53ca\u5176\u4f7f\u7528\u60c5\u6cc1\u7684\u7d9c\u5408\u6307\u6a19 \u5176\u4ed6\u6307\u6a19...... \u6211\u5011\u5c07\u5728\u5f8c\u9762\u67e5\u8a62\u5404\u500b\u6307\u6a19\u6642\u4e86\u89e3\u66f4\u591a\u95dc\u65bc\u5b83\u5011\u7684\u4fe1\u606f\u3002","title":"\u6f14\u793a\u670d\u52d9"},{"location":"prometheus/promql/histograms/","text":"\u76f4\u65b9\u5716 \u00b6 \u5728\u9019\u4e00\u7bc0\u4e2d\uff0c\u6211\u5011\u5c07\u5b78\u7fd2 histogram \u6307\u6a19\uff0c\u4e86\u89e3\u5982\u4f55\u6839\u64da\u9019\u4e9b\u6307\u6a19\u4f86\u8a08\u7b97\u5206\u4f4d\u6578\u3002 Prometheus \u4e2d\u7684\u76f4\u65b9\u5716\u6307\u6a19\u5141\u8a31\u4e00\u500b\u670d\u52d9\u8a18\u9304\u4e00\u7cfb\u5217\u6578\u503c\u7684\u5206\u4f48\u3002\u76f4\u65b9\u5716\u901a\u5e38\u7528\u65bc\u8ddf\u8e2a \u8acb\u6c42\u7684\u5ef6\u9072 \u6216 \u97ff\u61c9\u5927\u5c0f \u7b49\u6307\u6a19\u503c\uff0c\u7576\u7136\u7406\u8ad6\u4e0a\u5b83\u662f\u53ef\u4ee5\u8ddf\u8e2a\u4efb\u4f55\u6839\u64da\u67d0\u7a2e\u5206\u4f48\u800c\u7522\u751f\u6ce2\u52d5\u6578\u503c\u7684\u5927\u5c0f\u3002 Prometheus \u76f4\u65b9\u5716\u662f\u5728\u5ba2\u6236\u7aef\u5c0d\u6578\u64da\u9032\u884c\u7684\u63a1\u6a23\uff0c\u5b83\u5011\u4f7f\u7528\u7684\u4e00\u4e9b\u53ef\u914d\u7f6e\u7684\uff08\u4f8b\u5982\u5ef6\u9072\uff09bucket \u6876\u5c0d\u89c0\u5bdf\u5230\u7684\u503c\u9032\u884c\u8a08\u6578\uff0c\u7136\u5f8c\u5c07\u9019\u4e9b bucket \u4f5c\u70ba\u55ae\u7368\u7684\u6642\u9593\u5e8f\u5217\u66b4\u9732\u51fa\u4f86\u3002 \u4e0b\u5716\u662f\u4e00\u500b\u975e\u7d2f\u7a4d\u76f4\u65b9\u5716\u7684\u4f8b\u5b50\uff1a \u5728 Prometheus \u5167\u90e8\uff0c\u76f4\u65b9\u5716\u88ab\u5be6\u73fe\u70ba\u4e00\u7d44\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u4ee3\u8868\u6307\u5b9a\u6876\u7684\u8a08\u6578\uff08\u4f8b\u598210ms\u4ee5\u4e0b\u7684\u8acb\u6c42\u6578\u300125ms\u4ee5\u4e0b\u7684\u8acb\u6c42\u6578\u300150ms\u4ee5\u4e0b\u7684\u8acb\u6c42\u6578\u7b49\uff09\u3002\u5728 Prometheus \u4e2d\u6bcf\u500b bucket \u6876\u7684\u8a08\u6578\u5668\u662f\u7d2f\u52a0\u7684\uff0c\u9019\u610f\u5473\u8457\u8f03\u5927\u503c\u7684\u6876\u4e5f\u5305\u62ec\u6240\u6709\u4f4e\u6578\u503c\u7684\u6876\u7684\u8a08\u6578\u3002\u5728\u4f5c\u70ba\u76f4\u65b9\u5716\u4e00\u90e8\u5206\u7684\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u4e0a\uff0c\u76f8\u61c9\u7684\u6876\u7531\u7279\u6b8a\u7684 le \u6a19\u7c64\u8868\u793a\u3002 le \u4ee3\u8868\u7684\u662f \u5c0f\u65bc \u6216 \u7b49\u65bc \u3002 \u8207\u4e0a\u9762\u76f8\u540c\u7684\u76f4\u65b9\u5716\u5728 Prometheus \u4e2d\u7684\u7d2f\u7a4d\u76f4\u65b9\u5716\u5982\u4e0b\u6240\u793a\uff1a \u53ef\u4ee5\u770b\u5230\u5728 Prometheus \u4e2d\u76f4\u65b9\u5716\u7684\u8a08\u6578\u662f\u7d2f\u8a08\u7684\uff0c\u9019\u662f\u5f88\u5947\u602a\u7684\uff0c\u56e0\u70ba\u901a\u5e38\u60c5\u6cc1\u4e0b\u975e\u7d2f\u7a4d\u7684\u76f4\u65b9\u5716\u66f4\u5bb9\u6613\u7406\u89e3\u3002 Prometheus \u70ba\u4ec0\u9ebc\u8981\u9019\u9ebc\u505a\u5462\uff1f\u60f3\u50cf\u4e00\u4e0b\uff0c\u5982\u679c\u76f4\u65b9\u5716\u6307\u6a19\u4e2d\u52a0\u5165\u4e86\u984d\u5916\u7684\u6a19\u7c64\uff0c\u6216\u8005\u5283\u5206\u4e86\u66f4\u591a\u7684 bucket\uff0c\u90a3\u9ebc\u6a23\u672c\u6578\u64da\u7684\u5206\u6790\u5c31\u6703\u8b8a\u5f97\u8d8a\u4f86\u8d8a\u8907\u96dc\uff0c\u5982\u679c\u76f4\u65b9\u5716\u662f\u7d2f\u7a4d\u7684\uff0c\u5728\u6293\u53d6\u6307\u6a19\u6642\u5c31\u53ef\u4ee5\u6839\u64da\u9700\u8981\u4e1f\u68c4\u67d0\u4e9b bucket\uff0c\u9019\u6a23\u53ef\u4ee5\u5728\u964d\u4f4e Prometheus \u7dad\u8b77\u6210\u672c\u7684\u540c\u6642\uff0c\u9084\u53ef\u4ee5\u7c97\u7565\u8a08\u7b97\u6a23\u672c\u503c\u7684\u5206\u4f4d\u6578\u3002 \u901a\u904e\u9019\u7a2e\u65b9\u6cd5\uff0c\u7528\u6236\u4e0d\u9700\u8981\u4fee\u6539\u61c9\u7528\u4ee3\u78bc\uff0c\u4fbf\u53ef\u4ee5\u52d5\u614b\u6e1b\u5c11\u6293\u53d6\u5230\u7684\u6a23\u672c\u6578\u91cf\u3002\u53e6\u5916\u76f4\u65b9\u5716\u9084\u63d0\u4f9b\u4e86 _sum \u6307\u6a19\u548c _count \u6307\u6a19\uff0c\u6240\u4ee5\u5373\u4f7f\u4f60\u4e1f\u68c4\u4e86\u6240\u6709\u7684 bucket\uff0c\u4ecd\u7136\u53ef\u4ee5\u901a\u904e\u9019\u5169\u500b\u6307\u6a19\u503c\u4f86\u8a08\u7b97\u8acb\u6c42\u7684\u5e73\u5747\u97ff\u61c9\u6642\u9593\u3002\u901a\u904e\u7d2f\u7a4d\u76f4\u65b9\u5716\u7684\u65b9\u5f0f\uff0c\u9084\u53ef\u4ee5\u5f88\u8f15\u9b06\u5730\u8a08\u7b97\u67d0\u500b bucket \u7684\u6a23\u672c\u6578\u4f54\u6240\u6709\u6a23\u672c\u6578\u7684\u6bd4\u4f8b\u3002 \u6211\u5011\u5728\u6f14\u793a\u7684 demo \u670d\u52d9\u4e2d\u66b4\u9732\u4e86\u4e00\u500b\u76f4\u65b9\u5716\u6307\u6a19 demo_api_request_duration_seconds_bucket\uff0c\u7528\u65bc\u8ddf\u8e2a API \u8acb\u6c42\u6642\u9577\u7684\u5206\u4f48\uff0c\u7531\u65bc\u9019\u500b\u76f4\u65b9\u5716\u70ba\u6bcf\u500b\u8ddf\u8e2a\u7684\u7dad\u5ea6\u5c0e\u51fa\u4e86 26 \u500b bucket\uff0c\u56e0\u6b64\u9019\u500b\u6307\u6a19\u6709\u5f88\u591a\u6642\u9593\u5e8f\u5217\u3002\u6211\u5011\u53ef\u4ee5\u5148\u4f86\u770b\u4e0b\u4f86\u81ea\u4e00\u500b\u670d\u52d9\u5be6\u4f8b\u7684\u4e00\u500b\u8acb\u6c42\u7dad\u5ea6\u7d44\u5408\u7684\u76f4\u65b9\u5716\uff0c\u67e5\u8a62\u8a9e\u53e5\u5982\u4e0b\u6240\u793a\uff1a demo_api_request_duration_seconds_bucket { instance = \" demo-service-0:10000 \", method = \" POST \", path = \" /api/bar \", status = \" 200 \", job = \" demo \"} \u6b63\u5e38\u6211\u5011\u53ef\u4ee5\u770b\u5230 26 \u500b\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u4ee3\u8868\u4e00\u500b bucket\uff0c\u7531 le \u6a19\u7c64\u6a19\u8b58\uff1a \u76f4\u65b9\u5716\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u4e86\u89e3\u9019\u6a23\u7684\u554f\u984c\uff0c\u6bd4\u5982\"\u6211\u6709\u591a\u5c11\u500b\u8acb\u6c42\u8d85\u904e\u4e86100ms\u7684\u6642\u9593\uff1f\" (\u7576\u7136\u9700\u8981\u76f4\u65b9\u5716\u4e2d\u914d\u7f6e\u4e86\u4e00\u500b\u4ee5 100ms \u70ba\u908a\u754c\u7684\u6876)\uff0c\u53c8\u6bd4\u5982\"\u621199%\u7684\u8acb\u6c42\u662f\u5728\u591a\u5c11\u5ef6\u9072\u4e0b\u5b8c\u6210\u7684\uff1f\"\uff0c\u9019\u985e\u6578\u503c\u88ab\u7a31\u70ba \u767e\u5206\u4f4d\u6578 \u6216 \u5206\u4f4d\u6578 \u3002\u5728 Prometheus \u4e2d\u9019\u5169\u500b\u8853\u8a9e\u5e7e\u4e4e\u662f\u53ef\u4ee5\u901a\u7528\uff0c\u53ea\u662f\u767e\u5206\u4f4d\u6578\u6307\u5b9a\u5728 0-100 \u7bc4\u570d\u5167\uff0c\u800c\u5206\u4f4d\u6578\u8868\u793a\u5728 0 \u548c 1 \u4e4b\u9593\uff0c\u6240\u4ee5\u7b2c 99 \u500b\u767e\u5206\u4f4d\u6578\u76f8\u7576\u65bc\u76ee\u6a19\u5206\u4f4d\u6578 0.99\u3002 \u5982\u679c\u4f60\u7684\u76f4\u65b9\u5716\u6876\u7c92\u5ea6\u8db3\u5920\u5c0f\uff0c\u90a3\u9ebc\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 histogram_quantile(\u03c6 scalar, b instant-vector) \u51fd\u6578\u7528\u65bc\u8a08\u7b97\u6b77\u53f2\u6578\u64da\u6307\u6a19\u4e00\u6bb5\u6642\u9593\u5167\u7684\u5206\u4f4d\u6578\u3002\u8a72\u51fd\u6578\u5c07\u76ee\u6a19\u5206\u4f4d\u6578 ( 0 \u2264 \u03c6 \u2264 1 ) \u548c\u76f4\u65b9\u5716\u6307\u6a19\u4f5c\u70ba\u8f38\u5165\uff0c\u5c31\u662f\u5927\u5bb6\u5e73\u6642\u8b1b\u7684 pxx \uff0c p50 \u5c31\u662f\u4e2d\u4f4d\u6578\uff0c\u53c3\u6578 b \u4e00\u5b9a\u662f\u5305\u542b le \u9019\u500b\u6a19\u7c64\u7684\u77ac\u6642\u5411\u91cf\uff0c\u4e0d\u5305\u542b\u5c31\u7121\u5f9e\u8a08\u7b97\u5206\u4f4d\u6578\u4e86\uff0c\u4f46\u662f\u8a08\u7b97\u7684\u5206\u4f4d\u6578\u662f\u4e00\u500b\u9810\u4f30\u503c\uff0c\u4e26\u4e0d\u5b8c\u5168\u6e96\u78ba\uff0c\u56e0\u70ba\u9019\u500b\u51fd\u6578\u662f\u5047\u5b9a\u6bcf\u500b\u5340\u9593\u5167\u7684\u6a23\u672c\u5206\u4f48\u662f\u7dda\u6027\u5206\u4f48\u4f86\u8a08\u7b97\u7d50\u679c\u503c\u7684\uff0c\u9810\u4f30\u7684\u6e96\u78ba\u5ea6\u53d6\u6c7a\u65bc bucket \u5340\u9593\u5283\u5206\u7684\u7c92\u5ea6\uff0c\u7c92\u5ea6\u8d8a\u5927\uff0c\u6e96\u78ba\u5ea6\u8d8a\u4f4e\u3002 \u56de\u5230\u6211\u5011\u7684\u6f14\u793a\u670d\u52d9\uff0c\u6211\u5011\u53ef\u4ee5\u5617\u8a66\u8a08\u7b97\u6240\u6709\u7dad\u5ea6\u5728\u6240\u6709\u6642\u9593\u5167\u7684\u7b2c 90 \u500b\u767e\u5206\u4f4d\u6578\uff0c\u4e5f\u5c31\u662f 90% \u7684\u8acb\u6c42\u7684\u6301\u7e8c\u6642\u9593\u3002 # BAD! histogram_quantile ( 0.9 , demo_api_request_duration_seconds_bucket { job = \" demo \"} ) \u4f46\u662f\u9019\u500b\u67e5\u8a62\u65b9\u5f0f\u662f\u6709\u4e00\u9ede\u554f\u984c\u7684\uff0c\u7576\u55ae\u500b\u670d\u52d9\u5be6\u4f8b\u91cd\u65b0\u555f\u52d5\u6642\uff0cbucket \u7684 Counter \u8a08\u6578\u5668\u6703\u88ab\u91cd\u7f6e\uff0c\u800c\u4e14\u6211\u5011\u5e38\u5e38\u60f3\u770b\u770b\u73fe\u5728\u7684\u5ef6\u9072\u662f\u591a\u5c11\uff08\u6bd4\u5982\u5728\u904e\u53bb 5 \u5206\u9418\u5167\uff09\uff0c\u800c\u4e0d\u662f\u6574\u500b\u6642\u9593\u5167\u7684\u6307\u6a19\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 rate() \u51fd\u6578\u61c9\u7528\u65bc\u5e95\u5c64\u76f4\u65b9\u5716\u8a08\u6578\u5668\u4f86\u5be6\u73fe\u9019\u4e00\u9ede\uff0c\u8a72\u51fd\u6578\u6703\u81ea\u52d5\u8655\u7406 Counter \u91cd\u7f6e\uff0c\u53c8\u53ef\u4ee5\u53ea\u8a08\u7b97\u6bcf\u500b\u6876\u5728\u6307\u5b9a\u6642\u9593\u7a97\u53e3\u5167\u7684\u5e73\u5747\u589e\u9577\u3002 \u6211\u5011\u53ef\u4ee5\u9019\u6a23\u53bb\u8a08\u7b97\u904e\u53bb 5 \u5206\u9418\u5167\u7b2c 90 \u500b\u767e\u5206\u4f4d\u6578\u7684 API \u5ef6\u9072\uff1a # GOOD! histogram_quantile ( 0.9 , rate ( demo_api_request_duration_seconds_bucket { job = \" demo \"}[ 5m ] )) \u9019\u500b\u67e5\u8a62\u5c31\u597d\u5f88\u591a\u4e86\u3002 \u9019\u500b\u67e5\u8a62\u6703\u986f\u793a\u6bcf\u500b\u7dad\u5ea6\uff08 job \u3001 instance \u3001 path \u3001 method \u548c status \uff09\u7684\u7b2c 90 \u500b\u767e\u5206\u9ede\uff0c\u4f46\u662f\u6211\u5011\u53ef\u80fd\u5c0d\u55ae\u7368\u7684\u9019\u4e9b\u7dad\u5ea6\u4e26\u4e0d\u611f\u8208\u8da3\uff0c\u60f3\u628a\u4ed6\u5011\u4e2d\u7684\u4e00\u4e9b\u6307\u6a19\u805a\u5408\u8d77\u4f86\uff0c\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u5728\u67e5\u8a62\u7684\u6642\u5019\u4f7f\u7528 Prometheus \u7684 sum \u904b\u7b97\u7b26\u8207 histogram_quantile() \u51fd\u6578\u7d50\u5408\u8d77\u4f86\uff0c\u8a08\u7b97\u51fa\u805a\u5408\u7684\u767e\u5206\u4f4d\uff0c\u5047\u8a2d\u5728\u6211\u5011\u60f3\u8981\u805a\u5408\u7684\u7dad\u5ea6\u4e4b\u9593\uff0c\u76f4\u65b9\u5716\u6876\u7684\u914d\u7f6e\u65b9\u5f0f\u76f8\u540c\uff08\u6876\u7684\u6578\u91cf\u76f8\u540c\uff0c\u4e0a\u9650\u76f8\u540c\uff09\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u4e0d\u540c\u7dad\u5ea6\u4e4b\u9593\u5177\u6709\u76f8\u540c le \u6a19\u7c64\u503c\u7684\u6876\u52a0\u5728\u4e00\u8d77\uff0c\u5f97\u5230\u4e00\u500b\u805a\u5408\u76f4\u65b9\u5716\u3002\u7136\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u8a72\u805a\u5408\u76f4\u65b9\u5716\u4f5c\u70ba histogram_quantile() \u51fd\u6578\u7684\u8f38\u5165\u3002 Info \u6ce8\u610f\uff1a\u9019\u662f\u5047\u8a2d\u76f4\u65b9\u5716\u7684 bucket \u5728\u4f60\u8981\u805a\u5408\u7684\u6240\u6709\u7dad\u5ea6\u4e4b\u9593\u7684\u914d\u7f6e\u662f\u76f8\u540c\u7684\uff0cbucket \u7684\u914d\u7f6e\u4e5f\u61c9\u8a72\u662f\u76f8\u5c0d\u975c\u614b\u7684\u914d\u7f6e\uff0c\u4e0d\u6703\u4e00\u76f4\u8b8a\u5316\uff0c\u56e0\u70ba\u9019\u6703\u7834\u58de\u4f60\u4f7f\u7528 histogram_quantile() \u67e5\u770b\u7684\u6642\u9593\u7bc4\u570d\u5167\u7684\u7d50\u679c\u3002 \u4e0b\u9762\u7684\u67e5\u8a62\u8a08\u7b97\u4e86\u7b2c 90 \u500b\u767e\u5206\u4f4d\u6578\u7684\u5ef6\u9072\uff0c\u4f46\u53ea\u6309 job \u3001 instance \u548c path \u7dad\u5ea6\u9032\u884c\u805a\u5408\u7d50\u679c\uff1a \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u8a08\u7b97\u5728 0.0001 \u79d2\u5167\u5b8c\u6210\u7684 demo \u670d\u52d9 API \u8acb\u6c42\u7684\u7e3d\u767e\u5206\u6bd4\uff0c\u8207\u904e\u53bb 5 \u5206\u9418\u5167\u6240\u6709\u8acb\u6c42\u7e3d\u6578\u7684\u5e73\u5747\u503c\u3002 sum ( rate ( demo_api_request_duration_seconds_bucket { le = \" 0.0001 \"}[ 5m ] )) / sum ( rate ( demo_api_request_duration_seconds_bucket { le = \" +Inf \"}[ 5m ] )) * 100 \u6216\u8005\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u67e5\u8a62: sum ( rate ( demo_api_request_duration_seconds_bucket { le = \" 0.0001 \"}[ 5m ] )) / sum ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) * 100 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u8a08\u7b97 demo \u670d\u52d9 API \u8acb\u6c42\u7684\u7b2c 50 \u500b\u767e\u5206\u4f4d\u5ef6\u9072\uff0c\u6309 status code \u548c method \u9032\u884c\u5283\u5206\uff0c\u5728\u904e\u53bb\u4e00\u5206\u9418\u7684\u5e73\u5747\u503c\u3002 histogram_quantile ( 0.5 , sum by ( status , method , le ) ( rate ( demo_api_request_duration_seconds_bucket [ 1m ] )))","title":"\u76f4\u65b9\u5716"},{"location":"prometheus/promql/histograms/#_1","text":"\u5728\u9019\u4e00\u7bc0\u4e2d\uff0c\u6211\u5011\u5c07\u5b78\u7fd2 histogram \u6307\u6a19\uff0c\u4e86\u89e3\u5982\u4f55\u6839\u64da\u9019\u4e9b\u6307\u6a19\u4f86\u8a08\u7b97\u5206\u4f4d\u6578\u3002 Prometheus \u4e2d\u7684\u76f4\u65b9\u5716\u6307\u6a19\u5141\u8a31\u4e00\u500b\u670d\u52d9\u8a18\u9304\u4e00\u7cfb\u5217\u6578\u503c\u7684\u5206\u4f48\u3002\u76f4\u65b9\u5716\u901a\u5e38\u7528\u65bc\u8ddf\u8e2a \u8acb\u6c42\u7684\u5ef6\u9072 \u6216 \u97ff\u61c9\u5927\u5c0f \u7b49\u6307\u6a19\u503c\uff0c\u7576\u7136\u7406\u8ad6\u4e0a\u5b83\u662f\u53ef\u4ee5\u8ddf\u8e2a\u4efb\u4f55\u6839\u64da\u67d0\u7a2e\u5206\u4f48\u800c\u7522\u751f\u6ce2\u52d5\u6578\u503c\u7684\u5927\u5c0f\u3002 Prometheus \u76f4\u65b9\u5716\u662f\u5728\u5ba2\u6236\u7aef\u5c0d\u6578\u64da\u9032\u884c\u7684\u63a1\u6a23\uff0c\u5b83\u5011\u4f7f\u7528\u7684\u4e00\u4e9b\u53ef\u914d\u7f6e\u7684\uff08\u4f8b\u5982\u5ef6\u9072\uff09bucket \u6876\u5c0d\u89c0\u5bdf\u5230\u7684\u503c\u9032\u884c\u8a08\u6578\uff0c\u7136\u5f8c\u5c07\u9019\u4e9b bucket \u4f5c\u70ba\u55ae\u7368\u7684\u6642\u9593\u5e8f\u5217\u66b4\u9732\u51fa\u4f86\u3002 \u4e0b\u5716\u662f\u4e00\u500b\u975e\u7d2f\u7a4d\u76f4\u65b9\u5716\u7684\u4f8b\u5b50\uff1a \u5728 Prometheus \u5167\u90e8\uff0c\u76f4\u65b9\u5716\u88ab\u5be6\u73fe\u70ba\u4e00\u7d44\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u4ee3\u8868\u6307\u5b9a\u6876\u7684\u8a08\u6578\uff08\u4f8b\u598210ms\u4ee5\u4e0b\u7684\u8acb\u6c42\u6578\u300125ms\u4ee5\u4e0b\u7684\u8acb\u6c42\u6578\u300150ms\u4ee5\u4e0b\u7684\u8acb\u6c42\u6578\u7b49\uff09\u3002\u5728 Prometheus \u4e2d\u6bcf\u500b bucket \u6876\u7684\u8a08\u6578\u5668\u662f\u7d2f\u52a0\u7684\uff0c\u9019\u610f\u5473\u8457\u8f03\u5927\u503c\u7684\u6876\u4e5f\u5305\u62ec\u6240\u6709\u4f4e\u6578\u503c\u7684\u6876\u7684\u8a08\u6578\u3002\u5728\u4f5c\u70ba\u76f4\u65b9\u5716\u4e00\u90e8\u5206\u7684\u6bcf\u500b\u6642\u9593\u5e8f\u5217\u4e0a\uff0c\u76f8\u61c9\u7684\u6876\u7531\u7279\u6b8a\u7684 le \u6a19\u7c64\u8868\u793a\u3002 le \u4ee3\u8868\u7684\u662f \u5c0f\u65bc \u6216 \u7b49\u65bc \u3002 \u8207\u4e0a\u9762\u76f8\u540c\u7684\u76f4\u65b9\u5716\u5728 Prometheus \u4e2d\u7684\u7d2f\u7a4d\u76f4\u65b9\u5716\u5982\u4e0b\u6240\u793a\uff1a \u53ef\u4ee5\u770b\u5230\u5728 Prometheus \u4e2d\u76f4\u65b9\u5716\u7684\u8a08\u6578\u662f\u7d2f\u8a08\u7684\uff0c\u9019\u662f\u5f88\u5947\u602a\u7684\uff0c\u56e0\u70ba\u901a\u5e38\u60c5\u6cc1\u4e0b\u975e\u7d2f\u7a4d\u7684\u76f4\u65b9\u5716\u66f4\u5bb9\u6613\u7406\u89e3\u3002 Prometheus \u70ba\u4ec0\u9ebc\u8981\u9019\u9ebc\u505a\u5462\uff1f\u60f3\u50cf\u4e00\u4e0b\uff0c\u5982\u679c\u76f4\u65b9\u5716\u6307\u6a19\u4e2d\u52a0\u5165\u4e86\u984d\u5916\u7684\u6a19\u7c64\uff0c\u6216\u8005\u5283\u5206\u4e86\u66f4\u591a\u7684 bucket\uff0c\u90a3\u9ebc\u6a23\u672c\u6578\u64da\u7684\u5206\u6790\u5c31\u6703\u8b8a\u5f97\u8d8a\u4f86\u8d8a\u8907\u96dc\uff0c\u5982\u679c\u76f4\u65b9\u5716\u662f\u7d2f\u7a4d\u7684\uff0c\u5728\u6293\u53d6\u6307\u6a19\u6642\u5c31\u53ef\u4ee5\u6839\u64da\u9700\u8981\u4e1f\u68c4\u67d0\u4e9b bucket\uff0c\u9019\u6a23\u53ef\u4ee5\u5728\u964d\u4f4e Prometheus \u7dad\u8b77\u6210\u672c\u7684\u540c\u6642\uff0c\u9084\u53ef\u4ee5\u7c97\u7565\u8a08\u7b97\u6a23\u672c\u503c\u7684\u5206\u4f4d\u6578\u3002 \u901a\u904e\u9019\u7a2e\u65b9\u6cd5\uff0c\u7528\u6236\u4e0d\u9700\u8981\u4fee\u6539\u61c9\u7528\u4ee3\u78bc\uff0c\u4fbf\u53ef\u4ee5\u52d5\u614b\u6e1b\u5c11\u6293\u53d6\u5230\u7684\u6a23\u672c\u6578\u91cf\u3002\u53e6\u5916\u76f4\u65b9\u5716\u9084\u63d0\u4f9b\u4e86 _sum \u6307\u6a19\u548c _count \u6307\u6a19\uff0c\u6240\u4ee5\u5373\u4f7f\u4f60\u4e1f\u68c4\u4e86\u6240\u6709\u7684 bucket\uff0c\u4ecd\u7136\u53ef\u4ee5\u901a\u904e\u9019\u5169\u500b\u6307\u6a19\u503c\u4f86\u8a08\u7b97\u8acb\u6c42\u7684\u5e73\u5747\u97ff\u61c9\u6642\u9593\u3002\u901a\u904e\u7d2f\u7a4d\u76f4\u65b9\u5716\u7684\u65b9\u5f0f\uff0c\u9084\u53ef\u4ee5\u5f88\u8f15\u9b06\u5730\u8a08\u7b97\u67d0\u500b bucket \u7684\u6a23\u672c\u6578\u4f54\u6240\u6709\u6a23\u672c\u6578\u7684\u6bd4\u4f8b\u3002 \u6211\u5011\u5728\u6f14\u793a\u7684 demo \u670d\u52d9\u4e2d\u66b4\u9732\u4e86\u4e00\u500b\u76f4\u65b9\u5716\u6307\u6a19 demo_api_request_duration_seconds_bucket\uff0c\u7528\u65bc\u8ddf\u8e2a API \u8acb\u6c42\u6642\u9577\u7684\u5206\u4f48\uff0c\u7531\u65bc\u9019\u500b\u76f4\u65b9\u5716\u70ba\u6bcf\u500b\u8ddf\u8e2a\u7684\u7dad\u5ea6\u5c0e\u51fa\u4e86 26 \u500b bucket\uff0c\u56e0\u6b64\u9019\u500b\u6307\u6a19\u6709\u5f88\u591a\u6642\u9593\u5e8f\u5217\u3002\u6211\u5011\u53ef\u4ee5\u5148\u4f86\u770b\u4e0b\u4f86\u81ea\u4e00\u500b\u670d\u52d9\u5be6\u4f8b\u7684\u4e00\u500b\u8acb\u6c42\u7dad\u5ea6\u7d44\u5408\u7684\u76f4\u65b9\u5716\uff0c\u67e5\u8a62\u8a9e\u53e5\u5982\u4e0b\u6240\u793a\uff1a demo_api_request_duration_seconds_bucket { instance = \" demo-service-0:10000 \", method = \" POST \", path = \" /api/bar \", status = \" 200 \", job = \" demo \"} \u6b63\u5e38\u6211\u5011\u53ef\u4ee5\u770b\u5230 26 \u500b\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u4ee3\u8868\u4e00\u500b bucket\uff0c\u7531 le \u6a19\u7c64\u6a19\u8b58\uff1a \u76f4\u65b9\u5716\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u4e86\u89e3\u9019\u6a23\u7684\u554f\u984c\uff0c\u6bd4\u5982\"\u6211\u6709\u591a\u5c11\u500b\u8acb\u6c42\u8d85\u904e\u4e86100ms\u7684\u6642\u9593\uff1f\" (\u7576\u7136\u9700\u8981\u76f4\u65b9\u5716\u4e2d\u914d\u7f6e\u4e86\u4e00\u500b\u4ee5 100ms \u70ba\u908a\u754c\u7684\u6876)\uff0c\u53c8\u6bd4\u5982\"\u621199%\u7684\u8acb\u6c42\u662f\u5728\u591a\u5c11\u5ef6\u9072\u4e0b\u5b8c\u6210\u7684\uff1f\"\uff0c\u9019\u985e\u6578\u503c\u88ab\u7a31\u70ba \u767e\u5206\u4f4d\u6578 \u6216 \u5206\u4f4d\u6578 \u3002\u5728 Prometheus \u4e2d\u9019\u5169\u500b\u8853\u8a9e\u5e7e\u4e4e\u662f\u53ef\u4ee5\u901a\u7528\uff0c\u53ea\u662f\u767e\u5206\u4f4d\u6578\u6307\u5b9a\u5728 0-100 \u7bc4\u570d\u5167\uff0c\u800c\u5206\u4f4d\u6578\u8868\u793a\u5728 0 \u548c 1 \u4e4b\u9593\uff0c\u6240\u4ee5\u7b2c 99 \u500b\u767e\u5206\u4f4d\u6578\u76f8\u7576\u65bc\u76ee\u6a19\u5206\u4f4d\u6578 0.99\u3002 \u5982\u679c\u4f60\u7684\u76f4\u65b9\u5716\u6876\u7c92\u5ea6\u8db3\u5920\u5c0f\uff0c\u90a3\u9ebc\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 histogram_quantile(\u03c6 scalar, b instant-vector) \u51fd\u6578\u7528\u65bc\u8a08\u7b97\u6b77\u53f2\u6578\u64da\u6307\u6a19\u4e00\u6bb5\u6642\u9593\u5167\u7684\u5206\u4f4d\u6578\u3002\u8a72\u51fd\u6578\u5c07\u76ee\u6a19\u5206\u4f4d\u6578 ( 0 \u2264 \u03c6 \u2264 1 ) \u548c\u76f4\u65b9\u5716\u6307\u6a19\u4f5c\u70ba\u8f38\u5165\uff0c\u5c31\u662f\u5927\u5bb6\u5e73\u6642\u8b1b\u7684 pxx \uff0c p50 \u5c31\u662f\u4e2d\u4f4d\u6578\uff0c\u53c3\u6578 b \u4e00\u5b9a\u662f\u5305\u542b le \u9019\u500b\u6a19\u7c64\u7684\u77ac\u6642\u5411\u91cf\uff0c\u4e0d\u5305\u542b\u5c31\u7121\u5f9e\u8a08\u7b97\u5206\u4f4d\u6578\u4e86\uff0c\u4f46\u662f\u8a08\u7b97\u7684\u5206\u4f4d\u6578\u662f\u4e00\u500b\u9810\u4f30\u503c\uff0c\u4e26\u4e0d\u5b8c\u5168\u6e96\u78ba\uff0c\u56e0\u70ba\u9019\u500b\u51fd\u6578\u662f\u5047\u5b9a\u6bcf\u500b\u5340\u9593\u5167\u7684\u6a23\u672c\u5206\u4f48\u662f\u7dda\u6027\u5206\u4f48\u4f86\u8a08\u7b97\u7d50\u679c\u503c\u7684\uff0c\u9810\u4f30\u7684\u6e96\u78ba\u5ea6\u53d6\u6c7a\u65bc bucket \u5340\u9593\u5283\u5206\u7684\u7c92\u5ea6\uff0c\u7c92\u5ea6\u8d8a\u5927\uff0c\u6e96\u78ba\u5ea6\u8d8a\u4f4e\u3002 \u56de\u5230\u6211\u5011\u7684\u6f14\u793a\u670d\u52d9\uff0c\u6211\u5011\u53ef\u4ee5\u5617\u8a66\u8a08\u7b97\u6240\u6709\u7dad\u5ea6\u5728\u6240\u6709\u6642\u9593\u5167\u7684\u7b2c 90 \u500b\u767e\u5206\u4f4d\u6578\uff0c\u4e5f\u5c31\u662f 90% \u7684\u8acb\u6c42\u7684\u6301\u7e8c\u6642\u9593\u3002 # BAD! histogram_quantile ( 0.9 , demo_api_request_duration_seconds_bucket { job = \" demo \"} ) \u4f46\u662f\u9019\u500b\u67e5\u8a62\u65b9\u5f0f\u662f\u6709\u4e00\u9ede\u554f\u984c\u7684\uff0c\u7576\u55ae\u500b\u670d\u52d9\u5be6\u4f8b\u91cd\u65b0\u555f\u52d5\u6642\uff0cbucket \u7684 Counter \u8a08\u6578\u5668\u6703\u88ab\u91cd\u7f6e\uff0c\u800c\u4e14\u6211\u5011\u5e38\u5e38\u60f3\u770b\u770b\u73fe\u5728\u7684\u5ef6\u9072\u662f\u591a\u5c11\uff08\u6bd4\u5982\u5728\u904e\u53bb 5 \u5206\u9418\u5167\uff09\uff0c\u800c\u4e0d\u662f\u6574\u500b\u6642\u9593\u5167\u7684\u6307\u6a19\u3002\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 rate() \u51fd\u6578\u61c9\u7528\u65bc\u5e95\u5c64\u76f4\u65b9\u5716\u8a08\u6578\u5668\u4f86\u5be6\u73fe\u9019\u4e00\u9ede\uff0c\u8a72\u51fd\u6578\u6703\u81ea\u52d5\u8655\u7406 Counter \u91cd\u7f6e\uff0c\u53c8\u53ef\u4ee5\u53ea\u8a08\u7b97\u6bcf\u500b\u6876\u5728\u6307\u5b9a\u6642\u9593\u7a97\u53e3\u5167\u7684\u5e73\u5747\u589e\u9577\u3002 \u6211\u5011\u53ef\u4ee5\u9019\u6a23\u53bb\u8a08\u7b97\u904e\u53bb 5 \u5206\u9418\u5167\u7b2c 90 \u500b\u767e\u5206\u4f4d\u6578\u7684 API \u5ef6\u9072\uff1a # GOOD! histogram_quantile ( 0.9 , rate ( demo_api_request_duration_seconds_bucket { job = \" demo \"}[ 5m ] )) \u9019\u500b\u67e5\u8a62\u5c31\u597d\u5f88\u591a\u4e86\u3002 \u9019\u500b\u67e5\u8a62\u6703\u986f\u793a\u6bcf\u500b\u7dad\u5ea6\uff08 job \u3001 instance \u3001 path \u3001 method \u548c status \uff09\u7684\u7b2c 90 \u500b\u767e\u5206\u9ede\uff0c\u4f46\u662f\u6211\u5011\u53ef\u80fd\u5c0d\u55ae\u7368\u7684\u9019\u4e9b\u7dad\u5ea6\u4e26\u4e0d\u611f\u8208\u8da3\uff0c\u60f3\u628a\u4ed6\u5011\u4e2d\u7684\u4e00\u4e9b\u6307\u6a19\u805a\u5408\u8d77\u4f86\uff0c\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u5728\u67e5\u8a62\u7684\u6642\u5019\u4f7f\u7528 Prometheus \u7684 sum \u904b\u7b97\u7b26\u8207 histogram_quantile() \u51fd\u6578\u7d50\u5408\u8d77\u4f86\uff0c\u8a08\u7b97\u51fa\u805a\u5408\u7684\u767e\u5206\u4f4d\uff0c\u5047\u8a2d\u5728\u6211\u5011\u60f3\u8981\u805a\u5408\u7684\u7dad\u5ea6\u4e4b\u9593\uff0c\u76f4\u65b9\u5716\u6876\u7684\u914d\u7f6e\u65b9\u5f0f\u76f8\u540c\uff08\u6876\u7684\u6578\u91cf\u76f8\u540c\uff0c\u4e0a\u9650\u76f8\u540c\uff09\uff0c\u6211\u5011\u53ef\u4ee5\u5c07\u4e0d\u540c\u7dad\u5ea6\u4e4b\u9593\u5177\u6709\u76f8\u540c le \u6a19\u7c64\u503c\u7684\u6876\u52a0\u5728\u4e00\u8d77\uff0c\u5f97\u5230\u4e00\u500b\u805a\u5408\u76f4\u65b9\u5716\u3002\u7136\u5f8c\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u8a72\u805a\u5408\u76f4\u65b9\u5716\u4f5c\u70ba histogram_quantile() \u51fd\u6578\u7684\u8f38\u5165\u3002 Info \u6ce8\u610f\uff1a\u9019\u662f\u5047\u8a2d\u76f4\u65b9\u5716\u7684 bucket \u5728\u4f60\u8981\u805a\u5408\u7684\u6240\u6709\u7dad\u5ea6\u4e4b\u9593\u7684\u914d\u7f6e\u662f\u76f8\u540c\u7684\uff0cbucket \u7684\u914d\u7f6e\u4e5f\u61c9\u8a72\u662f\u76f8\u5c0d\u975c\u614b\u7684\u914d\u7f6e\uff0c\u4e0d\u6703\u4e00\u76f4\u8b8a\u5316\uff0c\u56e0\u70ba\u9019\u6703\u7834\u58de\u4f60\u4f7f\u7528 histogram_quantile() \u67e5\u770b\u7684\u6642\u9593\u7bc4\u570d\u5167\u7684\u7d50\u679c\u3002 \u4e0b\u9762\u7684\u67e5\u8a62\u8a08\u7b97\u4e86\u7b2c 90 \u500b\u767e\u5206\u4f4d\u6578\u7684\u5ef6\u9072\uff0c\u4f46\u53ea\u6309 job \u3001 instance \u548c path \u7dad\u5ea6\u9032\u884c\u805a\u5408\u7d50\u679c\uff1a \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u8a08\u7b97\u5728 0.0001 \u79d2\u5167\u5b8c\u6210\u7684 demo \u670d\u52d9 API \u8acb\u6c42\u7684\u7e3d\u767e\u5206\u6bd4\uff0c\u8207\u904e\u53bb 5 \u5206\u9418\u5167\u6240\u6709\u8acb\u6c42\u7e3d\u6578\u7684\u5e73\u5747\u503c\u3002 sum ( rate ( demo_api_request_duration_seconds_bucket { le = \" 0.0001 \"}[ 5m ] )) / sum ( rate ( demo_api_request_duration_seconds_bucket { le = \" +Inf \"}[ 5m ] )) * 100 \u6216\u8005\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u67e5\u8a62: sum ( rate ( demo_api_request_duration_seconds_bucket { le = \" 0.0001 \"}[ 5m ] )) / sum ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) * 100 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u8a08\u7b97 demo \u670d\u52d9 API \u8acb\u6c42\u7684\u7b2c 50 \u500b\u767e\u5206\u4f4d\u5ef6\u9072\uff0c\u6309 status code \u548c method \u9032\u884c\u5283\u5206\uff0c\u5728\u904e\u53bb\u4e00\u5206\u9418\u7684\u5e73\u5747\u503c\u3002 histogram_quantile ( 0.5 , sum by ( status , method , le ) ( rate ( demo_api_request_duration_seconds_bucket [ 1m ] )))","title":"\u76f4\u65b9\u5716"},{"location":"prometheus/promql/intro/","text":"PromQL \u4ecb\u7d39 \u00b6 \u539f\u6587: PromQL \u4ecb\u7ecd PromQL \u662f Prometheus \u76e3\u63a7\u7cfb\u7d71\u5167\u7f6e\u7684\u4e00\u7a2e\u67e5\u8a62\u8a9e\u8a00\uff0cPromQL \u5141\u8a31\u4f60\u4ee5\u9748\u6d3b\u7684\u65b9\u5f0f\u9078\u64c7\u3001\u805a\u5408\u7b49\u5176\u4ed6\u65b9\u5f0f\u8f49\u63db\u548c\u8a08\u7b97\u6642\u9593\u5e8f\u5217\u6578\u64da\uff0c\u8a72\u8a9e\u8a00\u50c5\u7528\u65bc\u8b80\u53d6\u6578\u64da\u3002\u53ef\u4ee5\u8aaa PromQL \u662f\u6211\u5011\u5b78\u7fd2 Prometheus \u6700\u56f0\u96e3\u4e5f\u662f\u6700\u91cd\u8981\u7684\u90e8\u5206\uff0c\u672c\u7ae0\u7bc0\u6211\u5011\u5c07\u4ecb\u7d39 PromQL \u7684\u57fa\u790e\u77e5\u8b58\u3001\u7406\u8ad6\u57fa\u790e\uff0c\u7136\u5f8c\u6703\u6df1\u5165\u4e86\u89e3\u66f4\u52a0\u9ad8\u7d1a\u7684\u67e5\u8a62\u6a21\u5f0f\u3002 \u76ee\u6a19 \u00b6 \u901a\u904e\u5c0d\u672c\u7ae0\u7bc0 PromQL \u7684\u5b78\u7fd2\u4f60\u5c07\u80fd\u5920\u6709\u6548\u5730\u69cb\u5efa\u3001\u5206\u4eab\u548c\u7406\u89e3 PromQL \u67e5\u8a62\uff0c\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u5f9e\u5bb9\u61c9\u5c0d\u5831\u8b66\u898f\u5247\u3001\u5100\u9336\u76e4\u53ef\u8996\u5316\u7b49\u9700\u6c42\uff0c\u9084\u80fd\u5920\u907f\u514d\u4e00\u4e9b\u5728\u4f7f\u7528 PromQL \u8868\u9054\u5f0f\u7684\u6642\u5019\u9047\u5230\u7684\u4e00\u4e9b\u9677\u9631\u3002 \u57f7\u884c \u00b6 \u524d\u9762\u57fa\u790e\u7ae0\u7bc0\u6211\u5011\u4ecb\u7d39\u4e86 Prometheus \u6574\u9ad4\u7684\u67b6\u69cb\uff1a \u7576 Prometheus \u5f9e\u7cfb\u7d71\u548c\u670d\u52d9\u6536\u96c6\u6307\u6a19\u6578\u64da\u6642\uff0c\u5b83\u6703\u628a\u6578\u64da\u5b58\u5132\u5728\u5167\u7f6e\u7684\u6642\u5e8f\u6578\u64da\u5eab\uff08TSDB\uff09\u4e2d\uff0c\u8981\u5c0d\u6536\u96c6\u5230\u7684\u6578\u64da\u9032\u884c\u4efb\u4f55\u8655\u7406\uff0c\u6211\u5011\u90fd\u53ef\u4ee5\u4f7f\u7528 PromQL \u5f9e TSDB \u4e2d\u8b80\u53d6\u6578\u64da\uff0c\u540c\u6642\u53ef\u4ee5\u5c0d\u6240\u9078\u7684\u6578\u64da\u57f7\u884c\u904e\u6ffe\u3001\u805a\u5408\u4ee5\u53ca\u5176\u4ed6\u8f49\u63db\u64cd\u4f5c\u3002 PromQL \u7684\u57f7\u884c\u53ef\u4ee5\u901a\u904e\u5169\u7a2e\u65b9\u5f0f\u4f86\u89f8\u767c\uff1a \u5728 Prometheus \u670d\u52d9\u5668\u4e2d\uff0c\u8a18\u9304\u898f\u5247\u548c\u8b66\u5831\u898f\u5247\u6703\u5b9a\u671f\u904b\u884c\uff0c\u4e26\u57f7\u884c\u67e5\u8a62\u64cd\u4f5c\u4f86\u8a08\u7b97\u898f\u5247\u7d50\u679c\uff08\u4f8b\u5982\u89f8\u767c\u5831\u8b66\uff09\u3002\u8a72\u57f7\u884c\u5728 Prometheus \u670d\u52d9\u5167\u90e8\u9032\u884c\uff0c\u4e26\u5728\u914d\u7f6e\u898f\u5247\u6642\u81ea\u52d5\u767c\u751f\u3002 \u5916\u90e8\u7528\u6236\u548c UI \u754c\u9762\u53ef\u4ee5\u4f7f\u7528 Prometheus \u670d\u52d9\u63d0\u4f9b\u7684 HTTP API \u4f86\u57f7\u884c PromQL \u67e5\u8a62\u3002\u9019\u5c31\u662f\u5100\u9336\u76e4\u8edf\u4ef6\uff08\u4f8b\u5982 Grafana\u3001PromLens \u4ee5\u53ca Prometheus \u5167\u7f6e Web UI\uff09\u8a2a\u554f PromQL \u7684\u65b9\u5f0f\u3002 \u5834\u666f \u00b6 PromQL \u53ef\u4ee5\u7528\u65bc\u8a31\u591a\u76e3\u63a7\u5834\u666f\uff0c\u4e0b\u9762\u7c21\u55ae\u4ecb\u7d39\u5e7e\u500b\u76f8\u95dc\u6848\u4f8b\u3002 \u81e8\u6642\u67e5\u8a62 \u00b6 \u6211\u5011\u53ef\u4ee5\u7528 PromQL \u4f86\u5c0d\u6536\u96c6\u7684\u6578\u64da\u9032\u884c\u5be6\u6642\u67e5\u8a62\uff0c\u9019\u6709\u52a9\u65bc\u6211\u5011\u53bb\u8abf\u8a66\u548c\u8a3a\u65b7\u9047\u5230\u7684\u4e00\u4e9b\u554f\u984c\uff0c\u6211\u5011\u4e00\u822c\u4e5f\u662f\u76f4\u63a5\u4f7f\u7528\u5167\u7f6e\u7684\u8868\u9054\u5f0f\u67e5\u8a62\u754c\u9762\u4f86\u57f7\u884c\u9019\u985e\u67e5\u8a62\uff1a \u5100\u9336\u76e4 \u00b6 \u540c\u6a23\u6211\u5011\u4e5f\u53ef\u4ee5\u57fa\u65bc PromQL \u67e5\u8a62\u4f86\u5275\u5efa\u53ef\u8996\u5316\u7684\u5716\u5f62\u3001\u8868\u683c\u7b49\u9762\u677f\uff0c\u7576\u7136\u4e00\u822c\u6211\u5011\u90fd\u6703\u4f7f\u7528 Grafana\uff1a Grafana \u539f\u751f\u652f\u6301 Prometheus \u4f5c\u70ba\u6578\u64da\u6e90\uff0c\u4e26\u5167\u7f6e\u652f\u6301\u4e86 PromQL \u8868\u9054\u5f0f\u7684\u67e5\u8a62\u3002 \u5831\u8b66 \u00b6 Prometheus \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u57fa\u65bc PromQL \u5c0d\u6536\u96c6\u7684\u6578\u64da\u9032\u884c\u7684\u67e5\u8a62\u7d50\u679c\u4f86\u751f\u6210\u5831\u8b66\uff0c\u4e00\u500b\u5b8c\u6574\u7684\u5831\u8b66\u898f\u5247\u5982\u4e0b\u6240\u793a\uff1a groups : - name : demo - service - alerts rules : - alert : Many5xxErrors expr : | ( sum by ( path , instance , job ) ( rate ( demo_api_request_duration_seconds_count { status =~ \" 5.. \", job = \" demo \"}[ 1m ] ) ) / sum by ( path , instance , job ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 1m ] ) ) * 100 > 0.5 ) for : 30s labels : severity : critical annotations : title : \" {{$labels.instance}} high 5xx rate on {{$labels.path}} \" description : \" The 5xx error rate for path {{$labels.path}} on {{$labels.instance}} is {{$value}}%. \" \u9664\u4e86\u69cb\u6210\u5831\u8b66\u898f\u5247\u6838\u5fc3\u7684 PromQL \u8868\u9054\u5f0f\uff08\u4e0a\u9762 YAML \u6587\u4ef6\u4e2d\u7684 expr \u5c6c\u6027\uff09\uff0c\u5831\u8b66\u898f\u5247\u9084\u5305\u542b\u5176\u4ed6\u7684\u4e00\u4e9b\u5143\u6578\u64da\u5b57\u6bb5\uff0c\u5f8c\u9762\u5728\u5177\u9ad4\u8b1b\u89e3\u5831\u8b66\u7684\u7ae0\u7bc0\u4e2d\u6703\u8a73\u7d30\u548c\u5927\u5bb6\u8b1b\u89e3\u3002 \u7136\u5f8c\uff0cPrometheus \u53ef\u4ee5\u901a\u904e\u4e00\u500b\u540d\u70ba Alertmanager \u7684\u7d44\u4ef6\u4f86\u767c\u9001\u5831\u8b66\u901a\u77e5\uff0c\u53ef\u4ee5\u914d\u7f6e\u4e00\u4e9b\u63a5\u6536\u5668\u4f86\u63a5\u6536\u9019\u4e9b\u5831\u8b66\uff0c\u6bd4\u5982\u7528 Opsgenie \u63a5\u6536\u5831\u8b66\uff1a \u81ea\u52d5\u5316 \u00b6 \u6b64\u5916\u6211\u5011\u9084\u53ef\u4ee5\u69cb\u5efa\u81ea\u52d5\u5316\u6d41\u7a0b\uff0c\u91dd\u5c0d PromQL \u57f7\u884c\u7684\u67e5\u8a62\u7d50\u679c\u4f86\u505a\u51fa\u6c7a\u7b56\uff0c\u6bd4\u5982 Kubernetes \u4e2d\u57fa\u65bc\u81ea\u5b9a\u7fa9\u6307\u6a19\u7684 HPA\u3002","title":"PromQL \u7c21\u4ecb"},{"location":"prometheus/promql/intro/#promql","text":"\u539f\u6587: PromQL \u4ecb\u7ecd PromQL \u662f Prometheus \u76e3\u63a7\u7cfb\u7d71\u5167\u7f6e\u7684\u4e00\u7a2e\u67e5\u8a62\u8a9e\u8a00\uff0cPromQL \u5141\u8a31\u4f60\u4ee5\u9748\u6d3b\u7684\u65b9\u5f0f\u9078\u64c7\u3001\u805a\u5408\u7b49\u5176\u4ed6\u65b9\u5f0f\u8f49\u63db\u548c\u8a08\u7b97\u6642\u9593\u5e8f\u5217\u6578\u64da\uff0c\u8a72\u8a9e\u8a00\u50c5\u7528\u65bc\u8b80\u53d6\u6578\u64da\u3002\u53ef\u4ee5\u8aaa PromQL \u662f\u6211\u5011\u5b78\u7fd2 Prometheus \u6700\u56f0\u96e3\u4e5f\u662f\u6700\u91cd\u8981\u7684\u90e8\u5206\uff0c\u672c\u7ae0\u7bc0\u6211\u5011\u5c07\u4ecb\u7d39 PromQL \u7684\u57fa\u790e\u77e5\u8b58\u3001\u7406\u8ad6\u57fa\u790e\uff0c\u7136\u5f8c\u6703\u6df1\u5165\u4e86\u89e3\u66f4\u52a0\u9ad8\u7d1a\u7684\u67e5\u8a62\u6a21\u5f0f\u3002","title":"PromQL \u4ecb\u7d39"},{"location":"prometheus/promql/intro/#_1","text":"\u901a\u904e\u5c0d\u672c\u7ae0\u7bc0 PromQL \u7684\u5b78\u7fd2\u4f60\u5c07\u80fd\u5920\u6709\u6548\u5730\u69cb\u5efa\u3001\u5206\u4eab\u548c\u7406\u89e3 PromQL \u67e5\u8a62\uff0c\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u5f9e\u5bb9\u61c9\u5c0d\u5831\u8b66\u898f\u5247\u3001\u5100\u9336\u76e4\u53ef\u8996\u5316\u7b49\u9700\u6c42\uff0c\u9084\u80fd\u5920\u907f\u514d\u4e00\u4e9b\u5728\u4f7f\u7528 PromQL \u8868\u9054\u5f0f\u7684\u6642\u5019\u9047\u5230\u7684\u4e00\u4e9b\u9677\u9631\u3002","title":"\u76ee\u6a19"},{"location":"prometheus/promql/intro/#_2","text":"\u524d\u9762\u57fa\u790e\u7ae0\u7bc0\u6211\u5011\u4ecb\u7d39\u4e86 Prometheus \u6574\u9ad4\u7684\u67b6\u69cb\uff1a \u7576 Prometheus \u5f9e\u7cfb\u7d71\u548c\u670d\u52d9\u6536\u96c6\u6307\u6a19\u6578\u64da\u6642\uff0c\u5b83\u6703\u628a\u6578\u64da\u5b58\u5132\u5728\u5167\u7f6e\u7684\u6642\u5e8f\u6578\u64da\u5eab\uff08TSDB\uff09\u4e2d\uff0c\u8981\u5c0d\u6536\u96c6\u5230\u7684\u6578\u64da\u9032\u884c\u4efb\u4f55\u8655\u7406\uff0c\u6211\u5011\u90fd\u53ef\u4ee5\u4f7f\u7528 PromQL \u5f9e TSDB \u4e2d\u8b80\u53d6\u6578\u64da\uff0c\u540c\u6642\u53ef\u4ee5\u5c0d\u6240\u9078\u7684\u6578\u64da\u57f7\u884c\u904e\u6ffe\u3001\u805a\u5408\u4ee5\u53ca\u5176\u4ed6\u8f49\u63db\u64cd\u4f5c\u3002 PromQL \u7684\u57f7\u884c\u53ef\u4ee5\u901a\u904e\u5169\u7a2e\u65b9\u5f0f\u4f86\u89f8\u767c\uff1a \u5728 Prometheus \u670d\u52d9\u5668\u4e2d\uff0c\u8a18\u9304\u898f\u5247\u548c\u8b66\u5831\u898f\u5247\u6703\u5b9a\u671f\u904b\u884c\uff0c\u4e26\u57f7\u884c\u67e5\u8a62\u64cd\u4f5c\u4f86\u8a08\u7b97\u898f\u5247\u7d50\u679c\uff08\u4f8b\u5982\u89f8\u767c\u5831\u8b66\uff09\u3002\u8a72\u57f7\u884c\u5728 Prometheus \u670d\u52d9\u5167\u90e8\u9032\u884c\uff0c\u4e26\u5728\u914d\u7f6e\u898f\u5247\u6642\u81ea\u52d5\u767c\u751f\u3002 \u5916\u90e8\u7528\u6236\u548c UI \u754c\u9762\u53ef\u4ee5\u4f7f\u7528 Prometheus \u670d\u52d9\u63d0\u4f9b\u7684 HTTP API \u4f86\u57f7\u884c PromQL \u67e5\u8a62\u3002\u9019\u5c31\u662f\u5100\u9336\u76e4\u8edf\u4ef6\uff08\u4f8b\u5982 Grafana\u3001PromLens \u4ee5\u53ca Prometheus \u5167\u7f6e Web UI\uff09\u8a2a\u554f PromQL \u7684\u65b9\u5f0f\u3002","title":"\u57f7\u884c"},{"location":"prometheus/promql/intro/#_3","text":"PromQL \u53ef\u4ee5\u7528\u65bc\u8a31\u591a\u76e3\u63a7\u5834\u666f\uff0c\u4e0b\u9762\u7c21\u55ae\u4ecb\u7d39\u5e7e\u500b\u76f8\u95dc\u6848\u4f8b\u3002","title":"\u5834\u666f"},{"location":"prometheus/promql/intro/#_4","text":"\u6211\u5011\u53ef\u4ee5\u7528 PromQL \u4f86\u5c0d\u6536\u96c6\u7684\u6578\u64da\u9032\u884c\u5be6\u6642\u67e5\u8a62\uff0c\u9019\u6709\u52a9\u65bc\u6211\u5011\u53bb\u8abf\u8a66\u548c\u8a3a\u65b7\u9047\u5230\u7684\u4e00\u4e9b\u554f\u984c\uff0c\u6211\u5011\u4e00\u822c\u4e5f\u662f\u76f4\u63a5\u4f7f\u7528\u5167\u7f6e\u7684\u8868\u9054\u5f0f\u67e5\u8a62\u754c\u9762\u4f86\u57f7\u884c\u9019\u985e\u67e5\u8a62\uff1a","title":"\u81e8\u6642\u67e5\u8a62"},{"location":"prometheus/promql/intro/#_5","text":"\u540c\u6a23\u6211\u5011\u4e5f\u53ef\u4ee5\u57fa\u65bc PromQL \u67e5\u8a62\u4f86\u5275\u5efa\u53ef\u8996\u5316\u7684\u5716\u5f62\u3001\u8868\u683c\u7b49\u9762\u677f\uff0c\u7576\u7136\u4e00\u822c\u6211\u5011\u90fd\u6703\u4f7f\u7528 Grafana\uff1a Grafana \u539f\u751f\u652f\u6301 Prometheus \u4f5c\u70ba\u6578\u64da\u6e90\uff0c\u4e26\u5167\u7f6e\u652f\u6301\u4e86 PromQL \u8868\u9054\u5f0f\u7684\u67e5\u8a62\u3002","title":"\u5100\u9336\u76e4"},{"location":"prometheus/promql/intro/#_6","text":"Prometheus \u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528\u57fa\u65bc PromQL \u5c0d\u6536\u96c6\u7684\u6578\u64da\u9032\u884c\u7684\u67e5\u8a62\u7d50\u679c\u4f86\u751f\u6210\u5831\u8b66\uff0c\u4e00\u500b\u5b8c\u6574\u7684\u5831\u8b66\u898f\u5247\u5982\u4e0b\u6240\u793a\uff1a groups : - name : demo - service - alerts rules : - alert : Many5xxErrors expr : | ( sum by ( path , instance , job ) ( rate ( demo_api_request_duration_seconds_count { status =~ \" 5.. \", job = \" demo \"}[ 1m ] ) ) / sum by ( path , instance , job ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 1m ] ) ) * 100 > 0.5 ) for : 30s labels : severity : critical annotations : title : \" {{$labels.instance}} high 5xx rate on {{$labels.path}} \" description : \" The 5xx error rate for path {{$labels.path}} on {{$labels.instance}} is {{$value}}%. \" \u9664\u4e86\u69cb\u6210\u5831\u8b66\u898f\u5247\u6838\u5fc3\u7684 PromQL \u8868\u9054\u5f0f\uff08\u4e0a\u9762 YAML \u6587\u4ef6\u4e2d\u7684 expr \u5c6c\u6027\uff09\uff0c\u5831\u8b66\u898f\u5247\u9084\u5305\u542b\u5176\u4ed6\u7684\u4e00\u4e9b\u5143\u6578\u64da\u5b57\u6bb5\uff0c\u5f8c\u9762\u5728\u5177\u9ad4\u8b1b\u89e3\u5831\u8b66\u7684\u7ae0\u7bc0\u4e2d\u6703\u8a73\u7d30\u548c\u5927\u5bb6\u8b1b\u89e3\u3002 \u7136\u5f8c\uff0cPrometheus \u53ef\u4ee5\u901a\u904e\u4e00\u500b\u540d\u70ba Alertmanager \u7684\u7d44\u4ef6\u4f86\u767c\u9001\u5831\u8b66\u901a\u77e5\uff0c\u53ef\u4ee5\u914d\u7f6e\u4e00\u4e9b\u63a5\u6536\u5668\u4f86\u63a5\u6536\u9019\u4e9b\u5831\u8b66\uff0c\u6bd4\u5982\u7528 Opsgenie \u63a5\u6536\u5831\u8b66\uff1a","title":"\u5831\u8b66"},{"location":"prometheus/promql/intro/#_7","text":"\u6b64\u5916\u6211\u5011\u9084\u53ef\u4ee5\u69cb\u5efa\u81ea\u52d5\u5316\u6d41\u7a0b\uff0c\u91dd\u5c0d PromQL \u57f7\u884c\u7684\u67e5\u8a62\u7d50\u679c\u4f86\u505a\u51fa\u6c7a\u7b56\uff0c\u6bd4\u5982 Kubernetes \u4e2d\u57fa\u65bc\u81ea\u5b9a\u7fa9\u6307\u6a19\u7684 HPA\u3002","title":"\u81ea\u52d5\u5316"},{"location":"prometheus/promql/metric-type/","text":"\u6307\u6a19\u985e\u578b \u00b6 \u539f\u6587: \u6307\u6807\u7c7b\u578b \u5f9e\u5b58\u5132\u4e0a\u4f86\u8b1b\u6240\u6709\u7684\u76e3\u63a7\u6307\u6a19\u90fd\u662f\u76f8\u540c\u7684\uff0c\u4f46\u662f\u5728\u4e0d\u540c\u7684\u5834\u666f\u4e0b\u9019\u4e9b\u6307\u6a19\u53c8\u6709\u4e00\u4e9b\u7d30\u5fae\u7684\u5dee\u7570\u3002\u4f8b\u5982\uff0c\u5728 Node Exporter \u8fd4\u56de\u7684\u6a23\u672c\u4e2d\u6307\u6a19 node_load1 \u53cd\u61c9\u7684\u662f\u7576\u524d\u7cfb\u7d71\u7684\u8ca0\u8f09\u72c0\u614b\uff0c\u96a8\u8457\u6642\u9593\u7684\u8b8a\u5316\u9019\u500b\u6307\u6a19\u8fd4\u56de\u7684\u6a23\u672c\u6578\u64da\u662f\u5728\u4e0d\u65b7\u8b8a\u5316\u7684\u3002\u800c\u6307\u6a19 node_cpu_seconds_total \u6240\u7372\u53d6\u5230\u7684\u6a23\u672c\u6578\u64da\u537b\u4e0d\u540c\uff0c\u5b83\u662f\u4e00\u500b\u6301\u7e8c\u589e\u5927\u7684\u503c\uff0c\u56e0\u70ba\u5176\u53cd\u61c9\u7684\u662f CPU \u7684\u7d2f\u8a08\u4f7f\u7528\u6642\u9593\uff0c\u5f9e\u7406\u8ad6\u4e0a\u8b1b\u53ea\u8981\u4fc2\u7d71\u4e0d\u95dc\u6a5f\uff0c\u9019\u500b\u503c\u662f\u6703\u4e00\u76f4\u8b8a\u5927\u3002 \u70ba\u4e86\u80fd\u5920\u5e6b\u52a9\u7528\u6236\u7406\u89e3\u548c\u5340\u5206\u9019\u4e9b\u4e0d\u540c\u76e3\u63a7\u6307\u6a19\u4e4b\u9593\u7684\u5dee\u7570\uff0cPrometheus \u5b9a\u7fa9\u4e86 4 \u7a2e\u4e0d\u540c\u7684\u6307\u6a19\u985e\u578b\uff1aCounter\uff08\u8a08\u6578\u5668\uff09\u3001Gauge\uff08\u5100\u9336\u76e4\uff09\u3001Histogram\uff08\u76f4\u65b9\u5716\uff09\u3001Summary\uff08\u6458\u8981\uff09\u3002 \u5728 node-exporter\uff08\u5f8c\u9762\u6703\u8a73\u7d30\u8b1b\u89e3\uff09\u8fd4\u56de\u7684\u6a23\u672c\u6578\u64da\u4e2d\uff0c\u5176\u8a3b\u91cb\u4e2d\u4e5f\u5305\u542b\u4e86\u8a72\u6a23\u672c\u7684\u985e\u578b\u3002\u4f8b\u5982\uff1a # HELP node_cpu_seconds_total Seconds the cpus spent in each mode. # TYPE node_cpu_seconds_total counter node_cpu_seconds_total { cpu = \"cpu0\" ,mode = \"idle\" } 362812 .7890625 Counter \u00b6 Counter (\u53ea\u589e\u4e0d\u6e1b\u7684\u8a08\u6578\u5668) \u985e\u578b\u7684\u6307\u6a19\u5176\u5de5\u4f5c\u65b9\u5f0f\u548c\u8a08\u6578\u5668\u4e00\u6a23\uff0c \u53ea\u589e\u4e0d\u6e1b \uff0c\u6240\u4ee5\u5b83\u5c0d\u65bc\u5b58\u5132\u8af8\u5982\u670d\u52d9\u7684 HTTP \u8acb\u6c42\u6578\u91cf\u6216\u4f7f\u7528\u7684 CPU \u6642\u9593\u4e4b\u985e\u7684\u4fe1\u606f\u975e\u5e38\u6709\u7528\u3002\u5e38\u898b\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u5982 http_requests_total \u3001 node_cpu_seconds_total \u90fd\u662f Counter \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\u3002 \u53ef\u80fd\u4f60\u6703\u89ba\u5f97\u4e00\u76f4\u589e\u52a0\u7684\u6578\u64da\u6c92\u4ec0\u9ebc\u7528\u8655\uff0c\u4e86\u89e3\u670d\u52d9\u5f9e\u958b\u59cb\u6709\u591a\u5c11\u8acb\u6c42\u6709\u4ec0\u9ebc\u50f9\u503c\u55ce\uff1f \u4f46\u662f\u9700\u8981\u8a18\u4f4f\uff0c\u6bcf\u500b\u6307\u6a19\u90fd\u5b58\u5132\u4e86\u6642\u9593\u6233\u7684\uff0c\u6240\u6709\u4f60\u7684 HTTP \u8acb\u6c42\u6578\u73fe\u5728\u53ef\u80fd\u662f 1000 \u842c\uff0c\u4f46\u662f Prometheus \u4e5f\u6703\u8a18\u9304\u4e4b\u524d\u67d0\u500b\u6642\u9593\u9ede\u7684\u503c\uff0c\u6211\u5011\u53ef\u4ee5\u53bb\u67e5\u8a62\u904e\u53bb\u4e00\u500b\u5c0f\u6642\u5167\u7684\u8acb\u6c42\u6578\uff0c\u7576\u7136\u66f4\u591a\u7684\u6642\u5019\u6211\u5011\u60f3\u8981\u770b\u5230\u7684\u662f\u8acb\u6c42\u6578\u589e\u52a0\u6216\u6e1b\u5c11\u7684\u901f\u5ea6\u6709\u591a\u5feb\uff0c\u56e0\u6b64\u901a\u5e38\u60c5\u6cc1\u5c0d\u65bc Counter \u6307\u6a19\u6211\u5011\u90fd\u662f\u53bb\u67e5\u770b\u8b8a\u5316\u7387\u800c\u4e0d\u662f\u672c\u8eab\u7684\u6578\u5b57\u3002 PromQL \u5167\u7f6e\u7684\u805a\u5408\u64cd\u4f5c\u548c\u51fd\u6578\u53ef\u4ee5\u8b93\u7528\u6236\u5c0d\u9019\u4e9b\u6578\u64da\u9032\u884c\u9032\u4e00\u6b65\u7684\u5206\u6790\uff0c\u4f8b\u5982\uff0c\u901a\u904e rate() \u51fd\u6578\u7372\u53d6 HTTP \u8acb\u6c42\u7684\u589e\u9577\u7387\uff1a rate ( http_requests_total [ 5m ] ) Gauge \u00b6 \u8207 Counter \u4e0d\u540c\uff0c Gauge \uff08\u53ef\u589e\u53ef\u6e1b\u7684\u5100\u9336\u76e4\uff09\u985e\u578b\u7684\u6307\u6a19\u5074\u91cd\u65bc \u53cd\u61c9\u7cfb\u7d71\u7684\u7576\u524d\u72c0\u614b \uff0c\u56e0\u6b64\u9019\u985e\u6307\u6a19\u7684\u6a23\u672c\u6578\u64da\u53ef\u589e\u53ef\u6e1b\u3002\u5e38\u898b\u6307\u6a19\u5982 node_memory_MemFree_bytes \uff08\u7576\u524d\u4e3b\u6a5f\u7a7a\u9592\u7684\u5167\u5b58\u5927\u5c0f\uff09\u3001 node_memory_MemAvailable_bytes \uff08\u53ef\u7528\u5167\u5b58\u5927\u5c0f\uff09\u90fd\u662f Gauge \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\u3002\u7531\u65bc Gauge \u6307\u6a19\u4ecd\u7136\u5e36\u6709\u6642\u9593\u6233\u5b58\u5132\uff0c\u6240\u6709\u6211\u5011\u53ef\u4ee5\u770b\u5230\u96a8\u6642\u9593\u8b8a\u5316\u7684\u503c\uff0c\u901a\u5e38\u53ef\u4ee5\u76f4\u63a5\u628a\u5b83\u5011\u7e6a\u88fd\u51fa\u4f86\uff0c\u9019\u6a23\u5c31\u53ef\u4ee5\u770b\u5230\u503c\u672c\u8eab\u800c\u4e0d\u662f\u8b8a\u5316\u7387\u4e86\uff0c\u901a\u904e Gauge \u6307\u6a19\uff0c\u7528\u6236\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u7cfb\u7d71\u7684\u7576\u524d\u72c0\u614b\u3002 \u9019\u4e9b\u7c21\u55ae\u7684\u6307\u6a19\u985e\u578b\u90fd\u53ea\u662f\u70ba\u6bcf\u500b\u6a23\u672c\u7372\u53d6\u4e00\u500b\u6578\u5b57\uff0c\u4f46 Prometheus \u7684\u5f37\u5927\u4e4b\u8655\u5728\u65bc\u5982\u4f55\u8b93\u4f60\u8ddf\u8e2a\u5b83\u5011\uff0c\u6bd4\u5982\u6211\u5011\u7e6a\u88fd\u4e86\u5169\u5f35\u5716\uff0c\u4e00\u500b\u662f HTTP \u8acb\u6c42\u7684\u8b8a\u5316\u7387\uff0c\u53e6\u4e00\u500b\u662f\u5206\u914d\u7684 gauge \u985e\u578b\u7684\u5be6\u969b\u5167\u5b58\uff0c\u76f4\u63a5\u5f9e\u5716\u4e0a\u5c31\u53ef\u4ee5\u770b\u51fa\u9019\u5169\u500b\u4e4b\u9593\u6709\u4e00\u7a2e\u95dc\u806f\u6027\uff0c\u7576\u8acb\u6c42\u51fa\u73fe\u5cf0\u503c\u7684\u6642\u5019\uff0c\u5167\u5b58\u7684\u4f7f\u7528\u4e5f\u6703\u51fa\u73fe\u5cf0\u503c\uff0c\u4f46\u662f\u6211\u5011\u4ed4\u7d30\u89c0\u5bdf\u4e5f\u6703\u767c\u73fe\u5728\u5cf0\u503c\u904e\u5f8c\uff0c\u5167\u5b58\u4f7f\u7528\u91cf\u4e26\u6c92\u6709\u6062\u5fa9\u5230\u5cf0\u503c\u524d\u7684\u6c34\u5e73\uff0c\u6574\u9ad4\u4e0a\u5b83\u5728\u9010\u6f38\u589e\u52a0\uff0c\u9019\u8868\u660e\u5f88\u53ef\u80fd\u61c9\u7528\u7a0b\u5e8f\u4e2d\u5b58\u5728\u5167\u5b58\u6d29\u9732\u7684\u554f\u984c\uff0c\u901a\u904e\u9019\u4e9b\u7c21\u55ae\u7684\u6307\u6a19\u5c31\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u627e\u5230\u9019\u4e9b\u53ef\u80fd\u5b58\u5728\u7684\u554f\u984c\u3002 \u5c0d\u65bc Gauge \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u901a\u904e PromQL \u5167\u7f6e\u51fd\u6578 delta() \u53ef\u4ee5\u7372\u53d6\u6a23\u672c\u5728\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u7684\u8b8a\u5316\u60c5\u6cc1\u3002\u4f8b\u5982\uff0c\u8a08\u7b97 CPU \u6eab\u5ea6\u5728\u5169\u500b\u5c0f\u6642\u5167\u7684\u5dee\u7570\uff1a delta ( cpu_temp_celsius { host = \" zeus \"}[ 2h ] ) \u9084\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 predict_linear() \u5c0d\u6578\u64da\u7684\u8b8a\u5316\u8da8\u52e2\u9032\u884c\u9810\u6e2c\u3002\u4f8b\u5982\uff0c\u9810\u6e2c\u7cfb\u7d71\u78c1\u76e4\u7a7a\u9593\u5728 4 \u500b\u5c0f\u6642\u4e4b\u5f8c\u7684\u5269\u9918\u60c5\u6cc1\uff1a predict_linear ( node_filesystem_free_bytes [ 1h ], 4 * 3600 ) Histogram \u548c Summary \u00b6 \u9664\u4e86 Counter \u548c Gauge \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\u4ee5\u5916\uff0cPrometheus \u9084\u5b9a\u7fa9\u4e86 Histogram \u548c Summary \u7684\u6307\u6a19\u985e\u578b\u3002 Histogram \u548c Summary \u4e3b\u7528\u7528\u65bc\u7d71\u8a08\u548c\u5206\u6790\u6a23\u672c\u7684\u5206\u4f48\u60c5\u6cc1\u3002 \u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\u4eba\u5011\u90fd\u50be\u5411\u65bc\u4f7f\u7528\u67d0\u4e9b\u91cf\u5316\u6307\u6a19\u7684\u5e73\u5747\u503c\uff0c\u4f8b\u5982 CPU \u7684\u5e73\u5747\u4f7f\u7528\u7387\u3001\u9801\u9762\u7684\u5e73\u5747\u97ff\u61c9\u6642\u9593\uff0c\u9019\u7a2e\u65b9\u5f0f\u4e5f\u6709\u5f88\u660e\u986f\u7684\u554f\u984c\uff0c\u4ee5\u7cfb\u7d71 API \u8abf\u7528\u7684\u5e73\u5747\u97ff\u61c9\u6642\u9593\u70ba\u4f8b\uff1a\u5982\u679c\u5927\u591a\u6578 API \u8acb\u6c42\u90fd\u7dad\u6301\u5728 100ms \u7684\u97ff\u61c9\u6642\u9593\u7bc4\u570d\u5167\uff0c\u800c\u500b\u5225\u8acb\u6c42\u7684\u97ff\u61c9\u6642\u9593\u9700\u8981 5s\uff0c\u90a3\u9ebc\u5c31\u6703\u5c0e\u81f4\u67d0\u4e9b WEB \u9801\u9762\u7684\u97ff\u61c9\u6642\u9593\u843d\u5230 \u4e2d\u4f4d\u6578 \u4e0a\uff0c\u800c\u9019\u7a2e\u73fe\u50cf\u88ab\u7a31\u70ba \u9577\u5c3e\u554f\u984c \u3002 \u70ba\u4e86\u5340\u5206\u662f \u5e73\u5747\u7684\u6162\u9084\u662f\u9577\u5c3e\u7684\u6162 \uff0c\u6700\u7c21\u55ae\u7684\u65b9\u5f0f\u5c31\u662f\u6309\u7167\u8acb\u6c42\u5ef6\u9072\u7684\u7bc4\u570d\u9032\u884c\u5206\u7d44\u3002\u4f8b\u5982\uff0c\u7d71\u8a08\u5ef6\u9072\u5728 0~10ms \u4e4b\u9593\u7684\u8acb\u6c42\u6578\u6709\u591a\u5c11\u800c 10~20ms \u4e4b\u9593\u7684\u8acb\u6c42\u6578\u53c8\u6709\u591a\u5c11\u3002\u901a\u904e\u9019\u7a2e\u65b9\u5f0f\u53ef\u4ee5\u5feb\u901f\u5206\u6790\u7cfb\u7d71\u6162\u7684\u539f\u56e0\u3002 Histogram \u548c Summary \u90fd\u662f\u70ba\u4e86\u80fd\u5920\u89e3\u6c7a\u9019\u6a23\u7684\u554f\u984c\u5b58\u5728\u7684\uff0c\u901a\u904e Histogram \u548cSummary \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u6211\u5011\u53ef\u4ee5\u5feb\u901f\u4e86\u89e3\u76e3\u63a7\u6a23\u672c\u7684\u5206\u4f48\u60c5\u6cc1\u3002 Summary \u00b6 \u6458\u8981\u7528\u65bc\u8a18\u9304\u67d0\u4e9b\u6771\u897f\u7684\u5e73\u5747\u5927\u5c0f\uff0c\u53ef\u80fd\u662f\u8a08\u7b97\u6240\u9700\u7684\u6642\u9593\u6216\u8655\u7406\u7684\u6587\u4ef6\u5927\u5c0f\uff0c\u6458\u8981\u986f\u793a\u5169\u500b\u76f8\u95dc\u7684\u4fe1\u606f\uff1a count \uff08\u4e8b\u4ef6\u767c\u751f\u7684\u6b21\u6578\uff09\u548c sum \uff08\u6240\u6709\u4e8b\u4ef6\u7684\u7e3d\u5927\u5c0f\uff09\uff0c\u5982\u4e0b\u5716\u8a08\u7b97\u6458\u8981\u6307\u6a19\u53ef\u4ee5\u8fd4\u56de\u6b21\u6578\u70ba 3 \u548c\u7e3d\u548c 15\uff0c\u4e5f\u5c31\u610f\u5473\u8457 3 \u6b21\u8a08\u7b97\u7e3d\u5171\u9700\u8981 15s \u4f86\u8655\u7406\uff0c\u5e73\u5747\u6bcf\u6b21\u8a08\u7b97\u9700\u8981\u82b1\u8cbb 5s\u3002\u4e0b\u4e00\u500b\u6a23\u672c\u7684\u6b21\u6578\u70ba 10\uff0c\u7e3d\u548c\u70ba 113\uff0c\u90a3\u9ebc\u5e73\u5747\u503c\u70ba 11.3\uff0c\u56e0\u70ba\u5169\u7d44\u6307\u6a19\u90fd\u8a18\u9304\u6709\u6642\u9593\u6233\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u6458\u8981\u4f86\u69cb\u5efa\u4e00\u500b\u5716\u8868\uff0c\u986f\u793a\u5e73\u5747\u503c\u7684\u8b8a\u5316\u7387\uff0c\u6bd4\u5982\u5716\u4e0a\u7684\u8a9e\u53e5\u8868\u793a\u7684\u662f 5 \u5206\u9418\u6642\u9593\u6bb5\u5167\u7684\u5e73\u5747\u901f\u7387\u3002 \u4f8b\u5982\uff0c\u6307\u6a19 prometheus_tsdb_wal_fsync_duration_seconds \u7684\u6307\u6a19\u985e\u578b\u70ba Summary \uff0c\u5b83\u8a18\u9304\u4e86 Prometheus Server \u4e2d wal_fsync \u7684\u8655\u7406\u6642\u9593\uff0c\u901a\u904e\u8a2a\u554f Prometheus Server \u7684 /metrics \u5730\u5740\uff0c\u53ef\u4ee5\u7372\u53d6\u5230\u4ee5\u4e0b\u76e3\u63a7\u6a23\u672c\u6578\u64da\uff1a # HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync. # TYPE prometheus_tsdb_wal_fsync_duration_seconds summary prometheus_tsdb_wal_fsync_duration_seconds { quantile = \"0.5\" } 0 .012352463 prometheus_tsdb_wal_fsync_duration_seconds { quantile = \"0.9\" } 0 .014458005 prometheus_tsdb_wal_fsync_duration_seconds { quantile = \"0.99\" } 0 .017316173 prometheus_tsdb_wal_fsync_duration_seconds_sum 2 .888716127000002 prometheus_tsdb_wal_fsync_duration_seconds_count 216 \u5f9e\u4e0a\u9762\u7684\u6a23\u672c\u4e2d\u53ef\u4ee5\u5f97\u77e5\u7576\u524d Prometheus Server \u9032\u884c wal_fsync \u64cd\u4f5c\u7684\u7e3d\u6b21\u6578\u70ba 216 \u6b21\uff0c\u8017\u6642 2.888716127000002s\u3002\u5176\u4e2d\u4e2d\u4f4d\u6578\uff08quantile=0.5\uff09\u7684\u8017\u6642\u70ba 0.012352463\uff0c9 \u5206\u4f4d\u6578\uff08quantile=0.9\uff09\u7684\u8017\u6642\u70ba 0.014458005s\u3002 Histogram \u00b6 \u6458\u8981\u975e\u5e38\u6709\u7528\uff0c\u4f46\u662f\u5e73\u5747\u503c\u6703\u96b1\u85cf\u4e00\u4e9b\u7d30\u7bc0\uff0c\u4e0a\u5716\u4e2d 10 \u8207 113 \u7684\u7e3d\u548c\u5305\u542b\u975e\u5e38\u5ee3\u7684\u7bc4\u570d\uff0c\u5982\u679c\u6211\u5011\u60f3\u67e5\u770b\u6642\u9593\u82b1\u5728\u4ec0\u9ebc\u5730\u65b9\u4e86\uff0c\u90a3\u9ebc\u6211\u5011\u5c31\u9700\u8981\u76f4\u65b9\u5716\u4e86\u3002 \u76f4\u65b9\u5716\u4ee5 bucket \u6876\u7684\u5f62\u5f0f\u8a18\u9304\u6578\u64da\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u80fd\u6709\u4e00\u500b\u6876\u7528\u65bc\u9700\u8981 1s \u6216\u66f4\u5c11\u7684\u8a08\u7b97\uff0c\u53e6\u4e00\u500b\u6876\u7528\u65bc 5 \u79d2\u6216\u66f4\u5c11\u300110 \u79d2\u6216\u66f4\u5c11\u300120 \u79d2\u6216\u66f4\u5c11\u300160 \u79d2\u6216\u66f4\u5c11\u3002\u8a72\u6307\u6a19\u8fd4\u56de\u6bcf\u500b\u5b58\u5132\u6876\u7684\u8a08\u6578\uff0c\u5176\u4e2d 3 \u500b\u5728 5 \u79d2\u6216\u66f4\u77ed\u7684\u6642\u9593\u5167\u5b8c\u6210\uff0c6 \u500b\u5728 10 \u79d2\u6216\u66f4\u77ed\u7684\u6642\u9593\u5167\u5b8c\u6210\u3002 Prometheus \u4e2d\u7684\u76f4\u65b9\u5716\u662f \u7d2f\u7a4d \u7684\uff0c\u56e0\u6b64\u6240\u6709 10 \u6b21\u8a08\u7b97\u90fd\u5c6c\u65bc 60 \u79d2\u6216\u66f4\u5c11\u7684\u6642\u9593\u6bb5\uff0c\u800c\u5728\u9019 10 \u6b21\u4e2d\uff0c\u6709 9 \u6b21\u7684\u8655\u7406\u6642\u9593\u70ba 20 \u79d2\u6216\u66f4\u5c11\uff0c\u9019\u986f\u793a\u4e86\u6578\u64da\u7684\u5206\u4f48\u3002\u6240\u4ee5\u53ef\u4ee5\u770b\u5230\u6211\u5011\u7684\u5927\u90e8\u5206\u8a08\u7b97\u90fd\u5728 10 \u79d2\u4ee5\u4e0b\uff0c\u53ea\u6709\u4e00\u500b\u8d85\u904e 20 \u79d2\uff0c\u9019\u5c0d\u65bc\u8a08\u7b97\u767e\u5206\u4f4d\u6578\u5f88\u6709\u7528\u3002 \u5728 Prometheus Server \u81ea\u8eab\u8fd4\u56de\u7684\u6a23\u672c\u6578\u64da\u4e2d\uff0c\u6211\u5011\u4e5f\u80fd\u627e\u5230\u985e\u578b\u70ba Histogram \u7684\u76e3\u63a7\u6307\u6a19 prometheus_tsdb_compaction_chunk_range_seconds_bucket \uff1a # HELP prometheus_tsdb_compaction_chunk_range_seconds Final time range of chunks on their first compaction # TYPE prometheus_tsdb_compaction_chunk_range_seconds histogram prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"100\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"400\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"1600\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"6400\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"25600\" } 405 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"102400\" } 25690 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"409600\" } 71863 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"1.6384e+06\" } 115928 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"6.5536e+06\" } 2 .5687892e+07 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"2.62144e+07\" } 2 .5687896e+07 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"+Inf\" } 2 .5687896e+07 prometheus_tsdb_compaction_chunk_range_seconds_sum 4 .7728699529576e+13 prometheus_tsdb_compaction_chunk_range_seconds_count 2 .5687896e+07 \u8207 Summary \u985e\u578b\u7684\u6307\u6a19\u76f8\u4f3c\u4e4b\u8655\u5728\u65bc Histogram \u985e\u578b\u7684\u6a23\u672c\u540c\u6a23\u6703\u53cd\u61c9\u7576\u524d\u6307\u6a19\u7684\u8a18\u9304\u7684\u7e3d\u6578(\u4ee5 _count \u4f5c\u70ba\u5f8c\u7db4)\u4ee5\u53ca\u5176\u503c\u7684\u7e3d\u91cf\uff08\u4ee5 _sum \u4f5c\u70ba\u5f8c\u7db4\uff09\u3002\u4e0d\u540c\u5728\u65bc Histogram \u6307\u6a19\u76f4\u63a5\u53cd\u61c9\u4e86\u5728\u4e0d\u540c\u5340\u9593\u5167\u6a23\u672c\u7684\u500b\u6578\uff0c\u5340\u9593\u901a\u904e\u6a19\u7c64 le \u9032\u884c\u5b9a\u7fa9\u3002","title":"\u6307\u6a19\u985e\u578b"},{"location":"prometheus/promql/metric-type/#_1","text":"\u539f\u6587: \u6307\u6807\u7c7b\u578b \u5f9e\u5b58\u5132\u4e0a\u4f86\u8b1b\u6240\u6709\u7684\u76e3\u63a7\u6307\u6a19\u90fd\u662f\u76f8\u540c\u7684\uff0c\u4f46\u662f\u5728\u4e0d\u540c\u7684\u5834\u666f\u4e0b\u9019\u4e9b\u6307\u6a19\u53c8\u6709\u4e00\u4e9b\u7d30\u5fae\u7684\u5dee\u7570\u3002\u4f8b\u5982\uff0c\u5728 Node Exporter \u8fd4\u56de\u7684\u6a23\u672c\u4e2d\u6307\u6a19 node_load1 \u53cd\u61c9\u7684\u662f\u7576\u524d\u7cfb\u7d71\u7684\u8ca0\u8f09\u72c0\u614b\uff0c\u96a8\u8457\u6642\u9593\u7684\u8b8a\u5316\u9019\u500b\u6307\u6a19\u8fd4\u56de\u7684\u6a23\u672c\u6578\u64da\u662f\u5728\u4e0d\u65b7\u8b8a\u5316\u7684\u3002\u800c\u6307\u6a19 node_cpu_seconds_total \u6240\u7372\u53d6\u5230\u7684\u6a23\u672c\u6578\u64da\u537b\u4e0d\u540c\uff0c\u5b83\u662f\u4e00\u500b\u6301\u7e8c\u589e\u5927\u7684\u503c\uff0c\u56e0\u70ba\u5176\u53cd\u61c9\u7684\u662f CPU \u7684\u7d2f\u8a08\u4f7f\u7528\u6642\u9593\uff0c\u5f9e\u7406\u8ad6\u4e0a\u8b1b\u53ea\u8981\u4fc2\u7d71\u4e0d\u95dc\u6a5f\uff0c\u9019\u500b\u503c\u662f\u6703\u4e00\u76f4\u8b8a\u5927\u3002 \u70ba\u4e86\u80fd\u5920\u5e6b\u52a9\u7528\u6236\u7406\u89e3\u548c\u5340\u5206\u9019\u4e9b\u4e0d\u540c\u76e3\u63a7\u6307\u6a19\u4e4b\u9593\u7684\u5dee\u7570\uff0cPrometheus \u5b9a\u7fa9\u4e86 4 \u7a2e\u4e0d\u540c\u7684\u6307\u6a19\u985e\u578b\uff1aCounter\uff08\u8a08\u6578\u5668\uff09\u3001Gauge\uff08\u5100\u9336\u76e4\uff09\u3001Histogram\uff08\u76f4\u65b9\u5716\uff09\u3001Summary\uff08\u6458\u8981\uff09\u3002 \u5728 node-exporter\uff08\u5f8c\u9762\u6703\u8a73\u7d30\u8b1b\u89e3\uff09\u8fd4\u56de\u7684\u6a23\u672c\u6578\u64da\u4e2d\uff0c\u5176\u8a3b\u91cb\u4e2d\u4e5f\u5305\u542b\u4e86\u8a72\u6a23\u672c\u7684\u985e\u578b\u3002\u4f8b\u5982\uff1a # HELP node_cpu_seconds_total Seconds the cpus spent in each mode. # TYPE node_cpu_seconds_total counter node_cpu_seconds_total { cpu = \"cpu0\" ,mode = \"idle\" } 362812 .7890625","title":"\u6307\u6a19\u985e\u578b"},{"location":"prometheus/promql/metric-type/#counter","text":"Counter (\u53ea\u589e\u4e0d\u6e1b\u7684\u8a08\u6578\u5668) \u985e\u578b\u7684\u6307\u6a19\u5176\u5de5\u4f5c\u65b9\u5f0f\u548c\u8a08\u6578\u5668\u4e00\u6a23\uff0c \u53ea\u589e\u4e0d\u6e1b \uff0c\u6240\u4ee5\u5b83\u5c0d\u65bc\u5b58\u5132\u8af8\u5982\u670d\u52d9\u7684 HTTP \u8acb\u6c42\u6578\u91cf\u6216\u4f7f\u7528\u7684 CPU \u6642\u9593\u4e4b\u985e\u7684\u4fe1\u606f\u975e\u5e38\u6709\u7528\u3002\u5e38\u898b\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u5982 http_requests_total \u3001 node_cpu_seconds_total \u90fd\u662f Counter \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\u3002 \u53ef\u80fd\u4f60\u6703\u89ba\u5f97\u4e00\u76f4\u589e\u52a0\u7684\u6578\u64da\u6c92\u4ec0\u9ebc\u7528\u8655\uff0c\u4e86\u89e3\u670d\u52d9\u5f9e\u958b\u59cb\u6709\u591a\u5c11\u8acb\u6c42\u6709\u4ec0\u9ebc\u50f9\u503c\u55ce\uff1f \u4f46\u662f\u9700\u8981\u8a18\u4f4f\uff0c\u6bcf\u500b\u6307\u6a19\u90fd\u5b58\u5132\u4e86\u6642\u9593\u6233\u7684\uff0c\u6240\u6709\u4f60\u7684 HTTP \u8acb\u6c42\u6578\u73fe\u5728\u53ef\u80fd\u662f 1000 \u842c\uff0c\u4f46\u662f Prometheus \u4e5f\u6703\u8a18\u9304\u4e4b\u524d\u67d0\u500b\u6642\u9593\u9ede\u7684\u503c\uff0c\u6211\u5011\u53ef\u4ee5\u53bb\u67e5\u8a62\u904e\u53bb\u4e00\u500b\u5c0f\u6642\u5167\u7684\u8acb\u6c42\u6578\uff0c\u7576\u7136\u66f4\u591a\u7684\u6642\u5019\u6211\u5011\u60f3\u8981\u770b\u5230\u7684\u662f\u8acb\u6c42\u6578\u589e\u52a0\u6216\u6e1b\u5c11\u7684\u901f\u5ea6\u6709\u591a\u5feb\uff0c\u56e0\u6b64\u901a\u5e38\u60c5\u6cc1\u5c0d\u65bc Counter \u6307\u6a19\u6211\u5011\u90fd\u662f\u53bb\u67e5\u770b\u8b8a\u5316\u7387\u800c\u4e0d\u662f\u672c\u8eab\u7684\u6578\u5b57\u3002 PromQL \u5167\u7f6e\u7684\u805a\u5408\u64cd\u4f5c\u548c\u51fd\u6578\u53ef\u4ee5\u8b93\u7528\u6236\u5c0d\u9019\u4e9b\u6578\u64da\u9032\u884c\u9032\u4e00\u6b65\u7684\u5206\u6790\uff0c\u4f8b\u5982\uff0c\u901a\u904e rate() \u51fd\u6578\u7372\u53d6 HTTP \u8acb\u6c42\u7684\u589e\u9577\u7387\uff1a rate ( http_requests_total [ 5m ] )","title":"Counter"},{"location":"prometheus/promql/metric-type/#gauge","text":"\u8207 Counter \u4e0d\u540c\uff0c Gauge \uff08\u53ef\u589e\u53ef\u6e1b\u7684\u5100\u9336\u76e4\uff09\u985e\u578b\u7684\u6307\u6a19\u5074\u91cd\u65bc \u53cd\u61c9\u7cfb\u7d71\u7684\u7576\u524d\u72c0\u614b \uff0c\u56e0\u6b64\u9019\u985e\u6307\u6a19\u7684\u6a23\u672c\u6578\u64da\u53ef\u589e\u53ef\u6e1b\u3002\u5e38\u898b\u6307\u6a19\u5982 node_memory_MemFree_bytes \uff08\u7576\u524d\u4e3b\u6a5f\u7a7a\u9592\u7684\u5167\u5b58\u5927\u5c0f\uff09\u3001 node_memory_MemAvailable_bytes \uff08\u53ef\u7528\u5167\u5b58\u5927\u5c0f\uff09\u90fd\u662f Gauge \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\u3002\u7531\u65bc Gauge \u6307\u6a19\u4ecd\u7136\u5e36\u6709\u6642\u9593\u6233\u5b58\u5132\uff0c\u6240\u6709\u6211\u5011\u53ef\u4ee5\u770b\u5230\u96a8\u6642\u9593\u8b8a\u5316\u7684\u503c\uff0c\u901a\u5e38\u53ef\u4ee5\u76f4\u63a5\u628a\u5b83\u5011\u7e6a\u88fd\u51fa\u4f86\uff0c\u9019\u6a23\u5c31\u53ef\u4ee5\u770b\u5230\u503c\u672c\u8eab\u800c\u4e0d\u662f\u8b8a\u5316\u7387\u4e86\uff0c\u901a\u904e Gauge \u6307\u6a19\uff0c\u7528\u6236\u53ef\u4ee5\u76f4\u63a5\u67e5\u770b\u7cfb\u7d71\u7684\u7576\u524d\u72c0\u614b\u3002 \u9019\u4e9b\u7c21\u55ae\u7684\u6307\u6a19\u985e\u578b\u90fd\u53ea\u662f\u70ba\u6bcf\u500b\u6a23\u672c\u7372\u53d6\u4e00\u500b\u6578\u5b57\uff0c\u4f46 Prometheus \u7684\u5f37\u5927\u4e4b\u8655\u5728\u65bc\u5982\u4f55\u8b93\u4f60\u8ddf\u8e2a\u5b83\u5011\uff0c\u6bd4\u5982\u6211\u5011\u7e6a\u88fd\u4e86\u5169\u5f35\u5716\uff0c\u4e00\u500b\u662f HTTP \u8acb\u6c42\u7684\u8b8a\u5316\u7387\uff0c\u53e6\u4e00\u500b\u662f\u5206\u914d\u7684 gauge \u985e\u578b\u7684\u5be6\u969b\u5167\u5b58\uff0c\u76f4\u63a5\u5f9e\u5716\u4e0a\u5c31\u53ef\u4ee5\u770b\u51fa\u9019\u5169\u500b\u4e4b\u9593\u6709\u4e00\u7a2e\u95dc\u806f\u6027\uff0c\u7576\u8acb\u6c42\u51fa\u73fe\u5cf0\u503c\u7684\u6642\u5019\uff0c\u5167\u5b58\u7684\u4f7f\u7528\u4e5f\u6703\u51fa\u73fe\u5cf0\u503c\uff0c\u4f46\u662f\u6211\u5011\u4ed4\u7d30\u89c0\u5bdf\u4e5f\u6703\u767c\u73fe\u5728\u5cf0\u503c\u904e\u5f8c\uff0c\u5167\u5b58\u4f7f\u7528\u91cf\u4e26\u6c92\u6709\u6062\u5fa9\u5230\u5cf0\u503c\u524d\u7684\u6c34\u5e73\uff0c\u6574\u9ad4\u4e0a\u5b83\u5728\u9010\u6f38\u589e\u52a0\uff0c\u9019\u8868\u660e\u5f88\u53ef\u80fd\u61c9\u7528\u7a0b\u5e8f\u4e2d\u5b58\u5728\u5167\u5b58\u6d29\u9732\u7684\u554f\u984c\uff0c\u901a\u904e\u9019\u4e9b\u7c21\u55ae\u7684\u6307\u6a19\u5c31\u53ef\u4ee5\u5e6b\u52a9\u6211\u5011\u627e\u5230\u9019\u4e9b\u53ef\u80fd\u5b58\u5728\u7684\u554f\u984c\u3002 \u5c0d\u65bc Gauge \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u901a\u904e PromQL \u5167\u7f6e\u51fd\u6578 delta() \u53ef\u4ee5\u7372\u53d6\u6a23\u672c\u5728\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u7684\u8b8a\u5316\u60c5\u6cc1\u3002\u4f8b\u5982\uff0c\u8a08\u7b97 CPU \u6eab\u5ea6\u5728\u5169\u500b\u5c0f\u6642\u5167\u7684\u5dee\u7570\uff1a delta ( cpu_temp_celsius { host = \" zeus \"}[ 2h ] ) \u9084\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 predict_linear() \u5c0d\u6578\u64da\u7684\u8b8a\u5316\u8da8\u52e2\u9032\u884c\u9810\u6e2c\u3002\u4f8b\u5982\uff0c\u9810\u6e2c\u7cfb\u7d71\u78c1\u76e4\u7a7a\u9593\u5728 4 \u500b\u5c0f\u6642\u4e4b\u5f8c\u7684\u5269\u9918\u60c5\u6cc1\uff1a predict_linear ( node_filesystem_free_bytes [ 1h ], 4 * 3600 )","title":"Gauge"},{"location":"prometheus/promql/metric-type/#histogram-summary","text":"\u9664\u4e86 Counter \u548c Gauge \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\u4ee5\u5916\uff0cPrometheus \u9084\u5b9a\u7fa9\u4e86 Histogram \u548c Summary \u7684\u6307\u6a19\u985e\u578b\u3002 Histogram \u548c Summary \u4e3b\u7528\u7528\u65bc\u7d71\u8a08\u548c\u5206\u6790\u6a23\u672c\u7684\u5206\u4f48\u60c5\u6cc1\u3002 \u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\u4eba\u5011\u90fd\u50be\u5411\u65bc\u4f7f\u7528\u67d0\u4e9b\u91cf\u5316\u6307\u6a19\u7684\u5e73\u5747\u503c\uff0c\u4f8b\u5982 CPU \u7684\u5e73\u5747\u4f7f\u7528\u7387\u3001\u9801\u9762\u7684\u5e73\u5747\u97ff\u61c9\u6642\u9593\uff0c\u9019\u7a2e\u65b9\u5f0f\u4e5f\u6709\u5f88\u660e\u986f\u7684\u554f\u984c\uff0c\u4ee5\u7cfb\u7d71 API \u8abf\u7528\u7684\u5e73\u5747\u97ff\u61c9\u6642\u9593\u70ba\u4f8b\uff1a\u5982\u679c\u5927\u591a\u6578 API \u8acb\u6c42\u90fd\u7dad\u6301\u5728 100ms \u7684\u97ff\u61c9\u6642\u9593\u7bc4\u570d\u5167\uff0c\u800c\u500b\u5225\u8acb\u6c42\u7684\u97ff\u61c9\u6642\u9593\u9700\u8981 5s\uff0c\u90a3\u9ebc\u5c31\u6703\u5c0e\u81f4\u67d0\u4e9b WEB \u9801\u9762\u7684\u97ff\u61c9\u6642\u9593\u843d\u5230 \u4e2d\u4f4d\u6578 \u4e0a\uff0c\u800c\u9019\u7a2e\u73fe\u50cf\u88ab\u7a31\u70ba \u9577\u5c3e\u554f\u984c \u3002 \u70ba\u4e86\u5340\u5206\u662f \u5e73\u5747\u7684\u6162\u9084\u662f\u9577\u5c3e\u7684\u6162 \uff0c\u6700\u7c21\u55ae\u7684\u65b9\u5f0f\u5c31\u662f\u6309\u7167\u8acb\u6c42\u5ef6\u9072\u7684\u7bc4\u570d\u9032\u884c\u5206\u7d44\u3002\u4f8b\u5982\uff0c\u7d71\u8a08\u5ef6\u9072\u5728 0~10ms \u4e4b\u9593\u7684\u8acb\u6c42\u6578\u6709\u591a\u5c11\u800c 10~20ms \u4e4b\u9593\u7684\u8acb\u6c42\u6578\u53c8\u6709\u591a\u5c11\u3002\u901a\u904e\u9019\u7a2e\u65b9\u5f0f\u53ef\u4ee5\u5feb\u901f\u5206\u6790\u7cfb\u7d71\u6162\u7684\u539f\u56e0\u3002 Histogram \u548c Summary \u90fd\u662f\u70ba\u4e86\u80fd\u5920\u89e3\u6c7a\u9019\u6a23\u7684\u554f\u984c\u5b58\u5728\u7684\uff0c\u901a\u904e Histogram \u548cSummary \u985e\u578b\u7684\u76e3\u63a7\u6307\u6a19\uff0c\u6211\u5011\u53ef\u4ee5\u5feb\u901f\u4e86\u89e3\u76e3\u63a7\u6a23\u672c\u7684\u5206\u4f48\u60c5\u6cc1\u3002","title":"Histogram \u548c Summary"},{"location":"prometheus/promql/metric-type/#summary","text":"\u6458\u8981\u7528\u65bc\u8a18\u9304\u67d0\u4e9b\u6771\u897f\u7684\u5e73\u5747\u5927\u5c0f\uff0c\u53ef\u80fd\u662f\u8a08\u7b97\u6240\u9700\u7684\u6642\u9593\u6216\u8655\u7406\u7684\u6587\u4ef6\u5927\u5c0f\uff0c\u6458\u8981\u986f\u793a\u5169\u500b\u76f8\u95dc\u7684\u4fe1\u606f\uff1a count \uff08\u4e8b\u4ef6\u767c\u751f\u7684\u6b21\u6578\uff09\u548c sum \uff08\u6240\u6709\u4e8b\u4ef6\u7684\u7e3d\u5927\u5c0f\uff09\uff0c\u5982\u4e0b\u5716\u8a08\u7b97\u6458\u8981\u6307\u6a19\u53ef\u4ee5\u8fd4\u56de\u6b21\u6578\u70ba 3 \u548c\u7e3d\u548c 15\uff0c\u4e5f\u5c31\u610f\u5473\u8457 3 \u6b21\u8a08\u7b97\u7e3d\u5171\u9700\u8981 15s \u4f86\u8655\u7406\uff0c\u5e73\u5747\u6bcf\u6b21\u8a08\u7b97\u9700\u8981\u82b1\u8cbb 5s\u3002\u4e0b\u4e00\u500b\u6a23\u672c\u7684\u6b21\u6578\u70ba 10\uff0c\u7e3d\u548c\u70ba 113\uff0c\u90a3\u9ebc\u5e73\u5747\u503c\u70ba 11.3\uff0c\u56e0\u70ba\u5169\u7d44\u6307\u6a19\u90fd\u8a18\u9304\u6709\u6642\u9593\u6233\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u6458\u8981\u4f86\u69cb\u5efa\u4e00\u500b\u5716\u8868\uff0c\u986f\u793a\u5e73\u5747\u503c\u7684\u8b8a\u5316\u7387\uff0c\u6bd4\u5982\u5716\u4e0a\u7684\u8a9e\u53e5\u8868\u793a\u7684\u662f 5 \u5206\u9418\u6642\u9593\u6bb5\u5167\u7684\u5e73\u5747\u901f\u7387\u3002 \u4f8b\u5982\uff0c\u6307\u6a19 prometheus_tsdb_wal_fsync_duration_seconds \u7684\u6307\u6a19\u985e\u578b\u70ba Summary \uff0c\u5b83\u8a18\u9304\u4e86 Prometheus Server \u4e2d wal_fsync \u7684\u8655\u7406\u6642\u9593\uff0c\u901a\u904e\u8a2a\u554f Prometheus Server \u7684 /metrics \u5730\u5740\uff0c\u53ef\u4ee5\u7372\u53d6\u5230\u4ee5\u4e0b\u76e3\u63a7\u6a23\u672c\u6578\u64da\uff1a # HELP prometheus_tsdb_wal_fsync_duration_seconds Duration of WAL fsync. # TYPE prometheus_tsdb_wal_fsync_duration_seconds summary prometheus_tsdb_wal_fsync_duration_seconds { quantile = \"0.5\" } 0 .012352463 prometheus_tsdb_wal_fsync_duration_seconds { quantile = \"0.9\" } 0 .014458005 prometheus_tsdb_wal_fsync_duration_seconds { quantile = \"0.99\" } 0 .017316173 prometheus_tsdb_wal_fsync_duration_seconds_sum 2 .888716127000002 prometheus_tsdb_wal_fsync_duration_seconds_count 216 \u5f9e\u4e0a\u9762\u7684\u6a23\u672c\u4e2d\u53ef\u4ee5\u5f97\u77e5\u7576\u524d Prometheus Server \u9032\u884c wal_fsync \u64cd\u4f5c\u7684\u7e3d\u6b21\u6578\u70ba 216 \u6b21\uff0c\u8017\u6642 2.888716127000002s\u3002\u5176\u4e2d\u4e2d\u4f4d\u6578\uff08quantile=0.5\uff09\u7684\u8017\u6642\u70ba 0.012352463\uff0c9 \u5206\u4f4d\u6578\uff08quantile=0.9\uff09\u7684\u8017\u6642\u70ba 0.014458005s\u3002","title":"Summary"},{"location":"prometheus/promql/metric-type/#histogram","text":"\u6458\u8981\u975e\u5e38\u6709\u7528\uff0c\u4f46\u662f\u5e73\u5747\u503c\u6703\u96b1\u85cf\u4e00\u4e9b\u7d30\u7bc0\uff0c\u4e0a\u5716\u4e2d 10 \u8207 113 \u7684\u7e3d\u548c\u5305\u542b\u975e\u5e38\u5ee3\u7684\u7bc4\u570d\uff0c\u5982\u679c\u6211\u5011\u60f3\u67e5\u770b\u6642\u9593\u82b1\u5728\u4ec0\u9ebc\u5730\u65b9\u4e86\uff0c\u90a3\u9ebc\u6211\u5011\u5c31\u9700\u8981\u76f4\u65b9\u5716\u4e86\u3002 \u76f4\u65b9\u5716\u4ee5 bucket \u6876\u7684\u5f62\u5f0f\u8a18\u9304\u6578\u64da\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u80fd\u6709\u4e00\u500b\u6876\u7528\u65bc\u9700\u8981 1s \u6216\u66f4\u5c11\u7684\u8a08\u7b97\uff0c\u53e6\u4e00\u500b\u6876\u7528\u65bc 5 \u79d2\u6216\u66f4\u5c11\u300110 \u79d2\u6216\u66f4\u5c11\u300120 \u79d2\u6216\u66f4\u5c11\u300160 \u79d2\u6216\u66f4\u5c11\u3002\u8a72\u6307\u6a19\u8fd4\u56de\u6bcf\u500b\u5b58\u5132\u6876\u7684\u8a08\u6578\uff0c\u5176\u4e2d 3 \u500b\u5728 5 \u79d2\u6216\u66f4\u77ed\u7684\u6642\u9593\u5167\u5b8c\u6210\uff0c6 \u500b\u5728 10 \u79d2\u6216\u66f4\u77ed\u7684\u6642\u9593\u5167\u5b8c\u6210\u3002 Prometheus \u4e2d\u7684\u76f4\u65b9\u5716\u662f \u7d2f\u7a4d \u7684\uff0c\u56e0\u6b64\u6240\u6709 10 \u6b21\u8a08\u7b97\u90fd\u5c6c\u65bc 60 \u79d2\u6216\u66f4\u5c11\u7684\u6642\u9593\u6bb5\uff0c\u800c\u5728\u9019 10 \u6b21\u4e2d\uff0c\u6709 9 \u6b21\u7684\u8655\u7406\u6642\u9593\u70ba 20 \u79d2\u6216\u66f4\u5c11\uff0c\u9019\u986f\u793a\u4e86\u6578\u64da\u7684\u5206\u4f48\u3002\u6240\u4ee5\u53ef\u4ee5\u770b\u5230\u6211\u5011\u7684\u5927\u90e8\u5206\u8a08\u7b97\u90fd\u5728 10 \u79d2\u4ee5\u4e0b\uff0c\u53ea\u6709\u4e00\u500b\u8d85\u904e 20 \u79d2\uff0c\u9019\u5c0d\u65bc\u8a08\u7b97\u767e\u5206\u4f4d\u6578\u5f88\u6709\u7528\u3002 \u5728 Prometheus Server \u81ea\u8eab\u8fd4\u56de\u7684\u6a23\u672c\u6578\u64da\u4e2d\uff0c\u6211\u5011\u4e5f\u80fd\u627e\u5230\u985e\u578b\u70ba Histogram \u7684\u76e3\u63a7\u6307\u6a19 prometheus_tsdb_compaction_chunk_range_seconds_bucket \uff1a # HELP prometheus_tsdb_compaction_chunk_range_seconds Final time range of chunks on their first compaction # TYPE prometheus_tsdb_compaction_chunk_range_seconds histogram prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"100\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"400\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"1600\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"6400\" } 71 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"25600\" } 405 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"102400\" } 25690 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"409600\" } 71863 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"1.6384e+06\" } 115928 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"6.5536e+06\" } 2 .5687892e+07 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"2.62144e+07\" } 2 .5687896e+07 prometheus_tsdb_compaction_chunk_range_seconds_bucket { le = \"+Inf\" } 2 .5687896e+07 prometheus_tsdb_compaction_chunk_range_seconds_sum 4 .7728699529576e+13 prometheus_tsdb_compaction_chunk_range_seconds_count 2 .5687896e+07 \u8207 Summary \u985e\u578b\u7684\u6307\u6a19\u76f8\u4f3c\u4e4b\u8655\u5728\u65bc Histogram \u985e\u578b\u7684\u6a23\u672c\u540c\u6a23\u6703\u53cd\u61c9\u7576\u524d\u6307\u6a19\u7684\u8a18\u9304\u7684\u7e3d\u6578(\u4ee5 _count \u4f5c\u70ba\u5f8c\u7db4)\u4ee5\u53ca\u5176\u503c\u7684\u7e3d\u91cf\uff08\u4ee5 _sum \u4f5c\u70ba\u5f8c\u7db4\uff09\u3002\u4e0d\u540c\u5728\u65bc Histogram \u6307\u6a19\u76f4\u63a5\u53cd\u61c9\u4e86\u5728\u4e0d\u540c\u5340\u9593\u5167\u6a23\u672c\u7684\u500b\u6578\uff0c\u5340\u9593\u901a\u904e\u6a19\u7c64 le \u9032\u884c\u5b9a\u7fa9\u3002","title":"Histogram"},{"location":"prometheus/promql/operate/","text":"\u904b\u7b97 \u00b6 \u539f\u6587: \u8fd0\u7b97 Prometheus \u7684\u67e5\u8a62\u8a9e\u8a00\u652f\u6301\u57fa\u672c\u7684\u908f\u8f2f\u904b\u7b97\u548c\u7b97\u8853\u904b\u7b97\u3002 \u7b97\u8853\u904b\u7b97\u7b26 \u00b6 \u5728 Prometheus \u7cfb\u7d71\u4e2d\u652f\u6301\u4e0b\u9762\u7684\u4e8c\u5143\u7b97\u8853\u904b\u7b97\u7b26\uff1a + \u52a0\u6cd5 - \u6e1b\u6cd5 * \u4e58\u6cd5 / \u9664\u6cd5 % \u6a21 ^ \u51aa\u7b49 \u6700\u7c21\u55ae\u7684\u6211\u5011\u53ef\u4ee5\u5c07\u4e00\u500b\u6578\u5b57\u8a08\u7b97\u7576\u505a\u4e00\u500b PromQL \u8a9e\u53e5\uff0c\u7528\u65bc\u6a19\u91cf\u8207\u6a19\u91cf\u4e4b\u9593\u8a08\u7b97\uff0c\u6bd4\u5982\uff1a ( 2 + 3 / 6 ) * 2 ^ 2 \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u7d50\u679c\uff1a \u5716\u5f62\u4e2d\u8fd4\u56de\u7684\u662f\u4e00\u500b\u503c\u70ba 10 \u7684\u6a19\u91cf\uff08scalar\uff09\u985e\u578b\u7684\u6578\u64da\u3002 \u4e8c\u5143\u904b\u7b97\u540c\u6a23\u9069\u7528\u65bc\u5411\u91cf\u548c\u6a19\u91cf\u4e4b\u9593\uff0c\u4f8b\u5982\u6211\u5011\u53ef\u4ee5\u5c07\u4e00\u500b\u5b57\u7bc0\u6578\u9664\u4ee5\u5169\u6b21 1024 \u4f86\u8f49\u63db\u70ba MiB\uff0c\u5982\u4e0b\u67e5\u8a62\u8a9e\u53e5\uff1a demo_batch_last_run_processed_bytes { job = \" demo \"} / 1024 / 1024 \u6700\u5f8c\u8a08\u7b97\u7684\u7d50\u679c\u5c31\u662f MiB \u55ae\u4f4d\u7684\u4e86\uff1a \u53e6\u5916 PromQL \u7684\u4e00\u500b\u5f37\u5927\u529f\u80fd\u5c31\u662f\u53ef\u4ee5\u8b93\u6211\u5011\u5728\u5411\u91cf\u8207\u5411\u91cf\u4e4b\u9593\u9032\u884c\u4e8c\u5143\u904b\u7b97\u3002 \u4f8b\u5982 demo_api_request_duration_seconds_sum \u7684\u6578\u64da\u5305\u542b\u4e86\u5728 path \u3001 method \u3001 status \u7b49\u4e0d\u540c\u7dad\u5ea6\u4e0a\u82b1\u8cbb\u7684\u7e3d\u6642\u9593\uff0c\u6307\u6a19 demo_api_request_duration_seconds_count \u5305\u542b\u4e86\u4e0a\u9762\u540c\u7dad\u5ea6\u4e0b\u7684\u8acb\u6c42\u7e3d\u6b21\u6578\u3002\u5247\u6211\u5011\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u4f86\u67e5\u8a62\u904e\u53bb 5 \u5206\u9418\u7684\u5e73\u5747\u8acb\u6c42\u6301\u7e8c\u6642\u9593\uff1a rate ( demo_api_request_duration_seconds_sum { job = \" demo \"}[ 5m ] ) / rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) PromQL \u6703\u901a\u904e\u76f8\u540c\u7684\u6a19\u7c64\u96c6\u81ea\u52d5\u5339\u914d\u64cd\u4f5c\u7b26\u5de6\u908a\u548c\u53f3\u908a\u7684\u5143\u7d20\uff0c\u4e26\u5c07\u4e8c\u5143\u904b\u7b97\u61c9\u7528\u5230\u5b83\u5011\u8eab\u4e0a\u3002\u7531\u65bc\u4e0a\u9762\u5169\u500b\u6307\u6a19\u7684\u6a19\u7c64\u96c6\u5408\u90fd\u662f\u4e00\u81f4\u7684\uff0c\u6240\u6709\u53ef\u4ee5\u5f97\u5230\u76f8\u540c\u6a19\u7c64\u96c6\u7684\u5e73\u5747\u8acb\u6c42\u5ef6\u9072\u7d50\u679c\uff1a \u5411\u91cf\u5339\u914d \u00b6 \u4e00\u5c0d\u4e00 \u00b6 \u4e0a\u9762\u7684\u793a\u4f8b\u5176\u5be6\u5c31\u662f\u4e00\u5c0d\u4e00\u7684\u5411\u91cf\u5339\u914d\uff0c\u4f46\u662f\u4e00\u5c0d\u4e00\u5411\u91cf\u5339\u914d\u4e5f\u6709\u5169\u7a2e\u60c5\u6cc1\uff0c\u5c31\u662f\u662f\u5426\u6309\u7167\u6240\u6709\u6a19\u7c64\u5339\u914d\u9032\u884c\u8a08\u7b97\uff0c\u4e0b\u5716\u662f\u5339\u914d\u6240\u6709\u6a19\u7c64\u7684\u60c5\u6cc1\uff1a \u5716\u4e2d\u6211\u5011\u5169\u500b\u6307\u6a19 foo \u548c bar\uff0c\u5206\u5225\u751f\u6210\u4e86 3 \u500b\u5e8f\u5217\uff1a # TYPE foo gauge foo { color = \"red\" , size = \"small\" } 4 foo { color = \"green\" , size = \"medium\" } 8 foo { color = \"blue\" , size = \"large\" } 16 # TYPE bar gauge bar { color = \"green\" , size = \"xlarge\" } 2 bar { color = \"blue\" , size = \"large\" } 7 bar { color = \"red\" , size = \"small\" } 5 \u7576\u6211\u5011\u57f7\u884c\u67e5\u8a62\u8a9e\u53e5 foo{} + bar{} \u7684\u6642\u5019\uff0c\u5c0d\u65bc\u5411\u91cf\u5de6\u908a\u7684\u6bcf\u4e00\u500b\u5143\u7d20\uff0c\u64cd\u4f5c\u7b26\u90fd\u6703\u5617\u8a66\u5728\u53f3\u908a\u88e1\u9762\u627e\u5230\u4e00\u500b\u5339\u914d\u7684\u5143\u7d20\uff0c\u5339\u914d\u662f\u901a\u904e\u6bd4\u8f03\u6240\u6709\u7684\u6a19\u7c64\u4f86\u5b8c\u6210\u7684\uff0c\u6c92\u6709\u5339\u914d\u7684\u5143\u7d20\u6703\u88ab\u4e1f\u68c4\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u7684 foo{color=\"green\", size=\"medium\"} \u8207 bar{color=\"green\", size=\"xlarge\"} \u5169\u500b\u5e8f\u5217\u7684\u6a19\u7c64\u662f\u4e0d\u5339\u914d\u7684\uff0c\u5176\u9918\u5169\u500b\u5e8f\u5217\u6a19\u7c64\u5339\u914d\uff0c\u6240\u4ee5\u8a08\u7b97\u7d50\u679c\u6703\u62cb\u68c4\u6389\u4e0d\u5339\u914d\u7684\u5e8f\u5217\uff0c\u5f97\u5230\u7684\u7d50\u679c\u70ba\u5176\u9918\u5e8f\u5217\u7684\u503c\u76f8\u52a0\u3002 \u4e0a\u9762\u4f8b\u5b50\u4e2d\u5176\u4e2d\u4e0d\u5339\u914d\u7684\u6a19\u7c64\u4e3b\u8981\u662f\u56e0\u70ba\u7b2c\u4e8c\u500b size \u6a19\u7c64\u4e0d\u4e00\u81f4\u9020\u6210\u7684\uff0c\u90a3\u9ebc\u5982\u679c\u6211\u5011\u5728\u8a08\u7b97\u7684\u6642\u5019\u5ffd\u7565\u6389\u9019\u500b\u6a19\u7c64\u53ef\u4ee5\u55ce\uff1f\u5982\u4e0b\u5716\u6240\u793a\uff1a \u540c\u6a23\u91dd\u5c0d\u4e0a\u9762\u7684\u5169\u500b\u6307\u6a19\uff0c\u6211\u5011\u5728\u9032\u884c\u8a08\u7b97\u7684\u6642\u5019\u53ef\u4ee5\u4f7f\u7528 on \u6216\u8005 ignoring \u4fee\u98fe\u7b26\u4f86\u6307\u5b9a\u7528\u65bc\u5339\u914d\u7684\u6a19\u7c64\u9032\u884c\u8a08\u7b97\uff0c\u7531\u65bc\u793a\u4f8b\u4e2d\u5169\u908a\u7684\u6a19\u7c64\u90fd\u5177\u6709 color \u6a19\u7c64\uff0c\u6240\u4ee5\u5728\u9032\u884c\u8a08\u7b97\u7684\u6642\u5019\u6211\u5011\u53ef\u4ee5\u57fa\u65bc\u8a72\u6a19\u7c64 \uff08on (color)\uff09 \u6216\u8005\u5ffd\u7565\u5176\u4ed6\u7684\u6a19\u7c64 \uff08ignoring (size)\uff09 \u9032\u884c\u8a08\u7b97\uff0c\u9019\u6a23\u5f97\u5230\u7684\u7d50\u679c\u5c31\u662f\u6240\u4ee5\u5339\u914d\u7684\u6a19\u7c64\u5e8f\u5217\u76f8\u52a0\u7684\u7d50\u679c\uff0c\u8981\u6ce8\u610f\u7d50\u679c\u4e2d\u7684\u6a19\u7c64\u4e5f\u662f\u5339\u914d\u7684\u6a19\u7c64\u3002 \u4e00\u5c0d\u591a\u8207\u591a\u5c0d\u4e00 \u00b6 \u4e0a\u9762\u8b1b\u89e3\u7684\u4e00\u5c0d\u4e00\u7684\u5411\u91cf\u8a08\u7b97\u662f\u6700\u76f4\u63a5\u7684\u65b9\u5f0f\uff0c\u5728\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c on \u6216\u8005 ignoring \u4fee\u98fe\u7b26\u6709\u52a9\u65bc\u662f\u67e5\u8a62\u8fd4\u56de\u5408\u7406\u7684\u7d50\u679c\uff0c\u4f46\u901a\u5e38\u60c5\u6cc1\u7528\u65bc\u8a08\u7b97\u7684\u5169\u500b\u5411\u91cf\u4e4b\u9593\u4e26\u4e0d\u662f\u4e00\u5c0d\u4e00\u7684\u95dc\u4fc2\uff0c\u66f4\u591a\u7684\u662f\u4e00\u5c0d\u591a\u6216\u8005\u591a\u5c0d\u4e00\u7684\u95dc\u4fc2\uff0c\u5c0d\u65bc\u9019\u7a2e\u5834\u666f\u6211\u5011\u5c31\u4e0d\u80fd\u7c21\u55ae\u4f7f\u7528\u4e0a\u9762\u7684\u65b9\u5f0f\u9032\u884c\u8655\u7406\u4e86\u3002 \u591a\u5c0d\u4e00\u548c\u4e00\u5c0d\u591a\u5169\u7a2e\u5339\u914d\u6a21\u5f0f\u6307\u7684\u662f\u4e00\u5074\u7684\u6bcf\u4e00\u500b\u5411\u91cf\u5143\u7d20\u53ef\u4ee5\u8207\u591a\u5074\u7684\u591a\u500b\u5143\u7d20\u5339\u914d\u7684\u60c5\u6cc1\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5fc5\u9808\u4f7f\u7528 group \u4fee\u98fe\u7b26\uff1a group_left \u6216\u8005 group_right \u4f86\u78ba\u5b9a\u54ea\u4e00\u500b\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6578\uff08\u5145\u7576\u591a\u7684\u89d2\u8272\uff09\u3002\u591a\u5c0d\u4e00\u548c\u4e00\u5c0d\u591a\u5169\u7a2e\u6a21\u5f0f\u4e00\u5b9a\u662f\u51fa\u73fe\u5728\u64cd\u4f5c\u7b26\u5169\u5074\u8868\u9054\u5f0f\u8fd4\u56de\u7684\u5411\u91cf\u6a19\u7c64\u4e0d\u4e00\u81f4\u7684\u60c5\u6cc1\uff0c\u56e0\u6b64\u540c\u6a23\u9700\u8981\u4f7f\u7528 ignoring \u548c on \u4fee\u98fe\u7b26\u4f86\u6392\u9664\u6216\u8005\u9650\u5b9a\u5339\u914d\u7684\u6a19\u7c64\u5217\u8868\u3002 \u4f8b\u5982 demo_num_cpus \u6307\u6a19\u544a\u8a34\u6211\u5011\u6bcf\u500b\u5be6\u4f8b\u7684 CPU \u6838\u5fc3\u6578\u91cf\uff0c\u53ea\u6709 instance \u548c job \u9019\u5169\u500b\u6a19\u7c64\u7dad\u5ea6\u3002 \u800c demo_cpu_usage_seconds_total \u6307\u6a19\u5247\u591a\u4e86\u4e00\u500b mode \u6a19\u7c64\u7684\u7dad\u5ea6\uff0c\u5c07\u6bcf\u500b mode \u6a21\u5f0f\uff08 idle \u3001 system \u3001 user \uff09\u7684 CPU \u4f7f\u7528\u60c5\u6cc1\u5206\u958b\u9032\u884c\u4e86\u7d71\u8a08\u3002 \u5982\u679c\u8981\u8a08\u7b97\u6bcf\u500b\u6a21\u5f0f\u7684 CPU \u4f7f\u7528\u91cf\u9664\u4ee5\u6838\u5fc3\u6578\uff0c\u6211\u5011\u9700\u8981\u544a\u8a34\u9664\u6cd5\u904b\u7b97\u7b26\u6309\u7167 demo_cpu_usage_seconds_total \u6307\u6a19\u4e0a\u984d\u5916\u7684 mode \u6a19\u7c64\u7dad\u5ea6\u5c0d\u7d50\u679c\u9032\u884c\u5206\u7d44\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 group_left \uff08\u8868\u793a\u5de6\u908a\u7684\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6578\uff09\u4fee\u98fe\u7b26\u4f86\u5be6\u73fe\u3002\u540c\u6642\uff0c\u6211\u5011\u9084\u9700\u8981\u901a\u904e on() \u4fee\u98fe\u7b26\u660e\u78ba\u5c07\u6240\u8003\u616e\u7684\u6a19\u7c64\u96c6\u6e1b\u5c11\u5230\u9700\u8981\u5339\u914d\u7684\u6a19\u7c64\u5217\u8868\uff1a rate ( demo_cpu_usage_seconds_total { job = \" demo \"}[ 5m ] ) / on ( job , instance ) group_left demo_num_cpus { job = \" demo \"} \u4e0a\u9762\u7684\u8868\u9054\u5f0f\u53ef\u4ee5\u6b63\u5e38\u5f97\u5230\u7d50\u679c\uff1a \u9664\u4e86 on() \u4e4b\u5916\uff0c\u9084\u53ef\u4ee5\u4f7f\u7528\u76f8\u53cd\u7684 ignoring() \u4fee\u98fe\u7b26\uff0c\u53ef\u4ee5\u7528\u4f86\u5c07\u4e00\u4e9b\u6a19\u7c64\u7dad\u5ea6\u5f9e\u4e8c\u5143\u904b\u7b97\u64cd\u4f5c\u5339\u914d\u4e2d\u5ffd\u7565\u6389\uff0c\u5982\u679c\u5728\u64cd\u4f5c\u7b26\u7684\u53f3\u5074\u6709\u984d\u5916\u7684\u7dad\u5ea6\uff0c\u5247\u61c9\u8a72\u4f7f\u7528 group_right \uff08\u8868\u793a\u53f3\u908a\u7684\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6578\uff09\u4fee\u98fe\u7b26\u3002 \u6bd4\u5982\u4e0a\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\u540c\u6a23\u53ef\u4ee5\u7528 ignoring \u95dc\u9375\u5b57\u4f86\u5b8c\u6210\uff1a rate ( demo_cpu_usage_seconds_total { job = \" demo \"}[ 5m ] ) / ignoring ( mode ) group_left demo_num_cpus { job = \" demo \"} \u5f97\u5230\u7684\u7d50\u679c\u548c\u524d\u9762\u7528 on() \u67e5\u8a62\u7684\u7d50\u679c\u662f\u4e00\u81f4\u7684\u3002 \u5230\u9019\u88e1\u6211\u5011\u5c31\u77e5\u9053\u77ad\u5982\u4f55\u5728 PromQL \u4e2d\u9032\u884c\u6a19\u91cf\u548c\u5411\u91cf\u4e4b\u9593\u7684\u904b\u7b97\u4e86\u3002\u4e0d\u904e\u6211\u5011\u5728\u4f7f\u7528 PromQL \u67e5\u8a62\u6578\u64da\u7684\u6642\u5019\u9084\u884c\u8981\u907f\u514d\u4f7f\u7528\u95dc\u806f\u67e5\u8a62\uff0c\u5148\u60f3\u60f3\u80fd\u4e0d\u80fd\u901a\u904e Relabel\uff08\u5f8c\u7e8c\u6703\u8a73\u7d30\u4ecb\u7d39\uff09\u7684\u65b9\u5f0f\u7d66\u539f\u59cb\u6578\u64da\u591a\u52a0\u500b Label\uff0c\u4e00\u689d\u8a9e\u53e5\u80fd\u67e5\u51fa\u4f86\u7684\u4f55\u5fc5\u7528 Join \u5462\uff1f\u6642\u5e8f\u6578\u64da\u5eab\u4e0d\u662f\u95dc\u4fc2\u6578\u64da\u5eab\u3002 \u7df4\u7fd2 1.\u8a08\u7b97\u904e\u53bb 5 \u5206\u9418\u6240\u6709 POST \u8acb\u6c42\u5e73\u5747\u6578\u7684\u7e3d\u548c\u76f8\u5c0d\u65bc\u6240\u6709\u8acb\u6c42\u5e73\u5747\u6578\u7e3d\u548c\u7684\u767e\u5206\u6bd4\u3002 sum ( rate ( demo_api_request_duration_seconds_count { method = \" POST \"}[ 5m ] )) / sum ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) * 100 2.\u8a08\u7b97\u904e\u53bb 5 \u5206\u9418\u5167\u6bcf\u500b\u5be6\u4f8b\u7684 user \u548c system \u7684\u6a21\u5f0f\uff08 demo_cpu_usage_seconds_total \u6307\u6a19\uff09\u4e0b CPU \u4f7f\u7528\u91cf\u5e73\u5747\u503c\u7e3d\u548c\u3002 sum by ( instance , job ) ( rate ( demo_cpu_usage_seconds_total { mode =~ \" user|system \"}[ 5m ] )) \u6216\u8005 sum without ( mode ) ( rate ( demo_cpu_usage_seconds_total { mode =~ \" user|system \"}[ 5m ] )) \u6216\u8005 rate ( demo_cpu_usage_seconds_total { mode = \" user \"}[ 5m ] ) + ignoring ( mode ) rate ( demo_cpu_usage_seconds_total { mode = \" system \"}[ 5m ] )","title":"\u904b\u7b97"},{"location":"prometheus/promql/operate/#_1","text":"\u539f\u6587: \u8fd0\u7b97 Prometheus \u7684\u67e5\u8a62\u8a9e\u8a00\u652f\u6301\u57fa\u672c\u7684\u908f\u8f2f\u904b\u7b97\u548c\u7b97\u8853\u904b\u7b97\u3002","title":"\u904b\u7b97"},{"location":"prometheus/promql/operate/#_2","text":"\u5728 Prometheus \u7cfb\u7d71\u4e2d\u652f\u6301\u4e0b\u9762\u7684\u4e8c\u5143\u7b97\u8853\u904b\u7b97\u7b26\uff1a + \u52a0\u6cd5 - \u6e1b\u6cd5 * \u4e58\u6cd5 / \u9664\u6cd5 % \u6a21 ^ \u51aa\u7b49 \u6700\u7c21\u55ae\u7684\u6211\u5011\u53ef\u4ee5\u5c07\u4e00\u500b\u6578\u5b57\u8a08\u7b97\u7576\u505a\u4e00\u500b PromQL \u8a9e\u53e5\uff0c\u7528\u65bc\u6a19\u91cf\u8207\u6a19\u91cf\u4e4b\u9593\u8a08\u7b97\uff0c\u6bd4\u5982\uff1a ( 2 + 3 / 6 ) * 2 ^ 2 \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u7d50\u679c\uff1a \u5716\u5f62\u4e2d\u8fd4\u56de\u7684\u662f\u4e00\u500b\u503c\u70ba 10 \u7684\u6a19\u91cf\uff08scalar\uff09\u985e\u578b\u7684\u6578\u64da\u3002 \u4e8c\u5143\u904b\u7b97\u540c\u6a23\u9069\u7528\u65bc\u5411\u91cf\u548c\u6a19\u91cf\u4e4b\u9593\uff0c\u4f8b\u5982\u6211\u5011\u53ef\u4ee5\u5c07\u4e00\u500b\u5b57\u7bc0\u6578\u9664\u4ee5\u5169\u6b21 1024 \u4f86\u8f49\u63db\u70ba MiB\uff0c\u5982\u4e0b\u67e5\u8a62\u8a9e\u53e5\uff1a demo_batch_last_run_processed_bytes { job = \" demo \"} / 1024 / 1024 \u6700\u5f8c\u8a08\u7b97\u7684\u7d50\u679c\u5c31\u662f MiB \u55ae\u4f4d\u7684\u4e86\uff1a \u53e6\u5916 PromQL \u7684\u4e00\u500b\u5f37\u5927\u529f\u80fd\u5c31\u662f\u53ef\u4ee5\u8b93\u6211\u5011\u5728\u5411\u91cf\u8207\u5411\u91cf\u4e4b\u9593\u9032\u884c\u4e8c\u5143\u904b\u7b97\u3002 \u4f8b\u5982 demo_api_request_duration_seconds_sum \u7684\u6578\u64da\u5305\u542b\u4e86\u5728 path \u3001 method \u3001 status \u7b49\u4e0d\u540c\u7dad\u5ea6\u4e0a\u82b1\u8cbb\u7684\u7e3d\u6642\u9593\uff0c\u6307\u6a19 demo_api_request_duration_seconds_count \u5305\u542b\u4e86\u4e0a\u9762\u540c\u7dad\u5ea6\u4e0b\u7684\u8acb\u6c42\u7e3d\u6b21\u6578\u3002\u5247\u6211\u5011\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u4f86\u67e5\u8a62\u904e\u53bb 5 \u5206\u9418\u7684\u5e73\u5747\u8acb\u6c42\u6301\u7e8c\u6642\u9593\uff1a rate ( demo_api_request_duration_seconds_sum { job = \" demo \"}[ 5m ] ) / rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) PromQL \u6703\u901a\u904e\u76f8\u540c\u7684\u6a19\u7c64\u96c6\u81ea\u52d5\u5339\u914d\u64cd\u4f5c\u7b26\u5de6\u908a\u548c\u53f3\u908a\u7684\u5143\u7d20\uff0c\u4e26\u5c07\u4e8c\u5143\u904b\u7b97\u61c9\u7528\u5230\u5b83\u5011\u8eab\u4e0a\u3002\u7531\u65bc\u4e0a\u9762\u5169\u500b\u6307\u6a19\u7684\u6a19\u7c64\u96c6\u5408\u90fd\u662f\u4e00\u81f4\u7684\uff0c\u6240\u6709\u53ef\u4ee5\u5f97\u5230\u76f8\u540c\u6a19\u7c64\u96c6\u7684\u5e73\u5747\u8acb\u6c42\u5ef6\u9072\u7d50\u679c\uff1a","title":"\u7b97\u8853\u904b\u7b97\u7b26"},{"location":"prometheus/promql/operate/#_3","text":"","title":"\u5411\u91cf\u5339\u914d"},{"location":"prometheus/promql/operate/#_4","text":"\u4e0a\u9762\u7684\u793a\u4f8b\u5176\u5be6\u5c31\u662f\u4e00\u5c0d\u4e00\u7684\u5411\u91cf\u5339\u914d\uff0c\u4f46\u662f\u4e00\u5c0d\u4e00\u5411\u91cf\u5339\u914d\u4e5f\u6709\u5169\u7a2e\u60c5\u6cc1\uff0c\u5c31\u662f\u662f\u5426\u6309\u7167\u6240\u6709\u6a19\u7c64\u5339\u914d\u9032\u884c\u8a08\u7b97\uff0c\u4e0b\u5716\u662f\u5339\u914d\u6240\u6709\u6a19\u7c64\u7684\u60c5\u6cc1\uff1a \u5716\u4e2d\u6211\u5011\u5169\u500b\u6307\u6a19 foo \u548c bar\uff0c\u5206\u5225\u751f\u6210\u4e86 3 \u500b\u5e8f\u5217\uff1a # TYPE foo gauge foo { color = \"red\" , size = \"small\" } 4 foo { color = \"green\" , size = \"medium\" } 8 foo { color = \"blue\" , size = \"large\" } 16 # TYPE bar gauge bar { color = \"green\" , size = \"xlarge\" } 2 bar { color = \"blue\" , size = \"large\" } 7 bar { color = \"red\" , size = \"small\" } 5 \u7576\u6211\u5011\u57f7\u884c\u67e5\u8a62\u8a9e\u53e5 foo{} + bar{} \u7684\u6642\u5019\uff0c\u5c0d\u65bc\u5411\u91cf\u5de6\u908a\u7684\u6bcf\u4e00\u500b\u5143\u7d20\uff0c\u64cd\u4f5c\u7b26\u90fd\u6703\u5617\u8a66\u5728\u53f3\u908a\u88e1\u9762\u627e\u5230\u4e00\u500b\u5339\u914d\u7684\u5143\u7d20\uff0c\u5339\u914d\u662f\u901a\u904e\u6bd4\u8f03\u6240\u6709\u7684\u6a19\u7c64\u4f86\u5b8c\u6210\u7684\uff0c\u6c92\u6709\u5339\u914d\u7684\u5143\u7d20\u6703\u88ab\u4e1f\u68c4\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u5176\u4e2d\u7684 foo{color=\"green\", size=\"medium\"} \u8207 bar{color=\"green\", size=\"xlarge\"} \u5169\u500b\u5e8f\u5217\u7684\u6a19\u7c64\u662f\u4e0d\u5339\u914d\u7684\uff0c\u5176\u9918\u5169\u500b\u5e8f\u5217\u6a19\u7c64\u5339\u914d\uff0c\u6240\u4ee5\u8a08\u7b97\u7d50\u679c\u6703\u62cb\u68c4\u6389\u4e0d\u5339\u914d\u7684\u5e8f\u5217\uff0c\u5f97\u5230\u7684\u7d50\u679c\u70ba\u5176\u9918\u5e8f\u5217\u7684\u503c\u76f8\u52a0\u3002 \u4e0a\u9762\u4f8b\u5b50\u4e2d\u5176\u4e2d\u4e0d\u5339\u914d\u7684\u6a19\u7c64\u4e3b\u8981\u662f\u56e0\u70ba\u7b2c\u4e8c\u500b size \u6a19\u7c64\u4e0d\u4e00\u81f4\u9020\u6210\u7684\uff0c\u90a3\u9ebc\u5982\u679c\u6211\u5011\u5728\u8a08\u7b97\u7684\u6642\u5019\u5ffd\u7565\u6389\u9019\u500b\u6a19\u7c64\u53ef\u4ee5\u55ce\uff1f\u5982\u4e0b\u5716\u6240\u793a\uff1a \u540c\u6a23\u91dd\u5c0d\u4e0a\u9762\u7684\u5169\u500b\u6307\u6a19\uff0c\u6211\u5011\u5728\u9032\u884c\u8a08\u7b97\u7684\u6642\u5019\u53ef\u4ee5\u4f7f\u7528 on \u6216\u8005 ignoring \u4fee\u98fe\u7b26\u4f86\u6307\u5b9a\u7528\u65bc\u5339\u914d\u7684\u6a19\u7c64\u9032\u884c\u8a08\u7b97\uff0c\u7531\u65bc\u793a\u4f8b\u4e2d\u5169\u908a\u7684\u6a19\u7c64\u90fd\u5177\u6709 color \u6a19\u7c64\uff0c\u6240\u4ee5\u5728\u9032\u884c\u8a08\u7b97\u7684\u6642\u5019\u6211\u5011\u53ef\u4ee5\u57fa\u65bc\u8a72\u6a19\u7c64 \uff08on (color)\uff09 \u6216\u8005\u5ffd\u7565\u5176\u4ed6\u7684\u6a19\u7c64 \uff08ignoring (size)\uff09 \u9032\u884c\u8a08\u7b97\uff0c\u9019\u6a23\u5f97\u5230\u7684\u7d50\u679c\u5c31\u662f\u6240\u4ee5\u5339\u914d\u7684\u6a19\u7c64\u5e8f\u5217\u76f8\u52a0\u7684\u7d50\u679c\uff0c\u8981\u6ce8\u610f\u7d50\u679c\u4e2d\u7684\u6a19\u7c64\u4e5f\u662f\u5339\u914d\u7684\u6a19\u7c64\u3002","title":"\u4e00\u5c0d\u4e00"},{"location":"prometheus/promql/operate/#_5","text":"\u4e0a\u9762\u8b1b\u89e3\u7684\u4e00\u5c0d\u4e00\u7684\u5411\u91cf\u8a08\u7b97\u662f\u6700\u76f4\u63a5\u7684\u65b9\u5f0f\uff0c\u5728\u591a\u6578\u60c5\u6cc1\u4e0b\uff0c on \u6216\u8005 ignoring \u4fee\u98fe\u7b26\u6709\u52a9\u65bc\u662f\u67e5\u8a62\u8fd4\u56de\u5408\u7406\u7684\u7d50\u679c\uff0c\u4f46\u901a\u5e38\u60c5\u6cc1\u7528\u65bc\u8a08\u7b97\u7684\u5169\u500b\u5411\u91cf\u4e4b\u9593\u4e26\u4e0d\u662f\u4e00\u5c0d\u4e00\u7684\u95dc\u4fc2\uff0c\u66f4\u591a\u7684\u662f\u4e00\u5c0d\u591a\u6216\u8005\u591a\u5c0d\u4e00\u7684\u95dc\u4fc2\uff0c\u5c0d\u65bc\u9019\u7a2e\u5834\u666f\u6211\u5011\u5c31\u4e0d\u80fd\u7c21\u55ae\u4f7f\u7528\u4e0a\u9762\u7684\u65b9\u5f0f\u9032\u884c\u8655\u7406\u4e86\u3002 \u591a\u5c0d\u4e00\u548c\u4e00\u5c0d\u591a\u5169\u7a2e\u5339\u914d\u6a21\u5f0f\u6307\u7684\u662f\u4e00\u5074\u7684\u6bcf\u4e00\u500b\u5411\u91cf\u5143\u7d20\u53ef\u4ee5\u8207\u591a\u5074\u7684\u591a\u500b\u5143\u7d20\u5339\u914d\u7684\u60c5\u6cc1\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0c\u5fc5\u9808\u4f7f\u7528 group \u4fee\u98fe\u7b26\uff1a group_left \u6216\u8005 group_right \u4f86\u78ba\u5b9a\u54ea\u4e00\u500b\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6578\uff08\u5145\u7576\u591a\u7684\u89d2\u8272\uff09\u3002\u591a\u5c0d\u4e00\u548c\u4e00\u5c0d\u591a\u5169\u7a2e\u6a21\u5f0f\u4e00\u5b9a\u662f\u51fa\u73fe\u5728\u64cd\u4f5c\u7b26\u5169\u5074\u8868\u9054\u5f0f\u8fd4\u56de\u7684\u5411\u91cf\u6a19\u7c64\u4e0d\u4e00\u81f4\u7684\u60c5\u6cc1\uff0c\u56e0\u6b64\u540c\u6a23\u9700\u8981\u4f7f\u7528 ignoring \u548c on \u4fee\u98fe\u7b26\u4f86\u6392\u9664\u6216\u8005\u9650\u5b9a\u5339\u914d\u7684\u6a19\u7c64\u5217\u8868\u3002 \u4f8b\u5982 demo_num_cpus \u6307\u6a19\u544a\u8a34\u6211\u5011\u6bcf\u500b\u5be6\u4f8b\u7684 CPU \u6838\u5fc3\u6578\u91cf\uff0c\u53ea\u6709 instance \u548c job \u9019\u5169\u500b\u6a19\u7c64\u7dad\u5ea6\u3002 \u800c demo_cpu_usage_seconds_total \u6307\u6a19\u5247\u591a\u4e86\u4e00\u500b mode \u6a19\u7c64\u7684\u7dad\u5ea6\uff0c\u5c07\u6bcf\u500b mode \u6a21\u5f0f\uff08 idle \u3001 system \u3001 user \uff09\u7684 CPU \u4f7f\u7528\u60c5\u6cc1\u5206\u958b\u9032\u884c\u4e86\u7d71\u8a08\u3002 \u5982\u679c\u8981\u8a08\u7b97\u6bcf\u500b\u6a21\u5f0f\u7684 CPU \u4f7f\u7528\u91cf\u9664\u4ee5\u6838\u5fc3\u6578\uff0c\u6211\u5011\u9700\u8981\u544a\u8a34\u9664\u6cd5\u904b\u7b97\u7b26\u6309\u7167 demo_cpu_usage_seconds_total \u6307\u6a19\u4e0a\u984d\u5916\u7684 mode \u6a19\u7c64\u7dad\u5ea6\u5c0d\u7d50\u679c\u9032\u884c\u5206\u7d44\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 group_left \uff08\u8868\u793a\u5de6\u908a\u7684\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6578\uff09\u4fee\u98fe\u7b26\u4f86\u5be6\u73fe\u3002\u540c\u6642\uff0c\u6211\u5011\u9084\u9700\u8981\u901a\u904e on() \u4fee\u98fe\u7b26\u660e\u78ba\u5c07\u6240\u8003\u616e\u7684\u6a19\u7c64\u96c6\u6e1b\u5c11\u5230\u9700\u8981\u5339\u914d\u7684\u6a19\u7c64\u5217\u8868\uff1a rate ( demo_cpu_usage_seconds_total { job = \" demo \"}[ 5m ] ) / on ( job , instance ) group_left demo_num_cpus { job = \" demo \"} \u4e0a\u9762\u7684\u8868\u9054\u5f0f\u53ef\u4ee5\u6b63\u5e38\u5f97\u5230\u7d50\u679c\uff1a \u9664\u4e86 on() \u4e4b\u5916\uff0c\u9084\u53ef\u4ee5\u4f7f\u7528\u76f8\u53cd\u7684 ignoring() \u4fee\u98fe\u7b26\uff0c\u53ef\u4ee5\u7528\u4f86\u5c07\u4e00\u4e9b\u6a19\u7c64\u7dad\u5ea6\u5f9e\u4e8c\u5143\u904b\u7b97\u64cd\u4f5c\u5339\u914d\u4e2d\u5ffd\u7565\u6389\uff0c\u5982\u679c\u5728\u64cd\u4f5c\u7b26\u7684\u53f3\u5074\u6709\u984d\u5916\u7684\u7dad\u5ea6\uff0c\u5247\u61c9\u8a72\u4f7f\u7528 group_right \uff08\u8868\u793a\u53f3\u908a\u7684\u5411\u91cf\u5177\u6709\u66f4\u9ad8\u7684\u57fa\u6578\uff09\u4fee\u98fe\u7b26\u3002 \u6bd4\u5982\u4e0a\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\u540c\u6a23\u53ef\u4ee5\u7528 ignoring \u95dc\u9375\u5b57\u4f86\u5b8c\u6210\uff1a rate ( demo_cpu_usage_seconds_total { job = \" demo \"}[ 5m ] ) / ignoring ( mode ) group_left demo_num_cpus { job = \" demo \"} \u5f97\u5230\u7684\u7d50\u679c\u548c\u524d\u9762\u7528 on() \u67e5\u8a62\u7684\u7d50\u679c\u662f\u4e00\u81f4\u7684\u3002 \u5230\u9019\u88e1\u6211\u5011\u5c31\u77e5\u9053\u77ad\u5982\u4f55\u5728 PromQL \u4e2d\u9032\u884c\u6a19\u91cf\u548c\u5411\u91cf\u4e4b\u9593\u7684\u904b\u7b97\u4e86\u3002\u4e0d\u904e\u6211\u5011\u5728\u4f7f\u7528 PromQL \u67e5\u8a62\u6578\u64da\u7684\u6642\u5019\u9084\u884c\u8981\u907f\u514d\u4f7f\u7528\u95dc\u806f\u67e5\u8a62\uff0c\u5148\u60f3\u60f3\u80fd\u4e0d\u80fd\u901a\u904e Relabel\uff08\u5f8c\u7e8c\u6703\u8a73\u7d30\u4ecb\u7d39\uff09\u7684\u65b9\u5f0f\u7d66\u539f\u59cb\u6578\u64da\u591a\u52a0\u500b Label\uff0c\u4e00\u689d\u8a9e\u53e5\u80fd\u67e5\u51fa\u4f86\u7684\u4f55\u5fc5\u7528 Join \u5462\uff1f\u6642\u5e8f\u6578\u64da\u5eab\u4e0d\u662f\u95dc\u4fc2\u6578\u64da\u5eab\u3002 \u7df4\u7fd2 1.\u8a08\u7b97\u904e\u53bb 5 \u5206\u9418\u6240\u6709 POST \u8acb\u6c42\u5e73\u5747\u6578\u7684\u7e3d\u548c\u76f8\u5c0d\u65bc\u6240\u6709\u8acb\u6c42\u5e73\u5747\u6578\u7e3d\u548c\u7684\u767e\u5206\u6bd4\u3002 sum ( rate ( demo_api_request_duration_seconds_count { method = \" POST \"}[ 5m ] )) / sum ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) * 100 2.\u8a08\u7b97\u904e\u53bb 5 \u5206\u9418\u5167\u6bcf\u500b\u5be6\u4f8b\u7684 user \u548c system \u7684\u6a21\u5f0f\uff08 demo_cpu_usage_seconds_total \u6307\u6a19\uff09\u4e0b CPU \u4f7f\u7528\u91cf\u5e73\u5747\u503c\u7e3d\u548c\u3002 sum by ( instance , job ) ( rate ( demo_cpu_usage_seconds_total { mode =~ \" user|system \"}[ 5m ] )) \u6216\u8005 sum without ( mode ) ( rate ( demo_cpu_usage_seconds_total { mode =~ \" user|system \"}[ 5m ] )) \u6216\u8005 rate ( demo_cpu_usage_seconds_total { mode = \" user \"}[ 5m ] ) + ignoring ( mode ) rate ( demo_cpu_usage_seconds_total { mode = \" system \"}[ 5m ] )","title":"\u4e00\u5c0d\u591a\u8207\u591a\u5c0d\u4e00"},{"location":"prometheus/promql/rates/","text":"\u8b8a\u5316\u7387 \u00b6 \u539f\u6587: \u53d8\u5316\u7387 \u901a\u5e38\u4f86\u8aaa\u76f4\u63a5\u7e6a\u88fd\u4e00\u500b\u539f\u59cb\u7684 Counter \u985e\u578b\u7684\u6307\u6a19\u6578\u64da\u7528\u8655\u4e0d\u5927\uff0c\u56e0\u70ba\u5b83\u5011\u6703\u4e00\u76f4\u589e\u52a0\uff0c\u4e00\u822c\u4f86\u8aaa\u662f\u4e0d\u6703\u53bb\u76f4\u63a5\u95dc\u5fc3\u9019\u500b\u6578\u503c\u7684\uff0c\u56e0\u70ba Counter \u4e00\u65e6\u91cd\u7f6e\uff0c\u7e3d\u8a08\u6578\u5c31\u6c92\u6709\u610f\u7fa9\u4e86\uff0c\u6bd4\u5982\u6211\u5011\u76f4\u63a5\u57f7\u884c\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a demo_api_request_duration_seconds_count { job = \" demo \"} \u53ef\u4ee5\u5f97\u5230\u4e0b\u5716\u6240\u793a\u7684\u5716\u5f62\uff1a \u53ef\u4ee5\u770b\u5230\u6240\u6709\u7684\u90fd\u662f\u4e0d\u65b7\u589e\u9577\u7684\uff0c\u4e00\u822c\u4f86\u8aaa\u6211\u5011\u66f4\u60f3\u8981\u77e5\u9053\u7684\u662f Counter \u6307\u6a19\u7684\u8b8a\u5316\u7387\uff0cPromQL \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u51fd\u6578\u4f86\u8a08\u7b97\u8b8a\u5316\u7387\u3002 rate() \u51fd\u6578 \u00b6 \u7528\u65bc\u8a08\u7b97\u8b8a\u5316\u7387\u7684\u6700\u5e38\u898b\u51fd\u6578\u662f rate() \uff0c rate() \u51fd\u6578\u7528\u65bc\u8a08\u7b97===\u5728\u6307\u5b9a\u6642\u9593\u7bc4\u570d\u5167\u8a08\u6578\u5668\u5e73\u5747\u6bcf\u79d2\u7684\u589e\u52a0\u91cf===\u3002\u56e0\u70ba\u662f\u8a08\u7b97\u4e00\u500b\u6642\u9593\u7bc4\u570d\u5167\u7684\u5e73\u5747\u503c\uff0c\u6240\u4ee5\u6211\u5011\u9700\u8981\u5728\u5e8f\u5217\u9078\u64c7\u5668\u4e4b\u5f8c\u6dfb\u52a0\u4e00\u500b\u7bc4\u570d\u9078\u64c7\u5668\u3002 \u4f8b\u5982\u6211\u5011\u8981\u8a08\u7b97 demo_api_request_duration_seconds_count \u5728\u6700\u8fd1\u4e94\u5206\u9418\u5167\u7684\u6bcf\u79d2\u5e73\u5747\u8b8a\u5316\u7387\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a rate ( demo_api_request_duration_seconds_count [ 5m ] ) \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u5716\u5f62\uff1a \u73fe\u5728\u7e6a\u88fd\u7684\u5716\u5f62\u770b\u8d77\u4f86\u986f\u7136\u66f4\u52a0\u6709\u610f\u7fa9\u4e86\uff0c\u9032\u884c rate \u8a08\u7b97\u7684\u6642\u5019\u662f\u9078\u64c7\u6307\u5b9a\u6642\u9593\u7bc4\u570d\u4e0b\u7684\u7b2c\u4e00\u548c\u6700\u5f8c\u4e00\u500b\u6a23\u672c\u9032\u884c\u8a08\u7b97\uff0c\u4e0b\u5716\u662f\u8868\u793a\u77ac\u6642\u8a08\u7b97\u7684\u8a08\u7b97\u65b9\u5f0f\uff1a \u5f80\u5f80\u6211\u5011\u9700\u8981\u7684\u662f\u7e6a\u88fd\u4e00\u500b\u5716\u5f62\uff0c\u90a3\u9ebc\u5c31\u9700\u8981\u9032\u884c\u5340\u9593\u67e5\u8a62\uff0c\u6307\u5b9a\u4e00\u500b\u6642\u9593\u7bc4\u570d\u5167\u9032\u884c\u591a\u6b21\u8a08\u7b97\uff0c\u5c07\u7d50\u679c\u4e32\u806f\u8d77\u4f86\u5f62\u6210\u4e00\u500b\u5716\u5f62\uff1a \u5c0d\u65bc rate() \u548c\u76f8\u95dc\u51fd\u6578\u6709\u5e7e\u500b\u9700\u8981\u8aaa\u660e\u7684\uff1a \u7576\u88ab\u6293\u53d6\u6307\u6a19\u9032\u7684\u7a0b\u91cd\u555f\u6642\uff0c Counter \u6307\u6a19\u53ef\u80fd\u6703\u91cd\u7f6e\u70ba 0\uff0c\u4f46 rate() \u51fd\u6578\u6703\u81ea\u52d5\u8655\u7406\u9019\u500b\u554f\u984c\uff0c\u5b83\u6703\u5047\u8a2d Counter \u6307\u6a19\u7684\u503c\u53ea\u8981\u662f\u6e1b\u5c11\u4e86\u5c31\u8a8d\u70ba\u662f\u88ab\u91cd\u7f6e\u4e86\uff0c\u7136\u5f8c\u5b83\u53ef\u4ee5\u8abf\u6574\u5f8c\u7e8c\u7684\u6a23\u672c\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u6642\u9593\u5e8f\u5217\u7684\u503c\u70ba[5,10,4,6]\uff0c\u5247\u5c07\u5176\u8996\u70ba[5,10,14,16]\u3002 \u8b8a\u5316\u7387\u662f\u5f9e\u6307\u5b9a\u7684\u6642\u9593\u7bc4\u570d\u4e0b\u5305\u542b\u7684\u6a23\u672c\u9032\u884c\u8a08\u7b97\u7684\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u9019\u500b\u6642\u9593\u7a97\u53e3\u7684\u908a\u754c\u4e26\u4e0d\u4e00\u5b9a\u5c31\u662f\u4e00\u500b\u6a23\u672c\u6578\u64da\uff0c\u53ef\u80fd\u6703\u4e0d\u5b8c\u5168\u5c0d\u9f4a\uff0c\u6240\u4ee5\uff0c\u5373\u4f7f\u5c0d\u65bc\u6bcf\u6b21\u90fd\u662f\u589e\u52a0\u6574\u6578\u7684 Counter\uff0c\u4e5f\u53ef\u80fd\u8a08\u7b97\u7d50\u679c\u662f\u975e\u6574\u6578\u3002 \u53e6\u5916\u6211\u5011\u9700\u8981\u6ce8\u610f\u7576\u628a rate() \u8207\u4e00\u500b\u805a\u5408\u904b\u7b97\u7b26\uff08\u4f8b\u5982 sum() \uff09\u6216\u4e00\u500b\u96a8\u6642\u9593\u805a\u5408\u7684\u51fd\u6578\uff08\u4efb\u4f55\u4ee5 _over_time \u7d50\u5c3e\u7684\u51fd\u6578\uff09\u7d50\u5408\u8d77\u4f86\u4f7f\u7528\u6642\uff0c\u7e3d\u662f\u5148\u53d6\u7528 rate() \u51fd\u6578\uff0c\u7136\u5f8c\u518d\u9032\u884c\u805a\u5408\uff0c\u5426\u5247\uff0c\u7576\u4f60\u7684\u76ee\u6a19\u91cd\u65b0\u555f\u52d5\u6642\uff0c rate() \u51fd\u6578\u7121\u6cd5\u6aa2\u6e2c\u5230 Counter \u7684\u91cd\u7f6e\u3002 Info \u6ce8\u610f\uff1a rate() \u51fd\u6578\u9700\u8981\u5728\u6307\u5b9a\u7a97\u53e3\u4e0b\u81f3\u5c11\u6709\u5169\u500b\u6a23\u672c\u624d\u80fd\u8a08\u7b97\u8f38\u51fa\u3002\u4e00\u822c\u4f86\u8aaa\uff0c\u6bd4\u8f03\u597d\u7684\u505a\u6cd5\u662f\u9078\u64c7\u7bc4\u570d\u7a97\u53e3\u5927\u5c0f\u81f3\u5c11\u662f\u6293\u53d6\u9593\u9694\u7684 4 \u500d\uff0c\u9019\u6a23\u5373\u4f7f\u5728\u9047\u5230\u7a97\u53e3\u5c0d\u9f4a\u6216\u6293\u53d6\u6545\u969c\u6642\u4e5f\u6709\u53ef\u4ee5\u4f7f\u7528\u7684\u6a23\u672c\u9032\u884c\u8a08\u7b97\uff0c\u4f8b\u5982\uff0c\u5c0d\u65bc 1 \u5206\u9418\u7684\u6293\u53d6\u9593\u9694\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 4 \u5206\u9418\u7684 Rate \u8a08\u7b97\uff0c\u4f46\u662f\u901a\u5e38\u5c07\u5176\u56db\u6368\u4e94\u5165\u70ba 5 \u5206\u9418\u3002\u6240\u4ee5\u5982\u679c\u4f7f\u7528 query_range \u5340\u9593\u67e5\u8a62\uff0c\u4f8b\u5982\u5728\u7e6a\u5716\u4e2d\uff0c\u90a3\u9ebc\u7bc4\u570d\u61c9\u8a72\u81f3\u5c11\u662f\u6b65\u9577\u7684\u5927\u5c0f\uff0c\u5426\u5247\u6703\u4e1f\u5931\u4e00\u4e9b\u6578\u64da\u3002 irate() \u51fd\u6578 \u00b6 \u7531\u65bc\u4f7f\u7528 rate \u6216\u8005 increase \u51fd\u6578\u53bb\u8a08\u7b97\u6a23\u672c\u7684\u5e73\u5747\u589e\u9577\u901f\u7387\uff0c\u5bb9\u6613\u9677\u5165\u9577\u5c3e\u554f\u984c\u7576\u4e2d\uff0c\u5176\u7121\u6cd5\u53cd\u61c9\u5728\u6642\u9593\u7a97\u53e3\u5167\u6a23\u672c\u6578\u64da\u7684\u7a81\u767c\u8b8a\u5316\u3002 \u4f8b\u5982\uff0c\u5c0d\u65bc\u4e3b\u6a5f\u800c\u8a00\u5728 2 \u5206\u9418\u7684\u6642\u9593\u7a97\u53e3\u5167\uff0c\u53ef\u80fd\u5728\u67d0\u4e00\u500b\u7531\u65bc\u8a2a\u554f\u91cf\u6216\u8005\u5176\u5b83\u554f\u984c\u5c0e\u81f4 CPU \u4f54\u7528 100%\u7684\u60c5\u6cc1\uff0c\u4f46\u662f\u901a\u904e\u8a08\u7b97\u5728\u6642\u9593\u7a97\u53e3\u5167\u7684\u5e73\u5747\u589e\u9577\u7387\u537b\u7121\u6cd5\u53cd\u61c9\u51fa\u8a72\u554f\u984c\u3002 \u70ba\u4e86\u89e3\u6c7a\u8a72\u554f\u984c\uff0cPromQL \u63d0\u4f9b\u4e86\u53e6\u5916\u4e00\u500b\u9748\u654f\u5ea6\u66f4\u9ad8\u7684\u51fd\u6578 irate(v range-vector) \u3002 irate \u540c\u6a23\u7528\u65bc\u8a08\u7b97\u5340\u9593\u5411\u91cf\u7684\u8a08\u7b97\u7387\uff0c\u4f46\u662f\u5176\u53cd\u61c9\u51fa\u7684\u662f\u77ac\u6642\u589e\u9577\u7387\u3002 rate \u51fd\u6578\u662f\u901a\u904e\u5340\u9593\u5411\u91cf\u4e2d\u6700\u5f8c\u5169\u500b\u6a23\u672c\u6578\u64da\u4f86\u8a08\u7b97\u5340\u9593\u5411\u91cf\u7684\u589e\u9577\u901f\u7387\u3002\u9019\u7a2e\u65b9\u5f0f\u53ef\u4ee5\u907f\u514d\u5728\u6642\u9593\u7a97\u53e3\u7bc4\u570d\u5167\u7684\u9577\u5c3e\u554f\u984c\uff0c\u4e26\u4e14\u9ad4\u73fe\u51fa\u66f4\u597d\u7684\u9748\u654f\u5ea6\uff0c\u901a\u904e irate \u51fd\u6578\u7e6a\u88fd\u7684\u5716\u6a19\u80fd\u5920\u66f4\u597d\u7684\u53cd\u61c9\u6a23\u672c\u6578\u64da\u7684\u77ac\u6642\u8b8a\u5316\u72c0\u614b\u3002 \u90a3\u65e2\u7136\u662f\u4f7f\u7528\u6700\u5f8c\u5169\u500b\u9ede\u8a08\u7b97\uff0c\u90a3\u70ba\u4ec0\u9ebc\u9084\u8981\u6307\u5b9a\u985e\u4f3c\u65bc [1m] \u7684\u6642\u9593\u7bc4\u570d\u5462\uff1f\u9019\u500b [1m] \u4e0d\u662f\u7528\u4f86\u8a08\u7b97\u7684\uff0c irate \u5728\u8a08\u7b97\u7684\u6642\u5019\u6703\u6700\u591a\u5411\u524d\u5728 [1m] \u7bc4\u570d\u5167\u627e\u9ede\uff0c\u5982\u679c\u8d85\u904e [1m] \u6c92\u6709\u627e\u5230\u6578\u64da\u9ede\uff0c\u9019\u500b\u9ede\u7684\u8a08\u7b97\u5c31\u653e\u68c4\u4e86\u3002 \u7531\u65bc rate() \u63d0\u4f9b\u4e86\u66f4\u5e73\u6ed1\u7684\u7d50\u679c\uff0c\u56e0\u6b64\u5728\u9577\u671f\u8da8\u52e2\u5206\u6790\u6216\u8005\u544a\u8b66\u4e2d\u66f4\u63a8\u85a6\u4f7f\u7528 rate \u51fd\u6578\uff0c\u56e0\u70ba\u7576\u901f\u7387\u53ea\u51fa\u73fe\u4e00\u500b\u77ed\u66ab\u7684\u5cf0\u503c\u6642\uff0c\u4e0d\u61c9\u8a72\u89f8\u767c\u8a72\u5831\u8b66\u3002 \u4f7f\u7528 irate() \u51fd\u6578\u4e0a\u9762\u7684\u8868\u9054\u5f0f\u6703\u51fa\u73fe\u4e00\u4e9b\u77ed\u66ab\u4e0b\u964d\u7684\u5716\u5f62\uff1a \u9664\u4e86\u8a08\u7b97\u6bcf\u79d2\u901f\u7387\uff0c\u4f60\u9084\u53ef\u4ee5\u4f7f\u7528 increase() \u51fd\u6578\u67e5\u8a62\u6307\u5b9a\u6642\u9593\u7bc4\u570d\u5167\u7684\u7e3d\u589e\u91cf\uff0c\u5b83\u57fa\u672c\u4e0a\u76f8\u7576\u65bc\u901f\u7387\u4e58\u4ee5\u6642\u9593\u7bc4\u570d\u9078\u64c7\u5668\u4e2d\u7684\u79d2\u6578\uff1a increase ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 1h ] ) \u6bd4\u5982\u4e0a\u9762\u8868\u9054\u5f0f\u7684\u7d50\u679c\u548c\u4f7f\u7528 rate() \u51fd\u6578\u8a08\u7b97\u7684\u7d50\u679c\u6574\u9ad4\u5716\u5f62\u8da8\u52e2\u90fd\u662f\u4e00\u6a23\u7684\uff0c\u53ea\u662f Y \u8ef8\u7684\u6578\u64da\u4e0d\u4e00\u6a23\u800c\u5df2\uff0c\u4e00\u500b\u8868\u793a\u6578\u91cf\uff0c\u4e00\u500b\u8868\u793a\u767e\u5206\u6bd4\u3002 rate() \u3001 irate() \u548c increase() \u51fd\u6578\u53ea\u80fd\u8f38\u51fa\u975e\u8ca0\u503c\u7684\u7d50\u679c\uff0c\u5c0d\u65bc\u8ddf\u8e2a\u4e00\u500b\u53ef\u4ee5\u4e0a\u5347\u6216\u4e0b\u964d\u7684\u503c\u7684\u6307\u6a19\uff08\u5982\u6eab\u5ea6\u3001\u5167\u5b58\u6216\u78c1\u76e4\u7a7a\u9593\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 delta() \u548c deriv() \u51fd\u6578\u4f86\u4ee3\u66ff\u3002 deriv() \u51fd\u6578\u53ef\u4ee5\u8a08\u7b97\u4e00\u500b\u5340\u9593\u5411\u91cf\u4e2d\u5404\u500b\u6642\u9593\u5e8f\u5217\u4e8c\u968e\u5c0e\u6578\uff0c\u4f7f\u7528\u7c21\u55ae\u7dda\u6027\u56de\u6b78\uff0c deriv(v range-vector) \u7684\u53c3\u6578\u662f\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u8fd4\u56de\u4e00\u500b\u77ac\u6642\u5411\u91cf\uff0c\u9019\u500b\u51fd\u6578\u4e00\u822c\u53ea\u7528\u5728 Gauge \u985e\u578b\u7684\u6642\u9593\u5e8f\u5217\u4e0a\u3002\u4f8b\u5982\uff0c\u8981\u8a08\u7b97\u5728 15 \u5206\u9418\u7684\u7a97\u53e3\u4e0b\uff0c\u6bcf\u79d2\u9418\u78c1\u76e4\u4f7f\u7528\u91cf\u4e0a\u5347\u6216\u4e0b\u964d\u4e86\u591a\u5c11\uff1a \u9084\u6709\u53e6\u5916\u4e00\u500b predict_linear() \u51fd\u6578\u53ef\u4ee5\u9810\u6e2c\u4e00\u500b Gauge \u985e\u578b\u7684\u6307\u6a19\u5728\u672a\u4f86\u6307\u5b9a\u4e00\u6bb5\u6642\u9593\u5167\u7684\u503c\uff0c\u4f8b\u5982\u6211\u5011\u53ef\u4ee5\u6839\u64da\u904e\u53bb 15 \u5206\u9418\u7684\u8b8a\u5316\u60c5\u6cc1\uff0c\u4f86\u9810\u6e2c\u4e00\u500b\u5c0f\u6642\u5f8c\u7684\u78c1\u76e4\u4f7f\u7528\u91cf\u662f\u591a\u5c11\uff0c\u53ef\u4ee5\u7528\u5982\u4e0b\u6240\u793a\u7684\u8868\u9054\u5f0f\u4f86\u67e5\u8a62\uff1a predict_linear ( demo_disk_usage_bytes { job = \" demo \"}[ 15m ], 3600 ) \u9019\u500b\u51fd\u6578\u53ef\u4ee5\u7528\u65bc\u5831\u8b66\uff0c\u544a\u8a34\u6211\u5011\u78c1\u76e4\u662f\u5426\u6703\u5728\u5e7e\u500b\u5c0f\u6642\u5019\u5167\u7528\u5b8c\u3002","title":"\u8b8a\u5316\u7387"},{"location":"prometheus/promql/rates/#_1","text":"\u539f\u6587: \u53d8\u5316\u7387 \u901a\u5e38\u4f86\u8aaa\u76f4\u63a5\u7e6a\u88fd\u4e00\u500b\u539f\u59cb\u7684 Counter \u985e\u578b\u7684\u6307\u6a19\u6578\u64da\u7528\u8655\u4e0d\u5927\uff0c\u56e0\u70ba\u5b83\u5011\u6703\u4e00\u76f4\u589e\u52a0\uff0c\u4e00\u822c\u4f86\u8aaa\u662f\u4e0d\u6703\u53bb\u76f4\u63a5\u95dc\u5fc3\u9019\u500b\u6578\u503c\u7684\uff0c\u56e0\u70ba Counter \u4e00\u65e6\u91cd\u7f6e\uff0c\u7e3d\u8a08\u6578\u5c31\u6c92\u6709\u610f\u7fa9\u4e86\uff0c\u6bd4\u5982\u6211\u5011\u76f4\u63a5\u57f7\u884c\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a demo_api_request_duration_seconds_count { job = \" demo \"} \u53ef\u4ee5\u5f97\u5230\u4e0b\u5716\u6240\u793a\u7684\u5716\u5f62\uff1a \u53ef\u4ee5\u770b\u5230\u6240\u6709\u7684\u90fd\u662f\u4e0d\u65b7\u589e\u9577\u7684\uff0c\u4e00\u822c\u4f86\u8aaa\u6211\u5011\u66f4\u60f3\u8981\u77e5\u9053\u7684\u662f Counter \u6307\u6a19\u7684\u8b8a\u5316\u7387\uff0cPromQL \u63d0\u4f9b\u4e86\u4e0d\u540c\u7684\u51fd\u6578\u4f86\u8a08\u7b97\u8b8a\u5316\u7387\u3002","title":"\u8b8a\u5316\u7387"},{"location":"prometheus/promql/rates/#rate","text":"\u7528\u65bc\u8a08\u7b97\u8b8a\u5316\u7387\u7684\u6700\u5e38\u898b\u51fd\u6578\u662f rate() \uff0c rate() \u51fd\u6578\u7528\u65bc\u8a08\u7b97===\u5728\u6307\u5b9a\u6642\u9593\u7bc4\u570d\u5167\u8a08\u6578\u5668\u5e73\u5747\u6bcf\u79d2\u7684\u589e\u52a0\u91cf===\u3002\u56e0\u70ba\u662f\u8a08\u7b97\u4e00\u500b\u6642\u9593\u7bc4\u570d\u5167\u7684\u5e73\u5747\u503c\uff0c\u6240\u4ee5\u6211\u5011\u9700\u8981\u5728\u5e8f\u5217\u9078\u64c7\u5668\u4e4b\u5f8c\u6dfb\u52a0\u4e00\u500b\u7bc4\u570d\u9078\u64c7\u5668\u3002 \u4f8b\u5982\u6211\u5011\u8981\u8a08\u7b97 demo_api_request_duration_seconds_count \u5728\u6700\u8fd1\u4e94\u5206\u9418\u5167\u7684\u6bcf\u79d2\u5e73\u5747\u8b8a\u5316\u7387\uff0c\u5247\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a rate ( demo_api_request_duration_seconds_count [ 5m ] ) \u53ef\u4ee5\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u5716\u5f62\uff1a \u73fe\u5728\u7e6a\u88fd\u7684\u5716\u5f62\u770b\u8d77\u4f86\u986f\u7136\u66f4\u52a0\u6709\u610f\u7fa9\u4e86\uff0c\u9032\u884c rate \u8a08\u7b97\u7684\u6642\u5019\u662f\u9078\u64c7\u6307\u5b9a\u6642\u9593\u7bc4\u570d\u4e0b\u7684\u7b2c\u4e00\u548c\u6700\u5f8c\u4e00\u500b\u6a23\u672c\u9032\u884c\u8a08\u7b97\uff0c\u4e0b\u5716\u662f\u8868\u793a\u77ac\u6642\u8a08\u7b97\u7684\u8a08\u7b97\u65b9\u5f0f\uff1a \u5f80\u5f80\u6211\u5011\u9700\u8981\u7684\u662f\u7e6a\u88fd\u4e00\u500b\u5716\u5f62\uff0c\u90a3\u9ebc\u5c31\u9700\u8981\u9032\u884c\u5340\u9593\u67e5\u8a62\uff0c\u6307\u5b9a\u4e00\u500b\u6642\u9593\u7bc4\u570d\u5167\u9032\u884c\u591a\u6b21\u8a08\u7b97\uff0c\u5c07\u7d50\u679c\u4e32\u806f\u8d77\u4f86\u5f62\u6210\u4e00\u500b\u5716\u5f62\uff1a \u5c0d\u65bc rate() \u548c\u76f8\u95dc\u51fd\u6578\u6709\u5e7e\u500b\u9700\u8981\u8aaa\u660e\u7684\uff1a \u7576\u88ab\u6293\u53d6\u6307\u6a19\u9032\u7684\u7a0b\u91cd\u555f\u6642\uff0c Counter \u6307\u6a19\u53ef\u80fd\u6703\u91cd\u7f6e\u70ba 0\uff0c\u4f46 rate() \u51fd\u6578\u6703\u81ea\u52d5\u8655\u7406\u9019\u500b\u554f\u984c\uff0c\u5b83\u6703\u5047\u8a2d Counter \u6307\u6a19\u7684\u503c\u53ea\u8981\u662f\u6e1b\u5c11\u4e86\u5c31\u8a8d\u70ba\u662f\u88ab\u91cd\u7f6e\u4e86\uff0c\u7136\u5f8c\u5b83\u53ef\u4ee5\u8abf\u6574\u5f8c\u7e8c\u7684\u6a23\u672c\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u6642\u9593\u5e8f\u5217\u7684\u503c\u70ba[5,10,4,6]\uff0c\u5247\u5c07\u5176\u8996\u70ba[5,10,14,16]\u3002 \u8b8a\u5316\u7387\u662f\u5f9e\u6307\u5b9a\u7684\u6642\u9593\u7bc4\u570d\u4e0b\u5305\u542b\u7684\u6a23\u672c\u9032\u884c\u8a08\u7b97\u7684\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\u9019\u500b\u6642\u9593\u7a97\u53e3\u7684\u908a\u754c\u4e26\u4e0d\u4e00\u5b9a\u5c31\u662f\u4e00\u500b\u6a23\u672c\u6578\u64da\uff0c\u53ef\u80fd\u6703\u4e0d\u5b8c\u5168\u5c0d\u9f4a\uff0c\u6240\u4ee5\uff0c\u5373\u4f7f\u5c0d\u65bc\u6bcf\u6b21\u90fd\u662f\u589e\u52a0\u6574\u6578\u7684 Counter\uff0c\u4e5f\u53ef\u80fd\u8a08\u7b97\u7d50\u679c\u662f\u975e\u6574\u6578\u3002 \u53e6\u5916\u6211\u5011\u9700\u8981\u6ce8\u610f\u7576\u628a rate() \u8207\u4e00\u500b\u805a\u5408\u904b\u7b97\u7b26\uff08\u4f8b\u5982 sum() \uff09\u6216\u4e00\u500b\u96a8\u6642\u9593\u805a\u5408\u7684\u51fd\u6578\uff08\u4efb\u4f55\u4ee5 _over_time \u7d50\u5c3e\u7684\u51fd\u6578\uff09\u7d50\u5408\u8d77\u4f86\u4f7f\u7528\u6642\uff0c\u7e3d\u662f\u5148\u53d6\u7528 rate() \u51fd\u6578\uff0c\u7136\u5f8c\u518d\u9032\u884c\u805a\u5408\uff0c\u5426\u5247\uff0c\u7576\u4f60\u7684\u76ee\u6a19\u91cd\u65b0\u555f\u52d5\u6642\uff0c rate() \u51fd\u6578\u7121\u6cd5\u6aa2\u6e2c\u5230 Counter \u7684\u91cd\u7f6e\u3002 Info \u6ce8\u610f\uff1a rate() \u51fd\u6578\u9700\u8981\u5728\u6307\u5b9a\u7a97\u53e3\u4e0b\u81f3\u5c11\u6709\u5169\u500b\u6a23\u672c\u624d\u80fd\u8a08\u7b97\u8f38\u51fa\u3002\u4e00\u822c\u4f86\u8aaa\uff0c\u6bd4\u8f03\u597d\u7684\u505a\u6cd5\u662f\u9078\u64c7\u7bc4\u570d\u7a97\u53e3\u5927\u5c0f\u81f3\u5c11\u662f\u6293\u53d6\u9593\u9694\u7684 4 \u500d\uff0c\u9019\u6a23\u5373\u4f7f\u5728\u9047\u5230\u7a97\u53e3\u5c0d\u9f4a\u6216\u6293\u53d6\u6545\u969c\u6642\u4e5f\u6709\u53ef\u4ee5\u4f7f\u7528\u7684\u6a23\u672c\u9032\u884c\u8a08\u7b97\uff0c\u4f8b\u5982\uff0c\u5c0d\u65bc 1 \u5206\u9418\u7684\u6293\u53d6\u9593\u9694\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528 4 \u5206\u9418\u7684 Rate \u8a08\u7b97\uff0c\u4f46\u662f\u901a\u5e38\u5c07\u5176\u56db\u6368\u4e94\u5165\u70ba 5 \u5206\u9418\u3002\u6240\u4ee5\u5982\u679c\u4f7f\u7528 query_range \u5340\u9593\u67e5\u8a62\uff0c\u4f8b\u5982\u5728\u7e6a\u5716\u4e2d\uff0c\u90a3\u9ebc\u7bc4\u570d\u61c9\u8a72\u81f3\u5c11\u662f\u6b65\u9577\u7684\u5927\u5c0f\uff0c\u5426\u5247\u6703\u4e1f\u5931\u4e00\u4e9b\u6578\u64da\u3002","title":"rate() \u51fd\u6578"},{"location":"prometheus/promql/rates/#irate","text":"\u7531\u65bc\u4f7f\u7528 rate \u6216\u8005 increase \u51fd\u6578\u53bb\u8a08\u7b97\u6a23\u672c\u7684\u5e73\u5747\u589e\u9577\u901f\u7387\uff0c\u5bb9\u6613\u9677\u5165\u9577\u5c3e\u554f\u984c\u7576\u4e2d\uff0c\u5176\u7121\u6cd5\u53cd\u61c9\u5728\u6642\u9593\u7a97\u53e3\u5167\u6a23\u672c\u6578\u64da\u7684\u7a81\u767c\u8b8a\u5316\u3002 \u4f8b\u5982\uff0c\u5c0d\u65bc\u4e3b\u6a5f\u800c\u8a00\u5728 2 \u5206\u9418\u7684\u6642\u9593\u7a97\u53e3\u5167\uff0c\u53ef\u80fd\u5728\u67d0\u4e00\u500b\u7531\u65bc\u8a2a\u554f\u91cf\u6216\u8005\u5176\u5b83\u554f\u984c\u5c0e\u81f4 CPU \u4f54\u7528 100%\u7684\u60c5\u6cc1\uff0c\u4f46\u662f\u901a\u904e\u8a08\u7b97\u5728\u6642\u9593\u7a97\u53e3\u5167\u7684\u5e73\u5747\u589e\u9577\u7387\u537b\u7121\u6cd5\u53cd\u61c9\u51fa\u8a72\u554f\u984c\u3002 \u70ba\u4e86\u89e3\u6c7a\u8a72\u554f\u984c\uff0cPromQL \u63d0\u4f9b\u4e86\u53e6\u5916\u4e00\u500b\u9748\u654f\u5ea6\u66f4\u9ad8\u7684\u51fd\u6578 irate(v range-vector) \u3002 irate \u540c\u6a23\u7528\u65bc\u8a08\u7b97\u5340\u9593\u5411\u91cf\u7684\u8a08\u7b97\u7387\uff0c\u4f46\u662f\u5176\u53cd\u61c9\u51fa\u7684\u662f\u77ac\u6642\u589e\u9577\u7387\u3002 rate \u51fd\u6578\u662f\u901a\u904e\u5340\u9593\u5411\u91cf\u4e2d\u6700\u5f8c\u5169\u500b\u6a23\u672c\u6578\u64da\u4f86\u8a08\u7b97\u5340\u9593\u5411\u91cf\u7684\u589e\u9577\u901f\u7387\u3002\u9019\u7a2e\u65b9\u5f0f\u53ef\u4ee5\u907f\u514d\u5728\u6642\u9593\u7a97\u53e3\u7bc4\u570d\u5167\u7684\u9577\u5c3e\u554f\u984c\uff0c\u4e26\u4e14\u9ad4\u73fe\u51fa\u66f4\u597d\u7684\u9748\u654f\u5ea6\uff0c\u901a\u904e irate \u51fd\u6578\u7e6a\u88fd\u7684\u5716\u6a19\u80fd\u5920\u66f4\u597d\u7684\u53cd\u61c9\u6a23\u672c\u6578\u64da\u7684\u77ac\u6642\u8b8a\u5316\u72c0\u614b\u3002 \u90a3\u65e2\u7136\u662f\u4f7f\u7528\u6700\u5f8c\u5169\u500b\u9ede\u8a08\u7b97\uff0c\u90a3\u70ba\u4ec0\u9ebc\u9084\u8981\u6307\u5b9a\u985e\u4f3c\u65bc [1m] \u7684\u6642\u9593\u7bc4\u570d\u5462\uff1f\u9019\u500b [1m] \u4e0d\u662f\u7528\u4f86\u8a08\u7b97\u7684\uff0c irate \u5728\u8a08\u7b97\u7684\u6642\u5019\u6703\u6700\u591a\u5411\u524d\u5728 [1m] \u7bc4\u570d\u5167\u627e\u9ede\uff0c\u5982\u679c\u8d85\u904e [1m] \u6c92\u6709\u627e\u5230\u6578\u64da\u9ede\uff0c\u9019\u500b\u9ede\u7684\u8a08\u7b97\u5c31\u653e\u68c4\u4e86\u3002 \u7531\u65bc rate() \u63d0\u4f9b\u4e86\u66f4\u5e73\u6ed1\u7684\u7d50\u679c\uff0c\u56e0\u6b64\u5728\u9577\u671f\u8da8\u52e2\u5206\u6790\u6216\u8005\u544a\u8b66\u4e2d\u66f4\u63a8\u85a6\u4f7f\u7528 rate \u51fd\u6578\uff0c\u56e0\u70ba\u7576\u901f\u7387\u53ea\u51fa\u73fe\u4e00\u500b\u77ed\u66ab\u7684\u5cf0\u503c\u6642\uff0c\u4e0d\u61c9\u8a72\u89f8\u767c\u8a72\u5831\u8b66\u3002 \u4f7f\u7528 irate() \u51fd\u6578\u4e0a\u9762\u7684\u8868\u9054\u5f0f\u6703\u51fa\u73fe\u4e00\u4e9b\u77ed\u66ab\u4e0b\u964d\u7684\u5716\u5f62\uff1a \u9664\u4e86\u8a08\u7b97\u6bcf\u79d2\u901f\u7387\uff0c\u4f60\u9084\u53ef\u4ee5\u4f7f\u7528 increase() \u51fd\u6578\u67e5\u8a62\u6307\u5b9a\u6642\u9593\u7bc4\u570d\u5167\u7684\u7e3d\u589e\u91cf\uff0c\u5b83\u57fa\u672c\u4e0a\u76f8\u7576\u65bc\u901f\u7387\u4e58\u4ee5\u6642\u9593\u7bc4\u570d\u9078\u64c7\u5668\u4e2d\u7684\u79d2\u6578\uff1a increase ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 1h ] ) \u6bd4\u5982\u4e0a\u9762\u8868\u9054\u5f0f\u7684\u7d50\u679c\u548c\u4f7f\u7528 rate() \u51fd\u6578\u8a08\u7b97\u7684\u7d50\u679c\u6574\u9ad4\u5716\u5f62\u8da8\u52e2\u90fd\u662f\u4e00\u6a23\u7684\uff0c\u53ea\u662f Y \u8ef8\u7684\u6578\u64da\u4e0d\u4e00\u6a23\u800c\u5df2\uff0c\u4e00\u500b\u8868\u793a\u6578\u91cf\uff0c\u4e00\u500b\u8868\u793a\u767e\u5206\u6bd4\u3002 rate() \u3001 irate() \u548c increase() \u51fd\u6578\u53ea\u80fd\u8f38\u51fa\u975e\u8ca0\u503c\u7684\u7d50\u679c\uff0c\u5c0d\u65bc\u8ddf\u8e2a\u4e00\u500b\u53ef\u4ee5\u4e0a\u5347\u6216\u4e0b\u964d\u7684\u503c\u7684\u6307\u6a19\uff08\u5982\u6eab\u5ea6\u3001\u5167\u5b58\u6216\u78c1\u76e4\u7a7a\u9593\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 delta() \u548c deriv() \u51fd\u6578\u4f86\u4ee3\u66ff\u3002 deriv() \u51fd\u6578\u53ef\u4ee5\u8a08\u7b97\u4e00\u500b\u5340\u9593\u5411\u91cf\u4e2d\u5404\u500b\u6642\u9593\u5e8f\u5217\u4e8c\u968e\u5c0e\u6578\uff0c\u4f7f\u7528\u7c21\u55ae\u7dda\u6027\u56de\u6b78\uff0c deriv(v range-vector) \u7684\u53c3\u6578\u662f\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u8fd4\u56de\u4e00\u500b\u77ac\u6642\u5411\u91cf\uff0c\u9019\u500b\u51fd\u6578\u4e00\u822c\u53ea\u7528\u5728 Gauge \u985e\u578b\u7684\u6642\u9593\u5e8f\u5217\u4e0a\u3002\u4f8b\u5982\uff0c\u8981\u8a08\u7b97\u5728 15 \u5206\u9418\u7684\u7a97\u53e3\u4e0b\uff0c\u6bcf\u79d2\u9418\u78c1\u76e4\u4f7f\u7528\u91cf\u4e0a\u5347\u6216\u4e0b\u964d\u4e86\u591a\u5c11\uff1a \u9084\u6709\u53e6\u5916\u4e00\u500b predict_linear() \u51fd\u6578\u53ef\u4ee5\u9810\u6e2c\u4e00\u500b Gauge \u985e\u578b\u7684\u6307\u6a19\u5728\u672a\u4f86\u6307\u5b9a\u4e00\u6bb5\u6642\u9593\u5167\u7684\u503c\uff0c\u4f8b\u5982\u6211\u5011\u53ef\u4ee5\u6839\u64da\u904e\u53bb 15 \u5206\u9418\u7684\u8b8a\u5316\u60c5\u6cc1\uff0c\u4f86\u9810\u6e2c\u4e00\u500b\u5c0f\u6642\u5f8c\u7684\u78c1\u76e4\u4f7f\u7528\u91cf\u662f\u591a\u5c11\uff0c\u53ef\u4ee5\u7528\u5982\u4e0b\u6240\u793a\u7684\u8868\u9054\u5f0f\u4f86\u67e5\u8a62\uff1a predict_linear ( demo_disk_usage_bytes { job = \" demo \"}[ 15m ], 3600 ) \u9019\u500b\u51fd\u6578\u53ef\u4ee5\u7528\u65bc\u5831\u8b66\uff0c\u544a\u8a34\u6211\u5011\u78c1\u76e4\u662f\u5426\u6703\u5728\u5e7e\u500b\u5c0f\u6642\u5019\u5167\u7528\u5b8c\u3002","title":"irate() \u51fd\u6578"},{"location":"prometheus/promql/select-series/","text":"\u9078\u64c7\u6642\u9593\u5e8f\u5217 \u00b6 \u539f\u6587: \u9009\u62e9\u65f6\u95f4\u5e8f\u5217 \u672c\u7bc0\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u7528\u4e0d\u540c\u7684\u65b9\u5f0f\u4f86\u9078\u64c7\u6578\u64da\uff0c\u5982\u4f55\u5728\u55ae\u500b\u6642\u9593\u6233\u6216\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u57fa\u65bc\u6a19\u7c64\u904e\u6ffe\u6578\u64da\uff0c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u79fb\u52d5\u6642\u9593\u7684\u65b9\u5f0f\u4f86\u9078\u64c7\u6578\u64da\u3002 \u904e\u6ffe\u6307\u6a19\u540d\u7a31 \u00b6 \u6700\u7c21\u55ae\u7684 PromQL \u67e5\u8a62\u5c31\u662f\u76f4\u63a5\u9078\u64c7\u5177\u6709\u6307\u5b9a\u6307\u6a19\u540d\u7a31\u7684\u5e8f\u5217\uff0c\u4f8b\u5982\uff0c\u4ee5\u4e0b\u67e5\u8a62\u5c07\u8fd4\u56de\u6240\u6709\u5177\u6709\u6307\u6a19\u540d\u7a31 demo_api_request_duration_seconds_count \u7684\u5e8f\u5217\uff1a demo_api_request_duration_seconds_count \u8a72\u67e5\u8a62\u5c07\u8fd4\u56de\u8a31\u591a\u5177\u6709\u76f8\u540c\u6307\u6a19\u540d\u7a31\u7684\u5e8f\u5217\uff0c\u4f46\u6709\u4e0d\u540c\u7684\u6a19\u7c64\u7d44\u5408 instance\u3001job\u3001method\u3001path \u548c status \u7b49\u3002\u8f38\u51fa\u7d50\u679c\u5982\u4e0b\u6240\u793a\uff1a \u6839\u64da\u6a19\u7c64\u904e\u6ffe \u00b6 \u5982\u679c\u6211\u5011\u53ea\u67e5\u8a62 demo_api_request_duration_seconds_count \u4e2d\u5177\u6709 method=\"GET\" \u6a19\u7c64\u7684\u90a3\u4e9b\u6307\u6a19\u5e8f\u5217\uff0c\u5247\u53ef\u4ee5\u5728\u6307\u6a19\u540d\u7a31\u5f8c\u7528\u5927\u62ec\u865f\u52a0\u4e0a\u9019\u500b\u904e\u6ffe\u689d\u4ef6\uff1a demo_api_request_duration_seconds_count { method = \" GET \"} \u6b64\u5916\u6211\u5011\u9084\u53ef\u4ee5\u4f7f\u7528\u9017\u865f\u4f86\u7d44\u5408\u591a\u500b\u6a19\u7c64\u5339\u914d\u5668\uff1a demo_api_request_duration_seconds_count { instance = \" demo-service-0:10000 \", method = \" GET \", job = \" demo \"} \u4e0a\u9762\u5c07\u5f97\u5230 demo \u4efb\u52d9\u4e0b\u9762 demo-service-0:10000 \u9019\u500b\u5be6\u4f8b\u4e14 method=\"GET\" \u7684\u6307\u6a19\u5e8f\u5217\u6578\u64da\uff1a \u9700\u8981\u6ce8\u610f\u7684\u662f\u7d44\u5408\u4f7f\u7528\u591a\u500b\u5339\u914d\u689d\u4ef6\u7684\u6642\u5019\uff0c\u662f\u904e\u6ffe\u6240\u6709\u689d\u4ef6\u90fd\u6eff\u8db3\u7684\u6642\u9593\u5e8f\u5217\u3002 \u9664\u4e86\u76f8\u7b49\u5339\u914d\u4e4b\u5916\uff0cPrometheus \u9084\u652f\u6301\u5176\u4ed6\u5e7e\u7a2e\u5339\u914d\u5668\u985e\u578b\uff1a != \u4e0d\u7b49\u65bc =~ \u6b63\u5247\u8868\u9054\u5f0f\u5339\u914d !~ \u6b63\u5247\u8868\u9054\u5f0f\u4e0d\u5339\u914d \u751a\u81f3\u6211\u5011\u9084\u53ef\u4ee5\u5b8c\u5168\u7701\u7565\u6307\u6a19\u540d\u7a31\uff0c\u6bd4\u5982\u76f4\u63a5\u67e5\u8a62\u6240\u6709 path \u6a19\u7c64\u4ee5 /api \u958b\u982d\u7684\u6240\u6709\u5e8f\u5217\uff1a { path =~ \" /api.* \"} \u8a72\u67e5\u8a62\u6703\u5f97\u5230\u4e00\u4e9b\u5177\u6709\u4e0d\u540c\u6307\u6a19\u540d\u7a31\u7684\u5e8f\u5217\uff1a Tip \u6ce8\u610f\uff1a Prometheus \u4e2d\u7684\u6b63\u5247\u8868\u9054\u5f0f\u7e3d\u662f\u91dd\u5c0d\u5b8c\u6574\u7684\u5b57\u7b26\u4e32\u800c\u4e0d\u662f\u90e8\u5206\u5b57\u7b26\u4e32\u5339\u914d\u3002\u56e0\u6b64\uff0c\u5728\u5339\u914d\u4efb\u4f55\u4ee5 /api \u958b\u901a\u7684\u8def\u5f91\u6642\uff0c\u4e0d\u9700\u8981\u4ee5 ^ \u958b\u982d\uff0c\u4f46\u9700\u8981\u5728\u7d50\u5c3e\u8655\u6dfb\u52a0 .* \uff0c\u9019\u6a23\u53ef\u4ee5\u5339\u914d path=\"/api\" \u9019\u6a23\u7684\u5e8f\u5217\u3002 \u524d\u9762\u6211\u5011\u8aaa\u904e\u5728 Prometheus \u5167\u90e8\uff0c\u6307\u6a19\u540d\u7a31\u672c\u8cea\u4e0a\u662f\u4e00\u500b\u540d\u70ba __name__ \u7684\u7279\u6027\u6a19\u7c64\uff0c\u6240\u4ee5\u67e5\u8a62 demo_api_request_duration_seconds_count \u5be6\u969b\u4e0a\u548c\u4e0b\u9762\u7684\u67e5\u8a62\u65b9\u5f0f\u662f\u7b49\u6548\u7684\uff1a { __name__ = \" demo_api_request_duration_seconds_count \"} \u6309\u4e0a\u9762\u7684\u65b9\u6cd5\u7de8\u5beb\u7684\u9078\u64c7\u5668\uff0c\u53ef\u4ee5\u5f97\u5230\u4e00\u500b \u77ac\u6642\u5411\u91cf \uff0c\u5176\u4e2d\u5305\u542b\u6240\u6709\u9078\u5b9a\u5e8f\u5217\u7684\u55ae\u500b\u6700\u65b0\u503c\u3002\u4e8b\u5be6\u4e0a\u6709\u4e9b\u51fd\u6578\u8981\u6c42\u4f60\u4e0d\u662f\u50b3\u905e\u4e00\u500b\u55ae\u4e00\u7684\u503c\uff0c\u800c\u662f\u50b3\u905e\u4e00\u500b\u5e8f\u5217\u5728\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u7684\u503c\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u6211\u5011\u8aaa\u7684 \u5340\u9593\u5411\u91cf \u3002\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u901a\u904e\u9644\u52a0\u4e00\u500b [<\u6578\u5b57><\u55ae\u4f4d>] \u5f62\u5f0f\u7684\u6301\u7e8c\u6642\u9593\u6307\u5b9a\u7b26\uff0c\u5c07\"\u77ac\u6642\u5411\u91cf\u9078\u64c7\u5668\"\u6539\u8b8a\u70ba\"\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\"\uff08\u4f8b\u5982 [5m] \u8868\u793a 5 \u5206\u9418\uff09\u3002 \u6bd4\u5982\u8981\u67e5\u8a62\u6700\u8fd1 5 \u5206\u9418\u7684\u53ef\u7528\u5167\u5b58\uff0c\u53ef\u4ee5\u57f7\u884c\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a demo_memory_usage_bytes { type = \" free \"}[ 5m ] \u5c07\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8a62\u7d50\u679c\uff1a \u53ef\u4ee5\u4f7f\u7528\u7684\u6709\u6548\u7684\u6642\u9593\u55ae\u4f4d\u70ba\uff1a ms -\u6beb\u79d2 s -\u79d2 m - \u5206\u9418 h - \u5c0f\u6642 d - \u5929 y - \u5e74 \u6709\u6642\u6211\u5011\u9084\u9700\u8981\u4ee5 \u6642\u79fb (offset) \u7684\u65b9\u5f0f\u4f86\u8a2a\u554f\u904e\u53bb\u7684\u6578\u64da\uff0c\u901a\u5e38\u662f\u7528\u4f86\u8207\u7576\u524d\u6578\u64da\u9032\u884c\u6bd4\u8f03\u3002\u8981\u5c07\u904e\u53bb\u7684\u6578\u64da\u6642\u79fb\u5230\u7576\u524d\u4f4d\u7f6e\uff0c\u53ef\u4ee5\u4f7f\u7528 offset \u4fee\u98fe\u7b26\u6dfb\u52a0\u5230\u4efb\u4f55\u7bc4\u570d\u6216\u5373\u6642\u5e8f\u5217\u9078\u64c7\u5668\u9032\u884c\u67e5\u8a62\uff08\u4f8b\u5982 my_metric offset 5m \u6216 my_metric[1m] offset 7d \uff09\u3002 \u4f8b\u5982\uff0c\u8981\u9078\u64c7\u4e00\u500b\u5c0f\u6642\u524d\u7684\u53ef\u7528\u5167\u5b58\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a demo_memory_usage_bytes { type = \" free \"} offset 1h \u9019\u500b\u6642\u5019\u67e5\u8a62\u7684\u503c\u5247\u662f\u4e00\u500b\u5c0f\u6642\u4e4b\u524d\u7684\u6578\u64da\uff1a \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u9078\u64c7\u6240\u6709\u6642\u9593\u5e8f\u5217\u3002 { job != \"\"} \u6216\u8005\uff1a { __name__ =~ \" .+ \"} 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u67e5\u8a62\u6240\u6709\u6307\u6a19\u540d\u7a31\u70ba demo_api_request_duration_seconds_count \u4e26\u4e14 method \u6a19\u7c64\u4e0d\u70ba POST \u7684\u5e8f\u5217\u3002 demo_api_request_duration_seconds_count { method != \" POST \"} 3.\u4f7f\u7528 demo_memory_usage_bytes \u6307\u6a19\u67e5\u8a62\u4e00\u5c0f\u6642\u524d\u7684 1 \u5206\u9418\u6642\u9593\u7bc4\u570d\u7684\u7684\u53ef\u7528\u7a7a\u9592\u5167\u5b58\u3002 demo_memory_usage_bytes { type = \" free \"}[ 1m ] offset 1h","title":"\u9078\u64c7\u6642\u9593\u5e8f\u5217"},{"location":"prometheus/promql/select-series/#_1","text":"\u539f\u6587: \u9009\u62e9\u65f6\u95f4\u5e8f\u5217 \u672c\u7bc0\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u7528\u4e0d\u540c\u7684\u65b9\u5f0f\u4f86\u9078\u64c7\u6578\u64da\uff0c\u5982\u4f55\u5728\u55ae\u500b\u6642\u9593\u6233\u6216\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u57fa\u65bc\u6a19\u7c64\u904e\u6ffe\u6578\u64da\uff0c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u79fb\u52d5\u6642\u9593\u7684\u65b9\u5f0f\u4f86\u9078\u64c7\u6578\u64da\u3002","title":"\u9078\u64c7\u6642\u9593\u5e8f\u5217"},{"location":"prometheus/promql/select-series/#_2","text":"\u6700\u7c21\u55ae\u7684 PromQL \u67e5\u8a62\u5c31\u662f\u76f4\u63a5\u9078\u64c7\u5177\u6709\u6307\u5b9a\u6307\u6a19\u540d\u7a31\u7684\u5e8f\u5217\uff0c\u4f8b\u5982\uff0c\u4ee5\u4e0b\u67e5\u8a62\u5c07\u8fd4\u56de\u6240\u6709\u5177\u6709\u6307\u6a19\u540d\u7a31 demo_api_request_duration_seconds_count \u7684\u5e8f\u5217\uff1a demo_api_request_duration_seconds_count \u8a72\u67e5\u8a62\u5c07\u8fd4\u56de\u8a31\u591a\u5177\u6709\u76f8\u540c\u6307\u6a19\u540d\u7a31\u7684\u5e8f\u5217\uff0c\u4f46\u6709\u4e0d\u540c\u7684\u6a19\u7c64\u7d44\u5408 instance\u3001job\u3001method\u3001path \u548c status \u7b49\u3002\u8f38\u51fa\u7d50\u679c\u5982\u4e0b\u6240\u793a\uff1a","title":"\u904e\u6ffe\u6307\u6a19\u540d\u7a31"},{"location":"prometheus/promql/select-series/#_3","text":"\u5982\u679c\u6211\u5011\u53ea\u67e5\u8a62 demo_api_request_duration_seconds_count \u4e2d\u5177\u6709 method=\"GET\" \u6a19\u7c64\u7684\u90a3\u4e9b\u6307\u6a19\u5e8f\u5217\uff0c\u5247\u53ef\u4ee5\u5728\u6307\u6a19\u540d\u7a31\u5f8c\u7528\u5927\u62ec\u865f\u52a0\u4e0a\u9019\u500b\u904e\u6ffe\u689d\u4ef6\uff1a demo_api_request_duration_seconds_count { method = \" GET \"} \u6b64\u5916\u6211\u5011\u9084\u53ef\u4ee5\u4f7f\u7528\u9017\u865f\u4f86\u7d44\u5408\u591a\u500b\u6a19\u7c64\u5339\u914d\u5668\uff1a demo_api_request_duration_seconds_count { instance = \" demo-service-0:10000 \", method = \" GET \", job = \" demo \"} \u4e0a\u9762\u5c07\u5f97\u5230 demo \u4efb\u52d9\u4e0b\u9762 demo-service-0:10000 \u9019\u500b\u5be6\u4f8b\u4e14 method=\"GET\" \u7684\u6307\u6a19\u5e8f\u5217\u6578\u64da\uff1a \u9700\u8981\u6ce8\u610f\u7684\u662f\u7d44\u5408\u4f7f\u7528\u591a\u500b\u5339\u914d\u689d\u4ef6\u7684\u6642\u5019\uff0c\u662f\u904e\u6ffe\u6240\u6709\u689d\u4ef6\u90fd\u6eff\u8db3\u7684\u6642\u9593\u5e8f\u5217\u3002 \u9664\u4e86\u76f8\u7b49\u5339\u914d\u4e4b\u5916\uff0cPrometheus \u9084\u652f\u6301\u5176\u4ed6\u5e7e\u7a2e\u5339\u914d\u5668\u985e\u578b\uff1a != \u4e0d\u7b49\u65bc =~ \u6b63\u5247\u8868\u9054\u5f0f\u5339\u914d !~ \u6b63\u5247\u8868\u9054\u5f0f\u4e0d\u5339\u914d \u751a\u81f3\u6211\u5011\u9084\u53ef\u4ee5\u5b8c\u5168\u7701\u7565\u6307\u6a19\u540d\u7a31\uff0c\u6bd4\u5982\u76f4\u63a5\u67e5\u8a62\u6240\u6709 path \u6a19\u7c64\u4ee5 /api \u958b\u982d\u7684\u6240\u6709\u5e8f\u5217\uff1a { path =~ \" /api.* \"} \u8a72\u67e5\u8a62\u6703\u5f97\u5230\u4e00\u4e9b\u5177\u6709\u4e0d\u540c\u6307\u6a19\u540d\u7a31\u7684\u5e8f\u5217\uff1a Tip \u6ce8\u610f\uff1a Prometheus \u4e2d\u7684\u6b63\u5247\u8868\u9054\u5f0f\u7e3d\u662f\u91dd\u5c0d\u5b8c\u6574\u7684\u5b57\u7b26\u4e32\u800c\u4e0d\u662f\u90e8\u5206\u5b57\u7b26\u4e32\u5339\u914d\u3002\u56e0\u6b64\uff0c\u5728\u5339\u914d\u4efb\u4f55\u4ee5 /api \u958b\u901a\u7684\u8def\u5f91\u6642\uff0c\u4e0d\u9700\u8981\u4ee5 ^ \u958b\u982d\uff0c\u4f46\u9700\u8981\u5728\u7d50\u5c3e\u8655\u6dfb\u52a0 .* \uff0c\u9019\u6a23\u53ef\u4ee5\u5339\u914d path=\"/api\" \u9019\u6a23\u7684\u5e8f\u5217\u3002 \u524d\u9762\u6211\u5011\u8aaa\u904e\u5728 Prometheus \u5167\u90e8\uff0c\u6307\u6a19\u540d\u7a31\u672c\u8cea\u4e0a\u662f\u4e00\u500b\u540d\u70ba __name__ \u7684\u7279\u6027\u6a19\u7c64\uff0c\u6240\u4ee5\u67e5\u8a62 demo_api_request_duration_seconds_count \u5be6\u969b\u4e0a\u548c\u4e0b\u9762\u7684\u67e5\u8a62\u65b9\u5f0f\u662f\u7b49\u6548\u7684\uff1a { __name__ = \" demo_api_request_duration_seconds_count \"} \u6309\u4e0a\u9762\u7684\u65b9\u6cd5\u7de8\u5beb\u7684\u9078\u64c7\u5668\uff0c\u53ef\u4ee5\u5f97\u5230\u4e00\u500b \u77ac\u6642\u5411\u91cf \uff0c\u5176\u4e2d\u5305\u542b\u6240\u6709\u9078\u5b9a\u5e8f\u5217\u7684\u55ae\u500b\u6700\u65b0\u503c\u3002\u4e8b\u5be6\u4e0a\u6709\u4e9b\u51fd\u6578\u8981\u6c42\u4f60\u4e0d\u662f\u50b3\u905e\u4e00\u500b\u55ae\u4e00\u7684\u503c\uff0c\u800c\u662f\u50b3\u905e\u4e00\u500b\u5e8f\u5217\u5728\u4e00\u6bb5\u6642\u9593\u7bc4\u570d\u5167\u7684\u503c\uff0c\u4e5f\u5c31\u662f\u524d\u9762\u6211\u5011\u8aaa\u7684 \u5340\u9593\u5411\u91cf \u3002\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u901a\u904e\u9644\u52a0\u4e00\u500b [<\u6578\u5b57><\u55ae\u4f4d>] \u5f62\u5f0f\u7684\u6301\u7e8c\u6642\u9593\u6307\u5b9a\u7b26\uff0c\u5c07\"\u77ac\u6642\u5411\u91cf\u9078\u64c7\u5668\"\u6539\u8b8a\u70ba\"\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\"\uff08\u4f8b\u5982 [5m] \u8868\u793a 5 \u5206\u9418\uff09\u3002 \u6bd4\u5982\u8981\u67e5\u8a62\u6700\u8fd1 5 \u5206\u9418\u7684\u53ef\u7528\u5167\u5b58\uff0c\u53ef\u4ee5\u57f7\u884c\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a demo_memory_usage_bytes { type = \" free \"}[ 5m ] \u5c07\u5f97\u5230\u5982\u4e0b\u6240\u793a\u7684\u67e5\u8a62\u7d50\u679c\uff1a \u53ef\u4ee5\u4f7f\u7528\u7684\u6709\u6548\u7684\u6642\u9593\u55ae\u4f4d\u70ba\uff1a ms -\u6beb\u79d2 s -\u79d2 m - \u5206\u9418 h - \u5c0f\u6642 d - \u5929 y - \u5e74 \u6709\u6642\u6211\u5011\u9084\u9700\u8981\u4ee5 \u6642\u79fb (offset) \u7684\u65b9\u5f0f\u4f86\u8a2a\u554f\u904e\u53bb\u7684\u6578\u64da\uff0c\u901a\u5e38\u662f\u7528\u4f86\u8207\u7576\u524d\u6578\u64da\u9032\u884c\u6bd4\u8f03\u3002\u8981\u5c07\u904e\u53bb\u7684\u6578\u64da\u6642\u79fb\u5230\u7576\u524d\u4f4d\u7f6e\uff0c\u53ef\u4ee5\u4f7f\u7528 offset \u4fee\u98fe\u7b26\u6dfb\u52a0\u5230\u4efb\u4f55\u7bc4\u570d\u6216\u5373\u6642\u5e8f\u5217\u9078\u64c7\u5668\u9032\u884c\u67e5\u8a62\uff08\u4f8b\u5982 my_metric offset 5m \u6216 my_metric[1m] offset 7d \uff09\u3002 \u4f8b\u5982\uff0c\u8981\u9078\u64c7\u4e00\u500b\u5c0f\u6642\u524d\u7684\u53ef\u7528\u5167\u5b58\uff0c\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a demo_memory_usage_bytes { type = \" free \"} offset 1h \u9019\u500b\u6642\u5019\u67e5\u8a62\u7684\u503c\u5247\u662f\u4e00\u500b\u5c0f\u6642\u4e4b\u524d\u7684\u6578\u64da\uff1a \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u9078\u64c7\u6240\u6709\u6642\u9593\u5e8f\u5217\u3002 { job != \"\"} \u6216\u8005\uff1a { __name__ =~ \" .+ \"} 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u67e5\u8a62\u6240\u6709\u6307\u6a19\u540d\u7a31\u70ba demo_api_request_duration_seconds_count \u4e26\u4e14 method \u6a19\u7c64\u4e0d\u70ba POST \u7684\u5e8f\u5217\u3002 demo_api_request_duration_seconds_count { method != \" POST \"} 3.\u4f7f\u7528 demo_memory_usage_bytes \u6307\u6a19\u67e5\u8a62\u4e00\u5c0f\u6642\u524d\u7684 1 \u5206\u9418\u6642\u9593\u7bc4\u570d\u7684\u7684\u53ef\u7528\u7a7a\u9592\u5167\u5b58\u3002 demo_memory_usage_bytes { type = \" free \"}[ 1m ] offset 1h","title":"\u6839\u64da\u6a19\u7c64\u904e\u6ffe"},{"location":"prometheus/promql/set/","text":"\u96c6\u5408\u64cd\u4f5c \u00b6 \u539f\u6587: \u96c6\u5408\u64cd\u4f5c \u6709\u7684\u6642\u5019\u6211\u5011\u9700\u8981\u904e\u6ffe\u6216\u5c07\u4e00\u7d44\u6642\u9593\u5e8f\u5217\u8207\u53e6\u4e00\u7d44\u6642\u9593\u5e8f\u5217\u9032\u884c\u5408\u4f75\uff0cPrometheus \u63d0\u4f9b\u4e86 3 \u500b\u5728\u77ac\u6642\u5411\u91cf\u4e4b\u9593\u64cd\u4f5c\u7684\u96c6\u5408\u904b\u7b97\u7b26\u3002 and\uff08\u96c6\u5408\u4ea4\u96c6\uff09 \uff1a\u6bd4\u5982\u5c0d\u8f03\u9ad8\u932f\u8aa4\u7387\u89f8\u767c\u5831\u8b66\uff0c\u4f46\u662f\u53ea\u6709\u7576\u5c0d\u61c9\u7684\u7e3d\u932f\u8aa4\u7387\u8d85\u904e\u67d0\u500b\u95be\u503c\u7684\u6642\u5019\u624d\u6703\u89f8\u767c\u5831\u8b66 or\uff08\u96c6\u5408\u4f75\u96c6\uff09 \uff1a\u5c0d\u5e8f\u5217\u9032\u884c\u4e26\u96c6\u8a08\u7b97 unless\uff08\u9664\u975e\uff09 \uff1a\u6bd4\u5982\u8981\u5c0d\u78c1\u76e4\u7a7a\u9593\u4e0d\u8db3\u9032\u884c\u544a\u8b66\uff0c\u9664\u975e\u5b83\u662f\u552f\u8b80\u7684\u6587\u4ef6\u7cfb\u7d71\u3002 \u8207\u7b97\u8853\u548c\u904e\u6ffe\u4e8c\u5143\u904b\u7b97\u7b26\u985e\u4f3c\uff0c\u9019\u4e9b\u96c6\u5408\u904b\u7b97\u7b26\u6703\u5617\u8a66\u6839\u64da\u76f8\u540c\u7684\u6a19\u7c64\u96c6\u5728\u5de6\u5074\u548c\u53f3\u5074\u4e4b\u9593\u67e5\u627e\u4f86\u5339\u914d\u5e8f\u5217\uff0c\u9664\u975e\u4f60\u63d0\u4f9b on() \u6216 ignoring() \u4fee\u98fe\u7b26\u4f86\u6307\u5b9a\u61c9\u8a72\u5982\u4f55\u627e\u5230\u5339\u914d\u3002 Info \u6ce8\u610f\uff1a\u8207\u7b97\u8853\u548c\u904e\u6ffe\u4e8c\u9032\u5236\u904b\u7b97\u7b26\u76f8\u6bd4\uff0c\u96c6\u5408\u904b\u7b97\u7b26\u6c92\u6709 group_left() \u6216 group_right() \u4fee\u98fe\u7b26\uff0c\u56e0\u70ba\u96c6\u5408\u904b\u7b97\u7b26\u7e3d\u662f\u9032\u884c\u591a\u5c0d\u591a\u7684\u5339\u914d\uff0c\u4e5f\u5c31\u662f\u8aaa\uff0c\u5b83\u5011\u7e3d\u662f\u5141\u8a31\u4efb\u4f55\u4e00\u908a\u7684\u5339\u914d\u5e8f\u5217\u8207\u53e6\u4e00\u908a\u7684\u591a\u500b\u5e8f\u5217\u76f8\u5339\u914d\u3002 \u5c0d\u65bc and \u904b\u7b97\u7b26\uff0c\u5982\u679c\u627e\u5230\u4e00\u500b\u5339\u914d\u7684\uff0c\u5de6\u908a\u7684\u5e8f\u5217\u5c31\u6703\u6210\u70ba\u8f38\u51fa\u7d50\u679c\u7684\u4e00\u90e8\u5206\uff0c\u5982\u679c\u53f3\u908a\u6c92\u6709\u5339\u914d\u7684\u5e8f\u5217\uff0c\u5247\u4e0d\u6703\u8f38\u51fa\u4efb\u4f55\u7d50\u679c\u3002 \u4f8b\u5982\u6211\u5011\u60f3\u7be9\u9078\u51fa\u7b2c 90 \u500b\u767e\u5206\u4f4d\u5ef6\u9072\u9ad8\u65bc 50ms \u7684\u6240\u6709 HTTP \u7aef\u9ede\uff0c\u4f46\u53ea\u91dd\u5c0d\u6bcf\u79d2\u6536\u5230\u591a\u500b\u8acb\u6c42\u7684\u7dad\u5ea6\u7d44\u5408\uff0c\u67e5\u8a62\u65b9\u5f0f\u5982\u4e0b\u6240\u793a\uff1a histogram_quantile ( 0.9 , rate ( demo_api_request_duration_seconds_bucket { job = \" demo \"}[ 5m ] )) > 0.05 and rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) > 1 \u6709\u7684\u6642\u5019\u6211\u5011\u4e5f\u9700\u8981\u5c0d\u5169\u7d44\u6642\u9593\u5e8f\u5217\u9032\u884c\u5408\u4f75\u64cd\u4f5c\uff0c\u800c\u4e0d\u662f\u4ea4\u96c6\uff0c\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 or \u96c6\u5408\u904b\u7b97\u7b26\uff0c\u7522\u751f\u7684\u7d50\u679c\u662f\u904b\u7b97\u7b26\u5de6\u5074\u7684\u5e8f\u5217\uff0c\u52a0\u4e0a\u4f86\u81ea\u53f3\u5074\u4f46\u5de6\u5074\u6c92\u6709\u5339\u914d\u6a19\u7c64\u96c6\u7684\u6642\u9593\u5e8f\u5217\u3002\u6bd4\u5982\u6211\u5011\u8981\u5217\u51fa\u6240\u6709\u4f4e\u65bc 10 \u6216\u8005\u9ad8\u65bc 30 \u7684\u8acb\u6c42\u7387\uff0c\u5247\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4f86\u67e5\u8a62\uff1a rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) < 10 or rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) > 30 \u6211\u5011\u53ef\u4ee5\u770b\u5230\u5728\u5716\u4e2d\u4f7f\u7528\u503c\u904e\u6ffe\u5668\u548c\u96c6\u5408\u64cd\u4f5c\u6703\u5c0e\u81f4\u6642\u9593\u5e8f\u5217\u5728\u5716\u4e2d\u6709\u65b7\u9ede\u73fe\u8c61\uff0c\u9019\u53d6\u6c7a\u65bc\u4ed6\u5011\u5728\u5716\u4e2d\u7684\u6642\u9593\u9593\u9694\u4e0b\u662f\u5426\u80fd\u5920\u8207\u904e\u6ffe\u5668\u9032\u884c\u5339\u914d\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u5efa\u8b70\u53ea\u5728\u544a\u8b66\u898f\u5247\u4e2d\u4f7f\u7528\u9019\u7a2e\u904e\u6ffe\u64cd\u4f5c\u3002 \u9084\u6709\u4e00\u500b unless \u64cd\u4f5c\u7b26\uff0c\u5b83\u53ea\u6703\u4fdd\u7559\u5de6\u908a\u7684\u6642\u9593\u5e8f\u5217\uff0c\u5982\u679c\u53f3\u908a\u4e0d\u5b58\u5728\u76f8\u7b49\u7684\u6a19\u7c64\u96c6\u5408\u7684\u8a71\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u986f\u793a\u6309 path \u3001 method \u3001 status \uff085 \u5206\u9418\u5167\u5e73\u5747\uff09\u5283\u5206\u7684 demo API \u8acb\u6c42\u7684\u7b2c 95 \u500b\u767e\u5206\u4f4d\u5ef6\u9072\uff0c\u9664\u975e\u9019\u500b\u7dad\u5ea6\u7d44\u5408\u6bcf\u79d2\u6536\u5230\u7684\u8acb\u6c42\u5c11\u65bc 1 \u500b\u8acb\u6c42\uff085 \u5206\u9418\u5167\u5e73\u5747\uff09\u3002 histogram_quantile ( 0.95 , sum by ( path , method , status , le ) ( rate ( demo_api_request_duration_seconds_bucket [ 5m ] ))) unless sum by ( path , method , status ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) < 1","title":"\u96c6\u5408\u64cd\u4f5c"},{"location":"prometheus/promql/set/#_1","text":"\u539f\u6587: \u96c6\u5408\u64cd\u4f5c \u6709\u7684\u6642\u5019\u6211\u5011\u9700\u8981\u904e\u6ffe\u6216\u5c07\u4e00\u7d44\u6642\u9593\u5e8f\u5217\u8207\u53e6\u4e00\u7d44\u6642\u9593\u5e8f\u5217\u9032\u884c\u5408\u4f75\uff0cPrometheus \u63d0\u4f9b\u4e86 3 \u500b\u5728\u77ac\u6642\u5411\u91cf\u4e4b\u9593\u64cd\u4f5c\u7684\u96c6\u5408\u904b\u7b97\u7b26\u3002 and\uff08\u96c6\u5408\u4ea4\u96c6\uff09 \uff1a\u6bd4\u5982\u5c0d\u8f03\u9ad8\u932f\u8aa4\u7387\u89f8\u767c\u5831\u8b66\uff0c\u4f46\u662f\u53ea\u6709\u7576\u5c0d\u61c9\u7684\u7e3d\u932f\u8aa4\u7387\u8d85\u904e\u67d0\u500b\u95be\u503c\u7684\u6642\u5019\u624d\u6703\u89f8\u767c\u5831\u8b66 or\uff08\u96c6\u5408\u4f75\u96c6\uff09 \uff1a\u5c0d\u5e8f\u5217\u9032\u884c\u4e26\u96c6\u8a08\u7b97 unless\uff08\u9664\u975e\uff09 \uff1a\u6bd4\u5982\u8981\u5c0d\u78c1\u76e4\u7a7a\u9593\u4e0d\u8db3\u9032\u884c\u544a\u8b66\uff0c\u9664\u975e\u5b83\u662f\u552f\u8b80\u7684\u6587\u4ef6\u7cfb\u7d71\u3002 \u8207\u7b97\u8853\u548c\u904e\u6ffe\u4e8c\u5143\u904b\u7b97\u7b26\u985e\u4f3c\uff0c\u9019\u4e9b\u96c6\u5408\u904b\u7b97\u7b26\u6703\u5617\u8a66\u6839\u64da\u76f8\u540c\u7684\u6a19\u7c64\u96c6\u5728\u5de6\u5074\u548c\u53f3\u5074\u4e4b\u9593\u67e5\u627e\u4f86\u5339\u914d\u5e8f\u5217\uff0c\u9664\u975e\u4f60\u63d0\u4f9b on() \u6216 ignoring() \u4fee\u98fe\u7b26\u4f86\u6307\u5b9a\u61c9\u8a72\u5982\u4f55\u627e\u5230\u5339\u914d\u3002 Info \u6ce8\u610f\uff1a\u8207\u7b97\u8853\u548c\u904e\u6ffe\u4e8c\u9032\u5236\u904b\u7b97\u7b26\u76f8\u6bd4\uff0c\u96c6\u5408\u904b\u7b97\u7b26\u6c92\u6709 group_left() \u6216 group_right() \u4fee\u98fe\u7b26\uff0c\u56e0\u70ba\u96c6\u5408\u904b\u7b97\u7b26\u7e3d\u662f\u9032\u884c\u591a\u5c0d\u591a\u7684\u5339\u914d\uff0c\u4e5f\u5c31\u662f\u8aaa\uff0c\u5b83\u5011\u7e3d\u662f\u5141\u8a31\u4efb\u4f55\u4e00\u908a\u7684\u5339\u914d\u5e8f\u5217\u8207\u53e6\u4e00\u908a\u7684\u591a\u500b\u5e8f\u5217\u76f8\u5339\u914d\u3002 \u5c0d\u65bc and \u904b\u7b97\u7b26\uff0c\u5982\u679c\u627e\u5230\u4e00\u500b\u5339\u914d\u7684\uff0c\u5de6\u908a\u7684\u5e8f\u5217\u5c31\u6703\u6210\u70ba\u8f38\u51fa\u7d50\u679c\u7684\u4e00\u90e8\u5206\uff0c\u5982\u679c\u53f3\u908a\u6c92\u6709\u5339\u914d\u7684\u5e8f\u5217\uff0c\u5247\u4e0d\u6703\u8f38\u51fa\u4efb\u4f55\u7d50\u679c\u3002 \u4f8b\u5982\u6211\u5011\u60f3\u7be9\u9078\u51fa\u7b2c 90 \u500b\u767e\u5206\u4f4d\u5ef6\u9072\u9ad8\u65bc 50ms \u7684\u6240\u6709 HTTP \u7aef\u9ede\uff0c\u4f46\u53ea\u91dd\u5c0d\u6bcf\u79d2\u6536\u5230\u591a\u500b\u8acb\u6c42\u7684\u7dad\u5ea6\u7d44\u5408\uff0c\u67e5\u8a62\u65b9\u5f0f\u5982\u4e0b\u6240\u793a\uff1a histogram_quantile ( 0.9 , rate ( demo_api_request_duration_seconds_bucket { job = \" demo \"}[ 5m ] )) > 0.05 and rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) > 1 \u6709\u7684\u6642\u5019\u6211\u5011\u4e5f\u9700\u8981\u5c0d\u5169\u7d44\u6642\u9593\u5e8f\u5217\u9032\u884c\u5408\u4f75\u64cd\u4f5c\uff0c\u800c\u4e0d\u662f\u4ea4\u96c6\uff0c\u9019\u500b\u6642\u5019\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 or \u96c6\u5408\u904b\u7b97\u7b26\uff0c\u7522\u751f\u7684\u7d50\u679c\u662f\u904b\u7b97\u7b26\u5de6\u5074\u7684\u5e8f\u5217\uff0c\u52a0\u4e0a\u4f86\u81ea\u53f3\u5074\u4f46\u5de6\u5074\u6c92\u6709\u5339\u914d\u6a19\u7c64\u96c6\u7684\u6642\u9593\u5e8f\u5217\u3002\u6bd4\u5982\u6211\u5011\u8981\u5217\u51fa\u6240\u6709\u4f4e\u65bc 10 \u6216\u8005\u9ad8\u65bc 30 \u7684\u8acb\u6c42\u7387\uff0c\u5247\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8868\u9054\u5f0f\u4f86\u67e5\u8a62\uff1a rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) < 10 or rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) > 30 \u6211\u5011\u53ef\u4ee5\u770b\u5230\u5728\u5716\u4e2d\u4f7f\u7528\u503c\u904e\u6ffe\u5668\u548c\u96c6\u5408\u64cd\u4f5c\u6703\u5c0e\u81f4\u6642\u9593\u5e8f\u5217\u5728\u5716\u4e2d\u6709\u65b7\u9ede\u73fe\u8c61\uff0c\u9019\u53d6\u6c7a\u65bc\u4ed6\u5011\u5728\u5716\u4e2d\u7684\u6642\u9593\u9593\u9694\u4e0b\u662f\u5426\u80fd\u5920\u8207\u904e\u6ffe\u5668\u9032\u884c\u5339\u914d\uff0c\u6240\u4ee5\u4e00\u822c\u60c5\u6cc1\u4e0b\uff0c\u6211\u5011\u5efa\u8b70\u53ea\u5728\u544a\u8b66\u898f\u5247\u4e2d\u4f7f\u7528\u9019\u7a2e\u904e\u6ffe\u64cd\u4f5c\u3002 \u9084\u6709\u4e00\u500b unless \u64cd\u4f5c\u7b26\uff0c\u5b83\u53ea\u6703\u4fdd\u7559\u5de6\u908a\u7684\u6642\u9593\u5e8f\u5217\uff0c\u5982\u679c\u53f3\u908a\u4e0d\u5b58\u5728\u76f8\u7b49\u7684\u6a19\u7c64\u96c6\u5408\u7684\u8a71\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u986f\u793a\u6309 path \u3001 method \u3001 status \uff085 \u5206\u9418\u5167\u5e73\u5747\uff09\u5283\u5206\u7684 demo API \u8acb\u6c42\u7684\u7b2c 95 \u500b\u767e\u5206\u4f4d\u5ef6\u9072\uff0c\u9664\u975e\u9019\u500b\u7dad\u5ea6\u7d44\u5408\u6bcf\u79d2\u6536\u5230\u7684\u8acb\u6c42\u5c11\u65bc 1 \u500b\u8acb\u6c42\uff085 \u5206\u9418\u5167\u5e73\u5747\uff09\u3002 histogram_quantile ( 0.95 , sum by ( path , method , status , le ) ( rate ( demo_api_request_duration_seconds_bucket [ 5m ] ))) unless sum by ( path , method , status ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] )) < 1","title":"\u96c6\u5408\u64cd\u4f5c"},{"location":"prometheus/promql/sort/","text":"\u6392\u5e8f \u00b6 \u539f\u6587: \u6392\u5e8f \u672c\u7bc0\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u5c0d\u67e5\u8a62\u7d50\u679c\u9032\u884c\u6392\u5e8f\uff0c\u6216\u8005\u53ea\u9078\u64c7\u4e00\u7d44\u5e8f\u5217\u4e2d\u6700\u5927\u6216\u6700\u5c0f\u7684\u503c\u3002 \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 sort() \uff08\u5347\u5e8f\uff09 \u6216\u8005 sort_desc() \uff08\u964d\u5e8f\uff09\u51fd\u6578\u4f86\u5be6\u73fe\u5c0d\u8f38\u51fa\u7d50\u679c\u9032\u884c\u6392\u5e8f\uff0c\u4f8b\u5982\uff0c\u8981\u986f\u793a\u6309\u503c\u6392\u5e8f\u7684\u6bcf\u500b\u8def\u5f91\u8acb\u6c42\u7387\uff0c\u5f9e\u6700\u9ad8\u5230\u6700\u4f4e\uff0c\u6211\u5011\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u9032\u884c\u67e5\u8a62\uff1a sort_desc ( sum by ( path ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ))) \u6709\u7684\u6642\u5019\u6211\u5011\u4e26\u4e0d\u662f\u5c0d\u6240\u6709\u7684\u6642\u9593\u5e8f\u5217\u611f\u8208\u8da3\uff0c\u53ea\u5c0d\u6700\u5927\u6216\u6700\u5c0f\u7684\u5e7e\u500b\u5e8f\u5217\u611f\u8208\u8da3\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 topk() \u548c bottomk() \u9019\u5169\u500b\u904b\u7b97\u7b26\u4f86\u64cd\u4f5c\uff0c\u53ef\u4ee5\u8fd4\u56de K \u500b\u6700\u5927\u6216\u6700\u5c0f\u7684\u5e8f\u5217\uff0c\u6bd4\u5982\u53ea\u986f\u793a\u6bcf\u500b path \u548c method \u7684\u524d\u4e09\u7684\u8acb\u6c42\u7387\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u4f86\u67e5\u8a62\u3002 topk ( 3 , sum by ( path , method ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ))) \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\u4ee5\u5347\u5e8f\u7684\u65b9\u5f0f\u986f\u793a\u6240\u6709 3 \u500b demo \u670d\u52d9\u7684\u78c1\u76e4\u4f7f\u7528\u60c5\u6cc1\u3002 sort ( demo_disk_usage_bytes ) 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u6309 method\u3001path \u548c status \u7dad\u5ea6\u986f\u793a 3 \u500b\u6700\u4f4e\u6d41\u91cf\u7684 demo API \u8acb\u6c42\u6bd4\u7387\u3002 bottomk ( 3 , sum by ( method , path , status ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] )))","title":"\u6392\u5e8f"},{"location":"prometheus/promql/sort/#_1","text":"\u539f\u6587: \u6392\u5e8f \u672c\u7bc0\u6211\u5011\u5c07\u5b78\u7fd2\u5982\u4f55\u5c0d\u67e5\u8a62\u7d50\u679c\u9032\u884c\u6392\u5e8f\uff0c\u6216\u8005\u53ea\u9078\u64c7\u4e00\u7d44\u5e8f\u5217\u4e2d\u6700\u5927\u6216\u6700\u5c0f\u7684\u503c\u3002 \u6211\u5011\u53ef\u4ee5\u4f7f\u7528 sort() \uff08\u5347\u5e8f\uff09 \u6216\u8005 sort_desc() \uff08\u964d\u5e8f\uff09\u51fd\u6578\u4f86\u5be6\u73fe\u5c0d\u8f38\u51fa\u7d50\u679c\u9032\u884c\u6392\u5e8f\uff0c\u4f8b\u5982\uff0c\u8981\u986f\u793a\u6309\u503c\u6392\u5e8f\u7684\u6bcf\u500b\u8def\u5f91\u8acb\u6c42\u7387\uff0c\u5f9e\u6700\u9ad8\u5230\u6700\u4f4e\uff0c\u6211\u5011\u53ef\u4ee5\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u9032\u884c\u67e5\u8a62\uff1a sort_desc ( sum by ( path ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ))) \u6709\u7684\u6642\u5019\u6211\u5011\u4e26\u4e0d\u662f\u5c0d\u6240\u6709\u7684\u6642\u9593\u5e8f\u5217\u611f\u8208\u8da3\uff0c\u53ea\u5c0d\u6700\u5927\u6216\u6700\u5c0f\u7684\u5e7e\u500b\u5e8f\u5217\u611f\u8208\u8da3\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528 topk() \u548c bottomk() \u9019\u5169\u500b\u904b\u7b97\u7b26\u4f86\u64cd\u4f5c\uff0c\u53ef\u4ee5\u8fd4\u56de K \u500b\u6700\u5927\u6216\u6700\u5c0f\u7684\u5e8f\u5217\uff0c\u6bd4\u5982\u53ea\u986f\u793a\u6bcf\u500b path \u548c method \u7684\u524d\u4e09\u7684\u8acb\u6c42\u7387\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4e0b\u9762\u7684\u8a9e\u53e5\u4f86\u67e5\u8a62\u3002 topk ( 3 , sum by ( path , method ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ))) \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\u4ee5\u5347\u5e8f\u7684\u65b9\u5f0f\u986f\u793a\u6240\u6709 3 \u500b demo \u670d\u52d9\u7684\u78c1\u76e4\u4f7f\u7528\u60c5\u6cc1\u3002 sort ( demo_disk_usage_bytes ) 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u6309 method\u3001path \u548c status \u7dad\u5ea6\u986f\u793a 3 \u500b\u6700\u4f4e\u6d41\u91cf\u7684 demo API \u8acb\u6c42\u6bd4\u7387\u3002 bottomk ( 3 , sum by ( method , path , status ) ( rate ( demo_api_request_duration_seconds_count [ 5m ] )))","title":"\u6392\u5e8f"},{"location":"prometheus/promql/theory/","text":"\u67e5\u8a62\u57fa\u790e \u00b6 \u539f\u6587: PromQL \u57fa\u7840 \u5728\u7e7c\u7e8c\u6df1\u5165\u5b78\u7fd2 PromQL \u67e5\u8a62\u7d30\u7bc0\u4e4b\u524d\uff0c\u6211\u5011\u5148\u4f86\u770b\u770b PromQL \u67e5\u8a62\u7684\u4e00\u4e9b\u7406\u8ad6\u57fa\u790e\u3002 \u5d4c\u5957\u7d50\u69cb \u00b6 \u8207 SQL \u67e5\u8a62\u8a9e\u8a00\uff08SELECT * FROM ...\uff09\u4e0d\u540c\uff0cPromQL \u662f\u4e00\u7a2e\u5d4c\u5957\u7684\u51fd\u6578\u5f0f\u8a9e\u8a00\uff0c\u5c31\u662f\u6211\u5011\u8981\u628a\u9700\u8981\u67e5\u627e\u7684\u6578\u64da\u63cf\u8ff0\u6210\u4e00\u7d44\u5d4c\u5957\u7684\u8868\u9054\u5f0f\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u90fd\u6703\u8a55\u4f30\u70ba\u4e00\u500b\u4e2d\u9593\u503c\uff0c\u6bcf\u500b\u4e2d\u9593\u503c\u90fd\u6703\u88ab\u7528\u4f5c\u5b83\u4e0a\u5c64\u8868\u9054\u5f0f\u4e2d\u7684\u53c3\u6578\uff0c\u800c\u67e5\u8a62\u7684\u6700\u5916\u5c64\u8868\u9054\u5f0f\u8868\u793a\u4f60\u53ef\u4ee5\u5728\u8868\u683c\u3001\u5716\u5f62\u4e2d\u770b\u5230\u7684\u6700\u7d42\u8fd4\u56de\u503c\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a histogram_quantile ( # \u67e5\u8a62\u7684\u6839\uff0c\u6700\u7d42\u7d50\u679c\u8868\u793a\u4e00\u500b\u8fd1\u4f3c\u5206\u4f4d\u6578\u3002 0.9 , # histogram_quantile() \u7684\u7b2c\u4e00\u500b\u53c3\u6578\uff0c\u5206\u4f4d\u6578\u7684\u76ee\u6a19\u503c # histogram_quantile() \u7684\u7b2c\u4e8c\u500b\u53c3\u6578\uff0c\u805a\u5408\u7684\u76f4\u65b9\u5716 sum by ( le , method , path ) ( # sum() \u7684\u53c3\u6578\uff0c\u76f4\u65b9\u5716\u904e\u53bb5\u5206\u9418\u6bcf\u79d2\u589e\u91cf\u3002 rate ( # rate() \u7684\u53c3\u6578\uff0c\u904e\u53bb5\u5206\u9418\u7684\u539f\u59cb\u76f4\u65b9\u5716\u5e8f\u5217 demo_api_request_duration_seconds_bucket { job = \" demo \"}[ 5m ] ) ) ) PromQL \u8868\u9054\u5f0f\u4e0d\u50c5\u50c5\u662f\u6574\u500b\u67e5\u8a62\uff0c\u800c\u662f\u67e5\u8a62\u7684\u4efb\u4f55\u5d4c\u5957\u90e8\u5206\uff08\u6bd4\u5982\u4e0a\u9762\u7684rate(...)\u90e8\u5206\uff09\uff0c\u4f60\u53ef\u4ee5\u628a\u5b83\u4f5c\u70ba\u4e00\u500b\u67e5\u8a62\u672c\u8eab\u4f86\u904b\u884c\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6bcf\u884c\u8a3b\u91cb\u4ee3\u8868\u4e00\u500b\u8868\u9054\u5f0f\u3002 \u7d50\u679c\u985e\u578b \u00b6 \u5728\u67e5\u8a62 Prometheus \u6642\uff0c\u6709\u5169\u500b \u985e\u578b \u7684\u6982\u5ff5\u7d93\u5e38\u51fa\u73fe\uff0c\u5340\u5206\u5b83\u5011\u5f88\u91cd\u8981\u3002 \u6293\u53d6\u76ee\u6a19\u5831\u544a\u7684 \u6307\u6a19\u985e\u578b \uff1acounter\u3001gauge\u3001histogram\u3001summary\u3002 PromQL \u8868\u9054\u5f0f\u7684 \u7d50\u679c\u6578\u64da\u985e\u578b \uff1a\u5b57\u7b26\u4e32\u3001\u6a19\u91cf\u3001\u77ac\u6642\u5411\u91cf\u6216\u5340\u9593\u5411\u91cf\u3002 PromQL \u5be6\u969b\u4e0a\u6c92\u6709\u76f4\u63a5\u7684\u6307\u6a19\u985e\u578b\u7684\u6982\u5ff5\uff0c\u53ea\u95dc\u6ce8\u8868\u9054\u5f0f\u7684 \u7d50\u679c\u985e\u578b \u3002\u6bcf\u500b PromQL \u8868\u9054\u5f0f\u90fd\u6709\u4e00\u500b\u985e\u578b\uff0c\u6bcf\u500b\u51fd\u6578\u3001\u904b\u7b97\u7b26\u6216\u5176\u4ed6\u985e\u578b\u7684\u64cd\u4f5c\u90fd\u8981\u6c42\u5176\u53c3\u6578\u662f\u67d0\u7a2e\u8868\u9054\u5f0f\u985e\u578b\u3002\u4f8b\u5982\uff0c rate() \u51fd\u6578\u8981\u6c42\u5b83\u7684\u53c3\u6578\u662f\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u4f46\u662f rate() \u672c\u8eab\u8a55\u4f30\u70ba\u4e00\u500b\u77ac\u6642\u5411\u91cf\u8f38\u51fa\uff0c\u6240\u4ee5 rate() \u7684\u7d50\u679c\u53ea\u80fd\u7528\u5728\u671f\u671b\u662f\u77ac\u6642\u5411\u91cf\u7684\u5730\u65b9\u3002 PromQL \u4e2d\u53ef\u80fd\u7684\u8868\u9054\u5f0f\u985e\u578b\u5305\u62ec\uff1a string(\u5b57\u7b26\u4e32) \uff1a\u5b57\u7b26\u4e32\u53ea\u6703\u4f5c\u70ba\u67d0\u4e9b\u51fd\u6578\uff08\u5982 label_join() \u548c label_replace() \uff09\u7684\u53c3\u6578\u51fa\u73fe\u3002 scalar(\u6a19\u91cf) \uff1a\u4e00\u500b\u55ae\u4e00\u7684\u6578\u5b57\u503c\uff0c\u5982 1.234\uff0c\u9019\u4e9b\u6578\u5b57\u53ef\u4ee5\u4f5c\u70ba\u67d0\u4e9b\u51fd\u6578\u7684\u53c3\u6578\uff0c\u5982 histogram_quantile(0.9, ...) \u6216 topk(3, ...) \uff0c\u4e5f\u6703\u51fa\u73fe\u5728\u7b97\u8853\u904b\u7b97\u4e2d\u3002 instant vector(\u77ac\u6642\u5411\u91cf) \uff1a\u4e00\u7d44\u6a19\u8a18\u7684\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u6709\u4e00\u500b\u6a23\u672c\uff0c\u90fd\u5728\u540c\u4e00\u500b\u6642\u9593\u6233\uff0c\u77ac\u6642\u5411\u91cf\u53ef\u4ee5\u7531 TSDB \u6642\u9593\u5e8f\u5217\u9078\u64c7\u5668\u76f4\u63a5\u7522\u751f\uff0c\u5982 node_cpu_seconds_total \uff0c\u4e5f\u53ef\u4ee5\u7531\u4efb\u4f55\u51fd\u6578\u6216\u5176\u4ed6\u8f49\u63db\u4f86\u7372\u53d6\u3002 node_cpu_seconds_total { cpu = \"0\" , mode = \"idle\" } \u2192 19165078 .75 @ timestamp_1 node_cpu_seconds_total { cpu = \"0\" , mode = \"system\" } \u2192 381598 .72 @ timestamp_1 node_cpu_seconds_total { cpu = \"0\" , mode = \"user\" } \u2192 23211630 .97 @ timestamp_1 - range vector(\u5340\u9593\u5411\u91cf) \uff1a\u4e00\u7d44\u6a19\u8a18\u7684\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u90fd\u6709\u4e00\u500b\u96a8\u6642\u9593\u8b8a\u5316\u7684\u6a23\u672c\u7bc4\u570d\u3002\u5728 PromQL \u4e2d\u53ea\u6709\u5169\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u751f\u6210\u5340\u9593\u5411\u91cf\uff1a\u5728\u67e5\u8a62\u4e2d\u4f7f\u7528\u5b57\u9762\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\uff08\u5982 node_cpu_seconds_total[5m] \uff09\uff0c\u6216\u4f7f\u7528\u5b50\u67e5\u8a62\u8868\u9054\u5f0f\uff08\u5982 <expression>[5m:10s] \uff09\uff0c\u7576\u60f3\u8981\u5728\u6307\u5b9a\u7684\u6642\u9593\u7a97\u53e3\u5167\u805a\u5408\u4e00\u500b\u5e8f\u5217\u7684\u884c\u70ba\u6642\uff0c\u5340\u9593\u5411\u91cf\u975e\u5e38\u6709\u7528\uff0c\u5c31\u50cf rate(node_cpu_seconds_total[5m]) \u8a08\u7b97\u6bcf\u79d2\u589e\u52a0\u7387\u4e00\u6a23\uff0c\u5728 node_cpu_seconds_total \u6307\u6a19\u7684\u6700\u5f8c 5 \u5206\u9418\u5167\u6c42\u5e73\u5747\u503c\u3002 node_cpu_seconds_total { cpu = \"0\" , mode = \"idle\" } \u2192 19165078 .75 @ timestamp_1, 19165136 .3 @ timestamp_2, 19165167 .72 @ timestamp_3 node_cpu_seconds_total { cpu = \"0\" , mode = \"system\" } \u2192 381598 .72 @ timestamp_1, 381599 .98 @ timestamp_2, 381600 .58 @ timestamp_3 node_cpu_seconds_total { cpu = \"0\" , mode = \"user\" } \u2192 23211630 .97 @ timestamp_1, 23211711 .34 @ timestamp_2, 23211748 .64 @ timestamp_3 \u67e5\u8a62\u985e\u578b\u548c\u8a55\u4f30\u6642\u9593 \u00b6 PromQL \u67e5\u8a62\u4e2d\u5c0d\u6642\u9593\u7684\u5f15\u7528\u53ea\u6709\u76f8\u5c0d\u5f15\u7528\uff0c\u6bd4\u5982 [5m] \uff0c\u8868\u793a\u904e\u53bb 5 \u5206\u9418\uff0c\u90a3\u9ebc\u5982\u4f55\u6307\u5b9a\u4e00\u500b\u7d55\u5c0d\u7684\u6642\u9593\u7bc4\u570d\uff0c\u6216\u5728\u4e00\u500b\u8868\u683c\u4e2d\u986f\u793a\u67e5\u8a62\u7d50\u679c\u7684\u6642\u9593\u6233\uff1f\u5728 PromQL \u4e2d\uff0c\u9019\u6a23\u7684\u6642\u9593\u53c3\u6578\u662f\u8207\u8868\u9054\u5f0f\u5206\u958b\u767c\u9001\u5230 Prometheus \u67e5\u8a62 API \u7684\uff0c\u78ba\u5207\u7684\u6642\u9593\u53c3\u6578\u53d6\u6c7a\u65bc\u4f60\u767c\u9001\u7684\u67e5\u8a62\u985e\u578b\uff0cPrometheus \u6709\u5169\u7a2e\u985e\u578b\u7684 PromQL \u67e5\u8a62\uff1a \u77ac\u6642\u67e5\u8a62 \u548c \u5340\u9593\u67e5\u8a62 \u3002 \u77ac\u6642\u67e5\u8a62 \u00b6 \u77ac\u6642\u67e5\u8a62\u7528\u65bc\u985e\u4f3c\u8868\u683c\u7684\u8996\u5716\uff0c\u4f60\u60f3\u5728\u4e00\u500b\u6642\u9593\u9ede\u4e0a\u986f\u793a PromQL \u67e5\u8a62\u7684\u7d50\u679c\u3002\u4e00\u500b\u77ac\u6642\u67e5\u8a62\u6709\u4ee5\u4e0b\u53c3\u6578\uff1a PromQL \u8868\u9054\u5f0f \u4e00\u500b\u8a55\u4f30\u7684\u6642\u9593\u6233 \u5728\u67e5\u8a62\u7684\u6642\u5019\u53ef\u4ee5\u9078\u64c7\u67e5\u8a62\u904e\u53bb\u7684\u6578\u64da\uff0c\u6bd4\u5982 foo[1h] \u8868\u793a\u67e5\u8a62 foo \u5e8f\u5217\u6700\u8fd1 1 \u500b\u5c0f\u6642\u7684\u6578\u64da\uff0c\u8a2a\u554f\u904e\u53bb\u7684\u6578\u64da\uff0c\u5c0d\u65bc\u8a08\u7b97\u4e00\u6bb5\u6642\u9593\u5167\u7684\u6bd4\u7387\u6216\u5e73\u5747\u6578\u7b49\u805a\u5408\u6703\u975e\u5e38\u6709\u7528\u3002 \u5728 Prometheus \u7684 WebUI \u754c\u9762\u4e2d\u8868\u683c\u8996\u5716\u4e2d\u7684\u67e5\u8a62\u5c31\u662f\u77ac\u6642\u67e5\u8a62\uff0cAPI \u63a5\u53e3 /api/v1/query?query=xxxx&time=xxxx \u4e2d\u7684 query \u53c3\u6578\u5c31\u662f PromQL \u8868\u9054\u5f0f\uff0c time \u53c3\u6578\u5c31\u662f\u8a55\u4f30\u7684\u6642\u9593\u6233\u3002\u77ac\u6642\u67e5\u8a62\u53ef\u4ee5\u8fd4\u56de\u4efb\u4f55\u6709\u6548\u7684 PromQL \u8868\u9054\u5f0f\u985e\u578b\uff08\u5b57\u7b26\u4e32\u3001\u6a19\u91cf\u3001\u5373\u6642\u548c\u7bc4\u570d\u5411\u91cf\uff09\u3002 \u4e0b\u9762\u4f86\u770b\u4e00\u500b\u77ac\u6642\u67e5\u8a62\u7684\u793a\u4f8b\uff0c\u770b\u770b\u5b83\u662f\u5982\u4f55\u9032\u884c\u8a55\u4f30\u5de5\u4f5c\u7684\u3002\u6bd4\u5982 http_requests_total \u5728\u6307\u5b9a\u7684\u6642\u9593\u6233\u4f86\u8a55\u4f30\u8868\u9054\u5f0f\uff0c http_requests_total \u662f\u4e00\u500b\u77ac\u6642\u5411\u91cf\u9078\u64c7\u5668\uff0c\u5b83\u53ef\u4ee5\u9078\u64c7\u8a72\u6642\u9593\u5e8f\u5217\u7684\u6700\u65b0\u6a23\u672c\uff0c\u6700\u65b0\u610f\u5473\u8457\u67e5\u8a62\u6700\u8fd1 5 \u5206\u9418\u7684\u6a23\u672c\u6578\u64da\u3002 \u5982\u679c\u6211\u5011\u5728\u4e00\u500b\u6709\u6700\u8fd1\u6a23\u672c\u7684\u6642\u9593\u6233\u4e0a\u904b\u884c\u6b64\u67e5\u8a62\uff0c\u7d50\u679c\u5c07\u5305\u542b\u5169\u500b\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u90fd\u6709\u4e00\u500b\u6a23\u672c\uff1a \u6ce8\u610f\u6bcf\u500b\u8fd4\u56de\u7684\u6a23\u672c\u8f38\u51fa\u6642\u9593\u6233\u4e0d\u518d\u662f\u539f\u59cb\u6a23\u672c\u88ab\u63a1\u96c6\u7684\u6642\u9593\u6233\uff0c\u800c\u6703\u88ab\u8a2d\u7f6e\u70ba\u8a55\u4f30\u7684\u6642\u9593\u6233\u3002 \u5982\u679c\u5728\u6642\u9593\u6233\u4e4b\u524d\u6709\u4e00\u500b >5m \u7684\u9593\u9699\uff0c\u9019\u500b\u6642\u5019\u5982\u679c\u6211\u5011\u57f7\u884c\u76f8\u540c\u7684\u67e5\u8a62\uff1a \u9019\u500b\u60c5\u6cc1\u4e0b\u67e5\u8a62\u7684\u7d50\u679c\u5c07\u8fd4\u56de\u70ba\u7a7a\uff0c\u56e0\u70ba\u5f88\u986f\u7136\u5728\u6700\u8fd1 5 \u5206\u9418\u5167\u6c92\u6709\u80fd\u5920\u5339\u914d\u7684\u6a23\u672c\u3002 \u5340\u9593\u67e5\u8a62 \u00b6 \u5340\u9593\u67e5\u8a62\u4e3b\u8981\u7528\u65bc\u5716\u5f62\uff0c\u60f3\u5728\u4e00\u500b\u6307\u5b9a\u7684\u6642\u9593\u7bc4\u570d\u5167\u986f\u793a\u4e00\u500b PromQL \u8868\u9054\u5f0f\uff0c\u7bc4\u570d\u67e5\u8a62\u7684\u5de5\u4f5c\u65b9\u5f0f\u8207\u5373\u6642\u67e5\u8a62\u5b8c\u5168\u76f8\u540c\uff0c\u9019\u4e9b\u67e5\u8a62\u5728 \u6307\u5b9a\u6642\u9593\u7bc4\u570d\u7684\u8a55\u4f30\u6b65\u9577 \u4e2d\u9032\u884c\u8a55\u4f30\u3002\u7576\u7136\uff0c\u9019\u5728\u5f8c\u53f0\u662f\u9ad8\u5ea6\u512a\u5316\u7684\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0cPrometheus \u5be6\u969b\u4e0a\u4e26\u6c92\u6709\u904b\u884c\u8a31\u591a\u7368\u7acb\u7684\u5373\u6642\u67e5\u8a62\u3002 \u5340\u9593\u67e5\u8a62\u5305\u62ec\u4ee5\u4e0b\u4e00\u4e9b\u53c3\u6578\uff1a PromQL \u8868\u9054\u5f0f \u958b\u59cb\u6642\u9593 \u7d50\u675f\u6642\u9593 \u8a55\u4f30\u6b65\u9577 \u5728\u958b\u59cb\u6642\u9593\u548c\u7d50\u675f\u6642\u9593\u4e4b\u9593\u7684\u6bcf\u500b\u8a55\u4f30\u6b65\u9577\u4e0a\u8a55\u4f30\u8868\u9054\u5f0f\u5f8c\uff0c\u55ae\u7368\u8a55\u4f30\u7684\u6642\u9593\u7247\u88ab\u62fc\u63a5\u5230\u4e00\u500b\u55ae\u4e00\u7684\u5340\u9593\u5411\u91cf\u4e2d\u3002\u5340\u9593\u67e5\u8a62\u5141\u8a31\u50b3\u5165\u77ac\u6642\u5411\u91cf\u985e\u578b\u6216\u6a19\u91cf\u985e\u578b\u7684\u8868\u9054\u5f0f\uff0c\u4f46\u59cb\u7d42\u8fd4\u56de\u4e00\u500b\u7bc4\u570d\u5411\u91cf\uff08\u6a19\u91cf\u6216\u77ac\u6642\u5411\u91cf\u5728\u4e00\u500b\u6642\u9593\u7bc4\u570d\u5167\u88ab\u8a55\u4f30\u7684\u7d50\u679c\uff09\u3002 \u5728 Prometheus \u7684 WebUI \u754c\u9762\u4e2d\u5716\u5f62\u8996\u5716\u4e2d\u7684\u67e5\u8a62\u5c31\u662f\u5340\u9593\u67e5\u8a62\uff0cAPI \u63a5\u53e3 /api/v1/query_range?query=xxx&start=xxxxxx&end=xxxx&step=14 \u4e2d\u7684 query \u53c3\u6578\u5c31\u662f PromQL \u8868\u9054\u5f0f\uff0c start \u70ba\u958b\u59cb\u6642\u9593\uff0c end \u70ba\u7d50\u675f\u6642\u9593\uff0c step \u70ba\u8a55\u4f30\u7684\u6b65\u9577\u3002 \u6bd4\u5982\u628a\u4e0a\u9762\u7684 http_requests_total \u8868\u9054\u5f0f\u4f5c\u70ba\u4e00\u500b\u7bc4\u570d\u67e5\u8a62\u4f86\u9032\u884c\u8a55\u4f30\uff0c\u5b83\u7684\u8a55\u4f30\u7d50\u679c\u5982\u4e0b\u6240\u793a\uff1a \u6ce8\u610f\u6bcf\u500b\u8a55\u4f30\u6b65\u9a5f\u7684\u884c\u70ba\u8207\u7368\u7acb\u7684\u77ac\u6642\u67e5\u8a62\u5b8c\u5168\u4e00\u6a23\uff0c\u800c\u4e14\u6bcf\u500b\u7368\u7acb\u7684\u77ac\u6642\u67e5\u8a62\u90fd\u6c92\u6709\u67e5\u8a62\u7684\u7e3d\u9ad4\u7bc4\u570d\u7684\u6982\u5ff5\uff0c\u5728\u6211\u5011\u9019\u500b\u793a\u4f8b\u4e2d\u6700\u7d42\u7684\u7d50\u679c\u5c07\u662f\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u5176\u4e2d\u5305\u542b\u5169\u500b\u9078\u5b9a\u5e8f\u5217\u5728\u4e00\u5b9a\u6642\u9593\u7bc4\u570d\u5167\u7684\u6a23\u672c\uff0c\u4f46\u4e5f\u5c07\u5305\u542b\u67d0\u4e9b\u6642\u9593\u6b65\u9577\u7684\u5e8f\u5217\u6578\u64da\u7684\u9593\u9699\u3002","title":"\u67e5\u8a62\u57fa\u790e"},{"location":"prometheus/promql/theory/#_1","text":"\u539f\u6587: PromQL \u57fa\u7840 \u5728\u7e7c\u7e8c\u6df1\u5165\u5b78\u7fd2 PromQL \u67e5\u8a62\u7d30\u7bc0\u4e4b\u524d\uff0c\u6211\u5011\u5148\u4f86\u770b\u770b PromQL \u67e5\u8a62\u7684\u4e00\u4e9b\u7406\u8ad6\u57fa\u790e\u3002","title":"\u67e5\u8a62\u57fa\u790e"},{"location":"prometheus/promql/theory/#_2","text":"\u8207 SQL \u67e5\u8a62\u8a9e\u8a00\uff08SELECT * FROM ...\uff09\u4e0d\u540c\uff0cPromQL \u662f\u4e00\u7a2e\u5d4c\u5957\u7684\u51fd\u6578\u5f0f\u8a9e\u8a00\uff0c\u5c31\u662f\u6211\u5011\u8981\u628a\u9700\u8981\u67e5\u627e\u7684\u6578\u64da\u63cf\u8ff0\u6210\u4e00\u7d44\u5d4c\u5957\u7684\u8868\u9054\u5f0f\uff0c\u6bcf\u500b\u8868\u9054\u5f0f\u90fd\u6703\u8a55\u4f30\u70ba\u4e00\u500b\u4e2d\u9593\u503c\uff0c\u6bcf\u500b\u4e2d\u9593\u503c\u90fd\u6703\u88ab\u7528\u4f5c\u5b83\u4e0a\u5c64\u8868\u9054\u5f0f\u4e2d\u7684\u53c3\u6578\uff0c\u800c\u67e5\u8a62\u7684\u6700\u5916\u5c64\u8868\u9054\u5f0f\u8868\u793a\u4f60\u53ef\u4ee5\u5728\u8868\u683c\u3001\u5716\u5f62\u4e2d\u770b\u5230\u7684\u6700\u7d42\u8fd4\u56de\u503c\u3002\u6bd4\u5982\u4e0b\u9762\u7684\u67e5\u8a62\u8a9e\u53e5\uff1a histogram_quantile ( # \u67e5\u8a62\u7684\u6839\uff0c\u6700\u7d42\u7d50\u679c\u8868\u793a\u4e00\u500b\u8fd1\u4f3c\u5206\u4f4d\u6578\u3002 0.9 , # histogram_quantile() \u7684\u7b2c\u4e00\u500b\u53c3\u6578\uff0c\u5206\u4f4d\u6578\u7684\u76ee\u6a19\u503c # histogram_quantile() \u7684\u7b2c\u4e8c\u500b\u53c3\u6578\uff0c\u805a\u5408\u7684\u76f4\u65b9\u5716 sum by ( le , method , path ) ( # sum() \u7684\u53c3\u6578\uff0c\u76f4\u65b9\u5716\u904e\u53bb5\u5206\u9418\u6bcf\u79d2\u589e\u91cf\u3002 rate ( # rate() \u7684\u53c3\u6578\uff0c\u904e\u53bb5\u5206\u9418\u7684\u539f\u59cb\u76f4\u65b9\u5716\u5e8f\u5217 demo_api_request_duration_seconds_bucket { job = \" demo \"}[ 5m ] ) ) ) PromQL \u8868\u9054\u5f0f\u4e0d\u50c5\u50c5\u662f\u6574\u500b\u67e5\u8a62\uff0c\u800c\u662f\u67e5\u8a62\u7684\u4efb\u4f55\u5d4c\u5957\u90e8\u5206\uff08\u6bd4\u5982\u4e0a\u9762\u7684rate(...)\u90e8\u5206\uff09\uff0c\u4f60\u53ef\u4ee5\u628a\u5b83\u4f5c\u70ba\u4e00\u500b\u67e5\u8a62\u672c\u8eab\u4f86\u904b\u884c\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6bcf\u884c\u8a3b\u91cb\u4ee3\u8868\u4e00\u500b\u8868\u9054\u5f0f\u3002","title":"\u5d4c\u5957\u7d50\u69cb"},{"location":"prometheus/promql/theory/#_3","text":"\u5728\u67e5\u8a62 Prometheus \u6642\uff0c\u6709\u5169\u500b \u985e\u578b \u7684\u6982\u5ff5\u7d93\u5e38\u51fa\u73fe\uff0c\u5340\u5206\u5b83\u5011\u5f88\u91cd\u8981\u3002 \u6293\u53d6\u76ee\u6a19\u5831\u544a\u7684 \u6307\u6a19\u985e\u578b \uff1acounter\u3001gauge\u3001histogram\u3001summary\u3002 PromQL \u8868\u9054\u5f0f\u7684 \u7d50\u679c\u6578\u64da\u985e\u578b \uff1a\u5b57\u7b26\u4e32\u3001\u6a19\u91cf\u3001\u77ac\u6642\u5411\u91cf\u6216\u5340\u9593\u5411\u91cf\u3002 PromQL \u5be6\u969b\u4e0a\u6c92\u6709\u76f4\u63a5\u7684\u6307\u6a19\u985e\u578b\u7684\u6982\u5ff5\uff0c\u53ea\u95dc\u6ce8\u8868\u9054\u5f0f\u7684 \u7d50\u679c\u985e\u578b \u3002\u6bcf\u500b PromQL \u8868\u9054\u5f0f\u90fd\u6709\u4e00\u500b\u985e\u578b\uff0c\u6bcf\u500b\u51fd\u6578\u3001\u904b\u7b97\u7b26\u6216\u5176\u4ed6\u985e\u578b\u7684\u64cd\u4f5c\u90fd\u8981\u6c42\u5176\u53c3\u6578\u662f\u67d0\u7a2e\u8868\u9054\u5f0f\u985e\u578b\u3002\u4f8b\u5982\uff0c rate() \u51fd\u6578\u8981\u6c42\u5b83\u7684\u53c3\u6578\u662f\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u4f46\u662f rate() \u672c\u8eab\u8a55\u4f30\u70ba\u4e00\u500b\u77ac\u6642\u5411\u91cf\u8f38\u51fa\uff0c\u6240\u4ee5 rate() \u7684\u7d50\u679c\u53ea\u80fd\u7528\u5728\u671f\u671b\u662f\u77ac\u6642\u5411\u91cf\u7684\u5730\u65b9\u3002 PromQL \u4e2d\u53ef\u80fd\u7684\u8868\u9054\u5f0f\u985e\u578b\u5305\u62ec\uff1a string(\u5b57\u7b26\u4e32) \uff1a\u5b57\u7b26\u4e32\u53ea\u6703\u4f5c\u70ba\u67d0\u4e9b\u51fd\u6578\uff08\u5982 label_join() \u548c label_replace() \uff09\u7684\u53c3\u6578\u51fa\u73fe\u3002 scalar(\u6a19\u91cf) \uff1a\u4e00\u500b\u55ae\u4e00\u7684\u6578\u5b57\u503c\uff0c\u5982 1.234\uff0c\u9019\u4e9b\u6578\u5b57\u53ef\u4ee5\u4f5c\u70ba\u67d0\u4e9b\u51fd\u6578\u7684\u53c3\u6578\uff0c\u5982 histogram_quantile(0.9, ...) \u6216 topk(3, ...) \uff0c\u4e5f\u6703\u51fa\u73fe\u5728\u7b97\u8853\u904b\u7b97\u4e2d\u3002 instant vector(\u77ac\u6642\u5411\u91cf) \uff1a\u4e00\u7d44\u6a19\u8a18\u7684\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u6709\u4e00\u500b\u6a23\u672c\uff0c\u90fd\u5728\u540c\u4e00\u500b\u6642\u9593\u6233\uff0c\u77ac\u6642\u5411\u91cf\u53ef\u4ee5\u7531 TSDB \u6642\u9593\u5e8f\u5217\u9078\u64c7\u5668\u76f4\u63a5\u7522\u751f\uff0c\u5982 node_cpu_seconds_total \uff0c\u4e5f\u53ef\u4ee5\u7531\u4efb\u4f55\u51fd\u6578\u6216\u5176\u4ed6\u8f49\u63db\u4f86\u7372\u53d6\u3002 node_cpu_seconds_total { cpu = \"0\" , mode = \"idle\" } \u2192 19165078 .75 @ timestamp_1 node_cpu_seconds_total { cpu = \"0\" , mode = \"system\" } \u2192 381598 .72 @ timestamp_1 node_cpu_seconds_total { cpu = \"0\" , mode = \"user\" } \u2192 23211630 .97 @ timestamp_1 - range vector(\u5340\u9593\u5411\u91cf) \uff1a\u4e00\u7d44\u6a19\u8a18\u7684\u6642\u9593\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u90fd\u6709\u4e00\u500b\u96a8\u6642\u9593\u8b8a\u5316\u7684\u6a23\u672c\u7bc4\u570d\u3002\u5728 PromQL \u4e2d\u53ea\u6709\u5169\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u751f\u6210\u5340\u9593\u5411\u91cf\uff1a\u5728\u67e5\u8a62\u4e2d\u4f7f\u7528\u5b57\u9762\u5340\u9593\u5411\u91cf\u9078\u64c7\u5668\uff08\u5982 node_cpu_seconds_total[5m] \uff09\uff0c\u6216\u4f7f\u7528\u5b50\u67e5\u8a62\u8868\u9054\u5f0f\uff08\u5982 <expression>[5m:10s] \uff09\uff0c\u7576\u60f3\u8981\u5728\u6307\u5b9a\u7684\u6642\u9593\u7a97\u53e3\u5167\u805a\u5408\u4e00\u500b\u5e8f\u5217\u7684\u884c\u70ba\u6642\uff0c\u5340\u9593\u5411\u91cf\u975e\u5e38\u6709\u7528\uff0c\u5c31\u50cf rate(node_cpu_seconds_total[5m]) \u8a08\u7b97\u6bcf\u79d2\u589e\u52a0\u7387\u4e00\u6a23\uff0c\u5728 node_cpu_seconds_total \u6307\u6a19\u7684\u6700\u5f8c 5 \u5206\u9418\u5167\u6c42\u5e73\u5747\u503c\u3002 node_cpu_seconds_total { cpu = \"0\" , mode = \"idle\" } \u2192 19165078 .75 @ timestamp_1, 19165136 .3 @ timestamp_2, 19165167 .72 @ timestamp_3 node_cpu_seconds_total { cpu = \"0\" , mode = \"system\" } \u2192 381598 .72 @ timestamp_1, 381599 .98 @ timestamp_2, 381600 .58 @ timestamp_3 node_cpu_seconds_total { cpu = \"0\" , mode = \"user\" } \u2192 23211630 .97 @ timestamp_1, 23211711 .34 @ timestamp_2, 23211748 .64 @ timestamp_3","title":"\u7d50\u679c\u985e\u578b"},{"location":"prometheus/promql/theory/#_4","text":"PromQL \u67e5\u8a62\u4e2d\u5c0d\u6642\u9593\u7684\u5f15\u7528\u53ea\u6709\u76f8\u5c0d\u5f15\u7528\uff0c\u6bd4\u5982 [5m] \uff0c\u8868\u793a\u904e\u53bb 5 \u5206\u9418\uff0c\u90a3\u9ebc\u5982\u4f55\u6307\u5b9a\u4e00\u500b\u7d55\u5c0d\u7684\u6642\u9593\u7bc4\u570d\uff0c\u6216\u5728\u4e00\u500b\u8868\u683c\u4e2d\u986f\u793a\u67e5\u8a62\u7d50\u679c\u7684\u6642\u9593\u6233\uff1f\u5728 PromQL \u4e2d\uff0c\u9019\u6a23\u7684\u6642\u9593\u53c3\u6578\u662f\u8207\u8868\u9054\u5f0f\u5206\u958b\u767c\u9001\u5230 Prometheus \u67e5\u8a62 API \u7684\uff0c\u78ba\u5207\u7684\u6642\u9593\u53c3\u6578\u53d6\u6c7a\u65bc\u4f60\u767c\u9001\u7684\u67e5\u8a62\u985e\u578b\uff0cPrometheus \u6709\u5169\u7a2e\u985e\u578b\u7684 PromQL \u67e5\u8a62\uff1a \u77ac\u6642\u67e5\u8a62 \u548c \u5340\u9593\u67e5\u8a62 \u3002","title":"\u67e5\u8a62\u985e\u578b\u548c\u8a55\u4f30\u6642\u9593"},{"location":"prometheus/promql/theory/#_5","text":"\u77ac\u6642\u67e5\u8a62\u7528\u65bc\u985e\u4f3c\u8868\u683c\u7684\u8996\u5716\uff0c\u4f60\u60f3\u5728\u4e00\u500b\u6642\u9593\u9ede\u4e0a\u986f\u793a PromQL \u67e5\u8a62\u7684\u7d50\u679c\u3002\u4e00\u500b\u77ac\u6642\u67e5\u8a62\u6709\u4ee5\u4e0b\u53c3\u6578\uff1a PromQL \u8868\u9054\u5f0f \u4e00\u500b\u8a55\u4f30\u7684\u6642\u9593\u6233 \u5728\u67e5\u8a62\u7684\u6642\u5019\u53ef\u4ee5\u9078\u64c7\u67e5\u8a62\u904e\u53bb\u7684\u6578\u64da\uff0c\u6bd4\u5982 foo[1h] \u8868\u793a\u67e5\u8a62 foo \u5e8f\u5217\u6700\u8fd1 1 \u500b\u5c0f\u6642\u7684\u6578\u64da\uff0c\u8a2a\u554f\u904e\u53bb\u7684\u6578\u64da\uff0c\u5c0d\u65bc\u8a08\u7b97\u4e00\u6bb5\u6642\u9593\u5167\u7684\u6bd4\u7387\u6216\u5e73\u5747\u6578\u7b49\u805a\u5408\u6703\u975e\u5e38\u6709\u7528\u3002 \u5728 Prometheus \u7684 WebUI \u754c\u9762\u4e2d\u8868\u683c\u8996\u5716\u4e2d\u7684\u67e5\u8a62\u5c31\u662f\u77ac\u6642\u67e5\u8a62\uff0cAPI \u63a5\u53e3 /api/v1/query?query=xxxx&time=xxxx \u4e2d\u7684 query \u53c3\u6578\u5c31\u662f PromQL \u8868\u9054\u5f0f\uff0c time \u53c3\u6578\u5c31\u662f\u8a55\u4f30\u7684\u6642\u9593\u6233\u3002\u77ac\u6642\u67e5\u8a62\u53ef\u4ee5\u8fd4\u56de\u4efb\u4f55\u6709\u6548\u7684 PromQL \u8868\u9054\u5f0f\u985e\u578b\uff08\u5b57\u7b26\u4e32\u3001\u6a19\u91cf\u3001\u5373\u6642\u548c\u7bc4\u570d\u5411\u91cf\uff09\u3002 \u4e0b\u9762\u4f86\u770b\u4e00\u500b\u77ac\u6642\u67e5\u8a62\u7684\u793a\u4f8b\uff0c\u770b\u770b\u5b83\u662f\u5982\u4f55\u9032\u884c\u8a55\u4f30\u5de5\u4f5c\u7684\u3002\u6bd4\u5982 http_requests_total \u5728\u6307\u5b9a\u7684\u6642\u9593\u6233\u4f86\u8a55\u4f30\u8868\u9054\u5f0f\uff0c http_requests_total \u662f\u4e00\u500b\u77ac\u6642\u5411\u91cf\u9078\u64c7\u5668\uff0c\u5b83\u53ef\u4ee5\u9078\u64c7\u8a72\u6642\u9593\u5e8f\u5217\u7684\u6700\u65b0\u6a23\u672c\uff0c\u6700\u65b0\u610f\u5473\u8457\u67e5\u8a62\u6700\u8fd1 5 \u5206\u9418\u7684\u6a23\u672c\u6578\u64da\u3002 \u5982\u679c\u6211\u5011\u5728\u4e00\u500b\u6709\u6700\u8fd1\u6a23\u672c\u7684\u6642\u9593\u6233\u4e0a\u904b\u884c\u6b64\u67e5\u8a62\uff0c\u7d50\u679c\u5c07\u5305\u542b\u5169\u500b\u5e8f\u5217\uff0c\u6bcf\u500b\u5e8f\u5217\u90fd\u6709\u4e00\u500b\u6a23\u672c\uff1a \u6ce8\u610f\u6bcf\u500b\u8fd4\u56de\u7684\u6a23\u672c\u8f38\u51fa\u6642\u9593\u6233\u4e0d\u518d\u662f\u539f\u59cb\u6a23\u672c\u88ab\u63a1\u96c6\u7684\u6642\u9593\u6233\uff0c\u800c\u6703\u88ab\u8a2d\u7f6e\u70ba\u8a55\u4f30\u7684\u6642\u9593\u6233\u3002 \u5982\u679c\u5728\u6642\u9593\u6233\u4e4b\u524d\u6709\u4e00\u500b >5m \u7684\u9593\u9699\uff0c\u9019\u500b\u6642\u5019\u5982\u679c\u6211\u5011\u57f7\u884c\u76f8\u540c\u7684\u67e5\u8a62\uff1a \u9019\u500b\u60c5\u6cc1\u4e0b\u67e5\u8a62\u7684\u7d50\u679c\u5c07\u8fd4\u56de\u70ba\u7a7a\uff0c\u56e0\u70ba\u5f88\u986f\u7136\u5728\u6700\u8fd1 5 \u5206\u9418\u5167\u6c92\u6709\u80fd\u5920\u5339\u914d\u7684\u6a23\u672c\u3002","title":"\u77ac\u6642\u67e5\u8a62"},{"location":"prometheus/promql/theory/#_6","text":"\u5340\u9593\u67e5\u8a62\u4e3b\u8981\u7528\u65bc\u5716\u5f62\uff0c\u60f3\u5728\u4e00\u500b\u6307\u5b9a\u7684\u6642\u9593\u7bc4\u570d\u5167\u986f\u793a\u4e00\u500b PromQL \u8868\u9054\u5f0f\uff0c\u7bc4\u570d\u67e5\u8a62\u7684\u5de5\u4f5c\u65b9\u5f0f\u8207\u5373\u6642\u67e5\u8a62\u5b8c\u5168\u76f8\u540c\uff0c\u9019\u4e9b\u67e5\u8a62\u5728 \u6307\u5b9a\u6642\u9593\u7bc4\u570d\u7684\u8a55\u4f30\u6b65\u9577 \u4e2d\u9032\u884c\u8a55\u4f30\u3002\u7576\u7136\uff0c\u9019\u5728\u5f8c\u53f0\u662f\u9ad8\u5ea6\u512a\u5316\u7684\uff0c\u5728\u9019\u7a2e\u60c5\u6cc1\u4e0b\uff0cPrometheus \u5be6\u969b\u4e0a\u4e26\u6c92\u6709\u904b\u884c\u8a31\u591a\u7368\u7acb\u7684\u5373\u6642\u67e5\u8a62\u3002 \u5340\u9593\u67e5\u8a62\u5305\u62ec\u4ee5\u4e0b\u4e00\u4e9b\u53c3\u6578\uff1a PromQL \u8868\u9054\u5f0f \u958b\u59cb\u6642\u9593 \u7d50\u675f\u6642\u9593 \u8a55\u4f30\u6b65\u9577 \u5728\u958b\u59cb\u6642\u9593\u548c\u7d50\u675f\u6642\u9593\u4e4b\u9593\u7684\u6bcf\u500b\u8a55\u4f30\u6b65\u9577\u4e0a\u8a55\u4f30\u8868\u9054\u5f0f\u5f8c\uff0c\u55ae\u7368\u8a55\u4f30\u7684\u6642\u9593\u7247\u88ab\u62fc\u63a5\u5230\u4e00\u500b\u55ae\u4e00\u7684\u5340\u9593\u5411\u91cf\u4e2d\u3002\u5340\u9593\u67e5\u8a62\u5141\u8a31\u50b3\u5165\u77ac\u6642\u5411\u91cf\u985e\u578b\u6216\u6a19\u91cf\u985e\u578b\u7684\u8868\u9054\u5f0f\uff0c\u4f46\u59cb\u7d42\u8fd4\u56de\u4e00\u500b\u7bc4\u570d\u5411\u91cf\uff08\u6a19\u91cf\u6216\u77ac\u6642\u5411\u91cf\u5728\u4e00\u500b\u6642\u9593\u7bc4\u570d\u5167\u88ab\u8a55\u4f30\u7684\u7d50\u679c\uff09\u3002 \u5728 Prometheus \u7684 WebUI \u754c\u9762\u4e2d\u5716\u5f62\u8996\u5716\u4e2d\u7684\u67e5\u8a62\u5c31\u662f\u5340\u9593\u67e5\u8a62\uff0cAPI \u63a5\u53e3 /api/v1/query_range?query=xxx&start=xxxxxx&end=xxxx&step=14 \u4e2d\u7684 query \u53c3\u6578\u5c31\u662f PromQL \u8868\u9054\u5f0f\uff0c start \u70ba\u958b\u59cb\u6642\u9593\uff0c end \u70ba\u7d50\u675f\u6642\u9593\uff0c step \u70ba\u8a55\u4f30\u7684\u6b65\u9577\u3002 \u6bd4\u5982\u628a\u4e0a\u9762\u7684 http_requests_total \u8868\u9054\u5f0f\u4f5c\u70ba\u4e00\u500b\u7bc4\u570d\u67e5\u8a62\u4f86\u9032\u884c\u8a55\u4f30\uff0c\u5b83\u7684\u8a55\u4f30\u7d50\u679c\u5982\u4e0b\u6240\u793a\uff1a \u6ce8\u610f\u6bcf\u500b\u8a55\u4f30\u6b65\u9a5f\u7684\u884c\u70ba\u8207\u7368\u7acb\u7684\u77ac\u6642\u67e5\u8a62\u5b8c\u5168\u4e00\u6a23\uff0c\u800c\u4e14\u6bcf\u500b\u7368\u7acb\u7684\u77ac\u6642\u67e5\u8a62\u90fd\u6c92\u6709\u67e5\u8a62\u7684\u7e3d\u9ad4\u7bc4\u570d\u7684\u6982\u5ff5\uff0c\u5728\u6211\u5011\u9019\u500b\u793a\u4f8b\u4e2d\u6700\u7d42\u7684\u7d50\u679c\u5c07\u662f\u4e00\u500b\u5340\u9593\u5411\u91cf\uff0c\u5176\u4e2d\u5305\u542b\u5169\u500b\u9078\u5b9a\u5e8f\u5217\u5728\u4e00\u5b9a\u6642\u9593\u7bc4\u570d\u5167\u7684\u6a23\u672c\uff0c\u4f46\u4e5f\u5c07\u5305\u542b\u67d0\u4e9b\u6642\u9593\u6b65\u9577\u7684\u5e8f\u5217\u6578\u64da\u7684\u9593\u9699\u3002","title":"\u5340\u9593\u67e5\u8a62"},{"location":"prometheus/promql/threshold/","text":"\u95be\u503c \u00b6 \u539f\u6587: \u8fd0\u7b97 PromQL \u901a\u904e\u63d0\u4f9b\u4e00\u7d44\u904e\u6ffe\u7684\u4e8c\u5143\u904b\u7b97\u7b26\uff08>\u3001<\u3001== \u7b49\uff09\uff0c\u5141\u8a31\u6839\u64da\u5176\u6a23\u672c\u503c\u904e\u6ffe\u4e00\u7d44\u5e8f\u5217\uff0c\u9019\u7a2e\u904e\u6ffe\u6700\u5e38\u898b\u7684\u5834\u666f\u5c31\u662f\u5728\u5831\u8b66\u898f\u5247\u4e2d\u4f7f\u7528\u7684\u95be\u503c\u3002\u6bd4\u5982\u6211\u5011\u60f3\u67e5\u627e\u5728\u904e\u53bb 15 \u5206\u9418\u5167\u7684 status=\"500\" \u932f\u8aa4\u7387\u5927\u65bc 20% \u7684\u6240\u6709 HTTP \u8def\u5f91\uff0c\u6211\u5011\u5728 rate \u8868\u9054\u5f0f\u5f8c\u9762\u6dfb\u52a0\u4e00\u500b >0.2 \u7684\u904e\u6ffe\u904b\u7b97\u7b26\uff1a rate ( demo_api_request_duration_seconds_count { status = \" 500 \", job = \" demo \"}[ 15m ] ) > 0.2 \u9019\u500b\u67e5\u8a62\u53ea\u6703\u5c07\u932f\u8aa4\u7387\u5927\u65bc 20% \u7684\u6578\u64da\u904e\u6ffe\u51fa\u4f86\u3002 Info \u6ce8\u610f\uff1a\u7531\u65bc\u5728\u5716\u5f62\u4e2d\u7684\u6bcf\u500b\u6b65\u9577\u90fd\u662f\u5b8c\u5168\u7368\u7acb\u8a55\u4f30\u8868\u9054\u5f0f\u7684\uff0c\u56e0\u6b64\u6839\u64da\u6bcf\u500b\u6b65\u9a5f\u7684\u904e\u6ffe\u689d\u4ef6\uff0c\u67d0\u4e9b\u6bd4\u7387\u6703\u51fa\u73fe\u6216\u6d88\u5931\uff08\u56e0\u6b64\u5b58\u5728\u9593\u9699\uff09\u3002\u4e00\u822c\u4f86\u8aaa\uff0c\u4e8c\u5143\u904e\u6ffe\u904b\u7b97\u7b26\u5728\u5716\u5f62\u4e2d\u4e26\u4e0d\u5e38\u898b\uff0c\u5927\u591a\u6578\u5728\u5831\u8b66\u689d\u4ef6\u4e2d\u51fa\u73fe\uff0c\u7528\u4f86\u8868\u793a\u95be\u503c\u3002 \u9019\u7a2e\u904e\u6ffe\u65b9\u5f0f\u4e0d\u50c5\u9069\u7528\u65bc\u55ae\u500b\u6578\u5b57\uff0cPromQL \u9084\u5141\u8a31\u4f60\u7528\u4e00\u7d44\u6642\u9593\u5e8f\u5217\u904e\u6ffe\u53e6\u4e00\u7d44\u5e8f\u5217\u3002\u8207\u4e0a\u9762\u7684\u4e8c\u5143\u904b\u7b97\u4e00\u6a23\uff0c\u6bd4\u8f03\u904b\u7b97\u7b26\u6703\u81ea\u52d5\u61c9\u7528\u65bc\u6bd4\u8f03\u5de6\u5074\u548c\u53f3\u5074\u5177\u6709\u76f8\u540c\u6a19\u7c64\u96c6\u7684\u5e8f\u5217\u4e4b\u9593\u3002 on() / ignoring() \u548c group_left() / group_right() \u4fee\u98fe\u7b26\u7684\u4f5c\u7528\u4e5f\u8207\u6211\u5011\u524d\u9762\u5b78\u7fd2\u7684\u4e8c\u5143\u7b97\u8853\u904b\u7b97\u7b26\u4e00\u6a23\u3002 \u4ee5\u4e0b\u793a\u4f8b\u662f\u9078\u64c7\u6240\u6709\u5177\u6709 500 \u932f\u8aa4\u7387\u4e14\u81f3\u5c11\u6bd4\u540c\u4e00\u8def\u5f91\u7684\u7e3d\u8acb\u6c42\u7387\u5927 50 \u500d\u7684\u8def\u5f91\uff1a rate ( demo_api_request_duration_seconds_count { status = \" 500 \", job = \" demo \"}[ 5m ] ) * 50 > ignoring ( status ) sum without ( status ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u4e0d\u904e\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u5011\u5fc5\u9808\u5ffd\u7565\u5339\u914d\u4e2d\u7684 status \u6a19\u7c64\uff0c\u56e0\u70ba\u5728\u5de6\u908a\u4e00\u76f4\u6709\u9019\u500b\u6a19\u7c64\uff0c\u800c\u53f3\u908a\u6c92\u6709\u9019\u500b\u6a19\u7c64\u3002 \u6bd4\u5982\u6211\u5011\u9084\u53ef\u4ee5\u8a08\u7b97 demo \u6f14\u793a\u670d\u52d9\u5be6\u4f8b\u5728\u4e00\u5c0f\u6642\u5167\u7684\u9810\u6e2c\u78c1\u76e4\u4f7f\u7528\u91cf\uff0c\u4f46\u8981\u904e\u6ffe\u53ea\u6709\u90a3\u4e9b\u9810\u6e2c\u78c1\u76e4\u5df2\u6eff\u7684\u5be6\u4f8b\u3002 predict_linear ( demo_disk_usage_bytes { job = \" demo \"}[ 1h ], 3600 ) >= demo_disk_total_bytes { job = \" demo \"} Prometheus \u652f\u6301\u4ee5\u4e0b\u904e\u6ffe\u64cd\u4f5c\uff1a == != < <= > >= \u6709\u6642\u4f60\u53ef\u80fd\u60f3\u77e5\u9053\u6bd4\u8f03\u904b\u7b97\u7b26\u7684\u7d50\u679c\u800c\u4e0d\u5be6\u969b\u522a\u9664\u4efb\u4f55\u8f38\u51fa\u7cfb\u5217\u3002\u8981\u5be6\u73fe\u9019\u4e00\u9ede\uff0c\u6211\u5011\u53ef\u4ee5\u5411\u904b\u7b97\u7b26\u6dfb\u52a0\u4e00\u500b bool \u4fee\u98fe\u7b26\u4f86\u4fdd\u7559\u6240\u6709\u7684\u5e8f\u5217\uff0c\u4f46\u662f\u628a\u8f38\u51fa\u6a23\u672c\u503c\u8a2d\u7f6e\u70ba 1\uff08\u6bd4\u8f03\u70ba\u771f\uff09\u6216 0\uff08\u6bd4\u8f03\u70ba\u5047\uff09\u3002 \u4f8b\u5982\uff0c\u8981\u7c21\u55ae\u5730\u986f\u793a\u4e00\u7d44\u6578\u64da\u4e2d\u54ea\u4e9b\u8acb\u6c42\u7387\u9ad8\u65bc\u6216\u4f4e\u65bc 0.2/s\uff0c\u6211\u5011\u53ef\u4ee5\u9019\u6a23\u67e5\u8a62\uff1a rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) > bool 0.2 \u6211\u5011\u53ef\u4ee5\u770b\u5230\u8f38\u5165\u5e8f\u5217\u7684\u7d50\u679c\u70ba 0 \u6216 1\uff0c\u628a\u6578\u5b57\u689d\u4ef6\u8f49\u63db\u70ba\u4e86\u5e03\u723e\u8f38\u51fa\u503c\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u986f\u793a\u4f7f\u7528\u5c11\u65bc 20MB \u5167\u5b58\u7684\u76ee\u6a19\uff08 process_resident_memory_bytes \u6307\u6a19\uff09\u3002 process_resident_memory_bytes / 1024 ^ 2 < 20 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u986f\u793a Prometheus \u670d\u52d9\u5167\u90e8\u6240\u6709\u5728\u904e\u53bb 5 \u5206\u9418\u5167\u6c92\u6709\u6536\u5230\u4efb\u4f55\u67e5\u8a62\u7684 HTTP \u8655\u7406\u5668\u3002 rate ( prometheus_http_requests_total [ 5m ] ) == 0","title":"\u95be\u503c"},{"location":"prometheus/promql/threshold/#_1","text":"\u539f\u6587: \u8fd0\u7b97 PromQL \u901a\u904e\u63d0\u4f9b\u4e00\u7d44\u904e\u6ffe\u7684\u4e8c\u5143\u904b\u7b97\u7b26\uff08>\u3001<\u3001== \u7b49\uff09\uff0c\u5141\u8a31\u6839\u64da\u5176\u6a23\u672c\u503c\u904e\u6ffe\u4e00\u7d44\u5e8f\u5217\uff0c\u9019\u7a2e\u904e\u6ffe\u6700\u5e38\u898b\u7684\u5834\u666f\u5c31\u662f\u5728\u5831\u8b66\u898f\u5247\u4e2d\u4f7f\u7528\u7684\u95be\u503c\u3002\u6bd4\u5982\u6211\u5011\u60f3\u67e5\u627e\u5728\u904e\u53bb 15 \u5206\u9418\u5167\u7684 status=\"500\" \u932f\u8aa4\u7387\u5927\u65bc 20% \u7684\u6240\u6709 HTTP \u8def\u5f91\uff0c\u6211\u5011\u5728 rate \u8868\u9054\u5f0f\u5f8c\u9762\u6dfb\u52a0\u4e00\u500b >0.2 \u7684\u904e\u6ffe\u904b\u7b97\u7b26\uff1a rate ( demo_api_request_duration_seconds_count { status = \" 500 \", job = \" demo \"}[ 15m ] ) > 0.2 \u9019\u500b\u67e5\u8a62\u53ea\u6703\u5c07\u932f\u8aa4\u7387\u5927\u65bc 20% \u7684\u6578\u64da\u904e\u6ffe\u51fa\u4f86\u3002 Info \u6ce8\u610f\uff1a\u7531\u65bc\u5728\u5716\u5f62\u4e2d\u7684\u6bcf\u500b\u6b65\u9577\u90fd\u662f\u5b8c\u5168\u7368\u7acb\u8a55\u4f30\u8868\u9054\u5f0f\u7684\uff0c\u56e0\u6b64\u6839\u64da\u6bcf\u500b\u6b65\u9a5f\u7684\u904e\u6ffe\u689d\u4ef6\uff0c\u67d0\u4e9b\u6bd4\u7387\u6703\u51fa\u73fe\u6216\u6d88\u5931\uff08\u56e0\u6b64\u5b58\u5728\u9593\u9699\uff09\u3002\u4e00\u822c\u4f86\u8aaa\uff0c\u4e8c\u5143\u904e\u6ffe\u904b\u7b97\u7b26\u5728\u5716\u5f62\u4e2d\u4e26\u4e0d\u5e38\u898b\uff0c\u5927\u591a\u6578\u5728\u5831\u8b66\u689d\u4ef6\u4e2d\u51fa\u73fe\uff0c\u7528\u4f86\u8868\u793a\u95be\u503c\u3002 \u9019\u7a2e\u904e\u6ffe\u65b9\u5f0f\u4e0d\u50c5\u9069\u7528\u65bc\u55ae\u500b\u6578\u5b57\uff0cPromQL \u9084\u5141\u8a31\u4f60\u7528\u4e00\u7d44\u6642\u9593\u5e8f\u5217\u904e\u6ffe\u53e6\u4e00\u7d44\u5e8f\u5217\u3002\u8207\u4e0a\u9762\u7684\u4e8c\u5143\u904b\u7b97\u4e00\u6a23\uff0c\u6bd4\u8f03\u904b\u7b97\u7b26\u6703\u81ea\u52d5\u61c9\u7528\u65bc\u6bd4\u8f03\u5de6\u5074\u548c\u53f3\u5074\u5177\u6709\u76f8\u540c\u6a19\u7c64\u96c6\u7684\u5e8f\u5217\u4e4b\u9593\u3002 on() / ignoring() \u548c group_left() / group_right() \u4fee\u98fe\u7b26\u7684\u4f5c\u7528\u4e5f\u8207\u6211\u5011\u524d\u9762\u5b78\u7fd2\u7684\u4e8c\u5143\u7b97\u8853\u904b\u7b97\u7b26\u4e00\u6a23\u3002 \u4ee5\u4e0b\u793a\u4f8b\u662f\u9078\u64c7\u6240\u6709\u5177\u6709 500 \u932f\u8aa4\u7387\u4e14\u81f3\u5c11\u6bd4\u540c\u4e00\u8def\u5f91\u7684\u7e3d\u8acb\u6c42\u7387\u5927 50 \u500d\u7684\u8def\u5f91\uff1a rate ( demo_api_request_duration_seconds_count { status = \" 500 \", job = \" demo \"}[ 5m ] ) * 50 > ignoring ( status ) sum without ( status ) ( rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] )) \u4e0d\u904e\u9700\u8981\u6ce8\u610f\u7684\u662f\u6211\u5011\u5fc5\u9808\u5ffd\u7565\u5339\u914d\u4e2d\u7684 status \u6a19\u7c64\uff0c\u56e0\u70ba\u5728\u5de6\u908a\u4e00\u76f4\u6709\u9019\u500b\u6a19\u7c64\uff0c\u800c\u53f3\u908a\u6c92\u6709\u9019\u500b\u6a19\u7c64\u3002 \u6bd4\u5982\u6211\u5011\u9084\u53ef\u4ee5\u8a08\u7b97 demo \u6f14\u793a\u670d\u52d9\u5be6\u4f8b\u5728\u4e00\u5c0f\u6642\u5167\u7684\u9810\u6e2c\u78c1\u76e4\u4f7f\u7528\u91cf\uff0c\u4f46\u8981\u904e\u6ffe\u53ea\u6709\u90a3\u4e9b\u9810\u6e2c\u78c1\u76e4\u5df2\u6eff\u7684\u5be6\u4f8b\u3002 predict_linear ( demo_disk_usage_bytes { job = \" demo \"}[ 1h ], 3600 ) >= demo_disk_total_bytes { job = \" demo \"} Prometheus \u652f\u6301\u4ee5\u4e0b\u904e\u6ffe\u64cd\u4f5c\uff1a == != < <= > >= \u6709\u6642\u4f60\u53ef\u80fd\u60f3\u77e5\u9053\u6bd4\u8f03\u904b\u7b97\u7b26\u7684\u7d50\u679c\u800c\u4e0d\u5be6\u969b\u522a\u9664\u4efb\u4f55\u8f38\u51fa\u7cfb\u5217\u3002\u8981\u5be6\u73fe\u9019\u4e00\u9ede\uff0c\u6211\u5011\u53ef\u4ee5\u5411\u904b\u7b97\u7b26\u6dfb\u52a0\u4e00\u500b bool \u4fee\u98fe\u7b26\u4f86\u4fdd\u7559\u6240\u6709\u7684\u5e8f\u5217\uff0c\u4f46\u662f\u628a\u8f38\u51fa\u6a23\u672c\u503c\u8a2d\u7f6e\u70ba 1\uff08\u6bd4\u8f03\u70ba\u771f\uff09\u6216 0\uff08\u6bd4\u8f03\u70ba\u5047\uff09\u3002 \u4f8b\u5982\uff0c\u8981\u7c21\u55ae\u5730\u986f\u793a\u4e00\u7d44\u6578\u64da\u4e2d\u54ea\u4e9b\u8acb\u6c42\u7387\u9ad8\u65bc\u6216\u4f4e\u65bc 0.2/s\uff0c\u6211\u5011\u53ef\u4ee5\u9019\u6a23\u67e5\u8a62\uff1a rate ( demo_api_request_duration_seconds_count { job = \" demo \"}[ 5m ] ) > bool 0.2 \u6211\u5011\u53ef\u4ee5\u770b\u5230\u8f38\u5165\u5e8f\u5217\u7684\u7d50\u679c\u70ba 0 \u6216 1\uff0c\u628a\u6578\u5b57\u689d\u4ef6\u8f49\u63db\u70ba\u4e86\u5e03\u723e\u8f38\u51fa\u503c\u3002 \u7df4\u7fd2 1.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u986f\u793a\u4f7f\u7528\u5c11\u65bc 20MB \u5167\u5b58\u7684\u76ee\u6a19\uff08 process_resident_memory_bytes \u6307\u6a19\uff09\u3002 process_resident_memory_bytes / 1024 ^ 2 < 20 2.\u69cb\u5efa\u4e00\u500b\u67e5\u8a62\uff0c\u986f\u793a Prometheus \u670d\u52d9\u5167\u90e8\u6240\u6709\u5728\u904e\u53bb 5 \u5206\u9418\u5167\u6c92\u6709\u6536\u5230\u4efb\u4f55\u67e5\u8a62\u7684 HTTP \u8655\u7406\u5668\u3002 rate ( prometheus_http_requests_total [ 5m ] ) == 0","title":"\u95be\u503c"},{"location":"vault/docs/auth/kubernetes/","text":"Kubernetes Auth Method \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth/kubernetes kubernetes auth \u65b9\u6cd5\u53ef\u7528\u65bc\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service account)\u4ee4\u724c\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u9019\u7a2e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u53ef\u4ee5\u8f15\u9b06\u5730\u5c07 Vault \u4ee4\u724c\u5f15\u5165 Kubernetes Pod\u3002 \u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u901a\u904e JWT \u8eab\u4efd\u9a57\u8b49\u767b\u9304 \u3002\u8acb\u53c3\u95b1 \u5982\u4f55\u4f7f\u7528\u77ed\u671f Kubernetes \u4ee4\u724c \u90e8\u5206\uff0c\u4e86\u89e3\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528 JWT \u8eab\u4efd\u9a57\u8b49\u7684\u539f\u56e0\u4ee5\u53ca\u5b83\u8207 Kubernetes \u8eab\u4efd\u9a57\u8b49\u7684\u6bd4\u8f03\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u8981\u5347\u7d1a\u5230 Kubernetes v1.21+\uff0c\u8acb\u78ba\u4fdd\u914d\u7f6e\u9078\u9805 disable_iss_validation \u8a2d\u7f6e\u70ba true \u3002\u5047\u8a2d\u9ed8\u8a8d\u639b\u8f09\u8def\u5f91\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 vault read -field disable_iss_validation auth/kubernetes/config \u6aa2\u67e5\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684 Kubernetes 1.21 \u3002 Authentication \u00b6 Via the CLI \u00b6 \u9ed8\u8a8d\u8def\u5f91\u662f /kubernetes \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u5728 CLI \u4e2d\u6307\u5b9a -path=/my-path \u3002 $ vault write auth/kubernetes/login role = demo jwt = ... Via the API \u00b6 \u9ed8\u8a8d\u7aef\u9ede\u662f auth/kubernetes/login \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u4f7f\u7528\u8a72\u503c\u800c\u4e0d\u662f kubernetes\u3002 $ curl \\ --request POST \\ --data '{\"jwt\": \"<your service account jwt>\", \"role\": \"demo\"}' \\ http://127.0.0.1:8200/v1/auth/kubernetes/login \u97ff\u61c9\u5c07\u5728 auth.client_token \u5305\u542b\u4e00\u500b\u4ee4\u724c\uff1a { \"auth\" : { \"client_token\" : \"38fe9691-e623-7238-f618-c94d4e7bc674\" , \"accessor\" : \"78e87a38-84ed-2692-538f-ca8b9f400ab3\" , \"policies\" : [ \"default\" ], \"metadata\" : { \"role\" : \"demo\" , \"service_account_name\" : \"vault-auth\" , \"service_account_namespace\" : \"default\" , \"service_account_secret_name\" : \"vault-auth-token-pd21c\" , \"service_account_uid\" : \"aa9aa8ff-98d0-11e7-9bb7-0800276d99bf\" }, \"lease_duration\" : 2764800 , \"renewable\" : true } } Configuration \u00b6 \u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u5728 Vault\u3000\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531 Vault \u7ba1\u7406\u54e1\u6216\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff1a $ vault auth enable kubernetes \u4f7f\u7528 /config \u7aef\u9ede\u914d\u7f6e Vault \u4ee5\u8207 Kubernetes \u901a\u4fe1\u3002\u4f7f\u7528 kubectl cluster-info \u9a57\u8b49 Kubernetes \u4e3b\u6a5f\u5730\u5740\u548c TCP \u7aef\u53e3\u3002\u6709\u95dc\u53ef\u7528\u914d\u7f6e\u9078\u9805\u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \"<your reviewer service account JWT>\" \\ kubernetes_host = https://192.168.99.100:<your TCP port or blank for 443 > \\ kubernetes_ca_cert = @ca.crt \u5275\u5efa name role\uff1a $ vault write auth/kubernetes/role/demo \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = default \\ ttl = 1h \u6b64\u89d2\u8272\u6388\u6b0a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-auth \u670d\u52d9\u5e33\u6236\uff0c\u4e26\u70ba\u5176\u63d0\u4f9b\u9ed8\u8a8d\u7b56\u7565\u3002 \u6709\u95dc\u914d\u7f6e\u9078\u9805\u7684\u5b8c\u6574\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002 Kubernetes 1.21 \u00b6 \u5f9e\u7248\u672c 1.21 \u958b\u59cb\uff0cKubernetes BoundServiceAccountTokenVolume \u529f\u80fd\u9ed8\u8a8d\u70ba\u555f\u7528\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u6703\u4ee5\u5169\u7a2e\u5c0d Kubernetes \u8eab\u4efd\u9a57\u8b49\u5f88\u91cd\u8981\u7684\u65b9\u5f0f\u66f4\u6539\u639b\u8f09\u5230\u5bb9\u5668\u4e2d\u7684 JWT \u4ee4\u724c\uff1a \u5b83\u6709\u4e00\u500b\u904e\u671f\u6642\u9593\uff0c\u4e26\u4e14\u7d81\u5b9a\u5230 pod \u548c\u670d\u52d9\u5e33\u6236\u7684\u751f\u547d\u9031\u671f\u3002 JWT \u7684 iss \u8072\u660e\u7684\u503c\u53d6\u6c7a\u65bc\u96c6\u7fa4\u7684\u914d\u7f6e\u3002 \u914d\u7f6e token_reviewer_jwt \u9078\u9805\u6642\uff0c\u5c0d\u4ee4\u724c\u751f\u547d\u9031\u671f\u7684\u66f4\u6539\u5f88\u91cd\u8981\u3002\u5982\u679c\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0cKubernetes \u5c07\u5728 pod \u6216\u670d\u52d9\u5e33\u6236\u88ab\u522a\u9664\u6216\u904e\u671f\u6642\u9593\u904e\u5f8c\u7acb\u5373\u64a4\u92b7\u5b83\uff0c\u4e26\u4e14 Vault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API \u3002 \u70ba\u4e86\u97ff\u61c9 iss \u7684\u66f4\u6539\uff0cKubernetes auth \u5df2\u5728 Vault 1.9.0 \u4e2d\u66f4\u65b0\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u4e0d\u9a57\u8b49\u9812\u767c\u8005\u3002 Kubernetes API \u5728\u5be9\u67e5\u4ee4\u724c\u6642\u57f7\u884c\u76f8\u540c\u7684\u9a57\u8b49\uff0c\u56e0\u6b64\u5728 Vault \u7aef\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\u662f\u91cd\u8907\u7684\u5de5\u4f5c\u3002 \u5728\u4e0d\u7981\u7528 Vault \u7684\u9812\u767c\u8005\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\uff0c\u55ae\u500b Kubernetes \u8eab\u4efd\u9a57\u8b49\u914d\u7f6e\u7121\u6cd5\u540c\u6642\u7528\u65bc Kubernetes 1.20 \u548c 1.21 \u7684\u9ed8\u8a8d\u639b\u8f09 pod \u4ee4\u724c\u3002\u8acb\u6ce8\u610f\uff0c\u5728 Vault 1.9 \u4e4b\u524d\u5275\u5efa\u7684\u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u5c07\u4fdd\u6301\u820a\u7684\u9ed8\u8a8d\u503c\uff0c\u60a8\u9700\u8981\u5728\u5c07 Kubernetes \u5347\u7d1a\u5230 1.21 \u4e4b\u524d\u986f\u5f0f\u8a2d\u7f6e disable_iss_validation=true \u3002\u5982\u679c\u60a8\u5e0c\u671b\u5728 Vault \u4e2d\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684\u767c\u73fe\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u4ee5\u7372\u53d6\u6307\u5c0e\u3002 \u5982\u4f55\u514b\u670d short-lived Kubernetes tokens \u5e36\u4f86\u7684\u554f\u984c \u00b6 \u7576\u9ed8\u8a8d\u639b\u8f09\u7684 pod \u4ee4\u724c\u662f\u77ed\u66ab\u7684\u6642\uff0c\u6709\u5e7e\u7a2e\u4e0d\u540c\u7684\u65b9\u6cd5\u53ef\u4ee5\u70ba Kubernetes pod \u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\uff0c\u6bcf\u7a2e\u65b9\u6cd5\u90fd\u6709\u81ea\u5df1\u7684\u6b0a\u8861\u3002\u6b64\u8868\u7e3d\u7d50\u4e86\u9078\u9805\uff0c\u4e0b\u9762\u5c07\u66f4\u8a73\u7d30\u5730\u89e3\u91cb\u6bcf\u500b\u9078\u9805\u3002 Option All tokens are short-lived Can revoke tokens early Other considerations Use local token as reviewer JWT Yes Yes Requires Vault (1.9.3+) to be deployed on the Kubernetes cluster Use client JWT as reviewer JWT Yes Yes Operational overhead Use long-lived token as reviewer JWT No Yes Use JWT auth instead Yes No Use local service account token as the reviewer JWT \u00b6 \u5728 Kubernetes pod \u4e2d\u904b\u884c Vault \u6642\uff0c\u63a8\u85a6\u7684\u9078\u9805\u662f\u4f7f\u7528 pod \u7684\u672c\u5730\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 Vault \u5c07\u5b9a\u671f\u91cd\u65b0\u8b80\u53d6\u6587\u4ef6\u4ee5\u652f\u6301\u77ed\u671f\u4ee4\u724c\u3002\u8981\u4f7f\u7528\u672c\u5730\u4ee4\u724c\u548c CA \u8b49\u66f8\uff0c\u8acb\u5728\u914d\u7f6e auth \u65b9\u6cd5\u6642\u7701\u7565 token_reviewer_jwt \u548c kubernetes_ca_cert \u3002 Vault \u5c07\u5617\u8a66\u5206\u5225\u5f9e\u9ed8\u8a8d\u639b\u8f09\u6587\u4ef6\u593e /var/run/secrets/kubernetes.io/serviceaccount/ \u4e2d\u7684 token \u548c ca.crt \u52a0\u8f09\u5b83\u5011\u3002 $ vault write auth/kubernetes/config \\ kubernetes_host = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT Warning \u6ce8\u610f\uff1a\u9700\u8981 Vault 1.9.3+\u3002\u5728\u65e9\u671f\u7248\u672c\u4e2d\uff0c\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u548c CA \u8b49\u66f8\u88ab\u8b80\u53d6\u4e00\u6b21\u4e26\u5b58\u5132\u5728 Vault \u5b58\u5132\u4e2d\u3002\u7576\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u904e\u671f\u6216\u88ab\u64a4\u92b7\u6642\uff0cVault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API\uff0c\u4e26\u4e14\u5ba2\u6236\u7aef\u8eab\u4efd\u9a57\u8b49\u5c07\u5931\u6557\u3002 Use the Vault client's JWT as the reviewer JWT \u00b6 \u914d\u7f6e Kubernetes auth \u6642\uff0c\u53ef\u4ee5\u7701\u7565 token_reviewer_jwt \uff0cVault \u5728\u8207 Kubernetes TokenReview API \u901a\u4fe1\u6642\u6703\u4f7f\u7528 Vault \u5ba2\u6236\u7aef\u7684 JWT \u4f5c\u70ba\u81ea\u5df1\u7684 auth token\u3002\u5982\u679c Vault \u5728 Kubernetes \u4e2d\u904b\u884c\uff0c\u60a8\u9084\u9700\u8981\u8a2d\u7f6e disable_local_ca_jwt=true \u3002 \u9019\u610f\u5473\u8457 Vault \u4e0d\u5b58\u5132\u4efb\u4f55 JWT \u4e26\u5141\u8a31\u60a8\u5728\u4efb\u4f55\u5730\u65b9\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4f46\u6703\u589e\u52a0\u4e00\u4e9b\u64cd\u4f5c\u958b\u92b7\u4f86\u7dad\u8b77\u60a8\u5e0c\u671b\u80fd\u5920\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u670d\u52d9\u5e33\u6236\u96c6\u4e0a\u7684\u96c6\u7fa4\u89d2\u8272\u7d81\u5b9a\u3002 Vault \u7684\u6bcf\u500b\u5ba2\u6236\u7aef\u90fd\u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl create clusterrolebinding vault-client-auth-delegator \\ --clusterrole = system:auth-delegator \\ --group = group1 \\ --serviceaccount = default:svcaccount1 \\ ... Continue using long-lived tokens \u00b6 \u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u8655\u7684\u8aaa\u660e\u5275\u5efa\u4e00\u500b\u9577\u671f\u5b58\u5728\u7684\u6a5f\u5bc6\u4e26\u5c07\u5176\u7528\u4f5c token_reviewer_jwt \u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c vault \u670d\u52d9\u5e33\u6236 \u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl apply -f - <<EOF apiVersion: v1 kind: Secret metadata: name: vault-k8s-auth-secret annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u4f7f\u7528\u5b83\u53ef\u4ee5\u7dad\u8b77\u4ee5\u524d\u7684\u5de5\u4f5c\u6d41\u7a0b\uff0c\u4f46\u4e0d\u6703\u5f9e\u77ed\u671f\u4ee4\u724c\u7684\u6539\u9032\u5b89\u5168\u72c0\u614b\u4e2d\u53d7\u76ca\u3002 Use JWT auth \u00b6 Kubernetes auth \u5c08\u9580\u7528\u65bc\u4f7f\u7528 Kubernetes \u7684 TokenReview API \u3002\u4f46\u662f\uff0cKubernetes \u751f\u6210\u7684 JWT \u4ee4\u724c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u9a57\u8b49\u3002 JWT auth \u65b9\u6cd5\u6587\u6a94\u5305\u542b\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u8a2d\u7f6e JWT auth \u7684\u8aaa\u660e\u3002 \u6b64\u89e3\u6c7a\u65b9\u6848\u5141\u8a31\u60a8\u70ba\u6240\u6709\u5ba2\u6236\u7aef\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4e26\u4e14\u7121\u9700\u5be9\u67e5\u8005 JWT\u3002\u4f46\u662f\uff0c\u5ba2\u6236\u7aef\u4ee4\u724c\u5728\u5176 TTL \u5230\u671f\u4e4b\u524d\u4e0d\u80fd\u88ab\u64a4\u92b7\uff0c\u56e0\u6b64\u5efa\u8b70\u5728\u8a18\u4f4f\u8a72\u9650\u5236\u7684\u60c5\u6cc1\u4e0b\u4fdd\u6301 TTL \u8f03\u77ed\u3002 \u767c\u73fe Service account issuer \u00b6 Info \u6ce8\u610f\uff1a\u5f9e Vault 1.9.0 \u958b\u59cb\uff0c disable_iss_validation \u548c issuer \u5df2\u88ab\u68c4\u7528\uff0c\u4e26\u4e14 disable_iss_validation \u7684\u9ed8\u8a8d\u503c\u5df2\u66f4\u6539\u70ba true \u4ee5\u7528\u65bc\u65b0\u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u3002\u4ee5\u4e0b\u90e8\u5206\u50c5\u9069\u7528\u65bc\u60a8\u5df2\u8a2d\u7f6e disable_iss_validation=false \u6216\u5728 1.9 \u4e4b\u524d\u4f7f\u7528\u9ed8\u8a8d\u503c\u5275\u5efa\u639b\u8f09\uff0c\u4f46 disable_iss_validation=true \u662f\u6240\u6709 Vault \u7248\u672c\u7684\u65b0\u63a8\u85a6\u503c\u3002 Kubernetes 1.21+ \u96c6\u7fa4\u53ef\u80fd\u9700\u8981\u5c07\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u8a2d\u7f6e\u70ba\u8207 kube-apiserver \u7684 --service-account-issuer \u6a19\u8a8c\u76f8\u540c\u7684\u503c\u3002\u9019\u662f\u56e0\u70ba\u9019\u4e9b\u96c6\u7fa4\u7684\u670d\u52d9\u5e33\u6236 JWT \u53ef\u80fd\u5177\u6709\u7279\u5b9a\u65bc\u96c6\u7fa4\u672c\u8eab\u7684\u9812\u767c\u8005\uff0c\u800c\u4e0d\u662f\u820a\u9ed8\u8a8d\u7684 kubernetes/serviceaccount\u3002\u5982\u679c\u60a8\u7121\u6cd5\u76f4\u63a5\u6aa2\u67e5\u6b64\u503c\uff0c\u5247\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e26\u67e5\u627e iss \u5b57\u6bb5\u4ee5\u627e\u5230\u6240\u9700\u7684\u503c\uff1a echo '{\"apiVersion\": \"authentication.k8s.io/v1\", \"kind\": \"TokenRequest\"}' \\ | kubectl create -f- --raw /api/v1/namespaces/default/serviceaccounts/default/token \\ | jq -r '.status.token' \\ | cut -d . -f2 \\ | base64 -D \u5927\u591a\u6578\u96c6\u7fa4\u9084\u5c07\u5728 .well-known/openid-configuration \u7aef\u9ede\u4e0a\u63d0\u4f9b\u8a72\u4fe1\u606f\uff1a $ kubectl get --raw /.well-known/openid-configuration | jq -r .issuer \u7136\u5f8c\u5728\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u6642\u4f7f\u7528\u6b64\u503c\uff0c\u4f8b\u5982\uff1a $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT \" \\ issuer = \"\\\"test-aks-cluster-dns-d6cbb78e.hcp.uksouth.azmk8s.io\\\"\" { \"issuer\" : \"https://kubernetes.default.svc.cluster.local\" , \"jwks_uri\" : \"https://192.168.49.2:8443/openid/v1/jwks\" , \"response_types_supported\" : [ \"id_token\" ], \"subject_types_supported\" : [ \"public\" ], \"id_token_signing_alg_values_supported\" : [ \"RS256\" ] } \u914d\u7f6e Kubernetes \u00b6 \u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u8a2a\u554f Kubernetes TokenReview API \u4ee5\u9a57\u8b49\u63d0\u4f9b\u7684 JWT \u662f\u5426\u4ecd\u7136\u6709\u6548\u3002 Kubernetes \u61c9\u8a72\u4f7f\u7528 --service-account-lookup \u904b\u884c\u3002\u9019\u5728 Kubernetes 1.7 \u4e2d\u9ed8\u8a8d\u70ba true\u3002\u5426\u5247 Kubernetes \u4e2d\u5df2\u522a\u9664\u7684\u4ee4\u724c\u5c07\u7121\u6cd5\u6b63\u78ba\u64a4\u92b7\uff0c\u4e26\u4e14\u80fd\u5920\u901a\u904e\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4e2d\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u9700\u8981\u6709\u6b0a\u8a2a\u554f TokenReview API \u3002\u5982\u679c Kubernetes \u914d\u7f6e\u70ba\u4f7f\u7528 RBAC \u89d2\u8272\uff0c\u5247\u61c9\u6388\u4e88\u670d\u52d9\u5e33\u6236\u8a2a\u554f\u6b64 API \u7684\u6b0a\u9650\u3002\u4ee5\u4e0b\u793a\u4f8b ClusterRoleBinding \u53ef\u7528\u65bc\u6388\u4e88\u9019\u4e9b\u6b0a\u9650\uff1a apiVersion : rbac.authorization.k8s.io/v1beta1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default API \u00b6 Kubernetes Auth \u63d2\u4ef6\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002 \u4ee3\u78bc\u793a\u4f8b \u00b6 \u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684 Kubernetes auth \u65b9\u6cd5\u3002 package main import ( \"fmt\" \"os\" vault \"github.com/hashicorp/vault/api\" auth \"github.com/hashicorp/vault/api-docs/auth/kubernetes\" ) // Fetches a key-value secret (kv-v2) after authenticating to Vault with a Kubernetes service account. // For a more in-depth setup explanation, please see the relevant readme in the hashicorp/vault-examples repo. func getSecretWithKubernetesAuth () ( string , error ) { // If set, the VAULT_ADDR environment variable will be the address that // your pod uses to communicate with Vault. config := vault . DefaultConfig () // modify for more granular configuration client , err := vault . NewClient ( config ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Vault client: %w\" , err ) } // The service-account token will be read from the path where the token's // Kubernetes Secret is mounted. By default, Kubernetes will mount it to // /var/run/secrets/kubernetes.io/serviceaccount/token, but an administrator // may have configured it to be mounted elsewhere. // In that case, we'll use the option WithServiceAccountTokenPath to look // for the token there. k8sAuth , err := auth . NewKubernetesAuth ( \"dev-role-k8s\" , auth . WithServiceAccountTokenPath ( \"path/to/service-account-token\" ), ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Kubernetes auth method: %w\" , err ) } authInfo , err := client . Auth (). Login ( context . TODO (), k8sAuth ) if err != nil { return \"\" , fmt . Errorf ( \"unable to log in with Kubernetes auth: %w\" , err ) } if authInfo == nil { return \"\" , fmt . Errorf ( \"no auth info was returned after login\" ) } // get secret from Vault, from the default mount path for KV v2 in dev mode, \"secret\" secret , err := client . KVv2 ( \"secret\" ). Get ( context . Background (), \"creds\" ) if err != nil { return \"\" , fmt . Errorf ( \"unable to read secret: %w\" , err ) } // data map can contain more than one key-value pair, // in this case we're just grabbing one of them value , ok := secret . Data [ \"password\" ].( string ) if ! ok { return \"\" , fmt . Errorf ( \"value type assertion failed: %T %#v\" , secret . Data [ \"password\" ], secret . Data [ \"password\" ]) } return value , nil }","title":"Kubernetes"},{"location":"vault/docs/auth/kubernetes/#kubernetes-auth-method","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth/kubernetes kubernetes auth \u65b9\u6cd5\u53ef\u7528\u65bc\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service account)\u4ee4\u724c\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u9019\u7a2e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u53ef\u4ee5\u8f15\u9b06\u5730\u5c07 Vault \u4ee4\u724c\u5f15\u5165 Kubernetes Pod\u3002 \u60a8\u9084\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u901a\u904e JWT \u8eab\u4efd\u9a57\u8b49\u767b\u9304 \u3002\u8acb\u53c3\u95b1 \u5982\u4f55\u4f7f\u7528\u77ed\u671f Kubernetes \u4ee4\u724c \u90e8\u5206\uff0c\u4e86\u89e3\u60a8\u53ef\u80fd\u5e0c\u671b\u4f7f\u7528 JWT \u8eab\u4efd\u9a57\u8b49\u7684\u539f\u56e0\u4ee5\u53ca\u5b83\u8207 Kubernetes \u8eab\u4efd\u9a57\u8b49\u7684\u6bd4\u8f03\u3002 Info \u6ce8\u610f\uff1a\u5982\u679c\u60a8\u8981\u5347\u7d1a\u5230 Kubernetes v1.21+\uff0c\u8acb\u78ba\u4fdd\u914d\u7f6e\u9078\u9805 disable_iss_validation \u8a2d\u7f6e\u70ba true \u3002\u5047\u8a2d\u9ed8\u8a8d\u639b\u8f09\u8def\u5f91\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 vault read -field disable_iss_validation auth/kubernetes/config \u6aa2\u67e5\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684 Kubernetes 1.21 \u3002","title":"Kubernetes Auth Method"},{"location":"vault/docs/auth/kubernetes/#authentication","text":"","title":"Authentication"},{"location":"vault/docs/auth/kubernetes/#via-the-cli","text":"\u9ed8\u8a8d\u8def\u5f91\u662f /kubernetes \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u5728 CLI \u4e2d\u6307\u5b9a -path=/my-path \u3002 $ vault write auth/kubernetes/login role = demo jwt = ...","title":"Via the CLI"},{"location":"vault/docs/auth/kubernetes/#via-the-api","text":"\u9ed8\u8a8d\u7aef\u9ede\u662f auth/kubernetes/login \u3002\u5982\u679c\u5728\u4e0d\u540c\u7684\u8def\u5f91\u4e0a\u555f\u7528\u4e86\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u8acb\u4f7f\u7528\u8a72\u503c\u800c\u4e0d\u662f kubernetes\u3002 $ curl \\ --request POST \\ --data '{\"jwt\": \"<your service account jwt>\", \"role\": \"demo\"}' \\ http://127.0.0.1:8200/v1/auth/kubernetes/login \u97ff\u61c9\u5c07\u5728 auth.client_token \u5305\u542b\u4e00\u500b\u4ee4\u724c\uff1a { \"auth\" : { \"client_token\" : \"38fe9691-e623-7238-f618-c94d4e7bc674\" , \"accessor\" : \"78e87a38-84ed-2692-538f-ca8b9f400ab3\" , \"policies\" : [ \"default\" ], \"metadata\" : { \"role\" : \"demo\" , \"service_account_name\" : \"vault-auth\" , \"service_account_namespace\" : \"default\" , \"service_account_secret_name\" : \"vault-auth-token-pd21c\" , \"service_account_uid\" : \"aa9aa8ff-98d0-11e7-9bb7-0800276d99bf\" }, \"lease_duration\" : 2764800 , \"renewable\" : true } }","title":"Via the API"},{"location":"vault/docs/auth/kubernetes/#configuration","text":"\u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u5728 Vault\u3000\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531 Vault \u7ba1\u7406\u54e1\u6216\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff1a $ vault auth enable kubernetes \u4f7f\u7528 /config \u7aef\u9ede\u914d\u7f6e Vault \u4ee5\u8207 Kubernetes \u901a\u4fe1\u3002\u4f7f\u7528 kubectl cluster-info \u9a57\u8b49 Kubernetes \u4e3b\u6a5f\u5730\u5740\u548c TCP \u7aef\u53e3\u3002\u6709\u95dc\u53ef\u7528\u914d\u7f6e\u9078\u9805\u7684\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \"<your reviewer service account JWT>\" \\ kubernetes_host = https://192.168.99.100:<your TCP port or blank for 443 > \\ kubernetes_ca_cert = @ca.crt \u5275\u5efa name role\uff1a $ vault write auth/kubernetes/role/demo \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = default \\ ttl = 1h \u6b64\u89d2\u8272\u6388\u6b0a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-auth \u670d\u52d9\u5e33\u6236\uff0c\u4e26\u70ba\u5176\u63d0\u4f9b\u9ed8\u8a8d\u7b56\u7565\u3002 \u6709\u95dc\u914d\u7f6e\u9078\u9805\u7684\u5b8c\u6574\u5217\u8868\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002","title":"Configuration"},{"location":"vault/docs/auth/kubernetes/#kubernetes-121","text":"\u5f9e\u7248\u672c 1.21 \u958b\u59cb\uff0cKubernetes BoundServiceAccountTokenVolume \u529f\u80fd\u9ed8\u8a8d\u70ba\u555f\u7528\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0c\u9019\u6703\u4ee5\u5169\u7a2e\u5c0d Kubernetes \u8eab\u4efd\u9a57\u8b49\u5f88\u91cd\u8981\u7684\u65b9\u5f0f\u66f4\u6539\u639b\u8f09\u5230\u5bb9\u5668\u4e2d\u7684 JWT \u4ee4\u724c\uff1a \u5b83\u6709\u4e00\u500b\u904e\u671f\u6642\u9593\uff0c\u4e26\u4e14\u7d81\u5b9a\u5230 pod \u548c\u670d\u52d9\u5e33\u6236\u7684\u751f\u547d\u9031\u671f\u3002 JWT \u7684 iss \u8072\u660e\u7684\u503c\u53d6\u6c7a\u65bc\u96c6\u7fa4\u7684\u914d\u7f6e\u3002 \u914d\u7f6e token_reviewer_jwt \u9078\u9805\u6642\uff0c\u5c0d\u4ee4\u724c\u751f\u547d\u9031\u671f\u7684\u66f4\u6539\u5f88\u91cd\u8981\u3002\u5982\u679c\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0cKubernetes \u5c07\u5728 pod \u6216\u670d\u52d9\u5e33\u6236\u88ab\u522a\u9664\u6216\u904e\u671f\u6642\u9593\u904e\u5f8c\u7acb\u5373\u64a4\u92b7\u5b83\uff0c\u4e26\u4e14 Vault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API \u3002 \u70ba\u4e86\u97ff\u61c9 iss \u7684\u66f4\u6539\uff0cKubernetes auth \u5df2\u5728 Vault 1.9.0 \u4e2d\u66f4\u65b0\uff0c\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\u4e0d\u9a57\u8b49\u9812\u767c\u8005\u3002 Kubernetes API \u5728\u5be9\u67e5\u4ee4\u724c\u6642\u57f7\u884c\u76f8\u540c\u7684\u9a57\u8b49\uff0c\u56e0\u6b64\u5728 Vault \u7aef\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\u662f\u91cd\u8907\u7684\u5de5\u4f5c\u3002 \u5728\u4e0d\u7981\u7528 Vault \u7684\u9812\u767c\u8005\u9a57\u8b49\u7684\u60c5\u6cc1\u4e0b\uff0c\u55ae\u500b Kubernetes \u8eab\u4efd\u9a57\u8b49\u914d\u7f6e\u7121\u6cd5\u540c\u6642\u7528\u65bc Kubernetes 1.20 \u548c 1.21 \u7684\u9ed8\u8a8d\u639b\u8f09 pod \u4ee4\u724c\u3002\u8acb\u6ce8\u610f\uff0c\u5728 Vault 1.9 \u4e4b\u524d\u5275\u5efa\u7684\u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u5c07\u4fdd\u6301\u820a\u7684\u9ed8\u8a8d\u503c\uff0c\u60a8\u9700\u8981\u5728\u5c07 Kubernetes \u5347\u7d1a\u5230 1.21 \u4e4b\u524d\u986f\u5f0f\u8a2d\u7f6e disable_iss_validation=true \u3002\u5982\u679c\u60a8\u5e0c\u671b\u5728 Vault \u4e2d\u555f\u7528\u9812\u767c\u8005\u9a57\u8b49\uff0c\u8acb\u53c3\u95b1\u4e0b\u9762\u7684\u767c\u73fe\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u4ee5\u7372\u53d6\u6307\u5c0e\u3002","title":"Kubernetes 1.21"},{"location":"vault/docs/auth/kubernetes/#short-lived-kubernetes-tokens","text":"\u7576\u9ed8\u8a8d\u639b\u8f09\u7684 pod \u4ee4\u724c\u662f\u77ed\u66ab\u7684\u6642\uff0c\u6709\u5e7e\u7a2e\u4e0d\u540c\u7684\u65b9\u6cd5\u53ef\u4ee5\u70ba Kubernetes pod \u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\uff0c\u6bcf\u7a2e\u65b9\u6cd5\u90fd\u6709\u81ea\u5df1\u7684\u6b0a\u8861\u3002\u6b64\u8868\u7e3d\u7d50\u4e86\u9078\u9805\uff0c\u4e0b\u9762\u5c07\u66f4\u8a73\u7d30\u5730\u89e3\u91cb\u6bcf\u500b\u9078\u9805\u3002 Option All tokens are short-lived Can revoke tokens early Other considerations Use local token as reviewer JWT Yes Yes Requires Vault (1.9.3+) to be deployed on the Kubernetes cluster Use client JWT as reviewer JWT Yes Yes Operational overhead Use long-lived token as reviewer JWT No Yes Use JWT auth instead Yes No","title":"\u5982\u4f55\u514b\u670d short-lived Kubernetes tokens \u5e36\u4f86\u7684\u554f\u984c"},{"location":"vault/docs/auth/kubernetes/#use-local-service-account-token-as-the-reviewer-jwt","text":"\u5728 Kubernetes pod \u4e2d\u904b\u884c Vault \u6642\uff0c\u63a8\u85a6\u7684\u9078\u9805\u662f\u4f7f\u7528 pod \u7684\u672c\u5730\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 Vault \u5c07\u5b9a\u671f\u91cd\u65b0\u8b80\u53d6\u6587\u4ef6\u4ee5\u652f\u6301\u77ed\u671f\u4ee4\u724c\u3002\u8981\u4f7f\u7528\u672c\u5730\u4ee4\u724c\u548c CA \u8b49\u66f8\uff0c\u8acb\u5728\u914d\u7f6e auth \u65b9\u6cd5\u6642\u7701\u7565 token_reviewer_jwt \u548c kubernetes_ca_cert \u3002 Vault \u5c07\u5617\u8a66\u5206\u5225\u5f9e\u9ed8\u8a8d\u639b\u8f09\u6587\u4ef6\u593e /var/run/secrets/kubernetes.io/serviceaccount/ \u4e2d\u7684 token \u548c ca.crt \u52a0\u8f09\u5b83\u5011\u3002 $ vault write auth/kubernetes/config \\ kubernetes_host = https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT Warning \u6ce8\u610f\uff1a\u9700\u8981 Vault 1.9.3+\u3002\u5728\u65e9\u671f\u7248\u672c\u4e2d\uff0c\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u548c CA \u8b49\u66f8\u88ab\u8b80\u53d6\u4e00\u6b21\u4e26\u5b58\u5132\u5728 Vault \u5b58\u5132\u4e2d\u3002\u7576\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u904e\u671f\u6216\u88ab\u64a4\u92b7\u6642\uff0cVault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528 TokenReview API\uff0c\u4e26\u4e14\u5ba2\u6236\u7aef\u8eab\u4efd\u9a57\u8b49\u5c07\u5931\u6557\u3002","title":"Use local service account token as the reviewer JWT"},{"location":"vault/docs/auth/kubernetes/#use-the-vault-clients-jwt-as-the-reviewer-jwt","text":"\u914d\u7f6e Kubernetes auth \u6642\uff0c\u53ef\u4ee5\u7701\u7565 token_reviewer_jwt \uff0cVault \u5728\u8207 Kubernetes TokenReview API \u901a\u4fe1\u6642\u6703\u4f7f\u7528 Vault \u5ba2\u6236\u7aef\u7684 JWT \u4f5c\u70ba\u81ea\u5df1\u7684 auth token\u3002\u5982\u679c Vault \u5728 Kubernetes \u4e2d\u904b\u884c\uff0c\u60a8\u9084\u9700\u8981\u8a2d\u7f6e disable_local_ca_jwt=true \u3002 \u9019\u610f\u5473\u8457 Vault \u4e0d\u5b58\u5132\u4efb\u4f55 JWT \u4e26\u5141\u8a31\u60a8\u5728\u4efb\u4f55\u5730\u65b9\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4f46\u6703\u589e\u52a0\u4e00\u4e9b\u64cd\u4f5c\u958b\u92b7\u4f86\u7dad\u8b77\u60a8\u5e0c\u671b\u80fd\u5920\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u670d\u52d9\u5e33\u6236\u96c6\u4e0a\u7684\u96c6\u7fa4\u89d2\u8272\u7d81\u5b9a\u3002 Vault \u7684\u6bcf\u500b\u5ba2\u6236\u7aef\u90fd\u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl create clusterrolebinding vault-client-auth-delegator \\ --clusterrole = system:auth-delegator \\ --group = group1 \\ --serviceaccount = default:svcaccount1 \\ ...","title":"Use the Vault client's JWT as the reviewer JWT"},{"location":"vault/docs/auth/kubernetes/#continue-using-long-lived-tokens","text":"\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u8655\u7684\u8aaa\u660e\u5275\u5efa\u4e00\u500b\u9577\u671f\u5b58\u5728\u7684\u6a5f\u5bc6\u4e26\u5c07\u5176\u7528\u4f5c token_reviewer_jwt \u3002\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c vault \u670d\u52d9\u5e33\u6236 \u9700\u8981 system:auth-delegator ClusterRole\uff1a $ kubectl apply -f - <<EOF apiVersion: v1 kind: Secret metadata: name: vault-k8s-auth-secret annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u4f7f\u7528\u5b83\u53ef\u4ee5\u7dad\u8b77\u4ee5\u524d\u7684\u5de5\u4f5c\u6d41\u7a0b\uff0c\u4f46\u4e0d\u6703\u5f9e\u77ed\u671f\u4ee4\u724c\u7684\u6539\u9032\u5b89\u5168\u72c0\u614b\u4e2d\u53d7\u76ca\u3002","title":"Continue using long-lived tokens"},{"location":"vault/docs/auth/kubernetes/#use-jwt-auth","text":"Kubernetes auth \u5c08\u9580\u7528\u65bc\u4f7f\u7528 Kubernetes \u7684 TokenReview API \u3002\u4f46\u662f\uff0cKubernetes \u751f\u6210\u7684 JWT \u4ee4\u724c\u4e5f\u53ef\u4ee5\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u9a57\u8b49\u3002 JWT auth \u65b9\u6cd5\u6587\u6a94\u5305\u542b\u4f7f\u7528 Kubernetes \u4f5c\u70ba OIDC \u63d0\u4f9b\u7a0b\u5e8f\u8a2d\u7f6e JWT auth \u7684\u8aaa\u660e\u3002 \u6b64\u89e3\u6c7a\u65b9\u6848\u5141\u8a31\u60a8\u70ba\u6240\u6709\u5ba2\u6236\u7aef\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4e26\u4e14\u7121\u9700\u5be9\u67e5\u8005 JWT\u3002\u4f46\u662f\uff0c\u5ba2\u6236\u7aef\u4ee4\u724c\u5728\u5176 TTL \u5230\u671f\u4e4b\u524d\u4e0d\u80fd\u88ab\u64a4\u92b7\uff0c\u56e0\u6b64\u5efa\u8b70\u5728\u8a18\u4f4f\u8a72\u9650\u5236\u7684\u60c5\u6cc1\u4e0b\u4fdd\u6301 TTL \u8f03\u77ed\u3002","title":"Use JWT auth"},{"location":"vault/docs/auth/kubernetes/#service-account-issuer","text":"Info \u6ce8\u610f\uff1a\u5f9e Vault 1.9.0 \u958b\u59cb\uff0c disable_iss_validation \u548c issuer \u5df2\u88ab\u68c4\u7528\uff0c\u4e26\u4e14 disable_iss_validation \u7684\u9ed8\u8a8d\u503c\u5df2\u66f4\u6539\u70ba true \u4ee5\u7528\u65bc\u65b0\u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u639b\u8f09\u3002\u4ee5\u4e0b\u90e8\u5206\u50c5\u9069\u7528\u65bc\u60a8\u5df2\u8a2d\u7f6e disable_iss_validation=false \u6216\u5728 1.9 \u4e4b\u524d\u4f7f\u7528\u9ed8\u8a8d\u503c\u5275\u5efa\u639b\u8f09\uff0c\u4f46 disable_iss_validation=true \u662f\u6240\u6709 Vault \u7248\u672c\u7684\u65b0\u63a8\u85a6\u503c\u3002 Kubernetes 1.21+ \u96c6\u7fa4\u53ef\u80fd\u9700\u8981\u5c07\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u8a2d\u7f6e\u70ba\u8207 kube-apiserver \u7684 --service-account-issuer \u6a19\u8a8c\u76f8\u540c\u7684\u503c\u3002\u9019\u662f\u56e0\u70ba\u9019\u4e9b\u96c6\u7fa4\u7684\u670d\u52d9\u5e33\u6236 JWT \u53ef\u80fd\u5177\u6709\u7279\u5b9a\u65bc\u96c6\u7fa4\u672c\u8eab\u7684\u9812\u767c\u8005\uff0c\u800c\u4e0d\u662f\u820a\u9ed8\u8a8d\u7684 kubernetes/serviceaccount\u3002\u5982\u679c\u60a8\u7121\u6cd5\u76f4\u63a5\u6aa2\u67e5\u6b64\u503c\uff0c\u5247\u53ef\u4ee5\u904b\u884c\u4ee5\u4e0b\u547d\u4ee4\u4e26\u67e5\u627e iss \u5b57\u6bb5\u4ee5\u627e\u5230\u6240\u9700\u7684\u503c\uff1a echo '{\"apiVersion\": \"authentication.k8s.io/v1\", \"kind\": \"TokenRequest\"}' \\ | kubectl create -f- --raw /api/v1/namespaces/default/serviceaccounts/default/token \\ | jq -r '.status.token' \\ | cut -d . -f2 \\ | base64 -D \u5927\u591a\u6578\u96c6\u7fa4\u9084\u5c07\u5728 .well-known/openid-configuration \u7aef\u9ede\u4e0a\u63d0\u4f9b\u8a72\u4fe1\u606f\uff1a $ kubectl get --raw /.well-known/openid-configuration | jq -r .issuer \u7136\u5f8c\u5728\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u6642\u4f7f\u7528\u6b64\u503c\uff0c\u4f8b\u5982\uff1a $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_SERVICE_HOST : $KUBERNETES_SERVICE_PORT \" \\ issuer = \"\\\"test-aks-cluster-dns-d6cbb78e.hcp.uksouth.azmk8s.io\\\"\" { \"issuer\" : \"https://kubernetes.default.svc.cluster.local\" , \"jwks_uri\" : \"https://192.168.49.2:8443/openid/v1/jwks\" , \"response_types_supported\" : [ \"id_token\" ], \"subject_types_supported\" : [ \"public\" ], \"id_token_signing_alg_values_supported\" : [ \"RS256\" ] }","title":"\u767c\u73fe Service account issuer"},{"location":"vault/docs/auth/kubernetes/#kubernetes","text":"\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u8a2a\u554f Kubernetes TokenReview API \u4ee5\u9a57\u8b49\u63d0\u4f9b\u7684 JWT \u662f\u5426\u4ecd\u7136\u6709\u6548\u3002 Kubernetes \u61c9\u8a72\u4f7f\u7528 --service-account-lookup \u904b\u884c\u3002\u9019\u5728 Kubernetes 1.7 \u4e2d\u9ed8\u8a8d\u70ba true\u3002\u5426\u5247 Kubernetes \u4e2d\u5df2\u522a\u9664\u7684\u4ee4\u724c\u5c07\u7121\u6cd5\u6b63\u78ba\u64a4\u92b7\uff0c\u4e26\u4e14\u80fd\u5920\u901a\u904e\u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u6b64\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4e2d\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u9700\u8981\u6709\u6b0a\u8a2a\u554f TokenReview API \u3002\u5982\u679c Kubernetes \u914d\u7f6e\u70ba\u4f7f\u7528 RBAC \u89d2\u8272\uff0c\u5247\u61c9\u6388\u4e88\u670d\u52d9\u5e33\u6236\u8a2a\u554f\u6b64 API \u7684\u6b0a\u9650\u3002\u4ee5\u4e0b\u793a\u4f8b ClusterRoleBinding \u53ef\u7528\u65bc\u6388\u4e88\u9019\u4e9b\u6b0a\u9650\uff1a apiVersion : rbac.authorization.k8s.io/v1beta1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default","title":"\u914d\u7f6e Kubernetes"},{"location":"vault/docs/auth/kubernetes/#api","text":"Kubernetes Auth \u63d2\u4ef6\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 API \u6587\u6a94 \u3002","title":"API"},{"location":"vault/docs/auth/kubernetes/#_1","text":"\u4ee5\u4e0b\u793a\u4f8b\u6f14\u793a\u4e86\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684 Kubernetes auth \u65b9\u6cd5\u3002 package main import ( \"fmt\" \"os\" vault \"github.com/hashicorp/vault/api\" auth \"github.com/hashicorp/vault/api-docs/auth/kubernetes\" ) // Fetches a key-value secret (kv-v2) after authenticating to Vault with a Kubernetes service account. // For a more in-depth setup explanation, please see the relevant readme in the hashicorp/vault-examples repo. func getSecretWithKubernetesAuth () ( string , error ) { // If set, the VAULT_ADDR environment variable will be the address that // your pod uses to communicate with Vault. config := vault . DefaultConfig () // modify for more granular configuration client , err := vault . NewClient ( config ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Vault client: %w\" , err ) } // The service-account token will be read from the path where the token's // Kubernetes Secret is mounted. By default, Kubernetes will mount it to // /var/run/secrets/kubernetes.io/serviceaccount/token, but an administrator // may have configured it to be mounted elsewhere. // In that case, we'll use the option WithServiceAccountTokenPath to look // for the token there. k8sAuth , err := auth . NewKubernetesAuth ( \"dev-role-k8s\" , auth . WithServiceAccountTokenPath ( \"path/to/service-account-token\" ), ) if err != nil { return \"\" , fmt . Errorf ( \"unable to initialize Kubernetes auth method: %w\" , err ) } authInfo , err := client . Auth (). Login ( context . TODO (), k8sAuth ) if err != nil { return \"\" , fmt . Errorf ( \"unable to log in with Kubernetes auth: %w\" , err ) } if authInfo == nil { return \"\" , fmt . Errorf ( \"no auth info was returned after login\" ) } // get secret from Vault, from the default mount path for KV v2 in dev mode, \"secret\" secret , err := client . KVv2 ( \"secret\" ). Get ( context . Background (), \"creds\" ) if err != nil { return \"\" , fmt . Errorf ( \"unable to read secret: %w\" , err ) } // data map can contain more than one key-value pair, // in this case we're just grabbing one of them value , ok := secret . Data [ \"password\" ].( string ) if ! ok { return \"\" , fmt . Errorf ( \"value type assertion failed: %T %#v\" , secret . Data [ \"password\" ], secret . Data [ \"password\" ]) } return value , nil }","title":"\u4ee3\u78bc\u793a\u4f8b"},{"location":"vault/docs/auth/overview/","text":"Auth Methods \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u662f Vault \u4e2d\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7d44\u4ef6\uff0c\u8ca0\u8cac\u70ba\u7528\u6236\u5206\u914d\u8eab\u4efd\u548c\u4e00\u7d44\u7b56\u7565\u3002\u5728\u6240\u6709\u60c5\u6cc1\u4e0b\uff0cVault \u90fd\u6703\u5728\u8acb\u6c42\u8655\u7406\u904e\u7a0b\u4e2d\u5f37\u5236\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0cVault \u6703\u5c07\u8eab\u4efd\u9a57\u8b49\u7ba1\u7406\u548c\u6c7a\u7b56\u59d4\u8a17\u7d66\u76f8\u95dc\u914d\u7f6e\u7684\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982\uff0cAmazon Web Services\u3001GitHub\u3001Google Cloud Platform\u3001Kubernetes\u3001Microsoft Azure\u3001Okta ...\uff09\u3002 \u64c1\u6709\u591a\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f7f\u60a8\u80fd\u5920\u4f7f\u7528\u5c0d\u60a8\u7684 Vault \u548c\u60a8\u7684\u7d44\u7e54\u7684\u7528\u4f8b\u6700\u6709\u610f\u7fa9\u7684\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 \u4f8b\u5982\uff0c\u5728\u7a0b\u5f0f\u958b\u767c\u8005\u7684\u96fb\u8166\u4e0a\uff0c GitHub auth \u65b9\u6cd5\u6700\u5bb9\u6613\u4f7f\u7528\u3002\u4f46\u662f\u5c0d\u65bc\u670d\u52d9\u5668\uff0c AppRole \u65b9\u6cd5\u662f\u63a8\u85a6\u7684\u9078\u64c7\u3002 \u8981\u4e86\u89e3\u6709\u95dc\u8eab\u4efd\u9a57\u8b49\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u8eab\u4efd\u9a57\u8b49\u6982\u5ff5 \u9801\u9762\u3002 Enabling/Disabling Auth Methods \u00b6 \u53ef\u4ee5\u4f7f\u7528 CLI \u6216 API \u555f\u7528/\u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable userpass \u555f\u7528\u5f8c\uff0cauth \u65b9\u6cd5\u985e\u4f3c\u65bc secrets engines\uff1a\u5b83\u5011\u88ab\u639b\u8f09\u5728 Vault mount table \u4e2d\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u6a19\u6e96\u8b80/\u5beb API \u8a2a\u554f\u548c\u914d\u7f6e\u3002\u6240\u6709 auth \u65b9\u6cd5\u90fd\u5b89\u88dd\u5728 auth/ \u524d\u7db4\u4e0b\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cauth \u65b9\u6cd5\u639b\u8f09\u5230 auth/<type> \u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u555f\u7528\u201cgithub\u201d\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u5728 auth/github \u8207\u5b83\u9032\u884c\u4ea4\u4e92\u3002\u4f46\u662f\uff0c\u6b64\u8def\u5f91\u662f\u53ef\u81ea\u5b9a\u7fa9\u7684\uff0c\u5141\u8a31\u5177\u6709\u9ad8\u7d1a\u7528\u4f8b\u7684\u7528\u6236\u591a\u6b21\u639b\u8f09\u55ae\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable -path = my-login userpass \u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\uff0c\u901a\u904e\u8a72\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u6240\u6709\u7528\u6236\u90fd\u5c07\u81ea\u52d5\u8a3b\u92b7\u3002 External Auth Method Considerations \u00b6 \u7576\u4f7f\u7528\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982 GitHub\uff09\u6642\uff0cVault \u5c07\u5728\u8eab\u4efd\u9a57\u8b49\u6642\u8abf\u7528\u5916\u90e8\u670d\u52d9\u4ee5\u53ca\u4efb\u4f55\u5f8c\u7e8c\u4ee4\u724c\u66f4\u65b0\u3002\u9019\u610f\u5473\u8457\u5df2\u767c\u884c\u7684\u4ee4\u724c\u5728\u5176\u6574\u500b\u6709\u6548\u671f\u5167\u90fd\u6709\u6548\uff0c\u4e26\u4e14\u5728\u66f4\u65b0\u6216\u7528\u6236\u91cd\u65b0\u8eab\u4efd\u9a57\u8b49\u767c\u751f\u4e4b\u524d\u4e0d\u6703\u5931\u6548\u3002\u904b\u71df\u5546\u61c9\u78ba\u4fdd\u5728\u4f7f\u7528\u9019\u4e9b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\u8a2d\u7f6e\u9069\u7576\u7684 \u4ee4\u724c TTL \u3002","title":"Overview"},{"location":"vault/docs/auth/overview/#auth-methods","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u662f Vault \u4e2d\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7d44\u4ef6\uff0c\u8ca0\u8cac\u70ba\u7528\u6236\u5206\u914d\u8eab\u4efd\u548c\u4e00\u7d44\u7b56\u7565\u3002\u5728\u6240\u6709\u60c5\u6cc1\u4e0b\uff0cVault \u90fd\u6703\u5728\u8acb\u6c42\u8655\u7406\u904e\u7a0b\u4e2d\u5f37\u5236\u57f7\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u5728\u5927\u591a\u6578\u60c5\u6cc1\u4e0b\uff0cVault \u6703\u5c07\u8eab\u4efd\u9a57\u8b49\u7ba1\u7406\u548c\u6c7a\u7b56\u59d4\u8a17\u7d66\u76f8\u95dc\u914d\u7f6e\u7684\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982\uff0cAmazon Web Services\u3001GitHub\u3001Google Cloud Platform\u3001Kubernetes\u3001Microsoft Azure\u3001Okta ...\uff09\u3002 \u64c1\u6709\u591a\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4f7f\u60a8\u80fd\u5920\u4f7f\u7528\u5c0d\u60a8\u7684 Vault \u548c\u60a8\u7684\u7d44\u7e54\u7684\u7528\u4f8b\u6700\u6709\u610f\u7fa9\u7684\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 \u4f8b\u5982\uff0c\u5728\u7a0b\u5f0f\u958b\u767c\u8005\u7684\u96fb\u8166\u4e0a\uff0c GitHub auth \u65b9\u6cd5\u6700\u5bb9\u6613\u4f7f\u7528\u3002\u4f46\u662f\u5c0d\u65bc\u670d\u52d9\u5668\uff0c AppRole \u65b9\u6cd5\u662f\u63a8\u85a6\u7684\u9078\u64c7\u3002 \u8981\u4e86\u89e3\u6709\u95dc\u8eab\u4efd\u9a57\u8b49\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 \u8eab\u4efd\u9a57\u8b49\u6982\u5ff5 \u9801\u9762\u3002","title":"Auth Methods"},{"location":"vault/docs/auth/overview/#enablingdisabling-auth-methods","text":"\u53ef\u4ee5\u4f7f\u7528 CLI \u6216 API \u555f\u7528/\u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable userpass \u555f\u7528\u5f8c\uff0cauth \u65b9\u6cd5\u985e\u4f3c\u65bc secrets engines\uff1a\u5b83\u5011\u88ab\u639b\u8f09\u5728 Vault mount table \u4e2d\uff0c\u4e26\u4e14\u53ef\u4ee5\u4f7f\u7528\u6a19\u6e96\u8b80/\u5beb API \u8a2a\u554f\u548c\u914d\u7f6e\u3002\u6240\u6709 auth \u65b9\u6cd5\u90fd\u5b89\u88dd\u5728 auth/ \u524d\u7db4\u4e0b\u3002 \u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cauth \u65b9\u6cd5\u639b\u8f09\u5230 auth/<type> \u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u555f\u7528\u201cgithub\u201d\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u5728 auth/github \u8207\u5b83\u9032\u884c\u4ea4\u4e92\u3002\u4f46\u662f\uff0c\u6b64\u8def\u5f91\u662f\u53ef\u81ea\u5b9a\u7fa9\u7684\uff0c\u5141\u8a31\u5177\u6709\u9ad8\u7d1a\u7528\u4f8b\u7684\u7528\u6236\u591a\u6b21\u639b\u8f09\u55ae\u500b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 $ vault auth enable -path = my-login userpass \u7981\u7528\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\uff0c\u901a\u904e\u8a72\u65b9\u6cd5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u6240\u6709\u7528\u6236\u90fd\u5c07\u81ea\u52d5\u8a3b\u92b7\u3002","title":"Enabling/Disabling Auth Methods"},{"location":"vault/docs/auth/overview/#external-auth-method-considerations","text":"\u7576\u4f7f\u7528\u5916\u90e8\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff08\u4f8b\u5982 GitHub\uff09\u6642\uff0cVault \u5c07\u5728\u8eab\u4efd\u9a57\u8b49\u6642\u8abf\u7528\u5916\u90e8\u670d\u52d9\u4ee5\u53ca\u4efb\u4f55\u5f8c\u7e8c\u4ee4\u724c\u66f4\u65b0\u3002\u9019\u610f\u5473\u8457\u5df2\u767c\u884c\u7684\u4ee4\u724c\u5728\u5176\u6574\u500b\u6709\u6548\u671f\u5167\u90fd\u6709\u6548\uff0c\u4e26\u4e14\u5728\u66f4\u65b0\u6216\u7528\u6236\u91cd\u65b0\u8eab\u4efd\u9a57\u8b49\u767c\u751f\u4e4b\u524d\u4e0d\u6703\u5931\u6548\u3002\u904b\u71df\u5546\u61c9\u78ba\u4fdd\u5728\u4f7f\u7528\u9019\u4e9b\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6642\u8a2d\u7f6e\u9069\u7576\u7684 \u4ee4\u724c TTL \u3002","title":"External Auth Method Considerations"},{"location":"vault/docs/auth/userpass/","text":"Userpass Auth Method \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth/userpass userpass auth \u65b9\u6cd5\u5141\u8a31\u7528\u6236\u4f7f\u7528 username \u548c password \u7d44\u5408\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u7528\u6236\u540d/\u5bc6\u78bc\u7d44\u5408\u76f4\u63a5\u914d\u7f6e\u70ba\u4f7f\u7528 users/ \u8def\u5f91\u7684 auth \u65b9\u6cd5\u3002\u6b64\u65b9\u6cd5\u7121\u6cd5\u5f9e\u5916\u90e8\u6e90\u8b80\u53d6\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002 \u8a72\u65b9\u6cd5\u5c07\u6240\u6709\u63d0\u4ea4\u7684\u7528\u6236\u540d\u5c0f\u5beb\uff0c\u4f8b\u5982 Mary \u548c mary \u662f\u540c\u4e00\u500b\u4f7f\u7528\u8005\u3002 Authentication \u00b6 Via the CLI \u00b6 $ vault login -method = userpass \\ username = mitchellh \\ password = foo Via the API \u00b6 $ curl \\ --request POST \\ --data '{\"password\": \"foo\"}' \\ http://127.0.0.1:8200/v1/auth/userpass/login/mitchellh \u97ff\u61c9\u5c07\u5305\u542b auth.client_token \u4e2d\u7684\u4ee4\u724c\uff1a { \"lease_id\" : \"\" , \"renewable\" : false , \"lease_duration\" : 0 , \"data\" : null , \"auth\" : { \"client_token\" : \"c4f280f6-fdb2-18eb-89d3-589e2e834cdb\" , \"policies\" : [ \"admins\" ], \"metadata\" : { \"username\" : \"mitchellh\" }, \"lease_duration\" : 0 , \"renewable\" : false } } Configuration \u00b6 \u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531Vault \u7ba1\u7406\u54e1\u6216\u67d0\u7a2e\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 userpass auth \u65b9\u6cd5\uff1a $ vault auth enable userpass \u4f7f\u7528\u5141\u8a31\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u5c0d\u5176\u9032\u884c\u914d\u7f6e\uff1a $ vault write auth/userpass/users/mitchellh \\ password = foo \\ policies = admins \u9019\u5c07\u5275\u5efa\u4e00\u500b\u5bc6\u78bc\u70ba foo \u7684\u65b0\u7528\u6236 mitchellh \uff0c\u8a72\u7528\u6236\u5c07\u8207 admins \u7b56\u7565\u76f8\u95dc\u806f\u3002\u9019\u662f\u552f\u4e00\u9700\u8981\u7684\u914d\u7f6e\u3002 API \u00b6 Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 API \u3002","title":"Username & Password"},{"location":"vault/docs/auth/userpass/#userpass-auth-method","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth/userpass userpass auth \u65b9\u6cd5\u5141\u8a31\u7528\u6236\u4f7f\u7528 username \u548c password \u7d44\u5408\u5411 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u7528\u6236\u540d/\u5bc6\u78bc\u7d44\u5408\u76f4\u63a5\u914d\u7f6e\u70ba\u4f7f\u7528 users/ \u8def\u5f91\u7684 auth \u65b9\u6cd5\u3002\u6b64\u65b9\u6cd5\u7121\u6cd5\u5f9e\u5916\u90e8\u6e90\u8b80\u53d6\u7528\u6236\u540d\u548c\u5bc6\u78bc\u3002 \u8a72\u65b9\u6cd5\u5c07\u6240\u6709\u63d0\u4ea4\u7684\u7528\u6236\u540d\u5c0f\u5beb\uff0c\u4f8b\u5982 Mary \u548c mary \u662f\u540c\u4e00\u500b\u4f7f\u7528\u8005\u3002","title":"Userpass Auth Method"},{"location":"vault/docs/auth/userpass/#authentication","text":"","title":"Authentication"},{"location":"vault/docs/auth/userpass/#via-the-cli","text":"$ vault login -method = userpass \\ username = mitchellh \\ password = foo","title":"Via the CLI"},{"location":"vault/docs/auth/userpass/#via-the-api","text":"$ curl \\ --request POST \\ --data '{\"password\": \"foo\"}' \\ http://127.0.0.1:8200/v1/auth/userpass/login/mitchellh \u97ff\u61c9\u5c07\u5305\u542b auth.client_token \u4e2d\u7684\u4ee4\u724c\uff1a { \"lease_id\" : \"\" , \"renewable\" : false , \"lease_duration\" : 0 , \"data\" : null , \"auth\" : { \"client_token\" : \"c4f280f6-fdb2-18eb-89d3-589e2e834cdb\" , \"policies\" : [ \"admins\" ], \"metadata\" : { \"username\" : \"mitchellh\" }, \"lease_duration\" : 0 , \"renewable\" : false } }","title":"Via the API"},{"location":"vault/docs/auth/userpass/#configuration","text":"\u5728\u7528\u6236\u6216\u6a5f\u5668\u53ef\u4ee5\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u4e4b\u524d\uff0c\u5fc5\u9808\u63d0\u524d\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u9019\u4e9b\u6b65\u9a5f\u901a\u5e38\u7531Vault \u7ba1\u7406\u54e1\u6216\u67d0\u7a2e\u914d\u7f6e\u7ba1\u7406\u5de5\u5177\u5b8c\u6210\u3002 \u555f\u7528 userpass auth \u65b9\u6cd5\uff1a $ vault auth enable userpass \u4f7f\u7528\u5141\u8a31\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u7684\u7528\u6236\u5c0d\u5176\u9032\u884c\u914d\u7f6e\uff1a $ vault write auth/userpass/users/mitchellh \\ password = foo \\ policies = admins \u9019\u5c07\u5275\u5efa\u4e00\u500b\u5bc6\u78bc\u70ba foo \u7684\u65b0\u7528\u6236 mitchellh \uff0c\u8a72\u7528\u6236\u5c07\u8207 admins \u7b56\u7565\u76f8\u95dc\u806f\u3002\u9019\u662f\u552f\u4e00\u9700\u8981\u7684\u914d\u7f6e\u3002","title":"Configuration"},{"location":"vault/docs/auth/userpass/#api","text":"Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5177\u6709\u5b8c\u6574\u7684 HTTP API\u3002\u6709\u95dc\u66f4\u591a\u8a73\u7d30\u4fe1\u606f\uff0c\u8acb\u53c3\u95b1 Userpass \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 API \u3002","title":"API"},{"location":"vault/docs/platform/","text":"Kubernetes \u00b6 \u672c\u7ae0\u7bc0\u4ecb\u7d39\u5728 Kubernetes\u4e0a\u904b\u884c Vault\uff0c\u4e26\u89e3\u91cb\u67b6\u69cb\u3001\u914d\u7f6e\u3001\u5b89\u88dd\u548c\u5b89\u5168\u6ce8\u610f\u4e8b\u9805\u3002 Hashicorp \u5efa\u8b70\u4f7f\u7528\u5b98\u65b9 HashiCorp Vault Helm chart \u5c07 Vault \u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 Helm chart \u5141\u8a31\u7528\u6236\u4ee5\u5404\u7a2e\u914d\u7f6e\u90e8\u7f72 Vault\uff1a Dev \uff1a\u7528\u65bc\u6e2c\u8a66 Vault \u7684\u55ae\u500b\u5167\u5b58 Vault \u670d\u52d9\u5668 Standalone (default) \uff1a\u55ae\u500b Vault \u670d\u52d9\u5668\u4f7f\u7528\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u6301\u4e45\u4fdd\u5b58\u5230\u5377 High-Availability (HA) \uff1a\u4f7f\u7528 HA \u5b58\u5132\u5f8c\u7aef\uff08\u5982 Consul\uff09\u7684 Vault \u670d\u52d9\u5668\u96c6\u7fa4\uff08\u9ed8\u8a8d\uff09 External \uff1a\u4f9d\u8cf4\u65bc\u5916\u90e8 Vault \u670d\u52d9\u5668\u7684 Vault Agent Injector \u670d\u52d9\u5668 \u7528\u4f8b \u00b6 \u904b\u884c Vault Service \uff1aVault \u670d\u52d9\u5668\u96c6\u7fa4\u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\u3002\u9019\u53ef\u4ee5\u7531\u904b\u884c\u5728 Kubernetes \u5167\u90e8\u4ee5\u53ca Kubernetes \u5916\u90e8\u7684\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\uff0c\u53ea\u8981\u5b83\u5011\u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8207\u670d\u52d9\u5668\u901a\u4fe1\u3002 \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528\u8a31\u591a\u4e0d\u540c\u7684\u79d8\u5bc6\u5f15\u64ce\u548c\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5f9e Vault \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6\u3002 \u904b\u884c\u9ad8\u53ef\u7528 Vault \u670d\u52d9 \uff1a\u901a\u904e\u4f7f\u7528 pod \u95dc\u806f\u6027\u3001\u9ad8\u53ef\u7528\u5f8c\u7aef\u5b58\u5132\uff08\u5982 Consul\uff09\u548c\u81ea\u52d5\u89e3\u5c01\uff0cVault \u53ef\u4ee5\u6210\u70ba Kubernetes \u4e2d\u7684\u9ad8\u53ef\u7528\u670d\u52d9\u3002 \u52a0\u5bc6\u5373\u670d\u52d9 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u5229\u7528 Transit \u79d8\u5bc6\u5f15\u64ce\u4f5c\u70ba\u201c\u52a0\u5bc6\u5373\u670d\u52d9\u201d\u3002\u9019\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u5728\u5b58\u5132\u975c\u614b\u6578\u64da\u4e4b\u524d\u5c07\u52a0\u5bc6\u9700\u6c42\u5378\u8f09\u5230 Vault\u3002 Vault \u7684\u5be9\u8a08\u65e5\u8a8c \uff1a\u64cd\u4f5c\u54e1\u53ef\u4ee5\u9078\u64c7\u5c07\u6301\u4e45\u5377\u9644\u52a0\u5230 Vault \u96c6\u7fa4\uff0c\u8a72\u96c6\u7fa4\u53ef\u7528\u65bc\u5b58\u5132\u5be9\u8a08\u65e5\u8a8c\u3002 \u548c\u66f4\u591a\uff01 Vault \u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\uff0c\u56e0\u6b64\u9664\u4e86 Vault \u672c\u8eab\u63d0\u4f9b\u7684\u539f\u751f\u96c6\u6210\u4e4b\u5916\uff0c\u70ba Kubernetes \u69cb\u5efa\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u5177\u90fd\u53ef\u4ee5\u9078\u64c7\u5229\u7528 Vault\u3002 Vault \u6574\u5408 Kubernetes \u5165\u9580 \u00b6 \u6709\u5e7e\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u74b0\u5883\u4e2d\u5617\u8a66\u4f7f\u7528 Kubernetes \u7684 Vault\u3002 \u6307\u5357 \u00b6 \u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u5305\u62ec\u4f7f\u7528 Minikube \u548c\u5b98\u65b9 Helm chart\u5728\u672c\u5730\u5b89\u88dd Vault\u3002 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u63d0\u4f9b\u4e86\u4e00\u500b\u901a\u904e Kubernetes \u670d\u52d9\u548c\u7aef\u9ede\u4f7f Vault \u53ef\u8a2a\u554f\u7684\u793a\u4f8b\u3002 Kubernetes \u4e0a\u7684 Vault \u90e8\u7f72\u6307\u5357 \u6db5\u84cb\u4e86\u5b89\u88dd\u548c\u914d\u7f6e\u55ae\u500b HashiCorp Vault \u96c6\u7fa4\u6240\u9700\u7684\u6b65\u9a5f\uff0c\u5982 Kubernetes \u4e0a\u7684 Vault \u53c3\u8003\u67b6\u69cb \u4e2d\u5b9a\u7fa9\u7684\u90a3\u6a23\u3002","title":"Overview"},{"location":"vault/docs/platform/#kubernetes","text":"\u672c\u7ae0\u7bc0\u4ecb\u7d39\u5728 Kubernetes\u4e0a\u904b\u884c Vault\uff0c\u4e26\u89e3\u91cb\u67b6\u69cb\u3001\u914d\u7f6e\u3001\u5b89\u88dd\u548c\u5b89\u5168\u6ce8\u610f\u4e8b\u9805\u3002 Hashicorp \u5efa\u8b70\u4f7f\u7528\u5b98\u65b9 HashiCorp Vault Helm chart \u5c07 Vault \u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 Helm chart \u5141\u8a31\u7528\u6236\u4ee5\u5404\u7a2e\u914d\u7f6e\u90e8\u7f72 Vault\uff1a Dev \uff1a\u7528\u65bc\u6e2c\u8a66 Vault \u7684\u55ae\u500b\u5167\u5b58 Vault \u670d\u52d9\u5668 Standalone (default) \uff1a\u55ae\u500b Vault \u670d\u52d9\u5668\u4f7f\u7528\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u6301\u4e45\u4fdd\u5b58\u5230\u5377 High-Availability (HA) \uff1a\u4f7f\u7528 HA \u5b58\u5132\u5f8c\u7aef\uff08\u5982 Consul\uff09\u7684 Vault \u670d\u52d9\u5668\u96c6\u7fa4\uff08\u9ed8\u8a8d\uff09 External \uff1a\u4f9d\u8cf4\u65bc\u5916\u90e8 Vault \u670d\u52d9\u5668\u7684 Vault Agent Injector \u670d\u52d9\u5668","title":"Kubernetes"},{"location":"vault/docs/platform/#_1","text":"\u904b\u884c Vault Service \uff1aVault \u670d\u52d9\u5668\u96c6\u7fa4\u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\u3002\u9019\u53ef\u4ee5\u7531\u904b\u884c\u5728 Kubernetes \u5167\u90e8\u4ee5\u53ca Kubernetes \u5916\u90e8\u7684\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\uff0c\u53ea\u8981\u5b83\u5011\u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8207\u670d\u52d9\u5668\u901a\u4fe1\u3002 \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528\u8a31\u591a\u4e0d\u540c\u7684\u79d8\u5bc6\u5f15\u64ce\u548c\u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u5f9e Vault \u8a2a\u554f\u548c\u5b58\u5132\u79d8\u5bc6\u3002 \u904b\u884c\u9ad8\u53ef\u7528 Vault \u670d\u52d9 \uff1a\u901a\u904e\u4f7f\u7528 pod \u95dc\u806f\u6027\u3001\u9ad8\u53ef\u7528\u5f8c\u7aef\u5b58\u5132\uff08\u5982 Consul\uff09\u548c\u81ea\u52d5\u89e3\u5c01\uff0cVault \u53ef\u4ee5\u6210\u70ba Kubernetes \u4e2d\u7684\u9ad8\u53ef\u7528\u670d\u52d9\u3002 \u52a0\u5bc6\u5373\u670d\u52d9 \uff1a\u4f7f\u7528\u5728 Kubernetes \u4e2d\u904b\u884c\u7684 Vault \u670d\u52d9\u7684\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u5229\u7528 Transit \u79d8\u5bc6\u5f15\u64ce\u4f5c\u70ba\u201c\u52a0\u5bc6\u5373\u670d\u52d9\u201d\u3002\u9019\u5141\u8a31\u61c9\u7528\u7a0b\u5e8f\u5728\u5b58\u5132\u975c\u614b\u6578\u64da\u4e4b\u524d\u5c07\u52a0\u5bc6\u9700\u6c42\u5378\u8f09\u5230 Vault\u3002 Vault \u7684\u5be9\u8a08\u65e5\u8a8c \uff1a\u64cd\u4f5c\u54e1\u53ef\u4ee5\u9078\u64c7\u5c07\u6301\u4e45\u5377\u9644\u52a0\u5230 Vault \u96c6\u7fa4\uff0c\u8a72\u96c6\u7fa4\u53ef\u7528\u65bc\u5b58\u5132\u5be9\u8a08\u65e5\u8a8c\u3002 \u548c\u66f4\u591a\uff01 Vault \u53ef\u4ee5\u76f4\u63a5\u5728 Kubernetes \u4e0a\u904b\u884c\uff0c\u56e0\u6b64\u9664\u4e86 Vault \u672c\u8eab\u63d0\u4f9b\u7684\u539f\u751f\u96c6\u6210\u4e4b\u5916\uff0c\u70ba Kubernetes \u69cb\u5efa\u7684\u4efb\u4f55\u5176\u4ed6\u5de5\u5177\u90fd\u53ef\u4ee5\u9078\u64c7\u5229\u7528 Vault\u3002","title":"\u7528\u4f8b"},{"location":"vault/docs/platform/#vault-kubernetes","text":"\u6709\u5e7e\u7a2e\u65b9\u6cd5\u53ef\u4ee5\u5728\u4e0d\u540c\u7684\u74b0\u5883\u4e2d\u5617\u8a66\u4f7f\u7528 Kubernetes \u7684 Vault\u3002","title":"Vault \u6574\u5408 Kubernetes \u5165\u9580"},{"location":"vault/docs/platform/#_2","text":"\u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u5305\u62ec\u4f7f\u7528 Minikube \u548c\u5b98\u65b9 Helm chart\u5728\u672c\u5730\u5b89\u88dd Vault\u3002 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u63d0\u4f9b\u4e86\u4e00\u500b\u901a\u904e Kubernetes \u670d\u52d9\u548c\u7aef\u9ede\u4f7f Vault \u53ef\u8a2a\u554f\u7684\u793a\u4f8b\u3002 Kubernetes \u4e0a\u7684 Vault \u90e8\u7f72\u6307\u5357 \u6db5\u84cb\u4e86\u5b89\u88dd\u548c\u914d\u7f6e\u55ae\u500b HashiCorp Vault \u96c6\u7fa4\u6240\u9700\u7684\u6b65\u9a5f\uff0c\u5982 Kubernetes \u4e0a\u7684 Vault \u53c3\u8003\u67b6\u69cb \u4e2d\u5b9a\u7fa9\u7684\u90a3\u6a23\u3002","title":"\u6307\u5357"},{"location":"vault/docs/platform/injector-csi/","text":"Agent Injector \u5c0d\u6bd4 Vault CSI Provider \u00b6 \u672c\u6587\u6a94\u63a2\u8a0e\u4e86\u5c07 HashiCorp Vault \u8207 Kubernetes \u96c6\u6210\u7684\u5169\u7a2e\u4e0d\u540c\u65b9\u6cd5\u3002\u63d0\u4f9b\u7684\u4fe1\u606f\u9069\u7528\u65bc\u4e86\u89e3\u6a5f\u5bc6\u7ba1\u7406\u6982\u5ff5\u4e26\u719f\u6089 HashiCorp Vault \u548c Kubernetes \u7684 DevOps \u5f9e\u696d\u8005\u3002\u672c\u6587\u6a94\u9084\u63d0\u4f9b\u5be6\u7528\u6307\u5357\uff0c\u5e6b\u52a9\u60a8\u4e86\u89e3\u548c\u9078\u64c7\u6700\u9069\u5408\u60a8\u7684\u7528\u4f8b\u7684\u65b9\u6cd5\u3002 \u672c\u6587\u6a94\u4e2d\u5305\u542b\u7684\u4fe1\u606f\u8a73\u7d30\u8aaa\u660e\u4e86 Agent Injector \uff08\u5728\u672c\u6587\u6a94\u4e2d\u4e5f\u7a31\u70ba Vault Sidecar \u6216 Sidecar \uff09\u8207\u7528\u65bc\u96c6\u6210 Vault \u548c Kubernetes \u7684 Vault Container Storage Interface (CSI) \u63d0\u4f9b\u7a0b\u5e8f\u4e4b\u9593\u7684\u5c0d\u6bd4\u3002 Vault Sidecar Agent Injector \u00b6 Vault Sidecar Agent Injector \u5229\u7528 Sidecar \u6a21\u5f0f \u4f86\u66f4\u6539 pod \u898f\u7bc4\u4ee5\u5305\u542b\u4e00\u500b Vault Agent \u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u5c07 Vault \u6a5f\u5bc6\u5448\u73fe\u5230\u5171\u4eab\u5167\u5b58\u5377\u3002\u901a\u904e\u5c07\u79d8\u5bc6\u5448\u73fe\u7d66\u5171\u4eab\u5377\uff0cPod \u4e2d\u7684\u5bb9\u5668\u53ef\u4ee5\u4f7f\u7528 Vault \u79d8\u5bc6\u800c\u7121\u9700 Vault \u611f\u77e5\u3002\u6ce8\u5165\u5668\u662f\u4e00\u500b Kubernetes mutating webhook \u63a7\u5236\u5668\u3002\u5982\u679c\u8acb\u6c42\u4e2d\u5b58\u5728\u8a3b\u91cb\uff0c\u63a7\u5236\u5668\u6703\u6514\u622a pod \u4e8b\u4ef6\u4e26\u5c07\u8b8a\u66f4\u61c9\u7528\u65bc pod\u3002\u6b64\u529f\u80fd\u7531 Vault-k8s \u9805\u76ee\u63d0\u4f9b\uff0c\u53ef\u4ee5\u4f7f\u7528 Vault Helm \u5716\u8868\u81ea\u52d5\u5b89\u88dd\u548c\u914d\u7f6e\u3002","title":"Agent Injector \u5c0d\u6bd4 Vault CSI Provider"},{"location":"vault/docs/platform/injector-csi/#agent-injector-vault-csi-provider","text":"\u672c\u6587\u6a94\u63a2\u8a0e\u4e86\u5c07 HashiCorp Vault \u8207 Kubernetes \u96c6\u6210\u7684\u5169\u7a2e\u4e0d\u540c\u65b9\u6cd5\u3002\u63d0\u4f9b\u7684\u4fe1\u606f\u9069\u7528\u65bc\u4e86\u89e3\u6a5f\u5bc6\u7ba1\u7406\u6982\u5ff5\u4e26\u719f\u6089 HashiCorp Vault \u548c Kubernetes \u7684 DevOps \u5f9e\u696d\u8005\u3002\u672c\u6587\u6a94\u9084\u63d0\u4f9b\u5be6\u7528\u6307\u5357\uff0c\u5e6b\u52a9\u60a8\u4e86\u89e3\u548c\u9078\u64c7\u6700\u9069\u5408\u60a8\u7684\u7528\u4f8b\u7684\u65b9\u6cd5\u3002 \u672c\u6587\u6a94\u4e2d\u5305\u542b\u7684\u4fe1\u606f\u8a73\u7d30\u8aaa\u660e\u4e86 Agent Injector \uff08\u5728\u672c\u6587\u6a94\u4e2d\u4e5f\u7a31\u70ba Vault Sidecar \u6216 Sidecar \uff09\u8207\u7528\u65bc\u96c6\u6210 Vault \u548c Kubernetes \u7684 Vault Container Storage Interface (CSI) \u63d0\u4f9b\u7a0b\u5e8f\u4e4b\u9593\u7684\u5c0d\u6bd4\u3002","title":"Agent Injector \u5c0d\u6bd4 Vault CSI Provider"},{"location":"vault/docs/platform/injector-csi/#vault-sidecar-agent-injector","text":"Vault Sidecar Agent Injector \u5229\u7528 Sidecar \u6a21\u5f0f \u4f86\u66f4\u6539 pod \u898f\u7bc4\u4ee5\u5305\u542b\u4e00\u500b Vault Agent \u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u5c07 Vault \u6a5f\u5bc6\u5448\u73fe\u5230\u5171\u4eab\u5167\u5b58\u5377\u3002\u901a\u904e\u5c07\u79d8\u5bc6\u5448\u73fe\u7d66\u5171\u4eab\u5377\uff0cPod \u4e2d\u7684\u5bb9\u5668\u53ef\u4ee5\u4f7f\u7528 Vault \u79d8\u5bc6\u800c\u7121\u9700 Vault \u611f\u77e5\u3002\u6ce8\u5165\u5668\u662f\u4e00\u500b Kubernetes mutating webhook \u63a7\u5236\u5668\u3002\u5982\u679c\u8acb\u6c42\u4e2d\u5b58\u5728\u8a3b\u91cb\uff0c\u63a7\u5236\u5668\u6703\u6514\u622a pod \u4e8b\u4ef6\u4e26\u5c07\u8b8a\u66f4\u61c9\u7528\u65bc pod\u3002\u6b64\u529f\u80fd\u7531 Vault-k8s \u9805\u76ee\u63d0\u4f9b\uff0c\u53ef\u4ee5\u4f7f\u7528 Vault Helm \u5716\u8868\u81ea\u52d5\u5b89\u88dd\u548c\u914d\u7f6e\u3002","title":"Vault Sidecar Agent Injector"},{"location":"vault/docs/platform/helm/","text":"Helm Chart \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/platform/k8s/helm Vault Helm chart \u662f\u5728 Kubernetes \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Vault \u7684\u63a8\u85a6\u65b9\u5f0f\u3002\u9664\u4e86\u904b\u884c Vault \u672c\u8eab\u4e4b\u5916\uff0cHelm chart \u662f\u5b89\u88dd\u548c\u914d\u7f6e Vault \u4ee5\u8207\u5176\u4ed6\u670d\u52d9\u96c6\u6210\u7684\u4e3b\u8981\u65b9\u6cd5\uff0c\u4f8b\u5982 Consul for High Availability (HA) \u90e8\u7f72\u3002 \u6b64\u9801\u9762\u5047\u5b9a\u60a8\u5177\u6709 Helm \u7684\u4e00\u822c\u77e5\u8b58\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u3002\u4f7f\u7528 Helm \u5b89\u88dd Vault \u9700\u8981\u4f7f\u7528 Kubernetes \u96c6\u7fa4\u6b63\u78ba\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002 \u4f7f\u7528 Helm Chart \u00b6 \u5fc5\u9808\u5728\u60a8\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002\u8acb\u53c3\u95b1 Helm \u6587\u6a94 \u6216\u901a\u904e Helm \u5b89\u88dd\u5230 Minikube \u7684 Vault \u6559\u7a0b \u3002 \u8981\u4f7f\u7528 Helm chart\uff0c\u8acb\u6dfb\u52a0 Hashicorp helm \u5b58\u5132\u5eab\u4e26\u6aa2\u67e5\u60a8\u662f\u5426\u6709\u6b0a\u8a2a\u554f\u8a72 chart\uff1a $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories $ helm search repo hashicorp/vault NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart Warning \u91cd\u8981\u63d0\u793a\uff1aHelm chart \u6703\u6301\u7e8c\u88ab Hashicorpt \u958b\u767c\u66f4\u7248\u4e2d\u3002\u8acb\u59cb\u7d42\u5728\u5b89\u88dd\u6216\u5347\u7d1a\u4e4b\u524d\u4f7f\u7528 --dry-run \u904b\u884c Helm \u4ee5\u9a57\u8b49\u66f4\u6539\u3002 Helm chart \u7528\u6cd5\u793a\u4f8b\uff1a \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u5176\u4e2d pod \u4ee5\u540d\u7a31 vault \u70ba\u524d\u7db4\u3002 $ helm install vault hashicorp/vault \u5b89\u88dd\u7279\u5b9a\u7248\u672c\u7684 chart\u3002 # List the available releases $ helm search repo hashicorp/vault -l NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .20.0 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .19.0 1 .9.2 Official HashiCorp Vault Chart hashicorp/vault 0 .18.0 1 .9.0 Official HashiCorp Vault Chart hashicorp/vault 0 .17.1 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .17.0 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .16.1 1 .8.3 Official HashiCorp Vault Chart hashicorp/vault 0 .16.0 1 .8.2 Official HashiCorp Vault Chart hashicorp/vault 0 .15.0 1 .8.1 Official HashiCorp Vault Chart hashicorp/vault 0 .14.0 1 .8.0 Official HashiCorp Vault Chart hashicorp/vault 0 .13.0 1 .7.3 Official HashiCorp Vault Chart hashicorp/vault 0 .12.0 1 .7.2 Official HashiCorp Vault Chart hashicorp/vault 0 .11.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .10.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .9.1 1 .6.2 Official HashiCorp Vault Chart hashicorp/vault 0 .9.0 1 .6.1 Official HashiCorp Vault Chart hashicorp/vault 0 .8.0 1 .5.4 Official HashiCorp Vault Chart hashicorp/vault 0 .7.0 1 .5.2 Official HashiCorp Vault Chart hashicorp/vault 0 .6.0 1 .4.2 Official HashiCorp Vault Chart hashicorp/vault 0 .5.0 Install and configure Vault on Kubernetes. hashicorp/vault 0 .4.0 Install and configure Vault on Kubernetes. # Install version 0.20.1 $ helm install vault hashicorp/vault --version 0 .20.1 Info \u5b89\u5168\u8b66\u544a\uff1a\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cchart \u4ee5 standalong mode \u904b\u884c\u3002\u6b64\u6a21\u5f0f\u4f7f\u7528\u5e36\u6709\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u7684\u55ae\u500b Vault \u670d\u52d9\u5668\u3002\u9019\u662f\u4e00\u7a2e\u7c21\u6613\u5730\u5b89\u88dd\uff0c\u4e0d\u9069\u5408\u751f\u7522\u74b0\u5883\u7684\u8a2d\u7f6e\u3002\u5f37\u70c8\u5efa\u8b70\u4f7f\u7528\u9069\u7576\u4fdd\u8b77\u7684 Kubernetes \u96c6\u7fa4\uff0c\u4e86\u89e3\u53ef\u7528\u7684 \u914d\u7f6e\u9078\u9805 \uff0c\u4e26\u95b1\u8b80 \u751f\u7522\u90e8\u7f72\u6e05\u55ae \u3002 helm install \u547d\u4ee4\u63a5\u53d7\u53c3\u6578\u4ee5\u8986\u84cb\u4e8b\u5148\u5728 Helm \u4e2d\u5b9a\u7fa9\u7684\u9ed8\u8a8d\u914d\u7f6e\u503c\u3002 \u8986\u84cb server.dev.enabled \u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \u5728 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u8981\u8986\u84cb\u7684\u914d\u7f6e\u503c\uff1a override-values.yml server : ha : enabled : true replicas : 5 \u4f7f\u7528 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u4f86\u8986\u84cb\u9ed8\u8a8d\u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --values override-values.yml Dev mode \u00b6 Helm chart \u53ef\u4ee5\u904b\u884c\u4e00\u500b\u7528\u4f86\u8b93\u958b\u767c/\u9a57\u8b49\u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528 memory \u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 Info Dev mode\uff1a\u9019\u662f\u5b78\u7fd2\u548c\u6f14\u793a\u74b0\u5883\u7684\u7406\u60f3\u9078\u64c7\uff0c\u4f46\u4e0d\u63a8\u85a6\u7528\u65bc\u751f\u7522\u74b0\u5883\u3002 \u4f7f\u7528\u5728 Dev mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" Standalone mode \u00b6 Helm chart \u9ed8\u8a8d\u4ee5 Standalone mode \u5b89\u88dd Vault\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528\u6a94\u6848\u6587\u4ef6\u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 \u5728 Standalone mode \u4e0b\u5b89\u88dd Vault\u3002HA $ helm install vault hashicorp/vault HA mode \u00b6 Helm chart \u53ef\u4ee5\u5b89\u88dd\u4e00\u500b\u9ad8\u53ef\u7528\u6027 (HA) mode/ \u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e09\u500b\u5177\u6709\u4f7f\u7528 Consul \u5b58\u5132\u5f8c\u7aef\u7684 Vault \u670d\u52d9\u5668\u3002\u5efa\u8b70\u901a\u904e Consul Helm chart \u5b89\u88dd Consul\u3002 \u5728 HA mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.ha.enabled=true\" \u8acb\u53c3\u95b1 \u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u6559\u7a0b \uff0c\u4e86\u89e3\u5982\u4f55\u5728 HA \u6a21\u5f0f\u4e0b\u8a2d\u7f6e Consul \u548c Vault\u3002 External mode \u00b6 Helm chart\u53ef\u4ee5\u5728 External mode \u4e0b\u904b\u884c\u3002\u9019\u4e0d\u6703\u5b89\u88dd Vault \u670d\u52d9\u5668\uff0c\u800c\u662f\u4f9d\u8cf4\u65bc\u4e00\u500b\u5916\u90e8 Vault \u670d\u52d9\u5668\u3002 \u5728 External mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" \u8acb\u53c3\u95b1 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u6559\u7a0b\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528\u5916\u90e8 Vault\u3002 \u555f\u52d5 Vault UI \u00b6 Vault UI \u5df2\u555f\u7528\uff0c\u4f46\u51fa\u65bc\u5b89\u5168\u539f\u56e0\u672a\u4f5c\u70ba\u670d\u52d9\u516c\u958b\u3002 Vault UI \u4e5f\u53ef\u4ee5\u901a\u904e\u7aef\u53e3\u8f49\u767c\u6216\u901a\u904e ui \u914d\u7f6e\u503c \u516c\u958b\u3002 \u4f7f\u7528 port-forwarding \u516c\u958b Vault UI\uff1a $ kubectl port-forward vault-0 8200 :8200 Initialize \u8207 Unseal Vault \u00b6 \u5728\u4ee5 standalone \u6216 ha \u6a21\u5f0f\u5b89\u88dd Vault Helm chart\u5f8c\uff0c\u9700\u8981 \u521d\u59cb\u5316 \u5176\u4e2d\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u521d\u59cb\u5316\u6703\u751f\u6210 unseal \u6240\u6709 Vault \u670d\u52d9\u5668\u6240\u9700\u7684\u6191\u64da\u3002 CLI initialize \u8207 unseal \u00b6 \u67e5\u770b\u7576\u524d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 Vault pod\uff1a $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 0 /1 Running 0 1m49s vault-1 0 /1 Running 0 1m49s vault-2 0 /1 Running 0 1m49s \u4f7f\u7528\u9ed8\u8a8d\u7684\u5bc6\u9470\u5171\u4eab\u6578\u91cf\u548c\u9ed8\u8a8d\u7684\u5bc6\u9470\u95be\u503c\u521d\u59cb\u5316\u4e00\u500b Vault \u670d\u52d9\u5668\uff1a $ kubectl exec -ti vault-0 -- vault operator init Unseal Key 1 : MBFSDepD9E6whREc6Dj+k3pMaKJ6cCnCUWcySJQymObb Unseal Key 2 : zQj4v22k9ixegS+94HJwmIaWLBL3nZHe1i+b/wHz25fr Unseal Key 3 : 7dbPPeeGGW3SmeBFFo04peCKkXFuuyKc8b2DuntA4VU5 Unseal Key 4 : tLt+ME7Z7hYUATfWnuQdfCEgnKA2L173dptAwfmenCdf Unseal Key 5 : vYt9bxLr0+OzJ8m7c7cNMFj7nvdLljj0xWRbpLezFAI9 Initial Root Token: s.zJNwZlRrqISjyBHFMiEca6GF ##... Info \u8a18\u5f97\u5148\u628a\u9019\u4e9b\u89e3\u5c01\u7684\u5bc6\u9470\u8207 Root Token\u4fdd\u5b58\u8d77\u4f86 \u8f38\u51fa\u986f\u793a\u5bc6\u9470\u5171\u4eab\u548c\u751f\u6210\u7684\u521d\u59cb\u6839\u5bc6\u9470\u3002 \u4f7f\u7528\u5bc6\u9470\u5171\u4eab\u89e3\u5c01 Vault \u670d\u52d9\u5668\uff0c\u76f4\u5230\u6eff\u8db3\u5bc6\u9470\u95be\u503c\uff1a ## Unseal the first vault server until it reaches the key threshold $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 1 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 2 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 3 \u5c0d\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u91cd\u8907\u89e3\u5c01\u904e\u7a0b\u3002\u7576\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u90fd\u6253\u958b\u6642\uff0c\u5b83\u5011\u6703\u5831\u544a READY 1/1\u3002 $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 1m49s vault-1 1 /1 Running 0 1m49s vault-2 1 /1 Running 0 1m49s \u63a2\u91dd Probes \u00b6 \u63a2\u91dd Probes \u5c0d\u65bc\u5728 Kubernetes \u4e2d\u6aa2\u6e2c\u6545\u969c\u3001\u91cd\u65b0\u8abf\u5ea6\u548c\u4f7f\u7528 pod \u81f3\u95dc\u91cd\u8981\u3002 helm chart \u63d0\u4f9b\u53ef\u914d\u7f6e\u7684\u5c31\u7dd2\u548c\u6d3b\u8e8d\u5ea6\u63a2\u91dd\uff0c\u53ef\u4ee5\u91dd\u5c0d\u5404\u7a2e\u7528\u4f8b\u9032\u884c\u5b9a\u5236\u3002 \u53ef\u4ee5\u81ea\u5b9a\u7fa9 Vault \u7684 /sys/health \u7aef\u9ede\u4ee5\u66f4\u6539\u904b\u884c\u72c0\u6cc1\u6aa2\u67e5\u7684\u884c\u70ba\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u63a2\u91dd\u66f4\u6539 Vault \u5c31\u7dd2\u63a2\u6e2c\u4ee5\u986f\u793a Vault pod \u5df2\u6e96\u5099\u5c31\u7dd2\uff0c\u5373\u4f7f\u5b83\u5011\u4ecd\u672a\u521d\u59cb\u5316\u548c\u5bc6\u5c01\u72c0\u614b\uff1a server : readinessProbe : enabled : true path : '/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204' \u4f7f\u7528\u9019\u500b\u5b9a\u5236\u7684\u63a2\u91dd\uff0c\u4e00\u65e6 pod \u6e96\u5099\u597d\u9032\u884c\u5176\u4ed6\u8a2d\u7f6e\uff0cpostStart \u8173\u672c\u5c31\u53ef\u4ee5\u81ea\u52d5\u904b\u884c\u3002 \u4fdd\u8b77\u654f\u611f\u7684 Vault \u914d\u7f6e\u8cc7\u8a0a \u00b6 Vault Helm \u6703\u5728\u5b89\u88dd Vault \u7684\u904e\u7a0b\u4e2d\u751f\u6210\u4e00\u4f6a Vault \u914d\u7f6e\u6587\u4ef6\uff0c\u4e26\u5c07\u8a72\u6587\u4ef6\u5b58\u5132\u5728 Kubernetes configmap \u4e2d\u3002\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u80fd\u5305\u542b\u4e86\u4e00\u4e9b\u654f\u611f\u6578\u64da\u914d\u7f6e\u8cc7\u8a0a\uff0c\u4e26\u4e14\u4e00\u65e6\u5728 Kubernetes \u4e2d\u5275\u5efa\u4e4b\u5f8c\u5c31\u4e0d\u6703\u88ab\u975c\u614b\u52a0\u5bc6\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u5411 Vault Helm \u6dfb\u52a0\u984d\u5916\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4ee5\u4fdd\u8b77\u654f\u611f\u914d\u7f6e\u4e0d\u4f7f\u7528 Kubernetes \u6a5f\u5bc6\u4ee5\u975c\u614b\u660e\u6587\u5f62\u5f0f\u51fa\u73fe\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u555f\u52d5\u671f\u9593 Vault \u52a0\u8f09\u7684\u654f\u611f\u8a2d\u7f6e\u5275\u5efa\u90e8\u5206 Vault \u914d\u7f6e\uff1a config.hcl storage \"mysql\" { username = \"user1234\" password = \"secret123!\" database = \"vault\" } \u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u5305\u542b\u6b64\u90e8\u5206\u914d\u7f6e\u7684 Kubernetes secret\uff1a $ kubectl create secret generic vault-storage-config \\ --from-file = config.hcl \u6700\u5f8c\uff0c\u5c07\u6b64 secret \u639b\u8f09\u70ba\u4e00\u500b\u984d\u5916\u7684 volume\uff0c\u4e26\u5728 Vault \u555f\u52d5\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e00\u500b\u984d\u5916\u7684 -config \u6a19\u8a8c\uff1a $ helm install vault hashicorp/vault \\ --set = 'server.volumes[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumes[0].secret.defaultMode=420' \\ --set = 'server.volumes[0].secret.secretName=vault-storage-config' \\ --set = 'server.volumeMounts[0].mountPath=/vault/userconfig/vault-storage-config' \\ --set = 'server.volumeMounts[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumeMounts[0].readOnly=true' \\ --set = 'server.extraArgs=-config=/vault/userconfig/vault-storage-config/config.hcl'","title":"Overview"},{"location":"vault/docs/platform/helm/#helm-chart","text":"\u539f\u6587: https://www.vaultproject.io/docs/platform/k8s/helm Vault Helm chart \u662f\u5728 Kubernetes \u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Vault \u7684\u63a8\u85a6\u65b9\u5f0f\u3002\u9664\u4e86\u904b\u884c Vault \u672c\u8eab\u4e4b\u5916\uff0cHelm chart \u662f\u5b89\u88dd\u548c\u914d\u7f6e Vault \u4ee5\u8207\u5176\u4ed6\u670d\u52d9\u96c6\u6210\u7684\u4e3b\u8981\u65b9\u6cd5\uff0c\u4f8b\u5982 Consul for High Availability (HA) \u90e8\u7f72\u3002 \u6b64\u9801\u9762\u5047\u5b9a\u60a8\u5177\u6709 Helm \u7684\u4e00\u822c\u77e5\u8b58\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528\u5b83\u3002\u4f7f\u7528 Helm \u5b89\u88dd Vault \u9700\u8981\u4f7f\u7528 Kubernetes \u96c6\u7fa4\u6b63\u78ba\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002","title":"Helm Chart"},{"location":"vault/docs/platform/helm/#helm-chart_1","text":"\u5fc5\u9808\u5728\u60a8\u7684\u6a5f\u5668\u4e0a\u5b89\u88dd\u548c\u914d\u7f6e Helm\u3002\u8acb\u53c3\u95b1 Helm \u6587\u6a94 \u6216\u901a\u904e Helm \u5b89\u88dd\u5230 Minikube \u7684 Vault \u6559\u7a0b \u3002 \u8981\u4f7f\u7528 Helm chart\uff0c\u8acb\u6dfb\u52a0 Hashicorp helm \u5b58\u5132\u5eab\u4e26\u6aa2\u67e5\u60a8\u662f\u5426\u6709\u6b0a\u8a2a\u554f\u8a72 chart\uff1a $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories $ helm search repo hashicorp/vault NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart Warning \u91cd\u8981\u63d0\u793a\uff1aHelm chart \u6703\u6301\u7e8c\u88ab Hashicorpt \u958b\u767c\u66f4\u7248\u4e2d\u3002\u8acb\u59cb\u7d42\u5728\u5b89\u88dd\u6216\u5347\u7d1a\u4e4b\u524d\u4f7f\u7528 --dry-run \u904b\u884c Helm \u4ee5\u9a57\u8b49\u66f4\u6539\u3002 Helm chart \u7528\u6cd5\u793a\u4f8b\uff1a \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u5176\u4e2d pod \u4ee5\u540d\u7a31 vault \u70ba\u524d\u7db4\u3002 $ helm install vault hashicorp/vault \u5b89\u88dd\u7279\u5b9a\u7248\u672c\u7684 chart\u3002 # List the available releases $ helm search repo hashicorp/vault -l NAME CHART VERSION APP VERSION DESCRIPTION hashicorp/vault 0 .20.1 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .20.0 1 .10.3 Official HashiCorp Vault Chart hashicorp/vault 0 .19.0 1 .9.2 Official HashiCorp Vault Chart hashicorp/vault 0 .18.0 1 .9.0 Official HashiCorp Vault Chart hashicorp/vault 0 .17.1 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .17.0 1 .8.4 Official HashiCorp Vault Chart hashicorp/vault 0 .16.1 1 .8.3 Official HashiCorp Vault Chart hashicorp/vault 0 .16.0 1 .8.2 Official HashiCorp Vault Chart hashicorp/vault 0 .15.0 1 .8.1 Official HashiCorp Vault Chart hashicorp/vault 0 .14.0 1 .8.0 Official HashiCorp Vault Chart hashicorp/vault 0 .13.0 1 .7.3 Official HashiCorp Vault Chart hashicorp/vault 0 .12.0 1 .7.2 Official HashiCorp Vault Chart hashicorp/vault 0 .11.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .10.0 1 .7.0 Official HashiCorp Vault Chart hashicorp/vault 0 .9.1 1 .6.2 Official HashiCorp Vault Chart hashicorp/vault 0 .9.0 1 .6.1 Official HashiCorp Vault Chart hashicorp/vault 0 .8.0 1 .5.4 Official HashiCorp Vault Chart hashicorp/vault 0 .7.0 1 .5.2 Official HashiCorp Vault Chart hashicorp/vault 0 .6.0 1 .4.2 Official HashiCorp Vault Chart hashicorp/vault 0 .5.0 Install and configure Vault on Kubernetes. hashicorp/vault 0 .4.0 Install and configure Vault on Kubernetes. # Install version 0.20.1 $ helm install vault hashicorp/vault --version 0 .20.1 Info \u5b89\u5168\u8b66\u544a\uff1a\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cchart \u4ee5 standalong mode \u904b\u884c\u3002\u6b64\u6a21\u5f0f\u4f7f\u7528\u5e36\u6709\u6587\u4ef6\u5b58\u5132\u5f8c\u7aef\u7684\u55ae\u500b Vault \u670d\u52d9\u5668\u3002\u9019\u662f\u4e00\u7a2e\u7c21\u6613\u5730\u5b89\u88dd\uff0c\u4e0d\u9069\u5408\u751f\u7522\u74b0\u5883\u7684\u8a2d\u7f6e\u3002\u5f37\u70c8\u5efa\u8b70\u4f7f\u7528\u9069\u7576\u4fdd\u8b77\u7684 Kubernetes \u96c6\u7fa4\uff0c\u4e86\u89e3\u53ef\u7528\u7684 \u914d\u7f6e\u9078\u9805 \uff0c\u4e26\u95b1\u8b80 \u751f\u7522\u90e8\u7f72\u6e05\u55ae \u3002 helm install \u547d\u4ee4\u63a5\u53d7\u53c3\u6578\u4ee5\u8986\u84cb\u4e8b\u5148\u5728 Helm \u4e2d\u5b9a\u7fa9\u7684\u9ed8\u8a8d\u914d\u7f6e\u503c\u3002 \u8986\u84cb server.dev.enabled \u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \u5728 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u8981\u8986\u84cb\u7684\u914d\u7f6e\u503c\uff1a override-values.yml server : ha : enabled : true replicas : 5 \u4f7f\u7528 override-values.yml \u6587\u4ef6\u4e2d\u7684\u8a2d\u5b9a\u4f86\u8986\u84cb\u9ed8\u8a8d\u914d\u7f6e\u503c\uff1a $ helm install vault hashicorp/vault \\ --values override-values.yml","title":"\u4f7f\u7528 Helm Chart"},{"location":"vault/docs/platform/helm/#dev-mode","text":"Helm chart \u53ef\u4ee5\u904b\u884c\u4e00\u500b\u7528\u4f86\u8b93\u958b\u767c/\u9a57\u8b49\u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528 memory \u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 Info Dev mode\uff1a\u9019\u662f\u5b78\u7fd2\u548c\u6f14\u793a\u74b0\u5883\u7684\u7406\u60f3\u9078\u64c7\uff0c\u4f46\u4e0d\u63a8\u85a6\u7528\u65bc\u751f\u7522\u74b0\u5883\u3002 \u4f7f\u7528\u5728 Dev mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\"","title":"Dev mode"},{"location":"vault/docs/platform/helm/#standalone-mode","text":"Helm chart \u9ed8\u8a8d\u4ee5 Standalone mode \u5b89\u88dd Vault\u3002\u9019\u5c07\u5b89\u88dd\u4e00\u500b\u4f7f\u7528\u6a94\u6848\u6587\u4ef6\u4f5c\u70ba\u5f8c\u7aef\u5b58\u5132\u7684 Vault \u670d\u52d9\u5668\u3002 \u5728 Standalone mode \u4e0b\u5b89\u88dd Vault\u3002HA $ helm install vault hashicorp/vault","title":"Standalone mode"},{"location":"vault/docs/platform/helm/#ha-mode","text":"Helm chart \u53ef\u4ee5\u5b89\u88dd\u4e00\u500b\u9ad8\u53ef\u7528\u6027 (HA) mode/ \u7684 Vault \u670d\u52d9\u5668\u3002\u9019\u5c07\u5b89\u88dd\u4e09\u500b\u5177\u6709\u4f7f\u7528 Consul \u5b58\u5132\u5f8c\u7aef\u7684 Vault \u670d\u52d9\u5668\u3002\u5efa\u8b70\u901a\u904e Consul Helm chart \u5b89\u88dd Consul\u3002 \u5728 HA mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"server.ha.enabled=true\" \u8acb\u53c3\u95b1 \u901a\u904e Helm \u5c07 Vault \u5b89\u88dd\u5230 Minikube \u6559\u7a0b \uff0c\u4e86\u89e3\u5982\u4f55\u5728 HA \u6a21\u5f0f\u4e0b\u8a2d\u7f6e Consul \u548c Vault\u3002","title":"HA mode"},{"location":"vault/docs/platform/helm/#external-mode","text":"Helm chart\u53ef\u4ee5\u5728 External mode \u4e0b\u904b\u884c\u3002\u9019\u4e0d\u6703\u5b89\u88dd Vault \u670d\u52d9\u5668\uff0c\u800c\u662f\u4f9d\u8cf4\u65bc\u4e00\u500b\u5916\u90e8 Vault \u670d\u52d9\u5668\u3002 \u5728 External mode \u4e0b\u5b89\u88dd Vault\u3002 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" \u8acb\u53c3\u95b1 \u5c07 Kubernetes \u96c6\u7fa4\u8207\u5916\u90e8 Vault \u96c6\u6210 \u6559\u7a0b\uff0c\u4e86\u89e3\u5982\u4f55\u5728 Kubernetes \u96c6\u7fa4\u4e2d\u4f7f\u7528\u5916\u90e8 Vault\u3002","title":"External mode"},{"location":"vault/docs/platform/helm/#vault-ui","text":"Vault UI \u5df2\u555f\u7528\uff0c\u4f46\u51fa\u65bc\u5b89\u5168\u539f\u56e0\u672a\u4f5c\u70ba\u670d\u52d9\u516c\u958b\u3002 Vault UI \u4e5f\u53ef\u4ee5\u901a\u904e\u7aef\u53e3\u8f49\u767c\u6216\u901a\u904e ui \u914d\u7f6e\u503c \u516c\u958b\u3002 \u4f7f\u7528 port-forwarding \u516c\u958b Vault UI\uff1a $ kubectl port-forward vault-0 8200 :8200","title":"\u555f\u52d5 Vault UI"},{"location":"vault/docs/platform/helm/#initialize-unseal-vault","text":"\u5728\u4ee5 standalone \u6216 ha \u6a21\u5f0f\u5b89\u88dd Vault Helm chart\u5f8c\uff0c\u9700\u8981 \u521d\u59cb\u5316 \u5176\u4e2d\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u521d\u59cb\u5316\u6703\u751f\u6210 unseal \u6240\u6709 Vault \u670d\u52d9\u5668\u6240\u9700\u7684\u6191\u64da\u3002","title":"Initialize \u8207 Unseal Vault"},{"location":"vault/docs/platform/helm/#cli-initialize-unseal","text":"\u67e5\u770b\u7576\u524d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 Vault pod\uff1a $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 0 /1 Running 0 1m49s vault-1 0 /1 Running 0 1m49s vault-2 0 /1 Running 0 1m49s \u4f7f\u7528\u9ed8\u8a8d\u7684\u5bc6\u9470\u5171\u4eab\u6578\u91cf\u548c\u9ed8\u8a8d\u7684\u5bc6\u9470\u95be\u503c\u521d\u59cb\u5316\u4e00\u500b Vault \u670d\u52d9\u5668\uff1a $ kubectl exec -ti vault-0 -- vault operator init Unseal Key 1 : MBFSDepD9E6whREc6Dj+k3pMaKJ6cCnCUWcySJQymObb Unseal Key 2 : zQj4v22k9ixegS+94HJwmIaWLBL3nZHe1i+b/wHz25fr Unseal Key 3 : 7dbPPeeGGW3SmeBFFo04peCKkXFuuyKc8b2DuntA4VU5 Unseal Key 4 : tLt+ME7Z7hYUATfWnuQdfCEgnKA2L173dptAwfmenCdf Unseal Key 5 : vYt9bxLr0+OzJ8m7c7cNMFj7nvdLljj0xWRbpLezFAI9 Initial Root Token: s.zJNwZlRrqISjyBHFMiEca6GF ##... Info \u8a18\u5f97\u5148\u628a\u9019\u4e9b\u89e3\u5c01\u7684\u5bc6\u9470\u8207 Root Token\u4fdd\u5b58\u8d77\u4f86 \u8f38\u51fa\u986f\u793a\u5bc6\u9470\u5171\u4eab\u548c\u751f\u6210\u7684\u521d\u59cb\u6839\u5bc6\u9470\u3002 \u4f7f\u7528\u5bc6\u9470\u5171\u4eab\u89e3\u5c01 Vault \u670d\u52d9\u5668\uff0c\u76f4\u5230\u6eff\u8db3\u5bc6\u9470\u95be\u503c\uff1a ## Unseal the first vault server until it reaches the key threshold $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 1 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 2 $ kubectl exec -ti vault-0 -- vault operator unseal # ... Unseal Key 3 \u5c0d\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u91cd\u8907\u89e3\u5c01\u904e\u7a0b\u3002\u7576\u6240\u6709 Vault \u670d\u52d9\u5668 pod \u90fd\u6253\u958b\u6642\uff0c\u5b83\u5011\u6703\u5831\u544a READY 1/1\u3002 $ kubectl get pods -l app.kubernetes.io/name = vault NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 1m49s vault-1 1 /1 Running 0 1m49s vault-2 1 /1 Running 0 1m49s","title":"CLI initialize \u8207 unseal"},{"location":"vault/docs/platform/helm/#probes","text":"\u63a2\u91dd Probes \u5c0d\u65bc\u5728 Kubernetes \u4e2d\u6aa2\u6e2c\u6545\u969c\u3001\u91cd\u65b0\u8abf\u5ea6\u548c\u4f7f\u7528 pod \u81f3\u95dc\u91cd\u8981\u3002 helm chart \u63d0\u4f9b\u53ef\u914d\u7f6e\u7684\u5c31\u7dd2\u548c\u6d3b\u8e8d\u5ea6\u63a2\u91dd\uff0c\u53ef\u4ee5\u91dd\u5c0d\u5404\u7a2e\u7528\u4f8b\u9032\u884c\u5b9a\u5236\u3002 \u53ef\u4ee5\u81ea\u5b9a\u7fa9 Vault \u7684 /sys/health \u7aef\u9ede\u4ee5\u66f4\u6539\u904b\u884c\u72c0\u6cc1\u6aa2\u67e5\u7684\u884c\u70ba\u3002\u4f8b\u5982\uff0c\u6211\u5011\u53ef\u4ee5\u4f7f\u7528\u4ee5\u4e0b\u63a2\u91dd\u66f4\u6539 Vault \u5c31\u7dd2\u63a2\u6e2c\u4ee5\u986f\u793a Vault pod \u5df2\u6e96\u5099\u5c31\u7dd2\uff0c\u5373\u4f7f\u5b83\u5011\u4ecd\u672a\u521d\u59cb\u5316\u548c\u5bc6\u5c01\u72c0\u614b\uff1a server : readinessProbe : enabled : true path : '/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204' \u4f7f\u7528\u9019\u500b\u5b9a\u5236\u7684\u63a2\u91dd\uff0c\u4e00\u65e6 pod \u6e96\u5099\u597d\u9032\u884c\u5176\u4ed6\u8a2d\u7f6e\uff0cpostStart \u8173\u672c\u5c31\u53ef\u4ee5\u81ea\u52d5\u904b\u884c\u3002","title":"\u63a2\u91dd Probes"},{"location":"vault/docs/platform/helm/#vault","text":"Vault Helm \u6703\u5728\u5b89\u88dd Vault \u7684\u904e\u7a0b\u4e2d\u751f\u6210\u4e00\u4f6a Vault \u914d\u7f6e\u6587\u4ef6\uff0c\u4e26\u5c07\u8a72\u6587\u4ef6\u5b58\u5132\u5728 Kubernetes configmap \u4e2d\u3002\u5728\u914d\u7f6e\u6587\u4ef6\u4e2d\u53ef\u80fd\u5305\u542b\u4e86\u4e00\u4e9b\u654f\u611f\u6578\u64da\u914d\u7f6e\u8cc7\u8a0a\uff0c\u4e26\u4e14\u4e00\u65e6\u5728 Kubernetes \u4e2d\u5275\u5efa\u4e4b\u5f8c\u5c31\u4e0d\u6703\u88ab\u975c\u614b\u52a0\u5bc6\u3002 \u4ee5\u4e0b\u793a\u4f8b\u5c55\u793a\u77ad\u5982\u4f55\u5411 Vault Helm \u6dfb\u52a0\u984d\u5916\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u4ee5\u4fdd\u8b77\u654f\u611f\u914d\u7f6e\u4e0d\u4f7f\u7528 Kubernetes \u6a5f\u5bc6\u4ee5\u975c\u614b\u660e\u6587\u5f62\u5f0f\u51fa\u73fe\u3002 \u9996\u5148\uff0c\u4f7f\u7528\u555f\u52d5\u671f\u9593 Vault \u52a0\u8f09\u7684\u654f\u611f\u8a2d\u7f6e\u5275\u5efa\u90e8\u5206 Vault \u914d\u7f6e\uff1a config.hcl storage \"mysql\" { username = \"user1234\" password = \"secret123!\" database = \"vault\" } \u63a5\u4e0b\u4f86\uff0c\u5275\u5efa\u4e00\u500b\u5305\u542b\u6b64\u90e8\u5206\u914d\u7f6e\u7684 Kubernetes secret\uff1a $ kubectl create secret generic vault-storage-config \\ --from-file = config.hcl \u6700\u5f8c\uff0c\u5c07\u6b64 secret \u639b\u8f09\u70ba\u4e00\u500b\u984d\u5916\u7684 volume\uff0c\u4e26\u5728 Vault \u555f\u52d5\u547d\u4ee4\u4e2d\u6dfb\u52a0\u4e00\u500b\u984d\u5916\u7684 -config \u6a19\u8a8c\uff1a $ helm install vault hashicorp/vault \\ --set = 'server.volumes[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumes[0].secret.defaultMode=420' \\ --set = 'server.volumes[0].secret.secretName=vault-storage-config' \\ --set = 'server.volumeMounts[0].mountPath=/vault/userconfig/vault-storage-config' \\ --set = 'server.volumeMounts[0].name=userconfig-vault-storage-config' \\ --set = 'server.volumeMounts[0].readOnly=true' \\ --set = 'server.extraArgs=-config=/vault/userconfig/vault-storage-config/config.hcl'","title":"\u4fdd\u8b77\u654f\u611f\u7684 Vault \u914d\u7f6e\u8cc7\u8a0a"},{"location":"vault/kubernetes/agent-kubernetes/","text":"Vault Agent with Kubernetes \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/agent-kubernetes?in=vault/auth-methods \u5e7e\u4e4e\u6240\u6709\u5c0d Vault \u7684\u8acb\u6c42\u90fd\u5fc5\u9808\u9644\u6709\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3002\u9019\u5305\u62ec\u6240\u6709 API \u8acb\u6c42\uff0c\u4ee5\u53ca\u901a\u904e Vault CLI \u7684\u8acb\u6c42\u3002\u5982\u679c\u60a8\u53ef\u4ee5\u5b89\u5168\u5730\u5f9e\u767c\u8d77\u8005\u90a3\u88e1\u7372\u5f97\u7b2c\u4e00\u500b\u79d8\u5bc6\u5230\u6d88\u8cbb\u8005\uff0c\u90a3\u9ebc\u5728\u8a72\u767c\u8d77\u8005\u548c\u6d88\u8cbb\u8005\u4e4b\u9593\u50b3\u8f38\u7684\u6240\u6709\u5f8c\u7e8c\u79d8\u5bc6\u90fd\u53ef\u4ee5\u901a\u904e\u6210\u529f\u5206\u767c\u548c\u8a72\u7b2c\u4e00\u500b\u79d8\u5bc6\u7684\u7528\u6236\u5efa\u7acb\u7684\u4fe1\u4efb\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 Challenge \u00b6 \u5728 Kubernetes \u74b0\u5883\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u4e5f\u4e0d\u4f8b\u5916\u3002\u5e78\u904b\u7684\u662f\uff0cVault \u63d0\u4f9b\u4e86 Kubernetes auth \u65b9\u6cd5 \u4f86\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service Account)\u4ee4\u724c\u5c0d\u5ba2\u6236\u7aef\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u4f46\u662f\uff0c\u5ba2\u6236\u7aef(\u6bcf\u4e00\u500b\u5728K8S\u88e1\u982d\u7684Pod)\u4ecd\u7136\u9700\u8981\u8ca0\u8cac\u7ba1\u7406 Vault \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f(TTL)\u3002\u56e0\u6b64\uff0c\u4e0b\u4e00\u500b\u6311\u6230\u8b8a\u6210\u77ad\u5982\u4f55\u4ee5\u6a19\u6e96\u65b9\u5f0f\u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\uff0c\u800c\u7121\u9700\u7de8\u5beb\u81ea\u5b9a\u7fa9\u908f\u8f2f\u3002 Solution \u00b6 Vault Agent \u63d0\u4f9b\u4e86\u8a31\u591a\u4e0d\u540c\u7684\u5e6b\u52a9\u529f\u80fd\uff0c\u5c08\u9580\u89e3\u6c7a\u4ee5\u4e0b\u6311\u6230\uff1a \u81ea\u52d5\u8a8d\u8b49 \u4ee4\u724c\u7684\u5b89\u5168\u4ea4\u4ed8/\u5b58\u5132 \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u7ba1\u7406\uff08\u66f4\u65b0\u548c\u91cd\u65b0\u8a8d\u8b49\uff09 Info \u672c\u6559\u7a0b\u91cd\u9ede\u4ecb\u7d39\u4f7f\u7528 kubernetes auth \u65b9\u6cd5\u7684 Vault Agent Auto-Auth \u7684\u6f14\u793a\u3002 Vault Helm \u5f15\u5165\u4e86 Agent Sidecar Injector\u3002\u6709\u95dc Sidecar \u4f7f\u7528\u7684\u5206\u6b65\u6559\u7a0b\uff0c\u8acb\u53c3\u95b1\u901a\u904e Vault Helm Sidecar \u5c07 Secrets \u6ce8\u5165 Kubernetes Pod\u3002 Prerequisites \u00b6 \u8981\u57f7\u884c\u672c\u6559\u7a0b\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\uff0c\u60a8\u9700\u8981\uff1a \u4e00\u500b\u5b89\u88dd\u597d\u4e86\u7684 Minikube \u53ef\u5f9e Kubernetes \u74b0\u5883\u8a2a\u554f\u5230\u7684 Vault \u74b0\u5883\u3002\u8acb\u53c3\u95b1\u5165\u9580\u6559\u7a0b\u4ee5\u5b89\u88dd Vault\u3002\u78ba\u4fdd\u60a8\u7684 Vault \u670d\u52d9\u5668\u5df2\u521d\u59cb\u5316\u4e26\u89e3\u5c01 Info \u6ce8\u610f\uff1a\u51fa\u65bc\u6f14\u793a\u7684\u76ee\u7684\uff0c\u672c\u6559\u7a0b\u5c07 Minikube \u4f5c\u70ba Kubernetes \u74b0\u5883\u904b\u884c\u3002\u5982\u679c\u4f60\u5e0c\u671b\u6539\u70ba\u91dd\u5c0d Azure Kubernetes \u670d\u52d9 (AKS) \u7fa4\u96c6\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u6309\u7167 Azure Kubernetes \u670d\u52d9\u7fa4\u96c6\u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\u5275\u5efa AKS \u7fa4\u96c6\u3002\u5982\u679c\u8981\u91dd\u5c0d Google Kubernetes Engine (GKE) \u96c6\u7fa4\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u53c3\u95b1 Google Kubernetes Engine \u96c6\u7fa4\u90e8\u5206\u4e2d\u63cf\u8ff0\u7684\u6b65\u9a5f\u3002 \u901a\u904e\u5f9e clone GitHub hashcorp/learn-vault-agent \u5b58\u5132\u5eab\u4f86\u6aa2\u7d22\u9644\u52a0\u914d\u7f6e\u3002 $ git clone https://github.com/hashicorp/learn-vault-agent.git \u6b64Git\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6559\u7a0b\u7684\u652f\u6301\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u7279\u5b9a\u5167\u5bb9\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 learn-vault-agent/identity/vault-agent-k8s-demo \u76ee\u9304\u3002 $ cd learn-vault-agent/vault-agent-k8s-demo Info \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u5b83\u7684\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002 Start a Vault server \u00b6 \u8981\u5b8c\u6210\u672c\u6559\u7a0b\uff0c\u8acb\u555f\u52d5\u4e00\u500b Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u8a72\u670d\u52d9\u5668\u5728 0.0.0.0:8200 \u4ee5 root \u4f5c\u70ba\u6839\u4ee4\u724c ID \u5075\u807d\u672c\u5730\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u9023\u63a5\u5230\u3002 \u70ba Vault CLI \u5c0e\u51fa\u74b0\u5883\u8b8a\u91cf\u4ee5\u5b9a\u4f4d\u5230 Vault \u670d\u52d9\u5668\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200 Create a service account \u00b6 1. Start Kubernetes \u00b6 \u555f\u52d5\u5728 Minikube \u4e2d\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u3002 $ minikube start --driver = docker \u7b49\u5f85\u5e7e\u5206\u9418\u8b93 minikube \u74b0\u5883\u5b8c\u5168\u53ef\u7528\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured 2. Define Kubernetes Serviceaccount \u00b6 \u5728 Kubernetes \u4e2d\uff0c service account \u70ba\u5728 Pod \u4e2d\u904b\u884c\u7684\u9032\u7a0b\u63d0\u4f9b\u8eab\u4efd\uff0c\u4ee5\u4fbf\u9032\u7a0b\u53ef\u4ee5\u806f\u7e6b Kubernetes API \u670d\u52d9\u5668\u3002\u5728\u60a8\u9996\u9078\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\u6253\u958b\u63d0\u4f9b\u7684 vault-auth-service-account.yaml \u6587\u4ef6\uff0c\u4e26\u6aa2\u67e5\u5176\u5167\u5bb9\u4ee5\u4e86\u89e3\u672c\u6559\u7a0b\u8981\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u5b9a\u7fa9\u3002 vault-auth-service-account.yaml apiVersion : v1 kind : ServiceAccount metadata : name : vault-auth namespace : default --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default 3. Create Service account \u00b6 \u5275\u5efa Vault-auth \u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename vault-auth-service-account.yaml 4. Kubernetes 1.24+ only \u00b6 \u670d\u52d9\u5e33\u6236\u751f\u6210\u4e86\u4e00\u500b\u5728 Kubernetes 1.23 \u4e2d\u81ea\u52d5\u914d\u7f6e\u6240\u9700\u7684\u5bc6\u9470\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0c\u60a8\u9700\u8981\u986f\u5f0f\u5275\u5efa\u5bc6\u9470\u3002 vault-auth-secret.yaml apiVersion : v1 kind : Secret metadata : name : vault-auth-secret annotations : kubernetes.io/service-account.name : vault-auth type : kubernetes.io/service-account-token \u5275\u5efa\u4e00\u500b Vault-auth-secret \u5bc6\u9470\u3002 $ kubectl apply --filename vault-auth-secret.yaml Configure Kubernetes auth method \u00b6 1. Create a read-only policy \u00b6 \u5728 Vault \u4e2d\u5275\u5efa\u4e00\u500b\u552f\u8b80\u7684\u7b56\u7565 myapp-kv-ro \u3002 $ vault policy write myapp-kv-ro - <<EOF path \"secret/data/myapp/*\" { capabilities = [\"read\", \"list\"] } EOF 2. Put test data \u00b6 \u5728 secret/myapp \u8def\u5f91\u5275\u5efa\u4e00\u4e9b\u6e2c\u8a66\u6578\u64da\u3002 $ vault kv put secret/myapp/config \\ username = 'appuser' \\ password = 'suP3rsec(et!' \\ ttl = '30s' \u7d50\u679c: ====== Secret Path ====== secret/data/myapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -06-25T10:48:43.580414126Z custom_metadata <nil> deletion_time n/a destroyed false version 1 3. Set up environment variables \u00b6 \u5c07\u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6b63\u5728\u904b\u884c\u7684 Minikube \u74b0\u5883\u3002\u5c07 SA_SECRET_NAME \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba vault-auth \u670d\u52d9\u5e33\u6236 \u5bc6\u78bc\u3002 $ export SA_SECRET_NAME = $( kubectl get secrets --output = json \\ | jq -r '.items[].metadata | select(.name|startswith(\"vault-auth-\")).name' ) \u5c07 SA_JWT_TOKEN \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8a2a\u554f TokenReview API \u7684\u670d\u52d9\u5e33\u6236 JWT $ export SA_JWT_TOKEN = $( kubectl get secret $SA_SECRET_NAME \\ --output 'go-template={{ .data.token }}' | base64 --decode ) \u5c07 SA_CA_CRT \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8207 Kubernetes API \u5c0d\u8a71\u7684 PEM \u7de8\u78bc CA \u8b49\u66f8\u3002 $ export SA_CA_CRT = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) \u5c07 K8S_HOST \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba minikube IP \u5730\u5740\u3002 $ export K8S_HOST = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.server}' ) 4. Configure the Kubernetes auth method \u00b6 \u73fe\u5728\uff0c\u555f\u7528\u4e26\u914d\u7f6e Kubernetes auth \u65b9\u6cd5\u3002\u5728\u9ed8\u8a8d\u8def\u5f91\uff08 auth/kubernetes \uff09\u555f\u7528 Kubernetes auth \u65b9\u6cd5\u3002 $ vault auth enable kubernetes \u544a\u8a34 Vault \u5982\u4f55\u8207 Kubernetes (Minikube) \u96c6\u7fa4\u901a\u4fe1\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $SA_JWT_TOKEN \" \\ kubernetes_host = \" $K8S_HOST \" \\ kubernetes_ca_cert = \" $SA_CA_CRT \" \\ issuer = \"https://kubernetes.default.svc.cluster.local\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config Tips \u60a8\u53ef\u4ee5\u4f7f\u7528 \u6b64\u65b9\u6cd5 \u9a57\u8b49 Kubernetes \u96c6\u7fa4\u7684\u9812\u767c\u8005\u540d\u7a31\u3002 5. Create role \u00b6 \u5275\u5efa\u4e00\u500b\u540d\u70ba example \u7684\u89d2\u8272\uff0c\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u6620\u5c04\u5230 Vault \u7b56\u7565\u548c\u9ed8\u8a8d\u4ee4\u724c TTL\u3002 $ vault write auth/kubernetes/role/example \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = myapp-kv-ro \\ ttl = 24h \u7d50\u679c: Success! Data written to: auth/kubernetes/role/example Determine the Vault address \u00b6 \u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e\u5411 Kubernetes \u96c6\u7fa4\u7684\u7db2\u95dc\u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u7531 Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5c0b\u5740\u3002 1. \u555f\u52d5 minikube SSH \u00b6 $ minikube ssh ## ... minikube ssh login 2. \u5728\u6b64 SSH \u6703\u8a71\u4e2d\uff0c\u6aa2\u7d22 Minikube \u4e3b\u6a5f \u00b6 $ dig host.minikube.internal ; <<>> DiG 9 .16.1-Ubuntu <<>> host.minikube.internal ;; global options: +cmd ;; Got answer: ;; ->>HEADER <<- opco de: QUERY, status: NXDOMAIN, id: 13469 ;; flags: qr rd ra ; QUERY: 1 , ANSWER: 0 , AUTHORITY: 1 , ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0 , flags: ; udp: 65494 ;; QUESTION SECTION: ; host.minikube.internal. IN A ;; AUTHORITY SECTION: . 86375 IN SOA a.root-servers.net. nstld.verisign-grs.com. 2022062500 1800 900 604800 86400 ;; Query time: 43 msec ;; SERVER: 192 .168.49.1#53 ( 192 .168.49.1 ) ;; WHEN: Sat Jun 25 13 :02:27 UTC 2022 ;; MSG SIZE rcvd: 126 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u4f86\u6355\u7372 Minikube \u7db2\u95dc\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = $( minikube ssh \"dig +short host.docker.internal\" | tr -d '\\r' ) $ EXTERNAL_VAULT_ADDR = 192 .168.50.191 Optional: Verify the Kubernetes auth method configuration \u00b6 1. \u5b9a\u7fa9\u4e00\u500b\u5e36\u6709\u5bb9\u5668\u7684 Pod $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: vault-auth containers: - name: devwebapp image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" EOF Pod \u540d\u70ba devwebapp \u4e26\u4f7f\u7528 vault-auth \u670d\u52d9\u5e33\u6236\u904b\u884c\u3002 2. \u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml --namespace default pod/devwebapp created 3. \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 54s \u7b49\u5230 devwebapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 4. \u5728 devwebapp pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell $ kubectl exec --stdin = true --tty = true devwebapp -- /bin/sh # \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a # \u3002 Info \u6ce8\u610f\uff1a\u672c\u7bc0\u4e2d\u7684\u63d0\u793a\u986f\u793a\u70ba $\uff0c\u4f46\u9019\u4e9b\u547d\u4ee4\u65e8\u5728\u5728 devwebapp \u5bb9\u5668\u4e0a\u7684\u6b64\u4ea4\u4e92\u5f0f shell \u4e2d\u57f7\u884c\u3002 5. \u5c07 KUBE_TOKEN \u8a2d\u7f6e\u70ba\u670d\u52d9\u5e33\u6236\u4ee4\u724c $ KUBE_TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) 6. \u901a\u904e\u5e36\u6709 KUBE_TOKEN \u7684\u793a\u4f8b\u89d2\u8272\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49 curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ $VAULT_ADDR /v1/auth/kubernetes/login curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ http://192.168.50.191:8200/v1/auth/kubernetes/login","title":"Vault Agent \u8207 Kubernetes"},{"location":"vault/kubernetes/agent-kubernetes/#vault-agent-with-kubernetes","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/agent-kubernetes?in=vault/auth-methods \u5e7e\u4e4e\u6240\u6709\u5c0d Vault \u7684\u8acb\u6c42\u90fd\u5fc5\u9808\u9644\u6709\u8eab\u4efd\u9a57\u8b49\u4ee4\u724c\u3002\u9019\u5305\u62ec\u6240\u6709 API \u8acb\u6c42\uff0c\u4ee5\u53ca\u901a\u904e Vault CLI \u7684\u8acb\u6c42\u3002\u5982\u679c\u60a8\u53ef\u4ee5\u5b89\u5168\u5730\u5f9e\u767c\u8d77\u8005\u90a3\u88e1\u7372\u5f97\u7b2c\u4e00\u500b\u79d8\u5bc6\u5230\u6d88\u8cbb\u8005\uff0c\u90a3\u9ebc\u5728\u8a72\u767c\u8d77\u8005\u548c\u6d88\u8cbb\u8005\u4e4b\u9593\u50b3\u8f38\u7684\u6240\u6709\u5f8c\u7e8c\u79d8\u5bc6\u90fd\u53ef\u4ee5\u901a\u904e\u6210\u529f\u5206\u767c\u548c\u8a72\u7b2c\u4e00\u500b\u79d8\u5bc6\u7684\u7528\u6236\u5efa\u7acb\u7684\u4fe1\u4efb\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002","title":"Vault Agent with Kubernetes"},{"location":"vault/kubernetes/agent-kubernetes/#challenge","text":"\u5728 Kubernetes \u74b0\u5883\u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u4e5f\u4e0d\u4f8b\u5916\u3002\u5e78\u904b\u7684\u662f\uff0cVault \u63d0\u4f9b\u4e86 Kubernetes auth \u65b9\u6cd5 \u4f86\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236(Service Account)\u4ee4\u724c\u5c0d\u5ba2\u6236\u7aef\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u4f46\u662f\uff0c\u5ba2\u6236\u7aef(\u6bcf\u4e00\u500b\u5728K8S\u88e1\u982d\u7684Pod)\u4ecd\u7136\u9700\u8981\u8ca0\u8cac\u7ba1\u7406 Vault \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f(TTL)\u3002\u56e0\u6b64\uff0c\u4e0b\u4e00\u500b\u6311\u6230\u8b8a\u6210\u77ad\u5982\u4f55\u4ee5\u6a19\u6e96\u65b9\u5f0f\u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\uff0c\u800c\u7121\u9700\u7de8\u5beb\u81ea\u5b9a\u7fa9\u908f\u8f2f\u3002","title":"Challenge"},{"location":"vault/kubernetes/agent-kubernetes/#solution","text":"Vault Agent \u63d0\u4f9b\u4e86\u8a31\u591a\u4e0d\u540c\u7684\u5e6b\u52a9\u529f\u80fd\uff0c\u5c08\u9580\u89e3\u6c7a\u4ee5\u4e0b\u6311\u6230\uff1a \u81ea\u52d5\u8a8d\u8b49 \u4ee4\u724c\u7684\u5b89\u5168\u4ea4\u4ed8/\u5b58\u5132 \u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u7ba1\u7406\uff08\u66f4\u65b0\u548c\u91cd\u65b0\u8a8d\u8b49\uff09 Info \u672c\u6559\u7a0b\u91cd\u9ede\u4ecb\u7d39\u4f7f\u7528 kubernetes auth \u65b9\u6cd5\u7684 Vault Agent Auto-Auth \u7684\u6f14\u793a\u3002 Vault Helm \u5f15\u5165\u4e86 Agent Sidecar Injector\u3002\u6709\u95dc Sidecar \u4f7f\u7528\u7684\u5206\u6b65\u6559\u7a0b\uff0c\u8acb\u53c3\u95b1\u901a\u904e Vault Helm Sidecar \u5c07 Secrets \u6ce8\u5165 Kubernetes Pod\u3002","title":"Solution"},{"location":"vault/kubernetes/agent-kubernetes/#prerequisites","text":"\u8981\u57f7\u884c\u672c\u6559\u7a0b\u4e2d\u63cf\u8ff0\u7684\u4efb\u52d9\uff0c\u60a8\u9700\u8981\uff1a \u4e00\u500b\u5b89\u88dd\u597d\u4e86\u7684 Minikube \u53ef\u5f9e Kubernetes \u74b0\u5883\u8a2a\u554f\u5230\u7684 Vault \u74b0\u5883\u3002\u8acb\u53c3\u95b1\u5165\u9580\u6559\u7a0b\u4ee5\u5b89\u88dd Vault\u3002\u78ba\u4fdd\u60a8\u7684 Vault \u670d\u52d9\u5668\u5df2\u521d\u59cb\u5316\u4e26\u89e3\u5c01 Info \u6ce8\u610f\uff1a\u51fa\u65bc\u6f14\u793a\u7684\u76ee\u7684\uff0c\u672c\u6559\u7a0b\u5c07 Minikube \u4f5c\u70ba Kubernetes \u74b0\u5883\u904b\u884c\u3002\u5982\u679c\u4f60\u5e0c\u671b\u6539\u70ba\u91dd\u5c0d Azure Kubernetes \u670d\u52d9 (AKS) \u7fa4\u96c6\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u6309\u7167 Azure Kubernetes \u670d\u52d9\u7fa4\u96c6\u90e8\u5206\u4e2d\u7684\u6b65\u9a5f\u5275\u5efa AKS \u7fa4\u96c6\u3002\u5982\u679c\u8981\u91dd\u5c0d Google Kubernetes Engine (GKE) \u96c6\u7fa4\u9032\u884c\u6e2c\u8a66\uff0c\u8acb\u53c3\u95b1 Google Kubernetes Engine \u96c6\u7fa4\u90e8\u5206\u4e2d\u63cf\u8ff0\u7684\u6b65\u9a5f\u3002 \u901a\u904e\u5f9e clone GitHub hashcorp/learn-vault-agent \u5b58\u5132\u5eab\u4f86\u6aa2\u7d22\u9644\u52a0\u914d\u7f6e\u3002 $ git clone https://github.com/hashicorp/learn-vault-agent.git \u6b64Git\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6559\u7a0b\u7684\u652f\u6301\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u7279\u5b9a\u5167\u5bb9\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 learn-vault-agent/identity/vault-agent-k8s-demo \u76ee\u9304\u3002 $ cd learn-vault-agent/vault-agent-k8s-demo Info \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u5b83\u7684\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002","title":"Prerequisites"},{"location":"vault/kubernetes/agent-kubernetes/#start-a-vault-server","text":"\u8981\u5b8c\u6210\u672c\u6559\u7a0b\uff0c\u8acb\u555f\u52d5\u4e00\u500b Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u8a72\u670d\u52d9\u5668\u5728 0.0.0.0:8200 \u4ee5 root \u4f5c\u70ba\u6839\u4ee4\u724c ID \u5075\u807d\u672c\u5730\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u9023\u63a5\u5230\u3002 \u70ba Vault CLI \u5c0e\u51fa\u74b0\u5883\u8b8a\u91cf\u4ee5\u5b9a\u4f4d\u5230 Vault \u670d\u52d9\u5668\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200","title":"Start a Vault server"},{"location":"vault/kubernetes/agent-kubernetes/#create-a-service-account","text":"","title":"Create a service account"},{"location":"vault/kubernetes/agent-kubernetes/#1-start-kubernetes","text":"\u555f\u52d5\u5728 Minikube \u4e2d\u904b\u884c\u7684 Kubernetes \u96c6\u7fa4\u3002 $ minikube start --driver = docker \u7b49\u5f85\u5e7e\u5206\u9418\u8b93 minikube \u74b0\u5883\u5b8c\u5168\u53ef\u7528\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured","title":"1. Start Kubernetes"},{"location":"vault/kubernetes/agent-kubernetes/#2-define-kubernetes-serviceaccount","text":"\u5728 Kubernetes \u4e2d\uff0c service account \u70ba\u5728 Pod \u4e2d\u904b\u884c\u7684\u9032\u7a0b\u63d0\u4f9b\u8eab\u4efd\uff0c\u4ee5\u4fbf\u9032\u7a0b\u53ef\u4ee5\u806f\u7e6b Kubernetes API \u670d\u52d9\u5668\u3002\u5728\u60a8\u9996\u9078\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e2d\u6253\u958b\u63d0\u4f9b\u7684 vault-auth-service-account.yaml \u6587\u4ef6\uff0c\u4e26\u6aa2\u67e5\u5176\u5167\u5bb9\u4ee5\u4e86\u89e3\u672c\u6559\u7a0b\u8981\u4f7f\u7528\u7684\u670d\u52d9\u5e33\u6236\u5b9a\u7fa9\u3002 vault-auth-service-account.yaml apiVersion : v1 kind : ServiceAccount metadata : name : vault-auth namespace : default --- apiVersion : rbac.authorization.k8s.io/v1 kind : ClusterRoleBinding metadata : name : role-tokenreview-binding namespace : default roleRef : apiGroup : rbac.authorization.k8s.io kind : ClusterRole name : system:auth-delegator subjects : - kind : ServiceAccount name : vault-auth namespace : default","title":"2. Define Kubernetes Serviceaccount"},{"location":"vault/kubernetes/agent-kubernetes/#3-create-service-account","text":"\u5275\u5efa Vault-auth \u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename vault-auth-service-account.yaml","title":"3. Create Service account"},{"location":"vault/kubernetes/agent-kubernetes/#4-kubernetes-124-only","text":"\u670d\u52d9\u5e33\u6236\u751f\u6210\u4e86\u4e00\u500b\u5728 Kubernetes 1.23 \u4e2d\u81ea\u52d5\u914d\u7f6e\u6240\u9700\u7684\u5bc6\u9470\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0c\u60a8\u9700\u8981\u986f\u5f0f\u5275\u5efa\u5bc6\u9470\u3002 vault-auth-secret.yaml apiVersion : v1 kind : Secret metadata : name : vault-auth-secret annotations : kubernetes.io/service-account.name : vault-auth type : kubernetes.io/service-account-token \u5275\u5efa\u4e00\u500b Vault-auth-secret \u5bc6\u9470\u3002 $ kubectl apply --filename vault-auth-secret.yaml","title":"4. Kubernetes 1.24+ only"},{"location":"vault/kubernetes/agent-kubernetes/#configure-kubernetes-auth-method","text":"","title":"Configure Kubernetes auth method"},{"location":"vault/kubernetes/agent-kubernetes/#1-create-a-read-only-policy","text":"\u5728 Vault \u4e2d\u5275\u5efa\u4e00\u500b\u552f\u8b80\u7684\u7b56\u7565 myapp-kv-ro \u3002 $ vault policy write myapp-kv-ro - <<EOF path \"secret/data/myapp/*\" { capabilities = [\"read\", \"list\"] } EOF","title":"1. Create a read-only policy"},{"location":"vault/kubernetes/agent-kubernetes/#2-put-test-data","text":"\u5728 secret/myapp \u8def\u5f91\u5275\u5efa\u4e00\u4e9b\u6e2c\u8a66\u6578\u64da\u3002 $ vault kv put secret/myapp/config \\ username = 'appuser' \\ password = 'suP3rsec(et!' \\ ttl = '30s' \u7d50\u679c: ====== Secret Path ====== secret/data/myapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -06-25T10:48:43.580414126Z custom_metadata <nil> deletion_time n/a destroyed false version 1","title":"2. Put test data"},{"location":"vault/kubernetes/agent-kubernetes/#3-set-up-environment-variables","text":"\u5c07\u74b0\u5883\u8b8a\u91cf\u8a2d\u7f6e\u70ba\u6307\u5411\u6b63\u5728\u904b\u884c\u7684 Minikube \u74b0\u5883\u3002\u5c07 SA_SECRET_NAME \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba vault-auth \u670d\u52d9\u5e33\u6236 \u5bc6\u78bc\u3002 $ export SA_SECRET_NAME = $( kubectl get secrets --output = json \\ | jq -r '.items[].metadata | select(.name|startswith(\"vault-auth-\")).name' ) \u5c07 SA_JWT_TOKEN \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8a2a\u554f TokenReview API \u7684\u670d\u52d9\u5e33\u6236 JWT $ export SA_JWT_TOKEN = $( kubectl get secret $SA_SECRET_NAME \\ --output 'go-template={{ .data.token }}' | base64 --decode ) \u5c07 SA_CA_CRT \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba\u7528\u65bc\u8207 Kubernetes API \u5c0d\u8a71\u7684 PEM \u7de8\u78bc CA \u8b49\u66f8\u3002 $ export SA_CA_CRT = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) \u5c07 K8S_HOST \u74b0\u5883\u8b8a\u91cf\u503c\u8a2d\u7f6e\u70ba minikube IP \u5730\u5740\u3002 $ export K8S_HOST = $( kubectl config view --raw --minify --flatten \\ --output 'jsonpath={.clusters[].cluster.server}' )","title":"3. Set up environment variables"},{"location":"vault/kubernetes/agent-kubernetes/#4-configure-the-kubernetes-auth-method","text":"\u73fe\u5728\uff0c\u555f\u7528\u4e26\u914d\u7f6e Kubernetes auth \u65b9\u6cd5\u3002\u5728\u9ed8\u8a8d\u8def\u5f91\uff08 auth/kubernetes \uff09\u555f\u7528 Kubernetes auth \u65b9\u6cd5\u3002 $ vault auth enable kubernetes \u544a\u8a34 Vault \u5982\u4f55\u8207 Kubernetes (Minikube) \u96c6\u7fa4\u901a\u4fe1\u3002 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $SA_JWT_TOKEN \" \\ kubernetes_host = \" $K8S_HOST \" \\ kubernetes_ca_cert = \" $SA_CA_CRT \" \\ issuer = \"https://kubernetes.default.svc.cluster.local\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config Tips \u60a8\u53ef\u4ee5\u4f7f\u7528 \u6b64\u65b9\u6cd5 \u9a57\u8b49 Kubernetes \u96c6\u7fa4\u7684\u9812\u767c\u8005\u540d\u7a31\u3002","title":"4. Configure the Kubernetes auth method"},{"location":"vault/kubernetes/agent-kubernetes/#5-create-role","text":"\u5275\u5efa\u4e00\u500b\u540d\u70ba example \u7684\u89d2\u8272\uff0c\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u6620\u5c04\u5230 Vault \u7b56\u7565\u548c\u9ed8\u8a8d\u4ee4\u724c TTL\u3002 $ vault write auth/kubernetes/role/example \\ bound_service_account_names = vault-auth \\ bound_service_account_namespaces = default \\ policies = myapp-kv-ro \\ ttl = 24h \u7d50\u679c: Success! Data written to: auth/kubernetes/role/example","title":"5. Create role"},{"location":"vault/kubernetes/agent-kubernetes/#determine-the-vault-address","text":"\u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e\u5411 Kubernetes \u96c6\u7fa4\u7684\u7db2\u95dc\u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u7531 Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5c0b\u5740\u3002","title":"Determine the Vault address"},{"location":"vault/kubernetes/agent-kubernetes/#1-minikube-ssh","text":"$ minikube ssh ## ... minikube ssh login","title":"1. \u555f\u52d5 minikube SSH"},{"location":"vault/kubernetes/agent-kubernetes/#2-ssh-minikube","text":"$ dig host.minikube.internal ; <<>> DiG 9 .16.1-Ubuntu <<>> host.minikube.internal ;; global options: +cmd ;; Got answer: ;; ->>HEADER <<- opco de: QUERY, status: NXDOMAIN, id: 13469 ;; flags: qr rd ra ; QUERY: 1 , ANSWER: 0 , AUTHORITY: 1 , ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0 , flags: ; udp: 65494 ;; QUESTION SECTION: ; host.minikube.internal. IN A ;; AUTHORITY SECTION: . 86375 IN SOA a.root-servers.net. nstld.verisign-grs.com. 2022062500 1800 900 604800 86400 ;; Query time: 43 msec ;; SERVER: 192 .168.49.1#53 ( 192 .168.49.1 ) ;; WHEN: Sat Jun 25 13 :02:27 UTC 2022 ;; MSG SIZE rcvd: 126 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u4f86\u6355\u7372 Minikube \u7db2\u95dc\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = $( minikube ssh \"dig +short host.docker.internal\" | tr -d '\\r' ) $ EXTERNAL_VAULT_ADDR = 192 .168.50.191","title":"2. \u5728\u6b64 SSH \u6703\u8a71\u4e2d\uff0c\u6aa2\u7d22 Minikube \u4e3b\u6a5f"},{"location":"vault/kubernetes/agent-kubernetes/#optional-verify-the-kubernetes-auth-method-configuration","text":"1. \u5b9a\u7fa9\u4e00\u500b\u5e36\u6709\u5bb9\u5668\u7684 Pod $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: vault-auth containers: - name: devwebapp image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" EOF Pod \u540d\u70ba devwebapp \u4e26\u4f7f\u7528 vault-auth \u670d\u52d9\u5e33\u6236\u904b\u884c\u3002 2. \u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml --namespace default pod/devwebapp created 3. \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 54s \u7b49\u5230 devwebapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 4. \u5728 devwebapp pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell $ kubectl exec --stdin = true --tty = true devwebapp -- /bin/sh # \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a # \u3002 Info \u6ce8\u610f\uff1a\u672c\u7bc0\u4e2d\u7684\u63d0\u793a\u986f\u793a\u70ba $\uff0c\u4f46\u9019\u4e9b\u547d\u4ee4\u65e8\u5728\u5728 devwebapp \u5bb9\u5668\u4e0a\u7684\u6b64\u4ea4\u4e92\u5f0f shell \u4e2d\u57f7\u884c\u3002 5. \u5c07 KUBE_TOKEN \u8a2d\u7f6e\u70ba\u670d\u52d9\u5e33\u6236\u4ee4\u724c $ KUBE_TOKEN = $( cat /var/run/secrets/kubernetes.io/serviceaccount/token ) 6. \u901a\u904e\u5e36\u6709 KUBE_TOKEN \u7684\u793a\u4f8b\u89d2\u8272\u4f7f\u7528 Vault \u9032\u884c\u8eab\u4efd\u9a57\u8b49 curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ $VAULT_ADDR /v1/auth/kubernetes/login curl --request POST \\ --data '{\"jwt\": \"' \" $KUBE_TOKEN \" '\", \"role\": \"example\"}' \\ http://192.168.50.191:8200/v1/auth/kubernetes/login","title":"Optional: Verify the Kubernetes auth method configuration"},{"location":"vault/kubernetes/kubernetes-external-vault/","text":"Kubernetes \u8207\u5916\u90e8 Vault \u6574\u5408 \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-external-vault Vault \u53ef\u4ee5\u7ba1\u7406 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u7684\u6a5f\u5bc6\u3002\u901a\u5e38\u9019\u500b Vault \u670d\u52d9\u662f\u88ab\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e4b\u5916\u3002 Info \u5728 Kubernetes \u4e2d\u904b\u884c Vault\uff1a\u5728 Vault Installation to Minikube via Helm \u548c Injecting Secrets into Kubernetes Pods via Vault Helm Sidecar \u6559\u7a0b\u4e2d\u63a2\u8a0e\u4e86\u5728 K8S \u96c6\u7fa4\u4e2d\u904b\u884c Vault \u670d\u52d9\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5728\u672c\u5730\u904b\u884c Vault\uff0c\u4f7f\u7528 K3D \u555f\u52d5 Kubernetes \u96c6\u7fa4\uff0c\u90e8\u7f72\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u8a72\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u76f4\u63a5\u5f9e Vault \u6aa2\u7d22\u6a5f\u5bc6\uff0c\u4e26\u901a\u904e Vault Agent Injector \u9032\u884c\u6a5f\u5bc6\u6ce8\u5165\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001K3D \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 K3D version. $ k3d version k3d version v5.4.1 k3s version v1.22.7-k3s1 ( default ) Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" } \u9019\u4e9b\u662f\u63a8\u85a6\u7684\u8edf\u4ef6\u7248\u672c\uff0c\u986f\u793a\u7684\u8f38\u51fa\u53ef\u80fd\u6703\u56e0\u60a8\u7684\u74b0\u5883\u548c\u60a8\u4f7f\u7528\u7684\u8edf\u4ef6\u7248\u672c\u800c\u7570\u3002 \u63a5\u4e0b\u4f86\uff0c\u901a\u904e\u5f9e GitHub \u4f86 clone hashcorp/vault-guides \u5b58\u5132\u5eab\uff0c\u88e1\u982d\u5305\u542b\u672c\u6559\u7a0b\u7528\u4f86\u9a57\u8b49\u7684\u7bc4\u4f8b Web \u61c9\u7528\u7a0b\u5e8f\u548c\u5176\u4ed6\u914d\u7f6e\u6a94\u6848\u3002 $ git clone https://github.com/hashicorp/vault-guides.git \u6b64\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6307\u5357\u7684\u76f8\u95dc\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6587\u4ef6\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 vault-guides/operations/provision-vault/kubernetes/minikube/external-vault \u76ee\u9304\u3002 $ cd vault-guides/operations/provision-vault/kubernetes/minikube/external-vault Important \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u9918\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002 \u555f\u52d5 Vault \u00b6 \u53ea\u8981 Vault \u670d\u52d9\u5668\u662f\u7db2\u5740\u662f\u53ef\u88ab Kubernetes \u9023\u63a5\u5230\u7684\uff0c\u90a3\u9ebc\u904b\u884c\u5728 Kubernetes \u96c6\u7fa4\u5916\u90e8\u7684 Vault \u5c31\u53ef\u4ee5\u88ab\u5b83\u7684\u4efb\u4f55\u88ab\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684 pod \u6240\u9023\u63a5\u3002 1. \u555f\u52d5 Vault \u670d\u52d9 \u6253\u958b\u4e00\u500b\u65b0\u7d42\u7aef\uff0c\u555f\u52d5\u4e00\u500b\u4ee5 root \u4f5c\u70ba root \u4ee4\u724c\u7684 Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u5b83\u5728 0.0.0.0:8200 \u8655\u5075\u807d\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u5c0b\u5740\uff0c\u56e0\u70ba\u5b83\u7d81\u5b9a\u5230\u5171\u4eab\u7db2\u7d61. 2. \u8a2d\u5b9a VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u70ba Vault CLI \u8a2d\u5b9a\u74b0\u5883\u8b8a\u91cf\u4f86\u66b4\u9732\u51fa Vault \u670d\u52d9\u5668\u7db2\u8def\u5730\u5740\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200 \u60a8\u90e8\u7f72\u7684 Web \u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u53d6\u5f97\u5132\u5b58\u5728 Vault \u88e1\u9762\u7684 username \u548c password \uff0c\u9019\u4e9b\u7528\u6236\u540d\u548c\u5bc6\u78bc\u7684\u6a5f\u654f\u8cc7\u8a0a\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cVault \u958b\u767c\u670d\u52d9\u5668\u4ee5\u5728\u4ee5 secret \u70ba\u524d\u7db4\u7684\u8def\u5f91\u4e0a\u555f\u7528\u9375\u503c\u6a5f\u5bc6\u5f15\u64ce\u555f\u52d5\u3002 3. \u4fbf\u7528 root \u4ee4\u724c\u767b\u5165 Vault \u5728\u555f\u52d5 Vault \u6642\u6211\u5011\u8a2d\u5b9a\u7684 root \u4ee4\u724c\u662f root $ vault login root Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \"vault login\" again. Future Vault requests will automatically use this token. Key Value --- ----- token root token_accessor OJU8So8T5wuCassRAJpNrfN4 token_duration \u221e token_renewable false token_policies [ \"root\" ] identity_policies [] policies [ \"root\" ] 4. \u5728 secret/devwebapp/config \u8a2d\u5b9a credential \u4f7f\u7528\u7528\u6236\u540d username \u548c\u5bc6\u78bc password \u5728\u88ab\u5275\u5efa\u5728\u8def\u5f91 secret/devwebapp/config \u4e0a\u3002 $ vault kv put secret/devwebapp/config username = 'giraffe' password = 'salsa' ======== Secret Path ======== secret/data/devwebapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-11T22:35:03.103203218Z custom_metadata <nil> deletion_time n/a destroyed false version 1 5. \u9a57\u8b49 Secret \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002 $ vault kv get -format = json secret/devwebapp/config | jq \".data.data\" { \"password\" : \"salsa\" , \"username\" : \"giraffe\" } \u5e36\u6709\u5bc6\u9470\u7684 Vault \u670d\u52d9\u5668\u5df2\u6e96\u5099\u597d\uff0c\u63a5\u8457\u8b93\u6211\u5011\u914d\u7f6e\u4f86\u8b93 Kubernetes \u96c6\u7fa4\u548c\u90e8\u7f72\u5728\u5176\u4e2d\u7684 pod \u53ef\u9023\u63a5\u5230\u9019\u500b\u5916\u90e8\u7684 Vault \u670d\u52d9\u3002 \u555f\u52d5 Kubernetes \u00b6 k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u7d50\u679c: Kubernetes control plane is running at https://0.0.0.0:46339 CoreDNS is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy Metrics-server is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy Info \u5982\u679c\u6c92\u6709\u7279\u5225\u5b9a\u7fa9 K3D \u6703\u5728\u5275\u5efa Kubernetes \u96c6\u7fa4\u6642\u81ea\u52d5\u627e\u4e00\u500b\u53ef\u7528\u7684 port \u6210 Kubernetes API server \u4f7f\u7528\u7684 port\u3002 \u6c7a\u5b9a Vault address \u00b6 \u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5411 Kubernetes \u96c6\u7fa4\u7684 \u7db2\u95dc \u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u5c0b\u5740\u3002 1. \u53d6\u5f97\u672c\u6a5f\u7684\u7db2\u7d61\u4f4d\u5740 $ ifconfig wlp4s0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 192 .168.50.191 netmask 255 .255.255.0 broadcast 192 .168.50.255 inet6 fe80::3433:7b7c:e266:7a35 prefixlen 64 scopeid 0x20<link> ether 88 :b1:11:e5:6e:33 txqueuelen 1000 ( Ethernet ) RX packets 473363 bytes 659034753 ( 659 .0 MB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 96234 bytes 19111520 ( 19 .1 MB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \u5728\u7bc4\u4f8b\u7684\u6a5f\u5668\u4e0a\u7684\u7db2\u8def\u4f4d\u5740\u662f 192.168.50.191 (\u9019\u500b ip address \u5728\u4e0d\u540c\u7684\u6a5f\u5668\u4e0a\u90fd\u6703\u662f\u4e0d\u540c\u7684) !! 2. \u9a57\u8b49\u8207 Vault \u7684\u7db2\u7d61\u9023\u63a5 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5617\u8a66\u4f7f\u7528\u524d\u4e00\u6b65\u9a5f\u6240\u53d6\u7684\u7684 ip address \u4f86\u547c\u53eb external Vault \u7684 API\uff1a [ root@ca-test-pod:/ ] $ curl -s http://192.168.50.191:8200/v1/sys/seal-status { \"type\" : \"shamir\" , \"initialized\" :true, \"sealed\" :false, \"t\" :1, \"n\" :1, \"progress\" :0, \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" :false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" :false, \"storage_type\" : \"inmem\" } \u8f38\u51fa\u986f\u793a Vault \u5df2\u521d\u59cb\u5316\u4e14\u672a\u5bc6\u5c01\u3002\u9019\u78ba\u8a8d\u4e86\u96c6\u7fa4\u4e2d\u7684 pod \u80fd\u5920\u8a2a\u554f\u5230 external Vault\u3002 3. \u9000\u51fa pod \u6703\u8a71 [ root@ca-test-pod:/ ] $ exit 4. \u8a2d\u5b9a EXTERNAL_VAULT_ADDR \u74b0\u5883 \u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u5ba3\u544a Vault \u7684\u7db2\u7d61\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = 192 .168.50.191 5. \u9a57\u8b49\u8b8a\u91cf \u9a57\u8b49\u8b8a\u91cf\u3002 $ echo $EXTERNAL_VAULT_ADDR \u4f7f\u7528 hard-coded \u7684 Vault \u5730\u5740\u4f48\u7f72\u61c9\u7528\u7a0b\u5e8f \u00b6 Kubernetes \u96c6\u7fa4\u4e2d\u7684 pods \u627e\u5c0b \u5916\u90e8 Vault \u670d\u52d9\u4f4d\u5740\u7684\u6700\u76f4\u63a5\u65b9\u6cd5\u662f\u76f4\u63a5\u5728\u61c9\u7528\u7a0b\u5f0f\u7684\u7a0b\u5f0f\u78bc\u4e2d\u5b9a\u7fa9 (hard-coded) Valut \u7684\u7db2\u7d61\u4f4d\u5740\u6216\u628a Vault \u7684\u7db2\u7d61\u4f4d\u5740\u7528 \u74b0\u5883\u8b8a\u91cf \u9032\u884c\u63d0\u4f9b\u3002\u6211\u5011\u5df2\u7d93\u5275\u5efa\u4e26\u767c\u5e03\u4e86\u4e00\u500b\u5141\u8a31\u8a2d\u5b9a Vault \u5730\u5740\u7684 Web \u61c9\u7528\u7a0b\u5f0f\u3002 exampleapp config.ru lib/service.rb Dockerfile # This file is a configuration file for a Rackup application. # Load the service file found in the lib directory. require './lib/service' # This Sinatra web application was built in the Classic way. Which # is great for simple web application. Sinatra automatically provides # a class you can provide to Rackup's `run` method to start the # application. # # Read about the 'Modular vs. Classic Style' in the Sinatra README. # @see http://www.sinatrarb.com/intro.html run ExampleApp require \"sinatra\" require \"faraday\" require \"json\" require \"logger\" $stdout . sync = true class ExampleApp < Sinatra :: Base set :port , ENV [ 'SERVICE_PORT' ] || \"8080\" set :vault_token , ENV [ \"VAULT_TOKEN\" ] || \"root\" configure :development do logger = Logger . new ( STDOUT ) logger . level = Logger :: DEBUG set :raise_errors , true set :logger , logger set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://host.docker.internal:8200\" end configure :production do logger = Logger . new ( STDOUT ) logger . level = Logger :: INFO set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://vault:8200\" end # GET \"/\" get \"/\" do logger . info \"Received Request.\" # Set up an undefined state and set the vault server and secrets path secrets = { \"username\" => \"undefined\" , \"password\" => \"undefined\" } secrets_path = \"secret/data/devwebapp/config\" # Ask for the secret at the path vault_response = Faraday . get \" #{ settings . vault_url } /v1/ #{ secrets_path } \" do | req | req . headers [ 'Content-Type' ] = 'application/json' req . headers [ 'X-Vault-Token' ] = settings . vault_token end if vault_response . status != 200 raise Exception . new \"The secret request failed: #{ vault_response . body } \" end # Parse the JSON content = JSON . parse ( vault_response . body ) rescue {} # Traverse the response to find the secrets in the response if content . key? ( 'data' ) and content [ 'data' ]. key? ( 'data' ) secrets = content [ 'data' ][ 'data' ] end # Return secret secrets . to_s end end FROM ruby:2.6.2 RUN apt-get update && \\ apt-get install -y net-tools # Install gems ENV APP_HOME /app ENV HOME /root RUN mkdir $APP_HOME WORKDIR $APP_HOME COPY Gemfile* $APP_HOME / RUN bundle install # Upload source COPY config.ru $APP_HOME RUN mkdir $APP_HOME /lib COPY lib/* $APP_HOME /lib # Start server ENV PORT 8080 EXPOSE 8080 CMD [ \"rackup\" , \"--port\" , \"8080\" , \"--env\" , \"production\" ] 1. \u5275\u5efa internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236 $ kubectl create sa internal-app serviceaccount/internal-app created 2. \u8a2d\u7f6e EXTERNAL_VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u4f7f\u7528\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba EXTERNAL_VAULT_ADDR \u7684 Web \u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u4e00\u500b\u540d\u70ba devwebapp \u7684 pod\u3002 $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: internal-app containers: - name: app image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" - name: VAULT_TOKEN value: root EOF 3. \u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml pod/devwebapp created \u67e5\u770b pod/devwebapp \u7684\u898f\u683c: $ kubectl get pod/devwebapp -o yaml \u7d50\u679c: apiVersion : v1 kind : Pod metadata : annotations : ... ... app : devwebapp name : devwebapp namespace : default resourceVersion : \"1045\" uid : c41d0da7-e2d7-41ad-b3e5-b31a7a0c387a spec : containers : - env : - name : VAULT_ADDR value : http://192.168.50.191:8200 - name : VAULT_TOKEN value : root image : burtlo/devwebapp-ruby:k8s imagePullPolicy : IfNotPresent name : app resources : {} terminationMessagePath : /dev/termination-log terminationMessagePolicy : File volumeMounts : - mountPath : /var/run/secrets/kubernetes.io/serviceaccount name : kube-api-access-nhtdj readOnly : true dnsPolicy : ClusterFirst enableServiceLinks : true nodeName : minikube preemptionPolicy : PreemptLowerPriority priority : 0 restartPolicy : Always schedulerName : default-scheduler securityContext : {} serviceAccount : internal-app serviceAccountName : internal-app terminationGracePeriodSeconds : 30 tolerations : - effect : NoExecute key : node.kubernetes.io/not-ready operator : Exists tolerationSeconds : 300 - effect : NoExecute key : node.kubernetes.io/unreachable operator : Exists tolerationSeconds : 300 volumes : - name : kube-api-access-nhtdj projected : defaultMode : 420 sources : - serviceAccountToken : expirationSeconds : 3607 path : token - configMap : items : - key : ca.crt path : ca.crt name : kube-root-ca.crt - downwardAPI : items : - fieldRef : apiVersion : v1 fieldPath : metadata.namespace path : namespace 4. \u7372\u53d6 default \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 2m11s \u7b49\u5230 devwebapp pod \u5831\u544a\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 5. \u5f9e devwebapp pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u7684\u5167\u5bb9 $ kubectl exec devwebapp -- curl -s localhost:8080 ; echo \u7d50\u679c\u986f\u793a Secret \u662f\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u3002 {\"password\"=>\"salsa\", \"username\"=>\"giraffe\"} Web \u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u6839\u4ee4\u724c\u5411\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4e26\u8fd4\u56de\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u5bc6\u9470\u3002\u5982\u679c Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u4e0d\u8b8a\uff0c\u9019\u7a2e\u786c\u7de8\u78bc\u65b9\u6cd5\u662f\u4e00\u7a2e\u6709\u6548\u7684\u89e3\u6c7a\u65b9\u6848\u3002 \u5728 K8S \u90e8\u7f72 service \u548c endpoint \u4f86\u6620\u5c04\u81f3 external Vault \u00b6 \u5916\u90e8 Vault \u53ef\u80fd\u6c92\u6709 K8S \u96c6\u7fa4\u7684 Service \u53ef\u4ee5\u8b93\u76f8\u95dc\u7684 Pod \u4f86\u4f9d\u8cf4\u3002\u7576 Vault \u7684\u7db2\u8def\u5730\u5740\u66f4\u6539\u6642\uff0c\u6bcf\u500b Pod \u4e5f\u9700\u8981\u66f4\u6539\u624d\u80fd\u7e7c\u7e8c\u904b\u884c\u3002\u7ba1\u7406\u6b64\u7db2\u8def\u5730\u5740\u7684\u53e6\u4e00\u7a2e\u65b9\u6cd5\u662f\u5728Kubernetes \u4e2d\u901a\u904e\u5b9a\u7fa9 service \u548c endpoint \u7269\u4ef6\u4f86\u6307\u5411 Vault\u3002 Service \u7269\u4ef6\u662f\u5c0d Kubernetes \u5916\u90e8\u670d\u52d9\u7684\u62bd\u8c61\u8868\u793a\u3002\u7576\u5728 pod \u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u8acb\u6c42 service \u6642\uff0c\u8a72\u8acb\u6c42\u5c07\u88ab\u8def\u7531\u5230\u5171\u4eab service \u7684 endpoint \u3002 1. \u5b9a\u7fa9 service \u8207 endpoint \u7684\u7269\u4ef6 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba external-vault \u7684\u670d\u52d9\u548c\u4e00\u500b\u914d\u7f6e\u70ba\u5c0b\u5740 EXTERNAL_VAULT_ADDR \u7684\u76f8\u61c9\u7aef\u9ede\u3002 \u76f8\u95dc\u7684\u8aaa\u660e\u898b Kubernetes Service Overview \u3002 $ cat > external-vault.yaml <<EOF --- apiVersion: v1 kind: Service metadata: name: external-vault namespace: default spec: ports: - protocol: TCP port: 8200 --- apiVersion: v1 kind: Endpoints metadata: name: external-vault subsets: - addresses: - ip: $EXTERNAL_VAULT_ADDR ports: - port: 8200 EOF 2. \u5275\u5efa external-vault \u670d\u52d9 $ kubectl apply --filename external-vault.yaml service/external-vault created endpoints/external-vault created 3.\u9a57\u8b49 external-vault \u670d\u52d9\u662f\u5426\u53ef\u5f9e devwebapp pod \u4e2d\u5c0b\u5740 $ kubectl exec devwebapp -- curl -s http://external-vault:8200/v1/sys/seal-status | jq \u7d50\u679c\u986f\u793a Vault \u670d\u52d9\u5668\u7684\u72c0\u614b\u3002 { \"type\" : \"shamir\" , \"initialized\" : true, \"sealed\" : false, \"t\" : 1 , \"n\" : 1 , \"progress\" : 0 , \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" : false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" : false, \"storage_type\" : \"inmem\" } 4. \u5275\u5efa\u4e00\u500b\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba external-vault \u670d\u52d9\u7684 pod pod-devwebapp-through-service.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-through-service labels : app : devwebapp-through-service spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root devwebapp-through-service pod \u901a\u904eService name\u800c\u4e0d\u662f\u786c\u7de8\u78bc\u7684\u7db2\u7d61\u5730\u5740\u4f86\u5c0b\u5740 Vault\u3002 $ kubectl apply --filename = pod-devwebapp-through-service.yaml pod/devwebapp-through-service created 5. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 153m devwebapp-through-service 1 /1 Running 0 87s \u7b49\u5230 devwebapp-through-service pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 6. \u5f9e devwebapp-through-service pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u63d0\u4f9b\u7684\u5167\u5bb9 $ kubectl exec devwebapp-through-service -- curl -s localhost:8080 ; echo { \"password\" = > \"salsa\" , \"username\" = > \"giraffe\" } Web \u61c9\u7528\u7a0b\u5e8f\u5c0d\u5176\u901a\u904e external-Vault \u670d\u52d9\u627e\u5230\u7684\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u8acb\u6c42\u3002 \u5b89\u88dd\u914d\u7f6e\u70ba\u5c0b\u5740\u5916\u90e8 Vault \u7684 Vault Helm chart \u00b6 Vault Helm chart \u53ea\u80fd\u90e8\u7f72\u914d\u7f6e\u70ba\u4ee5\u5916\u90e8 Vault \u70ba\u76ee\u6a19\u7684 Vault Agent Injector \u670d\u52d9\u3002\u6ce8\u5165\u5668\u670d\u52d9\u901a\u904e\u5728\u5c07 Vault Agent \u5bb9\u5668\u81ea\u52d5\u5beb\u5165 pod \u6642\u6dfb\u52a0\u5b83\u5011\u4f86\u652f\u6301\u61c9\u7528\u7a0b\u5e8f\u7684\u8eab\u4efd\u9a57\u8b49\u548c\u79d8\u5bc6\u6aa2\u7d22\uff0c\u5b83\u5305\u542b\u7279\u5b9a\u7684\u8a3b\u91cb\u3002 \u5728\u672c\u7bc0\u4e2d\uff0c\u60a8\u5c07\u5b89\u88dd Vault Helm chart \u4e26\u555f\u52d5 Vault agent injector \u670d\u52d9\u3001\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u3001\u5275\u5efa\u89d2\u8272\u4ee5\u8a2a\u554f\u6a5f\u5bc6\u4ee5\u53ca\u4fee\u88dc\u90e8\u7f72\u3002 \u5b89\u88dd Vault Helm chart \u00b6 Vault Helm chart \u555f\u52d5 Vault Agent Injector \u670d\u52d9\u3002 1. \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" already exists with the same configuration, skipping 2. \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"hashicorp\" chart repository ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository Update Complete. \u2388Happy Helming!\u2388 3. \u5b89\u88dd\u5728\u5916\u90e8\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" NAME: vault LAST DEPLOYED: Wed Jul 13 16 :37:28 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault \u70ba injector.externalVaultAddr \u5206\u914d Deploy \u670d\u52d9\u548c\u7aef\u9ede\u4e2d\u5b9a\u7fa9\u7684 Kubernetes \u670d\u52d9\u7684\u5730\u5740\uff0c\u4ee5\u89e3\u6c7a\u5916\u90e8 Vault \u6b65\u9a5f\u3002 Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 4. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 31h devwebapp-through-service 1 /1 Running 0 29h vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 14m \u7b49\u5230 vault-agent-injector pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 Helm chart \u6703\u5275\u5efa\u4e00\u500b vault \u7684 service account\u3002Service account \u7684 JWT \u4ee4\u724c\u662f\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6240\u5fc5\u9700\u7684\u8a2d\u5b9a\u9805\u3002 5. \u63cf\u8ff0 Vault \u670d\u52d9\u5e33\u6236 $ kubectl describe serviceaccount vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: vault-token-kgdww Tokens: vault-token-kgdww Events: <none> 6. \u50c5\u9650 Kubernetes 1.24+ Mountable secrets \u7684\u540d\u7a31\u986f\u793a\u5728 Kubernetes 1.23 \u4e2d\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0cJWT \u4ee4\u724c\u4e0d\u6703\u81ea\u52d5\u5275\u5efa\uff0c\u60a8\u5fc5\u9808\u986f\u5f0f\u5275\u5efa\u5b83\u3002 cat > vault-secret.yaml <<EOF apiVersion: v1 kind: Secret metadata: name: vault-token-g955r annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u5275\u5efa\u4e00\u500b Secret \u3002 $ kubectl apply -f vault-secret.yaml secret/vault-token-g955r created $ kubectl describe sa vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: <none> Tokens: vault-token-kgdww Events: <none> 7. \u5275\u5efa\u4e00\u500b\u540d\u70ba VAULT_HELM_SECRET_NAME \u7684\u8b8a\u91cf\u4f86\u5b58\u5132\u5bc6\u9470\u540d\u7a31 $ VAULT_HELM_SECRET_NAME = $( kubectl get secrets --output = json | jq -r '.items[].metadata | select(.name|startswith(\"vault-token-\")).name' ) \u6b64\u547d\u4ee4\u904e\u6ffe\u4ee5 vault-token- \u958b\u982d\u7684\u79d8\u5bc6\u4e26\u8fd4\u56de\u4ee4\u724c\u7684\u540d\u7a31\u3002 8. \u63cf\u8ff0 Vault \u4ee4\u724c\u79d8\u5bc6 $ kubectl describe secret $VAULT_HELM_SECRET_NAME \u793a\u4f8b\u8f38\u51fa\uff1a $ kubectl describe secret $VAULT_HELM_SECRET_NAME Name: vault-token-kgdww Namespace: default Labels: <none> Annotations: kubernetes.io/service-account.name: vault kubernetes.io/service-account.uid: ab246d63-abae-4244-a173-5eb926e78913 Type: kubernetes.io/service-account-token Data ==== namespace: 7 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6Im1qb3FKczdnM1dFZnpDekd1N2tEU1B5YmhXZTFOVFpScjRxVm9oTUppQU0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InZhdWx0LXRva2VuLWc5NTVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYWIyNDZkNjMtYWJhZS00MjQ0LWExNzMtNWViOTI2ZTc4OTEzIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6dmF1bHQifQ.dVWwFxGLa-lxCqK2L0hllUI6KWAetnzAVMkjF3I7ybGxDq7JJcLyAil8Aym1rRK3gQBkwh1th0yHVrSfezBo0eEUgfPvzY4Qttqc1um3FN8dmPUdjnV4Gewr6hHEYijYtJJW7PWJYS7SmE3tnLuaaoyPFpXJBM-RyTW-aws9O5cZIVD18AI2G23MLhyt1D8nqZr39yyNPsPiwKPa-Ba0QYzMZUOh0AmcLEIP7yGnMM8OLKVeN7XMz7yKbCV1f85Nz0BgH-aPF1rYHr7gCZ5I0jRVPqqpmAl8Gje1OggWxekCnWhZZTmQtMXCR3L2e4q08P2LYTeiSxIiBFeyqjPZVg ca.crt: 1111 bytes \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49 \u00b6 Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 1. \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u6b64\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u914d\u7f6e\u7684 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002\u8981\u6b63\u78ba\u914d\u7f6e\u5b83\uff0c\u9700\u8981\u6355\u7372\u670d\u52d9\u5e33\u6236\u7684 JSON Web \u4ee4\u724c (JWT)\u3001Kubernetes CA \u8b49\u66f8\u548c Kubernetes \u4e3b\u6a5f URL\u3002 2. \u5f9e\u5bc6\u9470\u4e2d\u7372\u53d6 JSON Web \u4ee4\u724c (JWT) $ TOKEN_REVIEW_JWT = $( kubectl get secret $VAULT_HELM_SECRET_NAME --output = 'go-template={{ .data.token }}' | base64 --decode ) 3. \u6aa2\u7d22 Kubernetes CA \u8b49\u66f8 $ KUBE_CA_CERT = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) 4. \u6aa2\u7d22 Kubernetes \u4e3b\u6a5f URL $ KUBE_HOST = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.server}' ) 5. \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3001Kubernetes \u4e3b\u6a5f\u7684\u4f4d\u7f6e\u3001\u5176\u8b49\u66f8\u53ca\u5176\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u540d\u7a31 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $TOKEN_REVIEW_JWT \" \\ kubernetes_host = \" $KUBE_HOST \" \\ kubernetes_ca_cert = \" $KUBE_CA_CERT \" Success! Data written to: auth/kubernetes/config \u8981\u8b93 Vault \u5ba2\u6236\u7aef\u8b80\u53d6 Start Vault \u90e8\u5206\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 secret/data/devwebapp/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002 6. \u5b9a\u7fa9 devwebapp \u7684\u7b56\u7565\uff0c\u8a72\u7b56\u7565\u5728\u8def\u5f91 secret/data/devwebapp/config \u8655\u555f\u7528\u5c0d\u5bc6\u9470\u7684\u8b80\u53d6\u529f\u80fd $ vault policy write devwebapp - <<EOF path \"secret/data/devwebapp/config\" { capabilities = [\"read\"] } EOF Success! Uploaded policy: devwebapp 7. \u5728 Vault \u88e1\u5275\u5efa\u4e00\u500b\u540d\u70ba devweb-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49 role $ vault write auth/kubernetes/role/devweb-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = devwebapp \\ ttl = 24h Success! Data written to: auth/kubernetes/role/devweb-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001\u5167\u90e8\u61c9\u7528\u7a0b\u5e8f\u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 devwebapp \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002 \u5c07 Secret \u6ce8\u5165\u9032 pod \u00b6 Vault Agent Injector \u50c5\u5728 Pod \u6216\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u5c0d\u5176\u9032\u884c\u4fee\u6539\u3002 1.\u4f7f\u7528\u60a8\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4f7f\u7528\u8a3b\u91cb pod-devwebapp-with-annotations.yaml \u6aa2\u67e5 pod pod-devwebapp-with-annotations.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-with-annotations labels : app : devwebapp-with-annotations annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'devweb-app' vault.hashicorp.com/agent-inject-secret-credentials.txt : 'secret/data/devwebapp/config' spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector \u670d\u52d9 role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49 role agent-inject-secret-FILEPATH \u4f5c\u70ba\u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c credentials.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 2. \u5275\u5efa devwebapp-with-annotations pod $ kubectl apply --filename pod-devwebapp-with-annotations.yaml pod/devwebapp-with-annotations created 3. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 33h devwebapp-through-service 1 /1 Running 0 30h devwebapp-with-annotations 0 /2 Init:0/1 0 38s vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 104m \u7b49\u5230 devwebapp-with-annotations pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 Vault Agent Injector \u670d\u52d9\u5728 pod \u4e2d\u5275\u5efa\u4e86\u4e00\u500b\u9644\u52a0\u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u81ea\u52d5\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u8def\u5f91 /vault/secrets/credentials.txt \u8655\u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u3002 4. \u5728 devwebapp-with-annotations pod \u4e0a\u986f\u793a\u5beb\u5165\u6587\u4ef6 /vault/secrets/secret-credentials.txt \u7684\u6a5f\u5bc6 $ kubectl exec -it devwebapp-with-annotations -c app -- cat /vault/secrets/credentials.txt \u7d50\u679c\u986f\u793a\u5bb9\u5668\u4e0a\u5b58\u5728\u7684\u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u3002 data: map [ password:salsa username:giraffe ] metadata: map [ created_time:2022-06-06T18:26:14.070155Z custom_metadata:<nil> deletion_time: destroyed:false version:1 ] Tip \u683c\u5f0f\u5316\u6578\u64da\uff1a\u53ef\u4ee5\u61c9\u7528 \u6a21\u677f \u4f86\u683c\u5f0f\u5316\u9019\u4e9b\u6578\u64da\u4ee5\u6eff\u8db3\u61c9\u7528\u7a0b\u5e8f\u7684\u9700\u8981\u3002 \u9019\u500b pod \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u76f4\u63a5\u6aa2\u7d22\u79d8\u5bc6\uff0c\u4f46\u73fe\u5728\u6ce8\u5165\u5668\u670d\u52d9\u5df2\u90e8\u7f72\u4e26\u4e14\u80fd\u5920\u6aa2\u7d22\u61c9\u7528\u7a0b\u5e8f\u7684\u79d8\u5bc6\uff0c\u672a\u4f86\u7684\u66f4\u65b0\u53ef\u4ee5\u522a\u9664\u8a72\u61c9\u7528\u7a0b\u5e8f\u908f\u8f2f\u3002","title":"Kubernetes \u8207\u5916\u90e8 Vault \u6574\u5408"},{"location":"vault/kubernetes/kubernetes-external-vault/#kubernetes-vault","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-external-vault Vault \u53ef\u4ee5\u7ba1\u7406 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u7684\u6a5f\u5bc6\u3002\u901a\u5e38\u9019\u500b Vault \u670d\u52d9\u662f\u88ab\u4f48\u7f72\u5728 Kubernetes \u96c6\u7fa4\u4e4b\u5916\u3002 Info \u5728 Kubernetes \u4e2d\u904b\u884c Vault\uff1a\u5728 Vault Installation to Minikube via Helm \u548c Injecting Secrets into Kubernetes Pods via Vault Helm Sidecar \u6559\u7a0b\u4e2d\u63a2\u8a0e\u4e86\u5728 K8S \u96c6\u7fa4\u4e2d\u904b\u884c Vault \u670d\u52d9\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u5728\u672c\u5730\u904b\u884c Vault\uff0c\u4f7f\u7528 K3D \u555f\u52d5 Kubernetes \u96c6\u7fa4\uff0c\u90e8\u7f72\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f\uff0c\u8a72\u61c9\u7528\u7a0b\u5e8f\u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u76f4\u63a5\u5f9e Vault \u6aa2\u7d22\u6a5f\u5bc6\uff0c\u4e26\u901a\u904e Vault Agent Injector \u9032\u884c\u6a5f\u5bc6\u6ce8\u5165\u3002","title":"Kubernetes \u8207\u5916\u90e8 Vault \u6574\u5408"},{"location":"vault/kubernetes/kubernetes-external-vault/#_1","text":"\u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001K3D \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 K3D version. $ k3d version k3d version v5.4.1 k3s version v1.22.7-k3s1 ( default ) Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" } \u9019\u4e9b\u662f\u63a8\u85a6\u7684\u8edf\u4ef6\u7248\u672c\uff0c\u986f\u793a\u7684\u8f38\u51fa\u53ef\u80fd\u6703\u56e0\u60a8\u7684\u74b0\u5883\u548c\u60a8\u4f7f\u7528\u7684\u8edf\u4ef6\u7248\u672c\u800c\u7570\u3002 \u63a5\u4e0b\u4f86\uff0c\u901a\u904e\u5f9e GitHub \u4f86 clone hashcorp/vault-guides \u5b58\u5132\u5eab\uff0c\u88e1\u982d\u5305\u542b\u672c\u6559\u7a0b\u7528\u4f86\u9a57\u8b49\u7684\u7bc4\u4f8b Web \u61c9\u7528\u7a0b\u5e8f\u548c\u5176\u4ed6\u914d\u7f6e\u6a94\u6848\u3002 $ git clone https://github.com/hashicorp/vault-guides.git \u6b64\u5b58\u5132\u5eab\u5305\u542b\u6240\u6709 Vault \u5b78\u7fd2\u6307\u5357\u7684\u76f8\u95dc\u5167\u5bb9\u3002\u672c\u6559\u7a0b\u7684\u76f8\u95dc\u6587\u4ef6\u53ef\u4ee5\u5728\u5b50\u76ee\u9304\u4e2d\u627e\u5230\u3002 \u9032\u5165 vault-guides/operations/provision-vault/kubernetes/minikube/external-vault \u76ee\u9304\u3002 $ cd vault-guides/operations/provision-vault/kubernetes/minikube/external-vault Important \u5de5\u4f5c\u76ee\u9304\uff1a\u672c\u6559\u7a0b\u5047\u8a2d\u5176\u9918\u547d\u4ee4\u90fd\u5728\u6b64\u76ee\u9304\u4e2d\u57f7\u884c\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault","text":"\u53ea\u8981 Vault \u670d\u52d9\u5668\u662f\u7db2\u5740\u662f\u53ef\u88ab Kubernetes \u9023\u63a5\u5230\u7684\uff0c\u90a3\u9ebc\u904b\u884c\u5728 Kubernetes \u96c6\u7fa4\u5916\u90e8\u7684 Vault \u5c31\u53ef\u4ee5\u88ab\u5b83\u7684\u4efb\u4f55\u88ab\u4f48\u7f72\u5728 Kubernetes \u88e1\u7684 pod \u6240\u9023\u63a5\u3002 1. \u555f\u52d5 Vault \u670d\u52d9 \u6253\u958b\u4e00\u500b\u65b0\u7d42\u7aef\uff0c\u555f\u52d5\u4e00\u500b\u4ee5 root \u4f5c\u70ba root \u4ee4\u724c\u7684 Vault \u958b\u767c\u670d\u52d9\u5668\uff0c\u5b83\u5728 0.0.0.0:8200 \u8655\u5075\u807d\u8acb\u6c42\u3002 $ vault server -dev -dev-root-token-id root -dev-listen-address 0 .0.0.0:8200 \u5c07 -dev-listen-address \u8a2d\u7f6e\u70ba 0.0.0.0:8200 \u6703\u8986\u84cb Vault \u958b\u767c\u670d\u52d9\u5668\u7684\u9ed8\u8a8d\u5730\u5740 ( 127.0.0.1:8200 )\uff0c\u4e26\u4f7f Vault \u53ef\u4ee5\u88ab Kubernetes \u96c6\u7fa4\u53ca\u5176 Pod \u5c0b\u5740\uff0c\u56e0\u70ba\u5b83\u7d81\u5b9a\u5230\u5171\u4eab\u7db2\u7d61. 2. \u8a2d\u5b9a VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u70ba Vault CLI \u8a2d\u5b9a\u74b0\u5883\u8b8a\u91cf\u4f86\u66b4\u9732\u51fa Vault \u670d\u52d9\u5668\u7db2\u8def\u5730\u5740\u3002 $ export VAULT_ADDR = http://0.0.0.0:8200 \u60a8\u90e8\u7f72\u7684 Web \u61c9\u7528\u7a0b\u5e8f\u9700\u8981\u53d6\u5f97\u5132\u5b58\u5728 Vault \u88e1\u9762\u7684 username \u548c password \uff0c\u9019\u4e9b\u7528\u6236\u540d\u548c\u5bc6\u78bc\u7684\u6a5f\u654f\u8cc7\u8a0a\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002\u9ed8\u8a8d\u60c5\u6cc1\u4e0b\uff0cVault \u958b\u767c\u670d\u52d9\u5668\u4ee5\u5728\u4ee5 secret \u70ba\u524d\u7db4\u7684\u8def\u5f91\u4e0a\u555f\u7528\u9375\u503c\u6a5f\u5bc6\u5f15\u64ce\u555f\u52d5\u3002 3. \u4fbf\u7528 root \u4ee4\u724c\u767b\u5165 Vault \u5728\u555f\u52d5 Vault \u6642\u6211\u5011\u8a2d\u5b9a\u7684 root \u4ee4\u724c\u662f root $ vault login root Success! You are now authenticated. The token information displayed below is already stored in the token helper. You do NOT need to run \"vault login\" again. Future Vault requests will automatically use this token. Key Value --- ----- token root token_accessor OJU8So8T5wuCassRAJpNrfN4 token_duration \u221e token_renewable false token_policies [ \"root\" ] identity_policies [] policies [ \"root\" ] 4. \u5728 secret/devwebapp/config \u8a2d\u5b9a credential \u4f7f\u7528\u7528\u6236\u540d username \u548c\u5bc6\u78bc password \u5728\u88ab\u5275\u5efa\u5728\u8def\u5f91 secret/devwebapp/config \u4e0a\u3002 $ vault kv put secret/devwebapp/config username = 'giraffe' password = 'salsa' ======== Secret Path ======== secret/data/devwebapp/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-11T22:35:03.103203218Z custom_metadata <nil> deletion_time n/a destroyed false version 1 5. \u9a57\u8b49 Secret \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5b58\u5132\u5728\u8def\u5f91 secret/devwebapp/config \u4e2d\u3002 $ vault kv get -format = json secret/devwebapp/config | jq \".data.data\" { \"password\" : \"salsa\" , \"username\" : \"giraffe\" } \u5e36\u6709\u5bc6\u9470\u7684 Vault \u670d\u52d9\u5668\u5df2\u6e96\u5099\u597d\uff0c\u63a5\u8457\u8b93\u6211\u5011\u914d\u7f6e\u4f86\u8b93 Kubernetes \u96c6\u7fa4\u548c\u90e8\u7f72\u5728\u5176\u4e2d\u7684 pod \u53ef\u9023\u63a5\u5230\u9019\u500b\u5916\u90e8\u7684 Vault \u670d\u52d9\u3002","title":"\u555f\u52d5 Vault"},{"location":"vault/kubernetes/kubernetes-external-vault/#kubernetes","text":"k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u7d50\u679c: Kubernetes control plane is running at https://0.0.0.0:46339 CoreDNS is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy Metrics-server is running at https://0.0.0.0:46339/api/v1/namespaces/kube-system/services/https:metrics-server:https/proxy Info \u5982\u679c\u6c92\u6709\u7279\u5225\u5b9a\u7fa9 K3D \u6703\u5728\u5275\u5efa Kubernetes \u96c6\u7fa4\u6642\u81ea\u52d5\u627e\u4e00\u500b\u53ef\u7528\u7684 port \u6210 Kubernetes API server \u4f7f\u7528\u7684 port\u3002","title":"\u555f\u52d5 Kubernetes"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault-address","text":"\u6b63\u5982\u60a8\u914d\u7f6e Vault \u4e00\u6a23\uff0c\u7d81\u5b9a\u5230\u4e3b\u6a5f\u4e0a\u6240\u6709\u7db2\u7d61\u7684\u670d\u52d9\u53ef\u4ee5\u901a\u904e Minikube \u96c6\u7fa4\u4e2d\u7684 pod \u5411 Kubernetes \u96c6\u7fa4\u7684 \u7db2\u95dc \u5730\u5740\u767c\u9001\u8acb\u6c42\u4f86\u5c0b\u5740\u3002 1. \u53d6\u5f97\u672c\u6a5f\u7684\u7db2\u7d61\u4f4d\u5740 $ ifconfig wlp4s0: flags = 4163 <UP,BROADCAST,RUNNING,MULTICAST> mtu 1500 inet 192 .168.50.191 netmask 255 .255.255.0 broadcast 192 .168.50.255 inet6 fe80::3433:7b7c:e266:7a35 prefixlen 64 scopeid 0x20<link> ether 88 :b1:11:e5:6e:33 txqueuelen 1000 ( Ethernet ) RX packets 473363 bytes 659034753 ( 659 .0 MB ) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 96234 bytes 19111520 ( 19 .1 MB ) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0 \u5728\u7bc4\u4f8b\u7684\u6a5f\u5668\u4e0a\u7684\u7db2\u8def\u4f4d\u5740\u662f 192.168.50.191 (\u9019\u500b ip address \u5728\u4e0d\u540c\u7684\u6a5f\u5668\u4e0a\u90fd\u6703\u662f\u4e0d\u540c\u7684) !! 2. \u9a57\u8b49\u8207 Vault \u7684\u7db2\u7d61\u9023\u63a5 \u56de\u5230\u6211\u5011\u7684 Kubernetes \u96c6\u7fa4\u4e26\u904b\u884c\u4e00\u500b Pod\uff1a $ kubectl run -i --tty --rm ca-test-pod --image = radial/busyboxplus:curl [ root@ca-test-pod:/ ] $ \u5617\u8a66\u4f7f\u7528\u524d\u4e00\u6b65\u9a5f\u6240\u53d6\u7684\u7684 ip address \u4f86\u547c\u53eb external Vault \u7684 API\uff1a [ root@ca-test-pod:/ ] $ curl -s http://192.168.50.191:8200/v1/sys/seal-status { \"type\" : \"shamir\" , \"initialized\" :true, \"sealed\" :false, \"t\" :1, \"n\" :1, \"progress\" :0, \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" :false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" :false, \"storage_type\" : \"inmem\" } \u8f38\u51fa\u986f\u793a Vault \u5df2\u521d\u59cb\u5316\u4e14\u672a\u5bc6\u5c01\u3002\u9019\u78ba\u8a8d\u4e86\u96c6\u7fa4\u4e2d\u7684 pod \u80fd\u5920\u8a2a\u554f\u5230 external Vault\u3002 3. \u9000\u51fa pod \u6703\u8a71 [ root@ca-test-pod:/ ] $ exit 4. \u8a2d\u5b9a EXTERNAL_VAULT_ADDR \u74b0\u5883 \u5275\u5efa\u4e00\u500b\u540d\u70ba EXTERNAL_VAULT_ADDR \u7684\u8b8a\u91cf\u5ba3\u544a Vault \u7684\u7db2\u7d61\u5730\u5740\u3002 $ EXTERNAL_VAULT_ADDR = 192 .168.50.191 5. \u9a57\u8b49\u8b8a\u91cf \u9a57\u8b49\u8b8a\u91cf\u3002 $ echo $EXTERNAL_VAULT_ADDR","title":"\u6c7a\u5b9a Vault address"},{"location":"vault/kubernetes/kubernetes-external-vault/#hard-coded-vault","text":"Kubernetes \u96c6\u7fa4\u4e2d\u7684 pods \u627e\u5c0b \u5916\u90e8 Vault \u670d\u52d9\u4f4d\u5740\u7684\u6700\u76f4\u63a5\u65b9\u6cd5\u662f\u76f4\u63a5\u5728\u61c9\u7528\u7a0b\u5f0f\u7684\u7a0b\u5f0f\u78bc\u4e2d\u5b9a\u7fa9 (hard-coded) Valut \u7684\u7db2\u7d61\u4f4d\u5740\u6216\u628a Vault \u7684\u7db2\u7d61\u4f4d\u5740\u7528 \u74b0\u5883\u8b8a\u91cf \u9032\u884c\u63d0\u4f9b\u3002\u6211\u5011\u5df2\u7d93\u5275\u5efa\u4e26\u767c\u5e03\u4e86\u4e00\u500b\u5141\u8a31\u8a2d\u5b9a Vault \u5730\u5740\u7684 Web \u61c9\u7528\u7a0b\u5f0f\u3002 exampleapp config.ru lib/service.rb Dockerfile # This file is a configuration file for a Rackup application. # Load the service file found in the lib directory. require './lib/service' # This Sinatra web application was built in the Classic way. Which # is great for simple web application. Sinatra automatically provides # a class you can provide to Rackup's `run` method to start the # application. # # Read about the 'Modular vs. Classic Style' in the Sinatra README. # @see http://www.sinatrarb.com/intro.html run ExampleApp require \"sinatra\" require \"faraday\" require \"json\" require \"logger\" $stdout . sync = true class ExampleApp < Sinatra :: Base set :port , ENV [ 'SERVICE_PORT' ] || \"8080\" set :vault_token , ENV [ \"VAULT_TOKEN\" ] || \"root\" configure :development do logger = Logger . new ( STDOUT ) logger . level = Logger :: DEBUG set :raise_errors , true set :logger , logger set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://host.docker.internal:8200\" end configure :production do logger = Logger . new ( STDOUT ) logger . level = Logger :: INFO set :vault_url , ENV [ \"VAULT_ADDR\" ] || \"http://vault:8200\" end # GET \"/\" get \"/\" do logger . info \"Received Request.\" # Set up an undefined state and set the vault server and secrets path secrets = { \"username\" => \"undefined\" , \"password\" => \"undefined\" } secrets_path = \"secret/data/devwebapp/config\" # Ask for the secret at the path vault_response = Faraday . get \" #{ settings . vault_url } /v1/ #{ secrets_path } \" do | req | req . headers [ 'Content-Type' ] = 'application/json' req . headers [ 'X-Vault-Token' ] = settings . vault_token end if vault_response . status != 200 raise Exception . new \"The secret request failed: #{ vault_response . body } \" end # Parse the JSON content = JSON . parse ( vault_response . body ) rescue {} # Traverse the response to find the secrets in the response if content . key? ( 'data' ) and content [ 'data' ]. key? ( 'data' ) secrets = content [ 'data' ][ 'data' ] end # Return secret secrets . to_s end end FROM ruby:2.6.2 RUN apt-get update && \\ apt-get install -y net-tools # Install gems ENV APP_HOME /app ENV HOME /root RUN mkdir $APP_HOME WORKDIR $APP_HOME COPY Gemfile* $APP_HOME / RUN bundle install # Upload source COPY config.ru $APP_HOME RUN mkdir $APP_HOME /lib COPY lib/* $APP_HOME /lib # Start server ENV PORT 8080 EXPOSE 8080 CMD [ \"rackup\" , \"--port\" , \"8080\" , \"--env\" , \"production\" ] 1. \u5275\u5efa internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236 $ kubectl create sa internal-app serviceaccount/internal-app created 2. \u8a2d\u7f6e EXTERNAL_VAULT_ADDR \u74b0\u5883\u8b8a\u6578 \u4f7f\u7528\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba EXTERNAL_VAULT_ADDR \u7684 Web \u61c9\u7528\u7a0b\u5e8f\u5b9a\u7fa9\u4e00\u500b\u540d\u70ba devwebapp \u7684 pod\u3002 $ cat > devwebapp.yaml <<EOF apiVersion: v1 kind: Pod metadata: name: devwebapp labels: app: devwebapp spec: serviceAccountName: internal-app containers: - name: app image: burtlo/devwebapp-ruby:k8s env: - name: VAULT_ADDR value: \"http://$EXTERNAL_VAULT_ADDR:8200\" - name: VAULT_TOKEN value: root EOF 3. \u5275\u5efa devwebapp pod $ kubectl apply --filename devwebapp.yaml pod/devwebapp created \u67e5\u770b pod/devwebapp \u7684\u898f\u683c: $ kubectl get pod/devwebapp -o yaml \u7d50\u679c: apiVersion : v1 kind : Pod metadata : annotations : ... ... app : devwebapp name : devwebapp namespace : default resourceVersion : \"1045\" uid : c41d0da7-e2d7-41ad-b3e5-b31a7a0c387a spec : containers : - env : - name : VAULT_ADDR value : http://192.168.50.191:8200 - name : VAULT_TOKEN value : root image : burtlo/devwebapp-ruby:k8s imagePullPolicy : IfNotPresent name : app resources : {} terminationMessagePath : /dev/termination-log terminationMessagePolicy : File volumeMounts : - mountPath : /var/run/secrets/kubernetes.io/serviceaccount name : kube-api-access-nhtdj readOnly : true dnsPolicy : ClusterFirst enableServiceLinks : true nodeName : minikube preemptionPolicy : PreemptLowerPriority priority : 0 restartPolicy : Always schedulerName : default-scheduler securityContext : {} serviceAccount : internal-app serviceAccountName : internal-app terminationGracePeriodSeconds : 30 tolerations : - effect : NoExecute key : node.kubernetes.io/not-ready operator : Exists tolerationSeconds : 300 - effect : NoExecute key : node.kubernetes.io/unreachable operator : Exists tolerationSeconds : 300 volumes : - name : kube-api-access-nhtdj projected : defaultMode : 420 sources : - serviceAccountToken : expirationSeconds : 3607 path : token - configMap : items : - key : ca.crt path : ca.crt name : kube-root-ca.crt - downwardAPI : items : - fieldRef : apiVersion : v1 fieldPath : metadata.namespace path : namespace 4. \u7372\u53d6 default \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 2m11s \u7b49\u5230 devwebapp pod \u5831\u544a\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 5. \u5f9e devwebapp pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u7684\u5167\u5bb9 $ kubectl exec devwebapp -- curl -s localhost:8080 ; echo \u7d50\u679c\u986f\u793a Secret \u662f\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u3002 {\"password\"=>\"salsa\", \"username\"=>\"giraffe\"} Web \u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u6839\u4ee4\u724c\u5411\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\uff0c\u4e26\u8fd4\u56de\u5728 Vault \u8def\u5f91 secret/data/devwebapp/config \u4e2d\u5b9a\u7fa9\u7684\u5bc6\u9470\u3002\u5982\u679c Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u4e0d\u8b8a\uff0c\u9019\u7a2e\u786c\u7de8\u78bc\u65b9\u6cd5\u662f\u4e00\u7a2e\u6709\u6548\u7684\u89e3\u6c7a\u65b9\u6848\u3002","title":"\u4f7f\u7528 hard-coded \u7684 Vault \u5730\u5740\u4f48\u7f72\u61c9\u7528\u7a0b\u5e8f"},{"location":"vault/kubernetes/kubernetes-external-vault/#k8s-service-endpoint-external-vault","text":"\u5916\u90e8 Vault \u53ef\u80fd\u6c92\u6709 K8S \u96c6\u7fa4\u7684 Service \u53ef\u4ee5\u8b93\u76f8\u95dc\u7684 Pod \u4f86\u4f9d\u8cf4\u3002\u7576 Vault \u7684\u7db2\u8def\u5730\u5740\u66f4\u6539\u6642\uff0c\u6bcf\u500b Pod \u4e5f\u9700\u8981\u66f4\u6539\u624d\u80fd\u7e7c\u7e8c\u904b\u884c\u3002\u7ba1\u7406\u6b64\u7db2\u8def\u5730\u5740\u7684\u53e6\u4e00\u7a2e\u65b9\u6cd5\u662f\u5728Kubernetes \u4e2d\u901a\u904e\u5b9a\u7fa9 service \u548c endpoint \u7269\u4ef6\u4f86\u6307\u5411 Vault\u3002 Service \u7269\u4ef6\u662f\u5c0d Kubernetes \u5916\u90e8\u670d\u52d9\u7684\u62bd\u8c61\u8868\u793a\u3002\u7576\u5728 pod \u4e2d\u904b\u884c\u7684\u61c9\u7528\u7a0b\u5e8f\u8acb\u6c42 service \u6642\uff0c\u8a72\u8acb\u6c42\u5c07\u88ab\u8def\u7531\u5230\u5171\u4eab service \u7684 endpoint \u3002 1. \u5b9a\u7fa9 service \u8207 endpoint \u7684\u7269\u4ef6 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba external-vault \u7684\u670d\u52d9\u548c\u4e00\u500b\u914d\u7f6e\u70ba\u5c0b\u5740 EXTERNAL_VAULT_ADDR \u7684\u76f8\u61c9\u7aef\u9ede\u3002 \u76f8\u95dc\u7684\u8aaa\u660e\u898b Kubernetes Service Overview \u3002 $ cat > external-vault.yaml <<EOF --- apiVersion: v1 kind: Service metadata: name: external-vault namespace: default spec: ports: - protocol: TCP port: 8200 --- apiVersion: v1 kind: Endpoints metadata: name: external-vault subsets: - addresses: - ip: $EXTERNAL_VAULT_ADDR ports: - port: 8200 EOF 2. \u5275\u5efa external-vault \u670d\u52d9 $ kubectl apply --filename external-vault.yaml service/external-vault created endpoints/external-vault created 3.\u9a57\u8b49 external-vault \u670d\u52d9\u662f\u5426\u53ef\u5f9e devwebapp pod \u4e2d\u5c0b\u5740 $ kubectl exec devwebapp -- curl -s http://external-vault:8200/v1/sys/seal-status | jq \u7d50\u679c\u986f\u793a Vault \u670d\u52d9\u5668\u7684\u72c0\u614b\u3002 { \"type\" : \"shamir\" , \"initialized\" : true, \"sealed\" : false, \"t\" : 1 , \"n\" : 1 , \"progress\" : 0 , \"nonce\" : \"\" , \"version\" : \"1.11.0\" , \"build_date\" : \"2022-06-17T15:48:44Z\" , \"migration\" : false, \"cluster_name\" : \"vault-cluster-494486db\" , \"cluster_id\" : \"20c81ca5-5293-a454-2af1-aa1ba5825400\" , \"recovery_seal\" : false, \"storage_type\" : \"inmem\" } 4. \u5275\u5efa\u4e00\u500b\u5c07 VAULT_ADDR \u8a2d\u7f6e\u70ba external-vault \u670d\u52d9\u7684 pod pod-devwebapp-through-service.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-through-service labels : app : devwebapp-through-service spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root devwebapp-through-service pod \u901a\u904eService name\u800c\u4e0d\u662f\u786c\u7de8\u78bc\u7684\u7db2\u7d61\u5730\u5740\u4f86\u5c0b\u5740 Vault\u3002 $ kubectl apply --filename = pod-devwebapp-through-service.yaml pod/devwebapp-through-service created 5. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 153m devwebapp-through-service 1 /1 Running 0 87s \u7b49\u5230 devwebapp-through-service pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 6. \u5f9e devwebapp-through-service pod \u4e2d\u8acb\u6c42\u5728 localhost:8080 \u63d0\u4f9b\u7684\u5167\u5bb9 $ kubectl exec devwebapp-through-service -- curl -s localhost:8080 ; echo { \"password\" = > \"salsa\" , \"username\" = > \"giraffe\" } Web \u61c9\u7528\u7a0b\u5e8f\u5c0d\u5176\u901a\u904e external-Vault \u670d\u52d9\u627e\u5230\u7684\u5916\u90e8 Vault \u670d\u52d9\u5668\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u548c\u8acb\u6c42\u3002","title":"\u5728 K8S \u90e8\u7f72 service \u548c endpoint \u4f86\u6620\u5c04\u81f3 external Vault"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault-vault-helm-chart","text":"Vault Helm chart \u53ea\u80fd\u90e8\u7f72\u914d\u7f6e\u70ba\u4ee5\u5916\u90e8 Vault \u70ba\u76ee\u6a19\u7684 Vault Agent Injector \u670d\u52d9\u3002\u6ce8\u5165\u5668\u670d\u52d9\u901a\u904e\u5728\u5c07 Vault Agent \u5bb9\u5668\u81ea\u52d5\u5beb\u5165 pod \u6642\u6dfb\u52a0\u5b83\u5011\u4f86\u652f\u6301\u61c9\u7528\u7a0b\u5e8f\u7684\u8eab\u4efd\u9a57\u8b49\u548c\u79d8\u5bc6\u6aa2\u7d22\uff0c\u5b83\u5305\u542b\u7279\u5b9a\u7684\u8a3b\u91cb\u3002 \u5728\u672c\u7bc0\u4e2d\uff0c\u60a8\u5c07\u5b89\u88dd Vault Helm chart \u4e26\u555f\u52d5 Vault agent injector \u670d\u52d9\u3001\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u3001\u5275\u5efa\u89d2\u8272\u4ee5\u8a2a\u554f\u6a5f\u5bc6\u4ee5\u53ca\u4fee\u88dc\u90e8\u7f72\u3002","title":"\u5b89\u88dd\u914d\u7f6e\u70ba\u5c0b\u5740\u5916\u90e8 Vault \u7684 Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-external-vault/#vault-helm-chart","text":"Vault Helm chart \u555f\u52d5 Vault Agent Injector \u670d\u52d9\u3002 1. \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" already exists with the same configuration, skipping 2. \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"hashicorp\" chart repository ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository Update Complete. \u2388Happy Helming!\u2388 3. \u5b89\u88dd\u5728\u5916\u90e8\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668 $ helm install vault hashicorp/vault \\ --set \"injector.externalVaultAddr=http://external-vault:8200\" NAME: vault LAST DEPLOYED: Wed Jul 13 16 :37:28 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault \u70ba injector.externalVaultAddr \u5206\u914d Deploy \u670d\u52d9\u548c\u7aef\u9ede\u4e2d\u5b9a\u7fa9\u7684 Kubernetes \u670d\u52d9\u7684\u5730\u5740\uff0c\u4ee5\u89e3\u6c7a\u5916\u90e8 Vault \u6b65\u9a5f\u3002 Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 4. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 31h devwebapp-through-service 1 /1 Running 0 29h vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 14m \u7b49\u5230 vault-agent-injector pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 Helm chart \u6703\u5275\u5efa\u4e00\u500b vault \u7684 service account\u3002Service account \u7684 JWT \u4ee4\u724c\u662f\u914d\u7f6e Vault \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u6240\u5fc5\u9700\u7684\u8a2d\u5b9a\u9805\u3002 5. \u63cf\u8ff0 Vault \u670d\u52d9\u5e33\u6236 $ kubectl describe serviceaccount vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: vault-token-kgdww Tokens: vault-token-kgdww Events: <none> 6. \u50c5\u9650 Kubernetes 1.24+ Mountable secrets \u7684\u540d\u7a31\u986f\u793a\u5728 Kubernetes 1.23 \u4e2d\u3002\u5728 Kubernetes 1.24+ \u4e2d\uff0cJWT \u4ee4\u724c\u4e0d\u6703\u81ea\u52d5\u5275\u5efa\uff0c\u60a8\u5fc5\u9808\u986f\u5f0f\u5275\u5efa\u5b83\u3002 cat > vault-secret.yaml <<EOF apiVersion: v1 kind: Secret metadata: name: vault-token-g955r annotations: kubernetes.io/service-account.name: vault type: kubernetes.io/service-account-token EOF \u5275\u5efa\u4e00\u500b Secret \u3002 $ kubectl apply -f vault-secret.yaml secret/vault-token-g955r created $ kubectl describe sa vault Name: vault Namespace: default Labels: app.kubernetes.io/instance = vault app.kubernetes.io/managed-by = Helm app.kubernetes.io/name = vault helm.sh/chart = vault-0.20.1 Annotations: meta.helm.sh/release-name: vault meta.helm.sh/release-namespace: default Image pull secrets: <none> Mountable secrets: <none> Tokens: vault-token-kgdww Events: <none> 7. \u5275\u5efa\u4e00\u500b\u540d\u70ba VAULT_HELM_SECRET_NAME \u7684\u8b8a\u91cf\u4f86\u5b58\u5132\u5bc6\u9470\u540d\u7a31 $ VAULT_HELM_SECRET_NAME = $( kubectl get secrets --output = json | jq -r '.items[].metadata | select(.name|startswith(\"vault-token-\")).name' ) \u6b64\u547d\u4ee4\u904e\u6ffe\u4ee5 vault-token- \u958b\u982d\u7684\u79d8\u5bc6\u4e26\u8fd4\u56de\u4ee4\u724c\u7684\u540d\u7a31\u3002 8. \u63cf\u8ff0 Vault \u4ee4\u724c\u79d8\u5bc6 $ kubectl describe secret $VAULT_HELM_SECRET_NAME \u793a\u4f8b\u8f38\u51fa\uff1a $ kubectl describe secret $VAULT_HELM_SECRET_NAME Name: vault-token-kgdww Namespace: default Labels: <none> Annotations: kubernetes.io/service-account.name: vault kubernetes.io/service-account.uid: ab246d63-abae-4244-a173-5eb926e78913 Type: kubernetes.io/service-account-token Data ==== namespace: 7 bytes token: eyJhbGciOiJSUzI1NiIsImtpZCI6Im1qb3FKczdnM1dFZnpDekd1N2tEU1B5YmhXZTFOVFpScjRxVm9oTUppQU0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InZhdWx0LXRva2VuLWc5NTVyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6InZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiYWIyNDZkNjMtYWJhZS00MjQ0LWExNzMtNWViOTI2ZTc4OTEzIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6dmF1bHQifQ.dVWwFxGLa-lxCqK2L0hllUI6KWAetnzAVMkjF3I7ybGxDq7JJcLyAil8Aym1rRK3gQBkwh1th0yHVrSfezBo0eEUgfPvzY4Qttqc1um3FN8dmPUdjnV4Gewr6hHEYijYtJJW7PWJYS7SmE3tnLuaaoyPFpXJBM-RyTW-aws9O5cZIVD18AI2G23MLhyt1D8nqZr39yyNPsPiwKPa-Ba0QYzMZUOh0AmcLEIP7yGnMM8OLKVeN7XMz7yKbCV1f85Nz0BgH-aPF1rYHr7gCZ5I0jRVPqqpmAl8Gje1OggWxekCnWhZZTmQtMXCR3L2e4q08P2LYTeiSxIiBFeyqjPZVg ca.crt: 1111 bytes","title":"\u5b89\u88dd Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-external-vault/#kubernetes_1","text":"Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 1. \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5 $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u6b64\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u914d\u7f6e\u7684 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002\u8981\u6b63\u78ba\u914d\u7f6e\u5b83\uff0c\u9700\u8981\u6355\u7372\u670d\u52d9\u5e33\u6236\u7684 JSON Web \u4ee4\u724c (JWT)\u3001Kubernetes CA \u8b49\u66f8\u548c Kubernetes \u4e3b\u6a5f URL\u3002 2. \u5f9e\u5bc6\u9470\u4e2d\u7372\u53d6 JSON Web \u4ee4\u724c (JWT) $ TOKEN_REVIEW_JWT = $( kubectl get secret $VAULT_HELM_SECRET_NAME --output = 'go-template={{ .data.token }}' | base64 --decode ) 3. \u6aa2\u7d22 Kubernetes CA \u8b49\u66f8 $ KUBE_CA_CERT = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.certificate-authority-data}' | base64 --decode ) 4. \u6aa2\u7d22 Kubernetes \u4e3b\u6a5f URL $ KUBE_HOST = $( kubectl config view --raw --minify --flatten --output = 'jsonpath={.clusters[].cluster.server}' ) 5. \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3001Kubernetes \u4e3b\u6a5f\u7684\u4f4d\u7f6e\u3001\u5176\u8b49\u66f8\u53ca\u5176\u670d\u52d9\u5e33\u6236\u9812\u767c\u8005\u540d\u7a31 $ vault write auth/kubernetes/config \\ token_reviewer_jwt = \" $TOKEN_REVIEW_JWT \" \\ kubernetes_host = \" $KUBE_HOST \" \\ kubernetes_ca_cert = \" $KUBE_CA_CERT \" Success! Data written to: auth/kubernetes/config \u8981\u8b93 Vault \u5ba2\u6236\u7aef\u8b80\u53d6 Start Vault \u90e8\u5206\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 secret/data/devwebapp/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002 6. \u5b9a\u7fa9 devwebapp \u7684\u7b56\u7565\uff0c\u8a72\u7b56\u7565\u5728\u8def\u5f91 secret/data/devwebapp/config \u8655\u555f\u7528\u5c0d\u5bc6\u9470\u7684\u8b80\u53d6\u529f\u80fd $ vault policy write devwebapp - <<EOF path \"secret/data/devwebapp/config\" { capabilities = [\"read\"] } EOF Success! Uploaded policy: devwebapp 7. \u5728 Vault \u88e1\u5275\u5efa\u4e00\u500b\u540d\u70ba devweb-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49 role $ vault write auth/kubernetes/role/devweb-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = devwebapp \\ ttl = 24h Success! Data written to: auth/kubernetes/role/devweb-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001\u5167\u90e8\u61c9\u7528\u7a0b\u5e8f\u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 devwebapp \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002","title":"\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49"},{"location":"vault/kubernetes/kubernetes-external-vault/#secret-pod","text":"Vault Agent Injector \u50c5\u5728 Pod \u6216\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u5c0d\u5176\u9032\u884c\u4fee\u6539\u3002 1.\u4f7f\u7528\u60a8\u559c\u6b61\u7684\u6587\u672c\u7de8\u8f2f\u5668\u4e26\u4f7f\u7528\u8a3b\u91cb pod-devwebapp-with-annotations.yaml \u6aa2\u67e5 pod pod-devwebapp-with-annotations.yaml apiVersion : v1 kind : Pod metadata : name : devwebapp-with-annotations labels : app : devwebapp-with-annotations annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'devweb-app' vault.hashicorp.com/agent-inject-secret-credentials.txt : 'secret/data/devwebapp/config' spec : serviceAccountName : internal-app containers : - name : app image : burtlo/devwebapp-ruby:k8s env : - name : VAULT_ADDR value : \"http://external-vault:8200\" - name : VAULT_TOKEN value : root \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector \u670d\u52d9 role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49 role agent-inject-secret-FILEPATH \u4f5c\u70ba\u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c credentials.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 2. \u5275\u5efa devwebapp-with-annotations pod $ kubectl apply --filename pod-devwebapp-with-annotations.yaml pod/devwebapp-with-annotations created 3. \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod $ kubectl get pods NAME READY STATUS RESTARTS AGE devwebapp 1 /1 Running 0 33h devwebapp-through-service 1 /1 Running 0 30h devwebapp-with-annotations 0 /2 Init:0/1 0 38s vault-agent-injector-8679c9f654-trwvq 1 /1 Running 0 104m \u7b49\u5230 devwebapp-with-annotations pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 Vault Agent Injector \u670d\u52d9\u5728 pod \u4e2d\u5275\u5efa\u4e86\u4e00\u500b\u9644\u52a0\u5bb9\u5668\uff0c\u8a72\u5bb9\u5668\u81ea\u52d5\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u8def\u5f91 /vault/secrets/credentials.txt \u8655\u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u3002 4. \u5728 devwebapp-with-annotations pod \u4e0a\u986f\u793a\u5beb\u5165\u6587\u4ef6 /vault/secrets/secret-credentials.txt \u7684\u6a5f\u5bc6 $ kubectl exec -it devwebapp-with-annotations -c app -- cat /vault/secrets/credentials.txt \u7d50\u679c\u986f\u793a\u5bb9\u5668\u4e0a\u5b58\u5728\u7684\u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u3002 data: map [ password:salsa username:giraffe ] metadata: map [ created_time:2022-06-06T18:26:14.070155Z custom_metadata:<nil> deletion_time: destroyed:false version:1 ] Tip \u683c\u5f0f\u5316\u6578\u64da\uff1a\u53ef\u4ee5\u61c9\u7528 \u6a21\u677f \u4f86\u683c\u5f0f\u5316\u9019\u4e9b\u6578\u64da\u4ee5\u6eff\u8db3\u61c9\u7528\u7a0b\u5e8f\u7684\u9700\u8981\u3002 \u9019\u500b pod \u4e2d\u7684\u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u76f4\u63a5\u6aa2\u7d22\u79d8\u5bc6\uff0c\u4f46\u73fe\u5728\u6ce8\u5165\u5668\u670d\u52d9\u5df2\u90e8\u7f72\u4e26\u4e14\u80fd\u5920\u6aa2\u7d22\u61c9\u7528\u7a0b\u5e8f\u7684\u79d8\u5bc6\uff0c\u672a\u4f86\u7684\u66f4\u65b0\u53ef\u4ee5\u522a\u9664\u8a72\u61c9\u7528\u7a0b\u5e8f\u908f\u8f2f\u3002","title":"\u5c07 Secret \u6ce8\u5165\u9032 pod"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/","text":"\u901a\u904e\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u639b\u8f09 Vault Secret \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-secret-store-driver \u4f9d\u8cf4 Vault \u7ba1\u7406\u5176\u6a5f\u5bc6\u7684 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8acb\u6c42\u76f4\u63a5\u6aa2\u7d22\u5b83\u5011\uff0c\u6216\u8005\u901a\u904e Vault Injector \u670d\u52d9\u901a\u904e\u8a3b\u91cb\u6216\u9644\u52a0\u70ba\u81e8\u6642\u5377\u5728\u5df2\u5b89\u88dd\u7684\u6587\u4ef6\u7cfb\u7d71\u4e0a\u7dad\u8b77\u5b83\u5011\u3002\u9019\u7a2e\u4f7f\u7528\u81e8\u6642\u5377\u5b58\u5132\u6a5f\u5bc6\u7684\u65b9\u6cd5\u662f Kubernetes \u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u9a45\u52d5\u7a0b\u5e8f\u7684 Secrets Store \u64f4\u5c55\u7684\u4e00\u500b\u529f\u80fd\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Helm chart \u8a2d\u7f6e Vault \u53ca\u5176\u4f9d\u8cf4\u9805\u3002\u7136\u5f8c\u555f\u7528\u4e26\u914d\u7f6e secrets store CSI driver \u4ee5\u5275\u5efa\u4e00\u500b\u5305\u542b\u60a8\u5c07\u639b\u8f09\u5230\u61c9\u7528\u7a0b\u5e8f pod \u7684\u79d8\u5bc6\u7684 volume\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 Minikube version. $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7 Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" } \u555f\u52d5 Kubernetes \u00b6 Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u7528\u65bc\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002\u9019\u4e9b\u96c6\u7fa4\u5728\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u904b\u884c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \ud83c\udf89 minikube 1 .26.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.26.0 \ud83d\udca1 To disable this notice, run: 'minikube config set WantUpdateNotification false' \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 2 , Memory = 3900MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u986f\u793a Kubernetes \u96c6\u7fa4\u7684\u7248\u672c\u3002 $ kubectl version --output = json { \"clientVersion\" : { \"major\" : \"1\" , \"minor\" : \"24\" , \"gitVersion\" : \"v1.24.1\" , \"gitCommit\" : \"3ddd0f45aa91e2f30c70734b175631bec5b5825a\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-05-24T12:26:19Z\" , \"goVersion\" : \"go1.18.2\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } , \"kustomizeVersion\" : \"v4.5.4\" , \"serverVersion\" : { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } } \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Runningk3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684\u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 kubelet: Running apiserver: Running kubeconfig: Configured k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u4e3b\u6a5f\u3001kubelet\u3001apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002 \u5b89\u88dd Vault Helm chart \u00b6 Vault \u7ba1\u7406\u5beb\u5165\u9019\u4e9b\u53ef\u639b\u8f09\u5377\u7684\u6a5f\u5bc6\u3002\u8981\u63d0\u4f9b\u9019\u4e9b\u6a5f\u5bc6\uff0c\u9700\u8981\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u5c0d\u65bc\u6b64\u6f14\u793a\uff0cVault \u53ef\u4ee5\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\uff0c\u4ee5\u81ea\u52d5\u8655\u7406 KV \u6a5f\u5bc6\u5f15\u64ce\u7684\u521d\u59cb\u5316\u3001\u89e3\u5c01\u548c\u8a2d\u7f6e\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository ...Successfully got an update from the \"hashicorp\" chart repository Update Complete. \u2388Happy Helming!\u2388 \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u4e26\u7981\u7528\u6ce8\u5165\u5668\u670d\u52d9\u4e26\u555f\u7528 CSI\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \\ --set \"injector.enabled=false\" \\ --set \"csi.enabled=true\" \u793a\u4f8b\u8f38\u51fa\uff1a NAME: vault LAST DEPLOYED: Sun Jul 10 22 :23:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault Vault \u670d\u52d9\u5668\u5728\u55ae\u500b pod server.dev.enabled=true \u4e0a\u4ee5\u958b\u767c\u6a21\u5f0f\u904b\u884c\u3002 Vault Agent Injector pod \u88ab\u7981\u7528 injector.enabled=false \u4e26\u4e14 Vault CSI Provider pod csi.enabled=true \u88ab\u555f\u7528\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 16m vault-csi-provider-8kxjg 1 /1 Running 0 16m \u7b49\u5230 vault-0 pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 Vault \u4e2d\u8a2d\u7f6e Secret \u00b6 \u5728 Create a pod with secretmounted \u90e8\u5206\u4e2d\u639b\u8f09\u5230 pod \u7684\u6372\u9700\u8981\u5b58\u5132\u5728\u8def\u5f91 secret/data/db-pass \u4e2d\u7684 secret\u3002\u7576 Vault \u5728\u958b\u767c\u4e2d\u904b\u884c\u6642\uff0c\u5728\u8def\u5f91 /secret \u4e2d\u555f\u7528\u4e86 KV \u79d8\u5bc6\u5f15\u64ce\u3002 \u9996\u5148\uff0c\u5728 vault-0 pod \u4e0a\u555f\u52d5\u4e00\u500b\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 / $ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u4f7f\u7528\u5bc6\u78bc\u5728\u8def\u5f91 secret/db-pass \u8655\u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put secret/db-pass password = \"db-secret-password\" === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u5728\u8def\u5f91 secret/db-pass \u4e0a\u662f\u5426\u53ef\u8b80\u3002 / $ vault kv get secret/db-pass === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password \u914d\u7f6e Kubernetes authentication \u00b6 Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication \u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u8a2a\u554f\u5bc6\u9470\u548c\u5275\u5efa\u5377\u7684 Kubernetes \u8cc7\u6e90\u901a\u904e\u6b64\u65b9\u6cd5\u901a\u904e\u89d2\u8272\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ \u4f7f\u7528 Kubernetes API \u5730\u5740\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5b83\u5c07\u81ea\u52d5\u4f7f\u7528 Vault pod \u81ea\u5df1\u7684\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config \u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684\u7b56\u7565\u3002\u9019\u5c07\u7528\u65bc\u6388\u4e88 webapp-sa \u670d\u52d9\u5e33\u6236\u8b80\u53d6\u4e4b\u524d\u5275\u5efa\u7684 kv \u5bc6\u9470\u7684\u6b0a\u9650\u3002 / $ vault policy write internal-app - <<EOF path \"secret/data/db-pass\" { capabilities = [\"read\"] } EOF kv-v2 \u7684\u6578\u64da\u8981\u6c42\u5728\u5176\u639b\u8f09\u8def\u5f91\uff08\u672c\u4f8b\u4e2d\u70ba secret/ \uff09\u4e4b\u5f8c\u5305\u542b\u984d\u5916\u7684\u6578\u64da\u8def\u5f91\u5143\u7d20\u3002 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba database \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\uff0c\u8a72\u89d2\u8272\u5c07\u6b64\u7b56\u7565\u8207\u540d\u70ba webapp-sa \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u7d81\u5b9a\u3002 / $ vault write auth/kubernetes/role/database \\ bound_service_account_names = webapp-sa \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 20m \u7d50\u679c: Success! Data written to: auth/kubernetes/role/database \u8a72\u89d2\u8272\u5c07\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u4e2d\u7684 Kubernetes \u670d\u52d9\u5e33\u6236 webapp-sa \u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 20 \u5206\u9418\u3002\u9019\u500b Kubernetes \u670d\u52d9\u5e33\u6236\u540d\u7a31 webapp-sa \u5c07\u5728\u4e0b\u9762\u5275\u5efa\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit \u5b89\u88dd secrets store CSI driver \u00b6 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f secrets-store.csi.k8s.io \u5141\u8a31 Kubernetes \u5c07\u5b58\u5132\u5728\u4f01\u696d\u7d1a\u5916\u90e8\u6a5f\u5bc6\u5b58\u5132\u4e2d\u7684\u591a\u500b\u6a5f\u5bc6\u3001\u5bc6\u9470\u548c\u8b49\u66f8\u4f5c\u70ba\u5377\u639b\u8f09\u5230\u5176 pod \u4e2d\u3002\u9644\u52a0\u5377\u5f8c\uff0c\u5176\u4e2d\u7684\u6578\u64da\u5c07\u88ab\u639b\u8f09\u5230\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u6dfb\u52a0 Secrets Store CSI \u9a45\u52d5 Helm \u5b58\u5132\u5eab\u3002 $ helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts \"secrets-store-csi-driver\" has been added to your repositories \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Kubernetes Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u3002 $ helm install csi secrets-store-csi-driver/secrets-store-csi-driver \\ --set syncSecret.enabled = true \u7d50\u679c: NAME: csi LAST DEPLOYED: Sun Jul 10 23 :57:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: The Secrets Store CSI Driver is getting deployed to your cluster. To verify that Secrets Store CSI Driver has started, run: kubectl --namespace = default get pods -l \"app=secrets-store-csi-driver\" Now you can follow these steps https://secrets-store-csi-driver.sigs.k8s.io/getting-started/usage.html to create a SecretProviderClass resource, and a deployment using the SecretProviderClass. \u9a57\u8b49 Vault CSI provider \u555f\u52d5\u72c0\u614b \u00b6 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u652f\u6301\u901a\u904e\u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u64f4\u5c55\u3002\u63d0\u4f9b\u8005\u4f5c\u70ba Kubernetes DaemonSet \u8207 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f DaemonSet \u4e00\u8d77\u555f\u52d5\u3002 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u901a\u904e Vault Helm chart \u5b89\u88dd\u5728 Vault \u65c1\u908a\u3002 \u6b64 DaemonSet \u555f\u52d5\u5176\u81ea\u5df1\u7684\u63d0\u4f9b\u7a0b\u5e8f pod \u4e26\u904b\u884c\u4e00\u500b gRPC \u670d\u52d9\u5668\uff0cSecrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9023\u63a5\u5230\u8a72\u670d\u52d9\u5668\u4ee5\u767c\u51fa\u5377\u639b\u8f09\u8acb\u6c42\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\uff0c\u4ee5\u6aa2\u67e5 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 4m58s vault-0 1 /1 Running 0 99m vault-csi-provider-8kxjg 1 /1 Running 0 99m \u7b49\u5230 vault-csi-provider pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5b9a\u7fa9 SecretProviderClass resource \u00b6 Kubernetes Secrets Store CSI Driver Helm \u5716\u8868\u70ba SecretProviderClass \u8cc7\u6e90\u5275\u5efa\u5b9a\u7fa9\u3002\u6b64\u8cc7\u6e90\u63cf\u8ff0\u4e86\u63d0\u4f9b\u7d66 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u7684\u53c3\u6578\u3002\u8981\u914d\u7f6e\u5b83\uff0c\u9700\u8981 Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u3001Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u7684\u540d\u7a31\u548c\u6a5f\u5bc6\u3002 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u5275\u5efa vault-database \u7684 SecretProviderClass\u3002 $ kubectl apply --filename spc-vault-database.yaml secretproviderclass.secrets-store.csi.x-k8s.io/vault-database created vault-database \u7684 SecretProviderClass \u63cf\u8ff0\u4e86\u4e00\u500b Secret \u7269\u4ef6\uff1a objectName \u662f secret \u7684 symbolic name \u8207\u8981\u69cb\u5efa\u7684\u6a94\u6848\u540d\u7a31\u3002 secretPath \u662f secret \u5b9a\u7fa9\u5728 Vault \u88e1\u7684\u8def\u5f91\u3002 secretKey \u662f secret \u88e1\u7684\u9375\u540d(key name)\u3002 \u9a57\u8b49\u5df2\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5b9a\u7fa9\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ kubectl describe SecretProviderClass vault-database Name: vault-database Namespace: default Labels: <none> Annotations: kubectl.kubernetes.io/last-applied-configuration: { \"apiVersion\" : \"secrets-store.csi.x-k8s.io/v1\" , \"kind\" : \"SecretProviderClass\" , \"metadata\" : { \"annotations\" : {} , \"name\" : \"vault-database\" , \"namespace... API Version: secrets-store.csi.x-k8s.io/v1 Kind: SecretProviderClass ## ... \u5275\u5efa\u4e00\u500b\u639b\u8f09 secret \u7684 pod \u00b6 \u5c07 secret \u5b58\u5132\u5728 Vault \u4e2d\uff0c\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u4e26\u5275\u5efa\u89d2\u8272\uff0c\u5b89\u88dd provider-vault \u64f4\u5c55\u4e26\u5b9a\u7fa9 SecretProviderClass \uff0c\u6700\u5f8c\u662f\u6642\u5019\u5275\u5efa\u4e00\u500b\u639b\u8f09\u6240\u9700\u6a5f\u5bc6\u7684 pod\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba webapp-sa \u7684\u670d\u52d9\u5e33\u6236\u3002 $ kubectl create serviceaccount webapp-sa \u5b9a\u7fa9\u639b\u8f09\u79d8\u5bc6\u5377\u7684 webapp pod\u3002 $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF webapp pod \u5b9a\u7fa9\u4e86\u4e00\u500b\u552f\u8b80\u5377(volume)\u4e26\u5c07\u5176\u639b\u8f09\u5230 /mnt/secrets-store \u3002\u5728 vault-database SecretProviderClass \u4e2d\u5b9a\u7fa9\u7684\u7269\u4ef6\u5c07\u88ab\u5beb\u5165\u81f3\u8a72\u8def\u5f91\u4e2d\u7684\u6587\u4ef6\u3002 \u5275\u5efa webapp pod \u3002 $ kubectl apply --filename webapp-pod.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 6h23m vault-0 1 /1 Running 0 7h57m vault-csi-provider-8kxjg 1 /1 Running 0 7h57m webapp \u7b49\u5230 webapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 webapp pod \u4e0a\u7684 /mnt/secrets-store/db-password \u4e2d\u986f\u793a\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u7684\u5bc6\u78bc\u6a5f\u5bc6\u3002 $ kubectl exec webapp -- cat /mnt/secrets-store/db-password db-secret-password \u986f\u793a\u7684\u503c\u8207\u79d8\u5bc6 secret/db-pass \u7684\u5bc6\u78bc\u503c\u5339\u914d\u3002 \u540c\u6b65\u5230 Kubernetes Secret \u00b6 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9084\u652f\u6301\u540c\u6b65\u5230 Kubernetes \u7684 Secret \u7269\u4ef6\u3002 Kubernetes Secret \u586b\u5145\u4e86 CSI \u5377\u4e2d\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u5b83\u5011\u7684\u751f\u547d\u9031\u671f\u8207\u5275\u5efa\u5b83\u5011\u7684 pod \u7684\u751f\u547d\u9031\u671f\u5bc6\u5207\u76f8\u95dc\u3002 \u8981\u70ba\u60a8\u7684 webapp pod \u6dfb\u52a0 secret \u540c\u6b65\uff0c\u8acb\u66f4\u65b0 SecretProviderClass \u4ee5\u6dfb\u52a0\u4e00\u500b secretObjects \u689d\u76ee\uff1a $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault secretObjects: - data: - key: password objectName: db-password secretName: dbpass type: Opaque parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u61c9\u7528\u66f4\u6539\uff1a $ kubectl apply --filename spc-vault-database.yaml \u7576 pod \u5f15\u7528\u6b64 SecretProviderClass \u6642\uff0cCSI \u9a45\u52d5\u7a0b\u5e8f\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dbpass \u7684 Kubernetes secret\uff0c\u5176\u4e2d password \u5b57\u6bb5\u8a2d\u7f6e\u70ba\u53c3\u6578\u4e2d db-password \u5c0d\u8c61\u7684\u5167\u5bb9\u3002 Pod \u6703\u5728\u555f\u52d5\u524d\u7b49\u5f85 Secret \u88ab\u5275\u5efa\uff0c\u7576 Pod \u505c\u6b62\u6642\uff0cSecret \u6703\u88ab\u522a\u9664 \u3002 \u63a5\u4e0b\u4f86\uff0c\u66f4\u65b0 pod \u4ee5\u5f15\u7528\u65b0\u7684 secret\uff1a $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp env: - name: DB_PASSWORD valueFrom: secretKeyRef: name: dbpass key: password volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF \u8acb\u6ce8\u610f\uff0c\u73fe\u5728\u6709\u4e00\u500b env \u689d\u76ee\uff0c\u5f15\u7528\u4e86\u4e00\u500b\u79d8\u5bc6\u3002\u522a\u9664\u4e26\u91cd\u65b0\u90e8\u7f72 pod\uff1a $ kubectl delete pod webapp && kubectl apply --filename webapp-pod.yaml \u90e8\u7f72\u66f4\u65b0\u7684\u914d\u7f6e\u4e26\u7b49\u5f85 webapp pod \u518d\u6b21\u51fa\u73fe\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-w2xxv 3 /3 Running 0 4m28s vault-0 1 /1 Running 0 5m57s vault-csi-provider-qxz8d 1 /1 Running 0 5m57s webapp 1 /1 Running 0 36s \u60a8\u73fe\u5728\u53ef\u4ee5\u9a57\u8b49 Kubernetes \u5bc6\u9470\u662f\u5426\u5df2\u5275\u5efa\uff1a $ kubectl get secret dbpass NAME TYPE DATA AGE dbpass Opaque 1 100s \u60a8\u9084\u53ef\u4ee5\u9a57\u8b49\u8a72\u79d8\u5bc6\u5728 pod \u7684\u74b0\u5883\u4e2d\u662f\u5426\u53ef\u7528\uff1a $ kubectl exec webapp -- env | grep DB_PASSWORD DB_PASSWORD = db-secret-password","title":"\u901a\u904e\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u639b\u8f09 Vault Secret"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#csi-vault-secret","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-secret-store-driver \u4f9d\u8cf4 Vault \u7ba1\u7406\u5176\u6a5f\u5bc6\u7684 Kubernetes \u61c9\u7528\u7a0b\u5e8f pod \u53ef\u4ee5\u901a\u904e\u7db2\u7d61\u8acb\u6c42\u76f4\u63a5\u6aa2\u7d22\u5b83\u5011\uff0c\u6216\u8005\u901a\u904e Vault Injector \u670d\u52d9\u901a\u904e\u8a3b\u91cb\u6216\u9644\u52a0\u70ba\u81e8\u6642\u5377\u5728\u5df2\u5b89\u88dd\u7684\u6587\u4ef6\u7cfb\u7d71\u4e0a\u7dad\u8b77\u5b83\u5011\u3002\u9019\u7a2e\u4f7f\u7528\u81e8\u6642\u5377\u5b58\u5132\u6a5f\u5bc6\u7684\u65b9\u6cd5\u662f Kubernetes \u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u9a45\u52d5\u7a0b\u5e8f\u7684 Secrets Store \u64f4\u5c55\u7684\u4e00\u500b\u529f\u80fd\u3002 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Helm chart \u8a2d\u7f6e Vault \u53ca\u5176\u4f9d\u8cf4\u9805\u3002\u7136\u5f8c\u555f\u7528\u4e26\u914d\u7f6e secrets store CSI driver \u4ee5\u5275\u5efa\u4e00\u500b\u5305\u542b\u60a8\u5c07\u639b\u8f09\u5230\u61c9\u7528\u7a0b\u5e8f pod \u7684\u79d8\u5bc6\u7684 volume\u3002","title":"\u901a\u904e\u5bb9\u5668\u5b58\u5132\u63a5\u53e3 (CSI) \u639b\u8f09 Vault Secret"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#_1","text":"\u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI\u3001Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 Docker version. $ docker --version Docker version 20 .10.17, build 100c701 Minikube version. $ minikube version minikube version: v1.25.2 commit: 362d5fdc0a3dbee389b3d3f1034e8023e72bd3a7 Helm version. $ helm version version.BuildInfo { Version: \"v3.9.0\" , GitCommit: \"7ceeda6c585217a19a1131663d8cd1f7d641b2a7\" , GitTreeState: \"clean\" , GoVersion: \"go1.17.5\" }","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#kubernetes","text":"Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u7528\u65bc\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002\u9019\u4e9b\u96c6\u7fa4\u5728\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u904b\u884c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.25.2 on Ubuntu 21 .10 \ud83c\udf89 minikube 1 .26.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.26.0 \ud83d\udca1 To disable this notice, run: 'minikube config set WantUpdateNotification false' \u2728 Automatically selected the docker driver. Other choices: virtualbox, ssh \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\ude9c Pulling base image ... \ud83d\udd25 Creating docker container ( CPUs = 2 , Memory = 3900MB ) ... \ud83d\udc33 Preparing Kubernetes v1.23.3 on Docker 20 .10.12 ... \u25aa kubelet.housekeeping-interval = 5m \u25aa Generating certificates and keys ... \u25aa Booting up control plane ... \u25aa Configuring RBAC rules ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u986f\u793a Kubernetes \u96c6\u7fa4\u7684\u7248\u672c\u3002 $ kubectl version --output = json { \"clientVersion\" : { \"major\" : \"1\" , \"minor\" : \"24\" , \"gitVersion\" : \"v1.24.1\" , \"gitCommit\" : \"3ddd0f45aa91e2f30c70734b175631bec5b5825a\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-05-24T12:26:19Z\" , \"goVersion\" : \"go1.18.2\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } , \"kustomizeVersion\" : \"v4.5.4\" , \"serverVersion\" : { \"major\" : \"1\" , \"minor\" : \"23\" , \"gitVersion\" : \"v1.23.3\" , \"gitCommit\" : \"816c97ab8cff8a1c72eccca1026f7820e93e0d25\" , \"gitTreeState\" : \"clean\" , \"buildDate\" : \"2022-01-25T21:19:12Z\" , \"goVersion\" : \"go1.17.6\" , \"compiler\" : \"gc\" , \"platform\" : \"linux/amd64\" } } \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Runningk3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684\u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 kubelet: Running apiserver: Running kubeconfig: Configured k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u4e3b\u6a5f\u3001kubelet\u3001apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002","title":"\u555f\u52d5 Kubernetes"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#vault-helm-chart","text":"Vault \u7ba1\u7406\u5beb\u5165\u9019\u4e9b\u53ef\u639b\u8f09\u5377\u7684\u6a5f\u5bc6\u3002\u8981\u63d0\u4f9b\u9019\u4e9b\u6a5f\u5bc6\uff0c\u9700\u8981\u4e00\u500b Vault \u670d\u52d9\u5668\u3002\u5c0d\u65bc\u6b64\u6f14\u793a\uff0cVault \u53ef\u4ee5\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\uff0c\u4ee5\u81ea\u52d5\u8655\u7406 KV \u6a5f\u5bc6\u5f15\u64ce\u7684\u521d\u59cb\u5316\u3001\u89e3\u5c01\u548c\u8a2d\u7f6e\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \"hashicorp\" has been added to your repositories \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update Hang tight while we grab the latest from your chart repositories... ...Successfully got an update from the \"secrets-store-csi-driver\" chart repository ...Successfully got an update from the \"hashicorp\" chart repository Update Complete. \u2388Happy Helming!\u2388 \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault Helm chart\uff0c\u4e26\u7981\u7528\u6ce8\u5165\u5668\u670d\u52d9\u4e26\u555f\u7528 CSI\u3002 $ helm install vault hashicorp/vault \\ --set \"server.dev.enabled=true\" \\ --set \"injector.enabled=false\" \\ --set \"csi.enabled=true\" \u793a\u4f8b\u8f38\u51fa\uff1a NAME: vault LAST DEPLOYED: Sun Jul 10 22 :23:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 NOTES: Thank you for installing HashiCorp Vault! Now that you have deployed Vault, you should look over the docs on using Vault with Kubernetes available here: https://www.vaultproject.io/docs/ Your release is named vault. To learn more about the release, try: $ helm status vault $ helm get manifest vault Vault \u670d\u52d9\u5668\u5728\u55ae\u500b pod server.dev.enabled=true \u4e0a\u4ee5\u958b\u767c\u6a21\u5f0f\u904b\u884c\u3002 Vault Agent Injector pod \u88ab\u7981\u7528 injector.enabled=false \u4e26\u4e14 Vault CSI Provider pod csi.enabled=true \u88ab\u555f\u7528\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 16m vault-csi-provider-8kxjg 1 /1 Running 0 16m \u7b49\u5230 vault-0 pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002","title":"\u5b89\u88dd Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#vault-secret","text":"\u5728 Create a pod with secretmounted \u90e8\u5206\u4e2d\u639b\u8f09\u5230 pod \u7684\u6372\u9700\u8981\u5b58\u5132\u5728\u8def\u5f91 secret/data/db-pass \u4e2d\u7684 secret\u3002\u7576 Vault \u5728\u958b\u767c\u4e2d\u904b\u884c\u6642\uff0c\u5728\u8def\u5f91 /secret \u4e2d\u555f\u7528\u4e86 KV \u79d8\u5bc6\u5f15\u64ce\u3002 \u9996\u5148\uff0c\u5728 vault-0 pod \u4e0a\u555f\u52d5\u4e00\u500b\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 / $ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u4f7f\u7528\u5bc6\u78bc\u5728\u8def\u5f91 secret/db-pass \u8655\u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put secret/db-pass password = \"db-secret-password\" === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u5728\u8def\u5f91 secret/db-pass \u4e0a\u662f\u5426\u53ef\u8b80\u3002 / $ vault kv get secret/db-pass === Secret Path === secret/data/db-pass ======= Metadata ======= Key Value --- ----- created_time 2022 -07-10T15:17:48.580178065Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password","title":"\u5728 Vault \u4e2d\u8a2d\u7f6e Secret"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#kubernetes-authentication","text":"Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication \u65b9\u6cd5\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes \u670d\u52d9\u5e33\u6236\u4ee4\u724c\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u8a2a\u554f\u5bc6\u9470\u548c\u5275\u5efa\u5377\u7684 Kubernetes \u8cc7\u6e90\u901a\u904e\u6b64\u65b9\u6cd5\u901a\u904e\u89d2\u8272\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002 \u555f\u7528 Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ \u4f7f\u7528 Kubernetes API \u5730\u5740\u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u3002\u5b83\u5c07\u81ea\u52d5\u4f7f\u7528 Vault pod \u81ea\u5df1\u7684\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" \u7d50\u679c: Success! Data written to: auth/kubernetes/config \u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684\u7b56\u7565\u3002\u9019\u5c07\u7528\u65bc\u6388\u4e88 webapp-sa \u670d\u52d9\u5e33\u6236\u8b80\u53d6\u4e4b\u524d\u5275\u5efa\u7684 kv \u5bc6\u9470\u7684\u6b0a\u9650\u3002 / $ vault policy write internal-app - <<EOF path \"secret/data/db-pass\" { capabilities = [\"read\"] } EOF kv-v2 \u7684\u6578\u64da\u8981\u6c42\u5728\u5176\u639b\u8f09\u8def\u5f91\uff08\u672c\u4f8b\u4e2d\u70ba secret/ \uff09\u4e4b\u5f8c\u5305\u542b\u984d\u5916\u7684\u6578\u64da\u8def\u5f91\u5143\u7d20\u3002 \u6700\u5f8c\uff0c\u5275\u5efa\u4e00\u500b\u540d\u70ba database \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\uff0c\u8a72\u89d2\u8272\u5c07\u6b64\u7b56\u7565\u8207\u540d\u70ba webapp-sa \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u7d81\u5b9a\u3002 / $ vault write auth/kubernetes/role/database \\ bound_service_account_names = webapp-sa \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 20m \u7d50\u679c: Success! Data written to: auth/kubernetes/role/database \u8a72\u89d2\u8272\u5c07\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u4e2d\u7684 Kubernetes \u670d\u52d9\u5e33\u6236 webapp-sa \u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 20 \u5206\u9418\u3002\u9019\u500b Kubernetes \u670d\u52d9\u5e33\u6236\u540d\u7a31 webapp-sa \u5c07\u5728\u4e0b\u9762\u5275\u5efa\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit","title":"\u914d\u7f6e Kubernetes authentication"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#secrets-store-csi-driver","text":"Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f secrets-store.csi.k8s.io \u5141\u8a31 Kubernetes \u5c07\u5b58\u5132\u5728\u4f01\u696d\u7d1a\u5916\u90e8\u6a5f\u5bc6\u5b58\u5132\u4e2d\u7684\u591a\u500b\u6a5f\u5bc6\u3001\u5bc6\u9470\u548c\u8b49\u66f8\u4f5c\u70ba\u5377\u639b\u8f09\u5230\u5176 pod \u4e2d\u3002\u9644\u52a0\u5377\u5f8c\uff0c\u5176\u4e2d\u7684\u6578\u64da\u5c07\u88ab\u639b\u8f09\u5230\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u6dfb\u52a0 Secrets Store CSI \u9a45\u52d5 Helm \u5b58\u5132\u5eab\u3002 $ helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts \"secrets-store-csi-driver\" has been added to your repositories \u5b89\u88dd\u6700\u65b0\u7248\u672c\u7684 Kubernetes Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u3002 $ helm install csi secrets-store-csi-driver/secrets-store-csi-driver \\ --set syncSecret.enabled = true \u7d50\u679c: NAME: csi LAST DEPLOYED: Sun Jul 10 23 :57:05 2022 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None NOTES: The Secrets Store CSI Driver is getting deployed to your cluster. To verify that Secrets Store CSI Driver has started, run: kubectl --namespace = default get pods -l \"app=secrets-store-csi-driver\" Now you can follow these steps https://secrets-store-csi-driver.sigs.k8s.io/getting-started/usage.html to create a SecretProviderClass resource, and a deployment using the SecretProviderClass.","title":"\u5b89\u88dd secrets store CSI driver"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#vault-csi-provider","text":"Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u652f\u6301\u901a\u904e\u63d0\u4f9b\u7a0b\u5e8f\u9032\u884c\u64f4\u5c55\u3002\u63d0\u4f9b\u8005\u4f5c\u70ba Kubernetes DaemonSet \u8207 Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f DaemonSet \u4e00\u8d77\u555f\u52d5\u3002 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u901a\u904e Vault Helm chart \u5b89\u88dd\u5728 Vault \u65c1\u908a\u3002 \u6b64 DaemonSet \u555f\u52d5\u5176\u81ea\u5df1\u7684\u63d0\u4f9b\u7a0b\u5e8f pod \u4e26\u904b\u884c\u4e00\u500b gRPC \u670d\u52d9\u5668\uff0cSecrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9023\u63a5\u5230\u8a72\u670d\u52d9\u5668\u4ee5\u767c\u51fa\u5377\u639b\u8f09\u8acb\u6c42\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\uff0c\u4ee5\u6aa2\u67e5 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u662f\u5426\u6b63\u5728\u904b\u884c\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 4m58s vault-0 1 /1 Running 0 99m vault-csi-provider-8kxjg 1 /1 Running 0 99m \u7b49\u5230 vault-csi-provider pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002","title":"\u9a57\u8b49 Vault CSI provider \u555f\u52d5\u72c0\u614b"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#secretproviderclass-resource","text":"Kubernetes Secrets Store CSI Driver Helm \u5716\u8868\u70ba SecretProviderClass \u8cc7\u6e90\u5275\u5efa\u5b9a\u7fa9\u3002\u6b64\u8cc7\u6e90\u63cf\u8ff0\u4e86\u63d0\u4f9b\u7d66 Vault CSI \u63d0\u4f9b\u7a0b\u5e8f\u7684\u53c3\u6578\u3002\u8981\u914d\u7f6e\u5b83\uff0c\u9700\u8981 Vault \u670d\u52d9\u5668\u7684\u5730\u5740\u3001Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u7684\u540d\u7a31\u548c\u6a5f\u5bc6\u3002 \u5b9a\u7fa9\u4e00\u500b\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u5275\u5efa vault-database \u7684 SecretProviderClass\u3002 $ kubectl apply --filename spc-vault-database.yaml secretproviderclass.secrets-store.csi.x-k8s.io/vault-database created vault-database \u7684 SecretProviderClass \u63cf\u8ff0\u4e86\u4e00\u500b Secret \u7269\u4ef6\uff1a objectName \u662f secret \u7684 symbolic name \u8207\u8981\u69cb\u5efa\u7684\u6a94\u6848\u540d\u7a31\u3002 secretPath \u662f secret \u5b9a\u7fa9\u5728 Vault \u88e1\u7684\u8def\u5f91\u3002 secretKey \u662f secret \u88e1\u7684\u9375\u540d(key name)\u3002 \u9a57\u8b49\u5df2\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5b9a\u7fa9\u540d\u70ba vault-database \u7684 SecretProviderClass \u3002 $ kubectl describe SecretProviderClass vault-database Name: vault-database Namespace: default Labels: <none> Annotations: kubectl.kubernetes.io/last-applied-configuration: { \"apiVersion\" : \"secrets-store.csi.x-k8s.io/v1\" , \"kind\" : \"SecretProviderClass\" , \"metadata\" : { \"annotations\" : {} , \"name\" : \"vault-database\" , \"namespace... API Version: secrets-store.csi.x-k8s.io/v1 Kind: SecretProviderClass ## ...","title":"\u5b9a\u7fa9 SecretProviderClass resource"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#secret-pod","text":"\u5c07 secret \u5b58\u5132\u5728 Vault \u4e2d\uff0c\u914d\u7f6e\u8eab\u4efd\u9a57\u8b49\u4e26\u5275\u5efa\u89d2\u8272\uff0c\u5b89\u88dd provider-vault \u64f4\u5c55\u4e26\u5b9a\u7fa9 SecretProviderClass \uff0c\u6700\u5f8c\u662f\u6642\u5019\u5275\u5efa\u4e00\u500b\u639b\u8f09\u6240\u9700\u6a5f\u5bc6\u7684 pod\u3002 \u5275\u5efa\u4e00\u500b\u540d\u70ba webapp-sa \u7684\u670d\u52d9\u5e33\u6236\u3002 $ kubectl create serviceaccount webapp-sa \u5b9a\u7fa9\u639b\u8f09\u79d8\u5bc6\u5377\u7684 webapp pod\u3002 $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF webapp pod \u5b9a\u7fa9\u4e86\u4e00\u500b\u552f\u8b80\u5377(volume)\u4e26\u5c07\u5176\u639b\u8f09\u5230 /mnt/secrets-store \u3002\u5728 vault-database SecretProviderClass \u4e2d\u5b9a\u7fa9\u7684\u7269\u4ef6\u5c07\u88ab\u5beb\u5165\u81f3\u8a72\u8def\u5f91\u4e2d\u7684\u6587\u4ef6\u3002 \u5275\u5efa webapp pod \u3002 $ kubectl apply --filename webapp-pod.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u5167\u7684\u6240\u6709 pod\u3002 NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-45w5k 3 /3 Running 0 6h23m vault-0 1 /1 Running 0 7h57m vault-csi-provider-8kxjg 1 /1 Running 0 7h57m webapp \u7b49\u5230 webapp pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 webapp pod \u4e0a\u7684 /mnt/secrets-store/db-password \u4e2d\u986f\u793a\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u7684\u5bc6\u78bc\u6a5f\u5bc6\u3002 $ kubectl exec webapp -- cat /mnt/secrets-store/db-password db-secret-password \u986f\u793a\u7684\u503c\u8207\u79d8\u5bc6 secret/db-pass \u7684\u5bc6\u78bc\u503c\u5339\u914d\u3002","title":"\u5275\u5efa\u4e00\u500b\u639b\u8f09 secret \u7684 pod"},{"location":"vault/kubernetes/kubernetes-secret-store-driver/#kubernetes-secret","text":"Secrets Store CSI \u9a45\u52d5\u7a0b\u5e8f\u9084\u652f\u6301\u540c\u6b65\u5230 Kubernetes \u7684 Secret \u7269\u4ef6\u3002 Kubernetes Secret \u586b\u5145\u4e86 CSI \u5377\u4e2d\u6587\u4ef6\u7684\u5167\u5bb9\uff0c\u5b83\u5011\u7684\u751f\u547d\u9031\u671f\u8207\u5275\u5efa\u5b83\u5011\u7684 pod \u7684\u751f\u547d\u9031\u671f\u5bc6\u5207\u76f8\u95dc\u3002 \u8981\u70ba\u60a8\u7684 webapp pod \u6dfb\u52a0 secret \u540c\u6b65\uff0c\u8acb\u66f4\u65b0 SecretProviderClass \u4ee5\u6dfb\u52a0\u4e00\u500b secretObjects \u689d\u76ee\uff1a $ cat > spc-vault-database.yaml <<EOF apiVersion: secrets-store.csi.x-k8s.io/v1 kind: SecretProviderClass metadata: name: vault-database spec: provider: vault secretObjects: - data: - key: password objectName: db-password secretName: dbpass type: Opaque parameters: vaultAddress: \"http://vault.default:8200\" roleName: \"database\" objects: | - objectName: \"db-password\" secretPath: \"secret/data/db-pass\" secretKey: \"password\" EOF \u61c9\u7528\u66f4\u6539\uff1a $ kubectl apply --filename spc-vault-database.yaml \u7576 pod \u5f15\u7528\u6b64 SecretProviderClass \u6642\uff0cCSI \u9a45\u52d5\u7a0b\u5e8f\u5c07\u5275\u5efa\u4e00\u500b\u540d\u70ba dbpass \u7684 Kubernetes secret\uff0c\u5176\u4e2d password \u5b57\u6bb5\u8a2d\u7f6e\u70ba\u53c3\u6578\u4e2d db-password \u5c0d\u8c61\u7684\u5167\u5bb9\u3002 Pod \u6703\u5728\u555f\u52d5\u524d\u7b49\u5f85 Secret \u88ab\u5275\u5efa\uff0c\u7576 Pod \u505c\u6b62\u6642\uff0cSecret \u6703\u88ab\u522a\u9664 \u3002 \u63a5\u4e0b\u4f86\uff0c\u66f4\u65b0 pod \u4ee5\u5f15\u7528\u65b0\u7684 secret\uff1a $ cat > webapp-pod.yaml <<EOF kind: Pod apiVersion: v1 metadata: name: webapp spec: serviceAccountName: webapp-sa containers: - image: jweissig/app:0.0.1 name: webapp env: - name: DB_PASSWORD valueFrom: secretKeyRef: name: dbpass key: password volumeMounts: - name: secrets-store-inline mountPath: \"/mnt/secrets-store\" readOnly: true volumes: - name: secrets-store-inline csi: driver: secrets-store.csi.k8s.io readOnly: true volumeAttributes: secretProviderClass: \"vault-database\" EOF \u8acb\u6ce8\u610f\uff0c\u73fe\u5728\u6709\u4e00\u500b env \u689d\u76ee\uff0c\u5f15\u7528\u4e86\u4e00\u500b\u79d8\u5bc6\u3002\u522a\u9664\u4e26\u91cd\u65b0\u90e8\u7f72 pod\uff1a $ kubectl delete pod webapp && kubectl apply --filename webapp-pod.yaml \u90e8\u7f72\u66f4\u65b0\u7684\u914d\u7f6e\u4e26\u7b49\u5f85 webapp pod \u518d\u6b21\u51fa\u73fe\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE csi-secrets-store-csi-driver-w2xxv 3 /3 Running 0 4m28s vault-0 1 /1 Running 0 5m57s vault-csi-provider-qxz8d 1 /1 Running 0 5m57s webapp 1 /1 Running 0 36s \u60a8\u73fe\u5728\u53ef\u4ee5\u9a57\u8b49 Kubernetes \u5bc6\u9470\u662f\u5426\u5df2\u5275\u5efa\uff1a $ kubectl get secret dbpass NAME TYPE DATA AGE dbpass Opaque 1 100s \u60a8\u9084\u53ef\u4ee5\u9a57\u8b49\u8a72\u79d8\u5bc6\u5728 pod \u7684\u74b0\u5883\u4e2d\u662f\u5426\u53ef\u7528\uff1a $ kubectl exec webapp -- env | grep DB_PASSWORD DB_PASSWORD = db-secret-password","title":"\u540c\u6b65\u5230 Kubernetes Secret"},{"location":"vault/kubernetes/kubernetes-sidecar/","text":"\u901a\u904e Vault Agent \u5bb9\u5668\u5c07 Secret \u6ce8\u5165 Kubernetes Pod \u00b6 \u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-sidecar \u90e8\u7f72\u4f7f\u7528 Vault \u4f86\u4fdd\u5b58\u8207\u61c9\u7528\u5e33\u5bc6\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\uff1a \u9a57\u8b49\u4e26\u7372\u53d6\u5ba2\u6236\u7aef\u4ee4\u724c\u3002 \u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u3002 \u5f9e Vault \u4e2d\u6aa2\u7d22\u79d8\u5bc6\u3002 \u7ba1\u7406\u4efb\u4f55\u52d5\u614b\u6a5f\u5bc6\u7684\u79df\u7d04\u3002 Vault Agent \u8ca0\u8cac\u9019\u4e9b\u4efb\u52d9\u4e26\u4f7f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u611f\u53d7\u4e0d\u5230 Vault \u7684\u5b58\u5728\u3002\u9019\u6a23\u7684\u6574\u5408\u5f15\u5165\u4e86\u4e00\u9805\u65b0\u8981\u6c42\uff0c\u4e5f\u5c31\u662f\u5c07 Vault Agent \u8207\u61c9\u7528\u7a0b\u5e8f\u4e00\u8d77\u5b89\u88dd\u548c\u914d\u7f6e\u70ba sidecar \u3002 Vault Helm chart \u4f7f\u60a8\u80fd\u5920\u904b\u884c Vault \u548c Vault Agent Injector \u670d\u52d9\u3002\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u5229\u7528 Kubernetes mutating admission webhook \u4f86\u6514\u622a\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684 pod\uff0c\u4e26\u8a3b\u5165 Vault Agent \u5bb9\u5668\u4f86\u7ba1\u7406\u9019\u4e9b\u6a5f\u5bc6\u3002\u9019\u662f\u5f88\u6709\u5e6b\u52a9\uff0c\u56e0\u70ba\uff1a \u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u4e0d\u77e5\u9053 Vault\uff0c\u56e0\u70ba\u6a5f\u5bc6\u5b58\u5132\u5728\u5176\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u73fe\u6709\u90e8\u7f72\u7121\u9700\u66f4\u6539\uff1b\u56e0\u70ba\u53ef\u4ee5\u4fee\u88dc\u8a3b\u91cb\u3002 \u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u5e33\u6236\u548c\u547d\u540d\u7a7a\u9593\u5f37\u5236\u8a2a\u554f\u6a5f\u5bc6 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Vault Helm chart \u8a2d\u7f6e Vault \u548c\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u3002\u7136\u5f8c\uff0c\u60a8\u5c07\u90e8\u7f72\u5e7e\u500b\u61c9\u7528\u7a0b\u5e8f\u4f86\u6f14\u793a\u9019\u500b\u65b0\u7684\u6ce8\u5165\u5668\u670d\u52d9\u5982\u4f55\u6aa2\u7d22\u548c\u5beb\u5165\u9019\u4e9b\u79d8\u5bc6\u4ee5\u4f9b\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u3002 \u5148\u6c7a\u689d\u4ef6 \u00b6 \u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI \u3001 Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002 \u555f\u52d5 Kubernetes \u00b6 Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u53ef\u5728\u7cfb\u7d71\u4e0a\u7684\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.19.0 on Darwin 11 .2.3 \u2728 Using the docker driver based on existing profile \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\udd04 Restarting existing docker container for \"minikube\" ... \ud83d\udc33 Preparing Kubernetes v1.20.2 on Docker 20 .10.5 ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u521d\u59cb\u5316\u904e\u7a0b\u9700\u8981\u5e7e\u5206\u9418\uff0c\u56e0\u70ba\u5b83\u6703\u6aa2\u7d22\u4efb\u4f55\u5fc5\u8981\u7684\u4f9d\u8cf4\u9805\u4e26\u57f7\u884c\u5404\u7a2e\u5bb9\u5668\u6620\u50cf\u3002 \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured \u4e3b\u6a5f\u3001kubelet \u548c apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002 Minikube \u5728\u57fa\u65bc Web \u7684\u5100\u8868\u677f\u4e2d\u63d0\u4f9b\u72c0\u614b\u7684\u53ef\u8996\u5316\u8868\u793a\u3002\u8a72\u754c\u9762\u5728\u53ef\u8996\u5316\u754c\u9762\u4e2d\u986f\u793a\u96c6\u7fa4\u6d3b\u52d5\uff0c\u6709\u52a9\u65bc\u6df1\u5165\u7814\u7a76\u5f71\u97ff\u5b83\u7684\u554f\u984c\u3002 \u5728\u53e6\u4e00\u500b\u7d42\u7aef\u4e2d\uff0c\u555f\u52d5 minikube \u5100\u8868\u677f\u3002 $ minikube dashboard \u64cd\u4f5c\u7cfb\u7d71\u7684\u9ed8\u8a8d\u700f\u89bd\u5668\u6253\u958b\u4e26\u986f\u793a\u5100\u8868\u677f\u3002 k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info \u5b89\u88dd Vault Helm chart \u00b6 \u5728 Kubernetes \u4e0a\u904b\u884c Vault \u7684\u63a8\u85a6\u65b9\u6cd5\u662f\u901a\u904e Helm chart \u3002 Helm \u662f\u4e00\u500b\u5305\u7ba1\u7406\u5668\uff0c\u5b83\u5b89\u88dd\u548c\u914d\u7f6e\u6240\u6709\u5fc5\u8981\u7684\u7d44\u4ef6\u4ee5\u5728\u5e7e\u7a2e\u4e0d\u540c\u7684\u6a21\u5f0f\u4e0b\u904b\u884c Vault\u3002 Helm chart \u5305\u62ec\u555f\u7528\u689d\u4ef6\u548c\u53c3\u6578\u5316\u57f7\u884c\u7684\u6a21\u677f\u3002\u9019\u4e9b\u53c3\u6578\u53ef\u4ee5\u901a\u904e\u547d\u4ee4\u884c\u53c3\u6578\u8a2d\u7f6e\u6216\u5728 YAML \u4e2d\u5b9a\u7fa9\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668\u3002 $ helm install vault hashicorp/vault --set \"server.dev.enabled=true\" Vault pod \u548c Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 80s vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 80s vault-0 pod \u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c Vault \u670d\u52d9\u5668\u3002 vault-agent-injector pod \u6839\u64da\u90e8\u7f72\u4e2d\u5b58\u5728\u6216\u4fee\u88dc\u7684\u8a3b\u91cb\u57f7\u884c\u6ce8\u5165\u3002 Info \u958b\u767c\u6a21\u5f0f\uff1a\u5728\u958b\u767c\u4e2d\u904b\u884c Vault \u670d\u52d9\u5668\u6703\u81ea\u52d5\u521d\u59cb\u5316\u548c\u89e3\u5c01\u3002\u9019\u5728\u5b78\u7fd2\u74b0\u5883\u4e2d\u662f\u7406\u60f3\u7684\uff0c\u4f46\u4e0d\u5efa\u8b70\u5728\u751f\u7522\u74b0\u5883\u4e2d\u4f7f\u7528\u3002 \u7b49\u5230 vault-0 pod \u548c vault-agent-injector pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002 \u5728 Vault \u4e2d\u8a2d\u5b9a Secret \u00b6 \u60a8\u5728\u5c07\u6a5f\u5bc6\u6ce8\u5165 pod \u90e8\u5206\u4e2d\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u671f\u671b Vault \u5b58\u5132\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff0c\u8a72\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5b58\u5132\u5728\u8def\u5f91 internal/database/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 /$ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u5728 internal \u8def\u5f91\u555f\u7528 kv-v2 \u6a5f\u5bc6\u5b58\u5132\u3002 / $ vault secrets enable -path = internal kv-v2 Success! Enabled the kv-v2 secrets engine at: internal/ \u4f7f\u7528\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5728\u8def\u5f91 internal/database/config \u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put internal/database/config username = \"db-readonly-username\" password = \"db-secret-password\" ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5728\u8def\u5f91 internal/database/config \u4e2d\u5b9a\u7fa9\u3002 / $ vault kv get internal/database/config ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password username db-readonly-username \u79d8\u5bc6\u5df2\u6e96\u5099\u597d\u7528\u65bc\u61c9\u7528\u7a0b\u5e8f\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit \u914d\u7f6e Kubernetes auth \u00b6 Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication method\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes **\u670d\u52d9\u5e33\u6236\u4ee4\u724c**\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u6b64\u4ee4\u724c\u5728\u5275\u5efa\u6642\u63d0\u4f9b\u7d66\u6bcf\u500b pod\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u5728 Vault \u4e2d\u555f\u52d5 Kubernetes authentication method\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u4ee4\u724c\u5be9\u67e5 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002 \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528 Kubernetes API \u7684\u4f4d\u7f6e\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" Success! Data written to: auth/kubernetes/config \u5b9a\u7fa9\u4e86\u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u4e26\u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5c0d\u65bc\u5ba2\u6236\u7aef\u8b80\u53d6\u5b9a\u7fa9\u5728 internal/database/config \u4e2d\u7684\u79d8\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 internal/data/database/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002\u9019\u662f Vault Policy \u7684\u4e00\u500b\u4f8b\u5b50\u3002Policy \u5b9a\u7fa9\u4e86\u4e00\u7d44\u80fd\u529b\u3002 \u5beb\u51fa\u540d\u70ba internal-app \u7684 Policy\uff0c\u8a72 Policy \u555f\u7528\u5c0d\u8def\u5f91 internal/data/database/config \u4e2d\u6a5f\u5bc6\u7684\u8b80\u53d6\u529f\u80fd\u3002 / $ vault policy write internal-app - <<EOF path \"internal/data/database/config\" { capabilities = [\"read\"] } EOF \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/internal-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/internal-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001internal-app \u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit \u5b9a\u7fa9\u4e00\u500b Kubernetes service account \u00b6 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5e33\u6236\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 98m vault 1 39m vault-agent-injector 1 39m \u8b93\u6211\u5011\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u9a57\u8b49\u670d\u52d9\u5e33\u6236\u662f\u5426\u5df2\u5275\u5efa\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 101m internal-app 1 69s vault 1 42m vault-agent-injector 1 42m \u6b64\u8655\u7684\u670d\u52d9\u5e33\u6236\u540d\u7a31\u8207\u5275\u5efa internal-app \u89d2\u8272\u6642\u5206\u914d\u7d66 bound_service_account_names \u5b57\u6bb5\u7684\u540d\u7a31\u4e00\u81f4\u3002 \u555f\u52d5\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f \u00b6 \u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5c07\u5176\u767c\u4f48\u5230 DockerHub\uff0c\u4e26\u5275\u5efa\u4e86\u4e00\u500b\u555f\u52d5\u8a72\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u90e8\u7f72\u3002 \u986f\u793a orgchart \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u3002 $ cat deployment-orgchart.yaml jwissig\u6e90\u78bc: https://github.com/jweissig/app/blob/master/main.go deployment-orgchart.yaml apiVersion : apps/v1 kind : Deployment metadata : name : orgchart labels : app : orgchart spec : selector : matchLabels : app : orgchart replicas : 1 template : metadata : annotations : labels : app : orgchart spec : serviceAccountName : internal-app containers : - name : orgchart image : jweissig/app:0.0.1 \u6b64\u90e8\u7f72\u7684\u540d\u7a31\u662f orgchart\u3002 spec.template.spec.serviceAccountName \u5b9a\u7fa9\u4e86\u670d\u52d9\u5e33\u6236 internal-app \u4f86\u904b\u884c\u9019\u500b\u5bb9\u5668\u3002 \u61c9\u7528\u5728 deployment-orgchart.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 $ kubectl apply --filename deployment-orgchart.yaml deployment.apps/orgchart created \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-97b5b656d-4658m 1 /1 Running 0 57s vault-0 1 /1 Running 0 53m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 53m orgchart pod \u5728\u6b64\u8655\u986f\u793a\u70ba\u4ee5 orgchart \u70ba\u524d\u7db4\u7684 pod\u3002 Vault-Agent \u6ce8\u5165\u5668\u67e5\u627e\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684\u90e8\u7f72\u3002\u7576\u524d\u90e8\u7f72\u4e2d\u4e0d\u5b58\u5728\u9019\u4e9b\u8a3b\u91cb\u3002\u9019\u610f\u5473\u8457 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u4e0a\u4e0d\u5b58\u5728\u4efb\u4f55\u9700\u8981\u5f9e Vault \u4e2d\u53d6\u5f97\u7684\u6a5f\u5bc6\u3002 \u9a57\u8b49 Vault-Agent \u6c92\u6709\u5c07\u6a5f\u5bc6\u5beb\u5165 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u3002 $ kubectl exec \\ $(kubectl get pod -l app=orgchart -o jsonpath=\"{.items[0].metadata.name}\") \\ --container orgchart -- ls /vault/secrets \u8f38\u51fa\u986f\u793a\u6c92\u627e\u5230\u540d\u70ba /vault/secrets \u7684\u6b64\u985e\u6587\u4ef6\u6216\u76ee\u9304\uff1a ls: /vault/secrets: No such file or directory command terminated with exit code 1 \u5728 pod \u88e1\u982d\u6ce8\u5165 secret \u00b6 \u90e8\u7f72\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 internal-app Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c pod\u3002 Vault Agent Injector \u53ea\u6709\u5728\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u6703\u4fee\u6539\u5b83\u3002\u73fe\u6709\u90e8\u7f72\u53ef\u80fd\u6703\u5c0d\u5176\u5b9a\u7fa9\u9032\u884c\u4fee\u88dc\u4ee5\u5305\u542b\u5fc5\u8981\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-inject-secrets.yaml \u3002 patch-inject-secrets.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector service role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272 agent-inject-secret-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c database-config.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 \u4fee\u88dc\u5728 patch-inject-secrets.yaml \u4e2d\u5b9a\u7fa9\u7684 orgchart \u90e8\u7f72\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets.yaml ) \" deployment.apps/orgchart patched \u4e00\u500b\u65b0\u7684 orgchart pod \u5728\u73fe\u6709 pod \u65c1\u908a\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-6f88c9f9f4-c2pdb 2 /2 Running 0 42s vault-0 1 /1 Running 0 66m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 66m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u9019\u500b\u65b0\u7684 pod \u73fe\u5728\u555f\u52d5\u4e86\u5169\u500b\u5bb9\u5668\u3002\u540d\u70ba orgchart \u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u548c\u540d\u70ba vault-agent \u7684 Vault Agent \u5bb9\u5668\u3002 \u5728\u65b0\u7684 orgchart pod \u4e2d\u986f\u793a Vault-agent \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: creating file sink 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T00:31:28.781Z [ INFO ] template.server: starting template server 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: authenticating 2022 -07-10T00:31:28.781Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.781Z [ INFO ] sink.server: starting sink server 2022 -07-10T00:31:28.784Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: authentication successful, sending token to sinks 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: starting renewal process 2022 -07-10T00:31:28.801Z [ INFO ] sink.file: token written: path = /home/vault/.vault-token 2022 -07-10T00:31:28.801Z [ INFO ] template.server: template server received new token 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) stopping 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) starting 2022 -07-10T00:31:28.803Z [ INFO ] auth.handler: renewed auth token Vault Agent \u7ba1\u7406\u4ee4\u724c\u751f\u547d\u9031\u671f\u548c\u79d8\u5bc6\u6aa2\u7d22\u3002\u6a5f\u5bc6\u5728\u8def\u5f91 /vault/secrets/database-config.txt \u7684 orgchart \u5bb9\u5668\u4e2d\u5448\u73fe\u3002 \u6700\u5f8c\uff0c\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container orgchart -- cat /vault/secrets/database-config.txt \u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u5b58\u5728\u65bc\u5bb9\u5668\u4e2d\uff1a data: map[password:db-secret-password username:db-readonly-user] metadata: map[created_time:2019-12-20T18:17:50.930264759Z deletion_time: destroyed:false version:2] \u5c07\u6a21\u677f\u61c9\u7528\u65bc\u6ce8\u5165\u7684\u6a5f\u5bc6 \u00b6 \u6ce8\u5165\u7684\u79d8\u5bc6\u7684\u7d50\u69cb\u53ef\u80fd\u9700\u8981\u4ee5\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u7684\u65b9\u5f0f\u9032\u884c\u7d50\u69cb\u5316\u3002\u5728\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u4e4b\u524d\uff0c\u6a21\u677f\u53ef\u4ee5\u69cb\u9020\u6578\u64da\u3002\u8981\u61c9\u7528\u6b64\u6a21\u677f\uff0c\u9700\u8981\u61c9\u7528\u4e00\u7d44\u65b0\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u5305\u542b\u6a21\u677f\u5b9a\u7fa9\u7684\u8a3b\u91cb\u6587\u4ef6\u3002 patch-inject-secrets-as-template.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u6b64\u88dc\u4e01\u5305\u542b\u5169\u500b\u65b0\u8a3b\u91cb\uff1a agent-inject-status \u8a2d\u7f6e\u70ba\u66f4\u65b0\u901a\u77e5\u6ce8\u5165\u5668\u91cd\u65b0\u8a3b\u5165\u9019\u4e9b\u503c\u3002 agent-inject-template-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\u3002\u8a72\u503c\u5b9a\u7fa9\u8981\u61c9\u7528\u65bc\u6a5f\u5bc6\u6578\u64da\u7684 Vault Agent \u6a21\u677f\u3002 \u8a72\u6a21\u677f\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u683c\u5f0f\u5316\u70ba PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u3002 \u61c9\u7528\u66f4\u65b0\u7684\u8a3b\u91cb\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets-as-template.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 16s vault-0 1 /1 Running 0 126m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 126m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 orgchart pod \u4e2d\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ -c orgchart -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard \u5e36\u6709\u8a3b\u91cb\u7684 Pod \u00b6 \u8a3b\u91cb\u53ef\u4ee5\u5c07\u9019\u4e9b\u79d8\u5bc6\u4fee\u88dc\u5230\u4efb\u4f55\u90e8\u7f72\u4e2d\u3002 Pod \u8981\u6c42\u5c07\u8a3b\u91cb\u5305\u542b\u5728\u5176\u521d\u59cb\u5b9a\u7fa9\u4e2d\u3002 \u986f\u793a payroll \u61c9\u7528\u7a0b\u5e8f\u7684 pod \u5b9a\u7fa9\u3002 pod-payroll.yaml apiVersion : v1 kind : Pod metadata : name : payroll labels : app : payroll annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} spec : serviceAccountName : internal-app containers : - name : payroll image : jweissig/app:0.0.1 \u61c9\u7528 pod-payroll.yaml \u4e2d\u5b9a\u7fa9\u7684 pod\u3002 $ kubectl apply --filename pod-payroll.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 4h18m payroll 2 /2 Running 0 3m vault-0 1 /1 Running 0 5h34m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 5h34m \u7b49\u5230 payroll pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 payroll pod \u4e2d\u986f\u793a\u5beb\u5165 payroll \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ payroll \\ --container payroll -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard Secret \u7d81\u5b9a\u5230 Service account \u00b6 \u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u986f\u793a website \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 deployment-website.yaml apiVersion : apps/v1 kind : Deployment metadata : name : website labels : app : website spec : selector : matchLabels : app : website replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : website spec : # This service account does not have permission to request the secrets. serviceAccountName : website containers : - name : website image : jweissig/app:0.0.1 --- apiVersion : v1 kind : ServiceAccount metadata : name : website \u61c9\u7528 deployment-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename deployment-website.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 29m payroll 2 /2 Running 0 12s vault-0 1 /1 Running 0 155m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 155m website-7fc8b69645-527rf 0 /2 Init:0/1 0 76s web-site \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728Kubernetes\u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init \u521d\u59cb\u5316\u904e\u7a0b\u5931\u6557\uff0c\u56e0\u70ba\u670d\u52d9\u5e33\u6236\u540d\u7a31\u672a\u7d93\u6388\u6b0a\uff1a ... [INFO] auth.handler: authenticating [ERROR] auth.handler: error authenticating: error=\"Error making API request. URL: PUT http://vault.default.svc:8200/v1/auth/kubernetes/login Code: 500. Errors: * service account name not authorized\" backoff=1.562132589 \u670d\u52d9\u5e33\u6236 website \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-website.yaml \u3002 patch-website.yaml spec : template : spec : serviceAccountName : internal-app \u8a72\u88dc\u4e01\u4fee\u6539\u4e86\u90e8\u7f72\u5b9a\u7fa9\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236 internal-app \u3002\u6b64 Kubernetes \u670d\u52d9\u5e33\u6236\u7531 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u6388\u6b0a\u3002 \u4fee\u88dc patch-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u7db2\u7ad9\u90e8\u7f72\u3002 $ kubectl patch deployment website --patch \" $( cat patch-website.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 8h payroll 2 /2 Running 0 4h9m vault-0 1 /1 Running 0 9h vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 9h website-54cf7dcdfd-fv9vh 2 /2 Running 0 23s website-5899c7c66b-drhv7 0 /2 Terminating 0 34m \u7b49\u5230\u7db2\u7ad9 pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 website pod \u4e2d\u986f\u793a\u5beb\u5165\u7db2\u7ad9\u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container website -- cat /vault/secrets/database-config.txt Secret \u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard Info Vault Kubernetes \u89d2\u8272\uff1a\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684 Vault Kubernetes \u89d2\u8272\uff0c\u8a72\u89d2\u8272\u555f\u7528\u539f\u59cb\u670d\u52d9\u5e33\u6236\u8a2a\u554f\uff0c\u4e26\u4fee\u88dc\u90e8\u7f72\u3002 Secret \u7d81\u5b9a\u5230 Namespace \u00b6 \u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u5275\u5efa offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl create namespace offsite namespace/offsite created \u5c07\u7576\u524d\u4e0a\u4e0b\u6587\u8a2d\u7f6e\u70ba offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl config set-context --current --namespace offsite Context \"minikube\" modified. \u5728 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u986f\u793a issue \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72 manifest\u3002 deployment-issues.yaml apiVersion : apps/v1 kind : Deployment metadata : name : issues labels : app : issues spec : selector : matchLabels : app : issues replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : issues spec : serviceAccountName : internal-app containers : - name : issues image : jweissig/app:0.0.1 \u61c9\u7528 deployment-issues.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u3002 $ kubectl apply --filename deployment-issues.yaml deployment.apps/issues created \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-cd8958bc6-7hrc5 0 /2 Init:0/1 0 111s deployment-issues.yaml \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728 Kubernetes \u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: creating file sink 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T11:51:47.277Z [ INFO ] template.server: starting template server 2022 -07-10T11:51:47.277Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T11:51:47.277Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T11:51:47.278Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:51:47.277Z [ INFO ] sink.server: starting sink server 2022 -07-10T11:51:47.278Z [ INFO ] ( runner ) creating watcher 2022 -07-10T11:52:47.279Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1s 2022 -07-10T11:52:48.280Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:53:48.281Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1 .93s 2022 -07-10T11:53:50.218Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:54:50.219Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 3 .36s 2022 -07-10T11:54:53.586Z [ INFO ] auth.handler: authenticating \u547d\u540d\u7a7a\u9593 offsite \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec --namespace default -it vault-0 -- /bin/sh / $ \u5275\u5efa\u4e00\u500b\u540d\u70ba offsite-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/offsite-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = offsite \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/offsite-app \u9000\u51fa vault-0 pod\u3002 $ exit \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-issues.yaml \u3002 patch-issues.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'offsite-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u8a72\u88dc\u4e01\u57f7\u884c\u66f4\u65b0\u4ee5\u5c07 vault.hashicorp.com/role \u8a2d\u7f6e\u70ba Vault Kubernetes \u89d2\u8272 offsite-app \u3002 \u4fee\u88dc patch-issues.yaml \u4e2d\u5b9a\u7fa9\u7684 issues \u90e8\u7f72\u3002 $ kubectl patch deployment issues --patch \" $( cat patch-issues.yaml ) \" deployment.apps/issues patched \u65b0\u554f\u984c pod \u8207\u73fe\u6709 pod \u4e00\u8d77\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-d8596bb9-jkzzr 2 /2 Running 0 66s \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684\u554f\u984c pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728\u554f\u984c pod \u4e2d\u986f\u793a\u5beb\u5165\u554f\u984c\u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container issues -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard","title":"\u901a\u904e Vault Agent \u5bb9\u5668\u5c07 Secret \u6ce8\u5165 Kubernetes Pod"},{"location":"vault/kubernetes/kubernetes-sidecar/#vault-agent-secret-kubernetes-pod","text":"\u539f\u6587: https://learn.hashicorp.com/tutorials/vault/kubernetes-sidecar \u90e8\u7f72\u4f7f\u7528 Vault \u4f86\u4fdd\u5b58\u8207\u61c9\u7528\u5e33\u5bc6\u7684\u61c9\u7528\u7a0b\u5e8f\u9700\u8981\uff1a \u9a57\u8b49\u4e26\u7372\u53d6\u5ba2\u6236\u7aef\u4ee4\u724c\u3002 \u7ba1\u7406\u4ee4\u724c\u7684\u751f\u547d\u9031\u671f\u3002 \u5f9e Vault \u4e2d\u6aa2\u7d22\u79d8\u5bc6\u3002 \u7ba1\u7406\u4efb\u4f55\u52d5\u614b\u6a5f\u5bc6\u7684\u79df\u7d04\u3002 Vault Agent \u8ca0\u8cac\u9019\u4e9b\u4efb\u52d9\u4e26\u4f7f\u60a8\u7684\u61c9\u7528\u7a0b\u5e8f\u611f\u53d7\u4e0d\u5230 Vault \u7684\u5b58\u5728\u3002\u9019\u6a23\u7684\u6574\u5408\u5f15\u5165\u4e86\u4e00\u9805\u65b0\u8981\u6c42\uff0c\u4e5f\u5c31\u662f\u5c07 Vault Agent \u8207\u61c9\u7528\u7a0b\u5e8f\u4e00\u8d77\u5b89\u88dd\u548c\u914d\u7f6e\u70ba sidecar \u3002 Vault Helm chart \u4f7f\u60a8\u80fd\u5920\u904b\u884c Vault \u548c Vault Agent Injector \u670d\u52d9\u3002\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u5229\u7528 Kubernetes mutating admission webhook \u4f86\u6514\u622a\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684 pod\uff0c\u4e26\u8a3b\u5165 Vault Agent \u5bb9\u5668\u4f86\u7ba1\u7406\u9019\u4e9b\u6a5f\u5bc6\u3002\u9019\u662f\u5f88\u6709\u5e6b\u52a9\uff0c\u56e0\u70ba\uff1a \u61c9\u7528\u7a0b\u5e8f\u4ecd\u7136\u4e0d\u77e5\u9053 Vault\uff0c\u56e0\u70ba\u6a5f\u5bc6\u5b58\u5132\u5728\u5176\u5bb9\u5668\u7684\u6587\u4ef6\u7cfb\u7d71\u4e2d\u3002 \u73fe\u6709\u90e8\u7f72\u7121\u9700\u66f4\u6539\uff1b\u56e0\u70ba\u53ef\u4ee5\u4fee\u88dc\u8a3b\u91cb\u3002 \u53ef\u4ee5\u901a\u904e Kubernetes \u670d\u52d9\u5e33\u6236\u548c\u547d\u540d\u7a7a\u9593\u5f37\u5236\u8a2a\u554f\u6a5f\u5bc6 \u5728\u672c\u6559\u7a0b\u4e2d\uff0c\u60a8\u5c07\u4f7f\u7528 Vault Helm chart \u8a2d\u7f6e Vault \u548c\u6b64\u6ce8\u5165\u5668\u670d\u52d9\u3002\u7136\u5f8c\uff0c\u60a8\u5c07\u90e8\u7f72\u5e7e\u500b\u61c9\u7528\u7a0b\u5e8f\u4f86\u6f14\u793a\u9019\u500b\u65b0\u7684\u6ce8\u5165\u5668\u670d\u52d9\u5982\u4f55\u6aa2\u7d22\u548c\u5beb\u5165\u9019\u4e9b\u79d8\u5bc6\u4ee5\u4f9b\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u3002","title":"\u901a\u904e Vault Agent \u5bb9\u5668\u5c07 Secret \u6ce8\u5165 Kubernetes Pod"},{"location":"vault/kubernetes/kubernetes-sidecar/#_1","text":"\u672c\u6559\u7a0b\u9700\u8981\u5b89\u88dd Kubernetes \u547d\u4ee4\u884c\u754c\u9762 (CLI) \u548c Helm CLI \u3001 Minikube \u4ee5\u53ca\u5176\u4ed6\u914d\u7f6e\u4ee5\u5c07\u5b83\u5011\u7d44\u5408\u5728\u4e00\u8d77\u3002","title":"\u5148\u6c7a\u689d\u4ef6"},{"location":"vault/kubernetes/kubernetes-sidecar/#kubernetes","text":"Minikube K3D Minikube \u662f\u4e00\u500b CLI \u5de5\u5177\uff0c\u53ef\u5728\u7cfb\u7d71\u4e0a\u7684\u865b\u64ec\u6a5f (VM) \u4e2d\u672c\u5730\u914d\u7f6e\u548c\u7ba1\u7406\u55ae\u7bc0\u9ede Kubernetes \u96c6\u7fa4\u7684\u751f\u547d\u9031\u671f\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ minikube start \ud83d\ude04 minikube v1.19.0 on Darwin 11 .2.3 \u2728 Using the docker driver based on existing profile \ud83d\udc4d Starting control plane node minikube in cluster minikube \ud83d\udd04 Restarting existing docker container for \"minikube\" ... \ud83d\udc33 Preparing Kubernetes v1.20.2 on Docker 20 .10.5 ... \ud83d\udd0e Verifying Kubernetes components... \u25aa Using image gcr.io/k8s-minikube/storage-provisioner:v5 \ud83c\udf1f Enabled addons: storage-provisioner, default-storageclass \ud83c\udfc4 Done! kubectl is now configured to use \"minikube\" cluster and \"default\" namespace by default \u521d\u59cb\u5316\u904e\u7a0b\u9700\u8981\u5e7e\u5206\u9418\uff0c\u56e0\u70ba\u5b83\u6703\u6aa2\u7d22\u4efb\u4f55\u5fc5\u8981\u7684\u4f9d\u8cf4\u9805\u4e26\u57f7\u884c\u5404\u7a2e\u5bb9\u5668\u6620\u50cf\u3002 \u9a57\u8b49 Minikube \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ minikube status minikube type: Control Plane host: Running kubelet: Running apiserver: Running kubeconfig: Configured \u4e3b\u6a5f\u3001kubelet \u548c apiserver \u5831\u544a\u5b83\u5011\u6b63\u5728\u904b\u884c\u3002 kubectl \u662f\u4e00\u500b\u547d\u4ee4\u884c\u754c\u9762 (CLI)\uff0c\u7528\u65bc\u91dd\u5c0d Kubernetes \u96c6\u7fa4\u904b\u884c\u547d\u4ee4\uff0c\u5b83\u4e5f\u88ab\u914d\u7f6e\u70ba\u8207\u9019\u500b\u6700\u8fd1\u555f\u52d5\u7684\u96c6\u7fa4\u9032\u884c\u901a\u4fe1\u3002 Minikube \u5728\u57fa\u65bc Web \u7684\u5100\u8868\u677f\u4e2d\u63d0\u4f9b\u72c0\u614b\u7684\u53ef\u8996\u5316\u8868\u793a\u3002\u8a72\u754c\u9762\u5728\u53ef\u8996\u5316\u754c\u9762\u4e2d\u986f\u793a\u96c6\u7fa4\u6d3b\u52d5\uff0c\u6709\u52a9\u65bc\u6df1\u5165\u7814\u7a76\u5f71\u97ff\u5b83\u7684\u554f\u984c\u3002 \u5728\u53e6\u4e00\u500b\u7d42\u7aef\u4e2d\uff0c\u555f\u52d5 minikube \u5100\u8868\u677f\u3002 $ minikube dashboard \u64cd\u4f5c\u7cfb\u7d71\u7684\u9ed8\u8a8d\u700f\u89bd\u5668\u6253\u958b\u4e26\u986f\u793a\u5100\u8868\u677f\u3002 k3d \u662f\u4e00\u500b\u8f15\u91cf\u7d1a\u7684 kubernetes \u5305\u88dd\u5668\uff0c\u7528\u65bc\u5728 docker \u4e2d\u904b\u884c k3s\uff08Rancher Lab \u7684\u6700\u5c0f Kubernetes \u767c\u884c\u7248\uff09\u3002 k3d \u4f7f\u5f97\u5728 docker \u4e2d\u5275\u5efa\u55ae\u7bc0\u9ede\u548c\u591a\u7bc0\u9ede k3s \u96c6\u7fa4\u8b8a\u5f97\u975e\u5e38\u5bb9\u6613\uff0c\u4f8b\u5982\u7528\u65bc Kubernetes \u4e0a\u7684\u672c\u5730\u958b\u767c\u3002 \u555f\u52d5 Kubernetes \u96c6\u7fa4\u3002 $ mkdir -p /tmp/k3d/kubelet/pods $ k3d cluster create -v /tmp/k3d/kubelet/pods:/var/lib/kubelet/pods:shared WARN [ 0000 ] No node filter specified INFO [ 0000 ] Prep: Network INFO [ 0000 ] Created network 'k3d-k3s-default' INFO [ 0000 ] Created image volume k3d-k3s-default-images INFO [ 0000 ] Starting new tools node... INFO [ 0000 ] Starting Node 'k3d-k3s-default-tools' INFO [ 0001 ] Creating node 'k3d-k3s-default-server-0' INFO [ 0001 ] Creating LoadBalancer 'k3d-k3s-default-serverlb' INFO [ 0001 ] Using the k3d-tools node to gather environment information INFO [ 0001 ] HostIP: using network gateway 172 .29.0.1 address INFO [ 0001 ] Starting cluster 'k3s-default' INFO [ 0001 ] Starting servers... INFO [ 0001 ] Starting Node 'k3d-k3s-default-server-0' INFO [ 0005 ] All agents already running. INFO [ 0005 ] Starting helpers... INFO [ 0006 ] Starting Node 'k3d-k3s-default-serverlb' INFO [ 0012 ] Injecting records for hostAliases ( incl. host.k3d.internal ) and for 2 network members into CoreDNS configmap... INFO [ 0014 ] Cluster 'k3s-default' created successfully! INFO [ 0014 ] You can now use it like this: kubectl cluster-info \u9a57\u8b49 K3D \u96c6\u7fa4\u7684\u72c0\u614b\u3002 $ kubectl cluster-info","title":"\u555f\u52d5 Kubernetes"},{"location":"vault/kubernetes/kubernetes-sidecar/#vault-helm-chart","text":"\u5728 Kubernetes \u4e0a\u904b\u884c Vault \u7684\u63a8\u85a6\u65b9\u6cd5\u662f\u901a\u904e Helm chart \u3002 Helm \u662f\u4e00\u500b\u5305\u7ba1\u7406\u5668\uff0c\u5b83\u5b89\u88dd\u548c\u914d\u7f6e\u6240\u6709\u5fc5\u8981\u7684\u7d44\u4ef6\u4ee5\u5728\u5e7e\u7a2e\u4e0d\u540c\u7684\u6a21\u5f0f\u4e0b\u904b\u884c Vault\u3002 Helm chart \u5305\u62ec\u555f\u7528\u689d\u4ef6\u548c\u53c3\u6578\u5316\u57f7\u884c\u7684\u6a21\u677f\u3002\u9019\u4e9b\u53c3\u6578\u53ef\u4ee5\u901a\u904e\u547d\u4ee4\u884c\u53c3\u6578\u8a2d\u7f6e\u6216\u5728 YAML \u4e2d\u5b9a\u7fa9\u3002 \u6dfb\u52a0 HashiCorp Helm \u5b58\u5132\u5eab\u3002 $ helm repo add hashicorp https://helm.releases.hashicorp.com \u66f4\u65b0\u6240\u6709\u5b58\u5132\u5eab\u4ee5\u78ba\u4fdd helm \u77e5\u9053\u6700\u65b0\u7248\u672c\u3002 $ helm repo update \u5b89\u88dd\u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c\u7684\u6700\u65b0\u7248\u672c\u7684 Vault \u670d\u52d9\u5668\u3002 $ helm install vault hashicorp/vault --set \"server.dev.enabled=true\" Vault pod \u548c Vault Agent Injector pod \u90e8\u7f72\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u3002 \u986f\u793a\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE vault-0 1 /1 Running 0 80s vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 80s vault-0 pod \u5728\u958b\u767c\u6a21\u5f0f\u4e0b\u904b\u884c Vault \u670d\u52d9\u5668\u3002 vault-agent-injector pod \u6839\u64da\u90e8\u7f72\u4e2d\u5b58\u5728\u6216\u4fee\u88dc\u7684\u8a3b\u91cb\u57f7\u884c\u6ce8\u5165\u3002 Info \u958b\u767c\u6a21\u5f0f\uff1a\u5728\u958b\u767c\u4e2d\u904b\u884c Vault \u670d\u52d9\u5668\u6703\u81ea\u52d5\u521d\u59cb\u5316\u548c\u89e3\u5c01\u3002\u9019\u5728\u5b78\u7fd2\u74b0\u5883\u4e2d\u662f\u7406\u60f3\u7684\uff0c\u4f46\u4e0d\u5efa\u8b70\u5728\u751f\u7522\u74b0\u5883\u4e2d\u4f7f\u7528\u3002 \u7b49\u5230 vault-0 pod \u548c vault-agent-injector pod \u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (1/1)\u3002","title":"\u5b89\u88dd Vault Helm chart"},{"location":"vault/kubernetes/kubernetes-sidecar/#vault-secret","text":"\u60a8\u5728\u5c07\u6a5f\u5bc6\u6ce8\u5165 pod \u90e8\u5206\u4e2d\u90e8\u7f72\u7684\u61c9\u7528\u7a0b\u5e8f\u671f\u671b Vault \u5b58\u5132\u7528\u6236\u540d\u548c\u5bc6\u78bc\uff0c\u8a72\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5b58\u5132\u5728\u8def\u5f91 internal/database/config \u4e2d\u3002\u8981\u5275\u5efa\u6b64\u5bc6\u9470\uff0c\u9700\u8981\u555f\u7528\u9375\u503c\u5bc6\u9470\u5f15\u64ce\u4e26\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u653e\u5728\u6307\u5b9a\u7684\u8def\u5f91\u4e2d\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh \u60a8\u7684\u7cfb\u7d71\u63d0\u793a\u7b26\u5c07\u66ff\u63db\u70ba\u65b0\u7684\u63d0\u793a\u7b26 /$ \u3002\u5728\u6b64\u63d0\u793a\u4e0b\u767c\u51fa\u7684\u547d\u4ee4\u5728 vault-0 \u5bb9\u5668\u4e0a\u57f7\u884c\u3002 \u5728 internal \u8def\u5f91\u555f\u7528 kv-v2 \u6a5f\u5bc6\u5b58\u5132\u3002 / $ vault secrets enable -path = internal kv-v2 Success! Enabled the kv-v2 secrets engine at: internal/ \u4f7f\u7528\u7528\u6236\u540d\u548c\u5bc6\u78bc\u5728\u8def\u5f91 internal/database/config \u5275\u5efa\u4e00\u500b\u79d8\u5bc6\u3002 / $ vault kv put internal/database/config username = \"db-readonly-username\" password = \"db-secret-password\" ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 \u9a57\u8b49\u5bc6\u9470\u662f\u5426\u5728\u8def\u5f91 internal/database/config \u4e2d\u5b9a\u7fa9\u3002 / $ vault kv get internal/database/config ======== Secret Path ======== internal/data/database/config ======= Metadata ======= Key Value --- ----- created_time 2022 -07-09T23:49:33.330145404Z custom_metadata <nil> deletion_time n/a destroyed false version 1 ====== Data ====== Key Value --- ----- password db-secret-password username db-readonly-username \u79d8\u5bc6\u5df2\u6e96\u5099\u597d\u7528\u65bc\u61c9\u7528\u7a0b\u5e8f\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit","title":"\u5728 Vault \u4e2d\u8a2d\u5b9a Secret"},{"location":"vault/kubernetes/kubernetes-sidecar/#kubernetes-auth","text":"Vault \u63d0\u4f9b\u4e86\u4e00\u7a2e Kubernetes authentication method\uff0c\u4f7f\u5ba2\u6236\u7aef\u80fd\u5920\u4f7f\u7528 Kubernetes **\u670d\u52d9\u5e33\u6236\u4ee4\u724c**\u9032\u884c\u8eab\u4efd\u9a57\u8b49\u3002\u6b64\u4ee4\u724c\u5728\u5275\u5efa\u6642\u63d0\u4f9b\u7d66\u6bcf\u500b pod\u3002 \u5728 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec -it vault-0 -- /bin/sh / $ \u5728 Vault \u4e2d\u555f\u52d5 Kubernetes authentication method\u3002 / $ vault auth enable kubernetes Success! Enabled kubernetes auth method at: kubernetes/ Vault \u63a5\u53d7\u4f86\u81ea Kubernetes \u96c6\u7fa4\u4e2d\u4efb\u4f55\u5ba2\u6236\u7aef\u7684\u670d\u52d9\u4ee4\u724c\u3002\u5728\u8eab\u4efd\u9a57\u8b49\u671f\u9593\uff0cVault \u901a\u904e\u67e5\u8a62\u4ee4\u724c\u5be9\u67e5 Kubernetes \u7aef\u9ede\u4f86\u9a57\u8b49\u670d\u52d9\u5e33\u6236\u4ee4\u724c\u662f\u5426\u6709\u6548\u3002 \u914d\u7f6e Kubernetes \u8eab\u4efd\u9a57\u8b49\u65b9\u6cd5\u4ee5\u4f7f\u7528 Kubernetes API \u7684\u4f4d\u7f6e\u3002 / $ vault write auth/kubernetes/config \\ kubernetes_host = \"https:// $KUBERNETES_PORT_443_TCP_ADDR :443\" Success! Data written to: auth/kubernetes/config \u5b9a\u7fa9\u4e86\u74b0\u5883\u8b8a\u91cf KUBERNETES_PORT_443_TCP_ADDR \u4e26\u5f15\u7528\u4e86 Kubernetes \u4e3b\u6a5f\u7684\u5167\u90e8\u7db2\u7d61\u5730\u5740\u3002 \u5c0d\u65bc\u5ba2\u6236\u7aef\u8b80\u53d6\u5b9a\u7fa9\u5728 internal/database/config \u4e2d\u7684\u79d8\u5bc6\u6578\u64da\uff0c\u9700\u8981\u70ba\u8def\u5f91 internal/data/database/config \u6388\u4e88\u8b80\u53d6\u80fd\u529b\u3002\u9019\u662f Vault Policy \u7684\u4e00\u500b\u4f8b\u5b50\u3002Policy \u5b9a\u7fa9\u4e86\u4e00\u7d44\u80fd\u529b\u3002 \u5beb\u51fa\u540d\u70ba internal-app \u7684 Policy\uff0c\u8a72 Policy \u555f\u7528\u5c0d\u8def\u5f91 internal/data/database/config \u4e2d\u6a5f\u5bc6\u7684\u8b80\u53d6\u529f\u80fd\u3002 / $ vault policy write internal-app - <<EOF path \"internal/data/database/config\" { capabilities = [\"read\"] } EOF \u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/internal-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = default \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/internal-app \u8a72\u89d2\u8272\u5c07 Kubernetes \u670d\u52d9\u5e33\u6236\u3001internal-app \u548c\u547d\u540d\u7a7a\u9593\uff08\u9ed8\u8a8d\uff09\u8207 Vault \u7b56\u7565 internal-app \u9023\u63a5\u8d77\u4f86\u3002\u8a8d\u8b49\u5f8c\u8fd4\u56de\u7684\u4ee4\u724c\u6709\u6548\u671f\u70ba 24 \u5c0f\u6642\u3002 \u6700\u5f8c\uff0c\u9000\u51fa vault-0 pod\u3002 / $ exit","title":"\u914d\u7f6e Kubernetes auth"},{"location":"vault/kubernetes/kubernetes-sidecar/#kubernetes-service-account","text":"Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u5b9a\u7fa9\u4e86\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709\u670d\u52d9\u5e33\u6236\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 98m vault 1 39m vault-agent-injector 1 39m \u8b93\u6211\u5011\u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u9a57\u8b49\u670d\u52d9\u5e33\u6236\u662f\u5426\u5df2\u5275\u5efa\u3002 $ kubectl get serviceaccounts NAME SECRETS AGE default 1 101m internal-app 1 69s vault 1 42m vault-agent-injector 1 42m \u6b64\u8655\u7684\u670d\u52d9\u5e33\u6236\u540d\u7a31\u8207\u5275\u5efa internal-app \u89d2\u8272\u6642\u5206\u914d\u7d66 bound_service_account_names \u5b57\u6bb5\u7684\u540d\u7a31\u4e00\u81f4\u3002","title":"\u5b9a\u7fa9\u4e00\u500b Kubernetes service account"},{"location":"vault/kubernetes/kubernetes-sidecar/#_2","text":"\u6211\u5011\u5275\u5efa\u4e86\u4e00\u500b\u793a\u4f8b\u61c9\u7528\u7a0b\u5e8f\uff0c\u5c07\u5176\u767c\u4f48\u5230 DockerHub\uff0c\u4e26\u5275\u5efa\u4e86\u4e00\u500b\u555f\u52d5\u8a72\u61c9\u7528\u7a0b\u5e8f\u7684 Kubernetes \u90e8\u7f72\u3002 \u986f\u793a orgchart \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u3002 $ cat deployment-orgchart.yaml jwissig\u6e90\u78bc: https://github.com/jweissig/app/blob/master/main.go deployment-orgchart.yaml apiVersion : apps/v1 kind : Deployment metadata : name : orgchart labels : app : orgchart spec : selector : matchLabels : app : orgchart replicas : 1 template : metadata : annotations : labels : app : orgchart spec : serviceAccountName : internal-app containers : - name : orgchart image : jweissig/app:0.0.1 \u6b64\u90e8\u7f72\u7684\u540d\u7a31\u662f orgchart\u3002 spec.template.spec.serviceAccountName \u5b9a\u7fa9\u4e86\u670d\u52d9\u5e33\u6236 internal-app \u4f86\u904b\u884c\u9019\u500b\u5bb9\u5668\u3002 \u61c9\u7528\u5728 deployment-orgchart.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u5230 Kubernetes \u4e2d\u3002 $ kubectl apply --filename deployment-orgchart.yaml deployment.apps/orgchart created \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-97b5b656d-4658m 1 /1 Running 0 57s vault-0 1 /1 Running 0 53m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 53m orgchart pod \u5728\u6b64\u8655\u986f\u793a\u70ba\u4ee5 orgchart \u70ba\u524d\u7db4\u7684 pod\u3002 Vault-Agent \u6ce8\u5165\u5668\u67e5\u627e\u5b9a\u7fa9\u7279\u5b9a\u8a3b\u91cb\u7684\u90e8\u7f72\u3002\u7576\u524d\u90e8\u7f72\u4e2d\u4e0d\u5b58\u5728\u9019\u4e9b\u8a3b\u91cb\u3002\u9019\u610f\u5473\u8457 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u4e0a\u4e0d\u5b58\u5728\u4efb\u4f55\u9700\u8981\u5f9e Vault \u4e2d\u53d6\u5f97\u7684\u6a5f\u5bc6\u3002 \u9a57\u8b49 Vault-Agent \u6c92\u6709\u5c07\u6a5f\u5bc6\u5beb\u5165 orgchart pod \u4e2d\u7684 orgchart \u5bb9\u5668\u3002 $ kubectl exec \\ $(kubectl get pod -l app=orgchart -o jsonpath=\"{.items[0].metadata.name}\") \\ --container orgchart -- ls /vault/secrets \u8f38\u51fa\u986f\u793a\u6c92\u627e\u5230\u540d\u70ba /vault/secrets \u7684\u6b64\u985e\u6587\u4ef6\u6216\u76ee\u9304\uff1a ls: /vault/secrets: No such file or directory command terminated with exit code 1","title":"\u555f\u52d5\u4e00\u500b\u61c9\u7528\u7a0b\u5e8f"},{"location":"vault/kubernetes/kubernetes-sidecar/#pod-secret","text":"\u90e8\u7f72\u4f7f\u7528\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 internal-app Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c pod\u3002 Vault Agent Injector \u53ea\u6709\u5728\u90e8\u7f72\u5305\u542b\u4e00\u7d44\u7279\u5b9a\u8a3b\u91cb\u6642\u624d\u6703\u4fee\u6539\u5b83\u3002\u73fe\u6709\u90e8\u7f72\u53ef\u80fd\u6703\u5c0d\u5176\u5b9a\u7fa9\u9032\u884c\u4fee\u88dc\u4ee5\u5305\u542b\u5fc5\u8981\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-inject-secrets.yaml \u3002 patch-inject-secrets.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' \u9019\u4e9b\u8a3b\u91cb\u5b9a\u7fa9\u4e86\u90e8\u7f72\u6a21\u5f0f\u7684\u90e8\u5206\u7d50\u69cb\uff0c\u4e26\u4ee5 vault.hashicorp.com \u70ba\u524d\u7db4\u3002 agent-inject \u555f\u7528 Vault Agent Injector service role \u662f Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272 agent-inject-secret-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\uff0c database-config.txt \u5beb\u5165 /vault/secrets \u76ee\u9304\u3002\u8a72\u503c\u662f Vault \u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u7684\u8def\u5f91\u3002 \u4fee\u88dc\u5728 patch-inject-secrets.yaml \u4e2d\u5b9a\u7fa9\u7684 orgchart \u90e8\u7f72\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets.yaml ) \" deployment.apps/orgchart patched \u4e00\u500b\u65b0\u7684 orgchart pod \u5728\u73fe\u6709 pod \u65c1\u908a\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-6f88c9f9f4-c2pdb 2 /2 Running 0 42s vault-0 1 /1 Running 0 66m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 66m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u9019\u500b\u65b0\u7684 pod \u73fe\u5728\u555f\u52d5\u4e86\u5169\u500b\u5bb9\u5668\u3002\u540d\u70ba orgchart \u7684\u61c9\u7528\u7a0b\u5e8f\u5bb9\u5668\u548c\u540d\u70ba vault-agent \u7684 Vault Agent \u5bb9\u5668\u3002 \u5728\u65b0\u7684 orgchart pod \u4e2d\u986f\u793a Vault-agent \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: creating file sink 2022 -07-10T00:31:28.780Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T00:31:28.781Z [ INFO ] template.server: starting template server 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T00:31:28.781Z [ INFO ] auth.handler: authenticating 2022 -07-10T00:31:28.781Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.781Z [ INFO ] sink.server: starting sink server 2022 -07-10T00:31:28.784Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: authentication successful, sending token to sinks 2022 -07-10T00:31:28.801Z [ INFO ] auth.handler: starting renewal process 2022 -07-10T00:31:28.801Z [ INFO ] sink.file: token written: path = /home/vault/.vault-token 2022 -07-10T00:31:28.801Z [ INFO ] template.server: template server received new token 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) stopping 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) creating watcher 2022 -07-10T00:31:28.801Z [ INFO ] ( runner ) starting 2022 -07-10T00:31:28.803Z [ INFO ] auth.handler: renewed auth token Vault Agent \u7ba1\u7406\u4ee4\u724c\u751f\u547d\u9031\u671f\u548c\u79d8\u5bc6\u6aa2\u7d22\u3002\u6a5f\u5bc6\u5728\u8def\u5f91 /vault/secrets/database-config.txt \u7684 orgchart \u5bb9\u5668\u4e2d\u5448\u73fe\u3002 \u6700\u5f8c\uff0c\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container orgchart -- cat /vault/secrets/database-config.txt \u672a\u683c\u5f0f\u5316\u7684\u79d8\u5bc6\u6578\u64da\u5b58\u5728\u65bc\u5bb9\u5668\u4e2d\uff1a data: map[password:db-secret-password username:db-readonly-user] metadata: map[created_time:2019-12-20T18:17:50.930264759Z deletion_time: destroyed:false version:2]","title":"\u5728 pod \u88e1\u982d\u6ce8\u5165 secret"},{"location":"vault/kubernetes/kubernetes-sidecar/#_3","text":"\u6ce8\u5165\u7684\u79d8\u5bc6\u7684\u7d50\u69cb\u53ef\u80fd\u9700\u8981\u4ee5\u61c9\u7528\u7a0b\u5e8f\u4f7f\u7528\u7684\u65b9\u5f0f\u9032\u884c\u7d50\u69cb\u5316\u3002\u5728\u5c07\u6a5f\u5bc6\u5beb\u5165\u6587\u4ef6\u7cfb\u7d71\u4e4b\u524d\uff0c\u6a21\u677f\u53ef\u4ee5\u69cb\u9020\u6578\u64da\u3002\u8981\u61c9\u7528\u6b64\u6a21\u677f\uff0c\u9700\u8981\u61c9\u7528\u4e00\u7d44\u65b0\u7684\u8a3b\u91cb\u3002 \u986f\u793a\u5305\u542b\u6a21\u677f\u5b9a\u7fa9\u7684\u8a3b\u91cb\u6587\u4ef6\u3002 patch-inject-secrets-as-template.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u6b64\u88dc\u4e01\u5305\u542b\u5169\u500b\u65b0\u8a3b\u91cb\uff1a agent-inject-status \u8a2d\u7f6e\u70ba\u66f4\u65b0\u901a\u77e5\u6ce8\u5165\u5668\u91cd\u65b0\u8a3b\u5165\u9019\u4e9b\u503c\u3002 agent-inject-template-FILEPATH \u6587\u4ef6\u8def\u5f91\u7684\u524d\u7db4\u3002\u8a72\u503c\u5b9a\u7fa9\u8981\u61c9\u7528\u65bc\u6a5f\u5bc6\u6578\u64da\u7684 Vault Agent \u6a21\u677f\u3002 \u8a72\u6a21\u677f\u5c07\u7528\u6236\u540d\u548c\u5bc6\u78bc\u683c\u5f0f\u5316\u70ba PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u3002 \u61c9\u7528\u66f4\u65b0\u7684\u8a3b\u91cb\u3002 $ kubectl patch deployment orgchart --patch \" $( cat patch-inject-secrets-as-template.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 16s vault-0 1 /1 Running 0 126m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 126m \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684 orgchart pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 orgchart pod \u4e2d\u986f\u793a\u5beb\u5165 orgchart \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = orgchart -o jsonpath = \"{.items[0].metadata.name}\" ) \\ -c orgchart -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard","title":"\u5c07\u6a21\u677f\u61c9\u7528\u65bc\u6ce8\u5165\u7684\u6a5f\u5bc6"},{"location":"vault/kubernetes/kubernetes-sidecar/#pod","text":"\u8a3b\u91cb\u53ef\u4ee5\u5c07\u9019\u4e9b\u79d8\u5bc6\u4fee\u88dc\u5230\u4efb\u4f55\u90e8\u7f72\u4e2d\u3002 Pod \u8981\u6c42\u5c07\u8a3b\u91cb\u5305\u542b\u5728\u5176\u521d\u59cb\u5b9a\u7fa9\u4e2d\u3002 \u986f\u793a payroll \u61c9\u7528\u7a0b\u5e8f\u7684 pod \u5b9a\u7fa9\u3002 pod-payroll.yaml apiVersion : v1 kind : Pod metadata : name : payroll labels : app : payroll annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} spec : serviceAccountName : internal-app containers : - name : payroll image : jweissig/app:0.0.1 \u61c9\u7528 pod-payroll.yaml \u4e2d\u5b9a\u7fa9\u7684 pod\u3002 $ kubectl apply --filename pod-payroll.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 4h18m payroll 2 /2 Running 0 3m vault-0 1 /1 Running 0 5h34m vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 5h34m \u7b49\u5230 payroll pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 payroll pod \u4e2d\u986f\u793a\u5beb\u5165 payroll \u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ payroll \\ --container payroll -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-username:db-secret-password@postgres:5432/wizard","title":"\u5e36\u6709\u8a3b\u91cb\u7684 Pod"},{"location":"vault/kubernetes/kubernetes-sidecar/#secret-service-account","text":"\u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u986f\u793a website \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 deployment-website.yaml apiVersion : apps/v1 kind : Deployment metadata : name : website labels : app : website spec : selector : matchLabels : app : website replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : website spec : # This service account does not have permission to request the secrets. serviceAccountName : website containers : - name : website image : jweissig/app:0.0.1 --- apiVersion : v1 kind : ServiceAccount metadata : name : website \u61c9\u7528 deployment-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u548c\u670d\u52d9\u5e33\u6236\u3002 $ kubectl apply --filename deployment-website.yaml \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-554db4579d-w6565 2 /2 Running 0 29m payroll 2 /2 Running 0 12s vault-0 1 /1 Running 0 155m vault-agent-injector-5945fb98b5-tpglz 1 /1 Running 0 155m website-7fc8b69645-527rf 0 /2 Init:0/1 0 76s web-site \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728Kubernetes\u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init \u521d\u59cb\u5316\u904e\u7a0b\u5931\u6557\uff0c\u56e0\u70ba\u670d\u52d9\u5e33\u6236\u540d\u7a31\u672a\u7d93\u6388\u6b0a\uff1a ... [INFO] auth.handler: authenticating [ERROR] auth.handler: error authenticating: error=\"Error making API request. URL: PUT http://vault.default.svc:8200/v1/auth/kubernetes/login Code: 500. Errors: * service account name not authorized\" backoff=1.562132589 \u670d\u52d9\u5e33\u6236 website \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-website.yaml \u3002 patch-website.yaml spec : template : spec : serviceAccountName : internal-app \u8a72\u88dc\u4e01\u4fee\u6539\u4e86\u90e8\u7f72\u5b9a\u7fa9\u4ee5\u4f7f\u7528\u670d\u52d9\u5e33\u6236 internal-app \u3002\u6b64 Kubernetes \u670d\u52d9\u5e33\u6236\u7531 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u6388\u6b0a\u3002 \u4fee\u88dc patch-website.yaml \u4e2d\u5b9a\u7fa9\u7684\u7db2\u7ad9\u90e8\u7f72\u3002 $ kubectl patch deployment website --patch \" $( cat patch-website.yaml ) \" \u7372\u53d6\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE orgchart-b6c98776d-r7m5k 2 /2 Running 0 8h payroll 2 /2 Running 0 4h9m vault-0 1 /1 Running 0 9h vault-agent-injector-659b4488df-thv9x 1 /1 Running 0 9h website-54cf7dcdfd-fv9vh 2 /2 Running 0 23s website-5899c7c66b-drhv7 0 /2 Terminating 0 34m \u7b49\u5230\u7db2\u7ad9 pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728 website pod \u4e2d\u986f\u793a\u5beb\u5165\u7db2\u7ad9\u5bb9\u5668\u7684 secret\u3002 $ kubectl exec \\ $( kubectl get pod -l app = website -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container website -- cat /vault/secrets/database-config.txt Secret \u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard Info Vault Kubernetes \u89d2\u8272\uff1a\u6216\u8005\uff0c\u60a8\u53ef\u4ee5\u5b9a\u7fa9\u4e00\u500b\u65b0\u7684 Vault Kubernetes \u89d2\u8272\uff0c\u8a72\u89d2\u8272\u555f\u7528\u539f\u59cb\u670d\u52d9\u5e33\u6236\u8a2a\u554f\uff0c\u4e26\u4fee\u88dc\u90e8\u7f72\u3002","title":"Secret \u7d81\u5b9a\u5230 Service account"},{"location":"vault/kubernetes/kubernetes-sidecar/#secret-namespace","text":"\u4f7f\u7528 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u4e2d\u5b9a\u7fa9\u7684\u5e33\u6236\u4ee5\u5916\u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u904b\u884c\u7684 Pod \u7121\u6cd5\u8a2a\u554f\u5728\u8a72\u8def\u5f91\u4e2d\u5b9a\u7fa9\u7684\u6a5f\u5bc6\u3002 \u5275\u5efa offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl create namespace offsite namespace/offsite created \u5c07\u7576\u524d\u4e0a\u4e0b\u6587\u8a2d\u7f6e\u70ba offsite \u547d\u540d\u7a7a\u9593\u3002 $ kubectl config set-context --current --namespace offsite Context \"minikube\" modified. \u5728 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u5275\u5efa\u4e00\u500b\u540d\u70ba internal-app \u7684 Kubernetes \u670d\u52d9\u5e33\u6236\u3002 $ kubectl create sa internal-app serviceaccount/internal-app created \u986f\u793a issue \u61c9\u7528\u7a0b\u5e8f\u7684\u90e8\u7f72 manifest\u3002 deployment-issues.yaml apiVersion : apps/v1 kind : Deployment metadata : name : issues labels : app : issues spec : selector : matchLabels : app : issues replicas : 1 template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/role : 'internal-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} labels : app : issues spec : serviceAccountName : internal-app containers : - name : issues image : jweissig/app:0.0.1 \u61c9\u7528 deployment-issues.yaml \u4e2d\u5b9a\u7fa9\u7684\u90e8\u7f72\u3002 $ kubectl apply --filename deployment-issues.yaml deployment.apps/issues created \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-cd8958bc6-7hrc5 0 /2 Init:0/1 0 111s deployment-issues.yaml \u90e8\u7f72\u5275\u5efa\u4e86\u4e00\u500b pod\uff0c\u4f46\u5b83\u5728 Kubernetes \u88e1\u7684\u72c0\u614b\u7e3d\u662f\u7121\u6cd5\u50cf\u5176\u5b83\u7684 pod \u8f49\u63db\u6210 READY\u3002 \u5728\u7db2\u7ad9 pod \u4e2d\u986f\u793a vault-agent-init \u5bb9\u5668\u7684\u65e5\u8a8c\u3002 $ kubectl logs \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container vault-agent-init == > Vault agent started! Log data will stream in below: == > Vault agent configuration: Cgo: disabled Log Level: info Version: Vault v1.10.3 Version Sha: af866591ee60485f05d6e32dd63dde93df686dfb 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: creating file sink 2022 -07-10T11:51:47.276Z [ INFO ] sink.file: file sink configured: path = /home/vault/.vault-token mode = -rw-r----- 2022 -07-10T11:51:47.277Z [ INFO ] template.server: starting template server 2022 -07-10T11:51:47.277Z [ INFO ] auth.handler: starting auth handler 2022 -07-10T11:51:47.277Z [ INFO ] ( runner ) creating new runner ( dry: false, once: false ) 2022 -07-10T11:51:47.278Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:51:47.277Z [ INFO ] sink.server: starting sink server 2022 -07-10T11:51:47.278Z [ INFO ] ( runner ) creating watcher 2022 -07-10T11:52:47.279Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1s 2022 -07-10T11:52:48.280Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:53:48.281Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 1 .93s 2022 -07-10T11:53:50.218Z [ INFO ] auth.handler: authenticating 2022 -07-10T11:54:50.219Z [ ERROR ] auth.handler: error authenticating: error = \"context deadline exceeded\" backoff = 3 .36s 2022 -07-10T11:54:53.586Z [ INFO ] auth.handler: authenticating \u547d\u540d\u7a7a\u9593 offsite \u672a\u5206\u914d\u7d66\u4efb\u4f55 Vault Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002\u6b64\u8eab\u4efd\u9a57\u8b49\u5931\u6557\u6703\u5c0e\u81f4\u90e8\u7f72\u521d\u59cb\u5316\u5931\u6557\u3002 \u5728\u9ed8\u8a8d\u547d\u540d\u7a7a\u9593\u4e2d\u7684 vault-0 pod \u4e0a\u555f\u52d5\u4ea4\u4e92\u5f0f shell \u6703\u8a71\u3002 $ kubectl exec --namespace default -it vault-0 -- /bin/sh / $ \u5275\u5efa\u4e00\u500b\u540d\u70ba offsite-app \u7684 Kubernetes \u8eab\u4efd\u9a57\u8b49\u89d2\u8272\u3002 / $ vault write auth/kubernetes/role/offsite-app \\ bound_service_account_names = internal-app \\ bound_service_account_namespaces = offsite \\ policies = internal-app \\ ttl = 24h \u8a72\u547d\u4ee4\u7684\u6210\u529f\u8f38\u51fa\u985e\u4f3c\u65bc\u4ee5\u4e0b\u793a\u4f8b\uff1a Success! Data written to: auth/kubernetes/role/offsite-app \u9000\u51fa vault-0 pod\u3002 $ exit \u986f\u793a\u90e8\u7f72\u88dc\u4e01 patch-issues.yaml \u3002 patch-issues.yaml spec : template : metadata : annotations : vault.hashicorp.com/agent-inject : 'true' vault.hashicorp.com/agent-inject-status : 'update' vault.hashicorp.com/role : 'offsite-app' vault.hashicorp.com/agent-inject-secret-database-config.txt : 'internal/data/database/config' vault.hashicorp.com/agent-inject-template-database-config.txt : | {{- with secret \"internal/data/database/config\" -}} postgresql://{{ .Data.data.username }}:{{ .Data.data.password }}@postgres:5432/wizard {{- end -}} \u8a72\u88dc\u4e01\u57f7\u884c\u66f4\u65b0\u4ee5\u5c07 vault.hashicorp.com/role \u8a2d\u7f6e\u70ba Vault Kubernetes \u89d2\u8272 offsite-app \u3002 \u4fee\u88dc patch-issues.yaml \u4e2d\u5b9a\u7fa9\u7684 issues \u90e8\u7f72\u3002 $ kubectl patch deployment issues --patch \" $( cat patch-issues.yaml ) \" deployment.apps/issues patched \u65b0\u554f\u984c pod \u8207\u73fe\u6709 pod \u4e00\u8d77\u958b\u59cb\u3002\u7576\u5b83\u6e96\u5099\u597d\u6642\uff0c\u539f\u59cb\u7bc0\u9ede\u7d42\u6b62\u4e26\u5c07\u81ea\u5df1\u5f9e\u6d3b\u52d5 pod \u5217\u8868\u4e2d\u522a\u9664\u3002 \u7372\u53d6 offsite \u547d\u540d\u7a7a\u9593\u4e2d\u7684\u6240\u6709 pod\u3002 $ kubectl get pods NAME READY STATUS RESTARTS AGE issues-d8596bb9-jkzzr 2 /2 Running 0 66s \u7b49\u5230\u91cd\u65b0\u90e8\u7f72\u7684\u554f\u984c pod \u5831\u544a\u5b83\u6b63\u5728\u904b\u884c\u4e26\u6e96\u5099\u5c31\u7dd2 (2/2)\u3002 \u6700\u5f8c\uff0c\u5728\u554f\u984c pod \u4e2d\u986f\u793a\u5beb\u5165\u554f\u984c\u5bb9\u5668\u7684\u79d8\u5bc6\u3002 $ kubectl exec \\ $( kubectl get pod -l app = issues -o jsonpath = \"{.items[0].metadata.name}\" ) \\ --container issues -- cat /vault/secrets/database-config.txt \u79d8\u5bc6\u5448\u73fe\u5728\u5bb9\u5668\u4e0a\u7684 PostgreSQL \u9023\u63a5\u5b57\u7b26\u4e32\u4e2d\uff1a postgresql://db-readonly-user:db-secret-password@postgres:5432/wizard","title":"Secret \u7d81\u5b9a\u5230 Namespace"},{"location":"vault/tutorials/auth/identity-entity-group/","text":"Identity: Entities and Groups \u00b6 \u539f\u6587: https://www.vaultproject.io/docs/auth/userpass","title":"Identity: Entities and Groups"},{"location":"vault/tutorials/auth/identity-entity-group/#identity-entities-and-groups","text":"\u539f\u6587: https://www.vaultproject.io/docs/auth/userpass","title":"Identity: Entities and Groups"},{"location":"yaml/yaml-intro/","text":"YAML \u5165\u9580\u6559\u7a0b \u00b6 YAML \u662f \"YAML Ain't a Markup Language\"\uff08YAML \u4e0d\u662f\u4e00\u7a2e\u6a19\u8a18\u8a9e\u8a00\uff09\u7684\u7e2e\u5beb\u3002 YAML \u7684\u8a9e\u6cd5\u548c\u5176\u4ed6\u9ad8\u7d1a\u8a9e\u8a00\u985e\u4f3c\uff0c\u4e26\u4e14\u53ef\u4ee5\u7c21\u55ae\u8868\u9054\u6e05\u55ae\u3001\u6563\u5217\u8868\uff0c\u6a19\u91cf\u7b49\u6578\u64da\u5f62\u614b\u3002\u5b83\u4f7f\u7528\u7a7a\u767d\u7b26\u865f\u7e2e\u9032\u548c\u5927\u91cf\u4f9d\u8cf4\u5916\u89c0\u7684\u7279\u8272\uff0c\u7279\u5225\u9069\u5408\u7528\u4f86\u8868\u9054\u6216\u7de8\u8f2f\u6578\u64da\u7d50\u69cb\u3001\u5404\u7a2e\u914d\u7f6e\u6587\u4ef6\u3001\u50be\u5370\u8abf\u8a66\u5167\u5bb9\u3001\u6587\u4ef6\u5927\u7db1\uff08\u4f8b\u5982\uff1a\u8a31\u591a\u96fb\u5b50\u90f5\u4ef6\u6a19\u984c\u683c\u5f0f\u548c YAML \u975e\u5e38\u63a5\u8fd1\uff09\u3002 YAML \u7684\u914d\u7f6e\u6587\u4ef6\u5f8c\u7db4\u70ba .yml \uff0c\u5982\uff1arunoob.yml \u3002 \u57fa\u672c\u8a9e\u6cd5 \u00b6 \u5927\u5c0f\u5beb\u654f\u611f \u4f7f\u7528\u7e2e\u9032\u8868\u793a\u5c64\u7d1a\u95dc\u4fc2 \u7e2e\u9032\u4e0d\u5141\u8a31\u4f7f\u7528tab\uff0c\u53ea\u5141\u8a31\u7a7a\u683c \u7e2e\u9032\u7684\u7a7a\u683c\u6578\u4e0d\u91cd\u8981\uff0c\u53ea\u8981\u76f8\u540c\u5c64\u7d1a\u7684\u5143\u7d20\u5de6\u5c0d\u9f4a\u5373\u53ef '#'\u8868\u793a\u8a3b\u91cb \u6578\u64da\u985e\u578b \u00b6 YAML \u652f\u6301\u4ee5\u4e0b\u5e7e\u7a2e\u6578\u64da\u985e\u578b\uff1a \u7269\u4ef6/\u5c0d\u8c61\uff1a\u9375\u503c\u5c0d\u7684\u96c6\u5408\uff0c\u53c8\u7a31\u70ba\u6620\u5c04\uff08mapping\uff09/ \u54c8\u5e0c\uff08hashes\uff09 / \u5b57\u5178\uff08dictionary\uff09 \u9663\u5217/\u6578\u7d44\uff1a\u4e00\u7d44\u6309\u6b21\u5e8f\u6392\u5217\u7684\u503c\uff0c\u53c8\u7a31\u70ba\u5e8f\u5217\uff08sequence\uff09 / \u5217\u8868\uff08list\uff09 \u7d14\u91cf\uff08scalars\uff09\uff1a\u55ae\u500b\u7684\u3001\u4e0d\u53ef\u518d\u5206\u7684\u503c \u7269\u4ef6/\u5c0d\u8c61 \u00b6 \u5c0d\u8c61\u9375\u503c\u5c0d\u4f7f\u7528 \u5192\u865f \u7d50\u69cb\u8868\u793a key: value \uff0c \u5192\u865f\u5f8c\u9762\u8981\u52a0\u4e00\u500b\u7a7a\u683c \u3002 \u4e5f\u53ef\u4ee5\u4f7f\u7528 key:{key1: value1, key2: value2, ...} \u3002 \u9084\u53ef\u4ee5\u4f7f\u7528\u7e2e\u9032\u8868\u793a\u5c64\u7d1a\u95dc\u4fc2\uff1b key : child-key : value child-key2 : value2 \u8f03\u70ba\u8907\u96dc\u7684\u5c0d\u8c61\u683c\u5f0f\uff0c\u53ef\u4ee5\u4f7f\u7528\u554f\u865f\u52a0\u4e00\u500b\u7a7a\u683c\u4ee3\u8868\u4e00\u500b\u8907\u96dc\u7684 key\uff0c\u914d\u5408\u4e00\u500b\u5192\u865f\u52a0\u4e00\u500b\u7a7a\u683c\u4ee3\u8868\u4e00\u500b value\uff1a ? - complexkey1 - complexkey2 : - complexvalue1 - complexvalue2 \u610f\u601d\u5373\u5c0d\u8c61\u7684\u5c6c\u6027\u662f\u4e00\u500b\u6578\u7d44 [complexkey1,complexkey2]\uff0c\u5c0d\u61c9\u7684\u503c\u4e5f\u662f\u4e00\u500b\u6578\u7d44 [complexvalue1,complexvalue2] \u9663\u5217/\u6578\u7d44 \u00b6 \u4ee5 - \u958b\u982d\u7684\u884c\u8868\u793a\u69cb\u6210\u4e00\u500b\u6578\u7d44\uff1a key\uff1a - A - B - C YAML \u652f\u6301\u591a\u7dad\u6578\u7d44\uff0c\u53ef\u4ee5\u4f7f\u7528 inline \u683c\u5f0f\u4f86\u8868\u793a\uff1a key : [ A , B , C , ... ] \u6578\u64da\u7d50\u69cb\u7684\u5b50\u6210\u54e1\u662f\u4e00\u500b\u6578\u7d44\uff0c\u5247\u53ef\u4ee5\u5728\u8a72\u9805\u4e0b\u9762\u7e2e\u9032\u4e00\u500b\u7a7a\u683c\u3002 - - A - B - C \u4e00\u500b\u76f8\u5c0d\u8907\u96dc\u7684\u4f8b\u5b50\uff1a companies : - id : 1 name : company1 price : 200W - id : 2 name : company2 price : 500W \u610f\u601d\u662f companies \u5c6c\u6027\u662f\u4e00\u500b\u6578\u7d44\uff0c\u6bcf\u4e00\u500b\u6578\u7d44\u5143\u7d20\u53c8\u662f\u7531 id\u3001name\u3001price \u4e09\u500b\u5c6c\u6027\u69cb\u6210\u3002 \u6578\u7d44\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6d41\u5f0f(flow)\u7684\u65b9\u5f0f\u8868\u793a\uff1a companies : [{ id : 1 , name : company1 , price : 200W },{ id : 2 , name : company2 , price : 500W }] \u8907\u5408\u7d50\u69cb \u00b6 \u6578\u7d44\u548c\u5c0d\u8c61\u53ef\u4ee5\u69cb\u6210\u8907\u5408\u7d50\u69cb\uff0c\u4f8b\u5982\uff1a languages : - Ruby - Perl - Python websites : YAML : yaml.org Ruby : ruby-lang.org Python : python.org Perl : use.perl.org \u8f49\u63db\u70ba json \u70ba\uff1a { la n guages : [ 'Ruby' , 'Perl' , 'Py t ho n ' ], websi tes : { YAML : 'yaml.org' , Ruby : 'ruby - la n g.org' , Py t ho n : 'py t ho n .org' , Perl : 'use.perl.org' } } \u7d14\u91cf \u00b6 \u7d14\u91cf\u662f\u6700\u57fa\u672c\u7684\uff0c\u4e0d\u53ef\u518d\u5206\u7684\u503c\uff0c\u5305\u62ec\uff1a \u5b57\u7b26\u4e32 \u5e03\u723e\u503c \u6574\u6578 \u6d6e\u9ede\u6578 Null \u6642\u9593 \u65e5\u671f \u4f7f\u7528\u4e00\u500b\u4f8b\u5b50\u4f86\u5feb\u901f\u4e86\u89e3\u7d14\u91cf\u7684\u57fa\u672c\u4f7f\u7528\uff1a boolean : - TRUE #true,True\u90fd\u53ef\u4ee5 - FALSE #false\uff0cFalse\u90fd\u53ef\u4ee5 float : - 3.14 - 6.8523015e+5 #\u53ef\u4ee5\u4f7f\u7528\u79d1\u5b78\u8a08\u6578\u6cd5 int : - 123 - 0b1010_0111_0100_1010_1110 #\u4e8c\u9032\u88fd\u8868\u793a null : nodeName : 'node' parent : ~ #\u4f7f\u7528~\u8868\u793anull string : - \u54c8\u54c8 - 'Hello world' #\u53ef\u4ee5\u4f7f\u7528\u96d9\u5f15\u865f\u6216\u8005\u55ae\u5f15\u865f\u5305\u88f9\u7279\u6b8a\u5b57\u7b26 - newline newline2 #\u5b57\u7b26\u4e32\u53ef\u4ee5\u62c6\u6210\u591a\u884c\uff0c\u6bcf\u4e00\u884c\u6703\u88ab\u8f49\u5316\u6210\u4e00\u500b\u7a7a\u683c date : - 2018-02-17 #\u65e5\u671f\u5fc5\u9808\u4f7f\u7528ISO 8601\u683c\u5f0f\uff0c\u5373yyyy-MM-dd datetime : - 2018-02-17T15:02:31+08:00 #\u6642\u9593\u4f7f\u7528ISO 8601\u683c\u5f0f\uff0c\u6642\u9593\u548c\u65e5\u671f\u4e4b\u9593\u4f7f\u7528T\u9023\u63a5\uff0c\u6700\u5f8c\u4f7f\u7528+\u4ee3\u8868\u6642\u5340 \u5f15\u7528 \u00b6 & \u9328\u9ede\u548c * \u5225\u540d\uff0c\u53ef\u4ee5\u7528\u4f86\u5f15\u7528: defaults : &defaults adapter : postgres host : localhost development : database : myapp_development << : *defaults test : database : myapp_test << : *defaults \u76f8\u7576\u65bc: defaults : adapter : postgres host : localhost development : database : myapp_development adapter : postgres host : localhost test : database : myapp_test adapter : postgres host : localhost & \u7528\u4f86\u5efa\u7acb\u9328\u9ede\uff08defaults\uff09\uff0c << \u8868\u793a\u5408\u4f75\u5230\u7576\u524d\u6578\u64da\uff0c * \u7528\u4f86\u5f15\u7528\u9328\u9ede\u3002 \u4e0b\u9762\u662f\u53e6\u4e00\u500b\u4f8b\u5b50: - &showell Steve - Clark - Brian - Oren - *showell \u8f49\u70ba Json \u7d50\u69cb\u5982\u4e0b: [ 'S te ve' , 'Clark' , 'Bria n ' , 'Ore n ' , 'S te ve' ]","title":"YAML \u5165\u9580\u6559\u7a0b"},{"location":"yaml/yaml-intro/#yaml","text":"YAML \u662f \"YAML Ain't a Markup Language\"\uff08YAML \u4e0d\u662f\u4e00\u7a2e\u6a19\u8a18\u8a9e\u8a00\uff09\u7684\u7e2e\u5beb\u3002 YAML \u7684\u8a9e\u6cd5\u548c\u5176\u4ed6\u9ad8\u7d1a\u8a9e\u8a00\u985e\u4f3c\uff0c\u4e26\u4e14\u53ef\u4ee5\u7c21\u55ae\u8868\u9054\u6e05\u55ae\u3001\u6563\u5217\u8868\uff0c\u6a19\u91cf\u7b49\u6578\u64da\u5f62\u614b\u3002\u5b83\u4f7f\u7528\u7a7a\u767d\u7b26\u865f\u7e2e\u9032\u548c\u5927\u91cf\u4f9d\u8cf4\u5916\u89c0\u7684\u7279\u8272\uff0c\u7279\u5225\u9069\u5408\u7528\u4f86\u8868\u9054\u6216\u7de8\u8f2f\u6578\u64da\u7d50\u69cb\u3001\u5404\u7a2e\u914d\u7f6e\u6587\u4ef6\u3001\u50be\u5370\u8abf\u8a66\u5167\u5bb9\u3001\u6587\u4ef6\u5927\u7db1\uff08\u4f8b\u5982\uff1a\u8a31\u591a\u96fb\u5b50\u90f5\u4ef6\u6a19\u984c\u683c\u5f0f\u548c YAML \u975e\u5e38\u63a5\u8fd1\uff09\u3002 YAML \u7684\u914d\u7f6e\u6587\u4ef6\u5f8c\u7db4\u70ba .yml \uff0c\u5982\uff1arunoob.yml \u3002","title":"YAML \u5165\u9580\u6559\u7a0b"},{"location":"yaml/yaml-intro/#_1","text":"\u5927\u5c0f\u5beb\u654f\u611f \u4f7f\u7528\u7e2e\u9032\u8868\u793a\u5c64\u7d1a\u95dc\u4fc2 \u7e2e\u9032\u4e0d\u5141\u8a31\u4f7f\u7528tab\uff0c\u53ea\u5141\u8a31\u7a7a\u683c \u7e2e\u9032\u7684\u7a7a\u683c\u6578\u4e0d\u91cd\u8981\uff0c\u53ea\u8981\u76f8\u540c\u5c64\u7d1a\u7684\u5143\u7d20\u5de6\u5c0d\u9f4a\u5373\u53ef '#'\u8868\u793a\u8a3b\u91cb","title":"\u57fa\u672c\u8a9e\u6cd5"},{"location":"yaml/yaml-intro/#_2","text":"YAML \u652f\u6301\u4ee5\u4e0b\u5e7e\u7a2e\u6578\u64da\u985e\u578b\uff1a \u7269\u4ef6/\u5c0d\u8c61\uff1a\u9375\u503c\u5c0d\u7684\u96c6\u5408\uff0c\u53c8\u7a31\u70ba\u6620\u5c04\uff08mapping\uff09/ \u54c8\u5e0c\uff08hashes\uff09 / \u5b57\u5178\uff08dictionary\uff09 \u9663\u5217/\u6578\u7d44\uff1a\u4e00\u7d44\u6309\u6b21\u5e8f\u6392\u5217\u7684\u503c\uff0c\u53c8\u7a31\u70ba\u5e8f\u5217\uff08sequence\uff09 / \u5217\u8868\uff08list\uff09 \u7d14\u91cf\uff08scalars\uff09\uff1a\u55ae\u500b\u7684\u3001\u4e0d\u53ef\u518d\u5206\u7684\u503c","title":"\u6578\u64da\u985e\u578b"},{"location":"yaml/yaml-intro/#_3","text":"\u5c0d\u8c61\u9375\u503c\u5c0d\u4f7f\u7528 \u5192\u865f \u7d50\u69cb\u8868\u793a key: value \uff0c \u5192\u865f\u5f8c\u9762\u8981\u52a0\u4e00\u500b\u7a7a\u683c \u3002 \u4e5f\u53ef\u4ee5\u4f7f\u7528 key:{key1: value1, key2: value2, ...} \u3002 \u9084\u53ef\u4ee5\u4f7f\u7528\u7e2e\u9032\u8868\u793a\u5c64\u7d1a\u95dc\u4fc2\uff1b key : child-key : value child-key2 : value2 \u8f03\u70ba\u8907\u96dc\u7684\u5c0d\u8c61\u683c\u5f0f\uff0c\u53ef\u4ee5\u4f7f\u7528\u554f\u865f\u52a0\u4e00\u500b\u7a7a\u683c\u4ee3\u8868\u4e00\u500b\u8907\u96dc\u7684 key\uff0c\u914d\u5408\u4e00\u500b\u5192\u865f\u52a0\u4e00\u500b\u7a7a\u683c\u4ee3\u8868\u4e00\u500b value\uff1a ? - complexkey1 - complexkey2 : - complexvalue1 - complexvalue2 \u610f\u601d\u5373\u5c0d\u8c61\u7684\u5c6c\u6027\u662f\u4e00\u500b\u6578\u7d44 [complexkey1,complexkey2]\uff0c\u5c0d\u61c9\u7684\u503c\u4e5f\u662f\u4e00\u500b\u6578\u7d44 [complexvalue1,complexvalue2]","title":"\u7269\u4ef6/\u5c0d\u8c61"},{"location":"yaml/yaml-intro/#_4","text":"\u4ee5 - \u958b\u982d\u7684\u884c\u8868\u793a\u69cb\u6210\u4e00\u500b\u6578\u7d44\uff1a key\uff1a - A - B - C YAML \u652f\u6301\u591a\u7dad\u6578\u7d44\uff0c\u53ef\u4ee5\u4f7f\u7528 inline \u683c\u5f0f\u4f86\u8868\u793a\uff1a key : [ A , B , C , ... ] \u6578\u64da\u7d50\u69cb\u7684\u5b50\u6210\u54e1\u662f\u4e00\u500b\u6578\u7d44\uff0c\u5247\u53ef\u4ee5\u5728\u8a72\u9805\u4e0b\u9762\u7e2e\u9032\u4e00\u500b\u7a7a\u683c\u3002 - - A - B - C \u4e00\u500b\u76f8\u5c0d\u8907\u96dc\u7684\u4f8b\u5b50\uff1a companies : - id : 1 name : company1 price : 200W - id : 2 name : company2 price : 500W \u610f\u601d\u662f companies \u5c6c\u6027\u662f\u4e00\u500b\u6578\u7d44\uff0c\u6bcf\u4e00\u500b\u6578\u7d44\u5143\u7d20\u53c8\u662f\u7531 id\u3001name\u3001price \u4e09\u500b\u5c6c\u6027\u69cb\u6210\u3002 \u6578\u7d44\u4e5f\u53ef\u4ee5\u4f7f\u7528\u6d41\u5f0f(flow)\u7684\u65b9\u5f0f\u8868\u793a\uff1a companies : [{ id : 1 , name : company1 , price : 200W },{ id : 2 , name : company2 , price : 500W }]","title":"\u9663\u5217/\u6578\u7d44"},{"location":"yaml/yaml-intro/#_5","text":"\u6578\u7d44\u548c\u5c0d\u8c61\u53ef\u4ee5\u69cb\u6210\u8907\u5408\u7d50\u69cb\uff0c\u4f8b\u5982\uff1a languages : - Ruby - Perl - Python websites : YAML : yaml.org Ruby : ruby-lang.org Python : python.org Perl : use.perl.org \u8f49\u63db\u70ba json \u70ba\uff1a { la n guages : [ 'Ruby' , 'Perl' , 'Py t ho n ' ], websi tes : { YAML : 'yaml.org' , Ruby : 'ruby - la n g.org' , Py t ho n : 'py t ho n .org' , Perl : 'use.perl.org' } }","title":"\u8907\u5408\u7d50\u69cb"},{"location":"yaml/yaml-intro/#_6","text":"\u7d14\u91cf\u662f\u6700\u57fa\u672c\u7684\uff0c\u4e0d\u53ef\u518d\u5206\u7684\u503c\uff0c\u5305\u62ec\uff1a \u5b57\u7b26\u4e32 \u5e03\u723e\u503c \u6574\u6578 \u6d6e\u9ede\u6578 Null \u6642\u9593 \u65e5\u671f \u4f7f\u7528\u4e00\u500b\u4f8b\u5b50\u4f86\u5feb\u901f\u4e86\u89e3\u7d14\u91cf\u7684\u57fa\u672c\u4f7f\u7528\uff1a boolean : - TRUE #true,True\u90fd\u53ef\u4ee5 - FALSE #false\uff0cFalse\u90fd\u53ef\u4ee5 float : - 3.14 - 6.8523015e+5 #\u53ef\u4ee5\u4f7f\u7528\u79d1\u5b78\u8a08\u6578\u6cd5 int : - 123 - 0b1010_0111_0100_1010_1110 #\u4e8c\u9032\u88fd\u8868\u793a null : nodeName : 'node' parent : ~ #\u4f7f\u7528~\u8868\u793anull string : - \u54c8\u54c8 - 'Hello world' #\u53ef\u4ee5\u4f7f\u7528\u96d9\u5f15\u865f\u6216\u8005\u55ae\u5f15\u865f\u5305\u88f9\u7279\u6b8a\u5b57\u7b26 - newline newline2 #\u5b57\u7b26\u4e32\u53ef\u4ee5\u62c6\u6210\u591a\u884c\uff0c\u6bcf\u4e00\u884c\u6703\u88ab\u8f49\u5316\u6210\u4e00\u500b\u7a7a\u683c date : - 2018-02-17 #\u65e5\u671f\u5fc5\u9808\u4f7f\u7528ISO 8601\u683c\u5f0f\uff0c\u5373yyyy-MM-dd datetime : - 2018-02-17T15:02:31+08:00 #\u6642\u9593\u4f7f\u7528ISO 8601\u683c\u5f0f\uff0c\u6642\u9593\u548c\u65e5\u671f\u4e4b\u9593\u4f7f\u7528T\u9023\u63a5\uff0c\u6700\u5f8c\u4f7f\u7528+\u4ee3\u8868\u6642\u5340","title":"\u7d14\u91cf"},{"location":"yaml/yaml-intro/#_7","text":"& \u9328\u9ede\u548c * \u5225\u540d\uff0c\u53ef\u4ee5\u7528\u4f86\u5f15\u7528: defaults : &defaults adapter : postgres host : localhost development : database : myapp_development << : *defaults test : database : myapp_test << : *defaults \u76f8\u7576\u65bc: defaults : adapter : postgres host : localhost development : database : myapp_development adapter : postgres host : localhost test : database : myapp_test adapter : postgres host : localhost & \u7528\u4f86\u5efa\u7acb\u9328\u9ede\uff08defaults\uff09\uff0c << \u8868\u793a\u5408\u4f75\u5230\u7576\u524d\u6578\u64da\uff0c * \u7528\u4f86\u5f15\u7528\u9328\u9ede\u3002 \u4e0b\u9762\u662f\u53e6\u4e00\u500b\u4f8b\u5b50: - &showell Steve - Clark - Brian - Oren - *showell \u8f49\u70ba Json \u7d50\u69cb\u5982\u4e0b: [ 'S te ve' , 'Clark' , 'Bria n ' , 'Ore n ' , 'S te ve' ]","title":"\u5f15\u7528"},{"location":"yaml/yaml-tutorial/","text":"YAML \u6559\u7a0b\uff1a5 \u5206\u9418\u4e0a\u624b \u00b6 \u539f\u6587: https://www.educative.io/blog/yaml-tutorial YAML \u662f\u4e00\u7a2e\u6578\u64da\u5e8f\u5217\u5316\u8a9e\u8a00\uff0c\u53ef\u8b93\u60a8\u4ee5\u7dca\u6e4a\u6613\u8b80\u7684\u683c\u5f0f\u5b58\u5132\u8907\u96dc\u6578\u64da\u3002\u9019\u5c0d\u65bc DevOps \u548c\u865b\u64ec\u5316\u5f88\u91cd\u8981\uff0c\u56e0\u70ba\u5b83\u5c0d\u65bc\u69cb\u5efa\u9ad8\u6548\u7684\u6578\u64da\u7ba1\u7406\u7cfb\u7d71\u548c\u81ea\u52d5\u5316\u81f3\u95dc\u91cd\u8981\u3002 \u96d6\u7136\u7d93\u5e38\u88ab\u958b\u767c\u4eba\u54e1\u5ffd\u8996\uff0c\u4f46\u5b83\u662f\u4e00\u500b\u5f37\u5927\u800c\u7c21\u55ae\u7684\u5de5\u5177\uff0c\u53ea\u9700\u5e7e\u500b\u5c0f\u6642\u7684\u5b78\u7fd2\uff0c\u5c31\u53ef\u4ee5\u6975\u5927\u5730\u6539\u5584\u4f60\u7684\u5de5\u4f5c\u524d\u666f\u3002 \u4eca\u5929\uff0c\u6211\u5011\u5c07\u901a\u904e\u52d5\u624b\u6559\u7a0b\u5e6b\u52a9\u60a8\u5feb\u901f\u5b78\u7fd2 YAML\uff0c\u4e26\u63a2\u7d22\u5982\u4f55\u5728\u60a8\u7684\u4e0b\u4e00\u500b\u6578\u64da\u9a45\u52d5\u89e3\u6c7a\u65b9\u6848\u4e2d\u4f7f\u7528\u5b83\u3002 \u4ec0\u9ebc\u662f YAML\uff1f \u00b6 YAML \u662f\u4e00\u7a2e\u6578\u64da\u5e8f\u5217\u5316\u8a9e\u8a00\uff0c\u7528\u65bc\u4ee5\u4eba\u985e\u53ef\u8b80\u7684\u5f62\u5f0f\u5b58\u5132\u4fe1\u606f\u3002\u5b83\u6700\u521d\u4ee3\u8868 \u201cYet Another Markup Language\u201d\uff0c\u4f46\u5f8c\u4f86\u6539\u70ba \u201cYAML Ain't Markup Language\u201d\uff0c\u4ee5\u5340\u5225\u65bc\u771f\u6b63\u7684\u6a19\u8a18\u8a9e\u8a00\u3002 \u5b83\u985e\u4f3c\u65bc XML \u548c JSON \u6587\u4ef6\uff0c\u4f46\u5373\u4f7f\u5728\u4fdd\u6301\u985e\u4f3c\u529f\u80fd\u7684\u540c\u6642\u4f7f\u7528\u66f4\u7c21\u7d04\u7684\u8a9e\u6cd5\u3002 YAML \u901a\u5e38\u7528\u65bc\u5728 \u57fa\u790e\u67b6\u69cb\u5373\u4ee3\u78bc (IaC) \u7a0b\u5e8f\u4e2d\u5275\u5efa\u914d\u7f6e\u6587\u4ef6\u6216\u5728 DevOps \u958b\u767c\u7ba1\u9053\u4e2d\u7ba1\u7406\u5bb9\u5668\u3002 \u6700\u8fd1\uff0cYAML \u5df2\u88ab\u7528\u65bc\u5275\u5efa\u53ef\u4ee5\u57f7\u884c YAML \u6587\u4ef6\u4e2d\u5217\u51fa\u7684\u4e00\u7cfb\u5217\u547d\u4ee4\u7684\u81ea\u52d5\u5316\u5354\u8b70\u3002\u9019\u610f\u5473\u8457\u60a8\u7684\u7cfb\u7d71\u53ef\u4ee5\u66f4\u52a0\u7368\u7acb\u4e14\u97ff\u61c9\u8fc5\u901f\uff0c\u800c\u7121\u9700\u984d\u5916\u7684\u958b\u767c\u4eba\u54e1\u95dc\u6ce8\u3002 \u96a8\u8457\u8d8a\u4f86\u8d8a\u591a\u7684\u516c\u53f8\u63a1\u7528 DevOps \u548c\u865b\u64ec\u5316\uff0cYAML \u6b63\u8fc5\u901f\u6210\u70ba\u73fe\u4ee3\u958b\u767c\u4eba\u54e1\u8077\u4f4d\u7684\u5fc5\u5099\u6280\u80fd\u3002\u901a\u904e\u652f\u6301\u6d41\u884c\u7684\u6280\u8853\uff0c\u5982\u4f7f\u7528 PyYAML \u5eab\u3001Docker \u6216 Ansible \u7684 Python\uff0cYAML \u4e5f\u5f88\u5bb9\u6613\u8207\u73fe\u6709\u6280\u8853\u7d50\u5408\u3002 YAML \u7684\u986f\u8457\u7279\u9ede \u00b6 \u4ee5\u4e0b\u662f YAML \u63d0\u4f9b\u7684\u4e00\u4e9b\u986f\u8457\u7684\u529f\u80fd\u3002 Multi-document \u652f\u6301 \u00b6 \u60a8\u53ef\u4ee5\u5728\u4e00\u500b YAML \u6587\u4ef6\u4e2d\u5305\u542b\u591a\u500b YAML \u6587\u6a94\uff0c\u4ee5\u4f7f\u6587\u4ef6\u7d44\u7e54\u6216\u6578\u64da\u89e3\u6790\u66f4\u5bb9\u6613\u3002 \u6bcf\u500b\u6587\u6a94\u4e4b\u9593\u7684\u5206\u9694\u4f7f\u7528\u7528\u4e09\u500b\u7834\u6298\u865f ( --- ) \u4f86\u505a\u6a19\u8a18 --- player : playerOne action : attack (miss) --- player : playerTwo action : attack (hit) --- Built-in \u8a3b\u91cb \u00b6 YAML \u5141\u8a31\u60a8\u4f7f\u7528\u985e\u4f3c\u65bc Python \u8a3b\u91cb\u7684\u4e95\u865f ( # ) \u5411\u6587\u4ef6\u6dfb\u52a0 \u8a3b\u91cb \u3002 key : #Here is a single-line comment - value line 5 #Here is a #multi-line comment - value line 13 \u6613\u8b80\u8a9e\u6cd5 \u00b6 YAML \u6587\u4ef6\u4f7f\u7528\u985e\u4f3c\u65bc Python \u7684 \u7e2e\u9032\u7cfb\u7d71 \u4f86\u986f\u793a\u7a0b\u5e8f\u7684\u7d50\u69cb\u3002\u60a8\u9700\u8981\u4f7f\u7528 space \u800c\u4e0d\u662f tab \u4f86\u5275\u5efa\u7e2e\u9032\u4ee5\u907f\u514d\u6df7\u6dc6\u3002 \u5b83\u9084\u6d88\u9664\u4e86 JSON \u548c XML \u6587\u4ef6\u4e2d\u7684\u5927\u90e8\u5206\u201cnoise\u201d\u683c\u5f0f\uff0c\u4f8b\u5982\u5f15\u865f\u3001\u65b9\u62ec\u865f\u548c\u5927\u62ec\u865f\u3002 \u9019\u4e9b\u683c\u5f0f\u898f\u7bc4\u63d0\u9ad8\u4e86 YAML \u6587\u4ef6\u7684\u53ef\u8b80\u6027\uff0c\u8d85\u8d8a\u4e86 XML \u548c JSON\u3002 YAML Example Imaro : author : Charles R. Saunders language : English publication-year : 1981 pages : 224 JSON Example { \"Imaro\" : { \"author\" : \"Charles R. Saunders\" , \"language\" : \"English\" , \"publication-year\" : \"1981\" , \"pages\" : 224 , } } \u8acb\u6ce8\u610f\uff0c\u4e0a\u9762\u5169\u500b\u7bc4\u4f8b\u50b3\u9054\u4e86\u76f8\u540c\u7684\u4fe1\u606f\uff1b\u4f46\u662f\uff0c\u5728 YAML \u6587\u4ef6\u4e2d\u522a\u9664\u4e86\u96d9\u5f15\u865f\u3001\u9017\u865f\u548c\u65b9\u62ec\u865f\u4f7f\u5176\u66f4\u6613\u65bc\u4e00\u76ee\u4e86\u7136\u3002 \u96b1\u5f0f\u548c\u986f\u5f0f\u985e\u578b \u00b6 YAML \u901a\u904e\u81ea\u52d5\u6aa2\u6e2c\u6578\u64da\u985e\u578b\u63d0\u4f9b\u4e86\u8f38\u5165\u7684\u591a\u529f\u80fd\u6027\uff0c\u540c\u6642\u9084\u652f\u6301\u986f\u5f0f\u8f38\u5165\u9078\u9805\u3002\u8981\u5c07\u6578\u64da\u6a19\u8a18\u70ba\u7279\u5b9a\u985e\u578b\uff0c\u53ea\u9700\u5728\u503c\u524d\u5305\u542b !![typeName] \u3002 # The value should be an int: is-an-int : !!int 14.10 # Turn any value to a string: is-a-str : !!str 67.43 # The next value should be a boolean: is-a-bool : !!bool true YAML \u8a9e\u6cd5 \u00b6 YAML \u6709\u4e00\u4e9b\u69cb\u6210\u5927\u90e8\u5206\u6578\u64da\u7684\u57fa\u672c\u6982\u5ff5\u3002 \u9375\u503c\u5c0d Key-value pairs \u00b6 \u901a\u5e38\uff0cYAML \u6587\u4ef6\u4e2d\u7684\u5927\u591a\u6578\u5167\u5bb9\u90fd\u662f \u9375\u503c\u5c0d \u7684\u4e00\u7a2e\u5f62\u5f0f\uff0c\u5176\u4e2d \u9375 \u4ee3\u8868\u9375\u503c\u5c0d\u7684 \u540d\u7a31 \uff0c \u503c \u4ee3\u8868\u934a\u63a5\u5230\u8a72 \u540d\u7a31 \u7684 \u6578\u64da \u3002 \u9375\u503c\u5c0d \u662f\u6240\u6709\u5176\u4ed6 YAML \u7d50\u69cb\u7684\u57fa\u790e\u3002 \u6a19\u91cf\u548c\u6620\u5c04 \u00b6 \u6a19\u91cf\u8868\u793a\u55ae\u500b\u5b58\u5132\u503c\u3002\u4f7f\u7528\u6620\u5c04\u5c07\u6a19\u91cf\u5206\u914d\u7d66\u9375\u540d\u3002\u60a8\u4f7f\u7528\u540d\u7a31\u3001\u5192\u865f\u548c\u7a7a\u683c\u5b9a\u7fa9\u4e00\u500b\u6620\u5c04\uff0c\u7136\u5f8c\u662f\u4e00\u500b\u8981\u4fdd\u5b58\u7684\u503c\u3002 YAML \u652f\u6301\u5e38\u898b\u985e\u578b\uff0c\u5982\u6574\u6578\u548c\u6d6e\u9ede\u6578\u503c\uff0c\u4ee5\u53ca\u975e\u6578\u5b57\u985e\u578b Boolean \u548c String\u3002 \u6bcf\u500b\u90fd\u53ef\u4ee5\u7528\u4e0d\u540c\u7684\u65b9\u5f0f\u8868\u793a\uff0c\u5982\u5341\u516d\u9032\u5236\u3001\u516b\u9032\u88fd\u6216\u6307\u6578\u3002\u9084\u6709\u4e00\u4e9b\u7279\u6b8a\u985e\u578b\u7684\u6578\u5b78\u6982\u5ff5\uff0c\u5982\u7121\u7aae\u5927\u3001-\u7121\u7aae\u5927\u548c\u975e\u6578\u5b57 (NAN) integer : 25 hex : 0x12d4 #evaluates to 4820 octal : 023332 #evaluates to 9946 float : 25.0 exponent : 12.3015e+05 #evaluates to 1230150.0 boolean : Yes string : \"25\" infinity : .inf # evaluates to infinity neginf : -.Inf #evaluates to negative infinity not : .NAN #Not a Number \u5b57\u7b26\u4e32 String \u00b6 \u5b57\u7b26\u4e32\u662f\u8868\u793a\u53e5\u5b50\u6216\u77ed\u8a9e\u7684\u5b57\u7b26\u96c6\u5408\u3002\u60a8\u8981\u9ebc\u4f7f\u7528 | \u5c07\u6bcf\u500b\u5b57\u7b26\u4e32\u6253\u5370\u70ba\u65b0\u884c\u6216 > \u5c07\u5176\u6253\u5370\u70ba\u6bb5\u843d\u3002 YAML \u4e2d\u7684\u5b57\u7b26\u4e32\u4e0d\u9700\u8981\u7528\u96d9\u5f15\u865f\u3002 str : Hello World data : | These Newlines Are broken up data : > This text is wrapped and is a single paragraph \u5e8f\u5217 Sequence \u00b6 \u5e8f\u5217 \u662f\u985e\u4f3c\u65bc \u5217\u8868 (list) \u6216 \u6578\u7d44 (array) \u7684\u6578\u64da\u7d50\u69cb\uff0c\u5728\u540c\u4e00\u500b \u9375 \u4e0b\u4fdd\u5b58\u591a\u500b \u503c \u3002 \u5e8f\u5217 \u53ef\u4f7f\u7528 block \u6216 inline-flow \u6a23\u5f0f\u5b9a\u7fa9\u7684\u3002 block \u6a23\u5f0f\u4f7f\u7528\u591a\u884c\u7684 - \u4f86\u5efa\u69cb\u6587\u6a94\u3002\u8207 inline-flow \u98a8\u683c\u76f8\u6bd4\uff0c\u5b83\u66f4\u6613\u65bc\u95b1\u8b80\uff0c\u4f46\u4e0d\u592a\u7dca\u6e4a\u3002 --- # Shopping List Sequence in Block Style shopping : - milk - eggs - juice inline-flow \u6a23\u5f0f\u5141\u8a31\u60a8\u4f7f\u7528\u65b9\u62ec\u865f\u5167\u806f\u7de8\u5beb \u5e8f\u5217 \u3002 Flow \u98a8\u683c\u7dca\u6e4a\u800c\u4e14\u4e00\u76ee\u4e86\u7136\u3002 --- # Shopping List Sequence in Flow Style shopping : [ milk , eggs , juice ] \u5b57\u5178 Dictionaries \u00b6 \u5b57\u5178 \u662f\u6240\u6709\u5d4c\u5957\u5728\u540c\u4e00\u5b50\u7d44\u4e0b\u7684 \u9375\u503c\u5c0d \u7684\u96c6\u5408\u3002\u5b83\u5011\u6709\u52a9\u65bc\u5c07\u6578\u64da\u5283\u5206\u70ba\u908f\u8f2f\u985e\u5225\u4ee5\u4f9b\u4ee5\u5f8c\u4f7f\u7528\u3002 \u5b57\u5178\u7684\u5b9a\u7fa9\u985e\u4f3c\u65bc\u6620\u5c04\uff0c\u60a8\u8f38\u5165\u5b57\u5178\u540d\u7a31\u3001\u5192\u865f\u548c\u7a7a\u683c\uff0c\u5f8c\u9762\u8ddf\u5f9e\u8457 1 \u500b\u6216\u591a\u500b \u7e2e\u9032 \u9375\u503c\u5c0d\u3002 # An employee record Employees : - dan : name : Dan D. Veloper job : Developer team : DevOps - dora : name : Dora D. Veloper job : Project Manager team : Web Subscriptions","title":"Learn YAML"},{"location":"yaml/yaml-tutorial/#yaml-5","text":"\u539f\u6587: https://www.educative.io/blog/yaml-tutorial YAML \u662f\u4e00\u7a2e\u6578\u64da\u5e8f\u5217\u5316\u8a9e\u8a00\uff0c\u53ef\u8b93\u60a8\u4ee5\u7dca\u6e4a\u6613\u8b80\u7684\u683c\u5f0f\u5b58\u5132\u8907\u96dc\u6578\u64da\u3002\u9019\u5c0d\u65bc DevOps \u548c\u865b\u64ec\u5316\u5f88\u91cd\u8981\uff0c\u56e0\u70ba\u5b83\u5c0d\u65bc\u69cb\u5efa\u9ad8\u6548\u7684\u6578\u64da\u7ba1\u7406\u7cfb\u7d71\u548c\u81ea\u52d5\u5316\u81f3\u95dc\u91cd\u8981\u3002 \u96d6\u7136\u7d93\u5e38\u88ab\u958b\u767c\u4eba\u54e1\u5ffd\u8996\uff0c\u4f46\u5b83\u662f\u4e00\u500b\u5f37\u5927\u800c\u7c21\u55ae\u7684\u5de5\u5177\uff0c\u53ea\u9700\u5e7e\u500b\u5c0f\u6642\u7684\u5b78\u7fd2\uff0c\u5c31\u53ef\u4ee5\u6975\u5927\u5730\u6539\u5584\u4f60\u7684\u5de5\u4f5c\u524d\u666f\u3002 \u4eca\u5929\uff0c\u6211\u5011\u5c07\u901a\u904e\u52d5\u624b\u6559\u7a0b\u5e6b\u52a9\u60a8\u5feb\u901f\u5b78\u7fd2 YAML\uff0c\u4e26\u63a2\u7d22\u5982\u4f55\u5728\u60a8\u7684\u4e0b\u4e00\u500b\u6578\u64da\u9a45\u52d5\u89e3\u6c7a\u65b9\u6848\u4e2d\u4f7f\u7528\u5b83\u3002","title":"YAML \u6559\u7a0b\uff1a5 \u5206\u9418\u4e0a\u624b"},{"location":"yaml/yaml-tutorial/#yaml","text":"YAML \u662f\u4e00\u7a2e\u6578\u64da\u5e8f\u5217\u5316\u8a9e\u8a00\uff0c\u7528\u65bc\u4ee5\u4eba\u985e\u53ef\u8b80\u7684\u5f62\u5f0f\u5b58\u5132\u4fe1\u606f\u3002\u5b83\u6700\u521d\u4ee3\u8868 \u201cYet Another Markup Language\u201d\uff0c\u4f46\u5f8c\u4f86\u6539\u70ba \u201cYAML Ain't Markup Language\u201d\uff0c\u4ee5\u5340\u5225\u65bc\u771f\u6b63\u7684\u6a19\u8a18\u8a9e\u8a00\u3002 \u5b83\u985e\u4f3c\u65bc XML \u548c JSON \u6587\u4ef6\uff0c\u4f46\u5373\u4f7f\u5728\u4fdd\u6301\u985e\u4f3c\u529f\u80fd\u7684\u540c\u6642\u4f7f\u7528\u66f4\u7c21\u7d04\u7684\u8a9e\u6cd5\u3002 YAML \u901a\u5e38\u7528\u65bc\u5728 \u57fa\u790e\u67b6\u69cb\u5373\u4ee3\u78bc (IaC) \u7a0b\u5e8f\u4e2d\u5275\u5efa\u914d\u7f6e\u6587\u4ef6\u6216\u5728 DevOps \u958b\u767c\u7ba1\u9053\u4e2d\u7ba1\u7406\u5bb9\u5668\u3002 \u6700\u8fd1\uff0cYAML \u5df2\u88ab\u7528\u65bc\u5275\u5efa\u53ef\u4ee5\u57f7\u884c YAML \u6587\u4ef6\u4e2d\u5217\u51fa\u7684\u4e00\u7cfb\u5217\u547d\u4ee4\u7684\u81ea\u52d5\u5316\u5354\u8b70\u3002\u9019\u610f\u5473\u8457\u60a8\u7684\u7cfb\u7d71\u53ef\u4ee5\u66f4\u52a0\u7368\u7acb\u4e14\u97ff\u61c9\u8fc5\u901f\uff0c\u800c\u7121\u9700\u984d\u5916\u7684\u958b\u767c\u4eba\u54e1\u95dc\u6ce8\u3002 \u96a8\u8457\u8d8a\u4f86\u8d8a\u591a\u7684\u516c\u53f8\u63a1\u7528 DevOps \u548c\u865b\u64ec\u5316\uff0cYAML \u6b63\u8fc5\u901f\u6210\u70ba\u73fe\u4ee3\u958b\u767c\u4eba\u54e1\u8077\u4f4d\u7684\u5fc5\u5099\u6280\u80fd\u3002\u901a\u904e\u652f\u6301\u6d41\u884c\u7684\u6280\u8853\uff0c\u5982\u4f7f\u7528 PyYAML \u5eab\u3001Docker \u6216 Ansible \u7684 Python\uff0cYAML \u4e5f\u5f88\u5bb9\u6613\u8207\u73fe\u6709\u6280\u8853\u7d50\u5408\u3002","title":"\u4ec0\u9ebc\u662f YAML\uff1f"},{"location":"yaml/yaml-tutorial/#yaml_1","text":"\u4ee5\u4e0b\u662f YAML \u63d0\u4f9b\u7684\u4e00\u4e9b\u986f\u8457\u7684\u529f\u80fd\u3002","title":"YAML \u7684\u986f\u8457\u7279\u9ede"},{"location":"yaml/yaml-tutorial/#multi-document","text":"\u60a8\u53ef\u4ee5\u5728\u4e00\u500b YAML \u6587\u4ef6\u4e2d\u5305\u542b\u591a\u500b YAML \u6587\u6a94\uff0c\u4ee5\u4f7f\u6587\u4ef6\u7d44\u7e54\u6216\u6578\u64da\u89e3\u6790\u66f4\u5bb9\u6613\u3002 \u6bcf\u500b\u6587\u6a94\u4e4b\u9593\u7684\u5206\u9694\u4f7f\u7528\u7528\u4e09\u500b\u7834\u6298\u865f ( --- ) \u4f86\u505a\u6a19\u8a18 --- player : playerOne action : attack (miss) --- player : playerTwo action : attack (hit) ---","title":"Multi-document \u652f\u6301"},{"location":"yaml/yaml-tutorial/#built-in","text":"YAML \u5141\u8a31\u60a8\u4f7f\u7528\u985e\u4f3c\u65bc Python \u8a3b\u91cb\u7684\u4e95\u865f ( # ) \u5411\u6587\u4ef6\u6dfb\u52a0 \u8a3b\u91cb \u3002 key : #Here is a single-line comment - value line 5 #Here is a #multi-line comment - value line 13","title":"Built-in \u8a3b\u91cb"},{"location":"yaml/yaml-tutorial/#_1","text":"YAML \u6587\u4ef6\u4f7f\u7528\u985e\u4f3c\u65bc Python \u7684 \u7e2e\u9032\u7cfb\u7d71 \u4f86\u986f\u793a\u7a0b\u5e8f\u7684\u7d50\u69cb\u3002\u60a8\u9700\u8981\u4f7f\u7528 space \u800c\u4e0d\u662f tab \u4f86\u5275\u5efa\u7e2e\u9032\u4ee5\u907f\u514d\u6df7\u6dc6\u3002 \u5b83\u9084\u6d88\u9664\u4e86 JSON \u548c XML \u6587\u4ef6\u4e2d\u7684\u5927\u90e8\u5206\u201cnoise\u201d\u683c\u5f0f\uff0c\u4f8b\u5982\u5f15\u865f\u3001\u65b9\u62ec\u865f\u548c\u5927\u62ec\u865f\u3002 \u9019\u4e9b\u683c\u5f0f\u898f\u7bc4\u63d0\u9ad8\u4e86 YAML \u6587\u4ef6\u7684\u53ef\u8b80\u6027\uff0c\u8d85\u8d8a\u4e86 XML \u548c JSON\u3002 YAML Example Imaro : author : Charles R. Saunders language : English publication-year : 1981 pages : 224 JSON Example { \"Imaro\" : { \"author\" : \"Charles R. Saunders\" , \"language\" : \"English\" , \"publication-year\" : \"1981\" , \"pages\" : 224 , } } \u8acb\u6ce8\u610f\uff0c\u4e0a\u9762\u5169\u500b\u7bc4\u4f8b\u50b3\u9054\u4e86\u76f8\u540c\u7684\u4fe1\u606f\uff1b\u4f46\u662f\uff0c\u5728 YAML \u6587\u4ef6\u4e2d\u522a\u9664\u4e86\u96d9\u5f15\u865f\u3001\u9017\u865f\u548c\u65b9\u62ec\u865f\u4f7f\u5176\u66f4\u6613\u65bc\u4e00\u76ee\u4e86\u7136\u3002","title":"\u6613\u8b80\u8a9e\u6cd5"},{"location":"yaml/yaml-tutorial/#_2","text":"YAML \u901a\u904e\u81ea\u52d5\u6aa2\u6e2c\u6578\u64da\u985e\u578b\u63d0\u4f9b\u4e86\u8f38\u5165\u7684\u591a\u529f\u80fd\u6027\uff0c\u540c\u6642\u9084\u652f\u6301\u986f\u5f0f\u8f38\u5165\u9078\u9805\u3002\u8981\u5c07\u6578\u64da\u6a19\u8a18\u70ba\u7279\u5b9a\u985e\u578b\uff0c\u53ea\u9700\u5728\u503c\u524d\u5305\u542b !![typeName] \u3002 # The value should be an int: is-an-int : !!int 14.10 # Turn any value to a string: is-a-str : !!str 67.43 # The next value should be a boolean: is-a-bool : !!bool true","title":"\u96b1\u5f0f\u548c\u986f\u5f0f\u985e\u578b"},{"location":"yaml/yaml-tutorial/#yaml_2","text":"YAML \u6709\u4e00\u4e9b\u69cb\u6210\u5927\u90e8\u5206\u6578\u64da\u7684\u57fa\u672c\u6982\u5ff5\u3002","title":"YAML \u8a9e\u6cd5"},{"location":"yaml/yaml-tutorial/#key-value-pairs","text":"\u901a\u5e38\uff0cYAML \u6587\u4ef6\u4e2d\u7684\u5927\u591a\u6578\u5167\u5bb9\u90fd\u662f \u9375\u503c\u5c0d \u7684\u4e00\u7a2e\u5f62\u5f0f\uff0c\u5176\u4e2d \u9375 \u4ee3\u8868\u9375\u503c\u5c0d\u7684 \u540d\u7a31 \uff0c \u503c \u4ee3\u8868\u934a\u63a5\u5230\u8a72 \u540d\u7a31 \u7684 \u6578\u64da \u3002 \u9375\u503c\u5c0d \u662f\u6240\u6709\u5176\u4ed6 YAML \u7d50\u69cb\u7684\u57fa\u790e\u3002","title":"\u9375\u503c\u5c0d Key-value pairs"},{"location":"yaml/yaml-tutorial/#_3","text":"\u6a19\u91cf\u8868\u793a\u55ae\u500b\u5b58\u5132\u503c\u3002\u4f7f\u7528\u6620\u5c04\u5c07\u6a19\u91cf\u5206\u914d\u7d66\u9375\u540d\u3002\u60a8\u4f7f\u7528\u540d\u7a31\u3001\u5192\u865f\u548c\u7a7a\u683c\u5b9a\u7fa9\u4e00\u500b\u6620\u5c04\uff0c\u7136\u5f8c\u662f\u4e00\u500b\u8981\u4fdd\u5b58\u7684\u503c\u3002 YAML \u652f\u6301\u5e38\u898b\u985e\u578b\uff0c\u5982\u6574\u6578\u548c\u6d6e\u9ede\u6578\u503c\uff0c\u4ee5\u53ca\u975e\u6578\u5b57\u985e\u578b Boolean \u548c String\u3002 \u6bcf\u500b\u90fd\u53ef\u4ee5\u7528\u4e0d\u540c\u7684\u65b9\u5f0f\u8868\u793a\uff0c\u5982\u5341\u516d\u9032\u5236\u3001\u516b\u9032\u88fd\u6216\u6307\u6578\u3002\u9084\u6709\u4e00\u4e9b\u7279\u6b8a\u985e\u578b\u7684\u6578\u5b78\u6982\u5ff5\uff0c\u5982\u7121\u7aae\u5927\u3001-\u7121\u7aae\u5927\u548c\u975e\u6578\u5b57 (NAN) integer : 25 hex : 0x12d4 #evaluates to 4820 octal : 023332 #evaluates to 9946 float : 25.0 exponent : 12.3015e+05 #evaluates to 1230150.0 boolean : Yes string : \"25\" infinity : .inf # evaluates to infinity neginf : -.Inf #evaluates to negative infinity not : .NAN #Not a Number","title":"\u6a19\u91cf\u548c\u6620\u5c04"},{"location":"yaml/yaml-tutorial/#string","text":"\u5b57\u7b26\u4e32\u662f\u8868\u793a\u53e5\u5b50\u6216\u77ed\u8a9e\u7684\u5b57\u7b26\u96c6\u5408\u3002\u60a8\u8981\u9ebc\u4f7f\u7528 | \u5c07\u6bcf\u500b\u5b57\u7b26\u4e32\u6253\u5370\u70ba\u65b0\u884c\u6216 > \u5c07\u5176\u6253\u5370\u70ba\u6bb5\u843d\u3002 YAML \u4e2d\u7684\u5b57\u7b26\u4e32\u4e0d\u9700\u8981\u7528\u96d9\u5f15\u865f\u3002 str : Hello World data : | These Newlines Are broken up data : > This text is wrapped and is a single paragraph","title":"\u5b57\u7b26\u4e32 String"},{"location":"yaml/yaml-tutorial/#sequence","text":"\u5e8f\u5217 \u662f\u985e\u4f3c\u65bc \u5217\u8868 (list) \u6216 \u6578\u7d44 (array) \u7684\u6578\u64da\u7d50\u69cb\uff0c\u5728\u540c\u4e00\u500b \u9375 \u4e0b\u4fdd\u5b58\u591a\u500b \u503c \u3002 \u5e8f\u5217 \u53ef\u4f7f\u7528 block \u6216 inline-flow \u6a23\u5f0f\u5b9a\u7fa9\u7684\u3002 block \u6a23\u5f0f\u4f7f\u7528\u591a\u884c\u7684 - \u4f86\u5efa\u69cb\u6587\u6a94\u3002\u8207 inline-flow \u98a8\u683c\u76f8\u6bd4\uff0c\u5b83\u66f4\u6613\u65bc\u95b1\u8b80\uff0c\u4f46\u4e0d\u592a\u7dca\u6e4a\u3002 --- # Shopping List Sequence in Block Style shopping : - milk - eggs - juice inline-flow \u6a23\u5f0f\u5141\u8a31\u60a8\u4f7f\u7528\u65b9\u62ec\u865f\u5167\u806f\u7de8\u5beb \u5e8f\u5217 \u3002 Flow \u98a8\u683c\u7dca\u6e4a\u800c\u4e14\u4e00\u76ee\u4e86\u7136\u3002 --- # Shopping List Sequence in Flow Style shopping : [ milk , eggs , juice ]","title":"\u5e8f\u5217 Sequence"},{"location":"yaml/yaml-tutorial/#dictionaries","text":"\u5b57\u5178 \u662f\u6240\u6709\u5d4c\u5957\u5728\u540c\u4e00\u5b50\u7d44\u4e0b\u7684 \u9375\u503c\u5c0d \u7684\u96c6\u5408\u3002\u5b83\u5011\u6709\u52a9\u65bc\u5c07\u6578\u64da\u5283\u5206\u70ba\u908f\u8f2f\u985e\u5225\u4ee5\u4f9b\u4ee5\u5f8c\u4f7f\u7528\u3002 \u5b57\u5178\u7684\u5b9a\u7fa9\u985e\u4f3c\u65bc\u6620\u5c04\uff0c\u60a8\u8f38\u5165\u5b57\u5178\u540d\u7a31\u3001\u5192\u865f\u548c\u7a7a\u683c\uff0c\u5f8c\u9762\u8ddf\u5f9e\u8457 1 \u500b\u6216\u591a\u500b \u7e2e\u9032 \u9375\u503c\u5c0d\u3002 # An employee record Employees : - dan : name : Dan D. Veloper job : Developer team : DevOps - dora : name : Dora D. Veloper job : Project Manager team : Web Subscriptions","title":"\u5b57\u5178 Dictionaries"}]}